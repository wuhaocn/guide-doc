## 集群搭建配置

搭建一个由四台 zk 构成的 zk 集群，其中一台为 Leader，两台 Follower，一台 Observer。

```
server.1=192.168.1.101:2888:3888

server.2=192.168.1.101:2888:3888

server.3=192.168.1.101:2888:3888

server.4=192.168.1.101:2888:3888:observer
```

等号左边的“server.数字”，表示要设置第几个 zkServer 节点。数字一般从 1 开始计数， 依次加 1。

等号右边的第一段，表示该 zkServer 节点的主机，可以是主机名，也可以是主机 IP

等号右边的第二段，表示连接端口号。即其它 zkServer 与当前主机连接的端口号。每台主机的连接端口号可以任意设置，且可不一样。

等号右边的第三段，表示选举端口号。若当前的 Leader 宕机，各个 Follower 需要选举 新的 Leader，这些 Follower 之间为了选举而相互联系，就使用该端口号。每台主机的选举端口号可以任意设置，且可不一样。

在第四台 Server 后添加了 observer，用于指定其在集群中将以 Observer 的身份出现。

## 删除无效数据

zk 的运行会在/usr/data/zookeeper 目录中生成一些文件与目录，这些文件和目录与当前 的 zkServer 具有绑定关系。

注意：由于每台主机复制于原单机 Zookeeper，所以会将其 /usr/data/zookeeper 目录中生成文件与目录一起复制来，这些数据对于 zkos1 来说就是无效数据，可以将其全部删除。

## 创建 myid 文件

在/usr/data/zookeeper 目录中创建表示当前主机编号的 myid 文件。该主机编号要与 zoo.cfg 文件中设置的编号一致。

修改 myid 的值与 zoo.cfg 中指定的主机编号相同。

第四台主机即为要作 Observer 的主机，除了要完成以上配置，修改 myid 为 4 外，还需 要修改 zoo.conf 文件：添加 peerType=observer。用于指定当前 Server 即为 Observer。

**peerType=observer**

server.1=192.168.1.101:2888:3888

server.2=192.168.1.101:2888:3888

server.3=192.168.1.101:2888:3888

server.4=192.168.1.101:2888:3888:observer

## 启动 zk 集群

使用 zkServer.sh start 命令，逐个启动每一个 Zookeeper 节点主机，并且每启动一台，就 查看一下其状态。

在启动第一台 zkOS1 时，其状态是如下的错误状态。因为其只有一台主机无法完成 Leader 选举。

再启动 zkOS2 后再查看这两台的状态，发现 zkOS1 为 Follower，zkOS2 为 Leader。(myid 最大的当选)

再启动 zkOS3，查看其状态，则为 Follower。

再启动 zkOS4 后查看其状态，则为 Observer。

## 高可用集群的容灾

服务器数量的奇数与偶数

对于 zk 集群中所包含服务器的数量存在一个误区：为了防止出现赞同票与反对票各占 一半的问题，必须要将服务器数量部署为奇数（不包含 Observer）。

其实，部署奇数台服务 器从某种意义上说确实比偶数台好，但不是为了防止投票平均现象的。因为投票平均，提案 无法通过，则该提案会被重提的。 前面我们说过，**无论是写操作投票，还是 Leader 选举投票，都必须过半才能通过，也就是说若出现超过半数的主机宕机，则投票永远无法通过。**

基于该理论，由 5 台主机构成的 集群，最多只允许 2 台宕机。而由 6 台构成的集群，其最多也只允许 2 台宕机。即，6 台与 5 台的容灾能力是相同的。

基于此容灾能力的原因，建议使用奇数台主机构成集群，以避免 资源浪费。 但从系统吞吐量上说，6 台主机的性能一定是高于 5 台的。所以使用 6 台主机并不是资源浪费。

## 容灾设计方案

对于一个高可用的系统，除了要设置多台主机部署为一个集群避免单点问题外，还需要 考虑将集群部署在多个机房、多个楼宇。对于多个机房、楼宇中集群也是不能随意部署的， 下面就多个机房的部署进行分析。 在多机房部署设计中，要充分考虑“过半原则”，也就是说，尽量要确保 zk 集群中有过
半的机器能够正常运行。

三机房部署

在生产环境下，三机房部署是最常见的、容灾性最好的部署方案。 假定 zk 集群中机器总数（不含 Observer）为 N，三个机房中部署的机器数量分别为 N1、N2、N3。

A、 N1 的值

N1 = （N - 1）/ 2，例如 N 为 15，则 N1 的值为 7。即要保证第一机房中具有刚不到半数的主机。

B、 N2 的值

N2 的值是一个取值范围，1 ~ （N – N1）/ 2。仍以 N 为 15 为例，N2 的取值范围为 1~4 台。也就是说，N2 的取值只要不超 4 台即可。

C、 N3 的值

N3 = N – N1 – N2。若 N 为 15，N2 为 4，则 N3 为 4。 为什么要这样设计呢？这样做可以保证，三个机房中若有一个机房断电或断网，其它两个机房中的机器仍可以正常对外提供服务。当然，若两个机房出现了问题，那么整个集群就瘫痪了。这种情况出现的概率要远低于一个机房出问题的情况。

双机房部署

官网没有给出较好的双机房部署的容灾方案。只能是让其中一个机房占有超过半数 的主机，使其做为主机房，而另一机房少于半数。当然，若主机房出现问题，则整个集群会瘫痪。

## 扩容与缩容

水平扩展对于提高系统服务能力，是一种非常重要的方式。但 zk 对于水平扩容与缩容 做的并不完美，主机数量的变化需要修改配置文件后整个集群进行重启。集群重启的方式有
两种：

整体重启

整体重启指将整个集群停止，然后更新所有主机的配置后再次重启集群。该方式会使集群停止对外服务，所以该方式慎用。

部分重启

部分重启指每次重启一小部分主机，注意不能多于半数，因为重启的主机过半，则意味着剩余主机就不会过半，那么这些剩余主机将无法产生合法投票结果，即若出现宕机无法进行选举，不宕机无法提供写服务。生产环境下一般为 1/3。该方式不影响系统对外服务.
