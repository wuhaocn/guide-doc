### redis 源码概览

    详细参照：http://redisbook.com/(参考原书：重点回顾)

#### 1.简单动态字符串

    Redis只会使用C字符串作为字面量,在大多数情况下,Redis使用SDS(Simple Dynamic String，简单动态字符串）作为字符串表示。
    相比C字符串,SDS具有以下优点：
        常数复杂度获取字符串长度。
        杜绝缓冲区溢出。
        减少修改字符串长度时所需的内存重分配次数。
        二进制安全。
        兼容部分 C 字符串函数。

     每个 sds.h/sdshdr 结构表示一个 SDS 值：
     struct sdshdr {
         // 记录 buf 数组中已使用字节的数量
         // 等于 SDS 所保存字符串的长度
         int len;
         // 记录 buf 数组中未使用字节的数量
         int free;
         // 字节数组，用于保存字符串
         char buf[];
     };

     阅读参考：
         SDS 的定义
         SDS 与 C 字符串的区别
         SDS API

### 2.链表

    链表被广泛用于实现 Redis 的各种功能， 比如列表键， 发布与订阅， 慢查询， 监视器， 等等。
    每个链表节点由一个 listNode 结构来表示， 每个节点都有一个指向前置节点和后置节点的指针， 所以 Redis 的链表实现是双端链表。
    每个链表使用一个 list 结构来表示， 这个结构带有表头节点指针、表尾节点指针、以及链表长度等信息。
    因为链表表头节点的前置节点和表尾节点的后置节点都指向 NULL ， 所以 Redis 的链表实现是无环链表。
    通过为链表设置不同的类型特定函数， Redis 的链表可以用于保存各种不同类型的值。

    Redis 的链表实现的特性可以总结如下：

        双端： 链表节点带有 prev 和 next 指针， 获取某个节点的前置节点和后置节点的复杂度都是 O(1) 。
        无环： 表头节点的 prev 指针和表尾节点的 next 指针都指向 NULL ， 对链表的访问以 NULL 为终点。
        带表头指针和表尾指针： 通过 list 结构的 head 指针和 tail 指针， 程序获取链表的表头节点和表尾节点的复杂度为 O(1) 。
        带链表长度计数器： 程序使用 list 结构的 len 属性来对 list 持有的链表节点进行计数， 程序获取链表中节点数量的复杂度为 O(1) 。
        多态： 链表节点使用 void* 指针来保存节点值， 并且可以通过 list 结构的 dup 、 free 、 match 三个属性为节点值设置类型特定函数， 所以链表可以用于保存各种不同类型的值。

    每个链表节点使用一个 adlist.h/listNode 结构来表示：

        typedef struct listNode {
            // 前置节点
            struct listNode *prev;
            // 后置节点
            struct listNode *next;
            // 节点的值
            void *value;
        } listNode;

        typedef struct list {
            // 表头节点
            listNode *head;
            // 表尾节点
            listNode *tail;
            // 链表所包含的节点数量
            unsigned long len;
            // 节点值复制函数
            void *(*dup)(void *ptr);
            // 节点值释放函数
            void (*free)(void *ptr);
            // 节点值对比函数
            int (*match)(void *ptr, void *key);
        } list;

         阅读参考：
            链表和链表节点的实现
            链表和链表节点的 API
            重点回顾

### 3.字典

    字典被广泛用于实现 Redis 的各种功能， 其中包括数据库和哈希键。
    Redis 中的字典使用哈希表作为底层实现， 每个字典带有两个哈希表， 一个用于平时使用， 另一个仅在进行 rehash 时使用。
    当字典被用作数据库的底层实现， 或者哈希键的底层实现时， Redis 使用 MurmurHash2 算法来计算键的哈希值。
    哈希表使用链地址法来解决键冲突， 被分配到同一个索引上的多个键值对会连接成一个单向链表。
    在对哈希表进行扩展或者收缩操作时， 程序需要将现有哈希表包含的所有键值对 rehash 到新哈希表里面， 并且这个 rehash 过程并不是一次性地完成的， 而是渐进式地完成的。

    Redis 字典所使用的哈希表由 dict.h/dictht 结构定义：
    typedef struct dictht {
        // 哈希表数组
        dictEntry **table;
        // 哈希表大小
        unsigned long size;
        // 哈希表大小掩码，用于计算索引值
        // 总是等于 size - 1
        unsigned long sizemask;
        // 该哈希表已有节点的数量
        unsigned long used;
    } dictht;

     阅读参考：
        字典的实现
        哈希算法
        解决键冲突
        rehash
        渐进式 rehash
        字典 API

### 4.跳跃表（重点）

    跳跃表是有序集合的底层实现之一， 除此之外它在 Redis 中没有其他应用。
    Redis 的跳跃表实现由 zskiplist 和 zskiplistNode 两个结构组成，
    其中 zskiplist 用于保存跳跃表信息（比如表头节点、表尾节点、长度），
    而 zskiplistNode 则用于表示跳跃表节点。
    每个跳跃表节点的层高都是 1 至 32 之间的随机数。
    在同一个跳跃表中， 多个节点可以包含相同的分值， 但每个节点的成员对象必须是唯一的。
    跳跃表中的节点按照分值大小进行排序， 当分值相同时， 节点按照成员对象的大小进行排序。

    阅读参考：
        跳跃表的实现
        跳跃表 API

### 5.整数集合

    整数集合是集合键的底层实现之一。
    整数集合的底层实现为数组， 这个数组以有序、无重复的方式保存集合元素， 在有需要时，
    程序会根据新添加元素的类型， 改变这个数组的类型。
    升级操作为整数集合带来了操作上的灵活性， 并且尽可能地节约了内存。
    整数集合只支持升级操作， 不支持降级操作。

    整数集合（intset）是 Redis 用于保存整数值的集合抽象数据结构， 它可以保存类型为 int16_t 、 int32_t 或者 int64_t 的整数值，
    并且保证集合中不会出现重复元素。

    每个 intset.h/intset 结构表示一个整数集合：
    typedef struct intset {
        // 编码方式
        uint32_t encoding;
        // 集合包含的元素数量
        uint32_t length;
        // 保存元素的数组
        int8_t contents[];
    } intset;

    阅读参考：
        整数集合的实现
        升级
        升级的好处
        降级
        整数集合 API

### 6.压缩链表

    压缩列表是一种为节约内存而开发的顺序型数据结构。
    压缩列表被用作列表键和哈希键的底层实现之一。
    压缩列表可以包含多个节点，每个节点可以保存一个字节数组或者整数值。
    添加新节点到压缩列表， 或者从压缩列表中删除节点， 可能会引发连锁更新操作， 但这种操作出现的几率并不高。

    压缩列表是 Redis 为了节约内存而开发的， 由一系列特殊编码的连续内存块组成的顺序型（sequential）数据结构。
    一个压缩列表可以包含任意多个节点（entry）， 每个节点可以保存一个字节数组或者一个整数值。
    图 7-1 展示了压缩列表的各个组成部分， 表 7-1 则记录了各个组成部分的类型、长度、以及用途。

    阅读参考：
        压缩列表的构成
        压缩列表节点的构成
        连锁更新
        压缩列表 API

### 7.对象

    Redis 数据库中的每个键值对的键和值都是一个对象。
    Redis 共有字符串、列表、哈希、集合、有序集合五种类型的对象， 每种类型的对象至少都有两种或以上的编码方式， 不同的编码可以在不同的使用场景上优化对象的使用效率。
    服务器在执行某些命令之前， 会先检查给定键的类型能否执行指定的命令， 而检查一个键的类型就是检查键的值对象的类型。
    Redis 的对象系统带有引用计数实现的内存回收机制， 当一个对象不再被使用时， 该对象所占用的内存就会被自动释放。
    Redis 会共享值为 0 到 9999 的字符串对象。
    对象会记录自己的最后一次被访问的时间， 这个时间可以用于计算对象的空转时间。

    阅读参考：
        对象的类型与编码
        字符串对象
        列表对象
        哈希对象
        集合对象
        有序集合对象
        类型检查与命令多态
        内存回收
        对象共享
        对象的空转时长
