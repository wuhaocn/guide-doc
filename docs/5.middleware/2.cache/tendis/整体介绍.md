## 综述

- 优点
  - 兼容 redis 原生协议
  - 文档健全
  - 发版较为频繁，现阶段比较活跃(2021.5 2021.4. 2021.3 2020.12 2020.11 )
  - 集群模式健全和 redis 类似【不过无法兼容】
- 缺点
  - 服务稳定性较差(可能是机器差的原因)
  - 环境兼容差(mac 编译不通过，或者不好编译)
  - 整体软件包版本较大 100 多兆(130M)，redis10M(3M)以下
  - redis 和 tendis 集群无法兼容
- 总结
  - 思路及场景比较好比较适合咱们
  - 开源版本成熟度不够 bug 较多
  - 现阶段用风险较大

### 1.简介

- 简介

  tendis 存储版是腾讯互娱 CROS DBA 团队 & 腾讯云数据库团队 自主设计和研发的开源分布式高性能 KV 存储。
  Tendis 存储版完全兼容 redis 协议，并使用 rocksdb 作为存储引擎。用户可以通过 redis client 访问 Tendis 存储版，几乎不用修改代码。
  同时，Tendis 存储版支持远超内存的磁盘容量，可以大大降低用户的存储成本。
  类似于 Redis Cluster, Tendis 存储版使用去中心化的集群管理架构。数据节点之间通过 gossip 协议通讯，用户访问集群中的任意数据节，
  请求都能路由到正确的节点。并且集群节点支持自动发现、故障探测、自动故障切换、数据搬迁等能力，极大降低运维成本。

- 详细文档请参照：
  http://tendis.cn/#/Tendisplus/%E6%95%B4%E4%BD%93%E4%BB%8B%E7%BB%8D/%E7%AE%80%E4%BB%8B

- 最近发版周期
  (2021.5 2021.4. 2021.3 2020.12 2020.11 )

### 2.功能

- Redis 兼容性

完全兼容 redis 协议，支持绝大多数 redis(4.0)的指令

- 持久化存储

使用 rocksdb 作为存储引擎，所有数据以特定格式存储在 rocksdb 中，最大支持 PB 级存储

- 去中心化架构

类似于 redis cluster 的分布式实现，所有节点通过 gossip 协议通讯，可指定 hashtag 来控制数据分布和访问，使用和运维成本极低。
【这个部署方式和 redis 一样】

- 水平扩展

集群支持增删节点，并且数据可以按照 slot 在任意两节点之间迁移，扩容和缩容过程中对应用运维人员透明，支持扩展至 1000 个节点。

- 故障高可用

自动检测故障节点，当故障发生，slave 会提升为 master 继续对外服务。

- redis 冷热混合存储关键组件

得益于 Tendis 存储版的设计和内部优化，Redis 和 Tendis 存储版可以一起工作成为 Tendis 冷热混合存储。
混合存储区非常适用于 KV 存储场景，并平衡了性能和成本。对于 redis，占用大量存储空间的冷数据降冷后可以最多减少 80%的成本，同时保证热数据在 redis 的访问性能。

### 3.性能

- 官方数据

```
  CPU:2.50 GHz,48 core
  DISK:NVMe SSD
  MEM:192GB
```

![](http://tendis.cn/Tendisplus/%E6%95%B4%E4%BD%93%E4%BB%8B%E7%BB%8D/pic/qps_on_commands.png)

key 较大时性能会 set 直线下降

![](http://tendis.cn/Tendisplus/%E6%95%B4%E4%BD%93%E4%BB%8B%E7%BB%8D/pic/qps_on_bytes.png)

### 4.redis 兼容性

目前 Tendis 集群版兼容了大部分的 Redis4.0 的绝大多数命令，Redis 原运维和使用习惯基本可以无缝迁移过来。

但部分命令还不支持，具体包括：

- PUBSUB
- GEO
- MULTI/EXEC/WATCH/UNWATCH/DISCARD
  这些命令暂不支持，部分命令正在开发中。

- EVAL, 2.2.0 开始支持

- EVALSHA, 暂不支持

* 对于扫描操作 SCAN, 2.2.0 开始支持

HSCAN/SSCAN/ZSCAN，用法基本一致，但命令返回的 cursor 是一个字符串，而不是数字。
这个需要注意。详细
另外，还有部分 LIST 命令的性能可能比较差，因为时间复杂度是 O(n)，包括：

- LINSERT
- LREM
- LTRIM
  keys 和 dbsize 都需要遍历所有数据，因此执行效率会比较慢，在生产环境中慎用。
  部分管理命令不支持，但可以通过其他命令替代
- bgsave, 可通过 backup 替代
- debug sleep，可通过 tendisadmin sleep 替代
- flushdb 并不是只删除当前 db 的数据，而是清理所有数据，等价于 flushall。在集群模式中，由于只支持 0 号 db，所以两者本来也是一样的。

### 6.问题列表

- master 节点总是挂掉

无明显挂掉日志，需要跟一下代码

```
I0629 14:02:52.048372 29155 mpov.cpp:173] registerIncrSync storeIdArg:6 dstStoreIdArg:6 binlogPosArg:38901 listenIpArg:10.3.4.111 listenPortArg:51002
E0629 14:02:52.048429 29155 mpov.cpp:245] -ERR invalid binlogPos,storeId:6,master firstPos:52460,slave binlogPos:38901,lastFlushBinlogId:0
E0629 14:02:52.116376 29157 mpov.cpp:245] -ERR invalid binlogPos,storeId:2,master firstPos:52608,slave binlogPos:38918,lastFlushBinlogId:0
W0629 14:02:52.743296 29153 server_entry.cpp:990] [master] session id:1536214 socket borrowed
```

redis 同等条件测试也会有异常情况，反应为超时较多，单 redis 节点不会挂掉

- master 节点挂掉后不会自动切换

```
f57e9de79123c4ab9581aecc5fdf96665a304cc1 10.3.4.111:51002@61002 slave 6c9c067f264404db2dd487ab450ed27dcbe71e09 0 1624947904221 1 connected
1503e79d88b7953b1d13461756b47ddc6e98a6d6 10.3.4.111:51003@61003 myself,master - 0 1624947900000 2 connected 5462-10922
e4e78464d23ef1e97bae90aa6792c18f593f45a3 10.3.4.111:51005@61005 master - 0 1624947903214 4 connected 10923-16383
6c9c067f264404db2dd487ab450ed27dcbe71e09 10.3.4.111:51001@61001 master,fail - 1624946574949 1624946569000 1 disconnected 0-5461
8c46938569d322cb1f1fa9b17e4ac454c33a69b5 10.3.4.111:51006@61006 slave e4e78464d23ef1e97bae90aa6792c18f593f45a3 0 1624947904000 5 connected
a9007924fb2d018f1173cff0283a3404ef78a6af 10.3.4.111:51004@61004 slave 1503e79d88b7953b1d13461756b47ddc6e98a6d6 0 1624947901000 3 connected
```

- 社区相应互动不及时
  - 由于腾讯不是专门做开源的所以这块处理，估计反应慢一些
  - github 提交的 issues，简单的一般会立马回复，麻烦一点的 10 多天没有响应
  - github issues 总共 116 关了 60 剩余 56 打开
