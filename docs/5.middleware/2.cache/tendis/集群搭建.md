### 1.集群搭建概要

tendis 集群搭建示例

![](http://10.3.4.111:8082/file/get/img/d94a6f35-b267-4a9c-9b46-8e2c8958fa78)

- 编译安装，配置集群配置启动
- cluster meet 加入集群
- cluster addslots 分配 hash 槽
- cluster replicate 设置主从
- cluster 添加节点(TODO)
- cluster 删除节点(TODO)

下载地址： https://github.com/Tencent/Tendis/releases

### 2.配置

- tendisplus51001.conf

```
# tendisplus configuration for testing
port 51001
bind 10.3.4.111
daemon on
cluster-enabled yes
loglevel notice
logdir ./home/51001/log
dumpdir ./home/51001/dump
dir ./home/51001/db
pidfile ./home/51001/tendisplus.pid
slowlog ./home/51001/log/slowlog
rocks.blockcachemb 4096
executorThreadNum 48
```

依次类推创建 conf 文件
51002 51003 51004 51005 51006

- 创建 db 目录
  mkdir ./home/51001/db
  依次类推创建 db 文件目录
  51002 51003 51004 51005 51006

### 3.握手

- 集群握手

```
./redis-cli -h 10.3.4.111 -p 51001

10.3.4.111:51001> cluster meet 10.3.4.111 51002
OK
10.3.4.111:51001> cluster meet 10.3.4.111 51003
OK
10.3.4.111:51001> cluster meet 10.3.4.111 51004
OK
10.3.4.111:51001> cluster meet 10.3.4.111 51005
OK
10.3.4.111:51001> cluster meet 10.3.4.111 51006
OK
```

### 4.划分切片

```
./redis-cli -h 10.3.4.111 -p 51001 cluster addslots {0..5461}

./redis-cli -h 10.3.4.111 -p 51003 cluster addslots {5462..10922}

./redis-cli -h 10.3.4.111 -p 51005 cluster addslots {10923..16383}
```

### 5.集群查看

- 查看集群整体信息

```
10.3.4.111:51002> cluster info
cluster_state:ok
cluster_slots_assigend:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_known_nodes:6
cluster_size:3
cluster_current_epoch:5
cluster_my_epoch:0
cluster_stats_messages_ping_sent:1028
cluster_stats_messages_pong_sent:1051
cluster_stats_messages_sent:2079
cluster_stats_messages_ping_received:1046
cluster_stats_messages_pong_received:1028
cluster_stats_messages_meet_received:5
cluster_stats_messages_received:2079
```

- 查看集群节点 ID

```
10.3.4.111:51002> cluster nodes
f57e9de79123c4ab9581aecc5fdf96665a304cc1 10.3.4.111:51002@61002 myself,master - 0 1624879665000 0 connected
e4e78464d23ef1e97bae90aa6792c18f593f45a3 10.3.4.111:51005@61005 master - 0 1624879666019 4 connected 10923-16383
6c9c067f264404db2dd487ab450ed27dcbe71e09 10.3.4.111:51001@61001 master - 0 1624879665000 1 connected 0-5461
1503e79d88b7953b1d13461756b47ddc6e98a6d6 10.3.4.111:51003@61003 master - 0 1624879667021 2 connected 5462-10922
8c46938569d322cb1f1fa9b17e4ac454c33a69b5 10.3.4.111:51006@61006 master - 0 1624879664000 5 connected
a9007924fb2d018f1173cff0283a3404ef78a6af 10.3.4.111:51004@61004 master - 0 1624879665017 3 connected
```

### 6.主从复制

- 上述步骤已获节点 id

```
./redis-cli -h 10.3.4.111 -p 51002 cluster  replicate 6c9c067f264404db2dd487ab450ed27dcbe71e09
OK
./redis-cli -h 10.3.4.111 -p 51004 cluster replicate 1503e79d88b7953b1d13461756b47ddc6e98a6d6
OK
./redis-cli -h 10.3.4.111 -p 51006 cluster replicate e4e78464d23ef1e97bae90aa6792c18f593f45a3
OK
```

- 完成后查看集群信息

```
10.3.4.111:51004> cluster nodes
1503e79d88b7953b1d13461756b47ddc6e98a6d6 10.3.4.111:51003@61003 master - 0 1624935112000 2 connected 5462-10922
8c46938569d322cb1f1fa9b17e4ac454c33a69b5 10.3.4.111:51006@61006 slave e4e78464d23ef1e97bae90aa6792c18f593f45a3 0 1624935113395 5 connected
a9007924fb2d018f1173cff0283a3404ef78a6af 10.3.4.111:51004@61004 myself,slave 1503e79d88b7953b1d13461756b47ddc6e98a6d6 0 1624935112000 3 connected
e4e78464d23ef1e97bae90aa6792c18f593f45a3 10.3.4.111:51005@61005 master - 0 1624935112393 4 connected 10923-16383
6c9c067f264404db2dd487ab450ed27dcbe71e09 10.3.4.111:51001@61001 master - 0 1624935114398 1 connected 0-5461
f57e9de79123c4ab9581aecc5fdf96665a304cc1 10.3.4.111:51002@61002 slave 6c9c067f264404db2dd487ab450ed27dcbe71e09 0 1624935114000 1 connected
```

./redis-cli -h 10.3.4.111 -p 51006 cluster replicate 06b07e38210375c4cb66b1de39f0525cf01eade4
