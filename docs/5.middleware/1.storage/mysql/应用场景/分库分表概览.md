# [MySQL 分库分表方案，总结的非常好！](https://www.cnblogs.com/aksir/p/9085694.html)

前言

公司最近在搞服务分离，数据切分方面的东西，因为单张包裹表的数据量实在是太大，并且还在以每天 60W 的量增长。

之前了解过数据库的分库分表，读过几篇博文，但就只知道个模糊概念， 而且现在回想起来什么都是模模糊糊的。

今天看了一下午的数据库分库分表，看了很多文章，现在做个总结，“摘抄”下来。（但更期待后期的实操） 会从以下几个方面说起：

第一部分：实际网站发展过程中面临的问题。

第二部分：有哪几种切分方式，垂直和水平的区别和适用面。

第三部分：目前市面有的一些开源产品，技术，它们的优缺点是什么。

第四部分：可能是最重要的，为什么不建议水平分库分表！？这能让你能在规划前期谨慎的对待，规避掉切分造成的问题。

### 名词解释

库：**database**；表：**table**；分库分表：**sharding**

## 数据库架构演变

刚开始我们只用单机数据库就够了，随后面对越来越多的请求，我们将数据库的**写操作**和**读操作**进行分离， 使用多个从库副本（**Slaver Replication**）负责读，使用主库（**Master**）负责写， 从库从主库同步更新数据，保持数据一致。架构上就是数据库主从同步。 从库可以水平扩展，所以更多的读请求不成问题。

但是当用户量级上来后，写请求越来越多，该怎么办？加一个 Master 是不能解决问题的， 因为数据要保存一致性，写操作需要 2 个 master 之间同步，相当于是重复了，而且更加复杂。

这时就需要用到分库分表（**sharding**），对写操作进行切分。

## 分库分表前的问题

任何问题都是太大或者太小的问题，我们这里面对的数据量太大的问题。

### 用户请求量太大

因为单服务器 TPS，内存，IO 都是有限的。

解决方法：分散请求到多个服务器上； 其实用户请求和执行一个 sql 查询是本质是一样的，都是请求一个资源，只是用户请求还会经过网关，路由，http 服务器等。

### 单库太大

单个数据库处理能力有限；单库所在服务器上磁盘空间不足；

单库上操作的 IO 瓶颈 解决方法：切分成更多更小的库

### 单表太大

CRUD 都成问题；索引膨胀，查询超时

解决方法：切分成多个数据集更小的表。

## 分库分表的方式方法

一般就是**垂直切分**和**水平切分**，这是一种结果集描述的切分方式，是物理空间上的切分。

我们从面临的问题，开始解决，阐述： 首先是用户请求量太大，我们就堆机器搞定（这不是本文重点）。

然后是单个库太大，这时我们要看是因为**表多而导致数据多**，还是因为**单张表里面的数据多**。

如果是因为表多而数据多，使用垂直切分，根据业务切分成不同的库。

如果是因为单张表的数据量太大，这时要用水平切分，即把表的数据按**某种规则**切分成多张表，甚至多个库上的多张表。

**分库分表的顺序应该是先垂直分，后水平分。** 因为垂直分更简单，更符合我们处理现实世界问题的方式。

### 垂直拆分

- 垂直分表

也就是“大表拆小表”，基于列字段进行的。一般是表中的字段较多，将不常用的， 数据较大，长度较长（比如 text 类型字段）的拆分到“扩展表“。一般是针对那种几百列的大表，也避免查询时，数据量太大造成的“跨页”问题。

- 垂直分库

垂直分库针对的是一个系统中的不同业务进行拆分，比如用户 User 一个库，商品 Producet 一个库，订单 Order 一个库。 切分后，要放在多个服务器上，而不是一个服务器上。为什么？ 我们想象一下，一个购物网站对外提供服务，会有用户，商品，订单等的 CRUD。没拆分之前， 全部都是落到单一的库上的，这会让数据库的**单库处理能力成为瓶颈**。按垂直分库后，如果还是放在一个数据库服务器上， 随着用户量增大，这会让**单个数据库的处理能力成为瓶颈**，还有**单个服务器的磁盘空间，内存，tps 等非常吃紧**。 所以我们要拆分到多个服务器上，这样上面的问题都解决了，以后也不会面对单机资源问题。

数据库业务层面的拆分，和服务的“治理”，“降级”机制类似，也能对不同业务的数据分别的进行管理，维护，监控，扩展等。 数据库往往最容易成为应用系统的瓶颈，而数据库本身属于“有状态”的，相对于 Web 和应用服务器来讲，是比较难实现“横向扩展”的。 数据库的连接资源比较宝贵且单机处理能力也有限，在高并发场景下，垂直分库一定程度上能够突破 IO、连接数及单机硬件资源的瓶颈。

### 水平拆分

- 水平分表

针对数据量巨大的单张表（比如订单表），按照某种规则（**RANGE**,**HASH 取模**等），切分到多张表里面去。 但是这些表还是在同一个库中，所以**库级别的数据库操作还是有 IO 瓶颈**。不建议采用。

- 水平分库分表

将单张表的数据切分到多个服务器上去，每个服务器具有相应的库与表，只是表中数据集合不同。 水平分库分表能够有效的缓解单机和单库的性能瓶颈和压力，突破 IO、连接数、硬件资源等的瓶颈。

- 水平分库分表切分规则

**RANGE**

从 0 到 10000 一个表，10001 到 20000 一个表；

**HASH 取模**

一个商场系统，一般都是将用户，订单作为主表，然后将和它们相关的作为附表，这样不会造成跨库事务之类的问题。 取**用户 id**，然后**hash 取模**，分配到不同的数据库上。

**地理区域**

比如按照华东，华南，华北这样来区分业务，七牛云应该就是如此。

**时间**

按照时间切分，就是将 6 个月前，甚至一年前的数据切出去放到另外的一张表，因为随着时间流逝，这些表的数据 被查询的概率变小，所以没必要和“热数据”放在一起，这个也是“冷热数据分离”。

## 分库分表后面临的问题

### 事务支持

分库分表后，就成了**分布式事务**了。

如果依赖数据库本身的分布式事务管理功能去执行事务，将付出高昂的性能代价； 如果由应用程序去协助控制，形成程序逻辑上的事务，又会造成编程方面的负担。

### 多库结果集合并（group by，order by）

TODO

### 跨库 join

TODO 分库分表后表之间的关联操作将受到限制，我们无法 join 位于不同分库的表，也无法 join 分表粒度不同的表， 结果原本一次查询能够完成的业务，可能需要多次查询才能完成。粗略的解决方法： 全局表：基础数据，所有库都拷贝一份。 字段冗余：这样有些字段就不用 join 去查询了。 系统层组装：分别查询出所有，然后组装起来，较复杂。

## 分库分表方案产品

目前市面上的分库分表中间件相对较多，其中基于代理方式的有 MySQL Proxy 和 Amoeba， 基于 Hibernate 框架的是 Hibernate Shards，基于 jdbc 的有当当 sharding-jdbc， 基于 mybatis 的类似 maven 插件式的有蘑菇街的蘑菇街 TSharding， 通过重写 spring 的 ibatis template 类的 Cobar Client。

还有一些大公司的开源产品：

![](https://mmbiz.qpic.cn/mmbiz_jpg/tuSaKc6SfPoRLAFtmI4PGFzYzudYsr3FkFx3yAVxhI0sUJgWDSy6W0PYWvCsF2SYFtMLUoJ62NiaewdmSR8w0sw/640)
