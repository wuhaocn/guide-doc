<div class="article-inner">

<header class="article-header">

<h1 class="article-title" itemprop="name">
精尽 MyBatis 源码分析 —— 事务模块
</h1>

<a href="/MyBatis/transaction-package/" class="archive-article-date">
<time style="display: none;" datetime="2020-01-18T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2020-01-19</time>
</a>

</header>

<div class="article-entry" itemprop="articleBody">

<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>本文，我们来分享 MyBatis 的事务模块，对应 <code>transaction</code> 包。如下图所示：<a href="http://static2.iocoder.cn/images/MyBatis/2020_01_19/01.png" rel="external nofollow noopener noreferrer" target="_blank"><code>transaction</code> 包</a></p>
<p>在 <a href="http://svip.iocoder.cn/MyBatis/intro">《精尽 MyBatis 源码解析 —— 项目结构一览》</a> 中，简单介绍了这个模块如下：</p>
<blockquote>
<p>MyBatis 对数据库中的事务进行了抽象，其自身提供了<strong>相应的事务接口和简单实现</strong>。</p>
<p>在很多场景中，MyBatis 会与 Spring 框架集成，并由 <strong>Spring 框架管理事务</strong>。</p>
</blockquote>
<p>本文涉及的类如下图所示：<a href="http://static2.iocoder.cn/images/MyBatis/2020_01_19/02.png" rel="external nofollow noopener noreferrer" target="_blank">类图</a></p>
<p>下面，我们就一起来看看具体的源码实现。</p>
<h1 id="2-Transaction"><a href="#2-Transaction" class="headerlink" title="2. Transaction"></a>2. Transaction</h1><p><code>org.apache.ibatis.transaction.Transaction</code> ，事务接口。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Transaction.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transaction</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得连接</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * Retrieve inner database connection</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> DataBase connection</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SQLException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 事务提交</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * Commit inner database connection.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SQLException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 事务回滚</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * Rollback inner database connection.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SQLException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 关闭连接</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * Close inner database connection.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SQLException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得事务超时时间</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * Get transaction timeout if set</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SQLException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Integer <span class="title">getTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>连接相关<ul>
<li><code>#getConnection()</code> 方法，获得连接。</li>
<li><code>#close()</code> 方法，关闭连接。</li>
</ul>
</li>
<li>事务相关<ul>
<li><code>#commit()</code> 方法，事务提交。</li>
<li><code>#rollback()</code> 方法，事务回滚。</li>
<li><code>#getTimeout()</code> 方法，事务超时时间。实际上，目前这个方法都是空实现。</li>
</ul>
</li>
</ul>
<h2 id="2-1-JdbcTransaction"><a href="#2-1-JdbcTransaction" class="headerlink" title="2.1 JdbcTransaction"></a>2.1 JdbcTransaction</h2><p><code>org.apache.ibatis.transaction.jdbc.JdbcTransaction</code> ，实现 Transaction 接口，基于 JDBC 的事务实现类。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// JdbcTransaction.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcTransaction</span> <span class="keyword">implements</span> <span class="title">Transaction</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(JdbcTransaction.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Connection 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Connection connection;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * DataSource 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> DataSource dataSource;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 事务隔离级别</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> TransactionIsolationLevel level;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否自动提交</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">boolean</span> autoCommit;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JdbcTransaction</span><span class="params">(DataSource ds, TransactionIsolationLevel desiredLevel, <span class="keyword">boolean</span> desiredAutoCommit)</span> </span>{</span><br><span class="line">        dataSource = ds;</span><br><span class="line">        level = desiredLevel;</span><br><span class="line">        autoCommit = desiredAutoCommit;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JdbcTransaction</span><span class="params">(Connection connection)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.connection = connection;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="comment">// 连接为空，进行创建</span></span><br><span class="line">        <span class="keyword">if</span> (connection == <span class="keyword">null</span>) {</span><br><span class="line">            openConnection();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="comment">// 非自动提交，则执行提交事务</span></span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="keyword">null</span> &amp;&amp; !connection.getAutoCommit()) {</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) {</span><br><span class="line">                log.debug(<span class="string">"Committing JDBC Connection ["</span> + connection + <span class="string">"]"</span>);</span><br><span class="line">            }</span><br><span class="line">            connection.commit();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="comment">// 非自动提交。则回滚事务</span></span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="keyword">null</span> &amp;&amp; !connection.getAutoCommit()) {</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) {</span><br><span class="line">                log.debug(<span class="string">"Rolling back JDBC Connection ["</span> + connection + <span class="string">"]"</span>);</span><br><span class="line">            }</span><br><span class="line">            connection.rollback();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">if</span> (connection != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// 重置连接为自动提交</span></span><br><span class="line">            resetAutoCommit();</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) {</span><br><span class="line">                log.debug(<span class="string">"Closing JDBC Connection ["</span> + connection + <span class="string">"]"</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 关闭连接</span></span><br><span class="line">            connection.close();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置指定的 autoCommit 属性</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> desiredAutoCommit 指定的 autoCommit 属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setDesiredAutoCommit</span><span class="params">(<span class="keyword">boolean</span> desiredAutoCommit)</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">if</span> (connection.getAutoCommit() != desiredAutoCommit) {</span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) {</span><br><span class="line">                    log.debug(<span class="string">"Setting autocommit to "</span> + desiredAutoCommit + <span class="string">" on JDBC Connection ["</span> + connection + <span class="string">"]"</span>);</span><br><span class="line">                }</span><br><span class="line">                connection.setAutoCommit(desiredAutoCommit);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (SQLException e) {</span><br><span class="line">            <span class="comment">// Only a very poorly implemented driver would fail here,</span></span><br><span class="line">            <span class="comment">// and there's not much we can do about that.</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TransactionException(<span class="string">"Error configuring AutoCommit.  "</span></span><br><span class="line">                    + <span class="string">"Your driver may not support getAutoCommit() or setAutoCommit(). "</span></span><br><span class="line">                    + <span class="string">"Requested setting: "</span> + desiredAutoCommit + <span class="string">".  Cause: "</span> + e, e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重置 autoCommit 属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">resetAutoCommit</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="keyword">if</span> (!connection.getAutoCommit()) {</span><br><span class="line">                <span class="comment">// MyBatis does not call commit/rollback on a connection if just selects were performed.</span></span><br><span class="line">                <span class="comment">// Some databases start transactions with select statements</span></span><br><span class="line">                <span class="comment">// and they mandate a commit/rollback before closing the connection.</span></span><br><span class="line">                <span class="comment">// A workaround is setting the autocommit to true before closing the connection.</span></span><br><span class="line">                <span class="comment">// Sybase throws an exception here.</span></span><br><span class="line">                <span class="keyword">if</span> (log.isDebugEnabled()) {</span><br><span class="line">                    log.debug(<span class="string">"Resetting autocommit to true on JDBC Connection ["</span> + connection + <span class="string">"]"</span>);</span><br><span class="line">                }</span><br><span class="line">                connection.setAutoCommit(<span class="keyword">true</span>);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (SQLException e) {</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) {</span><br><span class="line">                log.debug(<span class="string">"Error resetting autocommit to true "</span></span><br><span class="line">                        + <span class="string">"before closing the connection.  Cause: "</span> + e);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得 Connection 对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> SQLException 获得失败</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">openConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) {</span><br><span class="line">            log.debug(<span class="string">"Opening JDBC Connection"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 获得连接</span></span><br><span class="line">        connection = dataSource.getConnection();</span><br><span class="line">        <span class="comment">// 设置隔离级别</span></span><br><span class="line">        <span class="keyword">if</span> (level != <span class="keyword">null</span>) {</span><br><span class="line">            connection.setTransactionIsolation(level.getLevel());</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 设置 autoCommit 属性</span></span><br><span class="line">        setDesiredAutoCommit(autoCommit);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>简单，胖友瞄一瞄。</li>
</ul>
<h2 id="2-2-ManagedTransaction"><a href="#2-2-ManagedTransaction" class="headerlink" title="2.2 ManagedTransaction"></a>2.2 ManagedTransaction</h2><p><code>org.apache.ibatis.transaction.managed.ManagedTransaction</code> ，实现 Transaction 接口，基于容器管理的事务实现类。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ManagedTransaction.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ManagedTransaction</span> <span class="keyword">implements</span> <span class="title">Transaction</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log log = LogFactory.getLog(ManagedTransaction.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Connection 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Connection connection;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * DataSource 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 事务隔离级别</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> TransactionIsolationLevel level;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否关闭连接</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 这个属性是和 {<span class="doctag">@link</span> org.apache.ibatis.transaction.jdbc.JdbcTransaction} 不同的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> closeConnection;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ManagedTransaction</span><span class="params">(Connection connection, <span class="keyword">boolean</span> closeConnection)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.connection = connection;</span><br><span class="line">        <span class="keyword">this</span>.closeConnection = closeConnection;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ManagedTransaction</span><span class="params">(DataSource ds, TransactionIsolationLevel level, <span class="keyword">boolean</span> closeConnection)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.dataSource = ds;</span><br><span class="line">        <span class="keyword">this</span>.level = level;</span><br><span class="line">        <span class="keyword">this</span>.closeConnection = closeConnection;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Connection <span class="title">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="comment">// 连接为空，进行创建</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.connection == <span class="keyword">null</span>) {</span><br><span class="line">            openConnection();</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.connection;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="comment">// Does nothing</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rollback</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="comment">// Does nothing</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="comment">// 如果开启关闭连接功能，则关闭连接</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.closeConnection &amp;&amp; <span class="keyword">this</span>.connection != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) {</span><br><span class="line">                log.debug(<span class="string">"Closing JDBC Connection ["</span> + <span class="keyword">this</span>.connection + <span class="string">"]"</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">this</span>.connection.close();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">openConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) {</span><br><span class="line">            log.debug(<span class="string">"Opening JDBC Connection"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 获得连接</span></span><br><span class="line">        <span class="keyword">this</span>.connection = <span class="keyword">this</span>.dataSource.getConnection();</span><br><span class="line">        <span class="comment">// 设置隔离级别</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.level != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">this</span>.connection.setTransactionIsolation(<span class="keyword">this</span>.level.getLevel());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">getTimeout</span><span class="params">()</span> <span class="keyword">throws</span> SQLException </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>和 JdbcTransaction 相比，少了 <code>autoCommit</code> 属性，空实现 <code>#commit()</code> 和 <code>#rollback()</code> 方法。因此，事务的管理，交给了容器。</li>
<li>简单了解下就成，实际没用过这个。</li>
</ul>
<h2 id="2-3-SpringManagedTransaction"><a href="#2-3-SpringManagedTransaction" class="headerlink" title="2.3 SpringManagedTransaction"></a>2.3 SpringManagedTransaction</h2><p><code>org.mybatis.spring.transaction.SpringManagedTransaction</code> ，实现 Transaction 接口，基于 Spring 管理的事务实现类。实际真正在使用的，本文暂时不分享，感兴趣的胖友可以自己先愁一愁 <a href="https://github.com/eddumelendez/mybatis-spring/blob/master/src/main/java/org/mybatis/spring/transaction/SpringManagedTransaction.java" rel="external nofollow noopener noreferrer" target="_blank">SpringManagedTransaction</a> 。</p>
<h1 id="3-TransactionFactory"><a href="#3-TransactionFactory" class="headerlink" title="3. TransactionFactory"></a>3. TransactionFactory</h1><p><code>org.apache.ibatis.transaction.TransactionFactory</code> ，Transaction 工厂接口。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// TransactionFactory.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionFactory</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Sets transaction factory custom properties.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 设置工厂的属性</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> props 属性</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties props)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a {<span class="doctag">@link</span> Transaction} out of an existing connection.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 创建 Transaction 事务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> conn Existing database connection</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Transaction</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 3.1.0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Transaction <span class="title">newTransaction</span><span class="params">(Connection conn)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a {<span class="doctag">@link</span> Transaction} out of a datasource.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 创建 Transaction 事务</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> dataSource DataSource to take the connection from</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> level      Desired isolation level</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> autoCommit Desired autocommit</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Transaction</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@since</span> 3.1.0</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">Transaction <span class="title">newTransaction</span><span class="params">(DataSource dataSource, TransactionIsolationLevel level, <span class="keyword">boolean</span> autoCommit)</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-1-JdbcTransactionFactory"><a href="#3-1-JdbcTransactionFactory" class="headerlink" title="3.1 JdbcTransactionFactory"></a>3.1 JdbcTransactionFactory</h2><p><code>org.apache.ibatis.transaction.jdbc.JdbcTransactionFactory</code> ，实现 TransactionFactory 接口，JdbcTransaction 工厂实现类。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// JdbcTransactionFactory.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JdbcTransactionFactory</span> <span class="keyword">implements</span> <span class="title">TransactionFactory</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties props)</span> </span>{</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Transaction <span class="title">newTransaction</span><span class="params">(Connection conn)</span> </span>{</span><br><span class="line">        <span class="comment">// 创建 JdbcTransaction 对象</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcTransaction(conn);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Transaction <span class="title">newTransaction</span><span class="params">(DataSource ds, TransactionIsolationLevel level, <span class="keyword">boolean</span> autoCommit)</span> </span>{</span><br><span class="line">        <span class="comment">// 创建 JdbcTransaction 对象</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JdbcTransaction(ds, level, autoCommit);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>胖友随便瞅一眼。</li>
</ul>
<h2 id="3-2-ManagedTransactionFactory"><a href="#3-2-ManagedTransactionFactory" class="headerlink" title="3.2 ManagedTransactionFactory"></a>3.2 ManagedTransactionFactory</h2><p><code>org.apache.ibatis.transaction.managed.ManagedTransactionFactory</code> ，实现 TransactionFactory 接口，ManagedTransaction 工厂实现类。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ManagedTransactionFactory.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ManagedTransactionFactory</span> <span class="keyword">implements</span> <span class="title">TransactionFactory</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 是否关闭连接</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> closeConnection = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProperties</span><span class="params">(Properties props)</span> </span>{</span><br><span class="line">        <span class="comment">// 获得是否关闭连接属性</span></span><br><span class="line">        <span class="keyword">if</span> (props != <span class="keyword">null</span>) {</span><br><span class="line">            String closeConnectionProperty = props.getProperty(<span class="string">"closeConnection"</span>);</span><br><span class="line">            <span class="keyword">if</span> (closeConnectionProperty != <span class="keyword">null</span>) {</span><br><span class="line">                closeConnection = Boolean.valueOf(closeConnectionProperty);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Transaction <span class="title">newTransaction</span><span class="params">(Connection conn)</span> </span>{</span><br><span class="line">        <span class="comment">// 创建 ManagedTransaction 对象</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ManagedTransaction(conn, closeConnection);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Transaction <span class="title">newTransaction</span><span class="params">(DataSource ds, TransactionIsolationLevel level, <span class="keyword">boolean</span> autoCommit)</span> </span>{</span><br><span class="line">        <span class="comment">// Silently ignores autocommit and isolation level, as managed transactions are entirely</span></span><br><span class="line">        <span class="comment">// controlled by an external manager.  It's silently ignored so that</span></span><br><span class="line">        <span class="comment">// code remains portable between managed and unmanaged configurations.</span></span><br><span class="line">        <span class="comment">// 创建 ManagedTransaction 对象</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ManagedTransaction(ds, level, closeConnection);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-3-SpringManagedTransactionFactory"><a href="#3-3-SpringManagedTransactionFactory" class="headerlink" title="3.3 SpringManagedTransactionFactory"></a>3.3 SpringManagedTransactionFactory</h2><p><code>org.mybatis.spring.transaction.SpringManagedTransactionFactory</code> ，实现 TransactionFactory 接口，SpringManagedTransaction 工厂实现类。实际真正在使用的，本文暂时不分享，感兴趣的胖友可以自己先愁一愁 <a href="https://github.com/eddumelendez/mybatis-spring/blob/c5834f93bd4a5879f86854fe188957787e56ef95/src/main/java/org/mybatis/spring/transaction/SpringManagedTransactionFactory.java" rel="external nofollow noopener noreferrer" target="_blank">SpringManagedTransactionFactory</a> 。</p>
<h1 id="666-彩蛋"><a href="#666-彩蛋" class="headerlink" title="666. 彩蛋"></a>666. 彩蛋</h1><p>水文一篇，开心。</p>
<p>参考和推荐如下文章：</p>
<ul>
<li>祖大俊 <a href="https://my.oschina.net/zudajun/blog/666764" rel="external nofollow noopener noreferrer" target="_blank">《Mybatis3.3.x技术内幕（三）：Mybatis事务管理（将颠覆你心中目前对事务的理解）》</a></li>
<li>徐郡明 <a href="https://item.jd.com/12125531.html" rel="external nofollow noopener noreferrer" target="_blank">《MyBatis 技术内幕》</a> 的 <a href="#">「2.7 Transaction」</a> 小节</li>
</ul>

</div>
<div class="article-info article-info-index">

<div class="article-category tagcloud">
<i class="icon-book icon"></i>
<ul class="article-tag-list">

<li class="article-tag-list-item">
<a href="/categories/MyBatis//" class="article-tag-list-link color3">MyBatis</a>
</li>

</ul>
</div>

<div class="clearfix"></div>
</div>
</div>
