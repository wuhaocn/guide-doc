<div id="wrapper" class="body-wrap">
<div class="menu-l">
<div class="canvas-wrap">
<canvas data-colors="#eaeaea" data-sectionheight="100" data-contentid="js-content" id="myCanvas1" class="anm-canvas"></canvas>
</div>
<div id="js-content" class="content-ll">
<article id="post-Spring-Boot/AutoConfiguration" class="article article-type-post " itemscope="" itemprop="blogPost">
<div class="article-inner">

<header class="article-header">

<h1 class="article-title" itemprop="name">
ç²¾å°½ Spring Boot æºç åˆ†æ â€”â€” è‡ªåŠ¨é…ç½®
</h1>

<a href="/Spring-Boot/AutoConfiguration/" class="archive-article-date">
<time style="display: none;" datetime="2021-01-09T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2021-01-10</time>
</a>

</header>

<div class="article-entry" itemprop="articleBody">

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥åˆ†äº« Spring Boot è‡ªåŠ¨é…ç½®çš„å®ç°æºç ã€‚åœ¨æ•…äº‹çš„å¼€å§‹ï¼Œæˆ‘ä»¬å…ˆæ¥è¯´ä¸¤ä¸ªäº‹æƒ…ï¼š</p>
<ul>
<li>è‡ªåŠ¨é…ç½®å’Œè‡ªåŠ¨è£…é…çš„åŒºåˆ«ï¼Ÿ</li>
<li>Spring Boot é…ç½®çš„åŸç†</li>
</ul>
<h1 id="2-è‡ªåŠ¨é…ç½®-V-S-è‡ªåŠ¨è£…é…"><a href="#2-è‡ªåŠ¨é…ç½®-V-S-è‡ªåŠ¨è£…é…" class="headerlink" title="2. è‡ªåŠ¨é…ç½® V.S è‡ªåŠ¨è£…é…"></a>2. è‡ªåŠ¨é…ç½® V.S è‡ªåŠ¨è£…é…</h1><p>åœ¨è¿™ç¯‡æ–‡ç« çš„å¼€å§‹ï¼Œè‰¿è‰¿æ˜¯æœ‰ç‚¹æ··æ·†è‡ªåŠ¨é…ç½®å’Œè‡ªåŠ¨è£…é…çš„æ¦‚å¿µï¼Œåæ¥ç»è¿‡ Google ä¹‹åï¼Œå‘ç°ä¸¤è€…æ˜¯æˆªç„¶ä¸å¦‚åŒçš„ï¼š</p>
<ul>
<li>è‡ªåŠ¨é…ç½®ï¼šæ˜¯ Spring Boot æä¾›çš„ï¼Œå®ç°é€šè¿‡ jar åŒ…çš„ä¾èµ–ï¼Œèƒ½å¤Ÿè‡ªåŠ¨é…ç½®åº”ç”¨ç¨‹åºã€‚ä¾‹å¦‚è¯´ï¼šæˆ‘ä»¬å¼•å…¥ <code>spring-boot-starter-web</code> ä¹‹åï¼Œå°±è‡ªåŠ¨å¼•å…¥äº† Spring MVC ç›¸å…³çš„ jar åŒ…ï¼Œä»è€Œè‡ªåŠ¨é…ç½® Spring MVC ã€‚</li>
<li>è‡ªåŠ¨è£…é…ï¼šæ˜¯ Spring æä¾›çš„ IoC æ³¨å…¥æ–¹å¼ï¼Œå…·ä½“çœ‹çœ‹ <a href="http://wiki.jikexueyuan.com/project/spring/beans-autowiring.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring æ•™ç¨‹ â€”â€” Beans è‡ªåŠ¨è£…é…ã€‹</a> æ–‡æ¡£ã€‚</li>
</ul>
<p>æ‰€ä»¥ï¼Œä¸è¦å’Œè‰¿è‰¿ä¸€æ ·æ„šè ¢çš„æé”™è½ã€‚</p>
<h1 id="3-è‡ªåŠ¨è£…é…åŸç†"><a href="#3-è‡ªåŠ¨è£…é…åŸç†" class="headerlink" title="3. è‡ªåŠ¨è£…é…åŸç†"></a>3. è‡ªåŠ¨è£…é…åŸç†</h1><p>èƒ–å‹å¯ä»¥ç›´æ¥çœ‹ <a href="https://www.jianshu.com/p/0114a5d728ea" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè¯¦è§£ Spring Boot è‡ªåŠ¨é…ç½®æœºåˆ¶ã€‹</a> æ–‡ç« çš„ <a href="#">ã€ŒäºŒã€Spring Boot è‡ªåŠ¨é…ç½®ã€</a> å°èŠ‚ï¼Œè‰¿è‰¿è§‰å¾—å†™çš„æŒºæ¸…æ™°çš„ã€‚</p>
<blockquote>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å³å¼€å§‹æ­£å¼æ’¸å…·ä½“çš„ä»£ç å®ç°äº†ã€‚</p>
</blockquote>
<h1 id="4-SpringBootApplication"><a href="#4-SpringBootApplication" class="headerlink" title="4. @SpringBootApplication"></a>4. @SpringBootApplication</h1><p><code>org.springframework.boot.autoconfigure.@SpringBootApplication</code> æ³¨è§£ï¼ŒåŸºæœ¬æˆ‘ä»¬çš„ Spring Boot åº”ç”¨ï¼Œä¸€å®šä¼šå»æœ‰è¿™æ ·ä¸€ä¸ªæ³¨è§£ã€‚å¹¶ä¸”ï¼Œé€šè¿‡ä½¿ç”¨å®ƒï¼Œä¸ä»…ä»…èƒ½æ ‡è®°è¿™æ˜¯ä¸€ä¸ª Spring Boot åº”ç”¨ï¼Œè€Œä¸”èƒ½å¤Ÿå¼€å¯è‡ªåŠ¨é…ç½®çš„åŠŸèƒ½ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<blockquote>
<p>ğŸ˜ˆ <code>@SpringBootApplication</code> æ³¨è§£ï¼Œå®ƒåœ¨ <code>spring-boot-autoconfigure</code> æ¨¡å—ä¸­ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ Spring Boot é¡¹ç›®æ—¶ï¼Œå¦‚æœä¸æƒ³ä½¿ç”¨è‡ªåŠ¨é…ç½®åŠŸèƒ½ï¼Œå°±ä¸ç”¨å¼•å…¥å®ƒã€‚å½“ç„¶ï¼Œæˆ‘ä»¬è²Œä¼¼ä¸å¤ªä¼šå­˜åœ¨è¿™æ ·çš„éœ€æ±‚ï¼Œæ˜¯å§~</p>
</blockquote>
<p><code>@SpringBootApplication</code> æ˜¯ä¸€ä¸ª<strong>ç»„åˆ</strong>æ³¨è§£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// SpringBootApplication.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(excludeFilters = {</span><br><span class="line">		<span class="meta">@Filter</span>(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span><br><span class="line">		<span class="meta">@Filter</span>(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) })</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication {</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Exclude specific auto-configuration classes such that they will never be applied.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the classes to exclude</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@AliasFor</span>(annotation = EnableAutoConfiguration.class)</span><br><span class="line">	Class&lt;?&gt;[] exclude() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Exclude specific auto-configuration class names such that they will never be</span></span><br><span class="line"><span class="comment">	 * applied.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the class names to exclude</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 1.3.0</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@AliasFor</span>(annotation = EnableAutoConfiguration.class)</span><br><span class="line">	String[] excludeName() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Base packages to scan for annotated components. Use {<span class="doctag">@link</span> #scanBasePackageClasses}</span></span><br><span class="line"><span class="comment">	 * for a type-safe alternative to String-based package names.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> base packages to scan</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 1.3.0</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@AliasFor</span>(annotation = ComponentScan.class, attribute = <span class="string">"basePackages"</span>)</span><br><span class="line">	String[] scanBasePackages() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Type-safe alternative to {<span class="doctag">@link</span> #scanBasePackages} for specifying the packages to</span></span><br><span class="line"><span class="comment">	 * scan for annotated components. The package of each class specified will be scanned.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;</span></span><br><span class="line"><span class="comment">	 * Consider creating a special no-op marker class or interface in each package that</span></span><br><span class="line"><span class="comment">	 * serves no purpose other than being referenced by this attribute.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> base packages to scan</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 1.3.0</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="meta">@AliasFor</span>(annotation = ComponentScan.class, attribute = <span class="string">"basePackageClasses"</span>)</span><br><span class="line">	Class&lt;?&gt;[] scanBasePackageClasses() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥é€ä¸ªçœ‹ <code>@SpringBootApplication</code> ä¸Šçš„æ¯ä¸ªæ³¨è§£ã€‚</p>
<h2 id="4-1-Inherited"><a href="#4-1-Inherited" class="headerlink" title="4.1 @Inherited"></a>4.1 @Inherited</h2><blockquote>
<p>Java è‡ªå¸¦çš„æ³¨è§£ã€‚</p>
</blockquote>
<p><code>java.lang.annotation.@Inherited</code> æ³¨è§£ï¼Œä½¿ç”¨æ­¤æ³¨è§£å£°æ˜å‡ºæ¥çš„è‡ªå®šä¹‰æ³¨è§£ï¼Œåœ¨ä½¿ç”¨<strong>æ­¤</strong>è‡ªå®šä¹‰æ³¨è§£æ—¶ï¼Œå¦‚æœæ³¨è§£åœ¨ç±»ä¸Šé¢æ—¶ï¼Œå­ç±»ä¼šè‡ªåŠ¨ç»§æ‰¿æ­¤æ³¨è§£ï¼Œå¦åˆ™çš„è¯ï¼Œå­ç±»ä¸ä¼šç»§æ‰¿æ­¤æ³¨è§£ã€‚</p>
<p>è¿™é‡Œä¸€å®šè¦è®°ä½ï¼Œä½¿ç”¨ <code>@Inherited</code> å£°æ˜å‡ºæ¥çš„æ³¨è§£ï¼Œåªæœ‰åœ¨ç±»ä¸Šä½¿ç”¨æ—¶æ‰ä¼šæœ‰æ•ˆï¼Œå¯¹æ–¹æ³•ï¼Œå±æ€§ç­‰å…¶ä»–æ— æ•ˆã€‚</p>
<p>ä¸äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ <a href="https://blog.csdn.net/snow_crazy/article/details/39381695" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå…³äº Java æ³¨è§£ä¸­å…ƒæ³¨è§£ Inherited çš„ä½¿ç”¨è¯¦è§£ã€‹</a> æ–‡ç« ã€‚</p>
<h2 id="4-2-SpringBootConfiguration"><a href="#4-2-SpringBootConfiguration" class="headerlink" title="4.2 @SpringBootConfiguration"></a>4.2 @SpringBootConfiguration</h2><blockquote>
<p>Spring Boot è‡ªå®šä¹‰çš„æ³¨è§£</p>
</blockquote>
<p><code>org.springframework.boot.@SpringBootConfiguration</code> æ³¨è§£ï¼Œæ ‡è®°è¿™æ˜¯ä¸€ä¸ª Spring Boot é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// SpringBootConfiguration.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootConfiguration {</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°ï¼Œå®ƒä¸Šé¢ç»§æ‰¿è‡ª <code>@Configuration</code> æ³¨è§£ï¼Œæ‰€ä»¥ä¸¤è€…åŠŸèƒ½ä¹Ÿä¸€è‡´ï¼Œå¯ä»¥å°†å½“å‰ç±»å†…å£°æ˜çš„ä¸€ä¸ªæˆ–å¤šä¸ªä»¥ <code>@Bean</code> æ³¨è§£æ ‡è®°çš„æ–¹æ³•çš„å®ä¾‹çº³å…¥åˆ° Srping å®¹å™¨ä¸­ï¼Œå¹¶ä¸”å®ä¾‹åå°±æ˜¯æ–¹æ³•åã€‚</li>
</ul>
<h2 id="4-3-ComponentScan"><a href="#4-3-ComponentScan" class="headerlink" title="4.3 @ComponentScan"></a>4.3 @ComponentScan</h2><blockquote>
<p>Spring è‡ªå®šä¹‰çš„æ³¨è§£</p>
</blockquote>
<p><code>org.springframework.context.annotation.@ComponentScan</code> æ³¨è§£ï¼Œæ‰«ææŒ‡å®šè·¯å¾„ä¸‹çš„ Componentï¼ˆ<code>@Componment</code>ã€<code>@Configuration</code>ã€<code>@Service</code> ç­‰ç­‰ï¼‰ã€‚</p>
<p>ä¸äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ <a href="https://shihlei.iteye.com/blog/2405675" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpringï¼š@ComponentScan ä½¿ç”¨ã€‹</a> æ–‡ç« ã€‚</p>
<h2 id="4-4-EnableAutoConfiguration"><a href="#4-4-EnableAutoConfiguration" class="headerlink" title="4.4 @EnableAutoConfiguration"></a>4.4 @EnableAutoConfiguration</h2><blockquote>
<p>Spring Boot è‡ªå®šä¹‰çš„æ³¨è§£</p>
</blockquote>
<p><code>org.springframework.boot.autoconfigure.@EnableAutoConfiguration</code> æ³¨è§£ï¼Œç”¨äºå¼€å¯è‡ªåŠ¨é…ç½®åŠŸèƒ½ï¼Œæ˜¯ <code>spring-boot-autoconfigure</code> é¡¹ç›®æœ€æ ¸å¿ƒçš„æ³¨è§£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// EnableAutoConfiguration.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@AutoConfigurationPackage</span></span><br><span class="line"><span class="meta">@Import</span>(AutoConfigurationImportSelector.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration {</span><br><span class="line"></span><br><span class="line">	String ENABLED_OVERRIDE_PROPERTY = <span class="string">"spring.boot.enableautoconfiguration"</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Exclude specific auto-configuration classes such that they will never be applied.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the classes to exclude</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	Class&lt;?&gt;[] exclude() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Exclude specific auto-configuration class names such that they will never be</span></span><br><span class="line"><span class="comment">	 * applied.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the class names to exclude</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@since</span> 1.3.0</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	String[] excludeName() <span class="keyword">default</span> {};</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><code>org.springframework.boot.autoconfigure.@AutoConfigurationPackage</code> æ³¨è§£ï¼Œä¸»è¦åŠŸèƒ½è‡ªåŠ¨é…ç½®åŒ…ï¼Œå®ƒä¼šè·å–ä¸»ç¨‹åºç±»æ‰€åœ¨çš„åŒ…è·¯å¾„ï¼Œå¹¶å°†åŒ…è·¯å¾„ï¼ˆåŒ…æ‹¬å­åŒ…ï¼‰ä¸‹çš„æ‰€æœ‰ç»„ä»¶æ³¨å†Œåˆ° Spring IOC å®¹å™¨ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationPackage.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@Import</span>(AutoConfigurationPackages.Registrar.class)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoConfigurationPackage {</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>org.springframework.context.annotation.@Import</code> æ³¨è§£ï¼Œå¯ç”¨äºèµ„æºçš„å¯¼å…¥ã€‚æƒ…å†µæ¯”è¾ƒå¤šï¼Œå¯ä»¥çœ‹çœ‹ <a href="https://blog.csdn.net/u010502101/article/details/78760032" rel="external nofollow noopener noreferrer" target="_blank">ã€Š6ã€@Import æ³¨è§£â€”â€”å¯¼å…¥èµ„æºã€‹</a> æ–‡ç« ã€‚</li>
<li>AutoConfigurationPackages.Registrar ï¼Œæœ‰ç‚¹ç¥å¥‡ï¼Œè¿™é‡Œå…ˆä¸è¯´ã€‚èƒ–å‹æœ€åå»çœ‹ <a href="#">ã€Œ6. AutoConfigurationPackagesã€</a> å°èŠ‚ã€‚</li>
</ul>
</li>
<li><p><code>@Import(AutoConfigurationImportSelector.class)</code> æ³¨è§£éƒ¨åˆ†ï¼Œæ˜¯é‡å¤´æˆçš„å¼€å§‹ã€‚</p>
<ul>
<li><code>org.springframework.context.annotation.@Import</code> æ³¨è§£ï¼Œå¯ç”¨äºèµ„æºçš„å¯¼å…¥ã€‚æƒ…å†µæ¯”è¾ƒå¤šï¼Œå¯ä»¥çœ‹çœ‹ <a href="https://blog.csdn.net/u010502101/article/details/78760032" rel="external nofollow noopener noreferrer" target="_blank">ã€Š6ã€@Import æ³¨è§£â€”â€”å¯¼å…¥èµ„æºã€‹</a> æ–‡ç« ã€‚</li>
<li>AutoConfigurationImportSelector ï¼Œå¯¼å…¥è‡ªåŠ¨é…ç½®ç›¸å…³çš„èµ„æºã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5. AutoConfigurationImportSelectorã€</a> å°èŠ‚ã€‚</li>
</ul>
</li>
</ul>
<h1 id="5-AutoConfigurationImportSelector"><a href="#5-AutoConfigurationImportSelector" class="headerlink" title="5. AutoConfigurationImportSelector"></a>5. AutoConfigurationImportSelector</h1><p><code>org.springframework.boot.autoconfigure.AutoConfigurationImportSelector</code> ï¼Œå®ç° DeferredImportSelectorã€BeanClassLoaderAwareã€ResourceLoaderAwareã€BeanFactoryAwareã€EnvironmentAwareã€Ordered æ¥å£ï¼Œå¤„ç† <code>@EnableAutoConfiguration</code> æ³¨è§£çš„èµ„æºå¯¼å…¥ã€‚</p>
<h2 id="5-1-getCandidateConfigurations"><a href="#5-1-getCandidateConfigurations" class="headerlink" title="5.1 getCandidateConfigurations"></a>5.1 getCandidateConfigurations</h2><p><code>#getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes)</code> æ–¹æ³•ï¼Œè·å¾—ç¬¦åˆæ¡ä»¶çš„é…ç½®ç±»çš„æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">getCandidateConfigurations</span><span class="params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; åŠ è½½æŒ‡å®šç±»å‹ EnableAutoConfiguration å¯¹åº”çš„ï¼Œåœ¨ `META-INF/spring.factories` é‡Œçš„ç±»åçš„æ•°ç»„</span></span><br><span class="line">	List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames(getSpringFactoriesLoaderFactoryClass(), getBeanClassLoader());</span><br><span class="line">	<span class="comment">// æ–­è¨€ï¼Œéç©º</span></span><br><span class="line">	Assert.notEmpty(configurations, <span class="string">"No auto configuration classes found in META-INF/spring.factories. If you "</span> + <span class="string">"are using a custom packaging, make sure that file is correct."</span>);</span><br><span class="line">	<span class="keyword">return</span> configurations;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#getSpringFactoriesLoaderFactoryClass()</code> æ–¹æ³•ï¼Œè·å¾—è¦ä» <code>META-INF/spring.factories</code> åŠ è½½çš„æŒ‡å®šç±»å‹ä¸º EnableAutoConfiguration ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> Class&lt;?&gt; getSpringFactoriesLoaderFactoryClass() {</span><br><span class="line">	<span class="keyword">return</span> EnableAutoConfiguration.class;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>SpringFactoriesLoader#loadFactoryNames(Class&lt;?&gt; factoryClass, ClassLoader classLoader)</code> æ–¹æ³•ï¼ŒåŠ è½½æŒ‡å®šç±»å‹ EnableAutoConfiguration å¯¹åº”çš„ï¼Œåœ¨ <code>META-INF/spring.factories</code> é‡Œçš„ç±»åçš„æ•°ç»„ã€‚çœ‹çœ‹ä¸‹å›¾ï¼Œèƒ–å‹ç›¸ä¿¡å°±æ˜ç™½äº†ï¼š<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-02-01/01.jpg" alt="`configurations`"></p>
</li>
</ul>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œå’Œç½‘ç»œä¸Š Spring Boot æ•¢äºè¿™å—çš„æºç è§£æï¼Œæˆ‘ä»¬å°±å¯ä»¥ç»“æŸäº†ã€‚å¦‚æœå•çº¯æ˜¯ä¸ºäº†äº†è§£åŸç† Spring Boot è‡ªåŠ¨é…ç½®çš„åŸç†ï¼Œè¿™é‡Œç»“æŸä¹Ÿæ˜¯æ²¡é—®é¢˜çš„ã€‚å› ä¸ºï¼Œæ‹¿åˆ° Configuration é…ç½®ç±»åï¼Œåé¢çš„å°±æ˜¯ Spring Java Config çš„äº‹æƒ…äº†ã€‚ä¸äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ <a href="http://wiki.jikexueyuan.com/project/spring/java-based-configuration.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring æ•™ç¨‹ â€”â€” åŸºäº Java çš„é…ç½®ã€‹</a> æ–‡ç« ã€‚</p>
<p>ğŸ˜œ ä½†æ˜¯ï¼ˆâ€œä½†æ˜¯â€åŒå­¦ï¼Œä½ èµ¶ç´§åä¸‹ï¼‰ï¼Œå…·æœ‰å€’è…¾ç²¾ç¥çš„è‰¿è‰¿ï¼Œè§‰å¾—è¿˜æ˜¯ç»§ç»­ç…ç… <code>#getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes)</code> æ–¹æ³•æ˜¯æ€ä¹ˆè¢«è°ƒç”¨çš„ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è°ƒç”¨å®ƒçš„æ–¹æ³•è°ƒç”¨é“¾ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-02-01/02.jpg" alt="è°ƒç”¨é“¾"></p>
<ul>
<li>â‘  å¤„ï¼Œrefresh æ–¹æ³•çš„è°ƒç”¨ï¼Œæˆ‘ä»¬åœ¨ <a href="http://svip.iocoder.cn/Spring-Boot/SpringApplication">ã€Šç²¾å°½ Spring Boot æºç åˆ†æ â€”â€” SpringApplicationã€‹</a> ä¸­ï¼ŒSpringApplication å¯åŠ¨æ—¶ï¼Œä¼šè°ƒç”¨åˆ°è¯¥æ–¹æ³•ã€‚</li>
<li>â‘¡ å¤„ï¼Œ<code>#getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes)</code> æ–¹æ³•è¢«è°ƒç”¨ã€‚</li>
<li><p>â‘¢ å¤„ï¼Œé‚£ä¹ˆæ­¤å¤„ï¼Œå°±æ˜¯é—®é¢˜çš„å…³é”®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>è‰¿è‰¿ï¼šå› ä¸ºæˆ‘è¿˜æ²¡ç‰¹åˆ«å®Œæ•´çš„æ’¸å®Œ Spring Java Annotations ç›¸å…³çš„æºç ï¼Œæ‰€ä»¥ä¸‹é¢çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬æ›´å¤šæ˜¯çœ‹æ•´ä¸ªè°ƒç”¨è¿‡ç¨‹ã€‚ğŸ˜ˆ æ°å¥½ï¼Œèƒ–å‹ä¹Ÿæ²¡çœ‹è¿‡ï¼Œå“ˆå“ˆå“ˆå“ˆã€‚ </p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ConfigurationClassParser#DeferredImportSelectorGroupingHandler.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DeferredImportSelector.Group group;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Iterable&lt;Group.Entry&gt; getImports() {</span><br><span class="line">	<span class="keyword">for</span> (DeferredImportSelectorHolder deferredImport : <span class="keyword">this</span>.deferredImports) {</span><br><span class="line">		<span class="keyword">this</span>.group.process(deferredImport.getConfigurationClass().getMetadata(),</span><br><span class="line">				deferredImport.getImportSelector()); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.group.selectImports(); <span class="comment">// &lt;2&gt;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>DeferredImportSelector.Group#process(AnnotationMetadata metadata, DeferredImportSelector selector)</code> æ–¹æ³•ï¼Œå¤„ç†è¢« <code>@Import</code> æ³¨è§£çš„æ³¨è§£ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>DeferredImportSelector.Group#this.group.selectImports()</code> æ–¹æ³•ï¼Œé€‰æ‹©éœ€è¦å¯¼å…¥çš„ã€‚ä¾‹å¦‚ï¼š<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-02-01/03.jpg" alt="selectImports"><ul>
<li>è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°éœ€è¦å¯¼å…¥çš„ Configuration é…ç½®ç±»ã€‚ </li>
</ul>
</li>
<li>å…·ä½“ <code>&lt;1&gt;</code> å’Œ <code>&lt;2&gt;</code> å¤„ï¼Œåœ¨ <a href="#">ã€Œ5.3 AutoConfigurationGroupã€</a> è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
</ul>
<h2 id="5-2-getImportGroup"><a href="#5-2-getImportGroup" class="headerlink" title="5.2 getImportGroup"></a>5.2 getImportGroup</h2><p><code>#getImportGroup()</code> æ–¹æ³•ï¼Œè·å¾—å¯¹åº”çš„ Group å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span> <span class="comment">// å®ç°è‡ª DeferredImportSelector æ¥å£</span></span><br><span class="line"><span class="keyword">public</span> Class&lt;? extends Group&gt; getImportGroup() {</span><br><span class="line">	<span class="keyword">return</span> AutoConfigurationGroup.class;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å…³äº AutoConfigurationGroup ç±»ï¼Œåœ¨ <a href="#">ã€Œ5.3 AutoConfigurationGroupã€</a> è¯¦ç»†è§£æã€‚</li>
</ul>
<h2 id="5-3-AutoConfigurationGroup"><a href="#5-3-AutoConfigurationGroup" class="headerlink" title="5.3 AutoConfigurationGroup"></a>5.3 AutoConfigurationGroup</h2><blockquote>
<p>è‰¿è‰¿ï¼šæ³¨æ„ï¼Œä»è¿™é‡Œå¼€å§‹åï¼Œä¸œè¥¿ä¼šæ¯”è¾ƒéš¾ã€‚å› ä¸ºï¼Œæ¶‰åŠçš„ä¸œè¥¿ä¼šæ¯”è¾ƒå¤šã€‚</p>
</blockquote>
<p>AutoConfigurationGroup ï¼Œæ˜¯ AutoConfigurationImportSelector çš„å†…éƒ¨ç±»ï¼Œå®ç° DeferredImportSelector.Groupã€BeanClassLoaderAwareã€BeanFactoryAwareã€ResourceLoaderAware æ¥å£ï¼Œè‡ªåŠ¨é…ç½®çš„ Group å®ç°ç±»ã€‚</p>
<h3 id="5-3-1-å±æ€§"><a href="#5-3-1-å±æ€§" class="headerlink" title="5.3.1 å±æ€§"></a>5.3.1 å±æ€§</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector#AutoConfigurationGroup.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AnnotationMetadata çš„æ˜ å°„</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * KEYï¼šé…ç½®ç±»çš„å…¨ç±»å</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, AnnotationMetadata&gt; entries = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * AutoConfigurationEntry çš„æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;AutoConfigurationEntry&gt; autoConfigurationEntries = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ClassLoader beanClassLoader;</span><br><span class="line"><span class="keyword">private</span> BeanFactory beanFactory;</span><br><span class="line"><span class="keyword">private</span> ResourceLoader resourceLoader;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªåŠ¨é…ç½®çš„å…ƒæ•°æ®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> AutoConfigurationMetadata autoConfigurationMetadata;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>entries</code> å±æ€§ï¼ŒAnnotationMetadata çš„æ˜ å°„ã€‚å…¶ä¸­ï¼ŒKEY ä¸º é…ç½®ç±»çš„å…¨ç±»åã€‚åœ¨åç»­æˆ‘ä»¬å°†çœ‹åˆ°çš„ <code>AutoConfigurationGroup#process(...)</code> æ–¹æ³•ä¸­ï¼Œè¢«è¿›è¡Œèµ‹å€¼ã€‚ä¾‹å¦‚ï¼š<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-02-01/04.jpg" alt="`entries`"></li>
<li><p><code>autoConfigurationEntries</code> å±æ€§ï¼ŒAutoConfigurationEntry çš„æ•°ç»„ã€‚</p>
<ul>
<li><p>å…¶ä¸­ï¼ŒAutoConfigurationEntry æ˜¯ AutoConfigurationImportSelector çš„å†…éƒ¨ç±»ï¼Œè‡ªåŠ¨é…ç½®çš„æ¡ç›®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector#AutoConfigurationEntry.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoConfigurationEntry</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®ç±»çš„å…¨ç±»åçš„æ•°ç»„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; configurations;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ’é™¤çš„é…ç½®ç±»çš„å…¨ç±»åçš„æ•°ç»„ </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; exclusions;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// çœç•¥æ„é€ æ–¹æ³•å’Œ setting/getting æ–¹æ³•</span></span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å±æ€§æ¯”è¾ƒç®€å•ã€‚</li>
</ul>
</li>
<li>åœ¨åç»­æˆ‘ä»¬å°†çœ‹åˆ°çš„ <code>AutoConfigurationGroup#process(...)</code> æ–¹æ³•ä¸­ï¼Œè¢«è¿›è¡Œèµ‹å€¼ã€‚ä¾‹å¦‚ï¼š<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-02-01/05.jpg" alt="`autoConfigurationEntries`"></li>
</ul>
</li>
<li><p><code>autoConfigurationMetadata</code> å±æ€§ï¼Œè‡ªåŠ¨é…ç½®çš„å…ƒæ•°æ®ï¼ˆMetadataï¼‰ã€‚</p>
<ul>
<li><p>é€šè¿‡ <code>#getAutoConfigurationMetadata()</code> æ–¹æ³•ï¼Œä¼šåˆå§‹åŒ–è¯¥å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector#AutoConfigurationGroup.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> AutoConfigurationMetadata <span class="title">getAutoConfigurationMetadata</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡ŒåŠ è½½</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.autoConfigurationMetadata == <span class="keyword">null</span>) {</span><br><span class="line">		<span class="keyword">this</span>.autoConfigurationMetadata = AutoConfigurationMetadataLoader.loadMetadata(<span class="keyword">this</span>.beanClassLoader);</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">this</span>.autoConfigurationMetadata;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å…³äº AutoConfigurationMetadataLoader ç±»ï¼Œæˆ‘ä»¬å…ˆä¸å»æ„ã€‚é¿å…ï¼Œæˆ‘ä»¬è°ƒè¯•çš„å¤ªè¿‡æ·±å…¥ã€‚TODO åç»­åœ¨è¡¥å……ä¸‹ã€‚</li>
<li>è¿”å›çš„ç±»å‹æ˜¯ PropertiesAutoConfigurationMetadata ï¼Œæ¯”è¾ƒç®€å•ï¼Œèƒ–å‹ç‚¹å‡» <a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/AutoConfigurationMetadataLoader.java#L67-L119" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a> ç…ä¸€çœ¼å³å¯ã€‚</li>
<li>å¦‚ä¸‹æ˜¯ä¸€ä¸ªè¿”å›å€¼çš„ç¤ºä¾‹ï¼š<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-02-01/06.jpg" alt="`autoConfigurationEntries`"><ul>
<li>å¯èƒ½èƒ–å‹ä¼šæœ‰ç‚¹æ‡µé€¼ï¼Œè¿™ä¹ˆå¤šï¼Œå¹¶ä¸” KEY / VALUE ç»“æœçœ‹ä¸æ‡‚ï¼Ÿä¸è¦æ–¹ï¼Œæˆ‘ä»¬ç®€å•æ¥è¯´ä¸‹ <a href="https://github.com/YunaiV/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/data/couchbase/CouchbaseReactiveRepositoriesAutoConfiguration.java" rel="external nofollow noopener noreferrer" target="_blank">CouchbaseReactiveRepositoriesAutoConfiguration</a> é…ç½®ç±»ã€‚å¦‚æœå®ƒç”Ÿæ•ˆï¼Œéœ€è¦ classpath ä¸‹æœ‰ Bucketã€ReactiveCouchbaseRepositoryã€Flux ä¸‰ä¸ªç±»ï¼Œæ‰€ä»¥çº¢çº¿é‚£ä¸ªæ¡ç›®ï¼Œå¯¹åº”çš„å°±æ˜¯ CouchbaseReactiveRepositoriesAutoConfiguration ç±»ä¸Šçš„ <code>@ConditionalOnClass({ Bucket.class, ReactiveCouchbaseRepository.class, Flux.class })</code> æ³¨è§£éƒ¨åˆ†ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>æ‰€ä»¥ï¼Œ<code>autoConfigurationMetadata</code> å±æ€§ï¼Œç”¨é€”å°±æ˜¯åˆ¶å®šé…ç½®ç±»ï¼ˆConfigurationï¼‰çš„ç”Ÿæ•ˆæ¡ä»¶ï¼ˆConditionï¼‰ã€‚</li>
</ul>
</li>
</ul>
<h3 id="5-3-2-process"><a href="#5-3-2-process" class="headerlink" title="5.3.2 process"></a>5.3.2 process</h3><p><code>#process(AnnotationMetadata annotationMetadata, DeferredImportSelector deferredImportSelector)</code> æ–¹æ³•ï¼Œè¿›è¡Œå¤„ç†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector#AutoConfigurationGroup.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(AnnotationMetadata annotationMetadata, DeferredImportSelector deferredImportSelector)</span> </span>{</span><br><span class="line">    <span class="comment">// æ–­è¨€</span></span><br><span class="line">    Assert.state(</span><br><span class="line">            deferredImportSelector <span class="keyword">instanceof</span> AutoConfigurationImportSelector,</span><br><span class="line">            () -&gt; String.format(<span class="string">"Only %s implementations are supported, got %s"</span>,</span><br><span class="line">                    AutoConfigurationImportSelector.class.getSimpleName(),</span><br><span class="line">                    deferredImportSelector.getClass().getName()));</span><br><span class="line">    <span class="comment">// &lt;1&gt; è·å¾— AutoConfigurationEntry å¯¹è±¡ </span></span><br><span class="line">    AutoConfigurationEntry autoConfigurationEntry = ((AutoConfigurationImportSelector) deferredImportSelector)</span><br><span class="line">            .getAutoConfigurationEntry(getAutoConfigurationMetadata(), annotationMetadata);</span><br><span class="line">    <span class="comment">// &lt;2&gt; æ·»åŠ åˆ° autoConfigurationEntries ä¸­</span></span><br><span class="line">    <span class="keyword">this</span>.autoConfigurationEntries.add(autoConfigurationEntry);</span><br><span class="line">    <span class="comment">// &lt;3&gt; æ·»åŠ åˆ° entries ä¸­</span></span><br><span class="line">    <span class="keyword">for</span> (String importClassName : autoConfigurationEntry.getConfigurations()) {</span><br><span class="line">        <span class="keyword">this</span>.entries.putIfAbsent(importClassName, annotationMetadata);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>annotationMetadata</code> å‚æ•°ï¼Œä¸€èˆ¬æ¥è¯´æ˜¯è¢« <code>@SpringBootApplication</code> æ³¨è§£çš„å…ƒæ•°æ®ã€‚å› ä¸ºï¼Œ<code>@SpringBootApplication</code> ç»„åˆäº† <code>@EnableAutoConfiguration</code> æ³¨è§£ã€‚</li>
<li><code>deferredImportSelector</code> å‚æ•°ï¼Œ<code>@EnableAutoConfiguration</code> æ³¨è§£çš„å®šä¹‰çš„ <code>@Import</code> çš„ç±»ï¼Œå³ AutoConfigurationImportSelector å¯¹è±¡ã€‚</li>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>AutoConfigurationImportSelector#getAutoConfigurationEntry(AutoConfigurationMetadata autoConfigurationMetadata, AnnotationMetadata annotationMetadata)</code> æ–¹æ³•ï¼Œè·å¾— AutoConfigurationEntry å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5.4 AutoConfigurationEntryã€</a> ã€‚å› ä¸ºè¿™å—æ¯”è¾ƒé‡è¦ï¼Œæ‰€ä»¥å…ˆè·³è¿‡å»ç…ç…ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œæ·»åŠ åˆ° <code>autoConfigurationEntries</code> ä¸­ã€‚</li>
<li><code>&lt;3&gt;</code> å¤„ï¼Œæ·»åŠ åˆ° <code>entries</code> ä¸­ã€‚</li>
</ul>
<h3 id="5-3-3-selectImports"><a href="#5-3-3-selectImports" class="headerlink" title="5.3.3 selectImports"></a>5.3.3 selectImports</h3><p><code>#selectImports()</code> æ–¹æ³•ï¼Œè·å¾—è¦å¼•å…¥çš„é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector#AutoConfigurationGroup.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Iterable&lt;Entry&gt; <span class="title">selectImports</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; å¦‚æœä¸ºç©ºï¼Œåˆ™è¿”å›ç©ºæ•°ç»„</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.autoConfigurationEntries.isEmpty()) {</span><br><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &lt;2.1&gt; è·å¾— allExclusions</span></span><br><span class="line">    Set&lt;String&gt; allExclusions = <span class="keyword">this</span>.autoConfigurationEntries.stream()</span><br><span class="line">            .map(AutoConfigurationEntry::getExclusions)</span><br><span class="line">            .flatMap(Collection::stream).collect(Collectors.toSet());</span><br><span class="line">    <span class="comment">// &lt;2.2&gt; è·å¾— processedConfigurations</span></span><br><span class="line">    Set&lt;String&gt; processedConfigurations = <span class="keyword">this</span>.autoConfigurationEntries.stream()</span><br><span class="line">            .map(AutoConfigurationEntry::getConfigurations)</span><br><span class="line">            .flatMap(Collection::stream)</span><br><span class="line">            .collect(Collectors.toCollection(LinkedHashSet::<span class="keyword">new</span>));</span><br><span class="line">    <span class="comment">// &lt;2.3&gt; ä» processedConfigurations ä¸­ï¼Œç§»é™¤æ’é™¤çš„</span></span><br><span class="line">    processedConfigurations.removeAll(allExclusions);</span><br><span class="line">    <span class="comment">// &lt;3&gt; å¤„ç†ï¼Œè¿”å›ç»“æœ</span></span><br><span class="line">    <span class="keyword">return</span> sortAutoConfigurations(processedConfigurations, getAutoConfigurationMetadata()) <span class="comment">// &lt;3.1&gt; æ’åº</span></span><br><span class="line">                .stream()</span><br><span class="line">                .map((importClassName) -&gt; <span class="keyword">new</span> Entry(<span class="keyword">this</span>.entries.get(importClassName), importClassName)) <span class="comment">// &lt;3.2&gt; åˆ›å»º Entry å¯¹è±¡</span></span><br><span class="line">                .collect(Collectors.toList()); <span class="comment">// &lt;3.3&gt; è½¬æ¢æˆ List</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™è¿”å›ç©ºæ•°ç»„ã€‚</li>
<li><code>&lt;2.1&gt;</code>ã€<code>&lt;2.2&gt;</code>ã€<code>&lt;2.3&gt;</code> å¤„ï¼Œè·å¾—è¦å¼•å…¥çš„é…ç½®ç±»é›†åˆã€‚ğŸ˜ˆ æ¯”è¾ƒå¥‡æ€ªçš„æ˜¯ï¼Œä¸Šé¢å·²ç»åšè¿‡ä¸€æ¬¡ç§»é™¤çš„å¤„ç†ï¼Œè¿™é‡Œåˆåšä¸€æ¬¡ã€‚ä¸è¿‡ï¼Œæ²¡å¤šå¤§å…³ç³»ï¼Œå¯ä»¥å…ˆæ— è§†ã€‚</li>
<li><p><code>&lt;3&gt;</code> å¤„ï¼Œå¤„ç†ï¼Œè¿”å›ç»“æœã€‚</p>
<ul>
<li><p><code>&lt;3.1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#sortAutoConfigurations(Set&lt;String&gt; configurations, AutoConfigurationMetadata autoConfigurationMetadata)</code> æ–¹æ³•ï¼Œæ’åºã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector#AutoConfigurationGroup.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">sortAutoConfigurations</span><span class="params">(Set&lt;String&gt; configurations, AutoConfigurationMetadata autoConfigurationMetadata)</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> AutoConfigurationSorter(getMetadataReaderFactory(), autoConfigurationMetadata).getInPriorityOrder(configurations);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å…·ä½“çš„æ’åºé€»è¾‘ï¼Œèƒ–å‹è‡ªå·±çœ‹ã€‚å®é™…ä¸Šï¼Œè¿˜æ˜¯æ¶‰åŠå“ªäº›ï¼Œä¾‹å¦‚è¯´ <code>@Order</code> æ³¨è§£ã€‚</li>
</ul>
</li>
<li><code>&lt;3.2&gt;</code> å¤„ï¼Œåˆ›å»º Entry å¯¹è±¡ã€‚</li>
<li><code>&lt;3.3&gt;</code> å¤„ï¼Œè½¬æ¢æˆ List ã€‚ç»“æœå¦‚ä¸‹å›¾ï¼š<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-02-01/09.jpg" alt="ç»“æœ"></li>
</ul>
</li>
</ul>
<blockquote>
<p>è‰¿è‰¿ï¼šç•¥å¾®æœ‰ç‚¹è‰°éš¾çš„è¿‡ç¨‹ã€‚ä¸è¿‡å›è¿‡å¤´æ¥ï¼Œå…¶å®ä¹Ÿæ²¡å•¥ç‰¹åˆ«å¤æ‚çš„é€»è¾‘ã€‚æ˜¯ä¸ï¼Œèƒ–å‹~</p>
</blockquote>
<h2 id="5-4-getAutoConfigurationEntry"><a href="#5-4-getAutoConfigurationEntry" class="headerlink" title="5.4 getAutoConfigurationEntry"></a>5.4 getAutoConfigurationEntry</h2><blockquote>
<p>è‰¿è‰¿ï¼šè¿™æ˜¯ä¸€ä¸ªå…³é”®æ–¹æ³•ã€‚å› ä¸ºä¼šè°ƒç”¨åˆ°ï¼Œæˆ‘ä»¬ä¼šåœ¨ <a href="#">ã€Œ5.1 getCandidateConfigurationsã€</a> çš„æ–¹æ³•ã€‚</p>
</blockquote>
<p><code>#getAutoConfigurationEntry(AutoConfigurationMetadata autoConfigurationMetadata, AnnotationMetadata annotationMetadata)</code> æ–¹æ³•ï¼Œè·å¾— AutoConfigurationEntry å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AutoConfigurationEntry <span class="title">getAutoConfigurationEntry</span><span class="params">(AutoConfigurationMetadata autoConfigurationMetadata, AnnotationMetadata annotationMetadata)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; åˆ¤æ–­æ˜¯å¦å¼€å¯ã€‚å¦‚æœªå¼€å¯ï¼Œè¿”å›ç©ºæ•°ç»„ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (!isEnabled(annotationMetadata)) {</span><br><span class="line">        <span class="keyword">return</span> EMPTY_ENTRY;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &lt;2&gt; è·å¾—æ³¨è§£çš„å±æ€§</span></span><br><span class="line">    AnnotationAttributes attributes = getAttributes(annotationMetadata);</span><br><span class="line">    <span class="comment">// &lt;3&gt; è·å¾—ç¬¦åˆæ¡ä»¶çš„é…ç½®ç±»çš„æ•°ç»„</span></span><br><span class="line">    List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes);</span><br><span class="line">    <span class="comment">// &lt;3.1&gt; ç§»é™¤é‡å¤çš„é…ç½®ç±»</span></span><br><span class="line">    configurations = removeDuplicates(configurations);</span><br><span class="line">    <span class="comment">// &lt;4&gt; è·å¾—éœ€è¦æ’é™¤çš„é…ç½®ç±»</span></span><br><span class="line">    Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);</span><br><span class="line">    <span class="comment">// &lt;4.1&gt; æ ¡éªŒæ’é™¤çš„é…ç½®ç±»æ˜¯å¦åˆæ³•</span></span><br><span class="line">    checkExcludedClasses(configurations, exclusions);</span><br><span class="line">    <span class="comment">// &lt;4.2&gt; ä» configurations ä¸­ï¼Œç§»é™¤éœ€è¦æ’é™¤çš„é…ç½®ç±»</span></span><br><span class="line">    configurations.removeAll(exclusions);</span><br><span class="line">    <span class="comment">// &lt;5&gt; æ ¹æ®æ¡ä»¶ï¼ˆConditionï¼‰ï¼Œè¿‡æ»¤æ‰ä¸ç¬¦åˆæ¡ä»¶çš„é…ç½®ç±»</span></span><br><span class="line">    configurations = filter(configurations, autoConfigurationMetadata);</span><br><span class="line">    <span class="comment">// &lt;6&gt; è§¦å‘è‡ªåŠ¨é…ç½®ç±»å¼•å…¥å®Œæˆçš„äº‹ä»¶</span></span><br><span class="line">    fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">    <span class="comment">// &lt;7&gt; åˆ›å»º AutoConfigurationEntry å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> AutoConfigurationEntry(configurations, exclusions);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>è¿™é‡Œæ¯ä¸€æ­¥éƒ½æ˜¯ç»†èŠ‚çš„æ–¹æ³•ï¼Œæ‰€ä»¥ä¼šæ¯ä¸€ä¸ªæ–¹æ³•ï¼Œéƒ½ä¼šæ˜¯å¼•å¯¼åˆ°å¯¹åº”çš„å°èŠ‚çš„æ–¹æ³•ã€‚</p>
<p>è™½ç„¶æœ‰ç‚¹é•¿ï¼Œä½†æ˜¯å¾ˆä¸å¤æ‚ã€‚ç®€å•çš„æ¥è¯´ï¼ŒåŠ è½½ç¬¦åˆæ¡ä»¶çš„é…ç½®ç±»ä»¬ï¼Œç„¶åç§»é™¤éœ€è¦æ’é™¤ï¼ˆexclusionï¼‰çš„ã€‚</p>
</blockquote>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#isEnabled(AnnotationMetadata metadata)</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å¼€å¯ã€‚å¦‚æœªå¼€å¯ï¼Œè¿”å›ç©ºæ•°ç»„ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5.4.1 isEnabledã€</a> ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#getAttributes(AnnotationMetadata metadata)</code> æ–¹æ³•ï¼Œè·å¾—æ³¨è§£çš„å±æ€§ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5.4.2 getAttributesã€</a> ã€‚</li>
<li><p>ã€é‡è¦ã€‘<code>&lt;3&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#getCandidateConfigurations(AnnotationMetadata metadata, AnnotationAttributes attributes)</code> æ–¹æ³•ï¼Œè·å¾—ç¬¦åˆæ¡ä»¶çš„é…ç½®ç±»çš„æ•°ç»„ã€‚</p>
<blockquote>
<p>å˜»å˜»ï¼Œåˆ°è¾¾æ­¤ä¹¦ä¹‹åï¼Œæ•´ä¸ªç»†èŠ‚æ˜¯ä¸æ˜¯å°±ä¸²èµ·æ¥äº†!</p>
</blockquote>
<ul>
<li><p><code>&lt;3.1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#removeDuplicates(List&lt;T&gt; list)</code> æ–¹æ³•ï¼Œç§»é™¤é‡å¤çš„é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">removeDuplicates</span><span class="params">(List&lt;T&gt; list)</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">new</span> LinkedHashSet&lt;&gt;(list));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç®€å•ç²—æš´</li>
</ul>
</li>
</ul>
</li>
<li><p><code>&lt;4&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#getExclusions(AnnotationMetadata metadata, AnnotationAttributes attributes)</code> æ–¹æ³•ï¼Œè·å¾—éœ€è¦æ’é™¤çš„é…ç½®ç±»ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5.4.3 getExclusionsã€</a> ã€‚</p>
<ul>
<li><code>&lt;4.1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#checkExcludedClasses(List&lt;String&gt; configurations, Set&lt;String&gt; exclusions)</code> æ–¹æ³•ï¼Œæ ¡éªŒæ’é™¤çš„é…ç½®ç±»æ˜¯å¦åˆæ³•ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5.4.4 checkExcludedClassesã€</a> ã€‚</li>
<li><code>&lt;4.2&gt;</code> å¤„ï¼Œä» <code>configurations</code> ä¸­ï¼Œç§»é™¤éœ€è¦æ’é™¤çš„é…ç½®ç±»ã€‚</li>
</ul>
</li>
<li><p><code>&lt;5&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#filter(List&lt;String&gt; configurations, AutoConfigurationMetadata autoConfigurationMetadata)</code> æ–¹æ³•ï¼Œæ ¹æ®æ¡ä»¶ï¼ˆConditionï¼‰ï¼Œè¿‡æ»¤æ‰ä¸ç¬¦åˆæ¡ä»¶çš„é…ç½®ç±»ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Spring-Boot/Condition/">ã€Šç²¾å°½ Spring Boot æºç åˆ†æ â€”â€” Conditionã€‹</a> æ–‡ç« ã€‚</p>
</li>
<li><code>&lt;6&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#fireAutoConfigurationImportEvents(List&lt;String&gt; configurations, Set&lt;String&gt; exclusions)</code> æ–¹æ³•ï¼Œè§¦å‘è‡ªåŠ¨é…ç½®ç±»å¼•å…¥å®Œæˆçš„äº‹ä»¶ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5.4.5 fireAutoConfigurationImportEventsã€</a> ã€‚</li>
<li><code>&lt;7&gt;</code> å¤„ï¼Œåˆ›å»º AutoConfigurationEntry å¯¹è±¡ã€‚</li>
</ul>
<blockquote>
<p>æ•´ä¸ª <a href="#">ã€Œ5.4 getAutoConfigurationEntryã€</a> çœ‹å®Œåï¼Œèƒ–å‹è¯·è·³å› <a href="#">ã€Œ5.3.3 selectImportsã€</a> ã€‚ </p>
</blockquote>
<h3 id="5-4-1-isEnabled"><a href="#5-4-1-isEnabled" class="headerlink" title="5.4.1 isEnabled"></a>5.4.1 isEnabled</h3><p><code>#isEnabled(AnnotationMetadata metadata)</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å¼€å¯è‡ªåŠ¨é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">(AnnotationMetadata metadata)</span> </span>{</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ "spring.boot.enableautoconfiguration" é…ç½®åˆ¤æ–­ï¼Œæ˜¯å¦å¼€å¯è‡ªåŠ¨é…ç½®ã€‚</span></span><br><span class="line">    <span class="comment">// é»˜è®¤æƒ…å†µä¸‹ï¼ˆæœªé…ç½®ï¼‰ï¼Œå¼€å¯è‡ªåŠ¨é…ç½®ã€‚</span></span><br><span class="line">	<span class="keyword">if</span> (getClass() == AutoConfigurationImportSelector.class) {</span><br><span class="line">		<span class="keyword">return</span> getEnvironment().getProperty(EnableAutoConfiguration.ENABLED_OVERRIDE_PROPERTY, Boolean.class, <span class="keyword">true</span>);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="5-4-2-getAttributes"><a href="#5-4-2-getAttributes" class="headerlink" title="5.4.2 getAttributes"></a>5.4.2 getAttributes</h3><p><code>#getAttributes(AnnotationMetadata metadata)</code> æ–¹æ³•ï¼Œè·å¾—æ³¨è§£çš„å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AnnotationAttributes <span class="title">getAttributes</span><span class="params">(AnnotationMetadata metadata)</span> </span>{</span><br><span class="line">	String name = getAnnotationClass().getName();</span><br><span class="line">	<span class="comment">// è·å¾—æ³¨è§£çš„å±æ€§</span></span><br><span class="line">	AnnotationAttributes attributes = AnnotationAttributes.fromMap(metadata.getAnnotationAttributes(name, <span class="keyword">true</span>));</span><br><span class="line">	<span class="comment">// æ–­è¨€</span></span><br><span class="line">	Assert.notNull(attributes,</span><br><span class="line">			() -&gt; <span class="string">"No auto-configuration attributes found. Is "</span></span><br><span class="line">					+ metadata.getClassName() + <span class="string">" annotated with "</span></span><br><span class="line">					+ ClassUtils.getShortName(name) + <span class="string">"?"</span>);</span><br><span class="line">	<span class="keyword">return</span> attributes;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ³¨æ„ï¼Œæ­¤å¤„ <code>getAnnotationClass().getName()</code> è¿”å›çš„æ˜¯ <code>@EnableAutoConfiguration</code> æ³¨è§£ï¼Œæ‰€ä»¥è¿™é‡Œè¿”å›çš„æ³¨è§£å±æ€§ï¼Œåªèƒ½æ˜¯ <code>exclude</code> å’Œ <code>excludeName</code> è¿™ä¸¤ä¸ªã€‚</li>
<li><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ Spring åº”ç”¨ä¸Šçš„æ³¨è§£å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span>(exclude = {SpringApplicationAdminJmxAutoConfiguration.class},</span><br><span class="line">    scanBasePackages = <span class="string">"cn.iocoder"</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¿”å›çš„ç»“æœï¼Œå¦‚ä¸‹å›¾ï¼š<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-02-01/07.jpg" alt="`attributes`"></li>
</ul>
</li>
</ul>
<h3 id="5-4-3-getExclusions"><a href="#5-4-3-getExclusions" class="headerlink" title="5.4.3 getExclusions"></a>5.4.3 getExclusions</h3><p><code>#getExclusions(AnnotationMetadata metadata, AnnotationAttributes attributes)</code> æ–¹æ³•ï¼Œè·å¾—éœ€è¦æ’é™¤çš„é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Set&lt;String&gt; <span class="title">getExclusions</span><span class="params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> </span>{</span><br><span class="line">	Set&lt;String&gt; excluded = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">	<span class="comment">// æ³¨è§£ä¸Šçš„ exclude å±æ€§</span></span><br><span class="line">	excluded.addAll(asList(attributes, <span class="string">"exclude"</span>));</span><br><span class="line">	<span class="comment">// æ³¨è§£ä¸Šçš„ excludeName å±æ€§</span></span><br><span class="line">	excluded.addAll(Arrays.asList(attributes.getStringArray(<span class="string">"excludeName"</span>)));</span><br><span class="line">	<span class="comment">// é…ç½®æ–‡ä»¶çš„ spring.autoconfigure.exclude å±æ€§</span></span><br><span class="line">	excluded.addAll(getExcludeAutoConfigurationsProperty());</span><br><span class="line">	<span class="keyword">return</span> excluded;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¸€å…±æœ‰ä¸‰ç§æ–¹å¼ï¼Œé…ç½®æ’é™¤å±æ€§ã€‚</li>
<li><p>è¯¥æ–¹æ³•ä¼šè°ƒç”¨å¦‚ä¸‹çš„æ–¹æ³•ï¼Œæ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±ç…ç…ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">getExcludeAutoConfigurationsProperty</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// ä¸€èˆ¬æ¥è¯´ï¼Œä¼šèµ°è¿™å—çš„é€»è¾‘</span></span><br><span class="line">	<span class="keyword">if</span> (getEnvironment() <span class="keyword">instanceof</span> ConfigurableEnvironment) {</span><br><span class="line">		Binder binder = Binder.get(getEnvironment());</span><br><span class="line">		<span class="keyword">return</span> binder.bind(PROPERTY_NAME_AUTOCONFIGURE_EXCLUDE, String[].class).map(Arrays::asList).orElse(Collections.emptyList());</span><br><span class="line">	}</span><br><span class="line">	String[] excludes = getEnvironment().getProperty(PROPERTY_NAME_AUTOCONFIGURE_EXCLUDE, String[].class);</span><br><span class="line">	<span class="keyword">return</span> (excludes != <span class="keyword">null</span>) ? Arrays.asList(excludes) : Collections.emptyList();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> List&lt;String&gt; <span class="title">asList</span><span class="params">(AnnotationAttributes attributes, String name)</span> </span>{</span><br><span class="line">	String[] value = attributes.getStringArray(name);</span><br><span class="line">	<span class="keyword">return</span> Arrays.asList(value);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h3 id="5-4-4-checkExcludedClasses"><a href="#5-4-4-checkExcludedClasses" class="headerlink" title="5.4.4 checkExcludedClasses"></a>5.4.4 checkExcludedClasses</h3><p><code>#checkExcludedClasses(List&lt;String&gt; configurations, Set&lt;String&gt; exclusions)</code> æ–¹æ³•ï¼Œæ ¡éªŒæ’é™¤çš„é…ç½®ç±»æ˜¯å¦åˆæ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkExcludedClasses</span><span class="params">(List&lt;String&gt; configurations, Set&lt;String&gt; exclusions)</span> </span>{</span><br><span class="line">    <span class="comment">// è·å¾— exclusions ä¸åœ¨ invalidExcludes çš„é›†åˆï¼Œæ·»åŠ åˆ° invalidExcludes ä¸­</span></span><br><span class="line">    List&lt;String&gt; invalidExcludes = <span class="keyword">new</span> ArrayList&lt;&gt;(exclusions.size());</span><br><span class="line">    <span class="keyword">for</span> (String exclusion : exclusions) {</span><br><span class="line">        <span class="keyword">if</span> (ClassUtils.isPresent(exclusion, getClass().getClassLoader()) <span class="comment">// classpath å­˜åœ¨è¯¥ç±»</span></span><br><span class="line">                &amp;&amp; !configurations.contains(exclusion)) { <span class="comment">// configurations ä¸å­˜åœ¨è¯¥ç±»</span></span><br><span class="line">            invalidExcludes.add(exclusion);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// å¦‚æœ invalidExcludes éç©ºï¼ŒæŠ›å‡º IllegalStateException å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (!invalidExcludes.isEmpty()) {</span><br><span class="line">        handleInvalidExcludes(invalidExcludes);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Handle any invalid excludes that have been specified.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> invalidExcludes the list of invalid excludes (will always have at least one</span></span><br><span class="line"><span class="comment"> * element)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">handleInvalidExcludes</span><span class="params">(List&lt;String&gt; invalidExcludes)</span> </span>{</span><br><span class="line">    StringBuilder message = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    <span class="keyword">for</span> (String exclude : invalidExcludes) {</span><br><span class="line">        message.append(<span class="string">"\t- "</span>).append(exclude).append(String.format(<span class="string">"%n"</span>));</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(String.format(<span class="string">"The following classes could not be excluded because they are"</span></span><br><span class="line">                    + <span class="string">" not auto-configuration classes:%n%s"</span>, message));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¸åˆæ³•çš„å®šä¹‰ï¼Œ<code>exclusions</code> å­˜åœ¨äº classpath ä¸­ï¼Œä½†æ˜¯ä¸å­˜åœ¨ <code>configurations</code> ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ï¼Œå¦‚æœä¸å­˜åœ¨çš„ï¼Œå°±ä¸è¦å»æ’é™¤å•¦ï¼</li>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±ç…ç…å³å¯ã€‚</li>
</ul>
<h3 id="5-4-5-fireAutoConfigurationImportEvents"><a href="#5-4-5-fireAutoConfigurationImportEvents" class="headerlink" title="5.4.5 fireAutoConfigurationImportEvents"></a>5.4.5 fireAutoConfigurationImportEvents</h3><p><code>#fireAutoConfigurationImportEvents(List&lt;String&gt; configurations, Set&lt;String&gt; exclusions)</code> æ–¹æ³•ï¼Œè§¦å‘è‡ªåŠ¨é…ç½®ç±»å¼•å…¥å®Œæˆçš„äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fireAutoConfigurationImportEvents</span><span class="params">(List&lt;String&gt; configurations, Set&lt;String&gt; exclusions)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; åŠ è½½æŒ‡å®šç±»å‹ AutoConfigurationImportListener å¯¹åº”çš„ï¼Œåœ¨ `META-INF/spring.factories` é‡Œçš„ç±»åçš„æ•°ç»„ã€‚</span></span><br><span class="line">	List&lt;AutoConfigurationImportListener&gt; listeners = getAutoConfigurationImportListeners();</span><br><span class="line">	<span class="keyword">if</span> (!listeners.isEmpty()) {</span><br><span class="line">	    <span class="comment">// &lt;2&gt; åˆ›å»º AutoConfigurationImportEvent äº‹ä»¶</span></span><br><span class="line">		AutoConfigurationImportEvent event = <span class="keyword">new</span> AutoConfigurationImportEvent(<span class="keyword">this</span>, configurations, exclusions);</span><br><span class="line">		<span class="comment">// &lt;3&gt; éå† AutoConfigurationImportListener ç›‘å¬å™¨ä»¬ï¼Œé€ä¸ªé€šçŸ¥</span></span><br><span class="line">		<span class="keyword">for</span> (AutoConfigurationImportListener listener : listeners) {</span><br><span class="line">		    <span class="comment">// &lt;3.1&gt; è®¾ç½® AutoConfigurationImportListener çš„å±æ€§</span></span><br><span class="line">			invokeAwareMethods(listener);</span><br><span class="line">			<span class="comment">// &lt;3.2&gt; é€šçŸ¥</span></span><br><span class="line">			listener.onAutoConfigurationImportEvent(event);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#getAutoConfigurationImportListeners()</code> æ–¹æ³•ï¼ŒåŠ è½½æŒ‡å®šç±»å‹ AutoConfigurationImportListener å¯¹åº”çš„ï¼Œåœ¨ <code>META-INF/spring.factories</code> é‡Œçš„ç±»åçš„æ•°ç»„ã€‚ä¾‹å¦‚ï¼š<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-02-01/08.jpg" alt="`listeners`"></li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œåˆ›å»º AutoConfigurationImportEvent äº‹ä»¶ã€‚</li>
<li><p><code>&lt;3&gt;</code> å¤„ï¼Œéå† AutoConfigurationImportListener ç›‘å¬å™¨ä»¬ï¼Œé€ä¸ªé€šçŸ¥ã€‚</p>
<ul>
<li><p><code>&lt;3.1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#invokeAwareMethods(Object instance)</code> æ–¹æ³•ï¼Œè®¾ç½® AutoConfigurationImportListener çš„å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationImportSelector.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeAwareMethods</span><span class="params">(Object instance)</span> </span>{</span><br><span class="line">    <span class="comment">// å„ç§ Aware å±æ€§çš„æ³¨å…¥</span></span><br><span class="line">	<span class="keyword">if</span> (instance <span class="keyword">instanceof</span> Aware) {</span><br><span class="line">		<span class="keyword">if</span> (instance <span class="keyword">instanceof</span> BeanClassLoaderAware) {</span><br><span class="line">			((BeanClassLoaderAware) instance).setBeanClassLoader(<span class="keyword">this</span>.beanClassLoader);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> (instance <span class="keyword">instanceof</span> BeanFactoryAware) {</span><br><span class="line">			((BeanFactoryAware) instance).setBeanFactory(<span class="keyword">this</span>.beanFactory);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> (instance <span class="keyword">instanceof</span> EnvironmentAware) {</span><br><span class="line">			((EnvironmentAware) instance).setEnvironment(<span class="keyword">this</span>.environment);</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">if</span> (instance <span class="keyword">instanceof</span> ResourceLoaderAware) {</span><br><span class="line">			((ResourceLoaderAware) instance).setResourceLoader(<span class="keyword">this</span>.resourceLoader);</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å„ç§ Aware å±æ€§çš„æ³¨å…¥ã€‚</li>
</ul>
</li>
<li><p><code>&lt;3.2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>AutoConfigurationImportListener#onAutoConfigurationImportEvent(event)</code> æ–¹æ³•ï¼Œé€šçŸ¥ç›‘å¬å™¨ã€‚ç›®å‰åªæœ‰ä¸€ä¸ª ConditionEvaluationReportAutoConfigurationImportListener  ç›‘å¬å™¨ï¼Œæ²¡å•¥é€»è¾‘ï¼Œæœ‰å…´è¶£è‡ªå·±çœ‹å“ˆã€‚</p>
</li>
</ul>
</li>
</ul>
<h1 id="6-AutoConfigurationPackages"><a href="#6-AutoConfigurationPackages" class="headerlink" title="6. AutoConfigurationPackages"></a>6. AutoConfigurationPackages</h1><p><code>org.springframework.boot.autoconfigure.AutoConfigurationPackages</code> ï¼Œè‡ªåŠ¨é…ç½®æ‰€åœ¨çš„åŒ…åã€‚å¯èƒ½è¿™ä¹ˆè§£é‡Šæœ‰ç‚¹æ€ªæ€ªçš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å®˜æ–¹æ³¨é‡Šï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">Class <span class="keyword">for</span> storing auto-<span class="function">configuration packages <span class="keyword">for</span> reference <span class="title">later</span> <span class="params">(e.g. by JPA entity scanner)</span>.</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯å°†ä½¿ç”¨ <code>@AutoConfigurationPackage</code> æ³¨è§£çš„ç±»æ‰€åœ¨çš„åŒ…ï¼ˆ<code>package</code>ï¼‰ï¼Œæ³¨å†Œæˆä¸€ä¸ª Spring IoC å®¹å™¨ä¸­çš„ Bean ã€‚é…±ç´«ï¼Œåç»­æœ‰å…¶å®ƒæ¨¡å—éœ€è¦ä½¿ç”¨ï¼Œå°±å¯ä»¥é€šè¿‡è·å¾—è¯¥ Bean ï¼Œä»è€Œè·å¾—æ‰€åœ¨çš„åŒ…ã€‚ä¾‹å¦‚è¯´ï¼ŒJPA æ¨¡å—ï¼Œéœ€è¦ä½¿ç”¨åˆ°ã€‚</li>
</ul>
<p>æ˜¯ä¸æ˜¯æœ‰ç‚¹ç¥å¥‡ï¼Œè‰¿è‰¿ä¹Ÿè§‰å¾—ã€‚</p>
<h2 id="6-1-Registrar"><a href="#6-1-Registrar" class="headerlink" title="6.1 Registrar"></a>6.1 Registrar</h2><p>Registrar ï¼Œæ˜¯ AutoConfigurationPackages çš„å†…éƒ¨ç±»ï¼Œå®ç° ImportBeanDefinitionRegistrarã€DeterminableImports æ¥å£ï¼Œæ³¨å†Œå™¨ï¼Œç”¨äºå¤„ç† <code>@AutoConfigurationPackage</code> æ³¨è§£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationPackages#Registrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Registrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">DeterminableImports</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> </span>{</span><br><span class="line">		register(registry, <span class="keyword">new</span> PackageImport(metadata).getPackageName()); <span class="comment">// &lt;X&gt;</span></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Set&lt;Object&gt; <span class="title">determineImports</span><span class="params">(AnnotationMetadata metadata)</span> </span>{</span><br><span class="line">		<span class="keyword">return</span> Collections.singleton(<span class="keyword">new</span> PackageImport(metadata));</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>PackageImport æ˜¯ AutoConfigurationPackages çš„å†…éƒ¨ç±»ï¼Œç”¨äºè·å¾—åŒ…åã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationPackages#Registrar.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PackageImport</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŒ…å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String packageName;</span><br><span class="line"></span><br><span class="line">    PackageImport(AnnotationMetadata metadata) {</span><br><span class="line">        <span class="keyword">this</span>.packageName = ClassUtils.getPackageName(metadata.getClassName());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPackageName</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.packageName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (obj == <span class="keyword">null</span> || getClass() != obj.getClass()) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.packageName.equals(((PackageImport) obj).packageName);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.packageName.hashCode();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Package Import "</span> + <span class="keyword">this</span>.packageName;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¦‚ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-02-01/10.jpg" alt="PackageImport"></li>
</ul>
</li>
<li><code>&lt;X&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#register(BeanDefinitionRegistry registry, String... packageNames)</code> æ–¹æ³•ï¼Œæ³¨å†Œä¸€ä¸ªç”¨äºå­˜å‚¨æŠ¥åï¼ˆ<code>package</code>ï¼‰çš„ Bean åˆ° Spring IoC å®¹å™¨ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ6.2 registerã€</a> ã€‚</li>
</ul>
<h2 id="6-2-register"><a href="#6-2-register" class="headerlink" title="6.2 register"></a>6.2 register</h2><p><code>#register(BeanDefinitionRegistry registry, String... packageNames)</code> æ–¹æ³•ï¼Œæ³¨å†Œä¸€ä¸ªç”¨äºå­˜å‚¨æŠ¥åï¼ˆ<code>package</code>ï¼‰çš„ Bean åˆ° Spring IoC å®¹å™¨ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationPackages.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEAN = AutoConfigurationPackages.class.getName();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(BeanDefinitionRegistry registry, String... packageNames)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; å¦‚æœå·²ç»å­˜åœ¨è¯¥ BEAN ï¼Œåˆ™ä¿®æ”¹å…¶åŒ…ï¼ˆpackageï¼‰å±æ€§</span></span><br><span class="line">	<span class="keyword">if</span> (registry.containsBeanDefinition(BEAN)) {</span><br><span class="line">		BeanDefinition beanDefinition = registry.getBeanDefinition(BEAN);</span><br><span class="line">		ConstructorArgumentValues constructorArguments = beanDefinition.getConstructorArgumentValues();</span><br><span class="line">		constructorArguments.addIndexedArgumentValue(<span class="number">0</span>, addBasePackages(constructorArguments, packageNames));</span><br><span class="line">    <span class="comment">// &lt;2&gt; å¦‚æœä¸å­˜åœ¨è¯¥ BEAN ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª Bean ï¼Œå¹¶è¿›è¡Œæ³¨å†Œ</span></span><br><span class="line">    } <span class="keyword">else</span> { GenericBeanDefinition beanDefinition = <span class="keyword">new</span> GenericBeanDefinition();</span><br><span class="line">		beanDefinition.setBeanClass(BasePackages.class);</span><br><span class="line">		beanDefinition.getConstructorArgumentValues().addIndexedArgumentValue(<span class="number">0</span>, packageNames);</span><br><span class="line">		beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br><span class="line">		registry.registerBeanDefinition(BEAN, beanDefinition);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>æ³¨å†Œçš„ <code>BEAN</code> çš„ç±»å‹ï¼Œä¸º BasePackages ç±»å‹ã€‚å®ƒæ˜¯ AutoConfigurationPackages çš„å†…éƒ¨ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationPackages#BasePackages.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BasePackages</span> </span>{</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; packages;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">boolean</span> loggedBasePackageInfo;</span><br><span class="line"></span><br><span class="line">	BasePackages(String... names) {</span><br><span class="line">		List&lt;String&gt; packages = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">		<span class="keyword">for</span> (String name : names) {</span><br><span class="line">			<span class="keyword">if</span> (StringUtils.hasText(name)) {</span><br><span class="line">				packages.add(name);</span><br><span class="line">			}</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">this</span>.packages = packages;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">get</span><span class="params">()</span> </span>{</span><br><span class="line">		<span class="keyword">if</span> (!<span class="keyword">this</span>.loggedBasePackageInfo) {</span><br><span class="line">			<span class="keyword">if</span> (<span class="keyword">this</span>.packages.isEmpty()) {</span><br><span class="line">				<span class="keyword">if</span> (logger.isWarnEnabled()) {</span><br><span class="line">					logger.warn(<span class="string">"@EnableAutoConfiguration was declared on a class "</span></span><br><span class="line">							+ <span class="string">"in the default package. Automatic @Repository and "</span></span><br><span class="line">							+ <span class="string">"@Entity scanning is not enabled."</span>);</span><br><span class="line">				}</span><br><span class="line">			} <span class="keyword">else</span> {</span><br><span class="line">				<span class="keyword">if</span> (logger.isDebugEnabled()) {</span><br><span class="line">					String packageNames = StringUtils</span><br><span class="line">							.collectionToCommaDelimitedString(<span class="keyword">this</span>.packages);</span><br><span class="line">					logger.debug(<span class="string">"@EnableAutoConfiguration was declared on a class "</span></span><br><span class="line">							+ <span class="string">"in the package '"</span> + packageNames</span><br><span class="line">							+ <span class="string">"'. Automatic @Repository and @Entity scanning is "</span></span><br><span class="line">							+ <span class="string">"enabled."</span>);</span><br><span class="line">				}</span><br><span class="line">			}</span><br><span class="line">			<span class="keyword">this</span>.loggedBasePackageInfo = <span class="keyword">true</span>;</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.packages;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å°±æ˜¯ä¸€ä¸ªæœ‰ <code>packages</code> å±æ€§çš„å°è£…ç±»ã€‚</li>
</ul>
</li>
<li><code>&lt;1&gt;</code> å¤„ï¼Œå¦‚æœå·²ç»å­˜åœ¨è¯¥ <code>BEAN</code> ï¼Œåˆ™ä¿®æ”¹å…¶åŒ…ï¼ˆ<code>package</code>ï¼‰å±æ€§ã€‚è€Œåˆå¹¶ <code>package</code> çš„é€»è¾‘ï¼Œé€šè¿‡ <code>#addBasePackages(ConstructorArgumentValues constructorArguments, String[] packageNames)</code> æ–¹æ³•ï¼Œè¿›è¡Œå®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š  <figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationPackages.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String[] addBasePackages(ConstructorArgumentValues constructorArguments, String[] packageNames) {</span><br><span class="line">	<span class="comment">// è·å¾—å·²å­˜åœ¨çš„</span></span><br><span class="line">    String[] existing = (String[]) constructorArguments.getIndexedArgumentValue(<span class="number">0</span>, String[].class).getValue();</span><br><span class="line">	<span class="comment">// è¿›è¡Œåˆå¹¶</span></span><br><span class="line">    Set&lt;String&gt; merged = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br><span class="line">	merged.addAll(Arrays.asList(existing));</span><br><span class="line">	merged.addAll(Arrays.asList(packageNames));</span><br><span class="line">	<span class="keyword">return</span> StringUtils.toStringArray(merged);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><code>&lt;2&gt;</code> å¤„ï¼Œå¦‚æœä¸å­˜åœ¨è¯¥ <code>BEAN</code> ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª <code>Bean</code> ï¼Œå¹¶è¿›è¡Œæ³¨å†Œã€‚</li>
</ul>
<h2 id="6-3-has"><a href="#6-3-has" class="headerlink" title="6.3 has"></a>6.3 has</h2><p><code>#has(BeanFactory beanFactory)</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨è¯¥ <code>BEAN</code> åœ¨ä¼ å…¥çš„å®¹å™¨ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationPackages.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">has</span><span class="params">(BeanFactory beanFactory)</span> </span>{</span><br><span class="line">	<span class="keyword">return</span> beanFactory.containsBean(BEAN) &amp;&amp; !get(beanFactory).isEmpty();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="6-4-get"><a href="#6-4-get" class="headerlink" title="6.4 get"></a>6.4 get</h2><p><code>#get(BeanFactory beanFactory)</code> æ–¹æ³•ï¼Œè·å¾— <code>BEAN</code> ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AutoConfigurationPackages.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">get</span><span class="params">(BeanFactory beanFactory)</span> </span>{</span><br><span class="line">	<span class="keyword">try</span> {</span><br><span class="line">		<span class="keyword">return</span> beanFactory.getBean(BEAN, BasePackages.class).get();</span><br><span class="line">	} <span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) {</span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unable to retrieve @EnableAutoConfiguration base packages"</span>);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ¯”æƒ³è±¡ä¸­é•¿çš„ä¸€ç¯‡æ–‡ç« ã€‚è™½ç„¶ä¸­é—´æœ‰äº›åœ°æ–¹å¤æ‚äº†ä¸€ç‚¹ï¼Œä½†æ˜¯è§‰å¾—è¿˜æ˜¯è›®æœ‰è¶£çš„ã€‚</p>
<p>æ’¸å®Œæœ‰ç‚¹ä¸æ¸…æ™°çš„èƒ–å‹ï¼Œå†è°ƒè¯•ä¸¤éã€‚è¿˜æœ‰ç–‘æƒ‘ï¼Œæ˜Ÿçƒç•™è¨€èµ°ä¸€æ³¢å“Ÿã€‚</p>
<p>å‚è€ƒå’Œæ¨èå¦‚ä¸‹æ–‡ç« ï¼š</p>
<ul>
<li><p>å¿«ä¹å´‡æ‹œ <a href="https://gitbook.cn/books/5a445f030173cb29d2041d61/index.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Boot æºç æ·±å…¥åˆ†æã€‹</a></p>
<blockquote>
<p>æœ‰æœ¨å‘ç°ï¼Œè‰¿è‰¿å†™çš„æ¯”ä»–è¯¦ç»†å¾ˆå¤šå¾ˆå¤šã€‚</p>
</blockquote>
</li>
<li><p>è€ç”° <a href="http://www.54tianzhisheng.cn/2018/04/19/SpringBootApplication-annotation/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSpring Boot 2.0 ç³»åˆ—æ–‡ç« (å…­)ï¼šSpring Boot 2.0 ä¸­SpringBootApplicationæ³¨è§£è¯¦è§£ã€‹</a></p>
</li>
<li>dm_vincent <a href="https://blog.csdn.net/dm_vincent/article/details/77619752" rel="external nofollow noopener noreferrer" target="_blank">ã€Š[Spring Boot] 4. Spring Bootå®ç°è‡ªåŠ¨é…ç½®çš„åŸç†ã€‹</a></li>
</ul>

</div>
<div class="article-info article-info-index">

<div class="article-category tagcloud">
<i class="icon-book icon"></i>
<ul class="article-tag-list">

<li class="article-tag-list-item">
<a href="/categories/Spring-Boot//" class="article-tag-list-link color2">Spring Boot</a>
</li>

</ul>
</div>

<div class="clearfix"></div>
</div>
</div>
</article>

<!-- hexo çš„ä¸‹ä¸€ç¯‡é€»è¾‘æœ‰é—®é¢˜

<nav id="article-nav">

<a href="/Spring-Boot/Condition/" id="article-nav-newer" class="article-nav-link-wrap">
<i class="icon-circle-left"></i>
<div class="article-nav-title">

ç²¾å°½ Spring Boot æºç åˆ†æ â€”â€” Condition

</div>
</a>


<a href="/Spring-Boot/SpringApplication/" id="article-nav-older" class="article-nav-link-wrap">
<div class="article-nav-title">ç²¾å°½ Spring Boot æºç åˆ†æ â€”â€” SpringApplication</div>
<i class="icon-circle-right"></i>
</a>

</nav>

-->

<aside class="wrap-side-operation">
<div class="mod-side-operation">

<div class="jump-container" id="js-jump-container" style="display: none;">
<a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
<i class="icon-font icon-back"></i>
</a>
<div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
<i class="icon-font icon-plane jump-plane"></i>
</div>
</div>

<div class="toc-container tooltip-left">
<i class="icon-font icon-category"></i>
<div class="tooltip tooltip-east">
<span class="tooltip-item">
</span>
<span class="tooltip-content">
<div class="toc-article">
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1-æ¦‚è¿°"><span class="toc-number" style="display: none;">1.</span> <span class="toc-text">1. æ¦‚è¿°</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-è‡ªåŠ¨é…ç½®-V-S-è‡ªåŠ¨è£…é…"><span class="toc-number" style="display: none;">2.</span> <span class="toc-text">2. è‡ªåŠ¨é…ç½® V.S è‡ªåŠ¨è£…é…</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-è‡ªåŠ¨è£…é…åŸç†"><span class="toc-number" style="display: none;">3.</span> <span class="toc-text">3. è‡ªåŠ¨è£…é…åŸç†</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-SpringBootApplication"><span class="toc-number" style="display: none;">4.</span> <span class="toc-text">4. @SpringBootApplication</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#4-1-Inherited"><span class="toc-number" style="display: none;">4.1.</span> <span class="toc-text">4.1 @Inherited</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2-SpringBootConfiguration"><span class="toc-number" style="display: none;">4.2.</span> <span class="toc-text">4.2 @SpringBootConfiguration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3-ComponentScan"><span class="toc-number" style="display: none;">4.3.</span> <span class="toc-text">4.3 @ComponentScan</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4-EnableAutoConfiguration"><span class="toc-number" style="display: none;">4.4.</span> <span class="toc-text">4.4 @EnableAutoConfiguration</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5-AutoConfigurationImportSelector"><span class="toc-number" style="display: none;">5.</span> <span class="toc-text">5. AutoConfigurationImportSelector</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#5-1-getCandidateConfigurations"><span class="toc-number" style="display: none;">5.1.</span> <span class="toc-text">5.1 getCandidateConfigurations</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-2-getImportGroup"><span class="toc-number" style="display: none;">5.2.</span> <span class="toc-text">5.2 getImportGroup</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-3-AutoConfigurationGroup"><span class="toc-number" style="display: none;">5.3.</span> <span class="toc-text">5.3 AutoConfigurationGroup</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-1-å±æ€§"><span class="toc-number" style="display: none;">5.3.1.</span> <span class="toc-text">5.3.1 å±æ€§</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-2-process"><span class="toc-number" style="display: none;">5.3.2.</span> <span class="toc-text">5.3.2 process</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-3-selectImports"><span class="toc-number" style="display: none;">5.3.3.</span> <span class="toc-text">5.3.3 selectImports</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-4-getAutoConfigurationEntry"><span class="toc-number" style="display: none;">5.4.</span> <span class="toc-text">5.4 getAutoConfigurationEntry</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-1-isEnabled"><span class="toc-number" style="display: none;">5.4.1.</span> <span class="toc-text">5.4.1 isEnabled</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-2-getAttributes"><span class="toc-number" style="display: none;">5.4.2.</span> <span class="toc-text">5.4.2 getAttributes</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-3-getExclusions"><span class="toc-number" style="display: none;">5.4.3.</span> <span class="toc-text">5.4.3 getExclusions</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-4-checkExcludedClasses"><span class="toc-number" style="display: none;">5.4.4.</span> <span class="toc-text">5.4.4 checkExcludedClasses</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-5-fireAutoConfigurationImportEvents"><span class="toc-number" style="display: none;">5.4.5.</span> <span class="toc-text">5.4.5 fireAutoConfigurationImportEvents</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6-AutoConfigurationPackages"><span class="toc-number" style="display: none;">6.</span> <span class="toc-text">6. AutoConfigurationPackages</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#6-1-Registrar"><span class="toc-number" style="display: none;">6.1.</span> <span class="toc-text">6.1 Registrar</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-2-register"><span class="toc-number" style="display: none;">6.2.</span> <span class="toc-text">6.2 register</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-3-has"><span class="toc-number" style="display: none;">6.3.</span> <span class="toc-text">6.3 has</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-4-get"><span class="toc-number" style="display: none;">6.4.</span> <span class="toc-text">6.4 get</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#666-å½©è›‹"><span class="toc-number" style="display: none;">7.</span> <span class="toc-text">666. å½©è›‹</span></a></li></ol>
</div>
</span>
</div>
</div>

</div>
</aside>

</div>
</div>
</div>
