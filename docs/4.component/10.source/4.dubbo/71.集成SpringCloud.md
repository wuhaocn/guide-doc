# é›†æˆ Spring Cloud

# 1. æ¦‚è¿°

æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥åˆ†äº« [Spring Cloud Alibaba Dubbo](https://github.com/spring-cloud-incubator/spring-cloud-alibaba/tree/master/spring-cloud-alibaba-dubbo) é¡¹ç›®çš„æºç è§£æï¼Œçœ‹çœ‹ Dubbo æ˜¯å¦‚ä½•é›†æˆåˆ° Spring Cloud ä¸­çš„ã€‚
ğŸ˜ˆ Spring Cloud å’Œ Dubbo ä¸€ç›´ä¸æ˜¯ç«äº‰çš„å…³ç³»ï¼Œèƒ–å‹è¦å¥½å¥½ç†è§£å“Ÿã€‚

ç›®å‰ Spring Cloud Alibaba Dubbo æš‚æ—¶æ²¡æœ‰æ–‡æ¡£ï¼Œä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œè‰¿è‰¿ä¼šå…ˆæ•™ä½ æ­å»ºä¸€ä¸ªç¤ºä¾‹ï¼ŒåŒæ—¶å®ƒä¹Ÿæ˜¯æˆ‘ä»¬åé¢ç”¨æ¥è°ƒè¯•çš„ç¤ºä¾‹ã€‚

# 2. è°ƒè¯•ç¯å¢ƒæ­å»º

åœ¨è¯»æºç ä¹‹å‰ï¼Œæˆ‘ä»¬å½“ç„¶æ˜¯å…ˆæŠŠè°ƒè¯•ç¯å¢ƒæ­å»ºèµ·æ¥ã€‚

## 2.1 ä¾èµ–å·¥å…·

- JDK ï¼š1.8+
- Maven
- IntelliJ IDEA

## 2.2 æºç æ‹‰å–

ä»å®˜æ–¹ä»“åº“ [https://github.com/spring-cloud-incubator/spring-cloud-alibaba](https://github.com/spring-cloud-incubator/spring-cloud-alibaba)

Fork
å‡ºå±äºè‡ªå·±çš„ä»“åº“ã€‚ä¸ºä»€ä¹ˆè¦

Fork
ï¼Ÿæ—¢ç„¶å¼€å§‹é˜…è¯»ã€è°ƒè¯•æºç ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™ä¸€äº›æ³¨é‡Šï¼Œæœ‰äº†è‡ªå·±çš„ä»“åº“ï¼Œå¯ä»¥è¿›è¡Œè‡ªç”±çš„æäº¤ã€‚ğŸ˜ˆ

ä½¿ç”¨ IntelliJ IDEA ä» Fork å‡ºæ¥çš„ä»“åº“æ‹‰å–ä»£ç ã€‚æ‹‰å–å®Œæˆåï¼ŒMaven ä¼šä¸‹è½½ä¾èµ–åŒ…ï¼Œå¯èƒ½ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œè€å¿ƒç­‰å¾…ä¸‹ã€‚

è€ƒè™‘åˆ°æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨

spring-cloud-alibaba-dubbo
é¡¹ç›®æä¾›çš„ç¤ºä¾‹ï¼Œå°±åœ¨å®ƒçš„

test
æµ‹è¯•ç›®å½•ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![ç¤ºä¾‹é¡¹ç›®](http://static2.iocoder.cn/images/Dubbo/2018_02_14/01.jpg)

ğŸ˜ˆ å¦å¤–ï¼Œæœ¬æ–‡ä½¿ç”¨çš„

spring-cloud-alibaba
ç‰ˆæœ¬æ˜¯

0.2.2.BUILD-SNAPSHOT
ã€‚

## 2.3 å¯åŠ¨ Nacos

å› ä¸ºåé¢æˆ‘ä»¬ä¼šä½¿ç”¨ Nacos ä½œä¸ºæ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒï¼Œæ‰€ä»¥éœ€è¦å¯åŠ¨å®ƒã€‚å…·ä½“çš„ï¼Œå‚è€ƒè‰¿è‰¿åœ¨ [ã€ŠNacos å®ç°åŸç†ä¸æºç è§£æç³»ç»Ÿ â€”â€” ç²¾å“åˆé›†ã€‹](http://www.iocoder.cn/Nacos/the-tutorial/) çš„ [ã€Œ2. å¿«é€Ÿå¼€å§‹ã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) å°èŠ‚ã€‚

## 2.4 å¯åŠ¨ç¤ºä¾‹

å³é”® DubboSpringCloudBootstrap ç±»çš„

/#main(String[] args)
æ–¹æ³•ï¼Œç›´æ¥è¿è¡Œå³å¯ã€‚ğŸ™‚ å¦‚æœä½ æ²¡æœ‰çœ‹åˆ°ä»»ä½•å¼‚å¸¸è¾“å‡ºï¼Œè¯´æ˜å°±å·²ç»æˆåŠŸäº†ã€‚

å¦å¤–ï¼Œè¿™ä¸ªç¤ºä¾‹ï¼Œå³åšäº†æœåŠ¡æ¶ˆè´¹è€…ï¼Œåˆåšäº†æœåŠ¡æä¾›è€…ã€‚

ä¸‹é¢ï¼Œè®©æˆ‘ä»¬è®©æˆ‘ä»¬é€æ­¥è§£é‡Šç¤ºä¾‹ä¸­çš„æ¯ä¸ªç±»å’Œé…ç½®æ–‡ä»¶ã€‚

### 2.4.1 bootstrap.yaml

```
spring:
application:
name: spring-cloud-alibaba-dubbo
cloud:
nacos:
discovery:
server-addr: 127.0.0.1:8848
config:
server-addr: 127.0.0.1:8848
eureka:
client:
enabled: false
---
spring:
profiles: eureka
cloud:
nacos:
discovery:
enabled: false
register-enabled: false
eureka:
client:
enabled: true
service-url:
defaultZone: http://127.0.0.1:8761/eureka/
```

- Eureka ç›¸å…³çš„é…ç½®ï¼Œå¯ä»¥æ— è§†ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Nacos ä½œä¸ºæ³¨å†Œä¸­å¿ƒã€‚
- spring.application.name
  ï¼Œé…ç½®äº†åº”ç”¨åã€‚
- spring.cloud.nacos.discovery.server-addr
  ï¼Œé…ç½®äº† Nacos ä½œä¸ºæ³¨å†Œä¸­å¿ƒã€‚
- spring.cloud.nacos.config.server-addr
  ï¼Œé…ç½®äº† Nacos ä½œä¸ºé…ç½®ä¸­å¿ƒã€‚

### 2.4.2 application.yaml

```
dubbo:
scan:
base-packages: org.springframework.cloud.alibaba.dubbo.service /# æ‰«ææŒ‡å®šåŒ…ï¼Œç”Ÿæˆå¯¹åº”çš„ @Service å’Œ @Reference Bean å¯¹è±¡
protocols:
dubbo:
name: dubbo /# Dubbo åè®®
port: 12345 /# Dubbo åè®®çš„ç«¯å£
rest:
name: rest /# REST åè®®
port: 9090 /# REST åè®®çš„ç«¯å£
server: netty /# ä½¿ç”¨ Netty ä½œä¸º HTTP Server
registry:
address: spring-cloud://nacos /# Dubbo æ³¨å†Œä¸­å¿ƒ
feign:
hystrix:
enabled: true /# å¼€å¯ Hystrix åŠŸèƒ½ï¼Œå¯ä»¥ç†”æ–­è½
server:
port: 8080 /# HTTP API ç«¯å£
```

- æ¯ä¸ªé…ç½®ï¼Œçœ‹çœ‹å…¶åçš„é…ç½®æ–‡ä»¶ã€‚

### 2.4.3 EchoService

org.springframework.cloud.alibaba.dubbo.service.EchoService
ï¼ŒEchoService æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// EchoService.java
public interface EchoService{
String echo(String message);
String plus(int a, int b);
}
```

- ç†Ÿæ‚‰ä¸èƒ½åœ¨ç†Ÿæ‚‰çš„ Dubbo Service æ¥å£çš„ä»£ç ~

### 2.4.4 DefaultEchoService

org.springframework.cloud.alibaba.dubbo.service.DefaultEchoService
ï¼Œå®ç° EchoService æ¥å£ï¼Œé»˜è®¤çš„ EchoService å®ç°è€…ï¼ŒæœåŠ¡æä¾›è€…ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DefaultEchoService.java
@Service(version = "1.0.0", protocol = {"dubbo", "rest"})
@RestController
@Path("/")
public class DefaultEchoService implements EchoService{
@Override
@GetMapping(value = "/echo"
// consumes = MediaType.APPLICATION_JSON_VALUE,
// produces = MediaType.APPLICATION_JSON_UTF8_VALUE
)
@Path("/echo")
@GET
// @Consumes("application/json")
// @Produces("application/json;charset=UTF-8")
public String echo(@RequestParam @QueryParam("message") String message){
System.out.println(message);
return RpcContext.getContext().getUrl() + " [echo] : " + message;
}
@Override
@PostMapping("/plus")
@Path("/plus")
@POST
public String plus(@RequestParam @QueryParam("a") int a, @RequestParam @QueryParam("b") int b){
return null;
}
}
```

- @Service(version = "1.0.0", protocol = {"dubbo", "rest"})
  æ³¨è§£ï¼Œæä¾› Dubbo å’Œ Rest ä¸¤ç§åè®®çš„æœåŠ¡ã€‚

### 2.4.5 DubboSpringCloudBootstrap

org.springframework.cloud.alibaba.dubbo.bootstrap.DubboSpringCloudBootstrap
ï¼Œç¤ºä¾‹çš„ Spring Boot å¯åŠ¨å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboSpringCloudBootstrap.java
@EnableDiscoveryClient // å¼€å¯æ³¨å†Œå‘ç°
@EnableAutoConfiguration // å¼€å¯è‡ªåŠ¨é…ç½®
@EnableFeignClients // å¼€å¯ Feign Client
@RestController
public class DubboSpringCloudBootstrap{
@Reference(version = "1.0.0")
private EchoService echoService;
@Autowired
@Lazy
private FeignEchoService feignEchoService;
@Autowired
@Lazy
private DubboFeignEchoService dubboFeignEchoService;
public static void main(String[] args){
new SpringApplicationBuilder(DubboSpringCloudBootstrap.class)
.run(args);
}
}
```

- @EnableDiscoveryClient
  æ³¨è§£ï¼Œç”¨äºå¼€å¯æ³¨å†Œå‘ç° Client çš„åŠŸèƒ½ã€‚
- @EnableAutoConfiguration
  æ³¨è§£ï¼Œç”¨äºå¼€å¯è‡ªåŠ¨é…ç½®ã€‚
- @EnableFeignClients
  æ³¨è§£ï¼Œå¼€å¯ Feign Client ã€‚åœ¨

spring-cloud-alibaba-dubbo
é¡¹ç›®ä¸­ï¼Œä½¿ç”¨ Feign ä½œä¸ºæœåŠ¡æ¶ˆè´¹è€…ã€‚

- @RestController
  æ³¨è§£ï¼Œåç»­æˆ‘ä»¬ä¼šçœ‹åˆ°è¿™ä¸ªç±»ä¸­ä¼šæä¾›åŸºäº Spring MVC çš„ HTTP API æ¥å£ã€‚
- echoService
  å±æ€§ï¼Œä½¿ç”¨

@Reference(version = "1.0.0")
æ³¨è§£ï¼Œå¼•å…¥ Dubbo æœåŠ¡ã€‚è¿™ä¸ªæ–¹å¼ï¼Œå°±æ˜¯æˆ‘ä»¬åŸå…ˆåœ¨ Dubbo ä¸­å°±ä½¿ç”¨çš„ã€‚

- feignEchoService
  å±æ€§ï¼Œä½¿ç”¨æ ‡å‡†çš„ Feign Client ä½œä¸ºæœåŠ¡æ¶ˆè´¹è€…ï¼Œå®ƒä½¿ç”¨ RestTemplate è°ƒç”¨çš„æ˜¯ Dubbo æä¾›çš„ Rest æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboSpringCloudBootstrap.java
@FeignClient("spring-cloud-alibaba-dubbo")
public interface FeignEchoService{
@GetMapping(value = "/echo")
String echo(@RequestParam("message") String message);
}
```

- dubboFeignEchoService
  å±æ€§ï¼Œä¹Ÿä½¿ç”¨æ ‡å‡†çš„ Feign Client ä½œä¸ºæœåŠ¡æ¶ˆè´¹è€…ï¼Œå®ƒè°ƒç”¨ Dubbo è°ƒç”¨çš„æ˜¯ Dubbo æä¾›çš„ Dubbo æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboSpringCloudBootstrap.java
@FeignClient("spring-cloud-alibaba-dubbo")
public interface DubboFeignEchoService{
@GetMapping(value = "/echo")
@DubboTransported
String echo(@RequestParam("message") String message);
}
```

- ç›¸æ¯”

echoService
å±æ€§ï¼Œå®ƒåœ¨æ–¹æ³•ä¸Šï¼Œå¢åŠ äº†

org.springframework.cloud.alibaba.dubbo.annotation.@DubboTransported
æ³¨è§£ã€‚

- å¯èƒ½ä¼šæœ‰èƒ–å‹å¥½å¥‡ï¼Œå…·ä½“æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿæœ¬æ–‡æˆ‘ä»¬ä¸€èµ·æ¥æ­æ™“~

```
// DubboSpringCloudBootstrap.java
@Bean
public ApplicationRunner applicationRunner(){
return arguments -> {
// Dubbo Service call
System.out.println(echoService.echo("mercyblitz"));
// Spring Cloud Open Feign REST Call
System.out.println(feignEchoService.echo("mercyblitz"));
// Spring Cloud Open Feign REST Call (Dubbo Transported)
System.out.println(dubboFeignEchoService.echo("mercyblitz"));
};
}
```

- å£°æ˜äº† ApplicationRunner Bean å¯¹è±¡ï¼Œåœ¨ Spring Boot å¯åŠ¨å®Œæˆï¼Œç›´æ¥å‘èµ·ç›¸åº”çš„è°ƒç”¨ã€‚å®ƒçš„ç›®çš„æ˜¯ï¼Œçœ‹çœ‹ä¸‰ç§è°ƒç”¨æ–¹å¼ï¼Œæ˜¯å¦éƒ½æ­£å¸¸ã€‚å¦‚æœæ²¡æœ‰æŠ¥é”™ï¼Œè¯´æ˜éƒ½æ˜¯ OK çš„ã€‚

```
// DubboSpringCloudBootstrap.java
@GetMapping(value = "/dubbo/call/echo")
public String dubboEcho(@RequestParam("message") String message){
return echoService.echo(message);
}
@GetMapping(value = "/feign/call/echo")
public String feignEcho(@RequestParam("message") String message){
return feignEchoService.echo(message);
}
@GetMapping(value = "/feign-dubbo/call/echo")
public String feignDubboEcho(@RequestParam("message") String message){
return dubboFeignEchoService.echo(message);
}
```

- å£°æ˜äº†ä¸‰ä¸ª Spring MVC HTTP API ï¼Œåˆ†åˆ«è°ƒç”¨ä¸‰ä¸ªä¸åŒçš„æœåŠ¡æ¶ˆè´¹è€…ã€‚
- è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ DubboSpringCloudBootstrap æœ‰

@RestController
æ³¨è§£ï¼Œä¸”é…ç½®æ–‡ä»¶ä¸­é…ç½®äº†

server.port=8080
ã€‚

ğŸ˜ˆ è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæ•´çœ‹è¿‡äº† Spring Cloud Alibaba Dubbo çš„ç¤ºä¾‹ï¼Œå¯ä»¥æ„‰å¿«çš„å¼€å§‹è°ƒè¯•äº†ã€‚

# 3. é¡¹ç›®ç»“æ„ä¸€è§ˆ

æœ¬æ–‡ä¸»è¦åˆ†äº«

spring-cloud-alibaba-dubbo
çš„ **é¡¹ç›®ç»“æ„**ã€‚
å¸Œæœ›é€šè¿‡æœ¬æ–‡èƒ½è®©èƒ–å‹å¯¹

spring-cloud-alibaba-dubbo
çš„æ•´ä½“é¡¹ç›®æœ‰ä¸ªç®€å•çš„äº†è§£ã€‚

![é¡¹ç›®ç»“æ„ä¸€è§ˆ](http://static2.iocoder.cn/images/Dubbo/2018_02_14/02.jpg)

## 3.1 ä»£ç ç»Ÿè®¡

è¿™é‡Œå…ˆåˆ†äº«ä¸€ä¸ªå°æŠ€å·§ã€‚ç¬”è€…åœ¨å¼€å§‹æºç å­¦ä¹ æ—¶ï¼Œä¼šé¦–å…ˆäº†è§£é¡¹ç›®çš„ä»£ç é‡ã€‚

**ç¬¬ä¸€ç§æ–¹å¼**ï¼Œä½¿ç”¨ [IDEA Statistic](https://plugins.jetbrains.com/plugin/4509-statistic) æ’ä»¶ï¼Œç»Ÿè®¡æ•´ä½“ä»£ç é‡ã€‚

![Statistic ç»Ÿè®¡ä»£ç é‡](http://static2.iocoder.cn/images/Dubbo/2018_02_14/03.jpg)

- æˆ‘ä»¬å¯ä»¥ç²—ç•¥çš„çœ‹åˆ°ï¼Œæ•´ä¸ª Spring Cloud Alibaba çš„ä»£ç é‡åœ¨ 16000 è¡Œã€‚è¿™å…¶ä¸­è¿˜åŒ…æ‹¬å•å…ƒæµ‹è¯•ï¼Œç¤ºä¾‹ç­‰ç­‰ä»£ç ã€‚
- /(ã„’ o ã„’)/~~ æ˜¾ç„¶ï¼Œç›®å‰è¿™ä¸ªæ’ä»¶æ²¡åŠæ³•å¾ˆæ–¹ä¾¿çš„ç»Ÿè®¡å‡ºï¼Œæˆ‘ä»¬æƒ³è¦çœ‹åˆ°çš„

spring-cloud-alibaba-dubbo
çš„ä»£ç é‡ã€‚

**ç¬¬äºŒç§æ–¹å¼**ï¼Œä½¿ç”¨ [Shell è„šæœ¬å‘½ä»¤é€ä¸ª Maven æ¨¡å—ç»Ÿè®¡](http://blog.csdn.net/yhhwatl/article/details/52623879) ã€‚

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç¬”è€…ä½¿ç”¨

find . -name "/_.java"|xargs cat|grep -v -e ^$ -e ^\s/_\/\/./\*$|wc -l
ã€‚è¿™ä¸ªå‘½ä»¤åªè¿‡æ»¤äº†**éƒ¨åˆ†æ³¨é‡Š**ï¼Œæ‰€ä»¥ç›¸æ¯” [IDEA Statistic](https://plugins.jetbrains.com/plugin/4509-statistic) ä¼š**åå¤š**ã€‚

å½“ç„¶ï¼Œè€ƒè™‘åˆ°å‡†ç¡®æ€§ï¼Œèƒ–å‹éœ€è¦æ‰‹åŠ¨

cd
åˆ°æ¯ä¸ª Maven é¡¹ç›®çš„

src/main/java
ç›®å½•ä¸‹ï¼Œä»¥è¾¾åˆ°æ’é™¤å•å…ƒæµ‹è¯•çš„ä»£ç é‡ã€‚

![Shell è„šæœ¬ç»Ÿè®¡ä»£ç é‡](http://static2.iocoder.cn/images/Dubbo/2018_02_14/04.jpg)

ç»Ÿè®¡å®Œåï¼Œå‘ç°ä»£ç é‡æ˜¯ä¸å¤šçš„ã€‚

## 3.2

annotation
åŒ…

annotation
åŒ…ï¼Œ62 è¡Œä»£ç ï¼Œæä¾›

@EnableFeignClients
æ³¨è§£ã€‚

## 3.3

autoconfigure
åŒ…

autoconfigure
åŒ…ï¼Œ172 è¡Œä»£ç ï¼Œæä¾› Spring Boot è‡ªåŠ¨é…ç½® Spring Cloud Alibaba Dubbo ã€‚

## 3.4

context
åŒ…

context
åŒ…ï¼Œ35 è¡Œä»£ç ï¼Œç›®å‰ä»…æœ‰ DubboServiceRegistrationApplicationContextInitializer ç±»ï¼Œå…ˆä¸è§£é‡Šå“ˆ~

## 3.5

metadata
åŒ…

metadata
åŒ…ï¼Œ904 è¡Œä»£ç ï¼Œå®ç°å°† Spring Cloud Alibaba Dubbo çš„æœåŠ¡çš„å…ƒæ•°æ®ï¼Œå­˜å‚¨åˆ°é…ç½®ä¸­å¿ƒã€‚è¿™æ ·ï¼Œåç»­ä½¿ç”¨

@DubboTransported
æ³¨è§£çš„ Dubbo è°ƒç”¨æ—¶ï¼Œå› ä¸ºä¼šä½¿ç”¨åˆ° [Dubbo çš„æ³›åŒ–è°ƒç”¨](http://dubbo.apache.org/zh-cn/blog/dubbo-generic-invoke.html) ï¼Œæœ‰äº†æœåŠ¡çš„å…ƒæ•°æ®ï¼Œå°±å¯ä»¥æ„‰å¿«çš„è°ƒç”¨äº†ã€‚

## 3.6

openfeign
åŒ…

openfeign
åŒ…ï¼Œ305 è¡Œä»£ç ï¼Œå®ç°å°† Dubbo é›†æˆåˆ° OpenFeign ä¸­ã€‚

## 3.7

registry
åŒ…

registry
åŒ…ï¼Œ478 è¡Œä»£ç ï¼Œå®ç° Dubbo ä½¿ç”¨ Spring Cloud Service æ³¨å†Œä¸­å¿ƒä½“ç³»ã€‚å¯èƒ½è¿™ä¹ˆè¯´æœ‰ç‚¹æŠ½è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å›è¿‡å¤´çœ‹çœ‹ [ã€Œ2.4.2 application.yamlã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) ä¸­çœ‹åˆ°ï¼Œæœ‰ä¸ªç¥å¥‡çš„

dubbo.protocols.registry.address=spring-cloud://nacos
é…ç½®ã€‚

emm~å“ˆå“ˆå“ˆï¼Œç­‰ä¼šçœ‹å…·ä½“ä»£ç ï¼Œä¼šæ›´åŠ æ˜ç™½ã€‚

# 4.

annotation
åŒ…

## 4.1 @DubboTransported

org.springframework.cloud.alibaba.dubbo.annotation.@DubboTransported
æ³¨è§£ï¼Œè¡¨åè°ƒç”¨æ—¶ï¼Œä½¿ç”¨ Dubbo ä½œä¸ºåº•å±‚ RPC è°ƒç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboTransported.java
//*/*
/* {@link DubboTransported @DubboTransported} annotation indicates that the traditional Spring Cloud Service-to-Service call is transported
/* by Dubbo under the hood, there are two main scenarios:
/* <ol>
/* <li>{@link FeignClient @FeignClient} annotated classes:
/* <ul>
/* If {@link DubboTransported @DubboTransported} annotated classes, the invocation of all methods of
/* {@link FeignClient @FeignClient} annotated classes.
/* </ul>
/* <ul>
/* If {@link DubboTransported @DubboTransported} annotated methods of {@link FeignClient @FeignClient} annotated classes.
/* </ul>
/* </li>
/* <li>{@link LoadBalanced @LoadBalanced} {@link RestTemplate} annotated field, method and parameters</li>
/* </ol>
/* <p>
/*
/* @see FeignClient
/* @see LoadBalanced
/*/
@Retention(RetentionPolicy.RUNTIME)
@Target(value = {ElementType.TYPE, ElementType.FIELD, ElementType.METHOD, ElementType.PARAMETER}) // æ”¯æŒç±»ã€æ–¹æ³•
@Documented
public @interface DubboTransported {
//*/*
/* The protocol of Dubbo transport whose value could be used the placeholder "dubbo.transport.protocol"
/*
/* ä½¿ç”¨çš„ Dubbo åè®®ï¼Œé»˜è®¤ä¸º "dubbo"
/*
/* @return the default protocol is "dubbo"
/*/
String protocol() default "${dubbo.transport.protocol:dubbo}";
//*/*
/* The cluster of Dubbo transport whose value could be used the placeholder "dubbo.transport.cluster"
/*
/* ä½¿ç”¨çš„é›†ç¾¤å®¹é”™æ–¹å¼ï¼Œé»˜è®¤ä¸º "failover"
/*
/* @return the default protocol is "failover"
/*/
String cluster() default "${dubbo.transport.cluster:failover}";
}
```

- protocol
  å±æ€§ï¼Œä½¿ç”¨çš„ Dubbo åè®®ï¼Œé»˜è®¤ä¸º

"dubbo"
ã€‚

- cluster
  å±æ€§ï¼Œä½¿ç”¨ ä½¿ç”¨çš„é›†ç¾¤å®¹é”™æ–¹å¼ï¼Œé»˜è®¤ä¸º

"failover"
ã€‚

- å¯æ ‡è®°åœ¨ç±»æˆ–è€…æ–¹æ³•ä¸Šã€‚

# 5.

autoconfigure
åŒ…

åœ¨

META-INF/spring.factories
æ–‡ä»¶ä¸­ï¼Œå£°æ˜äº†ä¸‰ä¸ªè‡ªåŠ¨é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
org.springframework.boot.autoconfigure.EnableAutoConfiguration=\
org.springframework.cloud.alibaba.dubbo.autoconfigure.DubboMetadataAutoConfiguration,\
org.springframework.cloud.alibaba.dubbo.autoconfigure.DubboOpenFeignAutoConfiguration,\
org.springframework.cloud.alibaba.dubbo.autoconfigure.DubboRestMetadataRegistrationAutoConfiguration
```

- ä¸‹é¢ï¼Œæˆ‘ä»¬é€ä¸ªæ¥ç…ç…ã€‚

## 5.1 DubboMetadataAutoConfiguration

org.springframework.cloud.alibaba.dubbo.autoconfigure.DubboMetadataAutoConfiguration
ï¼ŒDubbo å…ƒæ•°æ®ï¼ˆMetadataï¼‰ç›¸å…³ Bean çš„è‡ªåŠ¨é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboMetadataAutoConfiguration.java
@Configuration
@Import(DubboServiceMetadataRepository.class) // åˆ›å»ºäº† DubboServiceMetadataRepository Bean å¯¹è±¡
public class DubboMetadataAutoConfiguration{
@Bean // åˆ›å»ºäº† NacosMetadataConfigService Bean å¯¹è±¡
@ConditionalOnBean(NacosConfigProperties.class)
public MetadataConfigService metadataConfigService(){
return new NacosMetadataConfigService();
}
}
```

- é€šè¿‡

@Import(DubboServiceMetadataRepository.class)
ï¼Œåˆ›å»ºäº† DubboServiceMetadataRepository å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ7.5 DubboServiceMetadataRepositoryã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) ã€‚

- /#metadataConfigService()
  æ–¹æ³•ï¼Œåˆ›å»ºäº† NacosMetadataConfigService Bean å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ7.4.1 NacosMetadataConfigServiceã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) ã€‚

## 5.2 DubboOpenFeignAutoConfiguration

org.springframework.cloud.alibaba.dubbo.autoconfigure.DubboOpenFeignAutoConfiguration
ï¼ŒDubbo OpenFeign ç›¸å…³ Bean çš„è‡ªåŠ¨é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboOpenFeignAutoConfiguration.java
@ConditionalOnClass(value = Feign.class) // å­˜åœ¨ Feign ç±»çš„æ—¶å€™ï¼Œå³å­˜åœ¨ feign ä¾èµ–
@AutoConfigureAfter(FeignAutoConfiguration.class) // åœ¨ FeignAutoConfiguration é…ç½®ç±»ä¹‹ååˆå§‹åŒ–
@Configuration
public class DubboOpenFeignAutoConfiguration{
@Value("${spring.application.name}")
private String currentApplicationName;
@Bean // åˆ›å»º DubboServiceBeanMetadataResolver å¯¹è±¡
@ConditionalOnMissingBean
public MetadataResolver metadataJsonResolver(ObjectProvider<Contract> contract){
return new DubboServiceBeanMetadataResolver(currentApplicationName, contract);
}
@Bean // åˆ›å»º TargeterBeanPostProcessor å¯¹è±¡
public TargeterBeanPostProcessor targeterBeanPostProcessor(Environment environment,
DubboServiceMetadataRepository dubboServiceMetadataRepository){
return new TargeterBeanPostProcessor(environment, dubboServiceMetadataRepository);
}
}
```

- /#metadataJsonResolver(...)
  æ–¹æ³•ï¼Œåˆ›å»º DubboServiceBeanMetadataResolver Bean å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ7.2 MetadataResolverã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) ã€‚
- /#targeterBeanPostProcessor(...)
  æ–¹æ³•ï¼Œåˆ›å»º TargeterBeanPostProcessor Bean å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ8.1 TargeterBeanPostProcessorã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) ã€‚

## 5.3 DubboRestMetadataRegistrationAutoConfiguration

org.springframework.cloud.alibaba.dubbo.autoconfigure.DubboRestMetadataRegistrationAutoConfiguration
ï¼Œè‡ªåŠ¨é…ç½®ä¸¤ä¸ª Spring äº‹ä»¶ç›‘å¬å™¨ï¼Œå°† Dubbo Rest å…ƒæ•°æ®ï¼ˆMetadataï¼‰æ³¨å†Œåˆ°é…ç½®ä¸­å¿ƒã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboRestMetadataRegistrationAutoConfiguration.java
@ConditionalOnProperty(value = "spring.cloud.service-registry.auto-registration.enabled", matchIfMissing = true) // è¦æ±‚æœ‰ "spring.cloud.service-registry.auto-registration.enabled=true" ï¼Œæˆ–è€…ä¸é…ç½®ã€‚
@ConditionalOnBean(value = { // è¦æ±‚å­˜åœ¨ MetadataResolverã€MetadataConfigService Bean å¯¹è±¡
MetadataResolver.class,
MetadataConfigService.class
})
@AutoConfigureAfter(value = {DubboMetadataAutoConfiguration.class}) // åœ¨ DubboMetadataAutoConfiguration é…ç½®ç±»ä¹‹ååˆå§‹åŒ–
@Configuration
public class DubboRestMetadataRegistrationAutoConfiguration{
//*/*
/* A Map to store REST metadata temporary, its' key is the special service name for a Dubbo service,
/* the value is a JSON content of JAX-RS or Spring MVC REST metadata from the annotated methods.
/*
/* Dubbo Rest Service æ–¹æ³•çš„å…ƒæ•°æ®ï¼ˆMetadataï¼‰é›†åˆ
/*/
private final Set<ServiceRestMetadata> serviceRestMetadata = new LinkedHashSet<>();
@Autowired // é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¥è‡ª DubboOpenFeignAutoConfiguration æ³¨å†Œçš„ DubboServiceBeanMetadataResolver Bean å¯¹è±¡
private MetadataResolver metadataResolver;
@Autowired // é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¥è‡ª DubboMetadataAutoConfiguration æ³¨å†Œçš„ NacosMetadataConfigService Bean å¯¹è±¡
private MetadataConfigService metadataConfigService;
@EventListener(ServiceBeanExportedEvent.class)
public void recordRestMetadata(ServiceBeanExportedEvent event) throws JsonProcessingException{
ServiceBean serviceBean = event.getServiceBean();
serviceRestMetadata.addAll(metadataResolver.resolveServiceRestMetadata(serviceBean));
}
//*/*
/* Pre-handle Spring Cloud application service registered:
/* <p>
/* Put <code>restMetadata</code> with the JSON format into
/* {@link Registration/#getMetadata() service instances' metadata}
/* <p>
/*
/* @param event {@link InstancePreRegisteredEvent} instance
/*/
@EventListener(InstancePreRegisteredEvent.class)
public void registerRestMetadata(InstancePreRegisteredEvent event) throws Exception{
Registration registration = event.getRegistration();
metadataConfigService.publishServiceRestMetadata(registration.getServiceId(), serviceRestMetadata);
}
}
```

- serviceRestMetadata
  å±æ€§ï¼ŒDubbo Rest Service æ–¹æ³•çš„å…ƒæ•°æ®ï¼ˆMetadataï¼‰é›†åˆã€‚
- /#recordRestMetadata(ServiceBeanExportedEvent)
  æ–¹æ³•ï¼Œç›‘å¬ ServiceBeanExportedEvent äº‹ä»¶ã€‚

- åœ¨æ¯ä¸ª Dubbo æœåŠ¡æš´éœ²åï¼Œä¼šå‘å¸ƒ ServiceBeanExportedEvent äº‹ä»¶ã€‚åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ³¨è§£é…ç½®ã€‹](http://www.iocoder.cn/Dubbo/good-collection/) çš„ [ã€Œ5.3.3 onApplicationEventã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) ä¸­ï¼Œæˆ‘ä»¬æœ‰è¿‡è¯¦ç»†è§£æã€‚
- åœ¨æ¥æ”¶åˆ° ServiceBeanExportedEvent äº‹ä»¶ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨

MetadataResolver/#resolveServiceRestMetadata(ServiceBean serviceBean)
æ–¹æ³•ï¼Œè·å¾—è¯¥ ServiceBean çš„ ServiceRestMetadata é›†åˆï¼Œæ·»åŠ åˆ°

serviceRestMetadata
ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ7.5 DubboServiceBeanMetadataResolverã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) ã€‚

- /#registerRestMetadata(InstancePreRegisteredEvent)
  æ–¹æ³•ï¼Œç›‘å¬ InstancePreRegisteredEvent äº‹ä»¶ã€‚

- InstancePreRegisteredEvent äº‹ä»¶ï¼Œåœ¨ Spring Cloud åº”ç”¨æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒä¹‹å‰ï¼Œä¼šè§¦å‘è¯¥äº‹ä»¶ã€‚è¯¦ç»†çš„ï¼Œå¯ä»¥çœ‹çœ‹ [ã€Šspring-cloud-commons referenceã€‹](https://www.jianshu.com/p/a8b255c9feae) æ–‡ç« çš„ [ã€Œ2.2.1 ServiceRegistry Auto-Registrationã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) å°èŠ‚ã€‚ç°åœ¨ï¼Œå¯ä»¥ä¸çœ‹~
- åœ¨æ¥æ”¶åˆ° InstancePreRegisteredEvent äº‹ä»¶ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨

MetadataConfigService/#publishServiceRestMetadata(String serviceName, Set<ServiceRestMetadata> serviceRestMetadata)
æ–¹æ³•ï¼Œå°†æ¯ä¸ª Dubbo æœåŠ¡çš„ ServiceRestMetadata å…ƒæ•°æ®é›†åˆï¼Œå‘å¸ƒï¼ˆå­˜å‚¨ï¼‰åˆ°é…ç½®ä¸­å¿ƒã€‚

- è¿™æ ·ï¼Œåç»­çš„ Dubbo æ³›åŒ–è°ƒç”¨ï¼Œå°±æœ‰ Dubbo æœåŠ¡çš„å…ƒæ•°æ®å’§ã€‚
  å› ä¸ºæœ¬å°èŠ‚è®²çš„éƒ½æ˜¯è‡ªåŠ¨é…ç½®ç±»ï¼Œèƒ–å‹å¯èƒ½ä¼šç•¥æœ‰æ‡µé€¼ã€‚ä¸è¦æ…Œï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹æ’¸ã€‚

å¯¹å’§ï¼Œæœ€å¥½ä¸€è¾¹è°ƒè¯•ï¼Œä¸€è¾¹çœ‹ã€‚

# 6.

context
åŒ…

åœ¨

META-INF/spring.factories
æ–‡ä»¶ä¸­ï¼Œå£°æ˜äº†ä¸‰ä¸ªè‡ªåŠ¨é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
org.springframework.context.ApplicationContextInitializer=\
org.springframework.cloud.alibaba.dubbo.context.DubboServiceRegistrationApplicationContextInitializer
```

## 6.1 DubboServiceRegistrationApplicationContextInitializer

org.springframework.cloud.alibaba.dubbo.context.DubboServiceRegistrationApplicationContextInitializer
ï¼Œå®ç° ApplicationContextInitializer æ¥å£ï¼Œå°†

applicationContext
è®¾ç½®åˆ°

SpringCloudRegistryFactory.applicationContext
é™æ€å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// SpringCloudRegistryFactory.java
//*/*
/* The Dubbo services will be registered as the specified Spring cloud applications that will not be considered
/* normal ones, but only are used to Dubbo's service discovery even if it is based on Spring Cloud Commons abstraction.
/* However, current application will be registered by other DiscoveryClientAutoConfiguration.
/*
/*/
public class DubboServiceRegistrationApplicationContextInitializer implements ApplicationContextInitializer<ConfigurableApplicationContext>{
@Override
public void initialize(ConfigurableApplicationContext applicationContext){
// Set ApplicationContext into SpringCloudRegistryFactory before Dubbo Service Register
SpringCloudRegistryFactory.setApplicationContext(applicationContext);
}
}
```

# 7.

metadata
åŒ…

åœ¨çœ‹å…·ä½“ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆåœ¨ Nacos çš„é…ç½®ä¸­å¿ƒç•Œé¢ï¼Œçœ‹çœ‹ä»€ä¹ˆæ˜¯ Dubbo Metadata ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![Dubbo Metadata](http://static2.iocoder.cn/images/Dubbo/2018_02_14/05.jpg)

å¯èƒ½è¿™æ ·è¿˜æ˜¯ä¸å¤Ÿæ¸…ç†ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª Dubbo Service Metadata æ›´å…·ä½“çš„ç¤ºä¾‹ï¼Œå¦‚ä¸‹ JSON ä¸²ï¼š

```
{
"name" : "providers:dubbo:org.springframework.cloud.alibaba.dubbo.service.EchoService:1.0.0", // dubbo åè®®
"meta" : [ { // ä¸€ä¸ª Dubbo æ–¹æ³•
"method" : { // æ–¹æ³•ä¿¡æ¯
"name" : "echo",
"returnType" : "java.lang.String",
"params" : [ {
"index" : 0,
"name" : "message",
"type" : "java.lang.String"
} ]
},
"request" : { // è¯·æ±‚ä¿¡æ¯
"method" : "GET",
"url" : "/echo",
"queries" : {
"message" : [ "{message}" ]
},
"headers" : { }
},
"indexToName" : {
"0" : [ "message" ]
}
}, { // ä¸€ä¸ª Dubbo æ–¹æ³•
"method" : { // æ–¹æ³•ä¿¡æ¯
"name" : "plus",
"returnType" : "java.lang.String",
"params" : [ {
"index" : 0,
"name" : "a",
"type" : "int"
}, {
"index" : 1,
"name" : "b",
"type" : "int"
} ]
},
"request" : { // è¯·æ±‚ä¿¡æ¯
"method" : "POST",
"url" : "/plus",
"queries" : {
"a" : [ "{a}" ],
"b" : [ "{b}" ]
},
"headers" : { }
},
"indexToName" : {
"0" : [ "a" ],
"1" : [ "b" ]
}
} ]
}
```

/\*

## 7.1 Metadata ç±»

åœ¨

metadata
åŒ…çš„æ ¹ç›®å½•ï¼Œä¸€å…±æœ‰ 6 ä¸ª Metadata ç±»ã€‚å¦‚ä¸‹ï¼š

- ServiceRestMetadata
- RestMethodMetadata
- MethodMetadata
- MethodParameterMetadata
- RequestMetadata
- DubboTransportedMethodMetadata

### 7.1.1 ServiceRestMetadata

org.springframework.cloud.alibaba.dubbo.metadata.ServiceRestMetadata
ï¼ŒService Rest Metadata ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ServiceRestMetadata.java
public class ServiceRestMetadata{
//*/*
/* æœåŠ¡å
/*/
private String name;
//*/*
/* Rest æ–¹æ³•å…ƒæ•°æ®
/*/
private Set<RestMethodMetadata> meta;
// ... çœç•¥ setting/getting æ–¹æ³•
}
```

### 7.1.2 RestMethodMetadata

org.springframework.cloud.alibaba.dubbo.metadata.RestMethodMetadata
ï¼ŒRest Method Metadata ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// RestMethodMetadata.java
public class RestMethodMetadata{
//*/*
/* æ–¹æ³•å…ƒæ•°æ®
/*/
private MethodMetadata method;
//*/*
/* è¯·æ±‚å…ƒæ•°æ®
/*/
private RequestMetadata request;
//*/*
/* TODO
/*/
private Map<Integer, Collection<String>> indexToName;
// ... çœç•¥ setting/getting æ–¹æ³•
}
```

### 7.1.2.1 MethodMetadata

org.springframework.cloud.alibaba.dubbo.metadata.MethodMetadata
ï¼ŒMethod Metadata ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ServiceRestMetadata.java
public class MethodMetadata{
//*/*
/* æ–¹æ³•å
/*/
private String name;
//*/*
/* è¿”å›ç±»å‹
/*/
private String returnType;
//*/*
/* æ–¹æ³•å‚æ•°å…ƒæ•°æ®çš„æ•°ç»„
/*/
private List<MethodParameterMetadata> params;
//*/*
/* æ–¹æ³•
/*/
@JsonIgnore // ä¸å­˜å‚¨åˆ°é…ç½®ä¸­å¿ƒ
private Method method;
public MethodMetadata(){
this.params = new LinkedList<>();
}
public MethodMetadata(Method method){
this.name = method.getName();
// è·å¾—è¿”å›ç±»å‹
this.returnType = ClassUtils.getName(method.getReturnType());
// åˆå§‹åŒ– params
this.params = initParameters(method);
this.method = method;
}
private List<MethodParameterMetadata> initParameters(Method method){
// è·å¾—å‚æ•°æ•°é‡
int parameterCount = method.getParameterCount();
// å¦‚æœå‚æ•°ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›ç©ºæ•°ç»„
if (parameterCount < 1) {
return Collections.emptyList();
}
// åˆ›å»º MethodParameterMetadata æ•°ç»„
List<MethodParameterMetadata> params = new ArrayList<>(parameterCount);
Parameter[] parameters = method.getParameters();
for (int i = 0; i < parameterCount; i++) {
// è·å¾— Parameter å¯¹è±¡
Parameter parameter = parameters[i];
// è½¬æ¢æˆ MethodParameterMetadata å¯¹è±¡
MethodParameterMetadata param = toMethodParameterMetadata(i, parameter);
// æ·»åŠ åˆ° params ä¸­
params.add(param);
}
return params;
}
private MethodParameterMetadata toMethodParameterMetadata(int index, Parameter parameter){
// åˆ›å»º MethodParameterMetadata å¯¹è±¡
MethodParameterMetadata metadata = new MethodParameterMetadata();
metadata.setIndex(index); // æ–¹æ³•å‚æ•°çš„ä½ç½®
metadata.setName(parameter.getName()); // æ–¹æ³•å‚æ•°çš„åå­—
metadata.setType(parameter.getType().getTypeName()); // æ–¹æ³•å‚æ•°çš„ç±»å‹
return metadata;
}
// ... çœç•¥ setting/getting æ–¹æ³•
}
```

### 7.1.2.1.1 MethodParameterMetadata

org.springframework.cloud.alibaba.dubbo.metadata.MethodParameterMetadata
ï¼ŒMethod Parameter Metadata ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// MethodParameterMetadata.java
public class MethodParameterMetadata{
//*/*
/* æ–¹æ³•å‚æ•°çš„ä½ç½®
/*/
private int index;
//*/*
/* æ–¹æ³•å‚æ•°çš„åå­—
/*/
private String name;
//*/*
/* æ–¹æ³•å‚æ•°çš„ç±»å‹
/*/
private String type;
// ... çœç•¥ setting/getting æ–¹æ³•
}
```

### 7.1.2.2 RequestMetadata

org.springframework.cloud.alibaba.dubbo.metadata.RequestMetadata
ï¼ŒRequest Metadata ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// RequestMetadata.java
public class RequestMetadata{
//*/*
/* æ–¹æ³•å
/*/
private String method;
//*/*
/* URL è·¯å¾„
/*/
private String url;
private Map<String, Collection<String>> queries;
private Map<String, Collection<String>> headers;
public RequestMetadata(){
}
// å°† RequestTemplate å¯¹è±¡ï¼Œè½¬æ¢æˆ RequestMetadata å¯¹è±¡
public RequestMetadata(RequestTemplate requestTemplate){
this.method = requestTemplate.method();
this.url = requestTemplate.url();
this.queries = requestTemplate.queries();
this.headers = requestTemplate.headers();
}
// ... çœç•¥ setting/getting æ–¹æ³•
}
```

### 7.1.2.3 DubboTransportedMethodMetadata

org.springframework.cloud.alibaba.dubbo.metadata.DubboTransportedMethodMetadata
ï¼Œç»§æ‰¿ MethodMetadata ç±»ï¼Œ

@DubboTransported
æ³¨è§£å¯¹åº”çš„ MethodMetadata å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboTransportedMethodMetadata.java
public class DubboTransportedMethodMetadata extends MethodMetadata{
//*/*
/* Dubbo åè®®
/*/
private String protocol;
//*/*
/* Dubbo å®¹é”™ç­–ç•¥
/*/
private String cluster;
// ... çœç•¥ setting/getting æ–¹æ³•
}
```

## 7.2 MetadataResolver

org.springframework.cloud.alibaba.dubbo.metadata.resolver.MetadataResolver
ï¼ŒMetadata Resolver å…ƒæ•°æ®è§£æå™¨æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// MetadataResolver.java
//*/*
/* The REST metadata resolver
/*/
public interface MetadataResolver{
//*/*
/* Resolve the {@link ServiceRestMetadata} {@link Set set} from {@link ServiceBean}
/*
/* è§£ææŒ‡å®š ServiceBean çš„ ServiceRestMetadata é›†åˆ
/*
/* @param serviceBean {@link ServiceBean}
/* @return non-null {@link Set}
/*/
Set<ServiceRestMetadata> resolveServiceRestMetadata(ServiceBean serviceBean);
//*/*
/* Resolve {@link RestMethodMetadata} {@link Set set} from {@link Class target type}
/*
/* è§£ææŒ‡å®šç±»çš„ ServiceRestMetadata é›†åˆ
/*
/* @param targetType {@link Class target type}
/* @return non-null {@link Set}
/*/
Set<RestMethodMetadata> resolveMethodRestMetadata(Class<?> targetType);
}
```

### 7.2.1 DubboServiceBeanMetadataResolver

DubboServiceBeanMetadataResolver Bean å¯¹è±¡ï¼Œåœ¨ [ã€Œ5.2 DubboOpenFeignAutoConfigurationã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) ä¸­è¢«åˆ›å»ºã€‚

org.springframework.cloud.alibaba.dubbo.metadata.resolver.DubboServiceBeanMetadataResolver
ï¼Œå®ç° MetadataResolverã€BeanClassLoaderAwareã€SmartInitializingSingleton æ¥å£ï¼ŒåŸºäº Dubbo ServiceBean çš„ MetadataResolver å®ç°ç±»ã€‚

```
// DubboServiceBeanMetadataResolver.java
//*/*
/* The metadata resolver for {@link Feign} for {@link ServiceBean Dubbo Service Bean} in the provider side.
/*/
```

### 7.2.1.1 æ„é€ æ–¹æ³•

```
// DubboServiceBeanMetadataResolver.java
private static final String[] CONTRACT_CLASS_NAMES = {
"feign.jaxrs2.JAXRS2Contract",
"org.springframework.cloud.openfeign.support.SpringMvcContract",
};
//*/*
/* å½“å‰åº”ç”¨å
/*
/* ä¸è¿‡ï¼Œç›®å‰æš‚æ—¶å¹¶æœªç”¨è¯¥å‚æ•°
/*/
private final String currentApplicationName;
//*/*
/* å½“å‰ç±»åŠ è½½å™¨
/*/
private ClassLoader classLoader;
private final ObjectProvider<Contract> contract;
//*/*
/* Feign Contract æ•°ç»„
/*
/* https://www.jianshu.com/p/6582f8319f72
/*/
private Collection<Contract> contracts;
public DubboServiceBeanMetadataResolver(String currentApplicationName, ObjectProvider<Contract> contract){
this.currentApplicationName = currentApplicationName;
this.contract = contract;
}
```

- å…·ä½“çš„æ¯ä¸ªå±æ€§ï¼Œæˆ‘ä»¬ä¸‹é¢ä¸€ä¸ªä¸€ä¸ªæ¥çœ‹ã€‚

### 7.2.1.2 afterSingletonsInstantiated

å®ç°

/#afterSingletonsInstantiated()
æ–¹æ³•ï¼Œåˆå§‹åŒ–

contracts
å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboServiceBeanMetadataResolver.java
@Override
public void afterSingletonsInstantiated(){
// <1> åˆ›å»º Feign Contract æ•°ç»„
LinkedList<Contract> contracts = new LinkedList<>();
// Add injected Contract if available, for example SpringMvcContract Bean under Spring Cloud Open Feign
// <2.1> å¦‚æœ contract å­˜åœ¨ï¼Œåˆ™æ·»åŠ åˆ° contracts ä¸­
contract.ifAvailable(contracts::add);
// <2.2> éå† CONTRACT_CLASS_NAMES æ•°ç»„ï¼Œåˆ›å»ºå¯¹åº”çš„ Contract å¯¹è±¡ï¼Œæ·»åŠ åˆ° contracts ä¸­
Stream.of(CONTRACT_CLASS_NAMES)
.filter(this::isClassPresent) // filter the existed classes
.map(this::loadContractClass) // load Contract Class
.map(this::createContract) // create instance by the specified class
.forEach(contracts::add); // add the Contract instance into contracts
// <3> èµ‹å€¼ç»™ contracts ä¸­
this.contracts = Collections.unmodifiableCollection(contracts);
}
```

- <1>
  å¤„ï¼Œåˆ›å»º Feign Contract æ•°ç»„

contracts
ã€‚

- <2.1>
  å¤„ï¼Œå¦‚æœ

contract
å­˜åœ¨ï¼Œåˆ™æ·»åŠ åˆ°

contracts
ä¸­ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ

contract
ä¸å­˜åœ¨ï¼Œæ‰€ä»¥å¯ä»¥æš‚æ—¶æ— è§†ã€‚

- <2.2>
  å¤„ï¼Œéå†

CONTRACT_CLASS_NAMES
æ•°ç»„ï¼Œåˆ›å»ºå¯¹åº”çš„ Contract å¯¹è±¡ï¼Œæ·»åŠ åˆ°

contracts
ä¸­ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œéƒ½ä¼šå­˜åœ¨ã€‚æ¶‰åŠä»£ç å¦‚ä¸‹ï¼š

```
// DubboServiceBeanMetadataResolver.java
// åˆ¤æ–­æŒ‡å®š className ç±»æ˜¯å¦å­˜åœ¨
private boolean isClassPresent(String className){
return ClassUtils.isPresent(className, classLoader);
}
// åŠ è½½ contractClassName å¯¹åº”çš„ Contract å®ç°ç±»
private Class<?> loadContractClass(String contractClassName) {
return ClassUtils.resolveClassName(contractClassName, classLoader);
}
// åˆ›å»º Contract å¯¹è±¡
private Contract createContract(Class<?> contractClassName){
return (Contract) BeanUtils.instantiateClass(contractClassName);
}
```

- <3>
  å¤„ï¼Œèµ‹å€¼ç»™

this.contracts
ä¸­ã€‚

### 7.2.1.3 resolveMethodRestMetadata

å®ç°

/#resolveMethodRestMetadata(Class<?> targetType)
æ–¹æ³•ï¼Œè§£ææŒ‡å®šç±»çš„ ServiceRestMetadata é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboServiceBeanMetadataResolver.java
@Override
public Set<RestMethodMetadata> resolveMethodRestMetadata(Class<?> targetType){
// <1> è·å¾— Method é›†åˆ
List<Method> feignContractMethods = selectFeignContractMethods(targetType);
// <2> è½¬æ¢æˆ RestMethodMetadata é›†åˆ
return contracts.stream() // éå† contracts æ•°ç»„
.map(contract -> contract.parseAndValidatateMetadata(targetType)) // <2.1> è¿”å›ç›®æ ‡ç±»å‹çš„ Feign MethodMetadata æ•°ç»„
.flatMap(Collection::stream)
.map(methodMetadata -> resolveMethodRestMetadata(methodMetadata, targetType, feignContractMethods)) // <2.2> å°† Feign MethodMetadata è½¬æ¢æˆ RestMethodMetadata å¯¹è±¡
.collect(Collectors.toSet()); // è½¬æ¢æˆ Set
}
```

- <1>
  å¤„ï¼Œè°ƒç”¨

/#selectFeignContractMethods(Class<?> targetType)
æ–¹æ³•ï¼Œè·å¾— Method é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboServiceBeanMetadataResolver.java
//*/*
/* Select feign contract methods
/* <p>
/* extract some code from {@link Contract.BaseContract/#parseAndValidatateMetadata(java.lang.Class)}
/*
/* @param targetType
/* @return non-null
/*/
private List<Method> selectFeignContractMethods(Class<?> targetType){
List<Method> methods = new LinkedList<>();
// éå†ç›®æ ‡çš„æ–¹æ³•
for (Method method : targetType.getMethods()) {
// å¿½ç•¥
if (method.getDeclaringClass() == Object.class || // Object å£°æ˜çš„æ–¹æ³•ï¼Œä¾‹å¦‚è¯´ equals æ–¹æ³•
(method.getModifiers() & Modifier.STATIC) != 0 || // é™æ€æ–¹æ³•
Util.isDefault(method)) { // Feign é»˜è®¤æ–¹æ³•
continue;
}
methods.add(method);
}
return methods;
}
```

- <2>
  å¤„ï¼Œè½¬æ¢æˆ RestMethodMetadata é›†åˆã€‚
- <2.1>
  å¤„ï¼Œè°ƒç”¨

Contract/#parseAndValidatateMetadata()
æ–¹æ³•ï¼Œè¿”å›ç›®æ ‡ç±»å‹çš„ Feign MethodMetadata æ•°ç»„ã€‚è¿™å—ä»£ç å±äº Feign çš„ï¼Œæˆ‘ä»¬å…ˆä¸ç»†è°ƒï¼Œçœ‹ä¸€ä¸ªç»“æœçš„ç¤ºä¾‹ã€‚å¦‚ä¸‹å›¾ï¼š![ç»“æœ](http://static2.iocoder.cn/images/Dubbo/2018_02_14/06.jpg)

- è¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œå› ä¸º

CONTRACT_CLASS_NAMES
ä¸­ï¼Œå³æœ‰ JAXRS2Contract ç±»ï¼Œåˆæœ‰ SpringMvcContract ç±»ï¼Œæ‰€ä»¥è¦æ±‚æ·»åŠ  JSR311 çš„æ³¨è§£ï¼Œä¹Ÿè¦æ·»åŠ  Spring MVC çš„æ³¨è§£ã€‚ä¸¾ä¸ªä¾‹å­ï¼š

```
// DefaultEchoService.java
@Service(version = "1.0.0", protocol = {"dubbo", "rest"})
@RestController // Spring MVC æ³¨è§£
@Path("/") // JSR311 æ³¨è§£
public class DefaultEchoService implements EchoService{
@Override
@GetMapping(value = "/echo"
// consumes = MediaType.APPLICATION_JSON_VALUE,
// produces = MediaType.APPLICATION_JSON_UTF8_VALUE
) // Spring MVC æ³¨è§£
@Path("/echo") // JSR311 æ³¨è§£
@GET // JSR311 æ³¨è§£
// @Consumes("application/json")
// @Produces("application/json;charset=UTF-8")
public String echo(@RequestParam // Spring MVC æ³¨è§£
@QueryParam("message") String message){ // JSR311 æ³¨è§£
System.out.println(message);
return RpcContext.getContext().getUrl() + " [echo] : " + message;
}
}
```

- ä¸è¿‡è‰¿è‰¿æš‚æ—¶ä¸å¤ªç†è§£ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ã€‚æœ‰çŸ¥é“çš„èƒ–å‹ï¼Œéº»çƒ¦æ•™è‚²ä¸‹ï¼Œå˜»å˜»~
- <2.2>
  å¤„ï¼Œè°ƒç”¨

/#resolveMethodRestMetadata(MethodMetadata methodMetadata, Class<?> targetType, List<Method> feignContractMethods)
æ–¹æ³•ï¼Œå°† Feign MethodMetadata è½¬æ¢æˆ RestMethodMetadata å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboServiceBeanMetadataResolver.java
protected RestMethodMetadata resolveMethodRestMetadata(MethodMetadata methodMetadata, // Feign MethodMetadata
Class<?> targetType,
List<Method> feignContractMethods){
// è·å¾— configKey ã€‚ä¾‹å¦‚è¯´ï¼šDefaultEchoService/#echo(String)
String configKey = methodMetadata.configKey();
// è·å¾—åŒ¹é…çš„ Method
Method feignContractMethod = getMatchedFeignContractMethod(targetType, feignContractMethods, configKey);
// åˆ›å»º RestMethodMetadata å¯¹è±¡ï¼Œå¹¶è®¾ç½®å…¶å±æ€§
RestMethodMetadata metadata = new RestMethodMetadata();
metadata.setRequest(new RequestMetadata(methodMetadata.template()));
metadata.setMethod(new org.springframework.cloud.alibaba.dubbo.metadata.MethodMetadata(feignContractMethod));
metadata.setIndexToName(methodMetadata.indexToName());
return metadata;
}
private Method getMatchedFeignContractMethod(Class<?> targetType, List<Method> methods, String expectedConfigKey){
Method matchedMethod = null;
// éå† Method é›†åˆ
for (Method method : methods) {
// è·å¾—è¯¥æ–¹æ³•çš„ configKey
String configKey = Feign.configKey(targetType, method);
// å¦‚æœç›¸ç­‰ï¼Œåˆ™è¿›è¡Œè¿”å›ã€‚
if (expectedConfigKey.equals(configKey)) {
matchedMethod = method;
break;
}
}
return matchedMethod;
}
```

- å¯¹è±¡è½¬æ¢çš„ä»£ç ï¼Œç®€å•ç…ç…å³å¯æ˜ç™½ã€‚

### 7.2.1.4 resolveServiceRestMetadata

å®ç°

/#resolveServiceRestMetadata(ServiceBean serviceBean)
æ–¹æ³•ï¼Œè§£ææŒ‡å®š ServiceBean çš„ ServiceRestMetadata é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboServiceBeanMetadataResolver.java
@Override
public Set<ServiceRestMetadata> resolveServiceRestMetadata(ServiceBean serviceBean){
// <1.1> è·å¾—åº”ç”¨çš„ Bean å¯¹è±¡
Object bean = serviceBean.getRef();
// <1.2> è·å¾— Bean ç±»å‹
Class<?> beanType = bean.getClass();
// <1.3> è§£æ Bean ç±»å‹å¯¹åº”çš„ RestMethodMetadata é›†åˆ
Set<RestMethodMetadata> methodRestMetadata = resolveMethodRestMetadata(beanType);
// <2.1> åˆ›å»º ServiceRestMetadata æ•°ç»„
Set<ServiceRestMetadata> serviceRestMetadata = new LinkedHashSet<>();
// <2.2> è·å¾— ServiceBean æš´éœ²çš„ URL é›†åˆ
List<URL> urls = serviceBean.getExportedUrls();
// <2.3> éå† URL é›†åˆï¼Œå°† RestMethodMetadata é›†åˆï¼Œå°è£…æˆ ServiceRestMetadata å¯¹è±¡ï¼Œç„¶åæ·»åŠ åˆ° serviceRestMetadata ä¸­ï¼Œæœ€åè¿”å›ã€‚
urls.stream()
.map(SpringCloudRegistry::getServiceName)
.forEach(serviceName -> {
ServiceRestMetadata metadata = new ServiceRestMetadata();
metadata.setName(serviceName);
metadata.setMeta(methodRestMetadata);
serviceRestMetadata.add(metadata);
});
return serviceRestMetadata;
}
```

- <1.3>
  å¤„ï¼Œè°ƒç”¨

/#resolveMethodRestMetadata(Class<?> targetType)
æ–¹æ³•ï¼Œè§£æ Bean ç±»å‹å¯¹åº”çš„ RestMethodMetadata é›†åˆã€‚å³ï¼Œæˆ‘ä»¬åœ¨ [ã€Œ7.2.1.3 resolveMethodRestMetadataã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) è§£æçš„æ–¹æ³•ã€‚

- <2.1>
  å¤„ï¼Œè·å¾— ServiceBean æš´éœ²çš„ URL é›†åˆã€‚ä¾‹å¦‚è¯´ï¼Œæœ¬æ–‡çš„ DefaultEchoService ç¤ºä¾‹ï¼Œå°±æš´éœ²äº†

dubbo://
å’Œ

rest://
ä¸¤ç§åè®®çš„ URL ã€‚

- <2.3>
  å¤„ï¼Œéå† URL é›†åˆï¼Œå°† RestMethodMetadata é›†åˆï¼Œå°è£…æˆ ServiceRestMetadata å¯¹è±¡ï¼Œç„¶åæ·»åŠ åˆ° serviceRestMetadata ä¸­ï¼Œæœ€åè¿”å›ã€‚æ­¤å¤„çš„

SpringCloudRegistry::getServiceName
ä»£ç æ®µï¼Œå°±æ˜¯è°ƒç”¨

SpringCloudRegistry/#getServiceName(URL url)
æ–¹æ³•ï¼Œè·å¾— Dubbo æœåŠ¡åã€‚ä¾‹å¦‚è¯´ï¼š

providers:dubbo:org.springframework.cloud.alibaba.dubbo.service.EchoService:1.0.0
ã€‚

è‡³æ­¤ï¼ŒDubbo Service å…ƒæ•°æ®çš„è§£æï¼Œå°±å·²ç»å®Œæˆäº†ã€‚åç»­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¸¤ä¸ªæ–¹é¢çš„å†…å®¹ï¼š

- 1ã€å°†å…ƒæ•°æ®å­˜å‚¨åˆ°é…ç½®ä¸­å¿ƒã€‚è¿™æ ·ï¼ŒæœåŠ¡æ¶ˆè´¹è€…æ‰èƒ½å…±äº«åˆ°è¯¥éƒ¨åˆ†çš„æ•°æ®ã€‚
- 2ã€æœåŠ¡æ¶ˆè´¹è€…åŸºäº Dubbo Service å…ƒæ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ Dubbo å‘èµ·æ³›åŒ–è°ƒç”¨ã€‚

å½“ç„¶ï¼Œå¦‚æœä¸ä½¿ç”¨ Dubbo å‘èµ·æ³›åŒ–è°ƒç”¨ï¼Œæ˜¯ä¸éœ€è¦è¿™éƒ¨åˆ† Dubbo Service å…ƒæ•°æ®çš„ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿèƒ–å‹å¥½å¥½æ€è€ƒä¸€æ³¢~

## 7.3 DubboTransportedMethodMetadataResolver

org.springframework.cloud.alibaba.dubbo.metadata.resolver.DubboTransportedMethodMetadataResolver
ï¼Œè§£æ

@DubboTransported
æ³¨è§£çš„ MethodMetadata æ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboTransportedMethodMetadataResolver.java
public Map<DubboTransportedMethodMetadata, RequestMetadata> resolve(Class<?> targetType){
// <1> è·å¾—æŒ‡å®šç±»çš„ DubboTransportedMethodMetadata é›†åˆ
Set<DubboTransportedMethodMetadata> dubboTransportedMethodMetadataSet = resolveDubboTransportedMethodMetadataSet(targetType);
// <2> è·å¾—æŒ‡å®šç±»çš„ RequestMetadata æ˜ å°„ã€‚å…¶ä¸­ï¼ŒKEY ä¸º configKey
Map<String, RequestMetadata> requestMetadataMap = resolveRequestMetadataMap(targetType);
// <3> è½¬æ¢æˆ DubboTransportedMethodMetadata å’Œ RequestMetadata çš„æ˜ å°„
return dubboTransportedMethodMetadataSet
.stream()
.collect(Collectors.toMap(methodMetadata -> methodMetadata, methodMetadata ->
requestMetadataMap.get(Feign.configKey(targetType, methodMetadata.getMethod()))
));
}
```

- <1>
  å¤„ï¼Œè°ƒç”¨

/#resolveDubboTransportedMethodMetadataSet(Class<?> targetType)
æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šç±»çš„ DubboTransportedMethodMetadata é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboTransportedMethodMetadataResolver.java
protected Set<DubboTransportedMethodMetadata> resolveDubboTransportedMethodMetadataSet(Class<?> targetType){
// The public methods of target interface
Method[] methods = targetType.getMethods();
// åˆ›å»º DubboTransportedMethodMetadata æ•°ç»„
Set<DubboTransportedMethodMetadata> methodMetadataSet = new LinkedHashSet<>();
// éå†æ–¹æ³•
for (Method method : methods) {
// å¦‚æœæœ‰ @DubboTransported æ³¨è§£
DubboTransported dubboTransported = resolveDubboTransported(method); // â‘ 
// å¦‚æœæœ‰ï¼Œåˆ™åˆ›å»ºæˆ DubboTransportedMethodMetadata å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ° methodMetadataSet ä¸­
if (dubboTransported != null) {
// åˆ›å»º â‘¡
DubboTransportedMethodMetadata methodMetadata = createDubboTransportedMethodMetadata(method, dubboTransported);
// æ·»åŠ 
methodMetadataSet.add(methodMetadata);
}
}
return methodMetadataSet;
}
// â‘ 
private DubboTransported resolveDubboTransported(Method method){
// å…ˆä»æ–¹æ³•ä¸Šï¼Œè·å¾— @DubboTransported æ³¨è§£
DubboTransported dubboTransported = AnnotationUtils.findAnnotation(method, DUBBO_TRANSPORTED_CLASS);
// å¦‚æœè·å¾—ä¸åˆ°ï¼Œåˆ™ä»ç±»ä¸Šï¼Œè·å¾— @DubboTransported æ³¨è§£
if (dubboTransported == null) { // Attempt to find @DubboTransported in the declaring class
Class<?> declaringClass = method.getDeclaringClass();
dubboTransported = AnnotationUtils.findAnnotation(declaringClass, DUBBO_TRANSPORTED_CLASS);
}
return dubboTransported;
}
// â‘¡
private DubboTransportedMethodMetadata createDubboTransportedMethodMetadata(Method method, DubboTransported dubboTransported){
// åˆ›å»º DubboTransportedMethodMetadata å¯¹è±¡
DubboTransportedMethodMetadata methodMetadata = new DubboTransportedMethodMetadata(method);
// è§£æå±æ€§ï¼Œå¹¶è®¾ç½®åˆ° methodMetadata ä¸­
String protocol = propertyResolver.resolvePlaceholders(dubboTransported.protocol());
String cluster = propertyResolver.resolvePlaceholders(dubboTransported.cluster());
methodMetadata.setProtocol(protocol);
methodMetadata.setCluster(cluster);
return methodMetadata;
}
```

- <2>
  å¤„ï¼Œè°ƒç”¨

/#resolveRequestMetadataMap(Class<?> targetType)
æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šç±»çš„ RequestMetadata æ˜ å°„ã€‚å…¶ä¸­ï¼ŒKEY ä¸º

configKey
ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboTransportedMethodMetadataResolver.java
private Map<String, RequestMetadata> resolveRequestMetadataMap(Class<?> targetType){
return contract.parseAndValidatateMetadata(targetType) // è·å¾—æŒ‡å®šç±»çš„ Feign MethodMetadata é›†åˆ
.stream().collect(Collectors.toMap(feign.MethodMetadata::configKey, this::requestMetadata)); // åˆ›å»º RequestMetadata å¯¹è±¡
}
private RequestMetadata requestMetadata(feign.MethodMetadata methodMetadata){
return new RequestMetadata(methodMetadata.template());
}
```

- <3>
  å¤„ï¼Œè½¬æ¢æˆ DubboTransportedMethodMetadata å’Œ RequestMetadata çš„æ˜ å°„ã€‚

åç»­ï¼Œè¿™ä¸ªç±»ä¼šè¢« [ã€Œ8.1 TargeterInvocationHandlerã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) æ‰€è°ƒç”¨ ã€‚

## 7.4 MetadataConfigService

ç»™æœåŠ¡æä¾›è€…ä½¿ç”¨ã€‚

org.springframework.cloud.alibaba.dubbo.metadata.service.MetadataConfigService
ï¼Œå…ƒæ•°æ®é…ç½®æœåŠ¡æ¥å£ï¼Œå³å¯ä»¥ä»é…ç½®ä¸­å¿ƒï¼Œè¯»å–å’Œå†™å…¥å…ƒæ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// MetadataConfigService.java
public interface MetadataConfigService{
//*/*
/* å‘å¸ƒæŒ‡å®šæœåŠ¡çš„ Rest å…ƒæ•°æ®
/*
/* @param serviceName æœåŠ¡å
/* @param serviceRestMetadata ServiceRestMetadata é›†åˆ
/*/
void publishServiceRestMetadata(String serviceName, Set<ServiceRestMetadata> serviceRestMetadata);
//*/*
/* è·å¾—æŒ‡å®šæœåŠ¡çš„ Rest å…ƒæ•°æ®
/*
/* @param serviceName æœåŠ¡å
/* @return ServiceRestMetadata é›†åˆ
/*/
Set<ServiceRestMetadata> getServiceRestMetadata(String serviceName);
}
```

### 7.4.1 NacosMetadataConfigService

org.springframework.cloud.alibaba.dubbo.metadata.service.NacosMetadataConfigService
ï¼Œå®ç° MetadataConfigService æ¥å£ï¼ŒåŸºäº Nacos ä½œä¸ºé…ç½®ä¸­å¿ƒçš„å®ç°ç±»ã€‚

### 7.4.1.1 æ„é€ æ–¹æ³•

```
// NacosMetadataConfigService.java
//*/*
/* ObjectMapper ï¼Œä½¿ç”¨ Jackson åºåˆ—åŒ–å’Œååºåˆ—åŒ–
/*/
private final ObjectMapper objectMapper = new ObjectMapper();
//*/*
/* NacosConfigProperties å¯¹è±¡ï¼Œç”¨äºè·å¾— {@link /#configService}
/*/
@Autowired
private NacosConfigProperties nacosConfigProperties;
private ConfigService configService;
@PostConstruct
public void init(){
// åˆå§‹åŒ– configService å±æ€§
this.configService = nacosConfigProperties.configServiceInstance();
// å¼€å¯ JSON æ ¼å¼åŒ–
this.objectMapper.enable(SerializationFeature.INDENT_OUTPUT);
}
```

### 7.4.1.2 publishServiceRestMetadata

å®ç°

/#publishServiceRestMetadata(String serviceName, Set<ServiceRestMetadata> serviceRestMetadata)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
// NacosMetadataConfigService.java
@Override
public void publishServiceRestMetadata(String serviceName, Set<ServiceRestMetadata> serviceRestMetadata){
// è·å¾— Nacos dataId â‘ 
String dataId = getServiceRestMetadataDataId(serviceName);
// å°† ServiceRestMetadata é›†åˆåºåˆ—åŒ–æˆ json å­—ç¬¦ä¸² â‘¡
String json = writeValueAsString(serviceRestMetadata);
// å†™å…¥åˆ° Nacos é…ç½®ä¸­å¿ƒ
try {
configService.publishConfig(dataId, DEFAULT_GROUP, json);
} catch (NacosException e) {
throw new RuntimeException(e);
}
}
//*/*
/* Get the data Id of service rest metadata
/*/
private static String getServiceRestMetadataDataId(String serviceName){ // â‘ 
return "metadata:rest:" + serviceName + ".json";
}
private String writeValueAsString(Object object){ // â‘¡
String content;
try {
content = objectMapper.writeValueAsString(object);
} catch (JsonProcessingException e) {
throw new IllegalArgumentException(e);
}
return content;
}
```

### 7.4.1.3 getServiceRestMetadata

å®ç°

/#getServiceRestMetadata(String serviceName)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
// NacosMetadataConfigService.java
@Override
public Set<ServiceRestMetadata> getServiceRestMetadata(String serviceName){
Set<ServiceRestMetadata> metadata;
// è·å¾— Nacos dataId
String dataId = getServiceRestMetadataDataId(serviceName);
try {
// ä» Nacos é…ç½®ä¸­å¿ƒï¼Œè¯»å– json å­—ç¬¦ä¸²
String json = configService.getConfig(dataId, DEFAULT_GROUP, 1000 /* 3);
// å°† json å­—ç¬¦ä¸²ï¼Œååºåˆ—åŒ–æˆ ServiceRestMetadata é›†åˆ
metadata = objectMapper.readValue(json, TypeFactory.defaultInstance().constructCollectionType(LinkedHashSet.class, ServiceRestMetadata.class));
} catch (Exception e) {
throw new RuntimeException(e);
}
return metadata;
}
```

## 7.5 DubboServiceMetadataRepository

ç»™æœåŠ¡æ¶ˆè´¹è€…ä½¿ç”¨ã€‚

org.springframework.cloud.alibaba.dubbo.metadata.repository.DubboServiceMetadataRepository
ï¼ŒDubbo Service Metadata ä»“åº“ã€‚é€šè¿‡è¯¥ç±»ï¼ŒæœåŠ¡æ¶ˆè´¹è€…å°±å¯ä»¥è·å¾—æ¯ä¸ªå¯¹åº” Dubbo æœåŠ¡çš„ ReferenceBean å¯¹è±¡~

### 7.5.1 æ„é€ æ–¹æ³•

```
// DubboServiceMetadataRepository.java
//*/*
/* RequestMetadata å’Œ ReferenceBean çš„æ˜ å°„
/*
/* Key is application name
/* Value is Map<RequestMetadata, ReferenceBean<GenericService>>
/*/
private Map<String, Map<RequestMetadata, ReferenceBean<GenericService>>> referenceBeansRepository = new HashMap<>();
//*/*
/* RequestMetadata å’Œ MethodMetadata çš„æ˜ å°„
/*
/* Key is application name
/*/
private Map<String, Map<RequestMetadata, MethodMetadata>> methodMetadataRepository = new HashMap<>();
@Autowired
private MetadataConfigService metadataConfigService;
```

- çœ‹çœ‹æ¯ä¸ªå±æ€§ä¸Šçš„æ³¨é‡Šå“Ÿã€‚
- æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œ

Key is application name
ï¼Œè¡¨ç¤ºé¦–ä¸ª KEY æ˜¯ Spring Cloudï¼ˆSpring Bootï¼‰åº”ç”¨åã€‚

- ä½†æ˜¯ï¼Œä¸€ä¸ª Dubbo åº”ç”¨ä¸­ï¼Œå¯ä»¥æœ‰å¤šä¸ª Dubbo Service ï¼Œæ‰€ä»¥ï¼Œå°±æœ‰äº†ç¬¬äºŒä¸ª Map ï¼Œä¾‹å¦‚

Map<RequestMetadata, ReferenceBean<GenericService>
ã€‚

- å½“ç„¶ï¼Œæ­¤å¤„æ˜¯æŒ‰ç…§ RequestMetadata ä¸ºç»´åº¦ï¼Œå³æ¯ä¸ª Dubbo Service æ–¹æ³•å¯¹åº”çš„è¯·æ±‚ä¿¡æ¯ã€‚å› ä¸ºï¼Œæ¯ä¸ªè¯·æ±‚è·¯å¾„çš„ URL æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥è¿™ä¹ˆåšæ˜¯ OK çš„ã€‚ç›¸å½“äºè¯´ï¼ŒæŠŠæ¯ä¸ª Dubbo Service çš„æ–¹æ³•ï¼Œå¹³é“ºå¼€ã€‚

### 7.5.2 updateMetadata

/#updateMetadata(String serviceName)
æ–¹æ³•ï¼Œåˆå§‹åŒ–æŒ‡å®š

serviceName
çš„å…ƒæ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboServiceMetadataRepository.java
public void updateMetadata(String serviceName){
// <1.1> è·å¾— serviceName å¯¹åº”çš„ RequestMetadata å’Œ ReferenceBean çš„æ˜ å°„
Map<RequestMetadata, ReferenceBean<GenericService>> genericServicesMap = referenceBeansRepository.computeIfAbsent(serviceName, k -> new HashMap<>());
// <1.2> è·å¾— serviceName å¯¹åº”çš„ RequestMetadata å’Œ MethodMetadata çš„æ˜ å°„
Map<RequestMetadata, MethodMetadata> methodMetadataMap = methodMetadataRepository.computeIfAbsent(serviceName, k -> new HashMap<>());
// <1.3> è·å¾— serviceName å¯¹åº”çš„ ServiceRestMetadata é›†åˆ
Set<ServiceRestMetadata> serviceRestMetadataSet = metadataConfigService.getServiceRestMetadata(serviceName);
// <2> éå† ServiceRestMetadata é›†åˆï¼Œåˆ›å»ºå¯¹åº”çš„ ReferenceBean ï¼Œè·å¾—å¯¹åº”çš„ MethodMetadata å¯¹è±¡
for (ServiceRestMetadata serviceRestMetadata : serviceRestMetadataSet) {
// <2.1> åˆ›å»ºå¯¹åº”çš„ ReferenceBean
ReferenceBean<GenericService> referenceBean = adaptReferenceBean(serviceRestMetadata);
// <2.2> éå† RestMethodMetadata é›†åˆï¼Œæ·»åŠ åˆ° genericServicesMap å’Œ methodMetadataMap ä¸­ï¼Œè¿›è¡Œç¼“å­˜
serviceRestMetadata.getMeta().forEach(restMethodMetadata -> {
RequestMetadata requestMetadata = restMethodMetadata.getRequest();
genericServicesMap.put(requestMetadata, referenceBean);
methodMetadataMap.put(requestMetadata, restMethodMetadata.getMethod());
});
}
}
```

- <1.3>
  å¤„ï¼Œè°ƒç”¨

MetadataConfigService/#getServiceRestMetadata(String serviceName)
æ–¹æ³•ï¼Œè·å¾—æŒ‡å®š

serviceName
çš„ ServiceRestMetadata é›†åˆã€‚æ­¤å¤„ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨ä¸Šäº† [ã€Œ7.4 MetadataConfigServiceã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/)ã€‚

- <2>
  å¤„ï¼Œéå† ServiceRestMetadata é›†åˆï¼Œåˆ›å»ºå¯¹åº”çš„ ReferenceBean ï¼Œè·å¾—å¯¹åº”çš„ MethodMetadata å¯¹è±¡ã€‚

- <2.1>
  å¤„ï¼Œè°ƒç”¨

/#adaptReferenceBean(ServiceRestMetadata serviceRestMetadata)
æ–¹æ³•ï¼Œåˆ›å»º ReferenceBean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboServiceMetadataRepository.java
private ReferenceBean<GenericService> adaptReferenceBean(ServiceRestMetadata serviceRestMetadata){
// è·å¾—ç›¸åº”çš„å±æ€§
String dubboServiceName = serviceRestMetadata.getName();
String[] segments = SpringCloudRegistry.getServiceSegments(dubboServiceName);
String interfaceName = SpringCloudRegistry.getServiceInterface(segments);
String version = SpringCloudRegistry.getServiceVersion(segments);
String group = SpringCloudRegistry.getServiceGroup(segments);
// åˆ›å»º ReferenceBean å¯¹è±¡ï¼Œå¹¶è®¾ç½®ç›¸å…³å±æ€§
ReferenceBean<GenericService> referenceBean = new ReferenceBean<GenericService>();
referenceBean.setGeneric(true);
referenceBean.setInterface(interfaceName);
referenceBean.setVersion(version);
referenceBean.setGroup(group);
return referenceBean;
}
```

- æ³¨æ„å“¦ï¼Œæ­¤æ—¶åˆ›å»ºçš„ ReferenceBean æ˜¯ Dubbo çš„æ³›åŒ–å¼•ç”¨ã€‚
- <2.2>
  å¤„ï¼Œéå† RestMethodMetadata é›†åˆï¼Œæ·»åŠ åˆ°

genericServicesMap
å’Œ

methodMetadataMap
ä¸­ï¼Œè¿›è¡Œç¼“å­˜ã€‚

### 7.5.3 getReferenceBean

/#getReferenceBean(String serviceName, RequestMetadata requestMetadata)
æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šåº”ç”¨çš„æŒ‡å®š RequestMetadata å¯¹åº”çš„ ReferenceBean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public ReferenceBean<GenericService> getReferenceBean(String serviceName, RequestMetadata requestMetadata){
return getReferenceBeansMap(serviceName).get(requestMetadata);
}
private Map<RequestMetadata, ReferenceBean<GenericService>> getReferenceBeansMap(String serviceName) {
return referenceBeansRepository.getOrDefault(serviceName, Collections.emptyMap());
}
```

### 7.5.4 getMethodMetadata

/#getMethodMetadata(String serviceName, RequestMetadata requestMetadata)
æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šåº”ç”¨çš„æŒ‡å®š RequestMetadata å¯¹åº”çš„ MethodMetadata å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboServiceMetadataRepository.java
public MethodMetadata getMethodMetadata(String serviceName, RequestMetadata requestMetadata){
return getMethodMetadataMap(serviceName).get(requestMetadata);
}
private Map<RequestMetadata, MethodMetadata> getMethodMetadataMap(String serviceName){
return methodMetadataRepository.getOrDefault(serviceName, Collections.emptyMap());
}
```

## 7.6 å°ç»“

è‡³æ­¤ï¼Œæˆ‘ä»¬çœ‹å®Œäº†

metadata
åŒ…ä¸‹çš„æ‰€æœ‰ä»£ç ã€‚å› ä¸ºæœ¬å°èŠ‚æ›´å¤šæ˜¯å…ƒæ•°æ®çš„è§£æã€å­˜å‚¨ã€è¯»å–ï¼Œä¸æ¶‰åŠåˆ°å…·ä½“çš„ä½¿ç”¨ï¼Œæ‰€ä»¥ä¼šç•¥å¾®æœ‰ç‚¹æ‡µé€¼ã€‚ä½†æ˜¯ï¼Œåˆ°ä¸‹ä¸€èŠ‚

openfeign
åï¼ŒFeign é€šè¿‡æ³›åŒ–è°ƒç”¨å¯¹åº”çš„ Dubbo æœåŠ¡ï¼Œå°±ä¼šä½¿ç”¨ä¸Šå…ƒæ•°æ®äº†ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠæ•´ä¸ªæµç¨‹æ‰“é€šã€‚

# 8.

openfeign
åŒ…

æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬æ¥ç…ç…ï¼ŒDubbo æ˜¯å¦‚ä½•å’Œ Feign è¿›è¡Œé›†æˆçš„ã€‚

## 8.1 TargeterBeanPostProcessor

org.springframework.cloud.alibaba.dubbo.openfeign.TargeterBeanPostProcessor
ï¼Œå®ç° BeanPostProcessorã€BeanClassLoaderAware æ¥å£ï¼Œå¤„ç†ç±»å‹ä¸º openfeign Targeter çš„ Bean ï¼Œåˆ›å»ºå…¶åŠ¨æ€ä»£ç†ï¼Œä»è€Œèƒ½å¤Ÿå°† Dubbo é›†æˆåˆ° Openfeign ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// TargeterBeanPostProcessor.java
public class TargeterBeanPostProcessor implements BeanPostProcessor, BeanClassLoaderAware{
private static final String TARGETER_CLASS_NAME = "org.springframework.cloud.openfeign.Targeter";
private final Environment environment;
private final DubboServiceMetadataRepository dubboServiceMetadataRepository;
private ClassLoader classLoader;
public TargeterBeanPostProcessor(Environment environment, DubboServiceMetadataRepository dubboServiceMetadataRepository){
this.environment = environment;
this.dubboServiceMetadataRepository = dubboServiceMetadataRepository;
}
@Override
public Object postProcessBeforeInitialization(Object bean, String beanName) throws BeansException{
return bean;
}
@Override
public Object postProcessAfterInitialization(final Object bean, String beanName) throws BeansException{
// <1> è·å¾— Bean çš„ç±»
Class<?> beanClass = ClassUtils.getUserClass(bean.getClass());
// <2> è·å¾— openfeign Targeter æ¥å£
Class<?> targetClass = ClassUtils.resolveClassName(TARGETER_CLASS_NAME, classLoader);
// <3> å¦‚æœå®ç° openfeign Targeter æ¥å£ï¼Œåˆ™åˆ›å»ºåŠ¨æ€ä»£ç†
if (targetClass.isAssignableFrom(beanClass)) {
return Proxy.newProxyInstance(classLoader, new Class[]{targetClass},
new TargeterInvocationHandler(bean, environment, dubboServiceMetadataRepository));
}
return bean;
}
@Override
public void setBeanClassLoader(ClassLoader classLoader){
this.classLoader = classLoader;
}
}
```

- åœ¨åˆ†æå…·ä½“ä»£ç ä¹‹å‰ï¼Œèƒ–å‹å…ˆçœ‹ä¸‹ [ã€ŠSpring Cloud Alibaba Sentinel æ•´åˆ Feign çš„è®¾è®¡å®ç°ã€‹](https://cloud.tencent.com/developer/article/1378733) çš„ [ã€ŒFeign çš„æ‰§è¡Œè¿‡ç¨‹ã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) å°èŠ‚ã€‚å› ä¸ºè‰¿è‰¿çœ‹çš„æ—¶å€™ä¹Ÿä¸æ˜¯å¾ˆäº†è§£ Feign çš„å†…éƒ¨è¿è½¬æœºåˆ¶ï¼Œä¹Ÿæ˜¯å‚è€ƒè¿™ä¸ªå°èŠ‚è¯»æ‡‚è¿™éƒ¨åˆ†ä»£ç çš„ã€‚
- <1>
  å¤„ï¼Œè·å¾— Bean çš„ç±»ã€‚æ ¹æ®ä¸Šé¢æ¨èçš„æ–‡ç« ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œæ­¤æ—¶è¿”å›çš„æ˜¯ HystrixTargeter æˆ– DefaultTargeter ç±»ã€‚
- <2>
  å¤„ï¼Œè·å¾— openfeign Targeter æ¥å£ã€‚
- <3>
  å¤„ï¼Œå¦‚æœå®ç° openfeign Targeter æ¥å£ï¼Œåˆ™åˆ›å»ºåŠ¨æ€ä»£ç†ã€‚å…¶ä¸­ï¼Œä¼ å…¥çš„å¤„ç†å™¨æ˜¯ TargeterInvocationHandler å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ8.2 TargeterInvocationHandlerã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) ã€‚

## 8.2 TargeterInvocationHandler

org.springframework.cloud.alibaba.dubbo.openfeign.TargeterInvocationHandler
ï¼Œä¼šæ‹¦æˆª Targeter çš„

/#target(FeignClientFactoryBean factory, Builder feign, FeignContext context, HardCodedTarget<T> target)
æ–¹æ³•ï¼Œæ ¹æ®æ¡ä»¶ï¼Œåˆ›å»ºä¸åŒçš„ä»£ç†å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
å¦‚æœä¸ç†è§£ Targeter çš„è¯ï¼Œè¯·å†çœ‹ä¸‹ [ã€ŠSpring Cloud Alibaba Sentinel æ•´åˆ Feign çš„è®¾è®¡å®ç°ã€‹](https://cloud.tencent.com/developer/article/1378733)çš„ [ã€ŒFeign çš„æ‰§è¡Œè¿‡ç¨‹ã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) å°èŠ‚ã€‚

```
// TargeterInvocationHandler.java
class TargeterInvocationHandler implements InvocationHandler{
private final Object bean;
private final Environment environment;
private final DubboServiceMetadataRepository dubboServiceMetadataRepository;
TargeterInvocationHandler(Object bean, Environment environment,
DubboServiceMetadataRepository dubboServiceMetadataRepository) {
this.bean = bean;
this.environment = environment;
this.dubboServiceMetadataRepository = dubboServiceMetadataRepository;
}
@Override
public Object invoke(Object proxy, Method method, Object[] args) throws Throwable{
//*/*
/* args[0]: FeignClientFactoryBean factory
/* args[1]: Feign.Builder feign
/* args[2]: FeignContext context
/* args[3]: Target.HardCodedTarget<T> target
/*/
FeignContext feignContext = cast(args[2]);
Target.HardCodedTarget<?> target = cast(args[3]);
// <1> å…ˆè°ƒç”¨åŸæœ‰ target æ–¹æ³•ï¼Œè¿”å›é»˜è®¤çš„ä»£ç†å¯¹è±¡
// Execute Targeter/#target method first
method.setAccessible(true);
// Get the default proxy object
Object defaultProxy = method.invoke(bean, args);
// Create Dubbo Proxy if required
// å¦‚æœç¬¦åˆåˆ›å»º Dubbo ä»£ç†å¯¹è±¡ï¼Œåˆ™åˆ›å»º Dubbo ä»£ç†å¯¹è±¡ã€‚
// å¦åˆ™ï¼Œä½¿ç”¨é»˜è®¤çš„ defaultProxy ä»£ç†
return createDubboProxyIfRequired(feignContext, target, defaultProxy);
}
// ... çœç•¥ä¸‹é¢è¦è®²è§£çš„æ–¹æ³•
}
```

- ä¸ºäº†è®©èƒ–å‹æ›´åŠ å¥½ç†è§£ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨æ—¶çš„æˆªå›¾ï¼š![è°ƒç”¨å›¾](http://static2.iocoder.cn/images/Dubbo/2018_02_14/07.jpg)
- <1>
  å¤„ï¼Œå…ˆè°ƒç”¨åŸæœ‰

target
æ–¹æ³•ï¼Œè¿”å›é»˜è®¤çš„ä»£ç†å¯¹è±¡ã€‚

- <2>
  å¤„ï¼Œè°ƒç”¨

/#createDubboProxyIfRequired(FeignContext feignContext, Target target, Object defaultProxy)
æ–¹æ³•ï¼Œå¦‚æœç¬¦åˆåˆ›å»º Dubbo ä»£ç†å¯¹è±¡ï¼Œåˆ™åˆ›å»º Dubbo ä»£ç†å¯¹è±¡ã€‚å¦åˆ™ï¼Œä½¿ç”¨é»˜è®¤çš„ defaultProxy ä»£ç†ã€‚é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œæ¡ä»¶æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæœ‰

@DubboTransported
æ³¨è§£ï¼Œä¸”ä»é…ç½®ä¸­å¿ƒæ‹‰å–ä¸åˆ°æœåŠ¡æä¾›è€…çš„å…ƒæ•°æ®ã€‚ğŸ˜ˆ å› ä¸ºï¼Œæ²¡æœ‰æœåŠ¡æä¾›è€…çš„å…ƒæ•°æ®ï¼Œæˆ‘ä»¬ä¹Ÿæ— æ³•ä½¿ç”¨ Dubbo çš„æ³›åŒ–è°ƒç”¨å‘€ã€‚

- so ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚

### 8.2.1 createDubboProxyIfRequired

/#createDubboProxyIfRequiredcreateDubboProxyIfRequired(FeignContext feignContext, Target target, Object defaultProxy)
æ–¹æ³•ï¼Œæ ¹æ®æ¡ä»¶ï¼Œåˆ›å»ºå¯¹åº”çš„ä»£ç†å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// TargeterInvocationHandler.java
private Object createDubboProxyIfRequired(FeignContext feignContext, Target target, Object defaultProxy){
// <1> å°è¯•åˆ›å»º DubboInvocationHandler
DubboInvocationHandler dubboInvocationHandler = createDubboInvocationHandler(feignContext, target, defaultProxy);
// <2.1> å¦‚æœæœªåˆ›å»ºæˆåŠŸï¼Œè¯´æ˜ä¸ç¬¦åˆæ¡ä»¶ï¼Œåˆ™è¿”å›é»˜è®¤çš„ defaultProxy ä»£ç†
if (dubboInvocationHandler == null) {
return defaultProxy;
}
// <2.2> å¦‚æœåˆ›å»ºæˆåŠŸï¼Œè¯´æ˜ç¬¦åˆæ¡ä»¶ï¼Œåˆ™åˆ›å»ºä½¿ç”¨ dubboInvocationHandler çš„åŠ¨æ€ä»£ç†
return Proxy.newProxyInstance(target.type().getClassLoader(), new Class<?>[]{target.type()}, dubboInvocationHandler);
}
```

- <1>
  å¤„ï¼Œè°ƒç”¨

/#createDubboInvocationHandler(FeignContext feignContext, Target target, Object defaultFeignClientProxy)
æ–¹æ³•ï¼Œå°è¯•åˆ›å»º DubboInvocationHandlerã€‚

- <2.1>
  å¤„ï¼Œå¦‚æœæœªåˆ›å»ºæˆåŠŸï¼Œè¯´æ˜ä¸ç¬¦åˆæ¡ä»¶ï¼Œåˆ™è¿”å›é»˜è®¤çš„

defaultProxy
ä»£ç†ã€‚

- <2.2>
  å¤„ï¼Œå¦‚æœåˆ›å»ºæˆåŠŸï¼Œè¯´æ˜ç¬¦åˆæ¡ä»¶ï¼Œåˆ™åˆ›å»ºä½¿ç”¨

dubboInvocationHandler
çš„åŠ¨æ€ä»£ç†ã€‚

### 8.2.2 createDubboInvocationHandler

/#createDubboInvocationHandler(FeignContext feignContext, Target target, Object defaultFeignClientProxy)
æ–¹æ³•ï¼Œåˆ›å»º DubboInvocationHandler å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
æœªæ¥è¿™å—çš„é€»è¾‘ï¼Œä¼šè¢«æŠ½å–åˆ°

org.springframework.cloud.alibaba.dubbo.openfeign.DubboInvocationHandlerFactory
ç±»ä¸­ã€‚

```
// TargeterInvocationHandler.java
private DubboInvocationHandler createDubboInvocationHandler(FeignContext feignContext, Target target, Object defaultFeignClientProxy){
// Service name equals @FeignClient.name()
String serviceName = target.name();
Class<?> targetType = target.type();
// Get Contract Bean from FeignContext
// <1.1> è·å¾— Feign Contract
Contract contract = feignContext.getInstance(serviceName, Contract.class);
// <1.2> åˆ›å»º DubboTransportedMethodMetadataResolver å¯¹è±¡
DubboTransportedMethodMetadataResolver resolver = new DubboTransportedMethodMetadataResolver(environment, contract);
// <1.3> è§£ææŒ‡å®šç±»ï¼Œè·å¾—å…¶ DubboTransportedMethodMetadata å’Œ RequestMetadata çš„æ˜ å°„
Map<DubboTransportedMethodMetadata, RequestMetadata> methodRequestMetadataMap = resolver.resolve(targetType);
// <1.4> å¦‚æœä¸ºç©ºï¼Œåˆ™è¿”å›ï¼Œè¯´æ˜ä¸ç¬¦åˆæ¡ä»¶
if (methodRequestMetadataMap.isEmpty()) { // @DubboTransported method was not found
return null;
}
// Update Metadata
// <2> åˆå§‹åŒ–æŒ‡å®š `serviceName` çš„å…ƒæ•°æ®ã€‚æ­¤å¤„ï¼Œä¼šä»é…ç½®ä¸­å¿ƒï¼Œè·å¾—å…ƒæ•°æ®
dubboServiceMetadataRepository.updateMetadata(serviceName);
Map<Method, org.springframework.cloud.alibaba.dubbo.metadata.MethodMetadata> methodMetadataMap = new HashMap<>();
Map<Method, GenericService> genericServicesMap = new HashMap<>();
// <3> éå† methodRequestMetadataMap é›†åˆï¼Œåˆå§‹åŒ–å…¶ GenericService
methodRequestMetadataMap.forEach((dubboTransportedMethodMetadata, requestMetadata) -> {
// <3.1.1> è·å¾— ReferenceBean å¯¹è±¡ï¼Œå¹¶åˆå§‹åŒ–å…¶å±æ€§
ReferenceBean<GenericService> referenceBean = dubboServiceMetadataRepository.getReferenceBean(serviceName, requestMetadata);
referenceBean.setProtocol(dubboTransportedMethodMetadata.getProtocol());
referenceBean.setCluster(dubboTransportedMethodMetadata.getCluster());
// <3.1.2> æ·»åŠ åˆ° genericServicesMap ä¸­
genericServicesMap.put(dubboTransportedMethodMetadata.getMethod(), referenceBean.get());
// <3.2.1> è·å¾— MethodMetadata å¯¹è±¡
org.springframework.cloud.alibaba.dubbo.metadata.MethodMetadata methodMetadata = dubboServiceMetadataRepository.getMethodMetadata(serviceName, requestMetadata);
// <3.2.2> æ·»åŠ åˆ° methodMetadataMap ä¸­
methodMetadataMap.put(dubboTransportedMethodMetadata.getMethod(), methodMetadata);
});
// <4.1> è·å¾—é»˜è®¤çš„ defaultFeignClientProxy ä¸­ï¼Œé»˜è®¤çš„ InvocationHandler å¯¹è±¡
InvocationHandler defaultFeignClientInvocationHandler = Proxy.getInvocationHandler(defaultFeignClientProxy);
// <4.2> åˆ›å»º DubboInvocationHandler å¯¹è±¡
return new DubboInvocationHandler(genericServicesMap, methodMetadataMap, defaultFeignClientInvocationHandler);
}
```

- <1.1>
  å¤„ï¼Œè·å¾— Feign Contract ã€‚
- <1.2>
  å¤„ï¼Œåˆ›å»º DubboTransportedMethodMetadataResolver å¯¹è±¡ã€‚
- <1.3>
  å¤„ï¼Œè°ƒç”¨

DubboTransportedMethodMetadataResolver/#resolve(Class<?> targetType)
è§£ææŒ‡å®šç±»ï¼Œè·å¾—å…¶ DubboTransportedMethodMetadata å’Œ RequestMetadata çš„æ˜ å°„ã€‚æ­¤å¤„ï¼Œæˆ‘ä»¬å°±æŠŠ [ã€Œ7.3 DubboTransportedMethodMetadataã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) ç»™ä¸²èµ·æ¥äº†ã€‚

- <1.4>
  å¤„ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™è¿”å›ï¼Œè¯´æ˜ä¸ç¬¦åˆæ¡ä»¶ã€‚æ­¤å¤„ï¼Œæˆ‘ä»¬æ¥æŠ›ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœä¸€ä¸ªç±»é‡Œï¼Œå¤šä¸ªæ–¹æ³•ä¸­ï¼Œæœ‰éƒ¨åˆ†æ–¹æ³•æ²¡æœ‰

@DubboTransported
æ³¨è§£ï¼Œé‚£ä¹ˆä¼šä¸ä¼šåˆ›å»º DubboInvocationHandler å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚é‚£ä¹ˆæ­¤æ—¶ï¼Œå°±ä¼šæœ‰

@DubboTransported
æ³¨è§£çš„æ–¹æ³•ï¼Œä½¿ç”¨ Dubbo è¿›è¡Œè°ƒç”¨ï¼Œæ²¡æœ‰

@DubboTransported
æ³¨è§£çš„æ–¹æ³•ï¼Œè¿˜æ˜¯é€‰æ‹©åŸæœ‰ Feign æä¾›çš„æ–¹å¼ï¼ˆä¾‹å¦‚è¯´ RestTemplateï¼‰è¿›è¡Œè°ƒç”¨ã€‚

- <2>
  å¤„ï¼Œè°ƒç”¨

DubboServiceMetadataRepository/#updateMetadata(String serviceName)
æ–¹æ³•ï¼Œåˆå§‹åŒ–æŒ‡å®š

serviceName
çš„å…ƒæ•°æ®ï¼ˆæ­¤æ—¶ï¼Œä¼šä»é…ç½®ä¸­å¿ƒï¼Œè·å¾—å…ƒæ•°æ®ï¼‰ã€‚æ­¤å¤„ï¼Œæˆ‘ä»¬å°±æŠŠ [ã€Œ7.5 DubboServiceMetadataRepositoryã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) ç»™ä¸²èµ·æ¥äº†ã€‚

- <3>
  å¤„ï¼Œéå†

methodRequestMetadataMap
é›†åˆï¼Œåˆå§‹åŒ–å…¶ GenericService ã€‚

- <3.1.1>
  å¤„ï¼Œè·å¾— ReferenceBean å¯¹è±¡ï¼Œå¹¶åˆå§‹åŒ–å…¶å±æ€§ã€‚
- <3.1.2>
  å¤„ï¼Œæ·»åŠ åˆ°

genericServicesMap
ä¸­ã€‚

- <3.2.1>
  å¤„ï¼Œè·å¾— MethodMetadata å¯¹è±¡ã€‚
- <3.2.2>
  å¤„ï¼Œæ·»åŠ åˆ°

methodMetadataMap
ä¸­ã€‚

- <4.1>
  å¤„ï¼Œè·å¾—é»˜è®¤çš„

defaultFeignClientProxy
ä¸­ï¼Œé»˜è®¤çš„ InvocationHandler å¯¹è±¡ã€‚ä¸ºä»€ä¹ˆéœ€è¦å®ƒå‘¢ï¼Ÿå› ä¸ºï¼Œä¸€ä¸ªç±»ä¸­ï¼Œå¯èƒ½æœ‰æ²¡æœ‰

@DubboTransported
æ³¨è§£çš„æ–¹æ³•ã€‚

- <4.2>
  å¤„ï¼Œåˆ›å»º DubboInvocationHandler å¯¹è±¡ã€‚

## 8.3 DubboInvocationHandler

org.springframework.cloud.alibaba.dubbo.openfeign.DubboInvocationHandler
ï¼Œå®ç° InvocationHandler æ¥å£ï¼ŒDubbo InvocationHandler å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboInvocationHandler.java
public class DubboInvocationHandler implements InvocationHandler{
private final Map<Method, GenericService> genericServicesMap;
private final Map<Method, MethodMetadata> methodMetadata;
private final InvocationHandler defaultInvocationHandler;
public DubboInvocationHandler(Map<Method, GenericService> genericServicesMap,
Map<Method, MethodMetadata> methodMetadata,
InvocationHandler defaultInvocationHandler){
this.genericServicesMap = genericServicesMap;
this.methodMetadata = methodMetadata;
this.defaultInvocationHandler = defaultInvocationHandler;
}
@Override
public Object invoke(Object proxy, Method method, Object[] args) throws Throwable{
// è·å¾— GenericService å¯¹è±¡
GenericService genericService = genericServicesMap.get(method);
// è·å¾— MethodMetadata å¯¹è±¡
MethodMetadata methodMetadata = this.methodMetadata.get(method);
// <1> æƒ…å†µä¸€ï¼Œå¦‚æœä»»ä¸€ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤çš„ defaultInvocationHandler
if (genericService == null || methodMetadata == null) {
return defaultInvocationHandler.invoke(proxy, method, args);
}
// æƒ…å†µäºŒï¼Œæ‰§è¡Œæ³›åŒ–è°ƒç”¨
String methodName = methodMetadata.getName(); // æ–¹æ³•å
String[] parameterTypes = methodMetadata
.getParams()
.stream()
.map(MethodParameterMetadata::getType)
.toArray(String[]::new); // å‚æ•°ç±»å‹
return genericService.$invoke(methodName, parameterTypes, args);
}
}
```

- <1>
  å¤„ï¼Œå¦‚æœä»»ä¸€ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤çš„

defaultInvocationHandler
ï¼Œå³æ— 

@DubboTransported
æ³¨è§£çš„æ–¹æ³•ã€‚

- <2>
  å¤„ï¼Œæ‰§è¡Œæ³›åŒ–è°ƒç”¨ï¼Œå³æœ‰

@DubboTransported
æ³¨è§£çš„æ–¹æ³•ã€‚

## 8.4 å°ç»“

è‡³æ­¤ï¼Œæ•´ä¸ªæœåŠ¡æ¶ˆè´¹è€…è°ƒç”¨çš„æµç¨‹ï¼Œæˆ‘ä»¬å·²ç»ä¸²è”èµ·æ¥äº†ã€‚å› ä¸ºæœ¬æ–‡æ˜¯æŒ‰ç…§

package
åŒ…åˆ†å±‚æ¥å†™ï¼Œæ‰€ä»¥è¿è´¯æ€§ä¼šç›¸å¯¹æ¯”è¾ƒå·®ã€‚å› æ­¤ï¼Œéœ€è¦èƒ–å‹è‡ªå·±åœ¨è°ƒè¯•ä¸€ä¸‹å“ˆã€‚

# 9.

registry
åŒ…

æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬æ¥ç…ç…ï¼ŒDubbo æ˜¯å¦‚ä½•å’Œ Spring Cloud æ³¨å†Œä¸­å¿ƒè¿›è¡Œé›†æˆçš„ã€‚

åœ¨ [2.4.2 application.yaml](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ³¨å†Œä¸­å¿ƒä½¿ç”¨çš„æ˜¯

dubbo.registry.address: spring-cloud://nacos
ã€‚

## 9.1 Registration

org.springframework.cloud.alibaba.dubbo.registry.DubboRegistration
ï¼Œå®ç° Spring Cloud Registration æ¥å£ï¼ŒDubbo Registration å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// DubboRegistration.java
//*/*
/* The {@link Registration} of Dubbo uses an external of {@link ServiceInstance} instance as the delegate.
/*/
class DubboRegistration implements Registration{
//*/*
/* Spring Cloud ServiceInstance
/*/
private final ServiceInstance delegate;
public DubboRegistration(ServiceInstance delegate){
this.delegate = delegate;
}
@Override
public String getServiceId(){
return delegate.getServiceId();
}
@Override
public String getHost(){
return delegate.getHost();
}
@Override
public int getPort(){
return delegate.getPort();
}
@Override
public boolean isSecure(){
return delegate.isSecure();
}
@Override
public URI getUri(){
return delegate.getUri();
}
@Override
public Map<String, String> getMetadata(){
return delegate.getMetadata();
}
@Override
public String getScheme(){
return delegate.getScheme();
}
}
```

## 9.2 SpringCloudRegistryFactory

åœ¨

com.alibaba.dubbo.registry.RegistryFactory
ä¸­ï¼Œå£°æ˜äº†ä¸€ä¸ª SpringCloudRegistryFactory æ‹“å±•ã€‚å¦‚ä¸‹ï¼š

```
spring-cloud=org.springframework.cloud.alibaba.dubbo.registry.SpringCloudRegistryFactory
```

- å‰ç¼€ä¸º

"spring-cloud"
ã€‚å³ï¼Œå’Œæˆ‘ä»¬é…ç½®çš„

dubbo.registry.address: spring-cloud://nacos
èƒ½å¤Ÿå¯¹åº”ä¸Šã€‚

org.springframework.cloud.alibaba.dubbo.registry.SpringCloudRegistryFactory
ï¼Œå®ç° Dubbo RegistryFactory æ¥å£ï¼Œåˆ›å»ºå¯¹ SpringCloudRegistry æ³¨å†Œä¸­å¿ƒã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// SpringCloudRegistryFactory.java
public class SpringCloudRegistryFactory implements RegistryFactory{
private static ApplicationContext applicationContext;
@Override
public Registry getRegistry(URL url){
// <1> è·å¾— ServiceRegistry å¯¹è±¡
ServiceRegistry<Registration> serviceRegistry = applicationContext.getBean(ServiceRegistry.class);
// <2> è·å¾— DiscoveryClient å¯¹è±¡
DiscoveryClient discoveryClient = applicationContext.getBean(DiscoveryClient.class);
// <3> åˆ›å»º SpringCloudRegistry å¯¹è±¡
return new SpringCloudRegistry(url, serviceRegistry, discoveryClient);
}
public static void setApplicationContext(ApplicationContext applicationContext){
SpringCloudRegistryFactory.applicationContext = applicationContext;
}
}
```

- <1>
  å¤„ï¼Œè·å¾— ServiceRegistry å¯¹è±¡ã€‚æ­¤å¤„ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ Nacos ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œé‚£ä¹ˆè¿”å›çš„å°±æ˜¯

org.springframework.cloud.alibaba.nacos.registry.NacosServiceRegistry
å¯¹è±¡ã€‚

- <2>
  å¤„ï¼Œè·å¾— DiscoveryClient å¯¹è±¡ã€‚æ­¤å¤„ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ Nacos ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œé‚£ä¹ˆè¿”å›çš„ Composite DiscoveryClient å¯¹è±¡ï¼ŒåŒ…å«

org.springframework.cloud.alibaba.nacos.NacosDiscoveryClient
å¯¹è±¡ã€‚

- ä¸Šè¿°ä¸¤ä¸ªå˜é‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![å˜é‡](http://static2.iocoder.cn/images/Dubbo/2018_02_14/08.jpg)
- <3>
  å¤„ï¼Œåˆ›å»º SpringCloudRegistry å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ9.3 SpringCloudRegistryã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) ã€‚

## 9.3 SpringCloudRegistry

æœ¬å°èŠ‚ï¼Œå»ºç«‹åœ¨èƒ–å‹çœ‹è¿‡ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹](http://www.iocoder.cn/Dubbo/good-collection/) æ–‡ç« ã€‚

org.springframework.cloud.alibaba.dubbo.registry.SpringCloudRegistry
ï¼Œç»§æ‰¿ Dubbo FailbackRegistry æŠ½è±¡ç±»ï¼ŒåŸºäº Spring Cloud DiscoveryClientã€SpringCloudRegistry çš„ API ï¼Œå°è£…å‡º Spring Cloud Registry å®ç°ç±»ã€‚

### 9.3.1 æ„é€ æ–¹æ³•

```
// SpringCloudRegistry.java
//*/*
/* ServiceRegistry å¯¹è±¡
/*/
private final ServiceRegistry<Registration> serviceRegistry;
//*/*
/* DiscoveryClient å¯¹è±¡
/*/
private final DiscoveryClient discoveryClient;
public SpringCloudRegistry(URL url, ServiceRegistry<Registration> serviceRegistry,
DiscoveryClient discoveryClient){
super(url);
this.serviceRegistry = serviceRegistry;
this.discoveryClient = discoveryClient;
}
```

### 9.3.2 doRegister

å®ç°

/#doRegister(URL ur)
æ–¹æ³•ï¼Œæ‰§è¡Œæ³¨å†Œã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// SpringCloudRegistry.java
@Override
protected void doRegister(URL url){
// <1> è·å¾— serviceName
final String serviceName = getServiceName(url);
// <2> åˆ›å»º Registration å¯¹è±¡
final Registration registration = createRegistration(serviceName, url);
// <3> æ³¨å†Œåˆ° serviceRegistry ä¸­
serviceRegistry.register(registration);
}
```

- <1>
  å¤„ï¼Œè·å¾—

serviceName
ã€‚ä¾‹å¦‚ï¼š

providers:dubbo:org.springframework.cloud.alibaba.dubbo.service.EchoService:1.0.0
ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// SpringCloudRegistry.java
public static String getServiceName(URL url){
// è·å¾—åˆ†ç±»
String category = url.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);
// è·å¾— ServiceName
return getServiceName(url, category);
}
private static void appendIfPresent(StringBuilder target, URL url, String parameterName){
String parameterValue = url.getParameter(parameterName);
appendIfPresent(target, parameterValue);
}
private static final String SERVICE_NAME_SEPARATOR = ":";
private static void appendIfPresent(StringBuilder target, String parameterValue){
if (StringUtils.hasText(parameterValue)) {
target.append(SERVICE_NAME_SEPARATOR).append(parameterValue);
}
}
```

- <2>
  å¤„ï¼Œåˆ›å»º DubboRegistration å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// SpringCloudRegistry.java
private Registration createRegistration(String serviceName, URL url){
return new DubboRegistration(createServiceInstance(serviceName, url));
}
private ServiceInstance createServiceInstance(String serviceName, URL url){
// Append default category if absent
// è·å¾—å±æ€§
String category = url.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);
URL newURL = url.addParameter(Constants.CATEGORY_KEY, category);
newURL = newURL.addParameter(Constants.PROTOCOL_KEY, url.getProtocol());
String ip = NetUtils.getLocalHost(); // IP
int port = newURL.getParameter(Constants.BIND_PORT_KEY, url.getPort()); // ç«¯å£
// åˆ›å»º DefaultServiceInstance å¯¹è±¡
DefaultServiceInstance serviceInstance = new DefaultServiceInstance(serviceName, ip, port, false);
serviceInstance.getMetadata().putAll(new LinkedHashMap<>(newURL.getParameters()));
return serviceInstance;
}
```

- <3>
  å¤„ï¼Œè°ƒç”¨

ServiceRegistry/#register(R registration)
æ–¹æ³•ï¼Œæ³¨å†Œåˆ°

serviceRegistry
ä¸­ã€‚è¿™æ ·ï¼ŒDubbo å°±æ³¨å†Œåˆ° Spring Cloud Registry ä¸­ã€‚

### 9.3.3 doUnregister

å®ç°

/#doUnregister(URL url)
æ–¹æ³•ï¼Œå–æ¶ˆæ³¨å†Œã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// SpringCloudRegistry.java
@Override
protected void doUnregister(URL url){
// è·å¾— serviceName
final String serviceName = getServiceName(url);
// åˆ›å»º Registration å¯¹è±¡
final Registration registration = createRegistration(serviceName, url);
// å–æ¶ˆæ³¨å†Œä» serviceRegistry ä¸­
this.serviceRegistry.deregister(registration);
}
```

### 9.3.4 doSubscribe

å®ç°

/#doSubscribe(URL url, NotifyListener listener)
æ–¹æ³•ï¼Œæ‰§è¡Œè®¢é˜…ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// SpringCloudRegistry.java
@Override
protected void doSubscribe(URL url, NotifyListener listener){
// <1> è·å¾— serviceName æ•°ç»„
List<String> serviceNames = getServiceNames(url, listener);
// <2> æ‰§è¡Œè®¢é˜…
doSubscribe(url, listener, serviceNames);
}
```

- <1>
  å¤„ï¼Œè·å¾— serviceName æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// SpringCloudRegistry.java
private List<String> getServiceNames(URL url, NotifyListener listener){
// ç®¡ç†ç«¯ï¼Œæš‚æ—¶æ— è§†
if (isAdminProtocol(url)) {
scheduleServiceNamesLookup(url, listener);
return getServiceNamesForOps(url);
} else {
return doGetServiceNames(url);
}
}
private List<String> doGetServiceNames(URL url){
// è·å¾— category æ•°ç»„
String[] categories = getCategories(url);
// åˆ›å»º serviceName æ•°ç»„ï¼Œå¹¶è¿›è¡Œè·å¾—
List<String> serviceNames = new ArrayList<String>(categories.length);
for (String category : categories) {
final String serviceName = getServiceName(url, category);
serviceNames.add(serviceName);
}
return serviceNames;
}
```

- <2>
  å¤„ï¼Œè°ƒç”¨

/#doSubscribe(final URL url, final NotifyListener listener, final List<String> serviceNames)
æ–¹æ³•ï¼Œæ‰§è¡Œè®¢é˜…ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// SpringCloudRegistry.java
private void doSubscribe(final URL url, final NotifyListener listener, final List<String> serviceNames){
for (String serviceName : serviceNames) {
// <2.1> è·å¾— ServiceInstance æ•°ç»„
List<ServiceInstance> serviceInstances = discoveryClient.getInstances(serviceName);
// <2.2> é€šçŸ¥è®¢é˜…è€…
notifySubscriber(url, listener, serviceInstances);
// TODO Support Update notification event
}
}
```

- éå†

serviceNames
æ•°ç»„ï¼Œé€ä¸ªå¤„ç†ã€‚

- <2.1>
  å¤„ï¼Œè°ƒç”¨

DiscoveryClient/#getInstances(String serviceId)
æ–¹æ³•ï¼Œè·å¾— ServiceInstance æ•°ç»„ã€‚

- <2.2>
  å¤„ï¼Œè°ƒç”¨

/#notifySubscriber(URL url, NotifyListener listener, List<ServiceInstance> serviceInstances)
æ–¹æ³•ï¼Œé€šçŸ¥è®¢é˜…è€…ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€ŒnotifySubscriberã€](http://svip.iocoder.cn/Dubbo/spring-cloud-integration/) ã€‚

### 9.3.4.1 notifySubscriber

/#notifySubscriber(URL url, NotifyListener listener, List<ServiceInstance> serviceInstances)
æ–¹æ³•ï¼Œé€šçŸ¥è®¢é˜…è€…ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// SpringCloudRegistry.java
private void notifySubscriber(URL url, NotifyListener listener, List<ServiceInstance> serviceInstances){
// <1> è¿‡æ»¤æ‰éå¥åº·çš„ Dubbo æœåŠ¡
List<ServiceInstance> healthyInstances = new LinkedList<ServiceInstance>(serviceInstances);
// <1> Healthy Instances
filterHealthyInstances(healthyInstances);
// <2> åˆ›å»º URL æ•°ç»„
List<URL> urls = buildURLs(url, healthyInstances);
// <3> é€šçŸ¥è®¢é˜…è€…
this.notify(url, listener, urls);
}
```

- <1>
  å¤„ï¼Œè°ƒç”¨

/#filterHealthyInstances(Collection<ServiceInstance> instances)
æ–¹æ³•ï¼Œè¿‡æ»¤æ‰éå¥åº·çš„ Dubbo æœåŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// SpringCloudRegistry.java
private void filterHealthyInstances(Collection<ServiceInstance> instances){
filter(instances, new Filter<ServiceInstance>() {
@Override
public boolean accept(ServiceInstance data){
// TODO check the details of status
// return serviceRegistry.getStatus(new DubboRegistration(data)) != null;
return true;
}
});
}
private <T> void filter(Collection<T> collection, Filter<T> filter){
// remove if not accept
collection.removeIf(data -> !filter.accept(data));
}
private interface Filter<T>{
//*/*
/* Tests whether or not the specified data should be accepted.
/*
/* @param data The data to be tested
/* @return <code>true</code> if and only if <code>data</code>
/* should be accepted
/*/
boolean accept(T data);
}
```

- ä»

TODO check the details of status
å¯ä»¥çœ‹å‡ºï¼Œç›®å‰æš‚æ—¶æœªå®ç°ã€‚åç»­ï¼Œå¯èƒ½ä¼šæ ¹æ®çŠ¶æ€è¿›è¡Œè¿‡æ»¤ã€‚

- <2>
  å¤„ï¼Œè°ƒç”¨

/#buildURLs(URL consumerURL, Collection<ServiceInstance> serviceInstances)
æ–¹æ³•ï¼Œå°† ServiceInstance æ•°ç»„ï¼Œè½¬æ¢æˆ URL æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// SpringCloudRegistry.java
private List<URL> buildURLs(URL consumerURL, Collection<ServiceInstance> serviceInstances){
// serviceInstances ä¸ºç©ºï¼Œè¿”å›ç©ºæ•°ç»„
if (serviceInstances.isEmpty()) {
return Collections.emptyList();
}
// serviceInstances éç©ºï¼Œåˆ™é€ä¸ªæ„å»ºå¯¹åº”çš„ URL å¯¹è±¡ï¼Œæ·»åŠ åˆ° urls ä¸­è¿›è¡Œè¿”å›
List<URL> urls = new LinkedList<>();
for (ServiceInstance serviceInstance : serviceInstances) {
// æ„å»º URL å¯¹è±¡
URL url = buildURL(serviceInstance);
if (UrlUtils.isMatch(consumerURL, url)) {
urls.add(url);
}
}
return urls;
}
private URL buildURL(ServiceInstance serviceInstance){
return new URL(serviceInstance.getMetadata().get(Constants.PROTOCOL_KEY),
serviceInstance.getHost(),
serviceInstance.getPort(),
serviceInstance.getMetadata());
}
```

- <3>
  å¤„ï¼Œè°ƒç”¨çˆ¶

/#notify(URL url, NotifyListener listener, List<URL> urls)
æ–¹æ³•ï¼Œé€šçŸ¥è®¢é˜…è€…ã€‚

### 9.3.5 doUnsubscribe

å®ç°

/#doUnsubscribe(URL url, NotifyListener listener)
æ–¹æ³•ï¼Œå–æ¶ˆè®¢é˜…ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// SpringCloudRegistry.java
@Override
protected void doUnsubscribe(URL url, NotifyListener listener){
// å¿½ç•¥ç®¡ç†ç«¯
if (isAdminProtocol(url)) {
shutdownServiceNamesLookup();
}
}
```
