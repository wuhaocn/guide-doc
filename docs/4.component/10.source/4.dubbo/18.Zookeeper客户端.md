# Zookeeper å®¢æˆ·ç«¯

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

åœ¨

dubbo-remoting-zookeeper
æ¨¡å—ï¼Œå®ç°äº† Dubbo å¯¹ Zookeeper å®¢æˆ·ç«¯çš„å°è£…ã€‚åœ¨è¯¥æ¨¡å—ä¸­ï¼ŒæŠ½è±¡äº†**é€šç”¨**çš„ Zookeeper Client API æ¥å£ï¼Œå®ç°äº†**ä¸¤ç§** Zookeeper Client åº“çš„æ¥å…¥ï¼š

- åŸºäº [Apache Curator](https://curator.apache.org/) å®ç°ã€‚

```
<dubbo:registry address="zookeeper://127.0.0.1:2181" client="curator" />
```

- åŸºäº [ZkClient](https://github.com/sgroschupf/zkclient) å®ç°ã€‚

```
<dubbo:registry address="zookeeper://127.0.0.1:2181" client="zkclient" />
```

é»˜è®¤ä¸é…ç½®

client
çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Curator ã€‚

dubbo-remoting-zookeeper
çš„æ•´ä½“ç±»å›¾å¦‚ä¸‹ï¼š

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_07_01/01.png)

ä¸‹é¢ï¼Œæˆ‘ä»¬æŒ‰ç…§æ¥å£åˆ°å®ç°çš„é¡ºåºï¼Œå¾€ä¸‹çœ‹ã€‚

# 2. æ¥å£

## 2.1 StateListener

com.alibaba.dubbo.remoting.zookeeper.StateListener
ï¼ŒçŠ¶æ€ç›‘å¬å™¨æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public interface StateListener{
//*/*
/* çŠ¶æ€ - å·²æ–­å¼€
/*/
int DISCONNECTED = 0;
//*/*
/* çŠ¶æ€ - å·²è¿æ¥
/*/
int CONNECTED = 1;
//*/*
/* çŠ¶æ€ - å·²é‡è¿
/*/
int RECONNECTED = 2;
//*/*
/* çŠ¶æ€å˜æ›´å›è°ƒ
/*
/* @param connected çŠ¶æ€
/*/
void stateChanged(int connected);
}
```

## 2.2 ChildListener

com.alibaba.dubbo.remoting.zookeeper.StateListener
ï¼ŒèŠ‚ç‚¹ç›‘å¬å™¨æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public interface ChildListener{
//*/*
/* å­èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–çš„å›è°ƒ
/*
/* @param path èŠ‚ç‚¹
/* @param children æœ€æ–°çš„å­èŠ‚ç‚¹åˆ—è¡¨
/*/
void childChanged(String path, List<String> children);
}
```

## 2.3 ZookeeperClient

com.alibaba.dubbo.remoting.zookeeper.ZookeeperClient
ï¼ŒZookeeper å®¢æˆ·ç«¯æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public interface ZookeeperClient{
//*/*
/* åˆ›å»ºèŠ‚ç‚¹
/*
/* @param path èŠ‚ç‚¹è·¯å¾„
/* @param ephemeral æ˜¯å¦ä¸´æ—¶èŠ‚ç‚¹
/*/
void create(String path, boolean ephemeral);
//*/*
/* åˆ é™¤èŠ‚ç‚¹
/*
/* @param path èŠ‚ç‚¹è·¯å¾„
/*/
void delete(String path);
List<String> getChildren(String path);
//*/*
/* æ·»åŠ  ChildListener
/*
/* @param path èŠ‚ç‚¹è·¯å¾„
/* @param listener ç›‘å¬å™¨
/* @return å­èŠ‚ç‚¹åˆ—è¡¨
/*/
List<String> addChildListener(String path, ChildListener listener);
//*/*
/* ç§»é™¤ ChildListener
/*
/* @param path èŠ‚ç‚¹è·¯å¾„
/* @param listener ç›‘å¬å™¨
/*/
void removeChildListener(String path, ChildListener listener);
//*/*
/* æ·»åŠ  StateListener
/*
/* @param listener ç›‘å¬å™¨
/*/
void addStateListener(StateListener listener);
//*/*
/* ç§»é™¤ StateListener
/*
/* @param listener ç›‘å¬å™¨
/*/
void removeStateListener(StateListener listener);
//*/*
/* @return æ˜¯å¦è¿æ¥
/*/
boolean isConnected();
//*/*
/* å…³é—­
/*/
void close();
//*/*
/* @return è·å¾—æ³¨å†Œä¸­å¿ƒ URL
/*/
URL getUrl();
}
```

- çŠ¶æ€ç›¸å…³æ–¹æ³•

- /#isConnected()
- /#close()
- /#getUrl()
- æ•°æ®ç›¸å…³æ–¹æ³•

- /#create(path, ephemeral)
- /#getChildren(path)
- ä» API ä¸Šï¼ŒDubbo åªä½¿ç”¨èŠ‚ç‚¹çš„è·¯å¾„ï¼Œè€Œä¸ä½¿ç”¨èŠ‚ç‚¹çš„å€¼ï¼ˆå†…å®¹ï¼‰ã€‚
- ç›‘å¬ç›¸å…³æ–¹æ³•

- /#addChildListener(path, listener)
- /#removeChildListener(path, listener)
- /#addStateListener(listener)
- /#removeStateListener(listener)

## 2.4 AbstractZookeeperClient

com.alibaba.dubbo.remoting.zookeeper.support.AbstractZookeeperClient
ï¼Œå®ç° ZookeeperClient æ¥å£ï¼ŒZookeeper å®¢æˆ·ç«¯**æŠ½è±¡ç±»**ï¼Œå®ç°é€šç”¨çš„é€»è¾‘ã€‚

### 2.4.1 å±æ€§

```
public abstract class AbstractZookeeperClient<TargetChildListener> implements ZookeeperClient{
//*/*
/* æ³¨å†Œä¸­å¿ƒ URL
/*/
private final URL url;
//*/*
/* StateListener é›†åˆ
/*/
private final Set<StateListener> stateListeners = new CopyOnWriteArraySet<StateListener>();
//*/*
/* ChildListener é›†åˆ
/*
/* key1ï¼šèŠ‚ç‚¹è·¯å¾„
/* key2ï¼šChildListener å¯¹è±¡
/* value ï¼šç›‘å¬å™¨å…·ä½“å¯¹è±¡ã€‚ä¸åŒ Zookeeper å®¢æˆ·ç«¯ï¼Œå®ç°ä¼šä¸åŒã€‚
/*/
private final ConcurrentMap<String, ConcurrentMap<ChildListener, TargetChildListener>> childListeners = new ConcurrentHashMap<String, ConcurrentMap<ChildListener, TargetChildListener>>();
//*/*
/* æ˜¯å¦å…³é—­
/*/
private volatile boolean closed = false;
public AbstractZookeeperClient(URL url){
this.url = url;
}
@Override
public URL getUrl(){
return url;
}
// ... çœç•¥å…¶ä»–æ–¹æ³•
}
```

ğŸ™‚ è§ä»£ç æ³¨é‡Šã€‚

### 2.4.2 create

```
@Override
public void create(String path, boolean ephemeral){
// å¾ªç¯åˆ›å»ºçˆ¶è·¯å¾„
int i = path.lastIndexOf('/');
if (i > 0) {
String parentPath = path.substring(0, i);
if (!checkExists(parentPath)) {
create(parentPath, false);
}
}
// åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹
if (ephemeral) {
createEphemeral(path);
// åˆ›å»ºæŒä¹…èŠ‚ç‚¹
} else {
createPersistent(path);
}
}
```

- /#checkExists(path)
  **æŠ½è±¡**æ–¹æ³•ï¼ŒèŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
protected abstract boolean checkExists(String path);
```

- /#createEphemeral(path)
  **æŠ½è±¡**æ–¹æ³•ï¼Œåˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
protected abstract void createPersistent(String path);
```

- /#createPersistent(path)
  **æŠ½è±¡**æ–¹æ³•ï¼Œåˆ›å»ºæŒä¹…èŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
protected abstract void createEphemeral(String path);
```

### 2.4.3 StateListener ç›¸å…³æ–¹æ³•

```
@Override
public void addStateListener(StateListener listener){
stateListeners.add(listener);
}
@Override
public void removeStateListener(StateListener listener){
stateListeners.remove(listener);
}
public Set<StateListener> getSessionListeners(){
return stateListeners;
}
//*/*
/* StateListener æ•°ç»„ï¼Œå›è°ƒ
/*
/* @param state çŠ¶æ€
/*/
protected void stateChanged(int state){
for (StateListener sessionListener : getSessionListeners()) {
sessionListener.stateChanged(state);
}
}
```

### 2.4.4 ChildListener ç›¸å…³æ–¹æ³•

```
@Override
public List<String> addChildListener(String path, final ChildListener listener){
// è·å¾—è·¯å¾„ä¸‹çš„ç›‘å¬å™¨æ•°ç»„
ConcurrentMap<ChildListener, TargetChildListener> listeners = childListeners.get(path);
if (listeners == null) {
childListeners.putIfAbsent(path, new ConcurrentHashMap<ChildListener, TargetChildListener>());
listeners = childListeners.get(path);
}
// è·å¾—æ˜¯å¦å·²ç»æœ‰è¯¥ç›‘å¬å™¨
TargetChildListener targetListener = listeners.get(listener);
// ç›‘å¬å™¨ä¸å­˜åœ¨ï¼Œè¿›è¡Œåˆ›å»º
if (targetListener == null) {
listeners.putIfAbsent(listener, createTargetChildListener(path, listener));
targetListener = listeners.get(listener);
}
// å‘ Zookeeper ï¼ŒçœŸæ­£å‘èµ·è®¢é˜…
return addTargetChildListener(path, targetListener);
}
@Override
public void removeChildListener(String path, ChildListener listener){
ConcurrentMap<ChildListener, TargetChildListener> listeners = childListeners.get(path);
if (listeners != null) {
TargetChildListener targetListener = listeners.remove(listener);
if (targetListener != null) {
// å‘ Zookeeper ï¼ŒçœŸæ­£å‘èµ·å–æ¶ˆè®¢é˜…
removeTargetChildListener(path, targetListener);
}
}
}
```

- /#createTargetChildListener(path, listener)
  **æŠ½è±¡**æ–¹æ³•ï¼Œåˆ›å»ºçœŸæ­£çš„ ChildListener å¯¹è±¡ã€‚å› ä¸ºï¼Œæ¯ä¸ª Zookeeper çš„åº“ï¼Œå®ç°ä¸åŒã€‚ä»£ç å¦‚ä¸‹ï¼š

```
protected abstract TargetChildListener createTargetChildListener(String path, ChildListener listener);
```

- /#addTargetChildListener(path, targetListener)
  **æŠ½è±¡**æ–¹æ³•ï¼Œå‘ Zookeeper ï¼ŒçœŸæ­£å‘èµ·è®¢é˜…ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
protected abstract List<String> addTargetChildListener(String path, TargetChildListener listener);
```

- /#removeTargetChildListener(path, targetListener)
  **æŠ½è±¡**æ–¹æ³•ï¼Œå‘ Zookeeper ï¼ŒçœŸæ­£å‘èµ·å–æ¶ˆè®¢é˜…ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
protected abstract void removeTargetChildListener(String path, TargetChildListener listener);
```

### 2.4.5 close

```
@Override
public void close(){
if (closed) {
return;
}
closed = true;
try {
doClose();
} catch (Throwable t) {
logger.warn(t.getMessage(), t);
}
}
```

- /#doClose()
  **æŠ½è±¡**æ–¹æ³•ï¼Œå…³é—­ Zookeeper è¿æ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
protected abstract void doClose();
```

## 2.5 ZookeeperTransporter

com.alibaba.dubbo.remoting.zookeeper.ZookeeperTransporter
ï¼ŒZookeeper å·¥å‚æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
@SPI("curator")
public interface ZookeeperTransporter{
//*/*
/* è¿æ¥åˆ›å»º ZookeeperClient å¯¹è±¡
/*
/* @param url æ³¨å†Œä¸­å¿ƒåœ°å€
/* @return ZookeeperClient å¯¹è±¡
/*/
@Adaptive({Constants.CLIENT_KEY, Constants.TRANSPORTER_KEY})
ZookeeperClient connect(URL url);
}
```

- /#connect(url)
  æ–¹æ³•ï¼Œè¿æ¥åˆ›å»º ZookeeperClient å¯¹è±¡ã€‚
- @SPI("curator")
  æ³¨è§£ï¼Œä½¿ç”¨ Dubbo SPI æœºåˆ¶ï¼Œé»˜è®¤ä½¿ç”¨ Curator å®ç°ã€‚
- @Adaptive({Constants.CLIENT_KEY, Constants.TRANSPORTER_KEY})
  æ³¨è§£ï¼Œä½¿ç”¨ Dubbo SPI Adaptive æœºåˆ¶ï¼Œæ ¹æ®

url
å‚æ•°ï¼ŒåŠ è½½å¯¹åº”çš„ ZookeeperTransporter æ‹“å±•å®ç°ç±»ã€‚

# 3. åŸºäº Curator å®ç°

Apache Curator ï¼Œä½œä¸º Zookeeper å®¢æˆ·ç«¯çš„åº“ï¼ŒåŸºæœ¬æ˜¯**æœ€ä½³**çš„é€‰æ‹©ï¼Œåœ¨ Sharding-JDBCã€Elastic-Job ç­‰ç­‰ä¸­é—´éƒ½é€‰æ‹©äº† Curator è¿æ¥ Zookeeper ã€‚
å‹æƒ…æç¤ºï¼Œå¦‚æœå¯¹ Curator çš„ API ä¸ç†Ÿæ‚‰çš„èƒ–å‹ï¼Œæ¨èçœ‹ä¸‹å®˜æ–¹æ–‡æ¡£ï¼Œè¿›è¡Œä¸‹å­¦ä¹ ã€‚
ğŸ™‚ æœ¬æ–‡ä¸ä¼šå†™ Curator ä½¿ç”¨æ–¹æ³•ã€‚

## 3.1 CuratorZookeeperClient

com.alibaba.dubbo.remoting.zookeeper.curator.CuratorZookeeperClient
ï¼Œå®ç° ZookeeperTransporter æŠ½è±¡ç±»ï¼ŒåŸºäº Curator çš„ Zookeeper å®¢æˆ·ç«¯å®ç°ç±»ã€‚

### 3.1.1 å±æ€§

```
//*/*
/* client å¯¹è±¡
/*/
private final CuratorFramework client;
public CuratorZookeeperClient(URL url){
super(url);
try {
// åˆ›å»º client å¯¹è±¡
CuratorFrameworkFactory.Builder builder = CuratorFrameworkFactory.builder()
.connectString(url.getBackupAddress()) // è¿æ¥åœ°å€
.retryPolicy(new RetryNTimes(1, 1000)) // é‡è¯•ç­–ç•¥ï¼Œ1 æ¬¡ï¼Œé—´éš” 1000 ms
.connectionTimeoutMs(5000); // è¿æ¥è¶…æ—¶æ—¶é—´
String authority = url.getAuthority();
if (authority != null && authority.length() > 0) {
builder = builder.authorization("digest", authority.getBytes());
}
client = builder.build();
// æ·»åŠ è¿æ¥ç›‘å¬å™¨
client.getConnectionStateListenable().addListener(new ConnectionStateListener() {
public void stateChanged(CuratorFramework client, ConnectionState state){
if (state == ConnectionState.LOST) {
CuratorZookeeperClient.this.stateChanged(StateListener.DISCONNECTED);
} else if (state == ConnectionState.CONNECTED) {
CuratorZookeeperClient.this.stateChanged(StateListener.CONNECTED);
} else if (state == ConnectionState.RECONNECTED) {
CuratorZookeeperClient.this.stateChanged(StateListener.RECONNECTED);
}
}
});
// å¯åŠ¨ client
client.start();
} catch (Exception e) {
throw new IllegalStateException(e.getMessage(), e);
}
}
```

- åœ¨è¿æ¥çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè°ƒç”¨

/#stateChange(state)
æ–¹æ³•ï¼Œè¿›è¡Œ StateListener çš„å›è°ƒã€‚

### 3.1.2 create ç›¸å…³æ–¹æ³•

- [
  /#createPersistent(path)
  ](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-remoting/dubbo-remoting-zookeeper/src/main/java/com/alibaba/dubbo/remoting/zookeeper/curator/CuratorZookeeperClient.java#L72-L79)
- [
  /#createEphemeral(path)
  ](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-remoting/dubbo-remoting-zookeeper/src/main/java/com/alibaba/dubbo/remoting/zookeeper/curator/CuratorZookeeperClient.java#L81-L88)
- [
  /#checkExists(path)
  ](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-remoting/dubbo-remoting-zookeeper/src/main/java/com/alibaba/dubbo/remoting/zookeeper/curator/CuratorZookeeperClient.java#L109-L117)

### 3.1.3 ChildListener ç›¸å…³æ–¹æ³•

```
public CuratorWatcher createTargetChildListener(String path, ChildListener listener){
return new CuratorWatcherImpl(listener);
}
public List<String> addTargetChildListener(String path, CuratorWatcher listener){
try {
return client.getChildren().usingWatcher(listener).forPath(path);
} catch (NoNodeException e) {
return null;
} catch (Exception e) {
throw new IllegalStateException(e.getMessage(), e);
}
}
public void removeTargetChildListener(String path, CuratorWatcher listener){
((CuratorWatcherImpl) listener).unwatch();
}
private class CuratorWatcherImpl implements CuratorWatcher{
private volatile ChildListener listener;
public CuratorWatcherImpl(ChildListener listener){
this.listener = listener;
}
public void unwatch(){
this.listener = null;
}
@Override
public void process(WatchedEvent event) throws Exception{
if (listener != null) {
String path = event.getPath() == null ? "" : event.getPath();
listener.childChanged(path,
// if path is null, curator using watcher will throw NullPointerException.
// if client connect or disconnect to server, zookeeper will queue
// watched event(Watcher.Event.EventType.None, .., path = null).
StringUtils.isNotEmpty(path)
? client.getChildren().usingWatcher(this).forPath(path) // é‡æ–°å‘èµ·è¿æ¥ï¼Œå¹¶ä¼ å…¥æœ€æ–°çš„å­èŠ‚ç‚¹åˆ—è¡¨
: Collections.<String>emptyList()); //
}
}
}
```

### 3.1.4 close ç›¸å…³æ–¹æ³•

- [
  /#doClose()
  ](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-remoting/dubbo-remoting-zookeeper/src/main/java/com/alibaba/dubbo/remoting/zookeeper/curator/CuratorZookeeperClient.java#L122-L124)

### 3.1.5 delete

```
@Override
public void delete(String path){
try {
client.delete().forPath(path);
} catch (NoNodeException e) {
} catch (Exception e) {
throw new IllegalStateException(e.getMessage(), e);
}
}
```

æ— æ³•é€šç”¨ï¼Œæ‰€ä»¥å­ç±»å®ç°ã€‚

### 3.1.6 getChildren

```
@Override
public List<String> getChildren(String path){
try {
return client.getChildren().forPath(path);
} catch (NoNodeException e) {
return null;
} catch (Exception e) {
throw new IllegalStateException(e.getMessage(), e);
}
}
```

## 3.2 CuratorZookeeperTransporter

com.alibaba.dubbo.remoting.zookeeper.curator.CuratorZookeeperTransporter
ï¼Œå®ç° ZookeeperTransporter æ¥å£ï¼ŒCuratorZookeeper å·¥å‚å®ç°ç±»ã€‚

```
public class CuratorZookeeperTransporter implements ZookeeperTransporter{
public ZookeeperClient connect(URL url){
return new CuratorZookeeperClient(url);
}
}
```

# 4. åŸºäº ZkClient å®ç°

ğŸ™‚ åŸºäº ZkClient çš„å®ç°ï¼Œæœ¬æ–‡ä»…åˆ—å‡ºæ ‡é¢˜ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥è‡ªå·±å»çœ‹ã€‚

å½“ç„¶ï¼Œè‰¯å¿ƒå¦‚ç¬”è€…ï¼Œå·²ç»æ·»åŠ äº†ä¸­æ–‡æ³¨é‡Šã€‚

## 4.1 ZkclientZookeeperClient

[
com.alibaba.dubbo.remoting.zookeeper.zkclient.ZkclientZookeeperClient
](https://github.com/YunaiV/dubbo/blob/66a1e1b0ef4b01175be148d27fdcf519f4f01b15/dubbo-remoting/dubbo-remoting-zookeeper/src/main/java/com/alibaba/dubbo/remoting/zookeeper/zkclient/ZkclientZookeeperClient.java)

### 4.1.1 ZkClientWrapper

[
com.alibaba.dubbo.remoting.zookeeper.zkclient.ZkClientWrapper
](https://github.com/YunaiV/dubbo/blob/66a1e1b0ef4b01175be148d27fdcf519f4f01b15/dubbo-remoting/dubbo-remoting-zookeeper/src/main/java/com/alibaba/dubbo/remoting/zookeeper/zkclient/ZkClientWrapper.java)

## 4.2 ZkclientZookeeperTransporter

[
com.alibaba.dubbo.remoting.zookeeper.zkclient.ZkclientZookeeperTransporter
](https://github.com/YunaiV/dubbo/blob/66a1e1b0ef4b01175be148d27fdcf519f4f01b15/dubbo-remoting/dubbo-remoting-zookeeper/src/main/java/com/alibaba/dubbo/remoting/zookeeper/zkclient/ZkclientZookeeperTransporter.java)
