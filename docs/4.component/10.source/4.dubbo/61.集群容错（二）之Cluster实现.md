# é›†ç¾¤å®¹é”™ï¼ˆäºŒï¼‰ä¹‹ Cluster å®ç°

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡æ¥ [ã€Šç²¾å°½ Dubbo æºç è§£æ â€”â€” é›†ç¾¤å®¹é”™ï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹](http://svip.iocoder.cn/Dubbo/cluster-1-api-interface//?self) ä¸€æ–‡ï¼Œåˆ†äº«

dubbo-cluster
æ¨¡å—ï¼Œ

support
åŒ…ï¼Œ**å„ç§ Cluster å®ç°ç±»**ã€‚

Cluster å­ç±»å¦‚ä¸‹å›¾ï¼š

![Cluster å­ç±»](http://static2.iocoder.cn/images/Dubbo/2019_04_01/01.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ª Cluster å®ç°ç±»ï¼Œå¯¹åº”ä¸€ä¸ª**ä¸“å±**äºå…¶çš„ Invoker å®ç°ç±»ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªå­ç±»å¾€ä¸‹çœ‹ã€‚
è€è‰¿è‰¿ï¼šæœ¬æ–‡å¯¹åº” [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” é›†ç¾¤å®¹é”™ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/fault-tolerent-strategy.html) æ–‡æ¡£ã€‚

# 2. AvailableCluster

com.alibaba.dubbo.rpc.cluster.support.AvailableCluster
ï¼Œå®ç° Cluster æ¥å£ï¼Œè°ƒç”¨**é¦–ä¸ªå¯ç”¨**æœåŠ¡å™¨ï¼Œç›®å‰ç”¨äº[å¤šæ³¨å†Œä¸­å¿ƒå¼•ç”¨](http://dubbo.apache.org/zh-cn/docs/user/demos/multi-registry.html#%E5%A4%9A%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%B3%A8%E5%86%8C)ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class AvailableCluster implements Cluster{
public static final String NAME = "available";
public <T> Invoker<T> join(Directory<T> directory) throws RpcException{
return new AvailableClusterInvoker<T>(directory);
}
}
```

- å¯¹åº” Invoker å®ç°ç±»ä¸º AvailableClusterInvoker ã€‚

## 2.1 AvailableClusterInvoker

com.alibaba.dubbo.rpc.cluster.support.AvailableClusterInvoker
ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒAvailableCluster Invoker å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class AvailableClusterInvoker<T> extends AbstractClusterInvoker<T>{
public AvailableClusterInvoker(Directory<T> directory){
super(directory);
}
@Override
public Result doInvoke(Invocation invocation, List<Invoker<T>> invokers, LoadBalance loadbalance) throws RpcException{
// å¾ªç¯å€™é€‰çš„ Invoker é›†åˆï¼Œè°ƒç”¨é¦–ä¸ªå¯ç”¨çš„ Invoker å¯¹è±¡ã€‚
for (Invoker<T> invoker : invokers) {
if (invoker.isAvailable()) { // å¯ç”¨
// å‘èµ· RPC è°ƒç”¨
return invoker.invoke(invocation);
}
}
throw new RpcException("No provider available in " + invokers);
}
}
```

# 3. BroadcastCluster

com.alibaba.dubbo.rpc.cluster.support.BroadcastCluster
ï¼Œå®ç° Cluster æ¥å£ï¼Œå¹¿æ’­è°ƒç”¨**æ‰€æœ‰**æä¾›è€…ï¼Œé€ä¸ªè°ƒç”¨ï¼Œ**ä»»æ„**ä¸€å°æŠ¥é”™åˆ™æŠ¥é”™ã€‚é€šå¸¸ç”¨äºé€šçŸ¥æ‰€æœ‰æä¾›è€…æ›´æ–°ç¼“å­˜æˆ–æ—¥å¿—ç­‰æœ¬åœ°èµ„æºä¿¡æ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class BroadcastCluster implements Cluster{
@Override
public <T> Invoker<T> join(Directory<T> directory) throws RpcException{
return new BroadcastClusterInvoker<T>(directory);
}
}
```

- å¯¹åº” Invoker å®ç°ç±»ä¸º BroadcastClusterInvoker ã€‚

## 3.1 BroadcastClusterInvoker

com.alibaba.dubbo.rpc.cluster.support.BroadcastClusterInvoker
ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒBroadcastCluster Invoker å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class BroadcastClusterInvoker<T> extends AbstractClusterInvoker<T>{
private static final Logger logger = LoggerFactory.getLogger(BroadcastClusterInvoker.class);
public BroadcastClusterInvoker(Directory<T> directory){
super(directory);
}
@Override
@SuppressWarnings({"unchecked", "rawtypes"})
public Result doInvoke(final Invocation invocation, List<Invoker<T>> invokers, LoadBalance loadbalance) throws RpcException{
// æ£€æŸ¥ invokers å³å¯ç”¨Invokeré›†åˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œé‚£ä¹ˆæŠ›å‡ºå¼‚å¸¸
checkInvokers(invokers, invocation);
// è®¾ç½®å·²ç»è°ƒç”¨çš„ Invoker é›†åˆï¼Œåˆ° Context ä¸­
RpcContext.getContext().setInvokers((List) invokers);
// ä¿å­˜æœ€åä¸€æ¬¡è°ƒç”¨çš„å¼‚å¸¸
RpcException exception = null;
// ä¿å­˜æœ€åä¸€æ¬¡è°ƒç”¨çš„ç»“æœ
Result result = null;
// å¾ªç¯å€™é€‰çš„ Invoker é›†åˆï¼Œè°ƒç”¨æ‰€æœ‰ Invoker å¯¹è±¡ã€‚
for (Invoker<T> invoker : invokers) {
try {
// å‘èµ· RPC è°ƒç”¨
result = invoker.invoke(invocation);
} catch (RpcException e) {
exception = e;
logger.warn(e.getMessage(), e);
} catch (Throwable e) {
exception = new RpcException(e.getMessage(), e); // å°è£…æˆ RpcException å¼‚å¸¸
logger.warn(e.getMessage(), e);
}
}
// è‹¥å­˜åœ¨ä¸€ä¸ªå¼‚å¸¸ï¼ŒæŠ›å‡ºè¯¥å¼‚å¸¸
if (exception != null) {
throw exception;
}
return result;
}
}
```

# 4. FailbackCluster

com.alibaba.dubbo.rpc.cluster.support.FailbackCluster
ï¼Œå®ç° Cluster æ¥å£ï¼Œå¤±è´¥è‡ªåŠ¨æ¢å¤ï¼Œåå°è®°å½•å¤±è´¥è¯·æ±‚ï¼Œå®šæ—¶é‡å‘ã€‚é€šå¸¸ç”¨äºæ¶ˆæ¯é€šçŸ¥æ“ä½œã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class FailbackCluster implements Cluster{
public final static String NAME = "failback";
@Override
public <T> Invoker<T> join(Directory<T> directory) throws RpcException{
return new FailbackClusterInvoker<T>(directory);
}
}
```

- å¯¹åº” Invoker å®ç°ç±»ä¸º FailbackClusterInvoker ã€‚

## 4.1 FailbackClusterInvoker

com.alibaba.dubbo.rpc.cluster.support.FailbackClusterInvoker
ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒFailbackCluster Invoker å®ç°ç±»ã€‚

### 4.1.1 æ„é€ æ–¹æ³•

```
//*/*
/* é‡è¯•é¢‘ç‡
/*/
private static final long RETRY_FAILED_PERIOD = 5 /* 1000;
//*/*
/* ScheduledExecutorService å¯¹è±¡
/*/
private final ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(2, new NamedThreadFactory("failback-cluster-timer", true));
//*/*
/* å¤±è´¥ä»»åŠ¡é›†åˆ
/*/
private final ConcurrentMap<Invocation, AbstractClusterInvoker<?>> failed = new ConcurrentHashMap<Invocation, AbstractClusterInvoker<?>>();
//*/*
/* é‡è¯•ä»»åŠ¡ Future
/*/
private volatile ScheduledFuture<?> retryFuture;
public FailbackClusterInvoker(Directory<T> directory){
super(directory);
}
```

- æ‰€æœ‰å­—æ®µï¼Œéƒ½æ˜¯å’Œé‡è¯•ç›¸å…³ï¼Œèƒ–å‹çœ‹ä¸‹æ³¨é‡Šã€‚

### 4.1.2 doInvoke

```
@Override
protected Result doInvoke(Invocation invocation, List<Invoker<T>> invokers, LoadBalance loadbalance) throws RpcException{
try {
// æ£€æŸ¥ invokers å³å¯ç”¨Invokeré›†åˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œé‚£ä¹ˆæŠ›å‡ºå¼‚å¸¸
checkInvokers(invokers, invocation);
// æ ¹æ®è´Ÿè½½å‡è¡¡æœºåˆ¶ä» invokers ä¸­é€‰æ‹©ä¸€ä¸ªInvoker
Invoker<T> invoker = select(loadbalance, invocation, invokers, null);
// RPC è°ƒç”¨å¾—åˆ° Result
return invoker.invoke(invocation);
} catch (Throwable e) {
logger.error("Failback to invoke method " + invocation.getMethodName() + ", wait for retry in background. Ignored exception: " + e.getMessage() + ", ", e);
// æ·»åŠ åˆ°å¤±è´¥ä»»åŠ¡
addFailed(invocation, this);
return new RpcResult(); // ignore
}
}
```

- è‹¥ RPC è°ƒç”¨å¤±è´¥ï¼Œåˆ™è°ƒç”¨

/#addFailed(invocation, this)
æ–¹æ³•ï¼Œæ·»åŠ åˆ°

failed
ä¸­ï¼Œåå°å®šæ—¶é‡è¯•ã€‚

### 4.1.3 addFailed

```
private void addFailed(Invocation invocation, AbstractClusterInvoker<?> router){
// è‹¥å®šæ—¶ä»»åŠ¡æœªåˆå§‹åŒ–ï¼Œè¿›è¡Œåˆ›å»º
if (retryFuture == null) {
synchronized (this) {
if (retryFuture == null) {
retryFuture = scheduledExecutorService.scheduleWithFixedDelay(new Runnable() {
public void run(){
// collect retry statistics
try {
retryFailed();
} catch (Throwable t) { // Defensive fault tolerance
logger.error("Unexpected error occur at collect statistic", t);
}
}
}, RETRY_FAILED_PERIOD, RETRY_FAILED_PERIOD, TimeUnit.MILLISECONDS);
}
}
}
// æ·»åŠ åˆ°å¤±è´¥ä»»åŠ¡
failed.put(invocation, router);
}
```

- åˆ›å»ºçš„å®šæ—¶ä»»åŠ¡ï¼Œä¼šè°ƒç”¨

/#retryFailed()
æ–¹æ³•ï¼Œé‡è¯•ä»»åŠ¡ï¼Œå‘èµ· RCP è°ƒç”¨ã€‚

### 4.1.4 retryFailed

```
void retryFailed(){
if (failed.size() == 0) {
return;
}
// å¾ªç¯é‡è¯•ä»»åŠ¡ï¼Œé€ä¸ªè°ƒç”¨
for (Map.Entry<Invocation, AbstractClusterInvoker<?>> entry : new HashMap<Invocation, AbstractClusterInvoker<?>>(failed).entrySet()) { // åˆ›å»ºé›†åˆ
Invocation invocation = entry.getKey();
Invoker<?> invoker = entry.getValue();
try {
// RPC è°ƒç”¨å¾—åˆ° Result
invoker.invoke(invocation);
// ç§»é™¤å¤±è´¥ä»»åŠ¡
failed.remove(invocation);
} catch (Throwable e) {
logger.error("Failed retry to invoke method " + invocation.getMethodName() + ", waiting again.", e);
}
}
}
```

- å¾ªç¯é‡è¯•ä»»åŠ¡ï¼Œé€ä¸ªå‘èµ· RPC è°ƒç”¨ã€‚è‹¥è°ƒç”¨æˆåŠŸï¼Œç§»é™¤è¯¥å¤±è´¥ä»»åŠ¡å‡º

failed
é›†åˆã€‚

åœ¨æç«¯æƒ…å†µä¸‹ï¼Œå­˜åœ¨ä¸€ä¸ª BUG ï¼Œå¤ç°æ­¥éª¤å¦‚ä¸‹ï¼š

1. å‡è®¾ç›®å‰æœ‰ä¸¤ä¸ªæœåŠ¡æä¾›è€… Aã€B ã€‚
1. é¦–å…ˆè°ƒç”¨ A æœåŠ¡ï¼Œå‡è®¾è¶…æ—¶ï¼Œæ·»åŠ åˆ°

failed
ä¸­ã€‚

1. é‡è¯•è°ƒç”¨ B æœåŠ¡ï¼ˆA æœåŠ¡äº¦å¯ï¼‰ï¼Œå‡è®¾å†æ¬¡è¶…æ—¶ï¼Œæ·»åŠ åˆ°

failed
ä¸­ã€‚

1. å› ä¸º

/#doInvoker(...)
æ–¹æ³•ï¼Œè°ƒç”¨å¤±è´¥ï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼ˆå½“ç„¶ä¹Ÿä¸èƒ½ï¼‰ï¼Œå¯¼è‡´

/#retryFailed(...)
æ–¹æ³•ï¼Œ**è¯¯ä»¥ä¸º**è°ƒç”¨æˆåŠŸï¼Œé”™è¯¯çš„ç§»é™¤è¯¥å¤±è´¥ä»»åŠ¡å‡º

failed
é›†åˆã€‚

é‚£ä¹ˆèƒ½ä¸èƒ½åœ¨

/#retryFailed(...)
æ–¹æ³•ä¸­ï¼Œå…ˆç§»é™¤è¯¥å¤±è´¥ä»»åŠ¡å‡º

failed
é›†åˆå‘¢ï¼Œå†å‘èµ· PRC è°ƒç”¨å‘¢ï¼Ÿç­”æ¡ˆæ˜¯**ä¸å¯ä»¥**ï¼Œå› ä¸ºåœ¨è°ƒç”¨

/#doInvoke(...)
æ–¹æ³•ä¹‹å‰ï¼Œå¯èƒ½å‘ç”Ÿå¼‚å¸¸ï¼Œå¯¼è‡´å¤±è´¥ä»»åŠ¡çš„ä¸¢å¤±ã€‚

é‚£ä¹ˆè¯¥æ€ä¹ˆåŠï¼Ÿæœ‰ä¸¤ç§æ–¹å¼ï¼š

1. ä¸Šè¿°æ–¹æ¡ˆçš„åŸºç¡€ä¸Šï¼Œåœ¨

/#retryFailed(...)
æ–¹æ³•çš„ç§»é™¤å¤„ç†ä¸­ï¼Œå¢åŠ è°ƒç”¨

/#addFailed(...)
æ–¹æ³•ã€‚

1. æšä¸¾ä¸€ä¸ª

FAILED_RESULT
å¯¹è±¡ï¼Œè®©

/#doInvoke(...)
æ–¹æ³•å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè¿”å›è¯¥å¯¹è±¡ã€‚è¿™æ ·

/#retryFailed(...)
æ–¹æ³•ï¼Œåœ¨ç§»é™¤å‡º

failed
é›†åˆæ—¶ï¼Œå¢åŠ ä¸‹æ˜¯å¦æ‰§è¡ŒæˆåŠŸçš„åˆ¤æ–­ã€‚

ç¬”è€…å€¾å‘ç¬¬äºŒç§ï¼Œé€»è¾‘æ›´åŠ çº¿æ€§å’Œæ˜“æ‡‚ã€‚

# 5. FailfastCluster

com.alibaba.dubbo.rpc.cluster.support.FailfastCluster
ï¼Œå®ç° Cluster æ¥å£ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œåªå‘èµ·ä¸€æ¬¡è°ƒç”¨ï¼Œ**å¤±è´¥ç«‹å³æŠ¥é”™**ã€‚é€šå¸¸ç”¨äº**éå¹‚ç­‰æ€§çš„å†™æ“ä½œ**ï¼Œæ¯”å¦‚æ–°å¢è®°å½•ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class FailfastCluster implements Cluster{
public final static String NAME = "failfast";
@Override
public <T> Invoker<T> join(Directory<T> directory) throws RpcException{
return new FailfastClusterInvoker<T>(directory);
}
}
```

- å¯¹åº” Invoker å®ç°ç±»ä¸º FailfastClusterInvoker ã€‚

## 5.1 FailfastInvoker

com.alibaba.dubbo.rpc.cluster.support.FailbackClusterInvoker
ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒFailfast Invoker å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class FailfastClusterInvoker<T> extends AbstractClusterInvoker<T>{
public FailfastClusterInvoker(Directory<T> directory){
super(directory);
}
@Override
public Result doInvoke(Invocation invocation, List<Invoker<T>> invokers, LoadBalance loadbalance) throws RpcException{
// æ£€æŸ¥ invokers å³å¯ç”¨Invokeré›†åˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œé‚£ä¹ˆæŠ›å‡ºå¼‚å¸¸
checkInvokers(invokers, invocation);
// æ ¹æ®è´Ÿè½½å‡è¡¡æœºåˆ¶ä» invokers ä¸­é€‰æ‹©ä¸€ä¸ªInvoker
Invoker<T> invoker = select(loadbalance, invocation, invokers, null);
try {
// RPC è°ƒç”¨å¾—åˆ° Result
return invoker.invoke(invocation);
} catch (Throwable e) {
// è‹¥æ˜¯ä¸šåŠ¡æ€§è´¨çš„å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º
if (e instanceof RpcException && ((RpcException) e).isBiz()) { // biz exception.
throw (RpcException) e;
}
// å°è£… RpcException å¼‚å¸¸ï¼Œå¹¶æŠ›å‡º
throw new RpcException(e instanceof RpcException ? ((RpcException) e).getCode() : 0,
"Failfast invoke providers " + invoker.getUrl() + " " + loadbalance.getClass().getSimpleName() + " select from all providers " + invokers + " for service " + getInterface().getName() + " method " + invocation.getMethodName() + " on consumer " + NetUtils.getLocalHost() + " use dubbo version " + Version.getVersion() + ", but no luck to perform the invocation. Last error is: " + e.getMessage(), e.getCause() != null ? e.getCause() : e);
}
}
}
```

- å’Œ FailbackClusterInvoker å·®å¼‚ç‚¹ï¼Œåœ¨äºå¯¹å¼‚å¸¸çš„å¤„ç†ã€‚

# 6. FailsafeCluster

com.alibaba.dubbo.rpc.cluster.support.FailsafeCluster
ï¼Œå®ç° Cluster æ¥å£ï¼Œå¤±è´¥å®‰å…¨ï¼Œ**å‡ºç°å¼‚å¸¸æ—¶ï¼Œç›´æ¥å¿½ç•¥**ã€‚é€šå¸¸ç”¨äºå†™å…¥å®¡è®¡æ—¥å¿—ç­‰æ“ä½œã€‚

ä»£ç å¦‚ä¸‹ï¼š

```
public class FailfastCluster implements Cluster{
public final static String NAME = "failfast";
@Override
public <T> Invoker<T> join(Directory<T> directory) throws RpcException{
return new FailfastClusterInvoker<T>(directory);
}
}
```

- å¯¹åº” Invoker å®ç°ç±»ä¸º FailsafeClusterInvoker ã€‚

## 6.1 FailsafeClusterInvoker

com.alibaba.dubbo.rpc.cluster.support.FailsafeClusterInvoker
ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒFailsafe Invoker å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class FailsafeClusterInvoker<T> extends AbstractClusterInvoker<T>{
private static final Logger logger = LoggerFactory.getLogger(FailsafeClusterInvoker.class);
public FailsafeClusterInvoker(Directory<T> directory){
super(directory);
}
@Override
public Result doInvoke(Invocation invocation, List<Invoker<T>> invokers, LoadBalance loadbalance) throws RpcException{
try {
// æ£€æŸ¥ invokers å³å¯ç”¨Invokeré›†åˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œé‚£ä¹ˆæŠ›å‡ºå¼‚å¸¸
checkInvokers(invokers, invocation);
// æ ¹æ®è´Ÿè½½å‡è¡¡æœºåˆ¶ä» invokers ä¸­é€‰æ‹©ä¸€ä¸ªInvoker
Invoker<T> invoker = select(loadbalance, invocation, invokers, null);
// RPC è°ƒç”¨å¾—åˆ° Result
return invoker.invoke(invocation);
} catch (Throwable e) {
// æ‰“å°å¼‚å¸¸æ—¥å¿—
logger.error("Failsafe ignore exception: " + e.getMessage(), e);
// å¿½ç•¥å¼‚å¸¸
return new RpcResult(); // ignore
}
}
}
```

- å’Œ FailfastInvoker å·®å¼‚ç‚¹ï¼Œåœ¨äºå¯¹å¼‚å¸¸çš„å¤„ç†ã€‚

# 7. ForkingCluster

com.alibaba.dubbo.rpc.cluster.support.ForkingCluster
ï¼Œå®ç° Cluster æ¥å£ï¼Œå¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡å™¨ï¼Œåªè¦ä¸€ä¸ªæˆåŠŸå³è¿”å›ã€‚é€šå¸¸ç”¨äºå®æ—¶æ€§è¦æ±‚è¾ƒé«˜çš„è¯»æ“ä½œï¼Œä½†éœ€è¦æµªè´¹æ›´å¤šæœåŠ¡èµ„æºã€‚å¯é€šè¿‡

forks="2"
æ¥è®¾ç½®æœ€å¤§å¹¶è¡Œæ•°ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```
public class ForkingCluster implements Cluster{
public final static String NAME = "forking";
@Override
public <T> Invoker<T> join(Directory<T> directory) throws RpcException{
return new ForkingClusterInvoker<T>(directory);
}
}
```

## 7.1 ForkingClusterInvoker

è€è‰¿è‰¿ï¼šBlockQueue çš„ä½¿ç”¨ï¼Œéå¸¸ç²¾é«“ï¼

com.alibaba.dubbo.rpc.cluster.support.ForkingClusterInvoker
ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒForkingCluster Invoker å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: public class ForkingClusterInvoker<T> extends AbstractClusterInvoker<T>{
2:
3: //*/*
4: /* ExecutorService å¯¹è±¡ï¼Œå¹¶ä¸”ä¸º CachedThreadPool ã€‚
5: /*/
6: private final ExecutorService executor = Executors.newCachedThreadPool(new NamedThreadFactory("forking-cluster-timer", true));
7:
8: public ForkingClusterInvoker(Directory<T> directory){
9: super(directory);
10: }
11:
12: @Override
13: @SuppressWarnings({"unchecked", "rawtypes"})
14: public Result doInvoke(final Invocation invocation, List<Invoker<T>> invokers, LoadBalance loadbalance) throws RpcException{
15: // æ£€æŸ¥ invokers å³å¯ç”¨Invokeré›†åˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œé‚£ä¹ˆæŠ›å‡ºå¼‚å¸¸
16: checkInvokers(invokers, invocation);
17: // ä¿å­˜é€‰æ‹©çš„ Invoker é›†åˆ
18: final List<Invoker<T>> selected;
19: // å¾—åˆ°æœ€å¤§å¹¶è¡Œæ•°ï¼Œé»˜è®¤ä¸º Constants.DEFAULT_FORKS = 2
20: final int forks = getUrl().getParameter(Constants.FORKS_KEY, Constants.DEFAULT_FORKS);
21: // è·å¾—è°ƒç”¨è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º DEFAULT_TIMEOUT = 1000 æ¯«ç§’
22: final int timeout = getUrl().getParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);
23: // è‹¥æœ€å¤§å¹¶è¡Œä¹¦å°äºç­‰äº 0ï¼Œæˆ–è€…å¤§äº invokers çš„æ•°é‡ï¼Œç›´æ¥ä½¿ç”¨ invokers
24: if (forks <= 0 || forks >= invokers.size()) {
25: selected = invokers;
26: } else {
27: // å¾ªç¯ï¼Œæ ¹æ®è´Ÿè½½å‡è¡¡æœºåˆ¶ä» invokersï¼Œä¸­é€‰æ‹©ä¸€ä¸ªä¸ªInvoker ï¼Œä»è€Œç»„æˆ Invoker é›†åˆã€‚
28: // æ³¨æ„ï¼Œå› ä¸ºå¢åŠ äº†æ’é‡é€»è¾‘ï¼Œæ‰€ä»¥ä¸èƒ½ä¿è¯è·å¾—çš„ Invoker é›†åˆçš„å¤§å°ï¼Œå°äºæœ€å¤§å¹¶è¡Œæ•°
29: selected = new ArrayList<Invoker<T>>();
30: for (int i = 0; i < forks; i++) {
31: // åœ¨invokeråˆ—è¡¨(æ’é™¤selected)å,å¦‚æœæ²¡æœ‰é€‰å¤Ÿ,åˆ™å­˜åœ¨é‡å¤å¾ªç¯é—®é¢˜.è§selectå®ç°.
32: Invoker<T> invoker = select(loadbalance, invocation, invokers, selected);
33: if (!selected.contains(invoker)) { //Avoid add the same invoker several times. //é˜²æ­¢é‡å¤æ·»åŠ invoker
34: selected.add(invoker);
35: }
36: }
37: }
38: // è®¾ç½®å·²ç»è°ƒç”¨çš„ Invoker é›†åˆï¼Œåˆ° Context ä¸­
39: RpcContext.getContext().setInvokers((List) selected);
40: // å¼‚å¸¸è®¡æ•°å™¨
41: final AtomicInteger count = new AtomicInteger();
42: // åˆ›å»ºé˜»å¡é˜Ÿåˆ—
43: final BlockingQueue<Object> ref = new LinkedBlockingQueue<Object>();
44: // å¾ªç¯ selected é›†åˆï¼Œæäº¤çº¿ç¨‹æ± ï¼Œå‘èµ· RPC è°ƒç”¨
45: for (final Invoker<T> invoker : selected) {
46: executor.execute(new Runnable() {
47: public void run(){
48: try {
49: // RPC è°ƒç”¨ï¼Œè·å¾— Result ç»“æœ
50: Result result = invoker.invoke(invocation);
51: // æ·»åŠ  Result åˆ° `ref` é˜»å¡é˜Ÿåˆ—
52: ref.offer(result);
53: } catch (Throwable e) {
54: // å¼‚å¸¸è®¡æ•°å™¨ + 1
55: int value = count.incrementAndGet();
56: // è‹¥ RPC è°ƒç”¨ç»“æœéƒ½æ˜¯å¼‚å¸¸ï¼Œåˆ™æ·»åŠ å¼‚å¸¸åˆ° `ref` é˜»å¡é˜Ÿåˆ—
57: if (value >= selected.size()) {
58: ref.offer(e);
59: }
60: }
61: }
62: });
63: }
64: try {
65: // ä» `ref` é˜Ÿåˆ—ä¸­ï¼Œé˜»å¡ç­‰å¾…ç»“æœ
66: Object ret = ref.poll(timeout, TimeUnit.MILLISECONDS);
67: // è‹¥æ˜¯å¼‚å¸¸ç»“æœï¼ŒæŠ›å‡º RpcException å¼‚å¸¸
68: if (ret instanceof Throwable) {
69: Throwable e = (Throwable) ret;
70: throw new RpcException(e instanceof RpcException ? ((RpcException) e).getCode() : 0, "Failed to forking invoke provider " + selected + ", but no luck to perform the invocation. Last error is: " + e.getMessage(), e.getCause() != null ? e.getCause() : e);
71: }
72: // è‹¥æ˜¯æ­£å¸¸ç»“æœï¼Œç›´æ¥è¿”å›
73: return (Result) ret;
74: } catch (InterruptedException e) {
75: throw new RpcException("Failed to forking invoke provider " + selected + ", but no luck to perform the invocation. Last error is: " + e.getMessage(), e);
76: }
77: }
78:
79: }
```

- ç¬¬ 15 è‡³ 39 è¡Œï¼šèƒ–å‹è‡ªå·±çœ‹ä»£ç æ³¨é‡Šï¼Œæ¯”è¾ƒæ˜“æ‡‚ã€‚
- ç¬¬ 41 è¡Œï¼š

count
å˜é‡ï¼Œ**å¼‚å¸¸**è®¡æ•°å™¨ã€‚

- ç¬¬ 43 è¡Œï¼š

ref
å˜é‡ï¼Œé˜»å¡é˜Ÿåˆ—ã€‚é€šè¿‡å®ƒï¼Œå®ç°çº¿ç¨‹æ± å¼‚æ­¥æ‰§è¡Œä»»åŠ¡çš„**ç»“æœé€šçŸ¥**ï¼Œéå¸¸äº®çœ¼ã€‚

- ç¬¬ 44 è‡³ 63 è¡Œï¼šå¾ªç¯

selected
é›†åˆï¼Œæäº¤çº¿ç¨‹æ± ï¼Œå‘èµ· RPC è°ƒç”¨ã€‚

- ç¬¬ 49 è‡³ 52 è¡Œï¼šè°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼ŒRPC è°ƒç”¨ï¼Œ**æˆåŠŸ**è·å¾— Result ç»“æœï¼Œå¹¶å°† Result æ·»åŠ åˆ°

ref
é˜»å¡é˜Ÿåˆ—ä¸­ã€‚

- ç¬¬ 53 è‡³ 59 è¡Œï¼šè‹¥è°ƒç”¨**å¤±è´¥**ï¼Œå¼‚å¸¸è®¡æ•°å™¨

count
åŠ ä¸€ã€‚å½“æ‰€æœ‰çš„ RPC è°ƒç”¨éƒ½å®Œæˆï¼Œå¹¶ä¸”éƒ½æ˜¯å¼‚å¸¸æ—¶ï¼Œåˆ™æ·»åŠ **æœ€åä¸€ä¸ª**å¼‚å¸¸åˆ°

ref
é˜»å¡é˜Ÿåˆ—ã€‚ğŸ™‚ ç»†èŠ‚å¤„ç†å¾ˆåˆ°ä½ã€‚

- ç¬¬ 66 è¡Œï¼šä»

ref
é˜Ÿåˆ—ä¸­ï¼Œ**é˜»å¡**ç­‰å¾…ï¼Œç›´åˆ°è·å¾—åˆ°ç»“æœæˆ–è€…è¶…æ—¶ã€‚è‡³æ­¤ï¼ŒForkingClusterInvoker å®ç°äº†å¹¶è¡Œè°ƒç”¨ï¼Œä¸”åªè¦ä¸€ä¸ªæˆåŠŸå³è¿”å›ã€‚å½“ç„¶ï¼Œè¿˜æœ‰ä¸€ä¸ªéšæ€§çš„ï¼Œ**æ‰€æœ‰éƒ½å¤±è´¥æ‰è¿”å›**ã€‚

- ç¬¬ 67 è‡³ 76 è¡Œï¼šå¤„ç†ç­‰å¾…çš„â€œç»“æœâ€ã€‚

# 8. FailoverCluster

FailoverCluster ï¼Œåœ¨ [ã€Šç²¾å°½ Dubbo æºç è§£æ â€”â€” é›†ç¾¤å®¹é”™ï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹](http://svip.iocoder.cn/Dubbo/cluster-1-api-interface//?self) ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å·²ç»è¯¦ç»†è§£æã€‚

# 9. MergeableCluster

MergeableCluster ï¼Œå¯¹åº” [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” åˆ†ç»„èšåˆã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/group-merger.html) æ–‡æ¡£ï¼Œæˆ‘ä»¬åç»­å•ç‹¬å†™æ–‡ç« åˆ†äº«ã€‚

# 10. MockClusterWrapper

MockClusterWrapper ï¼Œå¯¹åº” [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€”æœ¬åœ°ä¼ªè£… ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/local-mock.html) æ–‡æ¡£ï¼Œæˆ‘ä»¬åç»­å•ç‹¬å†™æ–‡ç« åˆ†äº«ã€‚
