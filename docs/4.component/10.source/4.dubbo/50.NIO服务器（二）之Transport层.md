# NIO æœåŠ¡å™¨ï¼ˆäºŒï¼‰ä¹‹ Transport å±‚

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡æ¥ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” NIO æœåŠ¡å™¨ï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹](http://svip.iocoder.cn/Dubbo/remoting-api-interface/?self) ä¸€æ–‡ï¼Œåˆ†äº«

dubbo-remoting-api
æ¨¡å—ï¼Œ

transport
åŒ…ï¼Œ**ç½‘ç»œä¼ è¾“å±‚**ã€‚
**transport** ç½‘ç»œä¼ è¾“å±‚ï¼šæŠ½è±¡ mina å’Œ netty ä¸ºç»Ÿä¸€æ¥å£ï¼Œä»¥ Message ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸º Channel, Transporter, Client, Server, Codec

æ¶‰åŠçš„ç±»å›¾å¦‚ä¸‹ï¼š

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_12_04/01.png)

- ç™½è‰²éƒ¨åˆ†ï¼Œä¸ºé€šç”¨æ¥å£ã€‚
- è“è‰²éƒ¨åˆ†ï¼Œä¸º

transport
åŒ…ä¸‹çš„ç±»ã€‚

- æ•´ä¸ªç±»å›¾ï¼Œæˆ‘ä»¬åˆ†æˆ**å…­ä¸ª**éƒ¨åˆ†ï¼š

- Client
- Server
- Channel
- ChannelHandler
- Codec
- Dispacher
- ä»æµç¨‹ä¸Šæ¥è¯´ï¼Œæˆ‘ä»¬åˆ†æˆï¼š

- Server

- å¯åŠ¨
- å…³é—­
- Client

- å¯åŠ¨
- å…³é—­
- ChannelHandler

- å¤„ç†è¿æ¥
- å¤„ç†æ–­å¼€
- å‘é€æ¶ˆæ¯
- æ¥æ”¶æ¶ˆæ¯
- å¤„ç†å¼‚å¸¸
  è‰¿è‰¿çš„æ—ç™½ï¼šæ¶‰åŠè¾ƒå¤šç±»å’Œæµç¨‹ï¼Œå†…å®¹ä¸æ˜¯å¾ˆçº¿æ€§ï¼Œå¯èƒ½åˆ†äº«çš„æ¯”è¾ƒå‡Œä¹±ï¼Œè¿˜æœ›èƒ–å‹è°…è§£ã€‚å»ºè®®ï¼Œè¯» 2-3 éï¼Œå¹¶ä¸”åšä¸€äº›è°ƒè¯•ã€‚

# 2. AbstractPeer

[
com.alibaba.dubbo.remoting.transport.AbstractPeer
](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractPeer.java) ï¼Œå®ç° Endpointã€ChannelHandler æ¥å£ï¼Œ**Peer** æŠ½è±¡ç±»ã€‚

**æ„é€ æ–¹æ³•**

```
1: //*/*
2: /* é€šé“å¤„ç†å™¨
3: /*/
4: private final ChannelHandler handler;
5: //*/*
6: /* URL
7: /*/
8: private volatile URL url;
9: //*/*
10: /* æ­£åœ¨å…³é—­
11: /*
12: /* {@link /#startClose()}
13: /*/
14: // closing closed means the process is being closed and close is finished
15: private volatile boolean closing;
16: //*/*
17: /* å…³é—­å®Œæˆ
18: /*
19: /* {@link /#close()}
20: /*/
21: private volatile boolean closed;
22:
23: public AbstractPeer(URL url, ChannelHandler handler){
24: if (url == null) {
25: throw new IllegalArgumentException("url == null");
26: }
27: if (handler == null) {
28: throw new IllegalArgumentException("handler == null");
29: }
30: this.url = url;
31: this.handler = handler;
32: }
```

- handler
  å±æ€§ï¼Œé€šé“å¤„ç†å™¨ï¼Œé€šè¿‡æ„é€ æ–¹æ³•ä¼ å…¥ã€‚å®ç°çš„ ChannelHandler çš„æ¥å£æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨

handler
çš„æ–¹æ³•ï¼Œè¿›è¡Œæ‰§è¡Œé€»è¾‘å¤„ç†ã€‚

- å‚è§ä»£ç ï¼š[ä¼ é€é—¨](https://github.com/YunaiV/dubbo/blob/7fad710c2dbf66356d5e7b7995e843b8f6225652/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractPeer.java#L114-L141)
- è¿™ç§æ–¹å¼åœ¨è®¾è®¡æ¨¡å¼ä¸­è¢«ç§°ä½œ â€œ[è£…é¥°æ¨¡å¼](https://www.cnblogs.com/java-my-life/archive/2012/04/20/2455726.html)â€œ ã€‚åœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°**å¤§é‡çš„**è£…é¥°æ¨¡å¼çš„ä½¿ç”¨ã€‚å®é™…ä¸Šï¼Œè¿™ä¹Ÿæ˜¯

dubbo-remoting
æŠ½è±¡ API + å®ç°æœ€æ ¸å¿ƒçš„æ–¹å¼ä¹‹ä¸€ã€‚

- url
  å±æ€§ï¼ŒURL ï¼Œé€šè¿‡æ„é€ æ–¹æ³•ä¼ å…¥ã€‚é€šè¿‡è¯¥å±æ€§ï¼Œä¼ é€’ Dubbo æœåŠ¡å¼•ç”¨å’ŒæœåŠ¡æš´éœ²çš„**é…ç½®é¡¹**ã€‚
- closing
  å±æ€§ï¼Œæ­£åœ¨å…³é—­ï¼Œè°ƒç”¨

/#startClose()
æ–¹æ³•ï¼Œå˜æ›´ã€‚

- close
  å±æ€§ï¼Œå…³é—­å®Œæˆï¼Œè°ƒç”¨

/#close()
æ–¹æ³•ï¼Œå˜æ›´ã€‚

**å‘é€æ¶ˆæ¯**

```
@Override
public void send(Object message) throws RemotingException{
send(message, url.getParameter(Constants.SENT_KEY, false));
}
```

- sent
  é…ç½®é¡¹ï¼š

- true
  ç­‰å¾…æ¶ˆæ¯å‘å‡ºï¼Œæ¶ˆæ¯å‘é€å¤±è´¥å°†æŠ›å‡ºå¼‚å¸¸ã€‚
- false
  ä¸ç­‰å¾…æ¶ˆæ¯å‘å‡ºï¼Œå°†æ¶ˆæ¯æ”¾å…¥ IO é˜Ÿåˆ—ï¼Œå³åˆ»è¿”å›ã€‚
- è¯¦ç»†å‚è§ï¼š[ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” å¼‚æ­¥è°ƒç”¨ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/async-call.html)

**å…¶ä»–æ–¹æ³•**

èƒ–å‹ç‚¹å‡» [AbstractPeer](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractPeer.java) ï¼Œå†çœ‹çœ‹**æ‰€æœ‰**çš„æ–¹æ³•ã€‚

## 2.1 AbstractEndpint

[
com.alibaba.dubbo.remoting.transport.AbstractPeer.AbstractEndpint
](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractEndpoint.java) ï¼Œå®ç° Resetable æ¥å£ï¼Œç»§æ‰¿ AbstractPeer æŠ½è±¡ç±»ï¼Œ**ç«¯ç‚¹**æŠ½è±¡ç±»ã€‚

**æ„é€ æ–¹æ³•**

```
1: //*/*
2: /* ç¼–è§£ç å™¨
3: /*/
4: private Codec2 codec;
5: //*/*
6: /* è¶…æ—¶æ—¶é—´
7: /*/
8: private int timeout;
9: //*/*
10: /* è¿æ¥è¶…æ—¶æ—¶é—´
11: /*/
12: private int connectTimeout;
13:
14: public AbstractEndpoint(URL url, ChannelHandler handler){
15: super(url, handler);
16: this.codec = getChannelCodec(url);
17: this.timeout = url.getPositiveParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);
18: this.connectTimeout = url.getPositiveParameter(Constants.CONNECT_TIMEOUT_KEY, Constants.DEFAULT_CONNECT_TIMEOUT);
19: }
```

- codec
  å±æ€§ï¼Œç¼–è§£ç å™¨ã€‚åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨

/#getChannelCodec(url)
æ–¹æ³•ï¼ŒåŸºäº

url
å‚æ•°ï¼ŒåŠ è½½å¯¹åº”çš„ Codec å®ç°å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: protected static Codec2 getChannelCodec(URL url){
2: String codecName = url.getParameter(Constants.CODEC_KEY, "telnet");
3: if (ExtensionLoader.getExtensionLoader(Codec2.class).hasExtension(codecName)) { // ä¾‹å¦‚ï¼Œåœ¨ DubboProtocol ä¸­ï¼Œä¼šè·å¾— DubboCodec
4: return ExtensionLoader.getExtensionLoader(Codec2.class).getExtension(codecName);
5: } else {
6: return new CodecAdapter(ExtensionLoader.getExtensionLoader(Codec.class).getExtension(codecName));
7: }
8: }
```

- ç¬¬ 3 è¡Œï¼šåŸºäº Dubbo SPI æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Codec å®ç°å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œåœ¨ DubboProtocol ä¸­ï¼Œä¼šè·å¾— [DubboCodec](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-rpc/dubbo-rpc-dubbo/src/main/java/com/alibaba/dubbo/rpc/protocol/dubbo/DubboCodec.java) å¯¹è±¡ã€‚
- ç¬¬ 6 è¡Œï¼šCodec æ¥å£ï¼Œå·²ç»åºŸå¼ƒäº†ï¼Œç›®å‰ Dubbo é¡¹ç›®é‡Œï¼Œä¹Ÿæ²¡æœ‰å®ƒçš„æ‹“å±•å®ç°ã€‚

**é‡ç½®å±æ€§**

[
/#reset(url)
](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractEndpoint.java#L60-L92) **å®ç°**æ–¹æ³•ï¼Œä½¿ç”¨æ–°çš„

url
å±æ€§ï¼Œå¯é‡ç½®

codec

timeout

connectTimeout
å±æ€§ã€‚ğŸ™‚ å·²ç»æ·»åŠ äº†è°…è§£ï¼Œèƒ–å‹ç‚¹å‡»å¯çœ‹ã€‚

# 3. Client

## 3.1 AbstractClient

[
com.alibaba.dubbo.remoting.transport.AbstractClient
](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractClient.java) ï¼Œå®ç° Client æ¥å£ï¼Œç»§æ‰¿ AbstractEndpoint æŠ½è±¡ç±»ï¼Œ**å®¢æˆ·ç«¯**æŠ½è±¡ç±»ï¼Œ**é‡ç‚¹**å®ç°äº†å…¬ç”¨çš„é‡è¿é€»è¾‘ï¼ŒåŒæ—¶æŠ½è±¡äº†è¿æ¥ç­‰æ¨¡æ¿æ–¹æ³•ï¼Œä¾›å­ç±»å®ç°ã€‚æŠ½è±¡æ–¹æ³•å¦‚ä¸‹ï¼š

```
protected abstract void doOpen() throws Throwable;
protected abstract void doClose() throws Throwable;
protected abstract void doConnect() throws Throwable;
protected abstract void doDisConnect() throws Throwable;
protected abstract Channel getChannel();
```

**æ„é€ æ–¹æ³•**

```
1: //*/*
2: /* é‡è¿å®šæ—¶ä»»åŠ¡æ‰§è¡Œå™¨
3: /*/
4: private static final ScheduledThreadPoolExecutor reconnectExecutorService = new ScheduledThreadPoolExecutor(2, new NamedThreadFactory("DubboClientReconnectTimer", true));
5: //*/*
6: /* å‘é€æ¶ˆæ¯æ—¶ï¼Œè‹¥æ–­å¼€ï¼Œæ˜¯å¦é‡è¿
7: /*/
8: private final boolean send_reconnect;
9: //*/*
10: /* é‡è¿ warning çš„é—´éš”.(waringå¤šå°‘æ¬¡ä¹‹åï¼Œwarningä¸€æ¬¡) //for test
11: /*/
12: // reconnect warning period. Reconnect warning interval (log warning after how many times) //for test
13: private final int reconnect_warning_period;
14: //*/*
15: /* å…³é—­è¶…æ—¶æ—¶é—´
16: /*/
17: private final long shutdown_timeout;
18: //*/*
19: /* çº¿ç¨‹æ± 
20: /*
21: /* åœ¨è°ƒç”¨ {@link /#wrapChannelHandler(URL, ChannelHandler)} æ—¶ï¼Œä¼šè°ƒç”¨ {@link com.alibaba.dubbo.remoting.transport.dispatcher.WrappedChannelHandler} åˆ›å»º
22: /*/
23: protected volatile ExecutorService executor;
24:
25: public AbstractClient(URL url, ChannelHandler handler) throws RemotingException{
26: super(url, handler);
27: // ä» URL ä¸­ï¼Œè·å¾—é‡è¿ç›¸å…³é…ç½®é¡¹
28: send_reconnect = url.getParameter(Constants.SEND_RECONNECT_KEY, false);
29: shutdown_timeout = url.getParameter(Constants.SHUTDOWN_TIMEOUT_KEY, Constants.DEFAULT_SHUTDOWN_TIMEOUT);
30: // The default reconnection interval is 2s, 1800 means warning interval is 1 hour.
31: reconnect_warning_period = url.getParameter("reconnect.waring.period", 1800);
32:
33: // åˆå§‹åŒ–å®¢æˆ·ç«¯
34: try {
35: doOpen();
36: } catch (Throwable t) {
37: close(); // å¤±è´¥ï¼Œåˆ™å…³é—­
38: throw new RemotingException(url.toInetSocketAddress(), null,
39: "Failed to start " + getClass().getSimpleName() + " " + NetUtils.getLocalAddress()
40: + " connect to the server " + getRemoteAddress() + ", cause: " + t.getMessage(), t);
41: }
42:
43: // è¿æ¥æœåŠ¡å™¨
44: try {
45: // connect.
46: connect();
47: if (logger.isInfoEnabled()) {
48: logger.info("Start " + getClass().getSimpleName() + " " + NetUtils.getLocalAddress() + " connect to the server " + getRemoteAddress());
49: }
50: } catch (RemotingException t) {
51: if (url.getParameter(Constants.CHECK_KEY, true)) {
52: close(); // å¤±è´¥ï¼Œåˆ™å…³é—­
53: throw t;
54: } else {
55: logger.warn("Failed to start " + getClass().getSimpleName() + " " + NetUtils.getLocalAddress()
56: + " connect to the server " + getRemoteAddress() + " (check == false, ignore and retry later!), cause: " + t.getMessage(), t);
57: }
58: } catch (Throwable t) {
59: close(); // å¤±è´¥ï¼Œåˆ™å…³é—­
60: throw new RemotingException(url.toInetSocketAddress(), null,
61: "Failed to start " + getClass().getSimpleName() + " " + NetUtils.getLocalAddress()
62: + " connect to the server " + getRemoteAddress() + ", cause: " + t.getMessage(), t);
63: }
64:
65: // è·å¾—çº¿ç¨‹æ± 
66: executor = (ExecutorService) ExtensionLoader.getExtensionLoader(DataStore.class).getDefaultExtension()
67: .get(Constants.CONSUMER_SIDE, Integer.toString(url.getPort()));
68: ExtensionLoader.getExtensionLoader(DataStore.class).getDefaultExtension()
69: .remove(Constants.CONSUMER_SIDE, Integer.toString(url.getPort()));
70: }
```

- reconnectExecutorService
  å±æ€§ï¼Œé‡è¿å®šæ—¶ä»»åŠ¡æ‰§è¡Œå™¨ã€‚åœ¨å®¢æˆ·ç«¯è¿æ¥æœåŠ¡ç«¯æ—¶ï¼Œä¼šåˆ›å»ºåå°ä»»åŠ¡ï¼Œå®šæ—¶æ£€æŸ¥è¿æ¥ï¼Œè‹¥æ–­å¼€ï¼Œä¼šè¿›è¡Œé‡è¿ã€‚
- ç¬¬ 27 è‡³ 31 è¡Œï¼šä» URL ä¸­ï¼Œè·å¾—é‡è¿ç›¸å…³**é…ç½®é¡¹**ã€‚
- ç¬¬ 33 è‡³ 41 è¡Œï¼šè°ƒç”¨

/#doOpen()
**æŠ½è±¡**æ–¹æ³•ï¼Œåˆå§‹åŒ–å®¢æˆ·ç«¯ã€‚è‹¥å¼‚å¸¸ï¼Œè°ƒç”¨

/#close()
æ–¹æ³•ï¼Œè¿›è¡Œå…³é—­ã€‚

- ç¬¬ 43 è‡³ 63 è¡Œï¼šè°ƒç”¨

/#connect()
**å®ç°**æ–¹æ³•ï¼Œè¿æ¥æœåŠ¡å™¨ã€‚è‹¥å¼‚å¸¸ï¼Œè°ƒç”¨

/#close()
æ–¹æ³•ï¼Œè¿›è¡Œå…³é—­ã€‚

- ç¬¬ 51 è‡³ 57 è¡Œï¼šè‹¥æ˜¯è¿æ¥å¤±è´¥ RemotingException ï¼Œè‹¥å¼€å¯äº† [å¯åŠ¨æ—¶æ£€æŸ¥](http://dubbo.apache.org/zh-cn/docs/user/demos/preflight-check.html) ï¼Œåˆ™è°ƒç”¨

/#close()
æ–¹æ³•ï¼Œè¿›è¡Œå…³é—­ã€‚

- ç¬¬ 66 è‡³ 69 è¡Œï¼šä» [DataStore](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-common/src/main/java/com/alibaba/dubbo/common/store/DataStore.java) ä¸­ï¼Œè·å¾—çº¿ç¨‹æ± ã€‚

- DataStore åœ¨

dubbo-common
æ¨¡å—ï¼Œ[
store
](https://github.com/YunaiV/dubbo/tree/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-common/src/main/java/com/alibaba/dubbo/common/store) åŒ…ä¸‹å®ç°ã€‚ç›®å‰çš„å®ç°æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯

ConcurrentMap<String, ConcurrentMap<String, Object>>
çš„é›†åˆã€‚èƒ–å‹å¯ä»¥è‡ªå·±çœ‹ç›¸å…³å®ç°ã€‚

- æ­¤å¤„çš„çº¿ç¨‹æ± ï¼Œå®é™…å°±æ˜¯ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” çº¿ç¨‹æ¨¡å‹ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/thread-model.html) ä¸­è¯´çš„**çº¿ç¨‹æ± **ã€‚åœ¨ [ã€Œ8. Dispacherã€](http://svip.iocoder.cn/Dubbo/remoting-api-transport/) ä¸­ï¼Œè¯¦ç»†è§£æã€‚

**è¿æ¥æœåŠ¡å™¨**

```
//*/*
/* è¿æ¥é”ï¼Œç”¨äºå®ç°å‘èµ·è¿æ¥å’Œæ–­å¼€è¿æ¥äº’æ–¥ï¼Œé¿å…å¹¶å‘ã€‚
/*/
private final Lock connectLock = new ReentrantLock();
1: protected void connect() throws RemotingException{
2: // è·å¾—é”
3: connectLock.lock();
4: try {
5: // å·²è¿æ¥ï¼Œ
6: if (isConnected()) {
7: return;
8: }
9: // åˆå§‹åŒ–é‡è¿çº¿ç¨‹
10: initConnectStatusCheckCommand();
11: // æ‰§è¡Œè¿æ¥
12: doConnect();
13: // è¿æ¥å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸
14: if (!isConnected()) {
15: throw new RemotingException(this, "Failed connect to server " + getRemoteAddress() + " from " + getClass().getSimpleName() + " "
16: + NetUtils.getLocalHost() + " using dubbo version " + Version.getVersion()
17: + ", cause: Connect wait timeout: " + getTimeout() + "ms.");
18: // è¿æ¥æˆåŠŸï¼Œæ‰“å°æ—¥å¿—
19: } else {
20: if (logger.isInfoEnabled()) {
21: logger.info("Successed connect to server " + getRemoteAddress() + " from " + getClass().getSimpleName() + " "
22: + NetUtils.getLocalHost() + " using dubbo version " + Version.getVersion()
23: + ", channel is " + this.getChannel());
24: }
25: }
26: // è®¾ç½®é‡è¿æ¬¡æ•°å½’é›¶
27: reconnect_count.set(0);
28: // è®¾ç½®æœªæ‰“å°è¿‡é”™è¯¯æ—¥å¿—
29: reconnect_error_log_flag.set(false);
30: } catch (RemotingException e) {
31: throw e;
32: } catch (Throwable e) {
33: throw new RemotingException(this, "Failed connect to server " + getRemoteAddress() + " from " + getClass().getSimpleName() + " "
34: + NetUtils.getLocalHost() + " using dubbo version " + Version.getVersion()
35: + ", cause: " + e.getMessage(), e);
36: } finally {
37: // é‡Šæ”¾é”
38: connectLock.unlock();
39: }
40: }
```

- ç¬¬ 3 è¡Œï¼šè·å¾—é”ã€‚åœ¨è¿æ¥å’Œæ–­å¼€è¿æ¥æ—¶ï¼Œé€šè¿‡é”ï¼Œé¿å…å¹¶å‘å†²çªã€‚
- ç¬¬ 5 è‡³ 8 è¡Œï¼šè°ƒç”¨

/#isConnected()
æ–¹æ³•ï¼Œåˆ¤æ–­è¿æ¥çŠ¶æ€ã€‚è‹¥å·²ç»è¿æ¥ï¼Œå°±ä¸é‡å¤è¿æ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@Override
public boolean isConnected(){
Channel channel = getChannel();
return channel != null && channel.isConnected();
}
```

- è¯¥æ–¹æ³•ï¼Œæ˜¯å› ä¸ºå®ç° Channel æ¥å£( Client å®ç° Channel æ¥å£ )ï¼Œæ‰€ä»¥éœ€è¦å®ç°çš„ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®é™…æ–¹æ³•å†…éƒ¨ï¼Œè°ƒç”¨çš„æ˜¯

channel
å¯¹è±¡ï¼Œè¿›è¡Œåˆ¤æ–­ã€‚å…¶å®ƒå®ç° Channel çš„æ–¹æ³•ï¼Œä¹Ÿæ˜¯è¿™ä¹ˆå¤„ç†çš„ï¼Œä¾‹å¦‚ [
/#getAttribute(key)
](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractClient.java#L194-L245) ç­‰æ–¹æ³•ã€‚

- ç¬¬ 10 è¡Œï¼šè°ƒç”¨

/#initConnectStatusCheckCommand()
æ–¹æ³•ï¼Œåˆå§‹åŒ–é‡è¿**çº¿ç¨‹**ã€‚

- ğŸ™‚ æ–¹æ³•ä¼šå¤æ‚ä¸€äº›ï¼Œä¸æ‚ç³…åœ¨è¿™é‡Œè®²ã€‚
- ç¬¬ 14 è‡³ 17 è¡Œï¼šè¿æ¥å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ RemotingException ã€‚
- ç¬¬ 18 è‡³ 25 è¡Œï¼šè¿æ¥æˆåŠŸï¼Œæ‰“å°æ—¥å¿—ã€‚
- ç¬¬ 26 è‡³ 29 è¡Œï¼šè®¾ç½®é‡è¿æ¬¡æ•°å½’é›¶ï¼Œæ‰“å°è¿‡é”™è¯¯æ—¥å¿—çŠ¶æ€ä¸ºå¦ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è¿™äº›çŠ¶æ€å­—æ®µçš„å˜æ›´ã€‚
- ç¬¬ 38 è¡Œï¼šé‡Šæ”¾é”ã€‚

**åˆå§‹åŒ–é‡è¿çº¿ç¨‹**

```
//*/*
/* é‡è¿æ¬¡æ•°
/*/
private final AtomicInteger reconnect_count = new AtomicInteger(0);
//*/*
/* é‡è¿æ—¶ï¼Œæ˜¯å¦å·²ç»æ‰“å°è¿‡é”™è¯¯æ—¥å¿—ã€‚
/*/
// Reconnection error log has been called before?
private final AtomicBoolean reconnect_error_log_flag = new AtomicBoolean(false);
//*/*
/* é‡è¿æ‰§è¡Œä»»åŠ¡ Future
/*/
private volatile ScheduledFuture<?> reconnectExecutorFuture = null;
//*/*
/* æœ€åæˆåŠŸè¿æ¥æ—¶é—´
/*/
// the last successed connected time
private long lastConnectedTime = System.currentTimeMillis();
1: private synchronized void initConnectStatusCheckCommand(){
2: //reconnect=false to close reconnect
3: // è·å¾—è·å¾—é‡è¿é¢‘ç‡ï¼Œé»˜è®¤å¼€å¯ã€‚
4: int reconnect = getReconnectParam(getUrl());
5: // è‹¥å¼€å¯é‡è¿åŠŸèƒ½ï¼Œåˆ›å»ºé‡è¿çº¿ç¨‹
6: if (reconnect > 0 && (reconnectExecutorFuture == null || reconnectExecutorFuture.isCancelled())) {
7: // åˆ›å»º Runnable å¯¹è±¡
8: Runnable connectStatusCheckCommand = new Runnable() {
9: public void run(){
10: try {
11: // æœªè¿æ¥ï¼Œé‡è¿
12: if (!isConnected()) {
13: connect();
14: // å·²è¿æ¥ï¼Œè®°å½•æœ€åè¿æ¥æ—¶é—´
15: } else {
16: lastConnectedTime = System.currentTimeMillis();
17: }
18: } catch (Throwable t) {
19: // è¶…è¿‡ä¸€å®šæ—¶é—´æœªè¿æ¥ä¸Šï¼Œæ‰æ‰“å°å¼‚å¸¸æ—¥å¿—ã€‚å¹¶ä¸”ï¼Œä»…æ‰“å°ä¸€æ¬¡ã€‚é»˜è®¤ï¼Œ15 åˆ†é’Ÿã€‚
20: String errorMsg = "client reconnect to " + getUrl().getAddress() + " find error . url: " + getUrl();
21: // wait registry sync provider list
22: if (System.currentTimeMillis() - lastConnectedTime > shutdown_timeout) {
23: if (!reconnect_error_log_flag.get()) {
24: reconnect_error_log_flag.set(true);
25: logger.error(errorMsg, t);
26: return;
27: }
28: }
29: // æ¯ä¸€å®šæ¬¡å‘ç°æœªé‡è¿ï¼Œæ‰æ‰“å°å‘Šè­¦æ—¥å¿—ã€‚é»˜è®¤ï¼Œ1800 æ¬¡ï¼Œ1 å°æ—¶ã€‚
30: if (reconnect_count.getAndIncrement() % reconnect_warning_period == 0) {
31: logger.warn(errorMsg, t);
32: }
33: }
34: }
35: };
36: // å‘èµ·å®šæ—¶ä»»åŠ¡
37: reconnectExecutorFuture = reconnectExecutorService.scheduleWithFixedDelay(connectStatusCheckCommand, reconnect, reconnect, TimeUnit.MILLISECONDS);
38: }
39: }
```

- ç¬¬ 4 è¡Œï¼šè°ƒç”¨ [
  /#getReconnectParam(url)
  ](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractClient.java#L120-L142) æ–¹æ³•ï¼Œè·å¾—é‡è¿é¢‘ç‡ã€‚é»˜è®¤å¼€å¯ï¼Œ2000 æ¯«ç§’ã€‚

- ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±ç‚¹å‡»æ–¹æ³•æŸ¥çœ‹ã€‚
- ç¬¬ 6 è‡³ 38 è¡Œï¼šè‹¥**å¼€å¯**é‡è¿åŠŸèƒ½ï¼Œ åˆ›å»ºé‡è¿çº¿ç¨‹ã€‚

- ç¬¬ 8 è‡³ 35 è¡Œï¼šåˆ›å»º Runnable å¯¹è±¡ã€‚

- ç¬¬ 11 è‡³ 13 è¡Œï¼šæœªè¿æ¥æ—¶ï¼Œè°ƒç”¨

/#connect()
æ–¹æ³•ï¼Œè¿›è¡Œé‡è¿ã€‚

- ç¬¬ 14 è‡³ 17 è¡Œï¼šå·²è¿æ¥æ—¶ï¼Œè®°å½•æœ€åè¿æ¥æ—¶é—´ã€‚
- ç¬¬ 18 è‡³ 33 è¡Œï¼š**ç¬¦åˆ**æ¡ä»¶æ—¶ï¼Œæ‰“å°**é”™è¯¯**æˆ–**å‘Šè­¦**æ—¥å¿—ã€‚ä¸ºä»€ä¹ˆè¦ç¬¦åˆæ¡ä»¶æ‰æ‰“å°å‘¢ï¼Ÿä¹‹å‰ä¹Ÿå’Œæœ‹å‹èŠèµ·æ¥è¿‡ï¼Œçº¿ä¸Šå› ä¸ºä¸­é—´ä»¶ç»„ä»¶ï¼Œæ‰“å°äº†å¤ªå¤šçš„æ—¥å¿—ï¼Œç»“æœæ•´ä¸ª JVM å´©äº†ã€‚ç‰¹åˆ«åœ¨ç½‘ç»œåœºæ™¯ + å¤§é‡â€œæ— é™â€é‡è¯•çš„åœºæ™¯ï¼Œç‰¹åˆ«å®¹æ˜“æ‰“å‡ºæ»¡å±çš„æ—¥å¿—ã€‚è¿™å—ï¼Œæˆ‘ä»¬å¯ä»¥å­¦ä¹ ä¸‹ã€‚å¦å¤–ï¼ŒEureka åœ¨é›†ç¾¤åŒæ­¥ï¼Œä¹Ÿæœ‰ç±»ä¼¼å¤„ç†ã€‚
- ç¬¬ 36 è¡Œï¼šå‘èµ·ä»»åŠ¡ï¼Œ**å®šæ—¶**æ£€æŸ¥ï¼Œæ˜¯å¦éœ€è¦é‡è¿ã€‚
- reconnect=false to close reconnect
  ï¼Œä»ç›®å‰ä»£ç ä¸Šæ¥çœ‹ï¼Œæœªå®ç°

/#reset(url)
æ–¹æ³•ï¼Œåœ¨ URL çš„

reconnect=false
é…ç½®é¡¹æ—¶ï¼Œå…³é—­é‡è¿çº¿ç¨‹ã€‚

**å‘é€æ¶ˆæ¯**

```
@Override
public void send(Object message, boolean sent) throws RemotingException{
// æœªè¿æ¥æ—¶ï¼Œå¼€å¯é‡è¿åŠŸèƒ½ï¼Œåˆ™å…ˆå‘èµ·è¿æ¥
if (send_reconnect && !isConnected()) {
connect();
}
// å‘é€æ¶ˆæ¯
Channel channel = getChannel();
//TODO Can the value returned by getChannel() be null? need improvement.
if (channel == null || !channel.isConnected()) {
throw new RemotingException(this, "message can not send, because channel is closed . url:" + getUrl());
}
channel.send(message, sent);
}
```

**åŒ…è£…é€šé“å¤„ç†å™¨**

```
// Constants.java
public static final String DEFAULT_CLIENT_THREADPOOL = "cached";
protected static final String CLIENT_THREAD_POOL_NAME = "DubboClientHandler";
1: //*/*
2: /* åŒ…è£…é€šé“å¤„ç†å™¨
3: /*
4: /* @param url URL
5: /* @param handler è¢«åŒ…è£…çš„é€šé“å¤„ç†å™¨
6: /* @return åŒ…è£…åçš„é€šé“å¤„ç†å™¨
7: /*/
8: protected static ChannelHandler wrapChannelHandler(URL url, ChannelHandler handler){
9: // è®¾ç½®çº¿ç¨‹å
10: url = ExecutorUtil.setThreadName(url, CLIENT_THREAD_POOL_NAME);
11: // è®¾ç½®ä½¿ç”¨çš„çº¿ç¨‹æ± ç±»å‹
12: url = url.addParameterIfAbsent(Constants.THREADPOOL_KEY, Constants.DEFAULT_CLIENT_THREADPOOL);
13: // åŒ…è£…é€šé“å¤„ç†å™¨
14: return ChannelHandlers.wrap(handler, url);
15: }
```

- ç¬¬ 10 è¡Œï¼šè°ƒç”¨

ExecutorUtil/#setThreadName(url, CLIENT_THREAD_POOL_NAME)
æ–¹æ³•ï¼Œè®¾ç½®**çº¿ç¨‹å**ï¼Œå³

URL.threadname=xxx
ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public static URL setThreadName(URL url, String defaultName){
String name = url.getParameter(Constants.THREAD_NAME_KEY, defaultName);
name = new StringBuilder(32).append(name).append("-").append(url.getAddress()).toString();
url = url.addParameter(Constants.THREAD_NAME_KEY, name);
return url;
}
```

- æ³¨æ„ï¼Œçº¿ç¨‹åä¸­ï¼ŒåŒ…å« **URL çš„åœ°å€ä¿¡æ¯**ã€‚
- ç¬¬ 12 è¡Œï¼šè®¾ç½®**çº¿ç¨‹ç±»å‹**ï¼Œå³

URL.threadpool=xxx
ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨

"cached"
ç±»å‹ï¼Œè¿™ä¸ªå’Œ Server æ˜¯ä¸åŒçš„ï¼Œä¸‹é¢æˆ‘ä»¬ä¼šçœ‹åˆ°ã€‚

- [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” çº¿ç¨‹æ± ã€‹](http://svip.iocoder.cn/Dubbo/thread-pool/?self)
- ç¬¬ 14 è¡Œï¼šè°ƒç”¨

ChannelHandlers/#wrap(handler, url)
æ–¹æ³•ï¼ŒåŒ…è£…é€šé“å¤„ç†å™¨ã€‚è¿™é‡Œæˆ‘ä»¬ä¸ç»†è¯´ï¼Œåœ¨ [ã€Œ8. Dispacherã€](http://svip.iocoder.cn/Dubbo/remoting-api-transport/) ä¸­ï¼Œç»“åˆè§£æã€‚

- ğŸ™‚ è¿™æ˜¯ä¸€ä¸ªéå¸¸å…³é”®çš„æ–¹æ³•ï¼Œåœ¨ä¾‹å¦‚ NettyClient ç­‰é‡Œï¼Œéƒ½ä¼šè°ƒç”¨è¯¥æ–¹æ³•ã€‚

**å…¶ä»–æ–¹æ³•**

å¦‚ä¸‹æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œè‰¿è‰¿å°±ä¸é‡å¤å•°å—¦äº†ã€‚

- [
  /#disconnect()
  ](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractClient.java#L291-L311) æ–¹æ³•ï¼Œæ–­å¼€è¿æ¥ã€‚
- [
  /#reconnect()
  ](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractClient.java#L313-L316) æ–¹æ³•ï¼Œä¸»åŠ¨é‡è¿ã€‚
- [
  /#close()
  ](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractClient.java#L318-L341) æ–¹æ³•ï¼Œå¼ºåˆ¶å…³é—­ã€‚
- [
  /#close(timeout)
  ](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractClient.java#L343-L346) æ–¹æ³•ï¼Œä¼˜é›…å…³é—­ã€‚

**å­ç±»ç±»å›¾**

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_12_04/03.png)

## 3.2 ClientDelegate

[
com.alibaba.dubbo.remoting.transport.ClientDelegate
](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/ClientDelegate.java) ï¼Œå®ç° Client æ¥å£ï¼Œå®¢æˆ·ç«¯è£…é¥°è€…å®ç°ç±»ã€‚åœ¨æ¯ä¸ªå®ç°çš„æ–¹æ³•é‡Œï¼Œç›´æ¥è°ƒç”¨è¢«è£…é¥°çš„ [
client
](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/ClientDelegate.java#L31) å±æ€§çš„æ–¹æ³•ã€‚

ç›®å‰

dubbo-rpc-default
æ¨¡å—ä¸­ï¼Œ[ChannelWrapper](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-rpc/dubbo-rpc-default/src/main/java/com/alibaba/dubbo/rpc/protocol/dubbo/ChannelWrappedInvoker.java#L91-L160) ç»§æ‰¿äº† ClientDelegate ç±»ã€‚ä½†å®é™…ä¸Šï¼ŒChannelWrapper **é‡æ–°å®ç°äº†æ‰€æœ‰çš„æ–¹æ³•**ï¼Œå¹¶ä¸”ï¼Œå¹¶æœªå¤ç”¨ä»»ä½•æ–¹æ³•ã€‚æ‰€ä»¥ï¼ŒClientDelegate ç›®å‰ç”¨é€”ä¸å¤§ã€‚

# 4. Server

## 4.1 AbstractServer

[
com.alibaba.dubbo.remoting.transport.AbstractServer
](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractServer.java) ï¼Œå®ç° Server æ¥å£ï¼Œç»§æ‰¿ AbstractEndpoint æŠ½è±¡ç±»ï¼Œ**æœåŠ¡å™¨**æŠ½è±¡ç±»ï¼Œ**é‡ç‚¹**å®ç°äº†å…¬ç”¨çš„é€»è¾‘ï¼ŒåŒæ—¶æŠ½è±¡äº†å¼€å¯ã€å…³é—­ç­‰æ¨¡æ¿æ–¹æ³•ï¼Œä¾›å­ç±»å®ç°ã€‚æŠ½è±¡æ–¹æ³•å¦‚ä¸‹ï¼š

```
protected abstract void doOpen() throws Throwable;
protected abstract void doClose() throws Throwable;
```

**æ„é€ æ–¹æ³•**

```
1: //*/*
2: /* çº¿ç¨‹æ± 
3: /*/
4: ExecutorService executor;
5: //*/*
6: /* æœåŠ¡åœ°å€
7: /*/
8: private InetSocketAddress localAddress;
9: //*/*
10: /* ç»‘å®šåœ°å€
11: /*/
12: private InetSocketAddress bindAddress;
13: //*/*
14: /* æœåŠ¡å™¨æœ€å¤§å¯æ¥å—è¿æ¥æ•°
15: /*/
16: private int accepts;
17: //*/*
18: /* ç©ºé—²è¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’
19: /*/
20: private int idleTimeout; //600 seconds
21:
22: public AbstractServer(URL url, ChannelHandler handler) throws RemotingException{
23: super(url, handler);
24: // æœåŠ¡åœ°å€
25: localAddress = getUrl().toInetSocketAddress();
26: // ç»‘å®šåœ°å€
27: String bindIp = getUrl().getParameter(Constants.BIND_IP_KEY, getUrl().getHost());
28: int bindPort = getUrl().getParameter(Constants.BIND_PORT_KEY, getUrl().getPort());
29: if (url.getParameter(Constants.ANYHOST_KEY, false) || NetUtils.isInvalidLocalHost(bindIp)) {
30: bindIp = NetUtils.ANYHOST;
31: }
32: bindAddress = new InetSocketAddress(bindIp, bindPort);
33: // æœåŠ¡å™¨æœ€å¤§å¯æ¥å—è¿æ¥æ•°
34: this.accepts = url.getParameter(Constants.ACCEPTS_KEY, Constants.DEFAULT_ACCEPTS);
35: // ç©ºé—²è¶…æ—¶æ—¶é—´
36: this.idleTimeout = url.getParameter(Constants.IDLE_TIMEOUT_KEY, Constants.DEFAULT_IDLE_TIMEOUT);
37:
38: // å¼€å¯æœåŠ¡å™¨
39: try {
40: doOpen();
41: if (logger.isInfoEnabled()) {
42: logger.info("Start " + getClass().getSimpleName() + " bind " + getBindAddress() + ", export " + getLocalAddress());
43: }
44: } catch (Throwable t) {
45: throw new RemotingException(url.toInetSocketAddress(), null, "Failed to bind " + getClass().getSimpleName()
46: + " on " + getLocalAddress() + ", cause: " + t.getMessage(), t);
47: }
48:
49: // è·å¾—çº¿ç¨‹æ± 
50: //fixme replace this with better method
51: DataStore dataStore = ExtensionLoader.getExtensionLoader(DataStore.class).getDefaultExtension();
52: executor = (ExecutorService) dataStore.get(Constants.EXECUTOR_SERVICE_COMPONENT_KEY, Integer.toString(url.getPort()));
53: }
```

- ç¬¬ 24 è‡³ 36 è¡Œï¼šä» URL ä¸­ï¼ŒåŠ è½½

localAddress

bindAddress

accepts

idleTimeout
é…ç½®é¡¹ã€‚æ¯”è¾ƒéš¾ç†è§£çš„ï¼Œå¯èƒ½æ˜¯ä¸¤ä¸ªåœ°å€å±æ€§ï¼Œå¦‚ä¸‹æ˜¯æ¯”ä¾‹æä¾›çš„ä¸€ä¸ªä¾‹å­ï¼š![ä¾‹å­](http://static2.iocoder.cn/images/Dubbo/2018_12_04/02.png)

- é…ç½®é¡¹å¯åœ¨ [
  /#reset(url)
  ](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractServer.java#L80-L129) æ–¹æ³•ä¸­ï¼Œé‡ç½®å±æ€§ã€‚
- ç¬¬ 38 è‡³ 47 è¡Œï¼šè°ƒç”¨

/#doOpen()
æ–¹æ³•ï¼Œå¼€å¯æœåŠ¡å™¨ã€‚

- ç¬¬ 49 è‡³ 52 è¡Œï¼šä» [DataStore](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-common/src/main/java/com/alibaba/dubbo/common/store/DataStore.java) ä¸­ï¼Œè·å¾—çº¿ç¨‹æ± ã€‚

- fixme replace this with better method
  ï¼Œè¯´æ˜**å®˜æ–¹**åœ¨è¿™å—å®ç°ä¸Šï¼Œä¹Ÿä¸æ˜¯å¾ˆæ»¡æ„ï¼Œåé¢ä¼šä¼˜åŒ–æ‰ã€‚

**è¢«å®¢æˆ·ç«¯è¿æ¥**

```
@Override
public void connected(Channel ch) throws RemotingException{
// If the server has entered the shutdown process, reject any new connection
if (this.isClosing() || this.isClosed()) {
logger.warn("Close new channel " + ch + ", cause: server is closing or has been closed. For example, receive a new connect request while in shutdown process.");
ch.close();
return;
}
// è¶…è¿‡ä¸Šé™ï¼Œå…³é—­æ–°çš„é“¾æ¥
Collection<Channel> channels = getChannels();
if (accepts > 0 && channels.size() > accepts) {
logger.error("Close channel " + ch + ", cause: The server " + ch.getLocalAddress() + " connections greater than max config " + accepts);
ch.close(); // å…³é—­æ–°çš„é“¾æ¥
return;
}
// è¿æ¥
super.connected(ch);
}
```

**å‘é€æ¶ˆæ¯**

```
@Override
public void send(Object message, boolean sent) throws RemotingException{
// è·å¾—æ‰€æœ‰çš„å®¢æˆ·ç«¯çš„é€šé“
Collection<Channel> channels = getChannels();
// ç¾¤å‘æ¶ˆæ¯
for (Channel channel : channels) {
if (channel.isConnected()) {
channel.send(message, sent);
}
}
}
```

**å…¶ä»–æ–¹æ³•**

å¦‚ä¸‹æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œè‰¿è‰¿å°±ä¸é‡å¤å•°å—¦äº†ã€‚

- [
  /#disconnect()
  ](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractServer.java#L196-L203) æ–¹æ³•ï¼Œæ–­å¼€è¿æ¥ã€‚
- [
  /#close()
  ](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractServer.java#L140-L155) æ–¹æ³•ï¼Œå¼ºåˆ¶å…³é—­ã€‚
- [
  /#close(timeout)
  ](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractServer.java#L157-L160) æ–¹æ³•ï¼Œä¼˜é›…å…³é—­ã€‚

**å­ç±»ç±»å›¾**

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_12_04/04.png)

## 4.2 ServerDelegate

[
com.alibaba.dubbo.remoting.transport.ServerDelegate
](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/ServerDelegate.java) ï¼Œå®ç° Client æ¥å£ï¼Œå®¢æˆ·ç«¯è£…é¥°è€…å®ç°ç±»ã€‚åœ¨æ¯ä¸ªå®ç°çš„æ–¹æ³•é‡Œï¼Œç›´æ¥è°ƒç”¨è¢«è£…é¥°çš„ [
server
](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/ServerDelegate.java#L35) å±æ€§çš„æ–¹æ³•ã€‚

ç›®å‰

dubbo-remoting-p2p
æ¨¡å—ä¸­ï¼ŒPeerServer ä¼šç»§æ‰¿è¯¥ç±»ï¼Œåç»­å†çœ‹ã€‚

# 5. Channel

## 5.1 AbstractChannel

[
com.alibaba.dubbo.remoting.transport.AbstractChannel
](https://github.com/YunaiV/dubbo/blob/4fa80f25673c4e7060847a711a87ea37ed152d91/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractChannel.java) ï¼Œå®ç° Channel æ¥å£ï¼Œå®ç° AbstractPeer æŠ½è±¡ç±»ï¼Œ**é€šé“**æŠ½è±¡ç±»ã€‚

**å‘é€æ¶ˆæ¯**

```
@Override
public void send(Object message, boolean sent) throws RemotingException{
if (isClosed()) {
throw new RemotingException(this, "Failed to send message "
+ (message == null ? "" : message.getClass().getName()) + ":" + message
+ ", cause: Channel closed. channel: " + getLocalAddress() + " -> " + getRemoteAddress());
}
}
```

- å…·ä½“çš„å‘é€æ–¹æ³•ï¼Œå­ç±»å®ç°ã€‚åœ¨ AbstractChannel ä¸­ï¼Œç›®å‰åªåšçŠ¶æ€æ£€æŸ¥ã€‚

**å­ç±»ç±»å›¾**

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_12_04/05.png)

## 5.2 ChannelDelegate

[
com.alibaba.dubbo.remoting.transport.ChannelDelegate
](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/ChannelDelegate.java) ï¼Œå®ç° Channel æ¥å£ï¼Œé€šé“è£…é¥°è€…å®ç°ç±»ã€‚åœ¨æ¯ä¸ªå®ç°çš„æ–¹æ³•é‡Œï¼Œç›´æ¥è°ƒç”¨è¢«è£…é¥°çš„ [
channel
](https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/ChannelDelegate.java#L31) å±æ€§çš„æ–¹æ³•ã€‚

ç›®å‰ Dubbo ä¸­ï¼Œæš‚æœªç”¨åˆ°ã€‚

# 7. ChannelHandler

## 7.1 ChannelHandlerAdapter

com.alibaba.dubbo.remoting.transport.ChannelHandlerAdapter
ï¼Œå®ç° ChannelHandler æ¥å£ï¼Œé€šé“å¤„ç†å™¨**é€‚é…å™¨**ï¼Œæ¯ä¸ªæ–¹æ³•ä¸ºç©ºå®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@Override public void connected(Channel channel) throws RemotingException{ }
@Override public void disconnected(Channel channel) throws RemotingException{ }
@Override public void sent(Channel channel, Object message){ }
@Override public void received(Channel channel, Object message) throws RemotingException{ }
@Override public void caught(Channel channel, Throwable exception) throws RemotingException{ }
```

å­ç±»ï¼Œå¯ç»§æ‰¿å®ƒï¼Œ**ä»…å®ç°**æƒ³è¦çš„æ–¹æ³•ã€‚

## 7.2 ChannelHandlerDispatcher

com.alibaba.dubbo.remoting.transport.ChannelHandlerDispatcher
ï¼Œå®ç° ChannelHandler æ¥å£ï¼Œé€šé“å¤„ç†å™¨**è°ƒåº¦å™¨**ã€‚åœ¨å®ƒå†…éƒ¨ï¼Œæœ‰ä¸€ä¸ªé€šé“å¤„ç†å™¨æ•°ç»„ [
channelHandlers
](https://github.com/YunaiV/dubbo/blob/4fa80f25673c4e7060847a711a87ea37ed152d91/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/ChannelHandlerDispatcher.java#L35) å±æ€§ã€‚

æ¯ä¸ªå®ç°çš„æ–¹æ³•ï¼Œéƒ½ä¼šå¾ªç¯è°ƒç”¨

channelHandlers
çš„æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š

```
public void received(Channel channel, Object message){
for (ChannelHandler listener : channelHandlers) {
try {
listener.received(channel, message);
} catch (Throwable t) {
logger.error(t.getMessage(), t);
}
}
}
```

æœç´¢äº†ä¸‹ ChannelHandlerDispatcher çš„ä½¿ç”¨æƒ…å†µï¼Œä¸»è¦ç”¨åœ¨

dubbo-remoting-p2p
çš„ AbstractGroup ä¸­ã€‚

## 7.3 ChannelHandlerDelegate

com.alibaba.dubbo.remoting.transport.ChannelHandlerDelegate
ï¼Œå®ç° ChannelHandler æ¥å£ï¼Œé€šé“å¤„ç†å™¨**è£…é¥°è€…**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
ChannelHandler getHandler();
```

æ­£å¦‚ï¼Œæˆ‘ä»¬åœ¨ä¸Šæ–‡ä¸­è¯´é“ï¼Œ**è£…é¥°å™¨æ¨¡å¼**ï¼Œåœ¨

dubbo-remoting-api
æ‰®æ¼”äº†éå¸¸é‡è¦çš„è§’è‰²ï¼Œé‚£ä¹ˆæœ€ä½³æ¼”å‘˜å°±æ˜¯ ChannelHandlerDelegate ä»¬ã€‚ä¸‹é¢ï¼Œå¼€å§‹ä»–ä»¬çš„è¡¨æ¼”ã€‚

### 7.3.1 AbstractChannelHandlerDelegate

[
com.alibaba.dubbo.remoting.transport.AbstractChannelHandlerDelegate
](https://github.com/YunaiV/dubbo/blob/4fa80f25673c4e7060847a711a87ea37ed152d91/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractChannelHandlerDelegate.java) ï¼Œå®ç° ChannelHandlerDelegate æ¥å£ï¼Œé€šé“å¤„ç†å™¨è£…é¥°è€…**æŠ½è±¡å®ç°ç±»**ã€‚åœ¨æ¯ä¸ªå®ç°çš„æ–¹æ³•é‡Œï¼Œç›´æ¥è°ƒç”¨è¢«è£…é¥°çš„ [
handler
](https://github.com/YunaiV/dubbo/blob/4fa80f25673c4e7060847a711a87ea37ed152d91/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractChannelHandlerDelegate.java#L26) å±æ€§çš„æ–¹æ³•ã€‚

### 7.3.2 DecodeHandler

com.alibaba.dubbo.remoting.transport.DecodeHandler
ï¼Œå®ç° AbstractChannelHandlerDelegate æŠ½è±¡ç±»ï¼Œ**è§£ç å¤„ç†å™¨**ï¼Œå¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œå®ç°äº† Decodeable æ¥å£çš„æƒ…å†µã€‚

\*\*è¦†å†™äº†

/#received(channel, message)
æ–¹æ³•\*\*

```
1: @Override
2: public void received(Channel channel, Object message) throws RemotingException{
3: if (message instanceof Decodeable) {
4: decode(message);
5: }
6:
7: if (message instanceof Request) {
8: decode(((Request) message).getData());
9: }
10:
11: if (message instanceof Response) {
12: decode(((Response) message).getResult());
13: }
14:
15: handler.received(channel, message);
16: }
```

- ç¬¬ 3 è‡³ 5 è¡Œï¼šå½“æ¶ˆæ¯æ˜¯ Decodeable ç±»å‹æ—¶ï¼Œè°ƒç”¨

/#decode(message)
æ–¹æ³•ï¼Œè§£ææ¶ˆæ¯ã€‚

- ç¬¬ 7 è‡³ 9 è¡Œï¼šå½“æ¶ˆæ¯æ˜¯ Request ç±»å‹æ—¶ï¼Œè°ƒç”¨

/#decode(message)
æ–¹æ³•ï¼Œè§£æ

data
å±æ€§ã€‚

- ç¬¬ 11 è‡³ 13 è¡Œï¼šå½“æ¶ˆæ¯æ˜¯ Response ç±»å‹æ—¶ï¼Œè°ƒç”¨

/#decode(message)
æ–¹æ³•ï¼Œè§£æ

result
å±æ€§ã€‚

- ç¬¬ 15 è¡Œï¼šè°ƒç”¨

ChannelHandler/#received(channel, message)
æ–¹æ³•ï¼Œå°†æ¶ˆæ¯äº¤ç»™å§”æ‰˜çš„

handler
ï¼Œç»§ç»­å¤„ç†ã€‚ğŸ™‚ èƒ–å‹æ˜¯å¦æ„Ÿå—åˆ°ï¼Œè£…é¥°å™¨æ¨¡å¼çš„å¥½å¤„ï¼šé€šè¿‡ç»„åˆçš„æ–¹å¼ï¼Œå®ç°åŠŸèƒ½çš„å åŠ ã€‚

**è§£ææ¶ˆæ¯**

```
1: private void decode(Object message){
2: if (message != null && message instanceof Decodeable) {
3: try {
4: ((Decodeable) message).decode(); // è§£ææ¶ˆæ¯
5: if (log.isDebugEnabled()) {
6: log.debug(new StringBuilder(32).append("Decode decodeable message ").append(message.getClass().getName()).toString());
7: }
8: } catch (Throwable e) {
9: if (log.isWarnEnabled()) {
10: log.warn(new StringBuilder(32).append("Call Decodeable.decode failed: ").append(e.getMessage()).toString(), e);
11: }
12: } // ~ end of catch
13: } // ~ end of if
14: } // ~ end of method decode
```

- ç¬¬ 2 è‡³ 4 è¡Œï¼šå½“ç±»å‹æ˜¯ Decodeable æ—¶ï¼Œè°ƒç”¨

Decodeable/#decode()
æ–¹æ³•ï¼Œè¿›ä¸€æ­¥è§£æã€‚

- åœ¨

dubbo-rpc-default
é¡¹ç›®ä¸­ï¼ŒDecodeableRpcInvocation å’Œ DecodeableRpcResult å®ç° Decodeable æ¥å£ï¼Œåé¢æˆ‘ä»¬æ¥åˆ†äº«ã€‚

### 7.3.3 MultiMessageHandler

`com.alibaba.dubbo.remoting.transport.MultiMessageHandler ï¼Œå®ç° AbstractChannelHandlerDelegate æŠ½è±¡ç±»ï¼Œ**å¤šæ¶ˆæ¯å¤„ç†å™¨**ï¼Œå¤„ç†ä¸€æ¬¡æ€§æ¥æ”¶åˆ°å¤šæ¡æ¶ˆæ¯çš„æƒ…å†µã€‚

\*\*è¦†å†™äº†

/#received(channel, message)
æ–¹æ³•\*\*

```
1: @Override
2: public void received(Channel channel, Object message) throws RemotingException{
3: if (message instanceof MultiMessage) { // å¤šæ¶ˆæ¯
4: MultiMessage list = (MultiMessage) message;
5: for (Object obj : list) {
6: handler.received(channel, obj);
7: }
8: } else {
9: handler.received(channel, message);
10: }
11: }
```

- ç¬¬ 3 è‡³ 7 è¡Œï¼šå½“æ¶ˆæ¯æ˜¯ MultiMessage ç±»å‹ï¼Œå³**å¤šæ¶ˆæ¯**ï¼Œ**å¾ªç¯**æäº¤ç»™

handler
å¤„ç†ã€‚

- ç¬¬ 8 è‡³ 10 è¡Œï¼šå½“**å•æ¶ˆæ¯**æ—¶ï¼Œ**ç›´æ¥**æäº¤ç»™

handler
å¤„ç†ã€‚

ğŸ™‚ åœ¨ä¸‹é¢çš„æ–‡ç« ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° ChannelHandlerDelegate çš„**ç»„åˆä½¿ç”¨çš„ä¾‹å­**ã€‚

# 8. Dispacher

æœ¬å°èŠ‚å†…å®¹ï¼Œå¯¹åº” [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” çº¿ç¨‹æ¨¡å‹ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/thread-model.html) ã€‚

ç®€å•æ¦‚æ‹¬è¿™èŠ‚ï¼Œä»¥**æ¥æ”¶æ¶ˆæ¯**ä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
executor.execute(new Runnable() {
handler.received(channel, message)
});
```

å°† ChannelHandler çš„å…·ä½“æ“ä½œï¼Œè°ƒåº¦åˆ°çº¿ç¨‹æ± ä¸­ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¿™ä¸ªæ¨¡å—å«

dispacher
çš„åŸå› ã€‚

## 8.1 ChannelHandlers

com.alibaba.dubbo.remoting.transport.dispatcher.ChannelHandlers
ï¼Œé€šé“å¤„ç†å™¨**å·¥å‚**ã€‚åœ¨ä¸Šæ–‡ [ã€Œ3.1 AbstractClientã€](http://svip.iocoder.cn/Dubbo/remoting-api-transport/) ï¼Œæˆ‘ä»¬çœ‹åˆ°

AbstractClient/#wrapChannelHandler(url, handler)
æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨

ChannelHandlers/#wrap(url, handler)
æ–¹æ³•ã€‚å®é™…ä¸Šï¼ŒServer éƒ¨åˆ†ä¹Ÿä¼šæœ‰è¿™æ ·ç±»ä¼¼çš„é€»è¾‘ï¼Œåªæ˜¯ä»£ç å®ç°ä¸Šæš‚æœªç»Ÿä¸€ã€‚ä»¥

dubbo-remoting-netty4
æ¥ä¸¾ä¾‹å­ï¼š

- NettyClient ï¼š

```
public NettyClient(final URL url, final ChannelHandler handler) throws RemotingException{
super(url, wrapChannelHandler(url, handler));
}
```

- NettyServer ï¼š

```
public NettyServer(URL url, ChannelHandler handler) throws RemotingException{
super(url, ChannelHandlers.wrap(handler, ExecutorUtil.setThreadName(url, SERVER_THREAD_POOL_NAME) //* è®¾ç½®çº¿ç¨‹ååˆ° URL ä¸Š /*/));
}
```

æ— è®º Client è¿˜æ˜¯ Server ï¼Œéƒ½æ˜¯ç±»ä¼¼çš„ï¼Œå°†ä¼ å…¥çš„

handler
ï¼Œæœ€ç»ˆä½¿ç”¨ ChannelHandlers è¿›è¡Œä¸€æ¬¡åŒ…è£…ã€‚OK ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹åŒ…è£…é€šé“å¤„ç†å™¨çš„å…·ä½“ä»£ç ï¼š

```
1: //*/*
2: /* å•ä¾‹
3: /*/
4: private static ChannelHandlers INSTANCE = new ChannelHandlers();
5:
6: public static ChannelHandler wrap(ChannelHandler handler, URL url){
7: return ChannelHandlers.getInstance().wrapInternal(handler, url);
8: }
9:
10: protected ChannelHandler wrapInternal(ChannelHandler handler, URL url){
11: return new MultiMessageHandler(
12: new HeartbeatHandler(
13: ExtensionLoader.getExtensionLoader(Dispatcher.class).getAdaptiveExtension().dispatch(handler, url)
14: )
15: );
16: }
```

- ç¬¬ 11 è‡³ 15 è¡Œï¼šåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°±çœ‹åˆ°äº†å¤šä¸ª ChannelHandlerDelegate çš„ç»„åˆã€‚åŒ…æ‹¬ï¼Œç¬¬ 15 è¡Œçš„ï¼Œ

Dispatcher/#dispatch(handler, url)
æ–¹æ³•ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯**è¿”å›**ä¸€ä¸ª ChannelHandlerDelegate å¯¹è±¡ã€‚

## 8.2 Dispatcher å®ç°ç±»

åœ¨ Dubbo ä¸­ï¼Œæœ‰å¤šç§ Dispatcher çš„å®ç°ï¼Œå¦‚ä¸‹ï¼š
FROM [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” çº¿ç¨‹æ¨¡å‹ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/thread-model.html)

- all
  æ‰€æœ‰æ¶ˆæ¯éƒ½æ´¾å‘åˆ°çº¿ç¨‹æ± ï¼ŒåŒ…æ‹¬è¯·æ±‚ï¼Œå“åº”ï¼Œè¿æ¥äº‹ä»¶ï¼Œæ–­å¼€äº‹ä»¶ï¼Œå¿ƒè·³ç­‰ã€‚
- direct
  æ‰€æœ‰æ¶ˆæ¯éƒ½ä¸æ´¾å‘åˆ°çº¿ç¨‹æ± ï¼Œå…¨éƒ¨åœ¨ IO çº¿ç¨‹ä¸Šç›´æ¥æ‰§è¡Œã€‚
- message
  åªæœ‰è¯·æ±‚å“åº”æ¶ˆæ¯æ´¾å‘åˆ°çº¿ç¨‹æ± ï¼Œå…¶å®ƒè¿æ¥æ–­å¼€äº‹ä»¶ï¼Œå¿ƒè·³ç­‰æ¶ˆæ¯ï¼Œç›´æ¥åœ¨ IO çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚
- execution
  åªè¯·æ±‚æ¶ˆæ¯æ´¾å‘åˆ°çº¿ç¨‹æ± ï¼Œä¸å«å“åº”ï¼Œå“åº”å’Œå…¶å®ƒè¿æ¥æ–­å¼€äº‹ä»¶ï¼Œå¿ƒè·³ç­‰æ¶ˆæ¯ï¼Œç›´æ¥åœ¨ IO çº¿ç¨‹ä¸Šæ‰§è¡Œã€‚
- connection
  åœ¨ IO çº¿ç¨‹ä¸Šï¼Œå°†è¿æ¥æ–­å¼€äº‹ä»¶æ”¾å…¥é˜Ÿåˆ—ï¼Œæœ‰åºé€ä¸ªæ‰§è¡Œï¼Œå…¶å®ƒæ¶ˆæ¯æ´¾å‘åˆ°çº¿ç¨‹æ± ã€‚

**å­ç±»ç±»å›¾**

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_12_04/07.png)

### 8.2.1 AllDispatcher

æˆ‘ä»¬ä»¥

all
å¯¹åº”çš„ AllDispatcher ä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public class AllDispatcher implements Dispatcher{
public static final String NAME = "all";
public ChannelHandler dispatch(ChannelHandler handler, URL url){
return new AllChannelHandler(handler, url);
}
}
```

åœ¨è¯¥ç±»çš„

/#dispatch(...)
çš„æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åˆ›å»º AllChannelHandler å¯¹è±¡ï¼Œå¹¶ä¼ å…¥

handler
å±æ€§ã€‚ğŸ™‚ èªæ…§å¦‚ä½ ï¼Œå·²ç»çŒœåˆ° AllChannelHandler ä¹Ÿæ˜¯ ChannelHandlerDelegate ç±»å‹ã€‚ä¹Ÿå°±æ˜¯è¯´â€œ**çº¿ç¨‹æ¨¡å‹**â€ï¼Œä¹Ÿæ˜¯é€šè¿‡**è£…é¥°å™¨æ¨¡å¼**ï¼Œç»„åˆè€Œæˆã€‚

æ¯ä¸ª Dispatcher å®ç°ç±»ï¼Œéƒ½å¯¹åº”ä¸€ä¸ª ChannelHandler å®ç°ç±»ã€‚é»˜è®¤**æœªé…ç½®**çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ AllDispatcher è°ƒåº¦ã€‚

### 8.2.2 AllChannelHandler

[
com.alibaba.dubbo.remoting.transport.dispatcher.all.AllChannelHandler
](http://svip.iocoder.cn/Dubbo/remoting-api-transport/com.alibaba.dubbo.remoting.transport.dispatcher.all) ï¼Œå®ç° WrappedChannelHandler æŠ½è±¡ç±»ã€‚è¦†å†™

/#connected(channel)
æ–¹æ³•å¦‚ä¸‹ï¼š
WrappedChannelHandler æ˜¯å®ç° ChannelHandlerDelegate çš„æŠ½è±¡ç±»ï¼Œä¸‹æ–‡å†çœ‹ã€‚

```
@Override
public void connected(Channel channel) throws RemotingException{
ExecutorService cexecutor = getExecutorService();
try {
cexecutor.execute(new ChannelEventRunnable(channel, handler, ChannelState.CONNECTED));
} catch (Throwable t) {
throw new ExecutionException("connect event", channel, getClass() + " error when process connected event .", t);
}
}
```

- åˆ›å»º ChannelEventRunnable å¯¹è±¡ï¼Œæäº¤ç»™çº¿ç¨‹æ± æ‰§è¡Œã€‚
- æ³¨æ„ï¼Œä¼ å…¥çš„çŠ¶æ€ä¸º

ChannelState.CONNECTED
ã€‚ä¸åŒçš„å®ç°æ–¹æ³•ï¼Œå¯¹åº”ä¸åŒçš„çŠ¶æ€ã€‚

## 8.3 ChannelEventRunnable

[
com.alibaba.dubbo.remoting.transport.dispatcher.ChannelEventRunnable
](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/dispatcher/ChannelEventRunnable.java) ï¼Œå®ç° Runnable æ¥å£ã€‚ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹å™¢ã€‚ä¸»è¦åˆ†æˆä¸‰éƒ¨åˆ†ï¼š

- [æ„é€ æ–¹æ³•](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/dispatcher/ChannelEventRunnable.java#L27-L51)
- [ChannelState](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/dispatcher/ChannelEventRunnable.java#L98-L129)
- [
  /#run()
  ](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/dispatcher/ChannelEventRunnable.java#L53-L96) æ–¹æ³•ï¼Œç®€åŒ–ä»£ç å¦‚ä¸‹ï¼š

```
@Override
public void run(){
switch (state) {
case CONNECTED: handler.connected(channel); break;
case DISCONNECTED:handler.disconnected(channel); break;
case SENT:handler.sent(channel, message);break;
case RECEIVED:handler.received(channel, message);break;
case CAUGHT:handler.caught(channel, exception);break;
default: logger.warn("unknown state: " + state + ", message is " + message);
}
}
```

## 8.4 WrappedChannelHandler

com.alibaba.dubbo.remoting.transport.dispatcher.WrappedChannelHandler
ï¼Œå®ç° ChannelHandlerDelegate æ¥å£ï¼Œ**åŒ…è£…çš„** WrappedChannelHandler å®ç°ç±»ã€‚
ä»ç›®å‰çš„å®ç°æ¥çœ‹ï¼ŒWrappedChannelHandler ç»§æ‰¿ AbstractChannelHandlerDelegate æ›´åˆé€‚ï¼Œå› ä¸º

/#connected(channel)
ç­‰ï¼Œå®ç°çš„æ–¹æ³•éƒ½æ˜¯ç›¸åŒçš„ã€‚

**æ„é€ æ–¹æ³•**

```
1: //*/*
2: /* çº¿ç¨‹æ± 
3: /*/
4: protected final ExecutorService executor;
5: //*/*
6: /* é€šé“å¤„ç†å™¨
7: /*/
8: protected final ChannelHandler handler;
9: //*/*
10: /* URL
11: /*/
12: protected final URL url;
13:
14: public WrappedChannelHandler(ChannelHandler handler, URL url){
15: this.handler = handler;
16: this.url = url;
17:
18: // åˆ›å»ºçº¿ç¨‹æ± 
19: executor = (ExecutorService) ExtensionLoader.getExtensionLoader(ThreadPool.class).getAdaptiveExtension().getExecutor(url);
20:
21: // æ·»åŠ çº¿ç¨‹æ± åˆ° DataStore ä¸­
22: String componentKey = Constants.EXECUTOR_SERVICE_COMPONENT_KEY;
23: if (Constants.CONSUMER_SIDE.equalsIgnoreCase(url.getParameter(Constants.SIDE_KEY))) {
24: componentKey = Constants.CONSUMER_SIDE;
25: }
26: DataStore dataStore = ExtensionLoader.getExtensionLoader(DataStore.class).getDefaultExtension();
27: dataStore.put(componentKey, Integer.toString(url.getPort()), executor);
28: }
```

- ç¬¬ 19 è¡Œï¼šåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼Œåˆ›å»ºçº¿ç¨‹æ± ã€‚
- ç¬¬ 21 è‡³ 27 è¡Œï¼šæ·»åŠ çº¿ç¨‹æ± åˆ° DataStore ä¸­ã€‚ğŸ™‚ è¿™å°±æ˜¯ä¸Šæ–‡ AbstractClient æˆ– AbstractServer ä» DataStore è·å¾—çº¿ç¨‹æ± çš„**æ–¹å¼**ã€‚å½“ç„¶ï¼Œå®˜æ–¹ä¹Ÿè¯´äº†ï¼Œè¿™ç§æ–¹å¼ä¸æ˜¯å¾ˆä¼˜é›…ï¼Œæœ‰ç‚¹å¥‡æ·«æŠ€å·§ï¼Œæœªæ¥ä¼šä¼˜åŒ–æ‰ã€‚

**å…±äº«çº¿ç¨‹æ± **

åœ¨ WrappedChannelHandler ä¸­ï¼Œæœ‰ä¸€ä¸ªå†…ç½®çš„å…±äº«çº¿ç¨‹æ± ï¼Œå¦‚ä¸‹ï¼š

```
protected static final ExecutorService SHARED_EXECUTOR = Executors.newCachedThreadPool(new NamedThreadFactory("DubboSharedHandler", true));
```

ã€TODO 8024ã€‘æä¸æ‡‚ï¼Œè¿™ä¸ªè®¾è®¡çš„æ„å›¾ï¼Œå…ˆ mark ç•™ç€ã€‚

**å­ç±»ç±»å›¾**

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_12_04/06.png)

# 9. Codec

## 9.1 CodecSupport

com.alibaba.dubbo.remoting.transport.CodecSupport
ï¼Œç¼–è§£ç å·¥å…·ç±»ï¼Œæä¾›æŸ¥è¯¢ Serialization çš„åŠŸèƒ½ã€‚

**åˆå§‹åŒ–**

```
//*/*
/* åºåˆ—åŒ–å¯¹è±¡é›†åˆ
/* keyï¼šåºåˆ—åŒ–ç±»å‹ç¼–å· {@link Serialization/#getContentTypeId()}
/*/
private static Map<Byte, Serialization> ID_SERIALIZATION_MAP = new HashMap<Byte, Serialization>();
//*/*
/* åºåˆ—åŒ–åé›†åˆ
/* keyï¼šåºåˆ—åŒ–ç±»å‹ç¼–å· {@link Serialization/#getContentTypeId()}
/* value: åºåˆ—åŒ–æ‹“å±•å
/*/
private static Map<Byte, String> ID_SERIALIZATIONNAME_MAP = new HashMap<Byte, String>();
static {
// åŸºäº Dubbo SPI ï¼Œåˆå§‹åŒ–
Set<String> supportedExtensions = ExtensionLoader.getExtensionLoader(Serialization.class).getSupportedExtensions();
for (String name : supportedExtensions) {
Serialization serialization = ExtensionLoader.getExtensionLoader(Serialization.class).getExtension(name);
byte idByte = serialization.getContentTypeId();
if (ID_SERIALIZATION_MAP.containsKey(idByte)) {
logger.error("Serialization extension " + serialization.getClass().getName()
+ " has duplicate id to Serialization extension "
+ ID_SERIALIZATION_MAP.get(idByte).getClass().getName()
+ ", ignore this Serialization extension");
continue;
}
ID_SERIALIZATION_MAP.put(idByte, serialization);
ID_SERIALIZATIONNAME_MAP.put(idByte, name);
}
}
```

Dubbo æä¾›äº†å¤šç§åºåˆ—åŒ–æ–¹å¼ï¼Œæ­¤å¤„åˆå§‹åŒ–ç»“æœï¼Œå¦‚ä¸‹å›¾ï¼š![SERIALIZATION é›†åˆ](http://static2.iocoder.cn/images/Dubbo/2018_12_04/08.png)

**æŸ¥æ‰¾ Serialization å¯¹è±¡**

```
public static Serialization getSerialization(URL url, Byte id) throws IOException{
Serialization serialization = getSerializationById(id);
String serializationName = url.getParameter(Constants.SERIALIZATION_KEY, Constants.DEFAULT_REMOTING_SERIALIZATION); // é»˜è®¤ï¼Œhessian2
// å‡ºäºå®‰å…¨çš„ç›®çš„ï¼Œé’ˆå¯¹ JDK çš„åºåˆ—åŒ–æ–¹å¼ï¼ˆå¯¹åº”ç¼–å·ä¸º 3ã€4ã€7ï¼‰ï¼Œæ£€æŸ¥è¿æ¥åˆ°æœåŠ¡å™¨çš„ URL å’Œå®é™…ä¼ è¾“çš„æ•°æ®ï¼Œåè®®æ˜¯å¦ä¸€è‡´ã€‚
// https://github.com/apache/incubator-dubbo/issues/1138
// Check if "serialization id" passed from network matches the id on this side(only take effect for JDK serialization), for security purpose.
if (serialization == null
|| ((id == 3 || id == 7 || id == 4) && !(serializationName.equals(ID_SERIALIZATIONNAME_MAP.get(id))))) {
throw new IOException("Unexpected serialization id:" + id + " received from network, please check if the peer send the right id.");
}
return serialization;
}
```

ğŸ™‚ åœ¨æœ€æ–°çš„ Dubbo ç‰ˆæœ¬ä¸­ï¼Œå·²ç»å°†

serialization
æ¨¡å—ï¼Œä»

dubbo-common
ä¸­ï¼Œç‹¬ç«‹æˆ [
dubbo-serialization
](https://github.com/apache/incubator-dubbo/blob/HEAD/dubbo-serialization/pom.xml) ã€‚So ï¼Œæˆ‘ä»¬åé¢å¼€ä¸€ä¸ªç³»åˆ—æ¥åˆ†äº«ã€‚

## 9.2 AbstractCodec

com.alibaba.dubbo.remoting.transport.AbstractCodec
ï¼Œå®ç° Codec**2** æ¥å£ï¼Œæä¾›å¦‚ä¸‹å…¬ç”¨æ–¹æ³•ï¼š

- [
  /#checkPayload(channel, size)
  ](https://github.com/apache/incubator-dubbo/blob/05da8040e88ef5c9a544cb9dddf4c6abee6bd61a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractCodec.java#L38-L48) **é™æ€**æ–¹æ³•ï¼Œæ ¡éªŒæ¶ˆæ¯é•¿åº¦ã€‚
- [
  /#getSerialization(channel)
  ](https://github.com/apache/incubator-dubbo/blob/05da8040e88ef5c9a544cb9dddf4c6abee6bd61a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractCodec.java#L50-L52) æ–¹æ³•ï¼Œè·å¾— Serialization å¯¹è±¡ã€‚
- [
  /#isClientSide(channel)
  ](https://github.com/apache/incubator-dubbo/blob/05da8040e88ef5c9a544cb9dddf4c6abee6bd61a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractCodec.java#L54-L71) æ–¹æ³•ï¼Œæ˜¯å¦ä¸ºå®¢æˆ·ç«¯ä¾§çš„é€šé“ã€‚
- [
  /#isServerSide(channel)
  ](https://github.com/apache/incubator-dubbo/blob/05da8040e88ef5c9a544cb9dddf4c6abee6bd61a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractCodec.java#L73-L75) æ–¹æ³•ï¼Œæ˜¯å¦ä¸ºæœåŠ¡ç«¯ä¾§çš„é€šé“ã€‚

**å­ç±»ç±»å›¾**

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_12_04/09.png)

ç¼–è§£ç å™¨çš„å®ç°ï¼Œé€šè¿‡**ç»§æ‰¿**çš„æ–¹å¼ï¼Œè·å¾—æ›´å¤šçš„åŠŸèƒ½ã€‚æ¯ä¸€ä¸ª Codec2 ç±»å®ç°å¯¹ä¸åŒæ¶ˆæ¯çš„ç¼–è§£ç ã€‚é€šè¿‡**åè®®å¤´**æ¥åˆ¤æ–­ï¼Œå…·ä½“ä½¿ç”¨å“ªä¸ªç¼–è§£ç é€»è¾‘ã€‚å¬èµ·æ¥æœ‰ç‚¹ç»•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€æ®µç®€åŒ– ExchangeCodec çš„

/#decode(...)
ä¾‹å­ï¼š

```
1: protected Object decode(Channel channel, ChannelBuffer buffer, int readable, byte[] header) throws IOException{
2: // check magic number.
3: if (readable > 0 && header[0] != MAGIC_HIGH
4: || readable > 1 && header[1] != MAGIC_LOW) {
5: // ... çœç•¥
6: return super.decode(channel, buffer, readable, header);
7: }
8:
9: // ... çœç•¥
10:
11: return decodeBody(channel, is, header);
12: }
```

- ç¬¬ 2 è‡³ 7 è¡Œï¼šé€šè¿‡ magic number åˆ¤æ–­åˆ°ï¼Œ**å¹¶é** Dubbo Exchange **ä¿¡æ¯äº¤æ˜“çš„åè®®å¤´**ï¼Œè½¬äº¤ç»™çˆ¶ç±» TelnetCodec å¤„ç†ï¼Œä¸€èˆ¬æ­¤æ—¶æ˜¯ Telnet æ¶ˆæ¯ã€‚
- ç¬¬ 8 è‡³ 11 è¡Œï¼šé€šè¿‡ magic number åˆ¤æ–­åˆ°ï¼Œ**ç¬¦åˆ** Dubbo Exchange **ä¿¡æ¯äº¤æ˜“çš„åè®®å¤´**ï¼ŒExchangeCodec è‡ªå·±å¤„ç†ã€‚

### 9.2.1 TransportCodec

com.alibaba.dubbo.remoting.transport.codec.TransportCodec
ï¼Œä¼ è¾“ç¼–è§£ç å™¨ï¼Œä½¿ç”¨ Serialization è¿›è¡Œåºåˆ—åŒ–/ååºåˆ—åŒ–ï¼Œç›´æ¥ç¼–è§£ç ã€‚

**ç¼–ç æ¶ˆæ¯**

```
1: @Override
2: public void encode(Channel channel, ChannelBuffer buffer, Object message) throws IOException{
3: // è·å¾—ååºåˆ—åŒ–çš„ ObjectOutput å¯¹è±¡
4: OutputStream output = new ChannelBufferOutputStream(buffer);
5: ObjectOutput objectOutput = getSerialization(channel).serialize(channel.getUrl(), output);
6: // å†™å…¥ ObjectOutput
7: encodeData(channel, objectOutput, message);
8: objectOutput.flushBuffer();
9: // é‡Šæ”¾
10: if (objectOutput instanceof Cleanable) {
11: ((Cleanable) objectOutput).cleanup();
12: }
13: }
```

- ç¬¬ 3 è‡³ 5 è¡Œï¼šè·å¾—å¯¹åº”çš„ Serialization å¯¹è±¡ï¼Œå¹¶åˆ›å»ºç”¨äºååºåˆ—åŒ–çš„ ObjectOutput å¯¹è±¡ã€‚ä¸åŒçš„ Serialization å®ç°ï¼Œå¯¹åº”ä¸åŒçš„ ObjectOutput å®ç°ç±»ã€‚ğŸ™‚ è¿™é‡Œï¼Œæˆ‘ä»¬åªè¦è¯»æ‡‚å¤§ä½“æµç¨‹ï¼Œè¯¦ç»†çš„ï¼Œæˆ‘ä»¬åé¢æ–‡ç« è§ã€‚
- ç¬¬ 7 è¡Œï¼šè°ƒç”¨

/#encodeData(channel, objectOutput, message)
æ–¹æ³•ï¼Œå†™å…¥ ObjectOutputã€‚ä»£ç å¦‚ä¸‹ï¼š

```
protected void encodeData(Channel channel, ObjectOutput output, Object message) throws IOException{
encodeData(output, message);
}
protected void encodeData(ObjectOutput output, Object message) throws IOException{
output.writeObject(message);
}
```

- ç¬¬ 9 è‡³ 12 è¡Œï¼šé‡Šæ”¾èµ„æºã€‚ç›®å‰ï¼Œä»…æœ‰

kryo
çš„ KryoObjectInput ã€KryoObjectOutput å®ç°äº† Cleanable æ¥å£ï¼Œéœ€è¦é‡Šæ”¾èµ„æºã€‚

**è§£ç æ¶ˆæ¯**

[
/#decode(channel, buffer)
](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/codec/TransportCodec.java#L48-L56) **å®ç°**æ–¹æ³•ï¼Œå’Œè§£ç æ¶ˆæ¯åŸºæœ¬ä¸€è‡´ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚

## 9.3 CodecAdapter

[
com.alibaba.dubbo.remoting.transport.codec.CodecAdapter
](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/codec/CodecAdapter.java) ï¼Œå®ç° Code2 **æ¥å£**ï¼ŒCodec **é€‚é…å™¨**ï¼Œå°† Codec é€‚é…æˆ Codec2 ã€‚

ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚
