# è¿‡æ»¤å™¨ï¼ˆåï¼‰ä¹‹ CacheFilter

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«

dubbo-filter-cache
é¡¹ç›®çš„ CacheFilter è¿‡æ»¤å™¨ï¼Œç”¨äºæœåŠ¡**æ¶ˆè´¹è€…**å’Œ**æä¾›è€…**ä¸­ï¼Œæä¾› **ç»“æœç¼“å­˜**çš„åŠŸèƒ½ã€‚åœ¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” ç»“æœç¼“å­˜ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/result-cache.html) å®šä¹‰å¦‚ä¸‹ï¼š
ç»“æœç¼“å­˜ ï¼Œç”¨äºåŠ é€Ÿçƒ­é—¨æ•°æ®çš„è®¿é—®é€Ÿåº¦ï¼ŒDubbo æä¾›å£°æ˜å¼ç¼“å­˜ï¼Œä»¥å‡å°‘ç”¨æˆ·åŠ ç¼“å­˜çš„å·¥ä½œé‡ã€‚

Dubbo æä¾›äº†**ä¸‰ç§**å®ç°ï¼š

- lru
  ï¼šåŸºäºæœ€è¿‘æœ€å°‘ä½¿ç”¨åŸåˆ™åˆ é™¤å¤šä½™ç¼“å­˜ï¼Œä¿æŒæœ€çƒ­çš„æ•°æ®è¢«ç¼“å­˜ã€‚
- threadlocal
  ï¼šå½“å‰çº¿ç¨‹ç¼“å­˜ï¼Œæ¯”å¦‚ä¸€ä¸ªé¡µé¢æ¸²æŸ“ï¼Œç”¨åˆ°å¾ˆå¤š portalï¼Œæ¯ä¸ª portal éƒ½è¦å»æŸ¥ç”¨æˆ·ä¿¡æ¯ï¼Œé€šè¿‡çº¿ç¨‹ç¼“å­˜ï¼Œå¯ä»¥å‡å°‘è¿™ç§å¤šä½™è®¿é—®ã€‚
- jcache
  ï¼šä¸ [JSR107](https://jcp.org/en/jsr/detail?id=107) é›†æˆï¼Œå¯ä»¥æ¡¥æ¥å„ç§ç¼“å­˜å®ç°ã€‚

- å…·ä½“çš„é…ç½®æ–¹å¼ï¼Œåœ¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” ç»“æœç¼“å­˜ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/result-cache.html) æ–‡æ¡£ä¸­ï¼Œå·²ç»è¯¦ç»†åˆ†äº«ã€‚

æœ¬æ–‡æ¶‰åŠçš„ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_11_21/01.png)

# 2. CacheFilter

com.alibaba.dubbo.cache.filter.CacheFilter
ï¼Œå®ç° Filter æ¥å£ï¼Œç¼“å­˜è¿‡æ»¤å™¨å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: @Activate(group = {Constants.CONSUMER, Constants.PROVIDER}, value = Constants.CACHE_KEY)
2: public class CacheFilter implements Filter{
3:
4: //*/*
5: /* CacheFactory$Adaptive å¯¹è±¡ã€‚
6: /*
7: /* é€šè¿‡ Dubbo SPI æœºåˆ¶ï¼Œè°ƒç”¨ {@link /#setCacheFactory(CacheFactory)} æ–¹æ³•ï¼Œè¿›è¡Œæ³¨å…¥
8: /*/
9: private CacheFactory cacheFactory;
10:
11: public void setCacheFactory(CacheFactory cacheFactory){
12: this.cacheFactory = cacheFactory;
13: }
14:
15: @Override
16: public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException{
17: // æ–¹æ³•å¼€å¯ Cache åŠŸèƒ½
18: if (cacheFactory != null && ConfigUtils.isNotEmpty(invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.CACHE_KEY))) {
19: // åŸºäº URL + Method ä¸ºç»´åº¦ï¼Œè·å¾— Cache å¯¹è±¡ã€‚
20: Cache cache = cacheFactory.getCache(invoker.getUrl().addParameter(Constants.METHOD_KEY, invocation.getMethodName())); // æ·»åŠ  `method` å±æ€§ï¼Œæ˜¯å› ä¸º JCache éœ€è¦ã€‚
21: if (cache != null) {
22: // è·å¾— Cache Key
23: String key = StringUtils.toArgumentString(invocation.getArguments());
24: // ä»ç¼“å­˜ä¸­è·å¾—ç»“æœã€‚è‹¥å­˜åœ¨ï¼Œåˆ›å»º RpcResult å¯¹è±¡ã€‚
25: Object value = cache.get(key);
26: if (value != null) {
27: return new RpcResult(value);
28: }
29: // æœåŠ¡è°ƒç”¨
30: Result result = invoker.invoke(invocation);
31: // è‹¥éå¼‚å¸¸ç»“æœï¼Œç¼“å­˜ç»“æœ
32: if (!result.hasException()) {
33: cache.put(key, result.getValue());
34: }
35: return result;
36: }
37: }
38: // æœåŠ¡è°ƒç”¨
39: return invoker.invoke(invocation);
40: }
41:
42: }
```

- ç¬¬ 18 è¡Œï¼šåˆ¤æ–­æ–¹æ³•**å¼€å¯** Cache åŠŸèƒ½ã€‚å› ä¸ºï¼Œä¸€ä¸ªæœåŠ¡é‡Œï¼Œå¯èƒ½åªæœ‰**éƒ¨åˆ†**æ–¹æ³•å¼€å¯äº† Cache åŠŸèƒ½ã€‚
- ç¬¬ 20 è¡Œï¼šè°ƒç”¨

CacheFactory$Adaptive/#getCache(url)
æ–¹æ³•ï¼ŒåŸºäº **URL + Method** ä¸ºç»´åº¦ï¼Œè·å¾— Cache å¯¹è±¡ã€‚

- ç¬¬ 23 è¡Œï¼šè°ƒç”¨

StringUtils/#toArgumentString(Object[] args)
æ–¹æ³•ï¼Œè·å¾— Cache Key ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
//*/*
/* å°†å‚æ•°æ•°ç»„ï¼Œæ‹¼æ¥æˆå­—ç¬¦ä¸²ã€‚
/*
/* 1. ä½¿ç”¨é€—å·åˆ†éš”
/* 2. ä½¿ç”¨ JSON æ ¼å¼åŒ–å¯¹è±¡
/*
/* @param args å‚æ•°æ•°ç»„
/* @return å­—ç¬¦ä¸²
/*/
public static String toArgumentString(Object[] args){
StringBuilder buf = new StringBuilder();
for (Object arg : args) {
if (buf.length() > 0) {
buf.append(Constants.COMMA_SEPARATOR); // åˆ†éš”
}
// æ‹¼æ¥å‚æ•°
if (arg == null || ReflectUtils.isPrimitives(arg.getClass())) {
buf.append(arg);
} else {
try {
buf.append(JSON.toJSONString(arg)); // ä½¿ç”¨ JSON æ ¼å¼åŒ–å¯¹è±¡
} catch (Exception e) {
logger.warn(e.getMessage(), e);
buf.append(arg);
}
}
}
return buf.toString();
}
```

- ç¬¬ 24 è‡³ 28 è¡Œï¼šè°ƒç”¨

Cache/#get(key)
æ–¹æ³•ï¼Œä»ç¼“å­˜ä¸­è·å¾—ç»“æœã€‚è‹¥**å­˜åœ¨**ï¼Œåˆ›å»º RpcResult å¯¹è±¡å¹¶è¿”å›ã€‚

- ç¬¬ 30 è¡Œï¼šè°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚

- ç¬¬ 31 è‡³ 34 è¡Œï¼šè‹¥**éå¼‚å¸¸**ï¼Œè°ƒç”¨

Cache/#put(key, value)
æ–¹æ³•ï¼Œç¼“å­˜**æ­£å¸¸çš„**ç»“æœã€‚

- ç¬¬ 35 è¡Œï¼šè¿”å›è°ƒç”¨ç»“æœã€‚
- ç¬¬ 39 è¡Œï¼šè‹¥**ä¸ä½¿ç”¨** Cache åŠŸèƒ½ï¼Œ**ç›´æ¥**è°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚

# 3. API å®šä¹‰

## 3.1 Cache

com.alibaba.dubbo.cache.Cache
ï¼Œç¼“å­˜**å®¹å™¨**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
public interface Cache{
//*/*
/* æ·»åŠ é”®å€¼
/*
/* @param key é”®
/* @param value å€¼
/*/
void put(Object key, Object value);
//*/*
/* è·å¾—å€¼
/*
/* @param key é”®
/* @return å€¼
/*/
Object get(Object key);
}
```

- Cache æ˜¯ä¸ªç¼“å­˜**å®¹å™¨**ï¼Œå†…éƒ¨å¯ä»¥**ç®¡ç†**ç¼“å­˜çš„é”®å€¼ã€‚

## 3.2 CacheFactory

com.alibaba.dubbo.cache.CacheFactory
ï¼ŒCache å·¥å‚**æ¥å£**ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
@SPI("lru")
public interface CacheFactory{
//*/*
/* è·å¾—ç¼“å­˜å¯¹è±¡
/*
/* @param url URL å¯¹è±¡
/* @return ç¼“å­˜å¯¹è±¡
/*/
@Adaptive("cache")
Cache getCache(URL url);
}
```

- @SPI("lru")
  æ³¨è§£ï¼ŒDubbo SPI **æ‹“å±•ç‚¹**ï¼Œé»˜è®¤ä¸º

"lru"
ã€‚

- @Adaptive("cache")
  æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Cache å®ç°ï¼Œä½¿ç”¨

URL.cache
å±æ€§ã€‚

### 3.2.1 AbstractCacheFactory

com.alibaba.dubbo.cache.support.AbstractCacheFactory
ï¼ŒCache å·¥å‚**æŠ½è±¡ç±»**ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public abstract class AbstractCacheFactory implements CacheFactory{
//*/*
/* Cache é›†åˆ
/*
/* keyï¼šURL
/*/
private final ConcurrentMap<String, Cache> caches = new ConcurrentHashMap<String, Cache>();
@Override
public Cache getCache(URL url){
// è·å¾— Cache å¯¹è±¡
String key = url.toFullString();
Cache cache = caches.get(key);
// ä¸å­˜åœ¨ï¼Œåˆ›å»º Cache å¯¹è±¡ï¼Œå¹¶ç¼“å­˜
if (cache == null) {
caches.put(key, createCache(url));
cache = caches.get(key);
}
return cache;
}
//*/*
/* åˆ›å»º Cache å¯¹è±¡
/*
/* @param url URL
/* @return Cache å¯¹è±¡
/*/
protected abstract Cache createCache(URL url);
}
```

# 4. LRU å®ç°

lru
ï¼ŒåŸºäºæœ€è¿‘æœ€å°‘ä½¿ç”¨åŸåˆ™åˆ é™¤å¤šä½™ç¼“å­˜ï¼Œä¿æŒæœ€çƒ­çš„æ•°æ®è¢«ç¼“å­˜ã€‚

## 4.1 LruCache

com.alibaba.dubbo.cache.support.lru.LruCache
ï¼Œå®ç° Cache æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public class LruCache implements Cache{
//*/*
/* ç¼“å­˜é›†åˆ
/*/
private final Map<Object, Object> store;
public LruCache(URL url){
// `"cache.size"` é…ç½®é¡¹ï¼Œè®¾ç½®ç¼“å­˜å¤§å°
final int max = url.getParameter("cache.size", 1000);
// åˆ›å»º LRUCache å¯¹è±¡
this.store = new LRUCache<Object, Object>(max);
}
@Override
public void put(Object key, Object value){
store.put(key, value);
}
@Override
public Object get(Object key){
return store.get(key);
}
}
```

- "cache.size"
  é…ç½®é¡¹ï¼Œè®¾ç½®ç¼“å­˜**å¤§å°**ã€‚
- åŸºäº

com.alibaba.dubbo.common.utils.LRUCache
å®ç°ã€‚

### 4.1.1 LRUCache

[
com.alibaba.dubbo.common.utils.LRUCache
](https://github.com/YunaiV/dubbo/blob/26d2f1811c23096224fc9a973b3526f01aabeb28/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/LRUCache.java) ï¼Œå®ç° LinkedHashMap ç±»ï¼ŒLRU ç¼“å­˜å®ç°ç±»ã€‚ä»£ç æ¯”è¾ƒå¤šï¼Œèƒ–å‹ç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚ç¬”è€…è¯´å‡ ä¸ªå…³é”®ç‚¹ï¼š

- æ„é€ æ–¹æ³•ï¼Œè®¾ç½® LRUCache ä¸º**æŒ‰è®¿é—®é¡ºåº(è°ƒç”¨ get æ–¹æ³•)**çš„é“¾è¡¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public LRUCache(int maxCapacity){
super(16, DEFAULT_LOAD_FACTOR, true); // æœ€åä¸€ä¸ªå‚æ•°ï¼ŒæŒ‰è®¿é—®é¡ºåº(è°ƒç”¨getæ–¹æ³•)çš„é“¾è¡¨
this.maxCapacity = maxCapacity;
}
```

- é‡å†™ removeEldestEntry æ–¹æ³•è¿”å› true å€¼ï¼ŒæŒ‡å®šæ’å…¥å…ƒç´ æ—¶ç§»é™¤æœ€è€çš„å…ƒç´ ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@Override
protected boolean removeEldestEntry(java.util.Map.Entry<K, V> eldest){
return size() > maxCapacity;
}
```

- æ ¹æ®é“¾è¡¨ä¸­å…ƒç´ çš„é¡ºåºå¯ä»¥åˆ†ä¸ºï¼šæŒ‰æ’å…¥é¡ºåºçš„é“¾è¡¨ï¼Œå’ŒæŒ‰è®¿é—®é¡ºåº(è°ƒç”¨ get æ–¹æ³•)çš„é“¾è¡¨ã€‚é»˜è®¤æ˜¯æŒ‰æ’å…¥é¡ºåºæ’åºï¼Œå¦‚æœæŒ‡å®šæŒ‰è®¿é—®é¡ºåºæ’åºï¼Œé‚£ä¹ˆè°ƒç”¨ get æ–¹æ³•åï¼Œä¼šå°†è¿™æ¬¡è®¿é—®çš„å…ƒç´ ç§»è‡³é“¾è¡¨å°¾éƒ¨ï¼Œä¸æ–­è®¿é—®å¯ä»¥å½¢æˆæŒ‰è®¿é—®é¡ºåºæ’åºçš„é“¾è¡¨ã€‚
- lock
  å±æ€§ï¼Œé”ã€‚é¿å…å¹¶å‘è¯»å†™ï¼Œå¯¼è‡´æ­»é”ã€‚å‚è§ [ã€Šç–«è‹—ï¼šJAVA HashMap çš„æ­»å¾ªç¯ã€‹](https://coolshell.cn/articles/9606.html) ã€‚æ¶‰åŠè¯¥å±æ€§çš„æ–¹æ³•ç¤ºä¾‹ï¼š

```
@Override
public V put(K key, V value){
try {
lock.lock();
return super.put(key, value);
} finally {
lock.unlock();
}
}
@Override
public V remove(Object key){
try {
lock.lock();
return super.remove(key);
} finally {
lock.unlock();
}
}
```

## 4.2 LruCacheFactory

com.alibaba.dubbo.cache.support.lru.LruCacheFactory
ï¼Œå®ç° AbstractCacheFactory æŠ½è±¡ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public class LruCacheFactory extends AbstractCacheFactory{
@Override
protected Cache createCache(URL url){
return new LruCache(url);
}
}
```

# 5. ThreadLocal å®ç°

åŸºäº **ThreadLocal** ï¼Œå½“å‰çº¿ç¨‹ç¼“å­˜ï¼Œæ¯”å¦‚ä¸€ä¸ªé¡µé¢æ¸²æŸ“ï¼Œç”¨åˆ°å¾ˆå¤š portalï¼Œæ¯ä¸ª portal éƒ½è¦å»æŸ¥ç”¨æˆ·ä¿¡æ¯ï¼Œé€šè¿‡çº¿ç¨‹ç¼“å­˜ï¼Œå¯ä»¥å‡å°‘è¿™ç§å¤šä½™è®¿é—®ã€‚

## 5.1 ThreadLocalCache

com.alibaba.dubbo.cache.support.threadlocal.ThreadLocalCache
ï¼Œå®ç° Cache æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public class ThreadLocalCache implements Cache{
private final ThreadLocal<Map<Object, Object>> store; // çº¿ç¨‹å˜é‡
public ThreadLocalCache(URL url){
this.store = new ThreadLocal<Map<Object, Object>>() {
@Override
protected Map<Object, Object> initialValue(){
return new HashMap<Object, Object>();
}
};
}
@Override
public void put(Object key, Object value){
store.get().put(key, value);
}
@Override
public Object get(Object key){
return store.get().get(key);
}
}
```

- åŸºäº ThreadLocal å®ç°ï¼Œç›¸å½“äºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ª ThreadLocalCache å¯¹è±¡ã€‚
- ğŸ™‚ ThreadLocalCache ç›®å‰æ²¡æœ‰è¿‡æœŸæˆ–æ¸…ç†æœºåˆ¶ï¼Œæ‰€ä»¥**éœ€è¦æ³¨æ„**ã€‚

## 5.2 ThreadLocalCacheFactory

com.alibaba.dubbo.cache.support.threadlocal.ThreadLocalCacheFactory
ï¼Œå®ç° AbstractCacheFactory æŠ½è±¡ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public class ThreadLocalCacheFactory extends AbstractCacheFactory{
@Override
protected Cache createCache(URL url){
return new ThreadLocalCache(url);
}
}
```

# 6. JCache å®ç°

ä¸ [JSR107](https://jcp.org/en/jsr/detail?id=107) é›†æˆï¼Œå¯ä»¥æ¡¥æ¥å„ç§ç¼“å­˜å®ç°ã€‚

## 6.1 JCache

com.alibaba.dubbo.cache.support.jcache.JCache
ï¼Œå®ç° Cache æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public class JCache implements com.alibaba.dubbo.cache.Cache{
private final Cache<Object, Object> store;
public JCache(URL url){
// è·å¾— Cache Key
String method = url.getParameter(Constants.METHOD_KEY, "");
String key = url.getAddress() + "." + url.getServiceKey() + "." + method;
// `"jcache"` é…ç½®é¡¹ï¼Œä¸º Java SPI å®ç°çš„å…¨é™å®šç±»å
// jcache parameter is the full-qualified class name of SPI implementation
String type = url.getParameter("jcache");
// åŸºäºç±»å‹ï¼Œè·å¾— javax.cache.CachingProvider å¯¹è±¡ï¼Œ
CachingProvider provider = type == null || type.length() == 0 ? Caching.getCachingProvider() : Caching.getCachingProvider(type);
// è·å¾— javax.cache.CacheManager å¯¹è±¡
CacheManager cacheManager = provider.getCacheManager();
// è·å¾— javax.cache.Cache å¯¹è±¡
Cache<Object, Object> cache = cacheManager.getCache(key);
// ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œåˆ›å»º
if (cache == null) {
try {
// è®¾ç½® Cache é…ç½®é¡¹
// configure the cache
MutableConfiguration config =
new MutableConfiguration<Object, Object>()
// ç±»å‹
.setTypes(Object.class, Object.class)
// è¿‡æœŸç­–ç•¥ï¼ŒæŒ‰ç…§å†™å…¥æ—¶é—´è¿‡æœŸã€‚é€šè¿‡ `"cache.write.expire"` é…ç½®é¡¹è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤ä¸º 1 åˆ†é’Ÿã€‚
.setExpiryPolicyFactory(CreatedExpiryPolicy.factoryOf(new Duration(TimeUnit.MILLISECONDS, url.getMethodParameter(method, "cache.write.expire", 60 /* 1000))))
.setStoreByValue(false)
// è®¾ç½® MBean
.setManagementEnabled(true)
.setStatisticsEnabled(true);
// åˆ›å»º javax.cache.Cache å¯¹è±¡
cache = cacheManager.createCache(key, config);
} catch (CacheException e) {
// åˆå§‹åŒ– cache çš„å¹¶å‘æƒ…å†µ
// concurrent cache initialization
cache = cacheManager.getCache(key);
}
}
this.store = cache;
}
@Override
public void put(Object key, Object value){
store.put(key, value);
}
@Override
public Object get(Object key){
return store.get(key);
}
}
```

- å·²ç»æ·»åŠ è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚
- ç¬”è€…å¯¹ JCache äº†è§£ä¸å¤šï¼Œæ¨èé˜…è¯» [ã€Š Java Caching(ç¼“å­˜)-ç­–ç•¥å’Œ JCache APIã€‹](https://blog.csdn.net/boonya/article/details/54632129)

## 6.2 JCacheFactory

com.alibaba.dubbo.cache.support.jcache.JCacheFactory
ï¼Œå®ç° AbstractCacheFactory æŠ½è±¡ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public class JCacheFactory extends AbstractCacheFactory{
@Override
protected Cache createCache(URL url){
return new JCache(url);
}
}
```
