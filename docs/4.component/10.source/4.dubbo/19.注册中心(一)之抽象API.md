# æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ API

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” é¡¹ç›®ç»“æ„ä¸€è§ˆã€‹ã€Œ3.5 dubbo-registryã€](http://svip.iocoder.cn/Dubbo/registry-api/) ä¸­ï¼Œå¯¹

dubbo-registry
**æ³¨å†Œä¸­å¿ƒ**è¿™ä¸ªå¤§æ¨¡å—åšäº†å¤§ä½“çš„ä»‹ç»ã€‚é‚£ä¹ˆä»æœ¬æ–‡å¼€å§‹ï¼Œåˆ†äº«æ³¨å†Œä¸­å¿ƒçš„ä»£ç å®ç°ã€‚

æœ¬æ–‡åˆ†äº«

dubbo-registry-api
æ¨¡å—ï¼Œæ³¨å†Œä¸­å¿ƒçš„æŠ½è±¡ API ï¼Œç±»ç»“æ„å¦‚ä¸‹å›¾ï¼š

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_08_01/01.png)

ğŸ˜ˆ æ•´ä½“æ¯”è¾ƒæ˜“æ‡‚ï¼Œç¬”è€…åœ¨è¿™é‡Œå…ˆä¸ä»‹ç»ï¼Œèƒ–å‹å¯ä»¥çœ‹å®Œæœ¬æ–‡ï¼Œå›è¿‡å¤´çœ‹çœ‹ï¼Œè‡ªå·±æ˜¯ä¸æ˜¯ç†è§£äº†ï¼Ÿï¼

ä¸‹é¢ï¼Œæˆ‘ä»¬æŒ‰ç…§ä»å·¦åˆ°å³çš„é¡ºåºï¼Œé€ä¸ªåˆ†äº«ã€‚

# 2. RegistryFactory

[
com.alibaba.dubbo.registry.RegistryFactory
](https://github.com/YunaiV/dubbo/blob/7ece72959dd8c96e17fc240a2b22b40391265bcc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/RegistryFactory.java) ï¼Œæ³¨å†Œä¸­å¿ƒå·¥å‚**æ¥å£**ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
@SPI("dubbo")
public interface RegistryFactory{
//*/*
/* è¿æ¥æ³¨å†Œä¸­å¿ƒ.
/* <p>
/* è¿æ¥æ³¨å†Œä¸­å¿ƒéœ€å¤„ç†å¥‘çº¦ï¼š<br>
/* 1. å½“è®¾ç½®check=falseæ—¶è¡¨ç¤ºä¸æ£€æŸ¥è¿æ¥ï¼Œå¦åˆ™åœ¨è¿æ¥ä¸ä¸Šæ—¶æŠ›å‡ºå¼‚å¸¸ã€‚<br>
/* 2. æ”¯æŒURLä¸Šçš„username:passwordæƒé™è®¤è¯ã€‚<br>
/* 3. æ”¯æŒbackup=10.20.153.10å¤‡é€‰æ³¨å†Œä¸­å¿ƒé›†ç¾¤åœ°å€ã€‚<br>
/* 4. æ”¯æŒfile=registry.cacheæœ¬åœ°ç£ç›˜æ–‡ä»¶ç¼“å­˜ã€‚<br>
/* 5. æ”¯æŒtimeout=1000è¯·æ±‚è¶…æ—¶è®¾ç½®ã€‚<br>
/* 6. æ”¯æŒsession=60000ä¼šè¯è¶…æ—¶æˆ–è¿‡æœŸè®¾ç½®ã€‚<br>
/*
/* @param url æ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œä¸å…è®¸ä¸ºç©º
/* @return æ³¨å†Œä¸­å¿ƒå¼•ç”¨ï¼Œæ€»ä¸è¿”å›ç©º
/*/
@Adaptive({"protocol"})
Registry getRegistry(URL url);
}
```

- RegistryFactory æ˜¯ä¸€ä¸ª Dubbo SPI æ‹“å±•æ¥å£ã€‚
- /#getRegistry(url)
  æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œä¸­å¿ƒ Registry å¯¹è±¡ã€‚

- æ³¨æ„æ–¹æ³•ä¸Šæ³¨é‡Šçš„**å¤„ç†å¥‘çº¦**ã€‚
- @Adaptive({"protocol"})
  æ³¨è§£ï¼ŒDubbo SPI ä¼šè‡ªåŠ¨å®ç° RegistryFactory$Adaptive ç±»ï¼Œæ ¹æ®

url.protocol
è·å¾—å¯¹åº”çš„ RegistryFactory å®ç°ç±»ã€‚ä¾‹å¦‚ï¼Œ

url.protocol = zookeeper
æ—¶ï¼Œè·å¾— ZookeeperRegistryFactory å®ç°ç±»ã€‚

## 2.1 AbstractRegistryFactory

[
com.alibaba.dubbo.registry.support.AbstractRegistryFactory
](https://github.com/YunaiV/dubbo/blob/7ece72959dd8c96e17fc240a2b22b40391265bcc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistryFactory.java) ï¼Œå®ç° RegistryFactory æ¥å£ï¼ŒRegistryFactory æŠ½è±¡ç±»ï¼Œå®ç°äº† Registry çš„**å®¹å™¨ç®¡ç†**ã€‚

### 2.1.1 å±æ€§

```
// The lock for the acquisition process of the registry
private static final ReentrantLock LOCK = new ReentrantLock();
//*/*
/* Registry é›†åˆ
/*
/* keyï¼š{@link URL/#toServiceString()}
/*/
// Registry Collection Map<RegistryAddress, Registry>
private static final Map<String, Registry> REGISTRIES = new ConcurrentHashMap<String, Registry>();
```

- REGISTRIES
  é™æ€å±æ€§ï¼ŒRegistry é›†åˆã€‚
- LOCK
  é™æ€å±æ€§ï¼Œé”ï¼Œç”¨äº

/#destroyAll()
å’Œ

/#getRegistry(url)
æ–¹æ³•ï¼Œå¯¹

REGISTRIES
è®¿é—®çš„ç«äº‰ã€‚

### 2.1.2 createRegistry

/#createRegistry(url)
**æŠ½è±¡**æ–¹æ³•ï¼Œåˆ›å»º Registry å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
//*/*
/* åˆ›å»º Registry å¯¹è±¡
/*
/* @param url æ³¨å†Œä¸­å¿ƒåœ°å€
/* @return Registry å¯¹è±¡
/*/
protected abstract Registry createRegistry(URL url);
```

å­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œåˆ›å»ºå…¶å¯¹åº”çš„ Registry å®ç°ç±»ã€‚ä¾‹å¦‚ï¼ŒZookeeperRegistryFactory çš„è¯¥æ–¹æ³•ï¼Œåˆ›å»º ZookeeperRegistry å¯¹è±¡ã€‚

### 2.1.3 getRegistry

[
/#getRegistry(url)
](https://github.com/YunaiV/dubbo/blob/d7c9cec324901c8285e602fdd3256cc9f5586357/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistryFactory.java#L96-L132) **å®ç°**æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œä¸­å¿ƒ Registry å¯¹è±¡ã€‚ä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–ï¼Œå¦åˆ™è¿›è¡Œåˆ›å»ºã€‚

- ğŸ™‚ å®ç°æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ï¼Œæœ‰ä»£ç æ³¨é‡Šã€‚

### 2.1.4 destroyAll

[
/#destroyAll()
](https://github.com/YunaiV/dubbo/blob/d7c9cec324901c8285e602fdd3256cc9f5586357/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistryFactory.java#L65-L94) æ–¹æ³•ï¼Œé”€æ¯æ‰€æœ‰ Registry å¯¹è±¡ã€‚

- ğŸ™‚ å®ç°æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ï¼Œæœ‰ä»£ç æ³¨é‡Šã€‚

# 3. RegistryService

[
com.alibaba.dubbo.registry.RegistryService
](https://github.com/YunaiV/dubbo/blob/f2458c11b045f85f654ed1719c75f9b0ba6397fe/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/RegistryService.java) ï¼Œæ³¨å†Œä¸­å¿ƒæœåŠ¡**æ¥å£**ï¼Œå®šä¹‰äº†æ³¨å†Œã€è®¢é˜…ã€æŸ¥è¯¢**ä¸‰ç§**æ“ä½œæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

- /#register(url)
  æ–¹æ³•ï¼Œ**æ³¨å†Œ**æ•°æ®ï¼Œæ¯”å¦‚ï¼šæä¾›è€…åœ°å€ï¼Œæ¶ˆè´¹è€…åœ°å€ï¼Œè·¯ç”±è§„åˆ™ï¼Œè¦†ç›–è§„åˆ™ï¼Œç­‰æ•°æ®ã€‚

- /#unregister(url)
  æ–¹æ³•ï¼Œå–æ¶ˆæ³¨å†Œã€‚

- /#subscribe(url, NotifyListener)
  æ–¹æ³•ï¼Œ**è®¢é˜…**ç¬¦åˆæ¡ä»¶çš„å·²æ³¨å†Œæ•°æ®ï¼Œå½“æœ‰æ³¨å†Œæ•°æ®å˜æ›´æ—¶è‡ªåŠ¨æ¨é€ã€‚

- /#unsubscribe(url, NotifyListener)
  æ–¹æ³•ï¼Œå–æ¶ˆè®¢é˜…ã€‚
- åœ¨

URL.parameters.category
å±æ€§ä¸Šï¼Œè¡¨ç¤ºè®¢é˜…çš„æ•°æ®åˆ†ç±»ã€‚ç›®å‰æœ‰å››ç§ç±»å‹ï¼š

- consumers
  ï¼ŒæœåŠ¡æ¶ˆè´¹è€…åˆ—è¡¨ã€‚
- providers
  ï¼ŒæœåŠ¡æä¾›è€…åˆ—è¡¨ã€‚
- routers
  ï¼Œ[è·¯ç”±è§„åˆ™](http://dubbo.apache.org/zh-cn/docs/user/demos/routing-rule.html)åˆ—è¡¨ã€‚
- configurations
  ï¼Œ[é…ç½®è§„åˆ™](http://dubbo.apache.org/zh-cn/docs/user/demos/config-rule.html)åˆ—è¡¨ã€‚
- /#lookup(url)
  æ–¹æ³•ï¼Œ**æŸ¥è¯¢**ç¬¦åˆæ¡ä»¶çš„å·²æ³¨å†Œæ•°æ®ï¼Œä¸è®¢é˜…çš„æ¨æ¨¡å¼ç›¸å¯¹åº”ï¼Œè¿™é‡Œä¸ºæ‹‰æ¨¡å¼ï¼Œåªè¿”å›ä¸€æ¬¡ç»“æœã€‚

psï¼šæ³¨æ„æ–¹æ³•ä¸Šæ³¨é‡Šçš„å¤„ç†å¥‘çº¦ã€‚

## 3.1 Registry

[
com.alibaba.dubbo.registry.Registry
](https://github.com/YunaiV/dubbo/blob/f2458c11b045f85f654ed1719c75f9b0ba6397fe/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/Registry.java) ï¼Œæ³¨å†Œä¸­å¿ƒ**æ¥å£**ã€‚Registry ç»§æ‰¿äº†ï¼š

- RegistryService æ¥å£ï¼Œæ‹¥æœ‰æ‹¥æœ‰æ³¨å†Œã€è®¢é˜…ã€æŸ¥è¯¢ä¸‰ç§æ“ä½œæ–¹æ³•ã€‚
- [
  com.alibaba.dubbo.common.Node
  ](https://github.com/YunaiV/dubbo/blob/f2458c11b045f85f654ed1719c75f9b0ba6397fe/dubbo-common/src/main/java/com/alibaba/dubbo/common/Node.java) æ¥å£ï¼Œæ‹¥æœ‰èŠ‚ç‚¹ç›¸å…³çš„æ–¹æ³•ã€‚

## 3.2 AbstractRegistry

[
com.alibaba.dubbo.registry.support.AbstractRegistry
](http://svip.iocoder.cn/Dubbo/registry-api/) ï¼Œå®ç° Registry æ¥å£ï¼ŒRegistry æŠ½è±¡ç±»ï¼Œå®ç°äº†å¦‚ä¸‹æ–¹æ³•ï¼š

- é€šç”¨çš„æ³¨å†Œã€è®¢é˜…ã€æŸ¥è¯¢ã€é€šçŸ¥ç­‰æ–¹æ³•ã€‚
- æŒä¹…åŒ–æ³¨å†Œæ•°æ®åˆ°æ–‡ä»¶ï¼Œä»¥ properties æ ¼å¼å­˜å‚¨ã€‚åº”ç”¨äºï¼Œé‡å¯æ—¶ï¼Œæ— æ³•ä»æ³¨å†Œä¸­å¿ƒåŠ è½½æœåŠ¡æä¾›è€…åˆ—è¡¨ç­‰ä¿¡æ¯æ—¶ï¼Œä»è¯¥æ–‡ä»¶ä¸­è¯»å–ã€‚

### 3.2.1 å±æ€§

```
1: // URLåœ°å€åˆ†éš”ç¬¦ï¼Œç”¨äºæ–‡ä»¶ç¼“å­˜ä¸­ï¼ŒæœåŠ¡æä¾›è€…URLåˆ†éš”
2: // URL address separator, used in file cache, service provider URL separation
3: private static final char URL_SEPARATOR = ' ';
4: // URLåœ°å€åˆ†éš”æ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨äºè§£ææ–‡ä»¶ç¼“å­˜ä¸­æœåŠ¡æä¾›è€…URLåˆ—è¡¨
5: // URL address separated regular expression for parsing the service provider URL list in the file cache
6: private static final String URL_SPLIT = "\\s+";
7:
8: // Log output
9: protected final Logger logger = LoggerFactory.getLogger(getClass());
10: //*/*
11: /* æœ¬åœ°ç£ç›˜ç¼“å­˜ã€‚
12: /*
13: /* 1. å…¶ä¸­ç‰¹æ®Šçš„ key å€¼ .registies è®°å½•æ³¨å†Œä¸­å¿ƒåˆ—è¡¨
14: /* 2. å…¶å®ƒå‡ä¸º {@link /#notified} æœåŠ¡æä¾›è€…åˆ—è¡¨
15: /*/
16: // Local disk cache, where the special key value.registies records the list of registry centers, and the others are the list of notified service providers
17: private final Properties properties = new Properties();
18: //*/*
19: /* æ³¨å†Œä¸­å¿ƒç¼“å­˜å†™å…¥æ‰§è¡Œå™¨ã€‚
20: /*
21: /* çº¿ç¨‹æ•°=1
22: /*/
23: // File cache timing writing
24: private final ExecutorService registryCacheExecutor = Executors.newFixedThreadPool(1, new NamedThreadFactory("DubboSaveRegistryCache", true));
25: //*/*
26: /* æ˜¯å¦åŒæ­¥ä¿å­˜æ–‡ä»¶
27: /*/
28: // Is it synchronized to save the file
29: private final boolean syncSaveFile;
30: //*/*
31: /* æ•°æ®ç‰ˆæœ¬å·
32: /*
33: /* {@link /#properties}
34: /*/
35: private final AtomicLong lastCacheChanged = new AtomicLong();
36: //*/*
37: /* å·²æ³¨å†Œ URL é›†åˆã€‚
38: /*
39: /* æ³¨æ„ï¼Œæ³¨å†Œçš„ URL ä¸ä»…ä»…å¯ä»¥æ˜¯æœåŠ¡æä¾›è€…çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡æ¶ˆè´¹è€…çš„
40: /*/
41: private final Set<URL> registered = new ConcurrentHashSet<URL>();
42: //*/*
43: /* è®¢é˜… URL çš„ç›‘å¬å™¨é›†åˆ
44: /*
45: /* keyï¼šæ¶ˆè´¹è€…çš„ URL ï¼Œä¾‹å¦‚æ¶ˆè´¹è€…çš„ URL
46: /*/
47: private final ConcurrentMap<URL, Set<NotifyListener>> subscribed = new ConcurrentHashMap<URL, Set<NotifyListener>>();
48: //*/*
49: /* è¢«é€šçŸ¥çš„ URL é›†åˆ
50: /*
51: /* key1ï¼šæ¶ˆè´¹è€…çš„ URL ï¼Œä¾‹å¦‚æ¶ˆè´¹è€…çš„ URL ï¼Œå’Œ {@link /#subscribed} çš„é”®ä¸€è‡´
52: /* key2ï¼šåˆ†ç±»ï¼Œä¾‹å¦‚ï¼šprovidersã€consumersã€routesã€configuratorsã€‚ã€å®é™…æ—  consumers ï¼Œå› ä¸ºæ¶ˆè´¹è€…ä¸ä¼šå»è®¢é˜…å¦å¤–çš„æ¶ˆè´¹è€…çš„åˆ—è¡¨ã€‘
53: /* åœ¨ {@link Constants} ä¸­ï¼Œä»¥ "_CATEGORY" ç»“å°¾
54: /*/
55: private final ConcurrentMap<URL, Map<String, List<URL>>> notified = new ConcurrentHashMap<URL, Map<String, List<URL>>>();
56: //*/*
57: /* æ³¨å†Œä¸­å¿ƒ URL
58: /*/
59: private URL registryUrl;
60: //*/*
61: /* æœ¬åœ°ç£ç›˜ç¼“å­˜æ–‡ä»¶ï¼Œç¼“å­˜æ³¨å†Œä¸­å¿ƒçš„æ•°æ®
62: /*/
63: // Local disk cache file
64: private File file;
65: //*/*
66: /* æ˜¯å¦é”€æ¯
67: /*/
68: private AtomicBoolean destroyed = new AtomicBoolean(false);
69:
70: public AbstractRegistry(URL url){
71: setUrl(url);
72: // Start file save timer
73: syncSaveFile = url.getParameter(Constants.REGISTRY_FILESAVE_SYNC_KEY, false);
74: // è·å¾— `file`
75: String filename = url.getParameter(Constants.FILE_KEY, System.getProperty("user.home") + "/.dubbo/dubbo-registry-" + url.getParameter(Constants.APPLICATION_KEY) + "-" + url.getAddress() + ".cache");
76: File file = null;
77: if (ConfigUtils.isNotEmpty(filename)) {
78: file = new File(filename);
79: if (!file.exists() && file.getParentFile() != null && !file.getParentFile().exists()) {
80: if (!file.getParentFile().mkdirs()) {
81: throw new IllegalArgumentException("Invalid registry store file " + file + ", cause: Failed to create directory " + file.getParentFile() + "!");
82: }
83: }
84: }
85: this.file = file;
86: // åŠ è½½æœ¬åœ°ç£ç›˜ç¼“å­˜æ–‡ä»¶åˆ°å†…å­˜ç¼“å­˜
87: loadProperties();
88: // é€šçŸ¥ç›‘å¬å™¨ï¼ŒURL å˜åŒ–ç»“æœ
89: notify(url.getBackupUrls());
90: }
```

- file
  å±æ€§ï¼Œ_è§ä»£ç æ³¨é‡Š_ã€‚
- properties
  å±æ€§ï¼Œ_è§ä»£ç æ³¨é‡Š_ã€‚

- æ•°æ®æµå‘

- å¯åŠ¨æ—¶ï¼Œä»

file
è¯»å–æ•°æ®åˆ°

properties
ä¸­ã€‚

- æ³¨å†Œä¸­å¿ƒæ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼Œé€šçŸ¥åˆ° Registry åï¼Œä¿®æ”¹

properties
å¯¹åº”çš„å€¼ï¼Œå¹¶å†™å…¥

file
ã€‚

- æ•°æ®é”®å€¼

- å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé”®ä¸ºæœåŠ¡æ¶ˆè´¹è€…çš„ URL çš„æœåŠ¡é”®(

URL/#serviceKey()
)ï¼Œå¯¹åº”çš„å€¼ä¸ºæœåŠ¡æä¾›è€…åˆ—è¡¨ã€[è·¯ç”±è§„åˆ™](http://dubbo.apache.org/zh-cn/docs/user/demos/config-rule.html)åˆ—è¡¨ã€[é…ç½®è§„åˆ™](http://dubbo.apache.org/zh-cn/docs/user/demos/routing-rule.html)åˆ—è¡¨ã€‚

- ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œã€TODO 8019ã€‘.registies
- å› ä¸ºå€¼ä¼šå­˜åœ¨ä¸ºåˆ—è¡¨çš„æƒ…å†µï¼Œä½¿ç”¨ç©ºæ ¼(

URL_SEPARATOR
) åˆ†éš”ã€‚

- syncSaveFile
  å±æ€§ï¼Œ

properties
å‘ç”Ÿå˜æ›´æ—¶å€™ï¼Œæ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥å†™å…¥

file
ã€‚

- registryCacheExecutor
  å±æ€§ï¼Œ_è§ä»£ç æ³¨é‡Š_ã€‚
- lastCacheChanged
  å±æ€§ï¼Œ_è§ä»£ç æ³¨é‡Š_ã€‚

- å› ä¸ºæ¯æ¬¡å†™å…¥

file
æ˜¯å…¨é‡ï¼Œè€Œä¸æ˜¯å¢é‡å†™å…¥ï¼Œé€šè¿‡ç‰ˆæœ¬å·ï¼Œé¿å…è€ç‰ˆæœ¬è¦†ç›–æ–°ç‰ˆæœ¬ã€‚

- registered
  å±æ€§ï¼Œ_è§ä»£ç æ³¨é‡Š_ã€‚
- subscribed
  å±æ€§ï¼Œ_è§ä»£ç æ³¨é‡Š_ã€‚
- notified
  å±æ€§ï¼Œ_è§ä»£ç æ³¨é‡Š_ã€‚

- ä»æ•°æ®ä¸Šï¼Œå’Œ

properties
æ¯”è¾ƒç›¸ä¼¼ã€‚ç¬”è€…è®¤ä¸ºæœ‰ä¸¤ç‚¹å·®å¼‚ï¼š1ï¼‰æ•°æ®æ ¼å¼ä¸Šï¼Œ

notified
æ ¹æ®**åˆ†ç±»**åšäº†èšåˆï¼›2ï¼‰ä¸ä»

file
ä¸­è¯»å–ï¼Œéƒ½æ˜¯ä»æ³¨å†Œä¸­å¿ƒè¯»å–çš„æ•°æ®ã€‚

- registryUrl
  å±æ€§ï¼Œ_è§ä»£ç æ³¨é‡Š_ã€‚
- destroyed
  å±æ€§ï¼Œ_è§ä»£ç æ³¨é‡Š_ã€‚
- **æ„é€ æ–¹æ³•**ï¼Œ_è§ä»£ç æ³¨é‡Š_ã€‚

- ç¬¬ 87 è¡Œï¼šè°ƒç”¨ [
  /#loadProperties()
  ](https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L265-L291) æ–¹æ³•ï¼ŒåŠ è½½æœ¬åœ°ç£ç›˜ç¼“å­˜æ–‡ä»¶åˆ°å†…å­˜ç¼“å­˜ã€‚

- ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚
- ç¬¬ 89 è¡Œï¼š// ã€TODO 8020ã€‘ä¸ºä»€ä¹ˆæ„é€ æ–¹æ³•ï¼Œè¦é€šçŸ¥ï¼Œè¿ç›‘å¬å™¨éƒ½æ²¡æ³¨å†Œ

### 3.2.2 register && unregister

- [
  /#register(url)
  ](https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L356-L366)

- ä»å®ç°ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¹¶æœªå‘æ³¨å†Œä¸­å¿ƒå‘èµ·æ³¨å†Œï¼Œä»…ä»…æ˜¯æ·»åŠ åˆ°

registered
ä¸­ï¼Œè¿›è¡ŒçŠ¶æ€çš„ç»´æŠ¤ã€‚å®é™…ä¸Šï¼ŒçœŸæ­£çš„å®ç°åœ¨ FailbackRegistry ç±»ä¸­ã€‚

- [
  /#unregister(url)
  ](https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L368-L378)

- å’Œ

/#register(url)
çš„**å¤„ç†æ–¹å¼**ç›¸åŒã€‚

### 3.2.3 subscribe && unsubscribe

- [
  /#subscribe(url, listener)
  ](https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L380-L398)

- å’Œ

/#register(url)
çš„**å¤„ç†æ–¹å¼**ç›¸åŒã€‚

- [
  /#unsubscribe(url, listener)
  ](https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L400-L416)

- å’Œ

/#register(url)
çš„**å¤„ç†æ–¹å¼**ç›¸åŒã€‚

### 3.2.4 notify

[
/#notify(url, listener, urls)
](https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L477-L535) æ–¹æ³•ï¼Œé€šçŸ¥ç›‘å¬å™¨ï¼ŒURL å˜åŒ–ç»“æœã€‚è¿™é‡Œæˆ‘ä»¬æœ‰ä¸¤ç‚¹è¦æ³¨æ„ä¸‹ï¼š

- ç¬¬ä¸€ï¼Œå‘æ³¨å†Œä¸­å¿ƒå‘èµ·è®¢é˜…åï¼Œä¼šè·å–åˆ°**å…¨é‡**æ•°æ®ï¼Œæ­¤æ—¶ä¼šè¢«è°ƒç”¨

/#notify(...)
æ–¹æ³•ï¼Œå³ Registry è·å–åˆ°äº†å…¨é‡æ•°æ®ã€‚

- ç¬¬äºŒï¼Œæ¯æ¬¡æ³¨å†Œä¸­å¿ƒå‘ç”Ÿå˜æ›´æ—¶ï¼Œä¼šè°ƒç”¨

/#notify(...)
æ–¹æ³•ï¼Œè™½ç„¶å˜åŒ–æ˜¯**å¢é‡**ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨æ–¹ï¼Œå·²ç»è¿›è¡Œå¤„ç†ï¼Œä¼ å…¥çš„

urls
ä¾ç„¶æ˜¯**å…¨é‡**çš„ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```
1: //*/*
2: /* é€šçŸ¥ç›‘å¬å™¨ï¼ŒURL å˜åŒ–ç»“æœã€‚
3: /*
4: /* æ•°æ®æµå‘ `urls` => {@link /#notified} => {@link /#properties} => {@link /#file}
5: /*
6: /* @param url æ¶ˆè´¹è€… URL
7: /* @param listener ç›‘å¬å™¨
8: /* @param urls é€šçŸ¥çš„ URL å˜åŒ–ç»“æœï¼ˆå…¨é‡æ•°æ®ï¼‰
9: /*/
10: protected void notify(URL url, NotifyListener listener, List<URL> urls){
11: if (url == null) {
12: throw new IllegalArgumentException("notify url == null");
13: }
14: if (listener == null) {
15: throw new IllegalArgumentException("notify listener == null");
16: }
17: if ((urls == null || urls.isEmpty())
18: && !Constants.ANY_VALUE.equals(url.getServiceInterface())) {
19: logger.warn("Ignore empty notify urls for subscribe url " + url);
20: return;
21: }
22: if (logger.isInfoEnabled()) {
23: logger.info("Notify urls for subscribe url " + url + ", urls: " + urls);
24: }
25: // å°† `urls` æŒ‰ç…§ `url.parameter.category` åˆ†ç±»ï¼Œæ·»åŠ åˆ°é›†åˆ
26: Map<String, List<URL>> result = new HashMap<String, List<URL>>();
27: for (URL u : urls) {
28: if (UrlUtils.isMatch(url, u)) {
29: String category = u.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);
30: List<URL> categoryList = result.get(category);
31: if (categoryList == null) {
32: categoryList = new ArrayList<URL>();
33: result.put(category, categoryList);
34: }
35: categoryList.add(u);
36: }
37: }
38: if (result.size() == 0) {
39: return;
40: }
41: // è·å¾—æ¶ˆè´¹è€… URL å¯¹åº”çš„åœ¨ `notified` ä¸­ï¼Œé€šçŸ¥çš„ URL å˜åŒ–ç»“æœï¼ˆå…¨é‡æ•°æ®ï¼‰
42: Map<String, List<URL>> categoryNotified = notified.get(url);
43: if (categoryNotified == null) {
44: notified.putIfAbsent(url, new ConcurrentHashMap<String, List<URL>>());
45: categoryNotified = notified.get(url);
46: }
47: // å¤„ç†é€šçŸ¥çš„ URL å˜åŒ–ç»“æœï¼ˆå…¨é‡æ•°æ®ï¼‰
48: for (Map.Entry<String, List<URL>> entry : result.entrySet()) {
49: String category = entry.getKey();
50: List<URL> categoryList = entry.getValue();
51: // è¦†ç›–åˆ° `notified`
52: // å½“æŸä¸ªåˆ†ç±»çš„æ•°æ®ä¸ºç©ºæ—¶ï¼Œä¼šä¾ç„¶æœ‰ urls ã€‚å…¶ä¸­ `urls[0].protocol = empty` ï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå¤„ç†æ‰€æœ‰æœåŠ¡æä¾›è€…ä¸ºç©ºçš„æƒ…å†µã€‚
53: categoryNotified.put(category, categoryList);
54: // ä¿å­˜åˆ°æ–‡ä»¶
55: saveProperties(url);
56: // é€šçŸ¥ç›‘å¬å™¨
57: listener.notify(categoryList);
58: }
59: }
```

- ç¬¬ 25 è‡³ 37 è¡Œï¼šå°†

urls
æŒ‰ç…§

url.parameter.category
åˆ†ç±»ï¼Œæ·»åŠ åˆ°é›†åˆ

result
ä¸­ã€‚

- ç¬¬ 28 è¡Œï¼šTODO èŠ‹è‰¿
- è¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œæ¯æ¬¡ä¼ å…¥çš„

urls
çš„â€œ**å…¨é‡**â€ï¼ŒæŒ‡çš„æ˜¯è‡³å°‘è¦æ˜¯**ä¸€ä¸ªåˆ†ç±»**çš„å…¨é‡ï¼Œè€Œä¸ä¸€å®šæ˜¯å…¨éƒ¨æ•°æ®ã€‚

- ç¬¬ 41 è‡³ 46 è¡Œï¼šè·å¾—æ¶ˆè´¹è€… URL å¯¹åº”çš„åœ¨

notified
ä¸­çš„æ•°æ®ã€‚

- ç¬¬ 47 è‡³ 58 è¡Œï¼šæŒ‰ç…§**åˆ†ç±»**ï¼Œå¾ªç¯å¤„ç†é€šçŸ¥çš„ URL å˜åŒ–ç»“æœï¼ˆå…¨é‡æ•°æ®ï¼‰ã€‚

- ç¬¬ 51 è‡³ 53 è¡Œï¼šå°†

result
è¦†ç›–åˆ°

notified
ä¸­ã€‚è¿™é‡Œåˆæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå½“æŸä¸ªåˆ†ç±»çš„æ•°æ®ä¸ºç©ºæ—¶ï¼Œä¼šä¾ç„¶æœ‰

urls
ã€‚å…¶ä¸­

urls[0].protocol = empty
ï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå¤„ç†**æ‰€æœ‰æœåŠ¡æä¾›è€…ä¸ºç©º**çš„æƒ…å†µã€‚

- ç¬¬ 55 è¡Œï¼šè°ƒç”¨ [
  /#saveProperties(url)
  ](https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L539-L576) æ–¹æ³•ï¼Œä¿å­˜åˆ°æ–‡ä»¶ã€‚

- ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚
- ç¬¬ 57 è¡Œï¼šè°ƒç”¨

NotifyListener/#notify(urls)
æ–¹æ³•ï¼Œé€šçŸ¥ç›‘å¬å™¨å¤„ç†ã€‚ä¾‹å¦‚ï¼Œæœ‰æ–°çš„æœåŠ¡æä¾›è€…å¯åŠ¨æ—¶ï¼Œè¢«é€šçŸ¥ï¼Œåˆ›å»ºæ–°çš„ Invoker å¯¹è±¡ã€‚

### 3.2.5 recover

- [
  /#recover()
  ](https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L418-L447)

- å’Œ

/#register(url)
çš„**å¤„ç†æ–¹å¼**ç›¸åŒã€‚

åœ¨æ³¨å†Œä¸­å¿ƒæ–­å¼€ï¼Œé‡è¿æˆåŠŸï¼Œè°ƒç”¨

/#recover()
æ–¹æ³•ï¼Œè¿›è¡Œæ¢å¤æ³¨å†Œå’Œè®¢é˜…ã€‚

### 3.2.6 destroy

- [
  /#destroy()
  ](https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L578-L622)

- å’Œ

/#register(url)
çš„**å¤„ç†æ–¹å¼**ç›¸åŒã€‚

åœ¨ JVM å…³é—­æ—¶ï¼Œè°ƒç”¨

/#destroy()
æ–¹æ³•ï¼Œè¿›è¡Œå–æ¶ˆæ³¨å†Œå’Œè®¢é˜…ã€‚

## 3.3 FailbackRegistry

[
com.alibaba.dubbo.registry.support.FailbackRegistry
](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java) ï¼Œå®ç° AbstractRegistry æŠ½è±¡ç±»ï¼Œæ”¯æŒå¤±è´¥é‡è¯•çš„ Registry æŠ½è±¡ç±»ã€‚

åœ¨ä¸Šæ–‡ä¸­çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒAbstractRegistry è¿›è¡Œçš„æ³¨å†Œã€è®¢é˜…ç­‰æ“ä½œï¼Œæ›´å¤šçš„æ˜¯ä¿®æ”¹çŠ¶æ€ï¼Œè€Œæ— å’Œæ³¨å†Œä¸­å¿ƒå®é™…çš„æ“ä½œã€‚FailbackRegistry åœ¨ AbstractRegistry çš„åŸºç¡€ä¸Šï¼Œå®ç°äº†å’Œæ³¨å†Œä¸­å¿ƒå®é™…çš„æ“ä½œï¼Œå¹¶ä¸”æ”¯æŒå¤±è´¥é‡è¯•çš„ç‰¹æ€§ã€‚

### 3.3.1 å±æ€§

```
1: //*/*
2: /* å®šæ—¶ä»»åŠ¡æ‰§è¡Œå™¨
3: /*/
4: // Scheduled executor service
5: private final ScheduledExecutorService retryExecutor = Executors.newScheduledThreadPool(1, new NamedThreadFactory("DubboRegistryFailedRetryTimer", true));
6:
7: //*/*
8: /* å¤±è´¥é‡è¯•å®šæ—¶å™¨ï¼Œå®šæ—¶æ£€æŸ¥æ˜¯å¦æœ‰è¯·æ±‚å¤±è´¥ï¼Œå¦‚æœ‰ï¼Œæ— é™æ¬¡é‡è¯•
9: /*/
10: // Timer for failure retry, regular check if there is a request for failure, and if there is, an unlimited retry
11: private final ScheduledFuture<?> retryFuture;
12: //*/*
13: /* å¤±è´¥å‘èµ·æ³¨å†Œå¤±è´¥çš„ URL é›†åˆ
14: /*/
15: private final Set<URL> failedRegistered = new ConcurrentHashSet<URL>();
16: //*/*
17: /* å¤±è´¥å–æ¶ˆæ³¨å†Œå¤±è´¥çš„ URL é›†åˆ
18: /*/
19: private final Set<URL> failedUnregistered = new ConcurrentHashSet<URL>();
20: //*/*
21: /* å¤±è´¥å‘èµ·è®¢é˜…å¤±è´¥çš„ç›‘å¬å™¨é›†åˆ
22: /*/
23: private final ConcurrentMap<URL, Set<NotifyListener>> failedSubscribed = new ConcurrentHashMap<URL, Set<NotifyListener>>();
24: //*/*
25: /* å¤±è´¥å–æ¶ˆè®¢é˜…å¤±è´¥çš„ç›‘å¬å™¨é›†åˆ
26: /*/
27: private final ConcurrentMap<URL, Set<NotifyListener>> failedUnsubscribed = new ConcurrentHashMap<URL, Set<NotifyListener>>();
28: //*/*
29: /* å¤±è´¥é€šçŸ¥é€šçŸ¥çš„ URL é›†åˆ
30: /*/
31: private final ConcurrentMap<URL, Map<NotifyListener, List<URL>>> failedNotified = new ConcurrentHashMap<URL, Map<NotifyListener, List<URL>>>();
32: //*/*
33: /* æ˜¯å¦é”€æ¯
34: /*/
35: private AtomicBoolean destroyed = new AtomicBoolean(false);
36:
37: public FailbackRegistry(URL url){
38: super(url);
39: // é‡è¯•é¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’
40: int retryPeriod = url.getParameter(Constants.REGISTRY_RETRY_PERIOD_KEY, Constants.DEFAULT_REGISTRY_RETRY_PERIOD);
41: // åˆ›å»ºå¤±è´¥é‡è¯•å®šæ—¶å™¨
42: this.retryFuture = retryExecutor.scheduleWithFixedDelay(new Runnable() {
43: public void run(){
44: // Check and connect to the registry
45: try {
46: retry();
47: } catch (Throwable t) { // Defensive fault tolerance
48: logger.error("Unexpected error occur at failed retry, cause: " + t.getMessage(), t);
49: }
50: }
51: }, retryPeriod, retryPeriod, TimeUnit.MILLISECONDS);
52: }
```

- retryExecutor
  å±æ€§ï¼Œ_è§ä»£ç æ³¨é‡Š_ã€‚
- retryFuture
  å±æ€§ï¼Œ_è§ä»£ç æ³¨é‡Š_ã€‚

- ç¬¬ 41 è‡³ 51 è¡Œï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­åˆ›å»ºè¯¥å®šæ—¶å™¨ï¼Œåœ¨å…¶

/#run()
æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨

/#retry()
æ–¹æ³•ï¼Œè¿›è¡Œé‡è¯•ã€‚

- failedXXX
  å±æ€§ï¼Œ_è§ä»£ç æ³¨é‡Š_ã€‚

- æ¯ç§æ“ä½œéƒ½æœ‰ä¸€ä¸ªè®°å½•å¤±è´¥çš„é›†åˆã€‚
- destroyed
  å±æ€§ï¼Œ_è§ä»£ç æ³¨é‡Š_ã€‚

### 3.3.2 register && unregister

- [
  /#register(url)
  ](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L162-L199)
- [
  /#unregister(url)
  ](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L201-L238)
  ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚

### 3.3.3 subscribe && unsubscribe

- [
  /#subscribe(url, listener)
  ](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L240-L282)
- [
  /#unsubscribe(url, listener)
  ](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L284-L324)
  ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚

### 3.3.4 notify

- [
  /#notify(url, listener, url)
  ](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L326-L352)
  ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚

### 3.3.5 recover

- [
  /#recover()
  ](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L354-L379) æ–¹æ³•ï¼Œ**å®Œå…¨è¦†ç›–çˆ¶ç±»æ–¹æ³•**( å³ä¸åƒå‰é¢å‡ ä¸ªæ–¹æ³•ï¼Œä¼šè°ƒç”¨çˆ¶ç±»çš„æ–¹æ³• )ï¼Œå°†éœ€è¦æ³¨å†Œå’Œè®¢é˜…çš„ URL æ·»åŠ åˆ°

failedRegistered

failedSubscribed
å±æ€§ä¸­ã€‚è¿™æ ·ï¼Œåœ¨

/#retry()
æ–¹æ³•ä¸­ï¼Œä¼šé‡è¯•è¿›è¡Œè¿æ¥ã€‚
ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚

### 3.3.6 retry

- [
  /#retry()
  ](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L381-L528) æ–¹æ³•ï¼Œéå†äº”ä¸ª

failedXXX
å±æ€§ï¼Œé‡è¯•å¯¹åº”çš„æ“ä½œã€‚
ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚

### 3.3.7 destroy

- [
  /#destroy()
  ](https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L530-L541) æ–¹æ³•ï¼Œå–æ¶ˆæ³¨å†Œå’Œè®¢é˜…ï¼Œå¹¶å…³é—­å®šæ—¶å™¨ã€‚
  ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚

# 4. NotifyListener

[
com.alibaba.dubbo.registry.NotifyListener
](https://github.com/YunaiV/dubbo/blob/da5ebc2737d560dc0fe308793780695c6afc5fda/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/NotifyListener.java) ï¼Œé€šçŸ¥ç›‘å¬å™¨ã€‚å½“æ”¶åˆ°æœåŠ¡å˜æ›´é€šçŸ¥æ—¶è§¦å‘ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public interface NotifyListener{
//*/*
/* å½“æ”¶åˆ°æœåŠ¡å˜æ›´é€šçŸ¥æ—¶è§¦å‘ã€‚
/* <p>
/* é€šçŸ¥éœ€å¤„ç†å¥‘çº¦ï¼š<br>
/* 1. æ€»æ˜¯ä»¥æœåŠ¡æ¥å£å’Œæ•°æ®ç±»å‹ä¸ºç»´åº¦å…¨é‡é€šçŸ¥ï¼Œå³ä¸ä¼šé€šçŸ¥ä¸€ä¸ªæœåŠ¡çš„åŒç±»å‹çš„éƒ¨åˆ†æ•°æ®ï¼Œç”¨æˆ·ä¸éœ€è¦å¯¹æ¯”ä¸Šä¸€æ¬¡é€šçŸ¥ç»“æœã€‚<br>
/* 2. è®¢é˜…æ—¶çš„ç¬¬ä¸€æ¬¡é€šçŸ¥ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªæœåŠ¡çš„æ‰€æœ‰ç±»å‹æ•°æ®çš„å…¨é‡é€šçŸ¥ã€‚<br>
/* 3. ä¸­é€”å˜æ›´æ—¶ï¼Œå…è®¸ä¸åŒç±»å‹çš„æ•°æ®åˆ†å¼€é€šçŸ¥ï¼Œæ¯”å¦‚ï¼šproviders, consumers, routers, overridesï¼Œå…è®¸åªé€šçŸ¥å…¶ä¸­ä¸€ç§ç±»å‹ï¼Œä½†è¯¥ç±»å‹çš„æ•°æ®å¿…é¡»æ˜¯å…¨é‡çš„ï¼Œä¸æ˜¯å¢é‡çš„ã€‚<br>
/* 4. å¦‚æœä¸€ç§ç±»å‹çš„æ•°æ®ä¸ºç©ºï¼Œéœ€é€šçŸ¥ä¸€ä¸ªemptyåè®®å¹¶å¸¦categoryå‚æ•°çš„æ ‡è¯†æ€§URLæ•°æ®ã€‚<br>
/* 5. é€šçŸ¥è€…(å³æ³¨å†Œä¸­å¿ƒå®ç°)éœ€ä¿è¯é€šçŸ¥çš„é¡ºåºï¼Œæ¯”å¦‚ï¼šå•çº¿ç¨‹æ¨é€ï¼Œé˜Ÿåˆ—ä¸²è¡ŒåŒ–ï¼Œå¸¦ç‰ˆæœ¬å¯¹æ¯”ã€‚<br>
/*
/* @param urls å·²æ³¨å†Œä¿¡æ¯åˆ—è¡¨ï¼Œæ€»ä¸ä¸ºç©ºï¼Œå«ä¹‰åŒ{@link com.alibaba.dubbo.registry.RegistryService/#lookup(URL)}çš„è¿”å›å€¼ã€‚
/*/
void notify(List<URL> urls);
}
```

- æ³¨æ„çœ‹æ–¹æ³•ä¸Šçš„æ³¨é‡Šï¼Œç‰¹åˆ«æ˜¯**å…¨é‡**ã€**åˆ†ç±»**ã€**ä¸ºç©º**ã€**é¡ºåº**ã€‚

NotifyListener çš„å­ç±»å¦‚ä¸‹å›¾ï¼š

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_08_01/02.png)

# 5. ProviderConsumerRegTable

[
com.alibaba.dubbo.registry.support.ProviderConsumerRegTable
](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java) ï¼ŒæœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…æ³¨å†Œè¡¨ï¼Œå­˜å‚¨ JVM è¿›ç¨‹å†…**è‡ªå·±**çš„æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…çš„ Invoker ã€‚

è¯¥ä¿¡æ¯ç”¨äº [Dubbo QOS](http://dubbo.apache.org/zh-cn/docs/user/references/qos.html) ä½¿ç”¨ï¼Œä¾‹å¦‚å°† JVM è¿›ç¨‹ä¸­ï¼Œ**è‡ªå·±**çš„æœåŠ¡æä¾›è€…ä¸‹çº¿ï¼Œåˆæˆ–è€…æŸ¥è¯¢è‡ªå·±çš„æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…åˆ—è¡¨ã€‚

- [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” åœ¨çº¿è¿ç»´å‘½ä»¤ - QOSã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/qos.html)
- åç»­ä¼šæœ‰æ–‡ç« åˆ†äº« QOS ï¼Œæœ¬æ–‡ä¸å¤šå•°å—¦ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```
public class ProviderConsumerRegTable{
//*/*
/* æœåŠ¡æä¾›è€… Invoker é›†åˆ
/*
/* keyï¼šæœåŠ¡æä¾›è€… URL æœåŠ¡é”®
/*/
public static ConcurrentHashMap<String, Set<ProviderInvokerWrapper>> providerInvokers = new ConcurrentHashMap<String, Set<ProviderInvokerWrapper>>();
//*/*
/* æœåŠ¡æ¶ˆè´¹è€… Invoker é›†åˆ
/*
/* keyï¼šæœåŠ¡æ¶ˆè´¹è€… URL æœåŠ¡é”®
/*/
public static ConcurrentHashMap<String, Set<ConsumerInvokerWrapper>> consumerInvokers = new ConcurrentHashMap<String, Set<ConsumerInvokerWrapper>>();
// .... çœç•¥æ–¹æ³•
}
```

- å¦‚ä¸‹æ–¹æ³•ï¼Œå·²ç»æ·»åŠ ä»£ç æ³¨é‡Šï¼Œèƒ–å‹ç‚¹å‡»æŸ¥çœ‹ã€‚
- æœåŠ¡æä¾›è€…

- [
  /#registerProvider(invoker, registryUrl, providerUrl)
  ](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java#L51-L70) é™æ€æ–¹æ³•ï¼Œæ³¨å†Œ Provider Invoker ã€‚
- [
  /#getProviderInvoker(serviceUniqueName)
  ](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java#L72-L84) é™æ€é™æ€ï¼Œè·å¾—æŒ‡å®šæœåŠ¡é”®çš„ Provider Invoker é›†åˆã€‚
- [
  /#getProviderWrapper(invoker)
  ](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java#L86-L112) é™æ€æ–¹æ³•ï¼Œè·å¾—æœåŠ¡æä¾›è€…å¯¹åº”çš„ Invoker Wrapper å¯¹è±¡ã€‚
- æœåŠ¡æ¶ˆè´¹è€…

- [
  /#registerConsumer(invoker, registryUrl, consumerUrl, registryDirectory)
  ](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java#L114-L134) é™æ€æ–¹æ³•ï¼Œæ³¨å†Œ Consumer Invoker ã€‚
- [
  /#getConsumerInvoker(serviceUniqueName)
  ](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java#L136-L148) é™æ€æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šæœåŠ¡é”®çš„ Consumer Invoker é›†åˆã€‚

## 5.1 ProviderInvokerWrapper

[
com.alibaba.dubbo.registry.support.ProviderInvokerWrapper
](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderInvokerWrapper.java) ï¼Œå®ç° Invoker æ¥å£ï¼ŒæœåŠ¡æä¾›è€… Invoker Wrapper ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
//*/*
/* Invoker å¯¹è±¡
/*/
private Invoker<T> invoker;
//*/*
/* åŸå§‹ URL
/*/
private URL originUrl;
//*/*
/* æ³¨å†Œä¸­å¿ƒ URL
/*/
private URL registryUrl;
//*/*
/* æœåŠ¡æä¾›è€… URL
/*/
private URL providerUrl;
//*/*
/* æ˜¯å¦æ³¨å†Œ
/*/
private volatile boolean isReg;
// ... çœç•¥æ–¹æ³•
```

- ç›¸æ¯”çº¯ç²¹çš„ Invoker å¯¹è±¡ï¼Œåˆå¤šäº†è¿ç»´å‘½ä»¤éœ€è¦çš„å±æ€§ã€‚ä¾‹å¦‚

isReg
**çŠ¶æ€**å±æ€§ï¼Œå¯ä»¥åœ¨ä½¿ç”¨**ä¸‹çº¿æœåŠ¡å‘½ä»¤**åï¼Œæ ‡è®°ä¸º

false
ã€‚æƒ³æå‰æ·±å…¥äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹ä¸‹ [
com.alibaba.dubbo.qos.command.impl.Offline
](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-plugin/dubbo-qos/src/main/java/com/alibaba/dubbo/qos/command/impl/Online.java) å’Œ [
com.alibaba.dubbo.qos.command.impl.Online
](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-plugin/dubbo-qos/src/main/java/com/alibaba/dubbo/qos/command/impl/Online.java) ç±»ã€‚

## 5.2 ConsumerInvokerWrapper

[
com.alibaba.dubbo.registry.support.ConsumerInvokerWrapper
](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ConsumerInvokerWrapper.java) ï¼Œå®ç° Invoker æ¥å£ï¼ŒæœåŠ¡æ¶ˆè´¹è€… Invoker Wrapper ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
//*/*
/* Invoker å¯¹è±¡
/*/
private Invoker<T> invoker;
//*/*
/* åŸå§‹ URL
/*/
private URL originUrl;
//*/*
/* æ³¨å†Œä¸­å¿ƒ URL
/*/
private URL registryUrl;
//*/*
/* æ¶ˆè´¹è€… URL
/*/
private URL consumerUrl;
//*/*
/* æ³¨å†Œä¸­å¿ƒ Directory
/*/
private RegistryDirectory registryDirectory;
```

- ç›¸æ¯”çº¯ç²¹çš„ Invoker å¯¹è±¡ï¼Œåˆå¤šäº†è¿ç»´å‘½ä»¤éœ€è¦çš„å±æ€§ã€‚ä¾‹å¦‚

registryDirectory
å±æ€§ï¼Œå¯ä»¥åœ¨ä½¿ç”¨**åˆ—å‡ºæ¶ˆè´¹è€…å’Œæä¾›è€…å‘½ä»¤**åï¼Œè¾“å‡ºå¯æ¶ˆè´¹è€…**å¯è°ƒç”¨**çš„æœåŠ¡æä¾›è€…æ•°é‡ ã€‚æƒ³æå‰æ·±å…¥äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹ä¸‹ [
com.alibaba.dubbo.qos.command.impl.Ls
](https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-plugin/dubbo-qos/src/main/java/com/alibaba/dubbo/qos/command/impl/Ls.java) ç±»ã€‚

# 5. integration

ä¸åŒäºä¸Šé¢æˆ‘ä»¬çœ‹åˆ°çš„ä»£ç ï¼Œ[
integration
](https://github.com/YunaiV/dubbo/tree/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/integration) åŒ…ä¸‹æ˜¯å¯¹å…¶ä»– Dubbo æ¨¡å—çš„é›†æˆï¼š

- RegistryProtocol ï¼Œå¯¹

dubbo-rpc-api
çš„ä¾èµ–é›†æˆã€‚

- RegistryDirectory ï¼Œå¯¹

dubbo-cluster
çš„ä¾èµ–é›†æˆã€‚

è€ƒè™‘åˆ°è¶…å‡ºäº†æœ¬æ–‡çš„èŒƒç•´ï¼Œåé¢æ¶‰åŠåˆ°æ—¶ï¼Œå•ç‹¬åˆ†äº«ã€‚
