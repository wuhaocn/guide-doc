# è¿‡æ»¤å™¨ï¼ˆä¸€ï¼‰ä¹‹ ClassLoaderFilter

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

ä»æœ¬æ–‡å¼€å§‹ï¼Œæˆ‘ä»¬æ¥åˆ†äº« Dubbo çš„**è¿‡æ»¤å™¨**ä»¬ã€‚åœ¨ ProtocolFilterWrapper ä¸­ï¼Œåœ¨æœåŠ¡å¼•ç”¨å’Œæš´éœ²æ—¶ï¼Œ

/#buildInvokerChain(invoker, key, group)
æ–¹æ³•ä¸­ï¼ŒåŸºäº Dubbo SPI **Active** æœºåˆ¶ï¼ŒåŠ è½½**åŒ¹é…**å¯¹åº”çš„è¿‡æ»¤å™¨æ•°ç»„ï¼Œåˆ›å»ºå¸¦æœ‰**è¿‡æ»¤å™¨é“¾çš„ Invoker å¯¹è±¡**ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
//*/*
/* åˆ›å»ºå¸¦ Filter é“¾çš„ Invoker å¯¹è±¡
/*
/* @param invoker Invoker å¯¹è±¡
/* @param key è·å– URL å‚æ•°å
/* @param group åˆ†ç»„
/* @param <T> æ³›å‹
/* @return Invoker å¯¹è±¡
/*/
private static <T> Invoker<T> buildInvokerChain(final Invoker<T> invoker, String key, String group){
Invoker<T> last = invoker;
// è·å¾—è¿‡æ»¤å™¨æ•°ç»„
List<Filter> filters = ExtensionLoader.getExtensionLoader(Filter.class).getActivateExtension(invoker.getUrl(), key, group);
// å€’åºå¾ªç¯ Filter ï¼Œåˆ›å»ºå¸¦ Filter é“¾çš„ Invoker å¯¹è±¡
if (!filters.isEmpty()) {
for (int i = filters.size() - 1; i >= 0; i--) {
final Filter filter = filters.get(i);
final Invoker<T> next = last;
last = new Invoker<T>() {
@Override
public Class<T> getInterface(){
return invoker.getInterface();
}
@Override
public URL getUrl(){
return invoker.getUrl();
}
@Override
public boolean isAvailable(){
return invoker.isAvailable();
}
@Override
public Result invoke(Invocation invocation) throws RpcException{
return filter.invoke(next, invocation);
}
@Override
public void destroy(){
invoker.destroy();
}
@Override
public String toString(){
return invoker.toString();
}
};
}
}
return last;
}
```

- å…·ä½“çš„è¿‡æ»¤å™¨é“¾çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œåœ¨å‰é¢çš„ Dubbo RPC è°ƒç”¨ï¼Œå·²ç»åˆ†äº«ï¼Œè¿™é‡Œå°±ä¸é‡å¤è§£é‡Šå•¦ã€‚

æˆ‘ä»¬æŠŠæœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…çš„è¿‡æ»¤å™¨ç»Ÿä¸€æ•´ç†å¦‚ä¸‹ï¼š

![è¿‡æ»¤å™¨æ•´ç†](http://static2.iocoder.cn/images/Dubbo/2018_11_12/01.png)

- **é»„è‰²**éƒ¨åˆ†ï¼Œä»£è¡¨è¿‡æ»¤å™¨åœ¨æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…ä¸Šçš„é¡ºåºã€‚è‹¥ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºæ— è¯¥è¿‡æ»¤å™¨ã€‚
- **è“è‰²**éƒ¨åˆ†ï¼ŒEchoFilter ç­‰ç­‰ï¼Œå·²ç»åœ¨å…¶ä»–æ–‡ç« é‡Œåˆ†äº«ã€‚

- dubbo-filter-cache
  çš„ CacheFilter,

dubbo-filter-validation
çš„ ValidationFilter ï¼Œæœªç½—åˆ—åœ¨è¡¨æ ¼ä¸­ï¼Œä¹Ÿä¼šåœ¨å…¶ä»–æ–‡ç« é‡Œåˆ†äº«ã€‚

- **ç»¿è‰²**éƒ¨åˆ† ï¼ŒCompatibleFilter ç­‰ç­‰ï¼Œç›®å‰æœªå¼€å¯ Dubbo SPI

@Adaptive
æ³¨è§£ï¼Œæˆ‘ä»¬å°±ä¸å†™äº†ã€‚

æœ¬æ–‡åˆ†äº« ClassLoaderFilter ã€‚åç»­çš„æ–‡ç« ï¼Œä¹Ÿä¼šæ˜¯æ¯ç¯‡æ–‡ç« åˆ†äº« 1-2 ä¸ªè¿‡æ»¤å™¨ï¼Œæ ¹æ®å®é™…ç”¨é€”çš„æƒ…å†µã€‚

# 2. Filter

åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ ¸å¿ƒæµç¨‹ä¸€è§ˆã€‹ã€Œ4.4 Filterã€](http://svip.iocoder.cn/Dubbo/implementation-intro/?self) ä¸­ï¼Œå·²ç»è¯¦ç»†åˆ†äº«ã€‚

# 3. ClassLoaderFilter

[
com.alibaba.dubbo.rpc.filter.ClassLoaderFilter
](https://github.com/YunaiV/dubbo/blob/master/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/filter/ClassLoaderFilter.java) ï¼Œå®ç° Filter æ¥å£ï¼Œç±»åŠ è½½å™¨åˆ‡æ¢è¿‡æ»¤å™¨å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: @Activate(group = Constants.PROVIDER, order = -30000)
2: public class ClassLoaderFilter implements Filter{
3:
4: @Override
5: public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException{
6: // è·å¾—åŸæ¥çš„ç±»åŠ è½½å™¨
7: ClassLoader ocl = Thread.currentThread().getContextClassLoader();
8: // åˆ‡æ¢å½“å‰çº¿ç¨‹çš„ç±»åŠ è½½å™¨ä¸ºæœåŠ¡æ¥å£çš„ç±»åŠ è½½å™¨
9: Thread.currentThread().setContextClassLoader(invoker.getInterface().getClassLoader());
10: // æœåŠ¡è°ƒç”¨
11: try {
12: return invoker.invoke(invocation);
13: } finally {
14: // åˆ‡æ¢å½“å‰çº¿ç¨‹çš„ç±»åŠ è½½å™¨ä¸ºåŸæ¥çš„ç±»åŠ è½½å™¨
15: Thread.currentThread().setContextClassLoader(ocl);
16: }
17: }
18:
19: }
```

- ç¬¬ 7 è¡Œï¼šè°ƒç”¨

Thread/#getContextClassLoader()
æ–¹æ³•ï¼Œè·å¾—**åŸæ¥çš„**ç±»åŠ è½½å™¨ã€‚

- ç¬¬ 9 è¡Œï¼šè°ƒç”¨

Thread/#setContextClassLoader(ClassLoader)
æ–¹æ³•ï¼Œ**åˆ‡æ¢**å½“å‰çº¿ç¨‹çš„ç±»åŠ è½½å™¨ä¸º**æœåŠ¡æ¥å£çš„**ç±»åŠ è½½å™¨ã€‚

- ç¬¬ 12 è¡Œï¼šè°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚

- ç¬¬ 15 è¡Œï¼šè°ƒç”¨

Thread/#setContextClassLoader(ClassLoader)
æ–¹æ³•ï¼Œ**åˆ‡æ¢**å½“å‰çº¿ç¨‹çš„ç±»åŠ è½½å™¨ä¸º**åŸæ¥çš„**ç±»åŠ è½½å™¨ã€‚

ç¬”è€…çœ‹åˆ°è¿™ä¸ªè¿‡æ»¤å™¨ï¼Œè¡¨ç¤ºä¸€è„¸æ‡µé€¼ï¼Œäºæ˜¯å¼€å§‹ Google æ¢ç´¢ä¹‹è·¯ã€‚

1ã€äºæ˜¯æœåˆ° [ã€ŠISSUE/#1406ï¼šclassloaderFilterã€‹](https://github.com/apache/incubator-dubbo/issues/1406) ï¼Œå†…å®¹å¦‚ä¸‹ï¼š![ISSUE#1406](http://static2.iocoder.cn/images/Dubbo/2018_11_12/02.png)

ä½¿ç”¨æˆ‘å¤§æœ‰é“è¯å…¸ç¿»è¯‘ï¼š
åœ¨è®¾è®¡ç›®çš„ä¸­ï¼Œåˆ‡æ¢åˆ°åŠ è½½äº†æ¥å£å®šä¹‰çš„ç±»åŠ è½½å™¨ï¼Œä»¥ä¾¿å®ç°ä¸ç›¸åŒçš„ç±»åŠ è½½å™¨ä¸Šä¸‹æ–‡ä¸€èµ·å·¥ä½œã€‚

2ã€é‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¸‹ä¼šæœ‰å¤šä¸ª ClassLoader çš„æƒ…å†µå‘¢ï¼Ÿå†äºæ˜¯æœåˆ° [ã€ŠISSUE/#178ï¼šé¡¹ç›®æœ‰å¤šä¸ª ClassLoad æ—¶ä½¿ç”¨ dubbo å‡ºé”™ï¼›ã€‹](https://github.com/apache/incubator-dubbo/issues/178) ï¼Œå†…å®¹å¦‚ä¸‹ï¼š![ISSUE#178](http://static2.iocoder.cn/images/Dubbo/2018_11_12/03.png)

å¼€å§‹æ£€ç´¢ **pf4j** æ˜¯ä»€ä¹ˆä¸œä¸œï¼Ÿ
FROM [ã€ŠJava çš„æ’ä»¶æ¡†æ¶ PF4Jã€‹](https://www.oschina.net/p/pf4j)

PF4J æ˜¯ä¸€ä¸ª Java çš„æ’ä»¶æ¡†æ¶ï¼Œä¸ºç¬¬ä¸‰æ–¹æä¾›åº”ç”¨æ‰©å±•çš„æ¸ é“ã€‚ä½¿ç”¨ PF4J ä½ å¯ä»¥è½»æ¾å°†ä¸€ä¸ªæ™®é€šçš„ Java åº”ç”¨è½¬æˆä¸€ä¸ªæ¨¡å—åŒ–çš„åº”ç”¨ã€‚PF4J æœ¬èº«éå¸¸è½»é‡çº§ï¼Œåªæœ‰ 50KB å·¦å³ï¼Œç›®å‰åªä¾èµ–äº† slf4jã€‚[Gitblit](https://www.oschina.net/p/gitblit) é¡¹ç›®ä½¿ç”¨çš„å°±æ˜¯ PF4J è¿›è¡Œæ’ä»¶ç®¡ç†ã€‚

ğŸ™‚ çœ‹åˆ°æ­¤å¤„ï¼Œç¬”è€…å·²ç»è¿›å…¥äº†äº‘é‡Œå’Œé›¾é‡Œã€‚æ‰€ä»¥ï¼Œæˆ‘ä»…ä»…æ˜¯æŠ›ä¸ªç –ï¼Œæš‚æ—¶è¿˜æ²¡å»æµ‹è¯•ã€‚å†æ‰€ä»¥ï¼Œèƒ–å‹å¦‚æœæ„Ÿå…´è¶£ï¼Œå¯ä»¥è‡ªå·±å»ç ”ç©¶ä¸‹ä¸‹ã€‚æˆ‘çš„çŒœæµ‹æ˜¯ï¼Œä½¿ç”¨ PF4J åŠ è½½ä¸åŒçš„æœåŠ¡å®ç°ç±»çš„ Jar ï¼Œä¸åŒçš„ Jar çš„ç±»åŠ è½½å™¨ä¸åŒã€‚

æœ‰ç†Ÿæ‚‰è¿™å—çš„èƒ–å‹ï¼Œå¦‚æœæœ‰é”™è¯¯ï¼Œè¯·ç«‹å³æ–§æ­£æˆ‘ã€‚å“ˆå“ˆå“ˆã€‚
