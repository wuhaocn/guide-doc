# æœåŠ¡è°ƒç”¨ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°è°ƒç”¨ï¼ˆInjvmï¼‰

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

ä»è¿™ç¯‡æ–‡ç« å¼€å§‹ï¼Œæˆ‘ä»¬å¼€å§‹åˆ†äº«**æœåŠ¡è°ƒç”¨**çš„å®ç°ã€‚åœ¨å‰é¢ï¼Œè‰¿è‰¿å·²ç»å†™äº†æœåŠ¡ï¼š

- æœ¬åœ°æš´éœ²ã€è¿œç¨‹æš´éœ²
- æœ¬åœ°å¼•ç”¨ã€è¿œç¨‹å¼•ç”¨

é‚£ä¹ˆåœ¨æœåŠ¡è°ƒç”¨ï¼Œå¿…ç„¶ä¹Ÿæ˜¯åˆ†ï¼š

- æœ¬åœ°è°ƒç”¨
- è¿œç¨‹è°ƒç”¨

æœ¬æ–‡åˆ†äº«**æœ¬åœ°è°ƒç”¨**ï¼Œåœ¨

dubbo-rpc-injvm
æ¨¡å—å®ç°ã€‚

ç›¸æ¯”è¿œç¨‹è°ƒç”¨ï¼Œå®ç°ä¸Šä¼šç®€å•å¾ˆå¤šï¼šå› ä¸ºè°ƒç”¨çš„æœåŠ¡ï¼Œå°±åœ¨æœ¬åœ°è¿›ç¨‹å†…ï¼Œä¸”ä¸å­˜åœ¨å¤šä¸ªï¼Œæ‰€ä»¥ä¸éœ€è¦**é›†ç¾¤å®¹é”™**å’Œ**ç½‘ç»œé€šä¿¡**ç›¸å…³çš„åŠŸèƒ½ã€‚

# 2. è°ƒè¯•ç¯å¢ƒ

å‹æƒ…æç¤ºï¼šç¬”è€…å»ºè®®èƒ–å‹å…ˆå°è¯•è‡ªå·±æ­å»ºæœ¬åœ°è°ƒç”¨çš„è°ƒè¯•ç¯å¢ƒï¼Œå¦‚æœç¢°åˆ°é—®é¢˜åœ¨çœ‹æœ¬å°èŠ‚ã€‚

åŸºäº

dubbo-demo-consumer
æ”¹é€ ï¼š

1ã€å°†

dubbo-demo-provider
æ¨¡å—çš„

com.alibaba.dubbo.demo.provider.DemoServiceImpl
ç±»ï¼Œå¤åˆ¶åˆ°

dubbo-demo-consumer
æ¨¡å—çš„

com.alibaba.dubbo.demo.consumer
åŒ…ä¸‹ã€‚

2ã€åœ¨

resources/META-INF/spring
ç›®å½•ä¸‹ï¼Œæ–°å»º

dubbo-demo-injvm.xml
æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š

```
<beans xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
xmlns:dubbo="http://code.alibabatech.com/schema/dubbo"
xmlns="http://www.springframework.org/schema/beans"
xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd">
<dubbo:application name="demo-injvm"/>
<dubbo:registry address="N/A"/>
<dubbo:reference id="demoService" interface="com.alibaba.dubbo.demo.DemoService" protocol="injvm" scope="local" />
<bean id="demoServiceImpl" class="com.alibaba.dubbo.demo.consumer.DemoServiceImpl"/>
<dubbo:service interface="com.alibaba.dubbo.demo.DemoService" ref="demoServiceImpl" protocol="injvm" scope="local" />
</beans>
```

3ã€ä¿®æ”¹

com.alibaba.dubbo.demo.consumer.Consumer
ç±»ï¼ŒåŠ è½½çš„ Spring é…ç½®æ–‡ä»¶ä¸º

dubbo-demo-injvm.xml
ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(new String[]{"META-INF/spring/dubbo-demo-injvm.xml"});
```

4ã€å¯åŠ¨ Consumer ï¼Œå³å¯å¼€å§‹è°ƒè¯•ã€‚

[
dubbo-demo-consumer
](https://github.com/YunaiV/dubbo/tree/f14e4e4fffaede31cbece589e0f543ec6669b2ae/dubbo-demo/dubbo-demo-consumer) ï¼Œæ˜¯ç¬”è€…æ”¹å®Œï¼Œå¯è¿è¡Œçš„ä¸€ä¸ªå¿«ç…§ç‰ˆæœ¬ã€‚

# 3. é¡ºåºå›¾

- æ¶ˆè´¹è€…è°ƒç”¨æœåŠ¡çš„é¡ºåºå›¾ï¼š![æ¶ˆè´¹è€…è°ƒç”¨æœåŠ¡çš„é¡ºåºå›¾](http://static2.iocoder.cn/images/Dubbo/2018_10_01/01.png)
- æä¾›è€…æä¾›æœåŠ¡çš„é¡ºåºå›¾ï¼š![æä¾›è€…æä¾›æœåŠ¡çš„é¡ºåºå›¾](http://static2.iocoder.cn/images/Dubbo/2018_10_01/02.png)

ğŸ™‚ æµç¨‹ä¸Šè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œç¬”è€…å°±ä¸å“”å“”äº†ã€‚å¦‚æœèƒ–å‹ä¸å¤ªç†è§£ï¼Œå¯ä»¥å›çœ‹ä¹‹å‰çš„æ–‡ç« ï¼Œå†å¤šå¤šè°ƒè¯•ç†è§£ï¼Œæˆ–è€…çŸ¥è¯†æ˜Ÿçƒå‘å¸–ä¸€èµ·è®¨è®ºã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹æ¯ä¸ªæ­¥éª¤çš„å®ç°ä»£ç ã€‚

# 4. æ¶ˆè´¹è€…è°ƒç”¨æœåŠ¡

## 4.1 Proxy

æç¤ºï¼šå¯¹åº”å›¾ä¸­ [1][2] [3]

è§ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” åŠ¨æ€ä»£ç†ï¼ˆä¸€ï¼‰ä¹‹ Javassistã€‹](http://svip.iocoder.cn/Dubbo/proxy-javassist/?self) æ–‡ç« ã€‚

## 4.2 ProtocolFilterWrapper

æç¤ºï¼šå¯¹åº”å›¾ä¸­ [5]

ProtocolFilterWrapper çš„å¸¦æœ‰è¿‡æ»¤é“¾çš„ Invoker ï¼Œæ•´ä¸ªè°ƒç”¨è¿‡ç¨‹å’Œ J2EE FilterChain æ˜¯ä¸€è‡´çš„ï¼Œå…·ä½“æ¯ä¸ª Dubbo Filter çš„å®ç°ï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ã€‚

```
for (int i = filters.size() - 1; i >= 0; i--) {
final Filter filter = filters.get(i);
final Invoker<T> next = last;
last = new Invoker<T>() {
public Class<T> getInterface(){
return invoker.getInterface();
}
public URL getUrl(){
return invoker.getUrl();
}
public boolean isAvailable(){
return invoker.isAvailable();
}
public Result invoke(Invocation invocation) throws RpcException{
return filter.invoke(next, invocation);
}
public void destroy(){
invoker.destroy();
}
@Override
public String toString(){
return invoker.toString();
}
};
}
```

/#invoke(invocation)
æ–¹æ³•ä¸­ï¼Œè°ƒç”¨

Filter/#(invoker, invocation)
æ–¹æ³•ï¼Œä¸æ–­æ‰§è¡Œè¿‡æ»¤é€»è¾‘ã€‚è€Œåœ¨ Filter ä¸­ï¼Œåˆä¸æ–­è°ƒç”¨

Invoker/#invoker(invocation)
æ–¹æ³•ï¼Œæœ€ç»ˆæœ€åä¸€ä¸ª Filter ï¼Œä¼šè°ƒç”¨

InjvmInvoker/#invoke(invocation)
æ–¹æ³•ï¼Œç»§ç»­æ‰§è¡Œé€»è¾‘ã€‚

å‹æƒ…æç¤ºï¼ŒInjvmInvoker åªæ˜¯æ­¤å¤„çš„ä¾‹å­ï¼Œä¸åŒçš„åè®®ï¼Œä¼šè°ƒç”¨ä¸åŒçš„ Invoker å®ç°ç±»ï¼Œä¾‹å¦‚ Dubbo åè®®ï¼Œè°ƒç”¨çš„æ˜¯ DubboInvoker ã€‚

å¦å¤–ï¼ŒFilter è°ƒç”¨ Invoker çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š

```
public class DemoFilter implements Filter{
@Override
public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException{
return invoker.invoke(invocation); // è°ƒç”¨
}
}
```

## 4.3 ListenerInvokerWrapper

æç¤ºï¼šå¯¹åº”å›¾ä¸­ [6]

ListenerInvokerWrapper ç±»ï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº† InvokerListener çš„è§¦å‘ï¼Œç›®å‰è¯¥ç›‘å¬å™¨åªæœ‰

/#referred(invoker)

/#destroyed(invoker)
ä¸¤ä¸ªæ¥å£æ–¹æ³•ï¼Œå¹¶æœªå¯¹

/#invoke(invocation)
çš„è¿‡ç¨‹ï¼Œå®ç°ç›‘å¬ã€‚å› æ­¤ï¼ŒListenerInvokerWrapper çš„

/#invoke(invocation)
çš„å®ç°åŸºæœ¬ç­‰äºé›¶ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
@Override
public Result invoke(Invocation invocation) throws RpcException{
return invoker.invoke(invocation);
}
```

## 4.4 AbstractInvoker

æç¤ºï¼šå¯¹åº”å›¾ä¸­ [7]

AbstractInvoker ï¼Œåœ¨

/#invoke(invocation)
æ–¹æ³•ä¸­ï¼Œå®ç°äº†**å…¬ç”¨é€»è¾‘**ï¼ŒåŒæ—¶**æŠ½è±¡**äº†

/#doInvoke(invocation)
æ–¹æ³•ï¼Œå­ç±»å®ç°è‡ªå®šä¹‰é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: public Result invoke(Invocation inv) throws RpcException{
2: if (destroyed.get()) {
3: throw new RpcException("Rpc invoker for service " + this + " on consumer " + NetUtils.getLocalHost()
4: + " use dubbo version " + Version.getVersion()
5: + " is DESTROYED, can not be invoked any more!");
6: }
7: RpcInvocation invocation = (RpcInvocation) inv;
8: // è®¾ç½® `invoker` å±æ€§
9: invocation.setInvoker(this);
10: // æ·»åŠ å…¬ç”¨çš„éšå¼ä¼ å‚ï¼Œä¾‹å¦‚ï¼Œ`path` `interface` ç­‰ç­‰ï¼Œè¯¦è§ RpcInvocation ç±»ã€‚
11: if (attachment != null && attachment.size() > 0) {
12: invocation.addAttachmentsIfAbsent(attachment);
13: }
14: // æ·»åŠ è‡ªå®šä¹‰çš„éšå£«ä¼ å‚
15: Map<String, String> context = RpcContext.getContext().getAttachments();
16: if (context != null) {
17: invocation.addAttachmentsIfAbsent(context);
18: }
19: // è®¾ç½® `async=true` ï¼Œè‹¥ä¸ºå¼‚æ­¥æ–¹æ³•
20: if (getUrl().getMethodParameter(invocation.getMethodName(), Constants.ASYNC_KEY, false)) {
21: invocation.setAttachment(Constants.ASYNC_KEY, Boolean.TRUE.toString());
22: }
23: RpcUtils.attachInvocationIdIfAsync(getUrl(), invocation);
24:
25: // æ‰§è¡Œè°ƒç”¨
26: try {
27: return doInvoke(invocation);
28: // TODO ã€8023 biz exceptionã€‘
29: } catch (InvocationTargetException e) { // biz exception
30: Throwable te = e.getTargetException();
31: if (te == null) {
32: return new RpcResult(e);
33: } else {
34: if (te instanceof RpcException) {
35: ((RpcException) te).setCode(RpcException.BIZ_EXCEPTION);
36: }
37: return new RpcResult(te);
38: }
39: } catch (RpcException e) {
40: if (e.isBiz()) {
41: return new RpcResult(e);
42: } else {
43: throw e;
44: }
45: } catch (Throwable e) {
46: return new RpcResult(e);
47: }
48: }
```

- ç¬¬ 7 è‡³ 23 è¡Œï¼šè®¾ç½®

invocation
çš„å±æ€§ã€‚

- ç¬¬ 9 è¡Œï¼šè®¾ç½®

invoker
å±æ€§ä¸ºè‡ªå·±ã€‚åœ¨ä¸Šé¢ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ° Invoker æ˜¯å±‚å±‚åµŒå¥—ï¼Œåªè¦åˆ°äº†è¿™é‡Œæ‰æ˜¯çœŸæ­£çš„ Invoker å¯¹è±¡ã€‚

- ç¬¬ 10 è‡³ 13 è¡Œï¼šæ·»åŠ **å…¬ç”¨çš„**çš„éšå¼ä¼ å‚ã€‚ä¾‹å¦‚ï¼Œ

path

interface
ç­‰ç­‰ã€‚æ‰€æœ‰è§ [RpcInvocation](https://github.com/apache/incubator-dubbo/blob/master/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/RpcInvocation.java#L50-L76) æ„é€ æ–¹æ³•ã€‚ä»

Invocation/#addAttachmentsIfAbsent(context)
æ–¹æ³•ï¼Œä¸å­˜åœ¨æ‰æ·»åŠ ï¼Œå› æ­¤ä¸šåŠ¡ä¸Šéšå¼ä¼ å‚çš„ KEY ä¸èƒ½å†²çªåˆ°è¿™å‡ ä¸ªã€‚

- ç¬¬ 14 è‡³ 18 è¡Œï¼šæ·»åŠ **è‡ªå®šä¹‰çš„**éšå¼ä¼ å‚ï¼Œä»

RpcContext.attachments
ä¸­ã€‚ä½¿ç”¨ RpcContext éšå¼ä¼ å‚éœ€è¦æ³¨æ„ï¼š
æ³¨æ„ï¼šRpcContext æ˜¯ä¸€ä¸ªä¸´æ—¶çŠ¶æ€è®°å½•å™¨ï¼Œå½“æ¥æ”¶åˆ° RPC è¯·æ±‚ï¼Œæˆ–å‘èµ· RPC è¯·æ±‚æ—¶ï¼ŒRpcContext çš„çŠ¶æ€éƒ½ä¼šå˜åŒ–ã€‚
æ¯”å¦‚ï¼šA è°ƒ Bï¼ŒB å†è°ƒ Cï¼Œåˆ™ B æœºå™¨ä¸Šï¼Œåœ¨ B è°ƒ C ä¹‹å‰ï¼ŒRpcContext è®°å½•çš„æ˜¯ A è°ƒ B çš„ä¿¡æ¯ï¼Œåœ¨ B è°ƒ C ä¹‹åï¼ŒRpcContext è®°å½•çš„æ˜¯ B è°ƒ C çš„ä¿¡æ¯ã€‚

- ç¬¬ 19 è‡³ 23 è¡Œï¼šå¼‚æ­¥æ–¹æ³•ï¼Œç›¸å…³çš„å¤„ç†ï¼Œåé¢æ–‡ç« åˆ†äº«ã€‚
- ç¬¬ 27 è¡Œï¼šè°ƒç”¨

/#doInvoke(invocation)
**æŠ½è±¡**æ–¹æ³•ï¼Œå®ç°ä¸åŒåè®®è‡ªå®šä¹‰çš„è°ƒç”¨å®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
protected abstract Result doInvoke(Invocation invocation) throws Throwable;
```

- ç¬¬ 28 è‡³ 47 è¡Œï¼š// TODO ã€8023 biz exceptionã€‘

çœ‹å®Œè¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸€æ¬¡ Dubbo RPC ï¼Œæ¶‰åŠåˆ°æŠ½è±¡æ¨¡å‹å¦‚ä¸‹å›¾ï¼š

![RPC](http://static2.iocoder.cn/images/Dubbo/2018_10_01/03.png)

## 4.5 InjvmInvoker

æç¤ºï¼šå¯¹åº”å›¾ä¸­ [8]

/#doInvoke(invocation)
å®ç°æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
//*/*
/* Exporter é›†åˆ
/*
/* key: æœåŠ¡é”®
/*
/* è¯¥å€¼å®é™…å°±æ˜¯ {@link com.alibaba.dubbo.rpc.protocol.AbstractProtocol/#exporterMap}
/*/
private final Map<String, Exporter<?>> exporterMap;
1: @Override
2: public Result doInvoke(Invocation invocation) throws Throwable{
3: // è·å¾— Exporter å¯¹è±¡
4: Exporter<?> exporter = InjvmProtocol.getExporter(exporterMap, getUrl());
5: if (exporter == null) {
6: throw new RpcException("Service [" + key + "] not found.");
7: }
8: // è®¾ç½®æœåŠ¡æä¾›è€…åœ°å€ä¸ºæœ¬åœ°
9: RpcContext.getContext().setRemoteAddress(NetUtils.LOCALHOST, 0);
10: // è°ƒç”¨
11: return exporter.getInvoker().invoke(invocation);
12: }
```

- ç¬¬ 3 è‡³ 7 è¡Œï¼šè°ƒç”¨

InjvmProtocol/#getExporter(exporterMap, url)
æ–¹æ³•ï¼Œè·å¾—å¯¹åº”çš„ Exporter å¯¹è±¡ã€‚åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æœåŠ¡æš´éœ²ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°æš´éœ²ï¼ˆInjvmï¼‰ã€‹](http://svip.iocoder.cn/Dubbo/service-export-local/?self) ä¸­ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼Œ

exporterMap
å±æ€§ï¼Œå°±æ˜¯ä» InjvmProtocol çš„

exporterMap
å±æ€§ã€‚

- åœ¨è¿œç¨‹è°ƒç”¨ä¸­ï¼Œé€‰æ‹©æœåŠ¡æä¾›è€…çš„é€»è¾‘ä¼šæ›´åŠ å¤æ‚ï¼Œåç»­æ–‡ç« è§ã€‚
- ç¬¬ 9 è¡Œï¼šè®¾ç½®æœåŠ¡æä¾›è€…åœ°å€ä¸ºæœ¬åœ°ã€‚
- ç¬¬ 11 è¡Œï¼šè·å¾—åˆ° Exporter å¯¹è±¡ï¼Œé‡Œé¢å°±æœ‰**æœåŠ¡æä¾›è€…çš„ Invoker å¯¹è±¡**ã€‚è°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼Œè°ƒç”¨æœåŠ¡ã€‚

# 5. æä¾›è€…æä¾›æœåŠ¡

## 5.1 InjvmInvoker

æç¤ºï¼šå¯¹åº”å›¾ä¸­ [1][2]

åœ¨ [ã€Œ4.5 InjvmInvokerã€](http://svip.iocoder.cn/Dubbo/rpc-injvm/) å·²ç»åˆ†äº«ã€‚

## 5.2 ProtocolFilterWrapper

æç¤ºï¼šå¯¹åº”å›¾ä¸­ [3][4]

åœ¨ [ã€Œ4.2 ProtocolFilterWrapperã€](http://svip.iocoder.cn/Dubbo/rpc-injvm/) åŸºæœ¬ä¸€è‡´ï¼Œå·®å¼‚ç‚¹åœ¨æœåŠ¡æ¶ˆè´¹è€…å’Œæä¾›è€…çš„è¿‡æ»¤å™¨æ˜¯**ä¸åŒ**çš„ã€‚

## 5.3 DelegateProviderMetaDataInvoker

æç¤ºï¼šå¯¹åº”å›¾ä¸­ [5]

DelegateProviderMetaDataInvoker ï¼Œå¸¦æœ‰æœåŠ¡æä¾›è€…é…ç½® ServiceConfig çš„ Invoker å¯¹è±¡ã€‚ä»ç›®å‰ä»£ç ä¸Šæ¥çœ‹ï¼ŒServiceConfig æš‚æ—¶æ²¡ç”¨åˆ°ã€‚

/#invoke(invocation)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
//*/*
/* Invoker å¯¹è±¡
/*/
protected final Invoker<T> invoker;
//*/*
/* æœåŠ¡æä¾›è€…é…ç½®
/*/
private ServiceConfig metadata;
@Override
public Result invoke(Invocation invocation) throws RpcException{
return invoker.invoke(invocation);
}
```

## 5.4 Wrapper

æç¤ºï¼šå¯¹åº”å›¾ä¸­ [6][7] [8][9]

è§ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” åŠ¨æ€ä»£ç†ï¼ˆä¸€ï¼‰ä¹‹ Javassistã€‹](http://svip.iocoder.cn/Dubbo/proxy-javassist/?self) æ–‡ç« ã€‚
