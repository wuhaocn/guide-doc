# è¿‡æ»¤å™¨ï¼ˆä¸ƒï¼‰ä¹‹ ExceptionFilter

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«å¼‚å¸¸è¿‡æ»¤å™¨ ExceptionFilter ï¼Œç”¨äºæœåŠ¡**æä¾›è€…**ä¸­ã€‚ç”¨é€”å¦‚ä¸‹ï¼š
FROM ExceptionFilter ä¸Šçš„æ³¨é‡Šï¼š

1. ä¸æœŸæœ›çš„å¼‚å¸¸æ‰“ ERROR æ—¥å¿—( Provider ç«¯ )ã€‚ä¸æœŸæœ›çš„æ—¥å¿—å³æ˜¯ï¼Œæ²¡æœ‰çš„æ¥å£ä¸Šå£°æ˜çš„ Unchecked å¼‚å¸¸ã€‚
1. å¼‚å¸¸ä¸åœ¨ API åŒ…ä¸­ï¼Œåˆ™ Wrap ä¸€å±‚ RuntimeException ã€‚RPC å¯¹äºç¬¬ä¸€å±‚å¼‚å¸¸ä¼šç›´æ¥åºåˆ—åŒ–ä¼ è¾“( Cause å¼‚å¸¸ä¼š String åŒ–) ï¼Œé¿å…å¼‚å¸¸åœ¨ Client å‡ºä¸èƒ½**ååºåˆ—åŒ–**é—®é¢˜ã€‚

ğŸ™‚ å’Œæˆ‘ä»¬å¹³æ—¶ä¸šåŠ¡å†™çš„ç”¨äº**æ•æ‰å¼‚å¸¸**çš„è¿‡æ»¤å™¨æˆ–è€…æ‹¦æˆªå™¨**ä¸å¤ªä¸€æ ·**ï¼Œè€Œæ˜¯å…³æ³¨ç‚¹åœ¨æœåŠ¡æ¶ˆè´¹è€…ä¼šä¸ä¼šå‡ºç°ä¸å­˜åœ¨è¯¥å¼‚å¸¸ç±»ï¼Œå¯¼è‡´ååºåˆ—åŒ–çš„é—®é¢˜ã€‚

# 2. ExceptionFilter

com.alibaba.dubbo.rpc.filter.ExceptionFilter
ï¼Œå®ç° Filter æ¥å£ï¼Œå¼‚å¸¸è¿‡æ»¤å™¨å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: @Activate(group = Constants.PROVIDER)
2: public class ExceptionFilter implements Filter{
3:
4: private final Logger logger;
5:
6: public ExceptionFilter(){
7: this(LoggerFactory.getLogger(ExceptionFilter.class));
8: }
9:
10: public ExceptionFilter(Logger logger){
11: this.logger = logger;
12: }
13:
14: @Override
15: public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException{
16: try {
17: // æœåŠ¡è°ƒç”¨
18: Result result = invoker.invoke(invocation);
19: // æœ‰å¼‚å¸¸ï¼Œå¹¶ä¸”éæ³›åŒ–è°ƒç”¨
20: if (result.hasException() && GenericService.class != invoker.getInterface()) {
21: try {
22: Throwable exception = result.getException();
23:
24: // directly throw if it's checked exception
25: // å¦‚æœæ˜¯checkedå¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º
26: if (!(exception instanceof RuntimeException) && (exception instanceof Exception)) {
27: return result;
28: }
29: // directly throw if the exception appears in the signature
30: // åœ¨æ–¹æ³•ç­¾åä¸Šæœ‰å£°æ˜ï¼Œç›´æ¥æŠ›å‡º
31: try {
32: Method method = invoker.getInterface().getMethod(invocation.getMethodName(), invocation.getParameterTypes());
33: Class<?>[] exceptionClassses = method.getExceptionTypes();
34: for (Class<?> exceptionClass : exceptionClassses) {
35: if (exception.getClass().equals(exceptionClass)) {
36: return result;
37: }
38: }
39: } catch (NoSuchMethodException e) {
40: return result;
41: }
42:
43: // æœªåœ¨æ–¹æ³•ç­¾åä¸Šå®šä¹‰çš„å¼‚å¸¸ï¼Œåœ¨æœåŠ¡å™¨ç«¯æ‰“å° ERROR æ—¥å¿—
44: // for the exception not found in method's signature, print ERROR message in server's log.
45: logger.error("Got unchecked and undeclared exception which called by " + RpcContext.getContext().getRemoteHost()
46: + ". service: " + invoker.getInterface().getName() + ", method: " + invocation.getMethodName()
47: + ", exception: " + exception.getClass().getName() + ": " + exception.getMessage(), exception);
48:
49: // å¼‚å¸¸ç±»å’Œæ¥å£ç±»åœ¨åŒä¸€ jar åŒ…é‡Œï¼Œç›´æ¥æŠ›å‡º
50: // directly throw if exception class and interface class are in the same jar file.
51: String serviceFile = ReflectUtils.getCodeBase(invoker.getInterface());
52: String exceptionFile = ReflectUtils.getCodeBase(exception.getClass());
53: if (serviceFile == null || exceptionFile == null || serviceFile.equals(exceptionFile)) {
54: return result;
55: }
56: // æ˜¯JDKè‡ªå¸¦çš„å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º
57: // directly throw if it's JDK exception
58: String className = exception.getClass().getName();
59: if (className.startsWith("java.") || className.startsWith("javax.")) {
60: return result;
61: }
62: // æ˜¯Dubboæœ¬èº«çš„å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º
63: // directly throw if it's dubbo exception
64: if (exception instanceof RpcException) {
65: return result;
66: }
67:
68: // å¦åˆ™ï¼ŒåŒ…è£…æˆRuntimeExceptionæŠ›ç»™å®¢æˆ·ç«¯
69: // otherwise, wrap with RuntimeException and throw back to the client
70: return new RpcResult(new RuntimeException(StringUtils.toString(exception)));
71: } catch (Throwable e) {
72: logger.warn("Fail to ExceptionFilter when called by " + RpcContext.getContext().getRemoteHost()
73: + ". service: " + invoker.getInterface().getName() + ", method: " + invocation.getMethodName()
74: + ", exception: " + e.getClass().getName() + ": " + e.getMessage(), e);
75: return result;
76: }
77: }
78: // è¿”å›
79: return result;
80: } catch (RuntimeException e) {
81: logger.error("Got unchecked and undeclared exception which called by " + RpcContext.getContext().getRemoteHost()
82: + ". service: " + invoker.getInterface().getName() + ", method: " + invocation.getMethodName()
83: + ", exception: " + e.getClass().getName() + ": " + e.getMessage(), e);
84: throw e;
85: }
86: }
87:
88: }
```

- ç¬¬ 18 è¡Œï¼šè°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚

- ç¬¬ 21 è¡Œï¼šè°ƒç”¨ç»“æœæœ‰å¼‚å¸¸ï¼Œå¹¶ä¸”é**æ³›åŒ–è°ƒç”¨**ã€‚
- ç¬¬ 24 è‡³ 28 è¡Œï¼šå¦‚æœæ˜¯ checked å¼‚å¸¸ï¼Œç›´æ¥è¿”å›ã€‚å› ä¸ºï¼Œchecked å¼‚å¸¸ï¼Œè‚¯å®šå®šä¹‰åœ¨æ¥å£ä¸Šäº†ã€‚
- ç¬¬ 29 è‡³ 41 è¡Œï¼šåœ¨æ¥å£æ–¹æ³•çš„ç­¾åæœ‰ç”Ÿå‘½ï¼Œç›´æ¥è¿”å›ç»“æœã€‚
- ç¬¬ 45 è‡³ 47 è¡Œï¼šæœªåœ¨æ–¹æ³•ç­¾åä¸Šå®šä¹‰çš„å¼‚å¸¸ï¼Œåœ¨æœåŠ¡å™¨ç«¯æ‰“å° ERROR æ—¥å¿—ã€‚
- ç¬¬ 49 è‡³ 55 è¡Œï¼šå¼‚å¸¸ç±»å’Œæ¥å£ç±»åœ¨åŒä¸€ **jar** åŒ…é‡Œï¼Œç›´æ¥è¿”å›ç»“æœã€‚å› ä¸ºï¼ŒæœåŠ¡æ¶ˆè´¹è€…å¯ä»¥ååºåˆ—åŒ–è¯¥å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public static String getCodeBase(Class<?> cls){
if (cls == null) {
return null;
}
ProtectionDomain domain = cls.getProtectionDomain();
if (domain == null) {
return null;
}
CodeSource source = domain.getCodeSource();
if (source == null) {
return null;
}
URL location = source.getLocation();
if (location == null) {
return null;
}
return location.getFile();
}
```

- ç¬¬ 56 è‡³ 61 è¡Œï¼šæ˜¯ JDK è‡ªå¸¦çš„å¼‚å¸¸ï¼Œç›´æ¥è¿”å›ç»“æœã€‚
- ç¬¬ 62 è‡³ 66 è¡Œï¼šæ˜¯ Dubbo æœ¬èº«çš„å¼‚å¸¸ï¼Œç›´æ¥è¿”å›ç»“æœã€‚
- ç¬¬ 70 è¡Œï¼šå¦åˆ™ï¼ŒåŒ…è£…æˆ RuntimeException å¼‚å¸¸è¿”å›ç»™æœåŠ¡æ¶ˆè´¹è€…ï¼ŒåŒæ—¶æŠŠå¼‚å¸¸å †æ ˆç»™åŒ…è¿›å»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public static String toString(Throwable e){
UnsafeStringWriter w = new UnsafeStringWriter();
PrintWriter p = new PrintWriter(w);
p.print(e.getClass().getName());
if (e.getMessage() != null) {
p.print(": " + e.getMessage());
}
p.println();
try {
e.printStackTrace(p);
return w.toString();
} finally {
p.close();
}
}
```

# 666. å½©è›‹

ğŸ˜œ ä¸€å¼€å§‹æƒ³é”™äº†ï¼Œæ€ªä¸å¾—è§‰å¾—å¥½å¥‡æ€ªã€‚

å¦å¤–ï¼Œç¬”è€…æœ‰ä¸ªæƒ³æ³•ã€‚æˆ‘ä»¬åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œå¯èƒ½ä¼šå®šä¹‰é€šç”¨çš„ BusinessException ï¼Œå¹¶ä¸”æ¯ä¸ªæ¥å£ï¼Œå®é™…éƒ½ä¼šæŠ›å‡ºè¯¥å¼‚å¸¸ã€‚é‚£ä¹ˆè¦æ±‚å¼€å‘æ¯ä¸ªæ¥å£éƒ½å®šä¹‰æŠ›å‡º BusinessException æ˜¯æ¯”è¾ƒâ€œéº»çƒ¦â€çš„ã€‚
ä½†æ˜¯ï¼ŒæŒ‰ç…§ ExceptionFilter çš„é€»è¾‘ï¼Œä¼šæ‰“å°å¼‚å¸¸æ—¥å¿—ã€‚
æ‰€ä»¥ï¼Œç¬”è€…çš„æƒ³æ³•æ˜¯ï¼Œé‡å†™ ExceptionFilter ï¼Œå®šä¹‰ä¸€äº›é€šç”¨å¼‚å¸¸ï¼Œå…è®¸ç›´æ¥è¿”å›ç»“æœã€‚ğŸ™‚
