# NIO æœåŠ¡å™¨ï¼ˆä¸‰ï¼‰ä¹‹ Telnet å±‚

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡æ¥ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” NIO æœåŠ¡å™¨ï¼ˆäºŒï¼‰ä¹‹æŠ½è±¡ APIã€‹](http://svip.iocoder.cn/Dubbo/remoting-api-transport//?self) ä¸€æ–‡ï¼Œåˆ†äº«

dubbo-remoting-api
æ¨¡å—ï¼Œ

telnet
åŒ…ï¼Œ**Telnet å‘½ä»¤**ã€‚

åœ¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” Telnet å‘½ä»¤å‚è€ƒæ‰‹å†Œã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/telnet.html) ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒDubbo æ”¯æŒé€šè¿‡ telnet å‘½ä»¤ï¼Œç”¨æ¥æœåŠ¡æ²»ç†ã€‚å…¶ä¸­ï¼Œ

clear

exit

help

log

status
**é€šç”¨æŒ‡ä»¤**ï¼Œé€šè¿‡

telnet
åŒ…å®ç°ã€‚è€Œå…¶å®ƒå‡ ä¸ªæŒ‡ä»¤ï¼Œéœ€è¦ä¸åŒåè®®( Protocol )è‡ªå·±å®ç°ã€‚ç›®å‰ï¼Œ**ä»…æœ‰** Dubbo Protocol å®ç°äº†è‡ªå®šä¹‰æŒ‡ä»¤ã€‚

æœ¬æ–‡æ¶‰åŠ**ç±»å›¾**å¦‚ä¸‹ï¼š

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_12_07/01.png)

ä»**ç”¨é€”**ä¸Šï¼Œä¸Šè¿°ç±»å¯ä»¥åˆ†æˆä¸‰ç§ï¼š

- TelnetCodec ï¼šè´Ÿè´£ç¼–è§£ç  Telnet å‘½ä»¤ä¸ç»“æœã€‚
- TelnetHandlerAdapter ï¼šè´Ÿè´£æ¥æ”¶æ¥è‡ª HeaderExchangeHandler çš„ telnet å‘½ä»¤ï¼Œåˆ†å‘ç»™å¯¹åº”çš„ TelnetHandler å®ç°ç±»ï¼Œè¿›è¡Œå¤„ç†ï¼Œ**è¿”å›å‘½ä»¤ç»“æœ**ã€‚

- ğŸ™‚ ä¸ºä»€ä¹ˆæ¥è‡ª HeaderExchangeHandler ï¼Œæˆ‘ä»¬åç»­æ–‡ç« åˆ†äº«ã€‚
- XXXTelnetHandler ï¼šå¤„ç†å¯¹åº”çš„ telnet å‘½ä»¤ï¼Œè¿”å›ç»“æœã€‚

**æµç¨‹**å¦‚ä¸‹å›¾ï¼š

![æµç¨‹](http://static2.iocoder.cn/images/Dubbo/2018_12_07/02.png)

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“çš„ä»£ç å®ç°ã€‚

# 2. TelnetCodec

è‰¿è‰¿å¯¹ telnet server ä¸ç†Ÿæ‚‰ï¼Œå¦‚æœæœ‰é”™è¯¯ï¼Œè¿˜è¯·åŒ…æ¶µã€‚ğŸ™‚ æœ¬æ–‡ä¸»è¦èµ·åˆ°æŠ›ç –çš„ä½œç”¨ã€‚

[
com.alibaba.dubbo.remoting.telnet.codec.TelnetCodec
](http://svip.iocoder.cn/Dubbo/remoting-api-telnet/TODO) ï¼Œå®ç° TransportCodec ç±»ï¼ŒTelnet å‘½ä»¤ç¼–è§£ç å™¨ã€‚

**è§£ç **

```
1: @SuppressWarnings("unchecked")
2: protected Object decode(Channel channel, ChannelBuffer buffer, int readable, byte[] message) throws IOException{
3: // ã€TODO 8025ã€‘ä¸ºå•¥ client ä¾§ï¼Œç›´æ¥è¿”å›
4: if (isClientSide(channel)) {
5: return toString(message, getCharset(channel));
6: }
7: // æ£€æŸ¥é•¿åº¦
8: checkPayload(channel, readable);
9: if (message == null || message.length == 0) {
10: return DecodeResult.NEED_MORE_INPUT;
11: }
12:
13: // å¤„ç†é€€æ ¼çš„æƒ…å†µã€‚
14: if (message[message.length - 1] == '\b') { // Windows backspace echo
15: try {
16: // 32=ç©ºæ ¼ 8=é€€æ ¼
17: boolean doublechar = message.length >= 3 && message[message.length - 3] < 0; // double byte char
18: channel.send(new String(doublechar ? new byte[]{32, 32, 8, 8} : new byte[]{32, 8}, getCharset(channel).name()));
19: } catch (RemotingException e) {
20: throw new IOException(StringUtils.toString(e));
21: }
22: return DecodeResult.NEED_MORE_INPUT;
23: }
24:
25: // å…³é—­æŒ‡ä»¤
26: for (Object command : EXIT) {
27: if (isEquals(message, (byte[]) command)) {
28: if (logger.isInfoEnabled()) {
29: logger.info(new Exception("Close channel " + channel + " on exit command: " + Arrays.toString((byte[]) command)));
30: }
31: channel.close(); // å…³é—­é€šé“
32: return null;
33: }
34: }
35:
36: // ä½¿ç”¨å†å²çš„å‘½ä»¤
37: boolean up = endsWith(message, UP);
38: boolean down = endsWith(message, DOWN);
39: if (up || down) {
40: LinkedList<String> history = (LinkedList<String>) channel.getAttribute(HISTORY_LIST_KEY);
41: if (history == null || history.isEmpty()) {
42: return DecodeResult.NEED_MORE_INPUT;
43: }
44: // è·å¾—å†å²å‘½ä»¤æ•°ç»„çš„ä½ç½®
45: Integer index = (Integer) channel.getAttribute(HISTORY_INDEX_KEY);
46: Integer old = index;
47: if (index == null) {
48: index = history.size() - 1;
49: } else {
50: if (up) { // å‘ä¸Š
51: index = index - 1;
52: if (index < 0) {
53: index = history.size() - 1;
54: }
55: } else { // å‘ä¸‹
56: index = index + 1;
57: if (index > history.size() - 1) {
58: index = 0;
59: }
60: }
61: }
62: // è·å¾—å†å²å‘½ä»¤ï¼Œå¹¶å‘é€ç»™å®¢æˆ·ç«¯
63: if (old == null || !old.equals(index)) {
64: // è®¾ç½®å½“å‰ä½ç½®
65: channel.setAttribute(HISTORY_INDEX_KEY, index);
66: // è·å¾—å†å²å‘½ä»¤
67: String value = history.get(index);
68: // æ‹¼æ¥é€€æ ¼ï¼Œä»¥æ¸…é™¤å®¢æˆ·ç«¯åŸæœ‰å‘½ä»¤
69: if (old != null && old >= 0 && old < history.size()) {
70: String ov = history.get(old);
71: StringBuilder buf = new StringBuilder();
72: for (int i = 0; i < ov.length(); i++) {
73: buf.append("\b"); // é€€æ ¼
74: }
75: for (int i = 0; i < ov.length(); i++) {
76: buf.append(" ");
77: }
78: for (int i = 0; i < ov.length(); i++) {
79: buf.append("\b"); // é€€æ ¼
80: }
81: value = buf.toString() + value;
82: }
83: // å‘é€å‘½ä»¤
84: try {
85: channel.send(value);
86: } catch (RemotingException e) {
87: throw new IOException(StringUtils.toString(e));
88: }
89: }
90: // è¿”å›ï¼Œéœ€è¦æ›´å¤šæŒ‡ä»¤
91: return DecodeResult.NEED_MORE_INPUT;
92: }
93:
94: // å…³é—­æŒ‡ä»¤
95: for (Object command : EXIT) {
96: if (isEquals(message, (byte[]) command)) {
97: if (logger.isInfoEnabled()) {
98: logger.info(new Exception("Close channel " + channel + " on exit command " + command));
99: }
100: channel.close();
101: return null;
102: }
103: }
104: // æŸ¥æ‰¾æ˜¯å¦å›è½¦ç»“å°¾ã€‚è‹¥ä¸æ˜¯ï¼Œè¯´æ˜ä¸€æ¡ telnet æŒ‡ä»¤æ²¡ç»“æŸã€‚
105: byte[] enter = null;
106: for (Object command : ENTER) {
107: if (endsWith(message, (byte[]) command)) {
108: enter = (byte[]) command;
109: break;
110: }
111: }
112: if (enter == null) {
113: return DecodeResult.NEED_MORE_INPUT;
114: }
115: // ç§»é™¤å†å²å‘½ä»¤æ•°ç»„çš„ä½ç½®
116: LinkedList<String> history = (LinkedList<String>) channel.getAttribute(HISTORY_LIST_KEY);
117: Integer index = (Integer) channel.getAttribute(HISTORY_INDEX_KEY);
118: channel.removeAttribute(HISTORY_INDEX_KEY);
119: // å°†å†å²å‘½ä»¤æ‹¼æ¥
120: if (history != null && !history.isEmpty() && index != null && index >= 0 && index < history.size()) {
121: String value = history.get(index);
122: if (value != null) {
123: byte[] b1 = value.getBytes();
124: byte[] b2 = new byte[b1.length + message.length];
125: System.arraycopy(b1, 0, b2, 0, b1.length);
126: System.arraycopy(message, 0, b2, b1.length, message.length);
127: message = b2;
128: }
129: }
130: // å°†å‘½ä»¤å­—èŠ‚æ•°ç»„ï¼Œè½¬æˆå…·ä½“çš„ä¸€æ¡å‘½ä»¤
131: String result = toString(message, getCharset(channel));
132: // æ·»åŠ åˆ°å†å²
133: if (result.trim().length() > 0) {
134: if (history == null) {
135: history = new LinkedList<String>();
136: channel.setAttribute(HISTORY_LIST_KEY, history);
137: }
138: if (history.isEmpty()) {
139: history.addLast(result);
140: } else if (!result.equals(history.getLast())) {
141: // æ·»åŠ å½“å‰å‘½ä»¤åˆ°å†å²å°¾éƒ¨
142: history.remove(result);
143: history.addLast(result);
144: // è¶…è¿‡ä¸Šé™ï¼Œç§»é™¤å†å²çš„å¤´éƒ¨
145: if (history.size() > 10) {
146: history.removeFirst();
147: }
148: }
149: }
150: return result;
151: }
```

- ç¬”è€…åœ¨æµ‹è¯•ä»£ç ï¼Œä½¿ç”¨äº†ä¸¤ç§æ”¯æŒ telnet è¿æ¥çš„å·¥å…·ï¼Œä»è¡¨ç°ä¸Šå­˜åœ¨å·®å¼‚ï¼š

- ä½¿ç”¨

brew install telnet
å·¥å…·ï¼šæ¯æ¬¡è¾“å…¥å®Œå‘½ä»¤ï¼Œæ•²å®Œå›è½¦ï¼ŒDubbo Server æ‰æ”¶åˆ°è¯·æ±‚ã€‚

- ä½¿ç”¨ ShellCraft å·¥å…·ï¼šæ¯æ¬¡è¾“å…¥**ä»»ä½•ä¸€ä¸ª**å­—æ¯ï¼ŒDubbo Server éƒ½ä¼šæ”¶åˆ°è¯·æ±‚ã€‚
- ğŸ™‚ æ¨èä¸¤ç§å·¥å…·éƒ½å°è¯•ä¸‹ã€‚
- ç¬¬ 3 è‡³ 6 è¡Œï¼šã€TODO 8025ã€‘ä¸ºå•¥ client ä¾§ï¼Œç›´æ¥è¿”å›
- ç¬¬ 7 è‡³ 11 è¡Œï¼šè°ƒç”¨

/#checkPayload(channel, readable)
æ–¹æ³•ï¼Œæ£€æŸ¥é•¿åº¦ã€‚

- ç¬¬ 14 è‡³ 23 è¡Œï¼šå¤„ç†**é€€æ ¼**çš„æƒ…å†µã€‚ä¾‹å¦‚åœ¨ ShellCraft å·¥å…·çš„æƒ…å†µä¸‹ï¼Œè¾“é”™ä¸€ä¸ªå­—æ¯æ—¶ï¼Œä½¿ç”¨é€€æ ¼é”®ï¼Œéœ€è¦å‘ Client å‘é€ 32( ç©ºæ ¼ ) + 8( é€€æ ¼ )ã€‚
  FROM [ã€Štelnet ç¼–ç¨‹ å®¢æˆ·ç«¯ æœåŠ¡å™¨ã€‹](http://blog.51cto.com/wchrt/1627262)

å†™æœåŠ¡å™¨è¦è‡ªå·±å¤„ç†å¾ˆå¤šæƒ…å†µï¼Œæ¯”å¦‚è¯´æˆ‘è¦åˆ é™¤ä¸€ä¸ªå­—ç¬¦ã€‚BS é€€æ ¼ï¼Œä½†æ˜¯ä¸èƒ½åˆ é™¤ï¼Œä¹Ÿæ²¡æœ‰ç›¸åº”çš„åˆ é™¤ ASCIIã€‚è¿™é‡Œå¯ä»¥è¿™æ ·å¤„ç†ï¼šå…ˆå‘å®¢æˆ·ç«¯å‘é€é€€æ ¼ï¼Œå†å‘é€ç©ºæ ¼ï¼ˆè¦†ç›–è¦åˆ é™¤çš„å­—ç¬¦ï¼‰ï¼Œå†å‘é€é€€æ ¼ã€‚è¿™æ ·å°±å®ç°äº†åˆ é™¤ä¸€ä¸ªä½ç½®çš„å­—ç¬¦ã€‚

- ç¬¬ 25 è‡³ 34 è¡Œï¼šè°ƒç”¨

/#isEquals(message, command)
æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦ä½¿ç”¨é€€å‡ºå‘½ä»¤ã€‚è‹¥æ˜¯ï¼Œå…³é—­è¿æ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
private static final List<?> EXIT = Arrays.asList(new Object[]{new byte[]{3} //* Windows Ctrl+C /*/, new byte[]{-1, -12, -1, -3, 6} //* Linux Ctrl+C /*/, new byte[]{-1, -19, -1, -3, 6} //* Linux Pause /*/});
private static boolean isEquals(byte[] message, byte[] command) throws IOException{
return message.length == command.length && endsWith(message, command);
}
```

- ç¬¬ 36 è‡³ 92 è¡Œï¼šé€šè¿‡**å‘ä¸Š**æˆ–**å‘ä¸‹**é”®ï¼Œä» Dubbo Server è·å¾—å†å²çš„å‘½ä»¤ã€‚å› ä¸ºå¯ä»¥å¤šæ¬¡å‘ä¸Šæˆ–å‘ä¸‹ï¼Œæ‰€ä»¥ Server éœ€è¦è®°å½•ä½ç½®( Index )ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š

```
//*/*
/* å†å²å‘½ä»¤åˆ—è¡¨
/*/
private static final String HISTORY_LIST_KEY = "telnet.history.list";
//*/*
/* å†å²å‘½ä»¤ä½ç½®ï¼ˆç”¨æˆ·å‘ä¸Šæˆ–å‘ä¸‹ï¼‰
/*/
private static final String HISTORY_INDEX_KEY = "telnet.history.index";
//*/*
/* å‘ä¸Š
/*/
private static final byte[] UP = new byte[]{27, 91, 65};
//*/*
/* å‘ä¸‹
/*/
private static final byte[] DOWN = new byte[]{27, 91, 66};
```

- ğŸ™‚ ä»£ç æ¯”è¾ƒå¤æ‚ï¼Œæœ‰å¤šç§è¾¹ç•Œåœºæ™¯ï¼Œèƒ–å‹è®¤çœŸè¯»ä¸‹ä»£ç æ³¨é‡Šï¼Œå¹¶è‡ªå·±è°ƒè¯•ä¸‹ã€‚
- ç¬¬ 95 è‡³ 103 è¡Œï¼šå…³é—­æŒ‡ä»¤ã€‚**å†å²å‘½ä»¤çš„æƒ…å†µä¸‹**ã€‚
- ç¬¬ 104 è‡³ 114 è¡Œï¼šè°ƒç”¨

/#endsWith(message, command)
æ–¹æ³•ï¼ŒæŸ¥æ‰¾æ˜¯å¦**å›è½¦**ç»“å°¾ã€‚è‹¥ä¸æ˜¯ï¼Œè¯´æ˜ä¸€æ¡ telnet å‘½ä»¤è¿˜æ²¡ç»“æŸã€‚

```
private static final List<?> ENTER = Arrays.asList(new Object[]{new byte[]{'\r', '\n'} //* Windows Enter /*/, new byte[]{'\n'} //* Linux Enter /*/});
private static boolean endsWith(byte[] message, byte[] command) throws IOException{
if (message.length < command.length) {
return false;
}
int offset = message.length - command.length;
for (int i = command.length - 1; i >= 0; i--) {
if (message[offset + i] != command[i]) {
return false;
}
}
return true;
}
```

- ç¬¬ 115 è‡³ 118 è¡Œï¼šç§»é™¤å†å²å‘½ä»¤æ•°ç»„çš„ä½ç½®ã€‚
- ç¬¬ 119 è‡³ 129 è¡Œï¼šå°†å†å²å‘½ä»¤æ‹¼æ¥åˆ°å½“å‰å‘½ä»¤**å‰é¢**ã€‚æ­¤å¤„ä¼šå­˜åœ¨ä¸€ä¸ª Bug ï¼Œå¤ç°æµç¨‹å¦‚ä¸‹ï¼š

- 1ã€è¾“å…¥

ls
å›è½¦

- 2ã€è¾“å…¥

pwd
ï¼Œå‘ä¸Šï¼Œå›è½¦ã€‚æ­¤å¤„ Dubbo Server è§£æçš„æœ€ç»ˆç»“æœä¸º

lspwd
ã€‚ç†è®ºæ¥è¯´ï¼Œåº”è¯¥æ˜¯

ls
ã€‚

- ç¬¬ 131 è¡Œï¼šå°†å‘½ä»¤å­—èŠ‚æ•°ç»„ï¼Œè½¬æˆå…·ä½“çš„ä¸€æ¡å‘½ä»¤ã€‚

- è°ƒç”¨ [
  /#getCharset(channel)
  ](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/telnet/codec/TelnetCodec.java#L55-L85) æ–¹æ³•ï¼Œè·å¾—é€šé“çš„å­—ç¬¦é›†ã€‚ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹ç‚¹å‡»æŸ¥çœ‹ã€‚
- è°ƒç”¨

/#toString(message, charset)
æ–¹æ³•ï¼Œå°†å‘½ä»¤å­—èŠ‚æ•°ç»„ï¼Œè½¬æˆå…·ä½“çš„ä¸€æ¡å‘½ä»¤ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
private static String toString(byte[] message, Charset charset) throws UnsupportedEncodingException{
byte[] copy = new byte[message.length];
int index = 0;
for (int i = 0; i < message.length; i++) {
byte b = message[i];
// é€€æ ¼ï¼Œå°¾éƒ¨å‡å°
if (b == '\b') { // backspace
if (index > 0) {
index--;
}
if (i > 2 && message[i - 2] < 0) { // double byte char
if (index > 0) {
index--;
}
}
// æ¢ç (æº¢å‡º)
} else if (b == 27) { // escape
if (i < message.length - 4 && message[i + 4] == 126) {
i = i + 4;
} else if (i < message.length - 3 && message[i + 3] == 126) {
i = i + 3;
} else if (i < message.length - 2) {
i = i + 2;
}
// æ¡æ‰‹
} else if (b == -1 && i < message.length - 2
&& (message[i + 1] == -3 || message[i + 1] == -5)) { // handshake
i = i + 2;
} else {
copy[index++] = message[i];
}
}
if (index == 0) {
return "";
}
// åˆ›å»ºå­—ç¬¦ä¸²
return new String(copy, 0, index, charset.name()).trim();
}
```

/_ x
ğŸ˜ˆ å»ºè®®å¤šè°ƒè¯•ï¼Œè¿™æ ·ä¼šæ›´å¥½ç†è§£ã€‚
å¦‚ä¸‹æ˜¯ TelnetCodec çš„è¢«/_/_è°ƒç”¨æ ˆ/_/_ï¼š![è°ƒç”¨æ ˆ](http://static2.iocoder.cn/images/Dubbo/2018_12_07/03.png)
/_/_ç¼–ç /_/\*

```Java
public void encode(Channel channel, ChannelBuffer buffer, Object message) throws IOException{
// telnet å‘½ä»¤ç»“æœ
if (message instanceof String) {
if (isClientSide(channel)) { // ã€TODO 8025ã€‘ä¸ºå•¥ client ä¾§ï¼Œéœ€è¦å¤šåŠ  \r\n
message = message + "\r\n";
}
// å†™å…¥
byte[] msgData = ((String) message).getBytes(getCharset(channel).name());
buffer.writeBytes(msgData);
// é telnet å‘½ä»¤ç»“æœã€‚ç›®å‰ä¸ä¼šå‡ºç°
} else {
super.encode(channel, buffer, message);
}
}
```

# 3. TelnetHandler

com.alibaba.dubbo.remoting.telnet.TelnetHandler
ï¼Œtelnet å‘½ä»¤å¤„ç†å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@SPI
public interface TelnetHandler{
//*/*
/* telnet.
/* å¤„ç† telnet å‘½ä»¤
/*
/* @param channel é€šé“
/* @param message telnet å‘½ä»¤
/*/
String telnet(Channel channel, String message) throws RemotingException;
}
```

- @SPI
  æ³¨è§£ï¼ŒDubbo SPI **æ‹“å±•ç‚¹**ã€‚
- **æ¯ç§** telnet å‘½ä»¤ï¼Œå¯¹åº”ä¸€ä¸ª TelnetHandler å®ç°ç±»ã€‚

# 4. TelnetHandlerAdapter

com.alibaba.dubbo.remoting.telnet.support.TelnetHandlerAdapter
ï¼Œå®ç° TelnetHandler æ¥å£ï¼Œç»§æ‰¿ ChannelHandlerAdapter ç±»ï¼Œtelnet å¤„ç†å™¨**é€‚é…å™¨**ï¼Œè´Ÿè´£æ¥æ”¶æ¥è‡ª HeaderExchangeHandler çš„ telnet å‘½ä»¤ï¼Œåˆ†å‘ç»™å¯¹åº”çš„ TelnetHandler å®ç°ç±»ï¼Œè¿›è¡Œå¤„ç†ï¼Œ**è¿”å›å‘½ä»¤ç»“æœ**ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: public class TelnetHandlerAdapter extends ChannelHandlerAdapter implements TelnetHandler{
2:
3: private final ExtensionLoader<TelnetHandler> extensionLoader = ExtensionLoader.getExtensionLoader(TelnetHandler.class);
4:
5: @Override
6: public String telnet(Channel channel, String message) throws RemotingException{
7: // å¤„ç† telnet æç¤ºé”®
8: String prompt = channel.getUrl().getParameterAndDecoded(Constants.PROMPT_KEY, Constants.DEFAULT_PROMPT);
9: boolean noprompt = message.contains("--no-prompt");
10: message = message.replace("--no-prompt", "");
11: // æ‹†å‡º telnet å‘½ä»¤å’Œå‚æ•°
12: StringBuilder buf = new StringBuilder();
13: message = message.trim();
14: String command; // å‘½ä»¤
15: if (message.length() > 0) {
16: int i = message.indexOf(' ');
17: if (i > 0) {
18: command = message.substring(0, i).trim(); // å‘½ä»¤
19: message = message.substring(i + 1).trim(); // å‚æ•°
20: } else {
21: command = message; // å‘½ä»¤
22: message = ""; // å‚æ•°
23: }
24: } else {
25: command = ""; // å‘½ä»¤
26: }
27: if (command.length() > 0) {
28: // æŸ¥æ‰¾åˆ°å¯¹åº”çš„ TelnetHandler å¯¹è±¡ï¼Œæ‰§è¡Œå‘½ä»¤
29: if (extensionLoader.hasExtension(command)) {
30: try {
31: String result = extensionLoader.getExtension(command).telnet(channel, message);
32: if (result == null) {
33: return null;
34: }
35: buf.append(result);
36: } catch (Throwable t) {
37: buf.append(t.getMessage());
38: }
39: // æŸ¥æ‰¾ä¸åˆ°å¯¹åº”çš„ TelnetHandler å¯¹è±¡ï¼Œè¿”å›æŠ¥é”™ã€‚
40: } else {
41: buf.append("Unsupported command: ");
42: buf.append(command);
43: }
44: }
45: // æ·»åŠ  telnet æç¤ºè¯­
46: if (buf.length() > 0) {
47: buf.append("\r\n");
48: }
49: if (prompt != null && prompt.length() > 0 && !noprompt) {
50: buf.append(prompt);
51: }
52: // è¿”å›
53: return buf.toString();
54: }
55:
56: }
```

- ç¬¬ 8 è‡³ 10 è¡Œï¼šå¤„ç† telnet æç¤ºè¯­ï¼Œé»˜è®¤ä¸º

"dubbo"
ï¼Œå¯é€šè¿‡

<dubbo:application prompt="" />
é…ç½®ã€‚æç¤ºè¯­çš„æ•ˆæœï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºçº¢æ¡†éƒ¨åˆ†ï¼š![æç¤ºè¯­](http://static2.iocoder.cn/images/Dubbo/2018_12_07/04.png)

- ç¬¬ 11 è‡³ 26 è¡Œï¼šæ‹†é™¤ telnet å‘½ä»¤å’Œå‚æ•°**ä¸¤**éƒ¨åˆ†ã€‚
- ç¬¬ 28 è‡³ 38 è¡Œï¼šæŸ¥æ‰¾åˆ°å¯¹åº”çš„ TelnetHandler å¯¹è±¡ï¼Œæ‰§è¡Œå‘½ä»¤ï¼Œè¿”å›ç»“æœã€‚
- ç¬¬ 39 è‡³ 43 è¡Œï¼šæŸ¥æ‰¾ä¸åˆ°å¯¹åº”çš„ TelnetHandler å¯¹è±¡ï¼Œè¿”å›**æŠ¥é”™æç¤º**ã€‚
- ç¬¬ 45 è‡³ 53 è¡Œï¼šæ·»åŠ  telnet æç¤ºè¯­ï¼Œå¹¶æœ€ç»ˆè¿”å›ã€‚

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹ HeaderExchangeHandler å¯¹ TelnetHandlerAdapter çš„è°ƒç”¨ï¼Œç®€åŒ–ä»£ç å¦‚ä¸‹ï¼š

```
private final ExchangeHandler handler;
@Override
public void received(Channel channel, Object message) throws RemotingException{
// ... çœç•¥ä»£ç 
if (message instanceof String) {
if (isClientSide(channel)) {
Exception e = new Exception("Dubbo client can not supported string message: " + message + " in channel: " + channel + ", url: " + channel.getUrl());
logger.error(e.getMessage(), e);
} else {
String echo = handler.telnet(channel, (String) message);
if (echo != null && echo.length() > 0) {
channel.send(echo);
}
}
}
// ... çœç•¥ä»£ç 
}
```

- åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¼šè°ƒç”¨

handler
çš„

/#telnet(channel, message)
æ–¹æ³•ï¼Œå¤„ç† telnet å‘½ä»¤ï¼Œå¹¶å°†æ‰§è¡Œå‘½ä»¤çš„ç»“æœï¼Œå‘é€ç»™å®¢æˆ·ç«¯ã€‚

- ğŸ™‚ å¯èƒ½èƒ–å‹ä¼šæ‡µé€¼ï¼Œ

handler
ä¸æ˜¯ ExchangeHandler ç±»å‹ä¹ˆï¼Ÿåœ¨åé¢çš„æ–‡ç« ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ° ExchangeHandler å®ç° TelnetHandler æ¥å£ã€‚

è¿™æ ·å°±å®Œäº†ä¹ˆï¼Ÿä¸ä¸ä¸ã€‚ä¸ºä»€ä¹ˆ TelnetHandlerAdapter ä¼šç»§æ‰¿ ChannelHandlerAdapter ç±»å‘¢ï¼Ÿå› ä¸ºåæ–‡ä¼šçœ‹åˆ°çš„ ExchangeHandlerAdapter ï¼Œå®ç°äº† TelnetHandlerAdapter ç±»ï¼Œè€Œ Java ä¸æ”¯æŒå¤šç»§æ‰¿ï¼Œæ‰€ä»¥ä½¿ç”¨ TelnetHandlerAdapter ç»§æ‰¿ ChannelHandlerAdapter ç±»ã€‚å¤šå°‘æœ‰äº›æ— å¥ˆï¼Ÿè¿™æ˜¯è‰¿è‰¿çš„ç†è§£ï¼Œä¹Ÿä¸ä¸€å®šæ­£ç¡®ï¼Œæ¬¢è¿ä¸€èµ·æ¢è®¨ã€‚

# 5. TelnetHandler å‘½ä»¤å®ç°

åœ¨

command
åŒ…ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¤šç§ TelnetHandler å‘½ä»¤çš„å®ç°ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![command](http://static2.iocoder.cn/images/Dubbo/2018_12_07/05.png)

- ClearTelnetHandler
- ExitTelnetHandler
- HelpTelnetHandler
- LogTelnetHandler
- StatusTelnetHandler

ğŸ˜ˆ å…·ä½“æ¯ä¸ªç±»çš„å®ç°ï¼Œæœ¬æ–‡å°±çœç•¥ï¼Œèƒ–å‹å¯¹å“ªä¸ªæ„Ÿå…´è¶£ï¼Œå¯ä»¥è‡ªå·±ç…ç…ã€‚

åœ¨æ¯ä¸ªå®ç°ç±»ä¸Šï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æ·»åŠ æœ‰

@Help
æ³¨è§£ï¼Œç”¨äºæ¯ä¸ª telnet æŒ‡ä»¤çš„å¸®åŠ©æ–‡æ¡£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE})
public @interface Help {
//*/*
/* å‚æ•°è¯´æ˜
/*/
String parameter() default "";
//*/*
/* ç®€è¦æç¤º
/*/
String summary();
//*/*
/* è¯¦ç»†æç¤º
/*/
String detail() default "";
}
```
