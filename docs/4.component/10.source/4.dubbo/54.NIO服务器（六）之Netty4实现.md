# NIO æœåŠ¡å™¨ï¼ˆå…­ï¼‰ä¹‹ Netty4 å®ç°

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

åœ¨å‰é¢çš„æ–‡ç« ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†

dubbo-remoting-api
å¦‚ä½•å®ç° NIO æœåŠ¡å™¨çš„æŠ½è±¡ API å±‚ã€‚é‚£ä¹ˆæœ¬æ–‡æ¥çœ‹çœ‹ï¼Œ

dubbo-remoting-netty4
ï¼Œå¦‚ä½•å°† Netty4 æ¥å…¥å®ç°ã€‚

æ¶‰åŠå¦‚ä¸‹ç±»ï¼š

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_12_16/01.png)
å‹æƒ…æç¤ºï¼šåœ¨å½“å‰ç‰ˆæœ¬ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Netty3 ï¼Œå¦‚æœæƒ³é…ç½®æˆ Netty4 ï¼Œè¯·å‚è€ƒæ–‡æ¡£ï¼š[ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” Netty4ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/netty4.html)

# 2. NettyTransporter

com.alibaba.dubbo.remoting.transport.netty4.NettyTransporter
ï¼Œå®ç° Transporter æ¥å£ï¼ŒåŸºäº **Netty4** çš„ç½‘ç»œä¼ è¾“å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class NettyTransporter implements Transporter{
//*/*
/* æ‹“å±•å
/*/
public static final String NAME = "netty4";
public Server bind(URL url, ChannelHandler listener) throws RemotingException{
return new NettyServer(url, listener);
}
public Client connect(URL url, ChannelHandler listener) throws RemotingException{
return new NettyClient(url, listener);
}
}
```

- NAME
  **é™æ€**å±æ€§ï¼Œæ‹“å±•åã€‚
- NettyTransporter åŸºäº Dubbo SPI æœºåˆ¶åŠ è½½ã€‚
- åˆ›å»º NettyServer å’Œ NettyClient å¯¹è±¡ã€‚

# 3. NettyChannel

io.netty.channel.ChannelFuture.NettyChannel
ï¼Œå®ç° AbstractChannel æŠ½è±¡ç±»ï¼Œ**å°è£… Netty Channel** çš„é€šé“å®ç°ç±»ã€‚
NettyChannel å’Œ HeaderExchangeChannel å¾ˆç±»ä¼¼ã€‚

**æ„é€ æ–¹æ³•**

```
//*/*
/* é€šé“é›†åˆ
/*/
private static final ConcurrentMap<io.netty.channel.Channel, NettyChannel> channelMap = new ConcurrentHashMap<Channel, NettyChannel>();
//*/*
/* é€šé“
/*/
private final io.netty.channel.Channel channel;
//*/*
/* å±æ€§é›†åˆ
/*/
private final Map<String, Object> attributes = new ConcurrentHashMap<String, Object>();
private NettyChannel(io.netty.channel.Channel channel, URL url, ChannelHandler handler){
super(url, handler);
if (channel == null) {
throw new IllegalArgumentException("netty channel == null;");
}
this.channel = channel;
}
```

- channel
  å±æ€§ï¼Œé€šé“ã€‚NettyChannel æ˜¯ä¼ å…¥

channel
å±æ€§çš„**è£…é¥°å™¨**ï¼Œæ¯ä¸ªå®ç°çš„æ–¹æ³•ï¼Œéƒ½ä¼šè°ƒç”¨

channel
ã€‚

- attributes
  å±æ€§ï¼Œå±æ€§é›†åˆã€‚**æ³¨æ„**ï¼Œ

setAttribute(...)
ç­‰æ–¹æ³•ï¼Œä½¿ç”¨çš„æ˜¯è¯¥å±æ€§ï¼Œè€Œä¸æ˜¯

io.netty.channel.Channel
çš„ã€‚

- channelMap
  **é™æ€**å±æ€§ï¼Œé€šé“é›†åˆã€‚åœ¨å®é™… Netty Handler é‡Œï¼ˆä¾‹å¦‚ä¸‹é¢æˆ‘ä»¬ä¼šçœ‹åˆ°çš„ NettyServerHandler å’Œ NettyClientHandlerï¼‰ï¼Œæ¯ä¸ªæ–¹æ³•å‚æ•°é‡Œï¼Œä¼ é€’çš„æ˜¯

io.netty.channel.Channel
å¯¹è±¡ã€‚é€šè¿‡

NettyChannel.channelMap
ä¸­ï¼Œè·å¾—å¯¹åº”çš„ NettyChannel å¯¹è±¡ã€‚

- /#getOrAddChannel(ch, url, handler)
  **é™æ€**æ–¹æ³•ï¼Œåˆ›å»º NettyChannel å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
static NettyChannel getOrAddChannel(io.netty.channel.Channel ch, URL url, ChannelHandler handler){
if (ch == null) {
return null;
}
NettyChannel ret = channelMap.get(ch);
if (ret == null) {
NettyChannel nettyChannel = new NettyChannel(ch, url, handler);
if (ch.isActive()) { // è¿æ¥ä¸­
ret = channelMap.putIfAbsent(ch, nettyChannel); // æ·»åŠ åˆ° channelMap
}
if (ret == null) {
ret = nettyChannel;
}
}
return ret;
}
```

- x
- /#removeChannelIfDisconnected(ch)
  **é™æ€**æ–¹æ³•ï¼Œç§»é™¤ NettyChannel å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
static void removeChannelIfDisconnected(io.netty.channel.Channel ch){
if (ch != null && !ch.isActive()) { // æœªè¿æ¥
channelMap.remove(ch); // ç§»é™¤å‡ºchannelMap
}
}
```

- x

**å‘é€æ¶ˆæ¯**

```
1: @Override
2: public void send(Object message, boolean sent) throws RemotingException{
3: // æ£€æŸ¥è¿æ¥çŠ¶æ€
4: super.send(message, sent);
5:
6: boolean success = true; // å¦‚æœæ²¡æœ‰ç­‰å¾…å‘é€æˆåŠŸï¼Œé»˜è®¤æˆåŠŸã€‚
7: int timeout = 0;
8: try {
9: // å‘é€æ¶ˆæ¯
10: ChannelFuture future = channel.writeAndFlush(message);
11: // ç­‰å¾…å‘é€æˆåŠŸ
12: if (sent) {
13: timeout = getUrl().getPositiveParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);
14: success = future.await(timeout);
15: }
16: // è‹¥å‘ç”Ÿå¼‚å¸¸ï¼ŒæŠ›å‡º
17: Throwable cause = future.cause();
18: if (cause != null) {
19: throw cause;
20: }
21: } catch (Throwable e) {
22: throw new RemotingException(this, "Failed to send message " + message + " to " + getRemoteAddress() + ", cause: " + e.getMessage(), e);
23: }
24:
25: // å‘é€å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸
26: if (!success) {
27: throw new RemotingException(this, "Failed to send message " + message + " to " + getRemoteAddress()
28: + "in timeout(" + timeout + "ms) limit");
29: }
30: }
```

- ç¬¬ 4 è¡Œï¼šè°ƒç”¨

/#send(message, sent)
æ–¹æ³•ï¼Œæ£€æŸ¥è¿æ¥çŠ¶æ€ã€‚

- ç¬¬ 6 è¡Œï¼š

success
ï¼Œæ˜¯å¦æ‰§è¡ŒæˆåŠŸã€‚è‹¥ä¸éœ€è¦ç­‰å¾…å‘é€æˆåŠŸ(

sent = false
) ï¼Œé»˜è®¤æˆåŠŸã€‚

- ç¬¬ 10 è¡Œï¼šè°ƒç”¨**çœŸæ­£çš„**

io.netty.channel.Channel/#writeAndFlush(message)
æ–¹æ³•ï¼Œå‘é€æ¶ˆæ¯ã€‚

- ç¬¬ 11 è‡³ 15 è¡Œï¼šè‹¥éœ€è¦ç­‰å¾…å‘é€æˆåŠŸ(

sent = true
)ï¼Œç­‰å¾…ç›´åˆ°æˆåŠŸæˆ–è¶…æ—¶ã€‚

- ç¬¬ 16 è‡³ 20 è¡Œï¼šè‹¥å‘ç”Ÿå¼‚å¸¸ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚
- ç¬¬ 26 è‡³ 29 è¡Œï¼šè‹¥å‘é€å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚

**å…³é—­é€šé“**

```
@Override
@SuppressWarnings("Duplicates")
public void close(){
// æ ‡è®°å…³é—­
try {
super.close();
} catch (Exception e) {
logger.warn(e.getMessage(), e);
}
// ç§»é™¤è¿æ¥
try {
removeChannelIfDisconnected(channel);
} catch (Exception e) {
logger.warn(e.getMessage(), e);
}
// æ¸…ç©ºå±æ€§ attributes
try {
attributes.clear();
} catch (Exception e) {
logger.warn(e.getMessage(), e);
}
// å…³é—­çœŸæ­£çš„é€šé“ channel
try {
if (logger.isInfoEnabled()) {
logger.info("Close netty channel " + channel);
}
channel.close();
} catch (Exception e) {
logger.warn(e.getMessage(), e);
}
}
```

- **æ³¨æ„**ï¼Œæœ€åä¸€æ­¥æ‰å…³é—­çœŸæ­£çš„é€šé“ï¼Œé¿å…ä¸­é—´çŠ¶æ€ã€‚

**å…¶å®ƒæ–¹æ³•**

å…¶å®ƒå®ç°æ–¹æ³•ï¼Œæ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±ç…ç…ã€‚ä¾‹å¦‚ï¼š

```
@Override
public boolean isConnected(){
return !isClosed() && channel.isActive();
}
```

# 4. Server

## 4.1 NettyServer

[
com.alibaba.dubbo.remoting.transport.netty4.NettyServer
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyServer.java) ï¼Œå®ç° Server æ¥å£ï¼Œç»§æ‰¿ AbstractServer æŠ½è±¡ç±»ï¼ŒNetty æœåŠ¡å™¨å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**

```
//*/*
/* é€šé“é›†åˆ
/*/
private Map<String, Channel> channels; // <ip:port, channel>
private ServerBootstrap bootstrap;
private io.netty.channel.Channel channel;
private EventLoopGroup bossGroup;
private EventLoopGroup workerGroup;
public NettyServer(URL url, ChannelHandler handler) throws RemotingException{
super(url, ChannelHandlers.wrap(handler, ExecutorUtil.setThreadName(url, SERVER_THREAD_POOL_NAME) //* è®¾ç½®çº¿ç¨‹ååˆ° URL ä¸Š /*/));
}
```

- channels
  å±æ€§ï¼Œè¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é€šé“é›†åˆã€‚ç¬”è€…åœ¨çœ‹ NettyChannel æ—¶ï¼Œåœ¨æœ‰

NettyChannel.channels
ï¼Œé‚£ä¹ˆæ­¤å¤„çš„

channels
ä¸æ˜¯é‡å¤äº†ä¹ˆï¼Ÿç­”æ¡ˆåœ¨

/#getChannel(remoteAddress)
æ–¹æ³•ï¼Œè·å¾—**æŒ‡å®šåœ°å€**çš„ Channel å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@Override
public Channel getChannel(InetSocketAddress remoteAddress){
return channels.get(NetUtils.toAddressString(remoteAddress));
}
```

- bootstrap

channel

bossGroup

workerGroup
å±æ€§ï¼ŒğŸ˜ˆ ä¸ç†Ÿæ‚‰è¿™å‡ ä¸ªçš„èƒ–å‹ï¼Œè¯· Google ä¸€ä¸‹ Netty å…¥é—¨å™¶ã€‚

- ChannelHandlers.wrap(handler, ExecutorUtil.setThreadName(url, SERVER_THREAD_POOL_NAME)
  ä»£ç æ®µï¼ŒåŒ…è£… ChannelHandler ï¼Œå®ç° Dubbo çº¿ç¨‹æ¨¡å‹çš„åŠŸèƒ½ã€‚

- [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” NIO æœåŠ¡å™¨ï¼ˆäºŒï¼‰ä¹‹ Transport å±‚ã€‹ã€Œ8. Dispacherã€](http://svip.iocoder.cn/Dubbo/remoting-api-transport/?self) æœ‰è¯¦ç»†è§£æã€‚
- [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” çº¿ç¨‹æ¨¡å‹ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/thread-model.html)

**å¯åŠ¨æœåŠ¡å™¨**

```
1: @Override
2: protected void doOpen(){
3: // è®¾ç½®æ—¥å¿—å·¥å‚
4: NettyHelper.setNettyLoggerFactory();
5:
6: // å®ä¾‹åŒ– ServerBootstrap
7: bootstrap = new ServerBootstrap();
8:
9: // åˆ›å»ºçº¿ç¨‹ç»„
10: bossGroup = new NioEventLoopGroup(1, new DefaultThreadFactory("NettyServerBoss", true));
11: workerGroup = new NioEventLoopGroup(getUrl().getPositiveParameter(Constants.IO_THREADS_KEY, Constants.DEFAULT_IO_THREADS),
12: new DefaultThreadFactory("NettyServerWorker", true));
13:
14: // åˆ›å»º NettyServerHandler å¯¹è±¡
15: final NettyServerHandler nettyServerHandler = new NettyServerHandler(getUrl(), this);
16: // è®¾ç½® `channels` å±æ€§
17: channels = nettyServerHandler.getChannels();
18:
19: bootstrap
20: // è®¾ç½®å®ƒçš„çº¿ç¨‹ç»„
21: .group(bossGroup, workerGroup)
22: // è®¾ç½® Channelç±»å‹
23: .channel(NioServerSocketChannel.class) // Server
24: // è®¾ç½®å¯é€‰é¡¹
25: .childOption(ChannelOption.TCP_NODELAY, Boolean.TRUE)
26: .childOption(ChannelOption.SO_REUSEADDR, Boolean.TRUE)
27: .childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT)
28: // è®¾ç½®è´£ä»»é“¾è·¯
29: .childHandler(new ChannelInitializer<NioSocketChannel>() {
30: @Override
31: protected void initChannel(NioSocketChannel ch){
32: // åˆ›å»º NettyCodecAdapter å¯¹è±¡
33: NettyCodecAdapter adapter = new NettyCodecAdapter(getCodec(), getUrl(), NettyServer.this);
34: ch.pipeline()//.addLast("logging",new LoggingHandler(LogLevel.INFO))//for debug
35: .addLast("decoder", adapter.getDecoder()) // è§£ç 
36: .addLast("encoder", adapter.getEncoder()) // è§£ç 
37: .addLast("handler", nettyServerHandler); // å¤„ç†å™¨
38: }
39: });
40:
41: // æœåŠ¡å™¨ç»‘å®šç«¯å£ç›‘å¬
42: // bind
43: ChannelFuture channelFuture = bootstrap.bind(getBindAddress());
44: channelFuture.syncUninterruptibly();
45: channel = channelFuture.channel();
46: }
```

- å‚è€ƒï¼š[ã€ŠNetty4.x ä¸­æ–‡æ•™ç¨‹ç³»åˆ—(å…­) ä»å¤´å¼€å§‹ Bootstrapã€‹](https://tinyzzh.github.io/netty/2014/08/12/Netty4.x_6.html)
- ç¬¬ 4 è¡Œï¼šè®¾ç½® Netty çš„æ—¥å¿—å·¥å‚ï¼Œåœ¨ [ã€Œ7. æ—¥å¿—å¤„ç†ã€](http://svip.iocoder.cn/Dubbo/remoting-impl-netty4/) è¯¦ç»†è§£æã€‚
- ç¬¬ 7 è¡Œï¼šå®ä¾‹åŒ– ServerBootstrap å¯¹è±¡ã€‚
- ç¬¬ 9 è‡³ 12 è¡Œï¼šåˆ›å»º

bossGroup

workerGroup
çº¿ç¨‹ç»„ã€‚

- ç¬¬ 15 è¡Œï¼šåˆ›å»º NettyServerHandler å¯¹è±¡ã€‚
- ç¬¬ 17 è¡Œï¼šè®¾ç½®

channels
å±æ€§ï¼ŒæŒ‡å‘

NettyServerHandler.channels
å±æ€§ã€‚

- ç¬¬ 21 è¡Œï¼šè®¾ç½®çº¿ç¨‹ç»„ã€‚
- ç¬¬ 23 è¡Œï¼šè®¾ç½® Channel ç±»å‹ä¸º NioServerSocketChannel ã€‚
- ç¬¬ 24 è‡³ 27 è¡Œï¼šè®¾ç½®å¯é€‰é¡¹ã€‚

- PooledByteBufAllocator.DEFAULT
  ï¼Œå¯¹è±¡æ± ï¼Œé‡ç”¨ç¼“å†²åŒºã€‚å‚è§ [ã€ŠNetty è°ƒä¼˜ã€‹](http://huangdongrong.github.io/2016/05/24/netty-jvm/) ã€‚
- ç¬¬ 29 è‡³ 39 è¡Œï¼šè®¾ç½®è´£ä»»é“¾ã€‚

- ç¬¬ 33 è¡Œï¼šåˆ›å»º NettyCodecAdapter å¯¹è±¡ã€‚NettyCodecAdapter åœ¨ [ã€Œ6. 2 NettyCodecAdapterã€](http://svip.iocoder.cn/Dubbo/remoting-impl-netty4/) è¯¦ç»†è§£æã€‚
- ç¬¬ 35 è¡Œï¼šè°ƒç”¨

NettyCodecAdapter/#getDecoder()
æ–¹æ³•ï¼Œè·å¾—è§£ç å™¨ï¼Œå¹¶è®¾ç½®ã€‚

- ç¬¬ 37 è¡Œï¼šè°ƒç”¨

NettyCodecAdapter/#getEncoder()
æ–¹æ³•ï¼Œè·å¾—ç¼–ç å™¨ï¼Œå¹¶è®¾ç½®ã€‚

- ç¬¬ 37 è¡Œï¼šè®¾ç½®å¤„ç†å™¨

handler
ã€‚

- ç¬¬ 41 è‡³ 45 è¡Œï¼šæœåŠ¡å™¨ç»‘å®šç«¯å£ç›‘å¬ï¼Œ**æ­£å¼å¯åŠ¨**å•¦ã€‚

**è·å¾—æ‰€æœ‰é€šé“**

```
public Collection<Channel> getChannels(){
Collection<Channel> chs = new HashSet<Channel>();
for (Channel channel : this.channels.values()) {
if (channel.isConnected()) { // å·²è¿æ¥ï¼Œè¿”å›
chs.add(channel);
} else { // æœªè¿æ¥ï¼Œç§»é™¤
channels.remove(NetUtils.toAddressString(channel.getRemoteAddress()));
}
}
return chs;
}
```

**å…³é—­æœåŠ¡å™¨**

```
1: @Override
2: protected void doClose(){
3: // å…³é—­æœåŠ¡å™¨é€šé“
4: try {
5: if (channel != null) {
6: // unbind.
7: channel.close();
8: }
9: } catch (Throwable e) {
10: logger.warn(e.getMessage(), e);
11: }
12: // å…³é—­è¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é€šé“
13: try {
14: Collection<com.alibaba.dubbo.remoting.Channel> channels = getChannels();
15: if (channels != null && channels.size() > 0) {
16: for (com.alibaba.dubbo.remoting.Channel channel : channels) {
17: try {
18: channel.close();
19: } catch (Throwable e) {
20: logger.warn(e.getMessage(), e);
21: }
22: }
23: }
24: } catch (Throwable e) {
25: logger.warn(e.getMessage(), e);
26: }
27: // ä¼˜é›…å…³é—­å·¥ä½œç»„
28: try {
29: if (bootstrap != null) {
30: bossGroup.shutdownGracefully();
31: workerGroup.shutdownGracefully();
32: }
33: } catch (Throwable e) {
34: logger.warn(e.getMessage(), e);
35: }
36: // æ¸…ç©ºè¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é€šé“
37: try {
38: if (channels != null) {
39: channels.clear();
40: }
41: } catch (Throwable e) {
42: logger.warn(e.getMessage(), e);
43: }
44: }
```

- ç¬¬ 3 è‡³ 11 è¡Œï¼šå…³é—­æœåŠ¡å™¨é€šé“(

io.netty.channel.Channel
)ã€‚

- ç¬¬ 12 è‡³ 26 è¡Œï¼šå…³é—­è¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é€šé“(

com.alibaba.dubbo.remoting.Channel
) ã€‚

- ç¬¬ 27 è‡³ 35 è¡Œï¼šä¼˜é›…å…³é—­å·¥ä½œç»„ã€‚
- ç¬¬ 36 è‡³ 43 è¡Œï¼šæ¸…ç©ºè¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é€šé“ã€‚

## 4.2 NettyServerHandler

[
com.alibaba.dubbo.remoting.transport.netty4.NettyServerHandler
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyServerHandler.java) ï¼Œå®ç°

io.netty.channel.ChannelDuplexHandler
ç±»ï¼ŒNettyServer çš„å¤„ç†å™¨ã€‚
NettyServerHandler å’Œ HeaderExchangeHandler ç±»ä¼¼ã€‚

**æ„é€ æ–¹æ³•**

```
@io.netty.channel.ChannelHandler.Sharable
public class NettyServerHandler extends ChannelDuplexHandler{
//*/*
/* Dubbo Channel é›†åˆ
/*/
private final Map<String, Channel> channels = new ConcurrentHashMap<String, Channel>(); // <ip:port, channel>
//*/*
/* URL
/*/
private final URL url;
//*/*
/* Dubbo ChannelHandler
/*/
private final ChannelHandler handler;
public NettyServerHandler(URL url, ChannelHandler handler){
if (url == null) {
throw new IllegalArgumentException("url == null");
}
if (handler == null) {
throw new IllegalArgumentException("handler == null");
}
this.url = url;
this.handler = handler;
}
// ... çœç•¥å®ç°æ–¹æ³•
}
```

- [`@io.netty.channel.ChannelHandler.Sharable](mailto:%60@io.netty.channel.ChannelHandler.Sharable)` æ³¨è§£ï¼š
  FROM [ã€Šnetty4 ä¸­æ³¨è§£ Sharable çš„ä½¿ç”¨åœºæ™¯ï¼Ÿã€‹](https://www.zhihu.com/question/50198921)

Sharable æ³¨è§£ä¸»è¦æ˜¯ç”¨æ¥æ ‡ç¤ºä¸€ä¸ª ChannelHandler å¯ä»¥è¢«å®‰å…¨åœ°å…±äº«ï¼Œå³å¯ä»¥åœ¨å¤šä¸ª Channel çš„ ChannelPipeline ä¸­ä½¿ç”¨åŒä¸€ä¸ª ChannelHandler ï¼Œè€Œä¸å¿…æ¯ä¸€ä¸ª ChannelPipeline éƒ½é‡æ–° new ä¸€ä¸ªæ–°çš„ ChannelHandler ã€‚

- channels
  å±æ€§ï¼Œè¿æ¥åˆ°æœåŠ¡å™¨çš„ Dubbo Channel é›†åˆã€‚
- handler
  å±æ€§ï¼ŒDubbo ChannelHandlerã€‚NettyServerHandler å¯¹æ¯ä¸ªäº‹ä»¶çš„å¤„ç†ï¼Œä¼šè°ƒç”¨

handler
å¯¹åº”çš„æ–¹æ³•ã€‚

**å®ç°æ–¹æ³•**

æ¯ä¸ªå®ç°çš„æ–¹æ³•ï¼Œå¤„ç†éƒ½æ¯”è¾ƒç±»ä¼¼ï¼Œä¸€èˆ¬æ˜¯æäº¤ç»™

handler
åšç›¸åº”çš„å¤„ç†ã€‚è‰¿è‰¿å·²ç»æ·»åŠ äº†ä»£ç æ³¨é‡Šï¼Œèƒ–å‹å¯ä»¥è‡ªå·±çœ‹çœ‹ã€‚ä¸‹é¢ä»¥

/#channelActive(ChannelHandlerContext)
æ–¹æ³•ä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
1: @Override
2: public void channelActive(ChannelHandlerContext ctx) throws Exception{
3: // äº¤ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å¤„ç†
4: // èŠ‹è‰¿ï¼šå®é™…æ­¤å¤„ä¸è¦è°ƒç”¨ä¹Ÿæ²¡å…³ç³»ï¼Œå› ä¸º NettyServerHandler æ²¡ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚
5: ctx.fireChannelActive();
6:
7: // åˆ›å»º NettyChannel å¯¹è±¡
8: NettyChannel channel = NettyChannel.getOrAddChannel(ctx.channel(), url, handler);
9: try {
10: // æ·»åŠ åˆ° `channels` ä¸­
11: if (channel != null) {
12: channels.put(NetUtils.toAddressString((InetSocketAddress) ctx.channel().remoteAddress()), channel);
13: }
14: // æäº¤ç»™ `handler` å¤„ç†å™¨ã€‚
15: handler.connected(channel);
16: } finally {
17: // ç§»é™¤ NettyChannel å¯¹è±¡ï¼Œè‹¥å·²æ–­å¼€
18: NettyChannel.removeChannelIfDisconnected(ctx.channel());
19: }
20: }
```

- [ã€ŠNetty æ¡†æ¶æ€»ç»“ã€ŒChannelHandler åŠ EventLoopã€ã€‹](https://www.jianshu.com/p/88ffafa23221)
- ç¬¬ 5 è¡Œï¼šè°ƒç”¨

ChannelHandlerContext/#fireChannelActive()
æ–¹æ³•ï¼Œäº¤ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å¤„ç†ã€‚å®é™…ä¸Šï¼Œ**æ­¤å¤„ä¸è¦è°ƒç”¨ä¹Ÿæ²¡å…³ç³»**ï¼Œå› ä¸º NettyServerHandler æ²¡ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚

- ç¬¬ 8 è¡Œï¼šè°ƒç”¨

NettyChannel/#getOrAddChannel(channel, url, handler)
æ–¹æ³•ï¼Œåˆ›å»º NettyChannel å¯¹è±¡ã€‚

- ç¬¬ 10 è‡³ 13 è¡Œï¼šæ·»åŠ åˆ°

channels
ä¸­ã€‚

- ç¬¬ 15 è¡Œï¼šè°ƒç”¨

ChannelHandler/#connected(channel)
æ–¹æ³•ï¼Œå¤„ç†è¿æ¥äº‹ä»¶ã€‚

- ç¬¬ 16 è‡³ 19 è¡Œï¼šè°ƒç”¨

NettyChannel/#removeChannelIfDisconnected(channel)
æ–¹æ³•ï¼Œç§»é™¤ NettyChannel å¯¹è±¡ï¼Œè‹¥**å·²æ–­å¼€**ã€‚

# 5. Client

## 5.1 NettyClient

[
com.alibaba.dubbo.remoting.transport.netty4.NettyClient
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyClient.java) ï¼Œç»§æ‰¿ AbstractNettyClient æŠ½è±¡ç±»ï¼ŒNetty å®¢æˆ·ç«¯å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**

```
// ã€TODO 8027ã€‘ä¸ºå•¥å…¬ç”¨
private static final NioEventLoopGroup nioEventLoopGroup = new NioEventLoopGroup(Constants.DEFAULT_IO_THREADS, new DefaultThreadFactory("NettyClientWorker", true));
private Bootstrap bootstrap;
private volatile io.netty.channel.Channel channel; // volatile, please copy reference to use
public NettyClient(final URL url, final ChannelHandler handler) throws RemotingException{
super(url, wrapChannelHandler(url, handler));
}
```

- nioEventLoopGroup
  å±æ€§ï¼Œã€TODO 8027ã€‘ä¸ºå•¥å…¬ç”¨
- channel
  å±æ€§ï¼Œé€šé“ï¼Œæœ‰ **volatile** ä¿®é¥°ç¬¦ã€‚å› ä¸ºå®¢æˆ·ç«¯å¯èƒ½ä¼šæ–­å¼€é‡è¿ï¼Œéœ€è¦ä¿è¯**å¤šçº¿ç¨‹**çš„å¯è§æ€§ã€‚
- /#wrapChannelHandler(url, handler)
  ä»£ç æ®µï¼ŒåŒ…è£… ChannelHandler ï¼Œå®ç° Dubbo çº¿ç¨‹æ¨¡å‹çš„åŠŸèƒ½ã€‚

- [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” NIO æœåŠ¡å™¨ï¼ˆäºŒï¼‰ä¹‹ Transport å±‚ã€‹ã€Œ8. Dispacherã€](http://svip.iocoder.cn/Dubbo/remoting-api-transport/?self) æœ‰è¯¦ç»†è§£æã€‚
- [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” çº¿ç¨‹æ¨¡å‹ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/thread-model.html)

**å¯åŠ¨å®¢æˆ·ç«¯**

```
1: @Override
2: protected void doOpen(){
3: // è®¾ç½®æ—¥å¿—å·¥å‚
4: NettyHelper.setNettyLoggerFactory();
5:
6: // åˆ›å»º NettyClientHandler å¯¹è±¡
7: final NettyClientHandler nettyClientHandler = new NettyClientHandler(getUrl(), this);
8:
9: // å®ä¾‹åŒ– ServerBootstrap
10: bootstrap = new Bootstrap();
11: bootstrap
12: // è®¾ç½®å®ƒçš„çº¿ç¨‹ç»„
13: .group(nioEventLoopGroup)
14: // è®¾ç½®å¯é€‰é¡¹
15: .option(ChannelOption.SO_KEEPALIVE, true)
16: .option(ChannelOption.TCP_NODELAY, true)
17: .option(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT)
18: //.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, getTimeout())
19: // è®¾ç½® Channelç±»å‹
20: .channel(NioSocketChannel.class);
21:
22: // è®¾ç½®è¿æ¥è¶…æ—¶æ—¶é—´
23: if (getTimeout() < 3000) {
24: bootstrap.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 3000);
25: } else {
26: bootstrap.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, getTimeout());
27: }
28:
29: // è®¾ç½®è´£ä»»é“¾è·¯
30: bootstrap.handler(new ChannelInitializer() {
31: @Override
32: protected void initChannel(Channel ch){
33: // åˆ›å»º NettyCodecAdapter å¯¹è±¡
34: NettyCodecAdapter adapter = new NettyCodecAdapter(getCodec(), getUrl(), NettyClient.this);
35: ch.pipeline()//.addLast("logging",new LoggingHandler(LogLevel.INFO))//for debug
36: .addLast("decoder", adapter.getDecoder()) // è§£ç 
37: .addLast("encoder", adapter.getEncoder()) // è§£ç 
38: .addLast("handler", nettyClientHandler); // å¤„ç†å™¨
39: }
40: });
41: }
```

- å’Œ

NettyClient/#doOpen()
æ–¹æ³•ç±»ä¼¼ã€‚æˆ‘ä»¬ä»…ä»…è¯´ä¸€äº›å·®å¼‚ç‚¹ã€‚

- ç¬¬ 7 è¡Œï¼šåˆ›å»º NettyClientHandler å¯¹è±¡ã€‚
- ç¬¬ 13 è¡Œï¼šè®¾ç½®çº¿ç¨‹ç»„ï¼Œæ²¡æœ‰

bossGroup
ã€‚

- ç¬¬ 20 è¡Œï¼šè®¾ç½® Channel ç±»å‹ä¸º NioSocketChannel ã€‚
- ç¬¬ 22 è‡³ 27 è¡Œï¼šè®¾ç½®è¿æ¥è¶…æ—¶æ—¶é—´ã€‚

**è¿æ¥æœåŠ¡å™¨**

```
1: @Override
2: @SuppressWarnings("Duplicates")
3: protected void doConnect() throws Throwable{
4: long start = System.currentTimeMillis();
5: // è¿æ¥æœåŠ¡å™¨
6: ChannelFuture future = bootstrap.connect(getConnectAddress());
7: try {
8: // ç­‰å¾…è¿æ¥æˆåŠŸæˆ–è€…è¶…æ—¶
9: boolean ret = future.awaitUninterruptibly(3000, TimeUnit.MILLISECONDS);
10: // è¿æ¥æˆåŠŸ
11: if (ret && future.isSuccess()) {
12: Channel newChannel = future.channel();
13: try {
14: // å…³é—­è€çš„è¿æ¥
15: // Close old channel
16: Channel oldChannel = NettyClient.this.channel; // copy reference
17: if (oldChannel != null) {
18: try {
19: if (logger.isInfoEnabled()) {
20: logger.info("Close old netty channel " + oldChannel + " on create new netty channel " + newChannel);
21: }
22: oldChannel.close();
23: } finally {
24: NettyChannel.removeChannelIfDisconnected(oldChannel);
25: }
26: }
27: } finally {
28: // è‹¥ NettyClient è¢«å…³é—­ï¼Œå…³é—­è¿æ¥
29: if (NettyClient.this.isClosed()) {
30: try {
31: if (logger.isInfoEnabled()) {
32: logger.info("Close new netty channel " + newChannel + ", because the client closed.");
33: }
34: newChannel.close();
35: } finally {
36: NettyClient.this.channel = null;
37: NettyChannel.removeChannelIfDisconnected(newChannel);
38: }
39: // è®¾ç½®æ–°è¿æ¥
40: } else {
41: NettyClient.this.channel = newChannel;
42: }
43: }
44: // å‘ç”Ÿå¼‚å¸¸ï¼ŒæŠ›å‡º RemotingException å¼‚å¸¸
45: } else if (future.cause() != null) {
46: throw new RemotingException(this, "client(url: " + getUrl() + ") failed to connect to server "
47: + getRemoteAddress() + ", error message is:" + future.cause().getMessage(), future.cause());
48: // æ— ç»“æœï¼ˆè¿æ¥è¶…æ—¶ï¼‰ï¼ŒæŠ›å‡º RemotingException å¼‚å¸¸
49: } else {
50: throw new RemotingException(this, "client(url: " + getUrl() + ") failed to connect to server "
51: + getRemoteAddress() + " client-side timeout "
52: + getConnectTimeout() + "ms (elapsed: " + (System.currentTimeMillis() - start) + "ms) from netty client "
53: + NetUtils.getLocalHost() + " using dubbo version " + Version.getVersion());
54: }
55: } finally {
56: if (!isConnected()) {
57: //future.cancel(true);
58: }
59: }
60: }
```

- ç¬¬ 6 è¡Œï¼šè°ƒç”¨

Bootstrap/#connect(remoteAddress)
æ–¹æ³•ï¼Œè¿æ¥æœåŠ¡å™¨ã€‚

- ç¬¬ 9 è¡Œï¼šè°ƒç”¨

ChannelFuture/#awaitUninterruptibly(3000, TimeUnit)
æ–¹æ³•ï¼Œç­‰å¾…è¿æ¥æˆåŠŸæˆ–è¶…æ—¶ã€‚è¿™é‡Œä¼ å…¥

3000
è²Œä¼¼ä¸å¤ªæ­£ç¡®ï¼Œåº”è¯¥ä¼ å…¥

ChannelOption.CONNECT_TIMEOUT_MILLIS
çš„å®é™…å€¼ã€‚

- ç¬¬ 10 è‡³ 43 è¡Œï¼šè¿æ¥æˆåŠŸã€‚

- ç¬¬ 14 è‡³ 26 è¡Œï¼šè‹¥å­˜åœ¨**è€çš„**è¿æ¥ï¼Œè°ƒç”¨

Channel/#close()
æ–¹æ³•ï¼Œè¿›è¡Œå…³é—­ã€‚

- ç¬¬ 29 è‡³ 38 è¡Œï¼šè‹¥ NettyClient è¢«å…³é—­ï¼Œè°ƒç”¨

Channel/#close()
æ–¹æ³•ï¼Œå…³é—­**æ–°çš„è¿æ¥**ã€‚

- ç¬¬ 39 è‡³ 42 è¡Œï¼šè®¾ç½®**æ–°çš„è¿æ¥**åˆ°

channel
ã€‚

- ç¬¬ 44 è‡³ 47 è¡Œï¼šå‘ç”Ÿå¼‚å¸¸ï¼ŒæŠ›å‡º **Server** RemotingException å¼‚å¸¸ã€‚
- ç¬¬ 48 è‡³ 54 è¡Œï¼šæ— ç»“æœï¼ˆè¿æ¥è¶…æ—¶ï¼‰ï¼ŒæŠ›å‡º **Client** RemotingException å¼‚å¸¸ã€‚
- ç¬¬ 55 è‡³ 59 è¡Œï¼š// ã€TODO 8028ã€‘ä¸ºä»€ä¹ˆä¸å–æ¶ˆ future TODO å¯èƒ½ï¼Œå’Œ 3000 æœ‰å…³ç³»ã€‚< 3000 å¼ºåˆ¶ 3000 ã€‚ä»¥åŠç­‰å¾… 3000

**æ–­å¼€è¿æ¥**

```
@Override
protected void doDisConnect(){
try {
NettyChannel.removeChannelIfDisconnected(channel);
} catch (Throwable t) {
logger.warn(t.getMessage());
}
}
```

**å…³é—­è¿æ¥**

```
@Override
protected void doClose() throws Throwable{
//can't shutdown nioEventLoopGroup
//nioEventLoopGroup.shutdownGracefully();
}
```

## 5.2 NettyClientHandler

[
com.alibaba.dubbo.remoting.transport.netty4.NettyClientHandler
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyClientHandler.java) ï¼Œå®ç°

io.netty.channel.ChannelDuplexHandler
ç±»ï¼ŒNettyClient çš„å¤„ç†å™¨ã€‚
NettyServerHandler å’Œ HeaderExchangeHandler ç±»ä¼¼ã€‚

**æ„é€ æ–¹æ³•**

```
@io.netty.channel.ChannelHandler.Sharable
public class NettyClientHandler extends ChannelDuplexHandler{
//*/*
/* Dubbo URL
/*/
private final URL url;
//*/*
/* Dubbo ChannelHandler
/*/
private final ChannelHandler handler;
public NettyClientHandler(URL url, ChannelHandler handler){
if (url == null) {
throw new IllegalArgumentException("url == null");
}
if (handler == null) {
throw new IllegalArgumentException("handler == null");
}
this.url = url;
this.handler = handler;
}
// ... çœç•¥å®ç°æ–¹æ³•
}
```

**å®ç°æ–¹æ³•**

NettyClientHandler çš„**å¤„ç†æ–¹å¼**ï¼Œå’Œ NettyServerHandler å¤§ä½“ä¸€è‡´ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨**ä¸€å®šçš„å·®å¼‚**ï¼Œä»¥

/#channelActive(ChannelHandlerContext)
æ–¹æ³•ä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
@Override
public void channelActive(ChannelHandlerContext ctx){
ctx.fireChannelActive();
}
```

- ä¸åŒäº NettyServerHandler çš„è¯¥æ–¹æ³•ï¼Œä¼šæäº¤ç»™

handler
ç»§ç»­å¤„ç†ã€‚å› ä¸ºï¼Œå®¢æˆ·ç«¯ä¸ä¼šè¢«è¿æ¥ï¼Œæ— éœ€åšè¿å…¥ Channel çš„ç®¡ç†ã€‚

ğŸ™‚ å…¶ä»–æ–¹æ³•ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚

# 6. NettyBackedChannelBuffer

[
com.alibaba.dubbo.remoting.transport.netty4.NettyBackedChannelBuffer
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyBackedChannelBuffer.java) ï¼Œå®ç° ChannelBuffer æ¥å£ï¼ŒåŸºäº **Netty ByteBuf** çš„ ChannelBuffer å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**

```
private ByteBuf buffer;
public NettyBackedChannelBuffer(ByteBuf buffer){
Assert.notNull(buffer, "buffer == null");
this.buffer = buffer;
}
```

- [ã€ŠByteBuf - å­—èŠ‚æ•°æ®çš„å®¹å™¨ã€‹](https://waylau.gitbooks.io/essential-netty-in-action/CORE%20FUNCTIONS/ByteBuf%20-%20The%20byte%20data%20container.html)

**å·¥å‚**

```
@Override
//has nothing use
public ChannelBufferFactory factory(){
return null;
}
```

- æ— ä½¿ç”¨å·¥å‚çš„åœ°æ–¹ã€‚
- å¦å¤–ï¼ŒByteBuf é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¹é‡ä¸º Integer.MAX_VALUE ã€‚

**å®ç°æ–¹æ³•**

æ¯ä¸ªæ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ ByteBuf å¯¹åº”çš„æ–¹æ³•ã€‚ğŸ™‚ ChannelBuffer æ˜¯ä»¥ ByteBuf ä¸º**åŸå‹**ï¼Œè®¾è®¡çš„æ¥å£ API ã€‚

# 7. NettyCodecAdapter

[
com.alibaba.dubbo.remoting.transport.netty4.NettyCodecAdapter
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyCodecAdapter.java) ï¼ŒNetty ç¼–è§£ç **é€‚é…å™¨**ï¼Œå°† **Dubbo ç¼–è§£ç å™¨** é€‚é…æˆ Netty4 çš„ç¼–ç å™¨å’Œè§£ç å™¨ã€‚

**æ„é€ æ–¹æ³•**

```
//*/*
/* Netty ç¼–ç å™¨
/*/
private final ChannelHandler encoder = new InternalEncoder();
//*/*
/* Netty è§£ç å™¨
/*/
private final ChannelHandler decoder = new InternalDecoder();
//*/*
/* Dubbo ç¼–è§£ç å™¨
/*/
private final Codec2 codec;
//*/*
/* Dubbo URL
/*/
private final URL url;
//*/*
/* Dubbo ChannelHandler
/*/
private final com.alibaba.dubbo.remoting.ChannelHandler handler;
public NettyCodecAdapter(Codec2 codec, URL url, com.alibaba.dubbo.remoting.ChannelHandler handler){
this.codec = codec;
this.url = url;
this.handler = handler;
}
```

## 7.1 InternalEncoder

```
private class InternalEncoder extends MessageToByteEncoder{
@Override
protected void encode(ChannelHandlerContext ctx, Object msg, ByteBuf out) throws Exception{
// åˆ›å»º NettyBackedChannelBuffer å¯¹è±¡
com.alibaba.dubbo.remoting.buffer.ChannelBuffer buffer = new NettyBackedChannelBuffer(out);
// è·å¾— NettyChannel å¯¹è±¡
Channel ch = ctx.channel();
NettyChannel channel = NettyChannel.getOrAddChannel(ch, url, handler);
try {
// ç¼–ç 
codec.encode(channel, buffer, msg);
} finally {
// ç§»é™¤ NettyChannel å¯¹è±¡ï¼Œè‹¥æ–­å¼€è¿æ¥
NettyChannel.removeChannelIfDisconnected(ch);
}
}
}
```

- io.netty.handler.codec.MessageToByteEncoder
  ï¼ŒNetty4 ç¼–ç å™¨**æŠ½è±¡ç±»**ã€‚
- ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚

## 7.2 InternalDecoder

```
private class InternalDecoder extends ByteToMessageDecoder{
@Override
protected void decode(ChannelHandlerContext ctx, ByteBuf input, List<Object> out) throws Exception{
// åˆ›å»º NettyBackedChannelBuffer å¯¹è±¡
ChannelBuffer message = new NettyBackedChannelBuffer(input);
// è·å¾— NettyChannel å¯¹è±¡
NettyChannel channel = NettyChannel.getOrAddChannel(ctx.channel(), url, handler);
// å¾ªç¯è§£æï¼Œç›´åˆ°ç»“æŸ
Object msg;
int saveReaderIndex;
try {
// decode object.
do {
// è®°å½•å½“å‰è¯»è¿›åº¦
saveReaderIndex = message.readerIndex();
// è§£ç 
try {
msg = codec.decode(channel, message);
} catch (IOException e) {
throw e;
}
// éœ€è¦æ›´å¤šè¾“å…¥ï¼Œå³æ¶ˆæ¯ä¸å®Œæ•´ï¼Œæ ‡è®°å›åŸæœ‰è¯»è¿›åº¦ï¼Œå¹¶ç»“æŸ
if (msg == Codec2.DecodeResult.NEED_MORE_INPUT) {
message.readerIndex(saveReaderIndex);
break;
// è§£ç åˆ°æ¶ˆæ¯ï¼Œæ·»åŠ åˆ° `out`
} else {
//is it possible to go here ? èŠ‹è‰¿ï¼šä¸å¯èƒ½ï¼Œå“ˆå“ˆå“ˆ
if (saveReaderIndex == message.readerIndex()) {
throw new IOException("Decode without read data.");
}
if (msg != null) {
out.add(msg);
}
}
} while (message.readable());
} finally {
// ç§»é™¤ NettyChannel å¯¹è±¡ï¼Œè‹¥æ–­å¼€è¿æ¥
NettyChannel.removeChannelIfDisconnected(ctx.channel());
}
}
}
```

- io.netty.handler.codec.ByteToMessageDecoder
  ï¼ŒNetty4 è§£ç å™¨**æŠ½è±¡ç±»**ã€‚
- ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚

# 8. æ—¥å¿—å·¥å‚

åœ¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” æ—¥å¿—é€‚é…ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/logger-strategy.html) æ–‡æ¡£ï¼Œæåˆ°ï¼š
è‡ª

2.2.1
å¼€å§‹ï¼Œdubbo å¼€å§‹å†…ç½® log4jã€slf4jã€jclã€jdk è¿™äº›æ—¥å¿—æ¡†æ¶çš„é€‚é…ã€‚

åœ¨ [ã€ŠNetty æºç ç¬”è®° â€”â€” Netty æ—¥å¿—å¤„ç†ã€‹](https://www.kancloud.cn/ssj234/netty-source/433218) æ–‡æ¡£ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Netty æ”¯æŒå®ç°è‡ªå®šä¹‰çš„**æ—¥å¿—å·¥å‚**ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ¥å…¥ Dubbo çš„**æ—¥å¿—é€‚é…**ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“çš„ä»£ç å®ç°ã€‚

è°ƒç”¨

NettyHelper/#setNettyLoggerFactory()
æ–¹æ³•ï¼Œè®¾ç½®æ—¥å¿—å·¥å‚ï¼ŒåŸºäº Dubbo Logger ç»„ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public static void setNettyLoggerFactory(){
InternalLoggerFactory factory = InternalLoggerFactory.getDefaultFactory();
if (factory == null || !(factory instanceof DubboLoggerFactory)) {
InternalLoggerFactory.setDefaultFactory(new DubboLoggerFactory());
}
}
```

- è®¾ç½® Netty æ—¥å¿—å·¥å‚ä¸º DubboLoggerFactory ã€‚

[DubboLoggerFactory](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/logging/NettyHelper.java#L27-L32) ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
static class DubboLoggerFactory extends InternalLoggerFactory{
@Override
public InternalLogger newInstance(String name){
return new DubboLogger(LoggerFactory.getLogger(name));
}
}
```

- åˆ›å»º DubboLogger å¯¹è±¡ï¼Œå¹¶ä¼ å…¥

name
å¯¹åº”çš„ Dubbo [Logger](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/logger/Logger.java) å¯¹è±¡ï¼Œè€Œ Dubbo Logger çš„å¯¹è±¡ï¼ŒåŸºäº Dubbo SPI æœºåˆ¶åŠ è½½ã€‚

[DubboLogger](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/logging/NettyHelper.java#L42-L236) ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
static class DubboLogger extends AbstractInternalLogger{
//*/*
/* æ—¥å¿—ç»„ä»¶
/*/
private com.alibaba.dubbo.common.logger.Logger logger;
DubboLogger(Logger logger) {
super(logger.getClass().getName());
this.logger = logger;
}
@Override
public void info(String msg){
if (isInfoEnabled()) {
logger.info(msg);
}
}
// ... çœç•¥ç±»ä¼¼ä»£ç 
}
```

- åœ¨å®ç°çš„æ¯ä¸ªæ–¹æ³•ä¸­ï¼Œç›´æ¥è°ƒç”¨

logger
å¯¹åº”çš„æ–¹æ³•ã€‚

- åœ¨ç±»ä¼¼

/#info(String format, Object... arguments)
æ–¹æ³•ä¸­ï¼Œéœ€è¦å¯¹æ—¥å¿—å†…å®¹è¿›è¡Œæ ¼å¼åŒ–ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
@Override
public void info(String format, Object... arguments){
if (isInfoEnabled()) {
FormattingTuple ft = MessageFormatter.arrayFormat(format, arguments);
logger.info(ft.getMessage(), ft.getThrowable());
}
}
```

- æˆ‘ä»¬çœ‹åˆ°éœ€è¦ [FormattingTuple](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/logging/MessageFormatter.java) å’Œ [MessageFormatter](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/logging/MessageFormatter.java) è¿™ä¸¤ä¸ªç±»ï¼Œç”¨äºæ ¼å¼åŒ–ã€‚å®é™…ä¸Šï¼Œè¿™ä¸¤ä¸ªç±»æ˜¯ç›´æ¥ä» Netty4 ä¸­æ‹·è´å‡ºæ¥çš„ä¸¤ä¸ªç±»ï¼Œå› ä¸ºå®ƒä»¬æ˜¯

package
ä¿®é¥°çš„ç±»ï¼Œåœ¨ DubboLogger ä¸­ï¼Œæ— æ³•è®¿é—®åˆ°å®ƒä»¬ï¼Œæ‰€ä»¥è¿›è¡Œå¤åˆ¶è§£å†³ã€‚
