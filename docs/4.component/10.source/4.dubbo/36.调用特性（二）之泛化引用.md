# è°ƒç”¨ç‰¹æ€§ï¼ˆäºŒï¼‰ä¹‹æ³›åŒ–å¼•ç”¨

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«**æ³›åŒ–å¼•ç”¨**ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹ [ã€Šç”¨æˆ·æŒ‡å— â€”â€” æ³›åŒ–å¼•ç”¨ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/generic-reference.html) çš„å®šä¹‰ï¼š
æ³›åŒ–æ¥å£è°ƒç”¨æ–¹å¼ä¸»è¦ç”¨äºå®¢æˆ·ç«¯æ²¡æœ‰ API æ¥å£åŠæ¨¡å‹ç±»å…ƒçš„æƒ…å†µï¼Œå‚æ•°åŠè¿”å›å€¼ä¸­çš„æ‰€æœ‰ POJO å‡ç”¨ Map è¡¨ç¤ºï¼Œé€šå¸¸ç”¨äºæ¡†æ¶é›†æˆï¼Œæ¯”å¦‚ï¼šå®ç°ä¸€ä¸ªé€šç”¨çš„æœåŠ¡æµ‹è¯•æ¡†æ¶ï¼Œå¯é€šè¿‡ GenericService è°ƒç”¨æ‰€æœ‰æœåŠ¡å®ç°ã€‚

è¯·æ³¨æ„ï¼Œæ¶ˆè´¹**æ¶ˆè´¹è€…**æ²¡æœ‰ **API æ¥å£** åŠ **æ¨¡å‹ç±»å…ƒ**ã€‚é‚£å°±æ˜¯è¯´ï¼ŒDubbo åœ¨æ³›åŒ–å¼•ç”¨ä¸­ï¼Œéœ€è¦åšä¸¤ä»¶äº‹æƒ…ï¼š

- æ²¡æœ‰ **API æ¥å£**ï¼Œæ‰€ä»¥æä¾›ä¸€ä¸ªæ³›åŒ–æœåŠ¡æ¥å£ï¼Œç›®å‰æ˜¯ [
  com.alibaba.dubbo.rpc.service.GenericService
  ](https://github.com/YunaiV/dubbo/blob/f83e70b53389a064e49babe32e61a5648002a44a/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/service/GenericService.java) ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
public interface GenericService{
//*/*
/* Generic invocation
/*
/* æ³›åŒ–è°ƒç”¨
/*
/* @param method Method name, e.g. findPerson. If there are overridden methods, parameter info is
/* required, e.g. findPerson(java.lang.String)
/* æ–¹æ³•å
/* @param parameterTypes Parameter types
/* å‚æ•°ç±»å‹æ•°ç»„
/* @param args Arguments
/* å‚æ•°æ•°ç»„
/* @return invocation return value è°ƒç”¨ç»“æœ
/* @throws Throwable potential exception thrown from the invocation
/*/
Object $invoke(String method, String[] parameterTypes, Object[] args) throws GenericException;
}
```

- **ä¸€ä¸ª**æ³›åŒ–å¼•ç”¨ï¼Œåªå¯¹åº”**ä¸€ä¸ª**æœåŠ¡å®ç°ã€‚
- é€šè¿‡

$invoke(method, parameterTypes, args)
æ–¹æ³•ï¼Œå¯ä»¥å®ç°æœåŠ¡çš„æ³›åŒ–è°ƒç”¨ã€‚

- å…·ä½“çš„ä½¿ç”¨æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨ [ã€Œ2. ç¤ºä¾‹ã€](http://svip.iocoder.cn/Dubbo/rpc-feature-generic-reference/) ä¸­çœ‹ã€‚
- æ²¡æœ‰ **æ¨¡å‹ç±»å…ƒ**ï¼Œæ‰€ä»¥æ–¹æ³•å‚æ•°å’Œæ–¹æ³•è¿”å›è‹¥æ˜¯ POJO ( ä¾‹å¦‚ User å’Œ Order ç­‰ ) ï¼Œéœ€è¦**è½¬æ¢å¤„ç†**ï¼š

- æœåŠ¡æ¶ˆè´¹è€…ï¼Œå°† POJO è½¬æˆ Map ï¼Œç„¶åå†è°ƒç”¨æœåŠ¡æä¾›è€…ã€‚
- æœåŠ¡æä¾›è€…ï¼Œæ¥æ”¶åˆ° Map ï¼Œè½¬æ¢æˆ POJO ï¼Œå†è°ƒç”¨ Service æ–¹æ³•ã€‚è‹¥è¿”å›å€¼æœ‰ POJO ï¼Œåˆ™è½¬æ¢æˆ Map å†è¿”å›ã€‚
- ğŸ™‚ æ­¤å¤„çš„ Map åªæ˜¯ä¸¾ä¾‹å­ï¼Œå®é™…åœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è¿˜æœ‰**ä¸¤ç§**è½¬æ¢æ–¹å¼ã€‚

æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š

![æµç¨‹](http://static2.iocoder.cn/images/Dubbo/2018_11_06/01.png)

# 2. ç¤ºä¾‹

**æœåŠ¡æä¾›è€…**

åœ¨ [
dubbo-generic-reference-demo-provider
](https://github.com/YunaiV/dubbo/blob/3766a47c5e97ee86c29d765dc88ee11ab5225604/dubbo-demo/dubbo-generic-reference-demo-provider) ï¼Œæˆ‘ä»¬æä¾›äº†ä¾‹å­ã€‚æ™®é€šçš„æœåŠ¡æä¾›è€…ï¼Œä¸éœ€è¦åšä»»ä½•å¤„ç†ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚

**æœåŠ¡æ¶ˆè´¹è€…**

åœ¨ [
dubbo-generic-reference-demo-consumer
](https://github.com/YunaiV/dubbo/tree/3766a47c5e97ee86c29d765dc88ee11ab5225604/dubbo-demo/dubbo-generic-reference-demo-consumer) ï¼Œæˆ‘ä»¬æä¾›äº†ä¾‹å­ã€‚æˆ‘ä»¬æŒ‘**é‡ç‚¹**çš„åœ°æ–¹è¯´ã€‚

â‘  åœ¨ Spring é…ç½®ç”³æ˜

generic="true"
ï¼š

```
<dubbo:reference id="demoService" interface="com.alibaba.dubbo.demo.DemoService" generic="true" />
```

- interface
  é…ç½®é¡¹ï¼Œæ³›åŒ–å¼•ç”¨çš„æœåŠ¡æ¥å£ã€‚é€šè¿‡è¯¥é…ç½®ï¼Œå¯ä»¥ä»æ³¨å†Œä¸­å¿ƒï¼Œè·å–åˆ°æ‰€æœ‰**è¯¥æœåŠ¡**çš„æä¾›æ–¹çš„åœ°å€ã€‚
- generic
  é…ç½®é¡¹ï¼Œé»˜è®¤ä¸º

false
ï¼Œä¸ä½¿ç”¨é…ç½®é¡¹ã€‚ç›®å‰æœ‰**ä¸‰ç§é…ç½®é¡¹çš„å€¼**ï¼Œå¼€å¯æ³›åŒ–å¼•ç”¨çš„åŠŸèƒ½ï¼š

- generic=true
  ï¼Œä½¿ç”¨ [
  com.alibaba.dubbo.common.utils.PojoUtils
  ](https://github.com/YunaiV/dubbo/blob/f83e70b53389a064e49babe32e61a5648002a44a/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/PojoUtils.java) ï¼Œå®ç°

POJO <=> Map
çš„äº’è½¬ã€‚

- generic=nativejava
  ï¼Œä½¿ç”¨ [
  com.alibaba.dubbo.common.serialize.support.nativejava.NativeJavaSerialization
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/nativejava/NativeJavaSerialization.java) ï¼Œå®ç°

POJO <=> byte[]
çš„äº’è½¬ã€‚

- generic=bean
  ï¼Œä½¿ç”¨ [
  com.alibaba.dubbo.common.beanutil.JavaBeanSerializeUtil
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/beanutil/JavaBeanSerializeUtil.java) ï¼Œå®ç°

POJO <=> JavaBeanDescriptor
çš„äº’è½¬ã€‚

- æ€»çš„æ¥è¯´ï¼Œä¸‰ç§æ–¹å¼çš„å·®å¼‚ï¼Œåœ¨äºä½¿ç”¨äº’è½¬( **åºåˆ—åŒ–å’Œååºåˆ—åŒ–** )çš„æ–¹å¼ä¸åŒã€‚æœªæ¥å¦‚æœæˆ‘ä»¬æœ‰éœ€è¦ï¼Œå®Œæˆå¯ä»¥å®ç°

generic=json
ï¼Œä½¿ç”¨ FastJSON æ¥åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚

â‘¡ åœ¨ Java ä»£ç è·å– barService å¹¶å¼€å§‹æ³›åŒ–è°ƒç”¨ï¼š

```
ClassPathXmlApplicationContext context = new ClassPathXmlApplicationContext(new String[]{"META-INF/spring/dubbo-demo-consumer.xml"});
GenericService genericService = (GenericService) context.getBean("demoService");
Object result = genericService.$invoke("say01", new String[]{"java.lang.String"}, new Object[]{"123"});
System.out.println("result: " + result);
```

- é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œä¸ºä»€ä¹ˆå¯ä»¥ä½¿ç”¨ GenericService è½¬æ¢ï¼Ÿç­”æ¡ˆåœ¨

ReferenceConfig/#init()
æ–¹æ³•ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
// ReferenceConfig.java
if (ProtocolUtils.isGeneric(getGeneric())) {
interfaceClass = GenericService.class;
}
// ProtocolUtils.java
public static boolean isGeneric(String generic){
return generic != null
&& !"".equals(generic)
&& (Constants.GENERIC_SERIALIZATION_DEFAULT.equalsIgnoreCase(generic) //* Normal generalization cal /*/
|| Constants.GENERIC_SERIALIZATION_NATIVE_JAVA.equalsIgnoreCase(generic) //* Streaming generalization call supporting jdk serialization /*/
|| Constants.GENERIC_SERIALIZATION_BEAN.equalsIgnoreCase(generic));
}
```

## 2.1 æœ‰å…³æ³›åŒ–ç±»å‹çš„è¿›ä¸€æ­¥è§£é‡Š

æœ¬å°èŠ‚ä¸ºå¼•ç”¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” æ³›åŒ–å¼•ç”¨ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/generic-reference.html) ã€‚

å‡è®¾å­˜åœ¨ POJO å¦‚ï¼š

```
package com.xxx;
public class PersonImpl implements Person{
private String name;
private String password;
public String getName(){
return name;
}
public void setName(String name){
this.name = name;
}
public String getPassword(){
return password;
}
public void setPassword(String password){
this.password = password;
}
}
```

åˆ™ POJO æ•°æ®ï¼š

```
Person person = new PersonImpl();
person.setName("xxx");
person.setPassword("yyy");
```

ã€æœåŠ¡æ¶ˆè´¹è€…ã€‘å¯ç”¨ä¸‹é¢ Map è¡¨ç¤ºï¼š

```
Map<String, Object> map = new HashMap<String, Object>();
// æ³¨æ„ï¼šå¦‚æœå‚æ•°ç±»å‹æ˜¯æ¥å£ï¼Œæˆ–è€…Listç­‰ä¸¢å¤±æ³›å‹ï¼Œå¯é€šè¿‡classå±æ€§æŒ‡å®šç±»å‹ã€‚
map.put("class", "com.xxx.PersonImpl");
map.put("name", "xxx");
map.put("password", "yyy");
```

- Map ä¸­çš„

class
å±æ€§ï¼Œåœ¨ PojoUtils ä¸­ï¼Œä¼šæ ¹æ®è¯¥å±æ€§ï¼Œå°† Map è½¬æ¢æˆ POJO å¯¹è±¡ã€‚

# 3. æœåŠ¡æ¶ˆè´¹è€… GenericImplFilter

[
com.alibaba.dubbo.rpc.filter.GenericImplFilter
](https://github.com/YunaiV/dubbo/blob/3766a47c5e97ee86c29d765dc88ee11ab5225604/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/filter/GenericImplFilter.java) ï¼Œå®ç° Filter æ¥å£ï¼ŒæœåŠ¡æ¶ˆè´¹è€…çš„æ³›åŒ–è°ƒç”¨è¿‡æ»¤å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: @Activate(group = Constants.CONSUMER, value = Constants.GENERIC_KEY, order = 20000)
2: public class GenericImplFilter implements Filter{
3:
4: // ... çœç•¥æ— å…³å±æ€§
5:
6: @Override
7: public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException{
8: // è·å¾— `generic` é…ç½®é¡¹
9: String generic = invoker.getUrl().getParameter(Constants.GENERIC_KEY);
10:
11: // çœç•¥ä»£ç ...æ³›åŒ–å®ç°çš„è°ƒç”¨
12:
13: // æ³›åŒ–å¼•ç”¨çš„è°ƒç”¨
14: if (invocation.getMethodName().equals(Constants.$INVOKE) // æ–¹æ³•åä¸º `$invoke`
15: && invocation.getArguments() != null
16: && invocation.getArguments().length == 3
17: && ProtocolUtils.isGeneric(generic)) {
18: Object[] args = (Object[]) invocation.getArguments()[2];
19: // `nativejava` ï¼Œæ ¡éªŒæ–¹æ³•å‚æ•°éƒ½ä¸º byte[]
20: if (ProtocolUtils.isJavaGenericSerialization(generic)) {
21: for (Object arg : args) {
22: if (!(byte[].class == arg.getClass())) {
23: error(byte[].class.getName(), arg.getClass().getName());
24: }
25: }
26: // `bean` ï¼Œæ ¡éªŒæ–¹æ³•å‚æ•°ä¸º JavaBeanDescriptor
27: } else if (ProtocolUtils.isBeanGenericSerialization(generic)) {
28: for (Object arg : args) {
29: if (!(arg instanceof JavaBeanDescriptor)) {
30: error(JavaBeanDescriptor.class.getName(), arg.getClass().getName());
31: }
32: }
33: }
34:
35: // é€šè¿‡éšå¼å‚æ•°ï¼Œä¼ é€’ `generic` é…ç½®é¡¹
36: ((RpcInvocation) invocation).setAttachment(Constants.GENERIC_KEY, generic);
37: }
38: return invoker.invoke(invocation);
39: }
40:
41: // çœç•¥ `/#error(...)` æ–¹æ³•
42:
43: }
```

- ä½¿ç”¨ Dubbo SPI Adaptive æœºåˆ¶ï¼Œ**è‡ªåŠ¨åŠ è½½**ï¼Œä»…é™**æœåŠ¡æ¶ˆè´¹è€…**ï¼Œå¹¶ä¸”æœ‰

generic
é…ç½®é¡¹ã€‚

- æ­¤å¤„ç¬”è€…å°±äº§ç”Ÿäº†ä¸€ä¸ªç–‘é—®ï¼Œä»æ³¨å†Œä¸­å¿ƒï¼Œè·å¾—åˆ°çš„æœåŠ¡ URL ï¼Œå¹¶æ²¡æœ‰è®¾ç½®

generic
çš„é…ç½®é¡¹ï¼Œé‚£å²‚ä¸æ˜¯åœ¨ ProtocolFilterWrapper ä¸­ï¼Œä½¿ç”¨ Dubbo SPI Adaptive åŠ è½½ä¸åˆ° GenericImplFilter è¿™ä¸ªè¿‡æ»¤å™¨ï¼Ÿ

- äºæ˜¯ï¼Œç¬”è€…å°±å¼€å§‹æ…¢æ…¢è°ƒè¯•ï¼Œç›´åˆ°å‘ç°

RegistryDirectory/#mergeUrl(providerUrl)
æ–¹æ³•ï¼Œå®ƒä¼šå°†æœåŠ¡æ¶ˆè´¹è€…çš„é…ç½®( URL )é¡¹ï¼Œ**è¦†ç›–**åˆ°æœåŠ¡æä¾›è€…çš„ URL ã€‚

- åˆå› ä¸ºæ³›åŒ–å¼•ç”¨æ—¶ï¼Œæˆ‘ä»¬ä¼šåœ¨æœåŠ¡æ¶ˆè´¹è€…çš„é…ç½®

generic = true
ï¼Œé‚£ä¹ˆæœåŠ¡æä¾›è€… URL è‡ªç„¶å°±æœ‰äº†è¯¥é…ç½®é¡¹ï¼Œæ‰€ä»¥ä¾¿æœ‰äº† GenericImplFilter è¿‡æ»¤å™¨ã€‚

- ç¬¬ 9 è¡Œï¼šè·å¾—

generic
é…ç½®é¡¹ã€‚

- ç¬¬ 11 è¡Œï¼šçœç•¥ç”¨äºè°ƒç”¨**æ³›åŒ–å®ç°æœåŠ¡**çš„ä»£ç ï¼Œå¯¹åº”æ–‡æ¡£ä¸º [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” æ³›åŒ–å®ç°ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/generic-service.html) ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬è¯¦ç»†åˆ†äº«ã€‚
- ç¬¬ 13 è‡³ 37 è¡Œï¼š**æ³›åŒ–å¼•ç”¨**çš„è°ƒç”¨ï¼Œé€šè¿‡æ–¹æ³•( åŒ…æ‹¬æ–¹æ³•åã€å‚æ•° ) +

generic
é…ç½®é¡¹ï¼Œè¿›è¡Œåˆ¤æ–­ã€‚

- ç¬¬ 19 è‡³ 33 è¡Œï¼šæ ¹æ®ä¸åŒçš„

generic
é…ç½®é¡¹ï¼Œæ ¡éªŒæ–¹æ³•å‚æ•°æ˜¯å¦å·²ç»æ­£ç¡®**åºåˆ—åŒ–**ã€‚è‹¥ä¸åˆæ³•ï¼Œè°ƒç”¨

/#error(expected, actual)
æ–¹æ³•ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
private void error(String expected, String actual) throws RpcException{
throw new RpcException(
new StringBuilder(32)
.append("Generic serialization [")
.append(Constants.GENERIC_SERIALIZATION_NATIVE_JAVA)
.append("] only support message type ")
.append(expected)
.append(" and your message type is ")
.append(actual).toString());
}
```

- x
- ç¬¬ 36 è¡Œï¼šè°ƒç”¨

RpcInvocation/#setAttachment(key, value)
é€šè¿‡éšå¼å‚æ•°ï¼Œä¼ é€’

generic
é…ç½®é¡¹ã€‚

- ç¬¬ 38 è¡Œï¼šè°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼Œç»§ç»­è¿‡æ»¤é“¾çš„è°ƒç”¨ï¼Œæœ€ç»ˆ RPC è°ƒç”¨ã€‚

# 4. æœåŠ¡æä¾›è€… GenericFilter

[
com.alibaba.dubbo.rpc.filter.GenericFilter
](https://github.com/YunaiV/dubbo/blob/3766a47c5e97ee86c29d765dc88ee11ab5225604/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/filter/GenericFilter.java) ï¼Œå®ç° Filter æ¥å£ï¼ŒæœåŠ¡æ¶ˆè´¹è€…çš„æ³›åŒ–è°ƒç”¨è¿‡æ»¤å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: @Activate(group = Constants.PROVIDER, order = -20000)
2: public class GenericFilter implements Filter{
3:
4: @Override
5: public Result invoke(Invoker<?> invoker, Invocation inv) throws RpcException{
6: // æ³›åŒ–å¼•ç”¨çš„è°ƒç”¨
7: if (inv.getMethodName().equals(Constants.$INVOKE)
8: && inv.getArguments() != null
9: && inv.getArguments().length == 3
10: && !ProtocolUtils.isGeneric(invoker.getUrl().getParameter(Constants.GENERIC_KEY))) { // éæ³›åŒ–å®ç°çš„è°ƒç”¨
11: String name = ((String) inv.getArguments()[0]).trim();
12: String[] types = (String[]) inv.getArguments()[1];
13: Object[] args = (Object[]) inv.getArguments()[2];
14: try {
15: // è·å¾—å¯¹åº”çš„æ–¹æ³• Method å¯¹è±¡
16: Method method = ReflectUtils.findMethodByMethodSignature(invoker.getInterface(), name, types);
17: // è·å¾—æ–¹æ³•å‚æ•°ç±»å‹å’Œæ–¹æ³•å‚æ•°æ•°ç»„
18: Class<?>[] params = method.getParameterTypes();
19: if (args == null) {
20: args = new Object[params.length];
21: }
22: // è·å¾— `generic` é…ç½®é¡¹
23: String generic = inv.getAttachment(Constants.GENERIC_KEY);
24: // ã€ç¬¬ä¸€æ­¥ã€‘`true` ï¼Œååºåˆ—åŒ–å‚æ•°ï¼Œä»…æœ‰ Map => POJO
25: if (StringUtils.isEmpty(generic) || ProtocolUtils.isDefaultGenericSerialization(generic)) {
26: args = PojoUtils.realize(args, params, method.getGenericParameterTypes());
27: // ã€ç¬¬ä¸€æ­¥ã€‘`nativejava` ï¼Œååºåˆ—åŒ–å‚æ•°ï¼Œbyte[] => æ–¹æ³•å‚æ•°
28: } else if (ProtocolUtils.isJavaGenericSerialization(generic)) {
29: for (int i = 0; i < args.length; i++) {
30: if (byte[].class == args[i].getClass()) {
31: try {
32: UnsafeByteArrayInputStream is = new UnsafeByteArrayInputStream((byte[]) args[i]);
33: args[i] = ExtensionLoader.getExtensionLoader(Serialization.class).getExtension(Constants.GENERIC_SERIALIZATION_NATIVE_JAVA)
34: .deserialize(null, is).readObject();
35: } catch (Exception e) {
36: throw new RpcException("Deserialize argument [" + (i + 1) + "] failed.", e);
37: }
38: } else {
39: throw new RpcException(
40: new StringBuilder(32).append("Generic serialization [")
41: .append(Constants.GENERIC_SERIALIZATION_NATIVE_JAVA)
42: .append("] only support message type ")
43: .append(byte[].class)
44: .append(" and your message type is ")
45: .append(args[i].getClass()).toString());
46: }
47: }
48: // ã€ç¬¬ä¸€æ­¥ã€‘`bean` ï¼Œååºåˆ—åŒ–å‚æ•°ï¼ŒJavaBeanDescriptor => æ–¹æ³•å‚æ•°
49: } else if (ProtocolUtils.isBeanGenericSerialization(generic)) {
50: for (int i = 0; i < args.length; i++) {
51: if (args[i] instanceof JavaBeanDescriptor) {
52: args[i] = JavaBeanSerializeUtil.deserialize((JavaBeanDescriptor) args[i]);
53: } else {
54: throw new RpcException(
55: new StringBuilder(32)
56: .append("Generic serialization [")
57: .append(Constants.GENERIC_SERIALIZATION_BEAN)
58: .append("] only support message type ")
59: .append(JavaBeanDescriptor.class.getName())
60: .append(" and your message type is ")
61: .append(args[i].getClass().getName()).toString());
62: }
63: }
64: }
65: // ã€ç¬¬äºŒæ­¥ã€‘æ–¹æ³•è°ƒç”¨
66: Result result = invoker.invoke(new RpcInvocation(method, args, inv.getAttachments()));
67: // ã€ç¬¬ä¸‰æ­¥ã€‘è‹¥æ˜¯å¼‚å¸¸ç»“æœï¼Œå¹¶ä¸”é GenericException å¼‚å¸¸ï¼Œåˆ™ä½¿ç”¨ GenericException åŒ…è£…
68: if (result.hasException()
69: && !(result.getException() instanceof GenericException)) {
70: return new RpcResult(new GenericException(result.getException()));
71: }
72: // ã€ç¬¬ä¸‰æ­¥ã€‘`nativejava` ï¼Œåºåˆ—åŒ–ç»“æœï¼Œç»“æœ => byte[]
73: if (ProtocolUtils.isJavaGenericSerialization(generic)) {
74: try {
75: UnsafeByteArrayOutputStream os = new UnsafeByteArrayOutputStream(512);
76: ExtensionLoader.getExtensionLoader(Serialization.class).getExtension(Constants.GENERIC_SERIALIZATION_NATIVE_JAVA)
77: .serialize(null, os).writeObject(result.getValue());
78: return new RpcResult(os.toByteArray());
79: } catch (IOException e) {
80: throw new RpcException("Serialize result failed.", e);
81: }
82: // ã€ç¬¬ä¸‰æ­¥ã€‘`bean` ï¼Œåºåˆ—åŒ–ç»“æœï¼Œç»“æœ => JavaBeanDescriptor
83: } else if (ProtocolUtils.isBeanGenericSerialization(generic)) {
84: return new RpcResult(JavaBeanSerializeUtil.serialize(result.getValue(), JavaBeanAccessor.METHOD));
85: // ã€ç¬¬ä¸‰æ­¥ã€‘`true` ï¼Œåºåˆ—åŒ–ç»“æœï¼Œä»…æœ‰ POJO => Map
86: } else {
87: return new RpcResult(PojoUtils.generalize(result.getValue()));
88: }
89: } catch (NoSuchMethodException e) {
90: throw new RpcException(e.getMessage(), e);
91: } catch (ClassNotFoundException e) {
92: throw new RpcException(e.getMessage(), e);
93: }
94: }
95: // æ™®é€šè°ƒç”¨
96: return invoker.invoke(inv);
97: }
98:
99: }
```

- ä½¿ç”¨ Dubbo SPI Adaptive æœºåˆ¶ï¼Œ**è‡ªåŠ¨åŠ è½½**ï¼Œä»…é™**æœåŠ¡æä¾›è€…**ã€‚
- ç¬¬ 96 è¡Œï¼šè‹¥æ˜¯æ™®é€šè°ƒç”¨( **éæ³›åŒ–å¼•ç”¨çš„è°ƒç”¨** )ï¼Œè°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼Œç»§ç»­è¿‡æ»¤é“¾çš„è°ƒç”¨ï¼Œæœ€ç»ˆè°ƒç”¨ Service æœåŠ¡ã€‚

- ç¬¬ 6 è‡³ 95 è¡Œï¼š è‹¥æ˜¯**æ³›åŒ–å¼•ç”¨çš„è°ƒç”¨**ï¼Œé€šè¿‡æ–¹æ³•( åŒ…æ‹¬æ–¹æ³•åã€å‚æ•° )åˆ¤æ–­ã€‚**æ³¨æ„**ï¼Œã€ç¬¬ 10 è¡Œã€‘é**æ³›åŒ–å®ç°**çš„è°ƒç”¨ã€‚
- ç¬¬ 16 è¡Œï¼šè°ƒç”¨ [
  ReflectUtils/#findMethodByMethodSignature(Class<?> clazz, String methodName, String[] parameterTypes)
  ](https://github.com/YunaiV/dubbo/blob/f83e70b53389a064e49babe32e61a5648002a44a/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/ReflectUtils.java#L768-L814) æ–¹æ³•ï¼Œé€šè¿‡åå°„ï¼Œè·å¾—å¯¹åº”çš„æ–¹æ³• **Method** å¯¹è±¡ã€‚å…·ä½“çš„ä»£ç å®ç°ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹å“ˆã€‚
- ç¬¬ 17 è‡³ 21 è¡Œï¼šè·å¾—**æ–¹æ³•å‚æ•°ç±»å‹å’Œæ–¹æ³•å‚æ•°**æ•°ç»„ã€‚
- ç¬¬ 23 è¡Œï¼šè·å¾—

generic
é…ç½®é¡¹ã€‚

- ========== ã€ç¬¬ä¸€æ­¥ï¼šååºåˆ—åŒ–å‚æ•°ã€‘ ==========
- ç¬¬ 24 è‡³ 26 è¡Œï¼š

generic = true
ï¼Œè°ƒç”¨ [
PojoUtils/#realize(Object[] objs, Class<?>[] types, Type[] gtypes)
](https://github.com/YunaiV/dubbo/blob/f83e70b53389a064e49babe32e61a5648002a44a/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/PojoUtils.java#L81-L89) æ–¹æ³•ï¼Œååºåˆ—åŒ–å‚æ•°ã€‚**æ³¨æ„**ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œåªæœ‰å¸¦æœ‰

class
å±æ€§çš„ Map ï¼Œéœ€è¦**ååºåˆ—åŒ–**æˆå¯¹åº”çš„ POJO å¯¹è±¡ã€‚

- ç¬¬ 27 è‡³ 47 è¡Œï¼š

generic = nativejava
ï¼Œè°ƒç”¨

NativeJavaSerialization/#deserialize(url, input)
æ–¹æ³•ï¼Œååºåˆ—åŒ–å‚æ•°ï¼Œå³

byte[] => æ–¹æ³•å‚æ•°
ã€‚

- ç¬¬ 48 è‡³ 64 è¡Œï¼š

generic = bean
ï¼Œè°ƒç”¨

JavaBeanSerializeUtil/#deserialize(JavaBeanDescriptor)
æ–¹æ³•ï¼Œååºåˆ—åŒ–å‚æ•°ï¼Œå³

JavaBeanDescriptor => æ–¹æ³•å‚æ•°
ã€‚

- ========== ã€ç¬¬äºŒæ­¥ï¼šæ–¹æ³•è°ƒç”¨ã€‘ ==========
- ç¬¬ 66 è¡Œï¼šåˆ›å»º**æ–°çš„** RpcInvocation å¯¹è±¡ã€‚è¿™æ˜¯**éå¸¸å…³é”®**çš„ä¸€æ­¥ï¼Œ

$invoke
çš„æ³›åŒ–è°ƒç”¨ï¼Œè¢«è½¬æ¢æˆ**å…·ä½“**çš„æ™®é€šè°ƒç”¨ã€‚

- ç¬¬ 66 è¡Œï¼šè°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼Œç»§ç»­è¿‡æ»¤é“¾çš„è°ƒç”¨ï¼Œæœ€ç»ˆè°ƒç”¨ Service æœåŠ¡ã€‚

- ========== ã€ç¬¬ä¸‰æ­¥ï¼šåºåˆ—åŒ–ç»“æœã€‘ ==========
- ç¬¬ 68 è‡³ 71 è¡Œï¼šè‹¥æ˜¯å¼‚å¸¸ç»“æœï¼Œå¹¶ä¸”é GenericException å¼‚å¸¸ï¼Œå¯èƒ½è¿™ä¸ªå¼‚å¸¸åœ¨æœåŠ¡æ¶ˆè´¹ç«¯æ˜¯**æ²¡æœ‰**çš„ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ [GenericException](https://github.com/YunaiV/dubbo/blob/f83e70b53389a064e49babe32e61a5648002a44a/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/service/GenericException.java) **åŒ…è£…åè¿”å›**ã€‚GenericException çš„ä»£ç å¦‚ä¸‹ï¼š

```
public class GenericException extends RuntimeException{
private String exceptionClass;
private String exceptionMessage;
public GenericException(){
}
public GenericException(String exceptionClass, String exceptionMessage){
super(exceptionMessage);
this.exceptionClass = exceptionClass;
this.exceptionMessage = exceptionMessage;
}
public GenericException(Throwable cause){
super(StringUtils.toString(cause));
this.exceptionClass = cause.getClass().getName();
this.exceptionMessage = cause.getMessage();
}
// ... çœç•¥ getting/setting çš„æ–¹æ³•
}
```

- ç¬¬ 72 è‡³ 81 è¡Œï¼š

generic = nativejava
ï¼Œè°ƒç”¨

NativeJavaSerialization/#serialize(url, output)
æ–¹æ³•ï¼Œåºåˆ—åŒ–ç»“æœï¼Œå³

ç»“æœ => byte[]
ã€‚

- ç¬¬ 82 è‡³ 84 è¡Œï¼š

generic = bean
ï¼Œè°ƒç”¨

JavaBeanSerializeUtil/#serialize(Object, JavaBeanAccessor)
æ–¹æ³•ï¼Œåºåˆ—åŒ–ç»“æœï¼Œå³

ç»“æœ => JavaBeanDescriptor
ã€‚

- ç¬¬ 85 è‡³ 88 è¡Œï¼š

generic = true
ï¼Œè°ƒç”¨

PojoUtils/#generalize(Object)
æ–¹æ³•ï¼Œåºåˆ—åŒ–ç»“æœï¼Œä»…æœ‰

POJO => Map
ã€‚
