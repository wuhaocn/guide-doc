# è¿‡æ»¤å™¨ï¼ˆäºŒï¼‰ä¹‹ ContextFilter

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº« RpcContext ç›¸å…³è¿‡æ»¤å™¨ï¼ŒåŒ…æ‹¬ä¸¤ä¸ªï¼š

- ConsumerContextFilter ï¼šåœ¨æœåŠ¡**æ¶ˆè´¹è€…**ä¸­ä½¿ç”¨ï¼Œè´Ÿè´£**å‘èµ·**è°ƒç”¨æ—¶ï¼Œåˆå§‹åŒ– RpcContext ã€‚
- ContextFilter ï¼šåœ¨æœåŠ¡**æä¾›è€…**ä¸­ä½¿ç”¨ï¼Œè´Ÿè´£**è¢«**è°ƒç”¨æ—¶ï¼Œåˆå§‹åŒ– RpcContext ã€‚

# 2. RpcContext

RpcContextï¼Œä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚åœ¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/context.html) ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š
ä¸Šä¸‹æ–‡ä¸­å­˜æ”¾çš„æ˜¯å½“å‰è°ƒç”¨è¿‡ç¨‹ä¸­æ‰€éœ€çš„ç¯å¢ƒä¿¡æ¯ã€‚æ‰€æœ‰é…ç½®ä¿¡æ¯éƒ½å°†è½¬æ¢ä¸º URL çš„å‚æ•°ï¼Œå‚è§ [schema é…ç½®å‚è€ƒæ‰‹å†Œ](http://dubbo.apache.org/zh-cn/docs/user/references/xml/introduction.html) ä¸­çš„å¯¹åº” URL å‚æ•°ä¸€åˆ—ã€‚

RpcContext æ˜¯ä¸€ä¸ª ThreadLocal çš„ä¸´æ—¶çŠ¶æ€è®°å½•å™¨ï¼Œå½“æ¥æ”¶åˆ° RPC è¯·æ±‚ï¼Œæˆ–å‘èµ· RPC è¯·æ±‚æ—¶ï¼ŒRpcContext çš„çŠ¶æ€éƒ½ä¼šå˜åŒ–ã€‚æ¯”å¦‚ï¼šA è°ƒ Bï¼ŒB å†è°ƒ Cï¼Œåˆ™ B æœºå™¨ä¸Šï¼Œ

- åœ¨ B è°ƒ C ä¹‹å‰ï¼ŒRpcContext è®°å½•çš„æ˜¯ A è°ƒ B çš„ä¿¡æ¯ï¼Œ
- åœ¨ B è°ƒ C ä¹‹åï¼ŒRpcContext è®°å½•çš„æ˜¯ B è°ƒ C çš„ä¿¡æ¯ã€‚

- RpcContext åœ¨è°ƒç”¨æ—¶çš„çŠ¶æ€å˜åŒ–ï¼Œæœ‰ç‚¹ç»•ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹å…·ä½“çš„ Filter å®ç°ï¼Œå°±ç›¸å¯¹å®¹æ˜“æ˜ç™½åˆ—ã€‚

[
com.alibaba.dubbo.rpc.RpcContext
](http://svip.iocoder.cn/Dubbo/filter-context-filter/TODO) ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
//*/*
/* RpcContext çº¿ç¨‹å˜é‡
/*/
private static final ThreadLocal<RpcContext> LOCAL = new ThreadLocal<RpcContext>() {
@Override
protected RpcContext initialValue(){
return new RpcContext();
}
};
//*/*
/* éšå¼å‚æ•°é›†åˆ
/*/
private final Map<String, String> attachments = new HashMap<String, String>();
// å®é™…æœªä½¿ç”¨
private final Map<String, Object> values = new HashMap<String, Object>();
//*/*
/* å¼‚æ­¥è°ƒç”¨ Future
/*/
private Future<?> future;
//*/*
/* å¯è°ƒç”¨æœåŠ¡çš„ URL å¯¹è±¡é›†åˆ
/*/
private List<URL> urls;
//*/*
/* è°ƒç”¨æœåŠ¡çš„ URL å¯¹è±¡
/*/
private URL url;
//*/*
/* æ–¹æ³•å
/*/
private String methodName;
//*/*
/* å‚æ•°ç±»å‹æ•°ç»„
/*/
private Class<?>[] parameterTypes;
//*/*
/* å‚æ•°å€¼æ•°ç»„
/*/
private Object[] arguments;
//*/*
/* æœåŠ¡æ¶ˆè´¹è€…åœ°å€
/*/
private InetSocketAddress localAddress;
//*/*
/* æœåŠ¡æä¾›è€…åœ°å€
/*/
private InetSocketAddress remoteAddress;
@Deprecated // DUBBO-325 åºŸå¼ƒçš„ï¼Œä½¿ç”¨ urls å±æ€§æ›¿ä»£
private List<Invoker<?>> invokers;
@Deprecated // DUBBO-325 åºŸå¼ƒçš„ï¼Œä½¿ç”¨ url å±æ€§æ›¿ä»£
private Invoker<?> invoker;
@Deprecated // DUBBO-325 åºŸå¼ƒçš„ï¼Œä½¿ç”¨ methodNameã€parameterTypesã€arguments å±æ€§æ›¿ä»£
private Invocation invocation;
//*/*
/* è¯·æ±‚
/*
/* ä¾‹å¦‚ï¼Œåœ¨ RestProtocol
/*/
private Object request;
//*/*
/* å“åº”
/*
/* ä¾‹å¦‚ï¼Œåœ¨ RestProtocol
/*/
private Object response;
// ... çœç•¥ä¸€äº›
```

- LOCAL
  **é™æ€**å±æ€§ï¼ŒRpcContext çº¿ç¨‹å˜é‡ã€‚åˆå§‹è·å¾—æ—¶ï¼Œè¿”å›æ–°çš„ RpcContext å¯¹è±¡ã€‚
- attachments
  å±æ€§ï¼Œéšå¼å‚æ•°é›†åˆã€‚

- ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨ PRC è°ƒç”¨å‰ï¼Œå¯åœ¨ä¸šåŠ¡ä»£ç é‡Œæ·»åŠ ä¸€äº›æƒ³è¦ä¼ é€’ç»™æœåŠ¡çš„å‚æ•°åˆ°è¯¥å±æ€§
- åˆä¾‹å¦‚ï¼Œåœ¨åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªæ—¶ï¼Œæ·»åŠ é“¾è·¯è¿½è¸ª**ç¼–å·**åˆ°è¯¥å±æ€§ç§ã€‚
- [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” éšå¼å‚æ•°ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/attachment.html)
- future
  å±æ€§ï¼Œå¼‚æ­¥è°ƒç”¨ Future å¯¹è±¡ï¼Œåœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æœåŠ¡è°ƒç”¨ï¼ˆä¸‰ï¼‰ä¹‹è¿œç¨‹è°ƒç”¨ï¼ˆDubboï¼‰ã€3ã€‘å¼‚æ­¥è°ƒç”¨ã€‹](http://svip.iocoder.cn/Dubbo/rpc-dubbo-3-async/?self) æœ‰è¯¦ç»†ä½¿ç”¨çš„ä»£ç åˆ†äº«ã€‚
- ã€æ›¿ä»£

invokers
å±æ€§ã€‘

- urls
  å±æ€§ï¼Œ**å¯è°ƒç”¨**çš„æœåŠ¡çš„ URL å¯¹è±¡é›†åˆï¼Œåœ¨é›†ç¾¤å®¹é”™æ¨¡å—å®ç°ã€‚
- ã€æ›¿ä»£

invoker
å±æ€§ã€‘

- url
  å±æ€§ï¼Œ**è°ƒç”¨**çš„æœåŠ¡çš„ URL å¯¹è±¡ã€‚
- ã€æ›¿ä»£

invocation
å±æ€§ã€‘

- methodName
  å±æ€§ï¼Œ**è°ƒç”¨**çš„æ–¹æ³•åã€‚
- parameterTypes
  å±æ€§ï¼Œ**è°ƒç”¨**çš„å‚æ•°ç±»å‹æ•°ç»„ã€‚
- arguments
  å±æ€§ï¼Œ**è°ƒç”¨**çš„å‚æ•°å€¼æ•°ç»„ã€‚
- åœ°å€

- localAddress
  å±æ€§ï¼Œ æœåŠ¡æ¶ˆè´¹è€…åœ°å€ã€‚
- remoteAddress
  å±æ€§ï¼ŒæœåŠ¡æä¾›è€…åœ°å€ã€‚
- request

response
å±æ€§ï¼Œè¯·æ±‚å’Œå“åº”ã€‚ä¾‹å¦‚ï¼Œåœ¨ RestProtocol ä¸­ä½¿ç”¨ï¼Œä»£è¡¨ HTTP Request å’Œ Response å¯¹è±¡ï¼Œåœ¨ RpcContextFilter ä¸­è®¾ç½®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![RpcContextFilter](http://static2.iocoder.cn/images/Dubbo/2018_11_13/01.png)

- æˆ‘ä»¬å¯ä»¥çœ‹åˆ°

request

response
çš„ç±»å‹æ˜¯ Object ç±»ã€‚é€šè¿‡è¿™ç§å½¢å¼ï¼Œå¯ä»¥ä¸ä»…ä»…é€‚ç”¨äº HTTP çš„åœºæ™¯ã€‚

RpcContext ä¸­ï¼Œæœ‰å¾ˆå¤šæ–¹æ³•ï¼Œæ¯”è¾ƒæ˜“æ‡‚ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹å™¢ã€‚

# 3. ConsumerContextFilter

com.alibaba.dubbo.rpc.filter.ConsumerContextFilter
ï¼Œå®ç° Filter æ¥å£ï¼Œ**æœåŠ¡æ¶ˆè´¹è€…**çš„ ContextFilter å®ç°ç±»ã€‚

```
1: @Activate(group = Constants.CONSUMER, order = -10000)
2: public class ConsumerContextFilter implements Filter{
3:
4: @Override
5: public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException{
6: // è®¾ç½® RpcContext å¯¹è±¡
7: RpcContext.getContext()
8: .setInvoker(invoker)
9: .setInvocation(invocation)
10: .setLocalAddress(NetUtils.getLocalHost(), 0) // æœ¬åœ°åœ°å€
11: .setRemoteAddress(invoker.getUrl().getHost(), invoker.getUrl().getPort()); // è¿œç¨‹åœ°å€
12: // è®¾ç½® RpcInvocation å¯¹è±¡çš„ `invoker` å±æ€§
13: if (invocation instanceof RpcInvocation) {
14: ((RpcInvocation) invocation).setInvoker(invoker);
15: }
16: // æœåŠ¡è°ƒç”¨
17: try {
18: return invoker.invoke(invocation);
19: } finally {
20: // æ¸…ç†éšå¼å‚æ•°é›†åˆ
21: RpcContext.getContext().clearAttachments();
22: }
23: }
24:
25: }
```

- ç¬¬ 6 è‡³ 11 è¡Œï¼šè®¾ç½® RpcContext å¯¹è±¡ã€‚
- ç¬¬ 12 è‡³ 15 è¡Œï¼šè®¾ç½® RpcInvocation å¯¹è±¡çš„

invoker
å±æ€§ã€‚è¯¥å±æ€§ï¼Œç›®å‰ä½¿ç”¨åœ¨å¦‚ä¸‹å›¾çš„åœºæ™¯ï¼š![RpcInvocation](http://static2.iocoder.cn/images/Dubbo/2018_11_13/02.png)

- ç¬¬ 18 è¡Œï¼šè°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚

- ç¬¬ 19 è‡³ 22 è¡Œï¼šè°ƒç”¨

RpcContext/#clearAttachments()
æ–¹æ³•ï¼Œæ¸…ç†éšå¼å‚æ•°é›†åˆã€‚æ‰€ä»¥ï¼Œ**æ¯æ¬¡**ï¼ˆæ³¨æ„ï¼Œæ¯æ¬¡ï¼ï¼ï¼ï¼‰æœåŠ¡è°ƒç”¨å®Œæˆï¼ŒRpcContext è®¾ç½®çš„éšå¼å‚æ•°**éƒ½ä¼šè¢«æ¸…ç†**ï¼ä»£ç å¦‚ä¸‹ï¼š

```
public void clearAttachments(){
this.attachments.clear();
}
```

ğŸ˜ˆ çœ‹åˆ°æ­¤å¤„ï¼Œ

RpcContext.attachments
å±æ€§ï¼Œæ˜¯å¦‚ä½•ä¼ é€’ç»™è¢«è°ƒç”¨çš„æœåŠ¡çš„å‘¢ï¼Ÿç­”æ¡ˆåœ¨ä¸‹å›¾ï¼š![é€ä¼ ](http://static2.iocoder.cn/images/Dubbo/2018_11_13/03.png)

# 4. ContextFilter

com.alibaba.dubbo.rpc.filter.ContextFilter
ï¼Œå®ç° Filter æ¥å£ï¼Œ**æœåŠ¡æä¾›è€…**çš„ ContextFilter å®ç°ç±»ã€‚

```
1: @Activate(group = Constants.PROVIDER, order = -10000)
2: public class ContextFilter implements Filter{
3:
4: @Override
5: public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException{
6: // åˆ›å»ºæ–°çš„ `attachments` é›†åˆï¼Œæ¸…ç†å…¬ç”¨çš„éšå¼å‚æ•°
7: Map<String, String> attachments = invocation.getAttachments();
8: if (attachments != null) {
9: attachments = new HashMap<String, String>(attachments);
10: attachments.remove(Constants.PATH_KEY);
11: attachments.remove(Constants.GROUP_KEY);
12: attachments.remove(Constants.VERSION_KEY);
13: attachments.remove(Constants.DUBBO_VERSION_KEY);
14: attachments.remove(Constants.TOKEN_KEY);
15: attachments.remove(Constants.TIMEOUT_KEY);
16: attachments.remove(Constants.ASYNC_KEY); // Remove async property to avoid being passed to the following invoke chain.
17: // æ¸…ç©ºæ¶ˆè´¹ç«¯çš„å¼‚æ­¥å‚æ•°
18: }
19: // è®¾ç½® RpcContext å¯¹è±¡
20: RpcContext.getContext()
21: .setInvoker(invoker)
22: .setInvocation(invocation)
23: // .setAttachments(attachments) // merged from dubbox
24: .setLocalAddress(invoker.getUrl().getHost(), invoker.getUrl().getPort());
25: // mreged from dubbox
26: // we may already added some attachments into RpcContext before this filter (e.g. in rest protocol)
27: // åœ¨æ­¤è¿‡æ»¤å™¨(ä¾‹å¦‚reståè®®)ä¹‹å‰ï¼Œæˆ‘ä»¬å¯èƒ½å·²ç»åœ¨RpcContextä¸­æ·»åŠ äº†ä¸€äº›é™„ä»¶ã€‚
28: if (attachments != null) {
29: if (RpcContext.getContext().getAttachments() != null) {
30: RpcContext.getContext().getAttachments().putAll(attachments);
31: } else {
32: RpcContext.getContext().setAttachments(attachments);
33: }
34: }
35: // è®¾ç½® RpcInvocation å¯¹è±¡çš„ `invoker` å±æ€§
36: if (invocation instanceof RpcInvocation) {
37: ((RpcInvocation) invocation).setInvoker(invoker);
38: }
39: // æœåŠ¡è°ƒç”¨
40: try {
41: return invoker.invoke(invocation);
42: } finally {
43: // ç§»é™¤ä¸Šä¸‹æ–‡
44: RpcContext.removeContext();
45: }
46: }
47:
48: }
```

- ç¬¬ 6 è‡³ 18 è¡Œï¼šåˆ›å»ºæ–°çš„

attachments
é›†åˆï¼Œå› ä¸ºè¦æ¸…ç†**å…¬ç”¨**çš„éšå¼å‚æ•°ã€‚è¯¥**å…¬ç”¨**çš„éšå¼å‚æ•°ï¼Œè®¾ç½®çš„åœ°æ–¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![RpcInvocation](http://static2.iocoder.cn/images/Dubbo/2018_11_13/04.png)

- ç¬¬ 19 è‡³ 24 è¡Œï¼šè®¾ç½® RpcContext å¯¹è±¡ã€‚
- ç¬¬ 25 è‡³ 34 è¡Œï¼šåœ¨æ­¤è¿‡æ»¤å™¨( ä¾‹å¦‚ RestProtocol çš„ RpcContextFilter )ä¹‹å‰ï¼Œæˆ‘ä»¬å¯èƒ½å·²ç»åœ¨ RpcContext ä¸­æ·»åŠ äº†ä¸€äº›éšå¼å‚æ•°ã€‚
- ç¬¬ 35 è‡³ 38 è¡Œï¼šè°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚

- ç¬¬ 41 è¡Œï¼šè°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚

- ç¬¬ 42 è‡³ 45 è¡Œï¼šè°ƒç”¨

RpcContext/#removeContext()
æ–¹æ³•ï¼Œç§»é™¤ä¸Šä¸‹æ–‡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public static void removeContext(){
LOCAL.remove();
}
```

# 5. RpcContext.values

æˆ‘ä»¬åœ¨å›è¿‡å¤´æ¥çœ‹

RpcContext.values
å±æ€§ã€‚ç›®å‰ Dubbo ä¸­ï¼Œ**å¹¶æœªä½¿ç”¨å®ƒ**ã€‚

ä»ä»£ç çœ‹ä¸‹æ¥ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›æœ‰**å¤šæ¬¡** Dubbo è°ƒç”¨ï¼Œå…±äº«å‚æ•°ï¼Œå¹¶ä¸”ä¸è¢« ConsumerContextFilter æ¸…ç†éšå¼å‚æ•°ï¼Œç¬”è€…è§‰å¾—å¯ä»¥ä½¿ç”¨è¯¥

values
å±æ€§ã€‚

å’Œ

value
å±æ€§ç›¸å…³çš„æ–¹æ³•å¦‚ä¸‹ï¼š

```
public Map<String, Object> get(){
return values;
}
public RpcContext set(String key, Object value){
if (value == null) {
values.remove(key);
} else {
values.put(key, value);
}
return this;
}
public RpcContext remove(String key){
values.remove(key);
return this;
}
public Object get(String key){
return values.get(key);
}
```

å½“ç„¶ï¼Œå¦‚æœåŒæ—¶æˆ‘ä»¬å¸Œæœ›ä¸€äº›**é€šç”¨**çš„

values
ä¼ é€’ç»™è¢«è°ƒç”¨çš„æœåŠ¡ï¼Œå¯ä»¥å®ç°ä¸€ä¸ª Filter ï¼Œç®€åŒ–ä»£ç å¦‚ä¸‹ï¼š

```
RpcContext.getContext().setAttachment("key1", RpcContext.getContext().get("key2").toString());
```

æ©ï¼Œè¿˜æ˜¯å½“ç„¶ï¼Œåœ¨ä¸šåŠ¡ä»£ç é‡Œï¼Œä¹Ÿå¯ä»¥è¿™ä¹ˆè°ƒç”¨ã€‚ğŸ™‚
