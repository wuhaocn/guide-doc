# æ³¨å†Œä¸­å¿ƒ(ä¸‰)ä¹‹ Redis

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

å‰ç½®é˜…è¯»æ–‡ç« ï¼š

- [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹](http://svip.iocoder.cn/Dubbo/registry-api/?self)
- [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒï¼ˆäºŒï¼‰ä¹‹ Zookeeperã€‹](http://svip.iocoder.cn/Dubbo/registry-zookeeper/?self)

æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” Redis æ³¨å†Œä¸­å¿ƒã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/registry/redis.html) æ–‡æ¡£ï¼Œå†…å®¹å¦‚ä¸‹ï¼š
åŸºäº Redis å®ç°çš„æ³¨å†Œä¸­å¿ƒã€‚

![æµç¨‹](http://static2.iocoder.cn/images/Dubbo/2018_08_07/01.png)

ä½¿ç”¨ Redis çš„ Key/Map ç»“æ„å­˜å‚¨æ•°æ®ç»“æ„ï¼š

- ä¸» Key ä¸ºæœåŠ¡åå’Œç±»å‹
- Map ä¸­çš„ Key ä¸º URL åœ°å€
- Map ä¸­çš„ Value ä¸ºè¿‡æœŸæ—¶é—´ï¼Œç”¨äºåˆ¤æ–­è„æ•°æ®ï¼Œè„æ•°æ®ç”±ç›‘æ§ä¸­å¿ƒåˆ é™¤

- **æ¨ªå‘**æ¥çœ‹ï¼Œå’ŒåŸºäº Zookeeper å®ç°çš„æ³¨å†Œä¸­å¿ƒï¼Œä¹Ÿæ˜¯åˆ†æˆ **Root**ã€**Service**ã€**Type**ã€**URL** å››å±‚ã€‚
- ä½¿ç”¨ **Redis Map** çš„æ•°æ®ç»“æ„ï¼Œèšåˆç›¸åŒæœåŠ¡å’Œç±»å‹( Root + Service + Type )ã€‚
- ä¸ä½¿ç”¨ Redis çš„**è‡ªåŠ¨è¿‡æœŸ**æœºåˆ¶ï¼Œè€Œæ˜¯é€šè¿‡**ç›‘æ§ä¸­å¿ƒ**ï¼Œå®ç°è¿‡æœŸæœºåˆ¶ã€‚å› ä¸ºï¼ŒRedis Key è‡ªåŠ¨è¿‡æœŸæ—¶ï¼Œä¸å­˜åœ¨ç›¸åº”çš„äº‹ä»¶é€šçŸ¥ã€‚
- æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…ï¼Œå®šæ—¶å»¶é•¿å…¶æ³¨å†Œçš„ URL åœ°å€çš„è¿‡æœŸæ—¶é—´ã€‚

ä½¿ç”¨ Redis çš„ **Publish/Subscribe** äº‹ä»¶é€šçŸ¥æ•°æ®å˜æ›´ï¼š

- é€šè¿‡äº‹ä»¶çš„å€¼åŒºåˆ†äº‹ä»¶ç±»å‹ï¼š

register
,

unregister

- æ™®é€šæ¶ˆè´¹è€…ç›´æ¥è®¢é˜…æŒ‡å®šæœåŠ¡æä¾›è€…çš„ Keyï¼Œåªä¼šæ”¶åˆ°**æŒ‡å®šæœåŠ¡**çš„å˜æ›´äº‹ä»¶
- ç›‘æ§ä¸­å¿ƒé€šè¿‡ psubscribe åŠŸèƒ½è®¢é˜…

/dubbo//\*
ï¼Œä¼šæ”¶åˆ°**æ‰€æœ‰æœåŠ¡**çš„æ‰€æœ‰å˜æ›´äº‹ä»¶

- æœåŠ¡å®ä¾‹çš„å¯åŠ¨æˆ–å…³é—­ï¼Œä¼šå†™å…¥æˆ–åˆ é™¤å¯¹åº”çš„ Redis Map ä¸­ï¼Œå¹¶å‘èµ·å¯¹åº”çš„

register
,

unregister
äº‹ä»¶ï¼Œä»è€Œä¿è¯**å®æ—¶æ€§**ã€‚

- é€šè¿‡ç›‘æ§ä¸­å¿ƒï¼Œè½®è¯¢ Key è¿‡æœŸï¼Œä¿è¯**æœªæ­£å¸¸å…³é—­**çš„æœåŠ¡å®ä¾‹çš„ URL çš„åˆ é™¤ï¼Œå¹¶å‘èµ·å¯¹åº”çš„

unregister
äº‹ä»¶ï¼Œä»è€Œä¿è¯**æœ€ç»ˆä¸€è‡´æ€§**ã€‚

**è°ƒç”¨è¿‡ç¨‹**ï¼š
ã€ä¸€ã€‘æœåŠ¡æä¾›æ–¹

- 1ã€æœåŠ¡æä¾›æ–¹å¯åŠ¨æ—¶ï¼Œå‘

Key:/dubbo/com.foo.BarService/providers
ä¸‹ï¼Œæ·»åŠ å½“å‰æä¾›è€…çš„åœ°å€

- 2ã€å¹¶å‘

Channel:/dubbo/com.foo.BarService/providers
å‘é€

register
äº‹ä»¶

ã€äºŒã€‘æœåŠ¡æ¶ˆè´¹æ–¹

- 3ã€æœåŠ¡æ¶ˆè´¹æ–¹å¯åŠ¨æ—¶ï¼Œä»

Channel:/dubbo/com.foo.BarService/providers
è®¢é˜…

register
å’Œ

unregister
äº‹ä»¶

- 4ã€å¹¶å‘

Key:/dubbo/com.foo.BarService/providers
ä¸‹ï¼Œæ·»åŠ å½“å‰æ¶ˆè´¹è€…çš„åœ°å€
æœåŠ¡æ¶ˆè´¹æ–¹æ”¶åˆ°

register
å’Œ

unregister
äº‹ä»¶åï¼Œä»

Key:/dubbo/com.foo.BarService/providers
ä¸‹è·å–æä¾›è€…åœ°å€åˆ—è¡¨

ã€ä¸‰ã€‘æœåŠ¡ç›‘æ§ä¸­å¿ƒ

- 5ã€æœåŠ¡ç›‘æ§ä¸­å¿ƒå¯åŠ¨æ—¶ï¼Œä»

Channel:/dubbo//\*
è®¢é˜…

register
å’Œ

unregister
ï¼Œä»¥åŠ

subscribe
å’Œ

unsubsribe
äº‹ä»¶

- 6ã€æœåŠ¡ç›‘æ§ä¸­å¿ƒæ”¶åˆ°

register
å’Œ

unregister
äº‹ä»¶åï¼Œä»

Key:/dubbo/com.foo.BarService/providers
ä¸‹è·å–æä¾›è€…åœ°å€åˆ—è¡¨

- 7ã€æœåŠ¡ç›‘æ§ä¸­å¿ƒæ”¶åˆ°

subscribe
å’Œ

unsubsribe
äº‹ä»¶åï¼Œä»

Key:/dubbo/com.foo.BarService/consumers
ä¸‹è·å–æ¶ˆè´¹è€…åœ°å€åˆ—è¡¨

æœ¬æ–‡æ¶‰åŠä»…æœ‰ RedisRegistry ä¸€ä¸ªç±»ï¼Œç±»å›¾å¦‚ä¸‹ï¼š

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_08_07/02.png)

# 2. RedisRegistry

[
com.alibaba.dubbo.registry.redis.RedisRegistry
](https://github.com/YunaiV/dubbo/blob/master/dubbo-registry/dubbo-registry-redis/src/main/java/com/alibaba/dubbo/registry/redis/RedisRegistry.java) ï¼Œå®ç° FailbackRegistry æŠ½è±¡ç±»ï¼ŒåŸºäº Redis å®ç°çš„æ³¨å†Œä¸­å¿ƒå®ç°ç±»ã€‚

## 2.1 æ„é€ æ–¹æ³•

```
1: //*/*
2: /* é»˜è®¤ç«¯å£
3: /*/
4: private static final int DEFAULT_REDIS_PORT = 6379;
5: //*/*
6: /* é»˜è®¤ Redis æ ¹èŠ‚ç‚¹
7: /*/
8: private final static String DEFAULT_ROOT = "dubbo";
9:
10: //*/*
11: /* Redis Key è¿‡æœŸæœºåˆ¶æ‰§è¡Œå™¨
12: /*/
13: private final ScheduledExecutorService expireExecutor = Executors.newScheduledThreadPool(1, new NamedThreadFactory("DubboRegistryExpireTimer", true));
14: //*/*
15: /* Redis Key è¿‡æœŸæœºåˆ¶ Future
16: /*/
17: private final ScheduledFuture<?> expireFuture;
18:
19: //*/*
20: /* Redis æ ¹èŠ‚ç‚¹
21: /*/
22: private final String root;
23:
24: //*/*
25: /* JedisPool é›†åˆ
26: /*
27: /* keyï¼šip:port
28: /*/
29: private final Map<String, JedisPool> jedisPools = new ConcurrentHashMap<String, JedisPool>();
30:
31: //*/*
32: /* é€šçŸ¥å™¨é›†åˆ
33: /*
34: /* keyï¼šRoot + Service ï¼Œä¾‹å¦‚ `/dubbo/com.alibaba.dubbo.demo.DemoService`
35: /*/
36: private final ConcurrentMap<String, Notifier> notifiers = new ConcurrentHashMap<String, Notifier>();
37:
38: //*/*
39: /* é‡è¿å‘¨æœŸï¼Œå•ä½ï¼šæ¯«ç§’
40: /*/
41: private final int reconnectPeriod;
42: //*/*
43: /* è¿‡æœŸå‘¨æœŸï¼Œå•ä½ï¼šæ¯«ç§’
44: /*/
45: private final int expirePeriod;
46:
47: //*/*
48: /* æ˜¯å¦ç›‘æ§ä¸­å¿ƒ
49: /*
50: /* ç”¨äºåˆ¤æ–­è„æ•°æ®ï¼Œè„æ•°æ®ç”±ç›‘æ§ä¸­å¿ƒåˆ é™¤ {@link /#clean(Jedis)}
51: /*/
52: private volatile boolean admin = false;
53:
54: //*/*
55: /* æ˜¯å¦å¤åˆ¶æ¨¡å¼
56: /*/
57: private boolean replicate;
58:
59: public RedisRegistry(URL url){
60: super(url);
61: if (url.isAnyHost()) {
62: throw new IllegalStateException("registry address == null");
63: }
64: // åˆ›å»º GenericObjectPoolConfig å¯¹è±¡
65: GenericObjectPoolConfig config = new GenericObjectPoolConfig();
66: config.setTestOnBorrow(url.getParameter("test.on.borrow", true));
67: config.setTestOnReturn(url.getParameter("test.on.return", false));
68: config.setTestWhileIdle(url.getParameter("test.while.idle", false));
69: if (url.getParameter("max.idle", 0) > 0)
70: config.setMaxIdle(url.getParameter("max.idle", 0));
71: if (url.getParameter("min.idle", 0) > 0)
72: config.setMinIdle(url.getParameter("min.idle", 0));
73: if (url.getParameter("max.active", 0) > 0)
74: config.setMaxTotal(url.getParameter("max.active", 0));
75: if (url.getParameter("max.total", 0) > 0)
76: config.setMaxTotal(url.getParameter("max.total", 0));
77: if (url.getParameter("max.wait", url.getParameter("timeout", 0)) > 0)
78: config.setMaxWaitMillis(url.getParameter("max.wait", url.getParameter("timeout", 0)));
79: if (url.getParameter("num.tests.per.eviction.run", 0) > 0)
80: config.setNumTestsPerEvictionRun(url.getParameter("num.tests.per.eviction.run", 0));
81: if (url.getParameter("time.between.eviction.runs.millis", 0) > 0)
82: config.setTimeBetweenEvictionRunsMillis(url.getParameter("time.between.eviction.runs.millis", 0));
83: if (url.getParameter("min.evictable.idle.time.millis", 0) > 0)
84: config.setMinEvictableIdleTimeMillis(url.getParameter("min.evictable.idle.time.millis", 0));
85:
86: // æ˜¯å¦å¤åˆ¶æ¨¡å¼
87: String cluster = url.getParameter("cluster", "failover");
88: if (!"failover".equals(cluster) && !"replicate".equals(cluster)) {
89: throw new IllegalArgumentException("Unsupported redis cluster: " + cluster + ". The redis cluster only supported failover or replicate.");
90: }
91: replicate = "replicate".equals(cluster);
92:
93: // è§£æ
94: List<String> addresses = new ArrayList<String>();
95: addresses.add(url.getAddress());
96: String[] backups = url.getParameter(Constants.BACKUP_KEY, new String[0]);
97: if (backups != null && backups.length > 0) {
98: addresses.addAll(Arrays.asList(backups));
99: }
100:
101: // åˆ›å»º JedisPool å¯¹è±¡
102: String password = url.getPassword();
103: for (String address : addresses) {
104: int i = address.indexOf(':');
105: String host;
106: int port;
107: if (i > 0) {
108: host = address.substring(0, i);
109: port = Integer.parseInt(address.substring(i + 1));
110: } else {
111: host = address;
112: port = DEFAULT_REDIS_PORT;
113: }
114: if (StringUtils.isEmpty(password)) { // æ— å¯†ç è¿æ¥
115: this.jedisPools.put(address, new JedisPool(config, host, port,
116: url.getParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT)));
117: } else { // æœ‰å¯†ç è¿æ¥
118: this.jedisPools.put(address, new JedisPool(config, host, port,
119: url.getParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT), password));
120: }
121: }
122:
123: // è§£æé‡è¿å‘¨æœŸ
124: this.reconnectPeriod = url.getParameter(Constants.REGISTRY_RECONNECT_PERIOD_KEY, Constants.DEFAULT_REGISTRY_RECONNECT_PERIOD);
125:
126: // è·å¾— Redis æ ¹èŠ‚ç‚¹
127: String group = url.getParameter(Constants.GROUP_KEY, DEFAULT_ROOT);
128: if (!group.startsWith(Constants.PATH_SEPARATOR)) { // å¤´ `/`
129: group = Constants.PATH_SEPARATOR + group;
130: }
131: if (!group.endsWith(Constants.PATH_SEPARATOR)) { // å°¾ `/`
132: group = group + Constants.PATH_SEPARATOR;
133: }
134: this.root = group;
135:
136: // åˆ›å»ºå®ç° Redis Key è¿‡æœŸæœºåˆ¶çš„ä»»åŠ¡
137: this.expirePeriod = url.getParameter(Constants.SESSION_TIMEOUT_KEY, Constants.DEFAULT_SESSION_TIMEOUT);
138: this.expireFuture = expireExecutor.scheduleWithFixedDelay(new Runnable() {
139: public void run(){
140: try {
141: deferExpired(); // Extend the expiration time
142: } catch (Throwable t) { // Defensive fault tolerance
143: logger.error("Unexpected exception occur at defer expire time, cause: " + t.getMessage(), t);
144: }
145: }
146: }, expirePeriod / 2, expirePeriod / 2, TimeUnit.MILLISECONDS);
147: }
```

- jedisPools
  å±æ€§ï¼ŒJedisPool é›†åˆï¼Œå…¶ä¸­é”®ä¸º

ip:port
ã€‚åœ¨ã€ç¬¬ 64 è‡³ 84 è¡Œã€‘å’Œã€ç¬¬ 93 è‡³ 99 è¡Œã€‘å’Œã€101 è‡³ 121 è¡Œã€‘åˆå§‹åŒ–ã€‚

- root
  å±æ€§ï¼ŒRedis æ ¹èŠ‚ç‚¹ï¼Œå³é¦–å›¾çš„ **Root** å±‚ã€‚åœ¨ã€ç¬¬ 126 è‡³ 134 è¡Œã€‘åˆå§‹åŒ–ã€‚
- replicate
  å±æ€§ï¼Œæ˜¯å¦å¤åˆ¶æ¨¡å¼ã€‚åœ¨ã€ç¬¬ 86 è‡³ 90 è¡Œã€‘æ–‡æ¡£è¯´æ˜å¦‚ä¸‹ï¼š
  å¯é€šè¿‡

<dubbo:registry cluster="replicate" />
è®¾ç½® redis é›†ç¾¤ç­–ç•¥ï¼Œç¼ºçœä¸º

failover
ï¼š

- failover
  : åªå†™å…¥å’Œè¯»å–ä»»æ„ä¸€å°ï¼Œå¤±è´¥æ—¶é‡è¯•å¦ä¸€å°ï¼Œéœ€è¦æœåŠ¡å™¨ç«¯è‡ªè¡Œé…ç½®æ•°æ®åŒæ­¥ã€‚
- replicate
  : åœ¨å®¢æˆ·ç«¯åŒæ—¶å†™å…¥æ‰€æœ‰æœåŠ¡å™¨ï¼Œåªè¯»å–å•å°ï¼ŒæœåŠ¡å™¨ç«¯ä¸éœ€è¦åŒæ­¥ï¼Œæ³¨å†Œä¸­å¿ƒé›†ç¾¤å¢å¤§ï¼Œæ€§èƒ½å‹åŠ›ä¹Ÿä¼šæ›´å¤§ã€‚
- notifiers
  å±æ€§ï¼Œé€šçŸ¥å™¨é›†åˆï¼Œå…¶ä¸­é”®ä¸º Root + Service ã€‚Notifier ï¼Œç”¨äº Redis Publish/Subscribe æœºåˆ¶ä¸­çš„è®¢é˜…ï¼Œå®æ—¶ç›‘å¬æ•°æ®çš„å˜åŒ–ã€‚

- reconnectPeriod
  å±æ€§ï¼Œé‡è¿å‘¨æœŸï¼Œå•ä½ï¼šæ¯«ç§’ã€‚åœ¨ã€ç¬¬ 91 è¡Œã€‘åˆå§‹åŒ–ã€‚ç”¨äºè®¢é˜…å‘ç”Ÿ Redis è¿æ¥å¼‚å¸¸æ—¶ï¼ŒNotifier **sleep** ï¼Œç­‰å¾…é‡è¿ä¸Šã€‚
- expireExecutor
  å±æ€§ï¼ŒRedis Key è¿‡æœŸæœºåˆ¶æ‰§è¡Œå™¨ã€‚

- expirePeriod
  å±æ€§ï¼ŒRedis Key è¿‡æœŸå‘¨æœŸï¼Œå•ä½ï¼šæ¯«ç§’ã€‚åœ¨ã€ç¬¬ 137 è¡Œã€‘åˆå§‹åŒ–ã€‚
- expireFuture
  å±æ€§ï¼ŒRedis Key è¿‡æœŸæœºåˆ¶ä»»åŠ¡çš„ Future ã€‚åœ¨ã€ç¬¬ 138 è‡³ 146 è¡Œã€‘åˆå§‹åŒ–ã€‚

- è¯¥ä»»åŠ¡ä¸»è¦æœ‰ä¸¤ä¸ªé€»è¾‘ï¼š1ï¼‰å»¶é•¿æœªè¿‡æœŸçš„ Key ï¼›2ï¼‰åˆ é™¤è¿‡æœŸçš„ Key ã€‚
- ä»»åŠ¡é—´éš”ä¸º

expirePeriod
çš„**ä¸€åŠ**ï¼Œé¿å…è¿‡äºé¢‘ç¹ï¼Œå¯¹ Redis çš„å‹åŠ›è¿‡å¤§ï¼›åŒæ—¶ï¼Œé¿å…è¿‡äºä¸é¢‘ç¹ï¼Œæ¯æ¬¡æ‰§è¡Œæ—¶ï¼Œéƒ½è¿‡æœŸäº†ã€‚

- admin
  å±æ€§ï¼Œæ˜¯å¦ç›‘æ§ä¸­å¿ƒï¼Œåœ¨

/#clean(Jedis)
æ–¹æ³•ï¼Œçœ‹åˆ°å…·ä½“çš„ä½¿ç”¨ã€‚

## 2.2 doRegister

```
1: @Override
2: public void doRegister(URL url){
3: String key = toCategoryPath(url);
4: String value = url.toFullString();
5: // è®¡ç®—è¿‡æœŸæ—¶é—´
6: String expire = String.valueOf(System.currentTimeMillis() + expirePeriod);
7: boolean success = false;
8: RpcException exception = null;
9: // å‘ Redis æ³¨å†Œ
10: for (Map.Entry<String, JedisPool> entry : jedisPools.entrySet()) {
11: JedisPool jedisPool = entry.getValue();
12: try {
13: Jedis jedis = jedisPool.getResource();
14: try {
15: // å†™å…¥ Redis Map é”®
16: jedis.hset(key, value, expire);
17: // å‘å¸ƒ Redis æ³¨å†Œäº‹ä»¶
18: jedis.publish(key, Constants.REGISTER);
19: success = true;
20: // å¦‚æœæœåŠ¡å™¨ç«¯å·²åŒæ­¥æ•°æ®ï¼Œåªéœ€å†™å…¥å•å°æœºå™¨
21: if (!replicate) {
22: break; // If the server side has synchronized data, just write a single machine
23: }
24: } finally {
25: jedisPool.returnResource(jedis);
26: }
27: } catch (Throwable t) {
28: exception = new RpcException("Failed to register service to redis registry. registry: " + entry.getKey() + ", service: " + url + ", cause: " + t.getMessage(), t);
29: }
30: }
31: // å¤„ç†å¼‚å¸¸
32: if (exception != null) {
33: if (success) { // è™½ç„¶å‘ç”Ÿå¼‚å¸¸ï¼Œä½†æ˜¯ç»“æœæˆåŠŸ
34: logger.warn(exception.getMessage(), exception);
35: } else { // æœ€ç»ˆæœªæˆåŠŸ
36: throw exception;
37: }
38: }
39: }
```

- ç¬¬ 3 è¡Œï¼šè°ƒç”¨

/#toCategoryPath(url)
æ–¹æ³•ï¼Œè·å¾—**åˆ†ç±»è·¯å¾„**ä½œä¸º Key ã€‚

- ç¬¬ 4 è¡Œï¼šè°ƒç”¨

URL/#toFullString()
æ–¹æ³•ï¼Œè·å¾— **URL å­—ç¬¦ä¸²**ä½œä¸º Value ã€‚

- ç¬¬ 6 è¡Œï¼šè®¡ç®—è¿‡æœŸæ—¶é—´ï¼Œå½“å‰æ—¶é—´ +

expirePeriod
ã€‚

- ç¬¬ 9 è‡³ 30 è¡Œï¼šå‘ Redis æ³¨å†Œã€‚

- ç¬¬ 16 è¡Œï¼šè°ƒç”¨

Jedis/#hset(key, value, expire)
æ–¹æ³•ï¼Œå†™å…¥ Redis Map ä¸­ã€‚**æ³¨æ„ï¼Œè¿‡æœŸæ—¶é—´ï¼Œä½œä¸º Map çš„å€¼**ã€‚

- ç¬¬ 18 è¡Œï¼šè°ƒç”¨

Jedis/#publish(channel, message)
æ–¹æ³•ï¼Œå‘å¸ƒ

register
äº‹ä»¶ã€‚è¿™æ ·è®¢é˜…è¯¥ Key çš„æœåŠ¡æ¶ˆè´¹è€…å’Œç›‘æ§ä¸­å¿ƒï¼Œå°±ä¼šå®æ—¶ä» Redis è¯»å–**è¯¥æœåŠ¡**çš„æœ€æ–°æ•°æ®ã€‚

- ç¬¬ 21 è‡³ 23 è¡Œï¼šå¦‚æœé

replicate
ï¼Œæ„å‘³ç€ Redis æœåŠ¡å™¨ç«¯å·²åŒæ­¥æ•°æ®ï¼Œåªéœ€å†™å…¥å•å°æœºå™¨ã€‚å› æ­¤ï¼Œç»“æŸå¾ªç¯ã€‚å¦åˆ™ï¼Œæ»¡è¶³

replicate
ï¼Œå‘æ‰€æœ‰ Redis å†™å…¥ã€‚

- ç¬¬ 31 è‡³ 38 è¡Œï¼šå¤„ç†å¼‚å¸¸ã€‚è¿™å—ä»£ç èƒ–å‹è‡ªå·±çœ‹ä¸‹ï¼Œæ³¨æ„ä¸‹

exception
å’Œ

success
èµ‹å€¼çš„åœ°æ–¹ã€‚è¿™å—çš„æ‰“å°å‘Šè­¦æ—¥å¿—çš„å¤„ç†æ–¹å¼ï¼Œä¹Ÿé€‚ç”¨äºå¤šæ¬¡é‡è¯•æŸä¸ªæ“ä½œï¼Œç»“æœå‘ç”Ÿå¼‚å¸¸ï¼Œä½†æ˜¯æœ€ç»ˆæˆåŠŸã€‚ä¾‹å¦‚ï¼ŒHTTP è¯·æ±‚è¿œç¨‹æœåŠ¡ã€‚

### 2.1.1 toCategoryPath

```
//*/*
/* è·å¾—åˆ†ç±»è·¯å¾„
/*
/* Root + Service + Type
/*
/* @param url URL
/* @return åˆ†ç±»è·¯å¾„
/*/
private String toCategoryPath(URL url){
return toServicePath(url) + Constants.PATH_SEPARATOR + url.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);
}
```

## 2.3 doUnregister

```
@Override
public void doUnregister(URL url){
String key = toCategoryPath(url);
String value = url.toFullString();
RpcException exception = null;
boolean success = false;
// å‘ Redis æ³¨å†Œ
for (Map.Entry<String, JedisPool> entry : jedisPools.entrySet()) {
JedisPool jedisPool = entry.getValue();
try {
Jedis jedis = jedisPool.getResource();
try {
// åˆ é™¤ Redis Map é”®
jedis.hdel(key, value);
// å‘å¸ƒ Redis å–æ¶ˆæ³¨å†Œäº‹ä»¶
jedis.publish(key, Constants.UNREGISTER);
success = true;
// å¦‚æœæœåŠ¡å™¨ç«¯å·²åŒæ­¥æ•°æ®ï¼Œåªéœ€å†™å…¥å•å°æœºå™¨
if (!replicate) {
break; // If the server side has synchronized data, just write a single machine
}
} finally {
jedisPool.returnResource(jedis);
}
} catch (Throwable t) {
exception = new RpcException("Failed to unregister service to redis registry. registry: " + entry.getKey() + ", service: " + url + ", cause: " + t.getMessage(), t);
}
}
// å¤„ç†å¼‚å¸¸
if (exception != null) {
if (success) { // è™½ç„¶å‘ç”Ÿå¼‚å¸¸ï¼Œä½†æ˜¯ç»“æœæˆåŠŸ
logger.warn(exception.getMessage(), exception);
} else { // æœ€ç»ˆæœªæˆåŠŸ
throw exception;
}
}
}
```

- å½“æœåŠ¡æ¶ˆè´¹è€…æˆ–æœåŠ¡æä¾›è€…ï¼Œå…³é—­æ—¶ï¼Œä¼šè°ƒç”¨

/#doUnregister(url)
æ–¹æ³•ï¼Œå–æ¶ˆæ³¨å†Œã€‚åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¼šåˆ é™¤å¯¹åº” Map ä¸­çš„**é”®** + å‘å¸ƒ

unregister
äº‹ä»¶ï¼Œä»è€Œ**å®æ—¶**é€šçŸ¥è®¢é˜…è€…ä»¬ã€‚å› æ­¤ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œå°±æ— éœ€ç›‘æ§ä¸­å¿ƒï¼Œåšè„æ•°æ®åˆ é™¤çš„å·¥ä½œã€‚

- ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œå’Œ

/#doRegister()
æ–¹æ³•ï¼Œé€»è¾‘ç›¸åã€‚

## 2.4 doSubscribe

```
1: @Override
2: public void doSubscribe(final URL url, final NotifyListener listener){
3: // è·å¾—æœåŠ¡è·¯å¾„ï¼Œä¾‹å¦‚ï¼š`/dubbo/com.alibaba.dubbo.demo.DemoService`
4: String service = toServicePath(url);
5: // è·å¾—é€šçŸ¥å™¨ Notifier å¯¹è±¡
6: Notifier notifier = notifiers.get(service);
7: // ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º Notifier å¯¹è±¡
8: if (notifier == null) {
9: Notifier newNotifier = new Notifier(service);
10: notifiers.putIfAbsent(service, newNotifier);
11: notifier = notifiers.get(service);
12: if (notifier == newNotifier) { // ä¿è¯å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¯åŠ¨
13: notifier.start();
14: }
15: }
16: boolean success = false;
17: RpcException exception = null;
18: // å¾ªç¯ `jedisPools` ï¼Œä»…å‘ä¸€ä¸ª Redis å‘èµ·è®¢é˜…
19: for (Map.Entry<String, JedisPool> entry : jedisPools.entrySet()) {
20: JedisPool jedisPool = entry.getValue();
21: try {
22: Jedis jedis = jedisPool.getResource();
23: try {
24: // å¤„ç†æ‰€æœ‰ Service å±‚çš„å‘èµ·è®¢é˜…ï¼Œä¾‹å¦‚ç›‘æ§ä¸­å¿ƒçš„è®¢é˜…
25: if (service.endsWith(Constants.ANY_VALUE)) {
26: admin = true;
27: // è·å¾—åˆ†ç±»å±‚é›†åˆï¼Œä¾‹å¦‚ï¼š`/dubbo/com.alibaba.dubbo.demo.DemoService/providers`
28: Set<String> keys = jedis.keys(service);
29: if (keys != null && !keys.isEmpty()) {
30: // æŒ‰ç…§æœåŠ¡èšåˆ URL é›†åˆ
31: Map<String, Set<String>> serviceKeys = new HashMap<String, Set<String>>(); // Keyï¼šRoot + Service ; Valueï¼šURL ã€‚
32: for (String key : keys) {
33: String serviceKey = toServicePath(key);
34: Set<String> sk = serviceKeys.get(serviceKey);
35: if (sk == null) {
36: sk = new HashSet<String>();
37: serviceKeys.put(serviceKey, sk);
38: }
39: sk.add(key);
40: }
41: // å¾ªç¯ serviceKeys ï¼ŒæŒ‰ç…§æ¯ä¸ª Service å±‚çš„å‘èµ·é€šçŸ¥
42: for (Set<String> sk : serviceKeys.values()) {
43: doNotify(jedis, sk, url, Collections.singletonList(listener));
44: }
45: }
46: // å¤„ç†æŒ‡å®š Service å±‚çš„å‘èµ·é€šçŸ¥
47: } else {
48: doNotify(jedis, jedis.keys(service + Constants.PATH_SEPARATOR + Constants.ANY_VALUE), url, Collections.singletonList(listener));
49: }
50: // æ ‡è®°æˆåŠŸ
51: success = true;
52: // ç»“æŸï¼Œä»…ä»…ä»ä¸€å°æœåŠ¡å™¨è¯»å–æ•°æ®
53: break; // Just read one server's data
54: } finally {
55: jedisPool.returnResource(jedis);
56: }
57: } catch (Throwable t) { // Try the next server
58: exception = new RpcException("Failed to subscribe service from redis registry. registry: " + entry.getKey() + ", service: " + url + ", cause: " + t.getMessage(), t);
59: }
60: }
61: // å¤„ç†å¼‚å¸¸
62: if (exception != null) {
63: if (success) { // è™½ç„¶å‘ç”Ÿå¼‚å¸¸ï¼Œä½†æ˜¯ç»“æœæˆåŠŸ
64: logger.warn(exception.getMessage(), exception);
65: } else { // æœ€ç»ˆæœªæˆåŠŸ
66: throw exception;
67: }
68: }
69: }
```

- ========== ã€ç¬¬ä¸€æ­¥ã€‘Notifier éƒ¨åˆ† ==========
- ç¬¬ 4 è¡Œï¼šè°ƒç”¨

/#toServicePath(url)
æ–¹æ³•ï¼Œè·å¾—æœåŠ¡è·¯å¾„ï¼Œä¾‹å¦‚ï¼š

/dubbo/com.alibaba.dubbo.demo.DemoService
ã€‚

- ç¬¬ 6 è¡Œï¼šè·å¾—é€šçŸ¥å™¨ Notifier å¯¹è±¡ã€‚
- ç¬¬ 8 è‡³ 15 è¡Œï¼šè‹¥ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º Notifier å¯¹è±¡ï¼Œå¹¶è°ƒç”¨

Notifier/#start()
æ–¹æ³•ã€‚

- ========== ã€ç¬¬äºŒæ­¥ã€‘è·å–åˆå§‹åŒ–æ•°æ®ï¼Œå¹¶è¿›è¡Œé€šçŸ¥ ==========
- ç¬¬ 19 è¡Œï¼šå¾ªç¯

jedisPools
ï¼Œå‘ Redis å‘èµ·è®¢é˜…ï¼Œ**ç›´åˆ°ä¸€ä¸ªæˆåŠŸ**ã€‚æˆ‘ä»¬ä¼šçœ‹åˆ°ä»£ç ï¼Œåˆ†æˆ**ä¸¤ä¸ªéƒ¨åˆ†**ã€‚

- ã€ç¬¬äºŒéƒ¨åˆ†ã€‘ç¬¬ 46 è‡³ 49 è¡Œï¼Œé€‚ç”¨æœåŠ¡æä¾›è€…å’ŒæœåŠ¡æ¶ˆè´¹è€…ï¼Œå¤„ç†**æŒ‡å®š** Service å±‚çš„åˆå§‹åŒ–æ•°æ®ï¼š
- ç¬¬ 48 è¡Œï¼šè°ƒç”¨

Jedis/#keys(pattern)
æ–¹æ³•ï¼Œè·å¾—**æŒ‡å®š** Service å±‚ä¸‹çš„æ‰€æœ‰ URL ä»¬ã€‚ä¾‹å¦‚

/dubbo/com.alibaba.dubbo.demo.DemoService//\*
ã€‚

- ç¬¬ 48 è¡Œï¼šè°ƒç”¨

/#doNotify(jedis, keys, url, listeners)
æ–¹æ³•ï¼Œé€šçŸ¥ç›‘å¬å™¨ï¼Œåˆå§‹çš„æ•°æ®ã€‚

- ã€ç¬¬ä¸€éƒ¨åˆ†ã€‘ç¬¬ 25 è‡³ 45 è¡Œï¼Œé€‚ç”¨æ³¨å†Œä¸­å¿ƒï¼Œå¤„ç†**æ‰€æœ‰** Service å±‚çš„åˆå§‹åŒ–æ•°æ®ï¼š
- ç¬¬ 26 è¡Œï¼šæ ‡è®°

admin = true
ã€‚å› ä¸ºï¼Œåªæœ‰æ³¨å†Œä¸­å¿ƒï¼Œæ‰æ¸…ç†è„æ•°æ®ã€‚

- ç¬¬ 28 è¡Œï¼šè°ƒç”¨

Jedis/#keys(pattern)
æ–¹æ³•ï¼Œè·å¾—**æ‰€æœ‰** Service å±‚ä¸‹çš„æ‰€æœ‰ URL ä»¬ã€‚ä¾‹å¦‚

/dubbo//\*
ã€‚

- ç¬¬ 31 è‡³ 39 è¡Œï¼šæŒ‰ç…§**æœåŠ¡**èšåˆ URL é›†åˆã€‚
- ç¬¬ 42 è‡³ 44 è¡Œï¼šå¾ªç¯

serviceKeys
ï¼Œè°ƒç”¨

/#doNotify(jedis, keys, url, listeners)
æ–¹æ³•ï¼ŒæŒ‰ç…§**æ¯ä¸ª Service å±‚**ï¼Œé€šçŸ¥ç›‘å¬å™¨ï¼Œåˆå§‹çš„æ•°æ®ã€‚æ­¤å¤„ï¼Œå°±å’Œã€ç¬¬ 48 è¡Œã€‘**ç±»ä¼¼**ã€‚

å¦å¤–ï¼Œè®¢é˜…åŠ¨ä½œï¼ˆã€ç¬¬ä¸€æ­¥ã€‘ï¼‰**ä¸€å®š**è¦åœ¨è·å–åˆå§‹åŒ–æ•°æ®ï¼ˆã€ç¬¬äºŒæ­¥ã€‘ï¼‰**ä¹‹å‰**ã€‚å¦‚æœåè¿‡æ¥ï¼Œå¯èƒ½è·å–æ•°æ®å®Œåï¼Œå¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰æ•°æ®çš„å˜æ›´ï¼Œæˆ‘ä»¬å°±æ— æ³•æ”¶åˆ°

register

unregister
çš„äº‹ä»¶ã€‚

### 2.4.1 toServicePath

```
//*/*
/* è·å¾—æœåŠ¡è·¯å¾„
/*
/* Root + Type
/*
/* @param url URL
/* @return æœåŠ¡è·¯å¾„
/*/
private String toServicePath(URL url){
return root + url.getServiceInterface();
}
```

### 2.4.2 toServicePath

```
//*/*
/* è·å¾—æœåŠ¡è·¯å¾„ï¼Œä¸»è¦æˆªæ‰å¤šä½™çš„éƒ¨åˆ†
/*
/* Root + Type
/*
/* @param categoryPath åˆ†ç±»è·¯å¾„
/* @return æœåŠ¡è·¯å¾„
/*/
private String toServicePath(String categoryPath){
int i;
if (categoryPath.startsWith(root)) {
i = categoryPath.indexOf(Constants.PATH_SEPARATOR, root.length());
} else {
i = categoryPath.indexOf(Constants.PATH_SEPARATOR);
}
return i > 0 ? categoryPath.substring(0, i) : categoryPath;
}
```

## 2.5 doUnsubscribe

```
@Override
public void doUnsubscribe(URL url, NotifyListener listener){
}
```

- æ­¤å¤„ç›®å‰å¹¶æœªå®ç°ï¼Œè‰¿è‰¿è§‰å¾—ï¼Œæ­¤å¤„åº”è¯¥å¢åŠ å–æ¶ˆå‘ Redis çš„è®¢é˜…( Subscribe ) ã€‚åœ¨ ZookeeperRegistry çš„è¯¥æ–¹æ³•ä¸­ï¼Œæ˜¯ç§»é™¤äº†å¯¹åº”çš„ç›‘å¬å™¨ã€‚

## 2.6 doNotify

```
1: // @params key åˆ†ç±»æ•°ç»„ï¼Œä¾‹å¦‚ï¼š`/dubbo/com.alibaba.dubbo.demo.DemoService/providers`
2: private void doNotify(Jedis jedis, String key){
3: for (Map.Entry<URL, Set<NotifyListener>> entry : new HashMap<URL, Set<NotifyListener>>(getSubscribed()).entrySet()) {
4: doNotify(jedis, Collections.singletonList(key), entry.getKey(), new HashSet<NotifyListener>(entry.getValue()));
5: }
6: }
7:
8: // @params keys åˆ†ç±»æ•°ç»„ï¼Œå…ƒç´ ä¾‹å¦‚ï¼š`/dubbo/com.alibaba.dubbo.demo.DemoService/providers`
9: private void doNotify(Jedis jedis, Collection<String> keys, URL url, Collection<NotifyListener> listeners){
10: if (keys == null || keys.isEmpty() || listeners == null || listeners.isEmpty()) {
11: return;
12: }
13: long now = System.currentTimeMillis();
14: List<URL> result = new ArrayList<URL>();
15: List<String> categories = Arrays.asList(url.getParameter(Constants.CATEGORY_KEY, new String[0])); // åˆ†ç±»æ•°ç»„
16: String consumerService = url.getServiceInterface(); // æœåŠ¡æ¥å£
17: // å¾ªç¯åˆ†ç±»å±‚ï¼Œä¾‹å¦‚ï¼š`/dubbo/com.alibaba.dubbo.demo.DemoService/providers`
18: for (String key : keys) {
19: // è‹¥æœåŠ¡ä¸åŒ¹é…ï¼Œè¿”å›
20: if (!Constants.ANY_VALUE.equals(consumerService)) {
21: String providerService = toServiceName(key);
22: if (!providerService.equals(consumerService)) {
23: continue;
24: }
25: }
26: // è‹¥è®¢é˜…çš„ä¸åŒ…å«è¯¥åˆ†ç±»ï¼Œè¿”å›
27: String category = toCategoryName(key);
28: if (!categories.contains(Constants.ANY_VALUE) && !categories.contains(category)) {
29: continue;
30: }
31: // è·å¾—æ‰€æœ‰ URL æ•°ç»„
32: List<URL> urls = new ArrayList<URL>();
33: Map<String, String> values = jedis.hgetAll(key);
34: if (values != null && values.size() > 0) {
35: for (Map.Entry<String, String> entry : values.entrySet()) {
36: URL u = URL.valueOf(entry.getKey());
37: if (!u.getParameter(Constants.DYNAMIC_KEY, true) // éåŠ¨æ€èŠ‚ç‚¹ï¼Œå› ä¸ºåŠ¨æ€èŠ‚ç‚¹ï¼Œä¸å—è¿‡æœŸçš„é™åˆ¶
38: || Long.parseLong(entry.getValue()) >= now) { // æœªè¿‡æœŸ
39: if (UrlUtils.isMatch(url, u)) {
40: urls.add(u);
41: }
42: }
43: }
44: }
45: // è‹¥ä¸å­˜åœ¨åŒ¹é…ï¼Œåˆ™åˆ›å»º `empty://` çš„ URLè¿”å›ï¼Œç”¨äºæ¸…ç©ºè¯¥æœåŠ¡çš„è¯¥åˆ†ç±»ã€‚
46: if (urls.isEmpty()) {
47: urls.add(url.setProtocol(Constants.EMPTY_PROTOCOL)
48: .setAddress(Constants.ANYHOST_VALUE)
49: .setPath(toServiceName(key))
50: .addParameter(Constants.CATEGORY_KEY, category));
51: }
52: result.addAll(urls);
53: if (logger.isInfoEnabled()) {
54: logger.info("redis notify: " + key + " = " + urls);
55: }
56: }
57: if (result.isEmpty()) {
58: return;
59: }
60: // å…¨é‡æ•°æ®è·å–å®Œæˆæ—¶ï¼Œè°ƒç”¨ `super/#notify(...)` æ–¹æ³•ï¼Œå›è°ƒ NotifyListener
61: for (NotifyListener listener : listeners) {
62: super.notify(url, listener, result);
63: }
64: }
```

- ä¸¤ä¸ªé‡è½½çš„

/#doNotify(...)
æ–¹æ³•ï¼Œä¸»è¦å·®å¼‚ç‚¹åœ¨å‰è€…å°‘

url
å’Œ

listeners
æ–¹æ³•å‚æ•°ã€‚æ‰€ä»¥ï¼š

- ç¬¬ 3 è¡Œï¼šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è°ƒç”¨

/#getSubscribed()
æ–¹æ³•ï¼Œè·å¾—**æ‰€æœ‰**ç›‘å¬å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
//*/*
/* è®¢é˜… URL çš„ç›‘å¬å™¨é›†åˆ
/*
/* keyï¼šè®¢é˜…è€…çš„ URL ï¼Œä¾‹å¦‚æ¶ˆè´¹è€…çš„ URL
/*/
private final ConcurrentMap<URL, Set<NotifyListener>> subscribed = new ConcurrentHashMap<URL, Set<NotifyListener>>();
```

- x
- ç¬¬ 3 è‡³ 5 è¡Œï¼š**å¾ªç¯**è°ƒç”¨

/#doNotify(jedis, keys, url, listeners)
æ–¹æ³•ï¼Œè¿›è¡Œé€šçŸ¥ã€‚**ä½†æ˜¯å‘¢**ï¼Ÿè¿™æ ·ä¸€æ¥ï¼Œé€šçŸ¥çš„äº‹ä»¶(

key
)å’Œç›‘å¬å™¨æœªå¿…åŒ¹é…ï¼Œå› æ­¤åœ¨ã€ç¬¬ 20 è‡³ 30 è¡Œã€‘çš„ä»£ç ï¼Œè¿›è¡ŒåŒ¹é…ã€‚

- ç¬¬ 15 è¡Œï¼šè·å¾—åˆ†ç±»å±‚( Category )ï¼Œå³åˆ†ç±»æ•°ç»„ã€‚åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒï¼ˆäºŒï¼‰ä¹‹ Zookeeperã€‹ã€Œ4. è°ƒç”¨ã€](http://svip.iocoder.cn/Dubbo/registry-zookeeper/?self) å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°ï¼Œä¸åŒè§’è‰²å…³æ³¨ä¸åŒçš„åˆ†ç±»æ•°æ®ã€‚

- æœåŠ¡æ¶ˆè´¹è€…ï¼Œå…³æ³¨

providers

configurations

routes
ã€‚

- æœåŠ¡æä¾›è€…ï¼Œå…³æ³¨

consumers
ã€‚

- ç›‘æ§ä¸­å¿ƒï¼Œå…³æ³¨æ‰€æœ‰ã€‚
- ç¬¬ 18 è¡Œï¼šå¾ªç¯åˆ†ç±»å±‚ï¼Œå³æ¯ä¸ªå…ƒç´ ä¸º Root + Service + Type ï¼Œä¾‹å¦‚ï¼š

/dubbo/com.alibaba.dubbo.demo.DemoService/providers
ã€‚

- ç¬¬ 32 è‡³ 44 è¡Œï¼šè°ƒç”¨

Jedis/#hgetAll(key)
æ–¹æ³•ï¼Œè·å¾—æ‰€æœ‰ URL æ•°ç»„ã€‚å¹¶ä¸”ï¼Œè·å–å®Œæˆåï¼Œä¼šè¿‡æ»¤æ‰**å·²è¿‡æœŸ**çš„**åŠ¨æ€**èŠ‚ç‚¹ã€‚

- ç¬¬ 45 è‡³ 51 è¡Œï¼šè‹¥ä¸å­˜åœ¨åŒ¹é…ï¼Œåˆ™åˆ›å»º

empty://
çš„ URL è¿”å›ï¼Œç”¨äº**æ¸…ç©º**è¯¥æœåŠ¡çš„è¯¥åˆ†ç±»ã€‚

- ç¬¬ 52 è¡Œï¼šæ·»åŠ åˆ°

result
ä¸­ã€‚

- ç¬¬ 60 è‡³ 63 è¡Œï¼šå…¨é‡æ•°æ®è·å–å®Œæˆæ—¶ï¼Œè°ƒç”¨

super/#notify(...)
æ–¹æ³•ï¼Œå›è°ƒ NotifyListener ã€‚è¯¥æ–¹æ³•ï¼Œåœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹](http://svip.iocoder.cn/Dubbo/registry-api/?self) æœ‰è¯¦ç»†è§£æã€‚

### 2.6.1 toServiceName

```
//*/*
/* è·å¾—æœåŠ¡åï¼Œä»æœåŠ¡è·¯å¾„ä¸Š
/*
/* Service
/*
/* @param categoryPath æœåŠ¡è·¯å¾„
/* @return æœåŠ¡å
/*/
private String toServiceName(String categoryPath){
String servicePath = toServicePath(categoryPath);
return servicePath.startsWith(root) ? servicePath.substring(root.length()) : servicePath;
}
```

### 2.6.2 toCategoryName

```
//*/*
/* è·å¾—åˆ†ç±»åï¼Œä»åˆ†ç±»è·¯å¾„ä¸Š
/*
/* Type
/*
/* @param categoryPath åˆ†ç±»è·¯å¾„
/* @return åˆ†ç±»å
/*/
private String toCategoryName(String categoryPath){
int i = categoryPath.lastIndexOf(Constants.PATH_SEPARATOR);
return i > 0 ? categoryPath.substring(i + 1) : categoryPath;
}
```

## 2.7 deferExpired

```
1: private void deferExpired(){
2: for (Map.Entry<String, JedisPool> entry : jedisPools.entrySet()) {
3: JedisPool jedisPool = entry.getValue();
4: try {
5: Jedis jedis = jedisPool.getResource();
6: try {
7: // å¾ªç¯å·²æ³¨å†Œçš„ URL é›†åˆ
8: for (URL url : new HashSet<URL>(getRegistered())) {
9: // åŠ¨æ€èŠ‚ç‚¹
10: if (url.getParameter(Constants.DYNAMIC_KEY, true)) {
11: // è·å¾—åˆ†ç±»è·¯å¾„
12: String key = toCategoryPath(url);
13: // å†™å…¥ Redis Map ä¸­
14: if (jedis.hset(key, url.toFullString(), String.valueOf(System.currentTimeMillis() + expirePeriod)) == 1) {
15: // å‘å¸ƒ `register` äº‹ä»¶ã€‚
16: jedis.publish(key, Constants.REGISTER);
17: }
18: }
19: }
20: // ç›‘æ§ä¸­å¿ƒè´Ÿè´£åˆ é™¤è¿‡æœŸè„æ•°æ®
21: if (admin) {
22: clean(jedis);
23: }
24: // å¦‚æœæœåŠ¡å™¨ç«¯å·²åŒæ­¥æ•°æ®ï¼Œåªéœ€å†™å…¥å•å°æœºå™¨
25: if (!replicate) {
26: break;// If the server side has synchronized data, just write a single machine
27: }
28: } finally {
29: jedisPool.returnResource(jedis);
30: }
31: } catch (Throwable t) {
32: logger.warn("Failed to write provider heartbeat to redis registry. registry: " + entry.getKey() + ", cause: " + t.getMessage(), t);
33: }
34: }
35: }
```

- è¢«

expireExecutor
ä¸­çš„å®šæ—¶è°ƒç”¨ï¼Œæ•´ä½“é€»è¾‘ç±»ä¼¼

/#doRegister()
æ–¹æ³•ã€‚

- ç¬¬ 8 è¡Œï¼šè°ƒç”¨

/#getRegistered()
æ–¹æ³•ï¼Œè·å¾—å·²æ³¨å†Œçš„ URL é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š

```
//*/*
/* å·²æ³¨å†Œ URL é›†åˆã€‚
/*
/* æ³¨æ„ï¼Œæ³¨å†Œçš„ URL ä¸ä»…ä»…å¯ä»¥æ˜¯æœåŠ¡æä¾›è€…çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡æ¶ˆè´¹è€…çš„
/*/
private final Set<URL> registered = new ConcurrentHashSet<URL>();
```

- ç¬¬ 8 è¡Œï¼šå¾ªç¯ URL é›†åˆã€‚
- ç¬¬ 10 è¡Œï¼šåˆ¤æ–­æ˜¯å¦ä¸º**åŠ¨æ€**èŠ‚ç‚¹ï¼Œåªæœ‰åŠ¨æ€èŠ‚ç‚¹éœ€è¦å»¶é•¿è¿‡æœŸæ—¶é—´ã€‚
- ç¬¬ 14 è¡Œï¼šè°ƒç”¨

Jedis/#hset(key, value, expire)
æ–¹æ³•ï¼Œå†™å…¥ Redis Map ä¸­ã€‚**æ³¨æ„ï¼Œè¿‡æœŸæ—¶é—´ï¼Œä½œä¸º Map çš„å€¼**ã€‚

- ç¬¬ 16 è¡Œï¼šè‹¥ã€ç¬¬ 14 è¡Œã€‘å†™å…¥è¿”å›çš„å€¼ä¸º 1 ï¼Œè¯´æ˜ Map ä¸­è¯¥é”®å¯¹åº”çš„å€¼ä¸å­˜åœ¨ï¼ˆä¾‹å¦‚ï¼Œå¤šå†™ Redis èŠ‚ç‚¹æ—¶ï¼Œæœ‰ä¸ªèŠ‚ç‚¹å†™å…¥å¤±è´¥ï¼‰ï¼Œå‘å¸ƒ

register
äº‹ä»¶ã€‚

- ç¬¬ 21 è‡³ 23 è¡Œï¼šè‹¥æ˜¯æ³¨å†Œä¸­å¿ƒ(

admin = true
) æ—¶ï¼Œè°ƒç”¨

/#clean(Jedis)
æ–¹æ³•ï¼Œæ¸…ç†è¿‡æœŸè„æ•°æ®ã€‚

- ç¬¬ 25 è‡³ 27 è¡Œï¼šå¦‚æœæœåŠ¡å™¨ç«¯å·²åŒæ­¥æ•°æ®ï¼Œåªéœ€å†™å…¥å•å°æœºå™¨ã€‚

### 2.7.1 clean

```
private void clean(Jedis jedis){
// è·å¾—æ‰€æœ‰æœåŠ¡
Set<String> keys = jedis.keys(root + Constants.ANY_VALUE);
if (keys != null && !keys.isEmpty()) {
for (String key : keys) {
// è·å¾—æ‰€æœ‰ URL
Map<String, String> values = jedis.hgetAll(key);
if (values != null && values.size() > 0) {
boolean delete = false;
long now = System.currentTimeMillis();
for (Map.Entry<String, String> entry : values.entrySet()) {
URL url = URL.valueOf(entry.getKey());
// åŠ¨æ€èŠ‚ç‚¹
if (url.getParameter(Constants.DYNAMIC_KEY, true)) {
long expire = Long.parseLong(entry.getValue());
// å·²ç»è¿‡æœŸ
if (expire < now) {
//
jedis.hdel(key, entry.getKey());
delete = true;
if (logger.isWarnEnabled()) {
logger.warn("Delete expired key: " + key + " -> value: " + entry.getKey() + ", expire: " + new Date(expire) + ", now: " + new Date(now));
}
}
}
}
// è‹¥åˆ é™¤æˆåŠŸï¼Œå‘å¸ƒ `unregister` äº‹ä»¶
if (delete) {
jedis.publish(key, Constants.UNREGISTER);
}
}
}
}
}
```

- æ•´ä½“é€»è¾‘ç±»ä¼¼

/#doUnregister()
æ–¹æ³•ã€‚

- ğŸ™‚ èƒ–å‹è‡ªå·±çœ‹æ–¹æ³•çš„æ³¨é‡Šå“ˆã€‚

## 2.8 isAvailable

```
@Override
public boolean isAvailable(){
for (JedisPool jedisPool : jedisPools.values()) {
try {
Jedis jedis = jedisPool.getResource();
try {
if (jedis.isConnected()) { // è‡³å°‘ä¸€ä¸ª Redis èŠ‚ç‚¹å¯ç”¨
return true; // At least one single machine is available.
}
} finally {
jedisPool.returnResource(jedis);
}
} catch (Throwable ignored) {
}
}
return false;
}
```

## 2.9 destroy

```
@Override
public void destroy(){
// çˆ¶ç±»å…³é—­
super.destroy();
// å…³é—­å®šæ—¶ä»»åŠ¡
try {
expireFuture.cancel(true);
} catch (Throwable t) {
logger.warn(t.getMessage(), t);
}
// å…³é—­é€šçŸ¥å™¨
try {
for (Notifier notifier : notifiers.values()) {
notifier.shutdown();
}
} catch (Throwable t) {
logger.warn(t.getMessage(), t);
}
// å…³é—­è¿æ¥æ± 
for (Map.Entry<String, JedisPool> entry : jedisPools.entrySet()) {
JedisPool jedisPool = entry.getValue();
try {
jedisPool.destroy();
} catch (Throwable t) {
logger.warn("Failed to destroy the redis registry client. registry: " + entry.getKey() + ", cause: " + t.getMessage(), t);
}
}
}
```

# 3. Notifier

Notifier æ˜¯ RedisRegistry çš„å†…éƒ¨ç±»ã€‚

Notifier ï¼Œç»§æ‰¿ Thread ç±»ï¼Œè´Ÿè´£å‘ Redis å‘èµ·è®¢é˜…é€»è¾‘ã€‚

## 3.1 æ„é€ æ–¹æ³•

```
1: //*/*
2: /* æœåŠ¡å Root + Service
3: /*/
4: private final String service;
5: //*/*
6: /* Jedis
7: /*/
8: private volatile Jedis jedis;
9: //*/*
10: /* æ˜¯å¦é¦–æ¬¡
11: /*/
12: private volatile boolean first = true;
13: //*/*
14: /* æ˜¯å¦è¿è¡Œä¸­
15: /*/
16: private volatile boolean running = true;
17: //*/*
18: /* è¿æ¥æ¬¡æ•°éšæœºæ•°
19: /*/
20: private volatile int connectRandom;
21: //*/*
22: /* éœ€è¦å¿½ç•¥è¿æ¥çš„æ¬¡æ•°
23: /*/
24: private final AtomicInteger connectSkip = new AtomicInteger();
25: //*/*
26: /* å·²ç»å¿½ç•¥è¿æ¥çš„æ¬¡æ•°
27: /*/
28: private final AtomicInteger connectSkiped = new AtomicInteger();
29: //*/*
30: /* éšæœº
31: /*/
32: private final Random random = new Random();
```

- service
  å±æ€§ï¼ŒæœåŠ¡å Root + Serviceã€‚
- first
  å±æ€§ï¼Œæ˜¯å¦é¦–æ¬¡ã€‚åœ¨

/#run()
æ–¹æ³•ä¸­ï¼ŒæŸ¥çœ‹ã€‚

- ã€ç¬¬ 13 è‡³ 32 è¡Œã€‘çš„å±æ€§ï¼Œç›¸å½“äº**é‡è¿ç­–ç•¥**ï¼Œç”¨äºå’Œ Redis æ–­å¼€æ—¶ï¼Œå¿½ç•¥ä¸€å®šæ¬¡æ•°å’Œ Redis çš„è¿æ¥ï¼Œé¿å…ç©ºè·‘ã€‚æ¶‰åŠæ–¹æ³•å¦‚ä¸‹ï¼š

- /#isSkip()
  æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å¿½ç•¥æœ¬æ¬¡å¯¹ Redis çš„è¿æ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: private boolean isSkip(){
2: // è·å¾—éœ€è¦å¿½ç•¥è¿æ¥çš„æ€»æ¬¡æ•°ã€‚å¦‚æœè¶…è¿‡ 10 ï¼Œåˆ™åŠ ä¸Šä¸€ä¸ª 10 ä»¥å†…çš„éšæœºæ•°ã€‚
3: int skip = connectSkip.get(); // Growth of skipping times
4: if (skip >= 10) { // If the number of skipping times increases by more than 10, take the random number
5: if (connectRandom == 0) {
6: connectRandom = random.nextInt(10);
7: }
8: skip = 10 + connectRandom;
9: }
10: // è‡ªå¢å¿½ç•¥æ¬¡æ•°ã€‚è‹¥å¿½ç•¥æ¬¡æ•°ä¸å¤Ÿï¼Œåˆ™ç»§ç»­å¿½ç•¥ã€‚
11: if (connectSkiped.getAndIncrement() < skip) { // Check the number of skipping times
12: return true;
13: }
14: // å¢åŠ éœ€è¦å¿½ç•¥çš„æ¬¡æ•°
15: connectSkip.incrementAndGet();
16: // é‡ç½®å·²å¿½ç•¥æ¬¡æ•°å’Œéšæœºæ•°
17: connectSkiped.set(0);
18: connectRandom = 0;
19: return false;
20: }
```

- ç¬¬ 2 è‡³ 9 è¡Œï¼šè·å¾—**éœ€è¦å¿½ç•¥è¿æ¥çš„æ€»æ¬¡æ•°**ã€‚å¦‚æœè¶…è¿‡ 10 ï¼Œåˆ™åŠ ä¸Šä¸€ä¸ª 10 ä»¥å†…çš„éšæœºæ•°ã€‚æ€è·¯æ˜¯ï¼Œè¿æ¥å¤±è´¥çš„æ¬¡æ•°è¶Šå¤šï¼Œ**æ¯ä¸€è½®**åŠ å¤§éœ€è¦å¿½ç•¥çš„æ€»æ¬¡æ•°ï¼Œå¹¶ä¸”å¸¦æœ‰ä¸€å®šçš„éšæœºæ€§ã€‚
- ç¬¬ 10 è‡³ 13 è¡Œï¼šè‡ªå¢å¿½ç•¥æ¬¡æ•°ã€‚è‹¥å¿½ç•¥æ¬¡æ•°ä¸å¤Ÿï¼Œåˆ™ç»§ç»­å¿½ç•¥ï¼Œå³è¿”å›

true
ã€‚

- ç¬¬ 15 è¡Œï¼šå¢åŠ éœ€è¦å¿½ç•¥çš„æ¬¡æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ**ä¸‹ä¸€è½®**ï¼Œä¸è€ƒè™‘éšæœºæ•°ï¼Œä¼šå¤šä¸€æ¬¡ã€‚å¦‚ä¸‹æ˜¯ä¸€æ¬¡æ¨¡æ‹Ÿï¼š
  ç¬¬ä¸€è½®

- connectSkip: 0; connectSkiped: 0

ç¬¬äºŒè½®

- connectSkip: 1; connectSkiped: 0
- connectSkip: 1; connectSkiped: 1

ç¬¬ä¸‰è½®

- connectSkip: 2; connectSkiped: 0
- connectSkip: 2; connectSkiped: 1
- connectSkip: 2; connectSkiped: 2

- å½“è¶…è¿‡åè½®åï¼Œå¢åŠ éšæœºæ•°ã€‚
- ç¬¬ 16 è‡³ 18 è¡Œï¼šé‡ç½®å·²å¿½ç•¥æ¬¡æ•°å’Œéšæœºæ•°ã€‚
- /#resetSkip()
  æ–¹æ³•ï¼Œé‡ç½®å¿½ç•¥è¿æ¥çš„ä¿¡æ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
private void resetSkip(){
// é‡ç½®éœ€è¦è¿æ¥çš„æ¬¡æ•°
connectSkip.set(0);
// é‡ç½®å·²å¿½ç•¥æ¬¡æ•°å’Œéšæœºæ•°
connectSkiped.set(0);
connectRandom = 0;
}
```

- x

## 3.2 run

```
1: @Override
2: public void run(){
3: while (running) {
4: try {
5: // æ˜¯å¦è·³è¿‡æœ¬æ¬¡ Redis è¿æ¥
6: if (!isSkip()) {
7: try {
8: for (Map.Entry<String, JedisPool> entry : jedisPools.entrySet()) {
9: JedisPool jedisPool = entry.getValue();
10: try {
11: jedis = jedisPool.getResource();
12: try {
13: // ç›‘æ§ä¸­å¿ƒ
14: if (service.endsWith(Constants.ANY_VALUE)) {
15: if (!first) {
16: first = false;
17: Set<String> keys = jedis.keys(service);
18: if (keys != null && !keys.isEmpty()) {
19: for (String s : keys) {
20: doNotify(jedis, s);
21: }
22: }
23: resetSkip();
24: }
25: // æ‰¹è®¢é˜…
26: jedis.psubscribe(new NotifySub(jedisPool), service); // blocking
27: // æœåŠ¡æä¾›è€…æˆ–æ¶ˆè´¹è€…
28: } else {
29: if (!first) {
30: first = false;
31: doNotify(jedis, service);
32: resetSkip();
33: }
34: // æ‰¹è®¢é˜…
35: jedis.psubscribe(new NotifySub(jedisPool), service + Constants.PATH_SEPARATOR + Constants.ANY_VALUE); // blocking
36: }
37: break;
38: } finally {
39: jedisPool.returnBrokenResource(jedis);
40: }
41: } catch (Throwable t) { // Retry another server
42: logger.warn("Failed to subscribe service from redis registry. registry: " + entry.getKey() + ", cause: " + t.getMessage(), t);
43: // If you only have a single redis, you need to take a rest to avoid overtaking a lot of CPU resources
44: sleep(reconnectPeriod);
45: }
46: }
47: } catch (Throwable t) {
48: logger.error(t.getMessage(), t);
49: sleep(reconnectPeriod);
50: }
51: }
52: } catch (Throwable t) {
53: logger.error(t.getMessage(), t);
54: }
55: }
56: }
```

- ç¬¬ 3 è¡Œï¼šå¾ªç¯æ‰§è¡Œï¼Œç›´åˆ°å…³é—­ã€‚
- ç¬¬ 6 è¡Œï¼šè°ƒç”¨

/#isSkip()
æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦è·³è¿‡æœ¬æ¬¡ Redis è¿æ¥ã€‚But ï¼Œå³ä½¿è·³è¿‡ï¼Œä¹Ÿæ²¡æœ‰æ‰§è¡Œç±»ä¼¼ sleep çš„é€»è¾‘ï¼Œæœ‰ç‚¹å¥‡æ€ªã€‚è¿™æ ·ï¼Œä¼šå¯¼è‡´å®é™…å³ä½¿è·³è¿‡ï¼Œä¹Ÿä¼šå¿«é€Ÿå‘ Redis å‘èµ·è®¢é˜…ã€‚ã€TODO 8032ã€‘Redis é‡è¿é€»è¾‘

- ç¬¬ 8 è¡Œï¼šå¾ªç¯è¿æ¥æ± ï¼Œå‘èµ·è®¢é˜…ï¼Œç›´åˆ°**ä¸€ä¸ªæˆåŠŸ**ã€‚
- ======================================================
- ã€ç¬¬ä¸€ç§æƒ…å†µã€‘ç¬¬ 14 è‡³ 26 è¡Œï¼šç›‘æ§ä¸­å¿ƒ

- ç¬¬ 15 è‡³ 24 è¡Œï¼šç›®å‰è¿™å—ä»£ç æœ‰ä¸€äº›é—®é¢˜ï¼Ÿï¼åˆå§‹æ—¶

first=true
ï¼Œé‚£ä¹ˆè¿™å—ä»£ç æ°¸è¿œæ— æ³•æ‰§è¡Œåˆ°ã€‚ç¬”è€…çŒœæµ‹è¿™å—çš„æ„å›¾æ˜¯ï¼Œåœ¨ ZookeeperRegistry ä¸­ï¼Œå¯ä»¥å®ç°å¯¹è¿æ¥çŠ¶æ€çš„ç›‘å¬ï¼Œä»è€Œå®ç°æ–­å¼€é‡è¿æˆåŠŸåï¼Œä» Zookeeper è·å–åˆ°æœ€æ–°çš„æ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
zkClient.addStateListener(new StateListener() {
public void stateChanged(int state){
if (state == RECONNECTED) {
try {
recover();
} catch (Exception e) {
logger.error(e.getMessage(), e);
}
}
}
});
```

/_ è€Œ JedisPool ä¸­ï¼Œä¸æä¾›è¿™æ ·çš„è¿æ¥ç›‘æ§æœºåˆ¶ã€‚é‚£ä¹ˆå¦‚æœè®¢é˜… Redis å‘ç”Ÿäº†å¼‚å¸¸ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸º Redis è¿æ¥æ–­å¼€äº†ï¼Œéœ€è¦é‡æ–°å‘èµ·è®¢é˜…ï¼Œå¹¶ä¸”éœ€è¦/_/_é‡æ–°/_/_ä» Redis ä¸­è·å–åˆ°æœ€æ–°çš„æ•°æ®ã€‚
/_ é‚£ä¹ˆæ­¤å¤„çš„ä»£ç å¯ä»¥è¿™æ ·æ”¹ï¼š
/_ ç¬¬ 16 è¡Œï¼š `first = true;`
/_ ç¬¬ 42 è¡Œï¼šå¢åŠ  `first = false;`
/_ ç¬¬ 26 è¡Œï¼šè°ƒç”¨ `Jedis/#psubscribe(JedisPubSub jedisPubSub, String... patterns)` æ–¹æ³•ï¼Œè®¢é˜…/_/_æ‰€æœ‰ Service å±‚/_/_ã€‚
/_ ã€ç¬¬äºŒç§æƒ…å†µã€‘ç¬¬ 27 è‡³ 36 è¡Œï¼šæœåŠ¡æä¾›è€…æˆ–æ¶ˆè´¹è€…ã€‚
/_ ç¬¬ 29 è‡³ 34 è¡Œï¼šå’Œã€ç¬¬ 15 è‡³ 24 è¡Œã€‘/_/_ç±»ä¼¼/_/_ã€‚
/_ ç¬¬ 35 è¡Œï¼šè°ƒç”¨ `Jedis/#psubscribe(JedisPubSub jedisPubSub, String... patterns)` æ–¹æ³•ï¼Œè®¢é˜…/*/*æŒ‡å®š Service å±‚/_/_ã€‚
/_ ======================================================
/_ ç¬¬ 37 è‡³ 40 è¡Œï¼šæ— æ³•æ‰§è¡Œåˆ°ï¼Œå› ä¸º `Jedis/#psubscribe(JedisPubSub jedisPubSub, String... patterns)` æ–¹æ³•ï¼Œæ˜¯/*/*é˜»å¡/*/*çš„ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Notifier æ˜¯ä¸€ä¸ª /*/*Thread/_/_ çš„åŸå› ã€‚
/\* ç¬¬ 41 è‡³ 45 è¡Œï¼šå‘ç”Ÿå¼‚å¸¸ï¼Œè¯´æ˜ Redis è¿æ¥æ–­å¼€äº†ã€‚å› æ­¤ï¼Œè°ƒç”¨ `/#sleep(millis)` æ–¹æ³•ï¼Œç­‰å¾… Redis é‡è¿æˆåŠŸã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œé¿å…æ‰§è¡Œï¼Œå ç”¨å¤§é‡çš„ CPU èµ„æºã€‚
/#/# 3.3 shutdown

```Java
public void shutdown(){
try {
// åœæ­¢è¿è¡Œ
running = false;
// Jedis æ–­å¼€è¿æ¥
jedis.disconnect();
} catch (Throwable t) {
logger.warn(t.getMessage(), t);
}
}
```

# 4. NotifySub

NotifySub æ˜¯ RedisRegistry çš„å†…éƒ¨ç±»ã€‚

NotifySub ï¼Œå®ç°

redis.clients.jedis.JedisPubSub
æŠ½è±¡ç±»ï¼Œé€šçŸ¥è®¢é˜…å®ç°ç±»ã€‚

```
1: private class NotifySub extends JedisPubSub{
2:
3: private final JedisPool jedisPool;
4:
5: public NotifySub(JedisPool jedisPool){
6: this.jedisPool = jedisPool;
7: }
8:
9: @Override
10: public void onMessage(String key, String msg){
11: if (logger.isInfoEnabled()) {
12: logger.info("redis event: " + key + " = " + msg);
13: }
14: if (msg.equals(Constants.REGISTER)
15: || msg.equals(Constants.UNREGISTER)) {
16: try {
17: Jedis jedis = jedisPool.getResource();
18: try {
19: doNotify(jedis, key);
20: } finally {
21: jedisPool.returnResource(jedis);
22: }
23: } catch (Throwable t) { // TODO Notification failure does not restore mechanism guarantee
24: logger.error(t.getMessage(), t);
25: }
26: }
27: }
28:
29: @Override
30: public void onPMessage(String pattern, String key, String msg){
31: onMessage(key, msg);
32: }
33:
34: @Override
35: public void onSubscribe(String key, int num){
36: }
37:
38: @Override
39: public void onPSubscribe(String pattern, int num){
40: }
41:
42: @Override
43: public void onUnsubscribe(String key, int num){
44: }
45:
46: @Override
47: public void onPUnsubscribe(String pattern, int num){
48: }
49:
50: }
```

- å®ç°äº†

/#onMessage(key, msg)
å’Œ

/#onPMessage(pattern, key, msg)
æ–¹æ³•ï¼Œæ”¶åˆ°

register

unregister
äº‹ä»¶ï¼Œè°ƒç”¨

/#doNotify(jedis, key)
æ–¹æ³•ï¼Œé€šçŸ¥ç›‘å¬å™¨ï¼Œæ•°æ®å˜åŒ–ï¼Œä»è€Œå®ç°**å®æ—¶**æ›´æ–°ã€‚

# 5. å¯é æ€§

FROM [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” Redis æ³¨å†Œä¸­å¿ƒã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/registry/redis.html)

é˜¿é‡Œå†…éƒ¨å¹¶æ²¡æœ‰é‡‡ç”¨ Redis åšä¸ºæ³¨å†Œä¸­å¿ƒï¼Œè€Œæ˜¯ä½¿ç”¨è‡ªå·±å®ç°çš„åŸºäºæ•°æ®åº“çš„æ³¨å†Œä¸­å¿ƒï¼Œå³ï¼šRedis æ³¨å†Œä¸­å¿ƒå¹¶æ²¡æœ‰åœ¨é˜¿é‡Œå†…éƒ¨é•¿æ—¶é—´è¿è¡Œçš„å¯é æ€§ä¿éšœï¼Œæ­¤ Redis æ¡¥æ¥å®ç°åªä¸ºå¼€æºç‰ˆæœ¬æä¾›ï¼Œå…¶å¯é æ€§ä¾èµ–äº Redis æœ¬èº«çš„å¯é æ€§ã€‚

FROM [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” æˆç†Ÿåº¦ã€‹](http://dubbo.apache.org/zh-cn/docs/user/maturity.html)

Redis æ³¨å†Œä¸­å¿ƒ

- Maturityï¼šStable
- Strengthï¼šæ”¯æŒåŸºäºå®¢æˆ·ç«¯åŒå†™çš„é›†ç¾¤æ–¹å¼ï¼Œæ€§èƒ½é«˜
- Problemï¼šè¦æ±‚æœåŠ¡å™¨æ—¶é—´åŒæ­¥ï¼Œç”¨äºæ£€æŸ¥å¿ƒè·³è¿‡æœŸè„æ•°æ®
- Adviseï¼šå¯ç”¨äºç”Ÿäº§ç¯å¢ƒ

åšä¸ªå°ç¬”è®°ï¼ŒRedis ä¸»ä»å¤åˆ¶çš„æƒ…å†µä¸‹ï¼Œä»èŠ‚ç‚¹çš„è®¢é˜…( Subscribe )ï¼Œå¯ä»¥æ”¶åˆ°ä¸»èŠ‚ç‚¹çš„å‘å¸ƒ( Publish ) ã€‚åšè¿™ä¸ªç¬”è®°çš„åŸå› æ˜¯ï¼ŒåŸæ¥æ‹…å¿ƒ

"failover"
æ¨¡å¼ä¸‹ï¼ŒRedis ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œå¦‚æœè®¢é˜…ä»èŠ‚ç‚¹ï¼Œä¼šä¸ä¼šå‡ºç°ï¼ŒRedis ä¸»èŠ‚ç‚¹æ¢å¤åï¼Œæ”¶ä¸åˆ°åœ¨å…¶ä¸Šçš„å‘å¸ƒäº‹ä»¶ã€‚
