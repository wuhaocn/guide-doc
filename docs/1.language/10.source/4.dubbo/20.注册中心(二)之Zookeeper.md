# æ³¨å†Œä¸­å¿ƒï¼ˆäºŒï¼‰ä¹‹ Zookeeper

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

å‰ç½®é˜…è¯»æ–‡ç« ï¼š

- [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” Zookeeper å®¢æˆ·ç«¯ã€‹](http://svip.iocoder.cn/Dubbo/remoting-zookeeper/?self)
- [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹](http://svip.iocoder.cn/Dubbo/registry-api/?self)

ğŸ˜ˆ åœ¨ã€Šæ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹ ä¸­ï¼Œæˆ‘ä»¬åˆ†äº«çš„é‚£æ˜¯**ç›¸å½“æŠ½è±¡**ã€‚å› æ­¤ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šåˆ†äº« Dubbo ä½¿ç”¨ Zookeeper ä½œä¸ºæ³¨å†Œä¸­å¿ƒçš„ä»£ç ï¼ŒåŒæ—¶ä¹Ÿä¼šåˆ†äº«æœåŠ¡æš´éœ²å’Œå¼•ç”¨æ—¶ï¼Œå¯¹æ³¨å†Œä¸­å¿ƒçš„ä½¿ç”¨ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” zookeeper æ³¨å†Œä¸­å¿ƒã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/registry/zookeeper.html) æ–‡æ¡£ï¼Œå†…å®¹å¦‚ä¸‹ï¼š
![æµç¨‹](http://static2.iocoder.cn/images/Dubbo/2018_08_04/01.png)

æµç¨‹è¯´æ˜ï¼š

- **æœåŠ¡æä¾›è€…**å¯åŠ¨æ—¶: å‘

/dubbo/com.foo.BarService/providers
ç›®å½•ä¸‹å†™å…¥è‡ªå·±çš„ URL åœ°å€

- **æœåŠ¡æ¶ˆè´¹è€…**å¯åŠ¨æ—¶: è®¢é˜…

/dubbo/com.foo.BarService/providers
ç›®å½•ä¸‹çš„æä¾›è€… URL åœ°å€ã€‚å¹¶å‘

/dubbo/com.foo.BarService/consumers
ç›®å½•ä¸‹å†™å…¥è‡ªå·±çš„ URL åœ°å€

- **ç›‘æ§ä¸­å¿ƒ**å¯åŠ¨æ—¶: è®¢é˜…

/dubbo/com.foo.BarService
ç›®å½•ä¸‹çš„æ‰€æœ‰æä¾›è€…å’Œæ¶ˆè´¹è€… URL åœ°å€ã€‚

- åœ¨å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Zookeeper çš„èŠ‚ç‚¹å±‚çº§ï¼Œè‡ªä¸Šè€Œä¸‹æ˜¯ï¼š

- **Root** å±‚ï¼šæ ¹ç›®å½•ï¼Œå¯é€šè¿‡

<dubbo:registry group="dubbo" />
çš„

"group"
è®¾ç½® Zookeeper çš„æ ¹èŠ‚ç‚¹ï¼Œç¼ºçœä½¿ç”¨

"dubbo"
ã€‚

- **Service** å±‚ï¼šæœåŠ¡æ¥å£å…¨åã€‚
- **Type** å±‚ï¼šåˆ†ç±»ã€‚ç›®å‰é™¤äº†æˆ‘ä»¬åœ¨å›¾ä¸­çœ‹åˆ°çš„

"providers"
( æœåŠ¡æä¾›è€…åˆ—è¡¨ )

"consumers"
( æœåŠ¡æ¶ˆè´¹è€…åˆ—è¡¨ ) å¤–ï¼Œè¿˜æœ‰ [
"routes"
](http://dubbo.apache.org/zh-cn/docs/user/demos/routing-rule.html)( è·¯ç”±è§„åˆ™åˆ—è¡¨ ) å’Œ [
"configurations"
](http://dubbo.apache.org/zh-cn/docs/user/demos/config-rule.html)( é…ç½®è§„åˆ™åˆ—è¡¨ )ã€‚

- **URL** å±‚ï¼šURL ï¼Œæ ¹æ®ä¸åŒ Type ç›®å½•ï¼Œä¸‹é¢å¯ä»¥æ˜¯æœåŠ¡æä¾›è€… URL ã€æœåŠ¡æ¶ˆè´¹è€… URL ã€è·¯ç”±è§„åˆ™ URL ã€é…ç½®è§„åˆ™ URL ã€‚
- å®é™…ä¸Š URL ä¸Šå¸¦æœ‰

"category"
å‚æ•°ï¼Œå·²ç»èƒ½åˆ¤æ–­æ¯ä¸ª URL çš„åˆ†ç±»ï¼Œä½†æ˜¯ Zookeeper æ˜¯åŸºäºèŠ‚ç‚¹ç›®å½•è®¢é˜…çš„ï¼Œæ‰€ä»¥å¢åŠ äº† **Type** å±‚ã€‚

- å®é™…ä¸Šï¼Œ**æœåŠ¡æ¶ˆè´¹è€…**å¯åŠ¨åï¼Œä¸ä»…ä»…è®¢é˜…äº†

"providers"
åˆ†ç±»ï¼Œä¹Ÿè®¢é˜…äº†

"routes"

"configurations"
åˆ†ç±»ã€‚

# 2. ZookeeperRegistryFactory

[
com.alibaba.dubbo.registry.zookeeper.ZookeeperRegistryFactory
](https://github.com/YunaiV/dubbo/blob/66a1e1b0ef4b01175be148d27fdcf519f4f01b15/dubbo-registry/dubbo-registry-zookeeper/src/main/java/com/alibaba/dubbo/registry/zookeeper/ZookeeperRegistryFactory.java) ï¼Œå®ç° AbstractRegistryFactory æŠ½è±¡ç±»ï¼ŒZookeeper Registry å·¥å‚ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class ZookeeperRegistryFactory extends AbstractRegistryFactory{
//*/*
/* Zookeeper å·¥å‚
/*/
private ZookeeperTransporter zookeeperTransporter;
//*/*
/* è®¾ç½® Zookeeper å·¥å‚
/*
/* è¯¥æ–¹æ³•ï¼Œé€šè¿‡ Dubbo SPI æ³¨å…¥
/*
/* @param zookeeperTransporter Zookeeper å·¥å‚å¯¹è±¡
/*/
public void setZookeeperTransporter(ZookeeperTransporter zookeeperTransporter){
this.zookeeperTransporter = zookeeperTransporter;
}
@Override
public Registry createRegistry(URL url){
return new ZookeeperRegistry(url, zookeeperTransporter);
}
}
```

# 3. ZookeeperRegistry

[
com.alibaba.dubbo.registry.zookeeper.ZookeeperRegistry
](https://github.com/YunaiV/dubbo/blob/66a1e1b0ef4b01175be148d27fdcf519f4f01b15/dubbo-registry/dubbo-registry-zookeeper/src/main/java/com/alibaba/dubbo/registry/zookeeper/ZookeeperRegistry.java) ï¼Œå®ç° FailbackRegistry æŠ½è±¡ç±»ï¼ŒZookeeper Registry ã€‚

## 3.1 å±æ€§ + æ„é€ æ–¹æ³•

```
1: //*/*
2: /* é»˜è®¤ç«¯å£
3: /*/
4: private final static int DEFAULT_ZOOKEEPER_PORT = 2181;
5: //*/*
6: /* é»˜è®¤ Zookeeper æ ¹èŠ‚ç‚¹
7: /*/
8: private final static String DEFAULT_ROOT = "dubbo";
9:
10: //*/*
11: /* Zookeeper æ ¹èŠ‚ç‚¹
12: /*/
13: private final String root;
14: //*/*
15: /* Service æ¥å£å…¨åé›†åˆ
16: /*/
17: private final Set<String> anyServices = new ConcurrentHashSet<String>();
18: //*/*
19: /* ç›‘å¬å™¨é›†åˆ
20: /*/
21: private final ConcurrentMap<URL, ConcurrentMap<NotifyListener, ChildListener>> zkListeners = new ConcurrentHashMap<URL, ConcurrentMap<NotifyListener, ChildListener>>();
22: //*/*
23: /* Zookeeper å®¢æˆ·ç«¯
24: /*/
25: private final ZookeeperClient zkClient;
26:
27: public ZookeeperRegistry(URL url, ZookeeperTransporter zookeeperTransporter){
28: super(url);
29: if (url.isAnyHost()) {
30: throw new IllegalStateException("registry address == null");
31: }
32: // è·å¾— Zookeeper æ ¹èŠ‚ç‚¹
33: String group = url.getParameter(Constants.GROUP_KEY, DEFAULT_ROOT); // `url.parameters.group` å‚æ•°å€¼
34: if (!group.startsWith(Constants.PATH_SEPARATOR)) {
35: group = Constants.PATH_SEPARATOR + group;
36: }
37: this.root = group;
38: // åˆ›å»º Zookeeper Client
39: zkClient = zookeeperTransporter.connect(url);
40: // æ·»åŠ  StateListener å¯¹è±¡ã€‚è¯¥ç›‘å¬å™¨ï¼Œåœ¨é‡è¿æ—¶ï¼Œè°ƒç”¨æ¢å¤æ–¹æ³•ã€‚
41: zkClient.addStateListener(new StateListener() {
42: public void stateChanged(int state){
43: if (state == RECONNECTED) {
44: try {
45: recover();
46: } catch (Exception e) {
47: logger.error(e.getMessage(), e);
48: }
49: }
50: }
51: });
52: }
```

- root
  å±æ€§ï¼ŒZookeeper æ ¹èŠ‚ç‚¹ï¼Œå³é¦–å›¾çš„ **Root** å±‚ã€‚
- anyServices
  å±æ€§ï¼ŒService æ¥å£æ¥å£å…¨å**é›†åˆ**ã€‚è¯¥å±æ€§é€‚å¯ç”¨äºç›‘æ§ä¸­å¿ƒï¼Œè®¢é˜…**æ•´ä¸ª** **Service** å±‚ã€‚å› ä¸ºï¼ŒService å±‚æ˜¯**åŠ¨æ€**çš„ï¼Œå¯ä»¥æœ‰ä¸æ–­æœ‰æ–°çš„ Service æœåŠ¡å‘å¸ƒï¼ˆæ³¨æ„ï¼Œä¸æ˜¯æœåŠ¡å®ä¾‹ï¼‰ã€‚åœ¨

/#doSubscribe(url, notifyListener)
æ–¹æ³•ä¸­ï¼Œä¼šæ›´å®¹æ˜“ç†è§£ã€‚

- zkListeners
  å±æ€§ï¼Œç›‘å¬å™¨é›†åˆï¼Œå»ºç«‹ NotifyListener å’Œ ChildListener çš„æ˜ å°„å…³ç³»ã€‚
- zkClient
  å±æ€§ï¼ŒZookeeper å®¢æˆ·ç«¯ã€‚
- **æ„é€ æ–¹æ³•**

- ç¬¬ 28 è‡³ 31 è¡Œï¼šè®¾ç½®æ³¨å†Œä¸­å¿ƒçš„ URL ã€‚
- ç¬¬ 32 è‡³ 37 è¡Œï¼šè®¾ç½®åœ¨ Zookeeper çš„æ ¹èŠ‚ç‚¹ï¼Œç¼ºçœä½¿ç”¨

DEFAULT_ROOT
ã€‚

- ç¬¬ 39 è¡Œï¼šè°ƒç”¨

ZookeeperTransporter/#connect(url)
æ–¹æ³•ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼Œæ ¹æ®

url
å‚æ•°ï¼ŒåŠ è½½å¯¹åº”çš„ ZookeeperTransporter å®ç°ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ ZookeeperClient å®ç°ç±»çš„å¯¹åº”ã€‚

- ç¬¬ 41 è‡³ 51 è¡Œï¼šæ·»åŠ  StateListener å¯¹è±¡åˆ° ZookeeperClient å¯¹è±¡ä¸­ã€‚è¯¥ç›‘å¬å™¨ï¼Œåœ¨é‡è¿æ—¶ï¼Œåœ¨ç¬¬ 45 è¡Œçš„ä»£ç ï¼Œè°ƒç”¨

/#recover()
æ–¹æ³•ï¼Œè¿›è¡Œæ¢å¤é€»è¾‘ï¼Œé‡æ–°å‘èµ·æ³¨å†Œå’Œè®¢é˜…ã€‚

## 3.2 doRegister

```
1: @Override
2: protected void doRegister(URL url){
3: try {
4: zkClient.create(toUrlPath(url), url.getParameter(Constants.DYNAMIC_KEY, true));
5: } catch (Throwable e) {
6: throw new RpcException("Failed to register " + url + " to zookeeper " + getUrl() + ", cause: " + e.getMessage(), e);
7: }
8: }
```

- ç¬¬ 4 è¡Œï¼šè°ƒç”¨

/#toUrlPath(url)
æ–¹æ³•ï¼Œè·å¾— URL çš„è·¯å¾„ã€‚

- ç¬¬ 4 è¡Œï¼š

url.parameters.dynamic
ï¼Œæ˜¯å¦åŠ¨æ€æ•°æ®ã€‚è‹¥ä¸º false ï¼Œè¯¥æ•°æ®ä¸º**æŒä¹…æ•°æ®**ï¼Œå½“æ³¨å†Œæ–¹é€€å‡ºæ—¶ï¼Œæ•°æ®ä¾ç„¶ä¿å­˜åœ¨æ³¨å†Œä¸­å¿ƒã€‚

- ç¬¬ 4 è¡Œï¼šè°ƒç”¨

ZookeeperClient/#create(url, ephemeral)
æ–¹æ³•ï¼Œåˆ›å»º URL èŠ‚ç‚¹ï¼Œå³æˆ‘ä»¬åœ¨é¦–å›¾çœ‹åˆ°çš„ **URL å±‚**ã€‚

### 3.2.1 toUrlPath

```
//*/*
/* è·å¾— URL çš„è·¯å¾„
/*
/* Root + Service + Type + URL
/*
/* è¢« {@link /#doRegister(URL)} å’Œ {@link /#doUnregister(URL)} è°ƒç”¨
/*
/* @param url URL
/* @return è·¯å¾„
/*/
private String toUrlPath(URL url){
return toCategoryPath(url) + Constants.PATH_SEPARATOR + URL.encode(url.toFullString());
}
```

### 3.2.2 toCategoryPath

```
//*/*
/* è·å¾—åˆ†ç±»è·¯å¾„
/*
/* Root + Service + Type
/*
/* @param url URL
/* @return åˆ†ç±»è·¯å¾„
/*/
private String toCategoryPath(URL url){
return toServicePath(url) + Constants.PATH_SEPARATOR + url.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);
}
```

### 3.2.3 toServicePath

```
//*/*
/* è·å¾—æœåŠ¡è·¯å¾„
/*
/* Root + Type
/*
/* @param url URL
/* @return æœåŠ¡è·¯å¾„
/*/
private String toServicePath(URL url){
String name = url.getServiceInterface();
if (Constants.ANY_VALUE.equals(name)) {
return toRootPath();
}
return toRootDir() + URL.encode(name);
}
```

### 3.2.4 toRootDir

```
//*/*
/* è·å¾—æ ¹ç›®å½•
/*
/* Root
/*
/* @return è·¯å¾„
/*/
private String toRootDir(){
if (root.equals(Constants.PATH_SEPARATOR)) {
return root;
}
return root + Constants.PATH_SEPARATOR;
}
//*/*
/* Root
/*
/* @return æ ¹è·¯å¾„
/*/
private String toRootPath(){
return root;
}
```

## 3.3 doUnregister

```
@Override
protected void doUnregister(URL url){
try {
zkClient.delete(toUrlPath(url));
} catch (Throwable e) {
throw new RpcException("Failed to unregister " + url + " to zookeeper " + getUrl() + ", cause: " + e.getMessage(), e);
}
}
```

## 3.4 doSubscribe

```
1: @Override
2: protected void doSubscribe(final URL url, final NotifyListener listener){
3: try {
4: // å¤„ç†æ‰€æœ‰ Service å±‚çš„å‘èµ·è®¢é˜…ï¼Œä¾‹å¦‚ç›‘æ§ä¸­å¿ƒçš„è®¢é˜…
5: if (Constants.ANY_VALUE.equals(url.getServiceInterface())) {
6: String root = toRootPath();
7: // è·å¾— url å¯¹åº”çš„ç›‘å¬å™¨é›†åˆ
8: ConcurrentMap<NotifyListener, ChildListener> listeners = zkListeners.get(url);
9: if (listeners == null) { // ä¸å­˜åœ¨ï¼Œè¿›è¡Œåˆ›å»º
10: zkListeners.putIfAbsent(url, new ConcurrentHashMap<NotifyListener, ChildListener>());
11: listeners = zkListeners.get(url);
12: }
13: // è·å¾— ChildListener å¯¹è±¡
14: ChildListener zkListener = listeners.get(listener);
15: if (zkListener == null) { // ä¸å­˜åœ¨ ChildListener å¯¹è±¡ï¼Œè¿›è¡Œåˆ›å»º ChildListener å¯¹è±¡
16: listeners.putIfAbsent(listener, new ChildListener() {
17: public void childChanged(String parentPath, List<String> currentChilds){
18: for (String child : currentChilds) {
19: child = URL.decode(child);
20: // æ–°å¢ Service æ¥å£å…¨åæ—¶ï¼ˆå³æ–°å¢æœåŠ¡ï¼‰ï¼Œå‘èµ·è¯¥ Service å±‚çš„è®¢é˜…
21: if (!anyServices.contains(child)) {
22: anyServices.add(child);
23: subscribe(url.setPath(child).addParameters(Constants.INTERFACE_KEY, child,
24: Constants.CHECK_KEY, String.valueOf(false)), listener);
25: }
26: }
27: }
28: });
29: zkListener = listeners.get(listener);
30: }
31: // åˆ›å»º Service èŠ‚ç‚¹ã€‚è¯¥èŠ‚ç‚¹ä¸ºæŒä¹…èŠ‚ç‚¹ã€‚
32: zkClient.create(root, false);
33: // å‘ Zookeeper ï¼ŒService èŠ‚ç‚¹ï¼Œå‘èµ·è®¢é˜…
34: List<String> services = zkClient.addChildListener(root, zkListener);
35: // é¦–æ¬¡å…¨é‡æ•°æ®è·å–å®Œæˆæ—¶ï¼Œå¾ªç¯ Service æ¥å£å…¨åæ•°ç»„ï¼Œå‘èµ·è¯¥ Service å±‚çš„è®¢é˜…
36: if (services != null && !services.isEmpty()) {
37: for (String service : services) {
38: service = URL.decode(service);
39: anyServices.add(service);
40: subscribe(url.setPath(service).addParameters(Constants.INTERFACE_KEY, service,
41: Constants.CHECK_KEY, String.valueOf(false)), listener);
42: }
43: }
44: // å¤„ç†æŒ‡å®š Service å±‚çš„å‘èµ·è®¢é˜…ï¼Œä¾‹å¦‚æœåŠ¡æ¶ˆè´¹è€…çš„è®¢é˜…
45: } else {
46: // å­èŠ‚ç‚¹æ•°æ®æ•°ç»„
47: List<URL> urls = new ArrayList<URL>();
48: // å¾ªç¯åˆ†ç±»æ•°ç»„
49: for (String path : toCategoriesPath(url)) {
50: // è·å¾— url å¯¹åº”çš„ç›‘å¬å™¨é›†åˆ
51: ConcurrentMap<NotifyListener, ChildListener> listeners = zkListeners.get(url);
52: if (listeners == null) { // ä¸å­˜åœ¨ï¼Œè¿›è¡Œåˆ›å»º
53: zkListeners.putIfAbsent(url, new ConcurrentHashMap<NotifyListener, ChildListener>());
54: listeners = zkListeners.get(url);
55: }
56: // è·å¾— ChildListener å¯¹è±¡
57: ChildListener zkListener = listeners.get(listener);
58: if (zkListener == null) { // ä¸å­˜åœ¨ ChildListener å¯¹è±¡ï¼Œè¿›è¡Œåˆ›å»º ChildListener å¯¹è±¡
59: listeners.putIfAbsent(listener, new ChildListener() {
60: public void childChanged(String parentPath, List<String> currentChilds){
61: // å˜æ›´æ—¶ï¼Œè°ƒç”¨ `/#notify(...)` æ–¹æ³•ï¼Œå›è°ƒ NotifyListener
62: ZookeeperRegistry.this.notify(url, listener, toUrlsWithEmpty(url, parentPath, currentChilds));
63: }
64: });
65: zkListener = listeners.get(listener);
66: }
67: // åˆ›å»º Type èŠ‚ç‚¹ã€‚è¯¥èŠ‚ç‚¹ä¸ºæŒä¹…èŠ‚ç‚¹ã€‚
68: zkClient.create(path, false);
69: // å‘ Zookeeper ï¼ŒPATH èŠ‚ç‚¹ï¼Œå‘èµ·è®¢é˜…
70: List<String> children = zkClient.addChildListener(path, zkListener);
71: // æ·»åŠ åˆ° `urls` ä¸­
72: if (children != null) {
73: urls.addAll(toUrlsWithEmpty(url, path, children));
74: }
75: }
76: // é¦–æ¬¡å…¨é‡æ•°æ®è·å–å®Œæˆæ—¶ï¼Œè°ƒç”¨ `/#notify(...)` æ–¹æ³•ï¼Œå›è°ƒ NotifyListener
77: notify(url, listener, urls);
78: }
79: } catch (Throwable e) {
80: throw new RpcException("Failed to subscribe " + url + " to zookeeper " + getUrl() + ", cause: " + e.getMessage(), e);
81: }
82: }
```

- æ•´ä¸ªæ–¹æ³•åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«ï¼š
- ============ ç¬¬äºŒéƒ¨åˆ†ã€ç¬¬ 44 è‡³ 78 è¡Œã€‘ ============
- å¤„ç†**æŒ‡å®š** Service å±‚çš„å‘èµ·è®¢é˜…ï¼Œä¾‹å¦‚**æœåŠ¡æ¶ˆè´¹è€…**çš„è®¢é˜…ã€‚
- ç¬¬ 47 è¡Œï¼šå­èŠ‚ç‚¹æ•°æ®æ•°ç»„ï¼Œå³ **Service å±‚**ä¸‹çš„**æ‰€æœ‰ URL** ã€‚
- ç¬¬ 49 è¡Œï¼šå¾ªç¯åˆ†ç±»æ•°ç»„ã€‚å…¶ä¸­ï¼Œè°ƒç”¨

/#toCategoriesPath(url)
æ–¹æ³•ï¼Œè·å¾— åˆ†ç±»æ•°ç»„ã€‚

- ç¬¬ 51 è‡³ 55 è¡Œï¼šè·å¾—è®¢é˜…çš„

url
å¯¹åº”çš„ç›‘å¬å™¨é›†åˆã€‚

- ç¬¬ 56 è‡³ 66 è¡Œï¼šè·å¾—

listener
( NotifyListener ) å¯¹åº”çš„ ChildListener å¯¹è±¡ã€‚**åœ¨ URL å±‚å‘ç”Ÿå˜æ›´æ—¶**ï¼Œä¼šè°ƒç”¨

NotifyListener/#notify(url, listener, currentChilds)
æ–¹æ³•ï¼Œå›è°ƒ NotifyListener çš„é€»è¾‘ã€‚é…±ç´«ï¼Œå¦‚æœ Service ä¸‹å¢åŠ **æ–°çš„æœåŠ¡æä¾›è€…å®ä¾‹**( æ–°çš„ URL )ï¼ŒæœåŠ¡æ¶ˆè´¹è€…å¯åˆ›å»ºæ–°çš„ Invoker å¯¹è±¡ï¼Œç”¨äºè°ƒç”¨è¯¥æœåŠ¡æä¾›è€…ã€‚

- ç¬¬ 68 è¡Œï¼šåˆ›å»º **Type** èŠ‚ç‚¹ã€‚è¯¥èŠ‚ç‚¹ä¸º**æŒä¹…**èŠ‚ç‚¹ã€‚
- ç¬¬ 70 è¡Œï¼šå‘ Zookeeper çš„ **Path** èŠ‚ç‚¹ï¼Œå‘èµ·è®¢é˜…ã€‚
- ç¬¬ 72 è‡³ 74 è¡Œï¼šæ·»åŠ åˆ°

urls
ä¸­ã€‚

- ç¬¬ 77 è¡Œï¼š**é¦–æ¬¡å…¨é‡æ•°æ®è·å–å®Œæˆæ—¶**ï¼Œè°ƒç”¨

NotifyListener/#notify(url, listener, currentChilds)
æ–¹æ³•ï¼Œå›è°ƒ NotifyListener çš„é€»è¾‘ã€‚é…±ç´«ï¼ŒæœåŠ¡æ¶ˆè´¹è€…å¯åˆ›å»ºæ‰€æœ‰çš„ Invoker å¯¹è±¡ï¼Œç”¨äºè°ƒç”¨æœåŠ¡æä¾›è€…ä»¬ã€‚

- ğŸ™‚ å›çœ‹ã€ç¬¬ 77 è¡Œã€‘å’Œã€ç¬¬ 62 è¡Œã€‘ï¼Œå…¨é‡ + å¢é‡ï¼Œä»”ç»†ç†è§£ä¸‹ã€‚
- ============ ç¬¬ä¸€éƒ¨åˆ†ã€ç¬¬ 5 è‡³ 43 è¡Œã€‘ ============
- å¤„ç†**æ‰€æœ‰** Service å±‚çš„å‘èµ·è®¢é˜…ï¼Œä¾‹å¦‚**ç›‘æ§ä¸­å¿ƒ**çš„è®¢é˜…
- ç¬¬ 8 è‡³ 12 è¡Œï¼šè·å¾—è®¢é˜…çš„

url
å¯¹åº”çš„ç›‘å¬å™¨é›†åˆã€‚

- ç¬¬ 13 è‡³ 30 è¡Œï¼šè·å¾—

listener
( NotifyListener ) å¯¹åº”çš„ ChildListener å¯¹è±¡ã€‚**åœ¨ Service å±‚å‘ç”Ÿå˜æ›´æ—¶**ï¼Œè‹¥æ˜¯æ–°å¢ Service æ¥å£å…¨åæ—¶ï¼ˆå³æ–°å¢æœåŠ¡ï¼‰ï¼Œè°ƒç”¨

/#subscribe(url, listener)
æ–¹æ³•ï¼Œå‘èµ·è¯¥ Service å±‚çš„è®¢é˜…ï¼ˆã€ç¬¬ 45 è‡³ 78 è¡Œã€‘çš„é€»è¾‘ï¼‰ã€‚æ˜¯å¦æ˜¯æ–°å¢çš„æœåŠ¡ï¼Œé€šè¿‡

anyServices
å±æ€§æ¥åˆ¤æ–­ã€‚

- ç¬¬ 32 è¡Œï¼šåˆ›å»º **Service** èŠ‚ç‚¹ã€‚è¯¥èŠ‚ç‚¹ä¸º**æŒä¹…**èŠ‚ç‚¹ã€‚
- ç¬¬ 34 è¡Œï¼šå‘ Zookeeper çš„ **Service** èŠ‚ç‚¹ï¼Œå‘èµ·è®¢é˜…ã€‚
- ç¬¬ 36 è‡³ 43 è¡Œï¼š**é¦–æ¬¡å…¨é‡æ•°æ®è·å–å®Œæˆæ—¶**ï¼Œå¾ªç¯ Service æ¥å£å…¨åæ•°ç»„ï¼Œè°ƒç”¨

/#subscribe(url, listener)
æ–¹æ³•ï¼Œå‘èµ·è¯¥ Service å±‚çš„è®¢é˜…ï¼ˆã€ç¬¬ 45 è‡³ 78 è¡Œã€‘çš„é€»è¾‘ï¼‰ã€‚
å‹æƒ…æç¤ºï¼šå¦‚æœè§‰å¾—æ¯”è¾ƒç»•ï¼Œæˆ–è€…ç¬”è€…è®²çš„ä¸æ¸…æ™°ï¼Œèƒ–å‹å¯ä»¥è¿›è¡Œè°ƒè¯•ç†è§£ã€‚

### 3.4.1 toCategoriesPath

```
//*/*
/* è·å¾—åˆ†ç±»è·¯å¾„æ•°ç»„
/*
/* Root + Service + Type
/*
/* @param url URL
/* @return åˆ†ç±»è·¯å¾„æ•°ç»„
/*/
private String[] toCategoriesPath(URL url) {
// è·å¾—åˆ†ç±»æ•°ç»„
String[] categories;
if (Constants.ANY_VALUE.equals(url.getParameter(Constants.CATEGORY_KEY))) { // /* æ—¶ï¼Œ
categories = new String[]{Constants.PROVIDERS_CATEGORY, Constants.CONSUMERS_CATEGORY,
Constants.ROUTERS_CATEGORY, Constants.CONFIGURATORS_CATEGORY};
} else {
categories = url.getParameter(Constants.CATEGORY_KEY, new String[]{Constants.DEFAULT_CATEGORY});
}
// è·å¾—åˆ†ç±»è·¯å¾„æ•°ç»„
String[] paths = new String[categories.length];
for (int i = 0; i < categories.length; i++) {
paths[i] = toServicePath(url) + Constants.PATH_SEPARATOR + categories[i];
}
return paths;
}
```

### 3.4.2 toUrlsWithEmpty

```
//*/*
/* è·å¾— providers ä¸­ï¼Œå’Œ consumer åŒ¹é…çš„ URL æ•°ç»„
/*
/* è‹¥ä¸å­˜åœ¨åŒ¹é…ï¼Œåˆ™åˆ›å»º `empty://` çš„ URLè¿”å›ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå¯ä»¥å¤„ç†ç±»ä¼¼æœåŠ¡æä¾›è€…ä¸ºç©ºçš„æƒ…å†µã€‚
/*
/* @param consumer ç”¨äºåŒ¹é… URL
/* @param path è¢«åŒ¹é…çš„ URL çš„å­—ç¬¦ä¸²
/* @param providers åŒ¹é…çš„ URL æ•°ç»„
/* @return åŒ¹é…çš„ URL æ•°ç»„
/*/
private List<URL> toUrlsWithEmpty(URL consumer, String path, List<String> providers){
// è·å¾— providers ä¸­ï¼Œå’Œ consumer åŒ¹é…çš„ URL æ•°ç»„
List<URL> urls = toUrlsWithoutEmpty(consumer, providers);
// è‹¥ä¸å­˜åœ¨åŒ¹é…ï¼Œåˆ™åˆ›å»º `empty://` çš„ URLè¿”å›
if (urls == null || urls.isEmpty()) {
int i = path.lastIndexOf('/');
String category = i < 0 ? path : path.substring(i + 1);
URL empty = consumer.setProtocol(Constants.EMPTY_PROTOCOL).addParameter(Constants.CATEGORY_KEY, category);
urls.add(empty);
}
return urls;
}
```

- /#toUrlsWithoutEmpty()
  æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
//*/*
/* è·å¾— providers ä¸­ï¼Œå’Œ consumer åŒ¹é…çš„ URL æ•°ç»„
/*
/* @param consumer ç”¨äºåŒ¹é… URL
/* @param providers è¢«åŒ¹é…çš„ URL çš„å­—ç¬¦ä¸²
/* @return åŒ¹é…çš„ URL æ•°ç»„
/*/
private List<URL> toUrlsWithoutEmpty(URL consumer, List<String> providers){
List<URL> urls = new ArrayList<URL>();
if (providers != null && !providers.isEmpty()) {
for (String provider : providers) {
provider = URL.decode(provider);
if (provider.contains("://")) { // æ˜¯ url
URL url = URL.valueOf(provider); // å°†å­—ç¬¦ä¸²è½¬åŒ–æˆ URL
if (UrlUtils.isMatch(consumer, url)) { // åŒ¹é…
urls.add(url);
}
}
}
}
return urls;
}
```

## 3.5 doUnsubscribe

```
@Override
protected void doUnsubscribe(URL url, NotifyListener listener){
ConcurrentMap<NotifyListener, ChildListener> listeners = zkListeners.get(url);
if (listeners != null) {
ChildListener zkListener = listeners.get(listener);
if (zkListener != null) {
// å‘ Zookeeper ï¼Œç§»é™¤è®¢é˜…
zkClient.removeChildListener(toUrlPath(url), zkListener);
}
}
}
```

## 3.6 lookup

```
//*/*
/* æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„å·²æ³¨å†Œæ•°æ®ï¼Œä¸è®¢é˜…çš„æ¨æ¨¡å¼ç›¸å¯¹åº”ï¼Œè¿™é‡Œä¸ºæ‹‰æ¨¡å¼ï¼Œåªè¿”å›ä¸€æ¬¡ç»“æœã€‚
/*
/* @param url æŸ¥è¯¢æ¡ä»¶ï¼Œä¸å…è®¸ä¸ºç©ºï¼Œå¦‚ï¼šconsumer://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&application=kylin
/* @return å·²æ³¨å†Œä¿¡æ¯åˆ—è¡¨ï¼Œå¯èƒ½ä¸ºç©ºï¼Œå«ä¹‰åŒ{@link com.alibaba.dubbo.registry.NotifyListener/#notify(List<URL>)}çš„å‚æ•°ã€‚
/* @see com.alibaba.dubbo.registry.NotifyListener/#notify(List)
/*/
@Override
public List<URL> lookup(URL url){
if (url == null) {
throw new IllegalArgumentException("lookup url == null");
}
try {
// å¾ªç¯åˆ†ç±»æ•°ç»„ï¼Œè·å¾—æ‰€æœ‰çš„ URL æ•°ç»„
List<String> providers = new ArrayList<String>();
for (String path : toCategoriesPath(url)) {
List<String> children = zkClient.getChildren(path);
if (children != null) {
providers.addAll(children);
}
}
// åŒ¹é…
return toUrlsWithoutEmpty(url, providers);
} catch (Throwable e) {
throw new RpcException("Failed to lookup " + url + " from zookeeper " + getUrl() + ", cause: " + e.getMessage(), e);
}
}
```

## 3.7 isAvailable

```
@Override
public boolean isAvailable(){
return zkClient.isConnected();
}
```

## 3.8 destroy

```
@Override
public void destroy(){
super.destroy();
try {
zkClient.close();
} catch (Exception e) {
logger.warn("Failed to close zookeeper client " + getUrl() + ", cause: " + e.getMessage(), e);
}
}
```

# 4. è°ƒç”¨

## 4.1 æœåŠ¡æä¾›è€…

å›å¤´çœ‹ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æœåŠ¡æš´éœ²ï¼ˆäºŒï¼‰ä¹‹è¿œç¨‹æš´éœ²ï¼ˆDubboï¼‰ã€‹](http://svip.iocoder.cn/Dubbo/service-export-remote-dubbo/?self) çš„ [ã€Œ3.2.2 exportã€](http://svip.iocoder.cn/Dubbo/registry-zookeeper/) å°èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š

- ç¬¬ 14 è¡Œï¼šè°ƒç”¨

/#register(registryUrl, registedProviderUrl)
æ–¹æ³•ï¼Œå‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡æä¾›è€…ï¼ˆè‡ªå·±ï¼‰ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public void register(URL registryUrl, URL registedProviderUrl){
Registry registry = registryFactory.getRegistry(registryUrl);
registry.register(registedProviderUrl);
}
```

## 4.2 æœåŠ¡æ¶ˆè´¹è€…

å›å¤´çœ‹ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æœåŠ¡å¼•ç”¨ï¼ˆäºŒï¼‰ä¹‹è¿œç¨‹å¼•ç”¨ï¼ˆDubboï¼‰ã€‹](http://svip.iocoder.cn/Dubbo/reference-refer-dubbo/?self) çš„ [ã€Œ3.2.2 doRefer](http://svip.iocoder.cn/Dubbo/registry-zookeeper/) å°èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š

- ç¬¬ 20 è‡³ 25 è¡Œï¼šè°ƒç”¨

RegistryService/#register(url)
æ–¹æ³•ï¼Œå‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œ**è‡ªå·±**ï¼ˆæœåŠ¡æ¶ˆè´¹è€…ï¼‰ã€‚

- ç¬¬ 35 è¡Œï¼šè°ƒç”¨

Directory/#subscribe(url)
æ–¹æ³•ï¼Œå‘æ³¨å†Œä¸­å¿ƒè®¢é˜…æœåŠ¡æä¾›è€… + è·¯ç”±è§„åˆ™ + é…ç½®è§„åˆ™ã€‚

- åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¼šå¾ªç¯è·å¾—åˆ°çš„æœåŠ¡ä½“ç”¨è¿™åˆ—è¡¨ï¼Œè°ƒç”¨

Protocol/#refer(type, url)
æ–¹æ³•ï¼Œåˆ›å»ºæ¯ä¸ªè°ƒç”¨æœåŠ¡çš„ Invoker å¯¹è±¡ã€‚
