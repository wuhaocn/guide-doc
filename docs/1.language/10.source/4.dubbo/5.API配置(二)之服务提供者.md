# API é…ç½®ï¼ˆäºŒï¼‰ä¹‹æœåŠ¡æä¾›è€…

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

å‹æƒ…æç¤ºï¼Œã€**é…ç½®**ã€‘è¿™å—çš„å†…å®¹ï¼Œä¼šç›¸å¯¹æ¯”è¾ƒæ¯ç‡¥ã€‚æ‰€ä»¥ï¼Œå¦‚æœçœ‹åˆ°ä¸€äº›å¾ˆéš¾æ‡‚çš„åœ°æ–¹ï¼Œå»ºè®®å…ˆè·³è¿‡ã€‚

å¯¹äº Dubbo ï¼Œé‡ç‚¹æ˜¯è¦å»ç†è§£ï¼Œå¤šåè®®ã€RPCã€å®¹é”™ç­‰ç­‰æ¨¡å—ï¼Œè€Œä¸æ˜¯ã€**é…ç½®**ã€‘ã€‚

ğŸ˜ˆ ä¼°è®¡å¥½å¤šèƒ–å‹è¢«ã€**é…ç½®**ã€‘è¿™ç« åŠé€€äº†æŠŠï¼Ÿï¼Ÿï¼Ÿ

# 1. æ¦‚è¿°

æœ¬æ–‡æ¥ [ã€ŠAPI é…ç½®ï¼ˆä¸€ï¼‰ä¹‹åº”ç”¨ã€‹](http://svip.iocoder.cn/Dubbo/configuration-api-1/) ï¼Œåˆ†äº«**æœåŠ¡æä¾›è€…**ç›¸å…³çš„é…ç½®ï¼šåŒ…æ‹¬ provider-config å’Œ sub-config éƒ¨åˆ†ã€‚

![é…ç½®ç±»å…³ç³»](http://static2.iocoder.cn/images/Dubbo/2018_01_07/03.png)

- **é»„æ¡†**éƒ¨åˆ†ï¼Œprovider-side
- **å…¶ä»–**éƒ¨åˆ†ï¼Œsub-config

è¿˜æ˜¯è€æ ·å­ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” API é…ç½®ã€‹](http://dubbo.apache.org/zh-cn/docs/user/configuration/api.html) ï¼ŒæœåŠ¡æä¾›è€…çš„åˆå§‹åŒ–ä»£ç ï¼š

```
// æœåŠ¡å®ç°
XxxService xxxService = new XxxServiceImpl();
// å½“å‰åº”ç”¨é…ç½®
ApplicationConfig application = new ApplicationConfig();
application.setName("xxx");
// è¿æ¥æ³¨å†Œä¸­å¿ƒé…ç½®
RegistryConfig registry = new RegistryConfig();
registry.setAddress("10.20.130.230:9090");
registry.setUsername("aaa");
registry.setPassword("bbb");
// æœåŠ¡æä¾›è€…åè®®é…ç½®
ProtocolConfig protocol = new ProtocolConfig();
protocol.setName("dubbo");
protocol.setPort(12345);
protocol.setThreads(200);
// æ³¨æ„ï¼šServiceConfigä¸ºé‡å¯¹è±¡ï¼Œå†…éƒ¨å°è£…äº†ä¸æ³¨å†Œä¸­å¿ƒçš„è¿æ¥ï¼Œä»¥åŠå¼€å¯æœåŠ¡ç«¯å£
// æœåŠ¡æä¾›è€…æš´éœ²æœåŠ¡é…ç½®
ServiceConfig<XxxService> service = new ServiceConfig<XxxService>(); // æ­¤å®ä¾‹å¾ˆé‡ï¼Œå°è£…äº†ä¸æ³¨å†Œä¸­å¿ƒçš„è¿æ¥ï¼Œè¯·è‡ªè¡Œç¼“å­˜ï¼Œå¦åˆ™å¯èƒ½é€ æˆå†…å­˜å’Œè¿æ¥æ³„æ¼
service.setApplication(application);
service.setRegistry(registry); // å¤šä¸ªæ³¨å†Œä¸­å¿ƒå¯ä»¥ç”¨setRegistries()
service.setProtocol(protocol); // å¤šä¸ªåè®®å¯ä»¥ç”¨setProtocols()
service.setInterface(XxxService.class);
service.setRef(xxxService);
service.setVersion("1.0.0");
// æš´éœ²åŠæ³¨å†ŒæœåŠ¡
service.export();
```

- ç›¸æ¯” ReferenceConfig çš„åˆå§‹åŒ–ï¼Œä¼šå¤šåˆ›å»º ProtocolConfig å¯¹è±¡ï¼Œè®¾ç½®åˆ° ServiceConfig å¯¹è±¡ä¸­ã€‚
  å‹æƒ…æç¤ºï¼šæœ¬æ–‡å‰é¢éƒ¨åˆ†ä¼šæ¯”è¾ƒçç¢ï¼Œé‡ç‚¹åœ¨ [ã€Œ8. ServiceConfigã€](http://svip.iocoder.cn/Dubbo/configuration-api-2/) éƒ¨åˆ†ã€‚

# 2. ProtocolConfig

[
com.alibaba.dubbo.config.ProtocolConfig
](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ProtocolConfig.java) ï¼ŒæœåŠ¡æä¾›è€…åè®®é…ç½®ã€‚

- å…·ä½“å±æ€§çš„è§£é‡Šï¼Œå‚è§ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” dubbo:protocolã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-protocol.html) æ–‡æ¡£ã€‚

# 3. AbstractMethodConfig

[
com.alibaba.dubbo.config.AbstractMethodConfig
](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractMethodConfig.java) ï¼Œæ–¹æ³•çº§é…ç½®çš„æŠ½è±¡ç±»ã€‚

- **éƒ¨åˆ†**å±æ€§çš„è§£é‡Šï¼Œå‚è§ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” dubbo:methodã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-method.html) æ–‡æ¡£ã€‚

# 4. MethodConfig

[
com.alibaba.dubbo.config.MethodConfig
](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractMethodConfig.java) ï¼Œç»§æ‰¿ AbstractMethodConfig ï¼Œæ–¹æ³•çº§é…ç½®ã€‚

- å…·ä½“å±æ€§çš„è§£é‡Šï¼Œ[ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” dubbo:methodã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-method.html) æ–‡æ¡£ã€‚

# 5. AbstractInterfaceConfig

[
com.alibaba.dubbo.config.AbstractInterfaceConfig
](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java) ï¼Œç»§æ‰¿ AbstractMethodConfig ï¼ŒæŠ½è±¡æ¥å£é…ç½®ç±»ã€‚

- å…·ä½“å±æ€§çš„è§£é‡Šï¼Œ**éœ€è¦å¯»æ‰¾**åœ¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” dubbo:serviceã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-service.html) æˆ– [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” dubbo:referenceã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-reference.html) æ–‡æ¡£ã€‚
- ä¸‹é¢çš„æ–¹æ³•ï¼Œä¼šåœ¨ [ã€Œ8. ServiceConfigã€](http://svip.iocoder.cn/Dubbo/configuration-api-2/) çš„åˆå§‹åŒ–è¢«è°ƒç”¨ï¼Œèƒ–å‹å¯éœ€è¦çš„æ—¶å€™ï¼Œç‚¹å‡»æŸ¥çœ‹ã€‚
- [
  /#checkApplication()
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L156-L187) æ–¹æ³•ï¼Œæ ¡éªŒ ApplicationConfig é…ç½®ã€‚**å®é™…ä¸Š**ï¼Œè¯¥æ–¹æ³•ä¼šåˆå§‹åŒ– ApplicationConfig çš„é…ç½®å±æ€§ã€‚

- ğŸ™‚ ç›´æ¥ç‚¹å‡»æ–¹æ³•æŸ¥çœ‹ï¼Œè¾ƒä¸ºç®€å•ï¼Œå·²ç»æ·»åŠ è¯¦ç»†æ³¨é‡Šã€‚
- [
  /#checkRegistry()
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L122-L154) æ–¹æ³•ï¼Œæ ¡éªŒ RegistryConfig é…ç½®ã€‚**å®é™…ä¸Š**ï¼Œè¯¥æ–¹æ³•ä¼šåˆå§‹åŒ– RegistryConfig çš„é…ç½®å±æ€§ã€‚

- ğŸ™‚ ç›´æ¥ç‚¹å‡»æ–¹æ³•æŸ¥çœ‹ï¼Œè¾ƒä¸ºç®€å•ï¼Œå·²ç»æ·»åŠ è¯¦ç»†æ³¨é‡Šã€‚
- [
  /#checkInterfaceAndMethods(interfaceClass, methods)
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L280-L317) æ–¹æ³•ï¼Œæ ¡éªŒæ¥å£å’Œæ–¹æ³•ã€‚ä¸»è¦æ˜¯ä¸¤æ–¹é¢ï¼š

- 1ã€ æ¥å£ç±»éç©ºï¼Œå¹¶æ˜¯æ¥å£
- 2ã€ æ–¹æ³•åœ¨æ¥å£ä¸­å·²å®šä¹‰
- ğŸ™‚ ç›´æ¥ç‚¹å‡»æ–¹æ³•æŸ¥çœ‹ï¼Œè¾ƒä¸ºç®€å•ï¼Œå·²ç»æ·»åŠ è¯¦ç»†æ³¨é‡Šã€‚
- [
  /#checkStubAndMock(interfaceClass)
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L319-L368) æ–¹æ³•ï¼Œæ ¡éªŒ Stub å’Œ Mock ç›¸å…³çš„é…ç½®ã€‚
- ä»¥ä¸Šæœªåˆ—ä¸¾çš„ [
  /#loadRegistries(provider)
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L189-L233) å’Œ [
  /#loadMonitor(registryURL)
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L235-L278) æ–¹æ³•ï¼Œåœ¨**åç»­æ–‡ç« **éœ€è¦ä½¿ç”¨åˆ°æ—¶ï¼Œåœ¨è¯¦ç»†åˆ†äº«ã€‚

# 6. AbstractServiceConfig

[
com.alibaba.dubbo.config.AbstractServiceConfig
](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractServiceConfig.java) ï¼Œå®ç° AbstractInterfaceConfig ï¼ŒæŠ½è±¡æœåŠ¡é…ç½®ç±»ã€‚

- å…·ä½“å±æ€§çš„è§£é‡Šï¼Œ**éœ€è¦å¯»æ‰¾**åœ¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” dubbo:serviceã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-service.html) æˆ– [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” dubbo:providerã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-provider.html) æ–‡æ¡£ã€‚

# 7. ProviderConfig

[
com.alibaba.dubbo.config.ProviderConfig
](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ProviderConfig.java) ï¼Œå®ç° AbstractServiceConfig ï¼ŒæœåŠ¡æä¾›è€…ç¼ºçœå€¼é…ç½®ã€‚

- å…·ä½“å±æ€§çš„è§£é‡Šï¼Œå‚è§ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” dubbo:providerã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-provider.html) æ–‡æ¡£ã€‚

# 8. ServiceConfig

[
com.alibaba.dubbo.config.ServiceConfig
](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java) ï¼ŒæœåŠ¡æä¾›è€…æš´éœ²**æœåŠ¡é…ç½®ç±»**ã€‚

- å…·ä½“å±æ€§çš„è§£é‡Šï¼Œå‚è§ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” dubbo:serviceã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-service.html) æ–‡æ¡£ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬è¿›å…¥**æ­£æˆ**ã€‚

åœ¨æ–‡åˆçš„ ServiceConfig çš„åˆå§‹åŒ–ç¤ºä¾‹ä»£ç ä¸­ï¼Œæœ€åè°ƒç”¨çš„æ˜¯ [
ServiceConfig/#export()
](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L239) æ–¹æ³•ã€‚ä»æ–¹æ³•çš„å‘½åï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œ**æš´éœ²æœåŠ¡**ã€‚è¯¥æ–¹æ³•ä¸»è¦åšäº†å¦‚ä¸‹å‡ ä»¶äº‹æƒ…ï¼š

1. **è¿›ä¸€æ­¥åˆå§‹åŒ–** ServiceConfig å¯¹è±¡ã€‚
1. **æ ¡éªŒ** ServiceConfig å¯¹è±¡çš„é…ç½®é¡¹ã€‚
1. ä½¿ç”¨ ServiceConfig å¯¹è±¡ï¼Œ**ç”Ÿæˆ** Dubbo URL å¯¹è±¡**æ•°ç»„**ã€‚
1. ä½¿ç”¨ Dubbo URL å¯¹è±¡ï¼Œ**æš´éœ²æœåŠ¡**ã€‚

ğŸ˜ˆ æœ¬æ–‡é‡ç‚¹åœ¨æœåŠ¡æä¾›è€…ç›¸å…³çš„é…ç½®ï¼Œå› æ­¤åªè§£æ **1+2+3** éƒ¨åˆ†( ä¸åŒ…æ‹¬ 4 )ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: public synchronized void export(){
2: // å½“ export æˆ–è€… delay æœªé…ç½®ï¼Œä» ProviderConfig å¯¹è±¡è¯»å–ã€‚
3: if (provider != null) {
4: if (export == null) {
5: export = provider.getExport();
6: }
7: if (delay == null) {
8: delay = provider.getDelay();
9: }
10: }
11: // ä¸æš´éœ²æœåŠ¡( export = false ) ï¼Œåˆ™ä¸è¿›è¡Œæš´éœ²æœåŠ¡é€»è¾‘ã€‚
12: if (export != null && !export) {
13: return;
14: }
15:
16: // å»¶è¿Ÿæš´éœ²
17: if (delay != null && delay > 0) {
18: delayExportExecutor.schedule(new Runnable() {
19: public void run(){
20: doExport();
21: }
22: }, delay, TimeUnit.MILLISECONDS);
23: // ç«‹å³æš´éœ²
24: } else {
25: doExport();
26: }
27: }
```

- ç¬¬ 2 è‡³ 10 è¡Œï¼šå½“ [
  export
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractServiceConfig.java#L48) æˆ– [
  delay
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractServiceConfig.java#L45) æœªé…ç½®æ—¶ï¼Œä» ProviderConfig å¯¹è±¡è¯»å–ã€‚
- ç¬¬ 11 è‡³ 14 è¡Œï¼šå½“é…ç½®ä¸éœ€è¦æš´éœ²æœåŠ¡(

export = false
)æ—¶ï¼Œç›´æ¥è¿”å›ã€‚

- ç¬¬ 17 è‡³ 22 è¡Œï¼šå½“é…ç½®å»¶è¿Ÿæš´éœ²(

delay > 0
)æ—¶ï¼Œä½¿ç”¨ [
delayExportExecutor
](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L86) **å»¶è¿Ÿ**è°ƒåº¦ï¼Œè°ƒç”¨

/#doExport()
æ–¹æ³•ã€‚

- [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” å»¶è¿Ÿæš´éœ²ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/delay-publish.html)
- ç¬¬ 23 è‡³ 26 è¡Œï¼šç«‹å³æš´éœ²ï¼Œè°ƒç”¨

/#doExport()
æ–¹æ³•ã€‚

[
/#doExport()
](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L267-L391) æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
1: protected synchronized void doExport(){
2: // æ£€æŸ¥æ˜¯å¦å¯ä»¥æš´éœ²ï¼Œè‹¥å¯ä»¥ï¼Œæ ‡è®°å·²ç»æš´éœ²ã€‚
3: if (unexported) {
4: throw new IllegalStateException("Already unexported!");
5: }
6: if (exported) {
7: return;
8: }
9: exported = true;
10: // æ ¡éªŒæ¥å£åéç©º
11: if (interfaceName == null || interfaceName.length() == 0) {
12: throw new IllegalStateException("<dubbo:service interface=\"\" /> interface not allow null!");
13: }
14: // æ‹¼æ¥å±æ€§é…ç½®ï¼ˆç¯å¢ƒå˜é‡ + properties å±æ€§ï¼‰åˆ° ProviderConfig å¯¹è±¡
15: checkDefault();
16: // ä» ProviderConfig å¯¹è±¡ä¸­ï¼Œè¯»å– applicationã€moduleã€registriesã€monitorã€protocols é…ç½®å¯¹è±¡ã€‚
17: if (provider != null) {
18: if (application == null) {
19: application = provider.getApplication();
20: }
21: if (module == null) {
22: module = provider.getModule();
23: }
24: if (registries == null) {
25: registries = provider.getRegistries();
26: }
27: if (monitor == null) {
28: monitor = provider.getMonitor();
29: }
30: if (protocols == null) {
31: protocols = provider.getProtocols();
32: }
33: }
34: // ä» ModuleConfig å¯¹è±¡ä¸­ï¼Œè¯»å– registriesã€monitor é…ç½®å¯¹è±¡ã€‚
35: if (module != null) {
36: if (registries == null) {
37: registries = module.getRegistries();
38: }
39: if (monitor == null) {
40: monitor = module.getMonitor();
41: }
42: }
43: // ä» ApplicationConfig å¯¹è±¡ä¸­ï¼Œè¯»å– registriesã€monitor é…ç½®å¯¹è±¡ã€‚
44: if (application != null) {
45: if (registries == null) {
46: registries = application.getRegistries();
47: }
48: if (monitor == null) {
49: monitor = application.getMonitor();
50: }
51: }
52: // æ³›åŒ–æ¥å£çš„å®ç°
53: if (ref instanceof GenericService) {
54: interfaceClass = GenericService.class;
55: if (StringUtils.isEmpty(generic)) {
56: generic = Boolean.TRUE.toString();
57: }
58: // æ™®é€šæ¥å£çš„å®ç°
59: } else {
60: try {
61: interfaceClass = Class.forName(interfaceName, true, Thread.currentThread().getContextClassLoader());
62: } catch (ClassNotFoundException e) {
63: throw new IllegalStateException(e.getMessage(), e);
64: }
65: // æ ¡éªŒæ¥å£å’Œæ–¹æ³•
66: checkInterfaceAndMethods(interfaceClass, methods);
67: // æ ¡éªŒæŒ‡å‘çš„ service å¯¹è±¡
68: checkRef();
69: generic = Boolean.FALSE.toString();
70: }
71: // å¤„ç†æœåŠ¡æ¥å£å®¢æˆ·ç«¯æœ¬åœ°ä»£ç†( `local` )ç›¸å…³ã€‚å®é™…ç›®å‰å·²ç»åºŸå¼ƒï¼Œä½¿ç”¨ `stub` å±æ€§ï¼Œå‚è§ `AbstractInterfaceConfig/#setLocal` æ–¹æ³•ã€‚
72: if (local != null) {
73: // è®¾ä¸º trueï¼Œè¡¨ç¤ºä½¿ç”¨ç¼ºçœä»£ç†ç±»åï¼Œå³ï¼šæ¥å£å + Local åç¼€
74: if ("true".equals(local)) {
75: local = interfaceName + "Local";
76: }
77: Class<?> localClass;
78: try {
79: localClass = ClassHelper.forNameWithThreadContextClassLoader(local);
80: } catch (ClassNotFoundException e) {
81: throw new IllegalStateException(e.getMessage(), e);
82: }
83: if (!interfaceClass.isAssignableFrom(localClass)) {
84: throw new IllegalStateException("The local implementation class " + localClass.getName() + " not implement interface " + interfaceName);
85: }
86: }
87: // å¤„ç†æœåŠ¡æ¥å£å®¢æˆ·ç«¯æœ¬åœ°ä»£ç†( `stub` )ç›¸å…³
88: if (stub != null) {
89: // è®¾ä¸º trueï¼Œè¡¨ç¤ºä½¿ç”¨ç¼ºçœä»£ç†ç±»åï¼Œå³ï¼šæ¥å£å + Stub åç¼€
90: if ("true".equals(stub)) {
91: stub = interfaceName + "Stub";
92: }
93: Class<?> stubClass;
94: try {
95: stubClass = ClassHelper.forNameWithThreadContextClassLoader(stub);
96: } catch (ClassNotFoundException e) {
97: throw new IllegalStateException(e.getMessage(), e);
98: }
99: if (!interfaceClass.isAssignableFrom(stubClass)) {
100: throw new IllegalStateException("The stub implementation class " + stubClass.getName() + " not implement interface " + interfaceName);
101: }
102: }
103: // æ ¡éªŒ ApplicationConfig é…ç½®ã€‚
104: checkApplication();
105: // æ ¡éªŒ RegistryConfig é…ç½®ã€‚
106: checkRegistry();
107: // æ ¡éªŒ ProtocolConfig é…ç½®æ•°ç»„ã€‚
108: checkProtocol();
109: // è¯»å–ç¯å¢ƒå˜é‡å’Œ properties é…ç½®åˆ° ServiceConfig å¯¹è±¡ã€‚
110: appendProperties(this);
111: // æ ¡éªŒ Stub å’Œ Mock ç›¸å…³çš„é…ç½®
112: checkStubAndMock(interfaceClass);
113: // æœåŠ¡è·¯å¾„ï¼Œç¼ºçœä¸ºæ¥å£å
114: if (path == null || path.length() == 0) {
115: path = interfaceName;
116: }
117: // æš´éœ²æœåŠ¡
118: doExportUrls();
119: // TODO èŠ‹è‰¿ï¼Œç­‰å¾… qos
120: ProviderModel providerModel = new ProviderModel(getUniqueServiceName(), this, ref);
121: ApplicationModel.initProviderModel(getUniqueServiceName(), providerModel);
122: }
```

- ç¬¬ 2 è‡³ 9 è¡Œï¼šæ£€æŸ¥æ˜¯å¦å¯ä»¥æš´éœ²ã€‚è‹¥å¯ä»¥ï¼Œæ ‡è®°å·²ç»æš´éœ²(

exported = true
)ã€‚

- ç¬¬ 10 è‡³ 13 è¡Œï¼šæ ¡éªŒæ¥å£å [
  interfaceName
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L111) éç©ºã€‚
- ç¬¬ 15 è¡Œï¼šè°ƒç”¨ [
  /#checkDefault()
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L791-L800) æ–¹æ³•ï¼Œè¯»å–**å±æ€§é…ç½®**( ç¯å¢ƒå˜é‡ + properties å±æ€§ )åˆ° ProviderConfig å¯¹è±¡ã€‚

- å…³äºâ€œ**å±æ€§é…ç½®**â€ ï¼Œåœ¨ [ã€Šç²¾å°½ Dubbo æºç è§£æ â€”â€” å±æ€§é…ç½®ã€‹](http://svip.iocoder.cn/Dubbo/configuration-properties/?self) è¯¦ç»†è§£æã€‚
- ğŸ™‚ ç›´æ¥ç‚¹å‡»æ–¹æ³•æŸ¥çœ‹ï¼Œè¾ƒä¸ºç®€å•ï¼Œå·²ç»æ·»åŠ è¯¦ç»†æ³¨é‡Šã€‚
- ç¬¬ 16 è‡³ 33 è¡Œï¼šä» ProviderConfig å¯¹è±¡ä¸­ï¼Œè¯»å– [
  application
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L102)ã€[
  module
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L105)ã€[
  registries
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L108)ã€[
  monitor
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L77)ã€[
  protocols
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractServiceConfig.java#L64) å¯¹è±¡ã€‚
- ç¬¬ 34 è‡³ 42 è¡Œï¼šä» ModuleConfig å¯¹è±¡ä¸­ï¼Œè¯»å– [
  registries
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L108)ã€[
  monitor
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L77) å¯¹è±¡ã€‚
- ç¬¬ 43 è‡³ 51 è¡Œï¼šä» ApplicationConfig å¯¹è±¡ä¸­ï¼Œè¯»å– [
  registries
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L108)ã€[
  monitor
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L77) å¯¹è±¡ã€‚
- ç¬¬ 52 è‡³ 57 è¡Œï¼šæ³›åŒ–æ¥å£çš„å®ç°ã€‚

- [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” æ³›åŒ–æ¥å£ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/generic-service.html)
- ç¬¬ 58 è‡³ 70 è¡Œï¼šæ™®é€šæ¥å£çš„å®ç°ã€‚

- ç¬¬ 60 è‡³ 64 è¡Œï¼šæ ¹æ® [
  interfaceName
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L105) ï¼Œè·å¾—å¯¹åº”çš„**æ¥å£ç±»**ï¼Œå¹¶èµ‹å€¼ç»™ [
  interfaceClass
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L111)ã€‚
- ç¬¬ 66 è¡Œï¼šè°ƒç”¨

/#checkInterfaceAndMethods(interfaceClass, methods)
æ–¹æ³•ï¼Œæ£€æŸ¥æ¥å£å’Œæ–¹æ³•ã€‚

- ğŸ™‚ æœ¬æ–‡æœ‰å·²ç»æœ‰è¿™ä¸ªæ–¹æ³•çš„è§£æã€‚
- ç¬¬ 68 è¡Œï¼šè°ƒç”¨ [
  /#checkRef()
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L393-L408) æ–¹æ³•ï¼Œæ ¡éªŒæŒ‡å‘çš„ Service å¯¹è±¡ã€‚
- ç¬¬ 69 è¡Œï¼šæ ‡è®° [
  generic
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L138) ä¸º**é**æ³›åŒ–å®ç°ã€‚
- ç¬¬ 71 è‡³ 86 è¡Œï¼šå¤„ç†æœåŠ¡æ¥å£å®¢æˆ·ç«¯æœ¬åœ°ä»£ç†( [
  local
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L55-L63) )ç›¸å…³ã€‚**å®é™…ç›®å‰å·²ç»åºŸå¼ƒï¼Œæ­¤å¤„ä¸»è¦ç”¨äºå…¼å®¹**ï¼Œä½¿ç”¨ [
  stub
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L64-L74)å±æ€§ï¼Œå‚è§ [
  AbstractInterfaceConfig/#setLocal(local)
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L379-L390) æ–¹æ³•çš„**æ³¨é‡Šè¯´æ˜**ã€‚
- ç¬¬ 87 è‡³ 102 è¡Œï¼šå¤„ç†æœåŠ¡æ¥å£å®¢æˆ·ç«¯æœ¬åœ°ä»£ç†( [
  stub
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L64-L74) å±æ€§ï¼Œå‚è§ [
  AbstractInterfaceConfig/#setLocal(local)
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L379-L390) )ç›¸å…³ã€‚
- ç¬¬ 104 è¡Œï¼šè°ƒç”¨ [
  /#checkApplication()
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L156-L187) æ–¹æ³•ï¼Œæ ¡éªŒ ApplicationConfig é…ç½®ã€‚

- ğŸ™‚ ç›´æ¥ç‚¹å‡»æ–¹æ³•æŸ¥çœ‹ï¼Œè¾ƒä¸ºç®€å•ï¼Œå·²ç»æ·»åŠ è¯¦ç»†æ³¨é‡Šã€‚
- ç¬¬ 106 è¡Œï¼šè°ƒç”¨ [
  /#checkRegistry()
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L122-L154) æ–¹æ³•ï¼Œæ ¡éªŒ RegistryConfig é…ç½®ã€‚

- ğŸ™‚ ç›´æ¥ç‚¹å‡»æ–¹æ³•æŸ¥çœ‹ï¼Œè¾ƒä¸ºç®€å•ï¼Œå·²ç»æ·»åŠ è¯¦ç»†æ³¨é‡Šã€‚
- ç¬¬ 108 è¡Œï¼šè°ƒç”¨ [
  /#checkProtocol()
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L802-L823) æ–¹æ³•ï¼Œæ ¡éªŒ ProtocolConfig é…ç½®æ•°ç»„ã€‚

- ğŸ™‚ ç›´æ¥ç‚¹å‡»æ–¹æ³•æŸ¥çœ‹ï¼Œè¾ƒä¸ºç®€å•ï¼Œå·²ç»æ·»åŠ è¯¦ç»†æ³¨é‡Šã€‚
- ç¬¬ 110 è¡Œï¼šè°ƒç”¨ [
  /#appendProperties(config)
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractConfig.java#L132-L212) æ–¹æ³•ï¼Œè¯»å–**å±æ€§é…ç½®**( ç¯å¢ƒå˜é‡ + properties å±æ€§ )åˆ° ServiceConfig å¯¹è±¡ï¼ˆ**è‡ªå·±**ï¼‰ã€‚
- ç¬¬ 112 è¡Œï¼šè°ƒç”¨ [
  /#checkStubAndMock(interfaceClass)
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L319-L368) æ–¹æ³•ï¼Œæ ¡éªŒ Stub å’Œ Mock ç›¸å…³çš„é…ç½®ã€‚
- ç¬¬ 113 è‡³ 116 è¡Œï¼šæœåŠ¡è·¯å¾„ [
  path
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L115) ä¸ºç©ºæ—¶ï¼Œç¼ºçœä¸ºæ¥å£åã€‚
- ç¬¬ 118 è¡Œï¼šè°ƒç”¨ [
  /#doExportUrls()
  ](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L430-L439) æ–¹æ³•ï¼Œ**æš´éœ²æœåŠ¡**ã€‚æ­¤æ–¹æ³•åŒ…å«äº†æˆ‘ä»¬ä¸Šè¿°çš„ **3+4** éƒ¨åˆ†ã€‚
- ç¬¬ 119 è‡³ 121 è¡Œï¼š// TODO èŠ‹è‰¿ï¼Œç­‰å¾… qos

å› ä¸ºæœ¬æ–‡ä¸åˆ†äº« **4** éƒ¨åˆ†ï¼Œæ‰€ä»¥ä¸‹é¢æˆ‘ä»¬åªçœ‹ [
/#doExportUrls()
](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L430-L439) æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ [
/#doExportUrlsFor1Protocol(protocolConfig, registryURLs)
](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L441-L621) æ–¹æ³•ï¼Œå’Œ **3** æœ‰å…³çš„éƒ¨åˆ†ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: private void doExportUrlsFor1Protocol(ProtocolConfig protocolConfig, List<URL> registryURLs){
2: // åè®®å
3: String name = protocolConfig.getName();
4: if (name == null || name.length() == 0) {
5: name = "dubbo";
6: }
7:
8: // å°† `side`ï¼Œ`dubbo`ï¼Œ`timestamp`ï¼Œ`pid` å‚æ•°ï¼Œæ·»åŠ åˆ° `map` é›†åˆä¸­ã€‚
9: Map<String, String> map = new HashMap<String, String>();
10: map.put(Constants.SIDE_KEY, Constants.PROVIDER_SIDE);
11: map.put(Constants.DUBBO_VERSION_KEY, Version.getVersion());
12: map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));
13: if (ConfigUtils.getPid() > 0) {
14: map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));
15: }
16: // å°†å„ç§é…ç½®å¯¹è±¡ï¼Œæ·»åŠ åˆ° `map` é›†åˆä¸­ã€‚
17: appendParameters(map, application);
18: appendParameters(map, module);
19: appendParameters(map, provider, Constants.DEFAULT_KEY); // ProviderConfig ï¼Œä¸º ServiceConfig çš„é»˜è®¤å±æ€§ï¼Œå› æ­¤æ·»åŠ  `default` å±æ€§å‰ç¼€ã€‚
20: appendParameters(map, protocolConfig);
21: appendParameters(map, this);
22: // å°† MethodConfig å¯¹è±¡æ•°ç»„ï¼Œæ·»åŠ åˆ° `map` é›†åˆä¸­ã€‚
23: if (methods != null && !methods.isEmpty()) {
24: for (MethodConfig method : methods) {
25: // å°† MethodConfig å¯¹è±¡ï¼Œæ·»åŠ åˆ° `map` é›†åˆä¸­ã€‚
26: appendParameters(map, method, method.getName());
27: // å½“ é…ç½®äº† `MethodConfig.retry = false` æ—¶ï¼Œå¼ºåˆ¶ç¦ç”¨é‡è¯•
28: String retryKey = method.getName() + ".retry";
29: if (map.containsKey(retryKey)) {
30: String retryValue = map.remove(retryKey);
31: if ("false".equals(retryValue)) {
32: map.put(method.getName() + ".retries", "0");
33: }
34: }
35: // å°† ArgumentConfig å¯¹è±¡æ•°ç»„ï¼Œæ·»åŠ åˆ° `map` é›†åˆä¸­ã€‚
36: List<ArgumentConfig> arguments = method.getArguments();
37: if (arguments != null && !arguments.isEmpty()) {
38: for (ArgumentConfig argument : arguments) {
39: // convert argument type
40: if (argument.getType() != null && argument.getType().length() > 0) { // æŒ‡å®šäº†ç±»å‹
41: Method[] methods = interfaceClass.getMethods();
42: // visit all methods
43: if (methods != null && methods.length > 0) {
44: for (int i = 0; i < methods.length; i++) {
45: String methodName = methods[i].getName();
46: // target the method, and get its signature
47: if (methodName.equals(method.getName())) { // æ‰¾åˆ°æŒ‡å®šæ–¹æ³•
48: Class<?>[] argTypes = methods[i].getParameterTypes();
49: // one callback in the method
50: if (argument.getIndex() != -1) { // æŒ‡å®šå•ä¸ªå‚æ•°çš„ä½ç½® + ç±»å‹
51: if (argTypes[argument.getIndex()].getName().equals(argument.getType())) {
52: // å°† ArgumentConfig å¯¹è±¡ï¼Œæ·»åŠ åˆ° `map` é›†åˆä¸­ã€‚
53: appendParameters(map, argument, method.getName() + "." + argument.getIndex()); // `${methodName}.${index}`
54: } else {
55: throw new IllegalArgumentException("argument config error : the index attribute and type attribute not match :index :" + argument.getIndex() + ", type:" + argument.getType());
56: }
57: } else {
58: // multiple callbacks in the method
59: for (int j = 0; j < argTypes.length; j++) {
60: Class<?> argClazz = argTypes[j];
61: if (argClazz.getName().equals(argument.getType())) {
62: // å°† ArgumentConfig å¯¹è±¡ï¼Œæ·»åŠ åˆ° `map` é›†åˆä¸­ã€‚
63: appendParameters(map, argument, method.getName() + "." + j); // `${methodName}.${index}`
64: if (argument.getIndex() != -1 && argument.getIndex() != j) { // å¤šä½™çš„åˆ¤æ–­ï¼Œå› ä¸º `argument.getIndex() == -1` ã€‚
65: throw new IllegalArgumentException("argument config error : the index attribute and type attribute not match :index :" + argument.getIndex() + ", type:" + argument.getType());
66: }
67: }
68: }
69: }
70: }
71: }
72: }
73: } else if (argument.getIndex() != -1) { // æŒ‡å®šå•ä¸ªå‚æ•°çš„ä½ç½®
74: // å°† ArgumentConfig å¯¹è±¡ï¼Œæ·»åŠ åˆ° `map` é›†åˆä¸­ã€‚
75: appendParameters(map, argument, method.getName() + "." + argument.getIndex()); // `${methodName}.${index}`
76: } else {
77: throw new IllegalArgumentException("argument config must set index or type attribute.eg: <dubbo:argument index='0' .../> or <dubbo:argument type=xxx .../>");
78: }
79:
80: }
81: }
82: } // end of methods for
83: }
84:
85: // genericã€methodsã€revision
86: if (ProtocolUtils.isGeneric(generic)) {
87: map.put("generic", generic);
88: map.put("methods", Constants.ANY_VALUE);
89: } else {
90: String revision = Version.getVersion(interfaceClass, version);
91: if (revision != null && revision.length() > 0) {
92: map.put("revision", revision); // ä¿®è®¢å·
93: }
94:
95: String[] methods = Wrapper.getWrapper(interfaceClass).getMethodNames(); // è·å¾—æ–¹æ³•æ•°ç»„
96: if (methods.length == 0) {
97: logger.warn("NO method found in service interface " + interfaceClass.getName());
98: map.put("methods", Constants.ANY_VALUE);
99: } else {
100: map.put("methods", StringUtils.join(new HashSet<String>(Arrays.asList(methods)), ","));
101: }
102: }
103: // token ï¼Œå‚è§ã€Šä»¤ç‰Œæ ¡éªŒã€‹http://dubbo.apache.org/zh-cn/docs/user/demos/token-authorization.html
104: if (!ConfigUtils.isEmpty(token)) {
105: if (ConfigUtils.isDefault(token)) {
106: map.put("token", UUID.randomUUID().toString());
107: } else {
108: map.put("token", token);
109: }
110: }
111: // åè®®ä¸º injvm æ—¶ï¼Œä¸æ³¨å†Œï¼Œä¸é€šçŸ¥ã€‚
112: if ("injvm".equals(protocolConfig.getName())) {
113: protocolConfig.setRegister(false);
114: map.put("notify", "false");
115: }
116: // export service
117: String contextPath = protocolConfig.getContextpath();
118: if ((contextPath == null || contextPath.length() == 0) && provider != null) {
119: contextPath = provider.getContextpath();
120: }
121:
122: // hostã€port
123: String host = this.findConfigedHosts(protocolConfig, registryURLs, map);
124: Integer port = this.findConfigedPorts(protocolConfig, name, map);
125:
126: // åˆ›å»º Dubbo URL å¯¹è±¡
127: URL url = new URL(name, host, port, (contextPath == null || contextPath.length() == 0 ? "" : contextPath + "/") + path, map);
128:
129: // é…ç½®è§„åˆ™ï¼Œå‚è§ã€Šé…ç½®è§„åˆ™ã€‹http://dubbo.apache.org/zh-cn/docs/user/demos/config-rule.html
130: if (ExtensionLoader.getExtensionLoader(ConfiguratorFactory.class)
131: .hasExtension(url.getProtocol())) {
132: url = ExtensionLoader.getExtensionLoader(ConfiguratorFactory.class)
133: .getExtension(url.getProtocol()).getConfigurator(url).configure(url);
134: }
135:
136: // çœç•¥ã€æœåŠ¡æš´éœ²ã€‘é€»è¾‘
137: }
```

- ç¬¬ 2 è‡³ 6 è¡Œï¼šåè®®åç©ºæ—¶ï¼Œç¼ºçœ

"dubbo"
ã€‚

- ç¬¬ 9 è¡Œï¼šåˆ›å»ºå‚æ•°é›†åˆ

map
ï¼Œç”¨äºä¸‹é¢åˆ›å»º Dubbo URL çš„ [
parameters
](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-common/src/main/java/com/alibaba/dubbo/common/URL.java#L109) å±æ€§ã€‚

- ç¬¬ 10 è‡³ 15 è¡Œï¼šå°†

side

dubbo

timestamp

timestamp

pid
æ·»åŠ åˆ°

map
ä¸­ã€‚

- ç¬¬ 16 è‡³ 21 è¡Œï¼šè°ƒç”¨

/#appendParameters(map, config)
æ–¹æ³•ï¼Œå°†å„ç§é…ç½®å¯¹è±¡æ·»åŠ åˆ°

map
ä¸­ã€‚

- ğŸ™‚

/#appendParameters(map, config)
æ–¹æ³•ï¼Œåœ¨ [ã€ŠAPI é…ç½®ï¼ˆä¸€ï¼‰ä¹‹åº”ç”¨ã€‹](http://svip.iocoder.cn/Dubbo/configuration-api-1/?self)

- ç¬¬ 22 è‡³ 83 è¡Œï¼šè°ƒç”¨ MethodConfig å¯¹è±¡**æ•°ç»„**ï¼Œæ·»åŠ åˆ°

map
ä¸­ã€‚

- ç›®çš„æ˜¯å°†**æ¯ä¸ª** MethodConfig å’Œå…¶å¯¹åº”çš„ ArgumentConfig å¯¹è±¡æ•°ç»„ï¼Œæ·»åŠ åˆ°

map
ä¸­ã€‚

- ğŸ™‚ ä»£ç æ¯”è¾ƒå†—é•¿ï¼Œèƒ–å‹è€å¿ƒçœ‹æ³¨é‡Šï¼Œå»ºè®®è¿›è¡Œè°ƒè¯•æ¯ç§æƒ…å†µã€‚
- ç¬¬ 85 è‡³ 102 è¡Œï¼šå°†

generic

methods

revision
åˆ°

map
ä¸­ã€‚

- revision
  ï¼Œå¯èƒ½æ¯”è¾ƒéš¾ç†è§£ï¼Œåœ¨ [ã€Œ10. Versionã€](http://svip.iocoder.cn/Dubbo/configuration-api-2/) è¯¦ç»†è§£æã€‚
- ç¬¬ 103 è‡³ 110 è¡Œï¼šå°†

token
æ·»åŠ åˆ°

map
ä¸­ã€‚

- [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” ä»¤ç‰ŒéªŒè¯ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/token-authorization.html)
- ç¬¬ 111 è‡³ 115 è¡Œï¼šå½“åè®®ä¸º

injvm
æ—¶ï¼Œæ·»åŠ 

notify = false
åˆ°

map
ä¸­ï¼Œè¡¨ç¤ºä¸æ³¨å†Œï¼Œä¸é€šçŸ¥ã€‚

- [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” æœ¬åœ°è°ƒç”¨ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/local-call.html)
- ç¬¬ 116 è‡³ 120 è¡Œï¼šè·å¾—

contextPath
ï¼ŒåŸºç¡€è·¯å¾„ï¼Œå³ java web åº”ç”¨ä¸­å¸¸è¯´çš„ context path ã€‚

- ç¬¬ 123 è¡Œï¼šè°ƒç”¨ [
  /#this.findConfigedHosts(protocolConfig, registryURLs, map)
  ](https://github.com/YunaiV/dubbo/blob/d3c3975f320c78452f96098b04441fed4c00ab70/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L661-L744) æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡æä¾›è€… Host ã€‚

- [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” ä¸»æœºç»‘å®šã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/hostname-binding.html)
- [ã€Šdubbo æ³¨å†ŒæœåŠ¡ IP è§£æå¼‚å¸¸åŠ IP è§£ææºç åˆ†æã€‹](https://segmentfault.com/a/1190000010550512)
- æŒ‡å®šæœåŠ¡æ³¨å†Œåœ°å€ï¼Œå‚è§ [dubbo-docker-sample](https://github.com/dubbo/dubbo-docker-sample) ç¤ºä¾‹é¡¹ç›®ã€‚
- ğŸ™‚ ä»£ç æ¯”è¾ƒå†—é•¿ï¼Œèƒ–å‹è€å¿ƒçœ‹æ³¨é‡Šï¼Œå»ºè®®è¿›è¡Œè°ƒè¯•æ¯ç§æƒ…å†µã€‚
- ç¬¬ 124 è¡Œï¼šè°ƒç”¨ [
  /#findConfigedHosts(protocolConfig, name, map)
  ](https://github.com/YunaiV/dubbo/blob/d3c3975f320c78452f96098b04441fed4c00ab70/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L746-L800) æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡æä¾›è€… Port ã€‚

- ğŸ™‚ ä»£ç æ¯”è¾ƒå†—é•¿ï¼Œèƒ–å‹è€å¿ƒçœ‹æ³¨é‡Šï¼Œå»ºè®®è¿›è¡Œè°ƒè¯•æ¯ç§æƒ…å†µã€‚
- ç¬¬ 127 è¡Œï¼šåˆ›å»º Dubbo URL ã€‚
- ç¬¬ 129 è‡³ 134 è¡Œï¼šé…ç½®è§„åˆ™ï¼Œåç»­è¯¦ç»†è§£æã€‚

- [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” é…ç½®è§„åˆ™ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/config-rule.html)
- ç¬¬ 136 è¡Œï¼š**çœç•¥**ã€æœåŠ¡æš´éœ²ã€‘é€»è¾‘ã€‚

# 9. ä¸ºä»€ä¹ˆç»§æ‰¿ï¼Ÿï¼Ÿï¼Ÿ

æˆ‘ä»¬ä»¥ ServiceConfig å’Œ ProviderConfig æ¥ä¸¾ä¾‹å­ï¼Œä¸¤è€…éƒ½ç»§æ‰¿ AbstractServiceConfigã€‚
ä»å±æ€§ä¸Šï¼Œä¸¤è€…æœ‰ç›¸åŒçš„å±æ€§ï¼Œä¾‹å¦‚

group
/

version
ã€‚
åŒæ—¶ï¼Œä¹Ÿå­˜åœ¨ç€ä¸€äº›å·®å¼‚ï¼Œä¾‹å¦‚

ServiceConfig.interfaceName
/

ProviderConfig.host
ã€‚

å¦å¤–ï¼Œæˆ‘ä»¬åœ¨çœ‹çœ‹ ServiceConfig å’Œ MethodConfig ï¼Œä¸¤è€…éƒ½ç»§æ‰¿ AbstractMethodConfigã€‚
åœ¨ ServiceConfig ä¸­ï¼Œå¯ä»¥é…ç½®ä¸‹å±æ‰€æœ‰æ–¹æ³•çš„

retries
æ¬¡æ•°ï¼Œä¹Ÿå¯ä»¥åœ¨ MethodConfig ä¸­**è‡ªå®šä¹‰**

retries
æ¬¡æ•°ã€‚

é€šè¿‡ç»§æ‰¿ï¼Œè·å¾—ç›¸åŒçš„å±æ€§ã€‚

# 10. Version

[
Version/#getVersion(cls, defaultVersion)
](https://github.com/alibaba/dubbo/blob/0423219d839404186b8a5ec7dec37f6addeb58d9/dubbo-common/src/main/java/com/alibaba/dubbo/common/Version.java) æ–¹æ³•ï¼Œè·å¾—ç‰ˆæœ¬å·ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: public static String getVersion(Class<?> cls, String defaultVersion){
2: try {
3: // find version info from MANIFEST.MF first
4: String version = cls.getPackage().getImplementationVersion();
5: if (version == null || version.length() == 0) {
6: version = cls.getPackage().getSpecificationVersion();
7: }
8: if (version == null || version.length() == 0) {
9: // guess version fro jar file name if nothing's found from MANIFEST.MF
10: CodeSource codeSource = cls.getProtectionDomain().getCodeSource();
11: if (codeSource == null) {
12: logger.info("No codeSource for class " + cls.getName() + " when getVersion, use default version " + defaultVersion);
13: } else {
14: String file = codeSource.getLocation().getFile();
15: if (file != null && file.length() > 0 && file.endsWith(".jar")) {
16: file = file.substring(0, file.length() - 4);
17: int i = file.lastIndexOf('/');
18: if (i >= 0) {
19: file = file.substring(i + 1);
20: }
21: i = file.indexOf("-");
22: if (i >= 0) {
23: file = file.substring(i + 1);
24: }
25: while (file.length() > 0 && !Character.isDigit(file.charAt(0))) {
26: i = file.indexOf("-");
27: if (i >= 0) {
28: file = file.substring(i + 1);
29: } else {
30: break;
31: }
32: }
33: version = file;
34: }
35: }
36: }
37: // return default version if no version info is found
38: return version == null || version.length() == 0 ? defaultVersion : version;
39: } catch (Throwable e) {
40: // return default version when any exception is thrown
41: logger.error("return default version, ignore exception " + e.getMessage(), e);
42: return defaultVersion;
43: }
44: }
```

- ç¬¬ 3 è‡³ 7 è¡Œï¼šä»

MAINFEST.MF
ä¸­è·å¾—ç‰ˆæœ¬å·ã€‚ä»¥ [spring-boot-starter-1.5.10.RELEASE.jar](http://central.maven.org/maven2/org/springframework/boot/spring-boot-starter/1.5.10.RELEASE/spring-boot-starter-1.5.10.RELEASE.jar) ä¸¾ä¾‹å­ï¼š![MAINFEST.MF](http://static2.iocoder.cn/images/Dubbo/2018_01_10/01.png)

- ç¬¬ 8 è‡³ 36 è¡Œï¼šè‹¥è·å–ä¸åˆ°ï¼Œä» jar åŒ…**å‘½å**ä¸­**å¯èƒ½**å¸¦çš„ç‰ˆæœ¬å·ä½œä¸ºç»“æœã€‚ä¾‹å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œ

  1.5.10.RELEASE
  ã€‚

- ç¬¬ 38 è¡Œï¼šè¿”å›ç‰ˆæœ¬å·ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿”å›é»˜è®¤ç‰ˆæœ¬å·ã€‚
