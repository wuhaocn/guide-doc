# æœåŠ¡æš´éœ²ï¼ˆäºŒï¼‰ä¹‹è¿œç¨‹æš´éœ²ï¼ˆDubboï¼‰

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æœåŠ¡æš´éœ²ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°æš´éœ²ï¼ˆInjvmï¼‰ã€‹](http://svip.iocoder.cn/Dubbo/service-export-local/?self) ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å·²ç»åˆ†äº«äº†**æœ¬åœ°æš´éœ²æœåŠ¡**ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æ¥åˆ†äº«**è¿œç¨‹æš´éœ²æœåŠ¡**ã€‚åœ¨ Dubbo ä¸­æä¾›å¤šç§åè®®( Protocol ) çš„å®ç°ï¼Œå¤§ä½“æµç¨‹ä¸€è‡´ï¼Œæœ¬æ–‡ä»¥ [Dubbo Protocol](http://dubbo.apache.org/zh-cn/docs/user/references/protocol/dubbo.html) ä¸ºä¾‹å­ï¼Œè¿™ä¹Ÿæ˜¯ Dubbo çš„**é»˜è®¤**åè®®ã€‚

å¦‚æœä¸ç†Ÿæ‚‰è¯¥åè®®çš„åŒå­¦ï¼Œå¯ä»¥å…ˆçœ‹çœ‹ [ã€ŠDubbo ä½¿ç”¨æŒ‡å— â€”â€” dubbo://ã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/protocol/dubbo.html) ï¼Œç®€å•äº†è§£å³å¯ã€‚
**ç‰¹æ€§**

ç¼ºçœåè®®ï¼Œä½¿ç”¨åŸºäº mina

1.1.7
å’Œ hessian

3.2.1
çš„ remoting äº¤äº’ã€‚

- è¿æ¥ä¸ªæ•°ï¼šå•è¿æ¥
- è¿æ¥æ–¹å¼ï¼šé•¿è¿æ¥
- ä¼ è¾“åè®®ï¼šTCP
- ä¼ è¾“æ–¹å¼ï¼šNIO å¼‚æ­¥ä¼ è¾“
- åºåˆ—åŒ–ï¼šHessian äºŒè¿›åˆ¶åºåˆ—åŒ–
- é€‚ç”¨èŒƒå›´ï¼šä¼ å…¥ä¼ å‡ºå‚æ•°æ•°æ®åŒ…è¾ƒå°ï¼ˆå»ºè®®å°äº 100Kï¼‰ï¼Œæ¶ˆè´¹è€…æ¯”æä¾›è€…ä¸ªæ•°å¤šï¼Œå•ä¸€æ¶ˆè´¹è€…æ— æ³•å‹æ»¡æä¾›è€…ï¼Œå°½é‡ä¸è¦ç”¨ dubbo åè®®ä¼ è¾“å¤§æ–‡ä»¶æˆ–è¶…å¤§å­—ç¬¦ä¸²ã€‚
- é€‚ç”¨åœºæ™¯ï¼šå¸¸è§„è¿œç¨‹æœåŠ¡æ–¹æ³•è°ƒç”¨

ç›¸æ¯”**æœ¬åœ°æš´éœ²**ï¼Œ**è¿œç¨‹æš´éœ²**ä¼šå¤šåšå¦‚ä¸‹å‡ ä»¶äº‹æƒ…ï¼š

- å¯åŠ¨é€šä¿¡æœåŠ¡å™¨ï¼Œç»‘å®šæœåŠ¡ç«¯å£ï¼Œæä¾›è¿œç¨‹è°ƒç”¨ã€‚
- å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡æä¾›è€…ï¼Œæä¾›æœåŠ¡æ¶ˆè´¹è€…ä»æ³¨å†Œä¸­å¿ƒå‘ç°æœåŠ¡ã€‚

# 2. è¿œç¨‹æš´éœ²

è¿œç¨‹æš´éœ²æœåŠ¡çš„é¡ºåºå›¾å¦‚ä¸‹ï¼š

![è¿œç¨‹æš´éœ²é¡ºåºå›¾](http://static2.iocoder.cn/images/Dubbo/2018_03_10/02.png)

åœ¨ [
/#doExportUrlsFor1Protocol(protocolConfig, registryURLs)
](https://github.com/YunaiV/dubbo/blob/c635dd1990a1803643194048f408db310f06175b/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L621-L648) æ–¹æ³•ä¸­ï¼Œæ¶‰åŠ**è¿œç¨‹æš´éœ²æœåŠ¡**çš„ä»£ç å¦‚ä¸‹ï¼š

```
1: // æœåŠ¡è¿œç¨‹æš´éœ²
2: // export to remote if the config is not local (export to local only when config is local)
3: if (!Constants.SCOPE_LOCAL.toString().equalsIgnoreCase(scope)) {
4: if (logger.isInfoEnabled()) {
5: logger.info("Export dubbo service " + interfaceClass.getName() + " to url " + url);
6: }
7: if (registryURLs != null && !registryURLs.isEmpty()) {
8: for (URL registryURL : registryURLs) {
9: // "dynamic" ï¼šæœåŠ¡æ˜¯å¦åŠ¨æ€æ³¨å†Œï¼Œå¦‚æœè®¾ä¸ºfalseï¼Œæ³¨å†Œåå°†æ˜¾ç¤ºådisableçŠ¶æ€ï¼Œéœ€äººå·¥å¯ç”¨ï¼Œå¹¶ä¸”æœåŠ¡æä¾›è€…åœæ­¢æ—¶ï¼Œä¹Ÿä¸ä¼šè‡ªåŠ¨å–æ¶ˆå†Œï¼Œéœ€äººå·¥ç¦ç”¨ã€‚
10: url = url.addParameterIfAbsent("dynamic", registryURL.getParameter("dynamic"));
11: // è·å¾—ç›‘æ§ä¸­å¿ƒ URL
12: URL monitorUrl = loadMonitor(registryURL); // TODO èŠ‹è‰¿ï¼Œç›‘æ§
13: if (monitorUrl != null) {
14: url = url.addParameterAndEncoded(Constants.MONITOR_KEY, monitorUrl.toFullString());
15: }
16: if (logger.isInfoEnabled()) {
17: logger.info("Register dubbo service " + interfaceClass.getName() + " url " + url + " to registry " + registryURL);
18: }
19: // ä½¿ç”¨ ProxyFactory åˆ›å»º Invoker å¯¹è±¡
20: Invoker<?> invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, registryURL.addParameterAndEncoded(Constants.EXPORT_KEY, url.toFullString()));
21:
22: // åˆ›å»º DelegateProviderMetaDataInvoker å¯¹è±¡
23: DelegateProviderMetaDataInvoker wrapperInvoker = new DelegateProviderMetaDataInvoker(invoker, this);
24:
25: // ä½¿ç”¨ Protocol æš´éœ² Invoker å¯¹è±¡
26: Exporter<?> exporter = protocol.export(wrapperInvoker);
27: // æ·»åŠ åˆ° `exporters`
28: exporters.add(exporter);
29: }
30: } else { // ç”¨äºè¢«æœåŠ¡æ¶ˆè´¹è€…ç›´è¿æœåŠ¡æä¾›è€…ï¼Œå‚è§æ–‡æ¡£ http://dubbo.apache.org/zh-cn/docs/user/demos/explicit-target.html ã€‚ä¸»è¦ç”¨äºå¼€å‘æµ‹è¯•ç¯å¢ƒä½¿ç”¨ã€‚
31: // ä½¿ç”¨ ProxyFactory åˆ›å»º Invoker å¯¹è±¡
32: Invoker<?> invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, url);
33:
34: // åˆ›å»º DelegateProviderMetaDataInvoker å¯¹è±¡
35: DelegateProviderMetaDataInvoker wrapperInvoker = new DelegateProviderMetaDataInvoker(invoker, this);
36:
37: // ä½¿ç”¨ Protocol æš´éœ² Invoker å¯¹è±¡
38: Exporter<?> exporter = protocol.export(wrapperInvoker);
39: // æ·»åŠ åˆ° `exporters`
40: exporters.add(exporter);
41: }
42: }
```

- ç¬¬ 30 è‡³ 41 è¡Œï¼š**å¤§ä½“å’Œã€ç¬¬ 7 è‡³ 29 è¡Œã€‘é€»è¾‘ç›¸åŒ**ã€‚å·®åˆ«åœ¨äºï¼Œå½“é…ç½®æ³¨å†Œä¸­å¿ƒä¸º

"N/A"
æ—¶ï¼Œè¡¨ç¤ºå³ä½¿è¿œç¨‹æš´éœ²æœåŠ¡ï¼Œä¹Ÿä¸å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œã€‚è¿™ç§æ–¹å¼ç”¨äºè¢«æœåŠ¡æ¶ˆè´¹è€…ç›´è¿æœåŠ¡æä¾›è€…ï¼Œå‚è§ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” ç›´è¿æä¾›è€…ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/explicit-target.html) æ–‡æ¡£ã€‚
åœ¨**å¼€å‘åŠæµ‹è¯•ç¯å¢ƒä¸‹**ï¼Œç»å¸¸éœ€è¦ç»•è¿‡æ³¨å†Œä¸­å¿ƒï¼Œåªæµ‹è¯•æŒ‡å®šæœåŠ¡æä¾›è€…ï¼Œè¿™æ—¶å€™å¯èƒ½éœ€è¦ç‚¹å¯¹ç‚¹ç›´è¿ï¼Œç‚¹å¯¹ç‚¹ç›´è”æ–¹å¼ï¼Œå°†ä»¥æœåŠ¡æ¥å£ä¸ºå•ä½ï¼Œå¿½ç•¥æ³¨å†Œä¸­å¿ƒçš„æä¾›è€…åˆ—è¡¨ï¼ŒA æ¥å£é…ç½®ç‚¹å¯¹ç‚¹ï¼Œä¸å½±å“ B æ¥å£ä»æ³¨å†Œä¸­å¿ƒè·å–åˆ—è¡¨ã€‚

- ç¬¬ 8 è¡Œï¼šå¾ªç¯ç¥–å†Œä¸­å¿ƒ URL æ•°ç»„

registryURLs
ã€‚

- ç¬¬ 10 è¡Œï¼š

"dynamic"
é…ç½®é¡¹ï¼ŒæœåŠ¡æ˜¯å¦åŠ¨æ€æ³¨å†Œã€‚å¦‚æœè®¾ä¸º **false** ï¼Œæ³¨å†Œåå°†æ˜¾ç¤ºå **disable** çŠ¶æ€ï¼Œéœ€äººå·¥å¯ç”¨ï¼Œå¹¶ä¸”æœåŠ¡æä¾›è€…åœæ­¢æ—¶ï¼Œä¹Ÿä¸ä¼šè‡ªåŠ¨å–æ¶ˆå†Œï¼Œéœ€äººå·¥ç¦ç”¨ã€‚

- ç¬¬ 12 è¡Œï¼šè°ƒç”¨

/#loadMonitor(registryURL)
æ–¹æ³•ï¼Œè·å¾—ç›‘æ§ä¸­å¿ƒ URL ã€‚

- ğŸ™‚ åœ¨ [ã€Œ2.1 loadMonitorã€](http://svip.iocoder.cn/Dubbo/service-export-remote-dubbo/) å°èŠ‚ï¼Œè¯¦ç»†è§£æã€‚
- ç¬¬ 13 è‡³ 15 è¡Œï¼šè°ƒç”¨ [
  URL/#addParameterAndEncoded(key, value)
  ](https://github.com/YunaiV/dubbo/blob/c635dd1990a1803643194048f408db310f06175b/dubbo-common/src/main/java/com/alibaba/dubbo/common/URL.java#L891-L896) æ–¹æ³•ï¼Œå°†ç›‘æ§ä¸­å¿ƒçš„ URL ä½œä¸º

"monitor"
å‚æ•°æ·»åŠ åˆ°æœåŠ¡æä¾›è€…çš„ URL ä¸­ï¼Œ**å¹¶ä¸”éœ€è¦ç¼–ç **ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼ŒæœåŠ¡æä¾›è€…çš„ URL ä¸­ï¼Œ**åŒ…å«äº†ç›‘æ§ä¸­å¿ƒçš„é…ç½®**ã€‚

- ç¬¬ 20 è¡Œï¼šè°ƒç”¨ [
  URL/#addParameterAndEncoded(key, value)
  ](https://github.com/YunaiV/dubbo/blob/c635dd1990a1803643194048f408db310f06175b/dubbo-common/src/main/java/com/alibaba/dubbo/common/URL.java#L891-L896) æ–¹æ³•ï¼Œå°†æœåŠ¡ä½“ç”¨è¿™çš„ URL ä½œä¸º

"export"
å‚æ•°æ·»åŠ åˆ°æ³¨å†Œä¸­å¿ƒçš„ URL ä¸­ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œæ³¨å†Œä¸­å¿ƒçš„ URL ä¸­ï¼Œ**åŒ…å«äº†æœåŠ¡æä¾›è€…çš„é…ç½®**ã€‚

- ç¬¬ 20 è¡Œï¼šè°ƒç”¨

ProxyFactory/#getInvoker(proxy, type, url)
æ–¹æ³•ï¼Œåˆ›å»º Invoker å¯¹è±¡ã€‚è¯¥ Invoker å¯¹è±¡ï¼Œæ‰§è¡Œ

/#invoke(invocation)
æ–¹æ³•æ—¶ï¼Œå†…éƒ¨ä¼šè°ƒç”¨ Service å¯¹è±¡(

ref
)å¯¹åº”çš„è°ƒç”¨æ–¹æ³•ã€‚

- ğŸ™‚ è¯¦ç»†çš„å®ç°ï¼Œåé¢å•ç‹¬å†™æ–‡ç« åˆ†äº«ã€‚
- ğŸ˜ˆ ä¸ºä»€ä¹ˆä¼ é€’çš„æ˜¯**æ³¨å†Œä¸­å¿ƒçš„ URL** å‘¢ï¼Ÿä¸‹æ–‡ä¼šè¯¦ç»†è§£æã€‚
- ç¬¬ 23 è¡Œï¼šåˆ›å»º [
  com.alibaba.dubbo.config.invoker.DelegateProviderMetaDataInvoker
  ](https://github.com/YunaiV/dubbo/blob/c635dd1990a1803643194048f408db310f06175b/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/invoker/DelegateProviderMetaDataInvoker.java) å¯¹è±¡ã€‚è¯¥å¯¹è±¡åœ¨ Invoker å¯¹è±¡çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†å½“å‰æœåŠ¡æä¾›è€… ServiceConfig å¯¹è±¡ã€‚
- ç¬¬ 26 è¡Œï¼šè°ƒç”¨

Protocol/#export(invoker)
æ–¹æ³•ï¼Œæš´éœ²æœåŠ¡ã€‚

- æ­¤å¤„ Dubbo SPI **è‡ªé€‚åº”**çš„ç‰¹æ€§çš„**å¥½å¤„**å°±å‡ºæ¥äº†ï¼Œå¯ä»¥**è‡ªåŠ¨**æ ¹æ® URL å‚æ•°ï¼Œè·å¾—å¯¹åº”çš„æ‹“å±•å®ç°ã€‚ä¾‹å¦‚ï¼Œ

invoker
ä¼ å…¥åï¼Œæ ¹æ®

invoker.url
è‡ªåŠ¨è·å¾—å¯¹åº” Protocol æ‹“å±•å®ç°ä¸º DubboProtocol ã€‚

- å®é™…ä¸Šï¼ŒProtocol æœ‰ä¸¤ä¸ª Wrapper æ‹“å±•å®ç°ç±»ï¼š ProtocolFilterWrapperã€ProtocolListenerWrapper ã€‚æ‰€ä»¥ï¼Œ

/#export(...)
æ–¹æ³•çš„è°ƒç”¨é¡ºåºæ˜¯ï¼š

- **Protocol$Adaptive => ProtocolFilterWrapper => ProtocolListenerWrapper => RegistryProtocol**
- =>
- **Protocol$Adaptive => ProtocolFilterWrapper => ProtocolListenerWrapper => DubboProtocol**
- ä¹Ÿå°±æ˜¯è¯´ï¼Œ**è¿™ä¸€æ¡å¤§çš„è°ƒç”¨é“¾ï¼ŒåŒ…å«ä¸¤æ¡å°çš„è°ƒç”¨é“¾**ã€‚åŸå› æ˜¯ï¼š

- é¦–å…ˆï¼Œä¼ å…¥çš„æ˜¯æ³¨å†Œä¸­å¿ƒçš„ URL ï¼Œé€šè¿‡ Protocol$Adaptive è·å–åˆ°çš„æ˜¯ RegistryProtocol å¯¹è±¡ã€‚
- å…¶æ¬¡ï¼ŒRegistryProtocol ä¼šåœ¨å…¶

/#export(...)
æ–¹æ³•ä¸­ï¼Œä½¿ç”¨æœåŠ¡æä¾›è€…çš„ URL ( å³æ³¨å†Œä¸­å¿ƒçš„ URL çš„

export
å‚æ•°å€¼)ï¼Œå†æ¬¡è°ƒç”¨ Protocol$Adaptive è·å–åˆ°çš„æ˜¯ DubboProtocol å¯¹è±¡ï¼Œè¿›è¡ŒæœåŠ¡æš´éœ²ã€‚

- **ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„é¡ºåº**ï¼Ÿé€šè¿‡è¿™æ ·çš„é¡ºåºï¼Œå¯ä»¥å®ç°ç±»ä¼¼ **AOP** çš„æ•ˆæœï¼Œåœ¨æœ¬åœ°æœåŠ¡å™¨å¯åŠ¨å®Œæˆåï¼Œå†å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œã€‚ä¼ªä»£ç å¦‚ä¸‹ï¼š

```
RegistryProtocol/#export(...) {
// 1. å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨
DubboProtocol/#export(...);
// 2. å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œã€‚
}
```

- è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸Šæ–‡æåˆ°çš„ â€œä¸ºä»€ä¹ˆä¼ é€’çš„æ˜¯**æ³¨å†Œä¸­å¿ƒçš„ URL** å‘¢ï¼Ÿâ€ çš„åŸå› ã€‚
- ğŸ™‚ å¦‚æœæ— æ³•ç†è§£ï¼Œåœ¨ [ã€Œ3. Protocolã€](http://svip.iocoder.cn/Dubbo/service-export-remote-dubbo/) åœ¨è§£æä»£ç ï¼Œè¿›ä¸€æ­¥ç†é¡ºã€‚
- ç¬¬ 28 è¡Œï¼šæ·»åŠ åˆ°

exporters
é›†åˆä¸­ã€‚

## 2.1 loadMonitor

å‹æƒ…æç¤ºï¼Œç›‘æ§ä¸­å¿ƒä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œç®€å•åˆ†äº«ä¸‹è¯¥æ–¹æ³•çš„é€»è¾‘ã€‚
å¯ç›´æ¥è·³è¿‡ã€‚

/#loadMonitor(registryURL)
æ–¹æ³•ï¼ŒåŠ è½½ç›‘æ§ä¸­å¿ƒ

com.alibaba.dubbo.common.URL
æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: //*/*
2: /* åŠ è½½ç›‘æ§ä¸­å¿ƒ URL
3: /*
4: /* @param registryURL æ³¨å†Œä¸­å¿ƒ URL
5: /* @return ç›‘æ§ä¸­å¿ƒ URL
6: /*/
7: protected URL loadMonitor(URL registryURL){
8: // ä» å±æ€§é…ç½® ä¸­åŠ è½½é…ç½®åˆ° MonitorConfig å¯¹è±¡ã€‚
9: if (monitor == null) {
10: String monitorAddress = ConfigUtils.getProperty("dubbo.monitor.address");
11: String monitorProtocol = ConfigUtils.getProperty("dubbo.monitor.protocol");
12: if ((monitorAddress == null || monitorAddress.length() == 0) && (monitorProtocol == null || monitorProtocol.length() == 0)) {
13: return null;
14: }
15:
16: monitor = new MonitorConfig();
17: if (monitorAddress != null && monitorAddress.length() > 0) {
18: monitor.setAddress(monitorAddress);
19: }
20: if (monitorProtocol != null && monitorProtocol.length() > 0) {
21: monitor.setProtocol(monitorProtocol);
22: }
23: }
24: appendProperties(monitor);
25: // æ·»åŠ  `interface` `dubbo` `timestamp` `pid` åˆ° `map` é›†åˆä¸­
26: Map<String, String> map = new HashMap<String, String>();
27: map.put(Constants.INTERFACE_KEY, MonitorService.class.getName());
28: map.put("dubbo", Version.getVersion());
29: map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));
30: if (ConfigUtils.getPid() > 0) {
31: map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));
32: }
33: // å°† MonitorConfig ï¼Œæ·»åŠ åˆ° `map` é›†åˆä¸­ã€‚
34: appendParameters(map, monitor);
35: // è·å¾—åœ°å€
36: String address = monitor.getAddress();
37: String sysaddress = System.getProperty("dubbo.monitor.address");
38: if (sysaddress != null && sysaddress.length() > 0) {
39: address = sysaddress;
40: }
41: // ç›´è¿ç›‘æ§ä¸­å¿ƒæœåŠ¡å™¨åœ°å€
42: if (ConfigUtils.isNotEmpty(address)) {
43: // è‹¥ä¸å­˜åœ¨ `protocol` å‚æ•°ï¼Œé»˜è®¤ "dubbo" æ·»åŠ åˆ° `map` é›†åˆä¸­ã€‚
44: if (!map.containsKey(Constants.PROTOCOL_KEY)) {
45: if (ExtensionLoader.getExtensionLoader(MonitorFactory.class).hasExtension("logstat")) {
46: map.put(Constants.PROTOCOL_KEY, "logstat");
47: } else {
48: map.put(Constants.PROTOCOL_KEY, "dubbo");
49: }
50: }
51: // è§£æåœ°å€ï¼Œåˆ›å»º Dubbo URL å¯¹è±¡ã€‚
52: return UrlUtils.parseURL(address, map);
53: // ä»æ³¨å†Œä¸­å¿ƒå‘ç°ç›‘æ§ä¸­å¿ƒåœ°å€
54: } else if (Constants.REGISTRY_PROTOCOL.equals(monitor.getProtocol()) && registryURL != null) {
55: return registryURL.setProtocol("dubbo").addParameter(Constants.PROTOCOL_KEY, "registry").addParameterAndEncoded(Constants.REFER_KEY, StringUtils.toQueryString(map));
56: }
57: return null;
58: }
```

- ç¬¬ 8 è‡³ 24 è¡Œï¼šä»**å±æ€§é…ç½®**ä¸­ï¼ŒåŠ è½½é…ç½®åˆ° MonitorConfig å¯¹è±¡ã€‚
- ç¬¬ 25 è‡³ 32 è¡Œï¼šæ·»åŠ 

interface

dubbo

timestamp

pid
åˆ°

map
é›†åˆä¸­ã€‚

- ç¬¬ 34 è¡Œï¼šè°ƒç”¨

/#appendParameters(map, config)
æ–¹æ³•ï¼Œå°† MonitorConfig ï¼Œæ·»åŠ åˆ°

map
é›†åˆä¸­ã€‚

- ç¬¬ 35 è‡³ 40 è¡Œï¼šè·å¾—**ç›‘æ§ä¸­å¿ƒ**çš„åœ°å€ã€‚
- ç¬¬ 42 è¡Œï¼šå½“

address
éç©ºæ—¶ï¼Œ**ç›´è¿ç›‘æ§ä¸­å¿ƒæœåŠ¡å™¨åœ°å€çš„æƒ…å†µ**ã€‚

- ç¬¬ 43 è‡³ 50 è¡Œï¼šè‹¥ä¸å­˜åœ¨

protocol
å‚æ•°ï¼Œç¼ºçœé»˜è®¤ä¸º â€œdubboâ€ ï¼Œå¹¶æ·»åŠ åˆ°

map
é›†åˆä¸­ã€‚

- ç¬¬ 44 è‡³ 55 è¡Œï¼š**å¯ä»¥å¿½ç•¥**ã€‚å› ä¸ºï¼Œ

logstat
è¿™ä¸ªæ‹“å±•å®ç°å·²ç»ä¸å­˜åœ¨ã€‚

- ç¬¬ 52 è¡Œï¼šè°ƒç”¨ [
  UrlUtils/#parseURL(address, map)
  ](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/UrlUtils.java#L30-L145) æ–¹æ³•ï¼Œè§£æ

address
ï¼Œåˆ›å»º Dubbo URL å¯¹è±¡ã€‚

- ğŸ™‚ å·²ç»æ·»åŠ äº†ä»£ç æ³¨é‡Šï¼Œèƒ–å‹ç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚
- ç¬¬ 54 è‡³ 56 è¡Œï¼šå½“

protocol = registry
æ—¶ï¼Œå¹¶ä¸”æ³¨å†Œä¸­å¿ƒ URL éç©ºæ—¶ï¼Œ**ä»æ³¨å†Œä¸­å¿ƒå‘ç°ç›‘æ§ä¸­å¿ƒåœ°å€**ã€‚ä»¥

registryURL
ä¸ºåŸºç¡€ï¼Œåˆ›å»º URL ï¼š

- protocol = dubbo
- parameters.protocol = registry
- parameters.refer = map
- ç¬¬ 57 è¡Œï¼š**æ— æ³¨å†Œä¸­å¿ƒ**ï¼Œè¿”å›ç©ºã€‚
- ps ï¼šåç»­ä¼šæœ‰æ–‡ç« ï¼Œè¯¦ç»†åˆ†äº«ã€‚

# 3. Protocol

æœ¬æ–‡æ¶‰åŠçš„ Protocol ç±»å›¾å¦‚ä¸‹ï¼š

![Protocol ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_03_10/04.png)

## 3.1 ProtocolFilterWrapper

æ¥ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æœåŠ¡æš´éœ²ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°æš´éœ²ï¼ˆInjvmï¼‰ã€‹ã€Œ 3.2 ProtocolFilterWrapperã€](http://svip.iocoder.cn/Dubbo/service-export-local/?self)å°èŠ‚ã€‚

/#export(invoker)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
1: public <T> Exporter<T> export(Invoker<T> invoker) throws RpcException{
2: // æ³¨å†Œä¸­å¿ƒ
3: if (Constants.REGISTRY_PROTOCOL.equals(invoker.getUrl().getProtocol())) {
4: return protocol.export(invoker);
5: }
6: // å»ºç«‹å¸¦æœ‰ Filter è¿‡æ»¤é“¾çš„ Invoker ï¼Œå†æš´éœ²æœåŠ¡ã€‚
7: return protocol.export(buildInvokerChain(invoker, Constants.SERVICE_FILTER_KEY, Constants.PROVIDER));
8: }
```

- ç¬¬ 2 è‡³ 5 è¡Œï¼šå½“

invoker.url.protocl = registry
ï¼Œ**æ³¨å†Œä¸­å¿ƒçš„ URL** ï¼Œæ— éœ€åˆ›å»º Filter è¿‡æ»¤é“¾ã€‚

- ç¬¬ 7 è¡Œï¼šè°ƒç”¨

/#buildInvokerChain(invoker, key, group)
æ–¹æ³•ï¼Œåˆ›å»ºå¸¦æœ‰ Filter è¿‡æ»¤é“¾çš„ Invoker å¯¹è±¡ã€‚

- ç¬¬ 7 è¡Œï¼šè°ƒç”¨

protocol/#export(invoker)
æ–¹æ³•ï¼Œç»§ç»­æš´éœ²æœåŠ¡ã€‚

- åœ¨ RegistryProtocol ä¸­ï¼Œä¼šè°ƒç”¨

DubboProtocol/#export(...)
æ–¹æ³•æ—¶ï¼Œä¼šèµ°ã€**ç¬¬ 7 è¡Œ**ã€‘çš„æµç¨‹ã€‚

## 3.2 RegistryProtocol

[
com.alibaba.dubbo.registry.integration.RegistryProtocol
](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/integration/RegistryProtocol.java) ï¼Œå®ç° Protocol æ¥å£ï¼Œæ³¨å†Œä¸­å¿ƒåè®®å®ç°ç±»ã€‚

### 3.2.1 å±æ€§

å±æ€§ç›¸å…³ï¼Œä»£ç å¦‚ä¸‹ï¼š
å‹æƒ…æç¤ºï¼Œä»…åŒ…å«æœ¬æ–‡æ¶‰åŠçš„å±æ€§ã€‚

```
// ... çœç•¥éƒ¨åˆ†å’Œæœ¬æ–‡æ— å…³çš„å±æ€§ã€‚
//*/*
/* å•ä¾‹ã€‚åœ¨ Dubbo SPI ä¸­ï¼Œè¢«åˆå§‹åŒ–ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€æ¬¡ã€‚
/*/
private static RegistryProtocol INSTANCE;
//*/*
/* ç»‘å®šå…³ç³»é›†åˆã€‚
/*
/* keyï¼šæœåŠ¡ Dubbo URL
/*/
// To solve the problem of RMI repeated exposure port conflicts, the services that have been exposed are no longer exposed.
// ç”¨äºè§£å†³rmié‡å¤æš´éœ²ç«¯å£å†²çªçš„é—®é¢˜ï¼Œå·²ç»æš´éœ²è¿‡çš„æœåŠ¡ä¸å†é‡æ–°æš´éœ²
// providerurl <--> exporter
private final Map<String, ExporterChangeableWrapper<?>> bounds = new ConcurrentHashMap<String, ExporterChangeableWrapper<?>>();
//*/*
/* Protocol è‡ªé€‚åº”æ‹“å±•å®ç°ç±»ï¼Œé€šè¿‡ Dubbo SPI è‡ªåŠ¨æ³¨å…¥ã€‚
/*/
private Protocol protocol;
//*/*
/* RegistryFactory è‡ªé€‚åº”æ‹“å±•å®ç°ç±»ï¼Œé€šè¿‡ Dubbo SPI è‡ªåŠ¨æ³¨å…¥ã€‚
/*/
private RegistryFactory registryFactory;
public RegistryProtocol(){
INSTANCE = this;
}
public static RegistryProtocol getRegistryProtocol(){
if (INSTANCE == null) {
ExtensionLoader.getExtensionLoader(Protocol.class).getExtension(Constants.REGISTRY_PROTOCOL); // load
}
return INSTANCE;
}
```

- INSTANCE
  **é™æ€**å±æ€§ï¼Œå•ä¾‹ã€‚é€šè¿‡ Dubbo SPI åŠ è½½åˆ›å»ºï¼Œæœ‰ä¸”ä»…æœ‰ä¸€æ¬¡ã€‚

- /#getRegistryProtocol()
  **é™æ€**æ–¹æ³•ï¼Œè·å¾—å•ä¾‹ã€‚
- bounds
  å±æ€§ï¼Œç»‘å®šå…³ç³»é›†åˆã€‚å…¶ä¸­ï¼ŒKey ä¸º**æœåŠ¡æä¾›è€… URL** ã€‚
- protocol
  å±æ€§ï¼ŒProtocol è‡ªé€‚åº”æ‹“å±•å®ç°ç±»ï¼Œé€šè¿‡ Dubbo SPI è‡ªåŠ¨æ³¨å…¥ã€‚
- registryFactory
  å±æ€§ï¼Œè‡ªé€‚åº”æ‹“å±•å®ç°ç±»ï¼Œé€šè¿‡ Dubbo SPI è‡ªåŠ¨æ³¨å…¥ã€‚

- ç”¨äºåˆ›å»ºæ³¨å†Œä¸­å¿ƒ Registry å¯¹è±¡ã€‚

### 3.2.2 export

æœ¬æ–‡æ¶‰åŠçš„

/#export(invoker)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
1: public <T> Exporter<T> export(final Invoker<T> originInvoker) throws RpcException{
2: // æš´éœ²æœåŠ¡
3: // export invoker
4: final ExporterChangeableWrapper<T> exporter = doLocalExport(originInvoker);
5:
6: // è·å¾—æ³¨å†Œä¸­å¿ƒ URL
7: URL registryUrl = getRegistryUrl(originInvoker);
8:
9: // è·å¾—æ³¨å†Œä¸­å¿ƒå¯¹è±¡
10: // registry provider
11: final Registry registry = getRegistry(originInvoker);
12:
13: // è·å¾—æœåŠ¡æä¾›è€… URL
14: final URL registedProviderUrl = getRegistedProviderUrl(originInvoker);
15:
16: //to judge to delay publish whether or not
17: boolean register = registedProviderUrl.getParameter("register", true);
18:
19: // å‘æœ¬åœ°æ³¨å†Œè¡¨ï¼Œæ³¨å†ŒæœåŠ¡æä¾›è€…
20: ProviderConsumerRegTable.registerProvider(originInvoker, registryUrl, registedProviderUrl);
21:
22: // å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡æä¾›è€…ï¼ˆè‡ªå·±ï¼‰
23: if (register) {
24: register(registryUrl, registedProviderUrl);
25: ProviderConsumerRegTable.getProviderWrapper(originInvoker).setReg(true); // æ ‡è®°å‘æœ¬åœ°æ³¨å†Œè¡¨çš„æ³¨å†ŒæœåŠ¡æä¾›è€…ï¼Œå·²ç»æ³¨å†Œ
26: }
27:
28: // ä½¿ç”¨ OverrideListener å¯¹è±¡ï¼Œè®¢é˜…é…ç½®è§„åˆ™
29: // Subscribe the override data
30: // FIXME When the provider subscribes, it will affect the scene : a certain JVM exposes the service and call the same service. Because the subscribed is cached key with the name of the service, it causes the subscription information to cover.
31: final URL overrideSubscribeUrl = getSubscribedOverrideUrl(registedProviderUrl);
32: final OverrideListener overrideSubscribeListener = new OverrideListener(overrideSubscribeUrl, originInvoker);
33: overrideListeners.put(overrideSubscribeUrl, overrideSubscribeListener);
34: registry.subscribe(overrideSubscribeUrl, overrideSubscribeListener);
35: //Ensure that a new exporter instance is returned every time export
36: return new DestroyableExporter<T>(exporter, originInvoker, overrideSubscribeUrl, registedProviderUrl);
37: }
```

- ç¬¬ 4 è¡Œï¼šè°ƒç”¨

/#doLocalExport(invoker)
æ–¹æ³•ï¼Œæš´éœ²æœåŠ¡ã€‚

- ç¬¬ 7 è¡Œï¼šè°ƒç”¨

/#getRegistryUrl(originInvoker)
æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œä¸­å¿ƒ URL ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
//*/*
/* è·å¾—æ³¨å†Œä¸­å¿ƒ URL
/*
/* @param originInvoker åŸå§‹ Invoker
/* @return URL
/*/
private URL getRegistryUrl(Invoker<?> originInvoker){
URL registryUrl = originInvoker.getUrl();
if (Constants.REGISTRY_PROTOCOL.equals(registryUrl.getProtocol())) { // protocol
String protocol = registryUrl.getParameter(Constants.REGISTRY_KEY, Constants.DEFAULT_DIRECTORY);
registryUrl = registryUrl.setProtocol(protocol).removeParameter(Constants.REGISTRY_KEY);
}
return registryUrl;
}
```

- è¯¥è¿‡ç¨‹æ˜¯æˆ‘ä»¬åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æœåŠ¡æš´éœ²ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°æš´éœ²ï¼ˆInjvmï¼‰ã€‹ã€Œ2.1 loadRegistriesã€](http://svip.iocoder.cn/Dubbo/service-export-remote-dubbo/) çš„é‚£å¼ å›¾çš„åå‘æµç¨‹ï¼Œå³**çº¢çº¿éƒ¨åˆ†** ï¼š![getRegistryUrl](http://static2.iocoder.cn/images/Dubbo/2018_03_10/01.png)
- ç¬¬ 11 è¡Œï¼šè·å¾—æ³¨å†Œä¸­å¿ƒå¯¹è±¡ã€‚
- ç¬¬ 14 è¡Œï¼šè°ƒç”¨

/#getRegistedProviderUrl(originInvoker)
æ–¹æ³•ï¼Œè·å¾—æœåŠ¡æä¾›è€… URL ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
private URL getRegistedProviderUrl(final Invoker<?> originInvoker){
// ä»æ³¨å†Œä¸­å¿ƒçš„ export å‚æ•°ä¸­ï¼Œè·å¾—æœåŠ¡æä¾›è€…çš„ URL
URL providerUrl = getProviderUrl(originInvoker);
//The address you see at the registry
return providerUrl.removeParameters(getFilteredKeys(providerUrl)) // ç§»é™¤ .hide ä¸ºå‰ç¼€çš„å‚æ•°
.removeParameter(Constants.MONITOR_KEY) // monitor
.removeParameter(Constants.BIND_IP_KEY) // bind.ip
.removeParameter(Constants.BIND_PORT_KEY) // bind.port
.removeParameter(QOS_ENABLE) // qos.enable
.removeParameter(QOS_PORT) // qos.port
.removeParameter(ACCEPT_FOREIGN_IP); // qos.accept.foreign.ip
}
private URL getProviderUrl(final Invoker<?> origininvoker){
String export = origininvoker.getUrl().getParameterAndDecoded(Constants.EXPORT_KEY); // export
if (export == null || export.length() == 0) {
throw new IllegalArgumentException("The registry export url is null! registry: " + origininvoker.getUrl());
}
return URL.valueOf(export);
}
private static String[] getFilteredKeys(URL url) {
Map<String, String> params = url.getParameters();
if (params != null && !params.isEmpty()) {
List<String> filteredKeys = new ArrayList<String>();
for (Map.Entry<String, String> entry : params.entrySet()) {
if (entry != null && entry.getKey() != null && entry.getKey().startsWith(Constants.HIDE_KEY_PREFIX)) {
filteredKeys.add(entry.getKey());
}
}
return filteredKeys.toArray(new String[filteredKeys.size()]);
} else {
return new String[]{};
}
}
```

- **é‡ç‚¹**ï¼Œä»æ³¨å†Œä¸­å¿ƒçš„ URL ä¸­è·å¾—

export
å‚æ•°å¯¹åº”çš„å€¼ï¼Œå³æœåŠ¡æä¾›è€…çš„ URL ã€‚

- ç§»é™¤**å¤šä½™**çš„å‚æ•°ã€‚å› ä¸ºï¼Œè¿™äº›å‚æ•°æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒæ²¡æœ‰å®é™…çš„ç”¨é€”ã€‚
- ç¬¬ 17 è¡Œï¼šé…ç½®é¡¹

register
ï¼ŒæœåŠ¡æä¾›è€…æ˜¯å¦æ³¨å†Œåˆ°é…ç½®ä¸­å¿ƒã€‚

- ç¬¬ 20 è¡Œï¼šè°ƒç”¨

ProviderConsumerRegTable/#registerProvider(invoker, registryUrl)
æ–¹æ³•ï¼Œå‘æœ¬åœ°æ³¨å†Œè¡¨ï¼Œæ³¨å†ŒæœåŠ¡æä¾›è€…ã€‚

- åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹ã€Œ5. ProviderConsumerRegTableã€](http://svip.iocoder.cn/Dubbo/registry-api/?self)ï¼Œæœ‰è¯¦ç»†è§£æã€‚
- ç¬¬ 24 è¡Œï¼šè°ƒç”¨

/#register(registryUrl, registedProviderUrl)
æ–¹æ³•ï¼Œå‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡æä¾›è€…ï¼ˆè‡ªå·±ï¼‰ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public void register(URL registryUrl, URL registedProviderUrl){
Registry registry = registryFactory.getRegistry(registryUrl);
registry.register(registedProviderUrl);
}
```

- è°ƒç”¨

RegistryService/#register(url)
æ–¹æ³•ï¼Œåœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹ã€Œ3. RegistryServiceã€](http://svip.iocoder.cn/Dubbo/registry-api/?self)ï¼Œæœ‰è¯¦ç»†è§£æã€‚

- ç¬¬ 25 è¡Œï¼šæ ‡è®°å‘æœ¬åœ°æ³¨å†Œè¡¨çš„æ³¨å†ŒæœåŠ¡æä¾›è€…ï¼Œå·²ç»æ³¨å†Œã€‚

- åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹ã€Œ5. ProviderConsumerRegTableã€](http://svip.iocoder.cn/Dubbo/registry-api/?self)ï¼Œæœ‰è¯¦ç»†è§£æã€‚
- ç¬¬ 28 è‡³ 34 è¡Œï¼šä½¿ç”¨ OverrideListener å¯¹è±¡ï¼Œè®¢é˜…é…ç½®è§„åˆ™ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Šç²¾å°½ Dubbo æºç è§£æ â€”â€” é›†ç¾¤å®¹é”™ï¼ˆå…­ï¼‰ä¹‹ Configurator å®ç°ã€‹](http://svip.iocoder.cn/Dubbo/cluster-6-impl-configurator?self) ä¸­ã€‚
- ç¬¬ 36 è¡Œï¼šåˆ›å»º DestroyableExporter å¯¹è±¡ã€‚

### 3.2.3 doLocalExport

/#doLocalExport()
æ–¹æ³•ï¼Œæš´éœ²æœåŠ¡ã€‚**æ­¤å¤„çš„ Local æŒ‡çš„æ˜¯ï¼Œæœ¬åœ°å¯åŠ¨æœåŠ¡ï¼Œä½†æ˜¯ä¸åŒ…æ‹¬å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡çš„æ„æ€**ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: //*/*
2: /* æš´éœ²æœåŠ¡ã€‚
3: /*
4: /* æ­¤å¤„çš„ Local æŒ‡çš„æ˜¯ï¼Œæœ¬åœ°å¯åŠ¨æœåŠ¡ï¼Œä½†æ˜¯ä¸åŒ…æ‹¬å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡çš„æ„æ€ã€‚
5: /*
6: /* @param originInvoker åŸå§‹ Invoker
7: /* @param <T> æ³›å‹
8: /* @return Exporter å¯¹è±¡
9: /*/
10: @SuppressWarnings("unchecked")
11: private <T> ExporterChangeableWrapper<T> doLocalExport(final Invoker<T> originInvoker){
12: // è·å¾—åœ¨ `bounds` ä¸­çš„ç¼“å­˜ Key
13: String key = getCacheKey(originInvoker);
14: // ä» `bounds` è·å¾—ï¼Œæ˜¯ä¸æ˜¯å·²ç»æš´éœ²è¿‡æœåŠ¡
15: ExporterChangeableWrapper<T> exporter = (ExporterChangeableWrapper<T>) bounds.get(key);
16: if (exporter == null) {
17: synchronized (bounds) {
18: exporter = (ExporterChangeableWrapper<T>) bounds.get(key);
19: // æœªæš´éœ²è¿‡ï¼Œè¿›è¡Œæš´éœ²æœåŠ¡
20: if (exporter == null) {
21: // åˆ›å»º Invoker Delegate å¯¹è±¡
22: final Invoker<?> invokerDelegete = new InvokerDelegete<T>(originInvoker, getProviderUrl(originInvoker));
23: // æš´éœ²æœåŠ¡ï¼Œåˆ›å»º Exporter å¯¹è±¡
24: // ä½¿ç”¨ åˆ›å»ºçš„Exporterå¯¹è±¡ + originInvoker ï¼Œåˆ›å»º ExporterChangeableWrapper å¯¹è±¡
25: exporter = new ExporterChangeableWrapper<T>((Exporter<T>) protocol.export(invokerDelegete), originInvoker);
26: // æ·»åŠ åˆ° `bounds`
27: bounds.put(key, exporter);
28: }
29: }
30: }
31: return exporter;
32: }
```

- ç¬¬ 13 è¡Œï¼šè°ƒç”¨

/#getCacheKey(originInvoker)
æ–¹æ³•ï¼Œè·å¾—åœ¨

bounds
ä¸­çš„ç¼“å­˜ Key ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
//*/*
/* Get the key cached in bounds by invoker
/*
/* è· å–invoker åœ¨ boundsä¸­ ç¼“å­˜çš„key
/*
/* @param originInvoker åŸå§‹ Invoker
/* @return url å­—ç¬¦ä¸²
/*/
private String getCacheKey(final Invoker<?> originInvoker){
URL providerUrl = getProviderUrl(originInvoker);
return providerUrl.removeParameters("dynamic", "enabled").toFullString();
}
```

- ç¬¬ 14 è‡³ 18 è¡Œï¼šä»

bounds
ä¸­ï¼Œè·å¾—å·²ç»æš´éœ²è¿‡çš„ ExporterChangeableWrapper å¯¹è±¡ã€‚

- ç¬¬ 20 è‡³ 28 è¡Œï¼šæœªæš´éœ²è¿‡ï¼Œè¿›è¡Œæš´éœ²æœåŠ¡ã€‚

- ç¬¬ 22 è¡Œï¼šè°ƒç”¨

/#getProviderUrl(originInvoker)
æ–¹æ³•ï¼Œè·å¾—æœåŠ¡æä¾›è€…çš„ URL ã€‚

- ç¬¬ 22 è¡Œï¼šåˆ›å»º [
  com.alibaba.dubbo.registry.integration.RegistryProtocol.InvokerDelegete
  ](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/integration/RegistryProtocol.java#L320-L339)å¯¹è±¡ã€‚

- InvokerDelegete å®ç° [
  com.alibaba.dubbo.rpc.protocol.InvokerWrapper
  ](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/protocol/InvokerWrapper.java) ç±»ï¼Œä¸»è¦å¢åŠ äº†

/#getInvoker()
æ–¹æ³•ï¼Œè·å¾—çœŸå®çš„ï¼Œé InvokerDelegete çš„ Invoker å¯¹è±¡ã€‚å› ä¸ºï¼Œå¯èƒ½ä¼šå­˜åœ¨

InvokerDelegete.invoker
ä¹Ÿæ˜¯ InvokerDelegete ç±»å‹çš„æƒ…å†µã€‚

- ç¬¬ 25 è¡Œï¼šè°ƒç”¨

DubboProtocol/#export(invoker)
æ–¹æ³•ï¼Œæš´éœ²æœåŠ¡ï¼Œè¿”å› Exporter å¯¹è±¡ã€‚

- åœ¨ [ã€Œ4.3 DubboProtocolã€](http://svip.iocoder.cn/Dubbo/service-export-remote-dubbo/) ä¸­ï¼Œè¯¦ç»†åˆ†äº«ã€‚
- ğŸ™‚ è‹¥æ­¤è‹¥æ˜¯**å…¶ä»–**åè®®ï¼Œè‹¥è°ƒç”¨å¯¹åº”åè®®çš„

XXXProtocol/#export(invoker)
æ–¹æ³•ã€‚

- ç¬¬ 25 è¡Œï¼šä½¿ç”¨ã€åˆ›å»ºçš„ Exporter å¯¹è±¡ã€‘+ã€

originInvoker
ã€‘ï¼Œåˆ›å»º ExporterChangeableWrapper å¯¹è±¡ã€‚è¿™æ ·ï¼Œ

originInvoker
å°±å’Œ Exporter å¯¹è±¡ï¼Œå½¢æˆäº†**ç»‘å®š**çš„å…³ç³»ã€‚

- ğŸ™‚ ExporterChangeableWrapper åœ¨ [ã€Œ4.1 ExporterChangeableWrapperã€](http://svip.iocoder.cn/Dubbo/service-export-remote-dubbo/) çœ‹è¯¦ç»†ä»£ç ã€‚
- ç¬¬ 27 è¡Œï¼šæ·»åŠ åˆ°

bounds
ã€‚

## 3.3 DubboProtocol

[
com.alibaba.dubbo.rpc.protocol.dubbo.DubboProtocol
](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-default/src/main/java/com/alibaba/dubbo/rpc/protocol/dubbo/DubboProtocol.java) ï¼Œå®ç° AbstractProtocol æŠ½è±¡ç±»ï¼ŒDubbo åè®®å®ç°ç±»ã€‚

### 3.3.1 å±æ€§

å±æ€§ç›¸å…³ï¼Œä»£ç å¦‚ä¸‹ï¼š
å‹æƒ…æç¤ºï¼Œä»…åŒ…å«æœ¬æ–‡æ¶‰åŠçš„å±æ€§ã€‚

```
// ... çœç•¥éƒ¨åˆ†å’Œæœ¬æ–‡æ— å…³çš„å±æ€§ã€‚
//*/*
/* é€šä¿¡æœåŠ¡å™¨é›†åˆ
/*
/* key: æœåŠ¡å™¨åœ°å€ã€‚æ ¼å¼ä¸ºï¼šhost:port
/*/
private final Map<String, ExchangeServer> serverMap = new ConcurrentHashMap<String, ExchangeServer>(); // <host:port,Exchanger>
```

- serverMap
  å±æ€§ï¼Œé€šä¿¡æœåŠ¡å™¨é›†åˆã€‚å…¶ä¸­ï¼ŒKey ä¸º**æœåŠ¡å™¨åœ°å€**ï¼Œæ ¼å¼ä¸º

host:port
ã€‚

### 3.3.2 export

æœ¬æ–‡æ¶‰åŠçš„

/#export(invoker)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
1: public <T> Exporter<T> export(Invoker<T> invoker) throws RpcException{
2: URL url = invoker.getUrl();
3:
4: // åˆ›å»º DubboExporter å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ° `exporterMap` ã€‚
5: // export service.
6: String key = serviceKey(url);
7: DubboExporter<T> exporter = new DubboExporter<T>(invoker, key, exporterMap);
8: exporterMap.put(key, exporter);
9:
10: // TODO ã€8033 å‚æ•°å›è°ƒã€‘
11: //export an stub service for dispatching event
12: Boolean isStubSupportEvent = url.getParameter(Constants.STUB_EVENT_KEY, Constants.DEFAULT_STUB_EVENT);
13: Boolean isCallbackservice = url.getParameter(Constants.IS_CALLBACK_SERVICE, false);
14: if (isStubSupportEvent && !isCallbackservice) {
15: String stubServiceMethods = url.getParameter(Constants.STUB_EVENT_METHODS_KEY);
16: if (stubServiceMethods == null || stubServiceMethods.length() == 0) {
17: if (logger.isWarnEnabled()) {
18: logger.warn(new IllegalStateException("consumer [" + url.getParameter(Constants.INTERFACE_KEY) +
19: "], has set stubproxy support event ,but no stub methods founded."));
20: }
21: } else {
22: stubServiceMethodsMap.put(url.getServiceKey(), stubServiceMethods);
23: }
24: }
25:
26: // å¯åŠ¨æœåŠ¡å™¨
27: openServer(url);
28:
29: // åˆå§‹åŒ–åºåˆ—åŒ–ä¼˜åŒ–å™¨
30: optimizeSerialization(url);
31: return exporter;
32: }
```

- ç¬¬ 6 è¡Œï¼šè°ƒç”¨ [
  /#serviceKey(url)
  ](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/protocol/AbstractProtocol.java#L45-L47) æ–¹æ³•ï¼Œè·å¾—æœåŠ¡é”®ã€‚è¯¥æ–¹æ³•ä»çˆ¶ç±»ç»§æ‰¿è€Œæ¥ã€‚
- ç¬¬ 7 è¡Œï¼šåˆ›å»º DubboExporter å¯¹è±¡ã€‚

- ğŸ™‚ åœ¨ [ã€Œ4.3 DubboExporterã€](http://svip.iocoder.cn/Dubbo/service-export-remote-dubbo/) è¯¦ç»†è§£æã€‚
- ç¬¬ 8 è¡Œï¼šæ·»åŠ åˆ° [
  exporterMap
  ](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/protocol/AbstractProtocol.java#L40) ä¸­ã€‚è¯¥å±æ€§ä»çˆ¶ç±»ç»§æ‰¿è€Œæ¥ã€‚
- ç¬¬ 10 è‡³ 24 è¡Œï¼šTODO ã€8033 å‚æ•°å›è°ƒã€‘
- ç¬¬ 27 è¡Œï¼šè°ƒç”¨

/#openServer(url)
æ–¹æ³•ï¼Œå¯åŠ¨æœåŠ¡å™¨ã€‚

- ç¬¬ 30 è¡Œï¼šè°ƒç”¨

/#optimizeSerialization(url)
æ–¹æ³•ï¼Œåˆå§‹åŒ–åºåˆ—åŒ–ä¼˜åŒ–å™¨ã€‚åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” åºåˆ—åŒ–ï¼ˆä¸€ï¼‰ä¹‹æ€»ä½“å®ç°ã€‹](http://svip.iocoder.cn/Dubbo/serialize-1-all?self) ä¸­ï¼Œè¯¦ç»†è§£æã€‚

### 3.3.3 openServer

å‹æƒ…æç¤ºï¼šæœ¬å°èŠ‚çš„å†…å®¹ï¼Œèƒ–å‹å…ˆçœ‹è¿‡ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” NIO æœåŠ¡å™¨ã€‹](http://svip.iocoder.cn/Dubbo/remoting-api-interface/?self) æ‰€æœ‰çš„æ–‡ç« ã€‚

/#openServer(url)
æ–¹æ³•ï¼Œå¯åŠ¨é€šä¿¡æœåŠ¡å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
//*/*
/* é€šä¿¡å®¢æˆ·ç«¯é›†åˆ
/*
/* key: æœåŠ¡å™¨åœ°å€ã€‚æ ¼å¼ä¸ºï¼šhost:port
/*/
private final Map<String, ReferenceCountExchangeClient> referenceClientMap = new ConcurrentHashMap<String, ReferenceCountExchangeClient>(); // <host:port,Exchanger>
1: //*/*
2: /* å¯åŠ¨æœåŠ¡å™¨
3: /*
4: /* @param url URL
5: /*/
6: private void openServer(URL url){
7: // find server.
8: String key = url.getAddress();
9: //client can export a service which's only for server to invoke
10: boolean isServer = url.getParameter(Constants.IS_SERVER_KEY, true); // isserver
11: if (isServer) {
12: ExchangeServer server = serverMap.get(key);
13: if (server == null) {
14: serverMap.put(key, createServer(url));
15: } else {
16: // server supports reset, use together with override
17: server.reset(url);
18: }
19: }
20: }
```

- ç¬¬ 8 è¡Œï¼šè·å¾—æœåŠ¡å™¨åœ°å€ã€‚
- ç¬¬ 10 è¡Œï¼šé…ç½®é¡¹

isserver
ï¼Œå¯ä»¥æš´éœ²ä¸€ä¸ªä»…å½“å‰ JVM å¯è°ƒç”¨çš„æœåŠ¡ã€‚ç›®å‰è¯¥é…ç½®é¡¹å·²ç»ä¸å­˜åœ¨ã€‚

- ç¬¬ 12 è¡Œï¼šä»

serverMap
è·å¾—å¯¹åº”æœåŠ¡å™¨åœ°å€å·²å­˜åœ¨çš„é€šä¿¡æœåŠ¡å™¨ã€‚å³ï¼Œ**ä¸é‡å¤åˆ›å»º**ã€‚

- ç¬¬ 13 è‡³ 14 è¡Œï¼šé€šä¿¡æœåŠ¡å™¨ä¸å­˜åœ¨ï¼Œè°ƒç”¨

/#createServer(url)
æ–¹æ³•ï¼Œåˆ›å»ºæœåŠ¡å™¨ã€‚

- ç¬¬ 15 è‡³ 18 è¡Œï¼šé€šä¿¡æœåŠ¡å™¨å·²å­˜åœ¨ï¼Œè°ƒç”¨

Server/#reset(url)
æ–¹æ³•ï¼Œé‡ç½®æœåŠ¡å™¨çš„å±æ€§ã€‚

- ä¸ºä»€ä¹ˆ**ä¼šå­˜åœ¨**å‘¢ï¼Ÿå› ä¸ºé”®æ˜¯

host:port
ï¼Œé‚£ä¹ˆä¾‹å¦‚ï¼Œå¤šä¸ª Service å…±ç”¨åŒä¸€ä¸ª Protocol ï¼ŒæœåŠ¡å™¨æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚

### 3.3.4 createServer

/#createServer(url)
æ–¹æ³•ï¼Œåˆ›å»ºå¹¶å¯åŠ¨é€šä¿¡æœåŠ¡å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: private ExchangeServer createServer(URL url){
2: // é»˜è®¤å¼€å¯ server å…³é—­æ—¶å‘é€ READ_ONLY äº‹ä»¶
3: // send readonly event when server closes, it's enabled by default
4: url = url.addParameterIfAbsent(Constants.CHANNEL_READONLYEVENT_SENT_KEY, Boolean.TRUE.toString());
5: // é»˜è®¤å¼€å¯ heartbeat
6: // enable heartbeat by default
7: url = url.addParameterIfAbsent(Constants.HEARTBEAT_KEY, String.valueOf(Constants.DEFAULT_HEARTBEAT));
8:
9: // æ ¡éªŒ Server çš„ Dubbo SPI æ‹“å±•æ˜¯å¦å­˜åœ¨
10: String str = url.getParameter(Constants.SERVER_KEY, Constants.DEFAULT_REMOTING_SERVER);
11: if (str != null && str.length() > 0 && !ExtensionLoader.getExtensionLoader(Transporter.class).hasExtension(str)) {
12: throw new RpcException("Unsupported server type: " + str + ", url: " + url);
13: }
14:
15: // è®¾ç½®ç¼–è§£ç å™¨ä¸º `"Dubbo"`
16: url = url.addParameter(Constants.CODEC_KEY, DubboCodec.NAME);
17:
18: // å¯åŠ¨æœåŠ¡å™¨
19: ExchangeServer server;
20: try {
21: server = Exchangers.bind(url, requestHandler);
22: } catch (RemotingException e) {
23: throw new RpcException("Fail to start server(url: " + url + ") " + e.getMessage(), e);
24: }
25:
26: // æ ¡éªŒ Client çš„ Dubbo SPI æ‹“å±•æ˜¯å¦å­˜åœ¨
27: str = url.getParameter(Constants.CLIENT_KEY);
28: if (str != null && str.length() > 0) {
29: Set<String> supportedTypes = ExtensionLoader.getExtensionLoader(Transporter.class).getSupportedExtensions();
30: if (!supportedTypes.contains(str)) {
31: throw new RpcException("Unsupported client type: " + str);
32: }
33: }
34: return server;
35: }
```

- ç¬¬ 4 è¡Œï¼šé»˜è®¤å¼€å¯ Server å…³é—­æ—¶ï¼Œå‘é€ **READ_ONLY** äº‹ä»¶ã€‚
- ç¬¬ 7 è¡Œï¼šé»˜è®¤å¼€å¯**å¿ƒè·³**åŠŸèƒ½ã€‚
- ç¬¬ 9 è‡³ 13 è¡Œï¼šæ ¡éªŒé…ç½®çš„ Server çš„ Dubbo SPI æ‹“å±•æ˜¯å¦å­˜åœ¨ã€‚è‹¥ä¸å­˜åœ¨ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚
- ç¬¬ 16 è¡Œï¼šè®¾ç½®ç¼–è§£ç å™¨ä¸º

"Dubbo"
åè®®ï¼Œå³ DubboCountCodec ã€‚

- ç¬¬ 18 è‡³ 24 è¡Œï¼šè°ƒç”¨

Exchangers/#bind(url, handler)
æ–¹æ³•ï¼Œå¯åŠ¨æœåŠ¡å™¨ã€‚å…·ä½“

requestHanlder
å±æ€§å€¼çš„å®ç°ï¼Œæˆ‘ä»¬æ”¾åœ¨ Dubbo åè®®ä¸‹çš„ RPC çš„æ–‡ç« é‡Œåˆ†äº«ã€‚

requestHanlder
å±æ€§çš„ç®€åŒ–ä»£ç å¦‚ä¸‹ï¼š

```
private ExchangeHandler requestHandler = new ExchangeHandlerAdapter() {
public Object reply(ExchangeChannel channel, Object message) throws RemotingException{
// .... çœç•¥å…·ä½“å®ç°ä»£ç 
return invoker.invoke(inv);
}
}
```

- ç¬¬ 26 è‡³ 33 è¡Œï¼šæ ¡éªŒé…ç½®çš„ Client çš„ Dubbo SPI æ‹“å±•æ˜¯å¦å­˜åœ¨ã€‚è‹¥ä¸å­˜åœ¨ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæœªé…ç½®ï¼Œæ‰€ä»¥ä¸ä¼šæ ¡éªŒã€‚
- ç¬¬ 34 è¡Œï¼šè¿”å›é€šä¿¡æœåŠ¡å™¨ã€‚

# 4. Exporter

æœ¬æ–‡æ¶‰åŠçš„ Exporter ç±»å›¾å¦‚ä¸‹ï¼š

![Exporter ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_03_10/03.png)

## 4.1 ExporterChangeableWrapper

[
com.alibaba.dubbo.registry.integration.RegistryProtocol.ExporterChangeableWrapper
](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/integration/RegistryProtocol.java#L422-L454) ï¼Œå®ç° Exporter æ¥å£ï¼ŒExporter å¯å˜çš„åŒ…è£…å™¨ã€‚

- å»ºç«‹ã€è¿”å›çš„ Exporterã€‘ä¸ã€Protocol export å‡ºçš„ Exporterã€‘çš„å¯¹åº”å…³ç³»ã€‚
- åœ¨ override æ—¶å¯ä»¥è¿›è¡Œå…³ç³»ä¿®æ”¹ã€‚

ä»£ç å¦‚ä¸‹ï¼š

```
private class ExporterChangeableWrapper<T> implements Exporter<T>{
//*/*
/* åŸ Invoker å¯¹è±¡
/*/
private final Invoker<T> originInvoker;
//*/*
/* æš´éœ²çš„ Exporter å¯¹è±¡
/*/
private Exporter<T> exporter;
public ExporterChangeableWrapper(Exporter<T> exporter, Invoker<T> originInvoker){
this.exporter = exporter;
this.originInvoker = originInvoker;
}
public Invoker<T> getOriginInvoker(){
return originInvoker;
}
public Invoker<T> getInvoker(){
return exporter.getInvoker();
}
public void setExporter(Exporter<T> exporter){
this.exporter = exporter;
}
public void unexport(){
String key = getCacheKey(this.originInvoker);
// ç§»é™¤å‡º `bounds`
bounds.remove(key);
// å–æ¶ˆæš´éœ²
exporter.unexport();
}
}
```

## 4.2 DestroyableExporter

[
com.alibaba.dubbo.registry.integration.RegistryProtocol.DestroyableExporter
](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/integration/RegistryProtocol.java#L456-L506) ï¼Œå®ç° Exporter æ¥å£ï¼Œ**å¯é”€æ¯**çš„ Exporter å®ç°ç±»ã€‚

```
private class ExporterChangeableWrapper<T> implements Exporter<T>{
//*/*
/* åŸ Invoker å¯¹è±¡
/*/
private final Invoker<T> originInvoker;
//*/*
/* æš´éœ²çš„ Exporter å¯¹è±¡
/*/
private Exporter<T> exporter;
public ExporterChangeableWrapper(Exporter<T> exporter, Invoker<T> originInvoker){
this.exporter = exporter;
this.originInvoker = originInvoker;
}
public Invoker<T> getOriginInvoker(){
return originInvoker;
}
@Override
public Invoker<T> getInvoker(){
return exporter.getInvoker();
}
// å¯ä»¥é‡æ–°è®¾ç½® Exporter å¯¹è±¡
public void setExporter(Exporter<T> exporter){
this.exporter = exporter;
}
@Override
public void unexport(){
String key = getCacheKey(this.originInvoker);
// ç§»é™¤å‡º `bounds`
bounds.remove(key);
// å–æ¶ˆæš´éœ²
exporter.unexport();
}
}
```

- Exporter **ä»£ç†**ï¼Œå»ºç«‹**åŸå§‹çš„** Invoker ä¸

Protocol/#export(Invoker<T> invoker)
æ–¹æ³•è¿”å›çš„ Exporter çš„**å¯¹åº”å…³ç³»**ã€‚

- åœ¨é…ç½®è§„åˆ™å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¯è°ƒç”¨

/#setExporter(Exporter<T>)
æ–¹æ³•ï¼Œä¿®æ”¹**å¯¹åº”å…³ç³»**ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Šç²¾å°½ Dubbo æºç è§£æ â€”â€” é›†ç¾¤å®¹é”™ï¼ˆå…­ï¼‰ä¹‹ Configurator å®ç°ã€‹](http://svip.iocoder.cn/Dubbo/cluster-6-impl-configurator/?self) ã€‚

## 4.3 DubboExporter

[
com.alibaba.dubbo.rpc.protocol.dubbo.DubboExporter
](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-default/src/main/java/com/alibaba/dubbo/rpc/protocol/dubbo/DubboExporter.java) ï¼Œå®ç° AbstractExporter æŠ½è±¡ç±»ï¼ŒDubbo Exporter å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class DubboExporter<T> extends AbstractExporter<T>{
//*/*
/* æœåŠ¡é”®
/*/
private final String key;
//*/*
/* Exporter é›†åˆ
/*
/* key: æœåŠ¡é”®
/*
/* è¯¥å€¼å®é™…å°±æ˜¯ {@link com.alibaba.dubbo.rpc.protocol.AbstractProtocol/#exporterMap}
/*/
private final Map<String, Exporter<?>> exporterMap;
public DubboExporter(Invoker<T> invoker, String key, Map<String, Exporter<?>> exporterMap){
super(invoker);
this.key = key;
this.exporterMap = exporterMap;
}
@Override
public void unexport(){
// å–æ¶ˆæš´éœ²
super.unexport();
// ç§»é™¤
exporterMap.remove(key);
}
}
```

- key
  å±æ€§ï¼ŒæœåŠ¡é”®ã€‚
- /#exporterMap
  å±æ€§ï¼ŒExporter é›†åˆã€‚åœ¨ä¸Šæ–‡

DubboProtocol/#export(invoker)
æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¯¥å±æ€§å°±æ˜¯

AbstractProtocol.exporterMap
å±æ€§ã€‚

- **æ„é€ æ–¹æ³•**ï¼Œ**å‘èµ·**æš´éœ²ï¼Œå°†è‡ªå·±æ·»åŠ åˆ°

exporterMap
ä¸­ã€‚

- /#unexport()
  æ–¹æ³•ï¼Œ**å–æ¶ˆ**æš´éœ²ï¼Œå°†è‡ªå·±ç§»é™¤å‡º

exporterMap
ä¸­ã€‚
