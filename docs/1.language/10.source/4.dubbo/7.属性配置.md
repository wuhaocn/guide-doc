# å±æ€§é…ç½®

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

å‹æƒ…æç¤ºï¼Œã€**é…ç½®**ã€‘è¿™å—çš„å†…å®¹ï¼Œä¼šç›¸å¯¹æ¯”è¾ƒæ¯ç‡¥ã€‚æ‰€ä»¥ï¼Œå¦‚æœçœ‹åˆ°ä¸€äº›å¾ˆéš¾æ‡‚çš„åœ°æ–¹ï¼Œå»ºè®®å…ˆè·³è¿‡ã€‚

å¯¹äº Dubbo ï¼Œé‡ç‚¹æ˜¯è¦å»ç†è§£ï¼Œå¤šåè®®ã€RPCã€å®¹é”™ç­‰ç­‰æ¨¡å—ï¼Œè€Œä¸æ˜¯ã€**é…ç½®**ã€‘ã€‚

ğŸ˜ˆ ä¼°è®¡å¥½å¤šèƒ–å‹è¢«ã€**é…ç½®**ã€‘è¿™ç« åŠé€€äº†æŠŠï¼Ÿï¼Ÿï¼Ÿ

# 1. æ¦‚è¿°

é¦–å…ˆï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹**å±æ€§é…ç½®**çš„å®šä¹‰ï¼š
FROM [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” å±æ€§é…ç½®ã€‹](http://dubbo.apache.org/zh-cn/docs/user/configuration/properties.html)

å¦‚æœå…¬å…±é…ç½®å¾ˆ**ç®€å•**ï¼Œæ²¡æœ‰å¤šæ³¨å†Œä¸­å¿ƒï¼Œå¤šåè®®ç­‰æƒ…å†µï¼Œæˆ–è€…æƒ³å¤šä¸ª Spring å®¹å™¨æƒ³å…±äº«é…ç½®ï¼Œå¯ä»¥ä½¿ç”¨

dubbo.properties
ä½œä¸ºç¼ºçœé…ç½®ã€‚

Dubbo å°†è‡ªåŠ¨åŠ è½½ classpath æ ¹ç›®å½•ä¸‹çš„

dubbo.properties
ï¼Œå¯ä»¥é€šè¿‡ JVM å¯åŠ¨å‚æ•°

-Ddubbo.properties.file=xxx.properties
æ”¹å˜ç¼ºçœé…ç½®ä½ç½®ã€‚

ä»å®šä¹‰ä¸Šï¼Œå¾ˆå…³é”®çš„ä¸€ä¸ªè¯æ˜¯ â€œ**ç®€å•**â€ ã€‚

- **å±æ€§é…ç½®**ï¼Œä¸æ”¯æŒå¤šæ³¨å†Œä¸­å¿ƒï¼Œå¤šåè®®ç­‰æƒ…å†µï¼ŒåŸå› è§ä»£ç ã€‚
- **å¤–éƒ¨åŒ–é…ç½®**ï¼Œèƒ½å¤Ÿè§£å†³ä¸Šè¿°çš„é—®é¢˜ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹å¯ä»¥è‡ªå·±çœ‹ä¸‹ [ã€ŠDubbo å¤–éƒ¨åŒ–é…ç½®ï¼ˆExternalized Configurationï¼‰ã€‹](https://github.com/mercyblitz/blogs/blob/master/java/dubbo/Dubbo-Externalized-Configuration.md) ã€‚å½“ç„¶ï¼Œè¿™å—å†…å®¹åé¢åˆ†äº«ï¼Œä¸åœ¨æœ¬æ–‡çš„èŒƒç•´ã€‚

OK ï¼Œä¸‹é¢åœ¨å¼€å§‹çœ‹çœ‹å…·ä½“ä»£ç ä¹‹å‰ï¼Œèƒ–å‹å…ˆä»”ç»†é˜…è¯»ä¸‹ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” å±æ€§é…ç½®ã€‹](http://dubbo.apache.org/zh-cn/docs/user/configuration/properties.html) ï¼Œæœ‰åŠ©äºä¸‹é¢ä»£ç çš„ç†è§£ã€‚

# 2. AbstractConfig

åœ¨ AbstractConfig ä¸­ï¼Œæä¾›äº† [
/#appendProperties(config)
](https://github.com/YunaiV/dubbo/blob/d3c3975f320c78452f96098b04441fed4c00ab70/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractConfig.java#L132-L212) æ–¹æ³•ï¼Œè¯»å–**å¯åŠ¨å‚æ•°å˜é‡**å’Œ **properties é…ç½®**åˆ°é…ç½®å¯¹è±¡ã€‚åœ¨å‰é¢çš„å‡ ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä»¬å¤šæ¬¡çœ‹åˆ°è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![è¯»å–è°ƒç”¨](http://static2.iocoder.cn/images/Dubbo/2018_01_13/01.png)

ä»£ç å¦‚ä¸‹ï¼š

```
1: protected static void appendProperties(AbstractConfig config){
2: if (config == null) {
3: return;
4: }
5: String prefix = "dubbo." + getTagName(config.getClass()) + ".";
6: Method[] methods = config.getClass().getMethods();
7: for (Method method : methods) {
8: try {
9: String name = method.getName();
10: if (name.length() > 3 && name.startsWith("set") && Modifier.isPublic(method.getModifiers()) // æ–¹æ³•æ˜¯ public çš„ setting æ–¹æ³•ã€‚
11: && method.getParameterTypes().length == 1 && isPrimitive(method.getParameterTypes()[0])) { // æ–¹æ³•çš„å”¯ä¸€å‚æ•°æ˜¯åŸºæœ¬æ•°æ®ç±»å‹
12: // è·å¾—å±æ€§åï¼Œä¾‹å¦‚ `ApplicationConfig/#setName(...)` æ–¹æ³•ï¼Œå¯¹åº”çš„å±æ€§åä¸º name ã€‚
13: String property = StringUtils.camelToSplitName(name.substring(3, 4).toLowerCase() + name.substring(4), ".");
14:
15: // ã€å¯åŠ¨å‚æ•°å˜é‡ã€‘ä¼˜å…ˆä»å¸¦æœ‰ `Config/#id` çš„é…ç½®ä¸­è·å–ï¼Œä¾‹å¦‚ï¼š`dubbo.application.demo-provider.name` ã€‚
16: String value = null;
17: if (config.getId() != null && config.getId().length() > 0) {
18: String pn = prefix + config.getId() + "." + property; // å¸¦æœ‰ `Config/#id`
19: value = System.getProperty(pn);
20: if (!StringUtils.isBlank(value)) {
21: logger.info("Use System Property " + pn + " to config dubbo");
22: }
23: }
24: // ã€å¯åŠ¨å‚æ•°å˜é‡ã€‘è·å–ä¸åˆ°ï¼Œå…¶æ¬¡ä¸å¸¦ `Config/#id` çš„é…ç½®ä¸­è·å–ï¼Œä¾‹å¦‚ï¼š`dubbo.application.name` ã€‚
25: if (value == null || value.length() == 0) {
26: String pn = prefix + property; // // ä¸å¸¦ `Config/#id`
27: value = System.getProperty(pn);
28: if (!StringUtils.isBlank(value)) {
29: logger.info("Use System Property " + pn + " to config dubbo");
30: }
31: }
32: if (value == null || value.length() == 0) {
33: // è¦†ç›–ä¼˜å…ˆçº§ä¸ºï¼šå¯åŠ¨å‚æ•°å˜é‡ > XML é…ç½® > properties é…ç½®ï¼Œå› æ­¤éœ€è¦ä½¿ç”¨ getter åˆ¤æ–­ XML æ˜¯å¦å·²ç»è®¾ç½®
34: Method getter;
35: try {
36: getter = config.getClass().getMethod("get" + name.substring(3), new Class<?>[0]);
37: } catch (NoSuchMethodException e) {
38: try {
39: getter = config.getClass().getMethod("is" + name.substring(3), new Class<?>[0]);
40: } catch (NoSuchMethodException e2) {
41: getter = null;
42: }
43: }
44: if (getter != null) {
45: if (getter.invoke(config, new Object[0]) == null) { // ä½¿ç”¨ getter åˆ¤æ–­ XML æ˜¯å¦å·²ç»è®¾ç½®
46: // ã€properties é…ç½®ã€‘ä¼˜å…ˆä»å¸¦æœ‰ `Config/#id` çš„é…ç½®ä¸­è·å–ï¼Œä¾‹å¦‚ï¼š`dubbo.application.demo-provider.name` ã€‚
47: if (config.getId() != null && config.getId().length() > 0) {
48: value = ConfigUtils.getProperty(prefix + config.getId() + "." + property);
49: }
50: // ã€properties é…ç½®ã€‘è·å–ä¸åˆ°ï¼Œå…¶æ¬¡ä¸å¸¦ `Config/#id` çš„é…ç½®ä¸­è·å–ï¼Œä¾‹å¦‚ï¼š`dubbo.application.name` ã€‚
51: if (value == null || value.length() == 0) {
52: value = ConfigUtils.getProperty(prefix + property);
53: }
54: // ã€properties é…ç½®ã€‘è€ç‰ˆæœ¬å…¼å®¹ï¼Œè·å–ä¸åˆ°ï¼Œæœ€åä¸å¸¦ `Config/#id` çš„é…ç½®ä¸­è·å–ï¼Œä¾‹å¦‚ï¼š`dubbo.protocol.name` ã€‚
55: if (value == null || value.length() == 0) {
56: String legacyKey = legacyProperties.get(prefix + property);
57: if (legacyKey != null && legacyKey.length() > 0) {
58: value = convertLegacyValue(legacyKey, ConfigUtils.getProperty(legacyKey));
59: }
60: }
61:
62: }
63: }
64: }
65: // è·å–åˆ°å€¼ï¼Œè¿›è¡Œåå°„è®¾ç½®ã€‚
66: if (value != null && value.length() > 0) {
67: method.invoke(config, new Object[]{convertPrimitive(method.getParameterTypes()[0], value)});
68: }
69: }
70: } catch (Exception e) {
71: logger.error(e.getMessage(), e);
72: }
73: }
74: }
```

- ç¬¬ 5 è¡Œï¼šè·å¾—é…ç½®é¡¹**å‰ç¼€**ã€‚æ­¤å¤„çš„ [
  /#getTagName(Class<?>)
  ](https://github.com/YunaiV/dubbo/blob/d3c3975f320c78452f96098b04441fed4c00ab70/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractConfig.java#L214-L230) æ–¹æ³•ï¼Œä½¿ç”¨é…ç½®ç±»çš„ç±»åï¼Œè·å¾—å¯¹åº”çš„å±æ€§æ ‡ç­¾ã€‚è¯¥æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š

```
1: //*/*
2: /* é…ç½®ç±»åçš„åç¼€
3: /* ä¾‹å¦‚ï¼ŒServiceConfig åç¼€ä¸º Configï¼›ServiceBean åç¼€ä¸º Beanã€‚
4: /*/
5: private static final String[] SUFFIXES = new String[]{"Config", "Bean"};
6:
7: //*/*
8: /* è·å–ç±»åå¯¹åº”çš„å±æ€§æ ‡ç­¾ï¼Œä¾‹å¦‚ï¼ŒServiceConfig å¯¹åº”ä¸º service ã€‚
9: /*
10: /* @param cls ç±»å
11: /* @return æ ‡ç­¾
12: /*/
13: private static String getTagName(Class<?> cls){
14: String tag = cls.getSimpleName();
15: for (String suffix : SUFFIXES) {
16: if (tag.endsWith(suffix)) {
17: tag = tag.substring(0, tag.length() - suffix.length());
18: break;
19: }
20: }
21: tag = tag.toLowerCase();
22: return tag;
23: }
```

- ç¬¬ 6 è¡Œï¼šè·å¾—é…ç½®ç±»çš„æ‰€æœ‰æ–¹æ³•ï¼Œç”¨äºä¸‹é¢é€šè¿‡**åå°„**è·å¾—é…ç½®é¡¹çš„å±æ€§åï¼Œå†ç”¨å±æ€§åï¼Œå»è¯»å–**å¯åŠ¨å‚æ•°å˜é‡**å’Œ **properties é…ç½®**åˆ°é…ç½®å¯¹è±¡ã€‚
- ç¬¬ 10 è‡³ 11 è¡Œï¼špublic && setting æ–¹æ³• && **å”¯ä¸€**å‚æ•°ä¸ºåŸºæœ¬ç±»å‹ã€‚

- å…¶ä¸­**å”¯ä¸€**å‚æ•°ä¸º**åŸºæœ¬ç±»å‹**ï¼Œå†³å®šäº†ä¸€ä¸ªé…ç½®å¯¹è±¡æ— æ³•è®¾ç½®å¦å¤–ä¸€ä¸ªé…ç½®å¯¹è±¡**æ•°ç»„**ä¸ºå±æ€§ï¼Œå³**æ²¡æœ‰å¤šæ³¨å†Œä¸­å¿ƒï¼Œå¤šåè®®ç­‰æƒ…å†µ**ã€‚ä¾‹å¦‚ï¼ŒServiceConfig æ— æ³•é€šè¿‡**å±æ€§é…ç½®**è®¾ç½®å¤šä¸ª ProtocolConfig å¯¹è±¡ã€‚
- å½“ç„¶ä¸Šè¿°é—®é¢˜ï¼Œæ­£å¦‚æ–‡åˆæ‰€è¯´ï¼Œ[ã€ŠDubbo å¤–éƒ¨åŒ–é…ç½®ï¼ˆExternalized Configurationï¼‰ã€‹](https://github.com/mercyblitz/blogs/blob/master/java/dubbo/Dubbo-Externalized-Configuration.md) å·²ç»æ”¯æŒã€‚
- å¦å¤–ï¼Œ**å±æ€§é…ç½®**å’Œ**å¤–éƒ¨åŒ–é…ç½®**æœ‰ä¸€å®šçš„ç›¸ä¼¼ç‚¹ï¼š
  FROM [ã€ŠDubbo å¤–éƒ¨åŒ–é…ç½®ï¼ˆExternalized Configurationï¼‰ã€‹](https://github.com/mercyblitz/blogs/blob/master/java/dubbo/Dubbo-Externalized-Configuration.md)

åœ¨ Dubbo å®˜æ–¹ç”¨æˆ·æ‰‹å†Œçš„[â€œå±æ€§é…ç½®â€](http://dubbo.apache.org/zh-cn/docs/user/configuration/properties.html)ç« èŠ‚ä¸­ï¼Œ

dubbo.properties
é…ç½®å±æ€§èƒ½å¤Ÿæ˜ å°„åˆ°

ApplicationConfig
ã€

ProtocolConfig
ä»¥åŠ

RegistryConfig
çš„å­—æ®µã€‚ä»æŸç§æ„ä¹‰ä¸Šæ¥è¯´ï¼Œ

dubbo.properties
ä¹Ÿæ˜¯ Dubbo çš„å¤–éƒ¨åŒ–é…ç½®ã€‚

- ç¬¬ 13 è¡Œï¼šè·å¾—å±æ€§åã€‚ä¾‹å¦‚ï¼Œ

ApplicationConfig/#setName(...)
æ–¹æ³•ï¼Œå¯¹åº”çš„å±æ€§åä¸º

"name"
ã€‚

- è¯»å–çš„**è¦†ç›–ç­–ç•¥**å¦‚ä¸‹ï¼š
  ![è¦†ç›–ç­–ç•¥](http://static2.iocoder.cn/images/Dubbo/2018_01_13/02.png)
- ç¬¬ 15 è‡³ 31 è¡Œï¼šä¼˜å…ˆä»ã€**å¯åŠ¨å‚æ•°å˜é‡**ã€‘è·å–é…ç½®é¡¹çš„å€¼ã€‚

- ğŸ™‚ æœ‰**ä¸¤ç§**æƒ…å†µï¼Œèƒ–å‹ç»†çœ‹ä¸‹æ³¨é‡Šã€‚
- ç¬¬ 33 è‡³ 45 è¡Œï¼šå› ä¸º XML é…ç½® çš„ä¼˜å…ˆçº§**å¤§äº** properties é…ç½®ï¼Œå› æ­¤éœ€è¦**è·å–å¹¶ä½¿ç”¨** getting æ–¹æ³•ï¼Œåˆ¤æ–­é…ç½®å¯¹è±¡**å·²ç»æ‹¥æœ‰**è¯¥é…ç½®é¡¹çš„å€¼ã€‚å¦‚æœæœ‰ï¼Œåˆ™ä¸ä» properties é…ç½® è¯»å–å¯¹åº”çš„å€¼ã€‚
- ç¬¬ 46 è‡³ 59 è¡Œï¼šæœ€åä»ã€**properties é…ç½®**ã€‘è·å–é…ç½®é¡¹çš„å€¼ã€‚

- ğŸ™‚ æœ‰**ä¸‰ç§**æƒ…å†µï¼Œå‰ä¸¤ç§å’Œã€**å¯åŠ¨å‚æ•°å˜é‡**ã€‘ç›¸åŒã€‚
- æœ€åä¸€ç§ï¼Œä¸»è¦æ˜¯å…¼å®¹è€ç‰ˆæœ¬çš„é…ç½®é¡¹ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: //*/* 2: /* æ–°è€ç‰ˆæœ¬çš„ properties çš„ key æ˜ å°„ 3: /* 4: /* keyï¼šæ–°ç‰ˆæœ¬çš„é…ç½® æ˜ å°„ 5: /* valueï¼šæ—§ç‰ˆæœ¬çš„é…ç½® æ˜ å°„ 6: /* 7: /* æ¥è‡ª 2012/3/8 ä¸‹åˆ 5ï¼š51 cb1f705 æäº¤ 8: /* DUBBO-251 å¢åŠ APIè¦†ç›–dubbo.propertiesçš„æµ‹è¯•ï¼Œä»¥åŠæ—§ç‰ˆæœ¬é…ç½®é¡¹æµ‹è¯•ã€‚ 9: /*/ 10: private static final Map<String, String> legacyProperties = new HashMap<String, String>(); 11: 12: //*/* 13: /* å°†é”®å¯¹åº”çš„å€¼è½¬æ¢æˆç›®æ ‡çš„å€¼ã€‚ 14: /* 15: /* å› ä¸ºï¼Œæ–°è€é…ç½®å¯èƒ½æœ‰ä¸€äº›å·®å¼‚ï¼Œé€šè¿‡è¯¥æ–¹æ³•è¿›è¡Œè½¬æ¢ã€‚ 16: /* 17: /* @param key é”® 18: /* @param value å€¼ 19: /* @return è½¬æ¢åçš„å€¼ 20: /*/ 21: private static String convertLegacyValue(String key, String value){ 22: if (value != null && value.length() > 0) { 23: if ("dubbo.service.max.retry.providers".equals(key)) { 24: return String.valueOf(Integer.parseInt(value) - 1); 25: } else if ("dubbo.service.allow.no.provider".equals(key)) { 26: return String.valueOf(!Boolean.parseBoolean(value)); 27: } 28: } 29: return value; 30: }
```

- x
- ç¬¬ 65 è‡³ 68 è¡Œï¼šæœ‰å€¼ï¼Œé€šè¿‡åå°„è¿›è¡Œè®¾ç½®åˆ°é…ç½®å¯¹è±¡ä¸­ã€‚
- ç¬¬ 70 è‡³ 72 è¡Œï¼šé€»è¾‘ä¸­é—´å‘ç”Ÿå¼‚å¸¸ï¼Œ**ä¸æŠ›å‡ºå¼‚å¸¸**ï¼Œä»…æ‰“å°é”™è¯¯æ—¥å¿—ã€‚
