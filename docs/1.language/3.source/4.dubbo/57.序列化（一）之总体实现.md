# åºåˆ—åŒ–ï¼ˆä¸€ï¼‰ä¹‹æ€»ä½“å®ç°

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

ä»æœ¬æ–‡å¼€å§‹ï¼Œæˆ‘ä»¬æ¥åˆ†äº« Dubbo çš„åºåˆ—åŒ–çš„å®ç°ã€‚åœ¨ [ã€ŠDubbo å¼€å‘æŒ‡å— â€”â€” åºåˆ—åŒ–æ‰©å±•ã€‹](http://dubbo.apache.org/zh-cn/docs/dev/impls/serialize.html) ï¼Œå¯¹åºåˆ—åŒ–å®šä¹‰å¦‚ä¸‹ï¼š
å°†å¯¹è±¡è½¬æˆå­—èŠ‚æµï¼Œç”¨äºç½‘ç»œä¼ è¾“ï¼Œä»¥åŠå°†å­—èŠ‚æµè½¬ä¸ºå¯¹è±¡ï¼Œç”¨äºåœ¨æ”¶åˆ°å­—èŠ‚æµæ•°æ®åè¿˜åŸæˆå¯¹è±¡ã€‚

- æ‰€ä»¥ï¼Œåºåˆ—åŒ–å®é™…ä¸ŠåŒ…å«**ä¸¤éƒ¨åˆ†**ã€‚
- æœ‰ä¸€ä¸ªæ¦‚å¿µï¼Œæˆ‘ä»¬éœ€è¦**å¼ºè°ƒ**ä¸€ä¸‹ï¼šåè®®å’Œåºåˆ—åŒ–ï¼Œæ˜¯ä¸¤ä»¶äº‹æƒ…ã€‚ä¸¾ä¸ªä¾‹å­ï¼ŒHTTP æ˜¯ä¸€ç§åè®®ï¼Œå¯ä»¥æœ‰ XML å’Œ JSON **ç­‰ç­‰**åºåˆ—åŒ–( æ•°æ®äº¤æ¢ )çš„æ–¹å¼ã€‚åŒæ—¶ï¼ŒXML å’Œ JSON ä¸ä»…ä»…å¯ä»¥ç”¨åœ¨ HTTP åè®®ï¼Œä¹Ÿå¯ä»¥ç”¨åœ¨ HTTPS ç­‰ç­‰åè®®ä¸­ã€‚**æ‰€ä»¥ï¼Œåè®®å’Œåºåˆ—åŒ–ä¸æ˜¯åŒ…å«çš„å…³ç³»ï¼Œè€Œæ˜¯ç»„åˆçš„å…³ç³»**ã€‚

åºåˆ—åŒ–åœ¨

dubbo-common
é¡¹ç›®çš„

serialize
æ¨¡å—å®ç°ã€‚ä»£ç ç»“æ„å¦‚ä¸‹å›¾ï¼š
ğŸ™‚ åœ¨æœ€æ–°ç‰ˆæœ¬çš„ Dubbo é¡¹ç›®ä¸­ï¼Œ

serialize
æ¨¡å—ï¼Œå·²ç»**ç‹¬ç«‹**æˆ

dubbo-serialize
é¡¹ç›®ã€‚

![ä»£ç ç»“æ„](http://static2.iocoder.cn/images/Dubbo/2019_02_15/01.png)

- æœ€å¤–å±‚ï¼Œå®šä¹‰äº† API **æ¥å£**ã€‚
- support
  åŒ…ï¼Œæä¾›äº†å¤šç§åºåˆ—åŒ–çš„**å®ç°**ã€‚

# 2. API å®šä¹‰

API æ¥å£ï¼Œç±»å›¾å¦‚ä¸‹ï¼š

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2019_02_15/02.png)

## 2.1 Serialization

com.alibaba.dubbo.common.serialize.Serialization
ï¼Œ**åºåˆ—åŒ–**æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@SPI("hessian2")
public interface Serialization{
//*/*
/* get content type id
/*
/* è·å¾—å†…å®¹ç±»å‹ç¼–å·
/*
/* @return content type id
/*/
byte getContentTypeId();
//*/*
/* get content type
/*
/* è·å¾—å†…å®¹ç±»å‹å
/*
/* @return content type
/*/
String getContentType();
//*/*
/* create serializer
/*
/* åˆ›å»º ObjectOutput å¯¹è±¡ï¼Œåºåˆ—åŒ–è¾“å‡ºåˆ° OutputStream
/*
/* @param url URL
/* @param output è¾“å‡ºæµ
/* @return serializer
/* @throws IOException å½“å‘ç”Ÿ IO å¼‚å¸¸æ—¶
/*/
@Adaptive
ObjectOutput serialize(URL url, OutputStream output) throws IOException;
//*/*
/* create deserializer
/*
/* åˆ›å»º ObjectInput å¯¹è±¡ï¼Œä» InputStream ååºåˆ—åŒ–
/*
/* @param url URL
/* @param input è¾“å…¥æµ
/* @return deserializer
/* @throws IOException å½“å‘ç”Ÿ IO å¼‚å¸¸æ—¶
/*/
@Adaptive
ObjectInput deserialize(URL url, InputStream input) throws IOException;
}
```

- @SPI("hessian2")
  æ³¨è§£ï¼ŒDubbo SPI **æ‹“å±•ç‚¹**ï¼Œé»˜è®¤ä¸º

"hessian2"
ï¼Œå³æœªé…ç½®æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Hessian è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ– ã€‚

- /#getContentTypeId()
  ,

/#getContentType()
æ–¹æ³•ï¼Œè·å¾—å†…å®¹ç±»å‹ç¼–å·å’Œåå­—ã€‚

- /#serialize(...)
  ,

/#deserialize(...)
æ–¹æ³•ï¼ŒğŸ™‚ å…·ä½“çœ‹æ³¨é‡Šã€‚

- è™½ç„¶æ·»åŠ äº†

@Adaptive
æ³¨è§£ï¼Œ ä½†æ˜¯å®é™…ä¸Šï¼Œä¸ä½¿ç”¨ Dubbo SPI Adaptive æœºåˆ¶ï¼Œè€Œæ˜¯ä»£ç ä¸­ï¼Œç›´æ¥è·å–ã€‚ä¾‹å¦‚ï¼š

```
// CodecSupport.java
public static Serialization getSerialization(URL url){
return ExtensionLoader.getExtensionLoader(Serialization.class).getExtension(
url.getParameter(Constants.SERIALIZATION_KEY, Constants.DEFAULT_REMOTING_SERIALIZATION));
}
```

- x
- Serialization å®ç°ç±»ï¼Œå®ç°è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ›å»ºå¯¹åº”çš„ ObjectOutput å’Œ ObjectInput **å®ç°ç±»**çš„å¯¹è±¡ã€‚

## 2.2 DataInput

com.alibaba.dubbo.common.serialize.DataInput
ï¼Œæ•°æ®**è¾“å…¥**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
boolean readBool() throws IOException;
byte readByte() throws IOException;
short readShort() throws IOException;
int readInt() throws IOException;
long readLong() throws IOException;
float readFloat() throws IOException;
double readDouble() throws IOException;
String readUTF() throws IOException;
byte[] readBytes() throws IOException;
```

- ä» InputStream ä¸­ï¼Œè¯»å–**åŸºæœ¬ç±»å‹**çš„æ•°æ®ã€‚

### 2.2.1 ObjectInput

com.alibaba.dubbo.common.serialize.ObjectInput
ï¼Œå®ç° DataInput æ¥å£ï¼Œå¯¹è±¡**è¾“å…¥**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
Object readObject() throws IOException, ClassNotFoundException;
<T> T readObject(Class<T> cls) throws IOException, ClassNotFoundException;
<T> T readObject(Class<T> cls, Type type) throws IOException, ClassNotFoundException;
```

- åœ¨ DataInput çš„åŸºç¡€ä¸Šï¼Œå¢åŠ è¯»å–å¯¹è±¡çš„æ•°æ®ã€‚

## 2.3 DataOutput

DataOutput å’Œ DataInput ç›¸åã€‚

com.alibaba.dubbo.common.serialize.DataOutput
ï¼Œæ•°æ®**è¾“å‡º**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
void writeBool(boolean v) throws IOException;
void writeByte(byte v) throws IOException;
void writeShort(short v) throws IOException;
void writeInt(int v) throws IOException;
void writeLong(long v) throws IOException;
void writeFloat(float v) throws IOException;
void writeDouble(double v) throws IOException;
void writeUTF(String v) throws IOException;
void writeBytes(byte[] v) throws IOException;
void writeBytes(byte[] v, int off, int len) throws IOException;
// Flush buffer.
void flushBuffer() throws IOException;
```

- å‘ InputStream ä¸­ï¼Œå†™å…¥**åŸºæœ¬ç±»å‹**çš„æ•°æ®ã€‚

### 2.3.1 ObjectOutput

com.alibaba.dubbo.common.serialize.ObjectOutput
ï¼Œå®ç° DataOutput æ¥å£ï¼Œå¯¹è±¡**è¾“å‡º**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
void writeObject(Object obj) throws IOException;
```

- åœ¨ DataOutput çš„åŸºç¡€ä¸Šï¼Œå¢åŠ å†™å…¥å¯¹è±¡çš„æ•°æ®ã€‚

## 2.4 Cleanable

com.alibaba.dubbo.common.serialize.Cleanable
ï¼Œ**æ¸…ç†**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
void cleanup();
```

- éƒ¨åˆ† Serialize å®ç°ç±»ï¼Œå®Œæˆåºåˆ—åŒ–æˆ–ååºåˆ—åŒ–ï¼Œéœ€è¦åšæ¸…ç†ã€‚é€šè¿‡å®ç°è¯¥æ¥å£ï¼Œæ‰§è¡Œæ¸…ç†çš„é€»è¾‘ã€‚

## 2.5 Optimizer ç›¸å…³

### 2.5.1 SerializationOptimizer

com.alibaba.dubbo.common.serialize.support.SerializationOptimizer
ï¼Œåºåˆ—åŒ–ä¼˜åŒ–å™¨æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

```
public interface SerializationOptimizer{
//*/*
/* @return éœ€è¦ä½¿ç”¨ä¼˜åŒ–çš„ç±»çš„é›†åˆ
/*/
Collection<Class> getSerializableClasses();
}
```

åœ¨ Kryo ã€FST ä¸­ï¼Œæ”¯æŒ**é…ç½®**éœ€è¦ä¼˜åŒ–çš„ç±»ã€‚ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œå¯ä»¥å®ç°è‡ªå®šä¹‰çš„ SerializationOptimizer å­ç±»ï¼Œè¿›è¡Œé…ç½®ã€‚å½“ç„¶ï¼Œä½¿ç”¨æ–‡ä»¶ä¹Ÿæ˜¯ä¸€ä¸ªé€‰æ‹©ï¼ŒDubbo åœ¨å®ç°è€ƒè™‘å–èˆçš„åŸå› å¦‚ä¸‹ï¼š

FROM ç±»æ³¨é‡Š

This class can be replaced with the contents in config file, but for now I think the class is easier to write

è¿™ä¸ªç±»å¯ä»¥æ›¿æ¢ä¸ºé…ç½®æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œä½†æ˜¯ç°åœ¨æˆ‘è®¤ä¸ºè¿™ä¸ªç±»æ›´å®¹æ˜“ç¼–å†™ã€‚

### 2.5.2 SerializableClassRegistry

com.alibaba.dubbo.common.serialize.support.SerializableClassRegistry
ï¼Œåºåˆ—åŒ–ä¼˜åŒ–ç±»çš„æ³¨å†Œè¡¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public abstract class SerializableClassRegistry{
private static final Set<Class> registrations = new LinkedHashSet<Class>();
//*/*
/* only supposed to be called at startup time
/*/
public static void registerClass(Class clazz){
registrations.add(clazz);
}
public static Set<Class> getRegisteredClasses(){
return registrations;
}
}
```

- /#registerClass(clazz)
  **é™æ€**æ–¹æ³•ï¼Œæ³¨å†Œã€‚åœ¨

SerializationOptimizer/#getSerializableClasses()
æ–¹æ³•ï¼Œè·å¾—çš„ç±»çš„é›†åˆï¼Œä¼šæ³¨å†Œåˆ° SerializableClassRegistry ä¸­ã€‚

- /#getRegisteredClasses()
  **é™æ€**æ–¹æ³•ï¼Œè·å¾—ã€‚åœ¨ Kryo ã€FST ä¸­ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼Œè·å¾—éœ€è¦ä½¿ç”¨ä¼˜åŒ–çš„ç±»çš„é›†åˆã€‚

### 2.5.3 åˆå§‹åŒ–åºåˆ—åŒ–ä¼˜åŒ–å™¨

åœ¨

DubboProtocol/#optimizeSerialization()
æ–¹æ³•ä¸­ï¼Œåˆå§‹åŒ–åºåˆ—åŒ–ä¼˜åŒ–å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
//*/*
/* å·²åˆå§‹åŒ–çš„ SerializationOptimizer å®ç°ç±»åçš„é›†åˆ
/*/
private final Set<String> optimizers = new ConcurrentHashSet<String>();
private void optimizeSerialization(URL url) throws RpcException{
// è·å¾— `"optimizer"` é…ç½®é¡¹
String className = url.getParameter(Constants.OPTIMIZER_KEY, "");
if (StringUtils.isEmpty(className) || optimizers.contains(className)) { // å·²æ³¨å†Œ
return;
}
logger.info("Optimizing the serialization process for Kryo, FST, etc...");
try {
// åŠ è½½ SerializationOptimizer å®ç°ç±»
Class clazz = Thread.currentThread().getContextClassLoader().loadClass(className);
if (!SerializationOptimizer.class.isAssignableFrom(clazz)) {
throw new RpcException("The serialization optimizer " + className + " isn't an instance of " + SerializationOptimizer.class.getName());
}
// åˆ›å»º SerializationOptimizer å¯¹è±¡
SerializationOptimizer optimizer = (SerializationOptimizer) clazz.newInstance();
if (optimizer.getSerializableClasses() == null) {
return;
}
// æ³¨å†Œåˆ° SerializableClassRegistry ä¸­
for (Class c : optimizer.getSerializableClasses()) {
SerializableClassRegistry.registerClass(c);
}
// æ·»åŠ åˆ° optimizers ä¸­
optimizers.add(className);
} catch (ClassNotFoundException e) {
throw new RpcException("Cannot find the serialization optimizer class: " + className, e);
} catch (InstantiationException e) {
throw new RpcException("Cannot instantiate the serialization optimizer class: " + className, e);
} catch (IllegalAccessException e) {
throw new RpcException("Cannot instantiate the serialization optimizer class: " + className, e);
}
}
```

- ğŸ™‚ èƒ–å‹ï¼Œç›´æ¥çœ‹ä»£ç æ³¨é‡Šã€‚

# 3. Dubbo å®ç°

åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” åºåˆ—åŒ–ï¼ˆäºŒï¼‰ä¹‹ Dubbo å®ç°ã€‹](http://svip.iocoder.cn/Dubbo/serialize-2-dubbo?self) ä¸­ï¼Œè¯¦ç»†è§£æã€‚

# 4. Kryo å®ç°

åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” åºåˆ—åŒ–ï¼ˆä¸‰ï¼‰ä¹‹ Kryo å®ç°ã€‹](http://svip.iocoder.cn/Dubbo/serialize-3-kryo?self) ä¸­ï¼Œè¯¦ç»†è§£æã€‚

# 5. FST å®ç°

FST fast-serialization æ˜¯é‡æ–°å®ç°çš„ Java å¿«é€Ÿå¯¹è±¡åºåˆ—åŒ–çš„å¼€å‘åŒ…ã€‚åºåˆ—åŒ–é€Ÿåº¦æ›´å¿«ï¼ˆ2-10 å€ï¼‰ã€ä½“ç§¯æ›´å°ï¼Œè€Œä¸”å…¼å®¹ JDK åŸç”Ÿçš„åºåˆ—åŒ–ã€‚è¦æ±‚ JDK 1.7 æ”¯æŒã€‚

ğŸ™‚ æ–‡æœ«ï¼Œæœ‰**æ€§èƒ½**ç›¸å…³æµ‹è¯•çš„åˆ†äº«ã€‚

## 4.1 FstFactory

com.alibaba.dubbo.common.serialize.support.fst.FstFactory
ï¼ŒFST å·¥å‚ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class FstFactory{
//*/*
/* å•ä¾‹
/*/
private static final FstFactory factory = new FstFactory();
//*/*
/* é…ç½®å¯¹è±¡
/*/
private final FSTConfiguration conf = FSTConfiguration.createDefaultConfiguration();
public static FstFactory getDefaultFactory(){
return factory;
}
public FstFactory(){
// æ³¨å†Œ
for (Class clazz : SerializableClassRegistry.getRegisteredClasses()) {
conf.registerClass(clazz);
}
}
public FSTObjectOutput getObjectOutput(OutputStream outputStream){
return conf.getObjectOutput(outputStream);
}
public FSTObjectInput getObjectInput(InputStream inputStream){
return conf.getObjectInput(inputStream);
}
}
```

- factory
  **é™æ€**å±æ€§ï¼Œå•ä¾‹ã€‚
- conf
  å±æ€§ï¼ŒFST é…ç½®å¯¹è±¡ã€‚åœ¨**æ„é€ æ–¹æ³•**ä¸­ï¼Œå°† SerializableClassRegistry æ³¨å†Œè¡¨éœ€è¦ä½¿ç”¨**ä¼˜åŒ–**çš„ç±»ï¼Œæ³¨å†Œåˆ° FSTConfiguration ä¸­ã€‚

SerializableClassRegistry/#registerClass(Class ... c)
æ–¹æ³•ï¼Œæ³¨é‡Šå¦‚ä¸‹ï¼š

```
//*/*
/*
/* Preregister a class (use at init time). This avoids having to write class names.
/* Its a very simple and effective optimization (frequently > 2 times faster for small objects).
/* é¢„æ³¨å†Œä¸€ä¸ªç±»(åœ¨åˆå§‹åŒ–æ—¶ä½¿ç”¨)ã€‚è¿™æ ·å¯ä»¥é¿å…ç¼–å†™ç±»åã€‚
/* å®ƒæ˜¯ä¸€ç§éå¸¸ç®€å•æœ‰æ•ˆçš„ä¼˜åŒ–(å¯¹äºå°å¯¹è±¡æ¥è¯´ï¼Œé€šå¸¸æ˜¯>çš„2å€)ã€‚
/*
/* Read and write side need to have classes preregistered in the exact same order.
/* å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éœ€è¦é¢„å…ˆä»¥å®Œå…¨ç›¸åŒçš„é¡ºåºæ³¨å†Œã€‚
/*
/*
/* The list does not have to be complete. Just add your most frequently serialized classes here
/* to get significant gains in speed and smaller serialized representation size.
/*
/* è¿™ä¸ªåˆ—è¡¨å¹¶ä¸ä¸€å®šè¦å®Œæ•´ã€‚åªéœ€åœ¨è¿™é‡Œæ·»åŠ æœ€å¸¸è§çš„åºåˆ—åŒ–ç±»ï¼Œä»¥è·å¾—é€Ÿåº¦å’Œè¾ƒå°çš„åºåˆ—åŒ–è¡¨ç¤ºå¤§å°çš„æ˜¾è‘—æé«˜ã€‚
/*/
```

- /#getObjectOutput()
  æ–¹æ³•ï¼Œè·å¾—

org.nustaq.serialization.FSTObjectOutput
å¯¹è±¡ï¼Œè¢« FstObjectOutput è°ƒç”¨ã€‚

- /#getObjectInput()
  æ–¹æ³•ï¼Œè·å¾—

org.nustaq.serialization.FSTObjectInput
å¯¹è±¡ï¼Œè¢« FstObjectInput è°ƒç”¨ã€‚

## 4.2 FstSerialization

com.alibaba.dubbo.common.serialize.support.fst.FstSerialization
ï¼Œå®ç° Serialization æ¥å£ï¼ŒFST **åºåˆ—åŒ–**å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class FstSerialization implements Serialization{
@Override
public byte getContentTypeId(){
return 9;
}
@Override
public String getContentType(){
return "x-application/fst";
}
@Override
public ObjectOutput serialize(URL url, OutputStream out) throws IOException{
return new FstObjectOutput(out);
}
@Override
public ObjectInput deserialize(URL url, InputStream is) throws IOException{
return new FstObjectInput(is);
}
}
```

- "x-application/fst"
  ï¼Œç±»ä¼¼ HTTP åè®® çš„ **Content-Types** çš„ Header ã€‚åœ¨ [ã€6. JSON å®ç°ã€](http://svip.iocoder.cn/Dubbo/serialize-1-all/) ç±»ä¸­ï¼Œè¿”å›çš„æ˜¯

"text/json"
ã€‚

## 4.3 FstObjectInput

[
com.alibaba.dubbo.common.serialize.support.fst.FstObjectInput
](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/fst/FstObjectInput.java) ï¼Œå®ç° ObjectInput æ¥å£ï¼ŒFST å¯¹è±¡**è¾“å…¥**å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**

```
private FSTObjectInput input;
public FstObjectInput(InputStream inputStream){
input = FstFactory.getDefaultFactory().getObjectInput(inputStream);
}
```

- input
  å±æ€§ï¼Œè°ƒç”¨

FstFactory/#getObjectInput(inputStream)
æ–¹æ³•ï¼Œè·å¾—ã€‚

**å®ç°æ–¹æ³•**

æ¯ä¸ªå®ç°æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ FSTObjectInput å¯¹åº”çš„æ–¹æ³•ã€‚æ¯”è¾ƒç‰¹æ®Šçš„æ˜¯ï¼Œ

/#readBytes()
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
@Override
public byte[] readBytes() throws IOException {
int len = input.readInt();
// æ•°ç»„ä¸ºç©º
if (len < 0) {
return null;
// æ•°ç»„ä¸ºé›¶
} else if (len == 0) {
return new byte[]{};
// æ•°ç»„ > 0
} else {
byte[] b = new byte[len];
input.readFully(b);
return b;
}
}
```

- [ å­—èŠ‚æ•°ç»„é•¿åº¦, å­—èŠ‚æ•°ç»„å†…å®¹ ]

## 4.4 FstObjectOutput

[
com.alibaba.dubbo.common.serialize.support.fst.FstObjectOutput
](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/fst/FstObjectOutput.java) ï¼Œå®ç° ObjectOutput æ¥å£ï¼ŒFST å¯¹è±¡**è¾“å‡º**å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**

```
private FSTObjectOutput output;
public FstObjectOutput(OutputStream outputStream){
output = FstFactory.getDefaultFactory().getObjectOutput(outputStream);
}
```

- output
  å±æ€§ï¼Œè°ƒç”¨

FstFactory/#getObjectInput(outputStream)
æ–¹æ³•ï¼Œè·å¾—ã€‚

**å®ç°æ–¹æ³•**

æ¯ä¸ªå®ç°æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ FSTObjectInput å¯¹åº”çš„æ–¹æ³•ã€‚æ¯”è¾ƒç‰¹æ®Šçš„æ˜¯ï¼Œ

/#writeBytes(byte[] v)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
@Override
public void writeBytes(byte[] v) throws IOException{
// ç©ºï¼Œå†™å…¥ -1
if (v == null) {
output.writeInt(-1);
// æœ‰æ•°ç»„
} else {
writeBytes(v, 0, v.length);
}
}
```

- [ å­—èŠ‚æ•°ç»„é•¿åº¦, å­—èŠ‚æ•°ç»„å†…å®¹ ]

# 6. JSON å®ç°

åŸºäº FastJSON å®ç°ã€‚
fastjson æ˜¯ä¸€ä¸ªæ€§èƒ½å¾ˆå¥½çš„ Java è¯­è¨€å®ç°çš„ JSON è§£æå™¨å’Œç”Ÿæˆå™¨ï¼Œæ¥è‡ªé˜¿é‡Œå·´å·´çš„å·¥ç¨‹å¸ˆå¼€å‘ã€‚

ä¸»è¦ç‰¹ç‚¹ï¼š

- å¿«é€Ÿ FAST (æ¯”å…¶å®ƒä»»ä½•åŸºäº Java çš„è§£æå™¨å’Œç”Ÿæˆå™¨æ›´å¿«ï¼ŒåŒ…æ‹¬ [jackson](https://www.oschina.net/p/jackson)ï¼‰
- å¼ºå¤§ï¼ˆæ”¯æŒæ™®é€š JDK ç±»åŒ…æ‹¬ä»»æ„ Java Bean Classã€Collectionã€Mapã€Date æˆ– enumï¼‰
- é›¶ä¾èµ–ï¼ˆæ²¡æœ‰ä¾èµ–å…¶å®ƒä»»ä½•ç±»åº“é™¤äº† JDKï¼‰

ä»£ç æ¯”è¾ƒç®€å•ï¼Œå’Œ [ã€5. FST å®ç°ã€](http://svip.iocoder.cn/Dubbo/serialize-1-all/) ç±»ä¼¼ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ï¼š

- [
  com.alibaba.dubbo.common.serialize.support.json.FastJsonSerialization
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/json/FastJsonSerialization.java)
- [
  com.alibaba.dubbo.common.serialize.support.json.FastJsonObjectInput
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/json/FastJsonObjectInput.java)
- [
  com.alibaba.dubbo.common.serialize.support.json.FastJsonObjectOutput
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/json/FastJsonObjectOutput.java)

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ

FastJsonObjectOutput/#writeObject(Object)
æ–¹æ³•çš„å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
@Override
public void writeObject(Object obj) throws IOException{
SerializeWriter out = new SerializeWriter();
// åºåˆ—åŒ–ï¼Œå†™å…¥å¯¹è±¡
JSONSerializer serializer = new JSONSerializer(out);
serializer.config(SerializerFeature.WriteEnumUsingToString, true); // æšä¸¾è½¬å­—ç¬¦ä¸²
serializer.write(obj);
// å†™åˆ°ï¼Œè¾“å‡ºæµ
out.writeTo(writer);
out.close(); // for reuse SerializeWriter buf
writer.println(); // æ¢è¡Œ
writer.flush();
}
```

# 7. Hessian2 å®ç°

å’Œå…¶ä»– Web æœåŠ¡çš„å®ç°æ¡†æ¶ä¸åŒçš„æ˜¯ï¼ŒHessian æ˜¯ä¸€ä¸ªä½¿ç”¨äºŒè¿›åˆ¶ Web æœåŠ¡åè®®çš„æ¡†æ¶ï¼Œå®ƒçš„å¥½å¤„åœ¨äºå…é™¤äº†ä¸€å¤§å †é™„åŠ çš„ API åŒ…ï¼Œä¾‹å¦‚ XML çš„å¤„ç†ä¹‹ç±»çš„ jar åŒ…ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¯´å®ƒæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ Web æœåŠ¡å®ç°æ¡†æ¶çš„åŸå› ï¼Œè¿™ä¸ªåŸå› è¿˜åœ¨äºæ‰‹æœºä¸Šçš„åº”ç”¨ç¨‹åºå¯ä»¥é€šè¿‡ Hessian æä¾›çš„ API å¾ˆæ–¹ä¾¿çš„è®¿é—® Hessian çš„ Web æœåŠ¡ã€‚

ä»ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒHessian è‡ªå·±æœ‰è‡ªå·±çš„**åºåˆ—åŒ–**çš„å®ç°ã€‚ä½†æ˜¯ï¼ŒHessian åœ¨å®ç°ä¸Šï¼Œå­˜åœ¨ä¸€äº› Bug å’Œéœ€è¦æ€§èƒ½ä¼˜åŒ–çš„ç‚¹ã€‚ä¾‹å¦‚ï¼š

**BigDecimal çš„ååºåˆ—åŒ–**

ä½¿ç”¨ Hessian åºåˆ—åŒ–åŒ…å« BigDecimal å­—æ®µçš„å¯¹è±¡æ—¶ä¼šå¯¼è‡´å…¶å€¼ä¸€ç›´ä¸º 0ï¼Œä¸æ³¨æ„è¿™ä¸ª bug ä¼šå¯¼è‡´å¾ˆå¤§çš„é—®é¢˜ï¼Œåœ¨æœ€æ–°çš„ 4.0.51 ç‰ˆæœ¬ä»ç„¶å¯ä»¥å¤ç°ã€‚è§£å†³æ–¹æ¡ˆä¹Ÿå¾ˆç®€å•ï¼ŒæŒ‡å®š BigDecimal çš„åºåˆ—åŒ–å™¨å³å¯ã€‚

æ‰€ä»¥ Dubbo ç»´æŠ¤äº†è‡ªå·±çš„ [
hessian-lite
](https://github.com/alibaba/dubbo/tree/4bbc0ddddacc915ddc8ff292dd28745bbc0031fd/hessian-lite) ï¼Œå¯¹ [Hessian 2](http://hessian.caucho.com/) çš„ **åºåˆ—åŒ–** éƒ¨åˆ†çš„ç²¾ç®€ã€æ”¹è¿›ã€BugFix ã€‚
æäº¤å†å²å¦‚ä¸‹ï¼š
![hessian-lite æäº¤å†å²](http://static2.iocoder.cn/images/Dubbo/2018_01_04/23.png)

ä»£ç æ¯”è¾ƒç®€å•ï¼Œå’Œ [ã€5. FST å®ç°ã€](http://svip.iocoder.cn/Dubbo/serialize-1-all/) ç±»ä¼¼ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ï¼š

- [
  com.alibaba.dubbo.common.serialize.support.hessian.Hessian2SerializerFactory
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/hessian/Hessian2SerializerFactory.java)
- [
  com.alibaba.dubbo.common.serialize.support.hessian.Hessian2Serialization
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/hessian/Hessian2Serialization.java)
- [
  com.alibaba.dubbo.common.serialize.support.hessian.Hessian2ObjectInput
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/hessian/Hessian2ObjectInput.java)
- [
  com.alibaba.dubbo.common.serialize.support.hessian.Hessian2ObjectOutput
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/hessian/Hessian2ObjectOutput.java)

# 8. NativeJava å®ç°

æ—ç™½å›ï¼šç”±äºè‰¿è‰¿å¯¹ Java åŸç”Ÿçš„åºåˆ—åŒ–ï¼Œäº†è§£çš„æ¯”è¾ƒç²—æµ…ï¼Œæœ¬å°èŠ‚æ›´å¤šçš„æ˜¯æŠŠä»£ç æ¢³ç†å¹²å‡€ã€‚

nativejava
ï¼ŒåŸºäº Java **åŸç”Ÿ**( è‡ªå¸¦ )çš„ Java åºåˆ—åŒ–å®ç°ï¼Œå³ä½¿ç”¨

java.io.ObjectInputStream
å’Œ

java.io.ObjectOutputStream
è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚

ä»£ç æ¯”è¾ƒç®€å•ï¼Œå’Œ [ã€5. FST å®ç°ã€](http://svip.iocoder.cn/Dubbo/serialize-1-all/) ç±»ä¼¼ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ï¼š

- [
  com.alibaba.dubbo.common.serialize.support.nativejava.NativeJavaSerialization
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/nativejava/NativeJavaSerialization.java)
- [
  com.alibaba.dubbo.common.serialize.support.nativejava.NativeJavaObjectInput
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/nativejava/NativeJavaObjectInput.java)
- [
  com.alibaba.dubbo.common.serialize.support.nativejava.NativeJavaObjectOutput
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/nativejava/NativeJavaObjectOutput.java)

## 8.1 Java å®ç°

java
ï¼Œåœ¨ [ã€8. NativeJava å®ç°ã€](http://svip.iocoder.cn/Dubbo/serialize-1-all/) çš„åŸºç¡€ä¸Šï¼Œå®ç°äº†å¯¹ç©ºå­—ç¬¦ä¸²å’Œç©ºå¯¹è±¡çš„å¤„ç†ã€‚å¦‚ä¸‹æ˜¯ JavaObjectOutput å¯¹ç©ºå­—ç¬¦ä¸²å’Œç©ºå¯¹è±¡çš„åºåˆ—åŒ–ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
// ã€æ³¨æ„ã€‘JavaObjectOutput extends NativeJavaObjectOutput ï¼ï¼ï¼
@Override
public void writeUTF(String v) throws IOException{
if (v == null) { // ç©ºå­—ç¬¦ä¸²
getObjectOutputStream().writeInt(-1);
} else {
getObjectOutputStream().writeInt(v.length()); // é•¿åº¦
getObjectOutputStream().writeUTF(v); // å­—ç¬¦ä¸²
}
}
@Override
public void writeObject(Object obj) throws IOException{
if (obj == null) { // ç©º
getObjectOutputStream().writeByte(0); // ç©º
} else {
getObjectOutputStream().writeByte(1); // éç©º
getObjectOutputStream().writeObject(obj); // å¯¹è±¡
}
}
```

ä»£ç æ¯”è¾ƒç®€å•ï¼Œå’Œ [ã€NativeJava å®ç°ã€](http://svip.iocoder.cn/Dubbo/serialize-1-all/) ç±»ä¼¼ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ï¼š

- [
  com.alibaba.dubbo.common.serialize.support.java.JavaSerialization
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/java/JavaSerialization.java)
- [
  com.alibaba.dubbo.common.serialize.support.java.JavaObjectInput
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/java/JavaObjectInput.java)
- [
  com.alibaba.dubbo.common.serialize.support.java.JavaObjectOutput
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/java/JavaObjectOutput.java)

## 8.2 CompactedJava

compactedjava
ï¼Œåœ¨ [ã€8.1 Java å®ç°ã€](http://svip.iocoder.cn/Dubbo/serialize-1-all/) çš„åŸºç¡€ä¸Šï¼Œå®ç°äº†å¯¹ **ClassDescriptor** çš„å¤„ç†ã€‚å¦‚ä¸‹æ˜¯ CompactedObjectOutputStream å¯¹ **ClassDescriptor** çš„å†™å…¥ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
// ã€æ³¨æ„ã€‘CompactedObjectOutputStream extends ObjectOutputStream ï¼ï¼ï¼
@Override
protected void writeClassDescriptor(ObjectStreamClass desc) throws IOException{
Class<?> clazz = desc.forClass();
if (clazz.isPrimitive() || clazz.isArray()) {
write(0);
super.writeClassDescriptor(desc);
} else {
write(1);
writeUTF(desc.getName());
}
}
```

- åœ¨ JavaObjectOutput çš„åˆ›å»ºæ—¶ï¼Œæ ¹æ®

compact = true
æ—¶ï¼Œä½¿ç”¨ CompactedObjectOutputStream è¾“å‡ºæµã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public JavaObjectOutput(OutputStream os, boolean compact) throws IOException{
super(compact ? new CompactedObjectOutputStream(os) : new ObjectOutputStream(os));
}
```

ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ï¼š

- [
  com.alibaba.dubbo.common.serialize.support.java.CompactedJavaSerialization
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/java/CompactedJavaSerialization.java)
- [
  com.alibaba.dubbo.common.serialize.support.java.CompactedObjectInputStream
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/java/CompactedObjectInputStream.java)
- [
  com.alibaba.dubbo.common.serialize.support.java.CompactedObjectOutputStream
  ](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/java/CompactedObjectOutputStream.java)
