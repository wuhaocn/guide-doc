# é›†ç¾¤å®¹é”™ï¼ˆäº”ï¼‰ä¹‹ Merger å®ç°

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡æ¥ [ã€Šç²¾å°½ Dubbo æºç è§£æ â€”â€” é›†ç¾¤å®¹é”™ï¼ˆå››ï¼‰ä¹‹ LoadBalance å®ç°ã€‹](http://svip.iocoder.cn/Dubbo/cluster-4-impl-loadbalance/?self) ä¸€æ–‡ï¼Œåˆ†äº«

dubbo-cluster
æ¨¡å—ï¼Œ

merger
åŒ…ï¼Œ**å„ç§ Merger å®ç°ç±»**ã€‚

Merger ç›¸å…³ç±»ï¼Œå¦‚ä¸‹å›¾ï¼š

![Merger ç›¸å…³ç±»](http://static2.iocoder.cn/images/Dubbo/2019_04_20/01.png)

æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç›®å‰ä¸€å…±æœ‰**ä¸¤éƒ¨åˆ†**ï¼š

- Merger ä»¥åŠå…¶å®ç°ç±»ã€‚
- MergerCluster ä»¥åŠå…¶ MergerClusterInvoker
  è€è‰¿è‰¿ï¼šæœ¬æ–‡å¯¹åº” [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” åˆ†ç»„èšåˆã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/group-merger.html) æ–‡æ¡£ã€‚

# 2. Merger

com.alibaba.dubbo.rpc.cluster.Merger
ï¼ŒMerger **æ¥å£**ï¼Œæä¾›æ¥å£æ–¹æ³•ï¼Œå°†**å¯¹è±¡æ•°ç»„**åˆå¹¶æˆ**ä¸€ä¸ªå¯¹è±¡**ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
@SPI
public interface Merger<T>{
//*/*
/* åˆå¹¶ T æ•°ç»„ï¼Œè¿”å›åˆå¹¶åçš„ T å¯¹è±¡
/*
/* @param items T æ•°ç»„
/* @return T å¯¹è±¡
/*/
T merge(T... items);
}
```

- @SPI
  æ³¨è§£ï¼ŒDubbo SPI **æ‹“å±•ç‚¹**ï¼Œæ— é»˜è®¤å€¼ã€‚

## 2.1 Merger å®ç°ç±»

Merger å†…ç½®**åäºŒ**ä¸ªå®ç°ç±»ï¼Œä»ä»£ç ä¸Šçœ‹åŸºæœ¬ç±»ä¼¼ã€‚æˆ‘ä»¬ä»¥ MapMerger å’Œ ShortArrayMerger ä½œä¸ºä¾‹å­ã€‚

### 2.1.1 MapMerger

com.alibaba.dubbo.rpc.cluster.merger.MapMerger
ï¼Œå®ç° Merger æ¥å£ï¼ŒMap Merger å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class MapMerger implements Merger<Map<?, ?>>{
@Override
public Map<?, ?> merge(Map<?, ?>... items) {
if (items.length == 0) {
return null;
}
// åˆ›å»ºç»“æœ Map
Map<Object, Object> result = new HashMap<Object, Object>();
// åˆå¹¶å¤šä¸ª Map
for (Map<?, ?> item : items) {
if (item != null) {
result.putAll(item);
}
}
return result;
}
}
```

### 2.1.2 ShortArrayMerger

com.alibaba.dubbo.rpc.cluster.merger.ShortArrayMerger
ï¼Œå®ç° Merger æ¥å£ï¼ŒShort æ•°ç»„ Merger å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class ShortArrayMerger implements Merger<short[]> {
@Override
public short[] merge(short[]... items) {
// è®¡ç®—åˆå¹¶åçš„æ•°ç»„å¤§å°
int total = 0;
for (short[] array : items) {
total += array.length;
}
// åˆ›å»ºç»“æœæ•°ç»„
short[] result = new short[total];
// åˆå¹¶å¤šä¸ªæ•°ç»„
int index = 0;
for (short[] array : items) {
for (short item : array) {
result[index++] = item;
}
}
return result;
}
}
```

## 2.2 MergerFactory

com.alibaba.dubbo.rpc.cluster.merger.MergerFactory
ï¼ŒMerger å·¥å‚ç±»ï¼Œæä¾›

/#getMerger(Class<T> returnType)
æ–¹æ³•ï¼Œè·å¾—**æŒ‡å®šç±»**å¯¹åº”çš„ Merger å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class MergerFactory{
//*/*
/* Merger å¯¹è±¡ç¼“å­˜
/*/
private static final ConcurrentMap<Class<?>, Merger<?>> mergerCache = new ConcurrentHashMap<Class<?>, Merger<?>>();
public static <T> Merger<T> getMerger(Class<T> returnType){
Merger result;
// æ•°ç»„ç±»å‹
if (returnType.isArray()) {
Class type = returnType.getComponentType();
// ä»ç¼“å­˜ä¸­è·å¾— Merger å¯¹è±¡
result = mergerCache.get(type);
if (result == null) {
loadMergers();
result = mergerCache.get(type);
}
// è·å–ä¸åˆ°ï¼Œä½¿ç”¨ ArrayMerger
if (result == null && !type.isPrimitive()) {
result = ArrayMerger.INSTANCE;
}
// æ™®é€šç±»å‹
} else {
// ä»ç¼“å­˜ä¸­è·å¾— Merger å¯¹è±¡
result = mergerCache.get(returnType);
if (result == null) {
loadMergers();
result = mergerCache.get(returnType);
}
}
return result;
}
//*/*
/* åˆå§‹åŒ–æ‰€æœ‰çš„ Merger æ‹“å±•å¯¹è±¡ï¼Œåˆ° mergerCache ç¼“å­˜ä¸­ã€‚
/*/
static void loadMergers(){
Set<String> names = ExtensionLoader.getExtensionLoader(Merger.class).getSupportedExtensions();
for (String name : names) {
Merger m = ExtensionLoader.getExtensionLoader(Merger.class).getExtension(name);
mergerCache.putIfAbsent(ReflectUtils.getGenericClass(m.getClass()), m);
}
}
}
```

# 3. MergeableCluster

com.alibaba.dubbo.rpc.cluster.support.MergeableCluster
ï¼Œå®ç° Cluster æ¥å£ï¼Œåˆ†ç»„èšåˆ Cluster å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
public class MergeableCluster implements Cluster{
public static final String NAME = "mergeable";
@Override
public <T> Invoker<T> join(Directory<T> directory) throws RpcException{
return new MergeableClusterInvoker<T>(directory);
}
}
```

- å¯¹åº” Invoker å®ç°ç±»ä¸º MergeableClusterInvoker ã€‚

Merger çš„ä½¿ç”¨ï¼Œ**éœ€è¦è®¾ç½® Cluster çš„å®ç°ç±»ä¸º MergeableCluster** ã€‚ä½†æ˜¯å‘¢ï¼Œå®ƒçš„é…ç½®æ–¹å¼ï¼Œå’Œå…¶ä»– Cluster å®ç°ç±»ä¸åŒã€‚

- ä½¿ç”¨æ–¹å¼ï¼Œå‚è§ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” åˆ†ç»„èšåˆã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/group-merger.html) æ–‡æ¡£ã€‚
- åŸå› ï¼Œå‚è§ [ã€Šç²¾å°½ Dubbo æºç è§£æ â€”â€” é›†ç¾¤å®¹é”™ï¼ˆä¸‰ï¼‰ä¹‹ Directory å®ç°ã€‹](http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory?self) çš„ [ã€Œ4.3.3.3 toMergeMethodInvokerMapã€](http://svip.iocoder.cn/Dubbo/cluster-5-impl-merger/) ã€‚

## 3.1 MergeableClusterInvoker

com.alibaba.dubbo.rpc.cluster.support.MergeableClusterInvoker
ï¼Œå®ç° Invoker æ¥å£ï¼ŒMergeableCluster Invoker å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
//*/*
/* Directory$Adaptive å¯¹è±¡
/*/
private final Directory<T> directory;
//*/*
/* ExecutorService å¯¹è±¡ï¼Œå¹¶ä¸”ä¸º CachedThreadPool ã€‚
/*/
private ExecutorService executor = Executors.newCachedThreadPool(new NamedThreadFactory("mergeable-cluster-executor", true));
1: @Override
2: public Result invoke(final Invocation invocation) throws RpcException{
3: // è·å¾— Invoker é›†åˆ
4: List<Invoker<T>> invokers = directory.list(invocation);
5: // è·å¾— Merger æ‹“å±•å
6: String merger = getUrl().getMethodParameter(invocation.getMethodName(), Constants.MERGER_KEY);
7: // è‹¥æœæœªé…ç½®æ‹“å±•ï¼Œç›´æ¥è°ƒç”¨é¦–ä¸ªå¯ç”¨çš„ Invoker å¯¹è±¡
8: if (ConfigUtils.isEmpty(merger)) { // If a method doesn't have a merger, only invoke one Group
9: for (final Invoker<T> invoker : invokers) {
10: if (invoker.isAvailable()) {
11: return invoker.invoke(invocation);
12: }
13: }
14: return invokers.iterator().next().invoke(invocation);
15: }
16:
17: // é€šè¿‡åå°„ï¼Œè·å¾—è¿”å›ç±»å‹
18: Class<?> returnType;
19: try {
20: returnType = getInterface().getMethod(invocation.getMethodName(), invocation.getParameterTypes()).getReturnType();
21: } catch (NoSuchMethodException e) {
22: returnType = null;
23: }
24:
25: // æäº¤çº¿ç¨‹æ± ï¼Œå¹¶è¡Œæ‰§è¡Œï¼Œå‘èµ· RPC è°ƒç”¨ï¼Œå¹¶æ·»åŠ åˆ° results ä¸­
26: Map<String, Future<Result>> results = new HashMap<String, Future<Result>>();
27: for (final Invoker<T> invoker : invokers) {
28: Future<Result> future = executor.submit(new Callable<Result>() {
29: public Result call(){
30: // RPC è°ƒç”¨
31: return invoker.invoke(new RpcInvocation(invocation, invoker));
32: }
33: });
34: results.put(invoker.getUrl().getServiceKey(), future);
35: }
36:
37: // é˜»å¡ç­‰å¾…æ‰§è¡Œæ‰§è¡Œç»“æœï¼Œå¹¶æ·»åŠ åˆ° resultList ä¸­
38: List<Result> resultList = new ArrayList<Result>(results.size());
39: int timeout = getUrl().getMethodParameter(invocation.getMethodName(), Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);
40: for (Map.Entry<String, Future<Result>> entry : results.entrySet()) {
41: Future<Result> future = entry.getValue();
42: try {
43: Result r = future.get(timeout, TimeUnit.MILLISECONDS);
44: if (r.hasException()) { // å¼‚å¸¸ Result ï¼Œæ‰“å°é”™è¯¯æ—¥å¿—ï¼Œå¿½ç•¥
45: log.error(new StringBuilder(32).append("Invoke ").append(getGroupDescFromServiceKey(entry.getKey())).append(" failed: ").append(r.getException().getMessage()).toString(), r.getException());
46: } else { // æ­£å¸¸ Result ï¼Œæ·»åŠ åˆ° resultList ä¸­
47: resultList.add(r);
48: }
49: } catch (Exception e) { // å¼‚å¸¸ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸
50: throw new RpcException(new StringBuilder(32).append("Failed to invoke service ").append(entry.getKey()).append(": ").append(e.getMessage()).toString(), e);
51: }
52: }
53:
54: // ç»“æœå¤§å°ä¸ºç©ºï¼Œè¿”å›ç©ºçš„ RpcResult
55: if (resultList.isEmpty()) {
56: return new RpcResult((Object) null);
57: // ç»“æœå¤§å°ä¸º 1 ï¼Œè¿”å›é¦–ä¸ª RpcResult
58: } else if (resultList.size() == 1) {
59: return resultList.iterator().next();
60: }
61: // è¿”å›ç±»å‹ä¸º void ï¼Œè¿”å›ç©ºçš„ RpcResult
62: if (returnType == void.class) {
63: return new RpcResult((Object) null);
64: }
65:
66: Object result;
67: // ã€ç¬¬ 1 ç§ã€‘åŸºäºåˆå¹¶æ–¹æ³•
68: if (merger.startsWith(".")) {
69: // è·å¾—åˆå¹¶æ–¹æ³• Method
70: merger = merger.substring(1);
71: Method method;
72: try {
73: method = returnType.getMethod(merger, returnType);
74: } catch (NoSuchMethodException e) {
75: throw new RpcException(new StringBuilder(32).append("Can not merge result because missing method [ ").append(merger).append(" ] in class [ ").append(returnType.getClass().getName()).append(" ]").toString());
76: }
77: // æœ‰ Method ï¼Œè¿›è¡Œåˆå¹¶
78: if (method != null) {
79: if (!Modifier.isPublic(method.getModifiers())) {
80: method.setAccessible(true);
81: }
82: result = resultList.remove(0).getValue();
83: try {
84: // æ–¹æ³•è¿”å›ç±»å‹åŒ¹é…ï¼Œåˆå¹¶æ—¶ï¼Œä¿®æ”¹ result
85: if (method.getReturnType() != void.class && method.getReturnType().isAssignableFrom(result.getClass())) {
86: for (Result r : resultList) {
87: result = method.invoke(result, r.getValue());
88: }
89: // æ–¹æ³•è¿”å›ç±»å‹ä¸åŒ¹é…ï¼Œåˆå¹¶æ—¶ï¼Œä¸ä¿®æ”¹ result
90: } else {
91: for (Result r : resultList) {
92: method.invoke(result, r.getValue());
93: }
94: }
95: } catch (Exception e) {
96: throw new RpcException(new StringBuilder(32).append("Can not merge result: ").append(e.getMessage()).toString(), e);
97: }
98: // æ—  Method ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸
99: } else {
100: throw new RpcException(new StringBuilder(32).append("Can not merge result because missing method [ ").append(merger).append(" ] in class [ ").append(returnType.getClass().getName()).append(" ]").toString());
101: }
102: // ã€ç¬¬ 2 ç§ã€‘åŸºäº Merger
103: } else {
104: Merger resultMerger;
105: // ã€ç¬¬ 2.1 ç§ã€‘æ ¹æ®è¿”å›å€¼ç±»å‹è‡ªåŠ¨åŒ¹é… Merger
106: if (ConfigUtils.isDefault(merger)) {
107: resultMerger = MergerFactory.getMerger(returnType);
108: // ã€ç¬¬ 2.2 ç§ã€‘æŒ‡å®š Merger
109: } else {
110: resultMerger = ExtensionLoader.getExtensionLoader(Merger.class).getExtension(merger);
111: }
112: // æœ‰ Merger ï¼Œè¿›è¡Œåˆå¹¶
113: if (resultMerger != null) {
114: List<Object> rets = new ArrayList<Object>(resultList.size());
115: for (Result r : resultList) {
116: rets.add(r.getValue());
117: }
118: result = resultMerger.merge(rets.toArray((Object[]) Array.newInstance(returnType, 0)));
119: // æ—  Merger ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸
120: } else {
121: throw new RpcException("There is no merger to merge result.");
122: }
123: }
124: // è¿”å› RpcResult ç»“æœ
125: return new RpcResult(result);
126: }
```

- ğŸ™‚ çœ‹ä¼¼æ¯”è¾ƒé•¿ï¼Œå®é™…å¾ˆæ˜“æ‡‚ã€‚
- ç¬¬ 4 è¡Œï¼šè°ƒç”¨

Directory/#list(invocation)
æ–¹æ³•ï¼Œè·å¾—æœåŠ¡ Invoker **é›†åˆ**ã€‚

- ç¬¬ 6 è¡Œï¼šè°ƒç”¨

URL/#getMethodParameter(methodName, "merger")
æ–¹æ³•ï¼Œè·å¾— Merger æ‹“å±•åï¼Œ**æ–¹æ³•çº§**ã€‚

- ç¬¬ 7 è‡³ 15 è¡Œï¼šè‹¥**æœªé…ç½®** Merger æ‹“å±•åï¼Œä¼˜å…ˆè°ƒç”¨é¦–ä¸ª**å¯ç”¨**çš„ Invoker å¯¹è±¡ï¼Œå…¶æ¬¡è°ƒç”¨é¦–ä¸ª Invoker å¯¹è±¡ã€‚
- ç¬¬ 17 è‡³ 23 è¡Œï¼šé€šè¿‡åå°„ï¼Œè·å¾—è°ƒç”¨æ–¹æ³•çš„**è¿”å›ç±»å‹**ã€‚
- ç¬¬ 25 è‡³ 35 è¡Œï¼šæäº¤çº¿ç¨‹æ± ï¼Œ**å¹¶è¡Œ**æ‰§è¡Œï¼Œå‘èµ· RPC è°ƒç”¨ï¼Œå¹¶æ·»åŠ  Future åˆ°

results
ä¸­ã€‚

- ç¬¬ 37 è‡³ 52 è¡Œï¼š**é˜»å¡**ç­‰å¾…æ‰§è¡Œç»“æœï¼Œå¹¶æ·»åŠ åˆ°

resultList
ä¸­ã€‚**æ³¨æ„**ï¼Œåˆ†æˆæ­£å¸¸ Resultã€å¼‚å¸¸ Resultï¼ˆ**å¿½ç•¥**ï¼‰ã€Exception ä¸‰ç§æƒ…å†µã€‚

- ç¬¬ 54 è‡³ 56 è¡Œï¼šç»“æœå¤§å°ä¸º**ç©º**ï¼Œè¿”å›**ç©º**çš„ RpcResult ã€‚
- ç¬¬ 57 è‡³ 60 è¡Œï¼šç»“æœå¤§å°ä¸º **1** ï¼Œè¿”å›**é¦–ä¸ª** RpcResult ã€‚
- ç¬¬ 61 è‡³ 64 è¡Œï¼šè¿”å›ç±»å‹ä¸º **void** ï¼Œè¿”å›**ç©º**çš„ RpcResult ã€‚
- ========== ã€**ç¬¬ 1 ç§**ã€‘åŸºäº Method åˆå¹¶==========
- ç¬¬ 68 è¡Œï¼šè‹¥

merger
ä¸º

"."
å¼€å¤´ï¼ŒæŒ‡å®šåˆå¹¶æ–¹æ³•ï¼Œå°†è°ƒç”¨è¿”å›ç»“æœçš„æŒ‡å®šæ–¹æ³•è¿›è¡Œåˆå¹¶ï¼Œåˆå¹¶æ–¹æ³•çš„å‚æ•°ç±»å‹å¿…é¡»æ˜¯è¿”å›ç»“æœç±»å‹**æœ¬èº«**ã€‚

- ç¬¬ 69 è‡³ 76 è¡Œï¼šè°ƒç”¨

Class/#getMethod(String name, Class<?>... parameterTypes)
æ–¹æ³•ï¼Œè·å¾—**åˆå¹¶æ–¹æ³• Method** ã€‚è¿™ä¸ªæ–¹æ³•ï¼Œæ„å‘³ç€â€œåˆå¹¶æ–¹æ³•çš„å‚æ•°ç±»å‹å¿…é¡»æ˜¯è¿”å›ç»“æœç±»å‹**æœ¬èº«**â€ï¼ï¼ï¼å…·ä½“åŸå› ï¼Œè§ [ã€Šdubbo æºç -é›†ç¾¤å®¹é”™ä¹‹ MergeableClusterã€‹](https://www.jianshu.com/p/512e2211f84c) ï¼Œæœç´¢

"åœ¨æ¡ä»¶åˆ†æ”¯ if ( merger.startsWith(".") ) {}"
ã€‚

- ç¬¬ 77 è‡³ 97 è¡Œï¼š**æœ‰** Method ï¼Œ**å¾ªç¯**è°ƒç”¨

Method/#invoke(Object obj, Object... args)
æ–¹æ³•ï¼Œè¿›è¡Œåˆå¹¶ã€‚

- ç¬¬ 98 è‡³ 101 è¡Œï¼š**æ— ** Method ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚
- ========== ã€**ç¬¬ 2 ç§**ã€‘åŸºäº Merger åˆå¹¶ ==========
- ã€ç¬¬ **2.1** ç§ã€‘ç¬¬ 105 è‡³ 107 è¡Œï¼šå½“

merger
ä¸º

"default"
æˆ–

"true"
æ—¶ï¼Œè°ƒç”¨

MergerFactory/#getMerger(Class<T> returnType)
æ–¹æ³•ï¼Œæ ¹æ®**è¿”å›å€¼ç±»å‹**è‡ªåŠ¨åŒ¹é… Merger ã€‚

- ã€ç¬¬ **2.2** ç§ã€‘ç¬¬ 108 è‡³ 111 è¡Œï¼šè°ƒç”¨

ExtensionLoader/#getExtension(merger)
æ–¹æ³•å•Šï¼Œè·å¾—**æŒ‡å®š** Merger ã€‚

- ç¬¬ 112 è‡³ 118 è¡Œï¼š**æœ‰** Merger ï¼Œ**å¾ªç¯**è°ƒç”¨

Merger/#merge(T... items)
æ–¹æ³•ï¼Œè¿›è¡Œåˆå¹¶ã€‚

- ç¬¬ 119 è‡³ 122 è¡Œï¼š**æ— ** Method ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚
