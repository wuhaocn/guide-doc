#### **题目**：zookeeper 同步流程

#### **参考答案**：

选完 Leader 以后，zk 就进入状态同步过程。

1. Leader 等待 Follower 和 Observer 连接；

2. Follower 连接 leader，将最大的 zxid 发送给 leader；

3. Leader 根据 follower 的 zxid 确定同步点；

4. 完成同步后通知 follower 已经成为 uptodate 状态；

5. Follower 收到 uptodate 消息后，又可以重新接受 client 的请求进行服务了。

<img src="zk_sync.png" />

数据同步的 4 种方式：

1、SNAP-全量同步

- 条件：peerLastZxid<minCommittedLog
- 说明：证明二者数据差异太大，follower 数据过于陈旧，leader 发送快照 SNAP 指令给 follower 全量同步数据，即 leader 将所有数据全量同步到 follower

2、DIFF-增量同步

- 条件：minCommittedLog<=peerLastZxid<=maxCommittedLog
- 说明：证明二者数据差异不大，follower 上有一些 leader 上已经提交的提议 proposal 未同步，此时需要增量提交这些提议即可

3、TRUNC-仅回滚同步

- 条件：peerLastZxid>minCommittedLog
- 说明：证明 follower 上有些提议 proposal 并未在 leader 上提交，follower 需要回滚到 zxid 为 minCommittedLog 对应的事务操作

4、TRUNC+DIFF-回滚+增量同步

- 条件：minCommittedLog<=peerLastZxid<=maxCommittedLog
- 说明：leader a 已经将事务 truncA 提交到本地事务日志中，但没有成功发起 proposal 协议进行投票就宕机了；然后集群中剔除原 leader a 重新选举出新 leader b，又提交了若干新的提议 proposal，然后原 leader a 重新服务又加入到集群中说明：此时 a,b 都有一些对方未提交的事务，若 b 是 leader, a 需要先回滚 truncA 然后增量同步新 leader b 上的数据。
