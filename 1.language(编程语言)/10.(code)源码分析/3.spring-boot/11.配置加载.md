# é…ç½®åŠ è½½

# 1. æ¦‚è¿°

åœ¨ä½¿ç”¨ Spring Boot æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„åœ¨

application.properties
æˆ–

application.yml
é…ç½®æ–‡ä»¶ä¸­ï¼Œæ·»åŠ ç›¸åº”çš„åº”ç”¨æ‰€éœ€çš„é…ç½®ã€‚é‚£ä¹ˆï¼Œç©¶ç«Ÿ Spring Boot æ˜¯å¦‚ä½•å®ç°è¯¥åŠŸèƒ½çš„å‘¢ï¼Œä»Šå„¿æˆ‘ä»¬å°±é€šè¿‡ Spring Boot çš„æºç ï¼Œä¸€æ¢ç©¶ç«Ÿï¼
è‰¿è‰¿çš„é«˜èƒ½æç¤ºï¼šè¿™ç¯‡ä¼šéå¸¸é•¿ï¼Œå»ºè®®èƒ–å‹ä¿æŒè€å¿ƒã€‚å¦å¤–ï¼Œæœ€å¥½è¾¹è°ƒè¯•è¾¹çœ‹~

# 2. Profiles

åœ¨è®²é…ç½®åŠ è½½ä¹‹å‰ï¼Œä¸å¾—ä¸å…ˆæä¸‹ Spring Profiles åŠŸèƒ½ã€‚

* å¦‚æœä¸ç†Ÿæ‚‰çš„èƒ–å‹ï¼Œå…ˆçœ‹çœ‹ [ã€Šè¯¦è§£ Spring ä¸­çš„ Profileã€‹](https://www.jianshu.com/p/948c303b2253) æ–‡ç« ã€‚
* å…³äºè¿™ä¸€å—ï¼Œä¹‹å‰åœ¨ [ã€Šã€æ­»ç£• Springã€‘â€”â€” ç¯å¢ƒ & å±æ€§ï¼šPropertySourceã€Environmentã€Profileã€‹](http://svip.iocoder.cn/Spring/PropertySource-and-Environment-and-Profile/) ä¸­ï¼Œå·²ç»æœ‰è¯¦ç»†çš„æºç è§£æã€‚

ğŸ˜ˆ Spring Boot åœ¨ Spring Framework çš„åŸºç¡€ä¹‹ä¸Šï¼Œå¯ä»¥æ‰‹åŠ¨é™„åŠ æ–°çš„ Profile ã€‚åœ¨ [ã€Šç²¾å°½ Spring Boot æºç åˆ†æ â€”â€” SpringApplicationã€‹](http://svip.iocoder.cn/Spring-Boot/SpringApplication/) çš„

/#
ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// SpringApplication.java
//*/*
/* é™„åŠ çš„ profiles çš„æ•°ç»„
/*/
private Set<String> additionalProfiles = new HashSet<>();
protected void configureProfiles(ConfigurableEnvironment environment, String[] args){
environment.getActiveProfiles(); // ensure they are initialized ä¿è¯å·²ç»è¢«åˆå§‹åŒ–
// But these ones should go first (last wins in a property key clash)
Set<String> profiles = new LinkedHashSet<>(this.additionalProfiles);
profiles.addAll(Arrays.asList(environment.getActiveProfiles())); // <X>
// è®¾ç½® activeProfiles
environment.setActiveProfiles(StringUtils.toStringArray(profiles));
}
```

* additionalProfiles
å±æ€§ï¼Œå¯ä»¥è®¾ç½®åˆ›å»ºçš„ SpringApplication å¯ä»¥é™„åŠ çš„

additionalProfiles
å±æ€§ã€‚
* <X>
å¤„ï¼Œåœ¨åŸæœ‰ Spring Framework ä¸­è®¾ç½®çš„ String Profiles çš„åŸºç¡€ä¸Šï¼Œåˆé™„åŠ ä¸Šäº†

SpringApplication.additionalProfiles
é…ç½®çš„ã€‚
è‰¿è‰¿ï¼šè¿™ä¸ªå°èŠ‚ï¼Œè®²çš„æœ‰ç‚¹ç»•ï¼Œèƒ–å‹è¾›è‹¦ç†è§£ä¸‹~

# 3. ConfigFileApplicationListener

Spring Boot å®ç°

application.properties
æˆ–

application.yml
é…ç½®æ–‡ä»¶çš„åŠ è½½ï¼Œå…³é”®åœ¨äº ConfigFileApplicationListener ç±»ã€‚åœ¨ [ã€Šç²¾å°½ Spring Boot æºç åˆ†æ â€”â€” ApplicationListenerã€‹](http://svip.iocoder.cn/Spring-Boot/ApplicationListener/) ä¸­ï¼Œæˆ‘ä»¬å·²ç»ç®€å•ä»‹ç»è¿‡å®ƒï¼š
org.springframework.boot.context.config.ConfigFileApplicationListener
ï¼Œå®ç° SmartApplicationListenerã€Orderedã€EnvironmentPostProcessor æ¥å£ï¼Œå®ç° Spring Boot é…ç½®æ–‡ä»¶çš„åŠ è½½ã€‚

* æ³¨æ„å“Ÿï¼ŒConfigFileApplicationListener å³æ˜¯ä¸€ä¸ª SmartApplicationListener å®ç°ç±»ï¼Œåˆæ˜¯ä¸€ä¸ª EnvironmentPostProcessor å®ç°ç±»ã€‚

## 3.1 onApplicationEvent

å®ç°

/#onApplicationEvent(ApplicationEvent event)
æ–¹æ³•ï¼Œåˆ†åˆ«å¯¹ ApplicationEnvironmentPreparedEventã€ApplicationPreparedEvent äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener.java
@Override
public boolean supportsEventType(Class<? extends ApplicationEvent> eventType){
return ApplicationEnvironmentPreparedEvent.class.isAssignableFrom(eventType)
|| ApplicationPreparedEvent.class.isAssignableFrom(eventType);
}
@Override
public void onApplicationEvent(ApplicationEvent event){
// <1> å¦‚æœæ˜¯ ApplicationEnvironmentPreparedEvent äº‹ä»¶ï¼Œè¯´æ˜ Spring ç¯å¢ƒå‡†å¤‡å¥½äº†ï¼Œåˆ™æ‰§è¡Œç›¸åº”çš„å¤„ç†
if (event instanceof ApplicationEnvironmentPreparedEvent) {
onApplicationEnvironmentPreparedEvent((ApplicationEnvironmentPreparedEvent) event);
}
// <2> å¦‚æœæ˜¯ ApplicationPreparedEvent äº‹ä»¶ï¼Œè¯´æ˜ Spring å®¹å™¨åˆå§‹åŒ–å¥½äº†ï¼Œåˆ™è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚
if (event instanceof ApplicationPreparedEvent) {
onApplicationPreparedEvent(event);
}
}
```

* <1>
å¤„ï¼Œå¦‚æœæ˜¯ ApplicationEnvironmentPreparedEvent äº‹ä»¶ï¼Œè¯´æ˜ Spring ç¯å¢ƒå‡†å¤‡å¥½äº†ï¼Œåˆ™è°ƒç”¨

/#onApplicationEnvironmentPreparedEvent(ApplicationEnvironmentPreparedEvent)
æ–¹æ³•ï¼Œæ‰§è¡Œç›¸åº”çš„å¤„ç†ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ3.2 onApplicationEnvironmentPreparedEventã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ã€‚
* <2>
å¤„ï¼Œå¦‚æœæ˜¯ ApplicationPreparedEvent äº‹ä»¶ï¼Œè¯´æ˜ Spring å®¹å™¨åˆå§‹åŒ–å¥½äº†ï¼Œåˆ™è°ƒç”¨

/#onApplicationPreparedEvent(ApplicationPreparedEvent)
æ–¹æ³•ï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ3.3 onApplicationPreparedEventã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ã€‚

## 3.2 onApplicationEnvironmentPreparedEvent

/#onApplicationEnvironmentPreparedEvent(ApplicationEnvironmentPreparedEvent)
æ–¹æ³•ï¼Œå¤„ç† ApplicationEnvironmentPreparedEvent äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener.java
private void onApplicationEnvironmentPreparedEvent(ApplicationEnvironmentPreparedEvent event){
// <1.1> åŠ è½½æŒ‡å®šç±»å‹ EnvironmentPostProcessor å¯¹åº”çš„ï¼Œåœ¨ `META-INF/spring.factories` é‡Œçš„ç±»åçš„æ•°ç»„
List<EnvironmentPostProcessor> postProcessors = loadPostProcessors();
// åŠ å…¥è‡ªå·±
postProcessors.add(this);
// æ’åº postProcessors æ•°ç»„
AnnotationAwareOrderComparator.sort(postProcessors);
// éå† postProcessors æ•°ç»„ï¼Œé€ä¸ªæ‰§è¡Œã€‚
for (EnvironmentPostProcessor postProcessor : postProcessors) {
postProcessor.postProcessEnvironment(event.getEnvironment(), event.getSpringApplication());
}
}
```

* <1.1>
å¤„ï¼Œè°ƒç”¨

/#loadPostProcessors()
æ–¹æ³•ï¼ŒåŠ è½½æŒ‡å®šç±»å‹ EnvironmentPostProcessor å¯¹åº”çš„ï¼Œåœ¨

META-INF/spring.factories
é‡Œçš„ç±»åçš„æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener.java
List<EnvironmentPostProcessor> loadPostProcessors(){
return SpringFactoriesLoader.loadFactories(EnvironmentPostProcessor.class, getClass().getClassLoader());
}
```

* é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿”å›çš„æ˜¯ SystemEnvironmentPropertySourceEnvironmentPostProcessorã€SpringApplicationJsonEnvironmentPostProcessorã€CloudFoundryVcapEnvironmentPostProcessor ç±»ã€‚
* <1.2>
å¤„ï¼ŒåŠ å…¥è‡ªå·±ï¼Œåˆ°

postProcessors
æ•°ç»„ä¸­ã€‚å› ä¸ºè‡ªå·±ä¹Ÿæ˜¯ä¸€ä¸ª EnvironmentPostProcessor å®ç°ç±»ã€‚
* <2>
å¤„ï¼Œæ’åº

postProcessors
æ•°ç»„ã€‚
* <3>
å¤„ï¼Œéå†

postProcessors
æ•°ç»„ï¼Œè°ƒç”¨

EnvironmentPostProcessor/#postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application)
æ–¹æ³•ï¼Œé€ä¸ªæ‰§è¡Œã€‚

é‚£ä¹ˆï¼Œæˆ‘ä»¬å¼€å§‹æ¥é€ä¸ªçœ‹çœ‹æ¯ä¸ª EnvironmentPostProcessor å®ç°ç±»ã€‚è€ƒè™‘åˆ° EnvironmentPostProcessor åº”æœ‰çš„ç‹¬ç«‹æ€§ï¼ˆå°Šä¸¥!ï¼‰ï¼Œæˆ‘ä»¬å•ç‹¬å¼€äº† [ã€Œ4. EnvironmentPostProcessorã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) å°èŠ‚ï¼Œæ‰€ä»¥èƒ–å‹å…ˆä¸€èµ·è·³è¿‡æ¥çœ‹çœ‹ã€‚
è‰¿è‰¿ï¼šè¿™å—æ¶‰åŠçš„é€»è¾‘éå¸¸å¤šã€‚æœ¬æ–‡çš„ 4ã€5ã€6ã€7 å°èŠ‚ï¼Œéƒ½å’Œ [ã€Œ3.2 onApplicationEnvironmentPreparedEventã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) æœ‰å…³ã€‚

## 3.3 onApplicationPreparedEvent

/#onApplicationPreparedEvent(ApplicationEvent event)
æ–¹æ³•ï¼Œå¤„ç† ApplicationPreparedEvent äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener.java
private void onApplicationPreparedEvent(ApplicationEvent event){
// ä¿®æ”¹ logger æ–‡ä»¶ï¼Œæš‚æ—¶å¯ä»¥æ— è§†ã€‚
this.logger.switchTo(ConfigFileApplicationListener.class);
// æ·»åŠ  PropertySourceOrderingPostProcessor å¤„ç†å™¨
addPostProcessors(((ApplicationPreparedEvent) event).getApplicationContext());
}
protected void addPostProcessors(ConfigurableApplicationContext context){
context.addBeanFactoryPostProcessor(new PropertySourceOrderingPostProcessor(context));
}
```

* æ·»åŠ  PropertySourceOrderingPostProcessor å¤„ç†å™¨ã€‚å…³äº PropertySourceOrderingPostProcessor ç±»ï¼Œè§ [ã€Œ3.3.1 PropertySourceOrderingPostProcessorã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ä¸­ã€‚

### 3.3.1 PropertySourceOrderingPostProcessor

PropertySourceOrderingPostProcessor ï¼Œæ˜¯ ConfigFileApplicationListener å†…éƒ¨ç±»ï¼Œå®ç° BeanFactoryPostProcessorã€Ordered æ¥å£ï¼Œå°†

DEFAULT_PROPERTIES
çš„ PropertySource å±æ€§æºï¼Œæ·»åŠ åˆ°

environment
çš„å°¾éƒ¨ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener.java
private static final String DEFAULT_PROPERTIES = "defaultProperties";
// ConfigFileApplicationListener/#PropertySourceOrderingPostProcessor.java
private class PropertySourceOrderingPostProcessor implements BeanFactoryPostProcessor, Ordered{
private ConfigurableApplicationContext context;
PropertySourceOrderingPostProcessor(ConfigurableApplicationContext context) {
this.context = context;
}
@Override
public int getOrder(){
return Ordered.HIGHEST_PRECEDENCE;
}
@Override
public void postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory) throws BeansException{
reorderSources(this.context.getEnvironment());
}
private void reorderSources(ConfigurableEnvironment environment){
// ç§»é™¤ DEFAULT_PROPERTIES çš„å±æ€§æº
PropertySource<?> defaultProperties = environment.getPropertySources().remove(DEFAULT_PROPERTIES);
// æ·»åŠ åˆ° environment å°¾éƒ¨
if (defaultProperties != null) {
environment.getPropertySources().addLast(defaultProperties);
}
}
}
```

* é‚£ä¹ˆ

DEFAULT_PROPERTIES
å¯¹åº”çš„ PropertySource å±æ€§æºï¼Œç©¶ç«Ÿæ˜¯å“ªé‡Œæ¥çš„å‘¢ï¼Ÿç­”æ¡ˆè§

SpringApplication.defaultProperties
ç›¸å…³ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
// SpringApplication.java
//*/*
/* é»˜è®¤çš„å±æ€§é›†åˆ
/*/
private Map<String, Object> defaultProperties;
protected void configurePropertySources(ConfigurableEnvironment environment, String[] args){
MutablePropertySources sources = environment.getPropertySources();
// é…ç½®çš„ defaultProperties
if (this.defaultProperties != null && !this.defaultProperties.isEmpty()) {
sources.addLast(new MapPropertySource("defaultProperties", this.defaultProperties));
}
// ... çœç•¥æ— å…³ä»£ç 
}
```

# 4. EnvironmentPostProcessor

org.springframework.boot.context.config.EnvironmentPostProcessor
æ¥å£ï¼Œåœ¨ Environment åŠ è½½å®Œæˆä¹‹åï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œä¸€äº›é…ç½®ã€å¢åŠ ä¸€äº›è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆè¯·ä½¿ç”¨ EnvironmentPostProcessor ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// EnvironmentPostProcessor.java
//*/*
/* Allows for customization of the application's {@link Environment} prior to the
/* application context being refreshed.
/* <p>
/* EnvironmentPostProcessor implementations have to be registered in
/* {@code META-INF/spring.factories}, using the fully qualified name of this class as the
/* key.
/* <p>
/* {@code EnvironmentPostProcessor} processors are encouraged to detect whether Spring's
/* {@link org.springframework.core.Ordered Ordered} interface has been implemented or if
/* the {@link org.springframework.core.annotation.Order @Order} annotation is present and
/* to sort instances accordingly if so prior to invocation.
/*
/* @author Andy Wilkinson
/* @author Stephane Nicoll
/* @since 1.3.0
/*/
@FunctionalInterface
public interface EnvironmentPostProcessor{
//*/*
/* Post-process the given {@code environment}.
/* @param environment the environment to post-process
/* @param application the application to which the environment belongs
/*/
void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application);
}
```

ä»å®ç°ä¸Šå’Œä½œç”¨ä¸Šæ¥è¯´ï¼Œå’Œ [ã€Šã€æ­»ç£• Springã€‘â€”â€” IoC ä¹‹æ·±å…¥åˆ†æ BeanPostProcessorã€‹](http://svip.iocoder.cn/Spring/IoC-BeanPostProcessor/) éƒ½æ˜¯éå¸¸ç±»ä¼¼çš„ã€‚

EnvironmentPostProcessor çš„å®ç°ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![EnvironmentPostProcessor å®ç°ç±»](http://static2.iocoder.cn/images/Spring-Boot/2021-01-28/01.jpg)

## 4.1 CloudFoundryVcapEnvironmentPostProcessor

org.springframework.boot.cloud.CloudFoundryVcapEnvironmentPostProcessor
ï¼Œå®ç° EnvironmentPostProcessorã€Ordered æ¥å£ï¼Œå®ç°å¯¹ [Cloud Foundry](https://www.cloudfoundry.org/) çš„æ”¯æŒã€‚å› ä¸ºæˆ‘ä»¬ä¸ä½¿ç”¨ Cloud Foundry ï¼Œæ‰€ä»¥å¯ä»¥è·³è¿‡å¯¹ CloudFoundryVcapEnvironmentPostProcessor æºç çš„äº†è§£ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥ç»“åˆ [ã€ŠSpring Boot å‚è€ƒæŒ‡å—ï¼ˆéƒ¨ç½²åˆ°äº‘ï¼‰ã€‹](https://segmentfault.com/a/1190000015088555) æ–‡ç« ï¼Œå¯¹æºç è¿›è¡Œç ”ç©¶ã€‚

## 4.2 SystemEnvironmentPropertySourceEnvironmentPostProcessor

è‰¿è‰¿ï¼šé€‰çœ‹~

org.springframework.boot.env.SystemEnvironmentPropertySourceEnvironmentPostProcessor
ï¼Œå®ç° EnvironmentPostProcessorã€Ordered æ¥å£ï¼Œå®ç°å°†

environment
ä¸­çš„

systemEnvironment
å¯¹åº”çš„ PropertySource å±æ€§æºå¯¹è±¡ï¼Œæ›¿æ¢æˆ OriginAwareSystemEnvironmentPropertySource å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// SystemEnvironmentPropertySourceEnvironmentPostProcessor.java
@Override
public void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application){
// <1> è·å¾— systemEnvironment å¯¹åº”çš„ PropertySource å±æ€§æº
String sourceName = StandardEnvironment.SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME;
PropertySource<?> propertySource = environment.getPropertySources().get(sourceName);
// <2> å°†åŸå§‹çš„ PropertySource å¯¹è±¡ï¼Œæ›¿æ¢æˆ OriginAwareSystemEnvironmentPropertySource å¯¹è±¡
if (propertySource != null) {
replacePropertySource(environment, sourceName, propertySource);
}
}
@SuppressWarnings("unchecked")
private void replacePropertySource(ConfigurableEnvironment environment, String sourceName, PropertySource<?> propertySource){
Map<String, Object> originalSource = (Map<String, Object>) propertySource.getSource();
// åˆ›å»º SystemEnvironmentPropertySource å¯¹è±¡
SystemEnvironmentPropertySource source = new OriginAwareSystemEnvironmentPropertySource(sourceName, originalSource);
// è¿›è¡Œæ›¿æ¢
environment.getPropertySources().replace(sourceName, source);
}
```

* <1>
å¤„ï¼Œè·å¾—

systemEnvironment
å¯¹åº”çš„ PropertySource å±æ€§æºã€‚
* <2>
å¤„ï¼Œè°ƒç”¨

/#replacePropertySource(...)
æ–¹æ³•ï¼Œå°†åŸå§‹çš„ PropertySource å¯¹è±¡ï¼Œæ›¿æ¢æˆ OriginAwareSystemEnvironmentPropertySource å¯¹è±¡ã€‚
* å…¶ä¸­ï¼ŒOriginAwareSystemEnvironmentPropertySource æ˜¯ SystemEnvironmentPropertySourceEnvironmentPostProcessor å†…éƒ¨ç±»ï¼Œç»§æ‰¿ SystemEnvironmentPropertySource ç±»ï¼Œå®ç° OriginLookup æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
// SystemEnvironmentPropertySourceEnvironmentPostProcessor/#OriginAwareSystemEnvironmentPropertySource.java
protected static class OriginAwareSystemEnvironmentPropertySource
extends SystemEnvironmentPropertySource implements OriginLookup<String>{
OriginAwareSystemEnvironmentPropertySource(String name, Map<String, Object> source) {
super(name, source);
}
@Override
public Origin getOrigin(String key){
// è§£æ key å¯¹åº”çš„ property
String property = resolvePropertyName(key);
// åˆ¤æ–­æ˜¯å¦å­˜åœ¨ property å¯¹åº”çš„å€¼ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™è¿”å› SystemEnvironmentOrigin å¯¹è±¡
if (super.containsProperty(property)) {
return new SystemEnvironmentOrigin(property);
}
// ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› null
return null;
}
}
```

* é‡å¿ƒæ˜¯å¯¹ [
org.springframework.boot.origin.OriginLookup
](https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/origin/OriginLookup.java) æ¥å£çš„

/#getOrigin(String key)
æ–¹æ³•çš„å®ç°ï¼Œå®ç°æŸ¥æ‰¾

key
å¯¹åº”çš„çœŸæ­£çš„

property
ã€‚éš¾é“ä¸¤è€…è¿˜ä¼šä¸åŒï¼Œç­”æ¡ˆæ˜¯çš„ã€‚ä¾‹å¦‚è¯´ï¼šä¼ å…¥çš„

key=foo.bar.baz
ï¼Œè¿”å›çš„æ˜¯

property=FOO_BAR_BAZ
ã€‚
* ç­”æ¡ˆè§

SystemEnvironmentPropertySource/#checkPropertyName(String name)
æ–¹æ³•ï¼Œå†…éƒ¨ä¼šè¿›è¡Œå„ç§çµæ´»çš„æ›¿æ¢â€œæŸ¥æ‰¾â€ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// SystemEnvironmentPropertySource.java
@Nullable
private String checkPropertyName(String name){
// Check name as-is
if (containsKey(name)) {
return name;
}
// Check name with just dots replaced
String noDotName = name.replace('.', '_');
if (!name.equals(noDotName) && containsKey(noDotName)) {
return noDotName;
}
// Check name with just hyphens replaced
String noHyphenName = name.replace('-', '_');
if (!name.equals(noHyphenName) && containsKey(noHyphenName)) {
return noHyphenName;
}
// Check name with dots and hyphens replaced
String noDotNoHyphenName = noDotName.replace('-', '_');
if (!noDotName.equals(noDotNoHyphenName) && containsKey(noDotNoHyphenName)) {
return noDotNoHyphenName;
}
// Give up
return null;
}
```

* å„ç§ç¬¦å·ï¼Œè½¬æˆ

_
æ¥æŸ¥æ‰¾å¯¹åº”çš„å±æ€§ã€‚

ğŸ˜ˆ é‚£ä¹ˆå…·ä½“æœ‰ä»€ä¹ˆæ ·çš„é€»è¾‘ä¸Šçš„éœ€è¦å‘¢ï¼Ÿæš‚æ—¶è¿˜æ²¡æ€ä¹ˆçœ‹åˆ°ï¼Œå˜¿å˜¿ã€‚æ‰€ä»¥ï¼ŒçŸ¥é“å°±å¥½ï¼Œæš‚æ—¶å…ˆä¸å»æ·±ç©¶ã€‚

## 4.3 SpringApplicationJsonEnvironmentPostProcessor

è‰¿è‰¿ï¼šé€‰çœ‹~

org.springframework.boot.env.SpringApplicationJsonEnvironmentPostProcessor
ï¼Œå®ç° EnvironmentPostProcessorã€Ordered æ¥å£ï¼Œè§£æ

environment
ä¸­çš„

spring.application.json
æˆ–

SPRING_APPLICATION_JSON
å¯¹åº”çš„ JSON æ ¼å¼çš„å±æ€§å€¼ï¼Œåˆ›å»ºæ–°çš„ PropertySource å¯¹è±¡ï¼Œæ·»åŠ åˆ°å…¶ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// SpringApplicationJsonEnvironmentPostProcessor.java
//*/*
/* é»˜è®¤çš„ {@link /#order} çš„å€¼
/*
/* The default order for the processor.
/*/
public static final int DEFAULT_ORDER = Ordered.HIGHEST_PRECEDENCE + 5;
//*/*
/* é¡ºåº
/*/
private int order = DEFAULT_ORDER;
@Override
public void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application){
MutablePropertySources propertySources = environment.getPropertySources();
propertySources.stream().map(JsonPropertyValue::get).filter(Objects::nonNull)
.findFirst().ifPresent((v) -> processJson(environment, v));
}
```

* map(JsonPropertyValue::get).filter(Objects::nonNull)
ä»£ç æ®µï¼Œè°ƒç”¨

JsonPropertyValue/#get(PropertySource<?> propertySource)
æ–¹æ³•ï¼Œ

environment
ä¸­çš„

spring.application.json
æˆ–

SPRING_APPLICATION_JSON
å¯¹åº”çš„ JSON æ ¼å¼çš„å±æ€§å€¼ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// SpringApplicationJsonEnvironmentPostProcessor.java
public static final String SPRING_APPLICATION_JSON_PROPERTY = "spring.application.json";
public static final String SPRING_APPLICATION_JSON_ENVIRONMENT_VARIABLE = "SPRING_APPLICATION_JSON";
private static class JsonPropertyValue{
private static final String[] CANDIDATES = { SPRING_APPLICATION_JSON_PROPERTY, SPRING_APPLICATION_JSON_ENVIRONMENT_VARIABLE };
private final PropertySource<?> propertySource;
private final String propertyName;
private final String json;
JsonPropertyValue(PropertySource<?> propertySource, String propertyName, String json) {
this.propertySource = propertySource;
this.propertyName = propertyName;
this.json = json;
}
public String getJson(){
return this.json;
}
public Origin getOrigin(){
return PropertySourceOrigin.get(this.propertySource, this.propertyName);
}
public static JsonPropertyValue get(PropertySource<?> propertySource){
// éå† CANDIDATES æ•°ç»„
for (String candidate : CANDIDATES) {
// è·å¾— candidate å¯¹åº”çš„å±æ€§å€¼
Object value = propertySource.getProperty(candidate);
if (value instanceof String
&& StringUtils.hasLength((String) value)) {
// åˆ›å»º JsonPropertyValue å¯¹è±¡ï¼Œç„¶åè¿”å›
return new JsonPropertyValue(propertySource, candidate, (String) value);
}
}
return null;
}
}
```

* æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹çœ‹ä¸‹å°±æ˜ç™½åˆ—ã€‚
* è°ƒç”¨

/#processJson(ConfigurableEnvironment environment, JsonPropertyValue propertyValue)
æ–¹æ³•ï¼Œæ‰§è¡Œå¤„ç† JSON å­—ç¬¦ä¸²ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ4.3.1 processJsonã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ã€‚

### 4.3.1 processJson

/#processJson(ConfigurableEnvironment environment, JsonPropertyValue propertyValue)
æ–¹æ³•ï¼Œæ‰§è¡Œå¤„ç† JSON å­—ç¬¦ä¸²ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// SpringApplicationJsonEnvironmentPostProcessor.java
private void processJson(ConfigurableEnvironment environment, JsonPropertyValue propertyValue){
// <1> è§£æ json å­—ç¬¦ä¸²ï¼Œæˆ Map å¯¹è±¡
JsonParser parser = JsonParserFactory.getJsonParser();
Map<String, Object> map = parser.parseMap(propertyValue.getJson());
// <2> åˆ›å»º JsonPropertySource å¯¹è±¡ï¼Œæ·»åŠ åˆ° environment ä¸­
if (!map.isEmpty()) {
// <2.2>
addJsonPropertySource(environment, new JsonPropertySource(propertyValue, flatten(map))); // <2.1>
}
}
```

* <1>
å¤„ï¼Œè§£æ json å­—ç¬¦ä¸²ï¼Œæˆ Map å¯¹è±¡ã€‚
* <2>
å¤„ï¼Œåˆ›å»º JsonPropertySource å¯¹è±¡ï¼Œæ·»åŠ åˆ°

environment
ä¸­ã€‚å…¶ä¸­ï¼ŒJsonPropertySource ç»§æ‰¿ MapPropertySource ç±»ï¼Œå®ç° OriginLookup æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
// SpringApplicationJsonEnvironmentPostProcessor/#JsonPropertySource.java
private static class JsonPropertySource extends MapPropertySource
implements OriginLookup<String>{
private final JsonPropertyValue propertyValue;
JsonPropertySource(JsonPropertyValue propertyValue, Map<String, Object> source) {
super(SPRING_APPLICATION_JSON_PROPERTY, source);
this.propertyValue = propertyValue;
}
@Override
public Origin getOrigin(String key){
return this.propertyValue.getOrigin();
}
}
```

* ä½¿ç”¨çš„

name
ä¸º

SPRING_APPLICATION_JSON_PROPERTY=spring.application.json
ã€‚
* <2.1>
å¤„ï¼Œè°ƒç”¨

/#flatten(String prefix, Map<String, Object> result, Map<String, Object> map)
æ–¹æ³•ï¼Œå°† JSON è§£æåçš„ Map å¯èƒ½å­˜åœ¨çš„å†…åµŒçš„ Map å¯¹è±¡ï¼Œè½¬æ¢æˆå¤šæ¡ KV æ ¼å¼çš„é…ç½®å¯¹ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// SpringApplicationJsonEnvironmentPostProcessor.java
private Map<String, Object> flatten(Map<String, Object> map){
Map<String, Object> result = new LinkedHashMap<>();
flatten(null, result, map);
return result;
}
private void flatten(String prefix, Map<String, Object> result, Map<String, Object> map){
String namePrefix = (prefix != null) ? prefix + "." : "";
map.forEach((key, value) -> extract(namePrefix + key, result, value));
}
@SuppressWarnings("unchecked")
private void extract(String name, Map<String, Object> result, Object value){
if (value instanceof Map) { // å†…åµŒçš„ Map æ ¼å¼
flatten(name, result, (Map<String, Object>) value);
} else if (value instanceof Collection) { // å†…åµŒçš„ Collection
int index = 0;
for (Object object : (Collection<Object>) value) {
extract(name + "[" + index + "]", result, object);
index++;
}
} else { // æ™®é€šæ ¼å¼ï¼Œæ·»åŠ åˆ° result ä¸­
result.put(name, value);
}
}
```
* <2.2>
å¤„ï¼Œè°ƒç”¨

/#addJsonPropertySource(ConfigurableEnvironment environment, PropertySource<?> source)
æ–¹æ³•ï¼Œæ·»åŠ åˆ°

environment
ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// SpringApplicationJsonEnvironmentPostProcessor.java
private void addJsonPropertySource(ConfigurableEnvironment environment, PropertySource<?> source){
MutablePropertySources sources = environment.getPropertySources();
// è·å¾—éœ€è¦æ·»åŠ åˆ° source æ‰€åœ¨çš„ PropertySource ä¹‹å‰çš„åå­—
String name = findPropertySource(sources);
// æ·»åŠ åˆ° environment çš„ sources ä¸­ã€‚
// è¿™ä¹ˆåšçš„æ•ˆæœæ˜¯ï¼Œsource é«˜äº SYSTEM_PROPERTIES_PROPERTY_SOURCE_NAME && JNDI_PROPERTY_SOURCE_NAME ä¹‹å‰
if (sources.contains(name)) {
sources.addBefore(name, source);
} else {
sources.addFirst(source);
}
}
private String findPropertySource(MutablePropertySources sources){
// åœ¨ Servlet ç¯å¢ƒä¸‹ï¼Œä¸”æœ‰ JNDI_PROPERTY_SOURCE_NAME å±æ€§ï¼Œåˆ™è¿”å› StandardServletEnvironment.JNDI_PROPERTY_SOURCE_NAME
if (ClassUtils.isPresent(SERVLET_ENVIRONMENT_CLASS, null)
&& sources.contains(StandardServletEnvironment.JNDI_PROPERTY_SOURCE_NAME)) {
return StandardServletEnvironment.JNDI_PROPERTY_SOURCE_NAME;
}
// å¦åˆ™ï¼Œè¿”å› SYSTEM_PROPERTIES_PROPERTY_SOURCE_NAME å±æ€§
return StandardEnvironment.SYSTEM_PROPERTIES_PROPERTY_SOURCE_NAME;
}
```

ğŸ˜ˆ å½“ç„¶ï¼Œå› ä¸ºç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šå»ä½¿ç”¨

spring.application.json
æˆ–

SPRING_APPLICATION_JSON
å»è¿›è¡Œé…ç½®ã€‚æ‰€ä»¥å‘¢ï¼Œè¿™å—é€»è¾‘ç­‰èƒ–å‹çœŸçš„æœ‰éœ€è¦ï¼Œå†æ¥ç…ç…è½ã€‚

## 4.4 ConfigFileApplicationListener

è‰¿è‰¿ï¼šçœŸæ­£çš„é‡å¤´æˆ~

å®ç°

/#addPropertySources(ConfigurableEnvironment environment,ResourceLoader resourceLoader)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
// ConfigFileApplicationListener.java
protected void addPropertySources(ConfigurableEnvironment environment,ResourceLoader resourceLoader){
// <1> æ·»åŠ  RandomValuePropertySource åˆ° environment ä¸­
RandomValuePropertySource.addToEnvironment(environment);
// <2> åˆ›å»º Loader å¯¹è±¡ï¼Œè¿›è¡ŒåŠ è½½
new Loader(environment, resourceLoader).load();
}
```

* <1>
å¤„ï¼Œæ·»åŠ  RandomValuePropertySource åˆ°

environment
ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ5. RandomValuePropertySourceã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ä¸­ã€‚
* <2>
å¤„ï¼Œåˆ›å»º Loader å¯¹è±¡ï¼Œå¹¶è°ƒç”¨

Loader/#load()
æ–¹æ³•ï¼Œè¿›è¡ŒåŠ è½½ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ4.4.1 Loaderã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ä¸­ã€‚

### 4.4.1 Loader

è‰¿è‰¿ï¼šé«˜èƒ½é¢„è­¦ï¼Œå…³äºè¿™ä¸€å—ï¼Œå†…å®¹ä¼šæ¯”è¾ƒæ‰å®ï¼ˆå¾ˆå¤šï¼‰ï¼

Loader æ˜¯ ConfigFileApplicationListener çš„å†…éƒ¨ç±»ï¼Œè´Ÿè´£åŠ è½½æŒ‡å®šçš„é…ç½®æ–‡ä»¶ã€‚æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š

```
// ConfigFileApplicationListener.java
private class Loader{
private final Log logger = ConfigFileApplicationListener.this.logger;
private final ConfigurableEnvironment environment;
private final PropertySourcesPlaceholdersResolver placeholdersResolver;
private final ResourceLoader resourceLoader;
private final List<PropertySourceLoader> propertySourceLoaders;
private Deque<Profile> profiles;
private List<Profile> processedProfiles;
private boolean activatedProfiles;
private Map<Profile, MutablePropertySources> loaded;
private Map<DocumentsCacheKey, List<Document>> loadDocumentsCache = new HashMap<>();
Loader(ConfigurableEnvironment environment, ResourceLoader resourceLoader) {
this.environment = environment;
// <1> åˆ›å»º PropertySourcesPlaceholdersResolver å¯¹è±¡
this.placeholdersResolver = new PropertySourcesPlaceholdersResolver(this.environment);
// <2> åˆ›å»º DefaultResourceLoader å¯¹è±¡
this.resourceLoader = (resourceLoader != null) ? resourceLoader : new DefaultResourceLoader();
// <3> åŠ è½½æŒ‡å®šç±»å‹ PropertySourceLoader å¯¹åº”çš„ï¼Œåœ¨ `META-INF/spring.factories` é‡Œçš„ç±»åçš„æ•°ç»„
this.propertySourceLoaders = SpringFactoriesLoader.loadFactories(PropertySourceLoader.class, getClass().getClassLoader());
}
// ... çœç•¥å…¶å®ƒæ–¹æ³•
}
```

* <1>
å¤„ï¼Œåˆ›å»º PropertySourcesPlaceholdersResolver å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œèƒ–å‹å¯ä»¥è·³åˆ° [ã€Œ6. PropertySourcesPlaceholdersResolverã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ä¸­ï¼Œç…ä¸€çœ¼ï¼Œç„¶åç»§ç»­å›åˆ°æ­¤å¤„ã€‚
* <2>
å¤„ï¼Œåˆ›å»º DefaultResourceLoader å¯¹è±¡ã€‚è¿™ä¸ªæ˜¯ Spring Framework ä¸­çš„ç±»ï¼Œç”¨äºèµ„æºçš„åŠ è½½ã€‚å½“ç„¶ï¼Œè¿™ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œæš‚æ—¶å…ˆå¿½ç•¥ã€‚
* <3>
å¤„ï¼ŒåŠ è½½æŒ‡å®šç±»å‹ PropertySourceLoader å¯¹åº”çš„ï¼Œåœ¨

META-INF/spring.factories
é‡Œçš„ç±»åçš„æ•°ç»„ã€‚

* é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿”å›çš„æ˜¯ PropertiesPropertySourceLoaderã€YamlPropertySourceLoader ç±»ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ7. PropertySourceLoaderã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ã€‚

### 4.4.1.1 load

/#load()
æ–¹æ³•ï¼ŒåŠ è½½é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#Loader.java
public void load(){
// <1> åˆå§‹åŒ–å˜é‡
this.profiles = new LinkedList<>(); // æœªå¤„ç†çš„ Profile é›†åˆ
this.processedProfiles = new LinkedList<>(); // å·²å¤„ç†çš„ Profile é›†åˆ
this.activatedProfiles = false;
this.loaded = new LinkedHashMap<>();
// <2> åˆå§‹åŒ– Spring Profiles ç›¸å…³
initializeProfiles();
// <3> éå† profiles æ•°ç»„
while (!this.profiles.isEmpty()) {
// è·å¾— Profile å¯¹è±¡
Profile profile = this.profiles.poll();
// <3.1> æ·»åŠ  Profile åˆ° environment ä¸­
if (profile != null && !profile.isDefaultProfile()) {
addProfileToEnvironment(profile.getName());
}
// <3.2> åŠ è½½é…ç½®
load(profile, this::getPositiveProfileFilter,
addToLoaded(MutablePropertySources::addLast, false));
// <3.3> æ·»åŠ åˆ° processedProfiles ä¸­ï¼Œè¡¨ç¤ºå·²å¤„ç†
this.processedProfiles.add(profile);
}
// <4> è·å¾—çœŸæ­£åŠ è½½çš„ Profile ä»¬ï¼Œæ·»åŠ åˆ° environment ä¸­ã€‚
resetEnvironmentProfiles(this.processedProfiles);
// <5> åŠ è½½é…ç½®
load(null, this::getNegativeProfileFilter,
addToLoaded(MutablePropertySources::addFirst, true));
// <6> å°†åŠ è½½çš„é…ç½®å¯¹åº”çš„ MutablePropertySources åˆ° environment ä¸­
addLoadedPropertySources();
}
```

* <1>
å¤„ï¼Œåˆå§‹åŒ–å˜é‡ã€‚æ¯ä¸ªå˜é‡çš„æ„æ€ï¼Œçœ‹ä»£ç ä¸­çš„æ³¨é‡Šã€‚
* <2>
å¤„ï¼Œåˆå§‹åŒ– Spring Profiles ç›¸å…³ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ4.4.1.1 initializeProfilesã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ä¸­ã€‚èƒ–å‹å¯ä»¥å…ˆè·³è¿‡å»çœ‹ä¸€çœ¼ï¼Œç„¶åå›æ¥ã€‚
* <3>
å¤„ï¼Œéå†

profiles
æ•°ç»„ï¼Œé€ä¸ªåŠ è½½å¯¹åº”çš„é…ç½®æ–‡ä»¶ã€‚

* <3.1>
å¤„ï¼Œè°ƒç”¨

/#addProfileToEnvironment(String profile)
æ–¹æ³•ï¼Œæ·»åŠ åˆ°

environment.activeProfiles
ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#Loader.java
private void addProfileToEnvironment(String profile){
// å¦‚æœå·²ç»åœ¨ activeProfiles ä¸­ï¼Œåˆ™è¿”å›
for (String activeProfile : this.environment.getActiveProfiles()) {
if (activeProfile.equals(profile)) {
return;
}
}
// å¦‚æœä¸åœ¨ï¼Œåˆ™æ·»åŠ åˆ° environment ä¸­
this.environment.addActiveProfile(profile);
}
```

* ~
* <3.2>
å¤„ï¼Œè°ƒç”¨

/#load(Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)
æ–¹æ³•ï¼ŒåŠ è½½é…ç½®ã€‚è¿™å—ä¼šæ¯”è¾ƒå¤æ‚ï¼Œæ™šç‚¹å†æ±‚çœ‹ [ã€Œ4.4.1.1.2 loadã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ã€‚
* <3.3>
å¤„ï¼Œæ·»åŠ åˆ°

processedProfiles
ä¸­ï¼Œè¡¨ç¤ºå·²å¤„ç†ã€‚
* <4>
å¤„ï¼Œè°ƒç”¨

/#resetEnvironmentProfiles(List<Profile> processedProfiles)
æ–¹æ³•ï¼Œè·å¾—çœŸæ­£åŠ è½½çš„ Profile ä»¬ï¼Œæ·»åŠ åˆ° environment ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#Loader.java
private void resetEnvironmentProfiles(List<Profile> processedProfiles){
// è·å¾—çœŸæ­£åŠ è½½çš„ Profile ä»¬ï¼Œæ·»åŠ åˆ° environment ä¸­ã€‚
String[] names = processedProfiles.stream()
.filter((profile) -> profile != null && !profile.isDefaultProfile())
.map(Profile::getName).toArray(String[]::new);
this.environment.setActiveProfiles(names);
}
```

* å› ä¸ºæ¯ä¸ª Profile å¯èƒ½ä¸å­˜åœ¨å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œåªæœ‰çœŸæ­£åŠ è½½åˆ°é…ç½®æ–‡ä»¶çš„ Profile ä»¬ï¼Œæ‰ä¼šè®¾ç½®åˆ°

environment.activeProfiles
å±æ€§ä¸­ã€‚
* <5>
å¤„ï¼Œè°ƒç”¨

/#load(Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)
æ–¹æ³•ï¼ŒåŠ è½½é…ç½®ã€‚è¿™å—ä¼šæ¯”è¾ƒå¤æ‚ï¼Œæ™šç‚¹å†æ±‚çœ‹ [ã€Œ4.4.1.1.2 loadã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ã€‚

* å’Œ

<3.2>
å¤„ï¼Œæœ‰ä¸€äº›ä¸åŒï¼Œä¸»è¦å·®åˆ«åœ¨äºä¼ å…¥çš„æ–¹æ³•å‚æ•°ã€‚
* åœ¨è¡¥å……ä¸€ç‚¹ï¼Œæœ‰ç‚¹ä¸é€ æ€ä¹ˆè§£é‡Šäº†ã€‚ğŸ˜ˆ

<5>
å¤„çš„ä½œç”¨æ˜¯ï¼Œå°†

profile=null
çš„æƒ…å†µä¸­ï¼Œå°†é…ç½®æ–‡ä»¶é‡Œæœ‰é…ç½®æ–‡ä»¶

spring.profiles
å†…å®¹ï¼Œä¸”å±äºåŸºäºçš„ Profile ï¼Œä¹Ÿæ·»åŠ åˆ°

profile=null
åœ¨

Loader.loaded
çš„æ˜ å°„ä¸­ã€‚å…·ä½“çš„ï¼Œå¯ä»¥çœ‹ [ã€Œ666. å½©è›‹ã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) æä¾›çš„ç¤ºä¾‹ã€‚ğŸ˜ˆ çœŸçš„æ˜¯ï¼Œå¥½ç»•å•Šï¼ï¼ï¼ï¼
* <6>
å¤„ï¼Œè°ƒç”¨

/#addLoadedPropertySources()
æ–¹æ³•ï¼Œå°†åŠ è½½çš„é…ç½®å¯¹åº”çš„ MutablePropertySources åˆ°

environment
ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener.java
private static final String DEFAULT_PROPERTIES = "defaultProperties";
// ConfigFileApplicationListener/#Loader.java
private void addLoadedPropertySources(){
MutablePropertySources destination = this.environment.getPropertySources();
// è·å¾—å½“å‰åŠ è½½çš„ MutablePropertySources é›†åˆ
List<MutablePropertySources> loaded = new ArrayList<>(this.loaded.values());
Collections.reverse(loaded); // <Z>
// å£°æ˜å˜é‡
String lastAdded = null; // ä¸‹é¢å¾ªç¯ï¼Œæœ€åæ‰¾åˆ°çš„ MutablePropertySources çš„åå­—
Set<String> added = new HashSet<>(); // å·²æ·»åŠ åˆ° destination ä¸­çš„ MutablePropertySources çš„åå­—çš„é›†åˆ
// <X> éå† loaded æ•°ç»„
for (MutablePropertySources sources : loaded) {
// <Y> éå† sources æ•°ç»„
for (PropertySource<?> source : sources) {
// æ·»åŠ åˆ° destination ä¸­
if (added.add(source.getName())) {
addLoadedPropertySource(destination, lastAdded, source);
lastAdded = source.getName();
}
}
}
}
private void addLoadedPropertySource(MutablePropertySources destination, String lastAdded, PropertySource<?> source){
if (lastAdded == null) {
if (destination.contains(DEFAULT_PROPERTIES)) {
destination.addBefore(DEFAULT_PROPERTIES, source);
} else {
destination.addLast(source);
}
} else {
destination.addAfter(lastAdded, source);
}
}
```

* <X>
å’Œ

<Y>
å¤„ï¼Œä¸ºä»€ä¹ˆæ˜¯ä¸¤å±‚éå†å‘¢ï¼Ÿå› ä¸ºä¸€ä¸ª Profile å¯ä»¥å¯¹åº”å¤šä¸ªé…ç½®æ–‡ä»¶ã€‚ä¾‹å¦‚è¯´ï¼ŒProfile ä¸º

prod
ï¼Œå¯¹åº”

applicaion-prod.properties
å’Œ

application-prod.yml
ä¸¤ä¸ªé…ç½®æ–‡ä»¶ã€‚
* è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»

environment
ä¸­ï¼Œè¯»å–åŠ è½½åˆ°çš„é…ç½®æ–‡ä»¶ã€‚
* <Z>
å¤„ï¼Œä¸ºä»€ä¹ˆè¦åè½¬ä¸€ä¸‹å‘¢ï¼Ÿå› ä¸ºï¼Œé…ç½®åœ¨è¶Šåé¢çš„ Profile ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œåè½¬ã€‚ä¸¾ä¸ªä¾‹å­

spring.profiles.active=prod,dev
ï¼Œé‚£ä¹ˆ Profile çš„ä¼˜å…ˆçº§æ˜¯

dev > prod > null
ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·³åˆ° [ã€Œ4.4.1.1.2 loadã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) å°èŠ‚ï¼Œçœ‹çœ‹è¿™ä¸ªå…³é”®çš„é€»è¾‘ã€‚
è‰¿è‰¿ï¼šé€»è¾‘çœŸçš„æœ‰ç‚¹å¤æ‚ï¼ç›®çš„ç®€å•ï¼Œè¿‡ç¨‹ä¸­çš„é€»è¾‘ç»†èŠ‚æ¯”è¾ƒå¤šã€‚å’Œæˆ‘ä¸€èµ·ï¼Œä¿æŒè€å¿ƒï¼ï¼ï¼

### 4.4.1.1.1 initializeProfiles

åœ¨

/#initializeProfiles()
æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ Profile ç±»ã€‚å®ƒæ˜¯ ConfigFileApplicationListener çš„å†…éƒ¨ç±»ï¼Œæ˜¯ Spring Profiles çš„å°è£…å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#Profile.java
//*/*
/* A Spring Profile that can be loaded.
/*/
private static class Profile{
//*/*
/* Profile åå­—
/*/
private final String name;
//*/*
/* æ˜¯å¦ä¸ºé»˜è®¤çš„ Profile
/*/
private final boolean defaultProfile;
// ... çœç•¥æ„é€ æ–¹æ³•ã€getting æ–¹æ³•ã€toString å’Œ hashCode æ–¹æ³•
}
```

ç„¶åï¼Œç»§ç»­æ¥çœ‹

/#initializeProfiles()
æ–¹æ³•ï¼Œåˆå§‹åŒ– Spring Profiles ç›¸å…³ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ConfigFileApplicationListener/#Loader.java
private void initializeProfiles(){
// The default profile for these purposes is represented as null. We add it
// first so that it is processed first and has lowest priority.
// <1> æ·»åŠ  null åˆ° profiles ä¸­ã€‚ç”¨äºåŠ è½½é»˜è®¤çš„é…ç½®æ–‡ä»¶ã€‚ä¼˜å…ˆæ·»åŠ åˆ° profiles ä¸­ï¼Œå› ä¸ºå¸Œæœ›é»˜è®¤çš„é…ç½®æ–‡ä»¶å…ˆè¢«å¤„ç†ã€‚
this.profiles.add(null);
// <2.1> è·å¾—æ¿€æ´»çš„ Profile ä»¬ï¼ˆä»é…ç½®ä¸­ï¼‰
Set<Profile> activatedViaProperty = getProfilesActivatedViaProperty();
// <2.2> å…ˆæ·»åŠ æ¿€æ´»çš„ Profile ä»¬ï¼ˆä¸åœ¨é…ç½®ä¸­ï¼‰
this.profiles.addAll(getOtherActiveProfiles(activatedViaProperty));
// Any pre-existing active profiles set via property sources (e.g.
// System properties) take precedence over those added in config files.
// <2.3> å†æ·»åŠ æ¿€æ´»çš„ Profile ä»¬ï¼ˆåœ¨é…ç½®ä¸­ï¼‰
addActiveProfiles(activatedViaProperty);
// <3> å¦‚æœæ²¡æœ‰æ¿€æ´»çš„ Profile ä»¬ï¼Œåˆ™æ·»åŠ é»˜è®¤çš„ Profile
if (this.profiles.size() == 1) { // only has null profile
for (String defaultProfileName : this.environment.getDefaultProfiles()) {
Profile defaultProfile = new Profile(defaultProfileName, true);
this.profiles.add(defaultProfile);
}
}
}
```

* <1>
å¤„ï¼Œæ·»åŠ 

null
åˆ°

profiles
ä¸­ã€‚ç”¨äºåŠ è½½é»˜è®¤çš„é…ç½®æ–‡ä»¶ã€‚ä¼˜å…ˆæ·»åŠ åˆ°

profiles
ä¸­ï¼Œå› ä¸ºå¸Œæœ›é»˜è®¤çš„é…ç½®æ–‡ä»¶å…ˆè¢«å¤„ç†ã€‚
* <2.1>
å¤„ï¼Œè°ƒç”¨

/#getProfilesActivatedViaProperty()
æ–¹æ³•ï¼Œè·å¾—æ¿€æ´»çš„ Profile ä»¬ï¼ˆä»é…ç½®ä¸­ï¼‰ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#Loader.java
private Set<Profile> getProfilesActivatedViaProperty(){
if (!this.environment.containsProperty(ACTIVE_PROFILES_PROPERTY)
&& !this.environment.containsProperty(INCLUDE_PROFILES_PROPERTY)) {
return Collections.emptySet();
}
Binder binder = Binder.get(this.environment);
Set<Profile> activeProfiles = new LinkedHashSet<>();
activeProfiles.addAll(getProfiles(binder, INCLUDE_PROFILES_PROPERTY)); // spring.profiles.include
activeProfiles.addAll(getProfiles(binder, ACTIVE_PROFILES_PROPERTY)); // spring.profiles.active
return activeProfiles;
}
```

* è¯»å–

"spring.profiles.include"
å’Œ

"spring.profiles.active"
å¯¹åº”çš„ Profile ä»¬ã€‚
* <2.2>
å¤„ï¼Œè°ƒç”¨

/#getOtherActiveProfiles(Set<Profile> activatedViaProperty)
æ–¹æ³•ï¼Œå…ˆæ·»åŠ æ¿€æ´»çš„ Profile ä»¬ï¼ˆ**ä¸åœ¨é…ç½®ä¸­**ï¼‰åˆ°

profiles
ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#Loader.java
private List<Profile> getOtherActiveProfiles(Set<Profile> activatedViaProperty){
return Arrays.stream(this.environment.getActiveProfiles()).map(Profile::new)
.filter((profile) -> !activatedViaProperty.contains(profile))
.collect(Collectors.toList());
}
```

* â€œ**ä¸åœ¨é…ç½®ä¸­**â€ï¼Œä¾‹å¦‚è¯´ï¼š

SpringApplication.additionalProfiles
ã€‚
* <2.3>
å¤„ï¼Œè°ƒç”¨

/#addActiveProfiles(Set<Profile> profiles)
æ–¹æ³•ï¼Œå†æ·»åŠ æ¿€æ´»çš„ Profile ä»¬ï¼ˆåœ¨é…ç½®ä¸­ï¼‰åˆ°

profiles
ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#Loader.java
void addActiveProfiles(Set<Profile> profiles){
if (profiles.isEmpty()) {
return;
}
// å¦‚æœå·²ç»æ ‡è®° activatedProfiles ä¸º true ï¼Œåˆ™ç›´æ¥è¿”å›
if (this.activatedProfiles) {
if (this.logger.isDebugEnabled()) {
this.logger.debug("Profiles already activated, '" + profiles + "' will not be applied");
}
return;
}
// æ·»åŠ åˆ° profiles ä¸­
this.profiles.addAll(profiles);
if (this.logger.isDebugEnabled()) {
this.logger.debug("Activated activeProfiles " + StringUtils.collectionToCommaDelimitedString(profiles));
}
// æ ‡è®° activatedProfiles ä¸º true ã€‚
this.activatedProfiles = true;
// ç§»é™¤ profiles ä¸­ï¼Œé»˜è®¤çš„é…ç½®ä»¬ã€‚
removeUnprocessedDefaultProfiles();
}
private void removeUnprocessedDefaultProfiles(){
this.profiles.removeIf(
(profile) -> (profile != null && profile.isDefaultProfile()));
}
```
* <3>
å¤„ï¼Œå¦‚æœæ²¡æœ‰æ¿€æ´»çš„ Profile ä»¬ï¼Œåˆ™æ·»åŠ é»˜è®¤çš„ Profile ã€‚æ­¤å¤„çš„â€œé»˜è®¤â€æ˜¯ï¼ŒæŒ‡çš„æ˜¯é…ç½®æ–‡ä»¶ä¸­çš„

"spring.profiles.default"
å¯¹åº”çš„å€¼ã€‚
* è¿™å—æ¯”è¾ƒç»•ï¼Œèƒ–å‹æœ€å¥½è‡ªå·±è°ƒè¯•ä¸‹ã€‚ä¾‹å¦‚è¯´ï¼Œæˆ‘ä»¬åœ¨ JVM å¯åŠ¨å¢åŠ 

--spring.profiles.active=prod
ï¼Œåˆ™ç»“æœå¦‚ä¸‹å›¾ï¼š![`profiles`](http://static2.iocoder.cn/images/Spring-Boot/2021-01-28/02.jpg)

### 4.4.1.1.2 load

/#load(Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)
æ–¹æ³•ï¼ŒåŠ è½½æŒ‡å®š Profile çš„é…ç½®æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#Loader.java
private void load(Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer){
// <1> è·å¾—è¦æ£€ç´¢é…ç½®çš„è·¯å¾„
getSearchLocations().forEach((location) -> {
// åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡ä»¶å¤¹
boolean isFolder = location.endsWith("/");
// <2> è·å¾—è¦æ£€ç´¢é…ç½®çš„æ–‡ä»¶åé›†åˆ
Set<String> names = isFolder ? getSearchNames() : NO_SEARCH_NAMES;
// <3> éå†æ–‡ä»¶åé›†åˆï¼Œé€ä¸ªåŠ è½½é…ç½®æ–‡ä»¶
names.forEach(
(name) -> load(location, name, profile, filterFactory, consumer));
});
}
```

* <1>
å¤„ï¼Œè°ƒç”¨

/#getSearchLocations()
æ–¹æ³•ï¼Œè·å¾—è¦æ£€ç´¢é…ç½®çš„è·¯å¾„ä»¬ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener.java
// Note the order is from least to most specific (last one wins)
private static final String DEFAULT_SEARCH_LOCATIONS = "classpath:/,classpath:/config/,file:./,file:./config/";
//*/*
/* The "config location" property name.
/*/
public static final String CONFIG_LOCATION_PROPERTY = "spring.config.location";
//*/*
/* The "config additional location" property name.
/*/
public static final String CONFIG_ADDITIONAL_LOCATION_PROPERTY = "spring.config.additional-location";
// ConfigFileApplicationListener/#Loader.java
private Set<String> getSearchLocations(){
// è·å¾— `"spring.config.location"` å¯¹åº”çš„é…ç½®çš„å€¼
if (this.environment.containsProperty(CONFIG_LOCATION_PROPERTY)) {
return getSearchLocations(CONFIG_LOCATION_PROPERTY);
}
// è·å¾— `"spring.config.additional-location"` å¯¹åº”çš„é…ç½®çš„å€¼
Set<String> locations = getSearchLocations(CONFIG_ADDITIONAL_LOCATION_PROPERTY);
// æ·»åŠ  searchLocations åˆ° locations ä¸­
locations.addAll(asResolvedSet(ConfigFileApplicationListener.this.searchLocations, DEFAULT_SEARCH_LOCATIONS));
return locations;
}
private Set<String> getSearchLocations(String propertyName){
Set<String> locations = new LinkedHashSet<>();
// å¦‚æœ environment ä¸­å­˜åœ¨ propertyName å¯¹åº”çš„å€¼
if (this.environment.containsProperty(propertyName)) {
// è¯»å–å±æ€§å€¼ï¼Œè¿›è¡Œåˆ†å‰²åï¼Œç„¶åéå†
for (String path : asResolvedSet(this.environment.getProperty(propertyName), null)) {
// å¤„ç† path
if (!path.contains("$")) {
path = StringUtils.cleanPath(path);
if (!ResourceUtils.isUrl(path)) {
path = ResourceUtils.FILE_URL_PREFIX + path;
}
}
// æ·»åŠ åˆ° path ä¸­
locations.add(path);
}
}
return locations;
}
// ä¼˜å…ˆä½¿ç”¨ value ã€‚å¦‚æœ value ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨ fallback
private Set<String> asResolvedSet(String value, String fallback){
List<String> list = Arrays.asList(StringUtils.trimArrayElements(
StringUtils.commaDelimitedListToStringArray((value != null)
? this.environment.resolvePlaceholders(value) : fallback)));
Collections.reverse(list);
return new LinkedHashSet<>(list);
}
```

* çœ‹ä¼¼æ¯”è¾ƒé•¿ï¼Œé€»è¾‘å¹¶ä¸å¤æ‚ã€‚
* å¦‚æœé…ç½®äº†

"spring.config.location"
ï¼Œåˆ™ä½¿ç”¨å®ƒçš„å€¼ï¼Œä½œä¸ºè¦æ£€ç´¢é…ç½®çš„è·¯å¾„ã€‚
* å¦‚æœé…ç½®äº†

"spring.config.additional-location"
ï¼Œåˆ™ä½¿ç”¨å®ƒä½œä¸º**é™„åŠ **è¦æ£€ç´¢é…ç½®çš„è·¯å¾„ã€‚å½“ç„¶ï¼Œè¿˜æ˜¯ä¼šæ·»åŠ é»˜è®¤çš„

DEFAULT_SEARCH_LOCATIONS
è·¯å¾„ã€‚
* é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿”å›çš„å€¼æ˜¯

DEFAULT_SEARCH_LOCATIONS
ã€‚å› ä¸ºï¼Œç»å¤§æ•°æƒ…å†µï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šåšç›¸åº”çš„é…ç½®ã€‚ğŸ˜ˆ æ‰€ä»¥ï¼Œèƒ–å‹å¦‚æœæ‡’çš„çœ‹é€»è¾‘ï¼Œå°±è®°å¾—è¿™ä¸ªç»“è®ºå°±å¯ä»¥äº†ã€‚
* <2>
å¤„ï¼Œè°ƒç”¨

/#getSearchNames()
æ–¹æ³•ï¼Œè·å¾—è¦æ£€ç´¢é…ç½®çš„æ–‡ä»¶åé›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener.java
private static final String DEFAULT_NAMES = "application";
private static final Set<String> NO_SEARCH_NAMES = Collections.singleton(null);
public static final String CONFIG_NAME_PROPERTY = "spring.config.name";
// ConfigFileApplicationListener/#Loader.java
private Set<String> getSearchNames(){
// è·å¾— `"spring.config.name"` å¯¹åº”çš„é…ç½®çš„å€¼
if (this.environment.containsProperty(CONFIG_NAME_PROPERTY)) {
String property = this.environment.getProperty(CONFIG_NAME_PROPERTY);
return asResolvedSet(property, null);
}
// æ·»åŠ  names or DEFAULT_NAMES åˆ° locations ä¸­
return asResolvedSet(ConfigFileApplicationListener.this.names, DEFAULT_NAMES);
}
```

* é€šè¿‡

DEFAULT_NAMES
é™æ€å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œé»˜è®¤éƒ½å»çš„é…ç½®æ–‡ä»¶åï¼ˆä¸è€ƒè™‘åç¼€ï¼‰ä¸º

"application"
ã€‚
* å‰©ä½™çš„é€»è¾‘ï¼Œèƒ–å‹ç®€å•çœ‹çœ‹å³å¯ã€‚
* é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿”å›çš„å€¼æ˜¯

DEFAULT_NAMES
ã€‚å› ä¸ºï¼Œç»å¤§æ•°æƒ…å†µï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šåšç›¸åº”çš„é…ç½®ã€‚ğŸ˜ˆ æ‰€ä»¥ï¼Œèƒ–å‹å¦‚æœæ‡’çš„çœ‹é€»è¾‘ï¼Œå°±è®°å¾—è¿™ä¸ªç»“è®ºå°±å¯ä»¥äº†ã€‚
* <3>
å¤„ï¼Œéå†

names
æ•°ç»„ï¼Œé€ä¸ªè°ƒç”¨

/#load(String location, String name, Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)
æ–¹æ³•ï¼Œé€ä¸ªåŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ4.4.1.1.3 loadã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ã€‚

### 4.4.1.1.3 load

/#load(String location, String name, Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)
æ–¹æ³•ï¼Œé€ä¸ªåŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#Loader.java
private void load(String location, String name, Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer){
// <1> è¿™å—é€»è¾‘å…ˆæ— è§†ï¼Œå› ä¸ºæˆ‘ä»¬ä¸ä¼šé…ç½® name ä¸ºç©ºã€‚
// é»˜è®¤æƒ…å†µä¸‹ï¼Œname ä¸º DEFAULT_NAMES=application
if (!StringUtils.hasText(name)) {
for (PropertySourceLoader loader : this.propertySourceLoaders) {
if (canLoadFileExtension(loader, location)) {
load(loader, location, profile, filterFactory.getDocumentFilter(profile), consumer);
return;
}
}
}
Set<String> processed = new HashSet<>(); // å·²å¤„ç†çš„æ–‡ä»¶åç¼€é›†åˆ
// <2> éå† propertySourceLoaders æ•°ç»„ï¼Œé€ä¸ªä½¿ç”¨ PropertySourceLoader è¯»å–é…ç½®
for (PropertySourceLoader loader : this.propertySourceLoaders) {
// <3> éå†æ¯ä¸ª PropertySourceLoader å¯å¤„ç†çš„æ–‡ä»¶åç¼€é›†åˆ
for (String fileExtension : loader.getFileExtensions()) {
// <4> æ·»åŠ åˆ° processed ä¸­ï¼Œä¸€ä¸ªæ–‡ä»¶åç¼€ï¼Œæœ‰ä¸”ä»…èƒ½è¢«ä¸€ä¸ª PropertySourceLoader æ‰€å¤„ç†
if (processed.add(fileExtension)) {
// åŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰
loadForFileExtension(loader, location + name, "." + fileExtension,
profile, filterFactory, consumer);
}
}
}
}
```

* <1>
å¤„çš„é€»è¾‘ï¼Œå¯ä»¥æ— è§†ã€‚å…·ä½“çš„åŸå› ï¼Œè§æˆ‘æ·»åŠ çš„æ³¨é‡Šã€‚
* <2>
å¤„ï¼Œéå†

propertySourceLoaders
æ•°ç»„ï¼Œé€ä¸ªä½¿ç”¨ PropertySourceLoader è¯»å–é…ç½®ã€‚
* <3>
å¤„ï¼Œéå†æ¯ä¸ª PropertySourceLoader å¯å¤„ç†çš„æ–‡ä»¶åç¼€é›†åˆã€‚ä¾‹å¦‚è¯´ï¼ŒPropertiesPropertySourceLoader å¯å¤„ç†

.properties
å’Œ

.xml
åç¼€ï¼ŒYamlPropertySourceLoader å¯å¤„ç†

.yml
å’Œ

.yaml
åç½®ã€‚
* <4>
å¤„ï¼Œæ·»åŠ åˆ°

processed
ä¸­ã€‚ä¸€ä¸ªæ–‡ä»¶åç¼€ï¼Œæœ‰ä¸”ä»…èƒ½è¢«ä¸€ä¸ª PropertySourceLoader æ‰€å¤„ç†ã€‚
* <5>
å¤„ï¼Œè°ƒç”¨

/#loadForFileExtension(PropertySourceLoader loader, String prefix, String fileExtension, Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)
æ–¹æ³•ï¼ŒåŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ4.4.1.1.7 loadForFileExtensionã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ã€‚

### 4.4.1.1.4 Document

å› ä¸ºç¨ååœ¨è®²è§£

/#loadForFileExtension(...)
æ–¹æ³•éœ€è¦ç”¨åˆ°ï¼Œæ‰€ä»¥æ’æ’­ä¸‹ã€‚

Document ï¼Œæ˜¯ ConfigFileApplicationListener çš„å†…éƒ¨ç±»ï¼Œç”¨äºå°è£… PropertySourceLoader åŠ è½½é…ç½®æ–‡ä»¶åã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ConfigFileApplicationListener/#Document.java
private static class Document{
private final PropertySource<?> propertySource;
//*/*
/* å¯¹åº” `spring.profiles` å±æ€§å€¼
/*/
private String[] profiles;
//*/*
/* å¯¹åº” `spring.profiles.active` å±æ€§å€¼
/*/
private final Set<Profile> activeProfiles;
//*/*
/* å¯¹åº” `spring.profiles.include` å±æ€§å€¼
/*/
private final Set<Profile> includeProfiles;
}
```

### 4.4.1.1.4.1 DocumentsCacheKey

DocumentsCacheKey ï¼Œæ˜¯ ConfigFileApplicationListener çš„å†…éƒ¨ç±»ï¼Œç”¨äºè¡¨ç¤ºåŠ è½½ Documents çš„ç¼“å­˜ KEY ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#DocumentsCacheKey.java
//*/*
/* Cache key used to save loading the same document multiple times.
/*/
private static class DocumentsCacheKey{
private final PropertySourceLoader loader;
private final Resource resource;
DocumentsCacheKey(PropertySourceLoader loader, Resource resource) {
this.loader = loader;
this.resource = resource;
}
@Override
public boolean equals(Object obj){
if (this == obj) {
return true;
}
if (obj == null || getClass() != obj.getClass()) {
return false;
}
DocumentsCacheKey other = (DocumentsCacheKey) obj;
return this.loader.equals(other.loader)
&& this.resource.equals(other.resource);
}
@Override
public int hashCode(){
return this.loader.hashCode() /* 31 + this.resource.hashCode();
}
}
```

* å› ä¸ºä¸€ä¸ªé…ç½®æ–‡ä»¶åœ¨ [ã€Œ4.4.1.1.7 loadForFileExtensionã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°å¯èƒ½å­˜åœ¨é‡å¤åŠ è½½çš„æƒ…å†µï¼Œæ‰€ä»¥é€šè¿‡ç¼“å­˜ï¼Œé¿å…é‡æ–°è¯»å–~

### 4.4.1.1.5 DocumentFilterFactory

å› ä¸ºç¨ååœ¨è®²è§£

/#loadForFileExtension(...)
æ–¹æ³•éœ€è¦ç”¨åˆ°ï¼Œæ‰€ä»¥æ’æ’­ä¸‹ã€‚

DocumentFilterFactory ï¼Œæ˜¯ ConfigFileApplicationListener çš„å†…éƒ¨æ¥å£ï¼Œç”¨äºåˆ›å»º DocumentFilter å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ConfigFileApplicationListener/#DocumentFilterFactory.java
@FunctionalInterface
private interface DocumentFilterFactory{
DocumentFilter getDocumentFilter(Profile profile);
}
```

åœ¨ [ã€Œ4.4.1.1 loadã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ä¸­ï¼Œæˆ‘ä»¬åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œå·²ç»çœ‹åˆ°å®ƒçš„ä¸¤ä¸ªåŒ¿åå®ç°ç±»ï¼Œå¦‚ä¸‹ï¼š

```
// ConfigFileApplicationListener/#Loader.java
ç¬¬ä¸€ä¸ªï¼šthis::getPositiveProfileFilter
ç¬¬äºŒä¸ªï¼šthis::getNegativeProfileFilter
```

* å®ƒä»¬åˆ†åˆ«è°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï¼Œåˆ›å»º DocumentFilter å¯¹è±¡ã€‚

### 4.4.1.1.5.1 DocumentFilter

DocumentFilter ï¼Œæ˜¯ ConfigFileApplicationListener çš„å†…éƒ¨æ¥å£ï¼Œç”¨äºåŒ¹é…é…ç½®åŠ è½½åçš„ Document å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#DocumentFilter.java
@FunctionalInterface
private interface DocumentFilter{
boolean match(Document document);
}
```

* åœ¨ä¸‹é¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼ŒåŠ è½½çš„é…ç½®æ–‡ä»¶åï¼Œè¿”å›çš„æ˜¯ Document å¯¹è±¡ã€‚ä½†æ˜¯ï¼Œè¿”å›çš„ Document å¯¹è±¡ï¼Œéœ€è¦å’Œ Profile è¿›è¡ŒåŒ¹é…ã€‚

### 4.4.1.1.5.2 getPositiveProfileFilter

/#getPositiveProfileFilter(Profile profile)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#Loader.java
private DocumentFilter getPositiveProfileFilter(Profile profile){
return (Document document) -> {
// <1> å½“ profile ä¸ºç©ºæ—¶ï¼Œdocument.profiles ä¹Ÿè¦ä¸ºç©º
if (profile == null) {
return ObjectUtils.isEmpty(document.getProfiles());
}
// <2> è¦æ±‚ document.profiles åŒ…å« profile
// å¹¶ä¸”ï¼Œenvironment.activeProfiles åŒ…å« document.profiles
// æ€»ç»“æ¥è¯´ï¼Œenvironment.activeProfiles åŒ…å« document.profiles åŒ…å« profile
return ObjectUtils.containsElement(document.getProfiles(), profile.getName())
&& this.environment.acceptsProfiles(Profiles.of(document.getProfiles()));
};
}
```

* <1>
å¤„ï¼Œå½“ä¼ å…¥çš„

profile
ä¸ºç©ºæ—¶ï¼Œè¦æ±‚

document.profiles
ä¹Ÿè¦ä¸ºç©ºã€‚
* <2>
å¤„ï¼Œå½“ä¼ å…¥çš„

profile
éç©ºæ—¶ï¼Œè¦æ±‚

environment.activeProfiles
åŒ…å«

document.profiles
åŒ…å«

profile
ã€‚

å¯èƒ½æ¯”è¾ƒç»•ï¼Œèƒ–å‹å…ˆçœ‹ [ã€ŠSpring-bootåŠ¨æ€profilesçš„å®è·µã€‹](https://spldeolin.com/posts/spring-boot-active-profiles/) æ–‡ç« çš„ [ã€ŒSpring Bootçš„Profileså±æ€§ã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) éƒ¨åˆ†ã€‚

* ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå‡è®¾ä¸€ä¸ª

application-prod.properties
çš„é…ç½®æ–‡ä»¶ï¼Œä¸€èˆ¬æˆ‘ä»¬çš„ç†è§£æ˜¯å¯¹åº” Profile ä¸º

prod
çš„æƒ…å†µï¼Œå¯¹å§ï¼Ÿï¼ä½†æ˜¯ï¼Œå¦‚æœè¯´æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­å¢åŠ äº†

spring.profiles=dev
ï¼Œé‚£å®ƒå®é™…æ˜¯å±äº Profile ä¸º

dev
çš„æƒ…å†µã€‚
è‰¿è‰¿ï¼šç¬¬ä¸€æ¬¡çŸ¥é“è¿˜æœ‰è¿™æ ·çš„è®¾å®šï¼ï¼ï¼
* å½“ç„¶ï¼Œæˆ‘ä»¬ç»å¤§éƒ½æ•°æƒ…å†µï¼Œå¹¶ä¸ä¼šå»å®šä¹‰

spring.profiles
å±æ€§ã€‚æ‰€ä»¥å‘¢ï¼Œåˆ†æˆä¸¤ç§æƒ…å†µï¼š
è‰¿è‰¿ï¼šä»”ç»†ç†è§£ï¼Œæˆ‘ä¹Ÿæ‡µé€¼äº†å¥½å¤šå°æ—¶ï¼ï¼ï¼ï¼

* profile
ä¸º

null
çš„æƒ…å†µï¼Œå¤„ç†é»˜è®¤æƒ…å†µï¼Œå³æˆ‘ä»¬æœªå®šä¹‰

spring.profiles
å±æ€§ã€‚
* profile
é

null
çš„æƒ…å†µï¼Œå¤„ç†é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†

spring.profiles
å±æ€§ï¼Œåˆ™éœ€è¦ä½¿ç”¨

profile
å’Œ

spring.profiles
åŒ¹é…ï¼Œå¹¶ä¸”å®ƒè¦å±äº

environment.activeProfiles
ä¸­å·²ç»æ¿€æ´»çš„ã€‚

ğŸ˜ˆ æ‰€ä»¥å‘¢ï¼Œæˆ‘ä»¬åœ¨ [ã€Œ4.4.1.1 loadã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ä¸­ï¼Œçœ‹åˆ°å®ƒæ˜¯åœ¨åŠ è½½æŒ‡å®š Profile çš„é…ç½®æ–‡ä»¶æ‰€ä½¿ç”¨ã€‚

### 4.4.1.1.5.3 getPositiveProfileFilter

/#getPositiveProfileFilter(Profile profile)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#Loader.java
private DocumentFilter getNegativeProfileFilter(Profile profile){
return (Document document) -> (profile == null // <1>
&& !ObjectUtils.isEmpty(document.getProfiles()) // <2> éç©º
// environment.activeProfiles åŒ…å« document.profiles
&& this.environment.acceptsProfiles(Profiles.of(document.getProfiles()))); // <3>
}
```

* <1>
å¤„ï¼Œè¦æ±‚ä¼ å…¥çš„

profile
ä¸ºç©ºã€‚å› ä¸ºå‘¢ï¼Œ[ã€Œ4.4.1.1 loadã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ä¸­ï¼Œçœ‹åˆ°å®ƒæ˜¯åœ¨åŠ è½½**æ—  Profile** çš„é…ç½®æ–‡ä»¶æ‰€ä½¿ç”¨ã€‚
* <2>
å¤„ï¼Œè¦æ±‚

document.profiles
éç©ºã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨

application.properties
ä¸­ï¼Œä¹Ÿå¹¶ä¸ä¼šå¡«å†™

spring.profiles
å±æ€§å€¼ã€‚è¿™å°±æ˜¯è¯´ï¼Œè¿™ä¸ªæ–¹æ³•é»˜è®¤åŸºæœ¬è¿”å›

false
ã€‚
* <3>
å¤„ï¼Œ

environment.activeProfiles
åŒ…å«

document.profiles
ã€‚

### 4.4.1.1.6 DocumentConsumer

å› ä¸ºç¨ååœ¨è®²è§£

/#loadForFileExtension(...)
æ–¹æ³•éœ€è¦ç”¨åˆ°ï¼Œæ‰€ä»¥æ’æ’­ä¸‹ã€‚

DocumentConsumer ï¼Œæ˜¯ ConfigFileApplicationListener çš„å†…éƒ¨æ¥å£ï¼Œç”¨äºå¤„ç†ä¼ å…¥çš„ Document ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
// ConfigFileApplicationListener/#DocumentConsumer.java
//*/*
/* Consumer used to handle a loaded {@link Document}.
/*/
@FunctionalInterface
private interface DocumentConsumer{
void accept(Profile profile, Document document);
}
```

åœ¨ [ã€Œ4.4.1.1 loadã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ä¸­ï¼Œæˆ‘ä»¬åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œå·²ç»çœ‹åˆ°å®ƒçš„ä¸€ä¸ªåŒ¿åå®ç°ç±»ï¼Œå¦‚ä¸‹ï¼š

```
// ConfigFileApplicationListener/#Loader.java
ç¬¬ä¸€ä¸ªï¼šaddToLoaded(MutablePropertySources::addLast, false))
ç¬¬äºŒä¸ªï¼šaddToLoaded(MutablePropertySources::addFirst, true))
```

* å·®åˆ«åœ¨äºä¼ å…¥çš„

/#addToLoaded(BiConsumer<MutablePropertySources, PropertySource<?>> addMethod, boolean checkForExisting)
æ–¹æ³•çš„

addMethod
å‚æ•°ä¸åŒã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

* å¯¹äºæœ‰ Profile çš„æƒ…å†µï¼Œä½¿ç”¨å‰è€…

MutablePropertySources::addLast
ï¼Œå°† Document çš„ PropertySource æ·»åŠ åˆ°å°¾éƒ¨ã€‚
* å¯¹äºæ—  Profile çš„æƒ…å†µï¼Œä½¿ç”¨åè€…

MutablePropertySources::addFirst
ï¼Œå°† Document çš„ PropertySource æ·»åŠ åˆ°å¤´éƒ¨ã€‚
* æœ€ç»ˆï¼Œæˆ‘ä»¬çœ‹åˆ°

/#addLoadedPropertySources()
æ–¹æ³•ä¸­ï¼Œä¼šæ‰§è¡Œ

Collections.reverse(loaded)
ä»£ç æ®µï¼Œè¿›è¡Œé¢ å€’ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™æ ·ï¼Œå°±èƒ½å¾ˆå·§å¦™çš„å®ç°

application-prod.properties
çš„ä¼˜å…ˆçº§ï¼Œé«˜äº

application.properties
ï¼Œä»è€Œå®ç°ç›¸åŒå±æ€§æ—¶ï¼Œè¦†ç›–è¯»å–~ï¼Œå³è¯»å–çš„æ˜¯

application-prod.properties
çš„å±æ€§é…ç½®ã€‚

### 4.4.1.1.6.1 addToLoaded

/#addToLoaded(BiConsumer<MutablePropertySources, PropertySource<?>> addMethod, boolean checkForExisting)
æ–¹æ³•ï¼Œå°† Document çš„ PropertySource ï¼Œæ·»åŠ åˆ°

Loader.loaded
ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#Loader.java
private DocumentConsumer addToLoaded(BiConsumer<MutablePropertySources, PropertySource<?>> addMethod, boolean checkForExisting){
// åˆ›å»º DocumentConsumer å¯¹è±¡
return (profile, document) -> {
// å¦‚æœè¦æ ¡éªŒå·²ç»å­˜åœ¨çš„æƒ…å†µï¼Œåˆ™å¦‚æœå·²ç»å­˜åœ¨ï¼Œåˆ™ç›´æ¥ return
if (checkForExisting) {
for (MutablePropertySources merged : this.loaded.values()) {
if (merged.contains(document.getPropertySource().getName())) {
return;
}
}
}
// è·å¾— profile å¯¹åº”çš„ MutablePropertySources å¯¹è±¡
MutablePropertySources merged = this.loaded.computeIfAbsent(profile,
(k) -> new MutablePropertySources());
// å°†åŠ è½½çš„ document åˆå¹¶åˆ° merged ä¸­
addMethod.accept(merged, document.getPropertySource());
};
}
```

* åˆ›å»ºäº†ä¸€ä¸ª DocumentConsumer å¯¹è±¡ã€‚è€Œå…¶å†…éƒ¨çš„é€»è¾‘ï¼Œå¾ˆç®€å•ï¼Œèƒ–å‹è‡ªå·±ç…ç…å³å¯ã€‚

### 4.4.1.1.7 loadForFileExtension

/#loadForFileExtension(PropertySourceLoader loader, String prefix, String fileExtension, Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)
æ–¹æ³•ï¼ŒåŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#Loader.java
private void loadForFileExtension(PropertySourceLoader loader, String prefix,
String fileExtension, Profile profile,
DocumentFilterFactory filterFactory, DocumentConsumer consumer){
// <1> è·å¾— DocumentFilter å¯¹è±¡
DocumentFilter defaultFilter = filterFactory.getDocumentFilter(null);
DocumentFilter profileFilter = filterFactory.getDocumentFilter(profile);
// <2> åŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚
if (profile != null) {
// Try profile-specific file & profile section in profile file (gh-340)
// åŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚
String profileSpecificFile = prefix + "-" + profile + fileExtension;
load(loader, profileSpecificFile, profile, defaultFilter, consumer); // <2.1> æƒ…å†µä¸€ï¼Œæœªé…ç½® spring.profile å±æ€§
load(loader, profileSpecificFile, profile, profileFilter, consumer); // <2.2> æƒ…å†µäºŒï¼Œæœ‰é…ç½® spring.profile å±æ€§
// Try profile specific sections in files we've already processed
// <2.3ã€‹ ç‰¹æ®Šæƒ…å†µï¼Œä¹‹å‰è¯»å– Profile å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå¯è¢«å½“å‰ Profile æ‰€è¯»å–ã€‚
// ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ä¹‹å‰è¯»å–äº† Profile ä¸º common å¯¹åº”é…ç½®æ–‡ä»¶æ˜¯ application-common.properties ï¼Œé‡Œé¢é…ç½®äº† spring.profile=dev,prod
// é‚£ä¹ˆï¼Œæ­¤æ—¶å¦‚æœè¯»å–çš„ Profile ä¸º dev æ—¶ï¼Œä¹Ÿèƒ½è¯»å– application-common.properties è¿™ä¸ªé…ç½®æ–‡ä»¶
for (Profile processedProfile : this.processedProfiles) {
if (processedProfile != null) {
String previouslyLoaded = prefix + "-" + processedProfile + fileExtension; // æ‹¼æ¥ä¹‹å‰çš„é…ç½®æ–‡ä»¶å
load(loader, previouslyLoaded, profile, profileFilter, consumer); // æ³¨æ„å™¢ï¼Œä¼ å…¥çš„ profile æ˜¯å½“å‰çš„ profile
}
}
}
// Also try the profile-specific section (if any) of the normal file
// <3> åŠ è½½ï¼ˆæ— éœ€å¸¦ Profileï¼‰æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚
load(loader, prefix + fileExtension, profile, profileFilter, consumer);
}
```

* <1>
å¤„ï¼Œè·å¾—ä¸¤ä¸ª DocumentFilter å¯¹è±¡ã€‚ä¸ºä»€ä¹ˆæ˜¯ä¸¤ä¸ªå‘¢ï¼Ÿèƒ–å‹æ€è€ƒä¸‹ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬åœ¨ [ã€Œ4.4.1.1.5.2 getPositiveProfileFilterã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ä¸­ï¼Œå·²ç»è¯´æ˜äº†ç­”æ¡ˆã€‚
* <2>
å¤„ï¼ŒåŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚æœ‰ä¸‰ç§æƒ…å†µï¼Œèƒ–å‹è®¤çœŸçœ‹

<2.1>
ã€

<2.2>
ã€

<2.3>
å¤„çš„ä»£ç æ³¨é‡Šã€‚
* <3>
å¤„ï¼ŒåŠ è½½ï¼ˆæ— éœ€å¸¦ Profileï¼‰æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚
* å…³äº

/#load(PropertySourceLoader loader, String location, Profile profile, DocumentFilter filter, DocumentConsumer consumer)
æ–¹æ³•ï¼ŒçœŸæ­£åŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ4.4.1.1.8 loadã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ã€‚

### 4.4.1.1.8 load

/#load(PropertySourceLoader loader, String location, Profile profile, DocumentFilter filter, DocumentConsumer consumer)
æ–¹æ³•ï¼ŒçœŸæ­£åŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#Loader.java
private void load(PropertySourceLoader loader, String location, Profile profile, DocumentFilter filter, DocumentConsumer consumer){
try {
// <1.1> åˆ¤æ–­æŒ‡å®šçš„é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›
Resource resource = this.resourceLoader.getResource(location);
if (!resource.exists()) {
if (this.logger.isTraceEnabled()) {
StringBuilder description = getDescription("Skipped missing config ", location, resource, profile);
this.logger.trace(description);
}
return;
}
// <1.2> å¦‚æœæ²¡æœ‰æ–‡ä»¶åç¼€çš„é…ç½®æ–‡ä»¶ï¼Œåˆ™å¿½ç•¥ï¼Œä¸è¿›è¡Œè¯»å–
if (!StringUtils.hasText(StringUtils.getFilenameExtension(resource.getFilename()))) {
if (this.logger.isTraceEnabled()) {
StringBuilder description = getDescription("Skipped empty config extension ", location, resource, profile);
this.logger.trace(description);
}
return;
}
// <1.3> åŠ è½½é…ç½®æ–‡ä»¶ï¼Œè¿”å› Document æ•°ç»„
String name = "applicationConfig: [" + location + "]";
List<Document> documents = loadDocuments(loader, name, resource);
// <1.4> å¦‚æœæ²¡åŠ è½½åˆ°ï¼Œåˆ™ç›´æ¥è¿”å›
if (CollectionUtils.isEmpty(documents)) {
if (this.logger.isTraceEnabled()) {
StringBuilder description = getDescription(
"Skipped unloaded config ", location, resource, profile);
this.logger.trace(description);
}
return;
}
// <2> ä½¿ç”¨ DocumentFilter è¿‡æ»¤åŒ¹é…çš„ Document ï¼Œæ·»åŠ åˆ° loaded æ•°ç»„ä¸­ã€‚
List<Document> loaded = new ArrayList<>();
for (Document document : documents) {
if (filter.match(document)) { // åŒ¹é…
addActiveProfiles(document.getActiveProfiles()); // <2.1>
addIncludedProfiles(document.getIncludeProfiles()); // <2.2>
loaded.add(document);
}
}
Collections.reverse(loaded);
// <3> ä½¿ç”¨ DocumentConsumer è¿›è¡Œæ¶ˆè´¹ Document ï¼Œæ·»åŠ åˆ°æœ¬åœ°çš„ loaded ä¸­ã€‚
if (!loaded.isEmpty()) {
loaded.forEach((document) -> consumer.accept(profile, document));
if (this.logger.isDebugEnabled()) {
StringBuilder description = getDescription("Loaded config file ", location, resource, profile);
this.logger.debug(description);
}
}
} catch (Exception ex) {
throw new IllegalStateException("Failed to load property "
+ "source from location '" + location + "'", ex);
}
}
```

* <1.1>
å¤„ï¼Œåˆ¤æ–­æŒ‡å®šçš„é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚
* <1.2>
å¤„ï¼Œå¦‚æœæ²¡æœ‰æ–‡ä»¶åç¼€çš„é…ç½®æ–‡ä»¶ï¼Œåˆ™å¿½ç•¥ï¼Œä¸è¿›è¡Œè¯»å–ã€‚
* <1.3>
å¤„ï¼Œè°ƒç”¨

/#loadDocuments(PropertySourceLoader loader, String name, Resource resource)
æ–¹æ³•ï¼ŒåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¹¶è¿”å› Document æ•°ç»„ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ4.4.1.1.8.1 loadDocumentsã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) å°èŠ‚ã€‚
* <1.4>
å¤„ï¼Œå¦‚æœæ²¡åŠ è½½åˆ°ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚
* <2>
å¤„ï¼Œéå†åŠ è½½åˆ°

documents
æ•°ç»„ï¼Œé€ä¸ªè°ƒç”¨

DocumentFilter/#match(Document document)
æ–¹æ³•ï¼Œè¿›è¡ŒåŒ¹é…ã€‚è‹¥åŒ¹é…æˆåŠŸï¼Œåˆ™æ·»åŠ åˆ°

loaded
ä¸­ã€‚

* <2.1>
å¤„ï¼Œ

/#addActiveProfiles(Set<Profile> profiles)
æ–¹æ³•ï¼Œå·²ç»åœ¨ [ã€Œ4.4.1.1.1 initializeProfilesã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ä¸­ï¼Œè¯¦ç»†è§£æã€‚
* <2.2>
å¤„ï¼Œ

/#addIncludedProfiles(Set<Profile> profiles)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#Loader.java
private void addIncludedProfiles(Set<Profile> includeProfiles){
// æ•´ä½“é€»è¾‘æ˜¯ includeProfiles - processedProfiles + profiles
LinkedList<Profile> existingProfiles = new LinkedList<>(this.profiles);
this.profiles.clear();
this.profiles.addAll(includeProfiles);
this.profiles.removeAll(this.processedProfiles);
this.profiles.addAll(existingProfiles);
}
```

* ~

* <3>
å¤„ï¼Œéå†

loaded
æ•°ç»„ï¼Œè°ƒç”¨

DocumentConsumer/#accept(Profile profile, Document document)
æ–¹æ³•ï¼Œæ·»åŠ åˆ°æœ¬åœ°çš„

Loader.loaded
ä¸­ã€‚æ­¤å¤„ï¼Œåœ¨ç»“åˆ [ã€Œ4.4.1.1.6 DocumentConsumerã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ä¸€èµ·çœ‹ã€‚

ğŸ˜ˆ è‡³æ­¤ï¼ŒSpring Boot åŠ è½½é…ç½®çš„åŠŸèƒ½ï¼ŒåŸºæœ¬æ˜¯å®Œæˆäº†ã€‚æ€»çš„æ¥è¯´ï¼Œç†è§£å¤§ä½“çš„æµç¨‹ï¼Œè¿˜æ˜¯ç›¸å¯¹æ¯”è¾ƒå®¹æ˜“çš„ã€‚ä½†æ˜¯ï¼Œæƒ³è¦æ‰£æ‡‚è¿™ä¸ªè¿‡ç¨‹çš„æ¯ä¸€ä¸ªç»†èŠ‚ï¼Œéœ€è¦å¤šå¤šçš„è°ƒè¯•ã€‚
è‰¿è‰¿ï¼šå¯èƒ½æœ‰äº›ç»†èŠ‚å†™çš„ä¸åˆ°ä½ï¼Œæˆ–è€…è§£é‡Šçš„ä¸åˆ°ä½ï¼Œåˆæˆ–è€…è®²çš„ä¸æ­£ç¡®ã€‚æ‰€ä»¥ï¼Œæœ‰ä»»ä½•ç–‘æƒ‘ï¼Œè¯·ç«‹åˆ»é©¬ä¸Šèµ¶ç´§ç»™æˆ‘æ˜Ÿçƒç•™è¨€æé—®å“ˆã€‚

### 4.4.1.1.8.1 loadDocuments

/#loadDocuments(PropertySourceLoader loader, String name, Resource resource)
æ–¹æ³•ï¼ŒåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¹¶è¿”å› Document æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#Loader.java
private List<Document> loadDocuments(PropertySourceLoader loader, String name, Resource resource) throws IOException{
// <1> åˆ›å»º DocumentsCacheKey å¯¹è±¡ï¼Œä» loadDocumentsCache ç¼“å­˜ä¸­åŠ è½½ Document æ•°ç»„
DocumentsCacheKey cacheKey = new DocumentsCacheKey(loader, resource);
List<Document> documents = this.loadDocumentsCache.get(cacheKey);
// <2.1> å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨ PropertySourceLoader åŠ è½½æŒ‡å®šé…ç½®æ–‡ä»¶
if (documents == null) {
List<PropertySource<?>> loaded = loader.load(name, resource);
// <2.2> å°†è¿”å›çš„ PropertySource æ•°ç»„ï¼Œå°è£…æˆ Document æ•°ç»„
documents = asDocuments(loaded);
// <2.3> æ·»åŠ åˆ° loadDocumentsCache ç¼“å­˜ä¸­
this.loadDocumentsCache.put(cacheKey, documents);
}
return documents;
}
```

* <1>
å¤„ï¼Œåˆ›å»º DocumentsCacheKey å¯¹è±¡ï¼Œä»

loadDocumentsCache
ç¼“å­˜ä¸­åŠ è½½ Document æ•°ç»„ã€‚
* <2.1>
å¤„ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨

PropertySourceLoader/#load(String name, Resource resource)
æ–¹æ³•ï¼ŒåŠ è½½æŒ‡å®šé…ç½®æ–‡ä»¶ã€‚è¯¦ç»†çš„è§£æï¼Œè§ [ã€Œ7. PropertySourceLoaderã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ä¸­ã€‚
* <2.2>
å¤„ï¼Œè°ƒç”¨

/#asDocuments(List<PropertySource<?>> loaded)
æ–¹æ³•ï¼Œå°†è¿”å›çš„ PropertySource æ•°ç»„ï¼Œå°è£…æˆ Document æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// ConfigFileApplicationListener/#Loader.java
private List<Document> asDocuments(List<PropertySource<?>> loaded){
if (loaded == null) {
return Collections.emptyList();
}
return loaded.stream().map((propertySource) -> {
// åˆ›å»º Binder å¯¹è±¡
Binder binder = new Binder(
ConfigurationPropertySources.from(propertySource),
this.placeholdersResolver);
return new Document(propertySource,
binder.bind("spring.profiles", STRING_ARRAY).orElse(null), // è¯»å– "spring.profiles" é…ç½®
getProfiles(binder, ACTIVE_PROFILES_PROPERTY), // è¯»å– "spring.profiles.active" é…ç½®
getProfiles(binder, INCLUDE_PROFILES_PROPERTY)); // è¯»å– "spring.profiles.include" é…ç½®
}).collect(Collectors.toList());
}
private Set<Profile> getProfiles(Binder binder, String name){
return binder.bind(name, STRING_ARRAY).map(this::asProfileSet).orElse(Collections.emptySet());
}
private Set<Profile> asProfileSet(String[] profileNames){
List<Profile> profiles = new ArrayList<>();
for (String profileName : profileNames) {
profiles.add(new Profile(profileName));
}
return new LinkedHashSet<>(profiles);
}
```
* <2.3>
å¤„ï¼Œæ·»åŠ åˆ°

loadDocumentsCache
ç¼“å­˜ä¸­ã€‚

# 5. RandomValuePropertySource

org.springframework.boot.env.RandomValuePropertySource
ï¼Œç»§æ‰¿ PropertySource ç±»ï¼Œæä¾›éšæœºå€¼çš„ PropertySource å®ç°ç±»ã€‚

ä¸äº†è§£ Spring Boot ä»é…ç½®æ–‡ä»¶ä¸­è·å–éšæœºæ•°ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠSpring Bootå­¦ä¹ â€“ä»é…ç½®æ–‡ä»¶ä¸­è·å–éšæœºæ•°ã€‹](https://blog.csdn.net/qq_35981283/article/details/77853069) æ–‡ç« ã€‚

## 5.1 addToEnvironment

/#addToEnvironment(ConfigurableEnvironment environment)
**é™æ€**æ–¹æ³•ï¼Œåˆ›å»º RandomValuePropertySource å¯¹è±¡ï¼Œæ·»åŠ åˆ°

environment
ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// RandomValuePropertySource.java
//*/*
/* Name of the random {@link PropertySource}.
/*/
public static final String RANDOM_PROPERTY_SOURCE_NAME = "random";
public static void addToEnvironment(ConfigurableEnvironment environment){
environment.getPropertySources().addAfter(StandardEnvironment.SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME, new RandomValuePropertySource(RANDOM_PROPERTY_SOURCE_NAME));
logger.trace("RandomValuePropertySource add to Environment");
}
```

## 5.2 getProperty

å®ç°

/#getProperty(String name)
æ–¹æ³•ï¼Œè·å¾—

name
å¯¹åº”çš„éšæœºå€¼ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// RandomValuePropertySource.java
private static final String PREFIX = "random.";
@Override
public Object getProperty(String name){
// <1> å¿…é¡»ä»¥ random. å‰ç¼€
if (!name.startsWith(PREFIX)) {
return null;
}
if (logger.isTraceEnabled()) {
logger.trace("Generating random property for '" + name + "'");
}
// <2> æ ¹æ®ç±»å‹ï¼Œè·å¾—éšæœºå€¼
return getRandomValue(name.substring(PREFIX.length()));
}
```

* <1>
å¤„ï¼Œå¿…é¡»ä»¥

"random."
å‰ç¼€ã€‚åœ¨è·å–å±æ€§å€¼ï¼Œ

name
å‰åçš„

${}
å·²ç»è¢«å»æ‰ã€‚
* <2>
å¤„ï¼Œè°ƒç”¨

/#getRandomValue(String type)
æ–¹æ³•ï¼Œæ ¹æ®ç±»å‹ï¼Œè·å¾—éšæœºå€¼ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// RandomValuePropertySource.java
private Object getRandomValue(String type){
// int
if (type.equals("int")) {
return getSource().nextInt();
}
// long
if (type.equals("long")) {
return getSource().nextLong();
}
// int èŒƒå›´
String range = getRange(type, "int");
if (range != null) {
return getNextIntInRange(range);
}
// long èŒƒå›´
range = getRange(type, "long");
if (range != null) {
return getNextLongInRange(range);
}
// uuid
if (type.equals("uuid")) {
return UUID.randomUUID().toString();
}
// md5
return getRandomBytes();
}
private String getRange(String type, String prefix){
if (type.startsWith(prefix)) {
int startIndex = prefix.length() + 1;
if (type.length() > startIndex) {
return type.substring(startIndex, type.length() - 1);
}
}
return null;
}
private int getNextIntInRange(String range){
String[] tokens = StringUtils.commaDelimitedListToStringArray(range);
int start = Integer.parseInt(tokens[0]);
if (tokens.length == 1) {
return getSource().nextInt(start);
}
return start + getSource().nextInt(Integer.parseInt(tokens[1]) - start);
}
private long getNextLongInRange(String range){
String[] tokens = StringUtils.commaDelimitedListToStringArray(range);
if (tokens.length == 1) {
return Math.abs(getSource().nextLong() % Long.parseLong(tokens[0]));
}
long lowerBound = Long.parseLong(tokens[0]);
long upperBound = Long.parseLong(tokens[1]) - lowerBound;
return lowerBound + Math.abs(getSource().nextLong() % upperBound);
}
private Object getRandomBytes(){
byte[] bytes = new byte[32];
getSource().nextBytes(bytes);
return DigestUtils.md5DigestAsHex(bytes);
}
```

* æ¯”è¾ƒç®€å•ï¼Œç…ç…å³æ˜ç™½ã€‚

ğŸ˜ˆ è¿™ä¸ªè°œé¢˜ï¼Œæ˜¯ä¸æ˜¯è¢«æ­æ™“äº†~

# 6. PropertySourcesPlaceholdersResolver

org.springframework.boot.context.properties.bind.PropertySourcesPlaceholdersResolver
ï¼Œå®ç° PropertySource å¯¹åº”çš„å€¼æ˜¯å ä½ç¬¦çš„è§£æå™¨ ã€‚

## 6.1 æ„é€ æ–¹æ³•

```
// PropertySourcesPlaceholdersResolver.java
private final Iterable<PropertySource<?>> sources;
private final PropertyPlaceholderHelper helper;
public PropertySourcesPlaceholdersResolver(Environment environment){
this(getSources(environment), null);
}
public PropertySourcesPlaceholdersResolver(Iterable<PropertySource<?>> sources){
this(sources, null);
}
public PropertySourcesPlaceholdersResolver(Iterable<PropertySource<?>> sources,
PropertyPlaceholderHelper helper){
this.sources = sources;
this.helper = (helper != null) ? helper
: new PropertyPlaceholderHelper(SystemPropertyUtils.PLACEHOLDER_PREFIX, // ${
SystemPropertyUtils.PLACEHOLDER_SUFFIX, // }
SystemPropertyUtils.VALUE_SEPARATOR, true);
}
// è·å¾— PropertySources ä»¬
private static PropertySources getSources(Environment environment){
Assert.notNull(environment, "Environment must not be null");
Assert.isInstanceOf(ConfigurableEnvironment.class, environment, "Environment must be a ConfigurableEnvironment");
return ((ConfigurableEnvironment) environment).getPropertySources();
}
```

* å…¶ä¸­ï¼Œåˆ›å»ºçš„

helper
å±æ€§ï¼Œä¸º PropertyPlaceholderHelper å¯¹è±¡ã€‚å…¶ä¸­

SystemPropertyUtils.PLACEHOLDER_PREFIX
ä¸º

${
ï¼Œ

SystemPropertyUtils.PLACEHOLDER_SUFFIX
ä¸º

}
ã€‚è¿™æ ·ï¼Œä¾‹å¦‚è¯´ RandomValuePropertySource çš„

${random.int}
ç­‰ç­‰ï¼Œå°±å¯ä»¥è¢« PropertySourcesPlaceholdersResolver æ‰€å¤„ç†ã€‚

## 6.2 resolvePlaceholders

å®ç°

/#resolvePlaceholders(Object value)
æ–¹æ³•ï¼Œè§£æå ä½ç¬¦ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// PropertySourcesPlaceholdersResolver.java
@Override
public Object resolvePlaceholders(Object value){
// å¦‚æœ value æ˜¯ String ç±»å‹ï¼Œæ‰æ˜¯å ä½ç¬¦
if (value instanceof String) {
return this.helper.replacePlaceholders((String) value, this::resolvePlaceholder);
}
return value;
}
```

* å¦‚æœ

value
æ˜¯ String ç±»å‹ï¼Œæ‰**å¯èƒ½**æ˜¯å ä½ç¬¦ã€‚æ»¡è¶³æ—¶ï¼Œè°ƒç”¨

PropertyPlaceholderHelper/#replacePlaceholders(String value, PlaceholderResolver placeholderResolver)
æ–¹æ³•ï¼Œè§£æå‡ºå ä½ç¬¦é‡Œé¢çš„å†…å®¹ã€‚

* ä¾‹å¦‚è¯´ï¼šPropertySourcesPlaceholdersResolver ä¸­ï¼Œå ä½ç¬¦æ˜¯

${}
ï¼Œé‚£ä¹ˆ

${random.int}
è¢«è§£æåçš„å†…å®¹æ˜¯

random.int
ã€‚
* è§£æåˆ°å ä½ç¬¦åï¼Œåˆ™å›è°ƒ

/#resolvePlaceholder(String placeholder)
æ–¹æ³•ï¼Œè·å¾—å ä½ç¬¦å¯¹åº”çš„å€¼ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// PropertySourcesPlaceholdersResolver.java
protected String resolvePlaceholder(String placeholder){
if (this.sources != null) {
// éå† sources æ•°ç»„ï¼Œé€ä¸ªè·å¾—å±æ€§å€¼ã€‚è‹¥è·å–åˆ°ï¼Œåˆ™è¿›è¡Œè¿”å›
for (PropertySource<?> source : this.sources) {
Object value = source.getProperty(placeholder);
if (value != null) {
return String.valueOf(value);
}
}
}
return null;
}
```

* è¿™æ ·ï¼ŒğŸ˜ˆ RandomValuePropertySource æ˜¯ä¸æ˜¯å°±è¢«ä¸²èµ·æ¥å–½ã€‚

# 7. PropertySourceLoader

org.springframework.boot.env.PropertySourceLoader
æ¥å£ï¼ŒåŠ è½½æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œè¿”å› PropertySource æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// PropertySourceLoader.java
public interface PropertySourceLoader{
//*/*
/* è·å¾—å¯ä»¥å¤„ç†çš„é…ç½®æ–‡ä»¶çš„åç¼€
/*
/* Returns the file extensions that the loader supports (excluding the '.').
/* @return the file extensions
/*/
String[] getFileExtensions();
//*/*
/* åŠ è½½æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œè¿”å› PropertySource æ•°ç»„
/*
/* Load the resource into one or more property sources. Implementations may either
/* return a list containing a single source, or in the case of a multi-document format
/* such as yaml a source for each document in the resource.
/* @param name the root name of the property source. If multiple documents are loaded
/* an additional suffix should be added to the name for each source loaded.
/* PropertySource çš„åå­—
/* @param resource the resource to load
/* é…ç½®æ–‡ä»¶çš„ Resource å¯¹è±¡
/* @return a list property sources
/* @throws IOException if the source cannot be loaded
/*/
List<PropertySource<?>> load(String name, Resource resource) throws IOException;
}
```

* å¯èƒ½èƒ–å‹ï¼Œå’Œæˆ‘å¼€å§‹ä¸€æ ·ï¼Œä¸ºä»€ä¹ˆä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼ŒåŠ è½½åä¼šå­˜åœ¨å¤šä¸ª PropertySource å¯¹è±¡å‘¢ï¼Ÿä¸‹é¢ï¼Œæˆ‘ä»¬æ¥è§åˆ†æ™“~

## 7.1 PropertiesPropertySourceLoader

org.springframework.boot.env.PropertiesPropertySourceLoader
ï¼Œå®ç° PropertySourceLoader æ¥å£ï¼ŒåŠ è½½

.xml
å’Œ

.properties
ç±»å‹çš„é…ç½®æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// PropertiesPropertySourceLoader.java
public class PropertiesPropertySourceLoader implements PropertySourceLoader{
private static final String XML_FILE_EXTENSION = ".xml";
@Override
public String[] getFileExtensions() {
return new String[] { "properties", "xml" }; // <1>
}
@Override
public List<PropertySource<?>> load(String name, Resource resource)
throws IOException {
// <2.1> è¯»å–æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œè¿”å› Map å¯¹è±¡
Map<String, ?> properties = loadProperties(resource);
// <2.2> å¦‚æœ Map ä¸ºç©ºï¼Œè¿”å›ç©ºæ•°ç»„
if (properties.isEmpty()) {
return Collections.emptyList();
}
// <2.3> å°† Map å°è£…æˆ OriginTrackedMapPropertySource å¯¹è±¡ï¼Œç„¶åè¿”å›å•å…ƒç´ çš„æ•°ç»„
return Collections.singletonList(new OriginTrackedMapPropertySource(name, properties));
}
}
```

* <1>
å¤„ï¼Œè¿”å›å¯å¤„ç†çš„æ–‡ä»¶ç±»å‹ï¼Œä¸º

properties
å’Œ

xml
ã€‚
* <2.1>
å¤„ï¼Œè°ƒç”¨

/#loadProperties(Resource resource)
æ–¹æ³•ï¼Œè¯»å–æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œè¿”å› Map å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// PropertiesPropertySourceLoader.java
private Map<String, ?> loadProperties(Resource resource) throws IOException {
String filename = resource.getFilename();
// è¯»å– XML åç¼€çš„é…ç½®æ–‡ä»¶
if (filename != null && filename.endsWith(XML_FILE_EXTENSION)) {
return (Map) PropertiesLoaderUtils.loadProperties(resource);
}
// è¯»å– Properties åç¼€çš„é…ç½®æ–‡ä»¶
return new OriginTrackedPropertiesLoader(resource).load();
}
```

* æ ¹æ®

.xml
å’Œ

.properties
åç¼€ï¼Œä½¿ç”¨ä¸åŒçš„è¯»å–æ–¹æ³•ã€‚è‡³äºè¯»å–é…ç½®çš„é€»è¾‘ï¼Œæš‚æ—¶ä¸åœ¨æœ¬æ–‡çš„èŒƒç•´ï¼Œhoho ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œè‡ªå·±å»ç…ç…ã€‚
* <2.2>
å¤„ï¼Œå¦‚æœ Map ä¸ºç©ºï¼Œè¿”å›ç©ºæ•°ç»„ã€‚
* <2.3>
å¤„ï¼Œå°† Map å°è£…æˆ OriginTrackedMapPropertySource å¯¹è±¡ï¼Œç„¶åè¿”å›å•å…ƒç´ çš„æ•°ç»„ã€‚

org.springframework.boot.env.OriginTrackedMapPropertySource
ï¼Œç»§æ‰¿ MapPropertySource ç±»ï¼Œå®ç° OriginLookup æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š  ```
// OriginTrackedMapPropertySource.java
public final class OriginTrackedMapPropertySource extends MapPropertySource
implements OriginLookup<String>{
@SuppressWarnings({ "unchecked", "rawtypes" })
public OriginTrackedMapPropertySource(String name, Map source){
super(name, source);
}
@Override
public Object getProperty(String name){
// è·å¾—å±æ€§å€¼
Object value = super.getProperty(name);
// å¦‚æœæ˜¯ OriginTrackedValue å°è£…ç±»å‹ï¼Œåˆ™è¿”å›å…¶çœŸå®çš„å€¼
if (value instanceof OriginTrackedValue) {
return ((OriginTrackedValue) value).getValue();
}
return value;
}
@Override
public Origin getOrigin(String name){
// è·å¾—å±æ€§å€¼
Object value = super.getProperty(name);
// å¦‚æœæ˜¯ OriginTrackedValue å°è£…ç±»å‹ï¼Œåˆ™è¿”å›å…¶ Origin
if (value instanceof OriginTrackedValue) {
return ((OriginTrackedValue) value).getOrigin();
}
return null;
}
}
```

## 7.2 YamlPropertySourceLoader

org.springframework.boot.env.YamlPropertySourceLoader
ï¼Œå®ç° PropertySourceLoader æ¥å£ï¼ŒåŠ è½½

.yaml
å’Œ

.yml
ç±»å‹çš„é…ç½®æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// YamlPropertySourceLoader.java
public class YamlPropertySourceLoader implements PropertySourceLoader{
@Override
public String[] getFileExtensions() {
return new String[] { "yml", "yaml" }; // <1>
}
@Override
public List<PropertySource<?>> load(String name, Resource resource) throws IOException {
// <2> å¦‚æœä¸å­˜åœ¨ org.yaml.snakeyaml.Yaml ç±»ï¼Œè¯´æ˜æ²¡æœ‰å¼•å…¥ snakeyaml ä¾èµ–
if (!ClassUtils.isPresent("org.yaml.snakeyaml.Yaml", null)) {
throw new IllegalStateException("Attempted to load " + name
+ " but snakeyaml was not found on the classpath");
}
// <3.1> åŠ è½½é…ç½®ï¼Œè¿”å› Map æ•°ç»„
List<Map<String, Object>> loaded = new OriginTrackedYamlLoader(resource).load();
// <3.2> å¦‚æœæ•°ç»„ä¸ºç©ºï¼Œè¿”å›ç©ºæ•°ç»„
if (loaded.isEmpty()) {
return Collections.emptyList();
}
// <3.3> å°† Map æ•°ç»„ï¼Œå°è£…æˆ OriginTrackedMapPropertySource æ•°ç»„ï¼Œè¿”å›
List<PropertySource<?>> propertySources = new ArrayList<>(loaded.size());
for (int i = 0; i < loaded.size(); i++) {
String documentNumber = (loaded.size() != 1) ? " (document /#" + i + ")" : "";
propertySources.add(new OriginTrackedMapPropertySource(name + documentNumber, loaded.get(i)));
}
return propertySources;
}
}
```

* <1>
å¤„ï¼Œè¿”å›å¯å¤„ç†çš„æ–‡ä»¶ç±»å‹ï¼Œä¸º

yaml
å’Œ

yml
ã€‚
* <2>
å¤„ï¼Œå¦‚æœä¸å­˜åœ¨

org.yaml.snakeyaml.Yaml
ç±»ï¼Œè¯´æ˜æ²¡æœ‰å¼•å…¥ snakeyaml ä¾èµ–ï¼Œåˆ™æŠ›å‡º IllegalStateException å¼‚å¸¸ã€‚
* <3.1>
å¤„ï¼Œè°ƒç”¨

OriginTrackedYamlLoader/#load()
æ–¹æ³•ï¼ŒåŠ è½½é…ç½®ï¼Œè¿”å› Map æ•°ç»„ã€‚ğŸ˜ˆ å“å“Ÿï¼Œæ­¤å¤„å°±æ˜¯æˆ‘ä»¬çš„å¥½å¥‡äº†ï¼Œè¿”å›çš„æ˜¯ Map æ•°ç»„åˆ—ï¼æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ [ã€ŠSpring Boot ä½¿ç”¨ YML æ–‡ä»¶é…ç½®å¤šç¯å¢ƒã€‹](https://blog.csdn.net/yy756127197/article/details/78193398) çš„ [ã€Œ1 ä¸€ä¸ªymlæ–‡ä»¶ã€](http://svip.iocoder.cn/Spring-Boot/properties-load/) ï¼Œæ¯ä¸ª

----
åˆ†å‰²çº¿ï¼Œä¼šè§£ææˆä¸€ä¸ªå¯¹åº”çš„

Map<String, Object>
å¯¹è±¡ã€‚
* <3.2>
å¤„ï¼Œå¦‚æœ Map æ•°ç»„ä¸ºç©ºï¼Œè¿”å›ç©ºæ•°ç»„ã€‚
* <3.3>
å¤„ï¼Œå°† Map æ•°ç»„ï¼Œå°è£…æˆ OriginTrackedMapPropertySource æ•°ç»„ï¼Œç„¶åè¿”å›ã€‚

# 666. å½©è›‹

å§æ§½ï¼ŒçœŸå¿ƒæ˜¯å†…å¿ƒæ— æ¯”å§æ§½ã€‚æ¯”æˆ‘é¢„å…ˆçš„ï¼Œé•¿å¤ªå¤ªå¤ªå¤šäº†ã€‚

å¦‚æœæœ‰è§£é‡Šä¸åˆ°ä½çš„åœ°æ–¹ï¼Œéº»çƒ¦èƒ–å‹åœ¨æ˜Ÿçƒæå‡ºä¸‹å“Ÿã€‚hoho ï¼Œæ˜¥èŠ‚æœŸé—´åˆäºŒï¼Œåœ¨è€å®¶å†™å®Œ~

å‚è€ƒå’Œæ¨èå¦‚ä¸‹æ–‡ç« ï¼š

* oldflame-Jm [ã€ŠSpring bootæºç åˆ†æ-profilesç¯å¢ƒï¼ˆ4ï¼‰ã€‹](https://blog.csdn.net/jamet/article/details/77508182)
* oldflame-Jm [ã€ŠSpring bootæºç åˆ†æ-ApplicationListeneråº”ç”¨ç¯å¢ƒï¼ˆ5ï¼‰ã€‹](https://blog.csdn.net/jamet/article/details/78042486)
* youzhibing2904 [ã€Šspring-boot-2.0.3ä¸ä¸€æ ·ç³»åˆ—ä¹‹æºç ç¯‡ - runæ–¹æ³•ï¼ˆäºŒï¼‰ä¹‹prepareEnvironmentï¼Œç»å¯¹æœ‰å€¼å¾—ä½ çœ‹çš„åœ°æ–¹ã€‹](https://www.cnblogs.com/youzhibing/p/9622441.html)

å¦‚ä¸‹å†…å®¹ï¼Œæ˜¯è‰¿è‰¿çš„è‰ç¨¿ï¼Œèƒ–å‹å¯ä»¥å…ˆä¸å»äº†è§£ã€‚

å‡è®¾ Profile ä¸º

prod,dev
ã€‚è¯»å–ç»“æœå¦‚ä¸‹ï¼š
å¦‚ä¸‹è¿‡ç¨‹ï¼Œçœç•¥è¯»å–ä¸åˆ°é…ç½®æ–‡ä»¶çš„æƒ…å†µã€‚

* getPositiveProfileFilter çš„æƒ…å†µ

* profile=null
éƒ¨åˆ†

* è¯»å–

classpath:/application.properties
ï¼ŒåŒ¹é…æˆåŠŸã€‚
* è¯»å–

classpath:/application.yaml
ï¼ŒåŒ¹é…æˆåŠŸã€‚
* profile=prod

* è¯»å–

classpath:/application-prod.properties
ï¼ŒåŒ¹é…æˆåŠŸï¼ˆåŸºäº

defaultFilter
ï¼‰ã€‚
* è¯»å–

classpath:/application-prod.properties
ï¼ŒåŒ¹é…å¤±è´¥ï¼ˆåŸºäº

profileFilter
ï¼‰ã€‚
* è¯»å–

classpath:/application-prod.properties
ï¼ŒåŒ¹é…å¤±è´¥ï¼ˆåŸºäº

profileFilter
ï¼‰ã€‚
* è¯»å–

classpath:/application.yaml
ï¼ŒåŒ¹é…å¤±è´¥ï¼ˆåŸºäº

profileFilter
ï¼‰ã€‚ã€åŒ¹é…ä¸Š prod é‚£éƒ¨åˆ†ã€‘
* profile=dev

* è¯»å–

classpath:/application-dev.properties
ï¼ŒåŒ¹é…æˆåŠŸï¼ˆåŸºäº

defaultFilter
ï¼‰ã€‚
* è¯»å–

classpath:/application-dev.properties
ï¼ŒåŒ¹é…å¤±è´¥ï¼ˆåŸºäº

profileFilter
ï¼‰ã€‚
* è¯»å–

classpath:/application-dev.properties
ï¼ŒåŒ¹é…å¤±è´¥ï¼ˆåŸºäº

profileFilter
ï¼‰ã€‚
* è¯»å–

classpath:/application.yaml
ï¼ŒåŒ¹é…å¤±è´¥ï¼ˆåŸºäº

profileFilter
ï¼‰ã€‚ã€åŒ¹é…ä¸Š dev é‚£éƒ¨åˆ†ã€‘
* getNegativeProfileFilter çš„æƒ…å†µ

* profile=null
éƒ¨åˆ†

* è¯»å–

classpath:/application.properties
ï¼ŒåŒ¹é…å¤±è´¥ã€‚
* ğŸ™‚ğŸ™‚ğŸ™‚ è¯»å–

classpath:/application.yaml
ï¼ŒåŒ¹é…æˆåŠŸã€åŒ¹é…ä¸Š prodã€dev é‚£éƒ¨åˆ†ã€‘ã€‚æ¯”è¾ƒæœ‰æ„æ€ ğŸ˜ˆ ï¼Œç”¨äºè§£å†³

profile=null
çš„æƒ…å†µï¼Œå¯ä»¥æŠŠæ¿€æ´»çš„ Profile ï¼Œä¹ŸåŒ¹é…ä¸Šã€‚ä½†æ˜¯åœ¨ç›®å‰è¿™ä¸ªæƒ…å†µä¸‹ï¼Œå³ä½¿åŒ¹é…ä¸Šï¼Œåœ¨

/#addToLoaded(...)
æ–¹æ³•ä¸­çš„ DocumentConsumer çš„é€»è¾‘æ—¶ï¼Œä¼šåœ¨

checkForExisting
é‚£å—çš„é€»è¾‘ï¼Œå¦‚æœè¦æ ¡éªŒå·²ç»å­˜åœ¨çš„æƒ…å†µï¼Œåˆ™å¦‚æœå·²ç»å­˜åœ¨ï¼Œåˆ™ç›´æ¥

return
è¢«æ’é™¤æ‰ã€‚å› ä¸ºåœ¨

profile=prod
å’Œ

profile=dev
éƒ¨åˆ†ï¼Œå·²ç»åŒ¹é…ä¸Šè¯¥éƒ¨åˆ†çš„é…ç½®ã€‚

* = =~å½“ç„¶ï¼Œå®åœ¨æä¸æ‡‚è¿™ä¸ªé€»è¾‘ï¼Œä¹Ÿä¸ç”¨çº ç»“è¿™ä¸ªã€‚é‡ç‚¹æ˜¯ææ‡‚ Spring Boot åŠ è½½é…ç½®çš„æ ¸å¿ƒé€»è¾‘ã€‚ä¹Ÿå°±æ˜¯ï¼ŒConfigFileApplicationListener æ•´ä½“çš„é€»è¾‘ã€‚
* è‰¿è‰¿åˆæ€è€ƒäº†ä¸‹ï¼Œè²Œä¼¼çªç„¶ä¹Ÿæœ‰ç‚¹æƒ³ä¸é€šï¼Œä»€ä¹ˆæƒ…å†µä¸‹ï¼Œè¿™å—é€»è¾‘ä¼šæˆåŠŸåŠ è½½åˆ° Profile ä¸åŒ¹é…çš„é…ç½®æ–‡ä»¶ï¼Œå³åœ¨åœ¨

/#addToLoaded(...)
æ–¹æ³•ä¸­çš„ DocumentConsumer çš„é€»è¾‘æ—¶ï¼Œä¼šåœ¨

checkForExisting
é‚£å—çš„é€»è¾‘ï¼Œå¦‚æœè¦æ ¡éªŒå·²ç»å­˜åœ¨çš„æƒ…å†µï¼Œåˆ™å¦‚æœä¸å­˜åœ¨ã€‚