# æœåŠ¡å¼•ç”¨ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°å¼•ç”¨ï¼ˆInjvmï¼‰

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

Dubbo æœåŠ¡å¼•ç”¨ï¼Œ**å’Œ Dubbo æœåŠ¡æš´éœ²ä¸€æ ·**ï¼Œ**ä¹Ÿ**æœ‰ä¸¤ç§æ–¹å¼ï¼š

* æœ¬åœ°å¼•ç”¨ï¼ŒJVM æœ¬åœ°è°ƒç”¨ã€‚é…ç½®å¦‚ä¸‹ï¼š
```
// æ¨è
<dubbo:service scope="local" />
// ä¸æ¨èä½¿ç”¨ï¼Œå‡†å¤‡åºŸå¼ƒ
<dubbo:service injvm="true" />
```
* è¿œç¨‹æš´éœ²ï¼Œç½‘ç»œè¿œç¨‹é€šä¿¡ã€‚é…ç½®å¦‚ä¸‹ï¼š
```
<dubbo:service scope="remote" />
```

æˆ‘ä»¬çŸ¥é“ Dubbo æä¾›äº†å¤šç§åè®®( Protocol )å®ç°ã€‚

* **æœ¬æ–‡**ä»…åˆ†äº«æœ¬åœ°å¼•ç”¨ï¼Œè¯¥æ–¹å¼ä»…ä½¿ç”¨ Injvm åè®®å®ç°ï¼Œå…·ä½“ä»£ç åœ¨

dubbo-rpc-injvm
æ¨¡å—ä¸­ã€‚
* **ä¸‹å‡ ç¯‡**ä¼šåˆ†äº«è¿œç¨‹å¼•ç”¨ï¼Œè¯¥æ–¹å¼æœ‰å¤šç§åè®®å®ç°ï¼Œä¾‹å¦‚ Dubbo ( é»˜è®¤åè®® )ã€Hessian ã€Rest ç­‰ç­‰ã€‚æˆ‘ä»¬ä¼šæ¯ä¸ªåè®®å¯¹åº”ä¸€ç¯‡æ–‡ç« ï¼Œè¿›è¡Œåˆ†äº«ã€‚

# 2. createProxy

æœ¬åœ°å¼•ç”¨æœåŠ¡çš„é¡ºåºå›¾å¦‚ä¸‹ï¼š

![æœ¬åœ°å¼•ç”¨é¡ºåºå›¾](http://static2.iocoder.cn/images/Dubbo/2018_05_01/02.png)

åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” API é…ç½®ï¼ˆä¸‰ï¼‰ä¹‹æœåŠ¡æ¶ˆè´¹è€…ã€‹](http://svip.iocoder.cn/Dubbo/configuration-api-3/?self) ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°

ReferenceConfig/#init()
æ–¹æ³•ä¸­ï¼Œä¼šåœ¨é…ç½®åˆå§‹åŒ–å®Œæˆåï¼Œè°ƒç”¨é¡ºåºå›¾çš„**èµ·ç‚¹**

/#createProxy(map)
æ–¹æ³•ï¼Œå¼€å§‹å¼•ç”¨æœåŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* è‡ªé€‚åº” Protocol å®ç°å¯¹è±¡
/*/
private static final Protocol refprotocol = ExtensionLoader.getExtensionLoader(Protocol.class).getAdaptiveExtension();
//*/*
/* è‡ªé€‚åº” ProxyFactory å®ç°å¯¹è±¡
/*/
private static final ProxyFactory proxyFactory = ExtensionLoader.getExtensionLoader(ProxyFactory.class).getAdaptiveExtension();
//*/*
/* ç›´è¿æœåŠ¡æä¾›è€…åœ°å€
/*/
// url for peer-to-peer invocation
private String url;
1: private T createProxy(Map<String, String> map){
2: URL tmpUrl = new URL("temp", "localhost", 0, map);
3: // æ˜¯å¦æœ¬åœ°å¼•ç”¨
4: final boolean isJvmRefer;
5: // injvm å±æ€§ä¸ºç©ºï¼Œä¸é€šè¿‡è¯¥å±æ€§åˆ¤æ–­
6: if (isInjvm() == null) {
7: // ç›´è¿æœåŠ¡æä¾›è€…ï¼Œå‚è§æ–‡æ¡£ã€Šç›´è¿æä¾›è€…ã€‹http://dubbo.apache.org/zh-cn/docs/user/demos/explicit-target.html
8: if (url != null && url.length() > 0) { // if a url is specified, don't do local reference
9: isJvmRefer = false;
10: // é€šè¿‡ `tmpUrl` åˆ¤æ–­ï¼Œæ˜¯å¦éœ€è¦æœ¬åœ°å¼•ç”¨
11: } else if (InjvmProtocol.getInjvmProtocol().isInjvmRefer(tmpUrl)) {
12: // by default, reference local service if there is
13: isJvmRefer = true;
14: // é»˜è®¤ä¸æ˜¯
15: } else {
16: isJvmRefer = false;
17: }
18: // é€šè¿‡ injvm å±æ€§ã€‚
19: } else {
20: isJvmRefer = isInjvm();
21: }
22:
23: // æœ¬åœ°å¼•ç”¨
24: if (isJvmRefer) {
25: // åˆ›å»ºæœåŠ¡å¼•ç”¨ URL å¯¹è±¡
26: URL url = new URL(Constants.LOCAL_PROTOCOL, NetUtils.LOCALHOST, 0, interfaceClass.getName()).addParameters(map);
27: // å¼•ç”¨æœåŠ¡ï¼Œè¿”å› Invoker å¯¹è±¡
28: invoker = refprotocol.refer(interfaceClass, url);
29: if (logger.isInfoEnabled()) {
30: logger.info("Using injvm service " + interfaceClass.getName());
31: }
32: // æ­£å¸¸æµç¨‹ï¼Œä¸€èˆ¬ä¸ºè¿œç¨‹å¼•ç”¨
33: } else {
34: // ... çœç•¥æœ¬æ–‡æš‚æ—¶ä¸åˆ†äº«çš„æœåŠ¡è¿œç¨‹å¼•ç”¨
35: }
36: }
37:
38: // å¯åŠ¨æ—¶æ£€æŸ¥
39: Boolean c = check;
40: if (c == null && consumer != null) {
41: c = consumer.isCheck();
42: }
43: if (c == null) {
44: c = true; // default true
45: }
46: if (c && !invoker.isAvailable()) {
47: throw new IllegalStateException("Failed to check the status of the service " + interfaceName + ". No provider available for the service " + (group == null ? "" : group + "/") + interfaceName + (version == null ? "" : ":" + version) + " from the url " + invoker.getUrl() + " to the consumer " + NetUtils.getLocalHost() + " use dubbo version " + Version.getVersion());
48: }
49: if (logger.isInfoEnabled()) {
50: logger.info("Refer dubbo service " + interfaceClass.getName() + " from url " + invoker.getUrl());
51: }
52:
53: // åˆ›å»º Service ä»£ç†å¯¹è±¡
54: // create service proxy
55: return (T) proxyFactory.getProxy(invoker);
56: }
```

* map
æ–¹æ³•å‚æ•°ï¼ŒURL å‚æ•°é›†åˆï¼ŒåŒ…å«æœåŠ¡å¼•ç”¨é…ç½®å¯¹è±¡çš„é…ç½®é¡¹ã€‚
* ============ åˆ†å‰²çº¿ ============
* ç¬¬ 2 è¡Œï¼šåˆ›å»º URL å¯¹è±¡ï¼Œé‡ç‚¹åœ¨**ç¬¬å››ä¸ªå‚æ•°**ï¼Œä¼ å…¥çš„æ˜¯

map
ï¼Œä»…ç”¨äºç¬¬ 11 è¡Œï¼Œæ˜¯å¦æœ¬åœ°å¼•ç”¨ã€‚

* protocol = temp
çš„åŸå› æ˜¯ï¼Œåœ¨ç¬¬ 11 è¡Œï¼Œå·²ç»ç›´æ¥ä½¿ç”¨äº† InjvmProtocol ï¼Œè€Œä¸éœ€è¦é€šè¿‡è¯¥å€¼å»è·å–ã€‚
* ç¬¬ 4 è¡Œï¼šæ˜¯å¦æœ¬åœ°å¼•ç”¨å˜é‡

isJvmRefer
ã€‚
* ç¬¬ 19 è¡Œ è‡³ 20 è¡Œï¼šè°ƒç”¨

/#isInjvm()
æ–¹æ³•ï¼Œè¿”å›**éç©º**ï¼Œè¯´æ˜é…ç½®äº†

injvm
é…ç½®é¡¹ï¼Œç›´æ¥ä½¿ç”¨é…ç½®é¡¹ã€‚
* ç¬¬ 8 è‡³ 9 è¡Œï¼šé…ç½®äº†

url
é…ç½®é¡¹ï¼Œè¯´æ˜ä½¿ç”¨ç›´è¿æœåŠ¡æä¾›è€…çš„åŠŸèƒ½ï¼Œåˆ™ä¸ä½¿ç”¨æœ¬åœ°ä½¿ç”¨ã€‚

* [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” ç›´è¿æä¾›è€…ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/explicit-target.html)
* ç¬¬ 11 è‡³ 13 è¡Œï¼šè°ƒç”¨

InjvmProtocol/#isInjvmRefer(url)
æ–¹æ³•ï¼Œé€šè¿‡

tmpUrl
åˆ¤æ–­ï¼Œæ˜¯å¦éœ€è¦æœ¬åœ°å¼•ç”¨ã€‚ä½¿ç”¨

tmpUrl
ï¼Œç›¸å½“äºä½¿ç”¨æœåŠ¡å¼•ç”¨é…ç½®å¯¹è±¡çš„é…ç½®é¡¹ã€‚è¯¥æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š
```
1: //*/*
2: /* æ˜¯å¦æœ¬åœ°å¼•ç”¨
3: /*
4: /* @param url URL
5: /* @return æ˜¯å¦
6: /*/
7: public boolean isInjvmRefer(URL url){
8: final boolean isJvmRefer;
9: String scope = url.getParameter(Constants.SCOPE_KEY);
10: // Since injvm protocol is configured explicitly, we don't need to set any extra flag, use normal refer process.
11: // å½“ `protocol = injvm` æ—¶ï¼Œæœ¬èº«å·²ç»æ˜¯ jvm åè®®äº†ï¼Œèµ°æ­£å¸¸æµç¨‹å°±æ˜¯äº†ã€‚
12: if (Constants.LOCAL_PROTOCOL.toString().equals(url.getProtocol())) {
13: isJvmRefer = false;
14: // å½“ `scope = local` æˆ–è€… `injvm = true` æ—¶ï¼Œæœ¬åœ°å¼•ç”¨
15: } else if (Constants.SCOPE_LOCAL.equals(scope) || (url.getParameter("injvm", false))) {
16: // if it's declared as local reference
17: // 'scope=local' is equivalent to 'injvm=true', injvm will be deprecated in the future release
18: isJvmRefer = true;
19: // å½“ `scope = remote` æ—¶ï¼Œè¿œç¨‹å¼•ç”¨
20: } else if (Constants.SCOPE_REMOTE.equals(scope)) {
21: // it's declared as remote reference
22: isJvmRefer = false;
23: // å½“ `generic = true` æ—¶ï¼Œå³ä½¿ç”¨æ³›åŒ–è°ƒç”¨ï¼Œè¿œç¨‹å¼•ç”¨ã€‚
24: } else if (url.getParameter(Constants.GENERIC_KEY, false)) {
25: // generic invocation is not local reference
26: isJvmRefer = false;
27: // å½“æœ¬åœ°å·²ç»æœ‰è¯¥ Exporter æ—¶ï¼Œæœ¬åœ°å¼•ç”¨
28: } else if (getExporter(exporterMap, url) != null) {
29: // by default, go through local reference if there's the service exposed locally
30: isJvmRefer = true;
31: // é»˜è®¤ï¼Œè¿œç¨‹å¼•ç”¨
32: } else {
33: isJvmRefer = false;
34: }
35: return isJvmRefer;
36: }
```

* ============ æœ¬åœ°å¼•ç”¨ ============

* ç¬¬ 15 è‡³ 18 è¡Œï¼šå½“

scope = local
æˆ–

injvm = true
æ—¶ï¼Œæœ¬åœ°å¼•ç”¨ã€‚
* ç¬¬ 27 è‡³ 30 è¡Œï¼šè°ƒç”¨

/#getExporter(url)
æ–¹æ³•ï¼Œåˆ¤æ–­å½“æœ¬åœ°å·²ç»æœ‰

url
å¯¹åº”çš„ InjvmExporter æ—¶ï¼Œ**ç›´æ¥**å¼•ç”¨ã€‚ğŸ™‚ æœ¬åœ°å·²æœ‰çš„æœåŠ¡ï¼Œä¸å¿…è¦ä½¿ç”¨è¿œç¨‹æœåŠ¡ï¼Œå‡å°‘ç½‘ç»œå¼€é”€ï¼Œæå‡æ€§èƒ½ã€‚

* ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œå·²ç»æ·»åŠ ä¸­æ–‡æ³¨é‡Šï¼Œèƒ–å‹ç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚
* [
InjvmProtocol/#getExporter(url)
](https://github.com/YunaiV/dubbo/blob/6f366fae76b4fc5fc4fb0352737b6e847a3a2b0b/dubbo-rpc/dubbo-rpc-injvm/src/main/java/com/alibaba/dubbo/rpc/protocol/injvm/InjvmProtocol.java#L63-L94)
* [
UrlUtils/#isServiceKeyMatch(pattern, value)
](https://github.com/YunaiV/dubbo/blob/6f366fae76b4fc5fc4fb0352737b6e847a3a2b0b/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/UrlUtils.java#L462-L491)
* ============ è¿œç¨‹å¼•ç”¨ ============
* ç¬¬ 10 è‡³ 13 è¡Œï¼šå½“

protocol = injvm
æ—¶ï¼Œæœ¬èº«å·²ç»æ˜¯ Injvm åè®®äº†ï¼Œèµ°æ­£å¸¸æµç¨‹å³å¯ã€‚**è¿™æ˜¯æœ€ç‰¹æ®Šçš„ï¼Œä¸‹é¢ä¼šæ›´å¥½çš„ç†è§£**ã€‚å¦å¤–ï¼Œå› ä¸º

/#isInjvmRefer(url)
æ–¹æ³•ï¼Œä»…æœ‰åœ¨

/#createProxy(map)
æ–¹æ³•ä¸­è°ƒç”¨ï¼Œå› æ­¤å®é™…ä¹Ÿä¸ä¼šè§¦å‘è¯¥é€»è¾‘ã€‚
* ç¬¬ 19 è‡³ 22 è¡Œï¼šå½“

scope = remote
æ—¶ï¼Œè¿œç¨‹å¼•ç”¨ã€‚
* ç¬¬ 23 è‡³ 26 è¡Œï¼šå½“

generic = true
æ—¶ï¼Œå³ä½¿ç”¨æ³›åŒ–è°ƒç”¨ï¼Œè¿œç¨‹å¼•ç”¨ã€‚

* [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” æ³›åŒ–è°ƒç”¨ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/generic-reference.html)
* ç¬¬ 31 è‡³ 34 è¡Œï¼šé»˜è®¤ï¼Œè¿œç¨‹å¼•ç”¨ã€‚
* ç¬¬ 23 è‡³ 31 è¡Œï¼š**æœ¬åœ°å¼•ç”¨**ã€‚

* ç¬¬ 26 è¡Œï¼šåˆ›å»ºæœ¬åœ°æœåŠ¡å¼•ç”¨ URL å¯¹è±¡ã€‚
* ç¬¬ 28 è¡Œï¼šè°ƒç”¨

Protocol/#refer(interface, url)
æ–¹æ³•ï¼Œå¼•ç”¨æœåŠ¡ï¼Œè¿”å› Invoker å¯¹è±¡ã€‚

* æ­¤å¤„ Dubbo SPI **è‡ªé€‚åº”**çš„ç‰¹æ€§çš„**å¥½å¤„**å°±å‡ºæ¥äº†ï¼Œå¯ä»¥**è‡ªåŠ¨**æ ¹æ® URL å‚æ•°ï¼Œè·å¾—å¯¹åº”çš„æ‹“å±•å®ç°ã€‚ä¾‹å¦‚ï¼Œ

invoker
ä¼ å…¥åï¼Œæ ¹æ®

invoker.url
è‡ªåŠ¨è·å¾—å¯¹åº” Protocol æ‹“å±•å®ç°ä¸º InjvmProtocol ã€‚
* å®é™…ä¸Šï¼ŒProtocol æœ‰ä¸¤ä¸ª Wrapper æ‹“å±•å®ç°ç±»ï¼š ProtocolFilterWrapperã€ProtocolListenerWrapper ã€‚æ‰€ä»¥ï¼Œ

/#refer(...)
æ–¹æ³•çš„è°ƒç”¨é¡ºåºæ˜¯ï¼š**Protocol$Adaptive => ProtocolFilterWrapper => ProtocolListenerWrapper => InjvmProtocol** ã€‚
* ğŸ™‚ è¯¦ç»†çš„è°ƒç”¨ï¼Œåœ¨ [ã€Œ3. Protocolã€](http://svip.iocoder.cn/Dubbo/reference-refer-local/) åœ¨è§£æã€‚
* ç¬¬ 32 è‡³ 36 è¡Œï¼šæ­£å¸¸æµç¨‹ï¼Œä¸€èˆ¬ä¸º**è¿œç¨‹å¼•ç”¨**ã€‚ä¸ºä»€ä¹ˆæ˜¯**ä¸€èˆ¬**å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬é…ç½®

protocol = injvm
ï¼Œå®é™…èµ°çš„æ˜¯**æœ¬åœ°å¼•ç”¨**ã€‚ä¾‹å¦‚ï¼š
```
<dubbo:reference protocol="injvm" >
</dubbo:reference>
```

* ğŸŒ å½“ç„¶ï¼Œç¬”è€…å»ºè®®ï¼Œå¦‚æœçœŸçš„æ˜¯éœ€è¦æœ¬åœ°åº”ç”¨ï¼Œå»ºè®®é…ç½®

scope = local
ã€‚è¿™æ ·ï¼Œä¼šæ›´åŠ æ˜ç¡®å’Œæ¸…æ™°ã€‚
* ç¬¬ 38 è‡³ 51 è¡Œï¼šè‹¥é…ç½®

check = true
é…ç½®é¡¹æ—¶ï¼Œè°ƒç”¨

Invoker/#isAvailable()
æ–¹æ³•ï¼Œå¯åŠ¨æ—¶æ£€æŸ¥ã€‚

* ğŸ™‚ è¯¥æ–¹æ³•åœ¨ [ã€Œ4.2 InjvmInvokerã€](http://svip.iocoder.cn/Dubbo/reference-refer-local/) ï¼Œè¯¦ç»†åˆ†äº«ã€‚
* ğŸ™‚ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” å¯åŠ¨æ—¶æ£€æŸ¥ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/preflight-check.html)
* ç¬¬ 55 è¡Œï¼šè°ƒç”¨

ProxyFactory/#getProxy(invoker)
æ–¹æ³•ï¼Œåˆ›å»º Service ä»£ç†å¯¹è±¡ã€‚è¯¥ Service ä»£ç†å¯¹è±¡çš„å†…éƒ¨ï¼Œä¼šè°ƒç”¨

Invoker/#invoke(Invocation)
æ–¹æ³•ï¼Œè¿›è¡Œ Dubbo æœåŠ¡çš„è°ƒç”¨ã€‚

* ğŸ™‚ è¯¦ç»†çš„å®ç°ï¼Œåé¢å•ç‹¬å†™æ–‡ç« åˆ†äº«ã€‚

# 3. Protocol

**æœåŠ¡å¼•ç”¨ä¸æš´éœ²çš„ Protocol å¾ˆå¤šç±»ä¼¼ç‚¹**ï¼Œæœ¬æ–‡å°±ä¸é‡å¤å™è¿°äº†ã€‚

å»ºè®®ä¸ç†Ÿæ‚‰çš„èƒ–å‹ï¼Œè¯·ç‚¹å‡» [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æœåŠ¡æš´éœ²ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°æš´éœ²ï¼ˆInjvmï¼‰ã€‹ã€Œ3. Protocolã€](http://svip.iocoder.cn/Dubbo/service-export-local/?self) æŸ¥çœ‹ã€‚

æœ¬æ–‡æ¶‰åŠçš„ Protocol ç±»å›¾å¦‚ä¸‹ï¼š

![Protocol ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_05_01/04.png)

## 3.1 ProtocolFilterWrapper

### 3.1.1 refer

æœ¬æ–‡æ¶‰åŠçš„

/#refer(type, url)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
1: public <T> Invoker<T> refer(Class<T> type, URL url) throws RpcException{
2: // æ³¨å†Œä¸­å¿ƒ
3: if (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) {
4: return protocol.refer(type, url);
5: }
6: // å¼•ç”¨æœåŠ¡ï¼Œè¿”å› Invoker å¯¹è±¡
7: // ç»™æ”¹ Invoker å¯¹è±¡ï¼ŒåŒ…è£…æˆå¸¦æœ‰ Filter è¿‡æ»¤é“¾çš„ Invoker å¯¹è±¡
8: return buildInvokerChain(protocol.refer(type, url), Constants.REFERENCE_FILTER_KEY, Constants.CONSUMER);
9: }
```

* ç¬¬ 2 è‡³ 5 è¡Œï¼šå½“

invoker.url.protocl = registry
ï¼Œè·³è¿‡ï¼Œæœ¬åœ°å¼•ç”¨æœåŠ¡ä¸ä¼šç¬¦åˆè¿™ä¸ªåˆ¤æ–­ã€‚åœ¨è¿œç¨‹å¼•ç”¨æœåŠ¡ä¼šç¬¦åˆæš´éœ²è¯¥åˆ¤æ–­ï¼Œæ‰€ä»¥ä¸‹ä¸€ç¯‡æ–‡ç« åˆ†äº«ã€‚
* ç¬¬ 8 è¡Œï¼šè°ƒç”¨

protocol/#refer(type, url)
æ–¹æ³•ï¼Œç»§ç»­å¼•ç”¨æœåŠ¡ï¼Œæœ€ç»ˆè¿”å› Invoker ã€‚
* ç¬¬ 8 è¡Œï¼šåœ¨å¼•ç”¨æœåŠ¡å®Œæˆåï¼Œè°ƒç”¨

/#buildInvokerChain(invoker, key, group)
æ–¹æ³•ï¼Œåˆ›å»ºå¸¦æœ‰ Filter è¿‡æ»¤é“¾çš„ Invoker å¯¹è±¡ã€‚

### 3.1.2 buildInvokerChain

å’Œ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æœåŠ¡æš´éœ²ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°æš´éœ²ï¼ˆInjvmï¼‰ã€‹ã€Œ3.1.3 buildInvokerChainã€](http://svip.iocoder.cn/Dubbo/service-export-local/?self) åŸºæœ¬ä¸€è‡´ï¼Œ**é»˜è®¤æƒ…å†µä¸‹**ï¼Œè·å¾—çš„ Filter æ•°ç»„å¦‚ä¸‹ï¼š

* ConsumerContextFilter
* FutureFilter
* MonitorFilter

å½“ç„¶ï¼Œå› ä¸ºä¼ å…¥çš„å‚æ•°

group
ä¸åŒï¼Œå¦‚æœèƒ–å‹è‡ªå®šä¹‰äº†**è‡ªåŠ¨æ¿€æ´»**çš„ Filter åªå‡ºç°åœ¨

group = consumer
ï¼Œé‚£ä¹ˆæœåŠ¡æ¶ˆè´¹è€…å°±ä¼šå¤šä¸€ä¸ªè¯¥ Filter å®ç°ã€‚

## 3.2 ProtocolListenerWrapper

æœ¬æ–‡æ¶‰åŠçš„

/#refer(type, url)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
1: public <T> Invoker<T> refer(Class<T> type, URL url) throws RpcException{
2: // æ³¨å†Œä¸­å¿ƒåè®®
3: if (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) {
4: return protocol.refer(type, url);
5: }
6: // å¼•ç”¨æœåŠ¡
7: Invoker<T> invoker = protocol.refer(type, url);
8: // è·å¾— InvokerListener æ•°ç»„
9: List<InvokerListener> listeners = Collections.unmodifiableList(ExtensionLoader.getExtensionLoader(InvokerListener.class).getActivateExtension(url, Constants.INVOKER_LISTENER_KEY));
10: // åˆ›å»º ListenerInvokerWrapper å¯¹è±¡
11: return new ListenerInvokerWrapper<T>(invoker, listeners);
12: }
```

* ç¬¬ 2 è‡³ 5 è¡Œï¼šå½“

invoker.url.protocl = registry
ï¼Œè·³è¿‡ï¼Œæœ¬åœ°å¼•ç”¨æœåŠ¡ä¸ä¼šç¬¦åˆè¿™ä¸ªåˆ¤æ–­ã€‚åœ¨è¿œç¨‹å¼•ç”¨æœåŠ¡ä¼šç¬¦åˆæš´éœ²è¯¥åˆ¤æ–­ï¼Œæ‰€ä»¥ä¸‹ä¸€ç¯‡æ–‡ç« åˆ†äº«ã€‚
* ç¬¬ 7 è¡Œï¼šè°ƒç”¨

protocol/#refer(type, url)
æ–¹æ³•ï¼Œç»§ç»­å¼•ç”¨æœåŠ¡ï¼Œæœ€ç»ˆè¿”å› Invoker ã€‚
* ç¬¬ 9 è¡Œï¼šè°ƒç”¨

ExtensionLoader/#getActivateExtension(url, key, group)
æ–¹æ³•ï¼Œè·å¾—ç›‘å¬å™¨æ•°ç»„ã€‚

* ğŸ™‚ ä¸ç†Ÿæ‚‰çš„èƒ–å‹ï¼Œè¯·çœ‹ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ‹“å±•æœºåˆ¶ SPIã€‹](http://svip.iocoder.cn/Dubbo/spi/?self) æ–‡ç« ã€‚
* ç»§ç»­ä»¥ä¸Šé¢çš„ä¾‹å­ä¸ºåŸºç¡€ï¼Œ

listeners
ä¸º**ç©º**ã€‚èƒ–å‹å¯ä»¥è‡ªè¡Œå®ç° ExporterListener ï¼Œå¹¶è¿›è¡Œé…ç½®

@Activate
æ³¨è§£ï¼Œæˆ–è€… XML ä¸­

listener
å±æ€§ã€‚
* ç¬¬ 11 è¡Œï¼šåˆ›å»ºå¸¦ InvokerListener çš„ ListenerInvokerWrapper å¯¹è±¡ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œ

ExporterListener/#referred(invoker)
æ–¹æ³•ã€‚

* ğŸ™‚ åœ¨ [ã€Œ4.3 ListenerInvokerWrapperã€](http://svip.iocoder.cn/Dubbo/reference-refer-local/) è¯¦ç»†è§£æã€‚

## 3.3 InjvmProtocol

æœ¬æ–‡æ¶‰åŠçš„

/#refer(type, url)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
public <T> Invoker<T> refer(Class<T> serviceType, URL url) throws RpcException{
return new InjvmInvoker<T>(serviceType, url, url.getServiceKey(), exporterMap);
}
```

* åˆ›å»º InjvmInvoker å¯¹è±¡ã€‚**æ³¨æ„**ï¼Œä¼ å…¥çš„

exporterMap
å‚æ•°ï¼ŒåŒ…å«**æ‰€æœ‰çš„** InjvmExporter å¯¹è±¡ã€‚

# 4. Invoker

Exporter **æ¥å£**ï¼Œåœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ ¸å¿ƒæµç¨‹ä¸€è§ˆã€‹ã€Œ4.1 Invokerã€](http://svip.iocoder.cn/Dubbo/reference-refer-local/) æœ‰è¯¦ç»†è§£æã€‚

æœ¬æ–‡æ¶‰åŠçš„ Invoker ç±»å›¾å¦‚ä¸‹ï¼š

![Invoker ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_05_01/05.png)

## 4.1 AbstractInvoker

[
com.alibaba.dubbo.rpc.protocol.AbstractInvoker
](https://github.com/YunaiV/dubbo/blob/6f366fae76b4fc5fc4fb0352737b6e847a3a2b0b/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/protocol/AbstractInvoker.java) ï¼Œå®ç° Invoker æ¥å£ï¼ŒæŠ½è±¡ Invoker ç±»ï¼Œä¸»è¦æä¾›äº† Invoker çš„é€šç”¨å±æ€§å’Œ

/#invoke(Invocation)
æ–¹æ³•çš„é€šç”¨å®ç°ã€‚

æœ¬æ–‡ä¸»è¦æ¶‰åŠåˆ°å®ƒçš„é€šç”¨å±æ€§ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* æ¥å£ç±»å‹
/*/
private final Class<T> type;
//*/*
/* æœåŠ¡ URL
/*/
private final URL url;
//*/*
/* å…¬ç”¨çš„éšå¼ä¼ å‚ã€‚åœ¨ {@link /#invoke(Invocation)} æ–¹æ³•ä¸­ä½¿ç”¨ã€‚
/*/
private final Map<String, String> attachment;
//*/*
/* æ˜¯å¦å¯ç”¨
/*/
private volatile boolean available = true;
//*/*
/* æ˜¯å¦é”€æ¯
/*/
private AtomicBoolean destroyed = new AtomicBoolean(false);
```

psï¼š

/#invoke(Invocation)
æ–¹æ³•ï¼Œåœ¨åç»­çš„æ–‡ç« åˆ†äº«ã€‚

## 4.2 InjvmInvoker

[
com.alibaba.dubbo.rpc.protocol.injvm.InjvmInvoker
](https://github.com/YunaiV/dubbo/blob/6f366fae76b4fc5fc4fb0352737b6e847a3a2b0b/dubbo-rpc/dubbo-rpc-injvm/src/main/java/com/alibaba/dubbo/rpc/protocol/injvm/InjvmInvoker.java) ï¼Œå®ç° AbstractInvoker æŠ½è±¡ç±»ï¼ŒInjvm Invoker å®ç°ç±»ã€‚

### 4.2.1 å±æ€§

```
//*/*
/* æœåŠ¡é”®
/*/
private final String key;
//*/*
/* Exporter é›†åˆ
/*
/* key: æœåŠ¡é”®
/*
/* è¯¥å€¼å®é™…å°±æ˜¯ {@link com.alibaba.dubbo.rpc.protocol.AbstractProtocol/#exporterMap}
/*/
private final Map<String, Exporter<?>> exporterMap;
InjvmInvoker(Class<T> type, URL url, String key, Map<String, Exporter<?>> exporterMap) {
super(type, url);
this.key = key;
this.exporterMap = exporterMap;
}
```

* key
å±æ€§ï¼ŒæœåŠ¡é”®ã€‚
* exporterMap
å±æ€§ï¼ŒExporter é›†åˆã€‚åœ¨

InjvmInvoker/#invoke(invocation)
æ–¹æ³•ä¸­ï¼Œé€šè¿‡è¯¥ Invoker çš„

key
å±æ€§ï¼Œè·å¾—å¯¹åº”çš„ Exporter å¯¹è±¡ã€‚

### 4.2.2 isAvailable

/#isAvailable()
æ–¹æ³•ï¼Œæ˜¯å¦å¯ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
@Override
public boolean isAvailable(){
// åˆ¤æ–­æ˜¯å¦æœ‰ Exporter å¯¹è±¡
InjvmExporter<?> exporter = (InjvmExporter<?>) exporterMap.get(key);
if (exporter == null) {
return false;
} else {
return super.isAvailable();
}
}
```

* å¼€å¯ [å¯åŠ¨æ—¶æ£€æŸ¥](http://dubbo.apache.org/zh-cn/docs/user/demos/preflight-check.html) æ—¶ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼Œåˆ¤æ–­è¯¥ Invoker å¯¹è±¡ï¼Œæ˜¯å¦æœ‰å¯¹åº”çš„ Exporter ã€‚è‹¥ä¸å­˜åœ¨ï¼Œ**è¯´æ˜ä¾èµ–æœåŠ¡ä¸å­˜åœ¨**ï¼Œæ£€æŸ¥ä¸é€šè¿‡ã€‚

## 4.3 ListenerInvokerWrapper

[
com.alibaba.dubbo.rpc.listener.ListenerInvokerWrapper
](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/listener/ListenerInvokerWrapper.java) ï¼Œå®ç° Invoker æ¥å£ï¼Œå…·æœ‰ç›‘å¬å™¨åŠŸèƒ½çš„ Invoker åŒ…è£…å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public class ListenerInvokerWrapper<T> implements Invoker<T>{
private static final Logger logger = LoggerFactory.getLogger(ListenerInvokerWrapper.class);
//*/*
/* çœŸå®çš„ Invoker å¯¹è±¡
/*/
private final Invoker<T> invoker;
//*/*
/* Invoker ç›‘å¬å™¨æ•°ç»„
/*/
private final List<InvokerListener> listeners;
public ListenerInvokerWrapper(Invoker<T> invoker, List<InvokerListener> listeners){
if (invoker == null) {
throw new IllegalArgumentException("invoker == null");
}
this.invoker = invoker;
this.listeners = listeners;
// æ‰§è¡Œç›‘å¬å™¨
if (listeners != null && !listeners.isEmpty()) {
for (InvokerListener listener : listeners) {
if (listener != null) {
try {
listener.referred(invoker);
} catch (Throwable t) {
logger.error(t.getMessage(), t);
}
}
}
}
}
public Class<T> getInterface(){
return invoker.getInterface();
}
public URL getUrl(){
return invoker.getUrl();
}
public boolean isAvailable(){
return invoker.isAvailable();
}
public Result invoke(Invocation invocation) throws RpcException{
return invoker.invoke(invocation);
}
@Override
public String toString(){
return getInterface() + " -> " + (getUrl() == null ? " " : getUrl().toString());
}
public void destroy(){
try {
invoker.destroy();
} finally {
// æ‰§è¡Œç›‘å¬å™¨
if (listeners != null && !listeners.isEmpty()) {
for (InvokerListener listener : listeners) {
if (listener != null) {
try {
listener.destroyed(invoker);
} catch (Throwable t) {
logger.error(t.getMessage(), t);
}
}
}
}
}
}
}
```

* **æ„é€ æ–¹æ³•**ï¼Œå¾ªç¯

listeners
ï¼Œæ‰§è¡Œ

InvokerListener/#referred(invoker)
æ–¹æ³•ã€‚ğŸ˜ˆ å’Œ ListenerExporterWrapper ä¸åŒï¼Œè‹¥æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ RuntimeException ï¼Œ**ä»…**æ‰“å°é”™è¯¯æ—¥å¿—ï¼Œç»§ç»­æ‰§è¡Œï¼Œæœ€ç»ˆ**ä¸**æŠ›å‡ºå¼‚å¸¸ã€‚
* /#unexport()
æ–¹æ³•ï¼Œå¾ªç¯

listeners
ï¼Œæ‰§è¡Œ

InvokerListener/#destroyed(invoker)
ã€‚ğŸ˜ˆ å’Œ ListenerExporterWrapper ä¸åŒï¼Œè‹¥æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ RuntimeException ï¼Œ**ä»…**æ‰“å°é”™è¯¯æ—¥å¿—ï¼Œç»§ç»­æ‰§è¡Œï¼Œæœ€ç»ˆ**ä¸**æŠ›å‡ºå¼‚å¸¸ã€‚

# 5. InvokerListener

[
com.alibaba.dubbo.rpc.InvokerListener
](https://github.com/YunaiV/dubbo/blob/6de0a069fcc870894e64ffd54a24e334b19dcb36/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/InvokerListener.java) ï¼ŒInvoker ç›‘å¬å™¨ã€‚

ä»£ç å¦‚ä¸‹ï¼š
```
@SPI
public interface InvokerListener{
//*/*
/* The invoker referred
/*
/* å½“æœåŠ¡å¼•ç”¨å®Œæˆ
/*
/* @param invoker
/* @throws RpcException
/* @see com.alibaba.dubbo.rpc.Protocol/#refer(Class, URL)
/*/
void referred(Invoker<?> invoker) throws RpcException;
//*/*
/* The invoker destroyed.
/*
/* å½“æœåŠ¡é”€æ¯å¼•ç”¨å®Œæˆ
/*
/* @param invoker
/* @see com.alibaba.dubbo.rpc.Invoker/#destroy()
/*/
void destroyed(Invoker<?> invoker);
}
```

![InvokerListener å­ç±»](http://static2.iocoder.cn/images/Dubbo/2018_03_01/16.png)

## 5.1 InvokerListenerAdapter

com.alibaba.dubbo.rpc.listener.InvokerListenerAdapter
ï¼Œå®ç° InvokerListener æ¥å£ï¼ŒInvokerListener é€‚é…å™¨**æŠ½è±¡ç±»**ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public abstract class InvokerListenerAdapter implements InvokerListener{
public void referred(Invoker<?> invoker) throws RpcException{ }
public void destroyed(Invoker<?> invoker){ }
}
```

## 5.2 DeprecatedInvokerListener

com.alibaba.dubbo.rpc.listener.DeprecatedInvokerListener
ï¼Œå®ç° InvokerListenerAdapter **æŠ½è±¡ç±»** ï¼Œå¼•ç”¨åºŸå¼ƒçš„æœåŠ¡æ—¶ï¼Œæ‰“å°é”™è¯¯æ—¥å¿—æé†’ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
@Activate(Constants.DEPRECATED_KEY)
public class DeprecatedInvokerListener extends InvokerListenerAdapter{
private static final Logger LOGGER = LoggerFactory.getLogger(DeprecatedInvokerListener.class);
public void referred(Invoker<?> invoker) throws RpcException{
if (invoker.getUrl().getParameter(Constants.DEPRECATED_KEY, false)) {
LOGGER.error("The service " + invoker.getInterface().getName() + " is DEPRECATED! Declare from " + invoker.getUrl());
}
}
}
```

* @Activate(Constants.DEPRECATED_KEY)
æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Activate æœºåˆ¶åŠ è½½ã€‚é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š
```
<dubbo:service interface="com.alibaba.dubbo.demo.DemoService" ref="demoService" deprecated="true" />
```
/* é€šè¿‡è®¾ç½® `"deprecated"` ä¸º `true` æ¥è®¾ç½®ã€‚
/* è¯¥æ–¹å¼ä»…é€‚ç”¨äº/*/*è¿œç¨‹å¼•ç”¨/*/*æœåŠ¡ã€‚
/* åœ¨ `/#referred(invoker)` æ–¹æ³•ä¸­ï¼Œæ‰“å°é”™è¯¯æ—¥å¿—ï¼Œä¾‹å¦‚ï¼š
```Java
[25/03/18 07:37:56:056 CST] main ERROR listener.DeprecatedInvokerListener: [DUBBO] The service com.alibaba.dubbo.demo.DemoService is DEPRECATED! Declare from dubbo://192.168.3.17:20880/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-consumer&check=false&compiler=jdk&default.delay=-1&default.retries=0&delay=-1&deprecated=true&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello,bye&pid=45155&qos.port=33333&register.ip=192.168.3.17&remote.timestamp=1521977820764&service.filter=demo&side=consumer&timestamp=1521977854685, dubbo version: 2.0.0, current host: 192.168.3.17
group:consumer
```

å¦å¤–ï¼Œ**æœ¬åœ°å¼•ç”¨**æœåŠ¡çš„é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š
```
<dubbo:reference id="demoService" interface="com.alibaba.dubbo.demo.DemoService" protocol="injvm">
<dubbo:parameter key="deprecated" value="true" />
</dubbo:reference>
```

* å› ä¸ºï¼Œæœ¬åœ°å¼•ç”¨æœåŠ¡æ—¶ï¼Œä¸æ˜¯ä½¿ç”¨æœåŠ¡æä¾›è€…çš„ URL ï¼Œè€Œæ˜¯æœåŠ¡æ¶ˆè´¹è€…çš„ URL ã€‚