# åºåˆ—åŒ–ï¼ˆäºŒï¼‰ä¹‹ Dubbo å®ç°

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«åŸºäº Dubbo **è‡ªå·±å®ç°**çš„åºåˆ—åŒ–æ‹“å±•ã€‚è¦å®ç°åºåˆ—åŒ–çš„é«˜æ€§èƒ½ï¼Œéœ€è¦è€ƒè™‘ä¸¤æ–¹é¢ï¼š

* åºåˆ—åŒ–å’Œååºåˆ—åŒ–**é€Ÿåº¦å¿«**
* ä»**ä¼ è¾“**è§’åº¦ï¼Œæ•°æ®å‹ç¼©æ•ˆæœå¥½ï¼Œå³åºåˆ—åŒ–åçš„æ•°æ®é‡**ä½“ç§¯å°**
æ—ç™½å›ï¼šä»ä»¥ä¸‹å¼€å§‹ï¼Œ**Dubbo æŒ‡çš„æ˜¯ Dubbo åºåˆ—åŒ–æ‹“å±•**ï¼Œè€Œä¸æ˜¯ Dubbo PRC æ¡†æ¶ã€‚è¯·æ³¨æ„ã€‚

åœ¨ [ã€Šç”¨æˆ·æŒ‡å— â€”â€” æ€§èƒ½æµ‹è¯•æŠ¥å‘Šã€‹](http://dubbo.apache.org/zh-cn/docs/user/perf-test.html) å’Œ [ã€Šåœ¨Dubboä¸­ä½¿ç”¨é«˜æ•ˆçš„Javaåºåˆ—åŒ–ï¼ˆKryoå’ŒFSTï¼‰ã€‹](https://dangdangdotcom.github.io/dubbox/serialization.html) ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒDubbo æ˜¯ä¸€ç§ç›¸å¯¹ä¼˜ç§€çš„å®ç°æ–¹å¼ã€‚è™½ç„¶ï¼Œåœ¨æœ€æ–°ç‰ˆæœ¬çš„ Dubbo é¡¹ç›®ä¸­ï¼Œ

dubbo-serialize
æ¨¡å—å·²ç»å»é™¤äº† Dubbo åºåˆ—åŒ–çš„å®ç°ï¼ŒçŒœæµ‹å› ä¸ºå¼•å…¥ Kryo å’Œ FST ï¼Œç›¸æ¯”æ¥è¯´æ›´ä¼˜ç§€ã€‚

å½“ç„¶ï¼Œå³ä½¿å¦‚æ­¤ï¼Œè‰¿è‰¿è§‰å¾—äº†è§£ä¸‹ Dubbo åºåˆ—åŒ–æ˜¯å¦‚ä½•å®ç°çš„ï¼Œ**æ˜¯ä¸€ç§éå¸¸æ£’çš„çœ¼ç•Œæå‡**ï¼Œç‰¹åˆ«æ˜¯åºåˆ—åŒ–çš„æ•°æ®å‹ç¼©ï¼Œåœ¨å¾ˆå¤šåœºæ™¯ä¸‹éƒ½ä¼šä½¿ç”¨ï¼Œä¾‹å¦‚ Lucene çš„æ•°æ®å­˜å‚¨ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬è·Ÿç€ä»£ç ï¼Œä¸€èµ·æ„‰å¿«çš„ç©è€æŠŠã€‚æœ¬æ–‡æ¶‰åŠä»£ç å¦‚ä¸‹ï¼š

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2019_02_18/01.png)
å†™çš„æœ‰ç‚¹åŒ†å¿™ï¼Œä¹Ÿæœ‰ç‚¹ç€æ€¥ï¼Œå¦‚æœæœ‰é”™è¯¯ï¼Œæˆ–è€…ä¸æ¸…æ™°çš„åœ°æ–¹ï¼Œè¯·å¾€æ­»é‡ŒæŠ½ï¼ˆå‘Šè¯‰ï¼‰æˆ‘ã€‚å“ˆå“ˆå“ˆã€‚

# 2. GenericDataFlags

Dubbo ï¼Œæ˜¯ä¸€ç§**æœ‰åºã€ç´§å‡‘**çš„åºåˆ—åŒ–æ–¹å¼ã€‚å¦‚ä¸‹æ˜¯åºåˆ—åŒ–åçš„äºŒè¿›åˆ¶æ•°æ®æµçš„ç¤ºæ„å›¾ï¼š

![äºŒè¿›åˆ¶æ•°æ®æµ](http://static2.iocoder.cn/images/Dubbo/2019_02_18/02.png)

* ä¸åŒäº JSON / XML ç­‰åºåˆ—åŒ–æ–¹å¼ï¼Œæ— éœ€åºåˆ—åŒ–æ¯ä¸ª**å±æ€§å**ã€‚é€šè¿‡ Builder å¯¹è±¡ï¼Œåˆ›å»ºæ¯ä¸ªç±»çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„**å…·ä½“**ä»£ç ã€‚

* è¿™æ ·ï¼Œæˆ‘ä»¬å°±é¿å…äº†**å±æ€§å**çš„åºåˆ—åŒ–ï¼Œæå‡äº†é€Ÿåº¦ï¼Œå‡å°‘äº†æ•°æ®çš„ä½“ç§¯ã€‚
* å½“ç„¶ï¼Œåè¿‡æ¥è¯´ï¼Œå¦‚æœå¯¹è±¡å‘ç”Ÿäº†**å˜åŒ–**( å¢åŠ æˆ–åˆ é™¤å±æ€§ )ï¼Œå¯èƒ½ä¼šå‡ºç° Client å’Œ Server åºåˆ—åŒ–çš„**ä¸å…¼å®¹**ï¼Œå› ä¸ºå±æ€§çš„**é¡ºåº**å‘ç”Ÿäº†å˜åŒ–ã€‚
* å±æ€§å€¼å’Œå±æ€§å€¼ä¹‹é—´**æ— é—´éš”**ï¼Œé€šè¿‡å±æ€§å€¼çš„**æ ‡å¿—ä½** Flag ä¿è¯ï¼Œä¹Ÿå°±æ˜¯æœ¬å°èŠ‚è¦åˆ†äº«çš„ GenericDataFlags ã€‚

ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ [
com.alibaba.dubbo.common.serialize.support.dubbo.GenericDataFlags
](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/GenericDataFlags.java) ï¼Œé€šç”¨æ•°æ®**æ ‡è®°ä½**æšä¸¾ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
public interface GenericDataFlags{
// prefix three bits
byte VARINT = 0, // 0 æ•°å­—
OBJECT = (byte) 0x80; // -128 å¯¹è±¡
// varint tag
byte VARINT8 = VARINT, VARINT16 = VARINT | 1, VARINT24 = VARINT | 2, VARINT32 = VARINT | 3;
byte VARINT40 = VARINT | 4, VARINT48 = VARINT | 5, VARINT56 = VARINT | 6, VARINT64 = VARINT | 7;
// varint contants
byte VARINT_NF = VARINT | 10, VARINT_NE = VARINT | 11, VARINT_ND = VARINT | 12;
byte VARINT_NC = VARINT | 13, VARINT_NB = VARINT | 14, VARINT_NA = VARINT | 15, VARINT_N9 = VARINT | 16;
byte VARINT_N8 = VARINT | 17, VARINT_N7 = VARINT | 18, VARINT_N6 = VARINT | 19, VARINT_N5 = VARINT | 20;
byte VARINT_N4 = VARINT | 21, VARINT_N3 = VARINT | 22, VARINT_N2 = VARINT | 23, VARINT_N1 = VARINT | 24;
byte VARINT_0 = VARINT | 25, VARINT_1 = VARINT | 26, VARINT_2 = VARINT | 27, VARINT_3 = VARINT | 28;
byte VARINT_4 = VARINT | 29, VARINT_5 = VARINT | 30, VARINT_6 = VARINT | 31, VARINT_7 = VARINT | 32;
byte VARINT_8 = VARINT | 33, VARINT_9 = VARINT | 34, VARINT_A = VARINT | 35, VARINT_B = VARINT | 36;
byte VARINT_C = VARINT | 37, VARINT_D = VARINT | 38, VARINT_E = VARINT | 39, VARINT_F = VARINT | 40;
byte VARINT_10 = VARINT | 41, VARINT_11 = VARINT | 42, VARINT_12 = VARINT | 43, VARINT_13 = VARINT | 44;
byte VARINT_14 = VARINT | 45, VARINT_15 = VARINT | 46, VARINT_16 = VARINT | 47, VARINT_17 = VARINT | 48;
byte VARINT_18 = VARINT | 49, VARINT_19 = VARINT | 50, VARINT_1A = VARINT | 51, VARINT_1B = VARINT | 52;
byte VARINT_1C = VARINT | 53, VARINT_1D = VARINT | 54, VARINT_1E = VARINT | 55, VARINT_1F = VARINT | 56;
// object tag
byte OBJECT_REF = OBJECT | 1, OBJECT_STREAM = OBJECT | 2, OBJECT_BYTES = OBJECT | 3;
byte OBJECT_VALUE = OBJECT | 4, OBJECT_VALUES = OBJECT | 5, OBJECT_MAP = OBJECT | 6;
byte OBJECT_DESC = OBJECT | 10, OBJECT_DESC_ID = OBJECT | 11;
// object constants
byte OBJECT_NULL = OBJECT | 20, OBJECT_DUMMY = OBJECT | 21;
}
```

ğŸ˜œ æ˜¯ä¸æ˜¯æœ‰ç‚¹ä¸€è„¸æ‡µé€¼ï¼Ÿï¼æˆ‘ä»¬æŠŠæšä¸¾åšä¸€æ¬¡è§„æ•´ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![åè®®æ•´ç†](http://static2.iocoder.cn/images/Dubbo/2019_02_18/09.png)

* åœ¨æ¯ä¸ªå±æ€§å€¼( å³ field )çš„**é¦–ä¸ª Byte ä½**ï¼Œç§°ä¸º**æ ‡å¿—ä½ Flag** ã€‚ç›®å‰æˆ‘ä»¬åˆ†æˆä¸¤å¤§ç±»( å›¾ä¸­ï¼Œç»¿è‰²éƒ¨åˆ† )ï¼š

* Varint ï¼Œ**å˜é•¿æ•°å­—**ï¼Œå ç”¨ Byte å€¼çš„

[0, 128)
åŒºé—´ã€‚
* Object ï¼Œ**å¯¹è±¡**ï¼Œå ç”¨ Byte å€¼çš„

[-128, 0)
åŒºé—´ã€‚
* æ ‡å¿—ä½ Flag æ ¹æ®**ç”¨é€”**ï¼Œå¯ä»¥åˆ†æˆä¸¤ç§**ç±»å‹**ï¼ˆæ³¨æ„ï¼Œå€¼æ˜¯**ä¸é‡å **çš„ï¼‰ï¼š

* Tag ï¼Œ**æ ‡ç­¾**( å›¾ä¸­ï¼Œæ©™è‰²éƒ¨åˆ† )ã€‚

* ä»¥ VarInt ä¸¾ä¾‹å­ï¼Œ**æ•°å­—**åˆ†æˆ BYTEã€SHORTã€INTã€LONG å››ç§æ•°æ®ç±»å‹ã€‚ é€šè¿‡æ ‡è®°ä½ï¼Œè¡¨ç¤ºæ•°å­—å ç”¨**å¤šå°‘**Byte ï¼Œä»è€Œå®ç°**å˜é•¿**ï¼ŒèŠ‚çœ Byte çš„å ç”¨ã€‚ä¾‹å¦‚ï¼Œå±æ€§å€¼ç±»å‹ä¸º **Long** ï¼Œä½†æ˜¯å€¼æ˜¯ **100L** ï¼Œé‚£ä¹ˆåªéœ€è¦è¦ 1 Byte( æ ‡è®°ä½ä¸º **VARINT8** ) + 1 Byte( **100L** ) = 2 Byte ã€‚
* å½“ç„¶ï¼Œè¿™ç§æ–¹å¼ä¹Ÿæœ‰ç¼ºç‚¹ï¼Œå¯¹äº**å¤§æ•´æ•°**ï¼Œä¼šå¤šå ç”¨ä¸€ä¸ª**æ ‡è®°ä½**ï¼Œä¾‹å¦‚

Integer.MAX_VALUE
ã€‚ä»ç»Ÿè®¡ä¸Šæ¥è¯´ï¼Œä¸šåŠ¡ç³»ç»Ÿæ›´å¤šçš„æ˜¯**å°æ•´æ•°**ã€‚æ‰€ä»¥ï¼Œè¿™ä¸ªç¼ºç‚¹ä¹Ÿæ˜¯èƒ½å¤Ÿæ¥å—çš„ã€‚
* CONSTANTS ï¼Œ **æšä¸¾**( å›¾ä¸­ï¼Œé»„è‰²éƒ¨åˆ† )ï¼Œç”¨äº**å¸¸ç”¨**å±æ€§å€¼ã€‚

* ä»¥ Varint ä¸¾ä¾‹å­ï¼Œåœ¨ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œ

[ -15, 31 ]
æ˜¯**éå¸¸å¸¸ç”¨**ã€‚é€šè¿‡æšä¸¾ï¼Œè¿›ä¸€æ­¥å‡å°‘æ•°æ®æåŠï¼Œæå‡åºåˆ—åŒ–é€Ÿåº¦ã€‚æ‰€ä»¥ Varint çš„äºŒè¿›åˆ¶æ•°æ®æµç¤ºæ„å›¾å¦‚ä¸‹ï¼š![äºŒè¿›åˆ¶æ•°æ®æµ](http://static2.iocoder.cn/images/Dubbo/2019_02_18/10.png)

å¯èƒ½æœ‰èƒ–å‹ä¼šé—®ï¼Œä¸Šé¢åªæåˆ°äº†æ•°å­—æ€ä¹ˆåºåˆ—åŒ–ï¼Œ**é‚£ä¹ˆå¯¹è±¡æ€ä¹ˆåºåˆ—åŒ–å‘¢**ï¼Ÿæˆ‘ä»¬ä»¥ POJO ä¸ºä¾‹å­ï¼Œç®€å•è¯´ä¸‹ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå¯¹è±¡ç†è§£æˆ**ä¸€ä¸ªå±æ€§å€¼çš„é›†åˆ**ï¼Œé€šè¿‡ä¸‹é¢ä¼šçœ‹åˆ°çš„ Builder ç±»ï¼Œç”Ÿæˆè¯¥å¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„è¿‡ç¨‹çš„ä»£ç å³å¯ã€‚

å½“ç„¶ï¼Œå¯¹è±¡ä¸ä»…ä»…æœ‰ POJO ï¼Œè¿˜æœ‰ MAPï¼Œæ•°ç»„ç­‰ç­‰ï¼Œä¸‹é¢æˆ‘ä»¬éƒ½ä¼šçœ‹åˆ°å…·ä½“çš„å¤„ç†ä»£ç ã€‚

ğŸ™‚ å—¯ï¼Œå“”å“”äº†è¿™ä¹ˆå¤šï¼Œè®©æˆ‘ä»¬æ„‰å¿«çš„å¼€å§‹çœ‹ä»£ç æŠŠã€‚

# 3. Data

## 3.1 GenericDataOutput

[
com.alibaba.dubbo.common.serialize.support.dubbo.GenericDataOutput
](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/GenericDataOutput.java) ï¼Œå®ç° DataOutputï¼ŒGenericDataFlags æ¥å£ï¼ŒDubbo æ•°æ®è¾“å‡ºå®ç°ç±»ã€‚

### 3.1.1 æ„é€ æ–¹æ³•

```
//*/*
/* é»˜è®¤ {@link /#mCharBuf} å¤§å°
/*/
private static final int CHAR_BUF_SIZE = 256;
//*/*
/* åºåˆ—åŒ–å­—ç¬¦ä¸²çš„ä¸´æ—¶ç»“æœçš„ Buffer æ•°ç»„ï¼Œç”¨äº {@link /#writeUTF(String)} ä¸­ã€‚
/*/
private final char[] mCharBuf = new char[CHAR_BUF_SIZE];
//*/*
/* åºåˆ—åŒ– Varint çš„ä¸´æ—¶ç»“æœçš„ Buffer æ•°ç»„ï¼Œç”¨äº {@link /#writeVarint32(int)} å’Œ {@link /#writeVarint64(long)} ä¸­ã€‚
/*/
private final byte[] mTemp = new byte[9];
//*/*
/* åºåˆ—åŒ–ç»“æœçš„ Buffer æ•°ç»„
/*/
private final byte[] mBuffer;
//*/*
/* {@link /#mBuffer} å®¹é‡å¤§å°
/*/
private final int mLimit;
//*/*
/* {@link /#mBuffer} å½“å‰å†™å…¥ä½ç½®
/*/
private int mPosition = 0;
//*/*
/* ç»“æœè¾“å‡º
/*/
private final OutputStream mOutput;
```

* mCharBuf
å±æ€§ï¼Œåºåˆ—åŒ–**å­—ç¬¦ä¸²**çš„ä¸´æ—¶ç»“æœçš„ Buffer æ•°ç»„ï¼Œç”¨äº

/#writeUTF(String v)
æ–¹æ³•ä¸­ã€‚

* /#CHAR_BUF_SIZE
**é™æ€**å±æ€§ï¼Œé»˜è®¤å¤§å°ã€‚
* mTemp
å±æ€§ï¼Œåºåˆ—åŒ– **Varint** çš„ä¸´æ—¶ç»“æœçš„ Buffer æ•°ç»„ï¼Œç”¨äº

/#writeVarint32(int)
å’Œ

/#writeVarint64(long)
æ–¹æ³•ä¸­ã€‚

* æ•°ç»„å¤§å°ä¸º 9 ï¼Œå› ä¸º Varint æœ€å¤§å ç”¨ 9 å­—èŠ‚ï¼ŒTag( 1 Byte ) + Long( 8 Bytes ) ã€‚
* mBuffer
å±æ€§ï¼Œåºåˆ—åŒ–**ç»“æœ**çš„ Buffer æ•°ç»„ã€‚

* mPosition
å±æ€§ï¼Œ**å½“å‰**å†™å…¥ä½ç½®ã€‚
* mLimit
å±æ€§ï¼Œå®¹é‡å¤§å°ã€‚
* mOutput
å±æ€§ï¼Œç»“æœè¾“å‡ºï¼Œ

mBuffer => mOutput
ä¸­ã€‚

### 3.1.2 writeBool

```
@Override
public void writeBool(boolean v) throws IOException{
write0(v ? VARINT_1 : VARINT_0);
}
```

* é€šè¿‡ 1 è¡¨ç¤º TRUE ï¼Œ0 è¡¨ç¤º FALSE ã€‚å ç”¨ 1 Byte ï¼Œä½¿ç”¨ **CONSTANTS**( VARINT_1ã€VARINT_0 ) å³å¯ã€‚
* è°ƒç”¨

/#write0(byte b)
æ–¹æ³•ï¼Œå†™å…¥

mBuffer
ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
protected void write0(byte b) throws IOException{
// è¶…è¿‡ mBuffer å®¹é‡ä¸Šé™ï¼Œåˆ·å…¥ mOutput ä¸­
if (mPosition == mLimit) {
flushBuffer();
}
// å†™å…¥ mBuffer ä¸­ã€‚
mBuffer[mPosition++] = b;
}
```

* /#flushBuffer()
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
@Override
public void flushBuffer() throws IOException{
if (mPosition > 0) {
// å†™å…¥ mOutput
mOutput.write(mBuffer, 0, mPosition);
// é‡ç½®å½“å‰å†™å…¥ä½ç½®
mPosition = 0;
}
}
```

### 3.1.3 writeByte

```
1: @Override
2: public void writeByte(byte v) throws IOException{
3: switch (v) {
4: // TODO ã€8034ã€‘ä¸ºä»€ä¹ˆæ²¡æœ‰è´Ÿæ•°çš„æšä¸¾
5: // ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œå†™å…¥å¯¹åº”çš„æšä¸¾å€¼
6: case 0:
7: write0(VARINT_0);
8: break;
9: // ... çœç•¥ä¸­é—´ï¼Œ[1, 30] é‡å¤çš„ case å¤„ç†
10: case 31:
11: write0(VARINT_1F);
12: break;
13: // ä¸ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œå†™å…¥ Tag + å…·ä½“å€¼
14: default:
15: // å†™å…¥ VARINT8
16: write0(VARINT8);
17: // å†™å…¥ BYTE å…·ä½“å€¼
18: write0(v);
19: }
20: }
```

* ç¬¬ 4 è¡Œï¼š// TODO ã€8034ã€‘ä¸ºä»€ä¹ˆæ²¡æœ‰è´Ÿæ•°çš„æšä¸¾
* ç¬¬ 5 è‡³ 12 è¡Œï¼šç¬¦åˆ Varint **CONSTANTS** ï¼Œå†™å…¥å¯¹åº”çš„ **CONSTANTS**ã€‚
* ç¬¬ 13 è‡³ 19 è¡Œï¼šä¸ç¬¦åˆ Varint CONSTANTS ï¼Œè°ƒç”¨ä¸¤æ¬¡

/#write0(byte b)
æ–¹æ³•ï¼Œå†™å…¥ **VARINT8** + å…·ä½“å€¼

v
ã€‚

### 3.1.4 writeShort

```
@Override
public void writeShort(short v) throws IOException{
writeVarint32(v);
}
```

* è°ƒç”¨

/#writeVarint32(int v)
æ–¹æ³•ï¼Œå†™å…¥ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: private void writeVarint32(int v) throws IOException{
2: switch (v) {
3: // ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œå†™å…¥å¯¹åº”çš„æšä¸¾å€¼
4: case -15:
5: write0(VARINT_NF);
6: break;
7: // ... çœç•¥ä¸­é—´ï¼Œ[-14, 30] é‡å¤çš„ case å¤„ç†
8: case 31:
9: write0(VARINT_1F);
10: break;
11: // ä¸ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œå†™å…¥ Tag + å…·ä½“å€¼
12: default:
13: int t = v, // å€¼
14: ix = 0; // å½“å‰å†™å…¥ä½ç½®
15: byte[] b = mTemp;
16: // é¡ºåºè¯»å–å­—èŠ‚ï¼Œå­˜åˆ° mTemp ä¸­
17: while (true) {
18: b[++ix] = (byte) (v & 0xff); // å¤§äºç­‰äº 128 æ—¶ï¼Œä¼šæˆªå–åˆ°æœ€é«˜ä½çš„ 1 ï¼Œå˜æˆè´Ÿæ•°ã€‚
19: if ((v >>>= 8) == 0) { // æ— å¯è¯»å­—èŠ‚
20: break;
21: }
22: }
23:
24: if (t > 0) { // æ­£æ•°
25: // [ 0a e2 => 0a e2 00 ] [ 92 => 92 00 ]
26: // æœ€åä¸€æ¬¡å–ä½™ï¼Œå¤§äºç­‰äº 128 æ—¶ï¼Œåœ¨ (byte) è½¬æ¢åï¼Œå˜æˆäº†è´Ÿæ•°ï¼Œéœ€è¦è¡¥ä¸€ä¸ª 0 çš„ BYTE åˆ° mTemp ä¸­ï¼Œå¦åˆ™ååºåˆ—åŒ–åä¼šè¢«è¯¯è®¤ä¸ºè´Ÿæ•°ã€‚
27: if (b[ix] < 0) {
28: b[++ix] = 0;
29: }
30: } else { // è´Ÿæ•°
31: // [ 01 ff ff ff => 01 ff ] [ e0 ff ff ff => e0 ]
32: // è´Ÿæ•°ä½¿ç”¨è¡¥ç è¡¨ç¤ºï¼Œé«˜ä½æ˜¯å¤§é‡çš„ 1 ï¼Œéœ€è¦å»é™¤ã€‚
33: // å¦å¤–ï¼ŒLONG çš„ä½æ•°æ¯” INT æ›´å¤šï¼Œæ‰€ä»¥ï¼Œç›¸åŒæ•°å­—ï¼ŒLONG å‹ä¼šæ¯” INT å‹æ›´å¤šï¼Œä¾‹å¦‚ long v = -662L å’Œ int v = -662 ã€‚
34: while (b[ix] == (byte) 0xff && b[ix - 1] < 0) {
35: ix--;
36: }
37: }
38:
39: // å†™å…¥ Tag ï¼Œåˆ°é¦– Byte ä½
40: b[0] = (byte) (VARINT + ix - 1);
41: // å†™å…¥ Tag + Bytes åˆ° mBuffer ä¸­
42: write0(b, 0, ix + 1);
43: }
44: }
```

* ç¬¬ 5 è‡³ 12 è¡Œï¼šç¬¦åˆ Varint **CONSTANTS** ï¼Œå†™å…¥å¯¹åº”çš„ **CONSTANTS**ã€‚
* ç¬¬ 11 è‡³ 43 è¡Œï¼šä¸ç¬¦åˆ Varint CONSTANTS ï¼Œå†™å…¥ **TAG** + å…·ä½“å€¼ ã€‚

* ç¬¬ 16 è‡³ 22 è¡Œï¼šé¡ºåº**å¾ªç¯**è¯»å–**æ¯ä¸ªå­—èŠ‚**ï¼Œå­˜åˆ°

b
æ•°ç»„ä¸­ã€‚

* ç¬¬ 18 è¡Œï¼šå…ˆ

0xff
åš

%256
å–ä½™ï¼Œè·å–åˆ°**ä¸€ä¸ªå­—èŠ‚**ã€‚å† **(byte)** è½¬æ¢æˆ BYTE å€¼ã€‚å› ä¸ºï¼ŒBYTE æ•°æ®èŒƒå›´ä¸º

[-128, 127]
ï¼Œæ‰€ä»¥å–ä½™çš„ç»“æœä¸º

[128, 255]
èŒƒå›´æ—¶ï¼Œåˆ™ä¼šè¢«**é«˜ä½æˆªå–**ï¼Œå˜æˆè´Ÿæ•°ã€‚ä¾‹å¦‚ï¼Œ255 ä¼šå˜æˆ -1 ã€‚ä¹Ÿå› æ­¤ï¼Œ**ååºåˆ—åŒ–**æ—¶ï¼Œéœ€è¦åšä¸€æ¬¡

0xff |
æ“ä½œï¼Œæ¥è¡¥é½**é«˜ä½çš„ 1**ã€‚
* ç¬¬ 18 è¡Œï¼š

b[++ix]
ï¼Œå…ˆå¢åŠ 

ix
çš„å€¼ï¼Œåœ¨å†™å…¥

b
æ•°ç»„ä¸­ã€‚å› ä¸ºï¼Œé¦– Byte ä½ä¸º **TAG** ã€‚
* ç¬¬ 19 è‡³ 21 è¡Œï¼šæ— å¯è¯»å­—èŠ‚ï¼Œç»“æŸå¾ªç¯ã€‚
* ç¬¬ 24 è‡³ 29 è¡Œï¼šæœ€åä¸€æ¬¡å–ä½™ï¼Œå¤§äºç­‰äº 128 æ—¶ï¼Œåœ¨ **(byte)** è½¬æ¢åï¼Œå˜æˆäº†è´Ÿæ•°ï¼Œéœ€è¦è¡¥ä¸€ä¸ª 0 åˆ°

b
ä¸­ï¼Œå¦åˆ™ååºåˆ—åŒ–åä¼šè¢«è¯¯è®¤ä¸ºè´Ÿæ•°ã€‚ä¾‹å¦‚ï¼š

v = 255
ã€‚
* ç¬¬ 30 è‡³ 37 è¡Œï¼šè´Ÿæ•°ä½¿ç”¨è¡¥ç è¡¨ç¤ºï¼Œé«˜ä½æ˜¯å¤§é‡çš„ 1 ï¼Œéœ€è¦**å¾ªç¯**å»é™¤ã€‚å¦å¤–ï¼ŒLONG çš„ä½æ•°æ¯” INT æ›´å¤šï¼Œæ‰€ä»¥ï¼Œç›¸åŒæ•°å­—ï¼ŒLONG å‹ä¼šæ¯” INT å‹æ›´å¤šï¼Œä¾‹å¦‚

long v = -662L
å’Œ

int v = -662
ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š
```
INT
-110 -3 -1 -1
LONG
-110 -3 -1 -1 -1 -1 -1 -1
```

* x
* æ¶‰åŠå¤§é‡çš„**ä½æ“ä½œ**ï¼Œä¸ç†Ÿæ‚‰çš„èƒ–å‹ï¼Œè¯· Google å¤ä¹ ä¸‹å¤§å­¦è¯¾ç¨‹ã€‚ğŸ˜ˆ
* ç¬¬ 40 è¡Œï¼šå†™å…¥ **TAG** ï¼Œåˆ°

b
çš„é¦–ä½ã€‚
* ç¬¬ 42 è¡Œï¼šè°ƒç”¨

/#write0(byte[] b, int off, int le)
æ–¹æ³•ï¼Œ**æ‰¹é‡**å†™å…¥

mBuffer
ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
protected void write0(byte[] b, int off, int len) throws IOException{
int rem = mLimit - mPosition;
// æœªè¶…è¿‡ mBuffer å®¹é‡ä¸Šé™ï¼Œæ‰¹é‡å†™å…¥ mBuffer ä¸­
if (rem > len) {
System.arraycopy(b, off, mBuffer, mPosition, len);
mPosition += len;
} else {
// éƒ¨åˆ†æ‰¹é‡å†™æ»¡ mBuffer ä¸­
System.arraycopy(b, off, mBuffer, mPosition, rem);
mPosition = mLimit;
// åˆ·å…¥ mOutput ä¸­
flushBuffer();
off += rem; // æ–°çš„å¼€å§‹ä½ç½®
len -= rem; // æ–°çš„é•¿åº¦
// æœªè¶…è¿‡ mBuffer å®¹é‡ä¸Šé™ï¼Œæ‰¹é‡å†™å…¥ mBuffer ä¸­
if (mLimit > len) {
System.arraycopy(b, off, mBuffer, 0, len);
mPosition = len;
// è¶…è¿‡ mBuffer å®¹é‡ä¸Šé™ï¼Œæ‰¹é‡å†™å…¥ mOutput ä¸­
} else {
mOutput.write(b, off, len);
}
}
}
```

### 3.1.5 writeInt

```
@Override
public void writeInt(int v) throws IOException{
writeVarint32(v);
}
```

### 3.1.6 writeLong

```
@Override
public void writeInt(int v) throws IOException{
writeVarint64(v);
}
```

* è°ƒç”¨

/#writeVarint64(long v)
æ–¹æ³•ï¼Œå†™å…¥ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: private void writeVarint64(long v) throws IOException{
2: // æ•°æ®èŒƒå›´åœ¨ INT å†…
3: int i = (int) v;
4: if (v == i) {
5: writeVarint32(i);
6: // æ•°æ®èŒƒå›´åœ¨ LONG å†…ï¼Œä¸ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œå†™å…¥ Tag + å…·ä½“å€¼ã€‚å’Œ writeVarint32 æ˜¯ä¸€è‡´çš„
7: } else {
8: long t = v;
9: int ix = 0;
10: byte[] b = mTemp;
11:
12: while (true) {
13: b[++ix] = (byte) (v & 0xff);
14: if ((v >>>= 8) == 0)
15: break;
16: }
17:
18: if (t > 0) {
19: // [ 0a e2 => 0a e2 00 ] [ 92 => 92 00 ]
20: if (b[ix] < 0)
21: b[++ix] = 0;
22: } else {
23: // [ 01 ff ff ff => 01 ff ] [ e0 ff ff ff => e0 ]
24: while (b[ix] == (byte) 0xff && b[ix - 1] < 0)
25: ix--;
26: }
27:
28: b[0] = (byte) (VARINT + ix - 1);
29: write0(b, 0, ix + 1);
30: }
31: }
```

* ç¬¬ 2 è‡³ 5 è¡Œï¼šå½“

v
æ•°æ®èŒƒå›´åœ¨ INT å†…æ—¶ï¼Œè°ƒç”¨

/#writeVarint32(int v)
å¤„ç†ã€‚
* ç¬¬ 7 è‡³ 30 è¡Œï¼šå½“

v
æ•°æ®èŒƒå›´åœ¨ LONG å†…æ—¶ï¼Œ ä¸ç¬¦åˆ Varint **CONSTANTS** ï¼Œå†™å…¥ **TAG** + å…·ä½“å€¼ï¼Œå’Œ

/#writeVarint32(int v)
**ååŠæ®µ**çš„ä»£ç æ˜¯ä¸€è‡´çš„ã€‚

### 3.1.7 writeFloat

```
@Override
public void writeFloat(float v) throws IOException{
writeVarint32(Float.floatToRawIntBits(v));
}
```

### 3.1.8 writeDouble

```
@Override
public void writeDouble(double v) throws IOException{
writeVarint64(Double.doubleToRawLongBits(v));
}
```

### 3.1.9 writeUInt

```
public void writeUInt(int v) throws IOException{
byte tmp;
// å¾ªç¯å†™å…¥
while (true) {
// è·å¾—æœ€å 7 Bits
tmp = (byte) (v & 0x7f);
// æ— åç»­çš„ Byte ï¼Œä¿®æ”¹ tmp é¦– Bit ä¸º 1 ï¼Œå†™å…¥ mBuffer ä¸­ï¼Œå¹¶ç»“æŸã€‚
if ((v >>>= 7) == 0) {
write0((byte) (tmp | 0x80));
return;
// æœ‰åç»­çš„ Byte ï¼Œå†™å…¥ mBuffer ä¸­
} else {
write0(tmp);
}
}
}
```

* UInt ï¼ŒUnsingned Int ï¼Œæ— ç¬¦å·æ•´æ•°( **æ­£æ•°** )ã€‚è¢«ç”¨äºè¡¨ç¤ºå­—ç¬¦ä¸²ã€æ•°ç»„çš„é•¿åº¦ã€‚åºåˆ—åŒ–æ—¶ï¼Œå’Œä¸Šæ–‡æˆ‘ä»¬çœ‹åˆ°çš„ Varint ä¸€æ ·ï¼Œä¹Ÿæ˜¯**å˜é•¿æ•°å­—**ï¼Œä½†æ˜¯æ–¹å¼**ä¸åŒ**ã€‚å› ä¸ºæ˜¯**æ­£æ•´æ•°**ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ **Byte æœ€é«˜ä½çš„ 1** ï¼ŒåŸæ¥ç”¨æ¥è¡¨ç¤ºè´Ÿæ•°ï¼Œç°åœ¨æ¥è¡¨ç¤ºæ˜¯å¦æœ‰**åç»­çš„ BYTE** ï¼Œä¹Ÿæ˜¯æ­£æ•´æ•°çš„ä¸€éƒ¨åˆ†ã€‚
* ğŸ™‚ ä»£ç å·²ç»æ·»åŠ æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±çœ‹çœ‹å“ˆã€‚
* æ¨èé˜…è¯» [ã€Šæ•°å€¼å‹ç¼©å­˜å‚¨æ–¹æ³•Varintã€‹](https://www.cnblogs.com/smark/archive/2012/05/03/2480034.html) ï¼Œé‡Œé¢ Varint å’Œ UInt ä¸€æ ·é‡‡ç”¨æœ€é«˜ä½æ¥è¡¨ç¤ºæ˜¯å¦æœ‰åç»­æ•°å­—ï¼Œä½†æ˜¯æ›´åŠ å¼ºå¤§é€šç”¨ï¼Œä½¿ç”¨ **Zag ç®—æ³•**è§£å†³è´Ÿæ•°é—®é¢˜ï¼Œåœ¨ Protobuf ä¸­é‡‡ç”¨è¯¥æ–¹å¼ã€‚ğŸ˜ˆ æ–‡ç« ä¸­çš„ Varint å’Œæœ¬æ–‡æˆ‘ä»¬çœ‹åˆ°çš„ Varint **ä¸åŒ**ã€‚å¦‚æœèƒ–å‹å¯¹ Protobuf çš„å®ç°æ„Ÿå…´è¶£ï¼Œæ¨èé˜…è¯» [ã€Š Protocol Buffer åºåˆ—åŒ–åŸç†å¤§æ­ç§˜ - ä¸ºä»€ä¹ˆProtocol Bufferæ€§èƒ½è¿™ä¹ˆå¥½ï¼Ÿã€‹](https://blog.csdn.net/carson_ho/article/details/70568606)ã€‚

### 3.1.10 writeBytes

```
1: @Override
2: public void writeBytes(byte[] b) throws IOException{
3: // NULL ï¼Œä½¿ç”¨ OBJECT_NULL å†™å…¥ mBuffer
4: if (b == null) {
5: write0(OBJECT_NULL);
6: // å…¶ä»–ï¼Œå†™å…¥ mBuffer
7: } else {
8: writeBytes(b, 0, b.length);
9: }
10: }
11:
12: @Override
13: public void writeBytes(byte[] b, int off, int len) throws IOException{
14: // ç©ºæ•°ç»„ï¼Œä½¿ç”¨ OBJECT_DUMMY å†™å…¥ mBuffer
15: if (len == 0) {
16: write0(OBJECT_DUMMY);
17: // æ•°ç»„éç©ºï¼Œå†™å…¥ OBJECT_BYTES + Length + å…·ä½“æ•°æ®åˆ° mBuffer
18: } else {
19: write0(OBJECT_BYTES);
20: writeUInt(len); // UInt
21: write0(b, off, len);
22: }
23: }
```

![writeBytes](http://static2.iocoder.cn/images/Dubbo/2019_02_18/03.png)

### 3.1.11 writeUTF

```
1: @Override
2: public void writeUTF(String v) throws IOException{
3: // NULL ï¼Œä½¿ç”¨ OBJECT_NULL å†™å…¥ mBuffer
4: if (v == null) {
5: write0(OBJECT_NULL);
6: } else {
7: // ç©ºå­—ç¬¦ä¸²ï¼Œä½¿ç”¨ OBJECT_DUMMY å†™å…¥ mBuffer
8: int len = v.length();
9: if (len == 0) {
10: write0(OBJECT_DUMMY);
11: // å­—ç¬¦ä¸²éç©ºï¼Œå†™å…¥ OBJECT_BYTES + Length + å…·ä½“æ•°æ®åˆ° mBuffer
12: } else {
13: // å†™å…¥ OBJECT_BYTES åˆ° mBuffer ä¸­
14: write0(OBJECT_BYTES);
15: // å†™å…¥ Length åˆ° mBuffer ä¸­
16: writeUInt(len);
17:
18: int off = 0,
19: limit = mLimit - 3, // -3 çš„åŸå› ï¼Œå› ä¸ºè‹¥ Char åœ¨ [2048, 65536) èŒƒå›´å†…ï¼Œéœ€è¦å ç”¨ä¸‰ä¸ªå­—èŠ‚ï¼Œäº‹å…ˆæ— æ³•å¾—çŸ¥ã€‚
20: size;
21: char[] buf = mCharBuf;
22: do {
23: // è¯»å–æ•°é‡ï¼Œä¸è¶…è¿‡ CHAR_BUF_SIZE ä¸Šé™ï¼ŒåŒæ—¶ä¸è¶…è¿‡å¯è¯»ä¸Šé™
24: size = Math.min(len - off, CHAR_BUF_SIZE);
25: // è¯»å–å­—ç¬¦ä¸²åˆ° buf ä¸­
26: v.getChars(off, off + size, buf, 0);
27:
28: // å†™å…¥æ•°æ®åˆ° mBuffer ä¸­
29: for (int i = 0; i < size; i++) {
30: char c = buf[i];
31: // Java Character æ•°æ®èŒƒå›´ä¸º [0, 65535]
32: if (mPosition > limit) {
33: if (c < 0x80) { // [0, 128) ASCII ç 
34: // 0X80 => 10 00 00 00 å–ä¸ƒä½ [0, 64)
35:
36: write0((byte) c);
37: } else if (c < 0x800) { // [128, 2048)
38: // 0xC0 => 11 00 00 00 å–å…­ä½ [0, 32)
39: // 0x80 => 10 00 00 00 å–ä¸ƒä½ [0, 64)
40:
41: // 0x1F => 00 01 11 11
42: // 0x3F => 00 11 11 11
43:
44: write0((byte) (0xC0 | ((c >> 6) & 0x1F)));
45: write0((byte) (0x80 | (c & 0x3F)));
46: } else { // [2048, 65536)
47: // 0xE0 => 11 10 00 00 å–äº”ä½ [0, 15]
48: // 0x80 => 10 00 00 00 å–ä¸ƒä½ [0, 63]
49: // 0x80 => 10 00 00 00 å–ä¸ƒä½ [0, 63]
50:
51: // 0x0F => 00 00 11 11
52: // 0x3F => 00 11 11 11
53: // 0x3F => 00 11 11 11
54:
55: write0((byte) (0xE0 | ((c >> 12) & 0x0F)));
56: write0((byte) (0x80 | ((c >> 6) & 0x3F)));
57: write0((byte) (0x80 | (c & 0x3F)));
58: }
59: } else {
60: if (c < 0x80) {
61: mBuffer[mPosition++] = (byte) c;
62: } else if (c < 0x800) {
63: mBuffer[mPosition++] = (byte) (0xC0 | ((c >> 6) & 0x1F));
64: mBuffer[mPosition++] = (byte) (0x80 | (c & 0x3F));
65: } else {
66: mBuffer[mPosition++] = (byte) (0xE0 | ((c >> 12) & 0x0F));
67: mBuffer[mPosition++] = (byte) (0x80 | ((c >> 6) & 0x3F));
68: mBuffer[mPosition++] = (byte) (0x80 | (c & 0x3F));
69: }
70: }
71: }
72:
73: // è®¡ç®— buf æ–°çš„å¼€å§‹è¯»å–ä½ç½®ã€‚
74: off += size;
75: } while (off < len);
76: }
77: }
78: }
```

* å­—ç¬¦ä¸²å’Œå­—èŠ‚æ•°ç»„ï¼Œ**äºŒè¿›åˆ¶æ•°æ®æµ**çš„ç»“æ„æ˜¯ä¸€è‡´çš„ï¼Œå·®å¼‚ç‚¹åœ¨å­—ç¬¦ä¸²çš„**æ¯ä¸ªå­—ç¬¦**ï¼Œå†™å…¥åˆ°

mBuffer
ä¸­ï¼Œå³ã€ç¬¬ 18 è‡³ 75 è¡Œã€‘ã€‚
* ç¬¬ 19 è¡Œï¼š

-3
çš„åŸå› ï¼Œå› ä¸ºæ¯ä¸ª**å­—ç¬¦**æœ€å¤šéœ€è¦å ç”¨**ä¸‰ä¸ª**å­—èŠ‚ï¼Œäº‹å…ˆæ— æ³•å¾—çŸ¥ã€‚è€Œã€ç¬¬ 32 è‡³ 58 è¡Œã€‘å’Œã€ç¬¬ 59 è‡³ 69 è¡Œã€‘ï¼Œé€»è¾‘ä¸Šæ˜¯**ä¸€è‡´**çš„ï¼Œç›¸æ¯”æ¥è¯´ã€ç¬¬ 32 è‡³ 58 è¡Œã€‘çš„

/#write0(byte b)
æ–¹æ³•ï¼Œå¤š**ä¸€ä¸ªåˆ¤æ–­**ï¼Œè€ƒè™‘åˆ°æ€§èƒ½ï¼Œå°±åˆ†æˆäº†**ä¸¤æ®µ**çš„é€»è¾‘ï¼Œä¹Ÿå°±å› æ­¤ï¼Œå¤šäº†è¿™é‡Œçš„

-3
ã€‚
* ç¬¬ 22 è‡³ 25 è¡Œï¼š**å¾ªç¯**è¯»å–å­—ç¬¦åˆ°

buf
ä¸­ã€‚å› ä¸ºæ¯æ¬¡è¯»å–æœ‰

CHAR_BUF_SIZE
æœ€å¤§é™åˆ¶ï¼Œæ‰€ä»¥è¶…è¿‡æ—¶ï¼Œéœ€è¦**å¤šæ¬¡**è¯»å–ã€‚è¯»å–å®Œä¸€æ‰¹ï¼Œå¤„ç†å®Œä¸€æ‰¹ï¼Œä¸æ–­**é‡ç”¨**

buf
æ•°ç»„ã€‚
* ç¬¬ 28 è‡³ 71 è¡Œï¼šå†™å…¥

buf
åˆ°

mBuffer
ä¸­ã€‚å› ä¸º Java **Character** çš„æ•°æ®èŒƒå›´ä¸º

[0, 65535]
ï¼Œè¶…è¿‡ **BYTE** ä¸Šé™ã€‚æ‰€ä»¥å†™å…¥æ¯ä¸ªå­—ç¬¦æ—¶ï¼Œåˆ†æˆ**ä¸‰ç§**æƒ…å†µï¼š

* ç¬¬ 33 è‡³ 36 è¡Œï¼š

[0, 128)
ï¼Œå ç”¨ä¸€ä¸ªå­—ç¬¦ã€‚å–ä¸ƒä½ï¼Œ2 çš„ ä¸ƒæ¬¡æ–¹ä¸º 128 ï¼Œä»è€Œæ»¡è¶³æ•°æ®èŒƒå›´ã€‚
* ç¬¬ 37 è‡³ 45 è¡Œï¼š

[128, 2048)
ï¼Œå ç”¨ä¸¤ä¸ªå­—ç¬¦ã€‚å–å…­ä½ã€ä¸ƒä½ï¼Œ2 çš„åä¸‰æ¬¡æ–¹ä¸º 2048 ï¼Œä»è€Œæ»¡è¶³æ•°æ®èŒƒå›´ã€‚
* ç¬¬ 46 è‡³ 58 è¡Œï¼š

[2048, 65536)
ï¼Œå ç”¨ä¸‰ä¸ªå­—ç¬¦ã€‚å–äº”ä½ã€ä¸ƒä½ã€ä¸ƒä½ï¼Œ2 çš„åä¹æ¬¡æ–¹ä¸º 65536 ï¼Œä»è€Œæ»¡è¶³æ•°æ®èŒƒå›´ã€‚
* **ä¸ºä»€ä¹ˆé¦–ä½å–çš„ä¸åŒçš„ä½æ•°å‘¢**ï¼Ÿåœ¨ååºåˆ—åŒ–æ—¶ï¼Œå¯ä»¥æ ¹æ®é¦–ä½æ•°çš„**é«˜ä½**æ¥åˆ¤æ–­ï¼Œåˆ°åº•å®Œæ•´çš„å­—ç¬¦ï¼Œå ç”¨äº†å‡ ä¸ªå­—èŠ‚ã€‚ğŸ™‚ æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£æˆï¼Œ**è¿™æ˜¯ä¸€ç§é’ˆå¯¹å½“å‰åœºæ™¯å®ç°çš„å˜é•¿æ•´æ•°**ã€‚
* ç¬¬ 74 è¡Œï¼šè®¡ç®—

buf
æ–°çš„å¼€å§‹**è¯»å–**ä½ç½®ã€‚

## 3.2 GenericDataInput

[
com.alibaba.dubbo.common.serialize.support.dubbo.GenericDataInput
](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/GenericDataInput.java) ï¼Œå®ç° DataInputï¼ŒGenericDataFlags æ¥å£ï¼ŒDubbo æ•°æ®è¾“å…¥å®ç°ç±»ã€‚

### 3.2.1 æ„é€ æ–¹æ³•

```
//*/*
/* ç©ºå­—ç¬¦ä¸²
/*/
private static final String EMPTY_STRING = "";
//*/*
/* ç©ºå­—èŠ‚æ•°ç»„
/*/
private static final byte[] EMPTY_BYTES = {};
//*/*
/* è¾“å…¥æµ
/*/
private final InputStream mInput;
//*/*
/* è¯»å– Buffer æ•°ç»„
/*/
private final byte[] mBuffer;
//*/*
/* {@link /#mBuffer} å½“å‰è¯»å–ä½ç½®
/*/
private int mRead = 0;
//*/*
/* {@link /#mBuffer} æœ€å¤§å¯è¯»å–ä½ç½®
/*/
private int mPosition = 0;
public GenericDataInput(InputStream is){
this(is, 1024);
}
public GenericDataInput(InputStream is, int buffSize){
mInput = is;
mBuffer = new byte[buffSize];
}
```

* mBuffer
å±æ€§ï¼Œè¯»å– Buffer æ•°ç»„ã€‚

* mRead
å±æ€§ï¼Œå½“å‰è¯»å–ä½ç½®ã€‚
* mPosition
å±æ€§ï¼Œæœ€å¤§å¯è¯»å–ä½ç½®ã€‚
* mInput
å±æ€§ï¼Œè¾“å…¥æµã€‚

### 3.2.2 readBool

```
@Override
public boolean readBool() throws IOException{
// è¯»å–å­—èŠ‚
byte b = read0();
// åˆ¤æ–­ true / false
switch (b) {
case VARINT_0: // false
return false;
case VARINT_1: // true
return true;
default: // éæ³•
throw new IOException("Tag error, expect BYTE_TRUE|BYTE_FALSE, but get " + b);
}
}
```

* è°ƒç”¨

/#read0()
æ–¹æ³•ï¼Œè¯»å–å­—èŠ‚ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
protected byte read0() throws IOException{
// è¯»å–åˆ°è¾¾ä¸Šé™ï¼Œä» mInput è¯»å–åˆ° mBuffer ä¸­ã€‚
if (mPosition == mRead) {
fillBuffer();
}
// ä» mBuffer ä¸­ï¼Œè¯»å–å­—èŠ‚ã€‚
return mBuffer[mPosition++];
}
```

* /#fillBuffer()
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
private void fillBuffer() throws IOException{
// é‡ç½® mPosition
mPosition = 0;
// è¯»å– mInput åˆ° mBuffer ä¸­
mRead = mInput.read(mBuffer);
// æœªè¯»å–åˆ°ï¼ŒæŠ›å‡º EOFException å¼‚å¸¸
if (mRead == -1) {
mRead = 0;
throw new EOFException();
}
}
```

### 3.2.3 readByte

```
1: @Override
2: public byte readByte() throws IOException{
3: // è¯»å–å­—èŠ‚
4: byte b = read0();
5: switch (b) {
6: // ä¸ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œè¯»å–å­—èŠ‚è¿”å›
7: case VARINT8:
8: return read0();
9: // ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œè¿”å›å¯¹åº”çš„å€¼
10: case VARINT_0:
11: return 0;
12: // ... çœç•¥ä¸­é—´ï¼Œ[1, 30] é‡å¤çš„ case å¤„ç†
13: case VARINT_1F:
14: return 31;
15: default: // éæ³•ï¼ŒæŠ›å‡º IOException å¼‚å¸¸
16: throw new IOException("Tag error, expect VARINT, but get " + b);
17: }
18: }
```

* ç¬¬ 4 è¡Œï¼šè°ƒç”¨

/#read0()
æ–¹æ³•ï¼Œè¯»å–å­—èŠ‚ã€‚
* ç¬¬ 6 è‡³ 8 è¡Œï¼šä¸ç¬¦åˆ Varint **CONSTANTS** ï¼Œè°ƒç”¨

/#read0()
æ–¹æ³•ï¼Œè¯»å–å­—èŠ‚è¿”å›ã€‚
* ç¬¬ 9 è‡³ 14 è¡Œï¼šç¬¦åˆ Varint CONSTANTSï¼Œè¿”å›å¯¹åº”çš„å€¼ã€‚

### 3.2.4 readShort

```
@Override
public short readShort() throws IOException{
return (short) readVarint32();
}
```

* è°ƒç”¨

/#readVarint32()
æ–¹æ³•ï¼Œè¯»å–ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: private int readVarint32() throws IOException{
2: // è¯»å–é¦–ä½ Byte å­—èŠ‚
3: byte b = read0();
4: //
5: switch (b) {
6: // ä¸ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œè¯»å– Tag + å…·ä½“å€¼
7: case VARINT8:
8: return read0();
9: case VARINT16: {
10: byte b1 = read0(), b2 = read0();
11: return (short) ((b1 & 0xff) |
12: ((b2 & 0xff) << 8));
13: }
14: case VARINT24: {
15: byte b1 = read0(), b2 = read0(), b3 = read0();
16: int ret = (b1 & 0xff) |
17: ((b2 & 0xff) << 8) |
18: ((b3 & 0xff) << 16);
19: if (b3 < 0) { // è¡¥é½è´Ÿæ•°çš„é«˜ä½
20: return ret | 0xff000000;
21: }
22: return ret;
23: }
24: case VARINT32: {
25: byte b1 = read0(), b2 = read0(), b3 = read0(), b4 = read0();
26: return ((b1 & 0xff) |
27: ((b2 & 0xff) << 8) |
28: ((b3 & 0xff) << 16) |
29: ((b4 & 0xff) << 24));
30: }
31: // ç¬¦åˆ Varint æšä¸¾å€¼ï¼Œè¿”å›å¯¹åº”çš„å€¼
32: case VARINT_NF:
33: return -15;
34: // ... çœç•¥ä¸­é—´ï¼Œ[-14, 30] é‡å¤çš„ case å¤„ç†
35: case VARINT_1F:
36: return 31;
37: default:
38: throw new IOException("Tag error, expect VARINT, but get " + b);
39: }
40: }
```

* ç¬¬ 3 è¡Œï¼šè°ƒç”¨

/#read0()
æ–¹æ³•ï¼Œè¯»å–**é¦–ä½** Byte å­—èŠ‚ã€‚
* ç¬¬ 6 è‡³ 30 è¡Œï¼šä¸ç¬¦åˆ Varint **CONSTANTS**ï¼Œè¯»å– **TAG** + å…·ä½“å€¼ã€‚

* & 0xff
æ“ä½œï¼Œè¡¥å›**è¢«æˆªå–æœ€é«˜çš„ 1**ï¼Œä»è€Œæ¢å¤**åŸæ•°**ï¼Œå¯¹åº”

/#writeVarint32(int v)
æ–¹æ³•çš„ã€ç¬¬ 18 ä½ã€‘ã€‚
* | 0xff000000
æ“ä½œï¼Œè¡¥é½è´Ÿæ•°çš„**é«˜ä½**ï¼Œå¯¹åº”

/#writeVarint32(int v)
æ–¹æ³•çš„ã€ç¬¬ 30 è‡³ 36 ä½ã€‘ã€‚
* ç¬¬ 31 è‡³ 36 è¡Œï¼šç¬¦åˆ Varint **CONSTANTS**ï¼Œè¿”å›å¯¹åº”çš„å€¼ã€‚

### 3.2.5 readInt

```
@Override
public int readInt() throws IOException{
return readVarint32();
}
```

### 3.2.6 readLong

```
@Override
public long readLong() throws IOException{
return readVarint64();
}
```

* [
/#readVarint64()
](https://github.com/YunaiV/dubbo/blob/335c72aeb45923681148d1a706f24ee2e6ba1020/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/GenericDataInput.java#L386-L555) å’Œ

/#readVarint32()
åŸºæœ¬ä¸€è‡´ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚

### 3.2.7 readFloat

```
@Override
public float readFloat() throws IOException{
return Float.intBitsToFloat(readVarint32());
}
```

### 3.2.8 readDouble

```
@Override
public double readDouble() throws IOException{
return Double.longBitsToDouble(readVarint64());
}
```

### 3.2.9 readUInt

```
public int readUInt() throws IOException{
// è¯»å–å­—èŠ‚
byte tmp = read0(); // ç”¨äºæš‚å­˜å½“å‰è¯»å–ç»“æœ
// ã€ç¬¬ä¸€æ¬¡ã€‘
if (tmp < 0) { // è´Ÿæ•°ï¼Œæ„å‘³ç€æ— åç»­
return tmp & 0x7f;
}
int ret = tmp & 0x7f; // æœ€ç»ˆç»“æœ
// ã€ç¬¬äºŒæ¬¡ã€‘
if ((tmp = read0()) < 0) { // è´Ÿæ•°ï¼Œæ„å‘³ç€æ— åç»­
ret |= (tmp & 0x7f) << 7; // æ‹¼æ¥ tmp + ret
} else {
ret |= tmp << 7;
// ã€ç¬¬ä¸‰æ¬¡ã€‘
if ((tmp = read0()) < 0) { // è´Ÿæ•°ï¼Œæ„å‘³ç€æ— åç»­
ret |= (tmp & 0x7f) << 14;
} else {
ret |= tmp << 14;
// ã€ç¬¬å››æ¬¡ã€‘
if ((tmp = read0()) < 0) { // è´Ÿæ•°ï¼Œæ„å‘³ç€æ— åç»­
ret |= (tmp & 0x7f) << 21;
// ã€ç¬¬äº”æ¬¡ã€‘5 /* 7 > 32 ï¼Œæ‰€ä»¥å¯ä»¥ç»“æŸ
} else {
ret |= tmp << 21;
ret |= (read0() & 0x7f) << 28;
}
}
}
return ret;
}
```

### 3.2.10 readBytes

```
@Override
public byte[] readBytes() throws IOException {
// è¯»å–å­—èŠ‚
byte b = read0();
switch (b) {
case OBJECT_BYTES: // æ•°ç»„éç©º
return read0(readUInt());
case OBJECT_NULL: // NULL
return null;
case OBJECT_DUMMY: // æ•°ç»„ä¸ºç©º
return EMPTY_BYTES;
default:
throw new IOException("Tag error, expect BYTES|BYTES_NULL|BYTES_EMPTY, but get " + b);
}
}
```

* /#read0(int len)
æ–¹æ³•ï¼Œæ‰¹é‡è¯»å–å­—èŠ‚ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
protected byte[] read0(int len) throws IOException {
int rem = mRead - mPosition;
byte[] ret = new byte[len];
// æœªè¶…è¿‡ mBuffer å‰©ä½™å¯è¯»å–ï¼Œæ‰¹é‡å†™å…¥ mBuffer ä¸­ã€‚mBuffer => ret
if (len <= rem) {
System.arraycopy(mBuffer, mPosition, ret, 0, len);
mPosition += len;
} else {
// éƒ¨åˆ†æ‰¹é‡å†™å…¥ ref ä¸­ã€‚mBuffer => ret
System.arraycopy(mBuffer, mPosition, ret, 0, rem);
mPosition = mRead;
len -= rem;
int read, pos = rem; // æ–°çš„ ret è¯»å–èµ·ç‚¹
// mInput => ret
while (len > 0) {
read = mInput.read(ret, pos, len);
if (read == -1) {
throw new EOFException();
}
pos += read; // æ–°çš„ ret è¯»å–èµ·ç‚¹
len -= read;
}
}
return ret;
}
```

### 3.2.11 readUTF

```
1: @Override
2: public String readUTF() throws IOException{
3: // è¯»å–å­—èŠ‚
4: byte b = read0();
5: switch (b) {
6: // å­—ç¬¦ä¸²éç©º
7: case OBJECT_BYTES:
8: // è¯»å–é•¿åº¦
9: int len = readUInt();
10: // ååºåˆ—åŒ–å‡ºå­—ç¬¦ä¸²
11: StringBuilder sb = new StringBuilder();
12: for (int i = 0; i < len; i++) {
13: // è¯»å–é¦–ä½
14: byte b1 = read0();
15: if ((b1 & 0x80) == 0) { // [0, 128) ASCII ç 
16: sb.append((char) b1);
17: } else if ((b1 & 0xE0) == 0xC0) { // [128, 2048)
18: byte b2 = read0();
19: sb.append((char) (((b1 & 0x1F) << 6) | (b2 & 0x3F)));
20: } else if ((b1 & 0xF0) == 0xE0) { // [2048, 65536)
21: byte b2 = read0(), b3 = read0();
22: sb.append((char) (((b1 & 0x0F) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F)));
23: } else
24: throw new UTFDataFormatException("Bad utf-8 encoding at " + b1);
25: }
26: return sb.toString();
27: // NULL
28: case OBJECT_NULL:
29: return null;
30: // å­—ç¬¦ä¸²ä¸ºç©º
31: case OBJECT_DUMMY:
32: return EMPTY_STRING;
33: default:
34: throw new IOException("Tag error, expect BYTES|BYTES_NULL|BYTES_EMPTY, but get " + b);
35: }
36: }
```

* ç¬¬ 13 è‡³ 25 è¡Œï¼šååºåˆ—åŒ–**æ¯ä¸ªå­—ç¬¦**ï¼Œé€šè¿‡é¦–ä½æ•°çš„**é«˜ä½**æ¥åˆ¤æ–­ï¼Œåˆ°åº•å®Œæ•´çš„å­—ç¬¦ï¼Œå ç”¨äº†å‡ ä¸ªå­—èŠ‚:

* ç¬¬ 15 è‡³ 16 è¡Œï¼šæ•°æ®èŒƒå›´æ˜¯

[0, 128)
ï¼Œæœ€å¤§æ•° 127 çš„äºŒè¿›åˆ¶ä¸º

01 11 11 11
ï¼Œä½¿ç”¨

& 0x80
è¿ç®—åï¼Œä¼šç­‰äº 0 ã€‚
* ç¬¬ 17 è‡³ 19 è¡Œï¼šæ•°æ®èŒƒå›´æ˜¯

[128, 2048)
ï¼Œå› ä¸ºé¦–ä½æ•°å–å…­ä½ï¼Œå¹¶ä¸”ä½¿ç”¨

0xC0 |
è¿ç®—åï¼Œæ‰€ä»¥äºŒè¿›åˆ¶ä¸º

11 XX XX XX
ï¼Œä½¿ç”¨

& 0xE0
è¿ç®—åï¼Œä¼šç­‰äº

0XC0
ã€‚

* ã€ç¬¬ 15 è‡³ 16 è¡Œã€‘å¦‚æœä½¿ç”¨

& 0x80
è¿ç®—ï¼Œ ä¸ä¼šç­‰äº 0 ï¼Œä¸ç¬¦åˆè¦æ±‚ã€‚

* ç¬¬ 20 è‡³ 22 è¡Œï¼šæ•°æ®èŒƒå›´æ˜¯

[2048, 65536)
ï¼Œå› ä¸ºé¦–ä½æ•°å–äº”ä½ï¼Œå¹¶ä¸”ä½¿ç”¨

0xE0 |
è¿ç®—åï¼Œæ‰€ä»¥äºŒè¿›åˆ¶ä¸º

11 1X XX XX
ï¼Œä½¿ç”¨

& 0xF0
è¿ç®—åï¼Œä¼šç­‰äº

0xE0
ã€‚
* ã€ç¬¬ 15 è‡³ 16 è¡Œã€‘å¦‚æœä½¿ç”¨

& 0x80
è¿ç®—ï¼Œ ä¸ä¼šç­‰äº 0 ï¼Œä¸ç¬¦åˆè¦æ±‚ã€‚
* ã€ç¬¬ 17 è‡³ 19 è¡Œã€‘å¦‚æœä½¿ç”¨

& 0xE0
è¿ç®—ï¼Œä¸ä¼šç­‰äº

0xC0
ï¼Œä¸ç¬¦åˆè¦æ±‚ã€‚

# 4. Object

## 4.1 GenericObjectOutput

[
com.alibaba.dubbo.common.serialize.support.dubbo.GenericObjectOutput
](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/GenericObjectOutput.java) ï¼Œå®ç° ObjectOutput æ¥å£ï¼Œç»§æ‰¿ GenericObjectOutput ç±»ï¼ŒDubbo å¯¹è±¡è¾“å‡ºå®ç°ç±»ã€‚

### 4.1.1 æ„é€ æ–¹æ³•

```
//*/*
/* å¯¹è±¡æ˜¯å¦å…è®¸ä¸å®ç° {@link java.io.Serializable} æ¥å£
/*/
private final boolean isAllowNonSerializable;
//*/*
/* ç±»æè¿°åŒ¹é…å™¨
/*/
private ClassDescriptorMapper mMapper;
//*/*
/* å¾ªç¯å¼•ç”¨é›†åˆ
/*
/* KEY ï¼šå¯¹è±¡
/* VALUE ï¼šå¼•ç”¨ç¼–å·
/*/
private Map<Object, Integer> mRefs = new ConcurrentHashMap<Object, Integer>();
```

* isAllowNonSerializable
å±æ€§ï¼Œå¯¹è±¡æ˜¯å¦å…è®¸ä¸å®ç° Serializable æ¥å£ã€‚Dubbo åºåˆ—åŒ–æ— éœ€å¼ºåˆ¶å®ç° Serializable æ¥å£ã€‚è€ƒè™‘åˆ°é€šç”¨æ€§ï¼Œé»˜è®¤

false
**ä¸å…è®¸**ã€‚
* mMapper
å±æ€§ï¼Œç±»æè¿°åŒ¹é…å™¨ã€‚é€šè¿‡è¯¥åŒ¹é…å™¨ï¼Œå¯ä»¥å°†ç±»æè¿°ï¼Œè½¬æ¢æˆå¯¹åº”çš„æè¿°ç¼–å·ï¼Œä»è€ŒåŠ é€Ÿåºåˆ—åŒ–çš„é€Ÿåº¦ï¼Œå‡å°‘ä½“ç§¯ï¼Œç±»ä¼¼ Kryo çš„**æ³¨å†Œ**ã€‚é»˜è®¤ä½¿ç”¨ Builder çš„ **DEFAULT_CLASS_DESCRIPTOR_MAPPER** å®ç°ç±»ã€‚
* mRefs
å±æ€§ï¼Œå¾ªç¯å¼•ç”¨é›†åˆï¼Œå’Œ FastJSON çš„ [ã€Šå¾ªç¯å¼•ç”¨ã€‹](https://github.com/alibaba/fastjson/wiki/%E5%BE%AA%E7%8E%AF%E5%BC%95%E7%94%A8) ä¸Šï¼Œæ¦‚å¿µæ˜¯ä¸€è‡´çš„ã€‚åœ¨ AbstractObjectBuilder ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°**å¾ªç¯å¼•ç”¨**çš„å®ç°ã€‚

### 4.1.2 writeObject

```
1: @Override
2: @SuppressWarnings({"unchecked", "rawtypes"})
3: public void writeObject(Object obj) throws IOException{
4: // NULL ï¼Œä½¿ç”¨ OBJECT_NULL å†™å…¥ mBuffer
5: if (obj == null) {
6: write0(OBJECT_NULL);
7: return;
8: }
9: // ç©ºå¯¹è±¡ï¼Œä½¿ç”¨ OBJECT_DUMMY å†™å…¥ mBuffer
10: Class<?> c = obj.getClass();
11: if (c == Object.class) {
12: write0(OBJECT_DUMMY);
13: } else {
14: // è·å¾—ç±»æè¿°
15: String desc = ReflectUtils.getDesc(c);
16: // æŸ¥è¯¢ç±»æè¿°ç¼–å·
17: int index = mMapper.getDescriptorIndex(desc);
18: // ä¸å­˜åœ¨ï¼Œä½¿ç”¨ OBJECT_DESC + ç±»æè¿° å†™å…¥ mBuffer
19: if (index < 0) {
20: write0(OBJECT_DESC);
21: writeUTF(desc);
22: // å­˜åœ¨ï¼Œä½¿ç”¨ OBJECT_DESC_ID + ç±»æè¿°ç¼–å· å†™å…¥ mBuffer
23: } else {
24: write0(OBJECT_DESC_ID);
25: writeUInt(index);
26: }
27: // è·å¾—ç±»å¯¹åº”çš„åºåˆ—åŒ– Builder
28: Builder b = Builder.register(c, isAllowNonSerializable);
29: // åºåˆ—åŒ–åˆ° mBuffer ä¸­
30: b.writeTo(obj, this);
31: }
32: }
```

* ã€ç¬¬ä¸€ç§ã€‘ç¬¬ 4 è‡³ 8 è¡Œï¼šå¯¹è±¡ä¸º NULL ï¼Œå†™å…¥ **OBJECT_NULL** åˆ°

mBuffer
ã€‚
* ã€ç¬¬äºŒç§ã€‘ç¬¬ 9 è‡³ 12 è¡Œï¼šå¯¹è±¡ä¸º Object ç±»å‹ï¼Œå†™å…¥ **OBJECT_DUMMY** åˆ°

mBuffer
ã€‚
* ã€ç¬¬ä¸‰ç§ã€‘ç¬¬ 13 è‡³ 30 è¡Œï¼šå¯¹è±¡éç©ºï¼Œå†™å…¥ **ç±»æè¿° + å¯¹è±¡** åˆ°

mBuffer
ã€‚

* ç¬¬ 15 è¡Œï¼šè°ƒç”¨

ReflectUtils/#getDesc(c)
æ–¹æ³•ï¼Œè·å¾—ç±»æè¿°ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public static String getDesc(Class<?> c){
StringBuilder ret = new StringBuilder();
// Array
while (c.isArray()) {
ret.append('[');
c = c.getComponentType();
}
// åŸºæœ¬ç±»å‹
if (c.isPrimitive()) {
String t = c.getName();
if ("void".equals(t)) ret.append(JVM_VOID);
else if ("boolean".equals(t)) ret.append(JVM_BOOLEAN);
else if ("byte".equals(t)) ret.append(JVM_BYTE);
else if ("char".equals(t)) ret.append(JVM_CHAR);
else if ("double".equals(t)) ret.append(JVM_DOUBLE);
else if ("float".equals(t)) ret.append(JVM_FLOAT);
else if ("int".equals(t)) ret.append(JVM_INT);
else if ("long".equals(t)) ret.append(JVM_LONG);
else if ("short".equals(t)) ret.append(JVM_SHORT);
// ç±»
} else {
ret.append('L');
ret.append(c.getName().replace('.', '/'));
ret.append(';');
}
return ret.toString();
}
```

* x
* ç¬¬ 17 è¡Œï¼šè°ƒç”¨

ClassDescriptorMapper/#getDescriptorIndex(desc)
æ–¹æ³•ï¼Œè·å¾—ç±»æè¿°**ç¼–å·**ã€‚

* ã€ä¸å­˜åœ¨ã€‘ç¬¬18 è‡³ 21 è¡Œï¼šå†™å…¥ **OBJECT_DESC** + **ç±»æè¿°**(å­—ç¬¦ä¸²) åˆ°

mBuffer
ä¸­ã€‚
* ã€å·²å­˜åœ¨ã€‘ç¬¬ 22 è‡³ 26 è¡Œï¼šå†™å…¥ **OBJECT_DESC_ID** + **ç±»æè¿°ç¼–å·**(ç¼–å·) åˆ°

mBuffer
ä¸­ã€‚
* ğŸ™‚ å¾ˆæ˜æ˜¾ï¼Œç¬¬äºŒç§çš„æ€§èƒ½å’Œä½“ç§¯éƒ½æ›´å¥½ã€‚å½“ç„¶ï¼Œéœ€è¦ä¿è¯ Server å’Œ Client çš„ç±»æè¿°ç¼–å·æ˜¯ä¸€è‡´çš„ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åªæ³¨å†Œ**å¸¸ç”¨**çš„æ•°æ®ç±»å‹åˆ° ClassDescriptorMapper ä¸­ã€‚
* ç¬¬ 28 è¡Œï¼šè°ƒç”¨

Builder/#register(Class<T> c, boolean isAllowNonSerializable)
æ–¹æ³•ï¼Œè·å¾—ç±»**å¯¹åº”**çš„ Builder å¯¹è±¡ã€‚
* ç¬¬ 30 è¡Œï¼šè°ƒç”¨

Builder/#writeToT obj, GenericObjectOutput out)
æ–¹æ³•ï¼Œ**åºåˆ—åŒ–**å¯¹è±¡åˆ° GenericObjectOutput ä¸­çš„è¾“å‡ºæµã€‚**ä¸ºä»€ä¹ˆå¯ä»¥è¿™ä¹ˆåš**ï¼Ÿçœ‹å®Œ [ã€Œ6. Builderã€](http://svip.iocoder.cn/Dubbo/serialize-2-dubbo/) çš„åˆ†äº«ï¼Œèƒ–å‹å°±ä¼šæ‰¾åˆ°ç­”æ¡ˆã€‚ğŸ™‚ å–ä¸ªå°å…³å­ã€‚

### 4.1.3 addRef

```
//*/*
/* æ·»åŠ å¾ªç¯å¼•ç”¨
/*
/* @param obj å¯¹è±¡
/*/
public void addRef(Object obj){
mRefs.put(obj, mRefs.size() //*/* å¼•ç”¨ç¼–å· /*/*/ );
}
```

### 4.1.4 getRef

```
//*/*
/* è·å¾—å¾ªç¯å¼•ç”¨ç¼–å·
/*
/* @param obj å¯¹è±¡
/* @return å¼•ç”¨ç¼–å·
/*/
public int getRef(Object obj){
Integer ref = mRefs.get(obj);
if (ref == null) {
return -1;
}
return ref;
}
```

## 4.2 GenericObjectInput

[
com.alibaba.dubbo.common.serialize.support.dubbo.GenericObjectInput
](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/GenericObjectInput.java) ï¼Œå®ç° ObjectInput æ¥å£ï¼Œç»§æ‰¿ GenericDataInput ç±»ï¼ŒDubbo å¯¹è±¡**è¾“å…¥**å®ç°ç±»ã€‚

### 4.2.1 æ„é€ æ–¹æ³•

```
//*/*
/* {@link /#skipAny()} ç©ºå¯¹è±¡
/*/
private static Object SKIPPED_OBJECT = new Object();
//*/*
/* ç±»æè¿°åŒ¹é…å™¨
/*/
private ClassDescriptorMapper mMapper;
//*/*
/* å¾ªç¯å¼•ç”¨æ•°ç»„
/*/
private List<Object> mRefs = new ArrayList<Object>();
```

### 4.2.2 readObject

```
1: @Override
2: public Object readObject() throws IOException{
3: String desc;
4: // è¯»å–å­—èŠ‚
5: byte b = read0();
6: switch (b) {
7: case OBJECT_NULL: // NULL
8: return null;
9: case OBJECT_DUMMY: // ç©ºå¯¹è±¡
10: return new Object();
11: case OBJECT_DESC: { // ç±»æè¿°
12: desc = readUTF();
13: break;
14: }
15: case OBJECT_DESC_ID: { // ç±»æè¿°ç¼–å·
16: // è¯»å–ç±»æè¿°ç¼–å·
17: int index = readUInt();
18: // è·å¾—ç±»æè¿°
19: desc = mMapper.getDescriptor(index);
20: if (desc == null) {
21: throw new IOException("Can not find desc id: " + index);
22: }
23: break;
24: }
25: default:
26: throw new IOException("Flag error, expect OBJECT_NULL|OBJECT_DUMMY|OBJECT_DESC|OBJECT_DESC_ID, get " + b);
27: }
28: try {
29: // è·å¾—ç±»
30: Class<?> c = ReflectUtils.desc2class(desc);
31: // è·å¾—ç±»å¯¹åº”çš„åºåˆ—åŒ– Builder
32: // ååºåˆ—åŒ–æˆå¯¹è±¡è¿”å›
33: return Builder.register(c).parseFrom(this);
34: } catch (ClassNotFoundException e) {
35: throw new IOException("Read object failed, class not found. " + StringUtils.toString(e));
36: }
37: }
```

* ç¬¬ 30 è¡Œï¼šè°ƒç”¨

ReflectUtils/#desc2class(desc)
æ–¹æ³•ï¼Œè·å¾—ç±»ã€‚
* ç¬¬ 33 è¡Œï¼šè°ƒç”¨

Builder/#register(Class<T> c, boolean isAllowNonSerializable)
æ–¹æ³•ï¼Œè·å¾—ç±»**å¯¹åº”**çš„ Builder å¯¹è±¡ã€‚
* ç¬¬ 33 è¡Œï¼šè°ƒç”¨

Builder/#parseFrom(GenericObjectInput)
æ–¹æ³•ï¼Œååºåˆ—åŒ–æˆ**å¯¹è±¡**è¿”å›ã€‚

### 4.2.3 addRef

```
//*/*
/* æ·»åŠ å¾ªç¯å¼•ç”¨
/*
/* @param obj å¯¹è±¡
/*/
public void addRef(Object obj){
mRefs.add(obj);
}
```

### 4.2.4 getRef

```
//*/*
/* è·å¾—å¾ªç¯å¼•ç”¨
/*
/* @param index å¼•ç”¨ç¼–å·
/* @return å¯¹è±¡
/* @throws IOException å½“å‘ç”Ÿ IO å¼‚å¸¸æ—¶
/*/
public Object getRef(int index) throws IOException{
if (index < 0 || index >= mRefs.size()) {
return null;
}
// è·å¾—å¯¹è±¡
Object ret = mRefs.get(index);
// åœ¨ skyAny() è®¾ç½®
if (ret == SKIPPED_OBJECT) {
throw new IOException("Ref skipped-object.");
}
return ret;
}
```

### 4.2.5 skipAny

ã€TODO 8035ã€‘1ã€å·²ç»é™åˆ¶çš„å¤§å°ï¼Œè¿™å—ä»£ç æ²¡ç”¨äº†å•Šï¼Ÿï¼

èƒ–å‹å¯å…ˆæ— è§†è¿™ä¸ªæ–¹æ³•ã€‚

# 5. ClassDescriptorMapper

com.alibaba.dubbo.common.serialize.support.dubbo.ClassDescriptorMapper
ï¼Œç±»æè¿°åŒ¹é…å™¨æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š
```
// æ ¹æ®ç±»æè¿°ç¼–å·ï¼Œè·å¾—ç±»æè¿°
String getDescriptor(int index);
// æ ¹æ®ç±»æè¿°ï¼Œè·å¾—ç±»æè¿°ç¼–å·
int getDescriptorIndex(String desc);
```

## 5.1 DEFAULT_CLASS_DESCRIPTOR_MAPPER

DEFAULT_CLASS_DESCRIPTOR_MAPPER æ˜¯ Builder çš„å†…éƒ¨å±æ€§ã€‚
  ```
//*/*
/* ç±»æè¿°æ•°ç»„
/*/
private static final List<String> mDescList = new ArrayList<String>();
//*/*
/* ç±»æè¿°æ˜ å°„
/*/
private static final Map<String, Integer> mDescMap = new ConcurrentHashMap<String, Integer>();
//*/*
/* ClassDescriptorMapper é»˜è®¤å®ç°ç±»
/*/
public static ClassDescriptorMapper DEFAULT_CLASS_DESCRIPTOR_MAPPER = new ClassDescriptorMapper() {
@Override
public String getDescriptor(int index){
if (index < 0 || index >= mDescList.size()) {
return null;
}
return mDescList.get(index);
}
@Override
public int getDescriptorIndex(String desc){
Integer ret = mDescMap.get(desc);
return ret == null ? -1 : ret;
}
};
```

åœ¨ Builder çš„ **static** ä»£ç å—ï¼Œä¼šåˆå§‹åŒ–

mDescMap
å±æ€§ï¼Œä»£ç å¦‚ä¸‹ï¼š

```
static {
addDesc(boolean[].class);
addDesc(byte[].class);
addDesc(char[].class);
addDesc(short[].class);
addDesc(int[].class);
addDesc(long[].class);
addDesc(float[].class);
addDesc(double[].class);
addDesc(Boolean.class);
addDesc(Byte.class);
addDesc(Character.class);
addDesc(Short.class);
addDesc(Integer.class);
addDesc(Long.class);
addDesc(Float.class);
addDesc(Double.class);
addDesc(String.class);
addDesc(String[].class);
addDesc(ArrayList.class);
addDesc(HashMap.class);
addDesc(HashSet.class);
addDesc(Date.class);
addDesc(java.sql.Date.class);
addDesc(java.sql.Time.class);
addDesc(java.sql.Timestamp.class);
addDesc(java.util.LinkedList.class);
addDesc(java.util.LinkedHashMap.class);
addDesc(java.util.LinkedHashSet.class);
// ... çœç•¥æ— å…³ä»£ç 
}
private static void addDesc(Class<?> c){
String desc = ReflectUtils.getDesc(c); // ä¾‹å¦‚ï¼Œjava.lang.Byte ä¸º Ljava/lang/Byte;
// æ·»åŠ åˆ°é›†åˆä¸­
int index = mDescList.size();
mDescList.add(desc);
mDescMap.put(desc, index);
}
```

# 6. Builder

[
com.alibaba.dubbo.common.serialize.support.dubbo.Builder
](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/Builder.java) ï¼Œå®ç° GenericDataFlags æ¥å£ï¼Œå¯¹è±¡åºåˆ—åŒ–ä»£ç æ„å»ºå™¨**æŠ½è±¡ç±»**ã€‚åŠŸèƒ½å¦‚ä¸‹ï¼š

* 1. ç±»çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„**æŠ½è±¡å®šä¹‰**ã€‚
1. 
1. æä¾›**å¸¸ç”¨ç±»**( ä¾‹å¦‚ Integer ã€Long ã€Map ç­‰ç­‰ )çš„ Builder å®ç°ç±»ã€‚
1. 
1. åŸºäº **Javassist** è‡ªåŠ¨å®ç°**è‡ªå®šä¹‰ç±»**( ä¾‹å¦‚ User ã€Student ç­‰ç­‰ )çš„ Builder å®ç°ç±»ã€‚

ğŸ™‚ å¤§ä½“çš„ç±»ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2019_02_18/04.png)

## 6.1 æŠ½è±¡æ–¹æ³•

```
//*/*
/* @return Builder å¯¹åº”çš„ç±»
/*/
abstract public Class<T> getType();
//*/*
/* åºåˆ—åŒ–å¯¹è±¡åˆ° GenericObjectOutput ä¸­çš„è¾“å‡ºæµã€‚
/*
/* @param obj å¯¹è±¡
/* @param out GenericObjectOutput å¯¹è±¡
/* @throws IOException å½“å‘ç”Ÿ IO å¼‚å¸¸æ—¶ã€‚
/*/
abstract public void writeTo(T obj, GenericObjectOutput out) throws IOException;
// â†‘â†‘â†‘ è°ƒç”¨ä¸Šé¢æ–¹æ³•
public void writeTo(T obj, OutputStream os) throws IOException{
// å°† OutputStream å°è£…æˆ GenericObjectOutput å¯¹è±¡
GenericObjectOutput out = new GenericObjectOutput(os);
// å†™å…¥
writeTo(obj, out);
// åˆ·å…¥
out.flushBuffer();
}
//*/*
/* ååºåˆ—åŒ– GenericObjectInput æˆå¯¹è±¡
/*
/* @param in GenericObjectInput å¯¹è±¡
/* @return å¯¹è±¡
/* @throws IOException å½“ IO å‘ç”Ÿå¼‚å¸¸æ—¶
/*/
abstract public T parseFrom(GenericObjectInput in) throws IOException;
// â†‘â†‘â†‘ è°ƒç”¨ä¸Šé¢æ–¹æ³•
public T parseFrom(InputStream is) throws IOException{
return parseFrom(new GenericObjectInput(is)); // å°† InputStream å°è£…æˆ GenericObjectInput å¯¹è±¡
}
// â†‘â†‘â†‘ è°ƒç”¨ä¸Šé¢æ–¹æ³•
public T parseFrom(byte[] b) throws IOException{
return parseFrom(new UnsafeByteArrayInputStream(b)); // å°† byte[] å°è£…æˆ InputStream å¯¹è±¡
}
```

**ä¸‰ä¸ª**æŠ½è±¡æ–¹æ³•ï¼š

* å¯¹åº”ç±»
* åºåˆ—åŒ–
* ååºåˆ—åŒ–

## 6.2 register

```
//*/*
/* å®ç° Serializable æ¥å£çš„ç±»çš„ Builder å¯¹è±¡ç¼“å­˜
/*/
private static final Map<Class<?>, Builder<?>> BuilderMap = new ConcurrentHashMap<Class<?>, Builder<?>>();
//*/*
/* æœªå®ç° Serializable æ¥å£çš„ç±»çš„ Builder å¯¹è±¡ç¼“å­˜
/*/
private static final Map<Class<?>, Builder<?>> nonSerializableBuilderMap = new ConcurrentHashMap<Class<?>, Builder<?>>();
1: public static <T> Builder<T> register(Class<T> c, boolean isAllowNonSerializable){
2: // Object ç±»ï¼Œæˆ–è€…æ¥å£ï¼Œä½¿ç”¨ GenericBuilder
3: if (c == Object.class || c.isInterface()) {
4: return (Builder<T>) GenericBuilder;
5: }
6: // Array ç±»å‹ï¼Œä½¿ç”¨ GenericArrayBuilder
7: if (c == Object[].class) {
8: return (Builder<T>) GenericArrayBuilder;
9: }
10:
11: // è·å¾— Builder å¯¹è±¡
12: Builder<T> b = (Builder<T>) BuilderMap.get(c);
13: if (null != b) {
14: return b;
15: }
16:
17: // è¦æ±‚å®ç° Serializable æ¥å£ï¼Œä½†æ˜¯å¹¶æœªå®ç°ï¼Œåˆ™æŠ›å‡º IllegalStateException å¼‚å¸¸
18: boolean isSerializable = Serializable.class.isAssignableFrom(c);
19: if (!isAllowNonSerializable && !isSerializable) {
20: throw new IllegalStateException("Serialized class " + c.getName() +
21: " must implement java.io.Serializable (dubbo codec setting: isAllowNonSerializable = false)");
22: }
23:
24: // è·å¾— Builder å¯¹è±¡
25: b = (Builder<T>) nonSerializableBuilderMap.get(c);
26: if (null != b) {
27: return b;
28: }
29:
30: // ä¸å­˜åœ¨ï¼Œä½¿ç”¨ Javassist ç”Ÿæˆå¯¹åº”çš„ Builder ç±»ï¼Œå¹¶è¿›è¡Œåˆ›å»º Builder å¯¹è±¡ã€‚
31: b = newBuilder(c);
32:
33: // æ·»åŠ åˆ° Builder å¯¹è±¡ç¼“å­˜ä¸­
34: if (isSerializable) {
35: BuilderMap.put(c, b);
36: } else {
37: nonSerializableBuilderMap.put(c, b);
38: }
39:
40: return b;
41: }
```

* ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œèƒ–å‹çœ‹ä¸‹æ³¨é‡Šå“ˆã€‚æ¯”è¾ƒå¥‡æ€ªçš„æ˜¯

c.isInterface()
çš„åˆ¤æ–­ï¼Œä¸ºä»€ä¹ˆä½¿ç”¨

GenericBuilder
å¯¹è±¡ã€‚åœ¨ [ã€Œ6.4 GenericBuilderã€](http://svip.iocoder.cn/Dubbo/serialize-2-dubbo/)ä¼šçœ‹åˆ°ç­”æ¡ˆã€‚

## 6.3 å¸¸ç”¨æ•°æ®ç±»å‹çš„ Builder å®ç°

åœ¨ **static** ä»£ç å—ï¼Œåˆå§‹åŒ–äº†å¸¸ç”¨æ•°æ®ç±»å‹çš„ Builder å®ç°ï¼Œä»£ç å¦‚ä¸‹å›¾ï¼š

![å¸¸ç”¨æ•°æ®ç±»å‹çš„ Builder å®ç°](http://static2.iocoder.cn/images/Dubbo/2019_02_18/05.png)

ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹ç‚¹å‡» [é“¾æ¥](http://svip.iocoder.cn/Dubbo/serialize-2-dubbo/TODO) ï¼Œè‡ªå·±æŸ¥çœ‹ã€‚è¿™é‡Œæˆ‘ä»¬å°±ä»¥ **HashMap** çš„ Builder ä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
register(HashMap.class, new Builder<HashMap>() {
@Override
public Class<HashMap> getType(){
return HashMap.class;
}
@Override
public void writeTo(HashMap obj, GenericObjectOutput out) throws IOException{
// NULL ï¼Œå†™å…¥ OBJECT_NULL åˆ° mBuffer ä¸­
if (obj == null) {
out.write0(OBJECT_NULL);
// HashMap éç©º
} else {
// å†™å…¥ OBJECT_MAP åˆ° mBuffer ä¸­
out.write0(OBJECT_MAP);
// å†™å…¥ Length(Map å¤§å°) åˆ° mBuffer ä¸­
out.writeUInt(obj.size());
// å†™å…¥ KV åˆ° mBuffer ä¸­
for (Map.Entry entry : (Set<Map.Entry>) obj.entrySet()) {
out.writeObject(entry.getKey());
out.writeObject(entry.getValue());
}
}
}
@Override
public HashMap parseFrom(GenericObjectInput in) throws IOException{
// è¯»å–é¦–ä½å­—èŠ‚
byte b = in.read0();
// NULL ï¼Œè¿”å› null
if (b == OBJECT_NULL) {
return null;
}
if (b != OBJECT_MAP) {
throw new IOException("Input format error, expect OBJECT_NULL|OBJECT_MAP, get " + b + ".");
}
// è¯»å– Length(Map å¤§å°)
int len = in.readUInt();
// å¾ªç¯è¯»å– KV åˆ° HashMap
HashMap ret = new HashMap(len);
for (int i = 0; i < len; i++) {
ret.put(in.readObject(), in.readObject());
}
return ret;
}
});
```

## 6.4 GenericBuilder

GenericBuilder
ï¼Œå®ç° Builder æ¥å£ï¼Œ**é€šç”¨** Object çš„ Builder å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
static final Builder<Object> GenericBuilder = new Builder<Object>() {
@Override
public Class<Object> getType(){
return Object.class;
}
@Override
public void writeTo(Object obj, GenericObjectOutput out) throws IOException{
out.writeObject(obj);
}
@Override
public Object parseFrom(GenericObjectInput in) throws IOException{
return in.readObject();
}
};
```

é€‚ç”¨äº**æ‰€æœ‰å¯¹è±¡**ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿæˆ‘ä»¬ä»¥

/#writeTo(Object obj, GenericObjectOutput out)
æ–¹æ³•ï¼Œä¸¾ä¾‹å­ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨

GenericObjectOutput/#writeObject(obj)
æ–¹æ³•ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¼šè·å¾—

obj
å¯¹è±¡ï¼ŒçœŸæ­£çš„ Builder å¯¹è±¡ï¼Œä»è€Œåºåˆ—åŒ–ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![å¸¸ç”¨æ•°æ®ç±»å‹çš„ Builder å®ç°](http://static2.iocoder.cn/images/Dubbo/2019_02_18/05.png)

## 6.5 SerializableBuilder

SerializableBuilder
å±æ€§ï¼Œå®ç° Builder æ¥å£ï¼Œ**é€šç”¨** Serializable çš„ Builder å¯¹è±¡ï¼Œä½¿ç”¨ **Java åŸç”Ÿåºåˆ—åŒ–**æ–¹å¼å®ç°ã€‚**ç›®å‰**ä½¿ç”¨åœ¨ï¼š

* Throwable å¯¹è±¡ã€‚
* å¸¦æœ‰ **transient** ä¿®é¥°ç¬¦å±æ€§çš„ **Serializable** å®ç°ç±»ã€‚

å› ä¸ºæ˜¯**å¹¿æ³›**åŒ¹é…ï¼Œæ‰€ä»¥ä¸é€‚åˆè°ƒç”¨

/#register(Class<T> c, boolean isAllowNonSerializable)
æ–¹æ³•ï¼Œè¿›è¡Œæ³¨å†Œã€‚è€Œæ˜¯åœ¨

/#newObjectBuilder(Class<?> c)
æ–¹æ³•ï¼Œé€šè¿‡**ç¡¬ç¼–ç **åˆ¤æ–­åŒ¹é…è¿”å›ã€‚

å®ç°ä»£ç å¦‚ä¸‹ï¼š
```
static final Builder<Serializable> SerializableBuilder = new Builder<Serializable>() {
@Override
public Class<Serializable> getType(){
return Serializable.class;
}
@Override
public void writeTo(Serializable obj, GenericObjectOutput out) throws IOException{
// NULL ï¼Œå†™å…¥ OBJECT_NULL åˆ° mBuffer ä¸­
if (obj == null) {
out.write0(OBJECT_NULL);
// éç©º
} else {
// å†™å…¥ OBJECT_STREAM åˆ° mBuffer ä¸­
out.write0(OBJECT_STREAM);
// ä½¿ç”¨ compactjava åºåˆ—åŒ–å®ç°ï¼Œè¿›è¡Œåºåˆ—åŒ–
UnsafeByteArrayOutputStream bos = new UnsafeByteArrayOutputStream();
CompactedObjectOutputStream oos = new CompactedObjectOutputStream(bos);
oos.writeObject(obj);
oos.flush();
bos.close();
byte[] b = bos.toByteArray();
// å†™å…¥ Length( å­—èŠ‚æ•°ç»„é•¿åº¦ ) åˆ° mBuffer ä¸­
out.writeUInt(b.length);
// å†™å…¥ å­—èŠ‚æ•°ç»„ åˆ° mBuffer ä¸­
out.write0(b, 0, b.length);
}
}
@Override
public Serializable parseFrom(GenericObjectInput in) throws IOException{
// è¯»å–é¦–ä½å­—èŠ‚
byte b = in.read0();
// NULL ï¼Œè¿”å› null
if (b == OBJECT_NULL) {
return null;
}
if (b != OBJECT_STREAM) {
throw new IOException("Input format error, expect OBJECT_NULL|OBJECT_STREAM, get " + b + ".");
}
// ä½¿ç”¨ compactjava åºåˆ—åŒ–å®ç°ï¼Œè¿›è¡Œååºåˆ—åŒ–
UnsafeByteArrayInputStream bis = new UnsafeByteArrayInputStream(in.read0(in.readUInt()));
CompactedObjectInputStream ois = new CompactedObjectInputStream(bis);
try {
return (Serializable) ois.readObject();
} catch (ClassNotFoundException e) {
throw new IOException(StringUtils.toString(e));
}
}
};
```

## 6.6 AbstractObjectBuilder

AbstractObjectBuilder ï¼Œå®ç° Builder æ¥å£ï¼ŒBuilder **æŠ½è±¡ç±»**ã€‚ä¸»è¦å®ç°äº†**å¾ªç¯å¼•ç”¨**å¯¹è±¡çš„æ”¯æŒã€‚ä»£ç å¦‚ä¸‹ï¼š
```
@Override
public void writeTo(T obj, GenericObjectOutput out) throws IOException{
// NULL ï¼Œå†™å…¥ OBJECT_NULL åˆ° mBuffer ä¸­
if (obj == null) {
out.write0(OBJECT_NULL);
} else {
// è¯»å–å¾ªç¯å¼•ç”¨å¯¹è±¡ç¼–å·
int ref = out.getRef(obj);
if (ref < 0) { // ä¸å­˜åœ¨
// æ·»åŠ åˆ°å¾ªç¯å¼•ç”¨ä¸­ï¼Œä»è€Œè·å¾—ç¼–å·ã€‚ä¸‹æ¬¡åœ¨å†™å…¥ç›¸ç­‰å¯¹è±¡æ—¶ï¼Œå¯ä½¿ç”¨å¾ªç¯å¼•ç”¨ç¼–å·çš„æ–¹å¼ã€‚
out.addRef(obj);
// å†™å…¥ OBJECT åˆ° mBuffer ä¸­
out.write0(OBJECT);
// å†™å…¥ å¯¹è±¡ åˆ° mBuffer ä¸­ã€‚
writeObject(obj, out);
} else { // å­˜åœ¨
// å†™å…¥ OBJECT_REF åˆ° mBuffer ä¸­
out.write0(OBJECT_REF);
// å†™å…¥ å¾ªç¯å¼•ç”¨å¯¹è±¡ç¼–å· åˆ° mBuffer ä¸­
out.writeUInt(ref);
}
}
}
@Override
public T parseFrom(GenericObjectInput in) throws IOException{
// è¯»å–é¦–ä½å­—èŠ‚
byte b = in.read0();
switch (b) {
// å¯¹è±¡
case OBJECT: {
// åˆ›å»ºå¯¹è±¡
T ret = newInstance(in);
// æ·»åŠ åˆ°å¾ªç¯å¼•ç”¨ä¸­ï¼Œä»è€Œè·å¾—ç¼–å·ã€‚ä¸‹æ¬¡åœ¨è¯»å–åˆ°å¾ªç¯å¼•ç”¨å¯¹è±¡ç¼–å·æ—¶ï¼Œå¯ç›´æ¥è·å–åˆ°è¯¥å¯¹è±¡ã€‚
in.addRef(ret);
// ååºåˆ—åŒ– GenericObjectInput åˆ°å¯¹è±¡
readObject(ret, in);
// è¿”å›
return ret;
}
// å¾ªç¯å¼•ç”¨å¯¹è±¡ç¼–å·
case OBJECT_REF:
// è¯»å–å¾ªç¯å¼•ç”¨å¯¹è±¡ç¼–å·
// è·å¾—å¯¹åº”çš„å¯¹è±¡
return (T) in.getRef(in.readUInt());
// NULL ï¼Œè¿”å› null
case OBJECT_NULL:
return null;
default:
throw new IOException("Input format error, expect OBJECT|OBJECT_REF|OBJECT_NULL, get " + b);
}
}
```

* å’Œ Builder æä¾›çš„ä¸‰ä¸ª**æŠ½è±¡**æ–¹æ³•**ä¸€ä¸€å¯¹åº”**ï¼ŒAbstractObjectBuilder ä¹Ÿå®šä¹‰äº†**ä¸‰ä¸ªæŠ½è±¡æ–¹æ³•**ï¼š
```
//*/*
/* åˆ›å»º Builder å¯¹åº”ç±»çš„å¯¹è±¡
/*
/* @param in GenericObjectInput å¯¹è±¡
/* @return å¯¹åº”ç±»çš„å¯¹è±¡
/* @throws IOException å½“ IO å‘ç”Ÿå¼‚å¸¸æ—¶
/*/
abstract protected T newInstance(GenericObjectInput in) throws IOException;
//*/*
/* åºåˆ—åŒ–å¯¹è±¡åˆ° GenericObjectOutput ä¸­çš„è¾“å‡ºæµã€‚
/*
/* @param obj å¯¹è±¡
/* @param out GenericObjectOutput å¯¹è±¡
/* @throws IOException å½“ IO å‘ç”Ÿå¼‚å¸¸æ—¶
/*/
abstract protected void writeObject(T obj, GenericObjectOutput out) throws IOException;
//*/*
/* ååºåˆ—åŒ– GenericObjectInput åˆ°å¯¹è±¡
/*
/* @param ret å¯¹è±¡ã€‚
/* è¯¥å¯¹è±¡åœ¨ {@link /#parseFrom(GenericObjectInput)} ä¸­ï¼Œè°ƒç”¨ {@link /#newInstance(GenericObjectInput)} åˆ›å»º
/* @param in GenericObjectInput å¯¹è±¡
/* @throws IOException å½“ IO å‘ç”Ÿå¼‚å¸¸æ—¶
/*/
abstract protected void readObject(T ret, GenericObjectInput in) throws IOException;
```

### 6.6.1 GenericArrayBuilder

GenericArrayBuilder
ï¼Œå®ç° AbstractObjectBuilder æŠ½è±¡ç±»ï¼Œé€šç”¨**æ•°ç»„( Array )** çš„ Builder å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
static final Builder<Object[]> GenericArrayBuilder = new AbstractObjectBuilder<Object[]>() {
@Override
public Class<Object[]> getType() {
return Object[].class;
}
@Override
protected Object[] newInstance(GenericObjectInput in) throws IOException {
// è¯»å–æ•°ç»„é•¿åº¦ï¼Œå¹¶åˆ›å»ºæ•°ç»„å¯¹è±¡
return new Object[in.readUInt()];
}
@Override
protected void readObject(Object[] ret, GenericObjectInput in) throws IOException{
// å¾ªç¯è¯»å–æ¯ä¸ªå¯¹è±¡åˆ° ret ä¸­
for (int i = 0; i < ret.length; i++) {
ret[i] = in.readObject();
}
}
@Override
protected void writeObject(Object[] obj, GenericObjectOutput out) throws IOException{
// å†™å…¥ Length( æ•°ç»„å¤§å° ) åˆ° mBuffer
out.writeUInt(obj.length);
// å¾ªç¯å†™å…¥æ¯ä¸ªå¯¹è±¡åˆ° mBuffer ä¸­
for (Object item : obj) {
out.writeObject(item);
}
}
};
```

* å› ä¸º

GenericArrayBuilder
å®ç° AbstractObjectBuilder æŠ½è±¡ç±»ï¼Œæ‰€ä»¥ï¼Œè‹¥æ•°ç»„ä¸­æœ‰**ç›¸ç­‰**çš„å…ƒç´ ï¼Œå¯ä»¥ä½¿ç”¨**å¾ªç¯å¼•ç”¨**çš„åŠŸèƒ½ï¼Œä»è€Œæå‡è§£æé€Ÿåº¦ï¼Œé™ä½ä½“ç§¯ã€‚

### 6.6.2 å…¶ä»–å­ç±»

åœ¨

/#newObjectBuilder(Class<?> c)
ä¸­ï¼ŒåŸºäº Javassist **è‡ªåŠ¨å®ç°**æ¯ä¸ªç±»çš„ Builder ç±»ï¼Œå®ç°çš„å°±æ˜¯ AbstractObjectBuilder æŠ½è±¡ç±»ã€‚

## 6.5 newBuilder

```
private static <T> Builder<T> newBuilder(Class<T> c){
// åŸºç¡€ç±»å‹ï¼Œå·²ç»å†…ç½®ç›¸åº”çš„ Builder å®ç°ç±»ï¼ŒæŠ›å‡º RuntimeException å¼‚å¸¸ã€‚å› ä¸ºï¼Œå·²ç»åœ¨ GenericDataInput å’Œ GenericDataOutput å®ç°ã€‚
if (c.isPrimitive()) {
throw new RuntimeException("Can not create builder for primitive type: " + c);
}
if (logger.isInfoEnabled())
logger.info("create Builder for class: " + c);
Builder<?> builder;
// åˆ›å»º Array Builder å¯¹è±¡
if (c.isArray()) {
builder = newArrayBuilder(c);
// åˆ›å»º Object Builder å¯¹è±¡
} else {
builder = newObjectBuilder(c);
}
return (Builder<T>) builder;
}
```

### 6.5.1 newObjectBuilder

/#newObjectBuilder(Class<?> c)
ï¼ŒåŸºäº Javassist **è‡ªåŠ¨å®ç°**æ¯ä¸ªç±»çš„ Builder ç±»( ç»§æ‰¿ **AbstractObjectBuilder** æŠ½è±¡ç±» )ï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„ Builder å¯¹è±¡ã€‚ä»£ç è¶…çº§å†—é•¿ï¼Œè€è‰¿è‰¿å·²ç»æ·»åŠ å¥½äº†è¯¦ç»†çš„ä»£ç æ³¨é‡Šï¼Œèƒ–å‹ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/dubbo/blob/834ff308bda98adc1832e41e2544c88389eb1f1f/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/Builder.java#L1010-L1422) è‡ªå·±æŸ¥çœ‹ã€‚

å®ç°åŸç†ï¼Œç®€å•çš„è¯´ï¼Œå…¶å®å°±æ˜¯ï¼Œå¾ªç¯ç±»çš„**æ¯ä¸ª**å±æ€§ï¼Œ**æ‹¼æ¥**å¯¹åº”çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„**è¿‡ç¨‹**çš„ä»£ç å­—ç¬¦ä¸²ï¼Œæœ€ç»ˆæäº¤ç»™ Javassist ç”Ÿæˆç±»ã€‚

è‰¯å¿ƒå¦‚æˆ‘ï¼Œå¦‚ä¸‹æ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š

* Student å’Œ Info ç±» ï¼š
```
package com.alibaba.dubbo.common.serialize.dubbo;
// ... çœç•¥ import
public class YunaiBuilderTest{
public static class Student implements Serializable{
public String username;
public String password;
public Info info1;
public Info info2;
public Student student;
public final int a = 3;
}
public static class Info implements Serializable{
public String key;
}
}
```

* Student å¯¹åº”çš„ Builder ç±»ï¼š![Student å¯¹åº”çš„ Builder ç±»](http://static2.iocoder.cn/images/Dubbo/2019_02_18/07.png)
* Info å¯¹è±¡çš„ Builder ç±»ï¼š![Info å¯¹åº”çš„ Builder ç±»](http://static2.iocoder.cn/images/Dubbo/2019_02_18/08.png)

### 6.5.2 newEnumBuilder

/#newEnumBuilder(Class<?> c)
ï¼ŒåŸºäº Javassist **è‡ªåŠ¨å®ç°**æ¯ä¸ªç±»çš„ Builder ç±»( ç»§æ‰¿ **Builder** æ¥å£ )ï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„ Builder å¯¹è±¡ã€‚ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œè€è‰¿è‰¿å·²ç»æ·»åŠ å¥½äº†è¯¦ç»†çš„ä»£ç æ³¨é‡Šï¼Œèƒ–å‹ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/dubbo/blob/834ff308bda98adc1832e41e2544c88389eb1f1f/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/Builder.java#L1424-L1461) è‡ªå·±æŸ¥çœ‹ã€‚

å®ç°åŸç†ï¼Œç²—æš´çš„è¯´ï¼Œ**åºåˆ—åŒ–**ä½¿ç”¨

enum/#name()
æ–¹æ³•ï¼Œ**ååºåˆ—åŒ–**ä½¿ç”¨

Enum/#valueOf(Class<T> enumType, String name)
æ–¹æ³•ã€‚

### 6.5.3 newArrayBuilder

/#newArrayBuilder(Class<?> c)
ï¼ŒåŸºäº Javassist **è‡ªåŠ¨å®ç°**æ¯ä¸ªç±»çš„ Builder ç±»( ç»§æ‰¿ **Builder** æ¥å£ )ï¼Œå¹¶åˆ›å»ºå¯¹åº”çš„ Builder å¯¹è±¡ã€‚ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œè€è‰¿è‰¿å·²ç»æ·»åŠ å¥½äº†è¯¦ç»†çš„ä»£ç æ³¨é‡Šï¼Œèƒ–å‹ç‚¹å‡» [é“¾æ¥](https://github.com/YunaiV/dubbo/blob/834ff308bda98adc1832e41e2544c88389eb1f1f/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/dubbo/Builder.java#L899-L1008) è‡ªå·±æŸ¥çœ‹ã€‚

å®ç°åŸç†ï¼Œç›´æ¥çš„è¯´ï¼Œå¾ªç¯æ•°ç»„çš„**æ¯ä¸ª**å…ƒç´ ï¼Œ**æ‹¼æ¥**å¯¹åº”çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„**è¿‡ç¨‹**çš„ä»£ç å­—ç¬¦ä¸²ï¼Œæœ€ç»ˆæäº¤ç»™ Javassist ç”Ÿæˆç±»ã€‚

ğŸ™‚ æ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯ï¼Œå¤šç»´æ•°ç»„çš„å¤„ç†ï¼Œä¾‹å¦‚

int[][][]
ã€‚èƒ–å‹å¯ä»¥æƒ³æƒ³ã€‚å®é™…ï¼Œä¹Ÿæ˜¯æ¯”è¾ƒç®€å•çš„ã€‚

# 666. å½©è›‹

å¤§å››( 2012 )çš„æ—¶å€™ï¼Œå†™äº†è‡ªå·±çš„åºåˆ—åŒ–å®ç° [Ludaima_Protobuf](https://github.com/YunaiV/Ludaima_Protobuf) ï¼ŒåŸºäº Protobuf çš„é…ç½®æ–‡ä»¶

proto
ï¼Œè¯»å–ï¼Œç”Ÿæˆåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„é™æ€ç±»ï¼ŒåŸºæœ¬é›¶ä¼˜åŒ–ã€‚

ç°åœ¨å›å¤´çœ‹äº† Dubbo åºåˆ—åŒ–çš„å®ç°ï¼Œè¿˜æ˜¯æ”¶ç›Šè‰¯å¤šã€‚ç¾æ»‹æ»‹ã€‚