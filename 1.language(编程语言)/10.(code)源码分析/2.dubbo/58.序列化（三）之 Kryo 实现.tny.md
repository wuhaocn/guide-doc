<header class="article-header"><header class="article-header">
<h1 class="article-title">åºåˆ—åŒ–ï¼ˆä¸‰ï¼‰ä¹‹ Kryo å®ç°</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡åˆ†äº«åŸºäº&nbsp;<strong>Kryo</strong>&nbsp;çš„åºåˆ—åŒ–æ‹“å±•å®ç°ã€‚</p>
<blockquote>
<p><strong>Javaå¯¹è±¡åºåˆ—åŒ–æ¡†æ¶ Kryo</strong></p>
<p>Kryo æ˜¯ä¸€ä¸ªå¿«é€Ÿé«˜æ•ˆçš„Javaå¯¹è±¡å›¾å½¢åºåˆ—åŒ–æ¡†æ¶ï¼Œä¸»è¦ç‰¹ç‚¹æ˜¯æ€§èƒ½ã€é«˜æ•ˆå’Œæ˜“ç”¨ã€‚è¯¥é¡¹ç›®ç”¨æ¥åºåˆ—åŒ–å¯¹è±¡åˆ°æ–‡ä»¶ã€æ•°æ®åº“æˆ–è€…ç½‘ç»œã€‚</p>
<p>ç¤ºä¾‹ä»£ç ï¼š</p>
</blockquote>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">Kryo kryo = <span class="keyword">new</span> Kryo();</span><br /><span class="line"><span class="comment">// ...</span></span><br /><span class="line">Output output = <span class="keyword">new</span> Output(<span class="keyword">new</span> FileOutputStream(<span class="string">"file.bin"</span>));</span><br /><span class="line">SomeClass someObject = ...</span><br /><span class="line">kryo.writeObject(output, someObject);</span><br /><span class="line">output.close();</span><br /><span class="line"><span class="comment">// ...</span></span><br /><span class="line">Input input = <span class="keyword">new</span> Input(<span class="keyword">new</span> FileInputStream(<span class="string">"file.bin"</span>));</span><br /><span class="line">SomeClass someObject = kryo.readObject(input, SomeClass.class);</span><br /><span class="line">input.close();</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>æœ¬æ–‡æ¶‰åŠï¼Œç±»å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_02_21/01.png" alt="ç±»å›¾" /></p>
<h1 id="2-KryoSerialization">2. KryoSerialization</h1>
<p><code>com.alibaba.dubbo.common.serialize.support.kryo.KryoSerialization</code>&nbsp;ï¼Œå®ç° Serialization æ¥å£ï¼ŒKryo&nbsp;<strong>åºåˆ—åŒ–</strong>å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KryoSerialization</span> <span class="keyword">implements</span> <span class="title">Serialization</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">byte</span> <span class="title">getContentTypeId</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="number">8</span>;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getContentType</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="string">"x-application/kryo"</span>;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> ObjectOutput <span class="title">serialize</span><span class="params">(URL url, OutputStream out)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> KryoObjectOutput(out);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> ObjectInput <span class="title">deserialize</span><span class="params">(URL url, InputStream is)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> KryoObjectInput(is);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="3-KryoObjectInput">3. KryoObjectInput</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/kryo/KryoObjectInput.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.common.serialize.support.kryo.KryoObjectInput</code></a>&nbsp;ï¼Œå®ç° ObjectInput, Cleanable æ¥å£ï¼ŒKryo å¯¹è±¡<strong>è¾“å…¥</strong>å®ç°ç±»ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Kryo å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Kryo kryo;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Kryo è¾“å…¥</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Input input;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">KryoObjectInput</span><span class="params">(InputStream inputStream)</span> </span>{</span><br /><span class="line">    input = <span class="keyword">new</span> Input(inputStream);</span><br /><span class="line">    <span class="keyword">this</span>.kryo = KryoUtils.get();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>kryo</code>&nbsp;å±æ€§ï¼Œé€šè¿‡&nbsp;<code>KryoUtils#get()</code>&nbsp;æ–¹æ³•ï¼Œè·å–ã€‚</li>
</ul>
<p><strong>ObjectInput å®ç°æ–¹æ³•</strong></p>
<p>â‘  æ¥è‡ª DataInput çš„å®ç°æ–¹æ³•ï¼Œè°ƒç”¨&nbsp;<code>input</code>&nbsp;å¯¹åº”çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">readBool</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="keyword">return</span> input.readBoolean();</span><br /><span class="line">    } <span class="keyword">catch</span> (KryoException e) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(e);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>â‘¡ æ¥è‡ª ObjectInput çš„å®ç°æ–¹æ³•ï¼Œè°ƒç”¨&nbsp;<code>kryo</code>&nbsp;å¯¹åº”çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">readObject</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>{</span><br /><span class="line">    <span class="comment">// TODO optimization</span></span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="keyword">return</span> kryo.readClassAndObject(input);</span><br /><span class="line">    } <span class="keyword">catch</span> (KryoException e) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(e);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>é€šè¿‡è¯»å–<strong>ç±»</strong>ï¼Œåœ¨æ ¹æ®ç±»è§£æå…·ä½“å¯¹è±¡ï¼Œå­—èŠ‚å†…å®¹&ldquo;<strong>å¤§ä½“</strong>&rdquo;æ˜¯ [ Class, å¯¹è±¡äºŒè¿›åˆ¶æ•°æ® ] ã€‚åœ¨&nbsp;<a href="https://www.cnkirito.moe/2017/11/28/rpc-serialize-1/" target="_blank" rel="external nofollow noopener noreferrer">ã€Šæ·±å…¥ç†è§£RPCä¹‹åºåˆ—åŒ–ç¯‡ &ndash; Kryoã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/serialize-3-kryo/">ã€Œä¸‰ç§è¯»å†™æ–¹å¼ã€</a>&nbsp;ï¼Œå¯¹è¿™å—è§£æçš„ç›¸å½“ä¸é”™ã€‚</li>
</ul>
<p><strong>Cleanable å®ç°æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// é‡Šæ”¾ Kryo å¯¹è±¡</span></span><br /><span class="line">    KryoUtils.release(kryo);</span><br /><span class="line">    <span class="comment">// æ¸…ç©º</span></span><br /><span class="line">    kryo = <span class="keyword">null</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="4-KryoObjectOutput">4. KryoObjectOutput</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/kryo/KryoObjectOutput.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.common.serialize.support.kryo.KryoObjectOutput</code></a>&nbsp;ï¼Œå®ç° ObjectOutput, Cleanable æ¥å£ï¼ŒKryo å¯¹è±¡<strong>è¾“å‡º</strong>å®ç°ç±»ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Kryo å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Kryo kryo;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Kryo è¾“å‡º</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Output output;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">KryoObjectOutput</span><span class="params">(OutputStream outputStream)</span> </span>{</span><br /><span class="line">    output = <span class="keyword">new</span> Output(outputStream);</span><br /><span class="line">    <span class="keyword">this</span>.kryo = KryoUtils.get();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>kryo</code>&nbsp;å±æ€§ï¼Œé€šè¿‡&nbsp;<code>KryoUtils#get()</code>&nbsp;æ–¹æ³•ï¼Œè·å–ã€‚</li>
</ul>
<p><strong>ObjectOutput å®ç°æ–¹æ³•</strong></p>
<p>â‘  æ¥è‡ª DataOutput çš„å®ç°æ–¹æ³•ï¼Œè°ƒç”¨&nbsp;<code>input</code>&nbsp;å¯¹åº”çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeBool</span><span class="params">(<span class="keyword">boolean</span> v)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line">    output.writeBoolean(v);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>â‘¡ æ¥è‡ª ObjectOutput çš„å®ç°æ–¹æ³•ï¼Œè°ƒç”¨&nbsp;<code>kryo</code>&nbsp;å¯¹åº”çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(Object v)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line">    <span class="comment">// TODO carries class info every time.</span></span><br /><span class="line">    kryo.writeClassAndObject(output, v);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>é€šè¿‡å†™å…¥<strong>ç±»</strong>&nbsp;+ å…·ä½“å¯¹è±¡ï¼Œå­—èŠ‚å†…å®¹&ldquo;<strong>å¤§ä½“</strong>&rdquo;æ˜¯ [ Class, å¯¹è±¡äºŒè¿›åˆ¶æ•°æ® ] ã€‚åœ¨&nbsp;<a href="https://www.cnkirito.moe/2017/11/28/rpc-serialize-1/" target="_blank" rel="external nofollow noopener noreferrer">ã€Šæ·±å…¥ç†è§£RPCä¹‹åºåˆ—åŒ–ç¯‡ &ndash; Kryoã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/serialize-3-kryo/">ã€Œä¸‰ç§è¯»å†™æ–¹å¼ã€</a>&nbsp;ï¼Œå¯¹è¿™å—è§£æçš„ç›¸å½“ä¸é”™ã€‚</li>
</ul>
<p><strong>Cleanable å®ç°æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// é‡Šæ”¾ Kryo å¯¹è±¡</span></span><br /><span class="line">    KryoUtils.release(kryo);</span><br /><span class="line">    <span class="comment">// æ¸…ç©º</span></span><br /><span class="line">    kryo = <span class="keyword">null</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="5-CompatibleKryo">5. CompatibleKryo</h1>
<p><code>com.alibaba.dubbo.common.serialize.support.kryo.CompatibleKryo</code>&nbsp;ï¼Œå®ç° Kryo ç±»ï¼Œå…¼å®¹<strong>ç©ºæ„é€ </strong>æ–¹æ³•çš„ Kryo å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Serializer <span class="title">getDefaultSerializer</span><span class="params">(Class type)</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (type == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"type cannot be null."</span>);</span><br /><span class="line"> <span class="number">5</span>:     }</span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// ç©ºæ„é€ æ–¹æ³•æ—¶ï¼Œä½¿ç”¨ JavaSerializer ï¼ŒJava åŸç”Ÿåºåˆ—åŒ–å®ç°</span></span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (!type.isArray() &amp;&amp; !type.isEnum() &amp;&amp; !ReflectionUtils.checkZeroArgConstructor(type)) {</span><br /><span class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (logger.isWarnEnabled()) {</span><br /><span class="line"> <span class="number">9</span>:             logger.warn(type + <span class="string">" has no zero-arg constructor and this will affect the serialization performance"</span>);</span><br /><span class="line"><span class="number">10</span>:         }</span><br /><span class="line"><span class="number">11</span>:         <span class="keyword">return</span> <span class="keyword">new</span> JavaSerializer();</span><br /><span class="line"><span class="number">12</span>:     }</span><br /><span class="line"><span class="number">13</span>:     <span class="comment">// ä½¿ç”¨ Kryo é»˜è®¤åºåˆ—åŒ–å®ç°</span></span><br /><span class="line"><span class="number">14</span>:     <span class="keyword">return</span> <span class="keyword">super</span>.getDefaultSerializer(type);</span><br /><span class="line"><span class="number">15</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ç¬¬ 6 è‡³ 12 è¡Œï¼šKryo ä¸æ”¯æŒä¸åŒ…å«<strong>ç©ºæ„é€ æ–¹æ³•</strong>çš„ç±»çš„åºåˆ—åŒ–ï¼Œå› æ­¤ï¼Œæ­¤æ—¶ä½¿ç”¨ Kryo å°è£…&nbsp;<strong>Java åŸç”Ÿåºåˆ—åŒ–</strong>å®ç°ç±»&nbsp;<code>com.esotericsoftware.kryo.serializers.JavaSerializer</code>&nbsp;ã€‚</p>
<ul>
<li>
<p><code>ReflectionUtils#checkZeroArgConstructor(type)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * åˆ¤æ–­ç±»æ˜¯å¦æœ‰ç©ºæ„é€ æ–¹æ³•</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> clazz ç±»</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> æ˜¯å¦</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkZeroArgConstructor</span><span class="params">(Class clazz)</span> </span>{</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        clazz.getDeclaredConstructor();</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br /><span class="line">    } <span class="keyword">catch</span> (NoSuchMethodException e) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>x</p>
</li>
</ul>
</li>
<li>
<p>ç¬¬ 14 è¡Œï¼šä½¿ç”¨ Kryo&nbsp;<strong>é»˜è®¤</strong>åºåˆ—åŒ–å®ç°ã€‚</p>
</li>
</ul>
<h1 id="6-KryoFactory">6. KryoFactory</h1>
<h2 id="6-1-AbstractKryoFactory">6.1 AbstractKryoFactory</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/kryo/utils/AbstractKryoFactory.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.common.serialize.support.kryo.utils.AbstractKryoFactory</code></a>&nbsp;ï¼Œå®ç°&nbsp;<code>com.esotericsoftware.kryo.pool.KryoFactory</code>&nbsp;æ¥å£ï¼ŒKryo&nbsp;<strong>å·¥å‚</strong>æŠ½è±¡ç±»ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * éœ€è¦æ³¨å†Œçš„ç±»çš„é›†åˆ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Class&gt; registrations = <span class="keyword">new</span> LinkedHashSet&lt;Class&gt;();</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦å¼€å¯æ³¨å†Œè¡Œä¸º</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> registrationRequired;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Kryo æ˜¯å¦å·²ç»åˆ›å»º</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> kryoCreated;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>registrations</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼Œéœ€è¦<strong>æ³¨å†Œ</strong>çš„ç±»çš„é›†åˆã€‚é€šè¿‡&nbsp;<code>#registerClass(Class)</code>&nbsp;æ–¹æ³•ï¼Œå¯ä»¥æ·»åŠ ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * only supposed to be called at startup time</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * later may consider adding support for custom serializer, custom id, etc</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerClass</span><span class="params">(Class clazz)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (kryoCreated) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Can't register class after creating kryo instance"</span>);</span><br /><span class="line">    }</span><br /><span class="line">    registrations.add(clazz);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>registrationRequired</code>&nbsp;å±æ€§ï¼Œæ˜¯å¦å¼€å¯<strong>æ³¨å†Œ</strong>è¡Œä¸ºï¼Œé»˜è®¤<strong>å…³é—­</strong>ã€‚</p>
<blockquote>
<p>Kryo æ”¯æŒå¯¹æ³¨å†Œè¡Œä¸ºï¼Œå¦‚&nbsp;<code>kryo.register(SomeClazz.class);</code>&nbsp;ï¼Œè¿™ä¼šèµ‹äºˆè¯¥ Class ä¸€ä¸ªä» 0 å¼€å§‹çš„ç¼–å·ï¼Œä½† Kryo ä½¿ç”¨æ³¨å†Œè¡Œä¸ºæœ€å¤§çš„é—®é¢˜åœ¨äºï¼Œå…¶ä¸ä¿è¯åŒä¸€ä¸ª Class æ¯ä¸€æ¬¡æ³¨å†Œçš„å·ç ç›¸åŒï¼Œè¿™ä¸æ³¨å†Œçš„é¡ºåºæœ‰å…³ï¼Œä¹Ÿå°±æ„å‘³ç€åœ¨ä¸åŒçš„æœºå™¨ã€åŒä¸€ä¸ªæœºå™¨é‡å¯å‰åéƒ½æœ‰å¯èƒ½æ‹¥æœ‰ä¸åŒçš„ç¼–å·ï¼Œè¿™ä¼šå¯¼è‡´åºåˆ—åŒ–äº§ç”Ÿé—®é¢˜ï¼Œæ‰€ä»¥åœ¨åˆ†å¸ƒå¼é¡¹ç›®ä¸­ï¼Œ<strong>ä¸€èˆ¬å…³é—­æ³¨å†Œè¡Œä¸º</strong>ã€‚</p>
</blockquote>
</li>
<li>
<p><code>kryoCreated</code>&nbsp;å±æ€§ï¼ŒKryo æ˜¯å¦å·²ç»åˆ›å»ºã€‚</p>
</li>
</ul>
<p><strong>æŠ½è±¡æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è¿”è¿˜ Kryo å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> kryo Kyro</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">returnKryo</span><span class="params">(Kryo kryo)</span></span>;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·å¾— Kryo å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> Kryo å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> Kryo <span class="title">getKryo</span><span class="params">()</span></span>;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p><strong>create</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Kryo <span class="title">create</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// æ ‡è®°å·²åˆ›å»º</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (!kryoCreated) {</span><br /><span class="line"> <span class="number">5</span>:         kryoCreated = <span class="keyword">true</span>;</span><br /><span class="line"> <span class="number">6</span>:     }</span><br /><span class="line"> <span class="number">7</span>: </span><br /><span class="line"> <span class="number">8</span>:     <span class="comment">// åˆ›å»º CompatibleKryo å¯¹è±¡</span></span><br /><span class="line"> <span class="number">9</span>:     Kryo kryo = <span class="keyword">new</span> CompatibleKryo();</span><br /><span class="line"><span class="number">10</span>: </span><br /><span class="line"><span class="number">11</span>:     <span class="comment">// TODO</span></span><br /><span class="line"><span class="number">12</span>: <span class="comment">//    kryo.setReferences(false);</span></span><br /><span class="line"><span class="number">13</span>:     kryo.setRegistrationRequired(registrationRequired);</span><br /><span class="line"><span class="number">14</span>: </span><br /><span class="line"><span class="number">15</span>:     <span class="comment">// æ³¨å†Œå¸¸ç”¨ç±»</span></span><br /><span class="line"><span class="number">16</span>:     kryo.register(Collections.singletonList(<span class="string">""</span>).getClass(), <span class="keyword">new</span> ArraysAsListSerializer());</span><br /><span class="line"><span class="number">17</span>:     kryo.register(GregorianCalendar.class, <span class="keyword">new</span> GregorianCalendarSerializer());</span><br /><span class="line"><span class="number">18</span>:     kryo.register(InvocationHandler.class, <span class="keyword">new</span> JdkProxySerializer());</span><br /><span class="line"><span class="number">19</span>:     kryo.register(BigDecimal.class, <span class="keyword">new</span> DefaultSerializers.BigDecimalSerializer());</span><br /><span class="line"><span class="number">20</span>:     kryo.register(BigInteger.class, <span class="keyword">new</span> DefaultSerializers.BigIntegerSerializer());</span><br /><span class="line"><span class="number">21</span>:     kryo.register(Pattern.class, <span class="keyword">new</span> RegexSerializer());</span><br /><span class="line"><span class="number">22</span>:     kryo.register(BitSet.class, <span class="keyword">new</span> BitSetSerializer());</span><br /><span class="line"><span class="number">23</span>:     kryo.register(URI.class, <span class="keyword">new</span> URISerializer());</span><br /><span class="line"><span class="number">24</span>:     kryo.register(UUID.class, <span class="keyword">new</span> UUIDSerializer());</span><br /><span class="line"><span class="number">25</span>:     UnmodifiableCollectionsSerializer.registerSerializers(kryo);</span><br /><span class="line"><span class="number">26</span>:     SynchronizedCollectionsSerializer.registerSerializers(kryo);</span><br /><span class="line"><span class="number">27</span>: </span><br /><span class="line"><span class="number">28</span>:     <span class="comment">// æ³¨å†Œå¸¸ç”¨æ•°æ®ç»“æ„</span></span><br /><span class="line"><span class="number">29</span>:     <span class="comment">// now just added some very common classes</span></span><br /><span class="line"><span class="number">30</span>:     <span class="comment">// TODO optimization</span></span><br /><span class="line"><span class="number">31</span>:     kryo.register(HashMap.class);</span><br /><span class="line"><span class="number">32</span>:     kryo.register(ArrayList.class);</span><br /><span class="line"><span class="number">33</span>:     kryo.register(LinkedList.class);</span><br /><span class="line"><span class="number">34</span>:     kryo.register(HashSet.class);</span><br /><span class="line"><span class="number">35</span>:     kryo.register(TreeSet.class);</span><br /><span class="line"><span class="number">36</span>:     kryo.register(Hashtable.class);</span><br /><span class="line"><span class="number">37</span>:     kryo.register(Date.class);</span><br /><span class="line"><span class="number">38</span>:     kryo.register(Calendar.class);</span><br /><span class="line"><span class="number">39</span>:     kryo.register(ConcurrentHashMap.class);</span><br /><span class="line"><span class="number">40</span>:     kryo.register(SimpleDateFormat.class);</span><br /><span class="line"><span class="number">41</span>:     kryo.register(GregorianCalendar.class);</span><br /><span class="line"><span class="number">42</span>:     kryo.register(Vector.class);</span><br /><span class="line"><span class="number">43</span>:     kryo.register(BitSet.class);</span><br /><span class="line"><span class="number">44</span>:     kryo.register(StringBuffer.class);</span><br /><span class="line"><span class="number">45</span>:     kryo.register(StringBuilder.class);</span><br /><span class="line"><span class="number">46</span>:     kryo.register(Object.class);</span><br /><span class="line"><span class="number">47</span>:     kryo.register(Object[].class);</span><br /><span class="line"><span class="number">48</span>:     kryo.register(String[].class);</span><br /><span class="line"><span class="number">49</span>:     kryo.register(<span class="keyword">byte</span>[].class);</span><br /><span class="line"><span class="number">50</span>:     kryo.register(<span class="keyword">char</span>[].class);</span><br /><span class="line"><span class="number">51</span>:     kryo.register(<span class="keyword">int</span>[].class);</span><br /><span class="line"><span class="number">52</span>:     kryo.register(<span class="keyword">float</span>[].class);</span><br /><span class="line"><span class="number">53</span>:     kryo.register(<span class="keyword">double</span>[].class);</span><br /><span class="line"><span class="number">54</span>: </span><br /><span class="line"><span class="number">55</span>:     <span class="comment">// `registrations` çš„æ³¨å†Œ</span></span><br /><span class="line"><span class="number">56</span>:     <span class="keyword">for</span> (Class clazz : registrations) {</span><br /><span class="line"><span class="number">57</span>:         kryo.register(clazz);</span><br /><span class="line"><span class="number">58</span>:     }</span><br /><span class="line"><span class="number">59</span>: </span><br /><span class="line"><span class="number">60</span>:     <span class="comment">// SerializableClassRegistry çš„æ³¨å†Œ</span></span><br /><span class="line"><span class="number">61</span>:     <span class="keyword">for</span> (Class clazz : SerializableClassRegistry.getRegisteredClasses()) {</span><br /><span class="line"><span class="number">62</span>:         kryo.register(clazz);</span><br /><span class="line"><span class="number">63</span>:     }</span><br /><span class="line"><span class="number">64</span>: </span><br /><span class="line"><span class="number">65</span>:     <span class="keyword">return</span> kryo;</span><br /><span class="line"><span class="number">66</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è‡³ 6 è¡Œï¼šæ ‡è®°å·²åˆ›å»º&nbsp;<code>kryoCreated = true</code>ã€‚</li>
<li>ç¬¬ 9 è¡Œï¼šåˆ›å»º CompatibleKryo å¯¹è±¡ã€‚</li>
<li>ç¬¬ 13 è¡Œï¼šè°ƒç”¨&nbsp;<code>Kryo#setRegistrationRequired(registrationRequired)</code>&nbsp;æ–¹æ³•ï¼Œè®¾ç½®æ˜¯å¦è¦<strong>å¼€å¯</strong>æ³¨å†Œçš„åŠŸèƒ½ã€‚</li>
<li>ğŸ™‚ å¼€å§‹ä¸€é¡¿æ³¨å†Œã€‚
<ul>
<li>ç¬¬ 15 è‡³ 26 è¡Œï¼šæ³¨å†Œ<strong>å¸¸ç”¨ç±»</strong>åˆ° Kryo å¯¹è±¡ã€‚</li>
<li>ç¬¬ 28 è‡³ 53 è¡Œï¼šæ³¨å†Œ<strong>å¸¸ç”¨æ•°æ®ç»“æ„</strong>åˆ° Kryo å¯¹è±¡ã€‚</li>
<li>ç¬¬ 55 è‡³ 58 è¡Œï¼šæ³¨å†Œ&nbsp;<code>registrations</code>&nbsp;åˆ° Kryo å¯¹è±¡ã€‚</li>
<li>ç¬¬ 60 è‡³ 63 è¡Œï¼šæ³¨å†Œ SerializableClassRegistry åˆ° Kryo å¯¹è±¡ã€‚</li>
</ul>
</li>
</ul>
<h2 id="6-2-ThreadLocalKryoFactory">6.2 ThreadLocalKryoFactory</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/kryo/utils/ThreadLocalKryoFactory.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.common.serialize.support.kryo.utils.ThreadLocalKryoFactory</code></a>&nbsp;ï¼Œå®ç° AbstractKryoFactory æŠ½è±¡ç±»ï¼ŒåŸºäº&nbsp;<strong>ThreadLocal</strong>&nbsp;çš„ Kryo å·¥å‚å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalKryoFactory</span> <span class="keyword">extends</span> <span class="title">AbstractKryoFactory</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;Kryo&gt; holder = <span class="keyword">new</span> ThreadLocal&lt;Kryo&gt;() {</span><br /><br /><span class="line">        <span class="meta">@Override</span></span><br /><span class="line">        <span class="function"><span class="keyword">protected</span> Kryo <span class="title">initialValue</span><span class="params">()</span> </span>{</span><br /><span class="line">            <span class="keyword">return</span> create(); <span class="comment">// åˆ›å»º Kryo</span></span><br /><span class="line">        }</span><br /><br /><span class="line">    };</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">returnKryo</span><span class="params">(Kryo kryo)</span> </span>{</span><br /><span class="line">        <span class="comment">// do nothing</span></span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Kryo <span class="title">getKryo</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> holder.get();</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>Kryo çš„åºåˆ—åŒ–å’Œååºåˆ—çš„è¿‡ç¨‹ï¼Œæ˜¯<strong>éçº¿ç¨‹å®‰å…¨</strong>çš„ã€‚æ‰€ä»¥é€šè¿‡ ThreadLocal æ¥ä¿è¯ï¼Œæ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰ä¸€ä¸ª Kryo å¯¹è±¡ã€‚</li>
</ul>
<h2 id="6-3-KryoUtils">6.3 KryoUtils</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/kryo/utils/KryoUtils.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.common.serialize.support.kryo.utils.KryoUtils</code></a>&nbsp;ï¼ŒKryo å·¥å…·ç±»ï¼Œç›®å‰ä»…ä»…å¯¹ KryoFactory è¿›è¡Œæ“ä½œã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KryoUtils</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AbstractKryoFactory kryoFactory = <span class="keyword">new</span> ThreadLocalKryoFactory();</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Kryo <span class="title">get</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> kryoFactory.getKryo();</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">(Kryo kryo)</span> </span>{</span><br /><span class="line">        kryoFactory.returnKryo(kryo);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>{</span><br /><span class="line">        kryoFactory.registerClass(clazz);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setRegistrationRequired</span><span class="params">(<span class="keyword">boolean</span> registrationRequired)</span> </span>{</span><br /><span class="line">        kryoFactory.setRegistrationRequired(registrationRequired);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="666-å½©è›‹">666. å½©è›‹</h1>
<p>æ¨èé˜…è¯»ï¼š</p>
<ul>
<li><a href="https://www.cnkirito.moe/2017/11/28/rpc-serialize-1/" target="_blank" rel="external nofollow noopener noreferrer">ã€Šæ·±å…¥ç†è§£RPCä¹‹åºåˆ—åŒ–ç¯‡ &ndash; Kryoã€‹</a></li>
<li><a href="https://blog.csdn.net/fanjunjaden/article/details/72823866" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠKryoå®˜æ–¹æ–‡æ¡£-ä¸­æ–‡ç¿»è¯‘ã€‹</a></li>
</ul>
</div>
</header>