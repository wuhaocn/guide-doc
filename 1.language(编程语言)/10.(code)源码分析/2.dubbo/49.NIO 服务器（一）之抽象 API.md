# NIO æœåŠ¡å™¨ï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ API

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

ä»æœ¬å°èŠ‚å¼€å§‹ï¼Œæˆ‘ä»¬æ¥åˆ†äº« Dubbo **è‡ªå·±**å®ç°çš„ NIO æœåŠ¡å™¨ï¼Œä½¿ç”¨åœ¨ [
dubbo://
](http://dubbo.apache.org/zh-cn/docs/user/references/protocol/dubbo.html) å’Œ [
thrift://
](http://dubbo.apache.org/zh-cn/docs/user/references/protocol/thrift.html) åè®®ä¸Šã€‚

åœ¨ NIO æ¡†æ¶çš„é€‰å‹ä¸Šï¼Œå¼ºå¤§çš„ Java ç¤¾åŒºé‡Œæœ‰ minaã€nettyã€grizzly ç­‰ï¼Œç”šè‡³ netty æä¾›äº† 3.x å’Œ 4.x çš„ç‰ˆæœ¬ã€‚é‚£ä¹ˆè¯¥å’‹åŠå‘¢ï¼Ÿ

Dubbo å¼€å‘å›¢é˜Ÿçš„é€‰æ‹©æ˜¯ï¼š

* API å±‚ï¼š

* dubbo-remoting-api
* å®ç°å±‚ï¼š

* dubbo-remoting-netty3
* dubbo-remoting-netty4
* dubbo-remoting-mina
* dubbo-remoting-grizzly
* dubbo-remoting-p2p

å†é…åˆä¸Š Dubbo SPI çš„æœºåˆ¶ï¼Œä½¿ç”¨è€…å¯ä»¥è‡ªå®šä¹‰ä½¿ç”¨å“ªä¸€ç§å…·ä½“çš„å®ç°ã€‚ç¾æ»‹æ»‹ã€‚

# 2. ä¸€è§ˆ

è¿˜æ˜¯è€æ ·å­ï¼Œç¬”è€…ä¹ æƒ¯æ€§å¯¹ä»£ç é‡è¿›è¡Œä¸‹ç»Ÿè®¡ï¼Œ

dubbo-remoting
çš„**ä»£ç é‡**å¦‚ä¸‹å›¾ï¼š

![ä»£ç é‡](http://static2.iocoder.cn/images/Dubbo/2018_12_01/01.png)

WTF ï¼ï¼ï¼

dubbo-remoting-api
çš„ä»£ç é‡ç«Ÿç„¶è¿‘**ä¸‡è¡Œ**ï¼Ÿ

{__/}
( â€¢ - â€¢)
/ã¤æ·¡å®š @èƒ–å‹

æˆ‘ä»¬æ¥é¦–å…ˆçœ‹ä¸€å¼ å›¾ï¼š
FROM [ã€ŠDubbo å¼€å‘æŒ‡å— â€”â€” æ¡†æ¶è®¾è®¡ã€‹](http://dubbo.apache.org/zh-cn/docs/dev/design.html)

![æ•´ä½“è®¾è®¡](http://static2.iocoder.cn/images/Dubbo/2018_12_01/02.png)

**çº¢æ¡†éƒ¨åˆ†**ï¼ŒProtocol => Exchange => Transport => Serialize çš„è°ƒç”¨é¡ºåºã€‚

* **exchange** ä¿¡æ¯äº¤æ¢å±‚ï¼šå°è£…è¯·æ±‚å“åº”æ¨¡å¼ï¼ŒåŒæ­¥è½¬å¼‚æ­¥ï¼Œä»¥ Request, Response ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸º Exchanger, ExchangeChannel, ExchangeClient, ExchangeServerã€‚
* **transport** ç½‘ç»œä¼ è¾“å±‚ï¼šæŠ½è±¡ mina å’Œ netty ä¸ºç»Ÿä¸€æ¥å£ï¼Œä»¥ Message ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸º Channel, Transporter, Client, Server, Codec
* **serialize** æ•°æ®åºåˆ—åŒ–å±‚ï¼šå¯å¤ç”¨çš„ä¸€äº›å·¥å…·ï¼Œæ‰©å±•æ¥å£ä¸º Serialization, ObjectInput, ObjectOutput, ThreadPool

åœ¨ç¬”è€…åˆçœ‹

dubbo-remoting-api
çš„ä»£ç æ—¶ï¼Œå¯¹ **exchange** å’Œ **transport** çš„ç†è§£æ˜¯æ¯”è¾ƒæ¨¡ç³Šçš„ã€‚ç®€å•æ¥è¯´ï¼Œ**exchange** åœ¨ **transport** ä¹‹ä¸Šï¼Œæ„é€ äº† Requestï¼ŒResponse æ¨¡å‹ï¼Œ**ä¸€ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ªå“åº”**ã€‚è¿™æ ·çš„æ–¹å¼ï¼Œæ‰ç¬¦åˆæˆ‘ä»¬å®é™…ä¸šåŠ¡å¼€å‘çš„éœ€è¦ã€‚å½“ç„¶ï¼Œå³ä½¿æ˜¯ Requestï¼ŒResponse ä¹Ÿåˆ†æˆ**åŒæ­¥å’Œå¼‚æ­¥**è¿”å›ï¼Œé‡è¦çš„æ˜¯ï¼Œèƒ½å¤Ÿ**ä¸€ä¸€æ˜ å°„**ã€‚

èƒ–å‹å¦‚æœæœ‰å…´è¶£ï¼Œå¯ä»¥çœ‹çœ‹ï¼š

* [ã€ŠRequestâ€“responseã€‹](https://en.wikipedia.org/wiki/Request%E2%80%93response)
* [ã€ŠClientâ€“server modelã€‹](https://en.wikipedia.org/wiki/Client%E2%80%93server_model)

çœ‹å®Œä»¥ä¸ŠçŸ¥è¯†ï¼Œæˆ‘ä»¬åœ¨å›è¿‡å¤´çœ‹

dubbo-remoting-api
çš„é¡¹ç›®ç»“æ„å°±æ¸…æ™°äº†ï¼š

![dubbo-remoting-api](http://static2.iocoder.cn/images/Dubbo/2018_12_01/03.png)

* æœ€å¤–å±‚ï¼šé€šç”¨æ¥å£ã€‚
* buffer
åŒ…ï¼šç¼“å†²åŒºã€‚
* exchange
åŒ…ï¼šä¿¡æ¯äº¤æ¢å±‚
* transporter
åŒ…ï¼šç½‘ç»œä¼ è¾“å±‚
* telnet
åŒ…ï¼š[Telnet å‘½ä»¤](http://dubbo.apache.org/zh-cn/docs/dev/impls/telnet-handler.html)

å¦‚ä¸Šçš„æ¯ä¸€å±‚/åŒ…ï¼Œæˆ‘ä»¬éƒ½ä¼šç‹¬ç«‹ä¸€ç¯‡æ–‡ç« ï¼Œè¿›è¡Œåˆ†äº«ã€‚
å½“ç„¶ï¼Œ

dubbo-remoting-api
æ¨¡å—ï¼Œåªè´Ÿè´£ API å±‚æŠ½è±¡å’Œéƒ¨åˆ†å®ç°ï¼Œæœ€ç»ˆèƒ½å¤Ÿ**çœŸæ­£é€šä¿¡**ï¼Œéœ€è¦

dubbo-remoting-netty
ç­‰ç­‰æ¨¡å—æ¥å®ç°ã€‚å¯¹åº”çš„æ¯ä¸€ä¸ªå®ç°æ¨¡å—ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯ç‹¬ç«‹ä¸€ç¯‡æ–‡ç« ã€‚

ğŸ™‚ æ˜¯ä¸æ˜¯å¾ˆæ¸…æ™°ï¼Œç¾æ»‹æ»‹ï¼Ÿ

# 3. æœ€å¤–å±‚ï¼šé€šç”¨æ¥å£

èƒ–å‹å…ˆçœ‹çœ‹ [ã€ŠNetty4.0å­¦ä¹ ç¬”è®°ç³»åˆ—ä¹‹ä¸€ï¼šServerä¸Clientçš„é€šè®¯ã€‹](https://blog.csdn.net/u013252773/article/details/21046697?self) **æ•™ç¨‹æ–‡ç« **ã€‚åœ¨è¯¥æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä½¿ç”¨ Netty åœ¨å››ä¸ªç±»ï¼š
* 1ã€HelloServer ï¼šserverç±»ï¼Œå¯åŠ¨Netty server
* 2ã€HelloServerInHandlerï¼šserverçš„handlerï¼Œæ¥æ”¶å®¢æˆ·ç«¯æ¶ˆæ¯ï¼Œå¹¶å‘å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯
* 3ã€HelloClientï¼šclientç±»ï¼Œå»ºç«‹äºNetty serverçš„è¿æ¥
* 4ã€HelloClientIntHandlerï¼šclientçš„handlerï¼Œæ¥æ”¶serverç«¯çš„æ¶ˆæ¯ï¼Œå¹¶å‘æœåŠ¡ç«¯å‘é€æ¶ˆæ¯

æ°å¥½ï¼Œå’Œ

dubbo-remoting-api
æ¨¡å—ï¼Œå®šä¹‰çš„ Serverã€Clientã€ChannelHandler **æ¥å£**å¯¹åº”ã€‚æˆ‘ä»¬ä»¥

dubbo-remoting-netty4
æ¨¡å—çš„ï¼Œä¸¾ä¾‹å­ã€‚æ•´ç†å¦‚ä¸‹ï¼š

ä¸Šæ–‡ 
dubbo-remoting-api
 
dubbo-remoting-netty4 HelloServer Server æ¥å£ [NettyServer](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyServer.java) å®ç°ç±» HelloServerInHandlerï¼šserver ChannelHandler æ¥å£ [NettyServerHandler](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyServerHandler.java) å®ç°ç±» HelloClient Client æ¥å£ [NettyClient](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyClient.java) å®ç°ç±» HelloServerInHandler ChannelHandler æ¥å£ [NettyClientHandler](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyClientHandler.java) å®ç°ç±»

å› ä¸º**æ•™ç¨‹æ–‡ç« **ï¼Œä»¥æ•™ç¨‹ Demo ä¸ºå‡†ï¼Œå®é™…ä¼šæœ‰æ›´å¤šéœ€è¦æŠ½è±¡çš„ï¼Œä¾‹å¦‚ï¼šCodec åè®®ç¼–è§£ç ï¼ŒDispatcher æ¶ˆæ¯ç­‰åˆ†å‘ã€‚èƒ–å‹å†æ¥çœ‹çœ‹

dubbo://
çš„å¤„ç†æµç¨‹ï¼š

FROM [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” dubbo://ã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/protocol/dubbo.html)
![dubbo:// ](http://static2.iocoder.cn/images/Dubbo/2018_12_01/04.png)

* Transporter: mina, netty, grizzy
* Serialization: dubbo, hessian2, java, json
* Dispatcher: all, direct, message, execution, connection
* ThreadPool: fixed, cached

å¦‚æœè¿™ä¸ªå›¾è¯»ä¸æ‡‚ï¼Œæ²¡å…³ç³»ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹æ¯ä¸ªæ¥å£ã€‚åé¢ï¼Œèƒ–å‹å¯ä»¥å›è¿‡å¤´æ¥ç†è§£è¿™ä¸ªå›¾ã€‚

**æœ¬æ–‡æ¶‰åŠçš„ç±»å›¾å¦‚ä¸‹**ï¼š

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_12_01/05.png)

# 4. Endpoint

com.alibaba.dubbo.remoting.Endpoint
ï¼Œ**ç«¯ç‚¹**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

* å±æ€§ç›¸å…³
```
URL getUrl();
InetSocketAddress getLocalAddress();
ChannelHandler getChannelHandler();
```
* å‘é€æ¶ˆæ¯
```
void send(Object message) throws RemotingException;
void send(Object message, boolean sent) throws RemotingException;
```
* å…³ç³»ç›¸å…³
```
void close();
void close(int timeout);
void startClose();
boolean isClosed();
```

Endpoint ï¼Œä»ä¸­æ–‡ä¸Šè§£é‡Šæ¥è¯´æ˜¯ï¼Œâ€œ**ç«¯ç‚¹**â€ã€‚ä»å­—é¢ä¸Šæ¥çœ‹ï¼Œä¸å¤ªå®¹æ˜“ç†è§£ã€‚åœ¨

dubbo-remoting-api
ä¸­ï¼Œä¸€ä¸ª Client æˆ– Server ï¼Œéƒ½æ˜¯ä¸€ä¸ª Endpoint ã€‚ğŸ™‚ ä¸åŒç³»ç»Ÿçš„ï¼ŒEndpoint ä»£è¡¨çš„ä¼šç•¥æœ‰å·®è·ï¼Œä¾‹å¦‚ SpringMVC ä¸­ï¼Œä¸€ä¸ªè¯·æ±‚ Restful URL ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª Endpoint ï¼Œèƒ–å‹å¯ä»¥ Google æŸ¥è¯¢ï¼Œç†è§£æ›´å¤šã€‚

## 4.1 Channel

com.alibaba.dubbo.remoting.Channel
ï¼Œç»§æ‰¿ Endpoint æ¥å£ï¼Œ**é€šé“**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š

* è¿æ¥ç›¸å…³
```
InetSocketAddress getRemoteAddress();
boolean isConnected();
```
* å±æ€§ç›¸å…³
```
boolean hasAttribute(String key);
Object getAttribute(String key);
void setAttribute(String key, Object value);
void removeAttribute(String key);
```

å’Œ Netty Channel ä¸€è‡´ï¼Œ**é€šè®¯çš„è½½ä½“**ã€‚åœ¨åé¢çš„æ–‡ç« ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°åœ¨

dubbo-remoting-netty4
é¡¹ç›®ä¸­ï¼Œ[NettyChannel](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyChannel.java) æ˜¯ Dubbo Channel çš„å®ç°ï¼Œå†…éƒ¨æœ‰**çœŸæ­£çš„** Netty Channel å±æ€§ï¼Œç”¨äº**é€šè®¯**ã€‚

## 4.2 Client

com.alibaba.dubbo.remoting.Client
ï¼Œå®ç° Endpoint å’Œ Channel å’Œ Resetable æ¥å£ï¼Œ**å®¢æˆ·ç«¯**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š
```
// é‡è¿
void reconnect() throws RemotingException;
```

## 4.3 Server

com.alibaba.dubbo.remoting.Server
ï¼Œç»§æ‰¿ Endpoint å’Œ Resetable æ¥å£ï¼Œ**æœåŠ¡å™¨**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š
```
// æ˜¯å¦ç»‘å®šæœ¬åœ°ç«¯å£ï¼Œæä¾›æœåŠ¡ã€‚å³ï¼Œæ˜¯å¦å¯åŠ¨æˆåŠŸï¼Œå¯è¿æ¥ï¼Œæ¥æ”¶æ¶ˆæ¯ç­‰ã€‚
boolean isBound();
// è·å¾—è¿æ¥ä¸ŠæœåŠ¡å™¨çš„é€šé“ï¼ˆå®¢æˆ·ç«¯ï¼‰ä»¬
Collection<Channel> getChannels();
Channel getChannel(InetSocketAddress remoteAddress);
```

### 4.3.1 Resetable

com.alibaba.dubbo.common.Resetable
ï¼Œ**å¯é‡ç½®**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š
```
void reset(URL url);
```

Server å®ç° Resetable æ¥å£ï¼Œåœ¨å®ç°

/#reset(url)
æ–¹æ³•ï¼Œç”¨äºæ ¹æ®æ–°ä¼ å…¥çš„

url
å±æ€§ï¼Œé‡ç½®è‡ªå·±å†…éƒ¨çš„ä¸€äº›å±æ€§ï¼Œä¾‹å¦‚ [
AbstractServer/#reset(url)
](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/AbstractServer.java#L80-L129) æ–¹æ³•ã€‚

# 5. ChannelHandler

com.alibaba.dubbo.remoting.ChannelHandler
ï¼Œ**é€šé“å¤„ç†å™¨**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š
```
void connected(Channel channel) throws RemotingException;
void disconnected(Channel channel) throws RemotingException;
void sent(Channel channel, Object message) throws RemotingException;
void received(Channel channel, Object message) throws RemotingException;
void caught(Channel channel, Throwable exception) throws RemotingException;
```

å’Œ Netty ChannelHandler ä¸€è‡´ï¼Œ**è´Ÿè´£ Channel ä¸­çš„é€»è¾‘å¤„ç†**ã€‚åœ¨åé¢çš„æ–‡ç« ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°åœ¨

dubbo-remoting-netty4
é¡¹ç›®ä¸­ï¼Œ[NettyServerHandler](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyServerHandler.java) æ˜¯ Netty ChannelHandler çš„å®ç°ï¼Œå†…éƒ¨è°ƒç”¨ Netty ChannelHandler çš„æ–¹æ³•ï¼Œè¿›è¡Œé€»è¾‘å¤„ç†ã€‚

# 6. Transporter

com.alibaba.dubbo.remoting.Transporter
ï¼Œ**ç½‘ç»œä¼ è¾“**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š
```
@SPI("netty")
public interface Transporter{
//*/*
/* Bind a server.
/*
/* ç»‘å®šä¸€ä¸ªæœåŠ¡å™¨
/*
/* @param url server url
/* @param handler é€šé“å¤„ç†å™¨
/* @return server æœåŠ¡å™¨
/* @throws RemotingException å½“ç»‘å®šå‘ç”Ÿå¼‚å¸¸æ—¶
/* @see com.alibaba.dubbo.remoting.Transporters/#bind(URL, Receiver, ChannelHandler)
/*/
@Adaptive({Constants.SERVER_KEY, Constants.TRANSPORTER_KEY})
Server bind(URL url, ChannelHandler handler) throws RemotingException;
//*/*
/* Connect to a server.
/*
/* è¿æ¥ä¸€ä¸ªæœåŠ¡å™¨ï¼Œå³åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯
/*
/* @param url server url æœåŠ¡å™¨åœ°å€
/* @param handler é€šé“å¤„ç†å™¨
/* @return client å®¢æˆ·ç«¯
/* @throws RemotingException å½“è¿æ¥å‘ç”Ÿå¼‚å¸¸æ—¶
/* @see com.alibaba.dubbo.remoting.Transporters/#connect(URL, Receiver, ChannelListener)
/*/
@Adaptive({Constants.CLIENT_KEY, Constants.TRANSPORTER_KEY})
Client connect(URL url, ChannelHandler handler) throws RemotingException;
}
```

* @SPI("netty")
æ³¨è§£ï¼ŒDubbo SPI **æ‹“å±•ç‚¹**ï¼Œé»˜è®¤ä¸º

"netty"
ã€‚æ³¨æ„ï¼Œæ­¤å¤„çš„

netty
å¯¹åº”çš„æ˜¯ netty3 ï¼Œå› ä¸º Dubbo é¡¹ç›®åœ¨å¼€å‘æ—¶ï¼Œnetty4 å¹¶æœªå‘å¸ƒã€‚é…ç½®æ–¹å¼è§ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” Netty4ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/netty4.html) æ–‡æ¡£ã€‚
* @Adaptive({Constants.SERVER_KEY, Constants.TRANSPORTER_KEY})
æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Server å®ç°ï¼Œä½¿ç”¨

URL.server
æˆ–

URL.transporter
å±æ€§ã€‚
* @Adaptive({Constants.CLIENT_KEY, Constants.TRANSPORTER_KEY})
æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Client å®ç°ï¼Œä½¿ç”¨

URL.client
æˆ–

URL.transporter
å±æ€§ã€‚

## 6.1 Transporters

[
com.alibaba.dubbo.remoting.Transporters
](https://github.com/YunaiV/dubbo/blob/7fad710c2dbf66356d5e7b7995e843b8f6225652/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/Transporters.java) ï¼ŒTransporter é—¨é¢ç±»ã€‚
å‹æƒ…æç¤ºï¼šFacade è®¾è®¡æ¨¡å¼ï¼Œå‚è§ [ã€Š è®¾è®¡æ¨¡å¼ï¼ˆä¹ï¼‰å¤–è§‚æ¨¡å¼Facadeï¼ˆç»“æ„å‹ï¼‰ã€‹](https://blog.csdn.net/hguisu/article/details/7533759) æ–‡ç« ã€‚

/#bind(String url, ChannelHandler... handler)
**é™æ€**æ–¹æ³•ï¼Œç»‘å®šä¸€ä¸ªæœåŠ¡å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: public static Server bind(String url, ChannelHandler... handler) throws RemotingException{
2: return bind(URL.valueOf(url), handler);
3: }
4:
5: public static Server bind(URL url, ChannelHandler... handlers) throws RemotingException{
6: if (url == null) {
7: throw new IllegalArgumentException("url == null");
8: }
9: if (handlers == null || handlers.length == 0) {
10: throw new IllegalArgumentException("handlers == null");
11: }
12: // åˆ›å»º handler
13: ChannelHandler handler;
14: if (handlers.length == 1) {
15: handler = handlers[0];
16: } else {
17: handler = new ChannelHandlerDispatcher(handlers);
18: }
19: // åˆ›å»º Server å¯¹è±¡
20: return getTransporter().bind(url, handler);
21: }
```

* å’Œ

Transporter/#bind(url, handler)
æ–¹æ³•ï¼Œå¯¹åº”ã€‚
* ç¬¬ 12 è‡³ 18 è¡Œï¼šåˆ›å»º

handler
ã€‚è‹¥

handlers
æ˜¯å¤šä¸ªï¼Œä½¿ç”¨ [ChannelHandlerDispatcher](https://github.com/YunaiV/dubbo/blob/7fad710c2dbf66356d5e7b7995e843b8f6225652/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/ChannelHandlerDispatcher.java) è¿›è¡Œå°è£…ã€‚åœ¨ ChannelHandlerDispatcher ä¸­ï¼Œä¼šå¾ªç¯è°ƒç”¨

handlers
ï¼Œå¯¹åº”çš„æ–¹æ³•ã€‚
* ç¬¬ 20 è¡Œï¼šè°ƒç”¨

/#getTransporter()
æ–¹æ³•ï¼ŒåŸºäº Dubbo SPI æœºåˆ¶ï¼Œè·å¾— Transporter$Adaptive å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public static Transporter getTransporter(){
return ExtensionLoader.getExtensionLoader(Transporter.class).getAdaptiveExtension();
}
```
* ç¬¬ 20 è¡Œï¼šè°ƒç”¨

Transporter/#bind(url, handler)
æ–¹æ³•ï¼Œåœ¨ Transporter$Adaptive å¯¹è±¡ä¸­ï¼Œä¼šæ ¹æ®

url
å‚æ•°ï¼Œè·å¾—å¯¹åº”çš„ **Transporter å®ç°å¯¹è±¡**ï¼ˆä¾‹å¦‚ï¼Œ [NettyTransporter](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyTransporter.java)ï¼‰ï¼Œä»è€Œåˆ›å»ºå¯¹åº”çš„ Server å¯¹è±¡ï¼ˆä¾‹å¦‚ï¼Œ [NettyServer](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyServer.java)ï¼‰ã€‚

å¦å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ª [
/#connect(url, handler)
](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/Transporters.java#L59-L76) **é™æ€**æ–¹æ³•ï¼Œè¿æ¥ä¸€ä¸ªæœåŠ¡å™¨ï¼Œå³åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯ã€‚ğŸ™‚ å’Œä¸Šé¢æ–¹æ³•ç±»ä¼¼ï¼Œèƒ–å‹è‡ªå·±çœ‹å’¯ã€‚

# 7. Codec2

com.alibaba.dubbo.remoting.Codec2
ï¼Œ**ç¼–è§£ç å™¨**æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* ç¼–ç 
/*
/* @param channel é€šé“
/* @param buffer Buffer
/* @param message æ¶ˆæ¯
/* @throws IOException å½“ç¼–ç å‘ç”Ÿå¼‚å¸¸æ—¶
/*/
@Adaptive({Constants.CODEC_KEY})
void encode(Channel channel, ChannelBuffer buffer, Object message) throws IOException;
//*/*
/* è§£ç 
/*
/* @param channel é€šé“
/* @param buffer Buffer
/* @return æ¶ˆæ¯
/* @throws IOException å½“è§£ç å‘ç”Ÿå¼‚å¸¸æ—¶
/*/
@Adaptive({Constants.CODEC_KEY})
Object decode(Channel channel, ChannelBuffer buffer) throws IOException;
```

* @SPI("netty")
æ³¨è§£ï¼ŒDubbo SPI **æ‹“å±•ç‚¹**ã€‚
* @Adaptive({Constants.CODEC_KEY})
æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Codec2 å®ç°ï¼Œä½¿ç”¨

URL.codec
å±æ€§ã€‚

å¦å¤–ï¼Œè§£ç è¿‡ç¨‹ä¸­ï¼Œéœ€è¦è§£å†³ TCP æ‹†åŒ…ã€ç²˜åŒ…çš„åœºæ™¯ï¼Œå› æ­¤è§£ç ç»“æœå¦‚ä¸‹ï¼š
```
// Codec2.java
enum DecodeResult {
//*/*
/* éœ€è¦æ›´å¤šè¾“å…¥
/*/
NEED_MORE_INPUT,
//*/*
/* å¿½ç•¥ä¸€äº›è¾“å…¥
/*/
SKIP_SOME_INPUT
}
```

* ç›®å‰

SKIP_SOME_INPUT
ï¼Œæš‚æœªä½¿ç”¨ã€‚
* æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥æå‰çœ‹ä¸‹ [ã€Šé«˜æ€§èƒ½ç½‘ç»œæ¡†æ¶Nettyçš„TCPæ‹†åŒ…ã€ç²˜åŒ…è§£å†³æ–¹æ¡ˆã€‹](http://chen-tao.github.io/2015/10/03/nettytcp/) æ–‡ç« ã€‚åœ¨åç»­çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æ—¢ä¼šçœ‹åˆ°åŸºäº**é•¿åº¦**çš„æ–¹æ¡ˆï¼Œä¹Ÿä¼šçœ‹åˆ°åŸºäº**ç•Œå®šç¬¦**çš„æ–¹æ¡ˆã€‚

## 7.1 Codec

[
com.alibaba.dubbo.remoting.Codec
](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/Codec.java)ï¼Œ**è€çš„**ç¼–è§£ç å™¨æ¥å£ï¼Œè¢« Codec2 å–ä»£ã€‚

é€šè¿‡ [CodecAdapter](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/codec/CodecAdapter.java) ï¼Œå°† Codec é€‚é…æˆ Codec2 ã€‚

## 7.2 Decodeable

com.alibaba.dubbo.remoting.Decodeable
ï¼Œ**å¯è§£ç **çš„æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š
```
// è§£ç 
void decode() throws Exception;
```

# 8. Dispatcher

com.alibaba.dubbo.remoting.Dispatcher
ï¼Œ**è°ƒåº¦å™¨**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š
```
@SPI(AllDispatcher.NAME)
public interface Dispatcher{
@Adaptive({Constants.DISPATCHER_KEY, "dispather", "channel.handler"})
// The last two parameters are reserved for compatibility with the old configuration
ChannelHandler dispatch(ChannelHandler handler, URL url);
}
```

* @SPI(AllDispatcher.NAME)
æ³¨è§£ï¼ŒDubbo SPI **æ‹“å±•ç‚¹**ï¼Œé»˜è®¤ä¸º

"all"
ã€‚
* @Adaptive({Constants.DISPATCHER_KEY, "dispather", "channel.handler"})
æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ ChanelHander å®ç°ï¼Œä½¿ç”¨

URL.dispatcher
å±æ€§ã€‚
* ä¸ºä»€ä¹ˆä¼ å…¥çš„

handler
å‚æ•°ï¼Œåˆ›å»ºè¿”å›çš„è¿˜æ˜¯ ChannelHandler å¯¹è±¡å‘¢ï¼Ÿæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥æå‰çœ‹ä¸‹ [AllChannelHandler](https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/transport/dispatcher/all/AllChannelHandler.java) å’Œ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” çº¿ç¨‹æ¨¡å‹ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/thread-model.html) ã€‚ğŸ™‚ æ–‡ç« ï¼Œåé¢è§ã€‚

# 9. RemotingException

com.alibaba.dubbo.remoting.RemotingException
ï¼Œå®ç° Exception ç±»ï¼Œ

dubbo-remoting-api
çš„**åŸºç¡€**å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public class RemotingException extends Exception{
//*/*
/* æœ¬åœ°åœ°å€
/*/
private InetSocketAddress localAddress;
//*/*
/* è¿œç¨‹åœ°å€
/*/
private InetSocketAddress remoteAddress;
// ... çœç•¥æ–¹æ³•
}
```

## 9.1 ExecutionException

com.alibaba.dubbo.remoting.ExecutionException
ï¼Œå®ç° RemotingException ç±»ï¼Œæ‰§è¡Œå¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public class ExecutionException extends RemotingException{
//*/*
/* è¯·æ±‚
/*/
private final Object request;
// ... çœç•¥æ–¹æ³•
}
```

## 9.2 TimeoutException

com.alibaba.dubbo.remoting.TimeoutException
ï¼Œå®ç° RemotingException ç±»ï¼Œè¶…æ—¶å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public class TimeoutException extends RemotingException{
//*/*
/* å®¢æˆ·ç«¯
/*/
public static final int CLIENT_SIDE = 0;
//*/*
/* æœåŠ¡ç«¯
/*/
public static final int SERVER_SIDE = 1;
//*/*
/* é˜¶æ®µ
/*/
private final int phase;
// ... çœç•¥æ–¹æ³•
}
```