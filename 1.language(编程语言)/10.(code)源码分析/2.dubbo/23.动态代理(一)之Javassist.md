# åŠ¨æ€ä»£ç†ï¼ˆä¸€ï¼‰ä¹‹ Javassist

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº« Dubbo **åŠ¨æ€ä»£ç†**çš„å®ç°ã€‚

åœ¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” schema é…ç½®å‚è€ƒæ‰‹å†Œã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/xml/introduction.html) ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°

<dubbo:service />
å’Œ

<dubbo:reference />
æ ‡ç­¾ä¸­ï¼Œå¯ä»¥é€šè¿‡

"proxy"
å±æ€§ï¼Œå¯ä»¥é…ç½®åŠ¨æ€ä»£ç†çš„ç”Ÿæˆæ–¹å¼ï¼š
ç”ŸæˆåŠ¨æ€ä»£ç†æ–¹å¼ï¼Œå¯é€‰ï¼šjdk / javassist

ä»è¯´æ˜ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒDubbo å®ç°äº†**ä¸¤ç§**æ–¹å¼ç”Ÿæˆä»£ç†ï¼š

* Javassit
* JDK

ğŸ™‚ æœ¬æ–‡åˆ†äº« Javassist å®ç°åŠ¨æ€ä»£ç†çš„æºç ï¼›æ¶‰åŠä»£ç å¦‚ä¸‹ï¼š

* dubbo-common
æ¨¡å—çš„

bytecode
åŒ…ã€‚
* dubbo-rpc-api
æ¨¡å—çš„

proxy
åŒ…ã€‚

ä¸‹ä¸€ç¯‡æ–‡ç« åˆ†äº« JDK å®ç°åŠ¨æ€ä»£ç†çš„æºç ã€‚

# 2. æ€§èƒ½

åœ¨åˆ†äº«å…·ä½“å®ç°ä¹‹å‰ï¼Œå¯èƒ½æœ‰èƒ–å‹å¯¹æ€§èƒ½æ–¹é¢æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹çœ‹å¦‚ä¸‹çš„å†…å®¹ï¼š

* [ã€ŠåŠ¨æ€ä»£ç†æ–¹æ¡ˆæ€§èƒ½å¯¹æ¯”ã€‹](http://javatar.iteye.com/blog/814426)
* æ¥è‡ªè€å¾çš„æŸç¯‡æ–‡ç« 
![èœé€¼è€å¾](http://static2.iocoder.cn/images/Dubbo/2018_09_13/01.png)

# 3. æ•´ä½“æµç¨‹

ğŸ˜ˆ çæ¯”æ¯”äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬å¼€å§‹è¿›å…¥æ­£é¢˜äº†ã€‚ç›¸ä¿¡å¾ˆå¤šèƒ–å‹å¯¹**åŠ¨æ€ä»£ç†**çš„æ¦‚å¿µå·²ç»ç†è§£ï¼ˆå¦‚æœæš‚æ—¶ä¸ç†è§£ï¼Œè¯· Google ä¸‹ï¼‰ï¼Œé‚£ä¹ˆ Dubbo å¯¹å®ƒä»¬ä½¿ç”¨åœ¨å“ªå‘¢ï¼Ÿè§ä¸‹å›¾ï¼š

![èœé€¼è€ç‹](http://static2.iocoder.cn/images/Dubbo/2018_09_13/02.png)
æ—ç™½å›ï¼šæœ¬å›¾æš‚ä¸è€ƒè™‘é›†ç¾¤å®¹é”™ã€ç½‘ç»œè°ƒç”¨ã€åºåˆ—åŒ–ååºåˆ—ç­‰ã€‚

* åœ¨ Dubbo ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ **Service æ¥å£**ï¼Œä½œä¸ºæœåŠ¡ API çš„å¥‘çº¦ã€‚
* åœ¨ Consumer ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨ Service æ¥å£çš„æ–¹æ³•æ—¶ï¼Œå®é™…è°ƒç”¨çš„æ˜¯ Dubbo åŠ¨æ€ä»£ç†ã€‚ä¸‹é¢å…ˆä¸€èµ·æ¥çœ‹ä¸€ä¸ªç”Ÿæˆçš„ **proxy** ä»£ç çš„ç¤ºä¾‹ï¼š
```
1: package com.alibaba.dubbo.common.bytecode;
2:
3: import com.alibaba.dubbo.demo.DemoService;
4: import com.alibaba.dubbo.rpc.service.EchoService;
5: import java.lang.reflect.InvocationHandler;
6: import java.lang.reflect.Method;
7:
8: public class proxy0
9: implements ClassGenerator.DC, EchoService, DemoService
10: {
11: public static Method[] methods;
12: private InvocationHandler handler;
13:
14: public void bye(Object paramObject)
15:{
16: Object[] arrayOfObject = new Object[1];
17: arrayOfObject[0] = paramObject;
18: Object localObject = this.handler.invoke(this, methods[0], arrayOfObject);
19: }
20:
21: public String sayHello(String paramString)
22:{
23: Object[] arrayOfObject = new Object[1];
24: arrayOfObject[0] = paramString;
25: Object localObject = this.handler.invoke(this, methods[1], arrayOfObject);
26: return (String)localObject;
27: }
28:
29: public Object $echo(Object paramObject)
30: {
31: Object[] arrayOfObject = new Object[1];
32: arrayOfObject[0] = paramObject;
33: Object localObject = this.handler.invoke(this, methods[2], arrayOfObject);
34: return (Object)localObject;
35: }
36:
37: public proxy0(){}
38:
39: public proxy0(InvocationHandler paramInvocationHandler)
40:{
41: this.handler = paramInvocationHandler;
42: }
43: }
```

* è¯¥ç±»é€šè¿‡

dubbo-common
æ¨¡å—çš„

bytecode
æ¨¡å—çš„ **Proxy** ç±»ï¼Œ**è‡ªåŠ¨ç”Ÿæˆ**ï¼Œä½¿ç”¨ Javassist æŠ€æœ¯ã€‚
* ç”Ÿæˆçš„ **proxy** ç±»ä¼š**å®ç°**æˆ‘ä»¬å®šä¹‰çš„ Service æ¥å£( ä¾‹å¦‚ï¼Œæ­¤å¤„æ˜¯ DemoService )ã€‚
* /#bye(Object)
å’Œ

/#sayHello(Object)
æ–¹æ³•ï¼Œæ˜¯æˆ‘ä»¬å®šä¹‰åœ¨ DemoService çš„**æ¥å£æ–¹æ³•**ï¼Œåœ¨ç”Ÿæˆçš„ **proxy**ç±»ä¸­ï¼Œå®ç°è¿™äº›å®šä¹‰åœ¨æ¥å£ä¸­çš„æ–¹æ³•ï¼Œæ”¶æ‹¢ç»Ÿä¸€è°ƒç”¨

java.lang.reflect.InvocationHandler/#invoke(proxy, method, args)
æ–¹æ³•ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå¯ä»¥è°ƒç”¨åˆ°æœ€ç»ˆçš„

Invoker/#invoke(Invocation)
æ–¹æ³•ï¼Œå®ç° RPC è°ƒç”¨ã€‚
* æ³¨æ„ï¼Œæ­¤å¤„æˆ‘ä»¬ä¸€ç›´ç”¨çš„ **proxy** ä¸€ç›´æ˜¯å°å†™çš„ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¯·è§ä¸‹æ–‡å¤§å†™çš„ **Proxy** ç±»ã€‚
* åœ¨ Provider ä¸­ï¼ŒXXXProtocol ä¼šè·å¾—è¢«è°ƒç”¨çš„ Exporter å¯¹è±¡ï¼Œä»è€Œè·å¾—åˆ° Invoker å¯¹è±¡ã€‚ä½†æ˜¯å‘¢ï¼ŒInvoker å¯¹è±¡å®é™…å’Œ Service å®ç°å¯¹è±¡ï¼Œæ˜¯æ— æ³•ç›´æ¥è°ƒç”¨ï¼Œéœ€è¦æœ‰ä¸­é—´çš„ä¸€å±‚ Wrapper æ¥**ä»£ç†åˆ†å‘**åˆ° Service å¯¹åº”çš„æ–¹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç”Ÿæˆçš„ Wrapper ä»£ç çš„ç¤ºä¾‹ï¼š
```
1: package com.alibaba.dubbo.common.bytecode;
2:
3: import com.alibaba.dubbo.demo.provider.DemoDAO;
4: import com.alibaba.dubbo.demo.provider.DemoServiceImpl;
5: import java.lang.reflect.InvocationTargetException;
6: import java.util.Map;
7:
8: public class Wrapper1
9: extends Wrapper
10: implements ClassGenerator.DC
11: {
12: public static String[] pns;
13: public static Map pts;
14: public static String[] mns;
15: public static String[] dmns;
16: public static Class[] mts0;
17: public static Class[] mts1;
18: public static Class[] mts2;
19:
20: public String[] getPropertyNames()
21: {
22: return pns;
23: }
24:
25: public boolean hasProperty(String paramString)
26:{
27: return pts.containsKey(paramString);
28: }
29:
30: public Class getPropertyType(String paramString)
31:{
32: return (Class)pts.get(paramString);
33: }
34:
35: public String[] getMethodNames()
36: {
37: return mns;
38: }
39:
40: public String[] getDeclaredMethodNames()
41: {
42: return dmns;
43: }
44:
45: public void setPropertyValue(Object paramObject1, String paramString, Object paramObject2)
46:{
47: DemoServiceImpl w;
48: try
49: {
50: w = (DemoServiceImpl)paramObject1;
51: }
52: catch (Throwable localThrowable)
53: {
54: throw new IllegalArgumentException(localThrowable);
55: }
56: if (paramString.equals("test01"))
57: {
58: w.test01 = ((String)paramObject2);
59: return;
60: }
61: if (paramString.equals("demoDAO"))
62: {
63: localDemoServiceImpl.setDemoDAO((DemoDAO)paramObject2);
64: return;
65: }
66: throw new NoSuchPropertyException("Not found property \"" + paramString + "\" filed or setter method in class com.alibaba.dubbo.demo.provider.DemoServiceImpl.");
67: }
68:
69: public Object getPropertyValue(Object paramObject, String paramString)
70:{
71: DemoServiceImpl w;
72: try
73: {
74: w = (DemoServiceImpl)paramObject;
75: }
76: catch (Throwable localThrowable)
77: {
78: throw new IllegalArgumentException(localThrowable);
79: }
80: if (paramString.equals("test01")) {
81: return localDemoServiceImpl.test01;
82: }
83: throw new NoSuchPropertyException("Not found property \"" + paramString + "\" filed or setter method in class com.alibaba.dubbo.demo.provider.DemoServiceImpl.");
84: }
85:
86: public Object invokeMethod(Object paramObject, String paramString, Class[] paramArrayOfClass, Object[] paramArrayOfObject)
87: throws InvocationTargetException
88:{
89: DemoServiceImpl w;
90: try
91: {
92: w = (DemoServiceImpl)paramObject;
93: }
94: catch (Throwable localThrowable1)
95: {
96: throw new IllegalArgumentException(localThrowable1);
97: }
98: try
99: {
100: if ("sayHello".equals(paramString) && paramArrayOfClass.length == 1) {
101: return w.sayHello((String)paramArrayOfObject[0]);
102: }
103: if ("bye".equals(paramString) && paramArrayOfClass.length == 1)
104: {
105: w.bye((Object)paramArrayOfObject[0]);
106: return null;
107: }
108: if ("setDemoDAO".equals(paramString) && paramArrayOfClass.length == 1)
109: {
110: w.setDemoDAO((DemoDAO)paramArrayOfObject[0]);
111: return null;
112: }
113: }
114: catch (Throwable localThrowable2)
115: {
116: throw new InvocationTargetException(localThrowable2);
117: }
118: throw new NoSuchMethodException("Not found method \"" + paramString + "\" in class com.alibaba.dubbo.demo.provider.DemoServiceImpl.");
119: }
120: }
```

* è¯¥ç±»é€šè¿‡

dubbo-common
æ¨¡å—çš„

bytecode
æ¨¡å—çš„ Wrapper ç±»ï¼Œ**è‡ªåŠ¨ç”Ÿæˆ**ï¼Œä½¿ç”¨ Javassist æŠ€æœ¯ã€‚
* ä¸åŒäºç”Ÿæˆçš„ **proxy**ç±»ï¼Œä¸å®ç° Service æ¥å£ç±»ï¼Œè€Œæ˜¯åœ¨

/#invokeMethod(paramObject, paramString, paramArrayOfClass, paramArrayOfObject)
æ–¹æ³•ï¼Œæä¾›ç»™

Invoker/#invoke(invocation)
ä¸­è°ƒç”¨ï¼Œç»Ÿä¸€åˆ†å‘è¯·æ±‚åˆ° Service å¯¹åº”çš„æ–¹æ³•ã€‚ä»èŒèƒ½ä¸Šæ¥çœ‹ï¼Œæœ‰ä¸€ç‚¹åƒç¡¬ç¼–ç çš„ Controller ã€‚
* ä¸€ä¸ªç”Ÿæˆçš„ **Wrapper**ç±»ï¼Œåªå¯¹åº”ä¸€ä¸ª Service ï¼Œä»ç¬¬ 75 è¡Œçš„ä»£ç ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºã€‚

# 4. ProxyFactory

[
com.alibaba.dubbo.rpc.ProxyFactory
](https://github.com/YunaiV/dubbo/blob/6de0a069fcc870894e64ffd54a24e334b19dcb36/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/ProxyFactory.java) ï¼Œä»£ç†å·¥å‚æ¥å£ã€‚

åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ ¸å¿ƒæµç¨‹ä¸€è§ˆã€‹](http://svip.iocoder.cn/Dubbo/implementation-intro/) çš„ [ã€Œ4.5 ProxyFactoryã€](http://svip.iocoder.cn/Dubbo/proxy-javassist/)ï¼Œå·²ç»åˆ†äº«ï¼Œèƒ–å‹ç‚¹å‡»æŸ¥çœ‹ã€‚

![ProxyFactory å­ç±»](http://static2.iocoder.cn/images/Dubbo/2018_03_01/13.png)

## 4.1 AbstractProxyFactory

com.alibaba.dubbo.rpc.proxy.AbstractProxyFactory
ï¼Œå®ç° ProxyFactory æ¥å£ï¼Œä»£ç†å·¥å‚æŠ½è±¡ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: public abstract class AbstractProxyFactory implements ProxyFactory{
2:
3: public <T> T getProxy(Invoker<T> invoker) throws RpcException{
4: Class<?>[] interfaces = null;
5: // TODO 8022 èŠ‹è‰¿
6: String config = invoker.getUrl().getParameter("interfaces");
7: if (config != null && config.length() > 0) {
8: String[] types = Constants.COMMA_SPLIT_PATTERN.split(config);
9: if (types != null && types.length > 0) {
10: interfaces = new Class<?>[types.length + 2];
11: interfaces[0] = invoker.getInterface();
12: interfaces[1] = EchoService.class;
13: for (int i = 0; i < types.length; i++) {
14: interfaces[i + 1] = ReflectUtils.forName(types[i]);
15: }
16: }
17: }
18: // å¢åŠ  EchoService æ¥å£ï¼Œç”¨äºå›ç”Ÿæµ‹è¯•ã€‚å‚è§æ–‡æ¡£ã€Šå›å£°æµ‹è¯•ã€‹http://dubbo.apache.org/zh-cn/docs/user/demos/echo-service.html
19: if (interfaces == null) {
20: interfaces = new Class<?>[]{invoker.getInterface(), EchoService.class};
21: }
22: return getProxy(invoker, interfaces);
23: }
24:
25: public abstract <T> T getProxy(Invoker<T> invoker, Class<?>[] types);
26:
27: }
```

* å¯ä»¥çœ‹åˆ°ï¼Œè¯¥æŠ½è±¡ç±»ï¼Œä¸»è¦æ˜¯å®ç°äº†

/#getProxy(invoker)
æ–¹æ³•ï¼Œè·å¾—éœ€è¦ç”Ÿæˆä»£ç†çš„æ¥å£ä»¬ã€‚

* ç¬¬ 5 è‡³ 17 è¡Œï¼š TODO 8022 èŠ‹è‰¿
* ç¬¬ 18 è‡³ 21 è¡Œï¼šåœ¨åŸæœ‰ Invoker å¯¹åº”**å…³è”**çš„ Service æ¥å£ä¹‹ä¸Šï¼Œå¢åŠ  EchoService æ¥å£ã€‚
FROM [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” å›å£°æµ‹è¯•ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/echo-service.html)

å›å£°æµ‹è¯•ç”¨äºæ£€æµ‹æœåŠ¡æ˜¯å¦å¯ç”¨ï¼Œå›å£°æµ‹è¯•æŒ‰ç…§æ­£å¸¸è¯·æ±‚æµç¨‹æ‰§è¡Œï¼Œèƒ½å¤Ÿæµ‹è¯•æ•´ä¸ªè°ƒç”¨æ˜¯å¦é€šç•…ï¼Œå¯ç”¨äºç›‘æ§ã€‚
æ‰€æœ‰æœåŠ¡è‡ªåŠ¨å®ç° EchoService æ¥å£ï¼Œåªéœ€å°†ä»»æ„æœåŠ¡å¼•ç”¨å¼ºåˆ¶è½¬å‹ä¸º EchoServiceï¼Œå³å¯ä½¿ç”¨ã€‚
* ç¬¬ 22 è¡Œï¼šè°ƒç”¨

/#getProxy(invoker, types)
**æŠ½è±¡**æ–¹æ³•ï¼Œè·å¾— Proxy å¯¹è±¡ã€‚

## 4.2 StubProxyFactoryWrapper

[
com.alibaba.dubbo.rpc.proxy.wrapper.StubProxyFactoryWrapper
](https://github.com/YunaiV/dubbo/blob/afb312f7dce997f5f90ba686345f4354e786534d/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/proxy/wrapper/StubProxyFactoryWrapper.java) ï¼Œå®ç° ProxyFactory æ¥å£ï¼ŒStub ä»£ç†å·¥å‚ Wrapper å®ç°ç±»ï¼ŒåŸºäº Dubbo SPI Wrapper æœºåˆ¶åŠ è½½ã€‚

ğŸ™‚ è¯¥ç±»ï¼Œä¸åœ¨æœ¬æ–‡çš„èŒƒç•´å†…ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹å¯ä»¥å…ˆçœ‹ä¸‹ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” æœ¬åœ°å­˜æ ¹ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/local-stub.html) ã€‚åç»­ï¼Œæˆ‘ä»¬å•ç‹¬å¼€æ–‡ç« åˆ†äº«ã€‚

## 4.3 JavassistProxyFactory

com.alibaba.dubbo.rpc.proxy.javassist.JavassistProxyFactory
ï¼Œå®ç° AbstractProxyFactory æŠ½è±¡ç±»ï¼ŒåŸºäº Javassist ä»£ç†å·¥å‚å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: public class JavassistProxyFactory extends AbstractProxyFactory{
2:
3: @SuppressWarnings("unchecked")
4: public <T> T getProxy(Invoker<T> invoker, Class<?>[] interfaces){
5: return (T) Proxy.getProxy(interfaces).newInstance(new InvokerInvocationHandler(invoker));
6: }
7:
8: public <T> Invoker<T> getInvoker(T proxy, Class<T> type, URL url){
9: // TODO Wrapper cannot handle this scenario correctly: the classname contains '$'
10: // TODO Wrapperç±»ä¸èƒ½æ­£ç¡®å¤„ç†å¸¦$çš„ç±»å
11: final Wrapper wrapper = Wrapper.getWrapper(proxy.getClass().getName().indexOf('$') < 0 ? proxy.getClass() : type);
12: return new AbstractProxyInvoker<T>(proxy, type, url) {
13: @Override
14: protected Object doInvoke(T proxy, String methodName,
15: Class<?>[] parameterTypes,
16: Object[] arguments) throws Throwable{
17: return wrapper.invokeMethod(proxy, methodName, parameterTypes, arguments);
18: }
19: };
20: }
21:
22: }
```

* /#getProxy(invoker, interfaces)
æ–¹æ³•

* ç¬¬ 5 è¡Œï¼šè°ƒç”¨

Proxy/#getProxy(interface)
æ–¹æ³•ï¼Œè·å¾— **Proxy** å¯¹è±¡ã€‚
* ç¬¬ 5 è¡Œï¼šè°ƒç”¨

Proxy/#newInstance(InvocationHandler)
æ–¹æ³•ï¼Œè·å¾— **proxy** å¯¹è±¡ã€‚å…¶ä¸­ä¼ å…¥çš„å‚æ•°æ˜¯ InvokerInvocationHandler ç±»ï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œè®© proxy å’ŒçœŸæ­£çš„é€»è¾‘ä»£ç è§£è€¦ã€‚

* Proxy å’Œ proxy ï¼Œåœ¨ [ã€Œ7.3 Proxyã€](http://svip.iocoder.cn/Dubbo/proxy-javassist/) ä¸­ï¼Œè¯¦ç»†è§£æã€‚
* InvokerInvocationHandler ï¼Œåœ¨ [ã€Œ5. InvokerInvocationHandlerã€](http://svip.iocoder.cn/Dubbo/proxy-javassist/) ä¸­ï¼Œè¯¦ç»†è§£æã€‚
* /#getInvoker(proxy, type, url)
æ–¹æ³•

* ç¬¬ 11 è¡Œï¼šè°ƒç”¨

Wrapper/#getWrapper(Class<?>)
æ–¹æ³•ï¼Œè·å¾— **Wrapper** å¯¹è±¡ã€‚

* Wrapper ï¼Œåœ¨ [ã€Œ7.4 Wrapperã€](http://svip.iocoder.cn/Dubbo/proxy-javassist/) ä¸­ï¼Œè¯¦ç»†è§£æã€‚
* ç¬¬ 12 è‡³ 19 è¡Œï¼šåˆ›å»º AbstractProxyInvoker å¯¹è±¡ï¼Œå®ç°

/#doInvoke(...)
æ–¹æ³•ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œè°ƒç”¨

Wrapper/#invokeMethod(...)
æ–¹æ³•ï¼Œä»è€Œè°ƒç”¨ Service çš„æ–¹æ³•ã€‚

* AbstractProxyInvoker ï¼Œåœ¨ [ã€Œ6. AbstractProxyInvokerã€](http://svip.iocoder.cn/Dubbo/proxy-javassist/) ä¸­ï¼Œè¯¦ç»†è§£æã€‚

# 5. InvokerInvocationHandler

com.alibaba.dubbo.rpc.proxy.InvokerInvocationHandler
ï¼Œå®ç° [
java.lang.reflect.InvocationHandler
](https://docs.oracle.com/javase/7/docs/api/java/lang/reflect/InvocationHandler.html) æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
1: public class InvokerInvocationHandler implements InvocationHandler{
2:
3: //*/*
4: /* Invoker å¯¹è±¡
5: /*/
6: private final Invoker<?> invoker;
7:
8: public InvokerInvocationHandler(Invoker<?> handler){
9: this.invoker = handler;
10: }
11:
12: @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable{
13: String methodName = method.getName();
14: Class<?>[] parameterTypes = method.getParameterTypes();
15: // wait ç­‰æ–¹æ³•ï¼Œç›´æ¥åå°„è°ƒç”¨
16: if (method.getDeclaringClass() == Object.class) {
17: return method.invoke(invoker, args);
18: }
19: // åŸºç¡€æ–¹æ³•ï¼Œä¸ä½¿ç”¨ RPC è°ƒç”¨
20: if ("toString".equals(methodName) && parameterTypes.length == 0) {
21: return invoker.toString();
22: }
23: if ("hashCode".equals(methodName) && parameterTypes.length == 0) {
24: return invoker.hashCode();
25: }
26: if ("equals".equals(methodName) && parameterTypes.length == 1) {
27: return invoker.equals(args[0]);
28: }
29: // RPC è°ƒç”¨
30: return invoker.invoke(new RpcInvocation(method, args)).recreate();
31: }
32:
33: }
```

* invoker
å±æ€§ï¼ŒInvoker å¯¹è±¡ï¼Œç”¨äºåœ¨

/#invoke()
æ–¹æ³•è°ƒç”¨ã€‚
* /#invoke(proxy, method, args)
**å®ç°**æ–¹æ³•ï¼Œæ ¸å¿ƒé€»è¾‘æ˜¯è°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼Œè¿›è¡Œ RPC è°ƒç”¨ã€‚

* ç¬¬ 16 è‡³ 18 è¡Œï¼šå¤„ç†

/#wait()

/#notify()
ç­‰æ–¹æ³•ï¼Œè¿›è¡Œåå°„è°ƒç”¨ã€‚
* ç¬¬ 20 è‡³ 28 è¡Œï¼šå¤„ç†

/#toString()

/#hashCode()
ç­‰æ–¹æ³•ï¼Œä½¿ç”¨ Invoker å¯¹è±¡çš„æ–¹æ³•ï¼Œä¸è¿›è¡Œ RPC è°ƒç”¨ã€‚
* ç¬¬ 30 è¡Œï¼šè°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼Œ**æ ¸å¿ƒé€»è¾‘**ï¼Œè¿›è¡Œ RPC è°ƒç”¨ã€‚
* ç¬¬ 30 è¡Œï¼šè°ƒç”¨

Result/#recreate()
æ–¹æ³•ï¼Œå›æ”¾è°ƒç”¨ç»“æœã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// RpcResult.java
public Object recreate() throws Throwable{
// æœ‰å¼‚å¸¸ï¼ŒæŠ›å‡ºå¼‚å¸¸
if (exception != null) {
throw exception;
}
// æ— å¼‚å¸¸ï¼Œè¿”å›ç»“æœ
return result;
}
```

* x

ğŸ™‚ é€šè¿‡ InvokerInvocationHandler ï¼Œå¯ä»¥å®ç° Proxy å’ŒçœŸæ­£çš„é€»è¾‘è§£è€¦ã€‚

# 6. AbstractProxyInvoker

com.alibaba.dubbo.rpc.proxy.AbstractProxyInvoker
ï¼Œå®ç° Invoker æ¥å£ï¼Œ**ä»£ç†** Invoker å¯¹è±¡çš„æŠ½è±¡ç±»ã€‚

## 6.1 å±æ€§

```
//*/*
/* ä»£ç†çš„å¯¹è±¡ï¼Œä¸€èˆ¬æ˜¯ Service å®ç°å¯¹è±¡
/*/
private final T proxy;
//*/*
/* æ¥å£ç±»å‹ï¼Œä¸€èˆ¬æ˜¯ Service æ¥å£
/*/
private final Class<T> type;
//*/*
/* URL å¯¹è±¡ï¼Œä¸€èˆ¬æ˜¯æš´éœ²æœåŠ¡çš„ URL å¯¹è±¡
/*/
private final URL url;
public AbstractProxyInvoker(T proxy, Class<T> type, URL url){
if (proxy == null) {
throw new IllegalArgumentException("proxy == null");
}
if (type == null) {
throw new IllegalArgumentException("interface == null");
}
if (!type.isInstance(proxy)) { //
throw new IllegalArgumentException(proxy.getClass().getName() + " not implement interface " + type);
}
this.proxy = proxy;
this.type = type;
this.url = url;
}
```

ğŸ™‚ èƒ–å‹ï¼Œè¯·çœ‹ä»£ç ä¸Šçš„æ³¨é‡Šã€‚

## 6.2 invoke

```
1: public Result invoke(Invocation invocation) throws RpcException{
2: try {
3: return new RpcResult(doInvoke(proxy, invocation.getMethodName(), invocation.getParameterTypes(), invocation.getArguments()));
4: } catch (InvocationTargetException e) {
5: return new RpcResult(e.getTargetException());
6: } catch (Throwable e) {
7: throw new RpcException("Failed to invoke remote proxy method " + invocation.getMethodName() + " to " + getUrl() + ", cause: " + e.getMessage(), e);
8: }
9: }
```

* ç¬¬ 3 è¡Œï¼šè°ƒç”¨

/#doInvoke(..)
**æŠ½è±¡**æ–¹æ³•ï¼Œæ‰§è¡Œè°ƒç”¨ï¼Œè¿”å›è°ƒç”¨ç»“æœã€‚

/#doInvoke(...)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* æ‰§è¡Œè°ƒç”¨
/*
/* @param proxy ä»£ç†çš„å¯¹è±¡
/* @param methodName æ–¹æ³•å
/* @param parameterTypes æ–¹æ³•å‚æ•°ç±»å‹æ•°ç»„
/* @param arguments æ–¹æ³•å‚æ•°æ•°ç»„
/* @return è°ƒç”¨ç»“æœ
/* @throws Throwable å‘ç”Ÿå¼‚å¸¸
/*/
protected abstract Object doInvoke(T proxy, String methodName, Class<?>[] parameterTypes, Object[] arguments) throws Throwable;
```
* ç¬¬ 3 è¡Œï¼šåˆ›å»º RpcResult å¯¹è±¡ï¼Œå°†ç»“æœåŒ…è£…è¿”å›ã€‚
* ç¬¬ 5 è¡Œï¼šå‘ç”Ÿ InvocationTargetException å¼‚å¸¸ï¼Œåˆ›å»º RpcResult å¯¹è±¡åŒ…è£…ã€‚

* [ã€Š Javaåå°„å¼‚å¸¸å¤„ç†ä¹‹InvocationTargetExceptionã€‹](https://blog.csdn.net/zhangzeyuaaa/article/details/39611467)

# 7. bytecode

åœ¨

dubbo-common
æ¨¡å—çš„

bytecode
åŒ…ï¼ŒåŸºäº Javassit åº“ï¼Œ**åŠ¨æ€ç¼–è¯‘**ï¼Œå®ç°æä¾›äº†**é€šç”¨çš„**çš„åŠ¨æ€ä»£ç†å®ç°ã€‚æ‰€ä»¥æœ¬å°èŠ‚ï¼Œä»**åŠ¨æ€ç¼–è¯‘**çš„è§’åº¦ä¸Šæ¥çœ‹ï¼Œåœ¨å†…å®¹ä¸Šï¼Œå’Œ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” åŠ¨æ€ç¼–è¯‘ï¼ˆä¸€ï¼‰ä¹‹ Javassistã€‹](http://svip.iocoder.cn/Dubbo/compiler-javassist/?self) æœ‰ä¸€å®šçš„ç›¸ä¼¼ã€‚

## 7.1 ClassGenerator

[
com.alibaba.dubbo.common.bytecode.ClassGenerator
](https://github.com/YunaiV/dubbo/blob/b5a5adcd965393b374a4f58ecea90264251c3cdb/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/ClassGenerator.java) ï¼Œç±»ç”Ÿæˆå™¨ï¼ŒåŸºäº **Javassist** å®ç°ã€‚

ç¬”è€…åœ¨ [ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” Dubbo æ”¯æŒã€‹](http://www.iocoder.cn/TCC-Transaction/dubbo-support/?self) çš„ [ã€Œ2.1.3 TccProxy & TccClassGeneratorã€](http://svip.iocoder.cn/Dubbo/proxy-javassist/)å·²ç»è¯¦ç»†åˆ†äº«ï¼ŒåŸºæœ¬ç±»ä¼¼ï¼Œèƒ–å‹ç…ç…å™¢ã€‚

## 7.3 Proxy

[
com.alibaba.dubbo.common.bytecode.Proxy
](https://github.com/YunaiV/dubbo/blob/b5a5adcd965393b374a4f58ecea90264251c3cdb/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/Proxy.java) ï¼Œä»£ç†æŠ½è±¡ç±»ï¼Œç”¨äºåˆ›å»º Proxy å’Œ proxy å¯¹è±¡ã€‚

ç¬”è€…åœ¨ [ã€ŠTCC-Transaction æºç åˆ†æ â€”â€” Dubbo æ”¯æŒã€‹](http://www.iocoder.cn/TCC-Transaction/dubbo-support/?self) çš„ [ã€Œ2.1.3 TccProxy & TccClassGeneratorã€](http://svip.iocoder.cn/Dubbo/proxy-javassist/)å·²ç»è¯¦ç»†åˆ†äº«ï¼ŒåŸºæœ¬ç±»ä¼¼ï¼Œèƒ–å‹ç…ç…å™¢ã€‚

å¦‚ä¸‹æ˜¯ä¸€ä¸ªç”Ÿæˆçš„ **Proxy** ä»£ç çš„ç¤ºä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
public class Proxy0 extends Proxy implements ClassGenerator.DC{
public Object newInstance(InvocationHandler paramInvocationHandler){
return new proxy0(paramInvocationHandler);
}
}
```

* **ç”Ÿæˆçš„Proxy** å®ç° Proxy æŠ½è±¡ç±»ï¼Œæ˜¯åˆ›å»º **ç”Ÿæˆçš„proxy** çš„å·¥å‚ï¼ˆä¸€ä¸€å¯¹åº”ï¼‰ã€‚ä¾‹å¦‚ï¼ŒProxy0 åˆ›å»º proxy0 å¯¹è±¡ã€‚
* /#newInstance(InvocationHandler)
æ–¹æ³•ï¼Œåˆ›å»º **ç”Ÿæˆçš„proxy** çš„æ–¹æ³•ã€‚

## 7.4 Wrapper

[
com.alibaba.dubbo.common.bytecode.Wrapper
](http://svip.iocoder.cn/Dubbo/proxy-javassist/TODO) ï¼ŒWrapper æŠ½è±¡ç±»ï¼Œç”¨äº**åˆ›å»ºæŸä¸ªå¯¹è±¡çš„æ–¹æ³•è°ƒç”¨**çš„åŒ…è£…å™¨ï¼Œä»¥é¿å…**åå°„**è°ƒç”¨ï¼Œæé«˜æ€§èƒ½ã€‚å³ï¼š
```
// åå°„
Method/#invoke(Object instance, Object[] args)
// ä¼˜åŒ–æˆ===>
// Wrapper
Wrapper/#invokeMethod(Object instance, String mn, Class<?>[] types, Object[] args)
```

* ä¸ºä»€ä¹ˆä¼šæé«˜æ€§èƒ½å‘¢ï¼Ÿçœ‹åˆ°ä¸Šæ–‡çš„ Wrapper ä»£ç†çš„ç¤ºä¾‹ï¼Œç›¸ä¿¡èƒ–å‹å·²ç»æ˜ç™½ã€‚

### 7.4.1 æŠ½è±¡æ–¹æ³•

åœ¨è‡ªåŠ¨ç”Ÿæˆ Wrapper ç±»æ—¶ï¼Œéœ€è¦å®ç°å¦‚ä¸‹**æŠ½è±¡**æ–¹æ³•ï¼š
```
abstract public String[] getPropertyNames();
abstract public Class<?> getPropertyType(String pn);
abstract public boolean hasProperty(String name);
abstract public Object getPropertyValue(Object instance, String pn) throws NoSuchPropertyException, IllegalArgumentException;
abstract public void setPropertyValue(Object instance, String pn, Object pv) throws NoSuchPropertyException, IllegalArgumentException;
abstract public String[] getMethodNames();
abstract public String[] getDeclaredMethodNames();
//*/*
/* invoke method.
/*
/* è°ƒç”¨æ–¹æ³•
/*
/* @param instance instance.
/* è¢«è°ƒç”¨çš„å¯¹è±¡
/* @param mn method name.
/* æ–¹æ³•å
/* @param types å‚æ•°ç±»å‹æ•°ç»„
/* @param args argument array.
/* å‚æ•°æ•°ç»„
/* @return return value.
/* è¿”å›å€¼
/*/
abstract public Object invokeMethod(Object instance, String mn, Class<?>[] types, Object[] args) throws NoSuchMethodException, InvocationTargetException;
```

### 7.4.2 getWrapper

/#getWrapper(c)
æ–¹æ³•ï¼Œæ ¹æ®æŒ‡å®šç±»ï¼Œè·å¾— Wrapper å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: public static Wrapper getWrapper(Class<?> c){
2: // åˆ¤æ–­æ˜¯å¦ç»§æ‰¿ ClassGenerator.DC.class ï¼Œå¦‚æœæ˜¯ï¼Œæ‹¿åˆ°çˆ¶ç±»ï¼Œé¿å…é‡å¤åŒ…è£…
3: while (ClassGenerator.isDynamicClass(c)) // can not wrapper on dynamic class.
4: c = c.getSuperclass();
5:
6: // æŒ‡å®šç±»ä¸º Object.class
7: if (c == Object.class)
8: return OBJECT_WRAPPER;
9:
10: // ä»ç¼“å­˜ä¸­è·å¾— Wrapper å¯¹è±¡
11: Wrapper ret = WRAPPER_MAP.get(c);
12: // åˆ›å»º Wrapper å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°ç¼“å­˜
13: if (ret == null) {
14: ret = makeWrapper(c);
15: WRAPPER_MAP.put(c, ret);
16: }
17: return ret;
18: }
```

* ç¬¬ 3 è‡³ 4 è¡Œï¼šåˆ¤æ–­æ˜¯å¦å·²ç»ç»§æ‰¿äº† [ClassGenerator.DC.class](https://github.com/YunaiV/dubbo/blob/91b4862d4aed0f984015b132c3cb426f9c3b0c76/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/ClassGenerator.java#L382-L386) ï¼Œå¦‚æœæ˜¯ï¼Œæ‹¿åˆ°çˆ¶ç±»ï¼Œé¿å…**é‡å¤åŒ…è£…**ã€‚
* ç¬¬ 7 è‡³ 8 è¡Œï¼šè‹¥æŒ‡å®šç±»ä¸º Object.class ï¼Œè¿”å› [OBJECT_WRAPPER](https://github.com/YunaiV/dubbo/blob/91b4862d4aed0f984015b132c3cb426f9c3b0c76/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/Wrapper.java#L43-L95) å¯¹è±¡ã€‚
* ç¬¬ 11 è¡Œï¼šä»ç¼“å­˜

WRAPPER_MAP
ä¸­ï¼Œè·å¾— Wrapper å¯¹è±¡ã€‚

WRAPPER_MAP
ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* Wrapper å¯¹è±¡ç¼“å­˜
/* key ï¼šWrapper ç±»ã€‚
/* value ï¼šProxy å¯¹è±¡
/*/
private static final Map<Class<?>, Wrapper> WRAPPER_MAP = new ConcurrentHashMap<Class<?>, Wrapper>(); //class wrapper map
```
* ç¬¬ 13 è‡³ 16 è¡Œï¼šè°ƒç”¨

/#makeWrapper(Class<?>)
æ–¹æ³•ï¼Œåˆ›å»º Wrapper å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°ç¼“å­˜ã€‚

### 7.4.3 makeWrapper

/#makeWrapper(Class<?>)
æ–¹æ³•ï¼Œåˆ›å»º Wrapper å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
æ—ç™½å›ï¼šå®ç°ä¸Šï¼Œå’Œ Proxy å·®ä¸è¿‡çš„ï¼Œåªç”Ÿæˆ**ä¸€ä¸ª** Wrapper ç±»ã€‚
  ```
1: private static Wrapper makeWrapper(Class<?> c){
2: // éç§æœ‰ç±»
3: if (c.isPrimitive())
4: throw new IllegalArgumentException("Can not create wrapper for primitive type: " + c);
5:
6: // ç±»å
7: String name = c.getName();
8: // ç±»åŠ è½½å™¨
9: ClassLoader cl = ClassHelper.getClassLoader(c);
10:
11: // è®¾ç½®å±æ€§æ–¹æ³• `/#setPropertyValue(o, n, v)` çš„å¼€å¤´çš„ä»£ç 
12: StringBuilder c1 = new StringBuilder("public void setPropertyValue(Object o, String n, Object v){ ");
13: // è·å¾—å±æ€§æ–¹æ³• `/#getPropertyValue(o, n)` çš„å¼€å¤´çš„ä»£ç 
14: StringBuilder c2 = new StringBuilder("public Object getPropertyValue(Object o, String n){ ");
15: // è°ƒç”¨æ–¹æ³• `/#invokeMethod(o, n, p, v)` çš„å¼€å¤´çš„ä»£ç 
16: StringBuilder c3 = new StringBuilder("public Object invokeMethod(Object o, String n, Class[] p, Object[] v) throws " + InvocationTargetException.class.getName() + "{ ");
17:
18: // æ·»åŠ æ¯ä¸ªæ–¹æ³•çš„ï¼Œè¢«è°ƒç”¨å¯¹è±¡çš„ç±»å‹è½¬æ¢çš„ä»£ç 
19: c1.append(name).append(" w; try{ w = ((").append(name).append(")$1); }catch(Throwable e){ throw new IllegalArgumentException(e); }");
20: c2.append(name).append(" w; try{ w = ((").append(name).append(")$1); }catch(Throwable e){ throw new IllegalArgumentException(e); }");
21: c3.append(name).append(" w; try{ w = ((").append(name).append(")$1); }catch(Throwable e){ throw new IllegalArgumentException(e); }");
22:
23: // å±æ€§åä¸å±æ€§åçš„é›†åˆï¼Œç”¨äº `/#hasProperty(...)` `/#setPropertyValue(...)` `getPropertyValue(...)` æ–¹æ³•ã€‚
24: Map<String, Class<?>> pts = new HashMap<String, Class<?>>(); // <property name, property types>
25: // æ–¹æ³•ç­¾åä¸æ–¹æ³•å¯¹è±¡çš„é›†åˆï¼Œç”¨äº `/#invokeMethod(..)` æ–¹æ³•ã€‚
26: Map<String, Method> ms = new LinkedHashMap<String, Method>(); // <method desc, Method instance>
27: // æ–¹æ³•åæ•°ç»„ç”¨äº `/#getMethodNames()` æ–¹æ³•ã€‚
28: List<String> mns = new ArrayList<String>(); // method names.
29: // å®šä¹‰çš„æ–¹æ³•åæ•°ç»„ï¼Œç”¨äº `/#getDeclaredMethodNames()` æ–¹æ³•ã€‚
30: List<String> dmns = new ArrayList<String>(); // declaring method names.
31:
32: // å¾ªç¯ public å±æ€§ï¼Œæ·»åŠ æ¯ä¸ªå±æ€§çš„è®¾ç½®å’Œè·å¾—åˆ†åˆ«åˆ° `/#setPropertyValue(o, n, v)` å’Œ `/#getPropertyValue(o, n)` çš„ä»£ç 
33: // get all public field.
34: for (Field f : c.getFields()) {
35: String fn = f.getName();
36: Class<?> ft = f.getType();
37: if (Modifier.isStatic(f.getModifiers()) || Modifier.isTransient(f.getModifiers())) // æ’é™¤ static å’Œ transient
38: continue;
39:
40: c1.append(" if( $2.equals(\"").append(fn).append("\") ){ w.").append(fn).append("=").append(arg(ft, "$3")).append("; return; }");
41: c2.append(" if( $2.equals(\"").append(fn).append("\") ){ return ($w)w.").append(fn).append("; }");
42: // æ·»åŠ åˆ° `pts` ä¸­
43: pts.put(fn, ft);
44: }
45:
46: Method[] methods = c.getMethods();
47: // å¦‚æœæœ‰æ–¹æ³•ï¼Œæ·»åŠ  `/#invokeMethod(o, n, p, v)` çš„ try çš„ä»£ç 
48: // get all public method.
49: boolean hasMethod = hasMethods(methods);
50: if (hasMethod) {
51: c3.append(" try{");
52: }
53: for (Method m : methods) {
54: // è·³è¿‡æ¥è‡ª Object çš„å†…ç½®æ–¹æ³•
55: if (m.getDeclaringClass() == Object.class) //ignore Object's method.
56: continue;
57:
58: String mn = m.getName(); // æ–¹æ³•å
59: // ä½¿ç”¨æ–¹æ³•å + æ–¹æ³•å‚æ•°é•¿åº¦æ¥åˆ¤æ–­
60: c3.append(" if( \"").append(mn).append("\".equals( $2 ) ");
61: int len = m.getParameterTypes().length;
62: c3.append(" && ").append(" $3.length == ").append(len);
63:
64: // è‹¥ç›¸åŒæ–¹æ³•åå­˜åœ¨å¤šä¸ªï¼Œå¢åŠ å‚æ•°ç±»å‹æ•°ç»„çš„æ¯”è¾ƒåˆ¤æ–­
65: boolean override = false;
66: for (Method m2 : methods) {
67: if (m != m2 && m.getName().equals(m2.getName())) {
68: override = true;
69: break;
70: }
71: }
72: if (override) {
73: if (len > 0) {
74: for (int l = 0; l < len; l++) {
75: c3.append(" && ").append(" $3[").append(l).append("].getName().equals(\"")
76: .append(m.getParameterTypes()[l].getName()).append("\")");
77: }
78: }
79: }
80:
81: c3.append(" ) { ");
82:
83: // æ·»åŠ è°ƒç”¨å¯¹è±¡çš„å¯¹åº”æ–¹æ³•çš„ä»£ç 
84: if (m.getReturnType() == Void.TYPE)
85: c3.append(" w.").append(mn).append('(').append(args(m.getParameterTypes(), "$4")).append(");").append(" return null;");
86: else
87: c3.append(" return ($w)w.").append(mn).append('(').append(args(m.getParameterTypes(), "$4")).append(");");
88:
89: c3.append(" }");
90:
91: // æ·»åŠ åˆ° `mns` ä¸­
92: mns.add(mn);
93: // æ·»åŠ åˆ° `dmns` ä¸­
94: if (m.getDeclaringClass() == c)
95: dmns.add(mn);
96: // æ·»åŠ åˆ° `ms` ä¸­
97: ms.put(ReflectUtils.getDesc(m), m);
98: }
99: // å¦‚æœæœ‰æ–¹æ³•ï¼Œæ·»åŠ  `/#invokeMethod(o, n, p, v)` çš„ catch çš„ä»£ç 
100: if (hasMethod) {
101: c3.append(" } catch(Throwable e) { ");
102: c3.append(" throw new java.lang.reflect.InvocationTargetException(e); ");
103: c3.append(" }");
104: }
105: // æ·»åŠ  `/#invokeMethod(o, n, p, v)` çš„æœªåŒ¹é…åˆ°æ–¹æ³•çš„ä»£ç 
106: c3.append(" throw new " + NoSuchMethodException.class.getName() + "(\"Not found method \\\"\"+$2+\"\\\" in class " + c.getName() + ".\"); }");
107:
108: // å¾ªç¯ setting/getting æ–¹æ³•ï¼Œæ·»åŠ æ¯ä¸ªå±æ€§çš„è®¾ç½®å’Œè·å¾—åˆ†åˆ«åˆ° `/#setPropertyValue(o, n, v)` å’Œ `/#getPropertyValue(o, n)` çš„ä»£ç 
109: // deal with get/set method.
110: Matcher matcher;
111: for (Map.Entry<String, Method> entry : ms.entrySet()) {
112: String md = entry.getKey();
113: Method method = entry.getValue();
114: if ((matcher = ReflectUtils.GETTER_METHOD_DESC_PATTERN.matcher(md)).matches()) {
115: String pn = propertyName(matcher.group(1));
116: c2.append(" if( $2.equals(\"").append(pn).append("\") ){ return ($w)w.").append(method.getName()).append("(); }");
117: // æ·»åŠ åˆ° `pts` ä¸­
118: pts.put(pn, method.getReturnType());
119: } else if ((matcher = ReflectUtils.IS_HAS_CAN_METHOD_DESC_PATTERN.matcher(md)).matches()) {
120: String pn = propertyName(matcher.group(1));
121: c2.append(" if( $2.equals(\"").append(pn).append("\") ){ return ($w)w.").append(method.getName()).append("(); }");
122: // æ·»åŠ åˆ° `pts` ä¸­
123: pts.put(pn, method.getReturnType());
124: } else if ((matcher = ReflectUtils.SETTER_METHOD_DESC_PATTERN.matcher(md)).matches()) { // ä¸æ”¯æŒ public T setName(String name) { this.name = name; return this;} è¿™ç§è¿”å› this çš„å½¢å¼ã€‚
125: Class<?> pt = method.getParameterTypes()[0];
126: String pn = propertyName(matcher.group(1));
127: c1.append(" if( $2.equals(\"").append(pn).append("\") ){ w.").append(method.getName()).append("(").append(arg(pt, "$3")).append("); return; }");
128: // æ·»åŠ åˆ° `pts` ä¸­
129: pts.put(pn, pt);
130: }
131: }
132: c1.append(" throw new " + NoSuchPropertyException.class.getName() + "(\"Not found property \\\"\"+$2+\"\\\" filed or setter method in class " + c.getName() + ".\"); }");
133: c2.append(" throw new " + NoSuchPropertyException.class.getName() + "(\"Not found property \\\"\"+$2+\"\\\" filed or setter method in class " + c.getName() + ".\"); }");
134:
135: // make class
136: long id = WRAPPER_CLASS_COUNTER.getAndIncrement();
137: // åˆ›å»º ClassGenerator å¯¹è±¡
138: ClassGenerator cc = ClassGenerator.newInstance(cl);
139: // è®¾ç½®ç±»å
140: cc.setClassName((Modifier.isPublic(c.getModifiers()) ? Wrapper.class.getName() : c.getName() + "$sw") + id);
141: // è®¾ç½®çˆ¶ç±»ä¸º Wrapper.class
142: cc.setSuperClass(Wrapper.class);
143:
144: // æ·»åŠ æ„é€ æ–¹æ³•ï¼Œå‚æ•° ç©º
145: cc.addDefaultConstructor();
146: // æ·»åŠ é™æ€å±æ€§ `pns` çš„ä»£ç 
147: cc.addField("public static String[] pns;"); // property name array.
148: // æ·»åŠ é™æ€å±æ€§ `pts` çš„ä»£ç 
149: cc.addField("public static " + Map.class.getName() + " pts;"); // property type map.
150: // æ·»åŠ é™æ€å±æ€§ `pts` çš„ä»£ç 
151: cc.addField("public static String[] mns;"); // all method name array.
152: // æ·»åŠ é™æ€å±æ€§ `dmns` çš„ä»£ç 
153: cc.addField("public static String[] dmns;"); // declared method name array.
154: // æ·»åŠ é™æ€å±æ€§ `mts` çš„ä»£ç ã€‚æ¯ä¸ªæ–¹æ³•çš„å‚æ•°æ•°ç»„ã€‚
155: for (int i = 0, len = ms.size(); i < len; i++)
156: cc.addField("public static Class[] mts" + i + ";");
157:
158: // ======= æ·»åŠ æŠ½è±¡æ–¹æ³•çš„å®ç°ï¼Œåˆ° `cc` ä¸­
159: // æ·»åŠ  `/#getPropertyNames()` çš„ä»£ç åˆ° `cc`
160: cc.addMethod("public String[] getPropertyNames(){ return pns; }");
161: // æ·»åŠ  `/#hasProperty(n)` çš„ä»£ç åˆ° `cc`
162: cc.addMethod("public boolean hasProperty(String n){ return pts.containsKey($1); }");
163: // æ·»åŠ  `/#getPropertyType(n)` çš„ä»£ç åˆ° `cc`
164: cc.addMethod("public Class getPropertyType(String n){ return (Class)pts.get($1); }");
165: // æ·»åŠ  `/#getMethodNames()` çš„ä»£ç åˆ° `cc`
166: cc.addMethod("public String[] getMethodNames(){ return mns; }");
167: // æ·»åŠ  `/#getDeclaredMethodNames()` çš„ä»£ç åˆ° `cc`
168: cc.addMethod("public String[] getDeclaredMethodNames(){ return dmns; }");
169: // æ·»åŠ  `/#setPropertyValue(o, n, v)` çš„ä»£ç åˆ° `cc`
170: cc.addMethod(c1.toString());
171: // æ·»åŠ  `/#getPropertyValue(o, n)` çš„ä»£ç åˆ° `cc`
172: cc.addMethod(c2.toString());
173: // æ·»åŠ  `/#invokeMethod(o, n, p, v)` çš„ä»£ç åˆ° `cc`
174: cc.addMethod(c3.toString());
175:
176: try {
177: // ç”Ÿæˆç±»
178: Class<?> wc = cc.toClass();
179: // åå°„ï¼Œè®¾ç½®é™æ€å˜é‡çš„å€¼
180: // setup static field.
181: wc.getField("pts").set(null, pts);
182: wc.getField("pns").set(null, pts.keySet().toArray(new String[0]));
183: wc.getField("mns").set(null, mns.toArray(new String[0]));
184: wc.getField("dmns").set(null, dmns.toArray(new String[0]));
185: int ix = 0;
186: for (Method m : ms.values())
187: wc.getField("mts" + ix++).set(null, m.getParameterTypes());
188: // åˆ›å»ºå¯¹è±¡
189: return (Wrapper) wc.newInstance();
190: } catch (RuntimeException e) {
191: throw e;
192: } catch (Throwable e) {
193: throw new RuntimeException(e.getMessage(), e);
194: } finally {
195: // é‡Šæ”¾èµ„æº
196: cc.release();
197: ms.clear();
198: mns.clear();
199: dmns.clear();
200: }
201: }
```

* ä¸Šæ–‡ç”Ÿæˆçš„ Wrapper1 çš„ä»£ç ï¼Œå¯¹åº”çš„ DempServiceImpl çš„ä»£ç å¦‚ä¸‹ï¼š
```
1: public class DemoServiceImpl implements DemoService{
2:
3: //*/*
4: /* æµ‹è¯•å±æ€§ï¼Œ{@link com.alibaba.dubbo.common.bytecode.Wrapper}
5: /*/
6: public String test01;
7:
8: private DemoDAO demoDAO;
9:
10: public String sayHello(String name){
11: System.out.println("[" + new SimpleDateFormat("HH:mm:ss").format(new Date()) + "] Hello " + name + ", request from consumer: " + RpcContext.getContext().getRemoteAddress());
12: return "Hello " + name + ", response form provider: " + RpcContext.getContext().getLocalAddress();
13: }
14:
15: @Override
16: public void bye(Object o){
17: System.out.println(JSON.toJSONString(o));
18: System.out.println(o.getClass());
19: }
20:
21: public void setDemoDAO(DemoDAO demoDAO){
22: this.demoDAO = demoDAO;
23: }
24:
25: }
```

* ä¸‹é¢ï¼Œæˆ‘ä»¬çš„è§£æï¼Œä¼šç»“åˆè¿™ä¸ªç±»ä¸€èµ·è®²ã€‚

* ========== ç”Ÿæˆä»£ç  ==========
* ç¬¬ 11 è‡³ 16 è¡Œï¼šåˆ›å»ºæ–¹æ³•çš„**å¼€å¤´**çš„ä»£ç ï¼š

* /#setPropertyValue(o, n, v)
çš„ã€Wrapper1 ç¬¬ 45 è‡³ 46 è¡Œã€‘
* /#getPropertyValue(o, n)
çš„ã€Wrapper1 ç¬¬ 69 è‡³ 70 è¡Œã€‘
* /#invokeMethod(o, n, p, v)
çš„ã€Wrapper1 ç¬¬ 86 è‡³ 88 è¡Œã€‘
* ç¬¬ 19 è‡³ 21 è¡Œï¼šè®¾ç½®æ–¹æ³•çš„**è¢«è°ƒç”¨å¯¹è±¡çš„ç±»å‹è½¬æ¢**çš„ä»£ç ï¼š

* /#setPropertyValue(o, n, v)
çš„ã€Wrapper1 ç¬¬ 47 è‡³ 55 è¡Œã€‘

* /#getPropertyValue(o, n)
çš„ã€Wrapper1 ç¬¬ 71 è‡³ 79 è¡Œã€‘
* /#invokeMethod(o, n, p, v)
çš„ã€Wrapper1 ç¬¬ 89 è‡³ 97 è¡Œã€‘
* ç¬¬ 23 è‡³ 30 è¡Œï¼šå£°æ˜

pts

ms

mn

dmns
å˜é‡ã€‚ğŸ™‚ æ¯ä¸ªå˜é‡çš„ç”¨é€”ï¼Œå·²ç»æ·»åŠ åˆ°ä»£ç çš„æ³¨é‡Šä¸Šã€‚
* ç¬¬ 32 è‡³ 44 è¡Œï¼šå¾ªç¯ **public** å±æ€§ï¼Œæ·»åŠ æ¯ä¸ªå±æ€§çš„è®¾ç½®å’Œè·å¾—åˆ†åˆ«ä»£ç ï¼š

* ã€DemoServiceImpl ç¬¬ 6 è¡Œã€‘
* /#setPropertyValue(o, n, v)
çš„ã€Wrapper1 ç¬¬ 56 è‡³ 60 è¡Œã€‘
* /#getPropertyValue(o, n)
çš„ã€Wrapper1 ç¬¬ 80 è‡³ 62 è¡Œã€‘
* ç¬¬ 46 è‡³ 106 è¡Œï¼šè®¾ç½®æ–¹æ³•

/#invokeMethod(o, n, p, v)
çš„è°ƒç”¨ä»£ç ï¼š

* ã€DemoServiceImpl ç¬¬ 10 è‡³ 23 è¡Œã€‘
* ã€Wrapper1 ç¬¬ 98 è‡³ 119 è¡Œã€‘
* ç¬¬ 108 è‡³ 131 è¡Œï¼šå¾ªç¯ **setting / getting** å±æ€§ï¼Œæ·»åŠ æ¯ä¸ªå±æ€§çš„è®¾ç½®å’Œè·å¾—åˆ†åˆ«ä»£ç ï¼š

* /#setPropertyValue(o, n, v)

* ã€DemoServiceImpl ç¬¬ 21 è‡³ 23 è¡Œã€‘ã€DemoServiceImpl ç¬¬ 8 è¡Œã€‘
* ã€Wrapper1 ç¬¬ 61 è‡³ 62 è¡Œã€‘
* ğŸ™‚

/#getPropertyValue(o, n)
æ²¡ä¸¾ä¾‹å­ï¼Œèƒ–å‹è‡ªå·±çœ‹ä»£ç è„‘è¡¥ã€‚
* ========== ç”Ÿæˆç±» ==========
* ç¬¬ 138 è¡Œï¼šåˆ›å»º ClassGenerator å¯¹è±¡ã€‚
* ç¬¬ 140 è¡Œï¼šè®¾ç½®ç±»åã€‚
* ç¬¬ 142 è¡Œï¼šè®¾ç½®çˆ¶ç±»ä¸º Wrapper.class
* ç¬¬ 145 è¡Œï¼šæ·»åŠ æ„é€ æ–¹æ³•ï¼Œå‚æ•°ä¸ºç©º
* ç¬¬ 146 è‡³ 156 è¡Œï¼šæ·»åŠ **é™æ€å±æ€§**

pns

pts

mns

dmns

mts
ã€‚
* ç¬¬ 158 è‡³ 174 è¡Œï¼šæ·»åŠ **æŠ½è±¡æ–¹æ³•**çš„å®ç°ã€‚
* ç¬¬ 178 è¡Œï¼šç”Ÿæˆç±»ã€‚
* ========== åˆ›å»ºå¯¹è±¡ ==========
* ç¬¬ 179 è‡³ 187 è¡Œï¼šåå°„ï¼Œè®¾ç½®**é™æ€å±æ€§**çš„å€¼ã€‚
* ç¬¬ 189 è¡Œï¼šåˆ›å»º Wrapper å¯¹è±¡ã€‚
* ========== é‡Šæ”¾ ==========
* ç¬¬ 195 è‡³ 199 è¡Œï¼šé‡Šæ”¾èµ„æºã€‚