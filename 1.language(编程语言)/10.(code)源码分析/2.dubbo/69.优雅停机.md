# ä¼˜é›…åœæœº

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº« Dubbo çš„**ä¼˜é›…åœæœº** Graceful Shutdown ï¼Œå¯¹åº” [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” ä¼˜é›…åœæœºã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/graceful-shutdown.html) ã€‚

å®šä¹‰å¦‚ä¸‹ï¼š
Dubbo æ˜¯é€šè¿‡ JDK çš„ ShutdownHook æ¥å®Œæˆä¼˜é›…åœæœºçš„ï¼Œæ‰€ä»¥å¦‚æœç”¨æˆ·ä½¿ç”¨

kill -9 PID
ç­‰å¼ºåˆ¶å…³é—­æŒ‡ä»¤ï¼Œæ˜¯ä¸ä¼šæ‰§è¡Œä¼˜é›…åœæœºçš„ï¼Œåªæœ‰é€šè¿‡

kill PID
æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œã€‚

* è¿™å—ï¼Œæˆ‘ä»¬åœ¨ [ã€Œ2. ShutdownHookã€](http://svip.iocoder.cn/Dubbo/graceful-shutdown/) ä¸­ï¼Œè¯¦ç»†è§£æã€‚

åŸç†å¦‚ä¸‹ï¼š
**æœåŠ¡æä¾›æ–¹**

* åœæ­¢æ—¶ï¼Œå…ˆæ ‡è®°ä¸ºä¸æ¥æ”¶æ–°è¯·æ±‚ï¼Œæ–°è¯·æ±‚è¿‡æ¥æ—¶ç›´æ¥æŠ¥é”™ï¼Œè®©å®¢æˆ·ç«¯é‡è¯•å…¶å®ƒæœºå™¨ã€‚ //<1>
* ç„¶åï¼Œæ£€æµ‹çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Œå¦‚æœæœ‰ï¼Œç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œé™¤éè¶…æ—¶ï¼Œåˆ™å¼ºåˆ¶å…³é—­ã€‚ // <2>

**æœåŠ¡æ¶ˆè´¹æ–¹**

* åœæ­¢æ—¶ï¼Œä¸å†å‘èµ·æ–°çš„è°ƒç”¨è¯·æ±‚ï¼Œæ‰€æœ‰æ–°çš„è°ƒç”¨åœ¨å®¢æˆ·ç«¯å³æŠ¥é”™ã€‚ // <3>
* ç„¶åï¼Œæ£€æµ‹æœ‰æ²¡æœ‰è¯·æ±‚çš„å“åº”è¿˜æ²¡æœ‰è¿”å›ï¼Œç­‰å¾…å“åº”è¿”å›ï¼Œé™¤éè¶…æ—¶ï¼Œåˆ™å¼ºåˆ¶å…³é—­ã€‚ // <4>

* <1>

<2>
ï¼šåŸºäº **READONLYEVENT** äº‹ä»¶ï¼Œåœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” NIO æœåŠ¡å™¨ï¼ˆå››ï¼‰ä¹‹ Exchange å±‚ã€‹](http://svip.iocoder.cn/Dubbo/remoting-api-exchange/?self)ä¸­ï¼Œè§ HeaderExchangeServer çš„ [ã€Œ4.1.4 ä¼˜é›…å…³é—­ã€](http://svip.iocoder.cn/Dubbo/graceful-shutdown/) ã€‚
* <3>

<4>
ï¼šåœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” NIO æœåŠ¡å™¨ï¼ˆå››ï¼‰ä¹‹ Exchange å±‚ã€‹](http://svip.iocoder.cn/Dubbo/remoting-api-exchange/?self) ä¸­ï¼Œè§ HeaderExchangeChannel çš„ [ã€Œ2.1.2 å‘é€è¯·æ±‚ã€](http://svip.iocoder.cn/Dubbo/graceful-shutdown/) å’Œ [ã€Œ2.1.3 ä¼˜é›…å…³é—­ã€](http://svip.iocoder.cn/Dubbo/graceful-shutdown/)ã€‚
* ğŸ˜ˆ å› ä¸ºä¹‹å‰æ–‡ç« æ˜¯**æ‹†å¼€**çš„ï¼Œæ‰€ä»¥ä¸‹æ–‡ä¼šæä¾›ä¸‹**æ•´ä½“**çš„é¡ºåºå›¾ã€‚

# 2. ShutdownHook

Dubbo çš„ä¼˜é›…åœæœº **ShutdownHook** åœ¨ AbstractConfig çš„**é™æ€ä»£ç å—**åˆå§‹åŒ–ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
static {
Runtime.getRuntime().addShutdownHook(new Thread(new Runnable() {
public void run(){
if (logger.isInfoEnabled()) {
logger.info("Run shutdown hook now.");
}
ProtocolConfig.destroyAll();
}
}, "DubboShutdownHook"));
}
```

* ä»ä»£ç çš„ä½ç½®ä¸Šæ¥è¯´ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ª**å¥½**çš„ä½ç½®ã€‚ä½†æ˜¯è€ƒè™‘åˆ°ä¿è¯**èƒ½å¤Ÿ**è¢«åˆå§‹åŒ–åˆ° ShutdownHook ï¼Œè¿™åˆæ˜¯ä¸€ä¸ª**åˆé€‚**çš„ä½ç½®ã€‚å½“ç„¶ï¼Œä»å®˜æ–¹çš„ TODO æ¥è¯´ï¼Œæœªæ¥å¯èƒ½ä¼šæ¢åœ°æ–¹ã€‚
* ProtocolConfig/#destroyAll()
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
1: public static void destroyAll(){
2: // å¿½ç•¥ï¼Œè‹¥å·²ç»é”€æ¯
3: if (!destroyed.compareAndSet(false, true)) {
4: return;
5: }
6: // é”€æ¯ Registry ç›¸å…³
7: AbstractRegistryFactory.destroyAll();
8:
9: // ç­‰åˆ°æœåŠ¡æ¶ˆè´¹ï¼Œæ¥æ”¶åˆ°æ³¨å†Œä¸­å¿ƒé€šçŸ¥åˆ°è¯¥æœåŠ¡æä¾›è€…å·²ç»ä¸‹çº¿ï¼ŒåŠ å¤§äº†åœ¨ä¸é‡è¯•æƒ…å†µä¸‹ä¼˜é›…åœæœºçš„æˆåŠŸç‡ã€‚
10: // Wait for registry notification
11: try {
12: Thread.sleep(ConfigUtils.getServerShutdownTimeout());
13: } catch (InterruptedException e) {
14: logger.warn("Interrupted unexpectedly when waiting for registry notification during shutdown process!");
15: }
16:
17: // é”€æ¯ Protocol ç›¸å…³
18: ExtensionLoader<Protocol> loader = ExtensionLoader.getExtensionLoader(Protocol.class);
19: for (String protocolName : loader.getLoadedExtensions()) {
20: try {
21: Protocol protocol = loader.getLoadedExtension(protocolName);
22: if (protocol != null) {
23: protocol.destroy();
24: }
25: } catch (Throwable t) {
26: logger.warn(t.getMessage(), t);
27: }
28: }
29: }
```

* ç¬¬ 2 è‡³ 5 è¡Œï¼š**å¿½ç•¥**ï¼Œè‹¥å·²ç»é”€æ¯ã€‚
* ç¬¬ 7 è¡Œï¼šè°ƒç”¨

AbstractRegistryFactory/#destroyAll()
æ–¹æ³•ï¼Œé”€æ¯**æ‰€æœ‰** Registry ï¼Œå–æ¶ˆ**åº”ç”¨ç¨‹åº**ä¸­çš„æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…çš„**è®¢é˜…**ä¸**æ³¨å†Œ**ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ2.1 AbstractRegistryFactoryã€](http://svip.iocoder.cn/Dubbo/graceful-shutdown/) ä¸­ã€‚
* ç¬¬ 9 è‡³ 15 è¡Œï¼šsleep **ç­‰å¾…**ä¸€æ®µæ—¶é—´ï¼Œç”¨äº**å…¶ä»–åº”ç”¨ç¨‹åº**çš„æœåŠ¡æ¶ˆè´¹è€…ï¼Œæ¥æ”¶åˆ°æ³¨å†Œä¸­å¿ƒé€šçŸ¥ï¼Œè¯¥**åº”ç”¨ç¨‹åº**çš„æœåŠ¡æä¾›è€…å·²ç»ä¸‹çº¿ï¼ŒåŠ å¤§äº†åœ¨ä¸é‡è¯•æƒ…å†µä¸‹ä¼˜é›…åœæœºçš„æˆåŠŸç‡ã€‚

* ğŸ˜ˆ å½“ç„¶ï¼Œè¿™ä¸æ˜¯**ç»å¯¹**èƒ½ç­‰å¾…åˆ°ï¼Œè€Œæ˜¯å¼€å‘è€…è‡ªå·±é…ç½®

"dubbo.service.shutdown.wait"
å‚æ•°ï¼Œè®¾ç½®ç­‰å¾…çš„æ—¶é•¿ï¼ˆå•ä½ï¼šæ¯«ç§’ï¼‰ã€‚

ConfigUtils/#getServerShutdownTimeout()
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
public static int getServerShutdownTimeout(){
// é»˜è®¤ï¼Œ10 /* 1000 æ¯«ç§’
int timeout = Constants.DEFAULT_SERVER_SHUTDOWN_TIMEOUT;
// è·å¾— "dubbo.service.shutdown.wait" é…ç½®é¡¹ï¼Œå•ä½ï¼šæ¯«ç§’
String value = ConfigUtils.getProperty(Constants.SHUTDOWN_WAIT_KEY);
if (value != null && value.length() > 0) {
try {
timeout = Integer.parseInt(value);
} catch (Exception e) {
}
// è‹¥ä¸ºç©ºï¼Œè·å¾— "dubbo.service.shutdown.wait.seconds" é…ç½®é¡¹ï¼Œå•ä½ï¼šç§’ã€‚
// psï¼šç›®å‰å·²ç»åºŸå¼ƒè¯¥å‚æ•°ï¼Œæ¨èä½¿ç”¨ "dubbo.service.shutdown.wait"
} else {
value = ConfigUtils.getProperty(Constants.SHUTDOWN_WAIT_SECONDS_KEY);
if (value != null && value.length() > 0) {
try {
timeout = Integer.parseInt(value) /* 1000;
} catch (Exception e) {
}
}
}
// è¿”å›
return timeout;
}
```

* **é»˜è®¤** 10 /* 1000 æ¯«ç§’ã€‚
* åœ¨ [ISSUE/#1021ï¼šEnhancement for graceful shutdown](https://github.com/apache/incubator-dubbo/pull/1021) ï¼Œæ˜¯é’ˆå¯¹è¿™å—çš„è®¨è®ºï¼Œéå¸¸æœ‰è¶£ï¼Œèƒ–å‹ä¸€å®šè¦çœ‹çœ‹ã€‚
ç›®å‰ä¸ç®¡æ˜¯ç”¨çš„æœ€å¤šçš„2.5.3ç‰ˆæœ¬è¿˜æ˜¯æœ€æ–°çš„2.5.7ç‰ˆæœ¬ï¼Œäº²è‡ªæµ‹è¯•åœ¨ä¸è®¾ç½®é‡è¯•æœºåˆ¶ä¸‹æ˜¯æ— æ³•åšåˆ°ä¼˜é›…åœæœºçš„ï¼Œè¿™æ¬¡æ”¹åŠ¨ä¸»è¦æ˜¯ä¿®æ”¹ä¸€ç‚¹ç‚¹ä»£ç ï¼ŒåŠ ä¸Šå¯é…ç½®çš„ç­‰å¾…æ—¶é—´ï¼Œå°±èƒ½ç®€å•çš„åšåˆ°â€œä¸å¼€å¯é‡è¯•ä¹Ÿèƒ½ä¼˜é›…åœæœºâ€ã€‚

å…¶ä¸»è¦å®ç°æœºåˆ¶å°±æ˜¯åœ¨ã€provideræ–­è¿æ³¨å†Œä¸­å¿ƒä¹‹åï¼Œå…³é—­åº”ç­”ä¹‹å‰ã€‘å’Œã€consumerç§»é™¤æ‰invokeråï¼Œå…³é—­clientä¹‹å‰ã€‘è¿™ä¸¤ä¸ªé˜¶æ®µåŠ å…¥å¯é…ç½®çš„ç­‰å¾…æ—¶é—´ï¼Œç›®å‰äº²æµ‹å¯ä»¥åšåˆ°ä¸é…ç½®é‡è¯•ä¹Ÿèƒ½ä¼˜é›…åœæœºã€‚

å› ä¸ºç°åœ¨å¤§å¤šæ•°ç”¨dubboçš„å…¬å¸ï¼Œä¸ºäº†é¿å…æç«¯æƒ…å†µä¸‹çš„é›ªå´©å’Œæµé‡é£æš´ï¼Œå¤§éƒ¨åˆ†æ¥å£éƒ½ä¼šå…³é—­é‡è¯•æœºåˆ¶ï¼Œè¿™æ ·ï¼Œå¯¹äºå½“å‰dubboä¼˜é›…åœæœºçš„è®¾å®šï¼Œå°±æ— æ³•åšåˆ°ä¼˜é›…åœæœºäº†ï¼Œæ‰€ä»¥è¿™é‡Œé€šè¿‡æ¯”è¾ƒç®€å•çš„æ–¹å¼ï¼ŒåŠ å¤§äº†åœ¨ä¸é‡è¯•æƒ…å†µä¸‹ä¼˜é›…åœæœºçš„æˆåŠŸç‡ã€‚
* ç¬¬ 17 è‡³ 28 è¡Œï¼šé”€æ¯**æ‰€æœ‰** Protocol ã€‚ç›®å‰åˆ†å±‚ä¸¤ç±» Protocol ï¼š

* å’Œ Registry é›†æˆçš„ Protocol å®ç°ç±» **RegistryProtocol** ï¼Œå…³æ³¨æœåŠ¡çš„**æ³¨å†Œ**ã€‚å…·ä½“çš„é”€æ¯é€»è¾‘ï¼Œè§ [ã€Œ2.3 RegistryProtocolã€](http://svip.iocoder.cn/Dubbo/graceful-shutdown/) ä¸­ã€‚
* **å…·ä½“åè®®**å¯¹åº”çš„ Protocol å®ç°ç±»ï¼Œä¾‹å¦‚

dubbo://
å¯¹åº”çš„ DubboProtocol ã€

hessian://
å¯¹åº”çš„ HessianProtocol ï¼Œå…³æ³¨æœåŠ¡çš„**æš´éœ²**å’Œ**å¼•ç”¨**ã€‚å› ä¸º DubboProtocol æ˜¯æœ€**å¸¸ç”¨**çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»¥å®ƒä¸ºä¾‹å­ï¼Œåœ¨ [ã€Œ2.2 DubboProtocolã€](http://svip.iocoder.cn/Dubbo/graceful-shutdown/) ä¸­åˆ†äº«ã€‚

## 2.1 AbstractRegistryFactory

/#destroyAll()
æ–¹æ³•ï¼Œé”€æ¯æ‰€æœ‰ Registry ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
private static final Map<String, Registry> REGISTRIES = new ConcurrentHashMap<String, Registry>();
public static void destroyAll(){
if (LOGGER.isInfoEnabled()) {
LOGGER.info("Close all registries " + getRegistries());
}
// è·å¾—é”
LOCK.lock();
try {
// é”€æ¯
for (Registry registry : getRegistries()) {
try {
registry.destroy();
} catch (Throwable e) {
LOGGER.error(e.getMessage(), e);
}
}
// æ¸…ç©ºç¼“å­˜
REGISTRIES.clear();
} finally {
// é‡Šæ”¾é”
LOCK.unlock();
}
}
```

* è°ƒç”¨

Registry/#destroy()
æ–¹æ³•ï¼Œé”€æ¯æ¯ä¸ª Registry ã€‚
* AbstractRegistry å®ç°äº†**å…¬ç”¨**çš„é”€æ¯é€»è¾‘ï¼šå–æ¶ˆ**æ³¨å†Œ**å’Œ**è®¢é˜…**ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
@Override
public void destroy(){
// å·²é”€æ¯ï¼Œè·³è¿‡
if (!destroyed.compareAndSet(false, true)) {
return;
}
if (logger.isInfoEnabled()) {
logger.info("Destroy registry:" + getUrl());
}
// å–æ¶ˆæ³¨å†Œ
Set<URL> destroyRegistered = new HashSet<URL>(getRegistered());
if (!destroyRegistered.isEmpty()) {
for (URL url : new HashSet<URL>(getRegistered())) {
if (url.getParameter(Constants.DYNAMIC_KEY, true)) {
try {
unregister(url); // å–æ¶ˆæ³¨å†Œ
if (logger.isInfoEnabled()) {
logger.info("Destroy unregister url " + url);
}
} catch (Throwable t) {
logger.warn("Failed to unregister url " + url + " to registry " + getUrl() + " on destroy, cause: " + t.getMessage(), t);
}
}
}
}
// å–æ¶ˆè®¢é˜…
Map<URL, Set<NotifyListener>> destroySubscribed = new HashMap<URL, Set<NotifyListener>>(getSubscribed());
if (!destroySubscribed.isEmpty()) {
for (Map.Entry<URL, Set<NotifyListener>> entry : destroySubscribed.entrySet()) {
URL url = entry.getKey();
for (NotifyListener listener : entry.getValue()) {
try {
unsubscribe(url, listener); // å–æ¶ˆè®¢é˜…
if (logger.isInfoEnabled()) {
logger.info("Destroy unsubscribe url " + url);
}
} catch (Throwable t) {
logger.warn("Failed to unsubscribe url " + url + " to registry " + getUrl() + " on destroy, cause: " + t.getMessage(), t);
}
}
}
}
}
```

* æ— è®ºæ˜¯æœåŠ¡**æä¾›è€…**è¿˜æ˜¯**æ¶ˆè´¹è€…**ï¼Œéƒ½ä¼šå‘ Registry å‘èµ·**æ³¨å†Œ**å’Œ**è®¢é˜…**ï¼Œæ‰€ä»¥**éƒ½**éœ€è¦è¿›è¡Œå–æ¶ˆã€‚
* AbstractRegistry çš„**å­ç±»** FailbackRegistry ï¼Œå®ç°é”€æ¯**å…¬ç”¨**çš„**é‡è¯•ä»»åŠ¡**ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
@Override
public void destroy(){
// å¿½ç•¥ï¼Œè‹¥å·²ç»é”€æ¯
if (!canDestroy()) {
return;
}
// è°ƒç”¨çˆ¶æ–¹æ³•ï¼Œå–æ¶ˆæ³¨å†Œå’Œè®¢é˜…
super.destroy();
// é”€æ¯é‡è¯•ä»»åŠ¡
try {
retryFuture.cancel(true);
} catch (Throwable t) {
logger.warn(t.getMessage(), t);
}
}
protected boolean canDestroy(){
return destroyed.compareAndSet(false, true);
}
```
* FailbackRegistry æœ‰**å¤šç§**å®ç°ç±»ï¼Œä¼šæœ‰é”€æ¯å…¶å¯¹åº”çš„**å®¢æˆ·ç«¯è¿æ¥**çš„é€»è¾‘ã€‚ä»¥ **Zookeeper**Registry ä¸¾ä¾‹å­ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
@Override
public void destroy(){
// è°ƒç”¨çˆ¶æ–¹æ³•ï¼Œå–æ¶ˆæ³¨å†Œå’Œè®¢é˜…
super.destroy();
try {
// å…³é—­ Zookeeper å®¢æˆ·ç«¯è¿æ¥
zkClient.close();
} catch (Exception e) {
logger.warn("Failed to close zookeeper client " + getUrl() + ", cause: " + e.getMessage(), e);
}
}
```

## 2.2 DubboProtocol

/#destroy()
æ–¹æ³•ï¼Œé”€æ¯**æ‰€æœ‰**é€šä¿¡ ExchangeClient å’Œ ExchangeServer ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: @SuppressWarnings("Duplicates")
2: @Override
3: public void destroy(){
4: // é”€æ¯æ‰€æœ‰ ExchangeServer
5: for (String key : new ArrayList<String>(serverMap.keySet())) {
6: ExchangeServer server = serverMap.remove(key);
7: if (server != null) {
8: try {
9: if (logger.isInfoEnabled()) {
10: logger.info("Close dubbo server: " + server.getLocalAddress());
11: }
12: server.close(ConfigUtils.getServerShutdownTimeout());
13: } catch (Throwable t) {
14: logger.warn(t.getMessage(), t);
15: }
16: }
17: }
18:
19: // é”€æ¯æ‰€æœ‰ ExchangeClient
20: for (String key : new ArrayList<String>(referenceClientMap.keySet())) {
21: ExchangeClient client = referenceClientMap.remove(key);
22: if (client != null) {
23: try {
24: if (logger.isInfoEnabled()) {
25: logger.info("Close dubbo connect: " + client.getLocalAddress() + "-->" + client.getRemoteAddress());
26: }
27: client.close(ConfigUtils.getServerShutdownTimeout()); // é”€æ¯
28: } catch (Throwable t) {
29: logger.warn(t.getMessage(), t);
30: }
31: }
32: }
33: // é”€æ¯æ‰€æœ‰å¹½çµ ExchangeClient
34: for (String key : new ArrayList<String>(ghostClientMap.keySet())) {
35: ExchangeClient client = ghostClientMap.remove(key);
36: if (client != null) {
37: try {
38: if (logger.isInfoEnabled()) {
39: logger.info("Close dubbo connect: " + client.getLocalAddress() + "-->" + client.getRemoteAddress());
40: }
41: client.close(ConfigUtils.getServerShutdownTimeout()); // é”€æ¯
42: } catch (Throwable t) {
43: logger.warn(t.getMessage(), t);
44: }
45: }
46: }
47: // ã€TODO 8033ã€‘ å‚æ•°å›è°ƒ
48: stubServiceMethodsMap.clear();
49: super.destroy();
50: }
```

* å®é™…æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºå³å¯ä»¥æ˜¯æœåŠ¡**æä¾›è€…**ï¼Œåˆæ˜¯æœåŠ¡**æ¶ˆè´¹è€…**ã€‚å› æ­¤ï¼Œéœ€è¦å…³é—­ ExchangeClient å’Œ ExchangeServer ã€‚
* ç¬¬ 4 è‡³ 17 è¡Œï¼š**å¾ªç¯**è°ƒç”¨

HeaderExchangeServer/#close(timeout)
æ–¹æ³•ï¼Œé”€æ¯æ‰€æœ‰ ExchangeServer ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ2.2.1 HeaderExchangeServerã€](http://svip.iocoder.cn/Dubbo/graceful-shutdown/) ã€‚
* ç¬¬ 19 è‡³ 32 è¡Œï¼š**å¾ªç¯**è°ƒç”¨

ReferenceCountExchangeClient/#close(timeout)
æ–¹æ³•ï¼Œé”€æ¯æ‰€æœ‰ ReferenceCountExchangeClient ã€‚**åœ¨è¯¥æ–¹æ³•å†…éƒ¨**ï¼Œä¼šè°ƒç”¨

HeaderExchangeClient/#close(timeout)
æ–¹æ³•ï¼Œå…³é—­ HeaderExchangeClient å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ2.2.2 HeaderExchangeClientã€](http://svip.iocoder.cn/Dubbo/graceful-shutdown/) ã€‚
* ç¬¬ 33 è‡³ 46 è¡Œï¼š**å¾ªç¯**è°ƒç”¨

LazyConnectExchangeClient/#close(timeout)
æ–¹æ³•ï¼Œè¿›è¡Œå…³é—­ã€‚å…³äº LazyConnectExchangeClient ï¼Œè¯¦ç»†è§ [ç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æœåŠ¡å¼•ç”¨ï¼ˆäºŒï¼‰ä¹‹è¿œç¨‹å¼•ç”¨ï¼ˆDubboï¼‰](http://svip.iocoder.cn/Dubbo/reference-refer-dubbo/?self) çš„ [ã€Œ5.2 LazyConnectExchangeClientã€](http://svip.iocoder.cn/Dubbo/graceful-shutdown/) ã€‚
* ç¬¬ 48 è¡Œï¼šã€TODO 8033ã€‘ å‚æ•°å›è°ƒ
* ç¬¬ 49 è¡Œï¼šè°ƒç”¨**çˆ¶**

AbstractExporter/#unexport()
æ–¹æ³•ï¼Œå–æ¶ˆæœåŠ¡çš„æš´éœ²( Exporter )ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: @Override
2: public void destroy(){
3: // é”€æ¯åè®®å¯¹åº”çš„æœåŠ¡æ¶ˆè´¹è€…çš„æ‰€æœ‰ Invoker
4: for (Invoker<?> invoker : invokers) {
5: if (invoker != null) {
6: invokers.remove(invoker);
7: try {
8: if (logger.isInfoEnabled()) {
9: logger.info("Destroy reference: " + invoker.getUrl());
10: }
11: invoker.destroy();
12: } catch (Throwable t) {
13: logger.warn(t.getMessage(), t);
14: }
15: }
16: }
17: // é”€æ¯åè®®å¯¹åº”çš„æœåŠ¡æä¾›è€…çš„æ‰€æœ‰ Exporter
18: for (String key : new ArrayList<String>(exporterMap.keySet())) {
19: Exporter<?> exporter = exporterMap.remove(key);
20: if (exporter != null) {
21: try {
22: if (logger.isInfoEnabled()) {
23: logger.info("Unexport service: " + exporter.getInvoker().getUrl());
24: }
25: exporter.unexport();
26: } catch (Throwable t) {
27: logger.warn(t.getMessage(), t);
28: }
29: }
30: }
31: }
```

* ç¬¬ 3 è‡³ 16 è¡Œï¼š**å¾ªç¯**ï¼Œé”€æ¯**åè®®( æ­¤å¤„ä¸º DubboProtocol )å¯¹åº”**çš„æœåŠ¡*æ¶ˆè´¹è€…*çš„æ‰€æœ‰ Invoker**( æ­¤å¤„ä¸º DubboInvoker )** ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ2.2.3 DubboInvokerã€](http://svip.iocoder.cn/Dubbo/graceful-shutdown/) ã€‚
* ç¬¬ 17 è‡³ 30 è¡Œï¼š**å¾ªç¯**ï¼Œé”€æ¯**åè®®( æ­¤å¤„ä¸º DubboProtocol )å¯¹åº”**çš„æœåŠ¡*æä¾›è€…*çš„æ‰€æœ‰ Exporter**( æ­¤å¤„ä¸º DubboExporter )** ã€‚è¯¦ç»†è§£æï¼Œè§ [ã€Œ2.2.4 DubboExporterã€](http://svip.iocoder.cn/Dubbo/graceful-shutdown/) ã€‚

### 2.2.1 HeaderExchangeServer

/#close(timeout)
æ–¹æ³•ï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š

![close](http://static2.iocoder.cn/images/Dubbo/2019_06_01/01.png)

* **çº¢**æ¡†éƒ¨åˆ†ï¼šå› ä¸º ProtocolListenerWrapper å’Œ ProtocolFilterWrapper å’Œ **Protocol çš„ Dubbo SPI Wrapper å®ç°ç±»**ï¼Œæ‰€ä»¥è°ƒç”¨

DubboProtocol/#destroy()
æ–¹æ³•æ—¶ï¼Œä¼šå…ˆè°ƒç”¨å®ƒä»¬ã€‚ç›®å‰ä»…ä»…æ˜¯ä¸€å±‚åŒ…è£…ï¼Œæ²¡æœ‰é€»è¾‘ ğŸ˜ˆ ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
// ProtocolListenerWrapper.java
@Override
public void destroy(){
protocol.destroy();
}
// ProtocolFilterWrapper.java
@Override
public void destroy(){
protocol.destroy();
}
```

* **ç»¿**æ¡†éƒ¨åˆ†ï¼šHeaderExchangeServer çš„**ä¼˜é›…**å…³é—­æµç¨‹ï¼Œè¯¦ç»†è§£æè§ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” NIO æœåŠ¡å™¨ï¼ˆå››ï¼‰ä¹‹ Exchange å±‚ã€‹](http://svip.iocoder.cn/Dubbo/remoting-api-exchange/?self) çš„ [ã€Œ4.1.4 ä¼˜é›…å…³é—­ã€](http://svip.iocoder.cn/Dubbo/graceful-shutdown/) ã€‚
* **é»„**æ¡†éƒ¨åˆ†ï¼šNettyServer å…³é—­**çœŸæ­£** Netty ç›¸å…³**æœåŠ¡å™¨**ç»„ä»¶ï¼Œè¯¦ç»†è§£æè§ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” NIO æœåŠ¡å™¨ï¼ˆå…­ï¼‰ä¹‹ Netty4 å®ç°ã€‹](http://svip.iocoder.cn/Dubbo/remoting-impl-netty4//?self) çš„ [ã€Œå…³é—­æœåŠ¡å™¨ã€](http://svip.iocoder.cn/Dubbo/graceful-shutdown/) ã€‚
* ExecutorUtil æä¾›äº†ä¸¤ç§**å…³é—­**æ–¹æ³•ï¼Œåœ¨æœ¬æ–‡çš„ [ã€Œ3. ExecutorUtilã€](http://svip.iocoder.cn/Dubbo/graceful-shutdown/) è¯¦ç»†è§£æ ã€‚

### 2.2.2 HeaderExchangeClient

/#close(timeout)
æ–¹æ³•ï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š

![close](http://static2.iocoder.cn/images/Dubbo/2019_06_01/02.png)

* **çº¢**æ¡†éƒ¨åˆ†ï¼šHeaderExchangeClient çš„**ä¼˜é›…**å…³é—­æµç¨‹ï¼Œè¯¦ç»†è§£æè§ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” NIO æœåŠ¡å™¨ï¼ˆå››ï¼‰ä¹‹ Exchange å±‚ã€‹](http://svip.iocoder.cn/Dubbo/remoting-api-exchange/?self) çš„ [ã€Œ2.1.3 ä¼˜é›…å…³é—­ã€](http://svip.iocoder.cn/Dubbo/graceful-shutdown/)ã€‚
* **ç»¿**æ¡†éƒ¨åˆ†ï¼šNettyClient å…³é—­**çœŸæ­£** Netty ç›¸å…³**å®¢æˆ·ç«¯**ç»„ä»¶ï¼Œè¯¦ç»†è§£æè§ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” NIO æœåŠ¡å™¨ï¼ˆå…­ï¼‰ä¹‹ Netty4 å®ç°ã€‹](http://svip.iocoder.cn/Dubbo/remoting-impl-netty4//?self) çš„ [ã€Œå…³é—­é€šé“ã€](http://svip.iocoder.cn/Dubbo/graceful-shutdown/) ã€‚

### 2.2.3 DubboInvoker

/#destroy()
æ–¹æ³•ï¼Œé”€æ¯ ExchangeClient ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: @Override
2: public void destroy(){
3: // å¿½ç•¥ï¼Œè‹¥å·²ç»é”€æ¯
4: if (super.isDestroyed()) {
5: return;
6: } else {
7: // double check to avoid dup close
8: // åŒé‡é”æ ¡éªŒï¼Œé¿å…å·²ç»å…³é—­
9: destroyLock.lock();
10: try {
11: if (super.isDestroyed()) {
12: return;
13: }
14: // æ ‡è®°å…³é—­
15: super.destroy();
16: // ç§»é™¤å‡º `invokers`
17: if (invokers != null) {
18: invokers.remove(this);
19: }
20: // å…³é—­ ExchangeClient ä»¬
21: for (ExchangeClient client : clients) {
22: try {
23: client.close(ConfigUtils.getServerShutdownTimeout());
24: } catch (Throwable t) {
25: logger.warn(t.getMessage(), t);
26: }
27: }
28: } finally {
29: // é‡Šæ”¾é”
30: destroyLock.unlock();
31: }
32: }
33: }
```

* ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œèƒ–å‹çœ‹ä»£ç æ³¨é‡Šã€‚ä¸‹é¢åªæŒ‘é€‰å‡ ä¸ªæ–¹æ³•åˆ†äº«ã€‚
* **çˆ¶**

AbstractInvoker/#isDestroyed()
æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»é”€æ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* æ˜¯å¦é”€æ¯
/*/
private AtomicBoolean destroyed = new AtomicBoolean(false);
public boolean isDestroyed(){
return destroyed.get();
}
```
* **çˆ¶**

AbstractInvoker/#destroy()
æ–¹æ³•ï¼Œæ ‡è®°å·²ç»é”€æ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* æ˜¯å¦å¯ç”¨
/*/
private volatile boolean available = true;
@Override
public void destroy(){
if (!destroyed.compareAndSet(false, true)) {
return;
}
setAvailable(false);
}
protected void setAvailable(boolean available){
this.available = available;
}
```

* å¹¶ä¸”ï¼Œä¼šæ ‡è®° DubboInvoker å·²ç»**ä¸å¯ç”¨**ã€‚
* æ ‡è®°å·²ç»é”€æ¯åï¼Œå†è°ƒç”¨

/#invoke(Invocation)
æ–¹æ³•ï¼Œä¼šæŠ›å‡º RpcException å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
@Override
public Result invoke(Invocation inv) throws RpcException{
if (destroyed.get()) {
throw new RpcException("Rpc invoker for service " + this + " on consumer " + NetUtils.getLocalHost()
+ " use dubbo version " + Version.getVersion()
+ " is DESTROYED, can not be invoked any more!");
}
// ... çœç•¥å…¶ä»–ä»£ç 
}
```

* x
* ç¬¬ 20 è‡³ 27 è¡Œï¼š**å¾ªç¯**ï¼Œè°ƒç”¨

ReferenceCountExchangeClient/#close(timeout)
æ–¹æ³•ï¼Œå…³é—­å®¢æˆ·ç«¯ã€‚ğŸ˜ˆ å®é™…ä¸Šï¼Œåœ¨

DubboProtocol/#destroy()
æ–¹æ³•ä¸­ï¼Œå·²ç»å…³é—­å®¢æˆ·ç«¯ã€‚è™½ç„¶çœ‹èµ·æ¥é‡å¤ï¼Œå®é™…ä¸ç„¶ã€‚å› ä¸ºè¿œç¨‹æœåŠ¡æä¾›è€…å…³é—­æ—¶ï¼Œ DubboInvoker éœ€è¦è¿›è¡Œé”€æ¯ï¼Œæ­¤æ—¶å¿…é¡»å…³é—­å®¢æˆ·ç«¯çš„é“¾æ¥ã€‚æ‰€ä»¥ï¼ŒDubboInvoker å¿…é¡»æœ‰è¿™å—é€»è¾‘ã€‚

### 2.2.4 DubboExporter

/#unexport()
æ–¹æ³•ï¼Œå–æ¶ˆæš´éœ²ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* æœåŠ¡é”®
/*/
private final String key;
//*/*
/* Exporter é›†åˆ
/*
/* key: æœåŠ¡é”®
/*
/* è¯¥å€¼å®é™…å°±æ˜¯ {@link com.alibaba.dubbo.rpc.protocol.AbstractProtocol/#exporterMap}
/*/
private final Map<String, Exporter<?>> exporterMap;
@Override
public void unexport(){
// å–æ¶ˆæš´éœ²
super.unexport();
// ç§»é™¤è‡ªå·±
exporterMap.remove(key);
}
```

* è°ƒç”¨**çˆ¶**

AbstractExporter/#unexport()
æ–¹æ³•ï¼Œå–æ¶ˆæš´éœ²ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* Invoker å¯¹è±¡
/*/
private final Invoker<T> invoker;
//*/*
/* æ˜¯å¦å–æ¶ˆæš´éœ²æœåŠ¡
/*/
private volatile boolean unexported = false;
@Override
public void unexport(){
// æ ‡è®°å·²ç»å–æ¶ˆæš´éœ²
if (unexported) {
return;
}
unexported = true;
// é”€æ¯
getInvoker().destroy();
}
```

* å…¶ä¸­ï¼Œ

invoker
å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![invoker](http://static2.iocoder.cn/images/Dubbo/2019_06_01/03.png)

* è¿™ä¸ª Invoker é€šè¿‡ JavassistProxyFactory åˆ›å»ºï¼Œå®é™…å®ç°äº† AbstractProxyInvoker æŠ½è±¡ç±»ã€‚æ‰€ä»¥

/#destroy()
æ–¹æ³•å¦‚ä¸‹ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
@Override
public void destroy(){
}
```

* ğŸ˜ˆ ç©ºçš„ï¼Œå˜¿å˜¿å˜¿ã€‚

## 2.3 RegistryProtocol

/#destroy()
æ–¹æ³•ï¼Œå–æ¶ˆæ‰€æœ‰ Exporter çš„æš´éœ²ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* ç»‘å®šå…³ç³»é›†åˆã€‚
/*
/* keyï¼šæœåŠ¡ Dubbo URL
/*/
private final Map<String, ExporterChangeableWrapper<?>> bounds = new ConcurrentHashMap<String, ExporterChangeableWrapper<?>>();
@Override
public void destroy(){
// è·å¾— Exporter æ•°ç»„
List<Exporter<?>> exporters = new ArrayList<Exporter<?>>(bounds.values());
// å–æ¶ˆæ‰€æœ‰ Exporter çš„æš´éœ²
for (Exporter<?> exporter : exporters) {
exporter.unexport();
}
// æ¸…ç©º
bounds.clear();
}
```

* **å¾ªç¯**ï¼Œè°ƒç”¨

ExporterChangeableWrapper/#unexport()
æ–¹æ³•ï¼Œå–æ¶ˆæœåŠ¡**æš´éœ²**ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* æš´éœ²çš„ Exporter å¯¹è±¡
/*/
private Exporter<T> exporter;
@Override
public void unexport(){
String key = getCacheKey(this.originInvoker);
// ç§»é™¤å‡º `bounds`
bounds.remove(key);
// å–æ¶ˆæš´éœ²
exporter.unexport();
}
```

* å› ä¸ºæœåŠ¡æä¾›è€…**é›†æˆ**äº†é…ç½®è§„åˆ™ Configurator ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨åˆ° ExporterChangeableWrapper ï¼Œä¿å­˜åŸæœ‰ Invoker å¯¹è±¡ã€‚

* ä¹Ÿå› æ­¤ï¼Œä¸Šè¿°æ‰€æœ‰å–æ¶ˆæš´éœ²é€»è¾‘ï¼Œæ˜¯æ— æ³•é”€æ¯ ExporterChangeableWrapper åœ¨

bounds
çš„æ˜ å°„ï¼Œéœ€è¦é€šè¿‡ RegistryProtocol çš„

/#destroy()
æ–¹æ³•å®ç°ã€‚
* ä¹Ÿå› æ­¤ï¼Œæ­¤å¤„è°ƒç”¨**æš´éœ²çš„ Exporter å¯¹è±¡**

exporter
ï¼Œå·²ç»è¢«

AbstractExporter/#unexport()
æ–¹æ³•ï¼Œå–æ¶ˆæš´éœ²ã€‚ä½†æ˜¯å‘¢ï¼Œè¿™é‡Œåˆä¸èƒ½å»æ‰è¿™å—é€»è¾‘ï¼Œå› ä¸ºæ²¡å‡†æœ‰åœ°æ–¹ï¼Œéœ€è¦è°ƒç”¨

ExporterChangeableWrapper/#unexport()
æ–¹æ³•å‘¢ã€‚

# 3. ExecutorUtil

## 3.1 gracefulShutdown

/#gracefulShutdown(executor, timeout)
æ–¹æ³•ï¼Œ**ä¼˜é›…**å…³é—­ï¼Œç¦æ­¢æ–°çš„ä»»åŠ¡æäº¤ï¼Œå°†åŸæœ‰ä»»åŠ¡æ‰§è¡Œå®Œã€‚
```
public static void gracefulShutdown(Executor executor, int timeout){
// å¿½ç•¥ï¼Œè‹¥ä¸æ˜¯ ExecutorService ï¼Œæˆ–è€…å·²ç»å…³é—­
if (!(executor instanceof ExecutorService) || isShutdown(executor)) {
return;
}
// å…³é—­ï¼Œç¦æ­¢æ–°çš„ä»»åŠ¡æäº¤ï¼Œå°†åŸæœ‰ä»»åŠ¡æ‰§è¡Œå®Œ
final ExecutorService es = (ExecutorService) executor;
try {
es.shutdown(); // Disable new tasks from being submitted <1>
} catch (SecurityException ex2) {
return;
} catch (NullPointerException ex2) {
return;
}
// ç­‰å¾…åŸæœ‰ä»»åŠ¡æ‰§è¡Œå®Œã€‚è‹¥ç­‰å¾…è¶…æ—¶ï¼Œå¼ºåˆ¶ç»“æŸæ‰€æœ‰ä»»åŠ¡
try {
if (!es.awaitTermination(timeout, TimeUnit.MILLISECONDS)) {
es.shutdownNow();
}
} catch (InterruptedException ex) {
// å‘ç”Ÿ InterruptedException å¼‚å¸¸ï¼Œä¹Ÿå¼ºåˆ¶ç»“æŸæ‰€æœ‰ä»»åŠ¡
es.shutdownNow();
Thread.currentThread().interrupt();
}
// è‹¥æœªå…³é—­æˆåŠŸï¼Œæ–°å¼€çº¿ç¨‹å»å…³é—­
if (!isShutdown(es)) {
newThreadToCloseExecutor(es);
}
}
```

## 3.2 shutdownNow

/#shutdownNow(executor, timeout)
æ–¹æ³•ï¼Œ**å¼ºåˆ¶**å…³é—­ï¼ŒåŒ…æ‹¬**æ‰“æ–­**åŸæœ‰æ‰§è¡Œä¸­çš„ä»»åŠ¡ã€‚
```
public static void shutdownNow(Executor executor, final int timeout){
// å¿½ç•¥ï¼Œè‹¥ä¸æ˜¯ ExecutorService ï¼Œæˆ–è€…å·²ç»å…³é—­
if (!(executor instanceof ExecutorService) || isShutdown(executor)) {
return;
}
// ç«‹å³å…³é—­ï¼ŒåŒ…æ‹¬åŸæœ‰ä»»åŠ¡ä¹Ÿæ‰“æ–­
final ExecutorService es = (ExecutorService) executor;
try {
es.shutdownNow(); // <1>
} catch (SecurityException ex2) {
return;
} catch (NullPointerException ex2) {
return;
}
// ç­‰å¾…åŸæœ‰ä»»åŠ¡è¢«æ‰“æ–­å®Œæˆ
try {
es.awaitTermination(timeout, TimeUnit.MILLISECONDS);
} catch (InterruptedException ex) {
Thread.currentThread().interrupt();
}
// è‹¥æœªå…³é—­æˆåŠŸï¼Œæ–°å¼€çº¿ç¨‹å»å…³é—­
if (!isShutdown(es)) {
newThreadToCloseExecutor(es);
}
}
```

* å’Œ

/#gracefulShutdown(executor, timeout)
æ–¹æ³•ä¸åŒçš„æ˜¯ï¼Œ

<1>
å¤„è°ƒç”¨çš„æ˜¯

/#shutdownNow()
æ–¹æ³•ï¼Œè€Œ**ä¸æ˜¯**

/#shutdown()
æ–¹æ³•ã€‚

## 3.3 newThreadToCloseExecutor

/#newThreadToCloseExecutor(ExecutorService)
æ–¹æ³•ï¼Œ**æ–°å¼€**çº¿ç¨‹ï¼Œä¸æ–­å¼ºåˆ¶å…³é—­ã€‚
```
private static void newThreadToCloseExecutor(final ExecutorService es){
if (!isShutdown(es)) {
shutdownExecutor.execute(new Runnable() {
public void run(){
try {
// å¾ªç¯ 1000 æ¬¡ï¼Œä¸æ–­å¼ºåˆ¶ç»“æŸçº¿ç¨‹æ± 
for (int i = 0; i < 1000; i++) {
// ç«‹å³å…³é—­ï¼ŒåŒ…æ‹¬åŸæœ‰ä»»åŠ¡ä¹Ÿæ‰“æ–­
es.shutdownNow();
// ç­‰å¾…åŸæœ‰ä»»åŠ¡è¢«æ‰“æ–­å®Œæˆ
if (es.awaitTermination(10, TimeUnit.MILLISECONDS)) {
break;
}
}
} catch (InterruptedException ex) {
Thread.currentThread().interrupt();
} catch (Throwable e) {
logger.warn(e.getMessage(), e);
}
}
});
}
}
```

# 666. å½©è›‹

![çŸ¥è¯†æ˜Ÿçƒ](http://static2.iocoder.cn/images/Architecture/2017_12_29/01.png)

ç†è®ºæ¥è¯´ï¼ŒæœåŠ¡æä¾›è€…å¦‚æœè¦å…³é—­ï¼Œå¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š
provider => registry ï¼šç§»é™¤è‡ªå·±
provider => consumer ï¼šæˆ‘å‡†å¤‡å…³é—­äº†ï¼Œä¸è¦è°ƒç”¨æˆ‘
**æ‰€æœ‰** consumer => provider ï¼šå¥½çš„ï¼Œæˆ‘çŸ¥é“äº†
provider => consumer ï¼šå¤„ç†å®Œæ‰€æœ‰åŸæœ‰è¯·æ±‚
provider å…³é—­

ä½†æ˜¯å®é™…æƒ…å†µéå¸¸å¤æ‚ï¼Œå¦‚æœä¾èµ– consumer å»åº”ç­”å’Œç¡®è®¤ã€‚æ‰€ä»¥ Dubbo çš„é€‰æ‹©æ˜¯ï¼š

* provider ä» registry ï¼Œç§»é™¤è‡ªå·±ã€‚å¹¶ä¸” sleep ç­‰å¾…ä¸€å®šæ—¶é—´ï¼ˆå¼€å‘è€…å¯é…ï¼‰ï¼Œç­‰å¾… consumer è·å¾—åˆ°é€šçŸ¥ã€‚å½“ç„¶ï¼Œè¿™ä¸ªè¿‡ç¨‹**ä¸æ˜¯ç»å¯¹èƒ½å¤ŸæˆåŠŸ**çš„ã€‚ä¾‹å¦‚ï¼Œconsumer è¿æ¥ä¸ä¸Š registry ï¼Œä½†æ˜¯è¿çš„ä¸Š provider ã€‚
* provider é€šçŸ¥ consumer ï¼Œè‡ªå·±å‡†å¤‡å…³é—­ï¼Œä¸è¦è¯·æ±‚è‡ªå·±ã€‚å…¨éƒ¨é€šçŸ¥å®Œæˆåï¼Œç­‰å¤„ç†å®ŒåŸæœ‰è¯·æ±‚ã€‚å®Œæˆåï¼Œå…³é—­æœ¬åœ°æœåŠ¡å™¨åŠçº¿ç¨‹æ± ã€‚

å½“ç„¶ï¼Œconsumer ä¹Ÿæœ‰ä¼˜é›…å…³é—­ï¼Œç­‰å¾…æ‰€æœ‰å‘èµ·çš„è¯·æ±‚ç»“æŸã€‚ç›¸å¯¹ç®€å•çš„å¤šã€‚

æ¨èé˜…è¯»æ–‡ç« ï¼š

* [ã€ŠDubboæºä»£ç åˆ†æä¹ï¼šä¼˜é›…åœæœºã€‹](https://blog.csdn.net/manzhizhen/article/details/78756370)
* [ã€ŠDubbo ä¼˜é›…åœæœºã€‹](https://www.jianshu.com/p/aa22eac09d8c)
* [ã€Šè§£å†³dubboä¼˜é›…åœæœºã€‹](https://my.oschina.net/u/1398931/blog/790709)

* [Dubbo](http://svip.iocoder.cn/categories/Dubbo//)