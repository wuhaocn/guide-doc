<header class="article-header">
<h1 class="article-title">æ³¨å†Œä¸­å¿ƒ(ä¸‰)ä¹‹Redis</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>å‰ç½®é˜…è¯»æ–‡ç« ï¼š</p>
<ul>
<li><a href="http://svip.iocoder.cn/Dubbo/registry-api/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹</a></li>
<li><a href="http://svip.iocoder.cn/Dubbo/registry-zookeeper/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æ³¨å†Œä¸­å¿ƒï¼ˆäºŒï¼‰ä¹‹ Zookeeperã€‹</a></li>
</ul>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/registry/redis.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; Redis æ³¨å†Œä¸­å¿ƒã€‹</a>&nbsp;æ–‡æ¡£ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>åŸºäº Redis å®ç°çš„æ³¨å†Œä¸­å¿ƒã€‚</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_08_07/01.png" alt="æµç¨‹" /></p>
<p>ä½¿ç”¨ Redis çš„ Key/Map ç»“æ„å­˜å‚¨æ•°æ®ç»“æ„ï¼š</p>
<ul>
<li>ä¸» Key ä¸ºæœåŠ¡åå’Œç±»å‹</li>
<li>Map ä¸­çš„ Key ä¸º URL åœ°å€</li>
<li>Map ä¸­çš„ Value ä¸ºè¿‡æœŸæ—¶é—´ï¼Œç”¨äºåˆ¤æ–­è„æ•°æ®ï¼Œè„æ•°æ®ç”±ç›‘æ§ä¸­å¿ƒåˆ é™¤</li>
</ul>
</blockquote>
<ul>
<li><strong>æ¨ªå‘</strong>æ¥çœ‹ï¼Œå’ŒåŸºäº Zookeeper å®ç°çš„æ³¨å†Œä¸­å¿ƒï¼Œä¹Ÿæ˜¯åˆ†æˆ&nbsp;<strong>Root</strong>ã€<strong>Service</strong>ã€<strong>Type</strong>ã€<strong>URL</strong>&nbsp;å››å±‚ã€‚</li>
<li>ä½¿ç”¨&nbsp;<strong>Redis Map</strong>&nbsp;çš„æ•°æ®ç»“æ„ï¼Œèšåˆç›¸åŒæœåŠ¡å’Œç±»å‹( Root + Service + Type )ã€‚</li>
<li>ä¸ä½¿ç”¨ Redis çš„<strong>è‡ªåŠ¨è¿‡æœŸ</strong>æœºåˆ¶ï¼Œè€Œæ˜¯é€šè¿‡<strong>ç›‘æ§ä¸­å¿ƒ</strong>ï¼Œå®ç°è¿‡æœŸæœºåˆ¶ã€‚å› ä¸ºï¼ŒRedis Key è‡ªåŠ¨è¿‡æœŸæ—¶ï¼Œä¸å­˜åœ¨ç›¸åº”çš„äº‹ä»¶é€šçŸ¥ã€‚</li>
<li>æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…ï¼Œå®šæ—¶å»¶é•¿å…¶æ³¨å†Œçš„ URL åœ°å€çš„è¿‡æœŸæ—¶é—´ã€‚</li>
</ul>
<p>ä½¿ç”¨ Redis çš„&nbsp;<strong>Publish/Subscribe</strong>&nbsp;äº‹ä»¶é€šçŸ¥æ•°æ®å˜æ›´ï¼š</p>
<blockquote>
<ul>
<li>é€šè¿‡äº‹ä»¶çš„å€¼åŒºåˆ†äº‹ä»¶ç±»å‹ï¼š<code>register</code>,&nbsp;<code>unregister</code></li>
<li>æ™®é€šæ¶ˆè´¹è€…ç›´æ¥è®¢é˜…æŒ‡å®šæœåŠ¡æä¾›è€…çš„ Keyï¼Œåªä¼šæ”¶åˆ°<strong>æŒ‡å®šæœåŠ¡</strong>çš„å˜æ›´äº‹ä»¶</li>
<li>ç›‘æ§ä¸­å¿ƒé€šè¿‡ psubscribe åŠŸèƒ½è®¢é˜…&nbsp;<code>/dubbo/*</code>ï¼Œä¼šæ”¶åˆ°<strong>æ‰€æœ‰æœåŠ¡</strong>çš„æ‰€æœ‰å˜æ›´äº‹ä»¶</li>
</ul>
</blockquote>
<ul>
<li>æœåŠ¡å®ä¾‹çš„å¯åŠ¨æˆ–å…³é—­ï¼Œä¼šå†™å…¥æˆ–åˆ é™¤å¯¹åº”çš„ Redis Map ä¸­ï¼Œå¹¶å‘èµ·å¯¹åº”çš„&nbsp;<code>register</code>,&nbsp;<code>unregister</code>&nbsp;äº‹ä»¶ï¼Œä»è€Œä¿è¯<strong>å®æ—¶æ€§</strong>ã€‚</li>
<li>é€šè¿‡ç›‘æ§ä¸­å¿ƒï¼Œè½®è¯¢ Key è¿‡æœŸï¼Œä¿è¯<strong>æœªæ­£å¸¸å…³é—­</strong>çš„æœåŠ¡å®ä¾‹çš„ URL çš„åˆ é™¤ï¼Œå¹¶å‘èµ·å¯¹åº”çš„&nbsp;<code>unregister</code>&nbsp;äº‹ä»¶ï¼Œä»è€Œä¿è¯<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ã€‚</li>
</ul>
<p><strong>è°ƒç”¨è¿‡ç¨‹</strong>ï¼š</p>
<blockquote>
<p>ã€ä¸€ã€‘æœåŠ¡æä¾›æ–¹</p>
<ul>
<li>1ã€æœåŠ¡æä¾›æ–¹å¯åŠ¨æ—¶ï¼Œå‘&nbsp;<code>Key:/dubbo/com.foo.BarService/providers</code>&nbsp;ä¸‹ï¼Œæ·»åŠ å½“å‰æä¾›è€…çš„åœ°å€</li>
<li>2ã€å¹¶å‘&nbsp;<code>Channel:/dubbo/com.foo.BarService/providers</code>&nbsp;å‘é€&nbsp;<code>register</code>&nbsp;äº‹ä»¶</li>
</ul>
<p>ã€äºŒã€‘æœåŠ¡æ¶ˆè´¹æ–¹</p>
<ul>
<li>3ã€æœåŠ¡æ¶ˆè´¹æ–¹å¯åŠ¨æ—¶ï¼Œä»&nbsp;<code>Channel:/dubbo/com.foo.BarService/providers</code>&nbsp;è®¢é˜…&nbsp;<code>register</code>&nbsp;å’Œ&nbsp;<code>unregister</code>&nbsp;äº‹ä»¶</li>
<li>4ã€å¹¶å‘&nbsp;<code>Key:/dubbo/com.foo.BarService/providers</code>&nbsp;ä¸‹ï¼Œæ·»åŠ å½“å‰æ¶ˆè´¹è€…çš„åœ°å€<br />æœåŠ¡æ¶ˆè´¹æ–¹æ”¶åˆ°&nbsp;<code>register</code>&nbsp;å’Œ&nbsp;<code>unregister</code>&nbsp;äº‹ä»¶åï¼Œä»&nbsp;<code>Key:/dubbo/com.foo.BarService/providers</code>&nbsp;ä¸‹è·å–æä¾›è€…åœ°å€åˆ—è¡¨</li>
</ul>
<p>ã€ä¸‰ã€‘æœåŠ¡ç›‘æ§ä¸­å¿ƒ</p>
<ul>
<li>5ã€æœåŠ¡ç›‘æ§ä¸­å¿ƒå¯åŠ¨æ—¶ï¼Œä»&nbsp;<code>Channel:/dubbo/*</code>&nbsp;è®¢é˜…&nbsp;<code>register</code>&nbsp;å’Œ&nbsp;<code>unregister</code>ï¼Œä»¥åŠ&nbsp;<code>subscribe</code>&nbsp;å’Œ&nbsp;<code>unsubsribe</code>&nbsp;äº‹ä»¶</li>
<li>6ã€æœåŠ¡ç›‘æ§ä¸­å¿ƒæ”¶åˆ°&nbsp;<code>register</code>&nbsp;å’Œ&nbsp;<code>unregister</code>&nbsp;äº‹ä»¶åï¼Œä»&nbsp;<code>Key:/dubbo/com.foo.BarService/providers</code>&nbsp;ä¸‹è·å–æä¾›è€…åœ°å€åˆ—è¡¨</li>
<li>7ã€æœåŠ¡ç›‘æ§ä¸­å¿ƒæ”¶åˆ°&nbsp;<code>subscribe</code>&nbsp;å’Œ&nbsp;<code>unsubsribe</code>&nbsp;äº‹ä»¶åï¼Œä»&nbsp;<code>Key:/dubbo/com.foo.BarService/consumers</code>&nbsp;ä¸‹è·å–æ¶ˆè´¹è€…åœ°å€åˆ—è¡¨</li>
</ul>
</blockquote>
<p>æœ¬æ–‡æ¶‰åŠä»…æœ‰ RedisRegistry ä¸€ä¸ªç±»ï¼Œç±»å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_08_07/02.png" alt="ç±»å›¾" /></p>
<h1 id="2-RedisRegistry">2. RedisRegistry</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-registry/dubbo-registry-redis/src/main/java/com/alibaba/dubbo/registry/redis/RedisRegistry.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.registry.redis.RedisRegistry</code></a>&nbsp;ï¼Œå®ç° FailbackRegistry æŠ½è±¡ç±»ï¼ŒåŸºäº Redis å®ç°çš„æ³¨å†Œä¸­å¿ƒå®ç°ç±»ã€‚</p>
<h2 id="2-1-æ„é€ æ–¹æ³•">2.1 æ„é€ æ–¹æ³•</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">  <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">  2:  * é»˜è®¤ç«¯å£</span></span><br /><span class="line"><span class="comment">  3:  */</span></span><br /><span class="line">  <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_REDIS_PORT = <span class="number">6379</span>;</span><br /><span class="line">  <span class="number">5</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">  6:  * é»˜è®¤ Redis æ ¹èŠ‚ç‚¹</span></span><br /><span class="line"><span class="comment">  7:  */</span></span><br /><span class="line">  <span class="number">8</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String DEFAULT_ROOT = <span class="string">"dubbo"</span>;</span><br /><span class="line">  <span class="number">9</span>: </span><br /><span class="line"> <span class="number">10</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 11:  * Redis Key è¿‡æœŸæœºåˆ¶æ‰§è¡Œå™¨</span></span><br /><span class="line"><span class="comment"> 12:  */</span></span><br /><span class="line"> <span class="number">13</span>: <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService expireExecutor = Executors.newScheduledThreadPool(<span class="number">1</span>, <span class="keyword">new</span> NamedThreadFactory(<span class="string">"DubboRegistryExpireTimer"</span>, <span class="keyword">true</span>));</span><br /><span class="line"> <span class="number">14</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 15:  * Redis Key è¿‡æœŸæœºåˆ¶ Future</span></span><br /><span class="line"><span class="comment"> 16:  */</span></span><br /><span class="line"> <span class="number">17</span>: <span class="keyword">private</span> <span class="keyword">final</span> ScheduledFuture&lt;?&gt; expireFuture;</span><br /><span class="line"> <span class="number">18</span>: </span><br /><span class="line"> <span class="number">19</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 20:  * Redis æ ¹èŠ‚ç‚¹</span></span><br /><span class="line"><span class="comment"> 21:  */</span></span><br /><span class="line"> <span class="number">22</span>: <span class="keyword">private</span> <span class="keyword">final</span> String root;</span><br /><span class="line"> <span class="number">23</span>: </span><br /><span class="line"> <span class="number">24</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 25:  * JedisPool é›†åˆ</span></span><br /><span class="line"><span class="comment"> 26:  *</span></span><br /><span class="line"><span class="comment"> 27:  * keyï¼šip:port</span></span><br /><span class="line"><span class="comment"> 28:  */</span></span><br /><span class="line"> <span class="number">29</span>: <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, JedisPool&gt; jedisPools = <span class="keyword">new</span> ConcurrentHashMap&lt;String, JedisPool&gt;();</span><br /><span class="line"> <span class="number">30</span>: </span><br /><span class="line"> <span class="number">31</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 32:  * é€šçŸ¥å™¨é›†åˆ</span></span><br /><span class="line"><span class="comment"> 33:  *</span></span><br /><span class="line"><span class="comment"> 34:  * keyï¼šRoot + Service ï¼Œä¾‹å¦‚ `/dubbo/com.alibaba.dubbo.demo.DemoService`</span></span><br /><span class="line"><span class="comment"> 35:  */</span></span><br /><span class="line"> <span class="number">36</span>: <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, Notifier&gt; notifiers = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Notifier&gt;();</span><br /><span class="line"> <span class="number">37</span>: </span><br /><span class="line"> <span class="number">38</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 39:  * é‡è¿å‘¨æœŸï¼Œå•ä½ï¼šæ¯«ç§’</span></span><br /><span class="line"><span class="comment"> 40:  */</span></span><br /><span class="line"> <span class="number">41</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> reconnectPeriod;</span><br /><span class="line"> <span class="number">42</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 43:  * è¿‡æœŸå‘¨æœŸï¼Œå•ä½ï¼šæ¯«ç§’</span></span><br /><span class="line"><span class="comment"> 44:  */</span></span><br /><span class="line"> <span class="number">45</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> expirePeriod;</span><br /><span class="line"> <span class="number">46</span>: </span><br /><span class="line"> <span class="number">47</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 48:  * æ˜¯å¦ç›‘æ§ä¸­å¿ƒ</span></span><br /><span class="line"><span class="comment"> 49:  *</span></span><br /><span class="line"><span class="comment"> 50:  * ç”¨äºåˆ¤æ–­è„æ•°æ®ï¼Œè„æ•°æ®ç”±ç›‘æ§ä¸­å¿ƒåˆ é™¤ {<span class="doctag">@link</span> #clean(Jedis)}</span></span><br /><span class="line"><span class="comment"> 51:  */</span></span><br /><span class="line"> <span class="number">52</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> admin = <span class="keyword">false</span>;</span><br /><span class="line"> <span class="number">53</span>: </span><br /><span class="line"> <span class="number">54</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 55:  * æ˜¯å¦å¤åˆ¶æ¨¡å¼</span></span><br /><span class="line"><span class="comment"> 56:  */</span></span><br /><span class="line"> <span class="number">57</span>: <span class="keyword">private</span> <span class="keyword">boolean</span> replicate;</span><br /><span class="line"> <span class="number">58</span>: </span><br /><span class="line"> <span class="number">59</span>: <span class="function"><span class="keyword">public</span> <span class="title">RedisRegistry</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line"> <span class="number">60</span>:     <span class="keyword">super</span>(url);</span><br /><span class="line"> <span class="number">61</span>:     <span class="keyword">if</span> (url.isAnyHost()) {</span><br /><span class="line"> <span class="number">62</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"registry address == null"</span>);</span><br /><span class="line"> <span class="number">63</span>:     }</span><br /><span class="line"> <span class="number">64</span>:     <span class="comment">// åˆ›å»º GenericObjectPoolConfig å¯¹è±¡</span></span><br /><span class="line"> <span class="number">65</span>:     GenericObjectPoolConfig config = <span class="keyword">new</span> GenericObjectPoolConfig();</span><br /><span class="line"> <span class="number">66</span>:     config.setTestOnBorrow(url.getParameter(<span class="string">"test.on.borrow"</span>, <span class="keyword">true</span>));</span><br /><span class="line"> <span class="number">67</span>:     config.setTestOnReturn(url.getParameter(<span class="string">"test.on.return"</span>, <span class="keyword">false</span>));</span><br /><span class="line"> <span class="number">68</span>:     config.setTestWhileIdle(url.getParameter(<span class="string">"test.while.idle"</span>, <span class="keyword">false</span>));</span><br /><span class="line"> <span class="number">69</span>:     <span class="keyword">if</span> (url.getParameter(<span class="string">"max.idle"</span>, <span class="number">0</span>) &gt; <span class="number">0</span>)</span><br /><span class="line"> <span class="number">70</span>:         config.setMaxIdle(url.getParameter(<span class="string">"max.idle"</span>, <span class="number">0</span>));</span><br /><span class="line"> <span class="number">71</span>:     <span class="keyword">if</span> (url.getParameter(<span class="string">"min.idle"</span>, <span class="number">0</span>) &gt; <span class="number">0</span>)</span><br /><span class="line"> <span class="number">72</span>:         config.setMinIdle(url.getParameter(<span class="string">"min.idle"</span>, <span class="number">0</span>));</span><br /><span class="line"> <span class="number">73</span>:     <span class="keyword">if</span> (url.getParameter(<span class="string">"max.active"</span>, <span class="number">0</span>) &gt; <span class="number">0</span>)</span><br /><span class="line"> <span class="number">74</span>:         config.setMaxTotal(url.getParameter(<span class="string">"max.active"</span>, <span class="number">0</span>));</span><br /><span class="line"> <span class="number">75</span>:     <span class="keyword">if</span> (url.getParameter(<span class="string">"max.total"</span>, <span class="number">0</span>) &gt; <span class="number">0</span>)</span><br /><span class="line"> <span class="number">76</span>:         config.setMaxTotal(url.getParameter(<span class="string">"max.total"</span>, <span class="number">0</span>));</span><br /><span class="line"> <span class="number">77</span>:     <span class="keyword">if</span> (url.getParameter(<span class="string">"max.wait"</span>, url.getParameter(<span class="string">"timeout"</span>, <span class="number">0</span>)) &gt; <span class="number">0</span>)</span><br /><span class="line"> <span class="number">78</span>:         config.setMaxWaitMillis(url.getParameter(<span class="string">"max.wait"</span>, url.getParameter(<span class="string">"timeout"</span>, <span class="number">0</span>)));</span><br /><span class="line"> <span class="number">79</span>:     <span class="keyword">if</span> (url.getParameter(<span class="string">"num.tests.per.eviction.run"</span>, <span class="number">0</span>) &gt; <span class="number">0</span>)</span><br /><span class="line"> <span class="number">80</span>:         config.setNumTestsPerEvictionRun(url.getParameter(<span class="string">"num.tests.per.eviction.run"</span>, <span class="number">0</span>));</span><br /><span class="line"> <span class="number">81</span>:     <span class="keyword">if</span> (url.getParameter(<span class="string">"time.between.eviction.runs.millis"</span>, <span class="number">0</span>) &gt; <span class="number">0</span>)</span><br /><span class="line"> <span class="number">82</span>:         config.setTimeBetweenEvictionRunsMillis(url.getParameter(<span class="string">"time.between.eviction.runs.millis"</span>, <span class="number">0</span>));</span><br /><span class="line"> <span class="number">83</span>:     <span class="keyword">if</span> (url.getParameter(<span class="string">"min.evictable.idle.time.millis"</span>, <span class="number">0</span>) &gt; <span class="number">0</span>)</span><br /><span class="line"> <span class="number">84</span>:         config.setMinEvictableIdleTimeMillis(url.getParameter(<span class="string">"min.evictable.idle.time.millis"</span>, <span class="number">0</span>));</span><br /><span class="line"> <span class="number">85</span>: </span><br /><span class="line"> <span class="number">86</span>:     <span class="comment">// æ˜¯å¦å¤åˆ¶æ¨¡å¼</span></span><br /><span class="line"> <span class="number">87</span>:     String cluster = url.getParameter(<span class="string">"cluster"</span>, <span class="string">"failover"</span>);</span><br /><span class="line"> <span class="number">88</span>:     <span class="keyword">if</span> (!<span class="string">"failover"</span>.equals(cluster) &amp;&amp; !<span class="string">"replicate"</span>.equals(cluster)) {</span><br /><span class="line"> <span class="number">89</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unsupported redis cluster: "</span> + cluster + <span class="string">". The redis cluster only supported failover or replicate."</span>);</span><br /><span class="line"> <span class="number">90</span>:     }</span><br /><span class="line"> <span class="number">91</span>:     replicate = <span class="string">"replicate"</span>.equals(cluster);</span><br /><span class="line"> <span class="number">92</span>: </span><br /><span class="line"> <span class="number">93</span>:     <span class="comment">// è§£æ</span></span><br /><span class="line"> <span class="number">94</span>:     List&lt;String&gt; addresses = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br /><span class="line"> <span class="number">95</span>:     addresses.add(url.getAddress());</span><br /><span class="line"> <span class="number">96</span>:     String[] backups = url.getParameter(Constants.BACKUP_KEY, <span class="keyword">new</span> String[<span class="number">0</span>]);</span><br /><span class="line"> <span class="number">97</span>:     <span class="keyword">if</span> (backups != <span class="keyword">null</span> &amp;&amp; backups.length &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">98</span>:         addresses.addAll(Arrays.asList(backups));</span><br /><span class="line"> <span class="number">99</span>:     }</span><br /><span class="line"><span class="number">100</span>: </span><br /><span class="line"><span class="number">101</span>:     <span class="comment">// åˆ›å»º JedisPool å¯¹è±¡</span></span><br /><span class="line"><span class="number">102</span>:     String password = url.getPassword();</span><br /><span class="line"><span class="number">103</span>:     <span class="keyword">for</span> (String address : addresses) {</span><br /><span class="line"><span class="number">104</span>:         <span class="keyword">int</span> i = address.indexOf(<span class="string">':'</span>);</span><br /><span class="line"><span class="number">105</span>:         String host;</span><br /><span class="line"><span class="number">106</span>:         <span class="keyword">int</span> port;</span><br /><span class="line"><span class="number">107</span>:         <span class="keyword">if</span> (i &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">108</span>:             host = address.substring(<span class="number">0</span>, i);</span><br /><span class="line"><span class="number">109</span>:             port = Integer.parseInt(address.substring(i + <span class="number">1</span>));</span><br /><span class="line"><span class="number">110</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">111</span>:             host = address;</span><br /><span class="line"><span class="number">112</span>:             port = DEFAULT_REDIS_PORT;</span><br /><span class="line"><span class="number">113</span>:         }</span><br /><span class="line"><span class="number">114</span>:         <span class="keyword">if</span> (StringUtils.isEmpty(password)) { <span class="comment">// æ— å¯†ç è¿æ¥</span></span><br /><span class="line"><span class="number">115</span>:             <span class="keyword">this</span>.jedisPools.put(address, <span class="keyword">new</span> JedisPool(config, host, port,</span><br /><span class="line"><span class="number">116</span>:                     url.getParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT)));</span><br /><span class="line"><span class="number">117</span>:         } <span class="keyword">else</span> { <span class="comment">// æœ‰å¯†ç è¿æ¥</span></span><br /><span class="line"><span class="number">118</span>:             <span class="keyword">this</span>.jedisPools.put(address, <span class="keyword">new</span> JedisPool(config, host, port,</span><br /><span class="line"><span class="number">119</span>:                     url.getParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT), password));</span><br /><span class="line"><span class="number">120</span>:         }</span><br /><span class="line"><span class="number">121</span>:     }</span><br /><span class="line"><span class="number">122</span>: </span><br /><span class="line"><span class="number">123</span>:     <span class="comment">// è§£æé‡è¿å‘¨æœŸ</span></span><br /><span class="line"><span class="number">124</span>:     <span class="keyword">this</span>.reconnectPeriod = url.getParameter(Constants.REGISTRY_RECONNECT_PERIOD_KEY, Constants.DEFAULT_REGISTRY_RECONNECT_PERIOD);</span><br /><span class="line"><span class="number">125</span>: </span><br /><span class="line"><span class="number">126</span>:     <span class="comment">// è·å¾— Redis æ ¹èŠ‚ç‚¹</span></span><br /><span class="line"><span class="number">127</span>:     String group = url.getParameter(Constants.GROUP_KEY, DEFAULT_ROOT);</span><br /><span class="line"><span class="number">128</span>:     <span class="keyword">if</span> (!group.startsWith(Constants.PATH_SEPARATOR)) { <span class="comment">// å¤´ `/`</span></span><br /><span class="line"><span class="number">129</span>:         group = Constants.PATH_SEPARATOR + group;</span><br /><span class="line"><span class="number">130</span>:     }</span><br /><span class="line"><span class="number">131</span>:     <span class="keyword">if</span> (!group.endsWith(Constants.PATH_SEPARATOR)) { <span class="comment">// å°¾ `/`</span></span><br /><span class="line"><span class="number">132</span>:         group = group + Constants.PATH_SEPARATOR;</span><br /><span class="line"><span class="number">133</span>:     }</span><br /><span class="line"><span class="number">134</span>:     <span class="keyword">this</span>.root = group;</span><br /><span class="line"><span class="number">135</span>: </span><br /><span class="line"><span class="number">136</span>:     <span class="comment">// åˆ›å»ºå®ç° Redis Key è¿‡æœŸæœºåˆ¶çš„ä»»åŠ¡</span></span><br /><span class="line"><span class="number">137</span>:     <span class="keyword">this</span>.expirePeriod = url.getParameter(Constants.SESSION_TIMEOUT_KEY, Constants.DEFAULT_SESSION_TIMEOUT);</span><br /><span class="line"><span class="number">138</span>:     <span class="keyword">this</span>.expireFuture = expireExecutor.scheduleWithFixedDelay(<span class="keyword">new</span> Runnable() {</span><br /><span class="line"><span class="number">139</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">140</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">141</span>:                 deferExpired(); <span class="comment">// Extend the expiration time</span></span><br /><span class="line"><span class="number">142</span>:             } <span class="keyword">catch</span> (Throwable t) { <span class="comment">// Defensive fault tolerance</span></span><br /><span class="line"><span class="number">143</span>:                 logger.error(<span class="string">"Unexpected exception occur at defer expire time, cause: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">144</span>:             }</span><br /><span class="line"><span class="number">145</span>:         }</span><br /><span class="line"><span class="number">146</span>:     }, expirePeriod / <span class="number">2</span>, expirePeriod / <span class="number">2</span>, TimeUnit.MILLISECONDS);</span><br /><span class="line"><span class="number">147</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>jedisPools</code>&nbsp;å±æ€§ï¼ŒJedisPool é›†åˆï¼Œå…¶ä¸­é”®ä¸º&nbsp;<code>ip:port</code>&nbsp;ã€‚åœ¨ã€ç¬¬ 64 è‡³ 84 è¡Œã€‘å’Œã€ç¬¬ 93 è‡³ 99 è¡Œã€‘å’Œã€101 è‡³ 121 è¡Œã€‘åˆå§‹åŒ–ã€‚</p>
<ul>
<li><code>root</code>&nbsp;å±æ€§ï¼ŒRedis æ ¹èŠ‚ç‚¹ï¼Œå³é¦–å›¾çš„&nbsp;<strong>Root</strong>&nbsp;å±‚ã€‚åœ¨ã€ç¬¬ 126 è‡³ 134 è¡Œã€‘åˆå§‹åŒ–ã€‚</li>
<li>
<p><code>replicate</code>&nbsp;å±æ€§ï¼Œæ˜¯å¦å¤åˆ¶æ¨¡å¼ã€‚åœ¨ã€ç¬¬ 86 è‡³ 90 è¡Œã€‘æ–‡æ¡£è¯´æ˜å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å¯é€šè¿‡&nbsp;<code>&lt;dubbo:registry cluster="replicate" /&gt;</code>&nbsp;è®¾ç½® redis é›†ç¾¤ç­–ç•¥ï¼Œç¼ºçœä¸º&nbsp;<code>failover</code>ï¼š</p>
<ul>
<li><code>failover</code>: åªå†™å…¥å’Œè¯»å–ä»»æ„ä¸€å°ï¼Œå¤±è´¥æ—¶é‡è¯•å¦ä¸€å°ï¼Œéœ€è¦æœåŠ¡å™¨ç«¯è‡ªè¡Œé…ç½®æ•°æ®åŒæ­¥ã€‚</li>
<li><code>replicate</code>: åœ¨å®¢æˆ·ç«¯åŒæ—¶å†™å…¥æ‰€æœ‰æœåŠ¡å™¨ï¼Œåªè¯»å–å•å°ï¼ŒæœåŠ¡å™¨ç«¯ä¸éœ€è¦åŒæ­¥ï¼Œæ³¨å†Œä¸­å¿ƒé›†ç¾¤å¢å¤§ï¼Œæ€§èƒ½å‹åŠ›ä¹Ÿä¼šæ›´å¤§ã€‚</li>
</ul>
</blockquote>
</li>
</ul>
</li>
<li>
<p><code>notifiers</code>&nbsp;å±æ€§ï¼Œé€šçŸ¥å™¨é›†åˆï¼Œå…¶ä¸­é”®ä¸º Root + Service ã€‚Notifier ï¼Œç”¨äº Redis Publish/Subscribe æœºåˆ¶ä¸­çš„è®¢é˜…ï¼Œå®æ—¶ç›‘å¬æ•°æ®çš„å˜åŒ–ã€‚</p>
<ul>
<li><code>reconnectPeriod</code>&nbsp;å±æ€§ï¼Œé‡è¿å‘¨æœŸï¼Œå•ä½ï¼šæ¯«ç§’ã€‚åœ¨ã€ç¬¬ 91 è¡Œã€‘åˆå§‹åŒ–ã€‚ç”¨äºè®¢é˜…å‘ç”Ÿ Redis è¿æ¥å¼‚å¸¸æ—¶ï¼ŒNotifier&nbsp;<strong>sleep</strong>&nbsp;ï¼Œç­‰å¾…é‡è¿ä¸Šã€‚</li>
</ul>
</li>
<li><code>expireExecutor</code>&nbsp;å±æ€§ï¼ŒRedis Key è¿‡æœŸæœºåˆ¶æ‰§è¡Œå™¨ã€‚
<ul>
<li><code>expirePeriod</code>&nbsp;å±æ€§ï¼ŒRedis Key è¿‡æœŸå‘¨æœŸï¼Œå•ä½ï¼šæ¯«ç§’ã€‚åœ¨ã€ç¬¬ 137 è¡Œã€‘åˆå§‹åŒ–ã€‚</li>
<li><code>expireFuture</code>&nbsp;å±æ€§ï¼ŒRedis Key è¿‡æœŸæœºåˆ¶ä»»åŠ¡çš„ Future ã€‚åœ¨ã€ç¬¬ 138 è‡³ 146 è¡Œã€‘åˆå§‹åŒ–ã€‚
<ul>
<li>è¯¥ä»»åŠ¡ä¸»è¦æœ‰ä¸¤ä¸ªé€»è¾‘ï¼š1ï¼‰å»¶é•¿æœªè¿‡æœŸçš„ Key ï¼›2ï¼‰åˆ é™¤è¿‡æœŸçš„ Key ã€‚</li>
<li>ä»»åŠ¡é—´éš”ä¸º&nbsp;<code>expirePeriod</code>&nbsp;çš„<strong>ä¸€åŠ</strong>ï¼Œé¿å…è¿‡äºé¢‘ç¹ï¼Œå¯¹ Redis çš„å‹åŠ›è¿‡å¤§ï¼›åŒæ—¶ï¼Œé¿å…è¿‡äºä¸é¢‘ç¹ï¼Œæ¯æ¬¡æ‰§è¡Œæ—¶ï¼Œéƒ½è¿‡æœŸäº†ã€‚</li>
</ul>
</li>
<li><code>admin</code>&nbsp;å±æ€§ï¼Œæ˜¯å¦ç›‘æ§ä¸­å¿ƒï¼Œåœ¨&nbsp;<code>#clean(Jedis)</code>&nbsp;æ–¹æ³•ï¼Œçœ‹åˆ°å…·ä½“çš„ä½¿ç”¨ã€‚</li>
</ul>
</li>
</ul>
<h2 id="2-2-doRegister">2.2 doRegister</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doRegister</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     String key = toCategoryPath(url);</span><br /><span class="line"> <span class="number">4</span>:     String value = url.toFullString();</span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// è®¡ç®—è¿‡æœŸæ—¶é—´</span></span><br /><span class="line"> <span class="number">6</span>:     String expire = String.valueOf(System.currentTimeMillis() + expirePeriod);</span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br /><span class="line"> <span class="number">8</span>:     RpcException exception = <span class="keyword">null</span>;</span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// å‘ Redis æ³¨å†Œ</span></span><br /><span class="line"><span class="number">10</span>:     <span class="keyword">for</span> (Map.Entry&lt;String, JedisPool&gt; entry : jedisPools.entrySet()) {</span><br /><span class="line"><span class="number">11</span>:         JedisPool jedisPool = entry.getValue();</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">13</span>:             Jedis jedis = jedisPool.getResource();</span><br /><span class="line"><span class="number">14</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">15</span>:                 <span class="comment">// å†™å…¥ Redis Map é”®</span></span><br /><span class="line"><span class="number">16</span>:                 jedis.hset(key, value, expire);</span><br /><span class="line"><span class="number">17</span>:                 <span class="comment">// å‘å¸ƒ Redis æ³¨å†Œäº‹ä»¶</span></span><br /><span class="line"><span class="number">18</span>:                 jedis.publish(key, Constants.REGISTER);</span><br /><span class="line"><span class="number">19</span>:                 success = <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">20</span>:                 <span class="comment">// &nbsp;å¦‚æœæœåŠ¡å™¨ç«¯å·²åŒæ­¥æ•°æ®ï¼Œåªéœ€å†™å…¥å•å°æœºå™¨</span></span><br /><span class="line"><span class="number">21</span>:                 <span class="keyword">if</span> (!replicate) {</span><br /><span class="line"><span class="number">22</span>:                     <span class="keyword">break</span>; <span class="comment">// &nbsp;If the server side has synchronized data, just write a single machine</span></span><br /><span class="line"><span class="number">23</span>:                 }</span><br /><span class="line"><span class="number">24</span>:             } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">25</span>:                 jedisPool.returnResource(jedis);</span><br /><span class="line"><span class="number">26</span>:             }</span><br /><span class="line"><span class="number">27</span>:         } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">28</span>:             exception = <span class="keyword">new</span> RpcException(<span class="string">"Failed to register service to redis registry. registry: "</span> + entry.getKey() + <span class="string">", service: "</span> + url + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">29</span>:         }</span><br /><span class="line"><span class="number">30</span>:     }</span><br /><span class="line"><span class="number">31</span>:     <span class="comment">// å¤„ç†å¼‚å¸¸</span></span><br /><span class="line"><span class="number">32</span>:     <span class="keyword">if</span> (exception != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">33</span>:         <span class="keyword">if</span> (success) { <span class="comment">// è™½ç„¶å‘ç”Ÿå¼‚å¸¸ï¼Œä½†æ˜¯ç»“æœæˆåŠŸ</span></span><br /><span class="line"><span class="number">34</span>:             logger.warn(exception.getMessage(), exception);</span><br /><span class="line"><span class="number">35</span>:         } <span class="keyword">else</span> { <span class="comment">// æœ€ç»ˆæœªæˆåŠŸ</span></span><br /><span class="line"><span class="number">36</span>:             <span class="keyword">throw</span> exception;</span><br /><span class="line"><span class="number">37</span>:         }</span><br /><span class="line"><span class="number">38</span>:     }</span><br /><span class="line"><span class="number">39</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šè°ƒç”¨&nbsp;<code>#toCategoryPath(url)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—<strong>åˆ†ç±»è·¯å¾„</strong>ä½œä¸º Key ã€‚</li>
<li>ç¬¬ 4 è¡Œï¼šè°ƒç”¨&nbsp;<code>URL#toFullString()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—&nbsp;<strong>URL å­—ç¬¦ä¸²</strong>ä½œä¸º Value ã€‚</li>
<li>ç¬¬ 6 è¡Œï¼šè®¡ç®—è¿‡æœŸæ—¶é—´ï¼Œå½“å‰æ—¶é—´ +&nbsp;<code>expirePeriod</code>&nbsp;ã€‚</li>
<li>ç¬¬ 9 è‡³ 30 è¡Œï¼šå‘ Redis æ³¨å†Œã€‚
<ul>
<li>ç¬¬ 16 è¡Œï¼šè°ƒç”¨&nbsp;<code>Jedis#hset(key, value, expire)</code>&nbsp;æ–¹æ³•ï¼Œå†™å…¥ Redis Map ä¸­ã€‚<strong>æ³¨æ„ï¼Œè¿‡æœŸæ—¶é—´ï¼Œä½œä¸º Map çš„å€¼</strong>ã€‚</li>
<li>ç¬¬ 18 è¡Œï¼šè°ƒç”¨&nbsp;<code>Jedis#publish(channel, message)</code>&nbsp;æ–¹æ³•ï¼Œå‘å¸ƒ&nbsp;<code>register</code>&nbsp;äº‹ä»¶ã€‚è¿™æ ·è®¢é˜…è¯¥ Key çš„æœåŠ¡æ¶ˆè´¹è€…å’Œç›‘æ§ä¸­å¿ƒï¼Œå°±ä¼šå®æ—¶ä» Redis è¯»å–<strong>è¯¥æœåŠ¡</strong>çš„æœ€æ–°æ•°æ®ã€‚</li>
<li>ç¬¬ 21 è‡³ 23 è¡Œï¼šå¦‚æœé&nbsp;<code>replicate</code>&nbsp;ï¼Œæ„å‘³ç€ Redis æœåŠ¡å™¨ç«¯å·²åŒæ­¥æ•°æ®ï¼Œåªéœ€å†™å…¥å•å°æœºå™¨ã€‚å› æ­¤ï¼Œç»“æŸå¾ªç¯ã€‚å¦åˆ™ï¼Œæ»¡è¶³&nbsp;<code>replicate</code>&nbsp;ï¼Œå‘æ‰€æœ‰ Redis å†™å…¥ã€‚</li>
</ul>
</li>
<li>ç¬¬ 31 è‡³ 38 è¡Œï¼šå¤„ç†å¼‚å¸¸ã€‚è¿™å—ä»£ç èƒ–å‹è‡ªå·±çœ‹ä¸‹ï¼Œæ³¨æ„ä¸‹&nbsp;<code>exception</code>&nbsp;å’Œ&nbsp;<code>success</code>&nbsp;èµ‹å€¼çš„åœ°æ–¹ã€‚è¿™å—çš„æ‰“å°å‘Šè­¦æ—¥å¿—çš„å¤„ç†æ–¹å¼ï¼Œä¹Ÿé€‚ç”¨äºå¤šæ¬¡é‡è¯•æŸä¸ªæ“ä½œï¼Œç»“æœå‘ç”Ÿå¼‚å¸¸ï¼Œä½†æ˜¯æœ€ç»ˆæˆåŠŸã€‚ä¾‹å¦‚ï¼ŒHTTP è¯·æ±‚è¿œç¨‹æœåŠ¡ã€‚</li>
</ul>
<h3 id="2-1-1-toCategoryPath">2.1.1 toCategoryPath</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·å¾—åˆ†ç±»è·¯å¾„</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Root + Service + Type</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> url URL</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> åˆ†ç±»è·¯å¾„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toCategoryPath</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> toServicePath(url) + Constants.PATH_SEPARATOR + url.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="2-3-doUnregister">2.3 doUnregister</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doUnregister</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    String key = toCategoryPath(url);</span><br /><span class="line">    String value = url.toFullString();</span><br /><span class="line">    RpcException exception = <span class="keyword">null</span>;</span><br /><span class="line">    <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br /><span class="line">    <span class="comment">// å‘ Redis æ³¨å†Œ</span></span><br /><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, JedisPool&gt; entry : jedisPools.entrySet()) {</span><br /><span class="line">        JedisPool jedisPool = entry.getValue();</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            Jedis jedis = jedisPool.getResource();</span><br /><span class="line">            <span class="keyword">try</span> {</span><br /><span class="line">                <span class="comment">// åˆ é™¤ Redis Map é”®</span></span><br /><span class="line">                jedis.hdel(key, value);</span><br /><span class="line">                <span class="comment">// å‘å¸ƒ Redis å–æ¶ˆæ³¨å†Œäº‹ä»¶</span></span><br /><span class="line">                jedis.publish(key, Constants.UNREGISTER);</span><br /><span class="line">                success = <span class="keyword">true</span>;</span><br /><span class="line">                <span class="comment">// &nbsp;å¦‚æœæœåŠ¡å™¨ç«¯å·²åŒæ­¥æ•°æ®ï¼Œåªéœ€å†™å…¥å•å°æœºå™¨</span></span><br /><span class="line">                <span class="keyword">if</span> (!replicate) {</span><br /><span class="line">                    <span class="keyword">break</span>; <span class="comment">// &nbsp;If the server side has synchronized data, just write a single machine</span></span><br /><span class="line">                }</span><br /><span class="line">            } <span class="keyword">finally</span> {</span><br /><span class="line">                jedisPool.returnResource(jedis);</span><br /><span class="line">            }</span><br /><span class="line">        } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">            exception = <span class="keyword">new</span> RpcException(<span class="string">"Failed to unregister service to redis registry. registry: "</span> + entry.getKey() + <span class="string">", service: "</span> + url + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// å¤„ç†å¼‚å¸¸</span></span><br /><span class="line">    <span class="keyword">if</span> (exception != <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">if</span> (success) { <span class="comment">// è™½ç„¶å‘ç”Ÿå¼‚å¸¸ï¼Œä½†æ˜¯ç»“æœæˆåŠŸ</span></span><br /><span class="line">            logger.warn(exception.getMessage(), exception);</span><br /><span class="line">        } <span class="keyword">else</span> { <span class="comment">// æœ€ç»ˆæœªæˆåŠŸ</span></span><br /><span class="line">            <span class="keyword">throw</span> exception;</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å½“æœåŠ¡æ¶ˆè´¹è€…æˆ–æœåŠ¡æä¾›è€…ï¼Œå…³é—­æ—¶ï¼Œä¼šè°ƒç”¨&nbsp;<code>#doUnregister(url)</code>&nbsp;æ–¹æ³•ï¼Œå–æ¶ˆæ³¨å†Œã€‚åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¼šåˆ é™¤å¯¹åº” Map ä¸­çš„<strong>é”®</strong>&nbsp;+ å‘å¸ƒ&nbsp;<code>unregister</code>&nbsp;äº‹ä»¶ï¼Œä»è€Œ<strong>å®æ—¶</strong>é€šçŸ¥è®¢é˜…è€…ä»¬ã€‚å› æ­¤ï¼Œæ­£å¸¸æƒ…å†µä¸‹ï¼Œå°±æ— éœ€ç›‘æ§ä¸­å¿ƒï¼Œåšè„æ•°æ®åˆ é™¤çš„å·¥ä½œã€‚</li>
<li>ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œå’Œ&nbsp;<code>#doRegister()</code>&nbsp;æ–¹æ³•ï¼Œé€»è¾‘ç›¸åã€‚</li>
</ul>
<h2 id="2-4-doSubscribe">2.4 doSubscribe</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doSubscribe</span><span class="params">(<span class="keyword">final</span> URL url, <span class="keyword">final</span> NotifyListener listener)</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// è·å¾—æœåŠ¡è·¯å¾„ï¼Œä¾‹å¦‚ï¼š`/dubbo/com.alibaba.dubbo.demo.DemoService`</span></span><br /><span class="line"> <span class="number">4</span>:     String service = toServicePath(url);</span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// è·å¾—é€šçŸ¥å™¨ Notifier å¯¹è±¡</span></span><br /><span class="line"> <span class="number">6</span>:     Notifier notifier = notifiers.get(service);</span><br /><span class="line"> <span class="number">7</span>:     <span class="comment">// ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º Notifier å¯¹è±¡</span></span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (notifier == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">9</span>:         Notifier newNotifier = <span class="keyword">new</span> Notifier(service);</span><br /><span class="line"><span class="number">10</span>:         notifiers.putIfAbsent(service, newNotifier);</span><br /><span class="line"><span class="number">11</span>:         notifier = notifiers.get(service);</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">if</span> (notifier == newNotifier) { <span class="comment">// ä¿è¯å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªå¯åŠ¨</span></span><br /><span class="line"><span class="number">13</span>:             notifier.start();</span><br /><span class="line"><span class="number">14</span>:         }</span><br /><span class="line"><span class="number">15</span>:     }</span><br /><span class="line"><span class="number">16</span>:     <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br /><span class="line"><span class="number">17</span>:     RpcException exception = <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">18</span>:     <span class="comment">// å¾ªç¯ `jedisPools` ï¼Œä»…å‘ä¸€ä¸ª Redis å‘èµ·è®¢é˜…</span></span><br /><span class="line"><span class="number">19</span>:     <span class="keyword">for</span> (Map.Entry&lt;String, JedisPool&gt; entry : jedisPools.entrySet()) {</span><br /><span class="line"><span class="number">20</span>:         JedisPool jedisPool = entry.getValue();</span><br /><span class="line"><span class="number">21</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">22</span>:             Jedis jedis = jedisPool.getResource();</span><br /><span class="line"><span class="number">23</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">24</span>:                 <span class="comment">// å¤„ç†æ‰€æœ‰ Service å±‚çš„å‘èµ·è®¢é˜…ï¼Œä¾‹å¦‚ç›‘æ§ä¸­å¿ƒçš„è®¢é˜…</span></span><br /><span class="line"><span class="number">25</span>:                 <span class="keyword">if</span> (service.endsWith(Constants.ANY_VALUE)) {</span><br /><span class="line"><span class="number">26</span>:                     admin = <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">27</span>:                     <span class="comment">// è·å¾—åˆ†ç±»å±‚é›†åˆï¼Œä¾‹å¦‚ï¼š`/dubbo/com.alibaba.dubbo.demo.DemoService/providers`</span></span><br /><span class="line"><span class="number">28</span>:                     Set&lt;String&gt; keys = jedis.keys(service);</span><br /><span class="line"><span class="number">29</span>:                     <span class="keyword">if</span> (keys != <span class="keyword">null</span> &amp;&amp; !keys.isEmpty()) {</span><br /><span class="line"><span class="number">30</span>:                         <span class="comment">// æŒ‰ç…§æœåŠ¡èšåˆ URL é›†åˆ</span></span><br /><span class="line"><span class="number">31</span>:                         Map&lt;String, Set&lt;String&gt;&gt; serviceKeys = <span class="keyword">new</span> HashMap&lt;String, Set&lt;String&gt;&gt;(); <span class="comment">// Keyï¼šRoot + Service ; Valueï¼šURL ã€‚</span></span><br /><span class="line"><span class="number">32</span>:                         <span class="keyword">for</span> (String key : keys) {</span><br /><span class="line"><span class="number">33</span>:                             String serviceKey = toServicePath(key);</span><br /><span class="line"><span class="number">34</span>:                             Set&lt;String&gt; sk = serviceKeys.get(serviceKey);</span><br /><span class="line"><span class="number">35</span>:                             <span class="keyword">if</span> (sk == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">36</span>:                                 sk = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br /><span class="line"><span class="number">37</span>:                                 serviceKeys.put(serviceKey, sk);</span><br /><span class="line"><span class="number">38</span>:                             }</span><br /><span class="line"><span class="number">39</span>:                             sk.add(key);</span><br /><span class="line"><span class="number">40</span>:                         }</span><br /><span class="line"><span class="number">41</span>:                         <span class="comment">// å¾ªç¯ serviceKeys ï¼ŒæŒ‰ç…§æ¯ä¸ª Service å±‚çš„å‘èµ·é€šçŸ¥</span></span><br /><span class="line"><span class="number">42</span>:                         <span class="keyword">for</span> (Set&lt;String&gt; sk : serviceKeys.values()) {</span><br /><span class="line"><span class="number">43</span>:                             doNotify(jedis, sk, url, Collections.singletonList(listener));</span><br /><span class="line"><span class="number">44</span>:                         }</span><br /><span class="line"><span class="number">45</span>:                     }</span><br /><span class="line"><span class="number">46</span>:                 <span class="comment">// å¤„ç†æŒ‡å®š Service å±‚çš„å‘èµ·é€šçŸ¥</span></span><br /><span class="line"><span class="number">47</span>:                 } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">48</span>:                     doNotify(jedis, jedis.keys(service + Constants.PATH_SEPARATOR + Constants.ANY_VALUE), url, Collections.singletonList(listener));</span><br /><span class="line"><span class="number">49</span>:                 }</span><br /><span class="line"><span class="number">50</span>:                 <span class="comment">// æ ‡è®°æˆåŠŸ</span></span><br /><span class="line"><span class="number">51</span>:                 success = <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">52</span>:                 <span class="comment">// ç»“æŸï¼Œä»…ä»…ä»ä¸€å°æœåŠ¡å™¨è¯»å–æ•°æ®</span></span><br /><span class="line"><span class="number">53</span>:                 <span class="keyword">break</span>; <span class="comment">// Just read one server's data</span></span><br /><span class="line"><span class="number">54</span>:             } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">55</span>:                 jedisPool.returnResource(jedis);</span><br /><span class="line"><span class="number">56</span>:             }</span><br /><span class="line"><span class="number">57</span>:         } <span class="keyword">catch</span> (Throwable t) { <span class="comment">// Try the next server</span></span><br /><span class="line"><span class="number">58</span>:             exception = <span class="keyword">new</span> RpcException(<span class="string">"Failed to subscribe service from redis registry. registry: "</span> + entry.getKey() + <span class="string">", service: "</span> + url + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">59</span>:         }</span><br /><span class="line"><span class="number">60</span>:     }</span><br /><span class="line"><span class="number">61</span>:     <span class="comment">// å¤„ç†å¼‚å¸¸</span></span><br /><span class="line"><span class="number">62</span>:     <span class="keyword">if</span> (exception != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">63</span>:         <span class="keyword">if</span> (success) { <span class="comment">// è™½ç„¶å‘ç”Ÿå¼‚å¸¸ï¼Œä½†æ˜¯ç»“æœæˆåŠŸ</span></span><br /><span class="line"><span class="number">64</span>:             logger.warn(exception.getMessage(), exception);</span><br /><span class="line"><span class="number">65</span>:         } <span class="keyword">else</span> { <span class="comment">// æœ€ç»ˆæœªæˆåŠŸ</span></span><br /><span class="line"><span class="number">66</span>:             <span class="keyword">throw</span> exception;</span><br /><span class="line"><span class="number">67</span>:         }</span><br /><span class="line"><span class="number">68</span>:     }</span><br /><span class="line"><span class="number">69</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>========== ã€ç¬¬ä¸€æ­¥ã€‘Notifier éƒ¨åˆ† ==========</li>
<li>ç¬¬ 4 è¡Œï¼šè°ƒç”¨&nbsp;<code>#toServicePath(url)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æœåŠ¡è·¯å¾„ï¼Œä¾‹å¦‚ï¼š<code>/dubbo/com.alibaba.dubbo.demo.DemoService</code>&nbsp;ã€‚</li>
<li>ç¬¬ 6 è¡Œï¼šè·å¾—é€šçŸ¥å™¨ Notifier å¯¹è±¡ã€‚</li>
<li>ç¬¬ 8 è‡³ 15 è¡Œï¼šè‹¥ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º Notifier å¯¹è±¡ï¼Œå¹¶è°ƒç”¨&nbsp;<code>Notifier#start()</code>&nbsp;æ–¹æ³•ã€‚</li>
<li>========== ã€ç¬¬äºŒæ­¥ã€‘è·å–åˆå§‹åŒ–æ•°æ®ï¼Œå¹¶è¿›è¡Œé€šçŸ¥ ==========</li>
<li>ç¬¬ 19 è¡Œï¼šå¾ªç¯&nbsp;<code>jedisPools</code>&nbsp;ï¼Œå‘ Redis å‘èµ·è®¢é˜…ï¼Œ<strong>ç›´åˆ°ä¸€ä¸ªæˆåŠŸ</strong>ã€‚æˆ‘ä»¬ä¼šçœ‹åˆ°ä»£ç ï¼Œåˆ†æˆ<strong>ä¸¤ä¸ªéƒ¨åˆ†</strong>ã€‚</li>
<li>ã€ç¬¬äºŒéƒ¨åˆ†ã€‘ç¬¬ 46 è‡³ 49 è¡Œï¼Œé€‚ç”¨æœåŠ¡æä¾›è€…å’ŒæœåŠ¡æ¶ˆè´¹è€…ï¼Œå¤„ç†<strong>æŒ‡å®š</strong>&nbsp;Service å±‚çš„åˆå§‹åŒ–æ•°æ®ï¼š</li>
<li>ç¬¬ 48 è¡Œï¼šè°ƒç”¨&nbsp;<code>Jedis#keys(pattern)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—<strong>æŒ‡å®š</strong>&nbsp;Service å±‚ä¸‹çš„æ‰€æœ‰ URL ä»¬ã€‚ä¾‹å¦‚&nbsp;<code>/dubbo/com.alibaba.dubbo.demo.DemoService/*</code>&nbsp;ã€‚</li>
<li>ç¬¬ 48 è¡Œï¼šè°ƒç”¨&nbsp;<code>#doNotify(jedis, keys, url, listeners)</code>&nbsp;æ–¹æ³•ï¼Œé€šçŸ¥ç›‘å¬å™¨ï¼Œåˆå§‹çš„æ•°æ®ã€‚</li>
<li>ã€ç¬¬ä¸€éƒ¨åˆ†ã€‘ç¬¬ 25 è‡³ 45 è¡Œï¼Œé€‚ç”¨æ³¨å†Œä¸­å¿ƒï¼Œå¤„ç†<strong>æ‰€æœ‰</strong>&nbsp;Service å±‚çš„åˆå§‹åŒ–æ•°æ®ï¼š</li>
<li>ç¬¬ 26 è¡Œï¼šæ ‡è®°&nbsp;<code>admin = true</code>&nbsp;ã€‚å› ä¸ºï¼Œåªæœ‰æ³¨å†Œä¸­å¿ƒï¼Œæ‰æ¸…ç†è„æ•°æ®ã€‚</li>
<li>ç¬¬ 28 è¡Œï¼šè°ƒç”¨&nbsp;<code>Jedis#keys(pattern)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—<strong>æ‰€æœ‰</strong>&nbsp;Service å±‚ä¸‹çš„æ‰€æœ‰ URL ä»¬ã€‚ä¾‹å¦‚&nbsp;<code>/dubbo/*</code>&nbsp;ã€‚</li>
<li>ç¬¬ 31 è‡³ 39 è¡Œï¼šæŒ‰ç…§<strong>æœåŠ¡</strong>èšåˆ URL é›†åˆã€‚</li>
<li>ç¬¬ 42 è‡³ 44 è¡Œï¼šå¾ªç¯&nbsp;<code>serviceKeys</code>&nbsp;ï¼Œè°ƒç”¨&nbsp;<code>#doNotify(jedis, keys, url, listeners)</code>&nbsp;æ–¹æ³•ï¼ŒæŒ‰ç…§<strong>æ¯ä¸ª Service å±‚</strong>ï¼Œé€šçŸ¥ç›‘å¬å™¨ï¼Œåˆå§‹çš„æ•°æ®ã€‚æ­¤å¤„ï¼Œå°±å’Œã€ç¬¬ 48 è¡Œã€‘<strong>ç±»ä¼¼</strong>ã€‚</li>
</ul>
<p>å¦å¤–ï¼Œè®¢é˜…åŠ¨ä½œï¼ˆã€ç¬¬ä¸€æ­¥ã€‘ï¼‰<strong>ä¸€å®š</strong>è¦åœ¨è·å–åˆå§‹åŒ–æ•°æ®ï¼ˆã€ç¬¬äºŒæ­¥ã€‘ï¼‰<strong>ä¹‹å‰</strong>ã€‚å¦‚æœåè¿‡æ¥ï¼Œå¯èƒ½è·å–æ•°æ®å®Œåï¼Œå¤„ç†çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰æ•°æ®çš„å˜æ›´ï¼Œæˆ‘ä»¬å°±æ— æ³•æ”¶åˆ°&nbsp;<code>register</code>&nbsp;<code>unregister</code>&nbsp;çš„äº‹ä»¶ã€‚</p>
<h3 id="2-4-1-toServicePath">2.4.1 toServicePath</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·å¾—æœåŠ¡è·¯å¾„</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Root + Type</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> url URL</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> æœåŠ¡è·¯å¾„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toServicePath</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> root + url.getServiceInterface();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="2-4-2-toServicePath">2.4.2 toServicePath</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·å¾—æœåŠ¡è·¯å¾„ï¼Œä¸»è¦æˆªæ‰å¤šä½™çš„éƒ¨åˆ†</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Root + Type</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> categoryPath åˆ†ç±»è·¯å¾„</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> æœåŠ¡è·¯å¾„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toServicePath</span><span class="params">(String categoryPath)</span> </span>{</span><br /><span class="line">    <span class="keyword">int</span> i;</span><br /><span class="line">    <span class="keyword">if</span> (categoryPath.startsWith(root)) {</span><br /><span class="line">        i = categoryPath.indexOf(Constants.PATH_SEPARATOR, root.length());</span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        i = categoryPath.indexOf(Constants.PATH_SEPARATOR);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> i &gt; <span class="number">0</span> ? categoryPath.substring(<span class="number">0</span>, i) : categoryPath;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="2-5-doUnsubscribe">2.5 doUnsubscribe</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doUnsubscribe</span><span class="params">(URL url, NotifyListener listener)</span> </span>{</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ­¤å¤„ç›®å‰å¹¶æœªå®ç°ï¼Œè‰¿è‰¿è§‰å¾—ï¼Œæ­¤å¤„åº”è¯¥å¢åŠ å–æ¶ˆå‘ Redis çš„è®¢é˜…( Subscribe ) ã€‚åœ¨ ZookeeperRegistry çš„è¯¥æ–¹æ³•ä¸­ï¼Œæ˜¯ç§»é™¤äº†å¯¹åº”çš„ç›‘å¬å™¨ã€‚</li>
</ul>
<h2 id="2-6-doNotify">2.6 doNotify</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">// @params key åˆ†ç±»æ•°ç»„ï¼Œä¾‹å¦‚ï¼š`/dubbo/com.alibaba.dubbo.demo.DemoService/providers`</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doNotify</span><span class="params">(Jedis jedis, String key)</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">for</span> (Map.Entry&lt;URL, Set&lt;NotifyListener&gt;&gt; entry : <span class="keyword">new</span> HashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;(getSubscribed()).entrySet()) {</span><br /><span class="line"> <span class="number">4</span>:         doNotify(jedis, Collections.singletonList(key), entry.getKey(), <span class="keyword">new</span> HashSet&lt;NotifyListener&gt;(entry.getValue()));</span><br /><span class="line"> <span class="number">5</span>:     }</span><br /><span class="line"> <span class="number">6</span>: }</span><br /><span class="line"> <span class="number">7</span>: </span><br /><span class="line"> <span class="number">8</span>: <span class="comment">// @params keys åˆ†ç±»æ•°ç»„ï¼Œå…ƒç´ ä¾‹å¦‚ï¼š`/dubbo/com.alibaba.dubbo.demo.DemoService/providers`</span></span><br /><span class="line"> <span class="number">9</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doNotify</span><span class="params">(Jedis jedis, Collection&lt;String&gt; keys, URL url, Collection&lt;NotifyListener&gt; listeners)</span> </span>{</span><br /><span class="line"><span class="number">10</span>:     <span class="keyword">if</span> (keys == <span class="keyword">null</span> || keys.isEmpty() || listeners == <span class="keyword">null</span> || listeners.isEmpty()) {</span><br /><span class="line"><span class="number">11</span>:         <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">12</span>:     }</span><br /><span class="line"><span class="number">13</span>:     <span class="keyword">long</span> now = System.currentTimeMillis();</span><br /><span class="line"><span class="number">14</span>:     List&lt;URL&gt; result = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br /><span class="line"><span class="number">15</span>:     List&lt;String&gt; categories = Arrays.asList(url.getParameter(Constants.CATEGORY_KEY, <span class="keyword">new</span> String[<span class="number">0</span>])); <span class="comment">// åˆ†ç±»æ•°ç»„</span></span><br /><span class="line"><span class="number">16</span>:     String consumerService = url.getServiceInterface(); <span class="comment">// æœåŠ¡æ¥å£</span></span><br /><span class="line"><span class="number">17</span>:     <span class="comment">// å¾ªç¯åˆ†ç±»å±‚ï¼Œä¾‹å¦‚ï¼š`/dubbo/com.alibaba.dubbo.demo.DemoService/providers`</span></span><br /><span class="line"><span class="number">18</span>:     <span class="keyword">for</span> (String key : keys) {</span><br /><span class="line"><span class="number">19</span>:         <span class="comment">// è‹¥æœåŠ¡ä¸åŒ¹é…ï¼Œè¿”å›</span></span><br /><span class="line"><span class="number">20</span>:         <span class="keyword">if</span> (!Constants.ANY_VALUE.equals(consumerService)) {</span><br /><span class="line"><span class="number">21</span>:             String providerService = toServiceName(key);</span><br /><span class="line"><span class="number">22</span>:             <span class="keyword">if</span> (!providerService.equals(consumerService)) {</span><br /><span class="line"><span class="number">23</span>:                 <span class="keyword">continue</span>;</span><br /><span class="line"><span class="number">24</span>:             }</span><br /><span class="line"><span class="number">25</span>:         }</span><br /><span class="line"><span class="number">26</span>:         <span class="comment">// è‹¥è®¢é˜…çš„ä¸åŒ…å«è¯¥åˆ†ç±»ï¼Œè¿”å›</span></span><br /><span class="line"><span class="number">27</span>:         String category = toCategoryName(key);</span><br /><span class="line"><span class="number">28</span>:         <span class="keyword">if</span> (!categories.contains(Constants.ANY_VALUE) &amp;&amp; !categories.contains(category)) {</span><br /><span class="line"><span class="number">29</span>:             <span class="keyword">continue</span>;</span><br /><span class="line"><span class="number">30</span>:         }</span><br /><span class="line"><span class="number">31</span>:         <span class="comment">// è·å¾—æ‰€æœ‰ URL æ•°ç»„</span></span><br /><span class="line"><span class="number">32</span>:         List&lt;URL&gt; urls = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br /><span class="line"><span class="number">33</span>:         Map&lt;String, String&gt; values = jedis.hgetAll(key);</span><br /><span class="line"><span class="number">34</span>:         <span class="keyword">if</span> (values != <span class="keyword">null</span> &amp;&amp; values.size() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">35</span>:             <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : values.entrySet()) {</span><br /><span class="line"><span class="number">36</span>:                 URL u = URL.valueOf(entry.getKey());</span><br /><span class="line"><span class="number">37</span>:                 <span class="keyword">if</span> (!u.getParameter(Constants.DYNAMIC_KEY, <span class="keyword">true</span>) <span class="comment">// éåŠ¨æ€èŠ‚ç‚¹ï¼Œå› ä¸ºåŠ¨æ€èŠ‚ç‚¹ï¼Œä¸å—è¿‡æœŸçš„é™åˆ¶</span></span><br /><span class="line"><span class="number">38</span>:                         || Long.parseLong(entry.getValue()) &gt;= now) { <span class="comment">// æœªè¿‡æœŸ</span></span><br /><span class="line"><span class="number">39</span>:                     <span class="keyword">if</span> (UrlUtils.isMatch(url, u)) {</span><br /><span class="line"><span class="number">40</span>:                         urls.add(u);</span><br /><span class="line"><span class="number">41</span>:                     }</span><br /><span class="line"><span class="number">42</span>:                 }</span><br /><span class="line"><span class="number">43</span>:             }</span><br /><span class="line"><span class="number">44</span>:         }</span><br /><span class="line"><span class="number">45</span>:         <span class="comment">// è‹¥ä¸å­˜åœ¨åŒ¹é…ï¼Œåˆ™åˆ›å»º `empty://` çš„ URLè¿”å›ï¼Œç”¨äºæ¸…ç©ºè¯¥æœåŠ¡çš„è¯¥åˆ†ç±»ã€‚</span></span><br /><span class="line"><span class="number">46</span>:         <span class="keyword">if</span> (urls.isEmpty()) {</span><br /><span class="line"><span class="number">47</span>:             urls.add(url.setProtocol(Constants.EMPTY_PROTOCOL)</span><br /><span class="line"><span class="number">48</span>:                     .setAddress(Constants.ANYHOST_VALUE)</span><br /><span class="line"><span class="number">49</span>:                     .setPath(toServiceName(key))</span><br /><span class="line"><span class="number">50</span>:                     .addParameter(Constants.CATEGORY_KEY, category));</span><br /><span class="line"><span class="number">51</span>:         }</span><br /><span class="line"><span class="number">52</span>:         result.addAll(urls);</span><br /><span class="line"><span class="number">53</span>:         <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"><span class="number">54</span>:             logger.info(<span class="string">"redis notify: "</span> + key + <span class="string">" = "</span> + urls);</span><br /><span class="line"><span class="number">55</span>:         }</span><br /><span class="line"><span class="number">56</span>:     }</span><br /><span class="line"><span class="number">57</span>:     <span class="keyword">if</span> (result.isEmpty()) {</span><br /><span class="line"><span class="number">58</span>:         <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">59</span>:     }</span><br /><span class="line"><span class="number">60</span>:     <span class="comment">// å…¨é‡æ•°æ®è·å–å®Œæˆæ—¶ï¼Œè°ƒç”¨ `super#notify(...)` æ–¹æ³•ï¼Œå›è°ƒ NotifyListener</span></span><br /><span class="line"><span class="number">61</span>:     <span class="keyword">for</span> (NotifyListener listener : listeners) {</span><br /><span class="line"><span class="number">62</span>:         <span class="keyword">super</span>.notify(url, listener, result);</span><br /><span class="line"><span class="number">63</span>:     }</span><br /><span class="line"><span class="number">64</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ä¸¤ä¸ªé‡è½½çš„&nbsp;<code>#doNotify(...)</code>&nbsp;æ–¹æ³•ï¼Œä¸»è¦å·®å¼‚ç‚¹åœ¨å‰è€…å°‘&nbsp;<code>url</code>&nbsp;å’Œ&nbsp;<code>listeners</code>&nbsp;æ–¹æ³•å‚æ•°ã€‚æ‰€ä»¥ï¼š</p>
<ul>
<li>
<p>ç¬¬ 3 è¡Œï¼šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è°ƒç”¨&nbsp;<code>#getSubscribed()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—<strong>æ‰€æœ‰</strong>ç›‘å¬å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è®¢é˜… URL çš„ç›‘å¬å™¨é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * keyï¼šè®¢é˜…è€…çš„ URL ï¼Œä¾‹å¦‚æ¶ˆè´¹è€…çš„ URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;URL, Set&lt;NotifyListener&gt;&gt; subscribed = <span class="keyword">new</span> ConcurrentHashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;();</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>x</li>
</ul>
</li>
<li>ç¬¬ 3 è‡³ 5 è¡Œï¼š<strong>å¾ªç¯</strong>è°ƒç”¨&nbsp;<code>#doNotify(jedis, keys, url, listeners)</code>&nbsp;æ–¹æ³•ï¼Œè¿›è¡Œé€šçŸ¥ã€‚<strong>ä½†æ˜¯å‘¢</strong>ï¼Ÿè¿™æ ·ä¸€æ¥ï¼Œé€šçŸ¥çš„äº‹ä»¶(&nbsp;<code>key</code>&nbsp;)å’Œç›‘å¬å™¨æœªå¿…åŒ¹é…ï¼Œå› æ­¤åœ¨ã€ç¬¬ 20 è‡³ 30 è¡Œã€‘çš„ä»£ç ï¼Œè¿›è¡ŒåŒ¹é…ã€‚</li>
</ul>
</li>
<li>ç¬¬ 15 è¡Œï¼šè·å¾—åˆ†ç±»å±‚( Category )ï¼Œå³åˆ†ç±»æ•°ç»„ã€‚åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/registry-zookeeper/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æ³¨å†Œä¸­å¿ƒï¼ˆäºŒï¼‰ä¹‹ Zookeeperã€‹ã€Œ4. è°ƒç”¨ã€</a>&nbsp;å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°ï¼Œä¸åŒè§’è‰²å…³æ³¨ä¸åŒçš„åˆ†ç±»æ•°æ®ã€‚
<ul>
<li>æœåŠ¡æ¶ˆè´¹è€…ï¼Œå…³æ³¨&nbsp;<code>providers</code>&nbsp;<code>configurations</code>&nbsp;<code>routes</code>&nbsp;ã€‚</li>
<li>æœåŠ¡æä¾›è€…ï¼Œå…³æ³¨&nbsp;<code>consumers</code>&nbsp;ã€‚</li>
<li>ç›‘æ§ä¸­å¿ƒï¼Œå…³æ³¨æ‰€æœ‰ã€‚</li>
</ul>
</li>
<li>ç¬¬ 18 è¡Œï¼šå¾ªç¯åˆ†ç±»å±‚ï¼Œå³æ¯ä¸ªå…ƒç´ ä¸º Root + Service + Type ï¼Œä¾‹å¦‚ï¼š<code>/dubbo/com.alibaba.dubbo.demo.DemoService/providers</code>&nbsp;ã€‚</li>
<li>ç¬¬ 32 è‡³ 44 è¡Œï¼šè°ƒç”¨&nbsp;<code>Jedis#hgetAll(key)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æ‰€æœ‰ URL æ•°ç»„ã€‚å¹¶ä¸”ï¼Œè·å–å®Œæˆåï¼Œä¼šè¿‡æ»¤æ‰<strong>å·²è¿‡æœŸ</strong>çš„<strong>åŠ¨æ€</strong>èŠ‚ç‚¹ã€‚</li>
<li>ç¬¬ 45 è‡³ 51 è¡Œï¼šè‹¥ä¸å­˜åœ¨åŒ¹é…ï¼Œåˆ™åˆ›å»º&nbsp;<code>empty://</code>&nbsp;çš„ URLè¿”å›ï¼Œç”¨äº<strong>æ¸…ç©º</strong>è¯¥æœåŠ¡çš„è¯¥åˆ†ç±»ã€‚</li>
<li>ç¬¬ 52 è¡Œï¼šæ·»åŠ åˆ°&nbsp;<code>result</code>&nbsp;ä¸­ã€‚</li>
<li>ç¬¬ 60 è‡³ 63 è¡Œï¼šå…¨é‡æ•°æ®è·å–å®Œæˆæ—¶ï¼Œè°ƒç”¨&nbsp;<code>super#notify(...)</code>&nbsp;æ–¹æ³•ï¼Œå›è°ƒ NotifyListener ã€‚è¯¥æ–¹æ³•ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/registry-api/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹</a>&nbsp;æœ‰è¯¦ç»†è§£æã€‚</li>
</ul>
<h3 id="2-6-1-toServiceName">2.6.1 toServiceName</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·å¾—æœåŠ¡åï¼Œä»æœåŠ¡è·¯å¾„ä¸Š</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Service</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> categoryPath æœåŠ¡è·¯å¾„</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> æœåŠ¡å</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toServiceName</span><span class="params">(String categoryPath)</span> </span>{</span><br /><span class="line">    String servicePath = toServicePath(categoryPath);</span><br /><span class="line">    <span class="keyword">return</span> servicePath.startsWith(root) ? servicePath.substring(root.length()) : servicePath;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="2-6-2-toCategoryName">2.6.2 toCategoryName</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·å¾—åˆ†ç±»åï¼Œä»åˆ†ç±»è·¯å¾„ä¸Š</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Type</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> categoryPath åˆ†ç±»è·¯å¾„</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> åˆ†ç±»å</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toCategoryName</span><span class="params">(String categoryPath)</span> </span>{</span><br /><span class="line">    <span class="keyword">int</span> i = categoryPath.lastIndexOf(Constants.PATH_SEPARATOR);</span><br /><span class="line">    <span class="keyword">return</span> i &gt; <span class="number">0</span> ? categoryPath.substring(i + <span class="number">1</span>) : categoryPath;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="2-7-deferExpired">2.7 deferExpired</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deferExpired</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="keyword">for</span> (Map.Entry&lt;String, JedisPool&gt; entry : jedisPools.entrySet()) {</span><br /><span class="line"> <span class="number">3</span>:         JedisPool jedisPool = entry.getValue();</span><br /><span class="line"> <span class="number">4</span>:         <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">5</span>:             Jedis jedis = jedisPool.getResource();</span><br /><span class="line"> <span class="number">6</span>:             <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">7</span>:                 <span class="comment">// å¾ªç¯å·²æ³¨å†Œçš„ URL é›†åˆ</span></span><br /><span class="line"> <span class="number">8</span>:                 <span class="keyword">for</span> (URL url : <span class="keyword">new</span> HashSet&lt;URL&gt;(getRegistered())) {</span><br /><span class="line"> <span class="number">9</span>:                     <span class="comment">// åŠ¨æ€èŠ‚ç‚¹</span></span><br /><span class="line"><span class="number">10</span>:                     <span class="keyword">if</span> (url.getParameter(Constants.DYNAMIC_KEY, <span class="keyword">true</span>)) {</span><br /><span class="line"><span class="number">11</span>:                         <span class="comment">// è·å¾—åˆ†ç±»è·¯å¾„</span></span><br /><span class="line"><span class="number">12</span>:                         String key = toCategoryPath(url);</span><br /><span class="line"><span class="number">13</span>:                         <span class="comment">// å†™å…¥ Redis Map ä¸­</span></span><br /><span class="line"><span class="number">14</span>:                         <span class="keyword">if</span> (jedis.hset(key, url.toFullString(), String.valueOf(System.currentTimeMillis() + expirePeriod)) == <span class="number">1</span>) {</span><br /><span class="line"><span class="number">15</span>:                             <span class="comment">// å‘å¸ƒ `register` äº‹ä»¶ã€‚</span></span><br /><span class="line"><span class="number">16</span>:                             jedis.publish(key, Constants.REGISTER);</span><br /><span class="line"><span class="number">17</span>:                         }</span><br /><span class="line"><span class="number">18</span>:                     }</span><br /><span class="line"><span class="number">19</span>:                 }</span><br /><span class="line"><span class="number">20</span>:                 <span class="comment">// ç›‘æ§ä¸­å¿ƒè´Ÿè´£åˆ é™¤è¿‡æœŸè„æ•°æ®</span></span><br /><span class="line"><span class="number">21</span>:                 <span class="keyword">if</span> (admin) {</span><br /><span class="line"><span class="number">22</span>:                     clean(jedis);</span><br /><span class="line"><span class="number">23</span>:                 }</span><br /><span class="line"><span class="number">24</span>:                 <span class="comment">// å¦‚æœæœåŠ¡å™¨ç«¯å·²åŒæ­¥æ•°æ®ï¼Œåªéœ€å†™å…¥å•å°æœºå™¨</span></span><br /><span class="line"><span class="number">25</span>:                 <span class="keyword">if</span> (!replicate) {</span><br /><span class="line"><span class="number">26</span>:                     <span class="keyword">break</span>;<span class="comment">// &nbsp;If the server side has synchronized data, just write a single machine</span></span><br /><span class="line"><span class="number">27</span>:                 }</span><br /><span class="line"><span class="number">28</span>:             } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">29</span>:                 jedisPool.returnResource(jedis);</span><br /><span class="line"><span class="number">30</span>:             }</span><br /><span class="line"><span class="number">31</span>:         } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">32</span>:             logger.warn(<span class="string">"Failed to write provider heartbeat to redis registry. registry: "</span> + entry.getKey() + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">33</span>:         }</span><br /><span class="line"><span class="number">34</span>:     }</span><br /><span class="line"><span class="number">35</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è¢«&nbsp;<code>expireExecutor</code>&nbsp;ä¸­çš„å®šæ—¶è°ƒç”¨ï¼Œæ•´ä½“é€»è¾‘ç±»ä¼¼&nbsp;<code>#doRegister()</code>&nbsp;æ–¹æ³•ã€‚</li>
<li>
<p>ç¬¬ 8 è¡Œï¼šè°ƒç”¨&nbsp;<code>#getRegistered()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—å·²æ³¨å†Œçš„ URL é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å·²æ³¨å†Œ URL é›†åˆã€‚</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * æ³¨æ„ï¼Œæ³¨å†Œçš„ URL ä¸ä»…ä»…å¯ä»¥æ˜¯æœåŠ¡æä¾›è€…çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡æ¶ˆè´¹è€…çš„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;URL&gt; registered = <span class="keyword">new</span> ConcurrentHashSet&lt;URL&gt;();</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 8 è¡Œï¼šå¾ªç¯ URL é›†åˆã€‚</p>
</li>
<li>ç¬¬ 10 è¡Œï¼šåˆ¤æ–­æ˜¯å¦ä¸º<strong>åŠ¨æ€</strong>èŠ‚ç‚¹ï¼Œåªæœ‰åŠ¨æ€èŠ‚ç‚¹éœ€è¦å»¶é•¿è¿‡æœŸæ—¶é—´ã€‚</li>
<li>ç¬¬ 14 è¡Œï¼šè°ƒç”¨&nbsp;<code>Jedis#hset(key, value, expire)</code>&nbsp;æ–¹æ³•ï¼Œå†™å…¥ Redis Map ä¸­ã€‚<strong>æ³¨æ„ï¼Œè¿‡æœŸæ—¶é—´ï¼Œä½œä¸º Map çš„å€¼</strong>ã€‚</li>
<li>ç¬¬ 16 è¡Œï¼šè‹¥ã€ç¬¬ 14 è¡Œã€‘å†™å…¥è¿”å›çš„å€¼ä¸º 1 ï¼Œè¯´æ˜ Map ä¸­è¯¥é”®å¯¹åº”çš„å€¼ä¸å­˜åœ¨ï¼ˆä¾‹å¦‚ï¼Œå¤šå†™ Redis èŠ‚ç‚¹æ—¶ï¼Œæœ‰ä¸ªèŠ‚ç‚¹å†™å…¥å¤±è´¥ï¼‰ï¼Œå‘å¸ƒ&nbsp;<code>register</code>&nbsp;äº‹ä»¶ã€‚</li>
<li>ç¬¬ 21 è‡³ 23 è¡Œï¼šè‹¥æ˜¯æ³¨å†Œä¸­å¿ƒ(&nbsp;<code>admin = true</code>&nbsp;) æ—¶ï¼Œè°ƒç”¨&nbsp;<code>#clean(Jedis)</code>&nbsp;æ–¹æ³•ï¼Œæ¸…ç†è¿‡æœŸè„æ•°æ®ã€‚</li>
<li>ç¬¬ 25 è‡³ 27 è¡Œï¼šå¦‚æœæœåŠ¡å™¨ç«¯å·²åŒæ­¥æ•°æ®ï¼Œåªéœ€å†™å…¥å•å°æœºå™¨ã€‚</li>
</ul>
<h3 id="2-7-1-clean">2.7.1 clean</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clean</span><span class="params">(Jedis jedis)</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾—æ‰€æœ‰æœåŠ¡</span></span><br /><span class="line">    Set&lt;String&gt; keys = jedis.keys(root + Constants.ANY_VALUE);</span><br /><span class="line">    <span class="keyword">if</span> (keys != <span class="keyword">null</span> &amp;&amp; !keys.isEmpty()) {</span><br /><span class="line">        <span class="keyword">for</span> (String key : keys) {</span><br /><span class="line">            <span class="comment">// è·å¾—æ‰€æœ‰ URL</span></span><br /><span class="line">            Map&lt;String, String&gt; values = jedis.hgetAll(key);</span><br /><span class="line">            <span class="keyword">if</span> (values != <span class="keyword">null</span> &amp;&amp; values.size() &gt; <span class="number">0</span>) {</span><br /><span class="line">                <span class="keyword">boolean</span> delete = <span class="keyword">false</span>;</span><br /><span class="line">                <span class="keyword">long</span> now = System.currentTimeMillis();</span><br /><span class="line">                <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : values.entrySet()) {</span><br /><span class="line">                    URL url = URL.valueOf(entry.getKey());</span><br /><span class="line">                    <span class="comment">// åŠ¨æ€èŠ‚ç‚¹</span></span><br /><span class="line">                    <span class="keyword">if</span> (url.getParameter(Constants.DYNAMIC_KEY, <span class="keyword">true</span>)) {</span><br /><span class="line">                        <span class="keyword">long</span> expire = Long.parseLong(entry.getValue());</span><br /><span class="line">                        <span class="comment">// å·²ç»è¿‡æœŸ</span></span><br /><span class="line">                        <span class="keyword">if</span> (expire &lt; now) {</span><br /><span class="line">                            <span class="comment">//</span></span><br /><span class="line">                            jedis.hdel(key, entry.getKey());</span><br /><span class="line">                            delete = <span class="keyword">true</span>;</span><br /><span class="line">                            <span class="keyword">if</span> (logger.isWarnEnabled()) {</span><br /><span class="line">                                logger.warn(<span class="string">"Delete expired key: "</span> + key + <span class="string">" -&gt; value: "</span> + entry.getKey() + <span class="string">", expire: "</span> + <span class="keyword">new</span> Date(expire) + <span class="string">", now: "</span> + <span class="keyword">new</span> Date(now));</span><br /><span class="line">                            }</span><br /><span class="line">                        }</span><br /><span class="line">                    }</span><br /><span class="line">                }</span><br /><span class="line">                <span class="comment">// è‹¥åˆ é™¤æˆåŠŸï¼Œå‘å¸ƒ `unregister` äº‹ä»¶</span></span><br /><span class="line">                <span class="keyword">if</span> (delete) {</span><br /><span class="line">                    jedis.publish(key, Constants.UNREGISTER);</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ•´ä½“é€»è¾‘ç±»ä¼¼&nbsp;<code>#doUnregister()</code>&nbsp;æ–¹æ³•ã€‚</li>
<li>ğŸ™‚ èƒ–å‹è‡ªå·±çœ‹æ–¹æ³•çš„æ³¨é‡Šå“ˆã€‚</li>
</ul>
<h2 id="2-8-isAvailable">2.8 isAvailable</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">for</span> (JedisPool jedisPool : jedisPools.values()) {</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            Jedis jedis = jedisPool.getResource();</span><br /><span class="line">            <span class="keyword">try</span> {</span><br /><span class="line">                <span class="keyword">if</span> (jedis.isConnected()) { <span class="comment">// è‡³å°‘ä¸€ä¸ª Redis èŠ‚ç‚¹å¯ç”¨</span></span><br /><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// At least one single machine is available.</span></span><br /><span class="line">                }</span><br /><span class="line">            } <span class="keyword">finally</span> {</span><br /><span class="line">                jedisPool.returnResource(jedis);</span><br /><span class="line">            }</span><br /><span class="line">        } <span class="keyword">catch</span> (Throwable ignored) {</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="2-9-destroy">2.9 destroy</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// çˆ¶ç±»å…³é—­</span></span><br /><span class="line">    <span class="keyword">super</span>.destroy();</span><br /><span class="line">    <span class="comment">// å…³é—­å®šæ—¶ä»»åŠ¡</span></span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        expireFuture.cancel(<span class="keyword">true</span>);</span><br /><span class="line">    } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">        logger.warn(t.getMessage(), t);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// å…³é—­é€šçŸ¥å™¨</span></span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="keyword">for</span> (Notifier notifier : notifiers.values()) {</span><br /><span class="line">            notifier.shutdown();</span><br /><span class="line">        }</span><br /><span class="line">    } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">        logger.warn(t.getMessage(), t);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// å…³é—­è¿æ¥æ± </span></span><br /><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, JedisPool&gt; entry : jedisPools.entrySet()) {</span><br /><span class="line">        JedisPool jedisPool = entry.getValue();</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            jedisPool.destroy();</span><br /><span class="line">        } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">            logger.warn(<span class="string">"Failed to destroy the redis registry client. registry: "</span> + entry.getKey() + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="3-Notifier">3. Notifier</h1>
<blockquote>
<p>Notifier æ˜¯ RedisRegistry çš„å†…éƒ¨ç±»ã€‚</p>
</blockquote>
<p>Notifier ï¼Œç»§æ‰¿ Thread ç±»ï¼Œè´Ÿè´£å‘ Redis å‘èµ·è®¢é˜…é€»è¾‘ã€‚</p>
<h2 id="3-1-æ„é€ æ–¹æ³•">3.1 æ„é€ æ–¹æ³•</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * æœåŠ¡å Root + Service</span></span><br /><span class="line"><span class="comment"> 3:  */</span></span><br /><span class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> String service;</span><br /><span class="line"> <span class="number">5</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 6:  * Jedis</span></span><br /><span class="line"><span class="comment"> 7:  */</span></span><br /><span class="line"> <span class="number">8</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> Jedis jedis;</span><br /><span class="line"> <span class="number">9</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">10:  * æ˜¯å¦é¦–æ¬¡</span></span><br /><span class="line"><span class="comment">11:  */</span></span><br /><span class="line"><span class="number">12</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> first = <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">13</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">14:  * æ˜¯å¦è¿è¡Œä¸­</span></span><br /><span class="line"><span class="comment">15:  */</span></span><br /><span class="line"><span class="number">16</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> running = <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">17</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">18:  * è¿æ¥æ¬¡æ•°éšæœºæ•°</span></span><br /><span class="line"><span class="comment">19:  */</span></span><br /><span class="line"><span class="number">20</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> connectRandom;</span><br /><span class="line"><span class="number">21</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">22:  * éœ€è¦å¿½ç•¥è¿æ¥çš„æ¬¡æ•°</span></span><br /><span class="line"><span class="comment">23:  */</span></span><br /><span class="line"><span class="number">24</span>: <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger connectSkip = <span class="keyword">new</span> AtomicInteger();</span><br /><span class="line"><span class="number">25</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">26:  * å·²ç»å¿½ç•¥è¿æ¥çš„æ¬¡æ•°</span></span><br /><span class="line"><span class="comment">27:  */</span></span><br /><span class="line"><span class="number">28</span>: <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger connectSkiped = <span class="keyword">new</span> AtomicInteger();</span><br /><span class="line"><span class="number">29</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">30:  * éšæœº</span></span><br /><span class="line"><span class="comment">31:  */</span></span><br /><span class="line"><span class="number">32</span>: <span class="keyword">private</span> <span class="keyword">final</span> Random random = <span class="keyword">new</span> Random();</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>service</code>&nbsp;å±æ€§ï¼ŒæœåŠ¡å Root + Serviceã€‚</li>
<li><code>first</code>&nbsp;å±æ€§ï¼Œæ˜¯å¦é¦–æ¬¡ã€‚åœ¨&nbsp;<code>#run()</code>&nbsp;æ–¹æ³•ä¸­ï¼ŒæŸ¥çœ‹ã€‚</li>
<li>
<p>ã€ç¬¬ 13 è‡³ 32 è¡Œã€‘çš„å±æ€§ï¼Œç›¸å½“äº<strong>é‡è¿ç­–ç•¥</strong>ï¼Œç”¨äºå’Œ Redis æ–­å¼€æ—¶ï¼Œå¿½ç•¥ä¸€å®šæ¬¡æ•°å’Œ Redis çš„è¿æ¥ï¼Œé¿å…ç©ºè·‘ã€‚æ¶‰åŠæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<ul>
<li>
<p><code>#isSkip()</code>&nbsp;æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å¿½ç•¥æœ¬æ¬¡å¯¹ Redis çš„è¿æ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isSkip</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// è·å¾—éœ€è¦å¿½ç•¥è¿æ¥çš„æ€»æ¬¡æ•°ã€‚å¦‚æœè¶…è¿‡ 10 ï¼Œåˆ™åŠ ä¸Šä¸€ä¸ª 10 ä»¥å†…çš„éšæœºæ•°ã€‚</span></span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">int</span> skip = connectSkip.get(); <span class="comment">// Growth of skipping times</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (skip &gt;= <span class="number">10</span>) { <span class="comment">// If the number of skipping times increases by more than 10, take the random number</span></span><br /><span class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (connectRandom == <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">6</span>:             connectRandom = random.nextInt(<span class="number">10</span>);</span><br /><span class="line"> <span class="number">7</span>:         }</span><br /><span class="line"> <span class="number">8</span>:         skip = <span class="number">10</span> + connectRandom;</span><br /><span class="line"> <span class="number">9</span>:     }</span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// è‡ªå¢å¿½ç•¥æ¬¡æ•°ã€‚è‹¥å¿½ç•¥æ¬¡æ•°ä¸å¤Ÿï¼Œåˆ™ç»§ç»­å¿½ç•¥ã€‚</span></span><br /><span class="line"><span class="number">11</span>:     <span class="keyword">if</span> (connectSkiped.getAndIncrement() &lt; skip) { <span class="comment">// Check the number of skipping times</span></span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">13</span>:     }</span><br /><span class="line"><span class="number">14</span>:     <span class="comment">// å¢åŠ éœ€è¦å¿½ç•¥çš„æ¬¡æ•°</span></span><br /><span class="line"><span class="number">15</span>:     connectSkip.incrementAndGet();</span><br /><span class="line"><span class="number">16</span>:     <span class="comment">// é‡ç½®å·²å¿½ç•¥æ¬¡æ•°å’Œéšæœºæ•°</span></span><br /><span class="line"><span class="number">17</span>:     connectSkiped.set(<span class="number">0</span>);</span><br /><span class="line"><span class="number">18</span>:     connectRandom = <span class="number">0</span>;</span><br /><span class="line"><span class="number">19</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line"><span class="number">20</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 2 è‡³ 9 è¡Œï¼šè·å¾—<strong>éœ€è¦å¿½ç•¥è¿æ¥çš„æ€»æ¬¡æ•°</strong>ã€‚å¦‚æœè¶…è¿‡ 10 ï¼Œåˆ™åŠ ä¸Šä¸€ä¸ª 10 ä»¥å†…çš„éšæœºæ•°ã€‚æ€è·¯æ˜¯ï¼Œè¿æ¥å¤±è´¥çš„æ¬¡æ•°è¶Šå¤šï¼Œ<strong>æ¯ä¸€è½®</strong>åŠ å¤§éœ€è¦å¿½ç•¥çš„æ€»æ¬¡æ•°ï¼Œå¹¶ä¸”å¸¦æœ‰ä¸€å®šçš„éšæœºæ€§ã€‚</li>
<li>ç¬¬ 10 è‡³ 13 è¡Œï¼šè‡ªå¢å¿½ç•¥æ¬¡æ•°ã€‚è‹¥å¿½ç•¥æ¬¡æ•°ä¸å¤Ÿï¼Œåˆ™ç»§ç»­å¿½ç•¥ï¼Œå³è¿”å›&nbsp;<code>true</code>&nbsp;ã€‚</li>
<li>
<p>ç¬¬ 15 è¡Œï¼šå¢åŠ éœ€è¦å¿½ç•¥çš„æ¬¡æ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>ä¸‹ä¸€è½®</strong>ï¼Œä¸è€ƒè™‘éšæœºæ•°ï¼Œä¼šå¤šä¸€æ¬¡ã€‚å¦‚ä¸‹æ˜¯ä¸€æ¬¡æ¨¡æ‹Ÿï¼š</p>
<blockquote>
<p>ç¬¬ä¸€è½®</p>
<ul>
<li>connectSkip: 0; connectSkiped: 0</li>
</ul>
<p>ç¬¬äºŒè½®</p>
<ul>
<li>connectSkip: 1; connectSkiped: 0</li>
<li>connectSkip: 1; connectSkiped: 1</li>
</ul>
<p>ç¬¬ä¸‰è½®</p>
<ul>
<li>connectSkip: 2; connectSkiped: 0</li>
<li>connectSkip: 2; connectSkiped: 1</li>
<li>connectSkip: 2; connectSkiped: 2</li>
</ul>
</blockquote>
<ul>
<li>å½“è¶…è¿‡åè½®åï¼Œå¢åŠ éšæœºæ•°ã€‚</li>
</ul>
</li>
<li>
<p>ç¬¬ 16 è‡³ 18 è¡Œï¼šé‡ç½®å·²å¿½ç•¥æ¬¡æ•°å’Œéšæœºæ•°ã€‚</p>
</li>
</ul>
</li>
<li>
<p><code>#resetSkip()</code>&nbsp;æ–¹æ³•ï¼Œé‡ç½®å¿½ç•¥è¿æ¥çš„ä¿¡æ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resetSkip</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// é‡ç½®éœ€è¦è¿æ¥çš„æ¬¡æ•°</span></span><br /><span class="line">    connectSkip.set(<span class="number">0</span>);</span><br /><span class="line">    <span class="comment">// é‡ç½®å·²å¿½ç•¥æ¬¡æ•°å’Œéšæœºæ•°</span></span><br /><span class="line">    connectSkiped.set(<span class="number">0</span>);</span><br /><span class="line">    connectRandom = <span class="number">0</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>x</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="3-2-run">3.2 run</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">while</span> (running) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">5</span>:             <span class="comment">// æ˜¯å¦è·³è¿‡æœ¬æ¬¡ Redis è¿æ¥</span></span><br /><span class="line"> <span class="number">6</span>:             <span class="keyword">if</span> (!isSkip()) {</span><br /><span class="line"> <span class="number">7</span>:                 <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">8</span>:                     <span class="keyword">for</span> (Map.Entry&lt;String, JedisPool&gt; entry : jedisPools.entrySet()) {</span><br /><span class="line"> <span class="number">9</span>:                         JedisPool jedisPool = entry.getValue();</span><br /><span class="line"><span class="number">10</span>:                         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">11</span>:                             jedis = jedisPool.getResource();</span><br /><span class="line"><span class="number">12</span>:                             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">13</span>:                                 <span class="comment">// ç›‘æ§ä¸­å¿ƒ</span></span><br /><span class="line"><span class="number">14</span>:                                 <span class="keyword">if</span> (service.endsWith(Constants.ANY_VALUE)) {</span><br /><span class="line"><span class="number">15</span>:                                     <span class="keyword">if</span> (!first) {</span><br /><span class="line"><span class="number">16</span>:                                         first = <span class="keyword">false</span>;</span><br /><span class="line"><span class="number">17</span>:                                         Set&lt;String&gt; keys = jedis.keys(service);</span><br /><span class="line"><span class="number">18</span>:                                         <span class="keyword">if</span> (keys != <span class="keyword">null</span> &amp;&amp; !keys.isEmpty()) {</span><br /><span class="line"><span class="number">19</span>:                                             <span class="keyword">for</span> (String s : keys) {</span><br /><span class="line"><span class="number">20</span>:                                                 doNotify(jedis, s);</span><br /><span class="line"><span class="number">21</span>:                                             }</span><br /><span class="line"><span class="number">22</span>:                                         }</span><br /><span class="line"><span class="number">23</span>:                                         resetSkip();</span><br /><span class="line"><span class="number">24</span>:                                     }</span><br /><span class="line"><span class="number">25</span>:                                     <span class="comment">// æ‰¹è®¢é˜…</span></span><br /><span class="line"><span class="number">26</span>:                                     jedis.psubscribe(<span class="keyword">new</span> NotifySub(jedisPool), service); <span class="comment">// blocking</span></span><br /><span class="line"><span class="number">27</span>:                                 <span class="comment">// æœåŠ¡æä¾›è€…æˆ–æ¶ˆè´¹è€…</span></span><br /><span class="line"><span class="number">28</span>:                                 } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">29</span>:                                     <span class="keyword">if</span> (!first) {</span><br /><span class="line"><span class="number">30</span>:                                         first = <span class="keyword">false</span>;</span><br /><span class="line"><span class="number">31</span>:                                         doNotify(jedis, service);</span><br /><span class="line"><span class="number">32</span>:                                         resetSkip();</span><br /><span class="line"><span class="number">33</span>:                                     }</span><br /><span class="line"><span class="number">34</span>:                                     <span class="comment">// æ‰¹è®¢é˜…</span></span><br /><span class="line"><span class="number">35</span>:                                     jedis.psubscribe(<span class="keyword">new</span> NotifySub(jedisPool), service + Constants.PATH_SEPARATOR + Constants.ANY_VALUE); <span class="comment">// blocking</span></span><br /><span class="line"><span class="number">36</span>:                                 }</span><br /><span class="line"><span class="number">37</span>:                                 <span class="keyword">break</span>;</span><br /><span class="line"><span class="number">38</span>:                             } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">39</span>:                                 jedisPool.returnBrokenResource(jedis);</span><br /><span class="line"><span class="number">40</span>:                             }</span><br /><span class="line"><span class="number">41</span>:                         } <span class="keyword">catch</span> (Throwable t) { <span class="comment">// Retry another server</span></span><br /><span class="line"><span class="number">42</span>:                             logger.warn(<span class="string">"Failed to subscribe service from redis registry. registry: "</span> + entry.getKey() + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">43</span>:                             <span class="comment">// If you only have a single redis, you need to take a rest to avoid overtaking a lot of CPU resources</span></span><br /><span class="line"><span class="number">44</span>:                             sleep(reconnectPeriod);</span><br /><span class="line"><span class="number">45</span>:                         }</span><br /><span class="line"><span class="number">46</span>:                     }</span><br /><span class="line"><span class="number">47</span>:                 } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">48</span>:                     logger.error(t.getMessage(), t);</span><br /><span class="line"><span class="number">49</span>:                     sleep(reconnectPeriod);</span><br /><span class="line"><span class="number">50</span>:                 }</span><br /><span class="line"><span class="number">51</span>:             }</span><br /><span class="line"><span class="number">52</span>:         } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">53</span>:             logger.error(t.getMessage(), t);</span><br /><span class="line"><span class="number">54</span>:         }</span><br /><span class="line"><span class="number">55</span>:     }</span><br /><span class="line"><span class="number">56</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šå¾ªç¯æ‰§è¡Œï¼Œç›´åˆ°å…³é—­ã€‚</li>
<li>ç¬¬ 6 è¡Œï¼šè°ƒç”¨&nbsp;<code>#isSkip()</code>&nbsp;æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦è·³è¿‡æœ¬æ¬¡ Redis è¿æ¥ã€‚But ï¼Œå³ä½¿è·³è¿‡ï¼Œä¹Ÿæ²¡æœ‰æ‰§è¡Œç±»ä¼¼ sleep çš„é€»è¾‘ï¼Œæœ‰ç‚¹å¥‡æ€ªã€‚è¿™æ ·ï¼Œä¼šå¯¼è‡´å®é™…å³ä½¿è·³è¿‡ï¼Œä¹Ÿä¼šå¿«é€Ÿå‘ Redis å‘èµ·è®¢é˜…ã€‚ã€TODO 8032ã€‘Redis é‡è¿é€»è¾‘</li>
<li>ç¬¬ 8 è¡Œï¼šå¾ªç¯è¿æ¥æ± ï¼Œå‘èµ·è®¢é˜…ï¼Œç›´åˆ°<strong>ä¸€ä¸ªæˆåŠŸ</strong>ã€‚</li>
<li>======================================================</li>
<li>
<p>ã€ç¬¬ä¸€ç§æƒ…å†µã€‘ç¬¬ 14 è‡³ 26 è¡Œï¼šç›‘æ§ä¸­å¿ƒ</p>
<ul>
<li>
<p>ç¬¬ 15 è‡³ 24 è¡Œï¼šç›®å‰è¿™å—ä»£ç æœ‰ä¸€äº›é—®é¢˜ï¼Ÿï¼åˆå§‹æ—¶&nbsp;<code>first=true</code>&nbsp;ï¼Œé‚£ä¹ˆè¿™å—ä»£ç æ°¸è¿œæ— æ³•æ‰§è¡Œåˆ°ã€‚ç¬”è€…çŒœæµ‹è¿™å—çš„æ„å›¾æ˜¯ï¼Œåœ¨ ZookeeperRegistry ä¸­ï¼Œå¯ä»¥å®ç°å¯¹è¿æ¥çŠ¶æ€çš„ç›‘å¬ï¼Œä»è€Œå®ç°æ–­å¼€é‡è¿æˆåŠŸåï¼Œä» Zookeeper è·å–åˆ°æœ€æ–°çš„æ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">        zkClient.addStateListener(<span class="keyword">new</span> StateListener() {</span><br /><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stateChanged</span><span class="params">(<span class="keyword">int</span> state)</span> </span>{</span><br /><span class="line">                <span class="keyword">if</span> (state == RECONNECTED) {</span><br /><span class="line">                    <span class="keyword">try</span> {</span><br /><span class="line">                        recover();</span><br /><span class="line">                    } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line">                        logger.error(e.getMessage(), e);</span><br /><span class="line">                    }</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">        });</span><br /><span class="line">        ``` </span><br /><span class="line">        * è€Œ JedisPool ä¸­ï¼Œä¸æä¾›è¿™æ ·çš„è¿æ¥ç›‘æ§æœºåˆ¶ã€‚é‚£ä¹ˆå¦‚æœè®¢é˜… Redis å‘ç”Ÿäº†å¼‚å¸¸ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸º Redis è¿æ¥æ–­å¼€äº†ï¼Œéœ€è¦é‡æ–°å‘èµ·è®¢é˜…ï¼Œå¹¶ä¸”éœ€è¦**é‡æ–°**ä» Redis ä¸­è·å–åˆ°æœ€æ–°çš„æ•°æ®ã€‚</span><br /><span class="line">        * é‚£ä¹ˆæ­¤å¤„çš„ä»£ç å¯ä»¥è¿™æ ·æ”¹ï¼š</span><br /><span class="line">            * ç¬¬ <span class="number">16</span> è¡Œï¼š `first = <span class="keyword">true</span>;`</span><br /><span class="line">            * ç¬¬ <span class="number">42</span> è¡Œï¼šå¢åŠ  `first = <span class="keyword">false</span>;`</span><br /><span class="line">    * ç¬¬ 26 è¡Œï¼šè°ƒç”¨ `Jedis#psubscribe(JedisPubSub jedisPubSub, String... patterns)` æ–¹æ³•ï¼Œè®¢é˜…**æ‰€æœ‰ Service å±‚**ã€‚</span><br /><span class="line">* ã€ç¬¬äºŒç§æƒ…å†µã€‘ç¬¬ <span class="number">27</span> è‡³ <span class="number">36</span> è¡Œï¼šæœåŠ¡æä¾›è€…æˆ–æ¶ˆè´¹è€…ã€‚</span><br /><span class="line">    * ç¬¬ <span class="number">29</span> è‡³ <span class="number">34</span> è¡Œï¼šå’Œã€ç¬¬ <span class="number">15</span> è‡³ <span class="number">24</span> è¡Œã€‘**ç±»ä¼¼**ã€‚</span><br /><span class="line">    * ç¬¬ 35 è¡Œï¼šè°ƒç”¨ `Jedis#psubscribe(JedisPubSub jedisPubSub, String... patterns)` æ–¹æ³•ï¼Œè®¢é˜…**æŒ‡å®š Service å±‚**ã€‚</span><br /><span class="line">*  ======================================================</span><br /><span class="line">*  ç¬¬ 37 è‡³ 40 è¡Œï¼šæ— æ³•æ‰§è¡Œåˆ°ï¼Œå› ä¸º `Jedis#psubscribe(JedisPubSub jedisPubSub, String... patterns)` æ–¹æ³•ï¼Œæ˜¯**é˜»å¡**çš„ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ Notifier æ˜¯ä¸€ä¸ª **Thread** çš„åŸå› ã€‚</span><br /><span class="line">*  ç¬¬ 41 è‡³ 45 è¡Œï¼šå‘ç”Ÿå¼‚å¸¸ï¼Œè¯´æ˜ Redis è¿æ¥æ–­å¼€äº†ã€‚å› æ­¤ï¼Œè°ƒç”¨ `#sleep(millis)` æ–¹æ³•ï¼Œç­‰å¾… Redis é‡è¿æˆåŠŸã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œé¿å…æ‰§è¡Œï¼Œå ç”¨å¤§é‡çš„ CPU èµ„æºã€‚</span><br /><br /><span class="line">## 3.3 shutdown</span><br /><br /><span class="line">```Java</span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdown</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="comment">// åœæ­¢è¿è¡Œ</span></span><br /><span class="line">        running = <span class="keyword">false</span>;</span><br /><span class="line">        <span class="comment">// Jedis æ–­å¼€è¿æ¥</span></span><br /><span class="line">        jedis.disconnect();</span><br /><span class="line">    } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">        logger.warn(t.getMessage(), t);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
</li>
</ul>
<h1 id="4-NotifySub">4. NotifySub</h1>
<blockquote>
<p>NotifySub æ˜¯ RedisRegistry çš„å†…éƒ¨ç±»ã€‚</p>
</blockquote>
<p>NotifySub ï¼Œå®ç°&nbsp;<code>redis.clients.jedis.JedisPubSub</code>&nbsp;æŠ½è±¡ç±»ï¼Œé€šçŸ¥è®¢é˜…å®ç°ç±»ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">NotifySub</span> <span class="keyword">extends</span> <span class="title">JedisPubSub</span> </span>{</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">private</span> <span class="keyword">final</span> JedisPool jedisPool;</span><br /><span class="line"> <span class="number">4</span>: </span><br /><span class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> <span class="title">NotifySub</span><span class="params">(JedisPool jedisPool)</span> </span>{</span><br /><span class="line"> <span class="number">6</span>:         <span class="keyword">this</span>.jedisPool = jedisPool;</span><br /><span class="line"> <span class="number">7</span>:     }</span><br /><span class="line"> <span class="number">8</span>: </span><br /><span class="line"> <span class="number">9</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">10</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(String key, String msg)</span> </span>{</span><br /><span class="line"><span class="number">11</span>:         <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"><span class="number">12</span>:             logger.info(<span class="string">"redis event: "</span> + key + <span class="string">" = "</span> + msg);</span><br /><span class="line"><span class="number">13</span>:         }</span><br /><span class="line"><span class="number">14</span>:         <span class="keyword">if</span> (msg.equals(Constants.REGISTER)</span><br /><span class="line"><span class="number">15</span>:                 || msg.equals(Constants.UNREGISTER)) {</span><br /><span class="line"><span class="number">16</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">17</span>:                 Jedis jedis = jedisPool.getResource();</span><br /><span class="line"><span class="number">18</span>:                 <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">19</span>:                     doNotify(jedis, key);</span><br /><span class="line"><span class="number">20</span>:                 } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">21</span>:                     jedisPool.returnResource(jedis);</span><br /><span class="line"><span class="number">22</span>:                 }</span><br /><span class="line"><span class="number">23</span>:             } <span class="keyword">catch</span> (Throwable t) { <span class="comment">// TODO Notification failure does not restore mechanism guarantee</span></span><br /><span class="line"><span class="number">24</span>:                 logger.error(t.getMessage(), t);</span><br /><span class="line"><span class="number">25</span>:             }</span><br /><span class="line"><span class="number">26</span>:         }</span><br /><span class="line"><span class="number">27</span>:     }</span><br /><span class="line"><span class="number">28</span>: </span><br /><span class="line"><span class="number">29</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">30</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPMessage</span><span class="params">(String pattern, String key, String msg)</span> </span>{</span><br /><span class="line"><span class="number">31</span>:         onMessage(key, msg);</span><br /><span class="line"><span class="number">32</span>:     }</span><br /><span class="line"><span class="number">33</span>: </span><br /><span class="line"><span class="number">34</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">35</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSubscribe</span><span class="params">(String key, <span class="keyword">int</span> num)</span> </span>{</span><br /><span class="line"><span class="number">36</span>:     }</span><br /><span class="line"><span class="number">37</span>: </span><br /><span class="line"><span class="number">38</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">39</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPSubscribe</span><span class="params">(String pattern, <span class="keyword">int</span> num)</span> </span>{</span><br /><span class="line"><span class="number">40</span>:     }</span><br /><span class="line"><span class="number">41</span>: </span><br /><span class="line"><span class="number">42</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">43</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUnsubscribe</span><span class="params">(String key, <span class="keyword">int</span> num)</span> </span>{</span><br /><span class="line"><span class="number">44</span>:     }</span><br /><span class="line"><span class="number">45</span>: </span><br /><span class="line"><span class="number">46</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">47</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPUnsubscribe</span><span class="params">(String pattern, <span class="keyword">int</span> num)</span> </span>{</span><br /><span class="line"><span class="number">48</span>:     }</span><br /><span class="line"><span class="number">49</span>: </span><br /><span class="line"><span class="number">50</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å®ç°äº†&nbsp;<code>#onMessage(key, msg)</code>&nbsp;å’Œ&nbsp;<code>#onPMessage(pattern, key, msg)</code>&nbsp;æ–¹æ³•ï¼Œæ”¶åˆ°&nbsp;<code>register</code><code>unregister</code>&nbsp;äº‹ä»¶ï¼Œè°ƒç”¨&nbsp;<code>#doNotify(jedis, key)</code>&nbsp;æ–¹æ³•ï¼Œé€šçŸ¥ç›‘å¬å™¨ï¼Œæ•°æ®å˜åŒ–ï¼Œä»è€Œå®ç°<strong>å®æ—¶</strong>æ›´æ–°ã€‚</li>
</ul>
<h1 id="5-å¯é æ€§">5. å¯é æ€§</h1>
<blockquote>
<p>FROM&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/registry/redis.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; Redis æ³¨å†Œä¸­å¿ƒã€‹</a></p>
<p>é˜¿é‡Œå†…éƒ¨å¹¶æ²¡æœ‰é‡‡ç”¨ Redis åšä¸ºæ³¨å†Œä¸­å¿ƒï¼Œè€Œæ˜¯ä½¿ç”¨è‡ªå·±å®ç°çš„åŸºäºæ•°æ®åº“çš„æ³¨å†Œä¸­å¿ƒï¼Œå³ï¼šRedis æ³¨å†Œä¸­å¿ƒå¹¶æ²¡æœ‰åœ¨é˜¿é‡Œå†…éƒ¨é•¿æ—¶é—´è¿è¡Œçš„å¯é æ€§ä¿éšœï¼Œæ­¤ Redis æ¡¥æ¥å®ç°åªä¸ºå¼€æºç‰ˆæœ¬æä¾›ï¼Œå…¶å¯é æ€§ä¾èµ–äº Redis æœ¬èº«çš„å¯é æ€§ã€‚</p>
</blockquote>
<blockquote>
<p>FROM&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/maturity.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; æˆç†Ÿåº¦ã€‹</a></p>
<p>Redisæ³¨å†Œä¸­å¿ƒ</p>
<ul>
<li>Maturityï¼šStable</li>
<li>Strengthï¼šæ”¯æŒåŸºäºå®¢æˆ·ç«¯åŒå†™çš„é›†ç¾¤æ–¹å¼ï¼Œæ€§èƒ½é«˜</li>
<li>Problemï¼šè¦æ±‚æœåŠ¡å™¨æ—¶é—´åŒæ­¥ï¼Œç”¨äºæ£€æŸ¥å¿ƒè·³è¿‡æœŸè„æ•°æ®</li>
<li>Adviseï¼šå¯ç”¨äºç”Ÿäº§ç¯å¢ƒ</li>
</ul>
</blockquote>
<p>åšä¸ªå°ç¬”è®°ï¼ŒRedis ä¸»ä»å¤åˆ¶çš„æƒ…å†µä¸‹ï¼Œä»èŠ‚ç‚¹çš„è®¢é˜…( Subscribe )ï¼Œå¯ä»¥æ”¶åˆ°ä¸»èŠ‚ç‚¹çš„å‘å¸ƒ( Publish ) ã€‚åšè¿™ä¸ªç¬”è®°çš„åŸå› æ˜¯ï¼ŒåŸæ¥æ‹…å¿ƒ&nbsp;<code>"failover"</code>&nbsp;æ¨¡å¼ä¸‹ï¼ŒRedis ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œå¦‚æœè®¢é˜…ä»èŠ‚ç‚¹ï¼Œä¼šä¸ä¼šå‡ºç°ï¼ŒRedis ä¸»èŠ‚ç‚¹æ¢å¤åï¼Œæ”¶ä¸åˆ°åœ¨å…¶ä¸Šçš„å‘å¸ƒäº‹ä»¶ã€‚</p>
</div>