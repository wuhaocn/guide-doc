# è°ƒç”¨ç‰¹æ€§ï¼ˆä¸‰ï¼‰ä¹‹æ³›åŒ–å®ç°

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«**æ³›åŒ–å®ç°**ã€‚æˆ‘ä»¬æ¥çœ‹ä¸‹ [ã€Šç”¨æˆ·æŒ‡å— â€”â€” æ³›åŒ–å®ç°ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/generic-service.html) çš„å®šä¹‰ï¼š
æ³›æ¥å£å®ç°æ–¹å¼ä¸»è¦ç”¨äºæœåŠ¡å™¨ç«¯æ²¡æœ‰APIæ¥å£åŠæ¨¡å‹ç±»å…ƒçš„æƒ…å†µï¼Œå‚æ•°åŠè¿”å›å€¼ä¸­çš„æ‰€æœ‰ POJO å‡ç”¨ Map è¡¨ç¤ºï¼Œé€šå¸¸ç”¨äºæ¡†æ¶é›†æˆï¼Œæ¯”å¦‚ï¼šå®ç°ä¸€ä¸ªé€šç”¨çš„è¿œç¨‹æœåŠ¡ Mock æ¡†æ¶ï¼Œå¯é€šè¿‡å®ç° GenericService æ¥å£å¤„ç†æ‰€æœ‰æœåŠ¡è¯·æ±‚ã€‚

è¯·æ³¨æ„ï¼Œæ¶ˆè´¹**æä¾›è€…**æ²¡æœ‰ **API æ¥å£** åŠ **æ¨¡å‹ç±»å…ƒ**ã€‚é‚£å°±æ˜¯è¯´ï¼ŒDubbo åœ¨æ³›åŒ–å®ç°ä¸­ï¼Œéœ€è¦åšä¸¤ä»¶äº‹æƒ…ï¼š

**æ³›åŒ–å®ç°**é€‚ç”¨äºæœåŠ¡æä¾›è€…ï¼Œå’Œ**æ³›åŒ–å¼•ç”¨**é€‚ç”¨äºæœåŠ¡æ¶ˆè´¹è€…ï¼Œæ°æ°â€œç›¸åâ€ã€‚

* æ²¡æœ‰ **API æ¥å£**ï¼Œæ‰€ä»¥æä¾›ä¸€ä¸ªæ³›åŒ–æœåŠ¡æ¥å£ï¼Œç›®å‰æ˜¯ [
com.alibaba.dubbo.rpc.service.GenericService
](https://github.com/YunaiV/dubbo/blob/f83e70b53389a064e49babe32e61a5648002a44a/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/service/GenericService.java) ã€‚

* **ä¸€ä¸ª**æ³›åŒ–å®ç°ï¼Œåªå®ç°**ä¸€ä¸ª**æœåŠ¡ã€‚
* é€šè¿‡å®ç°

$invoke(method, parameterTypes, args)
æ–¹æ³•ï¼Œ**å¤„ç†æ‰€æœ‰è¯¥æœåŠ¡çš„è¯·æ±‚**ã€‚
* å…·ä½“çš„ä½¿ç”¨æ–¹å¼ï¼Œæˆ‘ä»¬åœ¨ [ã€Œ2. ç¤ºä¾‹ã€](http://svip.iocoder.cn/Dubbo/rpc-feature-generic-service/) ä¸­çœ‹ã€‚
* æ²¡æœ‰ **æ¨¡å‹ç±»å…ƒ**ï¼Œæ‰€ä»¥æ–¹æ³•å‚æ•°å’Œæ–¹æ³•è¿”å›è‹¥æ˜¯ POJO ( ä¾‹å¦‚ User å’Œ Order ç­‰ ) ï¼Œéœ€è¦**è½¬æ¢å¤„ç†**ï¼š

* æœåŠ¡æ¶ˆè´¹è€…ï¼Œå°† POJO è½¬æˆ Map ï¼Œç„¶åå†è°ƒç”¨æœåŠ¡æä¾›è€…ã€‚ï¼ˆ**é€æ˜**ï¼‰
* æœåŠ¡æä¾›è€…ï¼Œè¿”å› Map ã€‚
* æœåŠ¡æ¶ˆè´¹è€…ï¼Œè‹¥**æ”¶åˆ°**è¿”å›å€¼æ˜¯ Map ï¼Œåˆ™è½¬æ¢æˆ POJO å†è¿”å›ã€‚
* ğŸ™‚ æ­¤å¤„çš„ Map åªæ˜¯ä¸¾ä¾‹å­ï¼Œå®é™…åœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è¿˜æœ‰**ä¸€ç§**è½¬æ¢æ–¹å¼ã€‚ ï¼ˆ**é€æ˜**ï¼‰

æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š

![æµç¨‹](http://static2.iocoder.cn/images/Dubbo/2018_11_07/01.png)

# 2. ç¤ºä¾‹

**æœåŠ¡æä¾›è€…**

åœ¨ [
dubbo-generic-service-demo-provider
](https://github.com/YunaiV/dubbo/tree/3766a47c5e97ee86c29d765dc88ee11ab5225604/dubbo-demo/dubbo-generic-reference-demo-provider) ï¼Œæˆ‘ä»¬æä¾›äº†ä¾‹å­ã€‚æˆ‘ä»¬æŒ‘**é‡ç‚¹**çš„åœ°æ–¹è¯´ã€‚

â‘  åœ¨ Java ä»£ç ä¸­å®ç° GenericService æ¥å£ï¼š
```
public class DemoServiceImpl implements GenericService{
@Override
public Object $invoke(String method, String[] parameterTypes, Object[] args) throws GenericException {
if ("sayHello".equals(method)) {
return "Welcome " + args[0];
}
return "unknown method";
}
}
```

â‘¡ åœ¨ Spring é…ç½®ç”³æ˜æœåŠ¡çš„å®ç°ï¼š

```
<bean id="demoService" class="com.alibaba.dubbo.demo.provider.DemoServiceImpl" />
<dubbo:service interface="com.alibaba.dubbo.demo.DemoService" ref="demoService" generic="true" />
```

* interface
é…ç½®é¡¹ï¼Œæ³›åŒ–å®ç°çš„æœåŠ¡æ¥å£ã€‚é€šè¿‡è¯¥é…ç½®ï¼ŒæœåŠ¡æ¶ˆè´¹è€…ï¼Œå¯ä»¥ä»æ³¨å†Œä¸­å¿ƒï¼Œè·å–åˆ°æ‰€æœ‰**è¯¥æœåŠ¡**çš„æä¾›æ–¹çš„åœ°å€ï¼ŒåŒ…æ‹¬æ³›åŒ–å®ç°çš„è¯¥æœåŠ¡çš„åœ°å€ã€‚
* generic
é…ç½®é¡¹ï¼Œé»˜è®¤ä¸º

false
ï¼Œä¸ä½¿ç”¨é…ç½®é¡¹ã€‚ç›®å‰æœ‰**ä¸¤ç§é…ç½®é¡¹çš„å€¼**ï¼Œå¼€å¯æ³›åŒ–å®ç°çš„åŠŸèƒ½ï¼š

* generic=true
ï¼Œä½¿ç”¨ [
com.alibaba.dubbo.common.utils.PojoUtils
](https://github.com/YunaiV/dubbo/blob/f83e70b53389a064e49babe32e61a5648002a44a/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/PojoUtils.java) ï¼Œå®ç°

POJO <=> Map
çš„äº’è½¬ã€‚
* generic=bean
ï¼Œä½¿ç”¨ [
com.alibaba.dubbo.common.beanutil.JavaBeanSerializeUtil
](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/beanutil/JavaBeanSerializeUtil.java) ï¼Œå®ç°

POJO <=> JavaBeanDescriptor
çš„äº’è½¬ã€‚
* ä¸å­˜åœ¨

generic=nativejava
é…ç½®é¡¹ã€‚

**æœåŠ¡æ¶ˆè´¹è€…**

åœ¨ [
dubbo-generic-service-demo-consumer
](https://github.com/YunaiV/dubbo/tree/3766a47c5e97ee86c29d765dc88ee11ab5225604/dubbo-demo/dubbo-generic-service-demo-consumer) ï¼Œæˆ‘ä»¬æä¾›äº†ä¾‹å­ã€‚æˆ‘ä»¬æŒ‘**é‡ç‚¹**çš„åœ°æ–¹è¯´ã€‚

è°ƒç”¨ä»£ç å¦‚ä¸‹ï¼š
```
DemoService demoService = (DemoService) context.getBean("demoService"); // get remote service proxy
Object result = demoService.say01("NIHAO");
System.out.println("result: " + result);
```

* å’Œæˆ‘ä»¬æ™®é€šçš„æœåŠ¡æ¶ˆè´¹è€…ï¼Œè°ƒç”¨æœåŠ¡æä¾›è€…ï¼Œ**ä¸€æ¨¡ä¸€æ ·**ï¼Œæ³¨æ„ï¼Œæ˜¯**ä¸€æ¨¡ä¸€æ ·**ã€‚

# 3. æœåŠ¡æ¶ˆè´¹è€… GenericImplFilter

[
com.alibaba.dubbo.rpc.filter.GenericImplFilter
](https://github.com/YunaiV/dubbo/blob/3766a47c5e97ee86c29d765dc88ee11ab5225604/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/filter/GenericImplFilter.java) ï¼Œå®ç° Filter æ¥å£ï¼ŒæœåŠ¡æ¶ˆè´¹è€…çš„æ³›åŒ–è°ƒç”¨è¿‡æ»¤å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: @Activate(group = Constants.CONSUMER, value = Constants.GENERIC_KEY, order = 20000)
2: public class GenericImplFilter implements Filter{
3:
4: private static final Logger logger = LoggerFactory.getLogger(GenericImplFilter.class);
5:
6: private static final Class<?>[] GENERIC_PARAMETER_TYPES = new Class<?>[]{String.class, String[].class, Object[].class};
7:
8: @Override
9: public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException{
10: // è·å¾— `generic` é…ç½®é¡¹
11: String generic = invoker.getUrl().getParameter(Constants.GENERIC_KEY);
12:
13: // æ³›åŒ–å®ç°çš„è°ƒç”¨
14: if (ProtocolUtils.isGeneric(generic)
15: && !Constants.$INVOKE.equals(invocation.getMethodName())
16: && invocation instanceof RpcInvocation) {
17: RpcInvocation invocation2 = (RpcInvocation) invocation;
18: String methodName = invocation2.getMethodName();
19: Class<?>[] parameterTypes = invocation2.getParameterTypes();
20: Object[] arguments = invocation2.getArguments();
21:
22: // è·å¾—å‚æ•°ç±»å‹æ•°ç»„
23: String[] types = new String[parameterTypes.length];
24: for (int i = 0; i < parameterTypes.length; i++) {
25: types[i] = ReflectUtils.getName(parameterTypes[i]);
26: }
27:
28: Object[] args;
29: // ã€ç¬¬ä¸€æ­¥ã€‘`bean` ï¼Œåºåˆ—åŒ–å‚æ•°ï¼Œæ–¹æ³•å‚æ•° => JavaBeanDescriptor
30: if (ProtocolUtils.isBeanGenericSerialization(generic)) {
31: args = new Object[arguments.length];
32: for (int i = 0; i < arguments.length; i++) {
33: args[i] = JavaBeanSerializeUtil.serialize(arguments[i], JavaBeanAccessor.METHOD);
34: }
35: // ã€ç¬¬ä¸€æ­¥ã€‘`true` ï¼Œåºåˆ—åŒ–å‚æ•°ï¼Œä»…æœ‰ Map => POJO
36: } else {
37: args = PojoUtils.generalize(arguments);
38: }
39:
40: // ä¿®æ”¹è°ƒç”¨æ–¹æ³•çš„åå­—ä¸º `$invoke`
41: invocation2.setMethodName(Constants.$INVOKE);
42: // è®¾ç½®è°ƒç”¨æ–¹æ³•çš„å‚æ•°ç±»å‹ä¸º `GENERIC_PARAMETER_TYPES`
43: invocation2.setParameterTypes(GENERIC_PARAMETER_TYPES);
44: // è®¾ç½®è°ƒç”¨æ–¹æ³•çš„å‚æ•°æ•°ç»„ï¼Œåˆ†åˆ«ä¸ºæ–¹æ³•åã€å‚æ•°ç±»å‹æ•°ç»„ã€å‚æ•°æ•°ç»„
45: invocation2.setArguments(new Object[]{methodName, types, args});
46:
47: // ã€ç¬¬äºŒæ­¥ã€‘RPC è°ƒç”¨
48: Result result = invoker.invoke(invocation2);
49:
50: // ã€ç¬¬ä¸‰æ­¥ã€‘ååºåˆ—åŒ–æ­£å¸¸ç»“æœ
51: if (!result.hasException()) {
52: Object value = result.getValue();
53: try {
54: // ã€ç¬¬ä¸‰æ­¥ã€‘`bean` ï¼Œååºåˆ—åŒ–ç»“æœï¼ŒJavaBeanDescriptor => ç»“æœ
55: if (ProtocolUtils.isBeanGenericSerialization(generic)) {
56: if (value == null) {
57: return new RpcResult(null);
58: } else if (value instanceof JavaBeanDescriptor) {
59: return new RpcResult(JavaBeanSerializeUtil.deserialize((JavaBeanDescriptor) value));
60: } else { // å¿…é¡»æ˜¯ JavaBeanDescriptor è¿”å›
61: throw new RpcException(
62: new StringBuilder(64)
63: .append("The type of result value is ")
64: .append(value.getClass().getName())
65: .append(" other than ")
66: .append(JavaBeanDescriptor.class.getName())
67: .append(", and the result is ")
68: .append(value).toString());
69: }
70: } else {
71: // è·å¾—å¯¹åº”çš„æ–¹æ³• Method å¯¹è±¡
72: Method method = invoker.getInterface().getMethod(methodName, parameterTypes);
73: //ã€ç¬¬ä¸‰æ­¥ã€‘`true` ï¼Œååºåˆ—åŒ–ç»“æœï¼Œä»…æœ‰ Map => POJO
74: return new RpcResult(PojoUtils.realize(value, method.getReturnType(), method.getGenericReturnType()));
75: }
76: } catch (NoSuchMethodException e) {
77: throw new RpcException(e.getMessage(), e);
78: }
79: // ã€ç¬¬ä¸‰æ­¥ã€‘ååºåˆ—åŒ–å¼‚å¸¸ç»“æœ
80: } else if (result.getException() instanceof GenericException) {
81: GenericException exception = (GenericException) result.getException();
82: try {
83: String className = exception.getExceptionClass();
84: Class<?> clazz = ReflectUtils.forName(className);
85: Throwable targetException = null;
86: Throwable lastException = null;
87: // åˆ›å»ºåŸå§‹å¼‚å¸¸
88: try {
89: targetException = (Throwable) clazz.newInstance();
90: } catch (Throwable e) {
91: lastException = e;
92: for (Constructor<?> constructor : clazz.getConstructors()) {
93: try {
94: targetException = (Throwable) constructor.newInstance(new Object[constructor.getParameterTypes().length]);
95: break;
96: } catch (Throwable e1) {
97: lastException = e1;
98: }
99: }
100: }
101: // è®¾ç½®å¼‚å¸¸çš„æ˜ç»†
102: if (targetException != null) {
103: try {
104: Field field = Throwable.class.getDeclaredField("detailMessage");
105: if (!field.isAccessible()) {
106: field.setAccessible(true);
107: }
108: field.set(targetException, exception.getExceptionMessage());
109: } catch (Throwable e) {
110: logger.warn(e.getMessage(), e);
111: }
112: // åˆ›å»ºæ–°çš„å¼‚å¸¸ RpcResult å¯¹è±¡
113: result = new RpcResult(targetException);
114: // åˆ›å»ºåŸå§‹å¼‚å¸¸å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸
115: } else if (lastException != null) {
116: throw lastException;
117: }
118: } catch (Throwable e) { // è‹¥å‘ç”Ÿå¼‚å¸¸ï¼ŒåŒ…è£…æˆ RpcException å¼‚å¸¸ï¼ŒæŠ›å‡ºã€‚
119: throw new RpcException("Can not deserialize exception " + exception.getExceptionClass() + ", message: " + exception.getExceptionMessage(), e);
120: }
121: }
122: // è¿”å› RpcResult ç»“æœ
123: return result;
124: }
125:
126: // çœç•¥ä»£ç ....æ³›åŒ–å¼•ç”¨çš„è°ƒç”¨
127:
128: // æ™®é€šè°ƒç”¨
129: return invoker.invoke(invocation);
130: }
131:
132: // ... çœç•¥ getting/setting çš„æ–¹æ³•
133:
134: }
```

* æ•´ä½“ï¼Œå’Œ**æœåŠ¡æä¾›è€…**çš„ GenericFilter æœ‰ä¸€äº›**ç±»ä¼¼**ã€‚
* ä½¿ç”¨ Dubbo SPI Adaptive æœºåˆ¶ï¼Œ**è‡ªåŠ¨åŠ è½½**ï¼Œä»…é™**æœåŠ¡æ¶ˆè´¹è€…**ï¼Œå¹¶ä¸”æœ‰

generic
é…ç½®é¡¹ã€‚
* ç¬¬ 126 è¡Œï¼šçœç•¥**æ³›åŒ–å¼•ç”¨**çš„è°ƒç”¨ï¼Œåœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” è°ƒç”¨ç‰¹æ€§ï¼ˆäºŒï¼‰ä¹‹æ³›åŒ–å¼•ç”¨ã€‹](http://svip.iocoder.cn/Dubbo/rpc-feature-generic-reference) ä¸­ï¼Œè¯¦ç»†è§£æã€‚
* ç¬¬ 129 è¡Œï¼šè‹¥æ˜¯æ™®é€šè°ƒç”¨( **éæ³›åŒ–å¼•ç”¨çš„è°ƒç”¨** )ï¼Œè°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼Œç»§ç»­è¿‡æ»¤é“¾çš„è°ƒç”¨ï¼Œæœ€ç»ˆè°ƒç”¨ Service æœåŠ¡ã€‚
* ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ­£æˆ ğŸ‘‡ğŸ‘‡ğŸ‘‡
* ç¬¬ 14 è‡³ 16 è¡Œï¼šåˆ¤æ–­æ˜¯**æ³›åŒ–å®ç°**çš„è°ƒç”¨
* ç¬¬ 22 è‡³ 26 è¡Œï¼šè·å¾—**å‚æ•°ç±»å‹**æ•°ç»„ã€‚
* ========== ã€ç¬¬ä¸€æ­¥ï¼šåºåˆ—åŒ–å‚æ•°ã€‘ ==========
* ç¬¬ 29 è‡³ 34 è¡Œï¼š

generic = bean
ï¼Œè°ƒç”¨

JavaBeanSerializeUtil/#serialize(JavaBeanDescriptor)
æ–¹æ³•ï¼Œåºåˆ—åŒ–å‚æ•°ï¼Œå³

æ–¹æ³•å‚æ•° => JavaBeanDescriptor
ã€‚
* ç¬¬ 35 è‡³ 38 è¡Œï¼š

generic = true
ï¼Œè°ƒç”¨ [
PojoUtils/#generalize(Object[] objs
](https://github.com/YunaiV/dubbo/blob/f83e70b53389a064e49babe32e61a5648002a44a/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/PojoUtils.java#L63-L69) æ–¹æ³•ï¼Œåºåˆ—åŒ–å‚æ•°ï¼Œä»…æœ‰

POJO => Map
ã€‚
* ========== ã€ç¬¬äºŒæ­¥ï¼šRPC è°ƒç”¨ã€‘ ==========
* ç¬¬ 41 è¡Œï¼šè®¾ç½® RpcInvocation çš„æ–¹æ³•åä¸º

$invoke
ã€‚
* ç¬¬ 42 è¡Œï¼šè®¾ç½® RpcInvocation çš„æ–¹æ³•å‚æ•°ç±»å‹ä¸º

GENERIC_PARAMETER_TYPES
ã€‚
* ç¬¬ 43 è¡Œï¼šè®¾ç½® RpcInvocation çš„å‚æ•°æ•°ç»„ä¸º

methodName

types

types
ã€‚
* ç¬¬ 48 è¡Œï¼šé€šè¿‡å¦‚ä¸Šçš„ **RpcInvocation** çš„è®¾ç½®ï¼Œæˆ‘ä»¬è°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼Œå°±èƒ½ RPC è°ƒç”¨åˆ°**æ³›åŒ–å®ç°**çš„æœåŠ¡ã€‚
* ========== ã€ç¬¬ä¸‰æ­¥ï¼šååºåˆ—åŒ–**æ­£å¸¸**ç»“æœã€‘ ==========
* ç¬¬ 55 è‡³ 69 è¡Œï¼š

generic = bean
ï¼Œè°ƒç”¨

JavaBeanSerializeUtil/#serialize(JavaBeanDescriptor)
æ–¹æ³•ï¼Œååºåˆ—åŒ–ç»“æœï¼Œå³

JavaBeanDescriptor => POJO
ã€‚
* ç¬¬ 71 è‡³ 74 è¡Œï¼š

generic = true
ï¼Œè°ƒç”¨

PojoUtils/#realize(pojo, type, genericType)
æ–¹æ³•ï¼Œååºåˆ—åŒ–ç»“æœï¼Œä»…æœ‰

Map => POJO
ã€‚
* **æ³¨æ„**ï¼Œååºåˆ—å®Œï¼Œæ˜¯ä¼šåˆ›å»º**æ–°çš„** RpcResult ã€‚
* ========== ã€ç¬¬ä¸‰æ­¥ï¼šååºåˆ—åŒ–**å¼‚å¸¸**ç»“æœã€‘ ==========
* ç¬¬ 87 è‡³ 100 è¡Œï¼šæ ¹æ® GenericException å¼‚å¸¸ï¼Œåˆ›å»º**åŸå§‹**å¼‚å¸¸

targetException
ã€‚
* ç¬¬ 101 è‡³ 111 è¡Œï¼šè®¾ç½®å¼‚å¸¸æ˜ç»†åˆ°

targetException
ã€‚
* ç¬¬ 113 è¡Œï¼šåˆ›å»º**æ–°çš„**å¼‚å¸¸ RpcResult å¯¹è±¡ã€‚
* ç¬¬ 114 è‡³ 117 è¡Œï¼šåˆ›å»ºåŸå§‹å¼‚å¸¸å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸

lastException
ã€‚