<header class="article-header">
<h1 class="article-title">çº¿ç¨‹æ± </h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>åœ¨&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/thread-model.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; çº¿ç¨‹æ¨¡å‹ã€‹</a>&nbsp;ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Dubbo æä¾›äº†<strong>ä¸‰ç§çº¿ç¨‹æ± çš„å®ç°</strong>ï¼š</p>
<blockquote>
<p>ThreadPool</p>
<ul>
<li><code>fixed</code>&nbsp;å›ºå®šå¤§å°çº¿ç¨‹æ± ï¼Œå¯åŠ¨æ—¶å»ºç«‹çº¿ç¨‹ï¼Œä¸å…³é—­ï¼Œä¸€ç›´æŒæœ‰ã€‚(<strong>ç¼ºçœ</strong>)</li>
<li><code>cached</code>&nbsp;ç¼“å­˜çº¿ç¨‹æ± ï¼Œç©ºé—²ä¸€åˆ†é’Ÿè‡ªåŠ¨åˆ é™¤ï¼Œéœ€è¦æ—¶é‡å»ºã€‚</li>
<li><code>limited</code>&nbsp;å¯ä¼¸ç¼©çº¿ç¨‹æ± ï¼Œä½†æ± ä¸­çš„çº¿ç¨‹æ•°åªä¼šå¢é•¿ä¸ä¼šæ”¶ç¼©ã€‚åªå¢é•¿ä¸æ”¶ç¼©çš„ç›®çš„æ˜¯ä¸ºäº†é¿å…æ”¶ç¼©æ—¶çªç„¶æ¥äº†å¤§æµé‡å¼•èµ·çš„æ€§èƒ½é—®é¢˜ã€‚</li>
</ul>
</blockquote>
<p>åœ¨&nbsp;<a href="https://github.com/apache/incubator-dubbo/tree/master/dubbo-common" target="_blank" rel="external nofollow noopener noreferrer"><code>dubbo-common</code></a>&nbsp;æ¨¡å—çš„&nbsp;<code>threadpool</code>&nbsp;åŒ…ä¸‹å®ç°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_03_05/01.png" alt="threadpool" /></p>
<h1 id="2-ThreadPool">2. ThreadPool</h1>
<p><a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-common/src/main/java/com/alibaba/dubbo/common/threadpool/ThreadPool.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.common.threadpool.ThreadPool</code></a>&nbsp;ï¼Œçº¿ç¨‹æ± æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@SPI</span>(<span class="string">"fixed"</span>)</span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ThreadPool</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Thread pool</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> url URL contains thread parameter</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> thread pool</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="meta">@Adaptive</span>({Constants.THREADPOOL_KEY})</span><br /><span class="line">    <span class="function">Executor <span class="title">getExecutor</span><span class="params">(URL url)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>@SPI("fixed")</code>&nbsp;æ³¨è§£ï¼ŒDubbo SPI&nbsp;<strong>æ‹“å±•ç‚¹</strong>ï¼Œé»˜è®¤ä¸º&nbsp;<code>"fixed"</code>&nbsp;ã€‚</li>
<li><code>@Adaptive({Constants.THREADPOOL_KEY})</code>&nbsp;æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„çº¿ç¨‹æ± å®ç°ï¼Œä½¿ç”¨&nbsp;<code>URL.threadpool</code>&nbsp;å±æ€§ã€‚
<ul>
<li><code>#getExecutor(url)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—<strong>å¯¹åº”</strong>çš„çº¿ç¨‹æ± çš„æ‰§è¡Œå™¨ã€‚</li>
</ul>
</li>
</ul>
<p>å­ç±»ç±»å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_03_05/02.png" alt="ç±»å›¾" /></p>
<h2 id="2-1-FixedThreadPool">2.1 FixedThreadPool</h2>
<p><code>com.alibaba.dubbo.common.threadpool.support.fixed.FixedThreadPool</code>&nbsp;ï¼Œå®ç° ThreadPool æ¥å£ï¼Œå›ºå®šå¤§å°çº¿ç¨‹æ± ï¼Œå¯åŠ¨æ—¶å»ºç«‹çº¿ç¨‹ï¼Œä¸å…³é—­ï¼Œä¸€ç›´æŒæœ‰ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FixedThreadPool</span> <span class="keyword">implements</span> <span class="title">ThreadPool</span> </span>{</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>:     <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="function"><span class="keyword">public</span> Executor <span class="title">getExecutor</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line"> <span class="number">5</span>:         <span class="comment">// çº¿ç¨‹å</span></span><br /><span class="line"> <span class="number">6</span>:         String name = url.getParameter(Constants.THREAD_NAME_KEY, Constants.DEFAULT_THREAD_NAME);</span><br /><span class="line"> <span class="number">7</span>:         <span class="comment">// çº¿ç¨‹æ•°</span></span><br /><span class="line"> <span class="number">8</span>:         <span class="keyword">int</span> threads = url.getParameter(Constants.THREADS_KEY, Constants.DEFAULT_THREADS);</span><br /><span class="line"> <span class="number">9</span>:         <span class="comment">// é˜Ÿåˆ—æ•°</span></span><br /><span class="line"><span class="number">10</span>:         <span class="keyword">int</span> queues = url.getParameter(Constants.QUEUES_KEY, Constants.DEFAULT_QUEUES);</span><br /><span class="line"><span class="number">11</span>:         <span class="comment">// åˆ›å»ºæ‰§è¡Œå™¨</span></span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(threads, threads, <span class="number">0</span>, TimeUnit.MILLISECONDS,</span><br /><span class="line"><span class="number">13</span>:                 queues == <span class="number">0</span> ? <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;() :</span><br /><span class="line"><span class="number">14</span>:                         (queues &lt; <span class="number">0</span> ? <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;()</span><br /><span class="line"><span class="number">15</span>:                                 : <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(queues)),</span><br /><span class="line"><span class="number">16</span>:                 <span class="keyword">new</span> NamedThreadFactory(name, <span class="keyword">true</span>), <span class="keyword">new</span> AbortPolicyWithReport(name, url));</span><br /><span class="line"><span class="number">17</span>:     }</span><br /><span class="line"><span class="number">18</span>: </span><br /><span class="line"><span class="number">19</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ç¬¬ 5 è‡³ 10 è¡Œï¼šè·å¾—çº¿ç¨‹åã€çº¿ç¨‹æ•°ã€é˜Ÿåˆ—æ•°ã€‚ç›®å‰åªæœ‰æœåŠ¡æä¾›è€…ä½¿ç”¨ï¼Œé…ç½®æ–¹å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">"com.alibaba.dubbo.demo.DemoService"</span> <span class="attr">ref</span>=<span class="string">"demoService"</span>&gt;</span></span><br />    <br /><span class="line">    <span class="tag">&lt;<span class="name">dubbo:parameter</span> <span class="attr">key</span>=<span class="string">"threadname"</span> <span class="attr">value</span>=<span class="string">"shuaiqi"</span> /&gt;</span></span><br /><span class="line">    <span class="tag">&lt;<span class="name">dubbo:parameter</span> <span class="attr">key</span>=<span class="string">"threads"</span> <span class="attr">value</span>=<span class="string">"123"</span> /&gt;</span></span><br /><span class="line">    <span class="tag">&lt;<span class="name">dubbo:parameter</span> <span class="attr">key</span>=<span class="string">"queues"</span> <span class="attr">value</span>=<span class="string">"10"</span> /&gt;</span></span><br /><br /><span class="line"><span class="tag">&lt;/<span class="name">dubbo:service</span>&gt;</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<ul>
<li>ç¬¬ 11 è‡³ 16 è¡Œï¼šåˆ›å»ºæ‰§è¡Œå™¨ ThreadPoolExecutor å¯¹è±¡ã€‚
<ul>
<li>æ ¹æ®ä¸åŒçš„é˜Ÿåˆ—æ•°ï¼Œä½¿ç”¨ä¸åŒçš„é˜Ÿåˆ—å®ç°ï¼š
<ul>
<li>ç¬¬ 13 è¡Œï¼š&nbsp;<code>queues == 0</code>&nbsp;ï¼Œ SynchronousQueue å¯¹è±¡ã€‚</li>
<li>ç¬¬ 14 è¡Œï¼š<code>queues &lt; 0</code>&nbsp;ï¼Œ LinkedBlockingQueue å¯¹è±¡ã€‚</li>
<li>ç¬¬ 15 è¡Œï¼š<code>queues &gt; 0</code>&nbsp;ï¼Œå¸¦é˜Ÿåˆ—æ•°çš„ LinkedBlockingQueue å¯¹è±¡ã€‚</li>
</ul>
</li>
<li>æ¨èé˜…è¯»ï¼š
<ul>
<li><a href="http://ifeve.com/java-synchronousqueue/" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠJavaå¹¶å‘åŒ…ä¸­çš„åŒæ­¥é˜Ÿåˆ—SynchronousQueueå®ç°åŸç†ã€‹</a></li>
<li><a href="https://fangjian0423.github.io/2016/05/10/java-arrayblockingqueue-linkedblockingqueue-analysis/" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠJavaé˜»å¡é˜Ÿåˆ—ArrayBlockingQueueå’ŒLinkedBlockingQueueå®ç°åŸç†åˆ†æã€‹</a></li>
<li><a href="http://www.infoq.com/cn/articles/java-threadPool" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠèŠèŠå¹¶å‘ï¼ˆä¸‰ï¼‰&mdash;&mdash;JAVAçº¿ç¨‹æ± çš„åˆ†æå’Œä½¿ç”¨ã€‹</a></li>
<li><a href="http://www.infoq.com/cn/articles/java-blocking-queue" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠèŠèŠå¹¶å‘ï¼ˆä¸ƒï¼‰&mdash;&mdash;Javaä¸­çš„é˜»å¡é˜Ÿåˆ—ã€‹</a></li>
</ul>
</li>
<li>ç¬¬ 16 è¡Œï¼šåˆ›å»º&nbsp;<a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/NamedThreadFactory.java" target="_blank" rel="external nofollow noopener noreferrer">NamedThreadFactory</a>&nbsp;å¯¹è±¡ï¼Œç”¨äºç”Ÿæˆ<strong>çº¿ç¨‹å</strong>ã€‚</li>
<li>ç¬¬ 16 è¡Œï¼šåˆ›å»º AbortPolicyWithReport å¯¹è±¡ï¼Œç”¨äº<strong>å½“ä»»åŠ¡æ·»åŠ åˆ°çº¿ç¨‹æ± ä¸­è¢«æ‹’ç»æ—¶</strong>ã€‚</li>
</ul>
</li>
</ul>
<h2 id="2-2-CachedThreadPool">2.2 CachedThreadPool</h2>
<p><code>com.alibaba.dubbo.common.threadpool.support.cached.CachedThreadPool</code>&nbsp;ï¼Œå®ç° ThreadPool æ¥å£ï¼Œç¼“å­˜çº¿ç¨‹æ± ï¼Œç©ºé—²ä¸€å®šæ—¶é•¿ï¼Œè‡ªåŠ¨åˆ é™¤ï¼Œéœ€è¦æ—¶é‡å»ºã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CachedThreadPool</span> <span class="keyword">implements</span> <span class="title">ThreadPool</span> </span>{</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>:     <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="function"><span class="keyword">public</span> Executor <span class="title">getExecutor</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line"> <span class="number">5</span>:         <span class="comment">// çº¿ç¨‹æ± å</span></span><br /><span class="line"> <span class="number">6</span>:         String name = url.getParameter(Constants.THREAD_NAME_KEY, Constants.DEFAULT_THREAD_NAME);</span><br /><span class="line"> <span class="number">7</span>:         <span class="comment">// æ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br /><span class="line"> <span class="number">8</span>:         <span class="keyword">int</span> cores = url.getParameter(Constants.CORE_THREADS_KEY, Constants.DEFAULT_CORE_THREADS);</span><br /><span class="line"> <span class="number">9</span>:         <span class="comment">// æœ€å¤§çº¿ç¨‹æ•°</span></span><br /><span class="line"><span class="number">10</span>:         <span class="keyword">int</span> threads = url.getParameter(Constants.THREADS_KEY, Integer.MAX_VALUE);</span><br /><span class="line"><span class="number">11</span>:         <span class="comment">// é˜Ÿåˆ—æ•°</span></span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">int</span> queues = url.getParameter(Constants.QUEUES_KEY, Constants.DEFAULT_QUEUES);</span><br /><span class="line"><span class="number">13</span>:         <span class="comment">// çº¿ç¨‹å­˜æ´»æ—¶é•¿</span></span><br /><span class="line"><span class="number">14</span>:         <span class="keyword">int</span> alive = url.getParameter(Constants.ALIVE_KEY, Constants.DEFAULT_ALIVE);</span><br /><span class="line"><span class="number">15</span>:         <span class="comment">// åˆ›å»ºæ‰§è¡Œå™¨</span></span><br /><span class="line"><span class="number">16</span>:         <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(cores, threads, alive, TimeUnit.MILLISECONDS,</span><br /><span class="line"><span class="number">17</span>:                 queues == <span class="number">0</span> ? <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;() :</span><br /><span class="line"><span class="number">18</span>:                         (queues &lt; <span class="number">0</span> ? <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;()</span><br /><span class="line"><span class="number">19</span>:                                 : <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(queues)),</span><br /><span class="line"><span class="number">20</span>:                 <span class="keyword">new</span> NamedThreadFactory(name, <span class="keyword">true</span>), <span class="keyword">new</span> AbortPolicyWithReport(name, url));</span><br /><span class="line"><span class="number">21</span>:     }</span><br /><span class="line"><span class="number">22</span>: </span><br /><span class="line"><span class="number">23</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 5 è‡³ 14 è¡Œï¼šè·å¾—çº¿ç¨‹åã€æ ¸å¿ƒçº¿ç¨‹æ•°ã€æœ€å¤§çº¿ç¨‹æ•°ã€é˜Ÿåˆ—æ•°ã€çº¿ç¨‹å­˜æ´»æ—¶é•¿ã€‚
<ul>
<li>ğŸ™‚ é…ç½®æ–¹å¼å’Œ FixedThreadPool ç±»ä¼¼ï¼Œä½¿ç”¨&nbsp;<code>&lt;dubbo:parameter /&gt;</code>&nbsp;é…ç½®ã€‚</li>
</ul>
</li>
<li>ç¬¬ 16 è‡³ 20 è¡Œï¼šåˆ›å»ºæ‰§è¡Œå™¨ ThreadPoolExecutor å¯¹è±¡ã€‚
<ul>
<li>ğŸ™‚ å’Œ FixedThreadPool ç›¸å¯¹ç±»ä¼¼ã€‚</li>
</ul>
</li>
</ul>
<h2 id="2-3-LimitedThreadPool">2.3 LimitedThreadPool</h2>
<p><code>com.alibaba.dubbo.common.threadpool.support.limited.LimitedThreadPool</code>&nbsp;ï¼Œå®ç° ThreadPool æ¥å£ï¼Œå¯ä¼¸ç¼©çº¿ç¨‹æ± ï¼Œä½†æ± ä¸­çš„çº¿ç¨‹æ•°åªä¼šå¢é•¿ä¸ä¼šæ”¶ç¼©ã€‚åªå¢é•¿ä¸æ”¶ç¼©çš„ç›®çš„æ˜¯ä¸ºäº†é¿å…æ”¶ç¼©æ—¶çªç„¶æ¥äº†å¤§æµé‡å¼•èµ·çš„æ€§èƒ½é—®é¢˜ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LimitedThreadPool</span> <span class="keyword">implements</span> <span class="title">ThreadPool</span> </span>{</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>:     <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="function"><span class="keyword">public</span> Executor <span class="title">getExecutor</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line"> <span class="number">5</span>:         <span class="comment">// çº¿ç¨‹å</span></span><br /><span class="line"> <span class="number">6</span>:         String name = url.getParameter(Constants.THREAD_NAME_KEY, Constants.DEFAULT_THREAD_NAME);</span><br /><span class="line"> <span class="number">7</span>:         <span class="comment">// æ ¸å¿ƒçº¿ç¨‹æ•°</span></span><br /><span class="line"> <span class="number">8</span>:         <span class="keyword">int</span> cores = url.getParameter(Constants.CORE_THREADS_KEY, Constants.DEFAULT_CORE_THREADS);</span><br /><span class="line"> <span class="number">9</span>:         <span class="comment">// æœ€å¤§çº¿ç¨‹æ•°</span></span><br /><span class="line"><span class="number">10</span>:         <span class="keyword">int</span> threads = url.getParameter(Constants.THREADS_KEY, Constants.DEFAULT_THREADS);</span><br /><span class="line"><span class="number">11</span>:         <span class="comment">// é˜Ÿåˆ—æ•°</span></span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">int</span> queues = url.getParameter(Constants.QUEUES_KEY, Constants.DEFAULT_QUEUES);</span><br /><span class="line"><span class="number">13</span>:         <span class="comment">// åˆ›å»ºæ‰§è¡Œå™¨</span></span><br /><span class="line"><span class="number">14</span>:         <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(cores, threads, Long.MAX_VALUE, TimeUnit.MILLISECONDS,</span><br /><span class="line"><span class="number">15</span>:                 queues == <span class="number">0</span> ? <span class="keyword">new</span> SynchronousQueue&lt;Runnable&gt;() :</span><br /><span class="line"><span class="number">16</span>:                         (queues &lt; <span class="number">0</span> ? <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;()</span><br /><span class="line"><span class="number">17</span>:                                 : <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(queues)),</span><br /><span class="line"><span class="number">18</span>:                 <span class="keyword">new</span> NamedThreadFactory(name, <span class="keyword">true</span>), <span class="keyword">new</span> AbortPolicyWithReport(name, url));</span><br /><span class="line"><span class="number">19</span>:     }</span><br /><span class="line"><span class="number">20</span>: </span><br /><span class="line"><span class="number">21</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å’Œ CachedThreadPool å®ç°æ˜¯åŸºæœ¬ä¸€è‡´çš„ï¼Œå·®å¼‚ç‚¹åœ¨&nbsp;<code>alive == Integer.MAX_VALUE</code>&nbsp;ï¼Œ<strong>ç©ºé—²æ—¶é—´æ— é™å¤§</strong>ï¼Œå³ä¸ä¼šè‡ªåŠ¨åˆ é™¤ã€‚</li>
</ul>
<h1 id="3-AbortPolicyWithReport">3. AbortPolicyWithReport</h1>
<p><code>com.alibaba.dubbo.common.threadpool.support.AbortPolicyWithReport</code>&nbsp;ï¼Œå®ç°&nbsp;<code>java.util.concurrent.ThreadPoolExecutor.AbortPolicy</code>&nbsp;ï¼Œæ‹’ç»ç­–ç•¥å®ç°ç±»ã€‚<strong>æ‰“å° JStack ï¼Œåˆ†æçº¿ç¨‹çŠ¶æ€</strong>ã€‚</p>
<h2 id="3-1-å±æ€§">3.1 å±æ€§</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * çº¿ç¨‹å</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String threadName;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * URL å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æœ€åæ‰“å°æ—¶é—´</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastPrintTime = <span class="number">0</span>;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ä¿¡å·é‡ï¼Œå¤§å°ä¸º 1 ã€‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Semaphore guard = <span class="keyword">new</span> Semaphore(<span class="number">1</span>);</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbortPolicyWithReport</span><span class="params">(String threadName, URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.threadName = threadName;</span><br /><span class="line">    <span class="keyword">this</span>.url = url;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="3-2-rejectedExecution">3.2 rejectedExecution</h2>
<p><code>#rejectedExecution(Runnable, ThreadPoolExecutor)</code>&nbsp;<strong>å®ç°</strong>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor e)</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// æ‰“å°å‘Šè­¦æ—¥å¿—</span></span><br /><span class="line"> <span class="number">4</span>:     String msg = String.format(<span class="string">"Thread pool is EXHAUSTED!"</span> +</span><br /><span class="line"> <span class="number">5</span>:                     <span class="string">" Thread Name: %s, Pool Size: %d (active: %d, core: %d, max: %d, largest: %d), Task: %d (completed: %d),"</span> +</span><br /><span class="line"> <span class="number">6</span>:                     <span class="string">" Executor status:(isShutdown:%s, isTerminated:%s, isTerminating:%s), in %s://%s:%d!"</span>,</span><br /><span class="line"> <span class="number">7</span>:             threadName, e.getPoolSize(), e.getActiveCount(), e.getCorePoolSize(), e.getMaximumPoolSize(), e.getLargestPoolSize(),</span><br /><span class="line"> <span class="number">8</span>:             e.getTaskCount(), e.getCompletedTaskCount(), e.isShutdown(), e.isTerminated(), e.isTerminating(),</span><br /><span class="line"> <span class="number">9</span>:             url.getProtocol(), url.getIp(), url.getPort());</span><br /><span class="line"><span class="number">10</span>:     logger.warn(msg);</span><br /><span class="line"><span class="number">11</span>:     <span class="comment">// æ‰“å° JStack ï¼Œåˆ†æçº¿ç¨‹çŠ¶æ€ã€‚</span></span><br /><span class="line"><span class="number">12</span>:     dumpJStack();</span><br /><span class="line"><span class="number">13</span>:     <span class="comment">// æŠ›å‡º RejectedExecutionException å¼‚å¸¸</span></span><br /><span class="line"><span class="number">14</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> RejectedExecutionException(msg);</span><br /><span class="line"><span class="number">15</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è‡³ 10 è¡Œï¼šæ‰“å°<strong>å‘Šè­¦æ—¥å¿—</strong>ã€‚</li>
<li>ç¬¬ 12 è¡Œï¼šè°ƒç”¨&nbsp;<code>#dumpJStack()</code>&nbsp;æ–¹æ³•ï¼Œæ‰“å°&nbsp;<strong>JStack</strong>&nbsp;ï¼Œåˆ†æçº¿ç¨‹çŠ¶æ€ã€‚</li>
<li>ç¬¬ 14 è¡Œï¼šæŠ›å‡º RejectedExecutionException å¼‚å¸¸ã€‚</li>
</ul>
<h2 id="3-3-dumpJStack">3.3 dumpJStack</h2>
<p><code>#dumpJStack()</code>&nbsp;æ–¹æ³•ï¼Œæ‰“å° JStackã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">dumpJStack</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="keyword">long</span> now = System.currentTimeMillis();</span><br /><span class="line"> <span class="number">3</span>: </span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// æ¯ 10 åˆ†é’Ÿï¼Œæ‰“å°ä¸€æ¬¡ã€‚</span></span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// dump every 10 minutes</span></span><br /><span class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (now - lastPrintTime &lt; <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000</span>) {</span><br /><span class="line"> <span class="number">7</span>:         <span class="keyword">return</span>;</span><br /><span class="line"> <span class="number">8</span>:     }</span><br /><span class="line"> <span class="number">9</span>: </span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// è·å¾—ä¿¡å·é‡</span></span><br /><span class="line"><span class="number">11</span>:     <span class="keyword">if</span> (!guard.tryAcquire()) {</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">13</span>:     }</span><br /><span class="line"><span class="number">14</span>: </span><br /><span class="line"><span class="number">15</span>:     <span class="comment">// åˆ›å»ºçº¿ç¨‹æ± ï¼Œåå°æ‰§è¡Œæ‰“å° JStack</span></span><br /><span class="line"><span class="number">16</span>:     Executors.newSingleThreadExecutor().execute(<span class="keyword">new</span> Runnable() {</span><br /><span class="line"><span class="number">17</span>:         <span class="meta">@Override</span></span><br /><span class="line"><span class="number">18</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">19</span>: </span><br /><span class="line"><span class="number">20</span>:             <span class="comment">// è·å¾—ç³»ç»Ÿ</span></span><br /><span class="line"><span class="number">21</span>:             String OS = System.getProperty(<span class="string">"os.name"</span>).toLowerCase();</span><br /><span class="line"><span class="number">22</span>:             <span class="comment">// è·å¾—è·¯å¾„</span></span><br /><span class="line"><span class="number">23</span>:             String dumpPath = url.getParameter(Constants.DUMP_DIRECTORY, System.getProperty(<span class="string">"user.home"</span>));</span><br /><span class="line"><span class="number">24</span>:             SimpleDateFormat sdf;</span><br /><span class="line"><span class="number">25</span>:             <span class="comment">// window system don't support ":" in file name</span></span><br /><span class="line"><span class="number">26</span>:             <span class="keyword">if</span>(OS.contains(<span class="string">"win"</span>)){</span><br /><span class="line"><span class="number">27</span>:                 sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd_HH-mm-ss"</span>);</span><br /><span class="line"><span class="number">28</span>:             }<span class="keyword">else</span> {</span><br /><span class="line"><span class="number">29</span>:                 sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd_HH:mm:ss"</span>);</span><br /><span class="line"><span class="number">30</span>:             }</span><br /><span class="line"><span class="number">31</span>:             String dateStr = sdf.format(<span class="keyword">new</span> Date());</span><br /><span class="line"><span class="number">32</span>:             <span class="comment">// è·å¾—è¾“å‡ºæµ</span></span><br /><span class="line"><span class="number">33</span>:             FileOutputStream jstackStream = <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">34</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">35</span>:                 jstackStream = <span class="keyword">new</span> FileOutputStream(<span class="keyword">new</span> File(dumpPath, <span class="string">"Dubbo_JStack.log"</span> + <span class="string">"."</span> + dateStr));</span><br /><span class="line"><span class="number">36</span>:                 <span class="comment">// æ‰“å° JStack</span></span><br /><span class="line"><span class="number">37</span>:                 JVMUtil.jstack(jstackStream);</span><br /><span class="line"><span class="number">38</span>:             } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">39</span>:                 logger.error(<span class="string">"dump jstack error"</span>, t);</span><br /><span class="line"><span class="number">40</span>:             } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">41</span>:                 <span class="comment">// é‡Šæ”¾ä¿¡å·é‡</span></span><br /><span class="line"><span class="number">42</span>:                 guard.release();</span><br /><span class="line"><span class="number">43</span>:                 <span class="comment">// é‡Šæ”¾è¾“å‡ºæµ</span></span><br /><span class="line"><span class="number">44</span>:                 <span class="keyword">if</span> (jstackStream != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">45</span>:                     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">46</span>:                         jstackStream.flush();</span><br /><span class="line"><span class="number">47</span>:                         jstackStream.close();</span><br /><span class="line"><span class="number">48</span>:                     } <span class="keyword">catch</span> (IOException e) {</span><br /><span class="line"><span class="number">49</span>:                     }</span><br /><span class="line"><span class="number">50</span>:                 }</span><br /><span class="line"><span class="number">51</span>:             }</span><br /><span class="line"><span class="number">52</span>:             <span class="comment">// è®°å½•æœ€åæ‰“å°æ—¶é—´</span></span><br /><span class="line"><span class="number">53</span>:             lastPrintTime = System.currentTimeMillis();</span><br /><span class="line"><span class="number">54</span>:         }</span><br /><span class="line"><span class="number">55</span>:     });</span><br /><span class="line"><span class="number">56</span>: </span><br /><span class="line"><span class="number">57</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 2 è‡³ 8 è¡Œï¼šæ¯ 10 åˆ†é’Ÿï¼Œ<strong>åª</strong>æ‰“å°ä¸€æ¬¡ã€‚</li>
<li>ç¬¬ 10 è‡³ 13 è¡Œï¼šè·å¾—ä¿¡å·é‡ã€‚ä¿è¯ï¼ŒåŒä¸€æ—¶é—´ï¼Œ<strong>æœ‰ä¸”ä»…æœ‰</strong>ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œæ‰“å°ã€‚</li>
<li>ç¬¬ 15 è‡³ 54 è¡Œï¼šåˆ›å»ºçº¿ç¨‹æ± ï¼Œ<strong>åå°</strong>æ‰§è¡Œæ‰“å° JStack ã€‚
<ul>
<li>ç¬¬ 20 è‡³ 31 è¡Œï¼šè·å¾—è·¯å¾„ã€‚</li>
<li>ç¬¬ 32 è‡³ 35 è¡Œï¼šè·å¾—æ–‡ä»¶è¾“å‡ºæµã€‚</li>
<li>ç¬¬ 37 è¡Œï¼šè°ƒç”¨&nbsp;<code>JVMUtil#jstack(OutputStream)</code>&nbsp;æ–¹æ³•ï¼Œæ‰“å° JStack ã€‚</li>
<li>ç¬¬ 42 è¡Œï¼šé‡Šæ”¾ä¿¡å·é‡ã€‚</li>
<li>ç¬¬ 44 è‡³ 50 è¡Œï¼šé‡Šæ”¾è¾“å‡ºæµã€‚</li>
<li>ç¬¬ 53 è¡Œï¼šè®°å½•æœ€åæ‰“å°æ—¶é—´ã€‚</li>
</ul>
</li>
</ul>
<h1 id="4-JVMUtil">4. JVMUtil</h1>
<p><a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/JVMUtil.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.common.utils.JVMUtil</code></a>&nbsp;ï¼ŒJVM å·¥å…·ç±»ã€‚ç›®å‰ï¼Œä»…æœ‰ JStack åŠŸèƒ½ï¼Œèƒ–å‹å¯ä»¥ç‚¹å‡»é“¾æ¥ï¼Œè‡ªå·±æŸ¥çœ‹ä¸‹ä»£ç ã€‚</p>
<p>å¦‚ä¸‹æ˜¯ä¸€ä¸ª JStack æ—¥å¿—çš„ç¤ºä¾‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="number">123312</span>:tmp yunai$ cat Dubbo_JStack.log.2018-<span class="number">03</span>-<span class="number">27_18</span>\:<span class="number">57</span>\:<span class="number">32</span></span><br /><span class="line"><span class="string">"pool-2-thread-1"</span> Id=<span class="number">11</span> RUNNABLE</span><br /><span class="line">	at sun.management.ThreadImpl.dumpThreads0(Native Method)</span><br /><span class="line">	at sun.management.ThreadImpl.dumpAllThreads(ThreadImpl.java:<span class="number">454</span>)</span><br /><span class="line">	at com.alibaba.dubbo.common.utils.JVMUtil.jstack(JVMUtil.java:<span class="number">34</span>)</span><br /><span class="line">	at com.alibaba.dubbo.common.threadpool.support.AbortPolicyWithReport$<span class="number">1</span>.run(AbortPolicyWithReport.java:<span class="number">122</span>)</span><br /><span class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:<span class="number">1142</span>)</span><br /><span class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:<span class="number">617</span>)</span><br /><span class="line">	at java.lang.Thread.run(Thread.java:<span class="number">745</span>)</span><br /><br /><span class="line">	Number of locked synchronizers = <span class="number">1</span></span><br /><span class="line">	- java.util.concurrent.ThreadPoolExecutor$Worker@<span class="number">5</span>cbc508c</span><br /><br /><span class="line"><span class="string">"Monitor Ctrl-Break"</span> Id=<span class="number">5</span> RUNNABLE (in <span class="keyword">native</span>)</span><br /><span class="line">	at java.net.SocketInputStream.socketRead0(Native Method)</span><br /><span class="line">	at java.net.SocketInputStream.socketRead(SocketInputStream.java:<span class="number">116</span>)</span><br /><span class="line">	at java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">171</span>)</span><br /><span class="line">	at java.net.SocketInputStream.read(SocketInputStream.java:<span class="number">141</span>)</span><br /><span class="line">	at sun.nio.cs.StreamDecoder.readBytes(StreamDecoder.java:<span class="number">284</span>)</span><br /><span class="line">	at sun.nio.cs.StreamDecoder.implRead(StreamDecoder.java:<span class="number">326</span>)</span><br /><span class="line">	at sun.nio.cs.StreamDecoder.read(StreamDecoder.java:<span class="number">178</span>)</span><br /><span class="line">	-  locked java.io.InputStreamReader@<span class="number">5</span>c7efb52</span><br /><span class="line">	at java.io.InputStreamReader.read(InputStreamReader.java:<span class="number">184</span>)</span><br /><span class="line">	at java.io.BufferedReader.fill(BufferedReader.java:<span class="number">161</span>)</span><br /><span class="line">	at java.io.BufferedReader.readLine(BufferedReader.java:<span class="number">324</span>)</span><br /><span class="line">	-  locked java.io.InputStreamReader@<span class="number">5</span>c7efb52</span><br /><span class="line">	at java.io.BufferedReader.readLine(BufferedReader.java:<span class="number">389</span>)</span><br /><span class="line">	at com.intellij.rt.execution.application.AppMainV2$<span class="number">1</span>.run(AppMainV2.java:<span class="number">64</span>)</span><br /><br /><span class="line"><span class="string">"Signal Dispatcher"</span> Id=<span class="number">4</span> RUNNABLE</span><br /><br /><span class="line"><span class="string">"Finalizer"</span> Id=<span class="number">3</span> WAITING on java.lang.ref.ReferenceQueue$Lock@<span class="number">197</span>c6eb9</span><br /><span class="line">	at java.lang.Object.wait(Native Method)</span><br /><span class="line">	-  waiting on java.lang.ref.ReferenceQueue$Lock@<span class="number">197</span>c6eb9</span><br /><span class="line">	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:<span class="number">143</span>)</span><br /><span class="line">	at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:<span class="number">164</span>)</span><br /><span class="line">	at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:<span class="number">209</span>)</span><br /><br /><span class="line"><span class="string">"Reference Handler"</span> Id=<span class="number">2</span> WAITING on java.lang.ref.Reference$Lock@<span class="number">7</span>b19fa34</span><br /><span class="line">	at java.lang.Object.wait(Native Method)</span><br /><span class="line">	-  waiting on java.lang.ref.Reference$Lock@<span class="number">7</span>b19fa34</span><br /><span class="line">	at java.lang.Object.wait(Object.java:<span class="number">502</span>)</span><br /><span class="line">	at java.lang.ref.Reference.tryHandlePending(Reference.java:<span class="number">191</span>)</span><br /><span class="line">	at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:<span class="number">153</span>)</span><br /><br /><span class="line"><span class="string">"main"</span> Id=<span class="number">1</span> TIMED_WAITING</span><br /><span class="line">	at java.lang.Thread.sleep(Native Method)</span><br /><span class="line">	at com.alibaba.dubbo.common.threadpool.AbortPolicyWithReportTest.jStackDumpTest(AbortPolicyWithReportTest.java:<span class="number">44</span>)</span><br /><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br /><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</span><br /><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br /><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br /><span class="line">	at org.junit.runners.model.FrameworkMethod$<span class="number">1</span>.runReflectiveCall(FrameworkMethod.java:<span class="number">50</span>)</span><br /><span class="line">	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:<span class="number">12</span>)</span><br /><span class="line">	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:<span class="number">47</span>)</span><br /><span class="line">	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:<span class="number">17</span>)</span><br /><span class="line">	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:<span class="number">325</span>)</span><br /><span class="line">	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:<span class="number">78</span>)</span><br /><span class="line">	at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:<span class="number">57</span>)</span><br /><span class="line">	at org.junit.runners.ParentRunner$<span class="number">3</span>.run(ParentRunner.java:<span class="number">290</span>)</span><br /><span class="line">	at org.junit.runners.ParentRunner$<span class="number">1</span>.schedule(ParentRunner.java:<span class="number">71</span>)</span><br /><span class="line">	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:<span class="number">288</span>)</span><br /><span class="line">	at org.junit.runners.ParentRunner.access$<span class="number">000</span>(ParentRunner.java:<span class="number">58</span>)</span><br /><span class="line">	at org.junit.runners.ParentRunner$<span class="number">2</span>.evaluate(ParentRunner.java:<span class="number">268</span>)</span><br /><span class="line">	at org.junit.runners.ParentRunner.run(ParentRunner.java:<span class="number">363</span>)</span><br /><span class="line">	at org.junit.runner.JUnitCore.run(JUnitCore.java:<span class="number">137</span>)</span><br /><span class="line">	at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:<span class="number">68</span>)</span><br /><span class="line">	at com.intellij.rt.execution.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:<span class="number">47</span>)</span><br /><span class="line">	at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:<span class="number">242</span>)</span><br /><span class="line">	at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:<span class="number">70</span>)</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>å¦å¤–ï¼Œèƒ–å‹å¯ä»¥çœ‹çœ‹&nbsp;<a href="https://www.jianshu.com/p/6690f7e92f27" target="_blank" rel="external nofollow noopener noreferrer">ã€Šå¦‚ä½•ä½¿ç”¨jstackåˆ†æçº¿ç¨‹çŠ¶æ€ã€‹</a>&nbsp;æ–‡ç« ã€‚</p>
</div>