<header class="article-header">
<h1 class="article-title">æœåŠ¡è°ƒç”¨ï¼ˆäºŒï¼‰ä¹‹è¿œç¨‹è°ƒç”¨ï¼ˆDubboï¼‰ã€1ã€‘é€šä¿¡å®ç°</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>ä»æœ¬æ–‡å¼€å§‹ï¼Œæˆ‘ä»¬å¼€å§‹åˆ†äº«&nbsp;<code>dubbo://</code>&nbsp;åè®®çš„è¿œç¨‹è°ƒç”¨ï¼Œä¸»è¦åˆ†æˆ<strong>å››ä¸ªéƒ¨åˆ†</strong>ï¼š</p>
<ol>
<li>é€šä¿¡å®ç°</li>
<li>åŒæ­¥è°ƒç”¨</li>
<li>å¼‚æ­¥è°ƒç”¨</li>
<li>å‚æ•°å›è°ƒ</li>
</ol>
<p>æœ¬æ–‡åˆ†äº«&nbsp;<strong>é€šä¿¡å®ç°</strong>&nbsp;éƒ¨åˆ†ã€‚</p>
<p>ğŸ˜ˆ&nbsp;<a href="http://svip.iocoder.cn/Dubbo/rpc-dubbo-1-remoting/">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; NIO æœåŠ¡å™¨ã€‹</a>&nbsp;ç³»åˆ—ï¼Œæ˜¯æœ¬æ–‡çš„<strong>å‰ç½®æ–‡ç« </strong>ï¼Œæ‰€ä»¥èƒ–å‹éœ€è¦å…ˆè¯»å®Œè¿™ä¸ªç³»åˆ—ã€‚å“ˆå“ˆå“ˆï¼Œå½“ç„¶ï¼Œä¹Ÿå¯ä»¥å‡‘åˆçœ‹çœ‹å…ˆã€‚</p>
<p>æœ¬æ–‡æ¶‰åŠç±»å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_10_04/01_01.png" alt="ç±»å›¾" /></p>
<h1 id="2-Server">2. Server</h1>
<p>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/reference-export-dubbo/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡å¼•ç”¨ï¼ˆäºŒï¼‰ä¹‹è¿œç¨‹æš´éœ²ï¼ˆDubboï¼‰ã€‹</a>&nbsp;ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ä½¿ç”¨çš„ Server å®ç°ç±»æ˜¯&nbsp;<strong>HeaderExchangeServer</strong>&nbsp;ã€‚</p>
<h1 id="3-Client">3. Client</h1>
<p>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/reference-refer-dubbo/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡å¼•ç”¨ï¼ˆäºŒï¼‰ä¹‹è¿œç¨‹å¼•ç”¨ï¼ˆDubboï¼‰ã€‹</a>&nbsp;ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°ä½¿ç”¨çš„ Client å®ç°ç±»æ˜¯&nbsp;<strong>ReferenceCountExchangeClient</strong>&nbsp;å’Œ&nbsp;<strong>LazyConnectExchangeClient</strong>&nbsp;ã€‚</p>
<h1 id="4-ExchangeHandler">4. ExchangeHandler</h1>
<p>åœ¨ DubboProtocol ä¸­ï¼Œå®ç°äº† ExchangeHandler ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> ExchangeHandler requestHandler = <span class="keyword">new</span> ExchangeHandlerAdapter() {</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">reply</span><span class="params">(ExchangeChannel channel, Object message)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">        <span class="comment">// ... çœç•¥å…·ä½“å®ç°</span></span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">received</span><span class="params">(Channel channel, Object message)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">        <span class="comment">// ... çœç•¥å…·ä½“å®ç°</span></span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">        <span class="keyword">this</span>.invoke(channel, Constants.ON_CONNECT_KEY);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disconnected</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">        <span class="comment">// ... çœç•¥å…·ä½“å®ç°</span></span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Channel channel, String methodKey)</span> </span>{</span><br /><span class="line">        <span class="comment">// ... çœç•¥å…·ä½“å®ç°</span></span><br /><span class="line">    }</span><br /><br /><span class="line">};</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>è¿™ä¸ªå¤„ç†å™¨ï¼Œè´Ÿè´£å°†è¯·æ±‚ï¼Œ<strong>è½¬å‘åˆ°å¯¹åº”çš„ Invoker å¯¹è±¡</strong>ï¼Œæ‰§è¡Œé€»è¾‘ï¼Œè¿”å›ç»“æœã€‚<br />å½“ç„¶ï¼Œæœ¬æ–‡ä¸ç»†åˆ†äº«ï¼Œæ”¾åœ¨&nbsp;<strong>åŒæ­¥è°ƒç”¨</strong>&nbsp;ä¸€æ–‡è¯¦ç»†è§£æã€‚</p>
<h1 id="5-Codec">5. Codec</h1>
<p>åœ¨&nbsp;<a href="https://github.com/apache/incubator-dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/codec/ExchangeCodec.java" target="_blank" rel="external nofollow noopener noreferrer">ExchangeCodec</a>&nbsp;ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°å¯¹ Request å’Œ Response çš„<strong>é€šç”¨</strong>è§£æã€‚ä½†æ˜¯å®ƒæ˜¯<strong>ä¸æ»¡è¶³</strong>åœ¨&nbsp;<code>dubbo://</code>&nbsp;åè®®ä¸­ï¼Œå¯¹&nbsp;<a href="http://svip.iocoder.cn/Dubbo/rpc-dubbo-1-remoting/">RpcInvocation</a>&nbsp;å’Œ&nbsp;<a href="http://svip.iocoder.cn/Dubbo/rpc-dubbo-1-remoting/">RpcResult</a>&nbsp;ä½œä¸º&nbsp;<strong>å†…å®¹ä½“( Body )</strong>&nbsp;çš„ç¼–è§£ç çš„éœ€è¦çš„ã€‚</p>
<p>å¦å¤–ï¼Œåœ¨&nbsp;<code>dubbo://</code>&nbsp;åè®®ä¸­ï¼Œæ”¯æŒ&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/callback-parameter.html" target="_blank" rel="external nofollow noopener noreferrer">å‚æ•°å›è°ƒ</a>&nbsp;çš„ç‰¹æ€§ï¼Œä¹Ÿæ˜¯éœ€è¦åœ¨ç¼–è§£ç åšä¸€äº›<strong>ç‰¹æ®Šé€»è¾‘</strong>ã€‚</p>
<p>ä¸‹é¢ï¼Œè®©æˆ‘ä»¬æ¥ä¸€èµ·ç…ç…ä»£ç å®ç°å§ã€‚</p>
<h2 id="5-1-DubboCountCodec">5.1 DubboCountCodec</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-rpc/dubbo-rpc-default/src/main/java/com/alibaba/dubbo/rpc/protocol/dubbo/DubboCountCodec.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.rpc.protocol.dubbo.DubboCountCodec</code></a>&nbsp;ï¼Œå®ç° Codec2 æ¥å£ï¼Œæ”¯æŒ<strong>å¤šæ¶ˆæ¯</strong>çš„ç¼–è§£ç å™¨ã€‚</p>
<h3 id="5-1-1-æ„é€ æ–¹æ³•">5.1.1 æ„é€ æ–¹æ³•</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ç¼–è§£ç å™¨</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> DubboCodec codec = <span class="keyword">new</span> DubboCodec();</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>åœ¨ Dubbo Client å’Œ Server åˆ›å»ºçš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬çœ‹åˆ°è®¾ç½®äº†ç¼–è§£ç å™¨ä¸º&nbsp;<code>"dubbo"</code>&nbsp;ï¼Œä»è€Œé€šè¿‡ Dubbo SPI æœºåˆ¶ï¼ŒåŠ è½½åˆ° DubboCountCodec ã€‚ç›¸å…³å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboProtocol#createServer(...)</span></span><br /><span class="line">url = url.addParameter(Constants.CODEC_KEY, DubboCodec.NAME);</span><br /><br /><span class="line"><span class="comment">// DubboProtocol#initClient(...)</span></span><br /><span class="line">url = url.addParameter(Constants.CODEC_KEY, DubboCodec.NAME);</span><br /><br /><span class="line"><span class="comment">// META-INF/dubbo/internal/com.alibaba.dubbo.remoting.Codec2</span></span><br /><span class="line">dubbo=com.alibaba.dubbo.rpc.protocol.dubbo.DubboCountCodec</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>å®é™…ç¼–è§£ç çš„é€»è¾‘ï¼Œä½¿ç”¨ DubboCodec ï¼Œå³&nbsp;<code>codec</code>&nbsp;å±æ€§ã€‚</p>
</li>
</ul>
<h3 id="5-1-2-ç¼–ç ">5.1.2 ç¼–ç </h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(Channel channel, ChannelBuffer buffer, Object msg)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line">    codec.encode(channel, buffer, msg);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="5-1-3-è§£ç ">5.1.3 è§£ç </h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Object <span class="title">decode</span><span class="params">(Channel channel, ChannelBuffer buffer)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// è®°å½•å½“å‰è¯»ä½ç½®</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">int</span> save = buffer.readerIndex();</span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// åˆ›å»º MultiMessage å¯¹è±¡</span></span><br /><span class="line"> <span class="number">6</span>:     MultiMessage result = MultiMessage.create();</span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">do</span> {</span><br /><span class="line"> <span class="number">8</span>:         <span class="comment">// è§£ç </span></span><br /><span class="line"> <span class="number">9</span>:         Object obj = codec.decode(channel, buffer);</span><br /><span class="line"><span class="number">10</span>:         <span class="comment">// è¾“å…¥ä¸å¤Ÿï¼Œé‡ç½®è¯»è¿›åº¦</span></span><br /><span class="line"><span class="number">11</span>:         <span class="keyword">if</span> (Codec2.DecodeResult.NEED_MORE_INPUT == obj) {</span><br /><span class="line"><span class="number">12</span>:             buffer.readerIndex(save);</span><br /><span class="line"><span class="number">13</span>:             <span class="keyword">break</span>;</span><br /><span class="line"><span class="number">14</span>:         <span class="comment">// è§£æåˆ°æ¶ˆæ¯</span></span><br /><span class="line"><span class="number">15</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">16</span>:             <span class="comment">// æ·»åŠ ç»“æœæ¶ˆæ¯</span></span><br /><span class="line"><span class="number">17</span>:             result.addMessage(obj);</span><br /><span class="line"><span class="number">18</span>:             <span class="comment">// è®°å½•æ¶ˆæ¯é•¿åº¦åˆ°éšå¼å‚æ•°é›†åˆï¼Œç”¨äº MonitorFilter ç›‘æ§</span></span><br /><span class="line"><span class="number">19</span>:             logMessageLength(obj, buffer.readerIndex() - save);</span><br /><span class="line"><span class="number">20</span>:             <span class="comment">// è®°å½•å½“å‰è¯»ä½ç½®</span></span><br /><span class="line"><span class="number">21</span>:             save = buffer.readerIndex();</span><br /><span class="line"><span class="number">22</span>:         }</span><br /><span class="line"><span class="number">23</span>:     } <span class="keyword">while</span> (<span class="keyword">true</span>);</span><br /><span class="line"><span class="number">24</span>:     <span class="comment">// éœ€è¦æ›´å¤šçš„è¾“å…¥</span></span><br /><span class="line"><span class="number">25</span>:     <span class="keyword">if</span> (result.isEmpty()) {</span><br /><span class="line"><span class="number">26</span>:         <span class="keyword">return</span> Codec2.DecodeResult.NEED_MORE_INPUT;</span><br /><span class="line"><span class="number">27</span>:     }</span><br /><span class="line"><span class="number">28</span>:     <span class="comment">// è¿”å›è§£æåˆ°çš„æ¶ˆæ¯</span></span><br /><span class="line"><span class="number">29</span>:     <span class="keyword">if</span> (result.size() == <span class="number">1</span>) {</span><br /><span class="line"><span class="number">30</span>:         <span class="keyword">return</span> result.get(<span class="number">0</span>);</span><br /><span class="line"><span class="number">31</span>:     }</span><br /><span class="line"><span class="number">32</span>:     <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">33</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>åŒ…å«ä¸¤å—é€»è¾‘ï¼š1ï¼‰å¤šæ¶ˆæ¯è§£æçš„æ”¯æŒã€‚2ï¼‰è®°å½•æ¯æ¡æ¶ˆæ¯çš„é•¿åº¦ï¼Œç”¨äº MonitorFilter ç›‘æ§ã€‚</li>
<li>ç¬¬ 4 è¡Œï¼šè®°å½•å½“å‰è¯»ä½ç½®ï¼Œç”¨äºä¸‹é¢è®¡ç®—æ¯æ¡æ¶ˆæ¯çš„é•¿åº¦ã€‚</li>
<li>ç¬¬ 6 è¡Œï¼šåˆ›å»º MultiMessage å¯¹è±¡ã€‚MultiMessageHandler æ”¯æŒå¯¹å®ƒçš„å¤„ç†åˆ†å‘ã€‚</li>
<li>ç¬¬ 7 è‡³ 23 è¡Œï¼š<strong>å¾ªç¯</strong>è§£ææ¶ˆæ¯ï¼Œç›´åˆ°ç»“æŸã€‚</li>
<li>ç¬¬ 9 è¡Œï¼šè°ƒç”¨&nbsp;<code>DubboCodec#decode(channel, buffer)</code>&nbsp;æ–¹æ³•ï¼Œè§£ç ã€‚</li>
<li>ç¬¬ 11 è‡³ 13 è¡Œï¼šå­—èŠ‚æ•°ç»„ä¸å¤Ÿï¼Œé‡ç½®è¯»è¿›åº¦ï¼Œç»“æŸè§£æã€‚</li>
<li>
<p>ç¬¬ 15 è‡³ 22 è¡Œï¼šè§£æåˆ°æ¶ˆæ¯ï¼Œæ·»åŠ åˆ°&nbsp;<code>result</code>&nbsp;ã€‚</p>
<ul>
<li>
<p>ç¬¬ 19 è¡Œï¼šè°ƒç”¨&nbsp;<code>#logMessageLength(obj, length)</code>&nbsp;æ–¹æ³•ï¼Œè®°å½•æ¶ˆæ¯é•¿åº¦åˆ°<strong>éšå¼å‚æ•°é›†åˆ</strong>ï¼Œç”¨äº MonitorFilter ç›‘æ§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">logMessageLength</span><span class="params">(Object result, <span class="keyword">int</span> bytes)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (bytes &lt;= <span class="number">0</span>) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">if</span> (result <span class="keyword">instanceof</span> Request) {</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            ((RpcInvocation) ((Request) result).getData()).setAttachment(Constants.INPUT_KEY, String.valueOf(bytes)); <span class="comment">// è¯·æ±‚</span></span><br /><span class="line">        } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line">            <span class="comment">/* ignore */</span></span><br /><span class="line">        }</span><br /><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (result <span class="keyword">instanceof</span> Response) {</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            ((RpcResult) ((Response) result).getResult()).setAttachment(Constants.OUTPUT_KEY, String.valueOf(bytes)); <span class="comment">// å“åº”</span></span><br /><span class="line">        } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line">            <span class="comment">/* ignore */</span></span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>x</li>
</ul>
</li>
<li>ç¬¬ 21 è¡Œï¼šè®°å½•å½“å‰è¯»ä½ç½®ï¼Œç”¨äºè®¡ç®—<strong>ä¸‹ä¸€æ¡</strong>æ¶ˆæ¯çš„é•¿åº¦ã€‚</li>
</ul>
</li>
<li>ç¬¬ 24 è‡³ 27 è¡Œï¼šéœ€è¦æ›´å¤šçš„è¾“å…¥ã€‚</li>
<li>ç¬¬ 28 è‡³ 32 è¡Œï¼šè¿”å›ç»“æœã€‚</li>
</ul>
<h2 id="5-2-DubboCodec">5.2 DubboCodec</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-rpc/dubbo-rpc-default/src/main/java/com/alibaba/dubbo/rpc/protocol/dubbo/DubboCountCodec.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.rpc.protocol.dubbo.DubboCodec</code></a>&nbsp;ï¼Œå®ç° Codec2 æ¥å£ï¼Œç»§æ‰¿ ExchangeCodec ç±»ï¼Œ<strong>Dubbo ç¼–è§£ç å™¨</strong>å®ç°ç±»ã€‚</p>
<h3 id="5-2-1-æ„é€ æ–¹æ³•">5.2.1 æ„é€ æ–¹æ³•</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * åè®®å</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">"dubbo"</span>;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * åè®®ç‰ˆæœ¬</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DUBBO_VERSION = Version.getVersion(DubboCodec.class, Version.getVersion());</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å“åº” - å¼‚å¸¸</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> RESPONSE_WITH_EXCEPTION = <span class="number">0</span>;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å“åº” - æ­£å¸¸ï¼ˆç©ºè¿”å›ï¼‰</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> RESPONSE_VALUE = <span class="number">1</span>;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å“åº” - æ­£å¸¸ï¼ˆæœ‰è¿”å›ï¼‰</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> RESPONSE_NULL_VALUE = <span class="number">2</span>;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ–¹æ³•å‚æ•° - ç©ºï¼ˆå‚æ•°ï¼‰</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Object[] EMPTY_OBJECT_ARRAY = <span class="keyword">new</span> Object[<span class="number">0</span>];</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ–¹æ³•å‚æ•° - ç©ºï¼ˆç±»å‹ï¼‰</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Class&lt;?&gt;[] EMPTY_CLASS_ARRAY = <span class="keyword">new</span> Class&lt;?&gt;[<span class="number">0</span>];</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="5-2-2-ç¼–ç å†…å®¹ä½“">5.2.2 ç¼–ç å†…å®¹ä½“</h3>
<h4 id="5-2-2-1-è¯·æ±‚">5.2.2.1 è¯·æ±‚</h4>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encodeRequestData</span><span class="params">(Channel channel, ObjectOutput out, Object data)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line"> <span class="number">3</span>:     RpcInvocation inv = (RpcInvocation) data;</span><br /><span class="line"> <span class="number">4</span>: </span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// å†™å…¥ `dubbo` `path` `version`</span></span><br /><span class="line"> <span class="number">6</span>:     out.writeUTF(inv.getAttachment(Constants.DUBBO_VERSION_KEY, DUBBO_VERSION));</span><br /><span class="line"> <span class="number">7</span>:     out.writeUTF(inv.getAttachment(Constants.PATH_KEY));</span><br /><span class="line"> <span class="number">8</span>:     out.writeUTF(inv.getAttachment(Constants.VERSION_KEY));</span><br /><span class="line"> <span class="number">9</span>: </span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// å†™å…¥æ–¹æ³•ã€æ–¹æ³•ç­¾åã€æ–¹æ³•å‚æ•°é›†åˆ</span></span><br /><span class="line"><span class="number">11</span>:     out.writeUTF(inv.getMethodName());</span><br /><span class="line"><span class="number">12</span>:     out.writeUTF(ReflectUtils.getDesc(inv.getParameterTypes()));</span><br /><span class="line"><span class="number">13</span>:     Object[] args = inv.getArguments();</span><br /><span class="line"><span class="number">14</span>:     <span class="keyword">if</span> (args != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">15</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) {</span><br /><span class="line"><span class="number">16</span>:             out.writeObject(CallbackServiceCodec.encodeInvocationArgument(channel, inv, i));</span><br /><span class="line"><span class="number">17</span>:         }</span><br /><span class="line"><span class="number">18</span>:     }</span><br /><span class="line"><span class="number">19</span>: </span><br /><span class="line"><span class="number">20</span>:     <span class="comment">// å†™å…¥éšå¼ä¼ å‚é›†åˆ</span></span><br /><span class="line"><span class="number">21</span>:     out.writeObject(inv.getAttachments());</span><br /><span class="line"><span class="number">22</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ğŸ™‚ èƒ–å‹çœ‹ä¸‹ä»£ç æ³¨é‡Šã€‚</li>
<li>ç¼–ç  RpcInvocation å¯¹è±¡ï¼Œå†™å…¥éœ€è¦ç¼–ç çš„å­—æ®µã€‚</li>
<li>å¯¹åº”çš„è§£ç ï¼Œåœ¨ DecodeableRpcInvocation ä¸­ã€‚</li>
<li>ç¬¬ 16 è¡Œï¼šè°ƒç”¨&nbsp;<code>CallbackServiceCodec#encodeInvocationArgument(...)</code>&nbsp;æ–¹æ³•ï¼Œç¼–ç å‚æ•°ã€‚ä¸»è¦ç”¨äº&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/callback-parameter.html" target="_blank" rel="external nofollow noopener noreferrer">å‚æ•°å›è°ƒ</a>&nbsp;åŠŸèƒ½ï¼Œåé¢çš„æ–‡ç« ï¼Œè¯¦ç»†è§£æã€‚</li>
</ul>
<h4 id="5-2-2-2-å“åº”">5.2.2.2 å“åº”</h4>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encodeResponseData</span><span class="params">(Channel channel, ObjectOutput out, Object data)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line"> <span class="number">3</span>:     Result result = (Result) data;</span><br /><span class="line"> <span class="number">4</span>: </span><br /><span class="line"> <span class="number">5</span>:     Throwable th = result.getException();</span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// æ­£å¸¸</span></span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (th == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">8</span>:         Object ret = result.getValue();</span><br /><span class="line"> <span class="number">9</span>:         <span class="comment">// ç©ºè¿”å›</span></span><br /><span class="line"><span class="number">10</span>:         <span class="keyword">if</span> (ret == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">11</span>:             out.writeByte(RESPONSE_NULL_VALUE);</span><br /><span class="line"><span class="number">12</span>:         <span class="comment">// æœ‰è¿”å›</span></span><br /><span class="line"><span class="number">13</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">14</span>:             out.writeByte(RESPONSE_VALUE);</span><br /><span class="line"><span class="number">15</span>:             out.writeObject(ret);</span><br /><span class="line"><span class="number">16</span>:         }</span><br /><span class="line"><span class="number">17</span>:     <span class="comment">// å¼‚å¸¸</span></span><br /><span class="line"><span class="number">18</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">19</span>:         out.writeByte(RESPONSE_WITH_EXCEPTION);</span><br /><span class="line"><span class="number">20</span>:         out.writeObject(th);</span><br /><span class="line"><span class="number">21</span>:     }</span><br /><span class="line"><span class="number">22</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ğŸ™‚ èƒ–å‹çœ‹ä¸‹ä»£ç æ³¨é‡Šã€‚</li>
<li>ç¼–ç  Result å¯¹è±¡ï¼Œå†™å…¥éœ€è¦ç¼–ç çš„å­—æ®µã€‚</li>
<li>å¯¹åº”çš„è§£ç ï¼Œåœ¨ DecodeableRpcResult ä¸­ã€‚</li>
</ul>
<h3 id="5-2-3-è§£ç å†…å®¹ä½“">5.2.3 è§£ç å†…å®¹ä½“</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> Object <span class="title">decodeBody</span><span class="params">(Channel channel, InputStream is, <span class="keyword">byte</span>[] header)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">byte</span> flag = header[<span class="number">2</span>];</span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// è·å¾— Serialization å¯¹è±¡</span></span><br /><span class="line"> <span class="number">5</span>:     <span class="keyword">byte</span> proto = (<span class="keyword">byte</span>) (flag &amp; SERIALIZATION_MASK);</span><br /><span class="line"> <span class="number">6</span>:     Serialization s = CodecSupport.getSerialization(channel.getUrl(), proto);</span><br /><span class="line"> <span class="number">7</span>:     <span class="comment">// è·å¾—è¯·æ±‚||å“åº”ç¼–å·</span></span><br /><span class="line"> <span class="number">8</span>:     <span class="comment">// get request id.</span></span><br /><span class="line"> <span class="number">9</span>:     <span class="keyword">long</span> id = Bytes.bytes2long(header, <span class="number">4</span>);</span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// è§£æå“åº”</span></span><br /><span class="line"><span class="number">11</span>:     <span class="keyword">if</span> ((flag &amp; FLAG_REQUEST) == <span class="number">0</span>) {</span><br /><span class="line"><span class="number">12</span>:         <span class="comment">// decode response.</span></span><br /><span class="line"><span class="number">13</span>:         Response res = <span class="keyword">new</span> Response(id);</span><br /><span class="line"><span class="number">14</span>:         <span class="comment">// ... çœç•¥ä»£ç </span></span><br /><span class="line"><span class="number">15</span>:         <span class="keyword">return</span> res;</span><br /><span class="line"><span class="number">16</span>:     <span class="comment">// è§£æè¯·æ±‚</span></span><br /><span class="line"><span class="number">17</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">18</span>:         <span class="comment">// decode request.</span></span><br /><span class="line"><span class="number">19</span>:         Request req = <span class="keyword">new</span> Request(id);</span><br /><span class="line"><span class="number">20</span>:         <span class="comment">// ... çœç•¥ä»£ç </span></span><br /><span class="line"><span class="number">21</span>:         <span class="keyword">return</span> req;</span><br /><span class="line"><span class="number">22</span>:     }</span><br /><span class="line"><span class="number">23</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 4 è‡³ 6 è¡Œï¼šè°ƒç”¨&nbsp;<code>CodeSupport#getSerialization(url, proto)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— Serialization å¯¹è±¡ï¼Œç”¨äºä¸‹é¢ååºåˆ—åŒ–å†…å®¹ä½“çš„æ¯ä¸ªå­—æ®µã€‚</li>
<li>ç¬¬ 9 è¡Œï¼šè·å¾—è¯·æ±‚æˆ–å“åº”çš„ç¼–å·ã€‚</li>
<li>ç¬¬ 10 è‡³ 15 è¡Œï¼šè§£æå“åº”( Response )ã€‚</li>
<li>ç¬¬ 16 è‡³ 22 è¡Œï¼šè§£æè¯·æ±‚( Request )ã€‚</li>
</ul>
<h4 id="5-2-3-1-è¯·æ±‚">5.2.3.1 è¯·æ±‚</h4>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">// decode response.</span></span><br /><span class="line"> <span class="number">2</span>: Response res = <span class="keyword">new</span> Response(id);</span><br /><span class="line"> <span class="number">3</span>: <span class="comment">// è‹¥æ˜¯å¿ƒè·³äº‹ä»¶ï¼Œè¿›è¡Œè®¾ç½®</span></span><br /><span class="line"> <span class="number">4</span>: <span class="keyword">if</span> ((flag &amp; FLAG_EVENT) != <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">5</span>:     res.setEvent(Response.HEARTBEAT_EVENT);</span><br /><span class="line"> <span class="number">6</span>: }</span><br /><span class="line"> <span class="number">7</span>: <span class="comment">// è®¾ç½®çŠ¶æ€</span></span><br /><span class="line"> <span class="number">8</span>: <span class="comment">// get status.</span></span><br /><span class="line"> <span class="number">9</span>: <span class="keyword">byte</span> status = header[<span class="number">3</span>];</span><br /><span class="line"><span class="number">10</span>: res.setStatus(status);</span><br /><span class="line"><span class="number">11</span>: <span class="comment">// æ­£å¸¸å“åº”çŠ¶æ€</span></span><br /><span class="line"><span class="number">12</span>: <span class="keyword">if</span> (status == Response.OK) {</span><br /><span class="line"><span class="number">13</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">14</span>:         Object data;</span><br /><span class="line"><span class="number">15</span>:         <span class="comment">// è§£ç å¿ƒè·³äº‹ä»¶</span></span><br /><span class="line"><span class="number">16</span>:         <span class="keyword">if</span> (res.isHeartbeat()) {</span><br /><span class="line"><span class="number">17</span>:             data = decodeHeartbeatData(channel, deserialize(s, channel.getUrl(), is));</span><br /><span class="line"><span class="number">18</span>:         <span class="comment">// è§£ç å…¶å®ƒäº‹ä»¶</span></span><br /><span class="line"><span class="number">19</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (res.isEvent()) {</span><br /><span class="line"><span class="number">20</span>:             data = decodeEventData(channel, deserialize(s, channel.getUrl(), is));</span><br /><span class="line"><span class="number">21</span>:         <span class="comment">// è§£ç æ™®é€šå“åº”</span></span><br /><span class="line"><span class="number">22</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">23</span>:             DecodeableRpcResult result;</span><br /><span class="line"><span class="number">24</span>:             <span class="comment">// åœ¨é€šä¿¡æ¡†æ¶ï¼ˆä¾‹å¦‚ï¼ŒNettyï¼‰çš„ IO çº¿ç¨‹ï¼Œè§£ç </span></span><br /><span class="line"><span class="number">25</span>:             <span class="keyword">if</span> (channel.getUrl().getParameter(Constants.DECODE_IN_IO_THREAD_KEY, Constants.DEFAULT_DECODE_IN_IO_THREAD)) {</span><br /><span class="line"><span class="number">26</span>:                 result = <span class="keyword">new</span> DecodeableRpcResult(channel, res, is, (Invocation) getRequestData(id), proto);</span><br /><span class="line"><span class="number">27</span>:                 result.decode();</span><br /><span class="line"><span class="number">28</span>:             <span class="comment">// åœ¨ Dubbo ThreadPool çº¿ç¨‹ï¼Œè§£ç ï¼Œä½¿ç”¨ DecodeHandler</span></span><br /><span class="line"><span class="number">29</span>:             } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">30</span>:                 result = <span class="keyword">new</span> DecodeableRpcResult(channel, res, <span class="keyword">new</span> UnsafeByteArrayInputStream(readMessageData(is)), (Invocation) getRequestData(id), proto);</span><br /><span class="line"><span class="number">31</span>:             }</span><br /><span class="line"><span class="number">32</span>:             data = result;</span><br /><span class="line"><span class="number">33</span>:         }</span><br /><span class="line"><span class="number">34</span>:         <span class="comment">// è®¾ç½®ç»“æœ</span></span><br /><span class="line"><span class="number">35</span>:         res.setResult(data);</span><br /><span class="line"><span class="number">36</span>:     } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">37</span>:         <span class="keyword">if</span> (log.isWarnEnabled()) {</span><br /><span class="line"><span class="number">38</span>:             log.warn(<span class="string">"Decode response failed: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">39</span>:         }</span><br /><span class="line"><span class="number">40</span>:         res.setStatus(Response.CLIENT_ERROR);</span><br /><span class="line"><span class="number">41</span>:         res.setErrorMessage(StringUtils.toString(t));</span><br /><span class="line"><span class="number">42</span>:     }</span><br /><span class="line"><span class="number">43</span>: <span class="comment">// å¼‚å¸¸å“åº”çŠ¶æ€</span></span><br /><span class="line"><span class="number">44</span>: } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">45</span>:     res.setErrorMessage(deserialize(s, channel.getUrl(), is).readUTF());</span><br /><span class="line"><span class="number">46</span>: }</span><br /><span class="line"><span class="number">47</span>: <span class="keyword">return</span> res;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ğŸ™‚ èƒ–å‹çœ‹ä¸‹ä»£ç æ³¨é‡Šã€‚æˆ‘ä»¬é‡ç‚¹è®²ä¸‹å¯èƒ½<strong>æ¯”è¾ƒç»•</strong>çš„åœ°æ–¹ã€‚</li>
<li>ç¬¬ 21 è‡³ 33 è¡Œï¼šè§£ç æ™®é€šå“åº”ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä»£ç åˆ†æˆã€ç¬¬ 25 è‡³ 27 è¡Œã€‘ã€ç¬¬ 28 è‡³ 31 è¡Œã€‘<strong>ä¸¤æ®µ</strong>ã€‚
<ul>
<li>ç›¸åŒç‚¹ï¼Œä½¿ç”¨&nbsp;<strong>DecodeableRpcResult</strong>&nbsp;è§£ç ã€‚å‰è€…ï¼Œæ¯”è¾ƒå¥½ç†è§£ï¼Œã€ç¬¬ 27 è¡Œã€‘å·²ç»è°ƒç”¨ï¼›åè€…ï¼Œåœ¨ DecodeHandler ä¸­ï¼Œæ‰æœ€ç»ˆè°ƒç”¨&nbsp;<code>DecodeableRpcResult#decode()</code>&nbsp;æ–¹æ³•ã€‚</li>
<li>å·®å¼‚ç‚¹ï¼Œä½¿ç”¨<strong>å“ªä¸ªçº¿ç¨‹</strong>è§£ç ã€‚å‰è€…ï¼Œè¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£ï¼Œå½“å‰çº¿ç¨‹ï¼Œå³é€šä¿¡æ¡†æ¶ï¼ˆä¾‹å¦‚ï¼ŒNettyï¼‰çš„ IO çº¿ç¨‹ã€‚åè€…ï¼ŒDubbo ThreadPool çº¿ç¨‹ä¸­ã€‚</li>
<li><code>decode.in.io</code>&nbsp;é…ç½®é¡¹ï¼Œç›®å‰åœ¨ Dubbo æ–‡æ¡£ä¸­ï¼Œå¹¶æœªè¯´æ˜ï¼Œåº”è¯¥æ˜¯<strong>æ€§èƒ½è°ƒä¼˜</strong>ï¼Œå…·ä½“ç¬”è€…è¿˜æ²¡æµ‹è¯•è¿‡ã€‚å˜¿å˜¿ã€‚</li>
</ul>
</li>
</ul>
<h4 id="5-2-3-2-å“åº”">5.2.3.2 å“åº”</h4>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">// decode request.</span></span><br /><span class="line"> <span class="number">2</span>: Request req = <span class="keyword">new</span> Request(id);</span><br /><span class="line"> <span class="number">3</span>: req.setVersion(<span class="string">"2.0.0"</span>);</span><br /><span class="line"> <span class="number">4</span>: <span class="comment">// æ˜¯å¦éœ€è¦å“åº”</span></span><br /><span class="line"> <span class="number">5</span>: req.setTwoWay((flag &amp; FLAG_TWOWAY) != <span class="number">0</span>);</span><br /><span class="line"> <span class="number">6</span>: <span class="comment">// è‹¥æ˜¯å¿ƒè·³äº‹ä»¶ï¼Œè¿›è¡Œè®¾ç½®</span></span><br /><span class="line"> <span class="number">7</span>: <span class="keyword">if</span> ((flag &amp; FLAG_EVENT) != <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">8</span>:     req.setEvent(Request.HEARTBEAT_EVENT);</span><br /><span class="line"> <span class="number">9</span>: }</span><br /><span class="line"><span class="number">10</span>: <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">11</span>:     Object data;</span><br /><span class="line"><span class="number">12</span>:     <span class="comment">// è§£ç å¿ƒè·³äº‹ä»¶</span></span><br /><span class="line"><span class="number">13</span>:     <span class="keyword">if</span> (req.isHeartbeat()) {</span><br /><span class="line"><span class="number">14</span>:         data = decodeHeartbeatData(channel, deserialize(s, channel.getUrl(), is));</span><br /><span class="line"><span class="number">15</span>:     <span class="comment">// è§£ç å…¶å®ƒäº‹ä»¶</span></span><br /><span class="line"><span class="number">16</span>:     } <span class="keyword">else</span> <span class="keyword">if</span> (req.isEvent()) {</span><br /><span class="line"><span class="number">17</span>:         data = decodeEventData(channel, deserialize(s, channel.getUrl(), is));</span><br /><span class="line"><span class="number">18</span>:     <span class="comment">// è§£ç æ™®é€šè¯·æ±‚</span></span><br /><span class="line"><span class="number">19</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">20</span>:         <span class="comment">// åœ¨é€šä¿¡æ¡†æ¶ï¼ˆä¾‹å¦‚ï¼ŒNettyï¼‰çš„ IO çº¿ç¨‹ï¼Œè§£ç </span></span><br /><span class="line"><span class="number">21</span>:         DecodeableRpcInvocation inv;</span><br /><span class="line"><span class="number">22</span>:         <span class="keyword">if</span> (channel.getUrl().getParameter(Constants.DECODE_IN_IO_THREAD_KEY, Constants.DEFAULT_DECODE_IN_IO_THREAD)) {</span><br /><span class="line"><span class="number">23</span>:             inv = <span class="keyword">new</span> DecodeableRpcInvocation(channel, req, is, proto);</span><br /><span class="line"><span class="number">24</span>:             inv.decode();</span><br /><span class="line"><span class="number">25</span>:         <span class="comment">// åœ¨ Dubbo ThreadPool çº¿ç¨‹ï¼Œè§£ç ï¼Œä½¿ç”¨ DecodeHandler</span></span><br /><span class="line"><span class="number">26</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">27</span>:             inv = <span class="keyword">new</span> DecodeableRpcInvocation(channel, req, <span class="keyword">new</span> UnsafeByteArrayInputStream(readMessageData(is)), proto);</span><br /><span class="line"><span class="number">28</span>:         }</span><br /><span class="line"><span class="number">29</span>:         data = inv;</span><br /><span class="line"><span class="number">30</span>:     }</span><br /><span class="line"><span class="number">31</span>:     req.setData(data);</span><br /><span class="line"><span class="number">32</span>: } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">33</span>:     <span class="keyword">if</span> (log.isWarnEnabled()) {</span><br /><span class="line"><span class="number">34</span>:         log.warn(<span class="string">"Decode request failed: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">35</span>:     }</span><br /><span class="line"><span class="number">36</span>:     <span class="comment">// bad request</span></span><br /><span class="line"><span class="number">37</span>:     req.setBroken(<span class="keyword">true</span>);</span><br /><span class="line"><span class="number">38</span>:     req.setData(t);</span><br /><span class="line"><span class="number">39</span>: }</span><br /><span class="line"><span class="number">40</span>: <span class="keyword">return</span> req;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å’Œ&nbsp;<a href="http://svip.iocoder.cn/Dubbo/rpc-dubbo-1-remoting/">ã€Œ5.2.3.1 è¯·æ±‚ã€</a>&nbsp;<strong>ç±»ä¼¼</strong>ï¼Œå·®å¼‚ç‚¹åœ¨ä½¿ç”¨&nbsp;<strong>DecodeableRpcInvocation</strong>&nbsp;ã€‚</li>
<li>ğŸ™‚ èƒ–å‹çœ‹ä¸‹ä»£ç æ³¨é‡Šã€‚</li>
</ul>
<h2 id="5-3-DecodeableRpcInvocation">5.3 DecodeableRpcInvocation</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-rpc/dubbo-rpc-default/src/main/java/com/alibaba/dubbo/rpc/protocol/dubbo/DecodeableRpcInvocation.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.rpc.protocol.dubbo.DecodeableRpcInvocation</code></a>&nbsp;ï¼Œå®ç° Codec å’Œ Decodeable æ¥å£ï¼Œç»§æ‰¿ RpcInvocation ç±»ï¼Œ<strong>å¯è§£ç </strong>çš„ RpcInvocation å®ç°ç±»ã€‚</p>
<p>å½“æœåŠ¡æ¶ˆè´¹è€…ï¼Œè°ƒç”¨æœåŠ¡æä¾›è€…ï¼Œå‰è€…ç¼–ç çš„ RpcInvocation å¯¹è±¡ï¼Œåè€…è§£ç æˆ DecodeableRpcInvocation å¯¹è±¡ã€‚</p>
<p>ä»ç›®å‰çš„ä»£ç å®ç°æ¥çœ‹ï¼ŒCodec æ¥å£ï¼Œå¯ä¸å®ç°ã€‚</p>
<h3 id="5-3-1-æ„é€ æ–¹æ³•">5.3.1 æ„é€ æ–¹æ³•</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é€šé“</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Channel channel;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Serialization ç±»å‹ç¼–å·</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span> serializationType;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è¾“å…¥æµ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> InputStream inputStream;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è¯·æ±‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Request request;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦å·²ç»è§£ç å®Œæˆ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> hasDecoded;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="5-3-2-è§£ç ">5.3.2 è§£ç </h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (!hasDecoded &amp;&amp; channel != <span class="keyword">null</span> &amp;&amp; inputStream != <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            decode(channel, inputStream);</span><br /><span class="line">        } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line">            <span class="keyword">if</span> (log.isWarnEnabled()) {</span><br /><span class="line">                log.warn(<span class="string">"Decode rpc invocation failed: "</span> + e.getMessage(), e);</span><br /><span class="line">            }</span><br /><span class="line">            request.setBroken(<span class="keyword">true</span>);</span><br /><span class="line">            request.setData(e);</span><br /><span class="line">        } <span class="keyword">finally</span> {</span><br /><span class="line">            hasDecoded = <span class="keyword">true</span>;</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">decode</span><span class="params">(Channel channel, InputStream input)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line">    ObjectInput in = CodecSupport.getSerialization(channel.getUrl(), serializationType).deserialize(channel.getUrl(), input);</span><br /><br /><span class="line">    <span class="comment">// è§£ç  `dubbo` `path` `version`</span></span><br /><span class="line">    setAttachment(Constants.DUBBO_VERSION_KEY, in.readUTF());</span><br /><span class="line">    setAttachment(Constants.PATH_KEY, in.readUTF());</span><br /><span class="line">    setAttachment(Constants.VERSION_KEY, in.readUTF());</span><br /><br /><span class="line">    <span class="comment">// è§£ç æ–¹æ³•ã€æ–¹æ³•ç­¾åã€æ–¹æ³•å‚æ•°é›†åˆ</span></span><br /><span class="line">    setMethodName(in.readUTF());</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        Object[] args;</span><br /><span class="line">        Class&lt;?&gt;[] pts;</span><br /><span class="line">        String desc = in.readUTF();</span><br /><span class="line">        <span class="keyword">if</span> (desc.length() == <span class="number">0</span>) {</span><br /><span class="line">            pts = DubboCodec.EMPTY_CLASS_ARRAY;</span><br /><span class="line">            args = DubboCodec.EMPTY_OBJECT_ARRAY;</span><br /><span class="line">        } <span class="keyword">else</span> {</span><br /><span class="line">            pts = ReflectUtils.desc2classArray(desc);</span><br /><span class="line">            args = <span class="keyword">new</span> Object[pts.length];</span><br /><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) {</span><br /><span class="line">                <span class="keyword">try</span> {</span><br /><span class="line">                    args[i] = in.readObject(pts[i]);</span><br /><span class="line">                } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line">                    <span class="keyword">if</span> (log.isWarnEnabled()) {</span><br /><span class="line">                        log.warn(<span class="string">"Decode argument failed: "</span> + e.getMessage(), e);</span><br /><span class="line">                    }</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        setParameterTypes(pts);</span><br /><br /><span class="line">        <span class="comment">// è§£ç éšå¼ä¼ å‚é›†åˆ</span></span><br /><span class="line">        Map&lt;String, String&gt; map = (Map&lt;String, String&gt;) in.readObject(Map.class);</span><br /><span class="line">        <span class="keyword">if</span> (map != <span class="keyword">null</span> &amp;&amp; map.size() &gt; <span class="number">0</span>) {</span><br /><span class="line">            Map&lt;String, String&gt; attachment = getAttachments();</span><br /><span class="line">            <span class="keyword">if</span> (attachment == <span class="keyword">null</span>) {</span><br /><span class="line">                attachment = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br /><span class="line">            }</span><br /><span class="line">            attachment.putAll(map);</span><br /><span class="line">            setAttachments(attachment);</span><br /><span class="line">        }</span><br /><br /><span class="line">        <span class="comment">// è¿›ä¸€æ­¥è§£ç æ–¹æ³•å‚æ•°ï¼Œä¸»è¦ä¸ºäº†å‚æ•°è¿”å›</span></span><br /><span class="line">        <span class="comment">// decode argument ,may be callback</span></span><br /><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) {</span><br /><span class="line">            args[i] = CallbackServiceCodec.decodeInvocationArgument(channel, <span class="keyword">this</span>, pts, i, args[i]);</span><br /><span class="line">        }</span><br /><span class="line">        setArguments(args);</span><br /><span class="line">    } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(StringUtils.toString(<span class="string">"Read invocation data failed."</span>, e));</span><br /><span class="line">    } <span class="keyword">finally</span> {</span><br /><span class="line">        <span class="keyword">if</span> (in <span class="keyword">instanceof</span> Cleanable) {</span><br /><span class="line">            ((Cleanable) in).cleanup();</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ğŸ™‚ èƒ–å‹çœ‹ä¸‹ä»£ç æ³¨é‡Šã€‚</li>
</ul>
<h2 id="5-4-DecodeableRpcResult">5.4 DecodeableRpcResult</h2>
<blockquote>
<p>å’Œ DecodeableRpcInvocation ä¸€è‡´ã€‚</p>
</blockquote>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-rpc/dubbo-rpc-default/src/main/java/com/alibaba/dubbo/rpc/protocol/dubbo/DecodeableRpcResult.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.rpc.protocol.dubbo.DecodeableRpcResult</code></a>&nbsp;ï¼Œå®ç° Codec å’Œ Decodeable æ¥å£ï¼Œç»§æ‰¿ RpcResult ç±»ï¼Œ<strong>å¯è§£ç </strong>çš„ RpcResult å®ç°ç±»ã€‚</p>
<p>å½“æœåŠ¡æä¾›è€…è€…ï¼Œè¿”å›æœåŠ¡æ¶ˆè´¹è€…è°ƒç”¨ç»“æœï¼Œå‰è€…ç¼–ç çš„ RpcResult å¯¹è±¡ï¼Œåè€…è§£ç æˆ DecodeableRpcResult å¯¹è±¡ã€‚</p>
<p>ä»ç›®å‰çš„ä»£ç å®ç°æ¥çœ‹ï¼ŒCodec æ¥å£ï¼Œå¯ä¸å®ç°ã€‚</p>
<h3 id="5-4-1-æ„é€ æ–¹æ³•">5.4.1 æ„é€ æ–¹æ³•</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é€šé“</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Channel channel;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Serialization ç±»å‹ç¼–å·</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span> serializationType;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è¾“å…¥æµ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> InputStream inputStream;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è¯·æ±‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Response response;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Invocation å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Invocation invocation;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦å·²ç»è§£ç å®Œæˆ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> hasDecoded;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="5-4-2-è§£ç ">5.4.2 è§£ç </h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (!hasDecoded &amp;&amp; channel != <span class="keyword">null</span> &amp;&amp; inputStream != <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            decode(channel, inputStream);</span><br /><span class="line">        } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line">            <span class="keyword">if</span> (log.isWarnEnabled()) {</span><br /><span class="line">                log.warn(<span class="string">"Decode rpc result failed: "</span> + e.getMessage(), e);</span><br /><span class="line">            }</span><br /><span class="line">            response.setStatus(Response.CLIENT_ERROR);</span><br /><span class="line">            response.setErrorMessage(StringUtils.toString(e));</span><br /><span class="line">        } <span class="keyword">finally</span> {</span><br /><span class="line">            hasDecoded = <span class="keyword">true</span>;</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">decode</span><span class="params">(Channel channel, InputStream input)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line">    ObjectInput in = CodecSupport.getSerialization(channel.getUrl(), serializationType).deserialize(channel.getUrl(), input);</span><br /><br /><span class="line">    <span class="comment">// è¯»å–æ ‡è®°ä½</span></span><br /><span class="line">    <span class="keyword">byte</span> flag = in.readByte();</span><br /><span class="line">    <span class="keyword">switch</span> (flag) {</span><br /><span class="line">        <span class="keyword">case</span> DubboCodec.RESPONSE_NULL_VALUE: <span class="comment">// æ— è¿”å›å€¼</span></span><br /><span class="line">            <span class="keyword">break</span>;</span><br /><span class="line">        <span class="keyword">case</span> DubboCodec.RESPONSE_VALUE: <span class="comment">// æœ‰è¿”å›å€¼</span></span><br /><span class="line">            <span class="keyword">try</span> {</span><br /><span class="line">                Type[] returnType = RpcUtils.getReturnTypes(invocation);</span><br /><span class="line">                setValue(returnType == <span class="keyword">null</span> || returnType.length == <span class="number">0</span> ? in.readObject() :</span><br /><span class="line">                        (returnType.length == <span class="number">1</span> ? in.readObject((Class&lt;?&gt;) returnType[<span class="number">0</span>])</span><br /><span class="line">                                <span class="comment">// è¿”å›ç»“æœ:Type[]{method.getReturnType(), method.getGenericReturnType()}</span></span><br /><span class="line">                                : in.readObject((Class&lt;?&gt;) returnType[<span class="number">0</span>], returnType[<span class="number">1</span>])));</span><br /><span class="line">            } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br /><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(StringUtils.toString(<span class="string">"Read response data failed."</span>, e));</span><br /><span class="line">            }</span><br /><span class="line">            <span class="keyword">break</span>;</span><br /><span class="line">        <span class="keyword">case</span> DubboCodec.RESPONSE_WITH_EXCEPTION: <span class="comment">// å¼‚å¸¸</span></span><br /><span class="line">            <span class="keyword">try</span> {</span><br /><span class="line">                Object obj = in.readObject();</span><br /><span class="line">                <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> Throwable)) {</span><br /><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Response data error, expect Throwable, but get "</span> + obj);</span><br /><span class="line">                }</span><br /><span class="line">                setException((Throwable) obj);</span><br /><span class="line">            } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br /><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(StringUtils.toString(<span class="string">"Read response data failed."</span>, e));</span><br /><span class="line">            }</span><br /><span class="line">            <span class="keyword">break</span>;</span><br /><span class="line">        <span class="keyword">default</span>:</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unknown result flag, expect '0' '1' '2', get "</span> + flag);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">if</span> (in <span class="keyword">instanceof</span> Cleanable) {</span><br /><span class="line">        ((Cleanable) in).cleanup();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ğŸ™‚ èƒ–å‹çœ‹ä¸‹ä»£ç æ³¨é‡Šã€‚</li>
</ul>
</div>