# æœåŠ¡æš´éœ²ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°æš´éœ²ï¼ˆInjvmï¼‰

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

Dubbo æœåŠ¡æš´éœ²æœ‰ä¸¤ç§æ–¹å¼

* æœ¬åœ°æš´éœ²ï¼ŒJVM æœ¬åœ°è°ƒç”¨ã€‚é…ç½®å¦‚ä¸‹ï¼š
```
<dubbo:service scope="local" />
```
* è¿œç¨‹æš´éœ²ï¼Œç½‘ç»œè¿œç¨‹é€šä¿¡ã€‚é…ç½®å¦‚ä¸‹ï¼š
```
<dubbo:service scope="remote" />
```
* ã€å¯ä»¥ä¸ç®—ã€‘ä¸æš´éœ²ï¼Œé…ç½®å¦‚ä¸‹ï¼š
```
<dubbo:service scope="none" />
```

åœ¨ä¸é…ç½®

scope
çš„æƒ…å†µä¸‹ï¼Œ**é»˜è®¤ä¸¤ç§æ–¹å¼éƒ½æš´éœ²**ã€‚å› ä¸ºï¼ŒDubbo è‡ªèº«æ— æ³•ç¡®è®¤åº”ç”¨ä¸­ï¼Œæ˜¯å¦å­˜åœ¨[æœ¬åœ°å¼•ç”¨](http://dubbo.apache.org/zh-cn/docs/user/demos/local-call.html)çš„æƒ…å†µã€‚
å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸éœ€è¦é…ç½®

scope
ã€‚å¦‚æœèƒ–å‹å¯ä»¥æ˜ç¡®æœåŠ¡å™¨æ¶ˆè´¹å¼•ç”¨æœåŠ¡çš„æ–¹å¼ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œè®¾ç½®ã€‚

æˆ‘ä»¬çŸ¥é“ Dubbo æä¾›äº†å¤šç§åè®®( Protocol )å®ç°ã€‚

* **æœ¬æ–‡**ä»…åˆ†äº«æœ¬åœ°æš´éœ²ï¼Œè¯¥æ–¹å¼ä»…ä½¿ç”¨ Injvm åè®®å®ç°ï¼Œå…·ä½“ä»£ç åœ¨

dubbo-rpc-injvm
æ¨¡å—ä¸­ã€‚
* **ä¸‹å‡ ç¯‡**ä¼šåˆ†äº«è¿œç¨‹æš´éœ²ï¼Œè¯¥æ–¹å¼æœ‰å¤šç§åè®®å®ç°ï¼Œä¾‹å¦‚ Dubbo ( é»˜è®¤åè®® )ã€Hessian ã€Rest ç­‰ç­‰ã€‚æˆ‘ä»¬ä¼šæ¯ä¸ªåè®®å¯¹åº”ä¸€ç¯‡æ–‡ç« ï¼Œè¿›è¡Œåˆ†äº«ã€‚

# 2. doExportUrls

æœ¬åœ°æš´éœ²æœåŠ¡çš„é¡ºåºå›¾å¦‚ä¸‹ï¼š

![æœ¬åœ°æš´éœ²é¡ºåºå›¾](http://static2.iocoder.cn/images/Dubbo/2018_03_07/03.png)

åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” API é…ç½®ï¼ˆäºŒï¼‰ä¹‹æœåŠ¡æä¾›è€…ã€‹](http://svip.iocoder.cn/Dubbo/configuration-api-2/?self) ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°

ServiceConfig/#export()
æ–¹æ³•ä¸­ï¼Œä¼šåœ¨é…ç½®åˆå§‹åŒ–å®Œæˆåï¼Œè°ƒç”¨é¡ºåºå›¾çš„**èµ·ç‚¹**

/#doExportUrls()
æ–¹æ³•ï¼Œå¼€å§‹æš´éœ²æœåŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* æ³¨å†Œä¸­å¿ƒé…ç½®æ•°ç»„
/*/
protected List<ProtocolConfig> protocols;
1: //*/*
2: /* æš´éœ² Dubbo URL
3: /*/
4: @SuppressWarnings({"unchecked", "rawtypes"})
5: private void doExportUrls(){
6: // åŠ è½½æ³¨å†Œä¸­å¿ƒ URL æ•°ç»„
7: List<URL> registryURLs = loadRegistries(true);
8: // å¾ªç¯ `protocols` ï¼Œå‘é€ä¸ªæ³¨å†Œä¸­å¿ƒåˆ†ç»„æš´éœ²æœåŠ¡ã€‚
9: for (ProtocolConfig protocolConfig : protocols) {
10: doExportUrlsFor1Protocol(protocolConfig, registryURLs);
11: }
12: }
```

* ç¬¬ 7 è¡Œï¼šè°ƒç”¨

/#loadRegistries(provider)
æ–¹æ³•ï¼ŒåŠ è½½æ³¨å†Œä¸­å¿ƒçš„ com.alibaba.dubbo.common.URL` æ•°ç»„ã€‚

* ğŸ™‚ åœ¨ [ã€Œ2.1 loadRegistriesã€](http://svip.iocoder.cn/Dubbo/service-export-local/) è¯¦ç»†è§£æã€‚
* ç¬¬ 8 è‡³ 11 è¡Œï¼šå¾ªç¯

protocols
ï¼Œè°ƒç”¨

/#doExportUrlsFor1Protocol(protocolConfig, registryURLs)
æ–¹æ³•ï¼Œä½¿ç”¨**å¯¹åº”çš„åè®®**ï¼Œé€ä¸ªå‘**æ³¨å†Œä¸­å¿ƒåˆ†ç»„**æš´éœ²æœåŠ¡ã€‚åœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼ŒåŒ…å«äº†æœ¬åœ°å’Œè¿œç¨‹ä¸¤ç§æš´éœ²æ–¹å¼ã€‚åœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œæœ¬åœ°æš´éœ²ä¸ä¼šå‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡ï¼Œ**å› ä¸ºä»…ä»…ç”¨äº JVM å†…éƒ¨æœ¬åœ°è°ƒç”¨ï¼Œå†…å­˜ä¸­å·²ç»æœ‰ç›¸å…³ä¿¡æ¯**ã€‚

* ğŸ™‚ åœ¨ [ã€Œ2.2 doExportUrlsFor1Protocolã€](http://svip.iocoder.cn/Dubbo/service-export-local/) è¯¦ç»†è§£æã€‚

## 2.1 loadRegistries

å‹æƒ…æç¤ºï¼Œå®é™…è¿™ä¸ªæ–¹æ³•ï¼Œæ”¾åœ¨æœåŠ¡çš„**è¿œç¨‹æš´éœ²**ä¸€æ–‡åˆ†äº«è¾ƒä¸ºåˆé€‚ã€‚
å› ä¸ºï¼Œ**æœ¬åœ°æš´éœ²**æ— éœ€å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œã€‚
æ‰€ä»¥ï¼Œè¯¥æ–¹æ³•ä¹Ÿå¯ä»¥æ”¾åˆ°**è¿œç¨‹æš´éœ²**ä¸€æ–‡åœ¨çœ‹ã€‚

/#loadRegistries(provider)
æ–¹æ³•ï¼ŒåŠ è½½æ³¨å†Œä¸­å¿ƒ

com.alibaba.dubbo.common.URL
æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š

```
1: //*/*
2: /* åŠ è½½æ³¨å†Œä¸­å¿ƒ URL æ•°ç»„
3: /*
4: /* @param provider æ˜¯å¦æ˜¯æœåŠ¡æä¾›è€…
5: /* @return URL æ•°ç»„
6: /*/
7: protected List<URL> loadRegistries(boolean provider){
8: // æ ¡éªŒ RegistryConfig é…ç½®æ•°ç»„ã€‚
9: checkRegistry();
10: // åˆ›å»º æ³¨å†Œä¸­å¿ƒ URL æ•°ç»„
11: List<URL> registryList = new ArrayList<URL>();
12: if (registries != null && !registries.isEmpty()) {
13: for (RegistryConfig config : registries) {
14: // è·å¾—æ³¨å†Œä¸­å¿ƒçš„åœ°å€
15: String address = config.getAddress();
16: if (address == null || address.length() == 0) {
17: address = Constants.ANYHOST_VALUE;
18: }
19: String sysaddress = System.getProperty("dubbo.registry.address"); // ä»å¯åŠ¨å‚æ•°è¯»å–
20: if (sysaddress != null && sysaddress.length() > 0) {
21: address = sysaddress;
22: }
23: // æœ‰æ•ˆçš„åœ°å€
24: if (address.length() > 0
25: && !RegistryConfig.NO_AVAILABLE.equalsIgnoreCase(address)) {
26: Map<String, String> map = new HashMap<String, String>();
27: // å°†å„ç§é…ç½®å¯¹è±¡ï¼Œæ·»åŠ åˆ° `map` é›†åˆä¸­ã€‚
28: appendParameters(map, application);
29: appendParameters(map, config);
30: // æ·»åŠ  `path` `dubbo` `timestamp` `pid` åˆ° `map` é›†åˆä¸­ã€‚
31: map.put("path", RegistryService.class.getName());
32: map.put("dubbo", Version.getVersion());
33: map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));
34: if (ConfigUtils.getPid() > 0) {
35: map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));
36: }
37: // è‹¥ä¸å­˜åœ¨ `protocol` å‚æ•°ï¼Œé»˜è®¤ "dubbo" æ·»åŠ åˆ° `map` é›†åˆä¸­ã€‚
38: if (!map.containsKey("protocol")) {
39: if (ExtensionLoader.getExtensionLoader(RegistryFactory.class).hasExtension("remote")) { // "remote"
40: map.put("protocol", "remote");
41: } else {
42: map.put("protocol", "dubbo");
43: }
44: }
45: // è§£æåœ°å€ï¼Œåˆ›å»º Dubbo URL æ•°ç»„ã€‚ï¼ˆæ•°ç»„å¤§å°å¯ä»¥ä¸ºä¸€ï¼‰
46: List<URL> urls = UrlUtils.parseURLs(address, map);
47: // å¾ªç¯ `url` ï¼Œè®¾ç½® "registry" å’Œ "protocol" å±æ€§ã€‚
48: for (URL url : urls) {
49: // è®¾ç½® `registry=${protocol}` å’Œ `protocol=registry` åˆ° URL
50: url = url.addParameter(Constants.REGISTRY_KEY, url.getProtocol());
51: url = url.setProtocol(Constants.REGISTRY_PROTOCOL);
52: // æ·»åŠ åˆ°ç»“æœ
53: if ((provider && url.getParameter(Constants.REGISTER_KEY, true)) // æœåŠ¡æä¾›è€… && æ³¨å†Œ
54: || (!provider && url.getParameter(Constants.SUBSCRIBE_KEY, true))) { // æœåŠ¡æ¶ˆè´¹è€… && è®¢é˜…
55: registryList.add(url);
56: }
57: }
58: }
59: }
60: }
61: return registryList;
62: }
```

* ç¬¬ 9 è¡Œï¼šè°ƒç”¨ [
/#checkRegistry()
](https://github.com/YunaiV/dubbo/blob/9d38b6f9f95798755141d6140e311e8fd51fecc1/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/AbstractInterfaceConfig.java#L122-L154) æ–¹æ³•ï¼Œæ ¡éªŒ RegistryConfig é…ç½®ã€‚

* ğŸ™‚ ç›´æ¥ç‚¹å‡»æ–¹æ³•æŸ¥çœ‹ï¼Œè¾ƒä¸ºç®€å•ï¼Œå·²ç»æ·»åŠ è¯¦ç»†æ³¨é‡Šã€‚
* ç¬¬ 11 è¡Œï¼š**åˆ›å»º**æ³¨å†Œä¸­å¿ƒ URL æ•°ç»„ã€‚
* ç¬¬ 13 è¡Œï¼š**å¾ªç¯**æ³¨å†Œä¸­å¿ƒé…ç½®å¯¹è±¡æ•°ç»„

registries
ã€‚
* ç¬¬ 14 è‡³ 22 è¡Œï¼šè·å¾—æ³¨å†Œä¸­å¿ƒçš„åœ°å€

address
ã€‚

* ç¬¬ 19 è‡³ 22 è¡Œï¼šä»å¯åŠ¨å‚æ•°

dubbo.registry.address
è¯»å–ï¼Œè‹¥å­˜åœ¨ï¼Œ**æœ€é«˜ä¼˜å…ˆçº§**ï¼Œè¿›è¡Œè¦†ç›–ã€‚
* ç¬¬ 24 è‡³ 25 è¡Œï¼šåœ°å€

address
æ˜¯æœ‰æ•ˆåœ°å€ï¼ŒåŒ…æ‹¬

address != N/A
ã€‚

* "N/A"
ä»£è¡¨ä¸é…ç½®æ³¨å†Œä¸­å¿ƒã€‚
* ç¬¬ 26 è¡Œï¼šåˆ›å»ºå‚æ•°é›†åˆ

map
ã€‚
* ç¬¬ 28 è‡³ 29 è¡Œï¼šè°ƒç”¨

/#appendParameters(map, config)
æ–¹æ³•ï¼Œå°†å„ç§é…ç½®å¯¹è±¡ï¼Œæ·»åŠ åˆ°

map
é›†åˆä¸­ã€‚

* ğŸ™‚ åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” API é…ç½®ï¼ˆä¸€ï¼‰ä¹‹åº”ç”¨ã€‹ã€Œ3.1 AbstractConfigã€](http://svip.iocoder.cn/Dubbo/configuration-api-1/?self) å·²ç»è¯¦ç»†è§£æã€‚
* [
RegistryConfig/#getAddress()
](https://github.com/YunaiV/dubbo/blob/4a877ee283af70c3f6a19c3b8b8e6918696540e6/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/RegistryConfig.java#L121-L124) ä¸Šæœ‰

@Parameter(excluded = true)
ï¼Œå› æ­¤

Registry.address
å±æ€§ä¸ä¼šæ·»åŠ åˆ°

map
ä¸­ã€‚
* ç¬¬ 30 è‡³ 36 è¡Œï¼šæ·»åŠ 

path

dubbo

timestamp

pid
åˆ°

map
é›†åˆä¸­ã€‚
* ç¬¬ 37 è‡³ 44 è¡Œï¼šè‹¥ä¸å­˜åœ¨

protocol
å‚æ•°ï¼Œç¼ºçœé»˜è®¤ä¸º â€œdubboâ€ ï¼Œå¹¶æ·»åŠ åˆ°

map
é›†åˆä¸­ã€‚

* ç¬¬ 39 è‡³ 40 è¡Œï¼š**å¯ä»¥å¿½ç•¥**ã€‚å› ä¸ºï¼Œ

remote
è¿™ä¸ªæ‹“å±•å®ç°å·²ç»ä¸å­˜åœ¨ã€‚
* ç¬¬ 46 è¡Œï¼šè°ƒç”¨ [
UrlUtils/#parseURLs(address, map)
](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/UrlUtils.java#L147-L174) æ–¹æ³•ï¼Œè§£æ

address
ï¼Œåˆ›å»º Dubbo URL æ•°ç»„ï¼ˆæ•°ç»„å¤§å°å¯ä»¥ä¸ºä¸€ï¼‰ã€‚

* ğŸ™‚ å·²ç»æ·»åŠ äº†ä»£ç æ³¨é‡Šï¼Œèƒ–å‹ç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚
* address
å¯ä»¥ä½¿ç”¨

"|"
æˆ–è€…

";"
ä½œä¸ºåˆ†éš”ç¬¦ï¼Œè®¾ç½®å¤šä¸ªæ³¨å†Œä¸­å¿ƒ**åˆ†ç»„**ã€‚**æ³¨æ„**ï¼Œä¸€ä¸ªæ³¨å†Œä¸­å¿ƒé›†ç¾¤æ˜¯ä¸€ä¸ªåˆ†ç»„ï¼Œè€Œä¸æ˜¯å¤šä¸ªã€‚
* è¿™ä¸ªæ–¹æ³•ä»åå­—ä¸Šå¾ˆéš¾çœ‹å‡ºå…·ä½“çš„å«ä¹‰ï¼Œçœ‹ä¸‹å›¾çš„**æ³¨é‡Š**ï¼Œç›¸ä¿¡èƒ–å‹èƒ½ç†è§£ã€‚![`UrlUtils#parseURLs(address, map)`](http://static2.iocoder.cn/images/Dubbo/2018_03_07/01.png)
* ç¬¬ 47 è‡³ 57 è¡Œï¼šå¾ªç¯

urls
ï¼Œè®¾ç½® â€œregistryâ€ å’Œ â€œprotocolâ€ å±æ€§ã€‚

* ç¬¬ 49 è‡³ 51 è¡Œï¼šè®¾ç½®

registry=${protocol}
å’Œ

protocol=registry
åˆ° URL ã€‚
* ç¬¬ 53 è¡Œï¼šè‹¥æ˜¯æœåŠ¡**æä¾›è€…**ï¼Œåˆ¤æ–­æ˜¯å¦**åªè®¢é˜…ä¸æ³¨å†Œ**ã€‚å¦‚æœæ˜¯ï¼Œ**ä¸æ·»åŠ **ç»“æœåˆ°

registryList
ä¸­ã€‚å¯¹åº” [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” åªè®¢é˜…ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/subscribe-only.html) æ–‡æ¡£ã€‚
* ç¬¬ 54 è¡Œï¼šè‹¥æ˜¯æœåŠ¡**æ¶ˆè´¹è€…**ï¼Œåˆ¤æ–­æ˜¯å¦**åªæ³¨å†Œä¸è®¢é˜…**ã€‚å¦‚æœæ˜¯ï¼Œ**ä¸æ·»åŠ **åˆ°ç»“æœ

registryList
ã€‚å¯¹åº” [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” åªæ³¨å†Œã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/registry-only.html) æ–‡æ¡£ã€‚
* ç¬¬ 53 è‡³ 56 è¡Œï¼šæ·»åŠ åˆ°ç»“æœ

registryList
ã€‚
* ä¸ºäº†èƒ–å‹æ›´åŠ å®¹æ˜“ç†è§£ï¼Œæˆ‘ä»¬ä¸¾ä¸ªä¾‹å­ã€‚![æ•°æ®æµå‘](http://static2.iocoder.cn/images/Dubbo/2018_03_07/02.png)

## 2.2 doExportUrlsFor1Protocol

/#doExportUrlsFor1Protocol(protocolConfig, registryURLs)
æ–¹æ³•ï¼ŒåŸºäºå•ä¸ªåè®®ï¼Œæš´éœ²æœåŠ¡ã€‚**ç®€åŒ–**ä»£ç å¦‚ä¸‹ï¼š
```
1: //*/*
2: /* åŸºäºå•ä¸ªåè®®ï¼Œæš´éœ²æœåŠ¡
3: /*
4: /* @param protocolConfig åè®®é…ç½®å¯¹è±¡
5: /* @param registryURLs æ³¨å†Œä¸­å¿ƒé“¾æ¥å¯¹è±¡æ•°ç»„
6: /*/
7: private void doExportUrlsFor1Protocol(ProtocolConfig protocolConfig, List<URL> registryURLs){
8: // ... ã€çœç•¥ã€‘ åˆ›å»ºæœåŠ¡ URL å¯¹è±¡
9:
10: String scope = url.getParameter(Constants.SCOPE_KEY);
11: // don't export when none is configured
12: if (!Constants.SCOPE_NONE.toString().equalsIgnoreCase(scope)) {
13:
14: // export to local if the config is not remote (export to remote only when config is remote)
15: if (!Constants.SCOPE_REMOTE.toString().equalsIgnoreCase(scope)) {
16: exportLocal(url);
17: }
18: // export to remote if the config is not local (export to local only when config is local)
19: if (!Constants.SCOPE_LOCAL.toString().equalsIgnoreCase(scope)) {
20: // ... ã€çœç•¥ã€‘è¿œç¨‹æš´éœ²
21: }
22: }
23: this.urls.add(url);
24: }
```

* ç¬¬ 8 è¡Œï¼šã€çœç•¥ä»£ç ã€‘åˆ›å»ºæœåŠ¡ URL å¯¹è±¡ã€‚

* ğŸ™‚ åœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” API é…ç½®ï¼ˆäºŒï¼‰ä¹‹æœåŠ¡æä¾›è€…ã€‹ã€Œ8. ServiceConfigã€](http://svip.iocoder.cn/Dubbo/configuration-api-2/?self) æœ‰è¯¦ç»†è§£æã€‚
* ç¬¬ 15 è‡³ 17 è¡Œï¼šå½“é

"remote"
æ—¶ï¼Œè°ƒç”¨

/#exportLocal(url)
æ–¹æ³•ï¼Œæœ¬åœ°æš´éœ²æœåŠ¡ã€‚

* ğŸ™‚ åœ¨ [ã€Œ2.2.1 exportLocalã€](http://svip.iocoder.cn/Dubbo/service-export-local/) è¯¦ç»†è§£æã€‚
* ç¬¬ 19 è‡³ 21 è¡Œï¼šã€çœç•¥ä»£ç ã€‘é

"local"
æ—¶ï¼Œè¿œç¨‹æš´éœ²æœåŠ¡ã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œè¯¦ç»†åˆ†äº«ã€‚

### 2.2.1 exportLocal

/#exportLocal(url)
æ–¹æ³•ï¼Œæœ¬åœ°æš´éœ²æœåŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* è‡ªé€‚åº” Protocol å®ç°å¯¹è±¡
/*/
private static final Protocol protocol = ExtensionLoader.getExtensionLoader(Protocol.class).getAdaptiveExtension();
//*/*
/* è‡ªé€‚åº” ProxyFactory å®ç°å¯¹è±¡
/*/
private static final ProxyFactory proxyFactory = ExtensionLoader.getExtensionLoader(ProxyFactory.class).getAdaptiveExtension();
//*/*
/* {@link /#interfaceName} å¯¹åº”çš„æ¥å£ç±»
/*
/* éé…ç½®
/*/
private Class<?> interfaceClass;
//*/*
/* Service å¯¹è±¡
/*/
// reference to interface impl
private T ref;
//*/*
/* æœåŠ¡é…ç½®æš´éœ²çš„ Exporter ã€‚
/* URL ï¼šExporter ä¸ä¸€å®šæ˜¯ 1ï¼š1 çš„å…³ç³»ã€‚
/* ä¾‹å¦‚ {@link /#scope} æœªè®¾ç½®æ—¶ï¼Œä¼šæš´éœ² Local + Remote ä¸¤ä¸ªï¼Œä¹Ÿå°±æ˜¯ URL ï¼šExporter = 1ï¼š2
/* {@link /#scope} è®¾ç½®ä¸ºç©ºæ—¶ï¼Œä¸ä¼šæš´éœ²ï¼Œä¹Ÿå°±æ˜¯ URL ï¼šExporter = 1ï¼š0
/* {@link /#scope} è®¾ç½®ä¸º Local æˆ– Remote ä»»ä¸€æ—¶ï¼Œä¼šæš´éœ² Local æˆ– Remote ä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯ URL ï¼šExporter = 1ï¼š1
/*
/* éé…ç½®ã€‚
/*/
private final List<Exporter<?>> exporters = new ArrayList<Exporter<?>>();
1: //*/*
2: /* æœ¬åœ°æš´éœ²æœåŠ¡
3: /*
4: /* @param url æ³¨å†Œä¸­å¿ƒ URL
5: /*/
6: @SuppressWarnings({"unchecked", "rawtypes"})
7: private void exportLocal(URL url){
8: if (!Constants.LOCAL_PROTOCOL.equalsIgnoreCase(url.getProtocol())) {
9: // åˆ›å»ºæœ¬åœ° Dubbo URL
10: URL local = URL.valueOf(url.toFullString())
11: .setProtocol(Constants.LOCAL_PROTOCOL) // injvm
12: .setHost(LOCALHOST) // æœ¬åœ°
13: .setPort(0); // ç«¯å£=0
14: // æ·»åŠ æœåŠ¡çš„çœŸå®ç±»åï¼Œä¾‹å¦‚ DemoServiceImpl ï¼Œä»…ç”¨äº RestProtocol ä¸­ã€‚
15: ServiceClassHolder.getInstance().pushServiceClass(getServiceClass(ref));
16: // ä½¿ç”¨ ProxyFactory åˆ›å»º Invoker å¯¹è±¡
17: // ä½¿ç”¨ Protocol æš´éœ² Invoker å¯¹è±¡
18: Exporter<?> exporter = protocol.export(proxyFactory.getInvoker(ref, (Class) interfaceClass, local));
19: // æ·»åŠ åˆ° `exporters`
20: exporters.add(exporter);
21: logger.info("Export dubbo service " + interfaceClass.getName() + " to local registry");
22: }
23: }
```

* protocol
**é™æ€**å±æ€§ï¼Œè‡ªé€‚åº” Protocol å®ç°å¯¹è±¡ã€‚

* ä¸ç†Ÿæ‚‰çš„èƒ–å‹ï¼Œè¯·çœ‹ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ‹“å±•æœºåˆ¶ SPIã€‹](http://svip.iocoder.cn/Dubbo/spi/?self) æ–‡ç« ã€‚
* proxyFactory
**é™æ€**å±æ€§ï¼Œè‡ªé€‚åº” ProxyFactory å®ç°å¯¹è±¡ã€‚
* interfaceClass
å±æ€§ï¼ŒService æ¥å£ã€‚
* ref
å±æ€§ï¼ŒService å¯¹è±¡ã€‚
* exporters
å±æ€§ï¼ŒExporter é›†åˆã€‚
* ========== åˆ†å‰²çº¿ ==========
* ç¬¬ 9 è‡³ 13 è¡Œï¼šåŸºäºåŸæœ‰

url
ï¼Œåˆ›å»º**æ–°çš„**æœåŠ¡çš„æœ¬åœ° Dubbo URL å¯¹è±¡ï¼Œå¹¶è®¾ç½®å±æ€§

protocol=injvm

host=127.0.0.1

port=0
ã€‚å› ä¸º

url
åœ¨åé¢è¿œç¨‹æš´éœ²æœåŠ¡ä¼šä½¿ç”¨ï¼Œæ‰€ä»¥è¦æ–°åˆ›å»ºã€‚
* ç¬¬ 15 è¡Œï¼šæ·»åŠ æœåŠ¡çš„çœŸå®ç±»åï¼Œä¾‹å¦‚ DemoServiceImpl ï¼Œä»…ç”¨äº RestProtocol ä¸­ã€‚
* ç¬¬ 18 è¡Œï¼šè°ƒç”¨

ProxyFactory/#getInvoker(proxy, type, url)
æ–¹æ³•ï¼Œåˆ›å»º Invoker å¯¹è±¡ã€‚è¯¥ Invoker å¯¹è±¡ï¼Œæ‰§è¡Œ

/#invoke(invocation)
æ–¹æ³•æ—¶ï¼Œå†…éƒ¨ä¼šè°ƒç”¨ Service å¯¹è±¡(

ref
)å¯¹åº”çš„è°ƒç”¨æ–¹æ³•ã€‚

* ğŸ™‚ è¯¦ç»†çš„å®ç°ï¼Œåé¢å•ç‹¬å†™æ–‡ç« åˆ†äº«ã€‚
* ç¬¬ 18 è¡Œï¼šè°ƒç”¨

Protocol/#export(invoker)
æ–¹æ³•ï¼Œæš´éœ²æœåŠ¡ã€‚

* æ­¤å¤„ Dubbo SPI **è‡ªé€‚åº”**çš„ç‰¹æ€§çš„**å¥½å¤„**å°±å‡ºæ¥äº†ï¼Œå¯ä»¥**è‡ªåŠ¨**æ ¹æ® URL å‚æ•°ï¼Œè·å¾—å¯¹åº”çš„æ‹“å±•å®ç°ã€‚ä¾‹å¦‚ï¼Œ

invoker
ä¼ å…¥åï¼Œæ ¹æ®

invoker.url
è‡ªåŠ¨è·å¾—å¯¹åº” Protocol æ‹“å±•å®ç°ä¸º InjvmProtocol ã€‚
* å®é™…ä¸Šï¼ŒProtocol æœ‰ä¸¤ä¸ª Wrapper æ‹“å±•å®ç°ç±»ï¼š ProtocolFilterWrapperã€ProtocolListenerWrapper ã€‚æ‰€ä»¥ï¼Œ

/#export(...)
æ–¹æ³•çš„è°ƒç”¨é¡ºåºæ˜¯ï¼š**Protocol$Adaptive => ProtocolFilterWrapper => ProtocolListenerWrapper => InjvmProtocol** ã€‚
* ğŸ™‚ è¯¦ç»†çš„è°ƒç”¨ï¼Œåœ¨ [ã€Œ3. Protocolã€](http://svip.iocoder.cn/Dubbo/service-export-local/) åœ¨è§£æã€‚
* ç¬¬ 20 è¡Œï¼šæ·»åŠ åˆ°

exporters
é›†åˆä¸­ã€‚

# 3. Protocol

Protocol **æ¥å£**ï¼Œåœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ ¸å¿ƒæµç¨‹ä¸€è§ˆã€‹ã€Œ4.6 Protocolã€](http://svip.iocoder.cn/Dubbo/service-export-local/) æœ‰è¯¦ç»†è§£æã€‚

æœ¬æ–‡æ¶‰åŠçš„ Protocol ç±»å›¾å¦‚ä¸‹ï¼š

![Protocol ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_03_07/04.png)

## 3.1 Protocol$Adaptive

ä»£ç ç±»ä¼¼ä¸‹å›¾ï¼Œç¬”è€…å·æ‡’ï¼Œå°±ä¸å»é‡æ–°ç”Ÿæˆå•¦ã€‚

![è‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°çš„å­—ç¬¦ä¸²ç”Ÿæˆä¾‹å­](http://static2.iocoder.cn/images/Dubbo/2018_03_04/05.png)

## 3.2 ProtocolFilterWrapper

[
com.alibaba.dubbo.rpc.protocol.ProtocolFilterWrapper
](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/protocol/ProtocolFilterWrapper.java) ï¼Œå®ç° Protocol æ¥å£ï¼ŒProtocol çš„ Wrapper æ‹“å±•å®ç°ç±»ï¼Œç”¨äºç»™ Invoker å¢åŠ è¿‡æ»¤é“¾ã€‚

### 3.2.1 export

æœ¬æ–‡æ¶‰åŠçš„

/#export(invoker)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
1: public <T> Exporter<T> export(Invoker<T> invoker) throws RpcException{
2: // æ³¨å†Œä¸­å¿ƒ
3: if (Constants.REGISTRY_PROTOCOL.equals(invoker.getUrl().getProtocol())) {
4: return protocol.export(invoker);
5: }
6: // å»ºç«‹å¸¦æœ‰ Filter è¿‡æ»¤é“¾çš„ Invoker ï¼Œå†æš´éœ²æœåŠ¡ã€‚
7: return protocol.export(buildInvokerChain(invoker, Constants.SERVICE_FILTER_KEY, Constants.PROVIDER));
8: }
```

* ç¬¬ 2 è‡³ 5 è¡Œï¼šå½“

invoker.url.protocl = registry
ï¼Œè·³è¿‡ï¼Œæœ¬åœ°æš´éœ²æœåŠ¡ä¸ä¼šç¬¦åˆè¿™ä¸ªåˆ¤æ–­ã€‚åœ¨è¿œç¨‹æš´éœ²æœåŠ¡ä¼šç¬¦åˆæš´éœ²è¯¥åˆ¤æ–­ï¼Œæ‰€ä»¥ä¸‹ä¸€ç¯‡æ–‡ç« åˆ†äº«ã€‚
* ç¬¬ 7 è¡Œï¼šè°ƒç”¨

/#buildInvokerChain(invoker, key, group)
æ–¹æ³•ï¼Œåˆ›å»ºå¸¦æœ‰ Filter è¿‡æ»¤é“¾çš„ Invoker å¯¹è±¡ã€‚

* ğŸ™‚ åœ¨ [ã€Œ3.2.2 buildInvokerChainã€](http://svip.iocoder.cn/Dubbo/service-export-local/) è¯¦ç»†è§£æã€‚
* ç¬¬ 7 è¡Œï¼šè°ƒç”¨

protocol/#export(invoker)
æ–¹æ³•ï¼Œç»§ç»­æš´éœ²æœåŠ¡ã€‚

### 3.2.2 buildInvokerChain

/#buildInvokerChain(invoker, key, group)
æ–¹æ³•ï¼Œåˆ›å»ºå¸¦ Filter é“¾çš„ Invoker å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: //*/*
2: /* åˆ›å»ºå¸¦ Filter é“¾çš„ Invoker å¯¹è±¡
3: /*
4: /* @param invoker Invoker å¯¹è±¡
5: /* @param key è·å– URL å‚æ•°å
6: /* @param group åˆ†ç»„
7: /* @param <T> æ³›å‹
8: /* @return Invoker å¯¹è±¡
9: /*/
10: private static <T> Invoker<T> buildInvokerChain(final Invoker<T> invoker, String key, String group){
11: Invoker<T> last = invoker;
12: // è·å¾—è¿‡æ»¤å™¨æ•°ç»„
13: List<Filter> filters = ExtensionLoader.getExtensionLoader(Filter.class).getActivateExtension(invoker.getUrl(), key, group);
14: // å€’åºå¾ªç¯ Filter ï¼Œåˆ›å»ºå¸¦ Filter é“¾çš„ Invoker å¯¹è±¡
15: if (!filters.isEmpty()) {
16: for (int i = filters.size() - 1; i >= 0; i--) {
17: final Filter filter = filters.get(i);
18: final Invoker<T> next = last;
19: last = new Invoker<T>() {
20:
21: public Class<T> getInterface(){
22: return invoker.getInterface();
23: }
24:
25: public URL getUrl(){
26: return invoker.getUrl();
27: }
28:
29: public boolean isAvailable(){
30: return invoker.isAvailable();
31: }
32:
33: public Result invoke(Invocation invocation) throws RpcException{
34: return filter.invoke(next, invocation);
35: }
36:
37: public void destroy(){
38: invoker.destroy();
39: }
40:
41: @Override
42: public String toString(){
43: return invoker.toString();
44: }
45: };
46: }
47: }
48: return last;
49: }
```

* key
å±æ€§ï¼Œè·å¾— URL å‚æ•°åã€‚

* è¯¥å‚æ•°ç”¨äºè·å¾— ServiceConfig æˆ– ReferenceConfig é…ç½®çš„è‡ªå®šä¹‰è¿‡æ»¤å™¨ã€‚
* ä»¥ ServiceConfig ä¸¾ä¾‹å­ï¼Œä¾‹å¦‚

url = injvm://127.0.0.1/com.alibaba.dubbo.demo.DemoService?anyhost=true&application=demo-provider&bind.ip=192.168.3.17&bind.port=20880&default.delay=-1&default.retries=0&default.service.filter=demo&delay=-1&dubbo=2.0.0&generic=false&interface=com.alibaba.dubbo.demo.DemoService&methods=sayHello&pid=81844&qos.port=22222&service.filter=demo&side=provider&timestamp=1520682156043
ä¸­ï¼Œ**
service.filter=demo
**ï¼Œè¿™æ˜¯ç¬”è€…é…ç½®è‡ªå®šä¹‰çš„ DemoFilter è¿‡æ»¤å™¨ã€‚
```
<dubbo:service interface="com.alibaba.dubbo.demo.DemoService" ref="demoService" filter="demo" />
```

* x
* group
å±æ€§ï¼Œåˆ†ç»„ã€‚

* åœ¨æš´éœ²æœåŠ¡æ—¶ï¼Œ

group = provider
ã€‚
* åœ¨å¼•ç”¨æœåŠ¡æ—¶ï¼Œ

group = consumer
ã€‚
* ========== åˆ†å‰²çº¿ ==========
* ç¬¬ 13 è¡Œï¼šè°ƒç”¨

ExtensionLoader/#getActivateExtension(url, key, group)
æ–¹æ³•ï¼Œè·å¾—è¿‡æ»¤å™¨æ•°ç»„ã€‚

* ğŸ™‚ ä¸ç†Ÿæ‚‰çš„èƒ–å‹ï¼Œè¯·çœ‹ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ‹“å±•æœºåˆ¶ SPIã€‹](http://svip.iocoder.cn/Dubbo/spi/?self) æ–‡ç« ã€‚
* ç»§ç»­ä»¥ä¸Šé¢çš„ä¾‹å­ä¸ºåŸºç¡€ï¼Œ

filters
ä¸ºï¼š

* EchoFilter
* ClassLoaderFilter
* GenericFilter
* ContextFilter
* TraceFilter
* TimeoutFilter
* MonitorFilter
* ExceptionFilter
* DemoFilter ã€è‡ªå®šä¹‰ã€‘
* ç¬¬ 15 è‡³ 47 è¡Œï¼š**å€’åº**å¾ªç¯ Filter ï¼Œåˆ›å»ºå¸¦ Filter é“¾çš„ Invoker å¯¹è±¡ã€‚å› ä¸ºæ˜¯é€šè¿‡**åµŒå¥—**å£°æ˜åŒ¿åç±»å¾ªç¯è°ƒç”¨çš„æ–¹å¼ï¼Œæ‰€ä»¥è¦å€’åºã€‚èƒ–å‹å¯ä»¥æ‰‹å·¥æ¨¡æ‹Ÿä¸‹è¿™ä¸ªè¿‡ç¨‹ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå®é™…è¿‡æ»¤çš„é¡ºåºï¼Œè¿˜æ˜¯æˆ‘ä»¬ä¸Šé¢çœ‹åˆ°çš„**æ­£åº**ã€‚

## 3.3 ProtocolListenerWrapper

[
com.alibaba.dubbo.rpc.protocol.ProtocolListenerWrapper
](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/protocol/ProtocolListenerWrapper.java) ï¼Œå®ç° Protocol æ¥å£ï¼ŒProtocol çš„ Wrapper æ‹“å±•å®ç°ç±»ï¼Œç”¨äºç»™ Exporter å¢åŠ  ExporterListener ï¼Œç›‘å¬ Exporter æš´éœ²å®Œæˆå’Œå–æ¶ˆæš´éœ²å®Œæˆã€‚

### 3.3.1 export

æœ¬æ–‡æ¶‰åŠçš„

/#export(invoker)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
1: public <T> Exporter<T> export(Invoker<T> invoker) throws RpcException{
2: // æ³¨å†Œä¸­å¿ƒ
3: if (Constants.REGISTRY_PROTOCOL.equals(invoker.getUrl().getProtocol())) {
4: return protocol.export(invoker);
5: }
6: // æš´éœ²æœåŠ¡ï¼Œåˆ›å»º Exporter å¯¹è±¡
7: Exporter<T> exporter = protocol.export(invoker);
8: // è·å¾— ExporterListener æ•°ç»„
9: List<ExporterListener> listeners = Collections.unmodifiableList(ExtensionLoader.getExtensionLoader(ExporterListener.class).getActivateExtension(invoker.getUrl(), Constants.EXPORTER_LISTENER_KEY));
10: // åˆ›å»ºå¸¦ ExporterListener çš„ Exporter å¯¹è±¡
11: return new ListenerExporterWrapper<T>(exporter, listeners);
12: }
```

* ç¬¬ 2 è‡³ 5 è¡Œï¼šå½“

invoker.url.protocl = registry
ï¼Œè·³è¿‡ï¼Œæœ¬åœ°æš´éœ²æœåŠ¡ä¸ä¼šç¬¦åˆè¿™ä¸ªåˆ¤æ–­ã€‚åœ¨è¿œç¨‹æš´éœ²æœåŠ¡ä¼šç¬¦åˆæš´éœ²è¯¥åˆ¤æ–­ï¼Œæ‰€ä»¥ä¸‹ä¸€ç¯‡æ–‡ç« åˆ†äº«ã€‚
* ç¬¬ 7 è¡Œï¼šè°ƒç”¨

InjvmProtocol/#export(invoker)
æ–¹æ³•ï¼Œæš´éœ²æœ¬åœ°æœåŠ¡ï¼Œåˆ›å»º InjvmExporter å¯¹è±¡ã€‚

* ğŸ™‚ åœ¨ [ã€Œ4.2 InjvmExporterã€](http://svip.iocoder.cn/Dubbo/service-export-local/) è¯¦ç»†è§£æã€‚
* ç¬¬ 9 è¡Œï¼šè°ƒç”¨

ExtensionLoader/#getActivateExtension(url, key, group)
æ–¹æ³•ï¼Œè·å¾—ç›‘å¬å™¨æ•°ç»„ã€‚

* ğŸ™‚ ä¸ç†Ÿæ‚‰çš„èƒ–å‹ï¼Œè¯·çœ‹ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ‹“å±•æœºåˆ¶ SPIã€‹](http://svip.iocoder.cn/Dubbo/spi/?self) æ–‡ç« ã€‚
* ç»§ç»­ä»¥ä¸Šé¢çš„ä¾‹å­ä¸ºåŸºç¡€ï¼Œ

listeners
ä¸º**ç©º**ã€‚èƒ–å‹å¯ä»¥è‡ªè¡Œå®ç° ExporterListener ï¼Œå¹¶è¿›è¡Œé…ç½®

@Activate
æ³¨è§£ï¼Œæˆ–è€… XML ä¸­

listener
å±æ€§ã€‚
* ç¬¬ 11 è¡Œï¼šåˆ›å»ºå¸¦ ExporterListener çš„ ListenerExporterWrapper å¯¹è±¡ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¼šæ‰§è¡Œ

ExporterListener/#exported(exporter)
æ–¹æ³•ã€‚

* ğŸ™‚ åœ¨ [ã€Œ4.3 ListenerExporterWrapperã€](http://svip.iocoder.cn/Dubbo/service-export-local/) è¯¦ç»†è§£æã€‚

## 3.4 AbstractProtocol

[
com.alibaba.dubbo.rpc.protocol.AbstractProtocol
](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/protocol/AbstractProtocol.java) ï¼Œå®ç° Protocol æ¥å£ï¼Œåè®®æŠ½è±¡ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public abstract class AbstractProtocol implements Protocol{
//*/*
/* Exporter é›†åˆ
/*
/* key: æœåŠ¡é”® {@link /#serviceKey(URL)} æˆ– {@link URL/#getServiceKey()} ã€‚
/* ä¸åŒåè®®ä¼šä¸åŒ
/*/
protected final Map<String, Exporter<?>> exporterMap = new ConcurrentHashMap<String, Exporter<?>>();
// ... çœç•¥å’Œæœ¬æ–‡æ— å…³çš„æ–¹æ³•ä¸å±æ€§
}
```

* exporterMap
å±æ€§ï¼ŒExporter é›†åˆã€‚**è¯¥é›†åˆæ‹¥æœ‰è¯¥åè®®ä¸­ï¼Œæ‰€æœ‰æš´éœ²ä¸­çš„ Exporter å¯¹è±¡**ã€‚å…¶ä¸­

key
ä¸ºæœåŠ¡é”®ã€‚ä¸åŒåè®®çš„å®ç°ï¼Œç”Ÿæˆçš„æ–¹å¼**ç•¥æœ‰å·®è·**ã€‚ä¾‹å¦‚ï¼š

* InjvmProtocol ä½¿ç”¨

URL/#getServiceKey()
æ–¹æ³•
* DubboProtocol ä½¿ç”¨

/#serviceKey(URL)
æ–¹æ³•ã€‚
* å·®åˆ«ä¸»è¦åœ¨äºæ˜¯å¦åŒ…å«

port
ã€‚å®é™…ä¸Šï¼Œä¹Ÿæ˜¯**ä¸€è‡´çš„**ã€‚å› ä¸º InjvmProtocol ç»Ÿä¸€

port=0
ã€‚
* è¯¥ç±»ä¸­ï¼Œ**çœç•¥å’Œæœ¬æ–‡æ— å…³çš„æ–¹æ³•ä¸å±æ€§**ã€‚

## 3.5 InjvmProtocol

[
com.alibaba.dubbo.rpc.protocol.injvm.InjvmProtocol
](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-injvm/src/main/java/com/alibaba/dubbo/rpc/protocol/injvm/InjvmProtocol.java) ï¼Œå®ç° AbstractProtocol æŠ½è±¡ç±»ï¼ŒInjvm åè®®å®ç°ç±»ã€‚

### 3.5.1 å±æ€§

å±æ€§ç›¸å…³ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* åè®®å
/*/
public static final String NAME = Constants.LOCAL_PROTOCOL;
//*/*
/* é»˜è®¤ç«¯å£
/*/
public static final int DEFAULT_PORT = 0;
//*/*
/* å•ä¾‹ã€‚åœ¨ Dubbo SPI ä¸­ï¼Œè¢«åˆå§‹åŒ–ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€æ¬¡ã€‚
/*/
private static InjvmProtocol INSTANCE;
public InjvmProtocol(){
INSTANCE = this;
}
public static InjvmProtocol getInjvmProtocol(){
if (INSTANCE == null) {
ExtensionLoader.getExtensionLoader(Protocol.class).getExtension(InjvmProtocol.NAME); // load
}
return INSTANCE;
}
```

* NAME
**é™æ€**å±æ€§ï¼Œ

injvm
ï¼Œåè®®åã€‚
* DEFAULT_PORT
**é™æ€**å±æ€§ï¼Œé»˜è®¤ç«¯å£ä¸º 0 ã€‚
* INSTANCE
**é™æ€**å±æ€§ï¼Œå•ä¾‹ã€‚é€šè¿‡ Dubbo SPI åŠ è½½åˆ›å»ºï¼Œæœ‰ä¸”ä»…æœ‰ä¸€æ¬¡ã€‚

* /#getInjvmProtocol()
**é™æ€**æ–¹æ³•ï¼Œè·å¾—å•ä¾‹ã€‚

### 3.5.2 export

æœ¬æ–‡æ¶‰åŠçš„

/#export(invoker)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
public <T> Exporter<T> export(Invoker<T> invoker) throws RpcException{
return new InjvmExporter<T>(invoker, invoker.getUrl().getServiceKey(), exporterMap);
}
```

* åˆ›å»º InjvmExporter å¯¹è±¡ã€‚

# 4. Exporter

Exporter **æ¥å£**ï¼Œåœ¨ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æ ¸å¿ƒæµç¨‹ä¸€è§ˆã€‹ã€Œ4.7 Exporterã€](http://svip.iocoder.cn/Dubbo/service-export-local/) æœ‰è¯¦ç»†è§£æã€‚

æœ¬æ–‡æ¶‰åŠçš„ Exporter ç±»å›¾å¦‚ä¸‹ï¼š

![Exporter ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_03_07/05.png)

## 4.1 AbstractExporter

[
com.alibaba.dubbo.rpc.protocol.AbstractExporter
](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/protocol/AbstractExporter.java) ï¼Œå®ç° Exporter æ¥å£ï¼ŒExporter æŠ½è±¡ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public abstract class AbstractExporter<T> implements Exporter<T>{
protected final Logger logger = LoggerFactory.getLogger(getClass());
//*/*
/* Invoker å¯¹è±¡
/*/
private final Invoker<T> invoker;
//*/*
/* æ˜¯å¦å–æ¶ˆæš´éœ²æœåŠ¡
/*/
private volatile boolean unexported = false;
public AbstractExporter(Invoker<T> invoker){
if (invoker == null)
throw new IllegalStateException("service invoker == null");
if (invoker.getInterface() == null)
throw new IllegalStateException("service type == null");
if (invoker.getUrl() == null)
throw new IllegalStateException("service url == null");
this.invoker = invoker;
}
@Override
public Invoker<T> getInvoker(){
return invoker;
}
@Override
public void unexport(){
if (unexported) {
return;
}
unexported = true;
getInvoker().destroy();
}
public String toString(){
return getInvoker().toString();
}
}
```

* invoker
å±æ€§ï¼ŒInvoker å¯¹è±¡ã€‚

* /#getInvoker()
æ–¹æ³•ï¼Œè·å¾— Invoker å¯¹è±¡ã€‚
* unexported
å±æ€§ï¼Œæ˜¯å¦å–æ¶ˆæš´éœ²æœåŠ¡ã€‚

* /#unexport()
æ–¹æ³•ï¼Œå–æ¶ˆæš´éœ²æœåŠ¡ã€‚

## 4.2 InjvmExporter

[
com.alibaba.dubbo.rpc.protocol.injvm.InjvmProtocol
](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-injvm/src/main/java/com/alibaba/dubbo/rpc/protocol/injvm/InjvmExporter.java) ï¼Œå®ç° AbstractExporter æŠ½è±¡ç±»ï¼ŒInjvm Exporter å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
class InjvmExporter<T> extends AbstractExporter<T>{
//*/*
/* æœåŠ¡é”®
/*/
private final String key;
//*/*
/* Exporter é›†åˆ
/*
/* key: æœåŠ¡é”®
/*
/* è¯¥å€¼å®é™…å°±æ˜¯ {@link com.alibaba.dubbo.rpc.protocol.AbstractProtocol/#exporterMap}
/*/
private final Map<String, Exporter<?>> exporterMap;
InjvmExporter(Invoker<T> invoker, String key, Map<String, Exporter<?>> exporterMap) {
super(invoker);
this.key = key;
this.exporterMap = exporterMap;
// æ·»åŠ åˆ° Exporter é›†åˆ
exporterMap.put(key, this);
}
@Override
public void unexport(){
super.unexport();
// ç§»é™¤å‡º Exporter é›†åˆ
exporterMap.remove(key);
}
}
```

* key
å±æ€§ï¼ŒæœåŠ¡é”®ã€‚
* exporterMap
å±æ€§ï¼ŒExporter é›†åˆã€‚åœ¨ä¸Šæ–‡

InjvmProtocol/#export(invoker)
æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¯¥å±æ€§å°±æ˜¯

AbstractProtocol.exporterMap
å±æ€§ã€‚

* **æ„é€ æ–¹æ³•**ï¼Œ**å‘èµ·**æš´éœ²ï¼Œå°†è‡ªå·±æ·»åŠ åˆ°

exporterMap
ä¸­ã€‚
* /#unexport()
æ–¹æ³•ï¼Œ**å–æ¶ˆ**æš´éœ²ï¼Œå°†è‡ªå·±ç§»é™¤å‡º

exporterMap
ä¸­ã€‚

## 4.3 ListenerExporterWrapper

[
com.alibaba.dubbo.rpc.listener.ListenerExporterWrapper
](https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/listener/ListenerExporterWrapper.java) ï¼Œå®ç° Exporter æ¥å£ï¼Œå…·æœ‰ç›‘å¬å™¨åŠŸèƒ½çš„ Exporter åŒ…è£…å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public class ListenerExporterWrapper<T> implements Exporter<T>{
private static final Logger logger = LoggerFactory.getLogger(ListenerExporterWrapper.class);
//*/*
/* çœŸå®çš„ Exporter å¯¹è±¡
/*/
private final Exporter<T> exporter;
//*/*
/* Exporter ç›‘å¬å™¨æ•°ç»„
/*/
private final List<ExporterListener> listeners;
public ListenerExporterWrapper(Exporter<T> exporter, List<ExporterListener> listeners){
if (exporter == null) {
throw new IllegalArgumentException("exporter == null");
}
this.exporter = exporter;
this.listeners = listeners;
// æ‰§è¡Œç›‘å¬å™¨
if (listeners != null && !listeners.isEmpty()) {
RuntimeException exception = null;
for (ExporterListener listener : listeners) {
if (listener != null) {
try {
listener.exported(this);
} catch (RuntimeException t) {
logger.error(t.getMessage(), t);
exception = t;
}
}
}
if (exception != null) {
throw exception;
}
}
}
public Invoker<T> getInvoker(){
return exporter.getInvoker();
}
public void unexport(){
try {
exporter.unexport();
} finally {
// æ‰§è¡Œç›‘å¬å™¨
if (listeners != null && !listeners.isEmpty()) {
RuntimeException exception = null;
for (ExporterListener listener : listeners) {
if (listener != null) {
try {
listener.unexported(this);
} catch (RuntimeException t) {
logger.error(t.getMessage(), t);
exception = t;
}
}
}
if (exception != null) {
throw exception;
}
}
}
}
}
```

* **æ„é€ æ–¹æ³•**ï¼Œå¾ªç¯

listeners
ï¼Œæ‰§è¡Œ

ExporterListener/#exported(listener)
ã€‚è‹¥æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ RuntimeException ï¼Œæ‰“å°é”™è¯¯æ—¥å¿—ï¼Œç»§ç»­æ‰§è¡Œï¼Œæœ€ç»ˆæ‰æŠ›å‡ºã€‚
* /#unexport()
æ–¹æ³•ï¼Œå¾ªç¯

listeners
ï¼Œæ‰§è¡Œ

ExporterListener/#unexported(listener)
ã€‚è‹¥æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ RuntimeException ï¼Œæ‰“å°é”™è¯¯æ—¥å¿—ï¼Œç»§ç»­æ‰§è¡Œï¼Œæœ€ç»ˆæ‰æŠ›å‡ºã€‚

# 5. ExporterListener

[
com.alibaba.dubbo.rpc.ExporterListener
](https://github.com/YunaiV/dubbo/blob/6de0a069fcc870894e64ffd54a24e334b19dcb36/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/ExporterListener.java) ï¼ŒExporter ç›‘å¬å™¨ã€‚

ä»£ç å¦‚ä¸‹ï¼š
```
@SPI
public interface ExporterListener{
//*/*
/* The exporter exported.
/*
/* å½“æœåŠ¡æš´éœ²å®Œæˆ
/*
/* @param exporter
/* @throws RpcException
/* @see com.alibaba.dubbo.rpc.Protocol/#export(Invoker)
/*/
void exported(Exporter<?> exporter) throws RpcException;
//*/*
/* The exporter unexported.
/*
/* å½“æœåŠ¡å–æ¶ˆæš´éœ²å®Œæˆ
/*
/* @param exporter
/* @throws RpcException
/* @see com.alibaba.dubbo.rpc.Exporter/#unexport()
/*/
void unexported(Exporter<?> exporter);
}
```

![ExporterListener å­ç±»](http://static2.iocoder.cn/images/Dubbo/2018_03_01/17.png)

## 5.1 ExporterListenerAdapter

com.alibaba.dubbo.rpc.listener.ExporterListenerAdapter
ï¼Œå®ç° ExporterListener æ¥å£ï¼ŒExporterListener é€‚é…å™¨æŠ½è±¡ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public abstract class ExporterListenerAdapter implements ExporterListener{
public void exported(Exporter<?> exporter) throws RpcException{ }
public void unexported(Exporter<?> exporter) throws RpcException{ }
}
```