<header class="article-header">
<h1 class="article-title">è¿‡æ»¤å™¨ï¼ˆä¸€ï¼‰ä¹‹ ClassLoaderFilter</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>ä»æœ¬æ–‡å¼€å§‹ï¼Œæˆ‘ä»¬æ¥åˆ†äº« Dubbo çš„<strong>è¿‡æ»¤å™¨</strong>ä»¬ã€‚åœ¨ ProtocolFilterWrapper ä¸­ï¼Œåœ¨æœåŠ¡å¼•ç”¨å’Œæš´éœ²æ—¶ï¼Œ<code>#buildInvokerChain(invoker, key, group)</code>&nbsp;æ–¹æ³•ä¸­ï¼ŒåŸºäº Dubbo SPI&nbsp;<strong>Active</strong>&nbsp;æœºåˆ¶ï¼ŒåŠ è½½<strong>åŒ¹é…</strong>å¯¹åº”çš„è¿‡æ»¤å™¨æ•°ç»„ï¼Œåˆ›å»ºå¸¦æœ‰<strong>è¿‡æ»¤å™¨é“¾çš„ Invoker å¯¹è±¡</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * åˆ›å»ºå¸¦ Filter é“¾çš„ Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> invoker Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> key è·å– URL å‚æ•°å</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> group åˆ†ç»„</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt; æ³›å‹</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">buildInvokerChain</span><span class="params">(<span class="keyword">final</span> Invoker&lt;T&gt; invoker, String key, String group)</span> </span>{</span><br /><span class="line">    Invoker&lt;T&gt; last = invoker;</span><br /><span class="line">    <span class="comment">// è·å¾—è¿‡æ»¤å™¨æ•°ç»„</span></span><br /><span class="line">    List&lt;Filter&gt; filters = ExtensionLoader.getExtensionLoader(Filter.class).getActivateExtension(invoker.getUrl(), key, group);</span><br /><span class="line">    <span class="comment">// å€’åºå¾ªç¯ Filter ï¼Œåˆ›å»ºå¸¦ Filter é“¾çš„ Invoker å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">if</span> (!filters.isEmpty()) {</span><br /><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = filters.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {</span><br /><span class="line">            <span class="keyword">final</span> Filter filter = filters.get(i);</span><br /><span class="line">            <span class="keyword">final</span> Invoker&lt;T&gt; next = last;</span><br /><span class="line">            last = <span class="keyword">new</span> Invoker&lt;T&gt;() {</span><br /><br /><span class="line">                <span class="meta">@Override</span></span><br /><span class="line">                <span class="function"><span class="keyword">public</span> Class&lt;T&gt; <span class="title">getInterface</span><span class="params">()</span> </span>{</span><br /><span class="line">                    <span class="keyword">return</span> invoker.getInterface();</span><br /><span class="line">                }</span><br /><br /><span class="line">                <span class="meta">@Override</span></span><br /><span class="line">                <span class="function"><span class="keyword">public</span> URL <span class="title">getUrl</span><span class="params">()</span> </span>{</span><br /><span class="line">                    <span class="keyword">return</span> invoker.getUrl();</span><br /><span class="line">                }</span><br /><br /><span class="line">                <span class="meta">@Override</span></span><br /><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>{</span><br /><span class="line">                    <span class="keyword">return</span> invoker.isAvailable();</span><br /><span class="line">                }</span><br /><br /><span class="line">                <span class="meta">@Override</span></span><br /><span class="line">                <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">                    <span class="keyword">return</span> filter.invoke(next, invocation);</span><br /><span class="line">                }</span><br /><br /><span class="line">                <span class="meta">@Override</span></span><br /><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line">                    invoker.destroy();</span><br /><span class="line">                }</span><br /><br /><span class="line">                <span class="meta">@Override</span></span><br /><span class="line">                <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>{</span><br /><span class="line">                    <span class="keyword">return</span> invoker.toString();</span><br /><span class="line">                }</span><br /><span class="line">            };</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> last;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å…·ä½“çš„è¿‡æ»¤å™¨é“¾çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œåœ¨å‰é¢çš„ Dubbo RPC è°ƒç”¨ï¼Œå·²ç»åˆ†äº«ï¼Œè¿™é‡Œå°±ä¸é‡å¤è§£é‡Šå•¦ã€‚</li>
</ul>
<p>æˆ‘ä»¬æŠŠæœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…çš„è¿‡æ»¤å™¨ç»Ÿä¸€æ•´ç†å¦‚ä¸‹ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_11_12/01.png" alt="è¿‡æ»¤å™¨æ•´ç†" /></p>
<ul>
<li><strong>é»„è‰²</strong>éƒ¨åˆ†ï¼Œä»£è¡¨è¿‡æ»¤å™¨åœ¨æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…ä¸Šçš„é¡ºåºã€‚è‹¥ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºæ— è¯¥è¿‡æ»¤å™¨ã€‚</li>
<li><strong>è“è‰²</strong>éƒ¨åˆ†ï¼ŒEchoFilter ç­‰ç­‰ï¼Œå·²ç»åœ¨å…¶ä»–æ–‡ç« é‡Œåˆ†äº«ã€‚
<ul>
<li><code>dubbo-filter-cache</code>&nbsp;çš„ CacheFilter,&nbsp;<code>dubbo-filter-validation</code>&nbsp;çš„ ValidationFilter ï¼Œæœªç½—åˆ—åœ¨è¡¨æ ¼ä¸­ï¼Œä¹Ÿä¼šåœ¨å…¶ä»–æ–‡ç« é‡Œåˆ†äº«ã€‚</li>
</ul>
</li>
<li><strong>ç»¿è‰²</strong>éƒ¨åˆ† ï¼ŒCompatibleFilter ç­‰ç­‰ï¼Œç›®å‰æœªå¼€å¯ Dubbo SPI&nbsp;<code>@Adaptive</code>&nbsp;æ³¨è§£ï¼Œæˆ‘ä»¬å°±ä¸å†™äº†ã€‚</li>
</ul>
<p>æœ¬æ–‡åˆ†äº« ClassLoaderFilter ã€‚åç»­çš„æ–‡ç« ï¼Œä¹Ÿä¼šæ˜¯æ¯ç¯‡æ–‡ç« åˆ†äº« 1-2 ä¸ªè¿‡æ»¤å™¨ï¼Œæ ¹æ®å®é™…ç”¨é€”çš„æƒ…å†µã€‚</p>
<h1 id="2-Filter">2. Filter</h1>
<p>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/implementation-intro/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æ ¸å¿ƒæµç¨‹ä¸€è§ˆã€‹ã€Œ4.4 Filterã€</a>&nbsp;ä¸­ï¼Œå·²ç»è¯¦ç»†åˆ†äº«ã€‚</p>
<h1 id="3-ClassLoaderFilter">3. ClassLoaderFilter</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/filter/ClassLoaderFilter.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.rpc.filter.ClassLoaderFilter</code></a>&nbsp;ï¼Œå®ç° Filter æ¥å£ï¼Œç±»åŠ è½½å™¨åˆ‡æ¢è¿‡æ»¤å™¨å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Activate</span>(group = Constants.PROVIDER, order = -<span class="number">30000</span>)</span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoaderFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>{</span><br /><span class="line"> <span class="number">3</span>: </span><br /><span class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">6</span>:         <span class="comment">// è·å¾—åŸæ¥çš„ç±»åŠ è½½å™¨</span></span><br /><span class="line"> <span class="number">7</span>:         ClassLoader ocl = Thread.currentThread().getContextClassLoader();</span><br /><span class="line"> <span class="number">8</span>:         <span class="comment">// åˆ‡æ¢å½“å‰çº¿ç¨‹çš„ç±»åŠ è½½å™¨ä¸ºæœåŠ¡æ¥å£çš„ç±»åŠ è½½å™¨</span></span><br /><span class="line"> <span class="number">9</span>:         Thread.currentThread().setContextClassLoader(invoker.getInterface().getClassLoader());</span><br /><span class="line"><span class="number">10</span>:         <span class="comment">// æœåŠ¡è°ƒç”¨</span></span><br /><span class="line"><span class="number">11</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">12</span>:             <span class="keyword">return</span> invoker.invoke(invocation);</span><br /><span class="line"><span class="number">13</span>:         } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">14</span>:             <span class="comment">// åˆ‡æ¢å½“å‰çº¿ç¨‹çš„ç±»åŠ è½½å™¨ä¸ºåŸæ¥çš„ç±»åŠ è½½å™¨</span></span><br /><span class="line"><span class="number">15</span>:             Thread.currentThread().setContextClassLoader(ocl);</span><br /><span class="line"><span class="number">16</span>:         }</span><br /><span class="line"><span class="number">17</span>:     }</span><br /><span class="line"><span class="number">18</span>: </span><br /><span class="line"><span class="number">19</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 7 è¡Œï¼šè°ƒç”¨&nbsp;<code>Thread#getContextClassLoader()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—<strong>åŸæ¥çš„</strong>ç±»åŠ è½½å™¨ã€‚</li>
<li>ç¬¬ 9 è¡Œï¼šè°ƒç”¨&nbsp;<code>Thread#setContextClassLoader(ClassLoader)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>åˆ‡æ¢</strong>å½“å‰çº¿ç¨‹çš„ç±»åŠ è½½å™¨ä¸º<strong>æœåŠ¡æ¥å£çš„</strong>ç±»åŠ è½½å™¨ã€‚</li>
<li>ç¬¬ 12 è¡Œï¼šè°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚</li>
<li>ç¬¬ 15 è¡Œï¼šè°ƒç”¨&nbsp;<code>Thread#setContextClassLoader(ClassLoader)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>åˆ‡æ¢</strong>å½“å‰çº¿ç¨‹çš„ç±»åŠ è½½å™¨ä¸º<strong>åŸæ¥çš„</strong>ç±»åŠ è½½å™¨ã€‚</li>
</ul>
<p>ç¬”è€…çœ‹åˆ°è¿™ä¸ªè¿‡æ»¤å™¨ï¼Œè¡¨ç¤ºä¸€è„¸æ‡µé€¼ï¼Œäºæ˜¯å¼€å§‹ Google æ¢ç´¢ä¹‹è·¯ã€‚</p>
<p>1ã€äºæ˜¯æœåˆ°&nbsp;<a href="https://github.com/apache/incubator-dubbo/issues/1406" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠISSUE#1406ï¼šclassloaderFilterã€‹</a>&nbsp;ï¼Œå†…å®¹å¦‚ä¸‹ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_11_12/02.png" alt="ISSUE#1406" /></p>
<p>ä½¿ç”¨æˆ‘å¤§æœ‰é“è¯å…¸ç¿»è¯‘ï¼š</p>
<blockquote>
<p>åœ¨è®¾è®¡ç›®çš„ä¸­ï¼Œåˆ‡æ¢åˆ°åŠ è½½äº†æ¥å£å®šä¹‰çš„ç±»åŠ è½½å™¨ï¼Œä»¥ä¾¿å®ç°ä¸ç›¸åŒçš„ç±»åŠ è½½å™¨ä¸Šä¸‹æ–‡ä¸€èµ·å·¥ä½œã€‚</p>
</blockquote>
<p>2ã€é‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¸‹ä¼šæœ‰å¤šä¸ª ClassLoader çš„æƒ…å†µå‘¢ï¼Ÿå†äºæ˜¯æœåˆ°&nbsp;<a href="https://github.com/apache/incubator-dubbo/issues/178" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠISSUE#178ï¼šé¡¹ç›®æœ‰å¤šä¸ªClassLoadæ—¶ä½¿ç”¨dubboå‡ºé”™ï¼›ã€‹</a>&nbsp;ï¼Œå†…å®¹å¦‚ä¸‹ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_11_12/03.png" alt="ISSUE#178" /></p>
<p>å¼€å§‹æ£€ç´¢&nbsp;<strong>pf4j</strong>&nbsp;æ˜¯ä»€ä¹ˆä¸œä¸œï¼Ÿ</p>
<blockquote>
<p>FROM&nbsp;<a href="https://www.oschina.net/p/pf4j" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠJava çš„æ’ä»¶æ¡†æ¶ PF4Jã€‹</a></p>
<p>PF4J æ˜¯ä¸€ä¸ª Java çš„æ’ä»¶æ¡†æ¶ï¼Œä¸ºç¬¬ä¸‰æ–¹æä¾›åº”ç”¨æ‰©å±•çš„æ¸ é“ã€‚ä½¿ç”¨ PF4J ä½ å¯ä»¥è½»æ¾å°†ä¸€ä¸ªæ™®é€šçš„ Java åº”ç”¨è½¬æˆä¸€ä¸ªæ¨¡å—åŒ–çš„åº”ç”¨ã€‚PF4J æœ¬èº«éå¸¸è½»é‡çº§ï¼Œåªæœ‰ 50KB å·¦å³ï¼Œç›®å‰åªä¾èµ–äº† slf4jã€‚<a href="https://www.oschina.net/p/gitblit" target="_blank" rel="external nofollow noopener noreferrer">Gitblit</a>&nbsp;é¡¹ç›®ä½¿ç”¨çš„å°±æ˜¯ PF4J è¿›è¡Œæ’ä»¶ç®¡ç†ã€‚</p>
</blockquote>
<p>ğŸ™‚ çœ‹åˆ°æ­¤å¤„ï¼Œç¬”è€…å·²ç»è¿›å…¥äº†äº‘é‡Œå’Œé›¾é‡Œã€‚æ‰€ä»¥ï¼Œæˆ‘ä»…ä»…æ˜¯æŠ›ä¸ªç –ï¼Œæš‚æ—¶è¿˜æ²¡å»æµ‹è¯•ã€‚å†æ‰€ä»¥ï¼Œèƒ–å‹å¦‚æœæ„Ÿå…´è¶£ï¼Œå¯ä»¥è‡ªå·±å»ç ”ç©¶ä¸‹ä¸‹ã€‚æˆ‘çš„çŒœæµ‹æ˜¯ï¼Œä½¿ç”¨ PF4J åŠ è½½ä¸åŒçš„æœåŠ¡å®ç°ç±»çš„ Jar ï¼Œä¸åŒçš„ Jar çš„ç±»åŠ è½½å™¨ä¸åŒã€‚</p>
<p>æœ‰ç†Ÿæ‚‰è¿™å—çš„èƒ–å‹ï¼Œå¦‚æœæœ‰é”™è¯¯ï¼Œè¯·ç«‹å³æ–§æ­£æˆ‘ã€‚å“ˆå“ˆå“ˆã€‚</p>
</div>