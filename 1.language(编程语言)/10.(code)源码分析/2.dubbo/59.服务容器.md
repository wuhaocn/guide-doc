# æœåŠ¡å®¹å™¨

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº« Dubbo å®ç° **æœåŠ¡å®¹å™¨** åŠŸèƒ½ã€‚åœ¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” æœåŠ¡å®¹å™¨ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/service-container.html) å®šä¹‰å¦‚ä¸‹ï¼š
æœåŠ¡å®¹å™¨æ˜¯ä¸€ä¸ª standalone çš„å¯åŠ¨ç¨‹åºï¼Œå› ä¸ºåå°æœåŠ¡ä¸éœ€è¦ Tomcat æˆ– JBoss ç­‰ Web å®¹å™¨çš„åŠŸèƒ½ï¼Œå¦‚æœç¡¬è¦ç”¨ Web å®¹å™¨å»åŠ è½½æœåŠ¡æä¾›æ–¹ï¼Œå¢åŠ å¤æ‚æ€§ï¼Œä¹Ÿæµªè´¹èµ„æºã€‚

æœåŠ¡å®¹å™¨åªæ˜¯ä¸€ä¸ªç®€å•çš„ Main æ–¹æ³•ï¼Œå¹¶åŠ è½½ä¸€ä¸ªç®€å•çš„ Spring å®¹å™¨ï¼Œç”¨äºæš´éœ²æœåŠ¡ã€‚

æœåŠ¡å®¹å™¨çš„åŠ è½½å†…å®¹å¯ä»¥æ‰©å±•ï¼Œå†…ç½®äº† spring, jetty, log4j ç­‰åŠ è½½ï¼Œå¯é€šè¿‡å®¹å™¨[æ‰©å±•ç‚¹](http://dubbo.apache.org/zh-cn/docs/dev/content/impls/container.html)è¿›è¡Œæ‰©å±•ã€‚é…ç½®é…åœ¨ java å‘½ä»¤çš„ -D å‚æ•°æˆ–è€…

dubbo.properties
ä¸­ã€‚

* ä»æ¦‚å¿µä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå’Œ SpringBoot ç±»ä¼¼ï¼Œæ˜¯ Dubbo æœåŠ¡çš„å¯åŠ¨å™¨ã€‚ğŸ™‚ è€ƒè™‘åˆ°ç›®å‰ Spring æ›´åŠ é€šç”¨ï¼Œæ‰€ä»¥å®é™…å®è·µæ—¶ï¼Œæ›´å¤šé‡‡ç”¨çš„æ˜¯ SpringBoot ï¼Œè€Œä¸æ˜¯ Dubbo çš„æœåŠ¡å®¹å™¨ã€‚
* jetty
æœåŠ¡å®¹å™¨å®ç°å·²ç»ç§»é™¤ï¼Œæ–°å¢

logback
æœåŠ¡å®¹å™¨å®ç°ã€‚

æœ¬æ–‡æ¶‰åŠå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![ä¸€è§ˆ](http://static2.iocoder.cn/images/Dubbo/2019_03_01/01.png)

# 2. Container

com.alibaba.dubbo.container.Container
ï¼ŒæœåŠ¡å®¹å™¨**æ¥å£**ã€‚
```
@SPI("spring")
public interface Container{
//*/*
/* start.
/*
/* å¯åŠ¨
/*/
void start();
//*/*
/* stop.
/*
/* åœæ­¢
/*/
void stop();
}
```

* @SPI("spring")
æ³¨è§£ï¼ŒDubbo SPI **æ‹“å±•ç‚¹**ï¼Œé»˜è®¤ä¸º

"spring"
ã€‚
* å®šä¹‰äº†å®¹å™¨çš„**å¯åŠ¨**å’Œ**åœæ­¢**ä¸¤ä¸ªæ–¹æ³•ã€‚

## 2.1 SpringContainer

com.alibaba.dubbo.container.spring.SpringContainer
ï¼Œå®ç° Container æ¥å£ï¼Œ**Spring** å®¹å™¨å®ç°ç±»ã€‚å±äº

dubbo-container-spring
é¡¹ç›®ã€‚
```
1: public class SpringContainer implements Container{
2:
3: private static final Logger logger = LoggerFactory.getLogger(SpringContainer.class);
4:
5: //*/*
6: /* Spring é…ç½®å±æ€§ KEY
7: /*/
8: public static final String SPRING_CONFIG = "dubbo.spring.config";
9: //*/*
10: /* é»˜è®¤é…ç½®æ–‡ä»¶åœ°å€
11: /*/
12: public static final String DEFAULT_SPRING_CONFIG = "classpath/*:META-INF/spring//*.xml";
13: //*/*
14: /* Spring Context
15: /*
16: /* é™æ€å±æ€§ï¼Œå…¨å±€å”¯ä¸€
17: /*/
18: static ClassPathXmlApplicationContext context;
19:
20: public static ClassPathXmlApplicationContext getContext(){
21: return context;
22: }
23:
24: @Override
25: public void start(){
26: // è·å¾— Spring é…ç½®æ–‡ä»¶çš„åœ°å€
27: String configPath = ConfigUtils.getProperty(SPRING_CONFIG);
28: if (configPath == null || configPath.length() == 0) {
29: configPath = DEFAULT_SPRING_CONFIG;
30: }
31: // åˆ›å»º Spring Context å¯¹è±¡
32: context = new ClassPathXmlApplicationContext(configPath.split("[,\\s]+"));
33: // å¯åŠ¨ Spring Context ï¼Œä¼šè§¦å‘ ContextStartedEvent äº‹ä»¶
34: context.start();
35: }
36:
37: @Override
38: public void stop(){
39: try {
40: if (context != null) {
41: // åœæ­¢ Spring Context ï¼Œä¼šè§¦å‘ ContextStoppedEvent äº‹ä»¶ã€‚
42: context.stop();
43: // å…³é—­ Spring Context ï¼Œä¼šè§¦å‘ ContextClosedEvent äº‹ä»¶ã€‚
44: context.close();
45: context = null;
46: }
47: } catch (Throwable e) {
48: logger.error(e.getMessage(), e);
49: }
50: }
51:
52: }
```

* context
**é™æ€**å±æ€§ï¼ŒSpring Context ï¼Œå…¨å±€**å”¯ä¸€**ã€‚å¯é€šè¿‡

/#getContext()
**é™æ€**æ–¹æ³•è·å–åˆ°ã€‚
* SPRING_CONFIG
**é™æ€**å±æ€§ï¼ŒSpring é…ç½®å±æ€§ **KEY**ã€‚

* DEFAULT_SPRING_CONFIG
**é™æ€**å±æ€§ï¼Œé»˜è®¤ Spring é…ç½®æ–‡ä»¶åœ°å€ã€‚
* /#start()
æ–¹æ³•ï¼Œå¯åŠ¨ Spring ã€‚ä»£ç å¦‚ä¸‹ï¼š

* ç¬¬ 27 è¡Œï¼šè°ƒç”¨

ConfigUtils/#getProperty(key)
æ–¹æ³•ï¼Œè·å¾— Spring é…ç½®æ–‡ä»¶çš„åœ°å€ã€‚ä¼˜å…ˆçº§ä¸ºï¼š

* ã€é«˜ã€‘JVM å¯åŠ¨å‚æ•°ï¼š

-Ddubbo.spring.config=è‡ªå®šä¹‰ XML è·¯å¾„
ã€‚
* ã€ä½ã€‘Dubbo Properties é…ç½®æ–‡ä»¶ï¼š

dubbo.spring.config=è‡ªå®šä¹‰ XML è·¯å¾„
ã€‚
* ç¬¬ 28 è‡³ 30 è¡Œï¼šæœªé…ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤è·¯å¾„

DEFAULT_SPRING_CONFIG
ã€‚
* ç¬¬ 32 è¡Œï¼šåˆ›å»º Spring Context å¯¹è±¡ã€‚
* ç¬¬ 34 è¡Œï¼šè°ƒç”¨

ClassPathXmlApplicationContext/#start()
æ–¹æ³•ï¼Œå¯åŠ¨ Spring Context ã€‚é€šè¿‡ Spring å¯åŠ¨ï¼Œ**åŠ è½½æˆ‘ä»¬çš„ Dubbo é…ç½®**ï¼Œä»è€Œå¯åŠ¨ Dubbo æœåŠ¡ã€‚
* /#stop()
æ–¹æ³•ï¼Œå…³é—­ Spring ã€‚ä»£ç å¦‚ä¸‹ï¼š

* ç¬¬ 42 è¡Œï¼šè°ƒç”¨

ClassPathXmlApplicationContext/#stop()
æ–¹æ³•ï¼Œåœæ­¢ Spring Context ã€‚
* ç¬¬ 44 è¡Œï¼šè°ƒç”¨

ClassPathXmlApplicationContext/#close()
æ–¹æ³•ï¼Œå…³é—­ Spring Context ã€‚

## 2.2 Log4jContainer

com.alibaba.dubbo.container.log4j.Log4jContainer
ï¼Œå®ç° Container æ¥å£ï¼Œ**Log4j** å®¹å™¨å®ç°ç±»ï¼Œ**è‡ªåŠ¨é…ç½®** log4j çš„é…ç½®ï¼Œåœ¨å¤šè¿›ç¨‹å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨ç»™æ—¥å¿—æ–‡ä»¶æŒ‰è¿›ç¨‹åˆ†ç›®å½•ã€‚å±äº

dubbo-container-log4j
é¡¹ç›®ã€‚
```
1: public class Log4jContainer implements Container{
2:
3: //*/*
4: /* æ—¥å¿—æ–‡ä»¶è·¯å¾„é…ç½® KEY
5: /*/
6: public static final String LOG4J_FILE = "dubbo.log4j.file";
7:
8: //*/*
9: /* æ—¥å¿—å­ç›®å½•å¾„é…ç½® KEY
10: /*/
11: public static final String LOG4J_SUBDIRECTORY = "dubbo.log4j.subdirectory";
12:
13: //*/*
14: /* æ—¥å¿—çº§åˆ«é…ç½® KEY
15: /*/
16: public static final String LOG4J_LEVEL = "dubbo.log4j.level";
17: //*/*
18: /* é»˜è®¤æ—¥å¿—çº§åˆ« - ERROR
19: /*/
20: public static final String DEFAULT_LOG4J_LEVEL = "ERROR";
21:
22: @Override
23: @SuppressWarnings("unchecked")
24: public void start(){
25: // è·å¾— log4j é…ç½®çš„æ—¥å¿—æ–‡ä»¶è·¯å¾„
26: String file = ConfigUtils.getProperty(LOG4J_FILE);
27: if (file != null && file.length() > 0) {
28: // è·å¾—æ—¥å¿—çº§åˆ«
29: String level = ConfigUtils.getProperty(LOG4J_LEVEL);
30: if (level == null || level.length() == 0) {
31: level = DEFAULT_LOG4J_LEVEL;
32: }
33: // åˆ›å»ºæ—¥å¿— Properties å¯¹è±¡ï¼Œå¹¶è®¾ç½®åˆ° PropertyConfigurator ä¸­ã€‚
34: Properties properties = new Properties();
35: properties.setProperty("log4j.rootLogger", level + ",application"); // æ—¥å¿—çº§åˆ«
36: // log4j.appender.application çš„é…ç½®
37: properties.setProperty("log4j.appender.application", "org.apache.log4j.DailyRollingFileAppender"); // DailyRollingFileAppender
38: properties.setProperty("log4j.appender.application.File", file); // æ—¥å¿—æ–‡ä»¶è·¯å¾„
39: properties.setProperty("log4j.appender.application.Append", "true");
40: properties.setProperty("log4j.appender.application.DatePattern", "'.'yyyy-MM-dd");
41: properties.setProperty("log4j.appender.application.layout", "org.apache.log4j.PatternLayout");
42: properties.setProperty("log4j.appender.application.layout.ConversionPattern", "%d [%t] %-5p %C{6} (%F:%L) - %m%n");
43: PropertyConfigurator.configure(properties);
44: }
45: // è·å¾—æ—¥å¿—å­ç›®å½•ï¼Œç”¨äºå¤šè¿›ç¨‹å¯åŠ¨ï¼Œé¿å…å†²çªã€‚
46: String subdirectory = ConfigUtils.getProperty(LOG4J_SUBDIRECTORY);
47: if (subdirectory != null && subdirectory.length() > 0) {
48: // å¾ªç¯æ¯ä¸ª Logger å¯¹è±¡
49: Enumeration<org.apache.log4j.Logger> ls = LogManager.getCurrentLoggers();
50: while (ls.hasMoreElements()) {
51: org.apache.log4j.Logger l = ls.nextElement();
52: if (l != null) {
53: // å¾ªç¯æ¯ä¸ª Logger å¯¹è±¡çš„ Appender å¯¹è±¡
54: Enumeration<Appender> as = l.getAllAppenders();
55: while (as.hasMoreElements()) {
56: Appender a = as.nextElement();
57: if (a instanceof FileAppender) { // å½“ä¸”ä»…å½“ FileAppender æ—¶
58: FileAppender fa = (FileAppender) a;
59: String f = fa.getFile();
60: if (f != null && f.length() > 0) {
61: int i = f.replace('\\', '/').lastIndexOf('/');
62: // æ‹¼æ¥æ—¥å¿—å­ç›®å½•
63: String path;
64: if (i == -1) { // æ— è·¯å¾„
65: path = subdirectory;
66: } else {
67: path = f.substring(0, i);
68: if (!path.endsWith(subdirectory)) { // å·²ç»æ˜¯ subdirectory ç»“å°¾ï¼Œåˆ™ä¸ç”¨æ‹¼æ¥
69: path = path + "/" + subdirectory;
70: }
71: f = f.substring(i + 1);
72: }
73: // è®¾ç½®æ–°çš„æ–‡ä»¶å
74: fa.setFile(path + "/" + f);
75: // ç”Ÿæ•ˆé…ç½®
76: fa.activateOptions();
77: }
78: }
79: }
80: }
81: }
82: }
83: }
84:
85: @Override
86: public void stop(){
87: }
88:
89: }
```

* LOG4J_FILE
**é™æ€**å±æ€§ï¼Œæ—¥å¿—æ–‡ä»¶è·¯å¾„é…ç½® KEY ã€‚ä¾‹å¦‚ï¼š

dubbo.log4j.file=/foo/bar.log
ã€‚
* LOG4J_SUBDIRECTORY
**é™æ€**å±æ€§ï¼Œæ—¥å¿—å­ç›®å½•å¾„é…ç½® KEY ã€‚ä¾‹å¦‚ï¼š

dubbo.log4j.subdirectory=20880
ã€‚

* Log4j åœ¨**å¤šè¿›ç¨‹**å†™å…¥**åŒä¸€**æ—¥å¿—æ–‡ä»¶ï¼Œæç«¯æƒ…å†µä¼šå­˜åœ¨ä¸¢å¤±é—®é¢˜ï¼Œå‚è§ [ã€Šå¤šè¿›ç¨‹log4jæ—¥å¿—ä¸¢å¤±é—®é¢˜åˆ†æã€‹](http://hellojavaer.iteye.com/blog/977599) æ–‡ç« çš„åˆ†æã€‚
* LOG4J_LEVEL
**é™æ€**å±æ€§ï¼Œæ—¥å¿—çº§åˆ«é…ç½® KEYã€‚ä¾‹å¦‚ï¼š

dubbo.log4j.level=WARN
ã€‚

* DEFAULT_LOG4J_LEVEL
**é™æ€**å±æ€§ï¼Œ é»˜è®¤æ—¥å¿—çº§åˆ«ï¼Œ**ERROR** ã€‚
* /#start()
æ–¹æ³•ï¼Œ**è‡ªåŠ¨é…ç½®** log4j çš„é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š

* ç¬¬ 26 è¡Œï¼šè·å¾— log4j é…ç½®çš„**æ—¥å¿—æ–‡ä»¶è·¯å¾„**ã€‚
* ç¬¬ 28 è‡³ 32 è¡Œï¼šè·å¾—æ—¥å¿—**çº§åˆ«**ã€‚
* ç¬¬ 33 è‡³ 43 è¡Œï¼šåˆ›å»ºæ—¥å¿— Properties å¯¹è±¡ï¼Œå¹¶è®¾ç½®åˆ°

org.apache.log4j.PropertyConfigurator
ä¸­ã€‚
* ç¬¬ 45 è‡³ 82 è¡Œï¼šè·å¾—æ—¥å¿—**å­ç›®å½•**ï¼Œç”¨äºå¤šè¿›ç¨‹å¯åŠ¨ï¼Œé¿å…å†²çªã€‚
* /#stop()
æ–¹æ³•ï¼Œç©ºå®ç°ã€‚å› ä¸ºï¼Œæ— éœ€å…³é—­ã€‚

## 2.3 LogbackContainer

com.alibaba.dubbo.container.logback.LogbackContainer
ï¼Œå®ç° Container æ¥å£ï¼Œ**Logback** å®¹å™¨å®ç°ç±»ï¼Œ**è‡ªåŠ¨é…ç½®** logback çš„é…ç½®ï¼Œè‡ªåŠ¨é€‚é… logback çš„é…ç½®ã€‚å±äº

dubbo-container-logback
é¡¹ç›®ã€‚
```
public class LogbackContainer implements Container{
//*/*
/* æ—¥å¿—æ–‡ä»¶è·¯å¾„é…ç½® KEY
/*/
public static final String LOGBACK_FILE = "dubbo.logback.file";
//*/*
/* æ—¥å¿—ä¿ç•™å¤©æ•°é…ç½® KEY
/*/
public static final String LOGBACK_MAX_HISTORY = "dubbo.logback.maxhistory";
//*/*
/* æ—¥å¿—çº§åˆ«é…ç½® KEY
/*/
public static final String LOGBACK_LEVEL = "dubbo.logback.level";
//*/*
/* é»˜è®¤æ—¥å¿—çº§åˆ« - ERROR
/*/
public static final String DEFAULT_LOGBACK_LEVEL = "ERROR";
@Override
public void start(){
// è·å¾— logback é…ç½®çš„æ—¥å¿—æ–‡ä»¶è·¯å¾„
String file = ConfigUtils.getProperty(LOGBACK_FILE);
if (file != null && file.length() > 0) {
// è·å¾—æ—¥å¿—çº§åˆ«
String level = ConfigUtils.getProperty(LOGBACK_LEVEL);
if (level == null || level.length() == 0) {
level = DEFAULT_LOGBACK_LEVEL;
}
// è·å¾—æ—¥å¿—ä¿ç•™å¤©æ•°ã€‚è‹¥ä¸ºé›¶ï¼Œåˆ™æ— é™å¤©æ•°
// maxHistory=0 Infinite history
int maxHistory = StringUtils.parseInteger(ConfigUtils.getProperty(LOGBACK_MAX_HISTORY));
// åˆå§‹åŒ– logback
doInitializer(file, level, maxHistory);
}
}
//*/*
/* Initializer logback
/*
/* åˆå§‹åŒ– logback
/*
/* @param file æ—¥å¿—æ–‡ä»¶è·¯å¾„
/* @param level æ—¥å¿—çº§åˆ«
/* @param maxHistory æ—¥å¿—ä¿ç•™å¤©æ•°
/*/
private void doInitializer(String file, String level, int maxHistory){
LoggerContext loggerContext = (LoggerContext) LoggerFactory.getILoggerFactory();
Logger rootLogger = loggerContext.getLogger(Logger.ROOT_LOGGER_NAME);
rootLogger.detachAndStopAllAppenders();
// appender
RollingFileAppender<ILoggingEvent> fileAppender = new RollingFileAppender<ILoggingEvent>();
fileAppender.setContext(loggerContext);
fileAppender.setName("application");
fileAppender.setFile(file);
fileAppender.setAppend(true);
// policy
TimeBasedRollingPolicy<ILoggingEvent> policy = new TimeBasedRollingPolicy<ILoggingEvent>();
policy.setContext(loggerContext);
policy.setMaxHistory(maxHistory);
policy.setFileNamePattern(file + ".%d{yyyy-MM-dd}");
policy.setParent(fileAppender);
policy.start();
fileAppender.setRollingPolicy(policy);
// encoder
PatternLayoutEncoder encoder = new PatternLayoutEncoder();
encoder.setContext(loggerContext);
encoder.setPattern("%date [%thread] %-5level %logger (%file:%line\\) - %msg%n");
encoder.start();
fileAppender.setEncoder(encoder);
fileAppender.start();
rootLogger.addAppender(fileAppender);
rootLogger.setLevel(Level.toLevel(level));
rootLogger.setAdditive(false);
}
@Override
public void stop(){
}
}
```

* LOGBACK_FILE
**é™æ€**å±æ€§ï¼Œæ—¥å¿—æ–‡ä»¶è·¯å¾„é…ç½® KEY ã€‚ä¾‹å¦‚ï¼š

dubbo.logback.file=/foo/bar.log
ã€‚
* LOGBACK_MAX_HISTORY
**é™æ€**å±æ€§ï¼Œæ—¥å¿—ä¿ç•™å¤©æ•°é…ç½® KEYã€‚ä¾‹å¦‚ï¼š

dubbo.logback.maxhistory=15
ã€‚
* LOGBACK_LEVEL
**é™æ€**å±æ€§ï¼Œæ—¥å¿—çº§åˆ«é…ç½® KEYã€‚ä¾‹å¦‚ï¼š

dubbo.logback.level=WARN
ã€‚

* DEFAULT_LOGBACK_LEVEL
**é™æ€**å±æ€§ï¼Œ é»˜è®¤æ—¥å¿—çº§åˆ«ï¼Œ**ERROR** ã€‚
* ä»£ç æ¯”è¾ƒç®€å•ï¼Œå’Œ Log4jContainer æ€è·¯ä¸€è‡´ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚å¦‚æœå¯¹ Logback ä¸äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ [ã€ŠLogbackèƒŒæ™¯ã€‹](http://webinglin.github.io/2015/06/04/Logback-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/) æ–‡ç« ã€‚

# 3. Main

com.alibaba.dubbo.container.Main
ï¼Œå¯åŠ¨ç¨‹åºï¼Œè´Ÿè´£åˆå§‹åŒ– Container æœåŠ¡å®¹å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: public class Main{
2:
3: private static final Logger logger = LoggerFactory.getLogger(Main.class);
4:
5: //*/*
6: /* Container é…ç½® KEY
7: /*/
8: public static final String CONTAINER_KEY = "dubbo.container";
9:
10: //*/*
11: /* ShutdownHook æ˜¯å¦å¼€å¯é…ç½® KEY
12: /*/
13: public static final String SHUTDOWN_HOOK_KEY = "dubbo.shutdown.hook";
14:
15: //*/*
16: /* Container æ‹“å±•ç‚¹å¯¹åº”çš„ ExtensionLoader å¯¹è±¡
17: /*/
18: private static final ExtensionLoader<Container> loader = ExtensionLoader.getExtensionLoader(Container.class);
19:
20: private static final ReentrantLock LOCK = new ReentrantLock();
21:
22: private static final Condition STOP = LOCK.newCondition();
23:
24: public static void main(String[] args){
25: try {
26: // è‹¥ main å‡½æ•°å‚æ•°ä¼ å…¥ä¸ºç©ºï¼Œä»é…ç½®ä¸­åŠ è½½ã€‚
27: if (args == null || args.length == 0) {
28: String config = ConfigUtils.getProperty(CONTAINER_KEY, loader.getDefaultExtensionName()); // é»˜è®¤ "spring"
29: args = Constants.COMMA_SPLIT_PATTERN.split(config);
30: }
31:
32: // åŠ è½½å®¹å™¨æ•°ç»„
33: final List<Container> containers = new ArrayList<Container>();
34: for (int i = 0; i < args.length; i++) {
35: containers.add(loader.getExtension(args[i]));
36: }
37: logger.info("Use container type(" + Arrays.toString(args) + ") to run dubbo serivce.");
38:
39: // ShutdownHook
40: if ("true".equals(System.getProperty(SHUTDOWN_HOOK_KEY))) {
41: Runtime.getRuntime().addShutdownHook(new Thread() {
42:
43: @Override
44: public void run(){
45: for (Container container : containers) {
46: // å…³é—­å®¹å™¨
47: try {
48: container.stop();
49: logger.info("Dubbo " + container.getClass().getSimpleName() + " stopped!");
50: } catch (Throwable t) {
51: logger.error(t.getMessage(), t);
52: }
53: try {
54: // è·å¾— ReentrantLock
55: LOCK.lock();
56: // å”¤é†’ Main ä¸»çº¿ç¨‹çš„ç­‰å¾…
57: STOP.signal();
58: } finally {
59: // é‡Šæ”¾ ReentrantLock
60: LOCK.unlock();
61: }
62: }
63: }
64:
65: });
66: }
67:
68: // å¯åŠ¨å®¹å™¨
69: for (Container container : containers) {
70: container.start();
71: logger.info("Dubbo " + container.getClass().getSimpleName() + " started!");
72: }
73:
74: // è¾“å‡ºæç¤ºï¼Œå¯åŠ¨æˆåŠŸ
75: System.out.println(new SimpleDateFormat("[yyyy-MM-dd HH:mm:ss]").format(new Date()) + " Dubbo service server started!");
76: } catch (RuntimeException e) {
77: // å‘ç”Ÿå¼‚å¸¸ï¼ŒJVM é€€å‡º
78: e.printStackTrace();
79: logger.error(e.getMessage(), e);
80: System.exit(1);
81: }
82: try {
83: // è·å¾— ReentrantLock
84: LOCK.lock();
85: // é‡Šæ”¾é”ï¼Œå¹¶ä¸”å°†è‡ªå·±æ²‰ç¡ï¼Œç­‰å¾…å”¤é†’
86: STOP.await();
87: } catch (InterruptedException e) {
88: logger.warn("Dubbo service server stopped, interrupted by other thread!", e);
89: } finally {
90: // é‡Šæ”¾ ReentrantLock
91: LOCK.unlock();
92: }
93: }
94:
95: }
```

* CONTAINER_KEY
**é™æ€**å±æ€§ï¼ŒContainer é…ç½® KEY ã€‚ä¾‹å¦‚ï¼š

dubbo.container=spring,jetty,log4j
ã€‚
* SHUTDOWN_HOOK_KEY
**é™æ€**å±æ€§ï¼ŒShutdownHook æ˜¯å¦å¼€å¯é…ç½® KEYã€‚ä¾‹å¦‚ï¼š

-Ddubbo.shutdown.hook=true
ã€‚
* loader
**é™æ€**å±æ€§ï¼ŒContainer æ‹“å±•ç‚¹å¯¹åº”çš„ ExtensionLoader å¯¹è±¡ã€‚
* /#main(args)
æ–¹æ³•ï¼Œ**åˆå§‹åŒ–** Container æœåŠ¡å®¹å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

* ç¬¬ 24 è¡Œï¼š

args
å¯åŠ¨å‚æ•°ï¼Œå¯é…ç½®è¦åŠ è½½çš„å®¹å™¨ã€‚ä¾‹å¦‚ï¼Œ

java com.alibaba.dubbo.container.Main spring jetty log4j
ã€‚
* ç¬¬ 26 è‡³ 30 è¡Œï¼šè‹¥

args
ä¸ºç©ºï¼Œä»é…ç½®ä¸­åŠ è½½ã€‚ä¾‹å¦‚ï¼š

dubbo.container=spring,jetty,log4j
ã€‚è‹¥è·å–ä¸åˆ°ï¼Œä½¿ç”¨ Container çš„**é»˜è®¤**æ‹“å±•

"spring"
ã€‚
* ç¬¬ 32 è‡³ 37 è¡Œï¼šä½¿ç”¨ Dubbo SPI æœºåˆ¶ï¼ŒåŠ è½½é…ç½®çš„ Container å¯¹è±¡ã€‚
* ç¬¬ 68 è‡³ 72 è¡Œï¼šå¾ªç¯è°ƒç”¨

Container/#start()
æ–¹æ³•ï¼Œå¯åŠ¨å®¹å™¨ã€‚
* ç¬¬ 75 è¡Œï¼šè¾“å‡ºæç¤ºï¼Œå¯åŠ¨**æˆåŠŸ**ã€‚
* ç¬¬ 76 è‡³ 81 è¡Œï¼šè‹¥å‘ç”Ÿå¼‚å¸¸ï¼Œæ‰“å°é”™è¯¯æ—¥å¿—ï¼Œå¹¶ JVM é€€å‡ºã€‚
* ç¬¬ 84 è¡Œï¼šè°ƒç”¨

ReentrantLock/#lock()
æ–¹æ³•ï¼Œè·å¾— ReentrantLock ã€‚
* ç¬¬ 86 è¡Œï¼šè°ƒç”¨

Condition/#await()
æ–¹æ³•ï¼Œ**é‡Šæ”¾**é”ï¼Œå¹¶ä¸”å°†è‡ªå·±**æ²‰ç¡**ï¼Œç­‰å¾…**å”¤é†’**ã€‚
* ========== ShutdownHook ==========
* ç¬¬ 40 è‡³ 41 è¡Œï¼šå½“é…ç½® JVM å¯åŠ¨å‚æ•°å¸¦æœ‰

Ddubbo.shutdown.hook=true
æ—¶ï¼Œæ·»åŠ å…³é—­çš„ ShutdownHook ã€‚

* å½“è¯»åˆ°æ­¤å¤„æ—¶ï¼Œè€è‰¿è‰¿å°±æœ‰ä¸ªç–‘æƒ‘ï¼Œå¦‚æœä¸å¼€å¯ ShutdownHook ï¼Œé‚£å²‚ä¸æ˜¯ Main ä¸€ç›´ç­‰å¾…ï¼ŒJVM æ— æ³•ç»“æŸäº†ï¼ŸğŸ™‚ ç­”æ¡ˆå®é™…æ˜¯ä¸ä¼šï¼ŒJVM æ­£å¸¸é€€å‡ºæ—¶ï¼Œä¾‹å¦‚ä½¿ç”¨

kill pid
æŒ‡å®šï¼Œåªè¦ ShutdownHook å…¨éƒ¨æ‰§è¡Œå®Œæˆå³å¯é€€å‡ºï¼Œæ— éœ€ Main å‡½æ•°æ‰§è¡Œå®Œæˆã€‚å¦‚æœæ²¡æœ‰ ShutdownHook ï¼Œé‚£å°±ç›´æ¥é€€å‡ºã€‚
* é‚£ä¹ˆ Main çš„**ç­‰å¾…å”¤é†’**æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿå¦‚æœã€ç¬¬ 86 è¡Œã€‘ä¸è¿›è¡Œç­‰å¾…ï¼ŒMain æ‰§è¡Œå®Œæˆï¼Œå°±ä¼šè§¦å‘ JVM é€€å‡ºï¼Œå¯¼è‡´ Dubbo æœåŠ¡é€€å‡ºã€‚æ‰€ä»¥ç›¸å½“äºï¼Œèµ·åˆ°äº† JVM è¿›ç¨‹å¸¸é©»çš„ä½œç”¨ã€‚
* ç¬¬ 45 è‡³ 52 è¡Œï¼šè°ƒç”¨

Container/#stop()
æ–¹æ³•ï¼Œå…³é—­å®¹å™¨ã€‚
* ç¬¬ 53 è‡³ 61 è¡Œï¼šè°ƒç”¨

Condition/#signal()
æ–¹æ³•ï¼Œå”¤é†’ Main çš„ç­‰å¾…ã€‚
* åœ¨**æ—©æœŸç‰ˆæœ¬** çš„ Main å®ç°ï¼Œç­‰å¾…å”¤é†’åŸºäº **Main.class çš„ wait/notify** æœºåˆ¶å®ç°ã€‚è€ƒè™‘åˆ°å®‰å…¨æ€§ï¼Œ

Main.class/#notify()
æ–¹æ³•ï¼Œå¯ä»¥è¢«ä»»æ„ä»£ç è®¿é—®ï¼Œå¯¼è‡´éæ­£å¸¸é€€å‡ºã€‚æ‰€ä»¥æ”¹æˆäº† ReentrantLock + Condition æ¥å®ç°ã€‚å€¼å¾—å€Ÿé‰´ã€‚è¯¦ç»†å‚è§ [ã€ŠISSUE/#520 shutdown with count down latchã€‹](https://github.com/apache/incubator-dubbo/pull/520) ã€‚

# 4. å¯åŠ¨ä¸æš‚åœ

åœ¨

dubbo-container-api
é¡¹ç›®ï¼Œ[
resources/META-INF/assembly/bin/
](https://github.com/apache/incubator-dubbo/tree/1de21470c95c9bf3724b39b79a0cc53eeb0594ce/dubbo-container/dubbo-container-api/src/main/resources/META-INF/assembly/bin) ä¸‹ï¼Œæä¾›äº†è„šæœ¬ï¼š

* start.sh
* stop.sh
* restart.sh
* dump.sh
è¿˜æœ‰ä¸€ä¸ª

server.sh
ï¼Œæ˜¯æ ¹æ®**å‚æ•°**ï¼Œè°ƒç”¨ä¸Šè¿°è„šæœ¬ã€‚

ğŸ™‚ ç¥ç§˜çš„å¾®ç¬‘ã€‚è¯¦ç»†è§£æï¼Œå‚è§ [ã€ŠDubboåº”ç”¨å¯åŠ¨ä¸åœæ­¢è„šæœ¬,è¶…è¯¦ç»†è§£æã€‹](https://blog.csdn.net/evankaka/article/details/61617483) æ–‡ç« ã€‚

# 666. å½©è›‹

æ¨èé˜…è¯»ï¼š

* [ã€ŠJavaå¤šçº¿ç¨‹ï¼ˆä¹ï¼‰ä¹‹ReentrantLockä¸Conditionã€‹](https://blog.csdn.net/vernonzheng/article/details/8288251)
* [ã€Šç ”ç©¶ä¼˜é›…åœæœºæ—¶çš„ä¸€ç‚¹æ€è€ƒã€‹](https://www.cnkirito.moe/2018/01/14/gracefully-shutdown/)