# è¿‡æ»¤å™¨ï¼ˆå››ï¼‰ä¹‹ ActiveLimitFilter && ExecuteLimitFilter

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«**æœåŠ¡æ–¹æ³•**çš„**æœ€å¤§å¯å¹¶è¡Œè°ƒç”¨**çš„**é™åˆ¶**è¿‡æ»¤å™¨ï¼Œåœ¨æœåŠ¡**æ¶ˆè´¹è€…**å’Œ**æä¾›è€…**å„æœ‰ä¸€ä¸ª LimitFilter ï¼š

* ActiveLimitFilter ï¼Œåœ¨æœåŠ¡**æ¶ˆè´¹è€…**ï¼Œé€šè¿‡

<dubbo:reference />
çš„

"actives"
**ç»Ÿä¸€**é…ç½®é¡¹å¼€å¯ï¼š
æ¯æœåŠ¡æ¶ˆè´¹è€…ï¼Œ**æ¯æœåŠ¡**çš„**æ¯æ–¹æ³•**æœ€å¤§å¹¶å‘è°ƒç”¨æ•°ã€‚
* ExecuteLimitFilter ï¼Œåœ¨æœåŠ¡**æä¾›è€…**ï¼Œé€šè¿‡

<dubbo:service />
çš„

"executes"
**ç»Ÿä¸€**é…ç½®é¡¹å¼€å¯ï¼š
æœåŠ¡æä¾›è€…ï¼Œ**æ¯æœåŠ¡**çš„**æ¯æ–¹æ³•**æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ã€‚

å¦å¤–ï¼Œåœ¨

<dubbo:method />
çš„

"actives"
å’Œ

"executes"
é…ç½®é¡¹ï¼Œå¯ä»¥**è‡ªå®šä¹‰**æ¯ä¸ªæ–¹æ³•çš„é…ç½®ã€‚

# 2. RpcStatus

com.alibaba.dubbo.rpc.RpcStatus
ï¼ŒRPC çŠ¶æ€ã€‚å¯ä»¥è®¡å…¥å¦‚ä¸‹ç»´åº¦ç»Ÿè®¡ï¼š

* 1. åŸºäºæœåŠ¡ URL
1. 
1. åŸºäºæœåŠ¡ URL + æ–¹æ³•

ç”¨äº ActiveLimitFilter å’Œ ExecuteLimitFilter ä¸­ã€‚ğŸ™‚ å½“ç„¶ï¼ŒDubbo ä¸­ï¼Œä¹Ÿæœ‰å…¶ä»–ç±»ï¼Œä¹Ÿä¼šè°ƒç”¨åˆ° RpcStatus ã€‚

## 2.1 æ„é€ æ–¹æ³•

```
//*/*
/* åŸºäºæœåŠ¡ URL ä¸ºç»´åº¦çš„ RpcStatus é›†åˆ
/*
/* keyï¼šURL
/*/
private static final ConcurrentMap<String, RpcStatus> SERVICE_STATISTICS = new ConcurrentHashMap<String, RpcStatus>();
//*/*
/* åŸºäºæœåŠ¡ URL + æ–¹æ³•ç»´åº¦çš„ RpcStatus é›†åˆ
/*
/* key1ï¼šURL
/* key2ï¼šæ–¹æ³•å
/*/
private static final ConcurrentMap<String, ConcurrentMap<String, RpcStatus>> METHOD_STATISTICS = new ConcurrentHashMap<String, ConcurrentMap<String, RpcStatus>>();
// ç›®å‰æ²¡æœ‰ç”¨åˆ°
private final ConcurrentMap<String, Object> values = new ConcurrentHashMap<String, Object>();
//*/*
/* è°ƒç”¨ä¸­çš„æ¬¡æ•°
/*/
private final AtomicInteger active = new AtomicInteger();
//*/*
/* æ€»è°ƒç”¨æ¬¡æ•°
/*/
private final AtomicLong total = new AtomicLong();
//*/*
/* æ€»è°ƒç”¨å¤±è´¥æ¬¡æ•°
/*/
private final AtomicInteger failed = new AtomicInteger();
//*/*
/* æ€»è°ƒç”¨æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’
/*/
private final AtomicLong totalElapsed = new AtomicLong();
//*/*
/* æ€»è°ƒç”¨å¤±è´¥æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’
/*/
private final AtomicLong failedElapsed = new AtomicLong();
//*/*
/* æœ€å¤§è°ƒç”¨æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’
/*/
private final AtomicLong maxElapsed = new AtomicLong();
//*/*
/* æœ€å¤§è°ƒç”¨å¤±è´¥æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’
/*/
private final AtomicLong failedMaxElapsed = new AtomicLong();
//*/*
/* æœ€å¤§è°ƒç”¨æˆåŠŸæ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’
/*/
private final AtomicLong succeededMaxElapsed = new AtomicLong();
//*/*
/* Semaphore used to control concurrency limit set by `executes`
/*
/* æœåŠ¡æ‰§è¡Œä¿¡å·é‡ï¼Œåœ¨ {@link com.alibaba.dubbo.rpc.filter.ExecuteLimitFilter} ä¸­ä½¿ç”¨
/*/
private volatile Semaphore executesLimit;
//*/*
/* æœåŠ¡æ‰§è¡Œä¿¡å·é‡å¤§å°
/*/
private volatile int executesPermits;
```

* ========== é™æ€å±æ€§ ==========
* SERVICE_STATISTICS
å±æ€§ï¼ŒåŸºäº**æœåŠ¡ URL** ä¸ºç»´åº¦çš„ **RpcStatus** é›†åˆã€‚

/#getStatus(url)
**é™æ€**æ–¹æ³•ï¼Œè·å¾— RpcStatus å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
public static RpcStatus getStatus(URL url){
String uri = url.toIdentityString();
// è·å¾—
RpcStatus status = SERVICE_STATISTICS.get(uri);
// ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œåˆ›å»º
if (status == null) {
SERVICE_STATISTICS.putIfAbsent(uri, new RpcStatus());
status = SERVICE_STATISTICS.get(uri);
}
return status;
}
```
* METHOD_STATISTICS
å±æ€§ï¼ŒåŸºäº**æœåŠ¡ URL** + **æ–¹æ³•**ä¸ºç»´åº¦çš„ **RpcStatus** é›†åˆã€‚

/#getStatus(url, methodName)
**é™æ€**æ–¹æ³•ï¼Œè·å¾— RpcStatus å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
public static RpcStatus getStatus(URL url, String methodName){
String uri = url.toIdentityString();
// è·å¾—æ–¹æ³•é›†åˆ
ConcurrentMap<String, RpcStatus> map = METHOD_STATISTICS.get(uri);
// ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–¹æ³•é›†åˆ
if (map == null) {
METHOD_STATISTICS.putIfAbsent(uri, new ConcurrentHashMap<String, RpcStatus>());
map = METHOD_STATISTICS.get(uri);
}
// è·å¾— RpcStatus å¯¹è±¡
RpcStatus status = map.get(methodName);
// ä¸å­˜åœ¨ï¼Œåˆ›å»º RpcStatus å¯¹è±¡
if (status == null) {
map.putIfAbsent(methodName, new RpcStatus());
status = map.get(methodName);
}
return status;
}
```
* ========== å¯¹è±¡å±æ€§ ==========
* æ¬¡æ•°ç›¸å…³

* active
ï¼Œ**è°ƒç”¨ä¸­**çš„æ¬¡æ•°ã€‚è¿™ä¸ªå±æ€§åœ¨ ActiveLimitFilter ä¸­**éå¸¸å…³é”®**ã€‚
* total

failed
* æ—¶é•¿ç›¸å…³

* totalElapsed

failedElapsed
* failedElapsed

failedMaxElapsed

succeededMaxElapsed
* ä¿¡å·é‡ç›¸å…³

* executesLimit
ï¼ŒæœåŠ¡æ‰§è¡Œä¿¡å·é‡ã€‚è¿™ä¸ªå±æ€§åœ¨ ExecuteLimitFilter ä¸­**éå¸¸å…³é”®**ã€‚
* executesPermits
ï¼ŒæœåŠ¡æ‰§è¡Œä¿¡å·é‡å¤§å°ã€‚

## 2.2 beginCount

```
//*/*
/* æœåŠ¡è°ƒç”¨å¼€å§‹çš„è®¡æ•°
/*
/* @param url URL å¯¹è±¡
/* @param methodName æ–¹æ³•å
/*/
public static void beginCount(URL url, String methodName){
// `SERVICE_STATISTICS` çš„è®¡æ•°
beginCount(getStatus(url));
// `METHOD_STATISTICS` çš„è®¡æ•°
beginCount(getStatus(url, methodName));
}
```

* **é™æ€æ–¹æ³•**ï¼Œåœ¨å…¶å†…éƒ¨ï¼Œä¼šè°ƒç”¨ä¸¤æ¬¡

/#beginCount(RpcStatus)
æ–¹æ³•ï¼Œåˆ†åˆ«è®¡æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
private static void beginCount(RpcStatus status){
// è°ƒç”¨ä¸­çš„æ¬¡æ•°
status.active.incrementAndGet();
}
```

## 2.3 endCount

```
//*/*
/* æœåŠ¡è°ƒç”¨ç»“æŸçš„è®¡æ•°
/*
/* @param url URL å¯¹è±¡
/* @param elapsed æ—¶é•¿ï¼Œæ¯«ç§’
/* @param succeeded æ˜¯å¦æˆåŠŸ
/*/
public static void endCount(URL url, String methodName, long elapsed, boolean succeeded){
// `SERVICE_STATISTICS` çš„è®¡æ•°
endCount(getStatus(url), elapsed, succeeded);
// `METHOD_STATISTICS` çš„è®¡æ•°
endCount(getStatus(url, methodName), elapsed, succeeded);
}
```

* **é™æ€æ–¹æ³•**ï¼Œåœ¨å…¶å†…éƒ¨ï¼Œä¼šè°ƒç”¨ä¸¤æ¬¡

/#endCount(RpcStatus)
æ–¹æ³•ï¼Œåˆ†åˆ«è®¡æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
private static void endCount(RpcStatus status, long elapsed, boolean succeeded){
// æ¬¡æ•°è®¡æ•°
status.active.decrementAndGet();
status.total.incrementAndGet();
status.totalElapsed.addAndGet(elapsed);
// æ—¶é•¿è®¡æ•°
if (status.maxElapsed.get() < elapsed) {
status.maxElapsed.set(elapsed);
}
if (succeeded) {
if (status.succeededMaxElapsed.get() < elapsed) {
status.succeededMaxElapsed.set(elapsed);
}
} else {
status.failed.incrementAndGet(); // å¤±è´¥æ¬¡æ•°
status.failedElapsed.addAndGet(elapsed);
if (status.failedMaxElapsed.get() < elapsed) {
status.failedMaxElapsed.set(elapsed);
}
}
}
```

## 2.4 getSemaphore

```
public Semaphore getSemaphore(int maxThreadNum){
if(maxThreadNum <= 0) {
return null;
}
// è‹¥ä¿¡å·é‡ä¸å­˜åœ¨ï¼Œæˆ–è€…ä¿¡å·é‡å¤§å°æ”¹å˜ï¼Œåˆ›å»ºæ–°çš„ä¿¡å·é‡
if (executesLimit == null || executesPermits != maxThreadNum) {
synchronized (this) {
if (executesLimit == null || executesPermits != maxThreadNum) {
executesLimit = new Semaphore(maxThreadNum);
executesPermits = maxThreadNum;
}
}
}
// è¿”å›ä¿¡å·é‡
return executesLimit;
}
```

* **å¯¹è±¡**æ–¹æ³•ï¼Œè·å¾—ä¿¡å·é‡

executesPermits
å±æ€§ã€‚
* åˆ›å»ºä¿¡å·é‡çš„**æ¡ä»¶**ï¼Œä¿¡å·é‡

executesPermits
ä¸å­˜åœ¨ï¼Œæˆ–è€…ä¿¡å·é‡å¤§å°

executesLimit
å‘ç”Ÿæ”¹å˜ã€‚æˆ‘ä»¬ä¼šå‘ç”Ÿæ¯”è¾ƒâ€œç¥å¥‡â€çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯**ç›´æ¥**è¿”å› Semaphore å¯¹è±¡ã€‚è€ƒè™‘åˆ°æœ‰ä¿¡å·é‡å¤§å°æ”¹å˜çš„éœ€æ±‚ï¼Œä½†æ˜¯ä¿¡å·é‡ä¸æ”¯æŒ**æ‰¹é‡**ä¿®æ”¹å¤§å°ï¼Œé‚£ä¹ˆå‰©ä½™çš„ä¸€ç§åˆé€‚çš„æ–¹å¼ï¼Œåˆ›å»º**æ–°çš„**ä¿¡å·é‡å¯¹è±¡ã€‚å› æ­¤ï¼Œè¿™ä¸ªæ–¹æ³•å°±é€‰æ‹©äº†ç›´æ¥è¿”å› Semaphore å¯¹è±¡ã€‚
* åœ¨ [ã€ŠDubboæºä»£ç åˆ†æä¸ƒï¼šä½¿ç”¨executeså±æ€§çš„ä¸€ä¸ªé—®é¢˜ã€‹](http://manzhizhen.iteye.com/blog/2386408) ä¸­ï¼Œåˆ†äº«çš„å¾ˆä¸é”™ã€‚

# 3. ActiveLimitFilter

com.alibaba.dubbo.rpc.filter.ActiveLimitFilter
ï¼Œå®ç° Filter æ¥å£ï¼Œæ¯æœåŠ¡æ¶ˆè´¹è€…**æ¯æœåŠ¡**ã€**æ¯æ–¹æ³•**çš„**æœ€å¤§å¯å¹¶è¡Œ**è°ƒç”¨æ•°é™åˆ¶çš„è¿‡æ»¤å™¨å®ç°ç±»ã€‚
```
1: @Activate(group = Constants.CONSUMER, value = Constants.ACTIVES_KEY)
2: public class ActiveLimitFilter implements Filter{
3:
4: @Override
5: public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException{
6: URL url = invoker.getUrl();
7: String methodName = invocation.getMethodName();
8: // è·å¾—æœåŠ¡æä¾›è€…æ¯æœåŠ¡æ¯æ–¹æ³•æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°
9: int max = invoker.getUrl().getMethodParameter(methodName, Constants.ACTIVES_KEY, 0);
10: // è·å¾— RpcStatus å¯¹è±¡ï¼ŒåŸºäºæœåŠ¡ URL + æ–¹æ³•ç»´åº¦
11: RpcStatus count = RpcStatus.getStatus(invoker.getUrl(), invocation.getMethodName());
12: if (max > 0) {
13: // è·å¾—è¶…æ—¶å€¼
14: long timeout = invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.TIMEOUT_KEY, 0);
15: long start = System.currentTimeMillis();
16: long remain = timeout; // å‰©ä½™å¯ç­‰å¾…æ—¶é—´
17: int active = count.getActive();
18: // è¶…è¿‡æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ï¼Œç­‰å¾…
19: if (active >= max) {
20: synchronized (count) { // é€šè¿‡é”ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªåœ¨ç­‰å¾…ã€‚
21: // å¾ªç¯ï¼Œç­‰å¾…å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°
22: while ((active = count.getActive()) >= max) {
23: // ç­‰å¾…ï¼Œç›´åˆ°è¶…æ—¶ï¼Œæˆ–è€…è¢«å”¤é†’
24: try {
25: count.wait(remain);
26: } catch (InterruptedException e) {
27: }
28: // åˆ¤æ–­æ˜¯å¦æ²¡æœ‰å‰©ä½™æ—¶é•¿äº†ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸
29: long elapsed = System.currentTimeMillis() - start; // æœ¬åœ°ç­‰å¾…æ—¶é•¿
30: remain = timeout - elapsed;
31: if (remain <= 0) {
32: throw new RpcException("Waiting concurrent invoke timeout in client-side for service: "
33: + invoker.getInterface().getName() + ", method: "
34: + invocation.getMethodName() + ", elapsed: " + elapsed
35: + ", timeout: " + timeout + ". concurrent invokes: " + active
36: + ". max concurrent invoke limit: " + max);
37: }
38: }
39: }
40: }
41: }
42: try {
43: long begin = System.currentTimeMillis();
44: // è°ƒç”¨å¼€å§‹çš„è®¡æ•°
45: RpcStatus.beginCount(url, methodName);
46: try {
47: // æœåŠ¡è°ƒç”¨
48: Result result = invoker.invoke(invocation);
49: // è°ƒç”¨ç»“æŸçš„è®¡æ•°ï¼ˆæˆåŠŸï¼‰
50: RpcStatus.endCount(url, methodName, System.currentTimeMillis() - begin, true);
51: return result;
52: } catch (RuntimeException t) {
53: // è°ƒç”¨ç»“æŸçš„è®¡æ•°ï¼ˆå¤±è´¥ï¼‰
54: RpcStatus.endCount(url, methodName, System.currentTimeMillis() - begin, false);
55: throw t;
56: }
57: } finally {
58: // å”¤é†’ç­‰å¾…çš„ç›¸åŒæœåŠ¡çš„ç›¸åŒæ–¹æ³•çš„è¯·æ±‚
59: if (max > 0) {
60: synchronized (count) {
61: count.notify();
62: }
63: }
64: }
65: }
66:
67: }
```

* ActiveLimitFilter åŸºäº

RpcStatus.active
å±æ€§ï¼Œåˆ¤æ–­å½“å‰**æ­£åœ¨è°ƒç”¨ä¸­**çš„æœåŠ¡çš„æ–¹æ³•çš„æ¬¡æ•°æ¥åˆ¤æ–­ã€‚å› ä¸ºï¼Œéœ€è¦æœ‰**ç­‰å¾…è¶…æ—¶**çš„ç‰¹æ€§ï¼Œæ‰€ä»¥ä¸ä½¿ç”¨

RpcStatus.semaphore
**ä¿¡å·é‡**çš„æ–¹å¼æ¥å®ç°ã€‚
* ç¬¬ 9 è¡Œï¼šè°ƒç”¨

URL/#getMethodParameter(methodName, key, defaultValue)
æ–¹æ³•ï¼Œè·å¾—æœåŠ¡æä¾›è€…æ¯æœåŠ¡æ¯æ–¹æ³•æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ã€‚ä¼˜å…ˆ

<dubbo: method />
ï¼Œå…¶æ¬¡

<dubbo:reference />
ã€‚
* ç¬¬ 11 è¡Œï¼šè°ƒç”¨

RpcStatus/#getStatus(url, methodName)
æ–¹æ³•ï¼Œè·å¾— RpcStatus å¯¹è±¡ï¼ŒåŸºäº**æœåŠ¡ URL + æ–¹æ³•**ä¸ºç»´åº¦ã€‚
* ç¬¬ 14 è¡Œï¼šè·å¾—**è¶…æ—¶å€¼**ã€‚è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œæ­¤å¤„äº§ç”Ÿçš„**ç­‰å¾…**æ—¶é•¿ï¼Œ**ä¸**å ç”¨è°ƒç”¨æœåŠ¡çš„**è¶…æ—¶**æ—¶é•¿ã€‚æ‰€ä»¥ï¼Œ**æç«¯æƒ…å†µ**ä¸‹çš„æœåŠ¡è¶…æ—¶ï¼Œçº¦ç­‰äº 2 /*

timeout
ã€‚
* ç¬¬ 19 è¡Œï¼šè¶…è¿‡æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ï¼Œ**éœ€è¦ç­‰å¾…**ã€‚
* ç¬¬ 20 è¡Œï¼šé€šè¿‡**é”å®š**

synchronized
ï¼Œ**æœ‰ä¸”ä»…æœ‰**ä¸€ä¸ªåœ¨ç­‰å¾…ã€‚åŒæ—¶ï¼Œä¹Ÿä¿è¯å…ˆè°ƒç”¨çš„å¯ä»¥å…ˆæ‰§è¡Œã€‚
* ç¬¬ 22 è¡Œï¼š**å¾ªç¯**ï¼Œç­‰å¾…å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ã€‚ä¸ºä»€ä¹ˆéœ€è¦å¾ªç¯å‘¢ï¼Ÿæç«¯æƒ…å†µä¸‹ï¼Œæ°å¥½æœ‰ä¸€ä¸ª**æ–°çš„**è°ƒç”¨ï¼Œåœ¨ã€ç¬¬ 61 è¡Œã€‘æ‰§è¡Œçš„ä¸€ç¬é—´ï¼Œèµ°åˆ°äº†ã€ç¬¬ 19 è¡Œã€‘ï¼Œâ€œ**æŠ¢**â€èµ°äº†æ­£åœ¨é”å®šç­‰å¾…çš„è¯·æ±‚æœºä¼šã€‚
* ç¬¬ 23 è‡³ 27 è¡Œï¼šç­‰å¾…ï¼Œç›´åˆ°è¶…æ—¶ï¼Œæˆ–è€…è¢«å”¤é†’ã€ç¬¬ 61 è¡Œã€‘ã€‚
* ç¬¬ 28 è‡³ 37 è¡Œï¼šåˆ¤æ–­è‹¥æ²¡æœ‰å‰©ä½™æ—¶é•¿äº†ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚
* ç¬¬ 45 è¡Œï¼šè°ƒç”¨

RpcStaus/#beginCount(url, methodName)
æ–¹æ³•ï¼Œè°ƒç”¨å¼€å§‹çš„è®¡æ•°ã€‚
* ç¬¬ 48 è¡Œï¼šè°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚
* ç¬¬ 50 è¡Œï¼šè°ƒç”¨

RpcStaus/#endCount(url, methodName, true)
æ–¹æ³•ï¼Œè°ƒç”¨å¼€å§‹çš„è®¡æ•°ï¼ˆæˆåŠŸï¼‰ã€‚
* ç¬¬ 54 è¡Œï¼šè°ƒç”¨

RpcStaus/#endCount(url, methodName, false)
æ–¹æ³•ï¼Œè°ƒç”¨å¼€å§‹çš„è®¡æ•°ï¼ˆå¤±è´¥ï¼‰ã€‚
* ç¬¬ 59 è‡³ 63 è¡Œï¼šå”¤é†’ç­‰å¾…çš„ç›¸åŒæœåŠ¡çš„ç›¸åŒæ–¹æ³•çš„è¯·æ±‚ã€ç¬¬ 25 è¡Œã€‘ã€‚

# 4. ExecuteLimitFilter

com.alibaba.dubbo.rpc.filter.ExecuteLimitFilter
ï¼Œå®ç° Filter æ¥å£ï¼ŒæœåŠ¡æä¾›è€…**æ¯æœåŠ¡**ã€**æ¯æ–¹æ³•**çš„**æœ€å¤§å¯å¹¶è¡Œ**æ‰§è¡Œè¯·æ±‚æ•°çš„è¿‡æ»¤å™¨å®ç°ç±»ã€‚
```
1: @Activate(group = Constants.PROVIDER, value = Constants.EXECUTES_KEY)
2: public class ExecuteLimitFilter implements Filter{
3:
4: @Override
5: public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException{
6: URL url = invoker.getUrl();
7: String methodName = invocation.getMethodName();
8: Semaphore executesLimit = null; // ä¿¡å·é‡
9: boolean acquireResult = false; // æ˜¯å¦è·å¾—ä¿¡å·é‡
10: // è·å¾—æœåŠ¡æä¾›è€…æ¯æœåŠ¡æ¯æ–¹æ³•æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°
11: int max = url.getMethodParameter(methodName, Constants.EXECUTES_KEY, 0);
12: if (max > 0) {
13: // è·å¾— RpcStatus å¯¹è±¡ï¼ŒåŸºäºæœåŠ¡ URL + æ–¹æ³•ç»´åº¦
14: RpcStatus count = RpcStatus.getStatus(url, invocation.getMethodName());
15: // è·å¾—ä¿¡å·é‡ã€‚è‹¥è·å¾—ä¸åˆ°ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚
16: // if (count.getActive() >= max) {
17: //*/*
18: /* http://manzhizhen.iteye.com/blog/2386408
19: /* use semaphore for concurrency control (to limit thread number)
20: /*/
21: executesLimit = count.getSemaphore(max);
22: if (executesLimit != null && !(acquireResult = executesLimit.tryAcquire())) {
23: throw new RpcException("Failed to invoke method " + invocation.getMethodName() + " in provider " + url + ", cause: The service using threads greater than <dubbo:service executes=\"" + max + "\" /> limited.");
24: }
25: }
26: long begin = System.currentTimeMillis();
27: boolean isSuccess = true;
28: // è°ƒç”¨å¼€å§‹çš„è®¡æ•°
29: RpcStatus.beginCount(url, methodName);
30: try {
31: // æœåŠ¡è°ƒç”¨
32: return invoker.invoke(invocation);
33: } catch (Throwable t) {
34: isSuccess = false; // æ ‡è®°å¤±è´¥
35: if (t instanceof RuntimeException) {
36: throw (RuntimeException) t;
37: } else {
38: throw new RpcException("unexpected exception when ExecuteLimitFilter", t);
39: }
40: } finally {
41: // è°ƒç”¨ç»“æŸçš„è®¡æ•°ï¼ˆæˆåŠŸï¼‰ï¼ˆå¤±è´¥ï¼‰
42: RpcStatus.endCount(url, methodName, System.currentTimeMillis() - begin, isSuccess);
43: // é‡Šæ”¾ä¿¡å·é‡
44: if (acquireResult) {
45: executesLimit.release();
46: }
47: }
48: }
49:
50: }
```

* ActiveLimitFilter åŸºäº

RpcStatus.semaphore
**ä¿¡å·é‡**å±æ€§ï¼Œåˆ¤æ–­è‹¥è¶…è¿‡æœ€å¤§å¯å¹¶è¡Œï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚
* ç¬¬ 11 è¡Œï¼šè°ƒç”¨

URL/#getMethodParameter(methodName, key, defaultValue)
æ–¹æ³•ï¼Œè·å¾—æœåŠ¡æä¾›è€…æ¯æœåŠ¡æ¯æ–¹æ³•æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ã€‚ä¼˜å…ˆ

<dubbo: method />
ï¼Œå…¶æ¬¡

<dubbo:service />
ã€‚
* ç¬¬ 13 è¡Œï¼šè°ƒç”¨

RpcStatus/#getStatus(url, methodName)
æ–¹æ³•ï¼Œè·å¾— RpcStatus å¯¹è±¡ï¼ŒåŸºäº**æœåŠ¡ URL + æ–¹æ³•**ä¸ºç»´åº¦ã€‚
* ç¬¬ 21 è‡³ 21 è¡Œï¼šè°ƒç”¨

RpcStatus/#getSemaphore(max)
æ–¹æ³•ï¼Œè·å¾— Semaphore å¯¹è±¡ã€‚
* ç¬¬ 22 è‡³ 24 è¡Œï¼šè°ƒç”¨

Semaphore/#tryAcquire()
æ–¹æ³•ï¼Œè‹¥è·å¾—ä¸åˆ°ä¿¡å·é‡ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚
* ç¬¬ 29 è¡Œï¼šè°ƒç”¨

RpcStaus/#beginCount(url, methodName)
æ–¹æ³•ï¼Œè°ƒç”¨å¼€å§‹çš„è®¡æ•°ã€‚
* ç¬¬ 32 è¡Œï¼šè°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚
* ç¬¬ 34 è¡Œï¼šè‹¥å‘ç”Ÿå¼‚å¸¸ï¼Œæ ‡è®°

isSuccess = false
ï¼Œè¡¨ç¤ºè°ƒç”¨å¤±è´¥ã€‚
* ç¬¬ 42 è¡Œï¼šè°ƒç”¨

RpcStaus/#endCount(url, methodName, success)
æ–¹æ³•ï¼Œè°ƒç”¨å¼€å§‹çš„è®¡æ•°ï¼ˆæˆåŠŸï¼‰ï¼ˆå¤±è´¥ï¼‰ã€‚
* ç¬¬ 43 è‡³ 46 è¡Œï¼šè°ƒç”¨

Semaphore/#release()
æ–¹æ³•ï¼Œé‡Šæ”¾ä¿¡å·é‡ã€‚