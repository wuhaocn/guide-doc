<header class="article-header">
<h1 class="article-title">è¿‡æ»¤å™¨ï¼ˆå››ï¼‰ä¹‹ ActiveLimitFilter &amp;&amp; ExecuteLimitFilter</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡åˆ†äº«<strong>æœåŠ¡æ–¹æ³•</strong>çš„<strong>æœ€å¤§å¯å¹¶è¡Œè°ƒç”¨</strong>çš„<strong>é™åˆ¶</strong>è¿‡æ»¤å™¨ï¼Œåœ¨æœåŠ¡<strong>æ¶ˆè´¹è€…</strong>å’Œ<strong>æä¾›è€…</strong>å„æœ‰ä¸€ä¸ª LimitFilter ï¼š</p>
<ul>
<li>
<p>ActiveLimitFilter ï¼Œåœ¨æœåŠ¡<strong>æ¶ˆè´¹è€…</strong>ï¼Œé€šè¿‡&nbsp;<code>&lt;dubbo:reference /&gt;</code>&nbsp;çš„&nbsp;<code>"actives"</code>&nbsp;<strong>ç»Ÿä¸€</strong>é…ç½®é¡¹å¼€å¯ï¼š</p>
<blockquote>
<p>æ¯æœåŠ¡æ¶ˆè´¹è€…ï¼Œ<strong>æ¯æœåŠ¡</strong>çš„<strong>æ¯æ–¹æ³•</strong>æœ€å¤§å¹¶å‘è°ƒç”¨æ•°ã€‚</p>
</blockquote>
</li>
<li>
<p>ExecuteLimitFilter ï¼Œåœ¨æœåŠ¡<strong>æä¾›è€…</strong>ï¼Œé€šè¿‡&nbsp;<code>&lt;dubbo:service /&gt;</code>&nbsp;çš„&nbsp;<code>"executes"</code>&nbsp;<strong>ç»Ÿä¸€</strong>é…ç½®é¡¹å¼€å¯ï¼š</p>
<blockquote>
<p>æœåŠ¡æä¾›è€…ï¼Œ<strong>æ¯æœåŠ¡</strong>çš„<strong>æ¯æ–¹æ³•</strong>æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ã€‚</p>
</blockquote>
</li>
</ul>
<p>å¦å¤–ï¼Œåœ¨&nbsp;<code>&lt;dubbo:method /&gt;</code>&nbsp;çš„&nbsp;<code>"actives"</code>&nbsp;å’Œ&nbsp;<code>"executes"</code>&nbsp;é…ç½®é¡¹ï¼Œå¯ä»¥<strong>è‡ªå®šä¹‰</strong>æ¯ä¸ªæ–¹æ³•çš„é…ç½®ã€‚</p>
<h1 id="2-RpcStatus">2. RpcStatus</h1>
<p><code>com.alibaba.dubbo.rpc.RpcStatus</code>&nbsp;ï¼ŒRPC çŠ¶æ€ã€‚å¯ä»¥è®¡å…¥å¦‚ä¸‹ç»´åº¦ç»Ÿè®¡ï¼š</p>
<ul>
<li>
<ol>
<li>åŸºäºæœåŠ¡ URL</li>
</ol>
</li>
<li>
<ol start="2">
<li>åŸºäºæœåŠ¡ URL + æ–¹æ³•</li>
</ol>
</li>
</ul>
<p>ç”¨äº ActiveLimitFilter å’Œ ExecuteLimitFilter ä¸­ã€‚ğŸ™‚ å½“ç„¶ï¼ŒDubbo ä¸­ï¼Œä¹Ÿæœ‰å…¶ä»–ç±»ï¼Œä¹Ÿä¼šè°ƒç”¨åˆ° RpcStatus ã€‚</p>
<h2 id="2-1-æ„é€ æ–¹æ³•">2.1 æ„é€ æ–¹æ³•</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * åŸºäºæœåŠ¡ URL ä¸ºç»´åº¦çš„ RpcStatus é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * keyï¼šURL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;String, RpcStatus&gt; SERVICE_STATISTICS = <span class="keyword">new</span> ConcurrentHashMap&lt;String, RpcStatus&gt;();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * åŸºäºæœåŠ¡ URL + æ–¹æ³•ç»´åº¦çš„ RpcStatus é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * key1ï¼šURL</span></span><br /><span class="line"><span class="comment"> * key2ï¼šæ–¹æ³•å</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;String, ConcurrentMap&lt;String, RpcStatus&gt;&gt; METHOD_STATISTICS = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ConcurrentMap&lt;String, RpcStatus&gt;&gt;();</span><br /><br /><span class="line"><span class="comment">// ç›®å‰æ²¡æœ‰ç”¨åˆ°</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, Object&gt; values = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Object&gt;();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è°ƒç”¨ä¸­çš„æ¬¡æ•°</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger active = <span class="keyword">new</span> AtomicInteger();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ€»è°ƒç”¨æ¬¡æ•°</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicLong total = <span class="keyword">new</span> AtomicLong();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ€»è°ƒç”¨å¤±è´¥æ¬¡æ•°</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger failed = <span class="keyword">new</span> AtomicInteger();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ€»è°ƒç”¨æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicLong totalElapsed = <span class="keyword">new</span> AtomicLong();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ€»è°ƒç”¨å¤±è´¥æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicLong failedElapsed = <span class="keyword">new</span> AtomicLong();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æœ€å¤§è°ƒç”¨æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicLong maxElapsed = <span class="keyword">new</span> AtomicLong();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æœ€å¤§è°ƒç”¨å¤±è´¥æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicLong failedMaxElapsed = <span class="keyword">new</span> AtomicLong();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æœ€å¤§è°ƒç”¨æˆåŠŸæ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicLong succeededMaxElapsed = <span class="keyword">new</span> AtomicLong();</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Semaphore used to control concurrency limit set by `executes`</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * æœåŠ¡æ‰§è¡Œä¿¡å·é‡ï¼Œåœ¨ {<span class="doctag">@link</span> com.alibaba.dubbo.rpc.filter.ExecuteLimitFilter} ä¸­ä½¿ç”¨</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Semaphore executesLimit;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æœåŠ¡æ‰§è¡Œä¿¡å·é‡å¤§å°</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> executesPermits;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>========== é™æ€å±æ€§ ==========</li>
<li>
<p><code>SERVICE_STATISTICS</code>&nbsp;å±æ€§ï¼ŒåŸºäº<strong>æœåŠ¡ URL</strong>&nbsp;ä¸ºç»´åº¦çš„&nbsp;<strong>RpcStatus</strong>&nbsp;é›†åˆã€‚<code>#getStatus(url)</code>&nbsp;<strong>é™æ€</strong>æ–¹æ³•ï¼Œè·å¾— RpcStatus å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RpcStatus <span class="title">getStatus</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    String uri = url.toIdentityString();</span><br /><span class="line">    <span class="comment">// è·å¾—</span></span><br /><span class="line">    RpcStatus status = SERVICE_STATISTICS.get(uri);</span><br /><span class="line">    <span class="comment">// ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œåˆ›å»º</span></span><br /><span class="line">    <span class="keyword">if</span> (status == <span class="keyword">null</span>) {</span><br /><span class="line">        SERVICE_STATISTICS.putIfAbsent(uri, <span class="keyword">new</span> RpcStatus());</span><br /><span class="line">        status = SERVICE_STATISTICS.get(uri);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> status;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>METHOD_STATISTICS</code>&nbsp;å±æ€§ï¼ŒåŸºäº<strong>æœåŠ¡ URL</strong>&nbsp;+&nbsp;<strong>æ–¹æ³•</strong>ä¸ºç»´åº¦çš„&nbsp;<strong>RpcStatus</strong>&nbsp;é›†åˆã€‚<code>#getStatus(url, methodName)</code>&nbsp;<strong>é™æ€</strong>æ–¹æ³•ï¼Œè·å¾— RpcStatus å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RpcStatus <span class="title">getStatus</span><span class="params">(URL url, String methodName)</span> </span>{</span><br /><span class="line">    String uri = url.toIdentityString();</span><br /><span class="line">    <span class="comment">// è·å¾—æ–¹æ³•é›†åˆ</span></span><br /><span class="line">    ConcurrentMap&lt;String, RpcStatus&gt; map = METHOD_STATISTICS.get(uri);</span><br /><span class="line">    <span class="comment">// ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–¹æ³•é›†åˆ</span></span><br /><span class="line">    <span class="keyword">if</span> (map == <span class="keyword">null</span>) {</span><br /><span class="line">        METHOD_STATISTICS.putIfAbsent(uri, <span class="keyword">new</span> ConcurrentHashMap&lt;String, RpcStatus&gt;());</span><br /><span class="line">        map = METHOD_STATISTICS.get(uri);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">// è·å¾— RpcStatus å¯¹è±¡</span></span><br /><span class="line">    RpcStatus status = map.get(methodName);</span><br /><span class="line">    <span class="comment">// ä¸å­˜åœ¨ï¼Œåˆ›å»º RpcStatus å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">if</span> (status == <span class="keyword">null</span>) {</span><br /><span class="line">        map.putIfAbsent(methodName, <span class="keyword">new</span> RpcStatus());</span><br /><span class="line">        status = map.get(methodName);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> status;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>========== å¯¹è±¡å±æ€§ ==========</p>
</li>
<li>æ¬¡æ•°ç›¸å…³
<ul>
<li><code>active</code>&nbsp;ï¼Œ<strong>è°ƒç”¨ä¸­</strong>çš„æ¬¡æ•°ã€‚è¿™ä¸ªå±æ€§åœ¨ ActiveLimitFilter ä¸­<strong>éå¸¸å…³é”®</strong>ã€‚</li>
<li><code>total</code>&nbsp;<code>failed</code></li>
</ul>
</li>
<li>æ—¶é•¿ç›¸å…³
<ul>
<li><code>totalElapsed</code>&nbsp;<code>failedElapsed</code></li>
<li><code>failedElapsed</code>&nbsp;<code>failedMaxElapsed</code>&nbsp;<code>succeededMaxElapsed</code></li>
</ul>
</li>
<li>ä¿¡å·é‡ç›¸å…³
<ul>
<li><code>executesLimit</code>&nbsp;ï¼ŒæœåŠ¡æ‰§è¡Œä¿¡å·é‡ã€‚è¿™ä¸ªå±æ€§åœ¨ ExecuteLimitFilter ä¸­<strong>éå¸¸å…³é”®</strong>ã€‚</li>
<li><code>executesPermits</code>&nbsp;ï¼ŒæœåŠ¡æ‰§è¡Œä¿¡å·é‡å¤§å°ã€‚</li>
</ul>
</li>
</ul>
<h2 id="2-2-beginCount">2.2 beginCount</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æœåŠ¡è°ƒç”¨å¼€å§‹çš„è®¡æ•°</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> url URL å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> methodName æ–¹æ³•å</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">beginCount</span><span class="params">(URL url, String methodName)</span> </span>{</span><br /><span class="line">    <span class="comment">// `SERVICE_STATISTICS` çš„è®¡æ•°</span></span><br /><span class="line">    beginCount(getStatus(url));</span><br /><span class="line">    <span class="comment">// `METHOD_STATISTICS` çš„è®¡æ•°</span></span><br /><span class="line">    beginCount(getStatus(url, methodName));</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><strong>é™æ€æ–¹æ³•</strong>ï¼Œåœ¨å…¶å†…éƒ¨ï¼Œä¼šè°ƒç”¨ä¸¤æ¬¡&nbsp;<code>#beginCount(RpcStatus)</code>&nbsp;æ–¹æ³•ï¼Œåˆ†åˆ«è®¡æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">beginCount</span><span class="params">(RpcStatus status)</span> </span>{</span><br /><span class="line">    <span class="comment">// è°ƒç”¨ä¸­çš„æ¬¡æ•°</span></span><br /><span class="line">    status.active.incrementAndGet();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<h2 id="2-3-endCount">2.3 endCount</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æœåŠ¡è°ƒç”¨ç»“æŸçš„è®¡æ•°</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> url URL å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> elapsed æ—¶é•¿ï¼Œæ¯«ç§’</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> succeeded æ˜¯å¦æˆåŠŸ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">endCount</span><span class="params">(URL url, String methodName, <span class="keyword">long</span> elapsed, <span class="keyword">boolean</span> succeeded)</span> </span>{</span><br /><span class="line">    <span class="comment">// `SERVICE_STATISTICS` çš„è®¡æ•°</span></span><br /><span class="line">    endCount(getStatus(url), elapsed, succeeded);</span><br /><span class="line">    <span class="comment">// `METHOD_STATISTICS` çš„è®¡æ•°</span></span><br /><span class="line">    endCount(getStatus(url, methodName), elapsed, succeeded);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><strong>é™æ€æ–¹æ³•</strong>ï¼Œåœ¨å…¶å†…éƒ¨ï¼Œä¼šè°ƒç”¨ä¸¤æ¬¡&nbsp;<code>#endCount(RpcStatus)</code>&nbsp;æ–¹æ³•ï¼Œåˆ†åˆ«è®¡æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">endCount</span><span class="params">(RpcStatus status, <span class="keyword">long</span> elapsed, <span class="keyword">boolean</span> succeeded)</span> </span>{</span><br /><span class="line">    <span class="comment">// æ¬¡æ•°è®¡æ•°</span></span><br /><span class="line">    status.active.decrementAndGet();</span><br /><span class="line">    status.total.incrementAndGet();</span><br /><span class="line">    status.totalElapsed.addAndGet(elapsed);</span><br /><span class="line">    <span class="comment">// æ—¶é•¿è®¡æ•°</span></span><br /><span class="line">    <span class="keyword">if</span> (status.maxElapsed.get() &lt; elapsed) {</span><br /><span class="line">        status.maxElapsed.set(elapsed);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">if</span> (succeeded) {</span><br /><span class="line">        <span class="keyword">if</span> (status.succeededMaxElapsed.get() &lt; elapsed) {</span><br /><span class="line">            status.succeededMaxElapsed.set(elapsed);</span><br /><span class="line">        }</span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        status.failed.incrementAndGet(); <span class="comment">// å¤±è´¥æ¬¡æ•°</span></span><br /><span class="line">        status.failedElapsed.addAndGet(elapsed);</span><br /><span class="line">        <span class="keyword">if</span> (status.failedMaxElapsed.get() &lt; elapsed) {</span><br /><span class="line">            status.failedMaxElapsed.set(elapsed);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<h2 id="2-4-getSemaphore">2.4 getSemaphore</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> Semaphore <span class="title">getSemaphore</span><span class="params">(<span class="keyword">int</span> maxThreadNum)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span>(maxThreadNum &lt;= <span class="number">0</span>) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è‹¥ä¿¡å·é‡ä¸å­˜åœ¨ï¼Œæˆ–è€…ä¿¡å·é‡å¤§å°æ”¹å˜ï¼Œåˆ›å»ºæ–°çš„ä¿¡å·é‡</span></span><br /><span class="line">    <span class="keyword">if</span> (executesLimit == <span class="keyword">null</span> || executesPermits != maxThreadNum) {</span><br /><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</span><br /><span class="line">            <span class="keyword">if</span> (executesLimit == <span class="keyword">null</span> || executesPermits != maxThreadNum) {</span><br /><span class="line">                executesLimit = <span class="keyword">new</span> Semaphore(maxThreadNum);</span><br /><span class="line">                executesPermits = maxThreadNum;</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è¿”å›ä¿¡å·é‡</span></span><br /><span class="line">    <span class="keyword">return</span> executesLimit;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><strong>å¯¹è±¡</strong>æ–¹æ³•ï¼Œè·å¾—ä¿¡å·é‡&nbsp;<code>executesPermits</code>&nbsp;å±æ€§ã€‚</li>
<li>åˆ›å»ºä¿¡å·é‡çš„<strong>æ¡ä»¶</strong>ï¼Œä¿¡å·é‡&nbsp;<code>executesPermits</code>&nbsp;ä¸å­˜åœ¨ï¼Œæˆ–è€…ä¿¡å·é‡å¤§å°&nbsp;<code>executesLimit</code>&nbsp;å‘ç”Ÿæ”¹å˜ã€‚æˆ‘ä»¬ä¼šå‘ç”Ÿæ¯”è¾ƒ&ldquo;ç¥å¥‡&rdquo;çš„æ˜¯ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯<strong>ç›´æ¥</strong>è¿”å› Semaphore å¯¹è±¡ã€‚è€ƒè™‘åˆ°æœ‰ä¿¡å·é‡å¤§å°æ”¹å˜çš„éœ€æ±‚ï¼Œä½†æ˜¯ä¿¡å·é‡ä¸æ”¯æŒ<strong>æ‰¹é‡</strong>ä¿®æ”¹å¤§å°ï¼Œé‚£ä¹ˆå‰©ä½™çš„ä¸€ç§åˆé€‚çš„æ–¹å¼ï¼Œåˆ›å»º<strong>æ–°çš„</strong>ä¿¡å·é‡å¯¹è±¡ã€‚å› æ­¤ï¼Œè¿™ä¸ªæ–¹æ³•å°±é€‰æ‹©äº†ç›´æ¥è¿”å› Semaphore å¯¹è±¡ã€‚</li>
<li>åœ¨&nbsp;<a href="http://manzhizhen.iteye.com/blog/2386408" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubboæºä»£ç åˆ†æä¸ƒï¼šä½¿ç”¨executeså±æ€§çš„ä¸€ä¸ªé—®é¢˜ã€‹</a>&nbsp;ä¸­ï¼Œåˆ†äº«çš„å¾ˆä¸é”™ã€‚</li>
</ul>
<h1 id="3-ActiveLimitFilter">3. ActiveLimitFilter</h1>
<p><code>com.alibaba.dubbo.rpc.filter.ActiveLimitFilter</code>&nbsp;ï¼Œå®ç° Filter æ¥å£ï¼Œæ¯æœåŠ¡æ¶ˆè´¹è€…<strong>æ¯æœåŠ¡</strong>ã€<strong>æ¯æ–¹æ³•</strong>çš„<strong>æœ€å¤§å¯å¹¶è¡Œ</strong>è°ƒç”¨æ•°é™åˆ¶çš„è¿‡æ»¤å™¨å®ç°ç±»ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Activate</span>(group = Constants.CONSUMER, value = Constants.ACTIVES_KEY)</span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActiveLimitFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>{</span><br /><span class="line"> <span class="number">3</span>: </span><br /><span class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">6</span>:         URL url = invoker.getUrl();</span><br /><span class="line"> <span class="number">7</span>:         String methodName = invocation.getMethodName();</span><br /><span class="line"> <span class="number">8</span>:         <span class="comment">// è·å¾—æœåŠ¡æä¾›è€…æ¯æœåŠ¡æ¯æ–¹æ³•æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°</span></span><br /><span class="line"> <span class="number">9</span>:         <span class="keyword">int</span> max = invoker.getUrl().getMethodParameter(methodName, Constants.ACTIVES_KEY, <span class="number">0</span>);</span><br /><span class="line"><span class="number">10</span>:         <span class="comment">// è·å¾— RpcStatus å¯¹è±¡ï¼ŒåŸºäºæœåŠ¡ URL + æ–¹æ³•ç»´åº¦</span></span><br /><span class="line"><span class="number">11</span>:         RpcStatus count = RpcStatus.getStatus(invoker.getUrl(), invocation.getMethodName());</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">if</span> (max &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">13</span>:             <span class="comment">// è·å¾—è¶…æ—¶å€¼</span></span><br /><span class="line"><span class="number">14</span>:             <span class="keyword">long</span> timeout = invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.TIMEOUT_KEY, <span class="number">0</span>);</span><br /><span class="line"><span class="number">15</span>:             <span class="keyword">long</span> start = System.currentTimeMillis();</span><br /><span class="line"><span class="number">16</span>:             <span class="keyword">long</span> remain = timeout; <span class="comment">// å‰©ä½™å¯ç­‰å¾…æ—¶é—´</span></span><br /><span class="line"><span class="number">17</span>:             <span class="keyword">int</span> active = count.getActive();</span><br /><span class="line"><span class="number">18</span>:             <span class="comment">// è¶…è¿‡æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ï¼Œç­‰å¾…</span></span><br /><span class="line"><span class="number">19</span>:             <span class="keyword">if</span> (active &gt;= max) {</span><br /><span class="line"><span class="number">20</span>:                 <span class="keyword">synchronized</span> (count) { <span class="comment">// é€šè¿‡é”ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€ä¸ªåœ¨ç­‰å¾…ã€‚</span></span><br /><span class="line"><span class="number">21</span>:                     <span class="comment">// å¾ªç¯ï¼Œç­‰å¾…å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°</span></span><br /><span class="line"><span class="number">22</span>:                     <span class="keyword">while</span> ((active = count.getActive()) &gt;= max) {</span><br /><span class="line"><span class="number">23</span>:                         <span class="comment">// ç­‰å¾…ï¼Œç›´åˆ°è¶…æ—¶ï¼Œæˆ–è€…è¢«å”¤é†’</span></span><br /><span class="line"><span class="number">24</span>:                         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">25</span>:                             count.wait(remain);</span><br /><span class="line"><span class="number">26</span>:                         } <span class="keyword">catch</span> (InterruptedException e) {</span><br /><span class="line"><span class="number">27</span>:                         }</span><br /><span class="line"><span class="number">28</span>:                         <span class="comment">// åˆ¤æ–­æ˜¯å¦æ²¡æœ‰å‰©ä½™æ—¶é•¿äº†ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸</span></span><br /><span class="line"><span class="number">29</span>:                         <span class="keyword">long</span> elapsed = System.currentTimeMillis() - start; <span class="comment">// æœ¬åœ°ç­‰å¾…æ—¶é•¿</span></span><br /><span class="line"><span class="number">30</span>:                         remain = timeout - elapsed;</span><br /><span class="line"><span class="number">31</span>:                         <span class="keyword">if</span> (remain &lt;= <span class="number">0</span>) {</span><br /><span class="line"><span class="number">32</span>:                             <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Waiting concurrent invoke timeout in client-side for service:  "</span></span><br /><span class="line"><span class="number">33</span>:                                     + invoker.getInterface().getName() + <span class="string">", method: "</span></span><br /><span class="line"><span class="number">34</span>:                                     + invocation.getMethodName() + <span class="string">", elapsed: "</span> + elapsed</span><br /><span class="line"><span class="number">35</span>:                                     + <span class="string">", timeout: "</span> + timeout + <span class="string">". concurrent invokes: "</span> + active</span><br /><span class="line"><span class="number">36</span>:                                     + <span class="string">". max concurrent invoke limit: "</span> + max);</span><br /><span class="line"><span class="number">37</span>:                         }</span><br /><span class="line"><span class="number">38</span>:                     }</span><br /><span class="line"><span class="number">39</span>:                 }</span><br /><span class="line"><span class="number">40</span>:             }</span><br /><span class="line"><span class="number">41</span>:         }</span><br /><span class="line"><span class="number">42</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">43</span>:             <span class="keyword">long</span> begin = System.currentTimeMillis();</span><br /><span class="line"><span class="number">44</span>:             <span class="comment">// è°ƒç”¨å¼€å§‹çš„è®¡æ•°</span></span><br /><span class="line"><span class="number">45</span>:             RpcStatus.beginCount(url, methodName);</span><br /><span class="line"><span class="number">46</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">47</span>:                 <span class="comment">// æœåŠ¡è°ƒç”¨</span></span><br /><span class="line"><span class="number">48</span>:                 Result result = invoker.invoke(invocation);</span><br /><span class="line"><span class="number">49</span>:                 <span class="comment">// è°ƒç”¨ç»“æŸçš„è®¡æ•°ï¼ˆæˆåŠŸï¼‰</span></span><br /><span class="line"><span class="number">50</span>:                 RpcStatus.endCount(url, methodName, System.currentTimeMillis() - begin, <span class="keyword">true</span>);</span><br /><span class="line"><span class="number">51</span>:                 <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">52</span>:             } <span class="keyword">catch</span> (RuntimeException t) {</span><br /><span class="line"><span class="number">53</span>:                 <span class="comment">// è°ƒç”¨ç»“æŸçš„è®¡æ•°ï¼ˆå¤±è´¥ï¼‰</span></span><br /><span class="line"><span class="number">54</span>:                 RpcStatus.endCount(url, methodName, System.currentTimeMillis() - begin, <span class="keyword">false</span>);</span><br /><span class="line"><span class="number">55</span>:                 <span class="keyword">throw</span> t;</span><br /><span class="line"><span class="number">56</span>:             }</span><br /><span class="line"><span class="number">57</span>:         } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">58</span>:             <span class="comment">// å”¤é†’ç­‰å¾…çš„ç›¸åŒæœåŠ¡çš„ç›¸åŒæ–¹æ³•çš„è¯·æ±‚</span></span><br /><span class="line"><span class="number">59</span>:             <span class="keyword">if</span> (max &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">60</span>:                 <span class="keyword">synchronized</span> (count) {</span><br /><span class="line"><span class="number">61</span>:                     count.notify();</span><br /><span class="line"><span class="number">62</span>:                 }</span><br /><span class="line"><span class="number">63</span>:             }</span><br /><span class="line"><span class="number">64</span>:         }</span><br /><span class="line"><span class="number">65</span>:     }</span><br /><span class="line"><span class="number">66</span>: </span><br /><span class="line"><span class="number">67</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ActiveLimitFilter åŸºäº&nbsp;<code>RpcStatus.active</code>&nbsp;å±æ€§ï¼Œåˆ¤æ–­å½“å‰<strong>æ­£åœ¨è°ƒç”¨ä¸­</strong>çš„æœåŠ¡çš„æ–¹æ³•çš„æ¬¡æ•°æ¥åˆ¤æ–­ã€‚å› ä¸ºï¼Œéœ€è¦æœ‰<strong>ç­‰å¾…è¶…æ—¶</strong>çš„ç‰¹æ€§ï¼Œæ‰€ä»¥ä¸ä½¿ç”¨&nbsp;<code>RpcStatus.semaphore</code>&nbsp;<strong>ä¿¡å·é‡</strong>çš„æ–¹å¼æ¥å®ç°ã€‚</li>
<li>ç¬¬ 9 è¡Œï¼šè°ƒç”¨&nbsp;<code>URL#getMethodParameter(methodName, key, defaultValue)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æœåŠ¡æä¾›è€…æ¯æœåŠ¡æ¯æ–¹æ³•æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ã€‚ä¼˜å…ˆ&nbsp;<code>&lt;dubbo: method /&gt;</code>&nbsp;ï¼Œå…¶æ¬¡&nbsp;<code>&lt;dubbo:reference /&gt;</code>&nbsp;ã€‚</li>
<li>ç¬¬ 11 è¡Œï¼šè°ƒç”¨&nbsp;<code>RpcStatus#getStatus(url, methodName)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— RpcStatus å¯¹è±¡ï¼ŒåŸºäº<strong>æœåŠ¡ URL + æ–¹æ³•</strong>ä¸ºç»´åº¦ã€‚</li>
<li>ç¬¬ 14 è¡Œï¼šè·å¾—<strong>è¶…æ—¶å€¼</strong>ã€‚è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œæ­¤å¤„äº§ç”Ÿçš„<strong>ç­‰å¾…</strong>æ—¶é•¿ï¼Œ<strong>ä¸</strong>å ç”¨è°ƒç”¨æœåŠ¡çš„<strong>è¶…æ—¶</strong>æ—¶é•¿ã€‚æ‰€ä»¥ï¼Œ<strong>æç«¯æƒ…å†µ</strong>ä¸‹çš„æœåŠ¡è¶…æ—¶ï¼Œçº¦ç­‰äº 2 *&nbsp;<code>timeout</code>&nbsp;ã€‚</li>
<li>ç¬¬ 19 è¡Œï¼šè¶…è¿‡æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ï¼Œ<strong>éœ€è¦ç­‰å¾…</strong>ã€‚</li>
<li>ç¬¬ 20 è¡Œï¼šé€šè¿‡<strong>é”å®š</strong>&nbsp;<code>synchronized</code>&nbsp;ï¼Œ<strong>æœ‰ä¸”ä»…æœ‰</strong>ä¸€ä¸ªåœ¨ç­‰å¾…ã€‚åŒæ—¶ï¼Œä¹Ÿä¿è¯å…ˆè°ƒç”¨çš„å¯ä»¥å…ˆæ‰§è¡Œã€‚</li>
<li>ç¬¬ 22 è¡Œï¼š<strong>å¾ªç¯</strong>ï¼Œç­‰å¾…å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ã€‚ä¸ºä»€ä¹ˆéœ€è¦å¾ªç¯å‘¢ï¼Ÿæç«¯æƒ…å†µä¸‹ï¼Œæ°å¥½æœ‰ä¸€ä¸ª<strong>æ–°çš„</strong>è°ƒç”¨ï¼Œåœ¨ã€ç¬¬ 61 è¡Œã€‘æ‰§è¡Œçš„ä¸€ç¬é—´ï¼Œèµ°åˆ°äº†ã€ç¬¬ 19 è¡Œã€‘ï¼Œ&ldquo;<strong>æŠ¢</strong>&rdquo;èµ°äº†æ­£åœ¨é”å®šç­‰å¾…çš„è¯·æ±‚æœºä¼šã€‚</li>
<li>ç¬¬ 23 è‡³ 27 è¡Œï¼šç­‰å¾…ï¼Œç›´åˆ°è¶…æ—¶ï¼Œæˆ–è€…è¢«å”¤é†’ã€ç¬¬ 61 è¡Œã€‘ã€‚</li>
<li>ç¬¬ 28 è‡³ 37 è¡Œï¼šåˆ¤æ–­è‹¥æ²¡æœ‰å‰©ä½™æ—¶é•¿äº†ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚</li>
<li>ç¬¬ 45 è¡Œï¼šè°ƒç”¨&nbsp;<code>RpcStaus#beginCount(url, methodName)</code>&nbsp;æ–¹æ³•ï¼Œè°ƒç”¨å¼€å§‹çš„è®¡æ•°ã€‚</li>
<li>ç¬¬ 48 è¡Œï¼šè°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚</li>
<li>ç¬¬ 50 è¡Œï¼šè°ƒç”¨&nbsp;<code>RpcStaus#endCount(url, methodName, true)</code>&nbsp;æ–¹æ³•ï¼Œè°ƒç”¨å¼€å§‹çš„è®¡æ•°ï¼ˆæˆåŠŸï¼‰ã€‚</li>
<li>ç¬¬ 54 è¡Œï¼šè°ƒç”¨&nbsp;<code>RpcStaus#endCount(url, methodName, false)</code>&nbsp;æ–¹æ³•ï¼Œè°ƒç”¨å¼€å§‹çš„è®¡æ•°ï¼ˆå¤±è´¥ï¼‰ã€‚</li>
<li>ç¬¬ 59 è‡³ 63 è¡Œï¼šå”¤é†’ç­‰å¾…çš„ç›¸åŒæœåŠ¡çš„ç›¸åŒæ–¹æ³•çš„è¯·æ±‚ã€ç¬¬ 25 è¡Œã€‘ã€‚</li>
</ul>
<h1 id="4-ExecuteLimitFilter">4. ExecuteLimitFilter</h1>
<p><code>com.alibaba.dubbo.rpc.filter.ExecuteLimitFilter</code>&nbsp;ï¼Œå®ç° Filter æ¥å£ï¼ŒæœåŠ¡æä¾›è€…<strong>æ¯æœåŠ¡</strong>ã€<strong>æ¯æ–¹æ³•</strong>çš„<strong>æœ€å¤§å¯å¹¶è¡Œ</strong>æ‰§è¡Œè¯·æ±‚æ•°çš„è¿‡æ»¤å™¨å®ç°ç±»ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Activate</span>(group = Constants.PROVIDER, value = Constants.EXECUTES_KEY)</span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecuteLimitFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>{</span><br /><span class="line"> <span class="number">3</span>: </span><br /><span class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">6</span>:         URL url = invoker.getUrl();</span><br /><span class="line"> <span class="number">7</span>:         String methodName = invocation.getMethodName();</span><br /><span class="line"> <span class="number">8</span>:         Semaphore executesLimit = <span class="keyword">null</span>; <span class="comment">// ä¿¡å·é‡</span></span><br /><span class="line"> <span class="number">9</span>:         <span class="keyword">boolean</span> acquireResult = <span class="keyword">false</span>; <span class="comment">// æ˜¯å¦è·å¾—ä¿¡å·é‡</span></span><br /><span class="line"><span class="number">10</span>:         <span class="comment">// è·å¾—æœåŠ¡æä¾›è€…æ¯æœåŠ¡æ¯æ–¹æ³•æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°</span></span><br /><span class="line"><span class="number">11</span>:         <span class="keyword">int</span> max = url.getMethodParameter(methodName, Constants.EXECUTES_KEY, <span class="number">0</span>);</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">if</span> (max &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">13</span>:             <span class="comment">// è·å¾— RpcStatus å¯¹è±¡ï¼ŒåŸºäºæœåŠ¡ URL + æ–¹æ³•ç»´åº¦</span></span><br /><span class="line"><span class="number">14</span>:             RpcStatus count = RpcStatus.getStatus(url, invocation.getMethodName());</span><br /><span class="line"><span class="number">15</span>:             <span class="comment">// è·å¾—ä¿¡å·é‡ã€‚è‹¥è·å¾—ä¸åˆ°ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br /><span class="line"><span class="number">16</span>: <span class="comment">//            if (count.getActive() &gt;= max) {</span></span><br /><span class="line"><span class="number">17</span>:             <span class="comment">/**</span></span><br /><span class="line"><span class="comment">18:              * http://manzhizhen.iteye.com/blog/2386408</span></span><br /><span class="line"><span class="comment">19:              * use semaphore for concurrency control (to limit thread number)</span></span><br /><span class="line"><span class="comment">20:              */</span></span><br /><span class="line"><span class="number">21</span>:             executesLimit = count.getSemaphore(max);</span><br /><span class="line"><span class="number">22</span>:             <span class="keyword">if</span> (executesLimit != <span class="keyword">null</span> &amp;&amp; !(acquireResult = executesLimit.tryAcquire())) {</span><br /><span class="line"><span class="number">23</span>:                 <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Failed to invoke method "</span> + invocation.getMethodName() + <span class="string">" in provider "</span> + url + <span class="string">", cause: The service using threads greater than &lt;dubbo:service executes=\""</span> + max + <span class="string">"\" /&gt; limited."</span>);</span><br /><span class="line"><span class="number">24</span>:             }</span><br /><span class="line"><span class="number">25</span>:         }</span><br /><span class="line"><span class="number">26</span>:         <span class="keyword">long</span> begin = System.currentTimeMillis();</span><br /><span class="line"><span class="number">27</span>:         <span class="keyword">boolean</span> isSuccess = <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">28</span>:         <span class="comment">// è°ƒç”¨å¼€å§‹çš„è®¡æ•°</span></span><br /><span class="line"><span class="number">29</span>:         RpcStatus.beginCount(url, methodName);</span><br /><span class="line"><span class="number">30</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">31</span>:             <span class="comment">// æœåŠ¡è°ƒç”¨</span></span><br /><span class="line"><span class="number">32</span>:             <span class="keyword">return</span> invoker.invoke(invocation);</span><br /><span class="line"><span class="number">33</span>:         } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">34</span>:             isSuccess = <span class="keyword">false</span>; <span class="comment">// æ ‡è®°å¤±è´¥</span></span><br /><span class="line"><span class="number">35</span>:             <span class="keyword">if</span> (t <span class="keyword">instanceof</span> RuntimeException) {</span><br /><span class="line"><span class="number">36</span>:                 <span class="keyword">throw</span> (RuntimeException) t;</span><br /><span class="line"><span class="number">37</span>:             } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">38</span>:                 <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"unexpected exception when ExecuteLimitFilter"</span>, t);</span><br /><span class="line"><span class="number">39</span>:             }</span><br /><span class="line"><span class="number">40</span>:         } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">41</span>:             <span class="comment">// è°ƒç”¨ç»“æŸçš„è®¡æ•°ï¼ˆæˆåŠŸï¼‰ï¼ˆå¤±è´¥ï¼‰</span></span><br /><span class="line"><span class="number">42</span>:             RpcStatus.endCount(url, methodName, System.currentTimeMillis() - begin, isSuccess);</span><br /><span class="line"><span class="number">43</span>:             <span class="comment">// é‡Šæ”¾ä¿¡å·é‡</span></span><br /><span class="line"><span class="number">44</span>:             <span class="keyword">if</span> (acquireResult) {</span><br /><span class="line"><span class="number">45</span>:                 executesLimit.release();</span><br /><span class="line"><span class="number">46</span>:             }</span><br /><span class="line"><span class="number">47</span>:         }</span><br /><span class="line"><span class="number">48</span>:     }</span><br /><span class="line"><span class="number">49</span>: </span><br /><span class="line"><span class="number">50</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ActiveLimitFilter åŸºäº&nbsp;<code>RpcStatus.semaphore</code>&nbsp;<strong>ä¿¡å·é‡</strong>å±æ€§ï¼Œåˆ¤æ–­è‹¥è¶…è¿‡æœ€å¤§å¯å¹¶è¡Œï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚</li>
<li>ç¬¬ 11 è¡Œï¼šè°ƒç”¨&nbsp;<code>URL#getMethodParameter(methodName, key, defaultValue)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æœåŠ¡æä¾›è€…æ¯æœåŠ¡æ¯æ–¹æ³•æœ€å¤§å¯å¹¶è¡Œæ‰§è¡Œè¯·æ±‚æ•°ã€‚ä¼˜å…ˆ&nbsp;<code>&lt;dubbo: method /&gt;</code>&nbsp;ï¼Œå…¶æ¬¡&nbsp;<code>&lt;dubbo:service /&gt;</code>&nbsp;ã€‚</li>
<li>ç¬¬ 13 è¡Œï¼šè°ƒç”¨&nbsp;<code>RpcStatus#getStatus(url, methodName)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— RpcStatus å¯¹è±¡ï¼ŒåŸºäº<strong>æœåŠ¡ URL + æ–¹æ³•</strong>ä¸ºç»´åº¦ã€‚</li>
<li>ç¬¬ 21 è‡³ 21 è¡Œï¼šè°ƒç”¨&nbsp;<code>RpcStatus#getSemaphore(max)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— Semaphore å¯¹è±¡ã€‚</li>
<li>ç¬¬ 22 è‡³ 24 è¡Œï¼šè°ƒç”¨&nbsp;<code>Semaphore#tryAcquire()</code>&nbsp;æ–¹æ³•ï¼Œè‹¥è·å¾—ä¸åˆ°ä¿¡å·é‡ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚</li>
<li>ç¬¬ 29 è¡Œï¼šè°ƒç”¨&nbsp;<code>RpcStaus#beginCount(url, methodName)</code>&nbsp;æ–¹æ³•ï¼Œè°ƒç”¨å¼€å§‹çš„è®¡æ•°ã€‚</li>
<li>ç¬¬ 32 è¡Œï¼šè°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚</li>
<li>ç¬¬ 34 è¡Œï¼šè‹¥å‘ç”Ÿå¼‚å¸¸ï¼Œæ ‡è®°&nbsp;<code>isSuccess = false</code>&nbsp;ï¼Œè¡¨ç¤ºè°ƒç”¨å¤±è´¥ã€‚</li>
<li>ç¬¬ 42 è¡Œï¼šè°ƒç”¨&nbsp;<code>RpcStaus#endCount(url, methodName, success)</code>&nbsp;æ–¹æ³•ï¼Œè°ƒç”¨å¼€å§‹çš„è®¡æ•°ï¼ˆæˆåŠŸï¼‰ï¼ˆå¤±è´¥ï¼‰ã€‚</li>
<li>ç¬¬ 43 è‡³ 46 è¡Œï¼šè°ƒç”¨&nbsp;<code>Semaphore#release()</code>&nbsp;æ–¹æ³•ï¼Œé‡Šæ”¾ä¿¡å·é‡ã€‚</li>
</ul>
</div>