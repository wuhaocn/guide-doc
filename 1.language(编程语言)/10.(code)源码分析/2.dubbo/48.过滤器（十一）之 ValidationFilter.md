# è¿‡æ»¤å™¨ï¼ˆåä¸€ï¼‰ä¹‹ ValidationFilter

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«

dubbo-filter-validation
é¡¹ç›®çš„ ValidationFilter è¿‡æ»¤å™¨ï¼Œç”¨äºæœåŠ¡**æ¶ˆè´¹è€…**å’Œ**æä¾›è€…**ä¸­ï¼Œæä¾› **å‚æ•°éªŒè¯** çš„åŠŸèƒ½ã€‚åœ¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” å‚æ•°éªŒè¯ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/parameter-validation.html) å®šä¹‰å¦‚ä¸‹ï¼š
å‚æ•°éªŒè¯åŠŸèƒ½ï¼Œæ˜¯åŸºäº [JSR303](https://jcp.org/en/jsr/detail?id=303) Bean Validation å®ç°çš„ï¼Œç”¨æˆ·åªéœ€æ ‡è¯† JSR303 æ ‡å‡†çš„éªŒè¯ annotationï¼Œå¹¶é€šè¿‡å£°æ˜ filter æ¥å®ç°éªŒè¯ã€‚

* **é…ç½®**å’Œ**ç¤ºä¾‹**ï¼Œå®˜æ–¹æ–‡æ¡£å·²ç»å†™çš„å¾ˆé½å…¨ï¼Œç¬”è€…å°±ä¸å¤šå“”å“”äº†ã€‚
* å¦‚ä¸‹æ˜¯æ–°ç‰ˆæœ¬çš„ Maven ä¾èµ–çš„ä¾‹å­ï¼š
```
<!-- JSR 303 - Bean Validation begin -->
<dependency>
<groupId>javax.validation</groupId>
<artifactId>validation-api</artifactId>
<version>1.1.0.Final</version>
</dependency>
<dependency>
<groupId>org.hibernate</groupId>
<artifactId>hibernate-validator</artifactId>
<version>5.3.4.Final</version>
</dependency>
<dependency>
<groupId>javax.el</groupId>
<artifactId>javax.el-api</artifactId>
<version>2.2.4</version>
</dependency>
<dependency>
<groupId>org.glassfish.web</groupId>
<artifactId>javax.el</artifactId>
<version>2.2.4</version>
</dependency>
<!-- JSR 303 - Bean Validation end -->
```

æœ¬æ–‡æ¶‰åŠçš„ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_11_22/02.png)

# 2. ValidationFilter

com.alibaba.dubbo.validation.filter.ValidationFilter
ï¼Œå®ç° Filter æ¥å£ï¼Œå‚æ•°éªŒè¯è¿‡æ»¤å™¨å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: @Activate(group = {Constants.CONSUMER, Constants.PROVIDER}, value = Constants.VALIDATION_KEY, order = 10000)
2: public class ValidationFilter implements Filter{
3:
4: //*/*
5: /* Validation$Adaptive å¯¹è±¡
6: /*
7: /* é€šè¿‡ Dubbo SPI æœºåˆ¶ï¼Œè°ƒç”¨ {@link /#setValidation(Validation)} æ–¹æ³•ï¼Œè¿›è¡Œæ³¨å…¥
8: /*/
9: private Validation validation;
10:
11: public void setValidation(Validation validation){
12: this.validation = validation;
13: }
14:
15: @Override
16: public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException{
17: if (validation != null && !invocation.getMethodName().startsWith("$") // éæ³›åŒ–è°ƒç”¨å’Œå›éŸ³è°ƒç”¨ç­‰æ–¹æ³•
18: && ConfigUtils.isNotEmpty(invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.VALIDATION_KEY))) { // æ–¹æ³•å¼€å¯ Validation åŠŸèƒ½
19: try {
20: // è·å¾— Validator å¯¹è±¡
21: Validator validator = validation.getValidator(invoker.getUrl());
22: // ä½¿ç”¨ Validator ï¼ŒéªŒè¯æ–¹æ³•å‚æ•°ã€‚è‹¥ä¸åˆæ³•ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚
23: if (validator != null) {
24: validator.validate(invocation.getMethodName(), invocation.getParameterTypes(), invocation.getArguments());
25: }
26: } catch (RpcException e) {
27: throw e;
28: } catch (Throwable t) {
29: return new RpcResult(t);
30: }
31: }
32: // æœåŠ¡è°ƒç”¨
33: return invoker.invoke(invocation);
34: }
35:
36: }
```

* ç¬¬ 17 è¡Œï¼šéæ³›åŒ–è°ƒç”¨å’Œå›éŸ³è°ƒç”¨ç­‰æ–¹æ³•ã€‚
* ç¬¬ 18 è¡Œï¼šåˆ¤æ–­æ–¹æ³•**å¼€å¯** Validation åŠŸèƒ½ã€‚å› ä¸ºï¼Œä¸€ä¸ªæœåŠ¡é‡Œï¼Œå¯èƒ½åªæœ‰**éƒ¨åˆ†**æ–¹æ³•å¼€å¯äº† Validation åŠŸèƒ½ã€‚
* ç¬¬ 21 è¡Œï¼šè°ƒç”¨

Validation$Adaptive/#getValidator(url)
æ–¹æ³•ï¼ŒåŸºäº **URL** ä¸ºç»´åº¦ï¼Œè·å¾— Validator å¯¹è±¡ã€‚
* ç¬¬ 22 è‡³ 25 è¡Œï¼šè°ƒç”¨

Validator/#validate(String methodName, Class<?>[] parameterTypes, Object[] arguments)
æ–¹æ³•ï¼Œæ–¹æ³•å‚æ•°éªŒè¯ã€‚è‹¥ä¸åˆæ³•ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚
* ç¬¬ 33 è¡Œï¼šè°ƒç”¨

Invoker/#invoke(invocation)
æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚

# 3. API å®šä¹‰

## 3.1 Validator

com.alibaba.dubbo.validation.Validator
ï¼ŒéªŒè¯å™¨æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public interface Validator{
//*/*
/* æ–¹æ³•å‚æ•°éªŒè¯
/*
/* @param methodName æ–¹æ³•å
/* @param parameterTypes å‚æ•°ç±»å‹æ•°ç»„
/* @param arguments å‚æ•°å€¼æ•°ç»„
/* @throws Exception å½“å‘ç”Ÿå¼‚å¸¸æ—¶
/*/
void validate(String methodName, Class<?>[] parameterTypes, Object[] arguments) throws Exception;
}
```

## 3.2 Validation

com.alibaba.dubbo.validation.Validation
ï¼ŒValidator å·¥å‚**æ¥å£**ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
@SPI("jvalidation")
public interface Validation{
//*/*
/* è·å¾— Validator å¯¹è±¡
/*
/* @param url URL
/* @return Validator
/*/
@Adaptive(Constants.VALIDATION_KEY)
Validator getValidator(URL url);
}
```

* @SPI("jvalidation")
æ³¨è§£ï¼ŒDubbo SPI **æ‹“å±•ç‚¹**ï¼Œé»˜è®¤ä¸º

"jvalidation"
ã€‚
* @Adaptive("validation")
æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Validator å®ç°ï¼Œä½¿ç”¨

URL.validation
å±æ€§ã€‚

### 3.2.1 AbstractValidation

com.alibaba.dubbo.validation.support.AbstractValidation
ï¼Œå®ç° Validation æ¥å£ï¼ŒValidator å·¥å‚**æŠ½è±¡ç±»**ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public abstract class AbstractValidation implements Validation{
//*/*
/* Validator é›†åˆ
/*
/* keyï¼šURL
/*/
private final ConcurrentMap<String, Validator> validators = new ConcurrentHashMap<String, Validator>();
@Override
public Validator getValidator(URL url){
// è·å¾— Validator å¯¹è±¡
String key = url.toFullString();
Validator validator = validators.get(key);
// ä¸å­˜åœ¨ï¼Œåˆ›å»º Validator å¯¹è±¡ï¼Œå¹¶ç¼“å­˜
if (validator == null) {
validators.put(key, createValidator(url));
validator = validators.get(key);
}
return validator;
}
//*/*
/* åˆ›å»º Validator å¯¹è±¡
/*
/* @param url URL
/* @return Validator å¯¹è±¡
/*/
protected abstract Validator createValidator(URL url);
}
```

# 3.3 @MethodValidated

com.alibaba.dubbo.validation.@MethodValidated
ï¼Œæ–¹æ³•åˆ†ç»„éªŒè¯**æ³¨è§£**ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
@Target({ElementType.METHOD})
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface MethodValidated {
//*/*
/* @return åˆ†ç»„é›†åˆ
/*/
Class<?>[] value() default {};
}
```

* ä½¿ç”¨åœºæ™¯ï¼šå½“è°ƒç”¨æŸä¸ªæ–¹æ³•æ—¶ï¼Œéœ€è¦æ£€æŸ¥å¤šä¸ªåˆ†ç»„ï¼Œå¯ä»¥åœ¨æ¥å£æ–¹æ³•ä¸ŠåŠ ä¸Šè¯¥æ³¨è§£ã€‚
* ç”¨æ³•ï¼š
```
@MethodValidated({Save.class, Update.class})
void relatedQuery(ValidationParameter parameter);
```

* åœ¨æ¥å£æ–¹æ³•ä¸Šå¢åŠ æ³¨è§£ï¼Œè¡¨ç¤º

/#relatedQuery(ValidationParameter)
è¿™ä¸ªæ–¹æ³•ï¼Œéœ€è¦åŒæ—¶æ£€æŸ¥ Save å’Œ Update è¿™ä¸¤ä¸ªåˆ†ç»„ã€‚
* å¦‚æœèƒ–å‹å¯¹ Java Bean Validation åˆ†ç»„ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥ç†è§£èµ·æ¥æ¯”è¾ƒç»•ã€‚å¯ä»¥è·‘ä¸‹å®˜æ–¹æä¾›çš„ [
com.alibaba.dubbo.config.validation
](https://github.com/YunaiV/dubbo/tree/f4216485f5641ea5cf406d1e58503c5651f86432/dubbo-config/dubbo-config-api/src/test/java/com/alibaba/dubbo/config/validation) çš„ç«‹è¶³ã€‚![relatedQuery](http://static2.iocoder.cn/images/Dubbo/2018_11_22/01.png)

# 4. JSR303 å®ç°

åŸºäº [JSR303](https://jcp.org/en/jsr/detail?id=303) Bean Validation å®ç°çš„ï¼Œç”¨æˆ·åªéœ€æ ‡è¯† JSR303 æ ‡å‡†çš„éªŒè¯ annotation ã€‚

## 4.1 JValidator

com.alibaba.dubbo.validation.support.jvalidation.JValidator
ï¼Œå®ç° Validator æ¥å£ï¼ŒåŸºäº [JSR303](https://jcp.org/en/jsr/detail?id=303) çš„éªŒè¯å™¨å®ç°ç±»ã€‚

### 4.1.1 æ„é€ æ–¹æ³•

```
//*/*
/* æœåŠ¡æ¥å£ç±»
/*/
private final Class<?> clazz;
//*/*
/* Validator å¯¹è±¡
/*/
private final javax.validation.Validator validator;
@SuppressWarnings({"unchecked", "rawtypes"})
public JValidator(URL url){
// è·å¾—æœåŠ¡æ¥å£ç±»
this.clazz = ReflectUtils.forName(url.getServiceInterface());
// è·å¾— `"jvalidation"` é…ç½®é¡¹
String jvalidation = url.getParameter("jvalidation");
// è·å¾— ValidatorFactory å¯¹è±¡
ValidatorFactory factory;
if (jvalidation != null && jvalidation.length() > 0) { // æŒ‡å®šå®ç°
factory = Validation.byProvider((Class) ReflectUtils.forName(jvalidation)).configure().buildValidatorFactory();
} else { // é»˜è®¤
factory = Validation.buildDefaultValidatorFactory();
}
// è·å¾— javax Validator å¯¹è±¡
this.validator = factory.getValidator();
}
```

* "jvalidation"
é…ç½®é¡¹ï¼Œå¯**æŒ‡å®š**å…·ä½“çš„ JSR303 çš„å®ç°ç±»ã€‚
* å¦‚æœæˆ‘ä»¬**æœªé…ç½®**ï¼Œå¹¶ä¸”å¼•å…¥ Hibernate Validator ï¼Œåˆ™ä½¿ç”¨çš„æ˜¯ HibernateValidatorFactory ã€‚

### 4.1.2 validate

```
1: @Override
2: public void validate(String methodName, Class<?>[] parameterTypes, Object[] arguments) throws Exception{
3: // éªŒè¯åˆ†ç»„é›†åˆ
4: List<Class<?>> groups = new ArrayList<Class<?>>();
5: // ã€ç¬¬ä¸€ç§ã€‘æ·»åŠ ä»¥æ–¹æ³•å‘½åçš„å†…éƒ¨æ¥å£ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚ä¾‹å¦‚ `ValidationService/#save(...)` æ–¹æ³•ï¼Œå¯¹åº” `ValidationService.Save` æ¥å£ã€‚
6: String methodClassName = clazz.getName() + "$" + toUpperMethodName(methodName);
7: Class<?> methodClass;
8: try {
9: methodClass = Class.forName(methodClassName, false, Thread.currentThread().getContextClassLoader());
10: groups.add(methodClass);
11: } catch (ClassNotFoundException e) {
12: }
13: // ã€ç¬¬äºŒç§ã€‘æ·»åŠ æ–¹æ³•çš„ @MethodValidated æ³¨è§£çš„å€¼å¯¹åº”çš„ç±»ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚
14: Method method = clazz.getMethod(methodName, parameterTypes);
15: Class<?>[] methodClasses;
16: if (method.isAnnotationPresent(MethodValidated.class)){
17: methodClasses = method.getAnnotation(MethodValidated.class).value();
18: groups.addAll(Arrays.asList(methodClasses));
19: }
20: // ã€ç¬¬ä¸‰ç§ã€‘æ·»åŠ  Default.class ç±»ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚åœ¨ JSR 303 ä¸­ï¼Œæœªè®¾ç½®åˆ†ç»„çš„éªŒè¯æ³¨è§£ï¼Œä½¿ç”¨ Default.class ã€‚
21: // add into default group
22: groups.add(0, Default.class);
23: // ã€ç¬¬å››ç§ã€‘æ·»åŠ æœåŠ¡æ¥å£ç±»ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚
24: groups.add(1, clazz);
25: // convert list to array
26: Class<?>[] classGroups = groups.toArray(new Class[0]);
27:
28: // éªŒè¯é”™è¯¯é›†åˆ
29: Set<ConstraintViolation<?>> violations = new HashSet<ConstraintViolation<?>>();
30: // ã€ç¬¬ä¸€æ­¥ã€‘è·å¾—æ–¹æ³•å‚æ•°çš„ Bean å¯¹è±¡ã€‚å› ä¸ºï¼ŒJSR 303 æ˜¯ Java Bean Validation ï¼Œä»¥ Bean ä¸ºç»´åº¦ã€‚
31: Object parameterBean = getMethodParameterBean(clazz, method, arguments);
32: // ã€ç¬¬ä¸€æ­¥ã€‘éªŒè¯ Bean å¯¹è±¡ã€‚
33: if (parameterBean != null) {
34: violations.addAll(validator.validate(parameterBean, classGroups));
35: }
36: // ã€ç¬¬äºŒæ­¥ã€‘éªŒè¯é›†åˆå‚æ•°
37: for (Object arg : arguments) {
38: validate(violations, arg, classGroups);
39: }
40: // è‹¥æœ‰é”™è¯¯ï¼ŒæŠ›å‡º ConstraintViolationException å¼‚å¸¸ã€‚
41: if (!violations.isEmpty()) {
42: logger.error("Failed to validate service: " + clazz.getName() + ", method: " + methodName + ", cause: " + violations);
43: throw new ConstraintViolationException("Failed to validate service: " + clazz.getName() + ", method: " + methodName + ", cause: " + violations, violations);
44: }
45: }
```

* ============ ã€ç¬¬ä¸€æ­¥ã€‘è·å¾—éªŒè¯åˆ†ç»„é›†åˆ ============
* ç¬¬ 4 è¡Œï¼šéªŒè¯åˆ†ç»„é›†åˆ

group
ï¼Œç›®å‰æœ‰å››ç§æ¥æºã€‚
* ã€ç¬¬ä¸€ç§ã€‘ç¬¬ 5 è‡³ 12 è¡Œï¼šæ·»åŠ ä»¥æ–¹æ³•å‘½åçš„å†…éƒ¨æ¥å£ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚ä¾‹å¦‚

ValidationService/#save(...)
æ–¹æ³•ï¼Œå¯¹åº”

ValidationService.Save
æ¥å£ã€‚
* ã€ç¬¬äºŒç§ã€‘ç¬¬ 13 è‡³ 19 è¡Œï¼šæ·»åŠ æ–¹æ³•çš„

@MethodValidated
æ³¨è§£çš„å€¼å¯¹åº”çš„ç±»ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚
* ã€ç¬¬ä¸‰ç§ã€‘ç¬¬ 22 è¡Œï¼šæ·»åŠ  Default.class ç±»ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚åœ¨ JSR 303 ä¸­ï¼Œæœªè®¾ç½®åˆ†ç»„çš„éªŒè¯æ³¨è§£ï¼Œä½¿ç”¨ Default.class ã€‚
* ã€ç¬¬å››ç§ã€‘ç¬¬ 24 è¡Œï¼šæ·»åŠ æœåŠ¡æ¥å£ç±»

clazz
ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚
* æœ€ç»ˆç”Ÿæˆçš„éªŒè¯åˆ†ç»„é›†åˆçš„é¡ºåºä¸ºï¼šã€ç¬¬ä¸‰ç§ã€‘ã€‹ã€ç¬¬å››ç§ã€‘ã€‹ã€ç¬¬ä¸€ç§ã€‘ã€‹ã€ç¬¬äºŒç§ã€‘ã€‚
* ============ ã€ç¬¬äºŒæ­¥ã€‘éªŒè¯æ–¹æ³•å‚æ•° ============
* ç¬¬ 29 è¡Œï¼šéªŒè¯é”™è¯¯é›†åˆ

violations
ã€‚
* ã€ç¬¬ä¸€æ­¥ã€‘è°ƒç”¨

/#getMethodParameterBean(Class<?> clazz, Method method, Object[] args)
æ–¹æ³•ï¼Œè·å¾—æ–¹æ³•å‚æ•°çš„ Bean å¯¹è±¡ã€‚å› ä¸ºï¼ŒJSR 303 æ˜¯ Java Bean Validation ï¼Œä»¥ Bean ä¸ºç»´åº¦ã€‚å…·ä½“çš„å®ç°ï¼Œæˆ‘ä»¬åœ¨ [ã€Œ4.1.3 getMethodParameterBeanã€](http://svip.iocoder.cn/Dubbo/filter-validation-filter/) ä¸­ï¼Œè¯¦ç»†è§£æã€‚
* ã€ç¬¬ä¸€æ­¥ã€‘è°ƒç”¨

Validator/#validate(T object, Class<?>... groups)
æ–¹æ³•ï¼ŒéªŒè¯ **Bean** å¯¹è±¡ã€‚
* ã€ç¬¬äºŒæ­¥ã€‘å¾ªç¯æ–¹æ³•å‚æ•°ï¼Œè°ƒç”¨

/#validate(violations, arg, classGroups)
æ–¹æ³•ï¼ŒéªŒè¯**é›†åˆ**å‚æ•°ã€‚**ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸€æ­¥**ï¼Ÿå› ä¸ºï¼Œåœ¨ã€ç¬¬ä¸€æ­¥ã€‘ä¸­ï¼Œæ ¡éªŒçš„æ˜¯ Constraint æ³¨è§£çš„å‚æ•°( ä¾‹å¦‚

@NotNull
) ï¼Œä½†æ˜¯å‘¢ï¼Œè‹¥æ˜¯é›†åˆå‚æ•°ï¼Œ**ä¸ä¼šæ ¡éªŒé›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ **ã€‚æˆ‘ä»¬æ¥ä¸¾ä¸ªä¾‹å­ï¼š
```
void saves(@NotNull(message = "è‡³å°‘éœ€è¦ä¿å­˜ä¸€ä¸ªç”¨æˆ·") User[] users);
```

* ã€ç¬¬ä¸€æ­¥ã€‘æ ¡éªŒ

users
å‚æ•°çš„

@NotNull
çº¦æŸã€‚
* ã€ç¬¬äºŒæ­¥ã€‘æ ¡éªŒ

users
å‚æ•°ä¸­çš„**æ¯ä¸ª User** çš„çº¦æŸã€‚
* ç¬¬ 40 è‡³ 44 è¡Œï¼šè‹¥æœ‰éªŒè¯é”™è¯¯ï¼ŒæŠ›å‡º ConstraintViolationException å¼‚å¸¸ã€‚

/#validate(Set<ConstraintViolation<?>> violations, Object arg, Class<?>... groups)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
1: //*/*
2: /* éªŒè¯é›†åˆå‚æ•°
3: /*
4: /* @param violations éªŒè¯é”™è¯¯é›†åˆ
5: /* @param arg å‚æ•°
6: /* @param groups éªŒè¯åˆ†ç»„é›†åˆ
7: /*/
8: private void validate(Set<ConstraintViolation<?>> violations, Object arg, Class<?>... groups){
9: if (arg != null && !isPrimitives(arg.getClass())) {
10: // [] æ•°ç»„
11: if (Object[].class.isInstance(arg)) {
12: for (Object item : (Object[]) arg) {
13: validate(violations, item, groups); // å•ä¸ªå…ƒç´ 
14: }
15: // Collection
16: } else if (Collection.class.isInstance(arg)) {
17: for (Object item : (Collection<?>) arg) {
18: validate(violations, item, groups); // å•ä¸ªå…ƒç´ 
19: }
20: // Map
21: } else if (Map.class.isInstance(arg)) {
22: for (Map.Entry<?, ?> entry : ((Map<?, ?>) arg).entrySet()) {
23: validate(violations, entry.getKey(), groups); // å•ä¸ªå…ƒç´ 
24: validate(violations, entry.getValue(), groups); // å•ä¸ªå…ƒç´ 
25: }
26: // å•ä¸ªå…ƒç´ 
27: } else {
28: violations.addAll(validator.validate(arg, groups));
29: }
30: }
31: }
```

* ç¬¬ 9 è¡Œï¼šè°ƒç”¨

/#isPrimitives(Class<?> cls)
æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦ä¸º**åŸºæœ¬ç±»å‹**ã€‚è‹¥æ˜¯åŸºæœ¬ç±»å‹ï¼Œå·²ç»è¢«ã€**ç¬¬ä¸€æ­¥**ã€‘ç»™éªŒè¯äº†ï¼Œé¿å…é‡å¤éªŒè¯ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
private static boolean isPrimitives(Class<?> cls){
// [] æ•°ç»„ï¼Œä½¿ç”¨å†…éƒ¨çš„ç±»æ¥åˆ¤æ–­
if (cls.isArray()) {
return isPrimitive(cls.getComponentType());
}
// ç›´æ¥åˆ¤æ–­
return isPrimitive(cls);
}
private static boolean isPrimitive(Class<?> cls){
return cls.isPrimitive() || cls == String.class || cls == Boolean.class || cls == Character.class
|| Number.class.isAssignableFrom(cls) || Date.class.isAssignableFrom(cls);
}
```
* ç¬¬ 10 è‡³ 14 è¡Œï¼šéªŒè¯

[ ]
æ•°ç»„å‚æ•°ï¼Œå¾ªç¯è°ƒç”¨ã€ç¬¬ 26 è‡³ 29ã€‘çš„éªŒè¯ã€‚
* ç¬¬ 15 è‡³ 19 è¡Œï¼šéªŒè¯ Collection å‚æ•°ï¼Œå¾ªç¯è°ƒç”¨ã€ç¬¬ 26 è‡³ 29ã€‘çš„éªŒè¯ã€‚
* ç¬¬ 20 è‡³ 25 è¡Œï¼šéªŒè¯ Map å‚æ•°ï¼Œå¾ªç¯è°ƒç”¨ã€ç¬¬ 26 è‡³ 29ã€‘çš„éªŒè¯ã€‚
* **ç¬¬ 26 è‡³ 29 è¡Œ**ï¼šéªŒè¯**å•ä¸ª**å‚æ•°ã€‚

### 4.1.3 getMethodParameterBean

åœ¨çœ‹

/#getMethodParameterBean(Class<?> clazz, Method method, Object[] args)
çš„å…·ä½“å®ç°ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒï¼Œæ ¹æ®æ–¹æ³•ï¼Œ**è‡ªåŠ¨ç”Ÿæˆ** Bean ç±»çš„ä¾‹å­ã€‚

* æ¥å£æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
void demo(@NotNull(message = "åå­—ä¸èƒ½ä¸ºç©º") @Min(value = 6, message = "æ˜µç§°ä¸èƒ½å¤ªçŸ­") String name,
String password, // ä¸æ ¡éªŒ
@NotNull(message = "è‡³å°‘éœ€è¦ä¿å­˜ä¸€ä¸ªç”¨æˆ·") User user);
```
* ç”Ÿæˆ Bean ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
package com.alibaba.dubbo.demo.DemoService_DemoParameter_java.lang.String_java.lang.String_com.alibaba.dubbo.demo.entity;
public class User{
@NotNull(message = "åå­—ä¸èƒ½ä¸ºç©º")
@Min(value = 6, message = "æ˜µç§°ä¸èƒ½å¤ªçŸ­")
public java.lang.String name;
public java.lang.String password;
@NotNull(message = "è‡³å°‘éœ€è¦ä¿å­˜ä¸€ä¸ªç”¨æˆ·")
public com.alibaba.dubbo.demo.entity.User user;
public User(){}
}
```

* ğŸ˜ˆ Javassist ç”Ÿæˆçš„ç±»ï¼Œä½¿ç”¨ JD-GUI åç¼–è¯‘ä¸€ç›´æŠ¥é”™ã€‚æ‰€ä»¥ï¼Œè¯¥ç±»æ˜¯ç¬”è€…ï¼Œ**æ‰‹å·¥**ç”Ÿæˆçš„ã€‚å“ˆå“ˆå“ˆï¼Œæ„æ€èƒ½è¾¾åˆ°å°±å¥½ã€‚

/#getMethodParameterBean(Class<?> clazz, Method method, Object[] args)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
1: //*/*
2: /* ä½¿ç”¨æ–¹æ³•å‚æ•°ï¼Œåˆ›å»º Bean å¯¹è±¡ã€‚
3: /*
4: /* å› ä¸ºè¯¥ Bean å¯¹è±¡ï¼Œå®é™…ä¸å­˜åœ¨å¯¹åº”ç±»ï¼Œä½¿ç”¨ Javassist åŠ¨æ€ç¼–è¯‘ç”Ÿæˆã€‚
5: /*
6: /* @param clazz æœåŠ¡æ¥å£ç±»
7: /* @param method æ–¹æ³•
8: /* @param args å‚æ•°æ•°ç»„
9: /* @return Bean å¯¹è±¡
10: /*/
11: private static Object getMethodParameterBean(Class<?> clazz, Method method, Object[] args){
12: // æ—  Constraint æ³¨è§£çš„æ–¹æ³•å‚æ•°ï¼Œæ— éœ€åˆ›å»º Bean å¯¹è±¡ã€‚
13: if (!hasConstraintParameter(method)) {
14: return null;
15: }
16: try {
17: // è·å¾— Bean ç±»å
18: String parameterClassName = generateMethodParameterClassName(clazz, method);
19: Class<?> parameterClass;
20: try {
21: // è·å¾— Bean ç±»
22: parameterClass = Class.forName(parameterClassName, true, clazz.getClassLoader());
23: } catch (ClassNotFoundException e) { // ç±»ä¸å­˜åœ¨ï¼Œä½¿ç”¨ Javassist åŠ¨æ€ç¼–è¯‘ç”Ÿæˆ
24: // åˆ›å»º ClassPool å¯¹è±¡
25: ClassPool pool = ClassGenerator.getClassPool(clazz.getClassLoader());
26: // åˆ›å»º CtClass å¯¹è±¡
27: CtClass ctClass = pool.makeClass(parameterClassName);
28: // è®¾ç½® Java ç‰ˆæœ¬ä¸º 5
29: ClassFile classFile = ctClass.getClassFile();
30: classFile.setVersionToJava5();
31: // æ·»åŠ é»˜è®¤æ„é€ æ–¹æ³•
32: ctClass.addConstructor(CtNewConstructor.defaultConstructor(pool.getCtClass(parameterClassName)));
33: // å¾ªç¯æ¯ä¸ªæ–¹æ³•å‚æ•°ï¼Œç”Ÿæˆå¯¹åº”çš„ç±»çš„å±æ€§
34: // parameter fields
35: Class<?>[] parameterTypes = method.getParameterTypes();
36: Annotation[][] parameterAnnotations = method.getParameterAnnotations();
37: for (int i = 0; i < parameterTypes.length; i++) {
38: Class<?> type = parameterTypes[i];
39: Annotation[] annotations = parameterAnnotations[i];
40: // åˆ›å»ºæ³¨è§£å±æ€§
41: AnnotationsAttribute attribute = new AnnotationsAttribute(classFile.getConstPool(), AnnotationsAttribute.visibleTag);
42: // å¾ªç¯æ¯ä¸ªæ–¹æ³•å‚æ•°çš„æ¯ä¸ªæ³¨è§£
43: for (Annotation annotation : annotations) {
44: if (annotation.annotationType().isAnnotationPresent(Constraint.class)) { // çº¦æŸæ¡ä»¶çš„æ³¨è§£ï¼Œä¾‹å¦‚ @NotNull
45: javassist.bytecode.annotation.Annotation ja = new javassist.bytecode.annotation.Annotation(
46: classFile.getConstPool(), pool.getCtClass(annotation.annotationType().getName()));
47: // å¾ªç¯æ³¨è§£çš„æ¯ä¸ªæ–¹æ³•
48: Method[] members = annotation.annotationType().getMethods();
49: for (Method member : members) {
50: if (Modifier.isPublic(member.getModifiers())
51: && member.getParameterTypes().length == 0
52: && member.getDeclaringClass() == annotation.annotationType()) {
53: // å°†æ³¨è§£ï¼Œæ·»åŠ åˆ°ç±»çš„å±æ€§ä¸Š
54: Object value = member.invoke(annotation);
55: if (null != value) {
56: MemberValue memberValue = createMemberValue(
57: classFile.getConstPool(), pool.get(member.getReturnType().getName()), value);
58: ja.addMemberValue(member.getName(), memberValue);
59: }
60: }
61: }
62: attribute.addAnnotation(ja);
63: }
64: }
65: // åˆ›å»ºå±æ€§
66: String fieldName = method.getName() + "Argument" + i;
67: CtField ctField = CtField.make("public " + type.getCanonicalName() + " " + fieldName + ";", pool.getCtClass(parameterClassName));
68: ctField.getFieldInfo().addAttribute(attribute);
69: // æ·»åŠ å±æ€§
70: ctClass.addField(ctField);
71: }
72: // ç”Ÿæˆç±»
73: parameterClass = ctClass.toClass(clazz.getClassLoader(), null);
74: }
75: // åˆ›å»º Bean å¯¹è±¡
76: Object parameterBean = parameterClass.newInstance();
77: // è®¾ç½® Bean å¯¹è±¡çš„æ¯ä¸ªå±æ€§çš„å€¼
78: for (int i = 0; i < args.length; i++) {
79: Field field = parameterClass.getField(method.getName() + "Argument" + i);
80: field.set(parameterBean, args[i]);
81: }
82: return parameterBean;
83: } catch (Throwable e) {
84: logger.warn(e.getMessage(), e);
85: return null;
86: }
87: }
```

* ç¬¬ 13 è‡³ 15 è¡Œï¼šè°ƒç”¨

/#hasConstraintParameter(method)
æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰ **Constraint** æ³¨è§£( ä¾‹å¦‚ï¼Œ

@NotNull
)çš„æ–¹æ³•å‚æ•°ã€‚è‹¥æ²¡æœ‰ï¼Œåˆ™æ— éœ€åˆ›å»º Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
private static boolean hasConstraintParameter(Method method){
Annotation[][] parameterAnnotations = method.getParameterAnnotations();
// å¾ªç¯æ‰€æœ‰æ–¹æ³•å‚æ•°çš„æ³¨è§£
if (parameterAnnotations != null && parameterAnnotations.length > 0) {
// å¾ªç¯æ¯ä¸ªæ–¹æ³•å‚æ•°çš„æ³¨è§£æ•°ç»„
for (Annotation[] annotations : parameterAnnotations) {
// æ˜¯å¦æœ‰ Constraint æ³¨è§£
for (Annotation annotation : annotations) {
if (annotation.annotationType().isAnnotationPresent(Constraint.class)) {
return true;
}
}
}
}
return false;
}
```
* ç¬¬ 17 è‡³ 22 è¡Œï¼šè·å¾— Bean ç±»ã€‚
* ç¬¬ 23 è‡³ 73 è¡Œï¼šè‹¥ Bean ç±»**ä¸å­˜åœ¨**ï¼Œä½¿ç”¨ Javassist åŠ¨æ€ç¼–è¯‘ç”Ÿæˆã€‚ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œå·²ç»æ·»åŠ è¯¦ç»†æ³¨é‡Šï¼Œèƒ–å‹è€å¿ƒçœ‹çœ‹å“ˆã€‚å…¶ä¸­ï¼Œ

/#createMemberValue(ConstPool cp, CtClass type, Object value)
æ–¹æ³•ï¼Œè·å¾—æ³¨è§£**æ¯ä¸ªå±æ€§çš„å€¼**ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
// Copy from javassist.bytecode.annotation.Annotation.createMemberValue(ConstPool, CtClass);
private static MemberValue createMemberValue(ConstPool cp, CtClass type, Object value) throws NotFoundException{
MemberValue memberValue = javassist.bytecode.annotation.Annotation.createMemberValue(cp, type);
if (memberValue instanceof BooleanMemberValue) // Boolean
((BooleanMemberValue) memberValue).setValue((Boolean) value);
else if (memberValue instanceof ByteMemberValue) // Byte
((ByteMemberValue) memberValue).setValue((Byte) value);
else if (memberValue instanceof CharMemberValue) // Char
((CharMemberValue) memberValue).setValue((Character) value);
else if (memberValue instanceof ShortMemberValue) // Short
((ShortMemberValue) memberValue).setValue((Short) value);
else if (memberValue instanceof IntegerMemberValue) // Integer
((IntegerMemberValue) memberValue).setValue((Integer) value);
else if (memberValue instanceof LongMemberValue) // Long
((LongMemberValue) memberValue).setValue((Long) value);
else if (memberValue instanceof FloatMemberValue) // Float
((FloatMemberValue) memberValue).setValue((Float) value);
else if (memberValue instanceof DoubleMemberValue)
((DoubleMemberValue) memberValue).setValue((Double) value);
else if (memberValue instanceof ClassMemberValue) // Class
((ClassMemberValue) memberValue).setValue(((Class<?>) value).getName());
else if (memberValue instanceof StringMemberValue) // String
((StringMemberValue) memberValue).setValue((String) value);
else if (memberValue instanceof EnumMemberValue) // Enum
((EnumMemberValue) memberValue).setValue(((Enum<?>) value).name());
//* else if (memberValue instanceof AnnotationMemberValue) /*/
else if (memberValue instanceof ArrayMemberValue) { // æ•°ç»„
CtClass arrayType = type.getComponentType();
int len = Array.getLength(value);
// å¾ªç¯ï¼Œé€’å½’
MemberValue[] members = new MemberValue[len];
for (int i = 0; i < len; i++) {
members[i] = createMemberValue(cp, arrayType, Array.get(value, i));
}
((ArrayMemberValue) memberValue).setValue(members);
}
return memberValue;
}
```
* ç¬¬ 75 è‡³ 81 è¡Œï¼šåˆ›å»º Bean å¯¹è±¡ï¼Œ**è®¾ç½® Bean å¯¹è±¡çš„æ¯ä¸ªå±æ€§çš„å€¼**ã€‚

ğŸ˜ˆ åˆæ˜¯ä¸€å¤„ï¼Œä½¿ç”¨ Javassist åŠ¨æ€ç¼–è¯‘ç±»çš„ä»£ç ã€‚å¥½ç”¨ï¼ï¼ï¼

## 4.2 JValidation

com.alibaba.dubbo.validation.support.jvalidation.JValidation
ï¼Œå®ç° AbstractValidation æŠ½è±¡ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
public class JValidation extends AbstractValidation{
@Override
protected Validator createValidator(URL url){
return new JValidator(url);
}
}
```

# 666. å½©è›‹

ğŸ™‚ ç¾æ»‹æ»‹ï¼Œç»ˆäºå¼„æ‡‚ï¼Œä¸ºä»€ä¹ˆ JSR303 æ˜¯ Java Bean Validation ï¼Œç»“æœæ¥å£æ–¹æ³•ä¸Šï¼Œæ¯ä¸ªå‚æ•°éƒ½æ·»åŠ  Constraint çš„æ³¨è§£ï¼Œç»“æœä¹Ÿå¯ä»¥åšæ ¡éªŒã€‚