<header class="article-header">
<h1 class="article-title">åŠ¨æ€ç¼–è¯‘ï¼ˆä¸€ï¼‰ä¹‹ Javassist</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>åœ¨ Java è¯­è¨€ä¸­ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å·²ç»ç¼–å†™å¥½ Java ç±»ï¼Œå¹¶ç¼–è¯‘æˆ Class æ–‡ä»¶è¿›è¡Œè¿è¡Œã€‚ä½†æ˜¯åœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œä¾‹å¦‚åŠ¨æ€ä»£ç†ï¼Œéœ€è¦è¿ç”¨åˆ°<strong>åŠ¨æ€ç¼–è¯‘</strong>çš„æŠ€æœ¯ã€‚è™½ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨åå°„çš„æŠ€æœ¯å®ç°ï¼Œä½†æ˜¯ç›¸æ¯”æ¥è¯´ï¼Œè¿˜æ˜¯æœ‰ä¸€å®šçš„æ€§èƒ½å·®è·ã€‚</p>
<p>ä¾‹å¦‚ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æ‹“å±•æœºåˆ¶ SPIã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/compiler-javassist/">ã€Œ4.5.4 createAdaptiveExtensionClassCodeã€</a>å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * è‡ªåŠ¨ç”Ÿæˆè‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°ï¼Œå¹¶ç¼–è¯‘åè¿”å›è¯¥ç±»ã€‚</span></span><br /><span class="line"><span class="comment"> 3:  *</span></span><br /><span class="line"><span class="comment"> 4:  * <span class="doctag">@return</span> ç±»</span></span><br /><span class="line"><span class="comment"> 5:  */</span></span><br /><span class="line"> <span class="number">6</span>: <span class="keyword">private</span> Class&lt;?&gt; createAdaptiveExtensionClass() {</span><br /><span class="line"> <span class="number">7</span>:     <span class="comment">// è‡ªåŠ¨ç”Ÿæˆè‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°çš„å­—ç¬¦ä¸²</span></span><br /><span class="line"> <span class="number">8</span>:     String code = createAdaptiveExtensionClassCode();</span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// ç¼–è¯‘ä»£ç ï¼Œå¹¶è¿”å›è¯¥ç±»</span></span><br /><span class="line"><span class="number">10</span>:     ClassLoader classLoader = findClassLoader();</span><br /><span class="line"><span class="number">11</span>:     com.alibaba.dubbo.common.compiler.Compiler compiler = ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.common.compiler.Compiler.class).getAdaptiveExtension();</span><br /><span class="line"><span class="number">12</span>:     <span class="keyword">return</span> compiler.compile(code, classLoader);</span><br /><span class="line"><span class="number">13</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>è°ƒç”¨&nbsp;<code>Compiler#compile(code, classLoader)</code>&nbsp;æ–¹æ³•ï¼Œç¼–è¯‘ä»£ç ï¼Œå¹¶è¿”å›è¯¥ç±»ã€‚Compiler åŸºäº Dubbo SPI æœºåˆ¶è¿›è¡ŒåŠ è½½ï¼Œç›®å‰æœ‰ä¸¤ç§å®ç°ï¼š</p>
<ul>
<li>
<p>JdkCompiler</p>
<figure class="highlight xml">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">compiler</span>=<span class="string">"jdk"</span> /&gt;</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>JavassistCompiler</p>
<figure class="highlight xml">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">compiler</span>=<span class="string">"javassist"</span> /&gt;</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<p><strong>ç¼ºçœ</strong>ä½¿ç”¨ JavassistCompiler ã€‚</p>
<p>ğŸ™‚ æœ¬æ–‡ä»…åˆ†äº« JavassistCompiler çš„å®ç°ã€‚</p>
<hr />
<p>åŠ¨æ€ç¼–è¯‘ï¼Œåœ¨&nbsp;<code>dubbo-common</code>&nbsp;æ¨¡å—çš„&nbsp;<a href="https://github.com/YunaiV/dubbo/tree/ded892cb2f31e2847c18f773e16b16a6fbaf53d2/dubbo-common/src/main/java/com/alibaba/dubbo/common/compiler" target="_blank" rel="external nofollow noopener noreferrer"><code>compiler</code></a>&nbsp;åŒ…ä¸‹å®ç°ï¼Œæ•´ä½“ç±»ç»“æ„å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_09_01/01.png" alt="ç±»å›¾" /></p>
<h1 id="2-Compiler">2. Compiler</h1>
<p><code>com.alibaba.dubbo.common.compiler.Compiler</code>&nbsp;ï¼Œç¼–è¾‘å™¨æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@SPI</span>(<span class="string">"javassist"</span>)</span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Compiler</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Compile java source code.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * ç¼–è¯‘ Java ä»£ç å­—ç¬¦ä¸²</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> code        Java source code</span></span><br /><span class="line"><span class="comment">     *                    Java ä»£ç å­—ç¬¦ä¸²</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> classLoader classloader</span></span><br /><span class="line"><span class="comment">     *                    ç±»åŠ è½½å™¨</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> Compiled class</span></span><br /><span class="line"><span class="comment">     *                    ç¼–è¯‘åçš„ç±»</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    Class&lt;?&gt; compile(String code, ClassLoader classLoader);</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>@SPI("javassist")</code>&nbsp;æ³¨è§£ï¼Œä½¿ç”¨ Dubbo SPI æœºåˆ¶ï¼Œé»˜è®¤æ‹“å±•ä¸º Javassist ã€‚</li>
<li><code>code</code>&nbsp;å‚æ•°ï¼ŒJava ä»£ç å­—ç¬¦ä¸²ã€‚å¦‚ä¸‹æ˜¯ ProxyFactory$Adaptive çš„è‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°çš„å­—ç¬¦ä¸²ç”Ÿæˆ<strong>ä¾‹å­</strong>ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_03_04/05.png" alt="è‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°çš„å­—ç¬¦ä¸²ç”Ÿæˆä¾‹å­" /></li>
</ul>
<h1 id="3-AdaptiveCompiler">3. AdaptiveCompiler</h1>
<p><code>com.alibaba.dubbo.common.compiler.support.AdaptiveCompiler</code>&nbsp;ï¼Œå®ç° Compiler æ¥å£ï¼Œè‡ªé€‚åº” Compiler å®ç°ç±»ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Adaptive</span></span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdaptiveCompiler</span> <span class="keyword">implements</span> <span class="title">Compiler</span> </span>{</span><br /><span class="line"> <span class="number">3</span>: </span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 5:      * é»˜è®¤ç¼–è¾‘å™¨çš„æ‹“å±•å</span></span><br /><span class="line"><span class="comment"> 6:      */</span></span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> String DEFAULT_COMPILER;</span><br /><span class="line"> <span class="number">8</span>: </span><br /><span class="line"> <span class="number">9</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setDefaultCompiler</span><span class="params">(String compiler)</span> </span>{</span><br /><span class="line"><span class="number">10</span>:         DEFAULT_COMPILER = compiler;</span><br /><span class="line"><span class="number">11</span>:     }</span><br /><span class="line"><span class="number">12</span>: </span><br /><span class="line"><span class="number">13</span>:     <span class="meta">@Override</span> <span class="keyword">public</span> Class&lt;?&gt; compile(String code, ClassLoader classLoader) {</span><br /><span class="line"><span class="number">14</span>:         Compiler compiler;</span><br /><span class="line"><span class="number">15</span>:         <span class="comment">// è·å¾— Compiler çš„ ExtensionLoader å¯¹è±¡ã€‚</span></span><br /><span class="line"><span class="number">16</span>:         ExtensionLoader&lt;Compiler&gt; loader = ExtensionLoader.getExtensionLoader(Compiler.class);</span><br /><span class="line"><span class="number">17</span>:         String name = DEFAULT_COMPILER; <span class="comment">// copy reference</span></span><br /><span class="line"><span class="number">18</span>:         <span class="comment">// ä½¿ç”¨è®¾ç½®çš„æ‹“å±•åï¼Œè·å¾— Compiler æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="number">19</span>:         <span class="keyword">if</span> (name != <span class="keyword">null</span> &amp;&amp; name.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">20</span>:             compiler = loader.getExtension(name);</span><br /><span class="line"><span class="number">21</span>:         <span class="comment">// è·å¾—é»˜è®¤çš„ Compiler æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="number">22</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">23</span>:             compiler = loader.getDefaultExtension();</span><br /><span class="line"><span class="number">24</span>:         }</span><br /><span class="line"><span class="number">25</span>:         <span class="comment">//</span></span><br /><span class="line"><span class="number">26</span>:         <span class="keyword">return</span> compiler.compile(code, classLoader);</span><br /><span class="line"><span class="number">27</span>:     }</span><br /><span class="line"><span class="number">28</span>: </span><br /><span class="line"><span class="number">29</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>#setDefaultCompiler(compiler)</code>&nbsp;<strong>é™æ€</strong>æ–¹æ³•ï¼Œè®¾ç½®é»˜è®¤ç¼–è¾‘å™¨çš„æ‹“å±•å(&nbsp;<code>DEFAULT_COMPILER</code>&nbsp;)ã€‚è¯¥æ–¹æ³•è¢«&nbsp;<code>ApplicationConfig#setCompiler(compiler)</code>&nbsp;æ–¹æ³•è°ƒç”¨ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ApplicationConfig.java</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCompiler</span><span class="params">(String compiler)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.compiler = compiler;</span><br /><span class="line">    AdaptiveCompiler.setDefaultCompiler(compiler);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>åœ¨&nbsp;<code>&lt;dubbo:application compiler="" /&gt;</code>&nbsp;é…ç½®ä¸‹ï¼Œå¯è§¦å‘è¯¥æ–¹æ³•ã€‚</li>
</ul>
</li>
<li>
<p><code>#compile(code, classLoader)</code>&nbsp;<strong>å®ç°</strong>æ–¹æ³•ï¼š</p>
<ul>
<li>ç¬¬ 16 è¡Œï¼šè°ƒç”¨&nbsp;<code>ExtensionLoader#getExtensionLoader(Class&lt;?&gt; type)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— Compiler çš„ ExtensionLoader å¯¹è±¡ã€‚</li>
<li>ç¬¬ 17 è¡Œï¼šå£°æ˜&nbsp;<code>name</code>&nbsp;å˜é‡ï¼Œå¼•ç”¨&nbsp;<code>DEFAULT_COMPILER</code>&nbsp;çš„å€¼ã€‚é¿å…åœ¨ã€ç¬¬ 19 è‡³ 20 è¡Œã€‘çš„ä»£ç è¿‡ç¨‹ä¸­ï¼Œå€¼å˜äº†ã€‚</li>
<li>ç¬¬ 19 è‡³ 20 è¡Œï¼šä½¿ç”¨<strong>è®¾ç½®</strong>çš„æ‹“å±•åï¼Œè·å¾— Compiler æ‹“å±•å¯¹è±¡ã€‚</li>
<li>ç¬¬ 22 è‡³ 24 è¡Œï¼šè·å¾—é»˜è®¤çš„ Compiler æ‹“å±•å¯¹è±¡ã€‚</li>
<li>ç¬¬ 26 è¡Œï¼šè°ƒç”¨çœŸæ­£çš„ Compiler å¯¹è±¡ï¼ŒåŠ¨æ€ç¼–è¯‘ä»£ç ã€‚</li>
</ul>
</li>
</ul>
<h1 id="4-AbstractCompiler">4. AbstractCompiler</h1>
<p><code>com.alibaba.dubbo.common.compiler.support.AbstractCompiler</code>&nbsp;ï¼Œå®ç° Compiler æ¥å£ï¼ŒCompiler&nbsp;<strong>æŠ½è±¡ç±»</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractCompiler</span> <span class="keyword">implements</span> <span class="title">Compiler</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ­£åˆ™ - åŒ…å</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern PACKAGE_PATTERN = Pattern.compile(<span class="string">"package\\s+([$_a-zA-Z][$_a-zA-Z0-9\\.]*);"</span>);</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ­£åˆ™ - ç±»å</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern CLASS_PATTERN = Pattern.compile(<span class="string">"class\\s+([$_a-zA-Z][$_a-zA-Z0-9]*)\\s+"</span>);</span><br /><br /><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; compile(String code, ClassLoader classLoader) {</span><br /><span class="line">        <span class="comment">// è·å¾—åŒ…å</span></span><br /><span class="line">        code = code.trim();</span><br /><span class="line">        Matcher matcher = PACKAGE_PATTERN.matcher(code);</span><br /><span class="line">        String pkg;</span><br /><span class="line">        <span class="keyword">if</span> (matcher.find()) {</span><br /><span class="line">            pkg = matcher.group(<span class="number">1</span>);</span><br /><span class="line">        } <span class="keyword">else</span> {</span><br /><span class="line">            pkg = <span class="string">""</span>;</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// è·å¾—ç±»å</span></span><br /><span class="line">        matcher = CLASS_PATTERN.matcher(code);</span><br /><span class="line">        String cls;</span><br /><span class="line">        <span class="keyword">if</span> (matcher.find()) {</span><br /><span class="line">            cls = matcher.group(<span class="number">1</span>);</span><br /><span class="line">        } <span class="keyword">else</span> {</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"No such class name in "</span> + code);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// è·å¾—å®Œæ•´ç±»å</span></span><br /><span class="line">        String className = pkg != <span class="keyword">null</span> &amp;&amp; pkg.length() &gt; <span class="number">0</span> ? pkg + <span class="string">"."</span> + cls : cls;</span><br /><span class="line">        <span class="comment">// åŠ è½½ç±»ï¼Œè‹¥å·²ç»å­˜åœ¨</span></span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            <span class="comment">// åŠ è½½æˆåŠŸï¼Œè¯´æ˜å·²å­˜åœ¨</span></span><br /><span class="line">            <span class="keyword">return</span> Class.forName(className, <span class="keyword">true</span>, ClassHelper.getCallerClassLoader(getClass())); <span class="comment">// classloader ä¸ºè°ƒç”¨æ–¹çš„</span></span><br /><span class="line">        } <span class="keyword">catch</span> (ClassNotFoundException e) { <span class="comment">// ç±»ä¸å­˜åœ¨ï¼Œè¯´æ˜å¯èƒ½æœªç¼–è¯‘è¿‡ï¼Œè¿›è¡Œç¼–è¯‘</span></span><br /><span class="line">            <span class="comment">// ä»£ç æ ¼å¼ä¸æ­£ç¡®</span></span><br /><span class="line">            <span class="keyword">if</span> (!code.endsWith(<span class="string">"}"</span>)) {</span><br /><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The java code not endsWith \"}\", code: \n"</span> + code + <span class="string">"\n"</span>);</span><br /><span class="line">            }</span><br /><span class="line">            <span class="comment">// ç¼–è¯‘ä»£ç </span></span><br /><span class="line">            <span class="keyword">try</span> {</span><br /><span class="line">                <span class="keyword">return</span> doCompile(className, code);</span><br /><span class="line">            } <span class="keyword">catch</span> (RuntimeException t) {</span><br /><span class="line">                <span class="keyword">throw</span> t;</span><br /><span class="line">            } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed to compile class, cause: "</span> + t.getMessage() + <span class="string">", class: "</span> + className + <span class="string">", code: \n"</span> + code + <span class="string">"\n, stack: "</span> + ClassUtils.toString(t));</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * ç¼–è¯‘ä»£ç </span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> name ç±»å</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> source ä»£ç </span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> ç¼–è¯‘åçš„ç±»</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Throwable å‘ç”Ÿå¼‚å¸¸</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> Class&lt;?&gt; doCompile(String name, String source) <span class="keyword">throws</span> Throwable;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>é¦–å…ˆè·å¾—å®Œæ•´ç±»åï¼Œåä½¿ç”¨ç±»åŠ è½½å™¨åŠ è½½è¯¥ç±»ï¼š
<ul>
<li>è‹¥æˆåŠŸï¼Œè¯´æ˜å·²ç»å­˜åœ¨ï¼ˆå¯èƒ½å·²ç»ç¼–è¯‘è¿‡ï¼‰ã€‚</li>
<li>è‹¥å¤±è´¥ï¼Œè¿›è¡Œç¼–è¯‘ã€‚</li>
</ul>
</li>
<li>ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹å¯ä»¥åœ¨çœ‹ä¸‹æ³¨é‡Šã€‚</li>
</ul>
<h1 id="5-JavassistCompiler">5. JavassistCompiler</h1>
<blockquote>
<p>Javassist æ˜¯ä¸€ä¸ªå¼€æºçš„åˆ†æã€ç¼–è¾‘å’Œåˆ›å»º Java å­—èŠ‚ç çš„ç±»åº“ã€‚é€šè¿‡ä½¿ç”¨Javassist å¯¹å­—èŠ‚ç æ“ä½œå¯ä»¥å®ç°åŠ¨æ€ &rdquo;AOP&rdquo; æ¡†æ¶ã€‚</p>
<p>å…³äº Java å­—èŠ‚ç çš„å¤„ç†ï¼Œç›®å‰æœ‰å¾ˆå¤šå·¥å…·ï¼Œå¦‚ bcelï¼Œasm( cglibåªæ˜¯å¯¹asmåˆå°è£…äº†ä¸€å±‚ )ã€‚ä¸è¿‡è¿™äº›éƒ½éœ€è¦ç›´æ¥è·Ÿè™šæ‹ŸæœºæŒ‡ä»¤æ‰“äº¤é“ã€‚</p>
<p>Javassist çš„ä¸»è¦çš„ä¼˜ç‚¹ï¼Œåœ¨äºç®€å•ï¼Œè€Œä¸”å¿«é€Ÿï¼Œç›´æ¥ä½¿ç”¨ Java ç¼–ç çš„å½¢å¼ï¼Œè€Œä¸éœ€è¦äº†è§£è™šæ‹ŸæœºæŒ‡ä»¤ï¼Œå°±èƒ½åŠ¨æ€æ”¹å˜ç±»çš„ç»“æ„ï¼Œæˆ–è€…åŠ¨æ€ç”Ÿæˆç±»ã€‚</p>
</blockquote>
<ul>
<li>ç²—ç•¥ä¸€çœ‹ï¼Œå¯èƒ½ä¸å¤Ÿå½¢è±¡ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡çœ‹ JavassistCompiler å¦‚ä½•ä½¿ç”¨æ¥ç†è§£ç†è§£ã€‚</li>
<li><a href="http://www.cnblogs.com/sunfie/p/5154246.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠJavaå­¦ä¹ ä¹‹javassistã€‹</a></li>
<li><a href="http://blog.csdn.net/qbg19881206/article/details/8993562" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠJavassist å­—èŠ‚ç æ“ä½œã€‹</a></li>
</ul>
<p><code>com.alibaba.dubbo.common.compiler.support.JavassistCompiler</code>&nbsp;ï¼Œå®ç° AbstractCompiler æŠ½è±¡ç±»ï¼ŒåŸºäº Javassist å®ç°çš„ Compiler ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">  <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavassistCompiler</span> <span class="keyword">extends</span> <span class="title">AbstractCompiler</span> </span>{</span><br /><span class="line">  <span class="number">2</span>: </span><br /><span class="line">  <span class="number">3</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment">  4:      * æ­£åˆ™ - åŒ¹é… import</span></span><br /><span class="line"><span class="comment">  5:      */</span></span><br /><span class="line">  <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern IMPORT_PATTERN = Pattern.compile(<span class="string">"import\\s+([\\w\\.\\*]+);\n"</span>);</span><br /><span class="line">  <span class="number">7</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment">  8:      * æ­£åˆ™ - åŒ¹é… extends</span></span><br /><span class="line"><span class="comment">  9:      */</span></span><br /><span class="line"> <span class="number">10</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern EXTENDS_PATTERN = Pattern.compile(<span class="string">"\\s+extends\\s+([\\w\\.]+)[^\\{]*\\{\n"</span>);</span><br /><span class="line"> <span class="number">11</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 12:      * æ­£åˆ™ - åŒ¹é… implements</span></span><br /><span class="line"><span class="comment"> 13:      */</span></span><br /><span class="line"> <span class="number">14</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern IMPLEMENTS_PATTERN = Pattern.compile(<span class="string">"\\s+implements\\s+([\\w\\.]+)\\s*\\{\n"</span>);</span><br /><span class="line"> <span class="number">15</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 16:      * æ­£åˆ™ - åŒ¹é…æ–¹æ³•</span></span><br /><span class="line"><span class="comment"> 17:      */</span></span><br /><span class="line"> <span class="number">18</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern METHODS_PATTERN = Pattern.compile(<span class="string">"\n(private|public|protected)\\s+"</span>);</span><br /><span class="line"> <span class="number">19</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 20:      * æ­£åˆ™ - åŒ¹é…å˜é‡</span></span><br /><span class="line"><span class="comment"> 21:      */</span></span><br /><span class="line"> <span class="number">22</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern FIELD_PATTERN = Pattern.compile(<span class="string">"[^\n]+=[^\n]+;"</span>);</span><br /><span class="line"> <span class="number">23</span>: </span><br /><span class="line"> <span class="number">24</span>:     <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">25</span>:     <span class="keyword">public</span> Class&lt;?&gt; doCompile(String name, String source) <span class="keyword">throws</span> Throwable {</span><br /><span class="line"> <span class="number">26</span>:         <span class="comment">// è·å¾—ç±»å</span></span><br /><span class="line"> <span class="number">27</span>:         <span class="keyword">int</span> i = name.lastIndexOf(<span class="string">'.'</span>);</span><br /><span class="line"> <span class="number">28</span>:         String className = i &lt; <span class="number">0</span> ? name : name.substring(i + <span class="number">1</span>);</span><br /><span class="line"> <span class="number">29</span>:         <span class="comment">// åˆ›å»º ClassPool å¯¹è±¡</span></span><br /><span class="line"> <span class="number">30</span>:         ClassPool pool = <span class="keyword">new</span> ClassPool(<span class="keyword">true</span>);</span><br /><span class="line"> <span class="number">31</span>:         <span class="comment">// è®¾ç½®ç±»æœç´¢è·¯å¾„</span></span><br /><span class="line"> <span class="number">32</span>:         pool.appendClassPath(<span class="keyword">new</span> LoaderClassPath(ClassHelper.getCallerClassLoader(getClass())));</span><br /><span class="line"> <span class="number">33</span>:         <span class="comment">// åŒ¹é… import</span></span><br /><span class="line"> <span class="number">34</span>:         Matcher matcher = IMPORT_PATTERN.matcher(source);</span><br /><span class="line"> <span class="number">35</span>:         List&lt;String&gt; importPackages = <span class="keyword">new</span> ArrayList&lt;String&gt;(); <span class="comment">// å¼•ç”¨çš„åŒ…å</span></span><br /><span class="line"> <span class="number">36</span>:         Map&lt;String, String&gt; fullNames = <span class="keyword">new</span> HashMap&lt;String, String&gt;(); <span class="comment">// å¼•ç”¨çš„ç±»å</span></span><br /><span class="line"> <span class="number">37</span>:         <span class="keyword">while</span> (matcher.find()) {</span><br /><span class="line"> <span class="number">38</span>:             String pkg = matcher.group(<span class="number">1</span>);</span><br /><span class="line"> <span class="number">39</span>:             <span class="keyword">if</span> (pkg.endsWith(<span class="string">".*"</span>)) { <span class="comment">// å¼•ç”¨æ•´ä¸ªåŒ…ä¸‹çš„ç±»/æ¥å£</span></span><br /><span class="line"> <span class="number">40</span>:                 String pkgName = pkg.substring(<span class="number">0</span>, pkg.length() - <span class="number">2</span>);</span><br /><span class="line"> <span class="number">41</span>:                 pool.importPackage(pkgName);</span><br /><span class="line"> <span class="number">42</span>:                 importPackages.add(pkgName);</span><br /><span class="line"> <span class="number">43</span>:             } <span class="keyword">else</span> { <span class="comment">// å¼•ç”¨æŒ‡å®šç±»/æ¥å£</span></span><br /><span class="line"> <span class="number">44</span>:                 <span class="keyword">int</span> pi = pkg.lastIndexOf(<span class="string">'.'</span>);</span><br /><span class="line"> <span class="number">45</span>:                 <span class="keyword">if</span> (pi &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">46</span>:                     String pkgName = pkg.substring(<span class="number">0</span>, pi);</span><br /><span class="line"> <span class="number">47</span>:                     pool.importPackage(pkgName);</span><br /><span class="line"> <span class="number">48</span>:                     importPackages.add(pkgName);</span><br /><span class="line"> <span class="number">49</span>:                     fullNames.put(pkg.substring(pi + <span class="number">1</span>), pkg); <span class="comment">// ç±»å</span></span><br /><span class="line"> <span class="number">50</span>:                 }</span><br /><span class="line"> <span class="number">51</span>:             }</span><br /><span class="line"> <span class="number">52</span>:         }</span><br /><span class="line"> <span class="number">53</span>:         String[] packages = importPackages.toArray(<span class="keyword">new</span> String[<span class="number">0</span>]);</span><br /><span class="line"> <span class="number">54</span>:         <span class="comment">// åŒ¹é… extends</span></span><br /><span class="line"> <span class="number">55</span>:         matcher = EXTENDS_PATTERN.matcher(source);</span><br /><span class="line"> <span class="number">56</span>:         CtClass cls;</span><br /><span class="line"> <span class="number">57</span>:         <span class="keyword">if</span> (matcher.find()) {</span><br /><span class="line"> <span class="number">58</span>:             String extend = matcher.group(<span class="number">1</span>).trim();</span><br /><span class="line"> <span class="number">59</span>:             String extendClass;</span><br /><span class="line"> <span class="number">60</span>:             <span class="keyword">if</span> (extend.contains(<span class="string">"."</span>)) { <span class="comment">// å†…åµŒçš„ç±»ï¼Œä¾‹å¦‚ï¼šextends A.B</span></span><br /><span class="line"> <span class="number">61</span>:                 extendClass = extend;</span><br /><span class="line"> <span class="number">62</span>:             } <span class="keyword">else</span> <span class="keyword">if</span> (fullNames.containsKey(extend)) { <span class="comment">// æŒ‡å®šå¼•ç”¨çš„ç±»</span></span><br /><span class="line"> <span class="number">63</span>:                 extendClass = fullNames.get(extend);</span><br /><span class="line"> <span class="number">64</span>:             } <span class="keyword">else</span> { <span class="comment">// å¼•ç”¨æ•´ä¸ªåŒ…ä¸‹çš„ç±»</span></span><br /><span class="line"> <span class="number">65</span>:                 extendClass = ClassUtils.forName(packages, extend).getName();</span><br /><span class="line"> <span class="number">66</span>:             }</span><br /><span class="line"> <span class="number">67</span>:             <span class="comment">// åˆ›å»º CtClass å¯¹è±¡</span></span><br /><span class="line"> <span class="number">68</span>:             cls = pool.makeClass(name, pool.get(extendClass));</span><br /><span class="line"> <span class="number">69</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">70</span>:             <span class="comment">// åˆ›å»º CtClass å¯¹è±¡</span></span><br /><span class="line"> <span class="number">71</span>:             cls = pool.makeClass(name);</span><br /><span class="line"> <span class="number">72</span>:         }</span><br /><span class="line"> <span class="number">73</span>:         <span class="comment">// åŒ¹é… implements</span></span><br /><span class="line"> <span class="number">74</span>:         matcher = IMPLEMENTS_PATTERN.matcher(source);</span><br /><span class="line"> <span class="number">75</span>:         <span class="keyword">if</span> (matcher.find()) {</span><br /><span class="line"> <span class="number">76</span>:             String[] ifaces = matcher.group(<span class="number">1</span>).trim().split(<span class="string">"\\,"</span>);</span><br /><span class="line"> <span class="number">77</span>:             <span class="keyword">for</span> (String iface : ifaces) {</span><br /><span class="line"> <span class="number">78</span>:                 iface = iface.trim();</span><br /><span class="line"> <span class="number">79</span>:                 String ifaceClass;</span><br /><span class="line"> <span class="number">80</span>:                 <span class="keyword">if</span> (iface.contains(<span class="string">"."</span>)) { <span class="comment">// å†…åµŒçš„æ¥å£ï¼Œä¾‹å¦‚ï¼šextends A.B</span></span><br /><span class="line"> <span class="number">81</span>:                     ifaceClass = iface;</span><br /><span class="line"> <span class="number">82</span>:                 } <span class="keyword">else</span> <span class="keyword">if</span> (fullNames.containsKey(iface)) { <span class="comment">// æŒ‡å®šå¼•ç”¨çš„æ¥å£</span></span><br /><span class="line"> <span class="number">83</span>:                     ifaceClass = fullNames.get(iface);</span><br /><span class="line"> <span class="number">84</span>:                 } <span class="keyword">else</span> { <span class="comment">// å¼•ç”¨æ•´ä¸ªåŒ…ä¸‹çš„æ¥å£</span></span><br /><span class="line"> <span class="number">85</span>:                     ifaceClass = ClassUtils.forName(packages, iface).getName();</span><br /><span class="line"> <span class="number">86</span>:                 }</span><br /><span class="line"> <span class="number">87</span>:                 <span class="comment">// æ·»åŠ æ¥å£</span></span><br /><span class="line"> <span class="number">88</span>:                 cls.addInterface(pool.get(ifaceClass));</span><br /><span class="line"> <span class="number">89</span>:             }</span><br /><span class="line"> <span class="number">90</span>:         }</span><br /><span class="line"> <span class="number">91</span>:         <span class="comment">// è·å¾—ç±»ä¸­çš„å†…å®¹ï¼Œå³é¦–æœ« {} çš„å†…å®¹ã€‚</span></span><br /><span class="line"> <span class="number">92</span>:         String body = source.substring(source.indexOf(<span class="string">"{"</span>) + <span class="number">1</span>, source.length() - <span class="number">1</span>);</span><br /><span class="line"> <span class="number">93</span>:         <span class="comment">// åŒ¹é… method ã€‚ä½¿ç”¨åˆ†éš”çš„æ–¹å¼ï¼Œå®é™…ä¸Šï¼Œåˆ†éš”å‡ºæ¥çš„ä¸ä»…ä»…æœ‰æ–¹æ³•ã€‚</span></span><br /><span class="line"> <span class="number">94</span>:         String[] methods = METHODS_PATTERN.split(body);</span><br /><span class="line"> <span class="number">95</span>:         <span class="keyword">for</span> (String method : methods) {</span><br /><span class="line"> <span class="number">96</span>:             method = method.trim();</span><br /><span class="line"> <span class="number">97</span>:             <span class="keyword">if</span> (method.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">98</span>:                 <span class="keyword">if</span> (method.startsWith(className)) { <span class="comment">// æ„é€ æ–¹æ³•</span></span><br /><span class="line"> <span class="number">99</span>:                     cls.addConstructor(CtNewConstructor.make(<span class="string">"public "</span> + method, cls));</span><br /><span class="line"><span class="number">100</span>:                 } <span class="keyword">else</span> <span class="keyword">if</span> (FIELD_PATTERN.matcher(method).matches()) { <span class="comment">// å˜é‡</span></span><br /><span class="line"><span class="number">101</span>:                     cls.addField(CtField.make(<span class="string">"private "</span> + method, cls));</span><br /><span class="line"><span class="number">102</span>:                 } <span class="keyword">else</span> { <span class="comment">// æ–¹æ³•</span></span><br /><span class="line"><span class="number">103</span>:                     cls.addMethod(CtNewMethod.make(<span class="string">"public "</span> + method, cls));</span><br /><span class="line"><span class="number">104</span>:                 }</span><br /><span class="line"><span class="number">105</span>:             }</span><br /><span class="line"><span class="number">106</span>:         }</span><br /><span class="line"><span class="number">107</span>:         <span class="comment">// ç”Ÿæˆç±»</span></span><br /><span class="line"><span class="number">108</span>:         <span class="comment">// JavassistCompiler.class.getProtectionDomain() =ã€‹ è®¾ç½®ä¿æŠ¤åŸŸå’Œ JavassistCompiler ä¸€è‡´ï¼Œå³ `#getClass()` æ–¹æ³•ã€‚æ·±å…¥è§ ã€ŠJavaå®‰å…¨&mdash;&mdash;å®‰å…¨ç®¡ç†å™¨ã€è®¿é—®æ§åˆ¶å™¨å’Œç±»è£…è½½å™¨ã€‹https://www.zybuluo.com/changedi/note/417132</span></span><br /><span class="line"><span class="number">109</span>:         <span class="keyword">return</span> cls.toClass(ClassHelper.getCallerClassLoader(getClass()), JavassistCompiler.class.getProtectionDomain());</span><br /><span class="line"><span class="number">110</span>:     }</span><br /><span class="line"><span class="number">111</span>: </span><br /><span class="line"><span class="number">112</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å› ä¸ºä¼ å…¥çš„æ˜¯ Java æºä»£ç &nbsp;<code>source</code>&nbsp;ï¼Œéœ€è¦é€šè¿‡æ­£åˆ™åŒ¹é…å‡º&nbsp;<code>import</code>ã€<code>extends</code>ã€<code>implements</code>ã€æ–¹æ³•ã€å˜é‡ï¼Œä¼ é€’ç»™ Javassist API ï¼Œè¿›è¡Œç±»ç”Ÿæˆã€‚ğŸ™‚ å¦‚æœèƒ–å‹å¯¹ Javassist çš„ API ä¸æ˜¯å¾ˆäº†è§£ï¼Œå¯ä»¥çœ‹å®Œæ•´ä½“é€»è¾‘ï¼Œå›çœ‹ä¸‹ä¸Šé¢æä¾›çš„æ–‡æ¡£ã€‚æŒºæœ‰è¶£çš„ã€‚</li>
<li>ç¬¬ 27 è‡³ 28 è¡Œï¼šè·å¾—ç±»åã€‚</li>
<li>ç¬¬ 30 è¡Œï¼šåˆ›å»º ClassPool å¯¹è±¡ã€‚<strong>ClassPool</strong>&nbsp;æ˜¯ä¸€ä¸ª CtClass å¯¹è±¡çš„ hash è¡¨ï¼Œç±»ååšä¸º key ã€‚ClassPool çš„&nbsp;<code>#get(key)</code>&nbsp;æœç´¢ hash è¡¨æ‰¾åˆ°ä¸æŒ‡å®š key å…³è”çš„ CtClass å¯¹è±¡ã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ° CtClass å¯¹è±¡ï¼Œ<code>#get(key)</code>&nbsp;è¯»ä¸€ä¸ªç±»æ–‡ä»¶æ„å»ºæ–°çš„ CtClass å¯¹è±¡ï¼Œå®ƒæ˜¯è¢«è®°å½•åœ¨ hash è¡¨ä¸­ç„¶åè¿”å›è¿™ä¸ªå¯¹è±¡ã€‚</li>
<li>ç¬¬ 32 è¡Œï¼šè°ƒç”¨&nbsp;<code>ClassPool#appendClassPath(ClassPath)</code>&nbsp;æ–¹æ³•ï¼Œè®¾ç½®ç±»æœç´¢è·¯å¾„ã€‚</li>
<li>ç¬¬ 33 è‡³ 52 è¡Œï¼šåŒ¹é…&nbsp;<code>import</code>&nbsp;ã€‚
<ul>
<li><code>ClassPool#importPackage(packageName)</code>&nbsp;æ–¹æ³•ï¼Œå¼•ç”¨åŒ…ã€‚</li>
</ul>
</li>
<li>ç¬¬ 54 è‡³ 72 è¡Œï¼šåŒ¹é…&nbsp;<code>extends</code>&nbsp;ã€‚
<ul>
<li><code>ClassPool#makeClass(name, extendClass)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º<strong>å¸¦ç»§æ‰¿çš„</strong>ç±»ã€‚</li>
<li><code>ClassPool#makeClass(name)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºç±»ã€‚</li>
</ul>
</li>
<li>ç¬¬ 74 è‡³ 90 è¡Œï¼šåŒ¹é…&nbsp;<code>implements</code>&nbsp;ï¼Œæ•´ä½“é€»è¾‘å’Œ&nbsp;<code>extends</code>&nbsp;ç±»ä¼¼ã€‚
<ul>
<li><code>CtClass#addInterface(anInterface)</code>&nbsp;æ–¹æ³•ï¼Œæ·»åŠ ç±»çš„æ¥å£ã€‚</li>
</ul>
</li>
<li>ç¬¬ 92 è¡Œï¼šè·å¾—ç±»ä¸­çš„å†…å®¹ï¼Œå³é¦–æœ«&nbsp;<code>{</code>&nbsp;<code>}</code>&nbsp;ä¸­çš„å†…å®¹ä½“ã€‚</li>
<li>ç¬¬ 94 è‡³ 106 è¡Œï¼šåŒ¹é…æ–¹æ³•å’Œå˜é‡ã€‚ä½¿ç”¨&nbsp;<code>METHODS_PATTERN</code>&nbsp;åˆ†éš”çš„æ–¹å¼ã€‚
<ul>
<li><code>CtClass#addConstructor(CtConstructor)</code>&nbsp;æ–¹æ³•ï¼Œæ·»åŠ ç±»çš„æ„é€ æ–¹æ³•ã€‚</li>
<li><code>CtClass#addMethod(CtMethod)</code>&nbsp;æ–¹æ³•ï¼Œæ·»åŠ ç±»çš„æ–¹æ³•ã€‚</li>
<li><code>CtClass#addField(CtField)</code>&nbsp;æ–¹æ³•ï¼Œæ·»åŠ ç±»çš„å±æ€§ã€‚</li>
</ul>
</li>
<li>ç¬¬ 109 è¡Œï¼šè°ƒç”¨&nbsp;<code>CtClass#toClass(ClassLoader, ProtectionDomain)</code>&nbsp;æ–¹æ³•ï¼Œç”Ÿæˆç±»ã€‚</li>
</ul>
</div>