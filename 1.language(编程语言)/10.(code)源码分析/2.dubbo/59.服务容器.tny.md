<header class="article-header"><header class="article-header">
<h1 class="article-title">æœåŠ¡å®¹å™¨</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡åˆ†äº« Dubbo å®ç°&nbsp;<strong>æœåŠ¡å®¹å™¨</strong>&nbsp;åŠŸèƒ½ã€‚åœ¨&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/service-container.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; æœåŠ¡å®¹å™¨ã€‹</a>&nbsp;å®šä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>æœåŠ¡å®¹å™¨æ˜¯ä¸€ä¸ª standalone çš„å¯åŠ¨ç¨‹åºï¼Œå› ä¸ºåå°æœåŠ¡ä¸éœ€è¦ Tomcat æˆ– JBoss ç­‰ Web å®¹å™¨çš„åŠŸèƒ½ï¼Œå¦‚æœç¡¬è¦ç”¨ Web å®¹å™¨å»åŠ è½½æœåŠ¡æä¾›æ–¹ï¼Œå¢åŠ å¤æ‚æ€§ï¼Œä¹Ÿæµªè´¹èµ„æºã€‚</p>
<p>æœåŠ¡å®¹å™¨åªæ˜¯ä¸€ä¸ªç®€å•çš„ Main æ–¹æ³•ï¼Œå¹¶åŠ è½½ä¸€ä¸ªç®€å•çš„ Spring å®¹å™¨ï¼Œç”¨äºæš´éœ²æœåŠ¡ã€‚</p>
<p>æœåŠ¡å®¹å™¨çš„åŠ è½½å†…å®¹å¯ä»¥æ‰©å±•ï¼Œå†…ç½®äº† spring, jetty, log4j ç­‰åŠ è½½ï¼Œå¯é€šè¿‡å®¹å™¨<a href="http://dubbo.apache.org/zh-cn/docs/dev/content/impls/container.html" target="_blank" rel="external nofollow noopener noreferrer">æ‰©å±•ç‚¹</a>è¿›è¡Œæ‰©å±•ã€‚é…ç½®é…åœ¨ java å‘½ä»¤çš„ -D å‚æ•°æˆ–è€…&nbsp;<code>dubbo.properties</code>&nbsp;ä¸­ã€‚</p>
</blockquote>
<ul>
<li>ä»æ¦‚å¿µä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå’Œ SpringBoot ç±»ä¼¼ï¼Œæ˜¯ Dubbo æœåŠ¡çš„å¯åŠ¨å™¨ã€‚ğŸ™‚ è€ƒè™‘åˆ°ç›®å‰ Spring æ›´åŠ é€šç”¨ï¼Œæ‰€ä»¥å®é™…å®è·µæ—¶ï¼Œæ›´å¤šé‡‡ç”¨çš„æ˜¯ SpringBoot ï¼Œè€Œä¸æ˜¯ Dubbo çš„æœåŠ¡å®¹å™¨ã€‚</li>
<li><code>jetty</code>&nbsp;æœåŠ¡å®¹å™¨å®ç°å·²ç»ç§»é™¤ï¼Œæ–°å¢&nbsp;<code>logback</code>&nbsp;æœåŠ¡å®¹å™¨å®ç°ã€‚</li>
</ul>
<p>æœ¬æ–‡æ¶‰åŠå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_03_01/01.png" alt="ä¸€è§ˆ" /></p>
<h1 id="2-Container">2. Container</h1>
<p><code>com.alibaba.dubbo.container.Container</code>&nbsp;ï¼ŒæœåŠ¡å®¹å™¨<strong>æ¥å£</strong>ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@SPI</span>(<span class="string">"spring"</span>)</span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Container</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * start.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * å¯åŠ¨</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * stop.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * åœæ­¢</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>@SPI("spring")</code>&nbsp;æ³¨è§£ï¼ŒDubbo SPI&nbsp;<strong>æ‹“å±•ç‚¹</strong>ï¼Œé»˜è®¤ä¸º&nbsp;<code>"spring"</code>&nbsp;ã€‚</li>
<li>å®šä¹‰äº†å®¹å™¨çš„<strong>å¯åŠ¨</strong>å’Œ<strong>åœæ­¢</strong>ä¸¤ä¸ªæ–¹æ³•ã€‚</li>
</ul>
<h2 id="2-1-SpringContainer">2.1 SpringContainer</h2>
<p><code>com.alibaba.dubbo.container.spring.SpringContainer</code>&nbsp;ï¼Œå®ç° Container æ¥å£ï¼Œ<strong>Spring</strong>&nbsp;å®¹å™¨å®ç°ç±»ã€‚å±äº&nbsp;<code>dubbo-container-spring</code>&nbsp;é¡¹ç›®ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringContainer</span> <span class="keyword">implements</span> <span class="title">Container</span> </span>{</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(SpringContainer.class);</span><br /><span class="line"> <span class="number">4</span>: </span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 6:      * Spring é…ç½®å±æ€§ KEY</span></span><br /><span class="line"><span class="comment"> 7:      */</span></span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SPRING_CONFIG = <span class="string">"dubbo.spring.config"</span>;</span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment">10:      * é»˜è®¤é…ç½®æ–‡ä»¶åœ°å€</span></span><br /><span class="line"><span class="comment">11:      */</span></span><br /><span class="line"><span class="number">12</span>:     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SPRING_CONFIG = <span class="string">"classpath*:META-INF/spring/*.xml"</span>;</span><br /><span class="line"><span class="number">13</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment">14:      * Spring Context</span></span><br /><span class="line"><span class="comment">15:      *</span></span><br /><span class="line"><span class="comment">16:      * é™æ€å±æ€§ï¼Œå…¨å±€å”¯ä¸€</span></span><br /><span class="line"><span class="comment">17:      */</span></span><br /><span class="line"><span class="number">18</span>:     <span class="keyword">static</span> ClassPathXmlApplicationContext context;</span><br /><span class="line"><span class="number">19</span>: </span><br /><span class="line"><span class="number">20</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ClassPathXmlApplicationContext <span class="title">getContext</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">21</span>:         <span class="keyword">return</span> context;</span><br /><span class="line"><span class="number">22</span>:     }</span><br /><span class="line"><span class="number">23</span>: </span><br /><span class="line"><span class="number">24</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">25</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">26</span>:         <span class="comment">// è·å¾— Spring é…ç½®æ–‡ä»¶çš„åœ°å€</span></span><br /><span class="line"><span class="number">27</span>:         String configPath = ConfigUtils.getProperty(SPRING_CONFIG);</span><br /><span class="line"><span class="number">28</span>:         <span class="keyword">if</span> (configPath == <span class="keyword">null</span> || configPath.length() == <span class="number">0</span>) {</span><br /><span class="line"><span class="number">29</span>:             configPath = DEFAULT_SPRING_CONFIG;</span><br /><span class="line"><span class="number">30</span>:         }</span><br /><span class="line"><span class="number">31</span>:         <span class="comment">// åˆ›å»º Spring Context å¯¹è±¡</span></span><br /><span class="line"><span class="number">32</span>:         context = <span class="keyword">new</span> ClassPathXmlApplicationContext(configPath.split(<span class="string">"[,\\s]+"</span>));</span><br /><span class="line"><span class="number">33</span>:         <span class="comment">// å¯åŠ¨ Spring Context ï¼Œä¼šè§¦å‘ ContextStartedEvent äº‹ä»¶</span></span><br /><span class="line"><span class="number">34</span>:         context.start();</span><br /><span class="line"><span class="number">35</span>:     }</span><br /><span class="line"><span class="number">36</span>: </span><br /><span class="line"><span class="number">37</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">38</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">39</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">40</span>:             <span class="keyword">if</span> (context != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">41</span>:                 <span class="comment">// åœæ­¢ Spring Context ï¼Œä¼šè§¦å‘ ContextStoppedEvent äº‹ä»¶ã€‚</span></span><br /><span class="line"><span class="number">42</span>:                 context.stop();</span><br /><span class="line"><span class="number">43</span>:                 <span class="comment">// å…³é—­ Spring Context ï¼Œä¼šè§¦å‘ ContextClosedEvent äº‹ä»¶ã€‚</span></span><br /><span class="line"><span class="number">44</span>:                 context.close();</span><br /><span class="line"><span class="number">45</span>:                 context = <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">46</span>:             }</span><br /><span class="line"><span class="number">47</span>:         } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">48</span>:             logger.error(e.getMessage(), e);</span><br /><span class="line"><span class="number">49</span>:         }</span><br /><span class="line"><span class="number">50</span>:     }</span><br /><span class="line"><span class="number">51</span>: </span><br /><span class="line"><span class="number">52</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>context</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼ŒSpring Context ï¼Œå…¨å±€<strong>å”¯ä¸€</strong>ã€‚å¯é€šè¿‡&nbsp;<code>#getContext()</code>&nbsp;<strong>é™æ€</strong>æ–¹æ³•è·å–åˆ°ã€‚</li>
<li><code>SPRING_CONFIG</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼ŒSpring é…ç½®å±æ€§&nbsp;<strong>KEY</strong>ã€‚
<ul>
<li><code>DEFAULT_SPRING_CONFIG</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼Œé»˜è®¤ Spring é…ç½®æ–‡ä»¶åœ°å€ã€‚</li>
</ul>
</li>
<li><code>#start()</code>&nbsp;æ–¹æ³•ï¼Œå¯åŠ¨ Spring ã€‚ä»£ç å¦‚ä¸‹ï¼š
<ul>
<li>ç¬¬ 27 è¡Œï¼šè°ƒç”¨&nbsp;<code>ConfigUtils#getProperty(key)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— Spring é…ç½®æ–‡ä»¶çš„åœ°å€ã€‚ä¼˜å…ˆçº§ä¸ºï¼š
<ul>
<li>ã€é«˜ã€‘JVM å¯åŠ¨å‚æ•°ï¼š<code>-Ddubbo.spring.config=è‡ªå®šä¹‰ XML è·¯å¾„</code>&nbsp;ã€‚</li>
<li>ã€ä½ã€‘Dubbo Properties é…ç½®æ–‡ä»¶ï¼š<code>dubbo.spring.config=è‡ªå®šä¹‰ XML è·¯å¾„</code>&nbsp;ã€‚</li>
</ul>
</li>
<li>ç¬¬ 28 è‡³ 30 è¡Œï¼šæœªé…ç½®ï¼Œåˆ™ä½¿ç”¨é»˜è®¤è·¯å¾„&nbsp;<code>DEFAULT_SPRING_CONFIG</code>&nbsp;ã€‚</li>
<li>ç¬¬ 32 è¡Œï¼šåˆ›å»º Spring Context å¯¹è±¡ã€‚</li>
<li>ç¬¬ 34 è¡Œï¼šè°ƒç”¨&nbsp;<code>ClassPathXmlApplicationContext#start()</code>&nbsp;æ–¹æ³•ï¼Œå¯åŠ¨ Spring Context ã€‚é€šè¿‡ Spring å¯åŠ¨ï¼Œ<strong>åŠ è½½æˆ‘ä»¬çš„ Dubbo é…ç½®</strong>ï¼Œä»è€Œå¯åŠ¨ Dubbo æœåŠ¡ã€‚</li>
</ul>
</li>
<li><code>#stop()</code>&nbsp;æ–¹æ³•ï¼Œå…³é—­ Spring ã€‚ä»£ç å¦‚ä¸‹ï¼š
<ul>
<li>ç¬¬ 42 è¡Œï¼šè°ƒç”¨&nbsp;<code>ClassPathXmlApplicationContext#stop()</code>&nbsp;æ–¹æ³•ï¼Œåœæ­¢ Spring Context ã€‚</li>
<li>ç¬¬ 44 è¡Œï¼šè°ƒç”¨&nbsp;<code>ClassPathXmlApplicationContext#close()</code>&nbsp;æ–¹æ³•ï¼Œå…³é—­ Spring Context ã€‚</li>
</ul>
</li>
</ul>
<h2 id="2-2-Log4jContainer">2.2 Log4jContainer</h2>
<p><code>com.alibaba.dubbo.container.log4j.Log4jContainer</code>&nbsp;ï¼Œå®ç° Container æ¥å£ï¼Œ<strong>Log4j</strong>&nbsp;å®¹å™¨å®ç°ç±»ï¼Œ<strong>è‡ªåŠ¨é…ç½®</strong>&nbsp;log4j çš„é…ç½®ï¼Œåœ¨å¤šè¿›ç¨‹å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨ç»™æ—¥å¿—æ–‡ä»¶æŒ‰è¿›ç¨‹åˆ†ç›®å½•ã€‚å±äº&nbsp;<code>dubbo-container-log4j</code>é¡¹ç›®ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Log4jContainer</span> <span class="keyword">implements</span> <span class="title">Container</span> </span>{</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 4:      * æ—¥å¿—æ–‡ä»¶è·¯å¾„é…ç½® KEY</span></span><br /><span class="line"><span class="comment"> 5:      */</span></span><br /><span class="line"> <span class="number">6</span>:     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG4J_FILE = <span class="string">"dubbo.log4j.file"</span>;</span><br /><span class="line"> <span class="number">7</span>: </span><br /><span class="line"> <span class="number">8</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 9:      * æ—¥å¿—å­ç›®å½•å¾„é…ç½® KEY</span></span><br /><span class="line"><span class="comment">10:      */</span></span><br /><span class="line"><span class="number">11</span>:     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG4J_SUBDIRECTORY = <span class="string">"dubbo.log4j.subdirectory"</span>;</span><br /><span class="line"><span class="number">12</span>: </span><br /><span class="line"><span class="number">13</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment">14:      * æ—¥å¿—çº§åˆ«é…ç½® KEY</span></span><br /><span class="line"><span class="comment">15:      */</span></span><br /><span class="line"><span class="number">16</span>:     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOG4J_LEVEL = <span class="string">"dubbo.log4j.level"</span>;</span><br /><span class="line"><span class="number">17</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment">18:      * é»˜è®¤æ—¥å¿—çº§åˆ« - ERROR</span></span><br /><span class="line"><span class="comment">19:      */</span></span><br /><span class="line"><span class="number">20</span>:     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_LOG4J_LEVEL = <span class="string">"ERROR"</span>;</span><br /><span class="line"><span class="number">21</span>: </span><br /><span class="line"><span class="number">22</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">23</span>:     <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line"><span class="number">24</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">25</span>:         <span class="comment">// è·å¾— log4j é…ç½®çš„æ—¥å¿—æ–‡ä»¶è·¯å¾„</span></span><br /><span class="line"><span class="number">26</span>:         String file = ConfigUtils.getProperty(LOG4J_FILE);</span><br /><span class="line"><span class="number">27</span>:         <span class="keyword">if</span> (file != <span class="keyword">null</span> &amp;&amp; file.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">28</span>:             <span class="comment">// è·å¾—æ—¥å¿—çº§åˆ«</span></span><br /><span class="line"><span class="number">29</span>:             String level = ConfigUtils.getProperty(LOG4J_LEVEL);</span><br /><span class="line"><span class="number">30</span>:             <span class="keyword">if</span> (level == <span class="keyword">null</span> || level.length() == <span class="number">0</span>) {</span><br /><span class="line"><span class="number">31</span>:                 level = DEFAULT_LOG4J_LEVEL;</span><br /><span class="line"><span class="number">32</span>:             }</span><br /><span class="line"><span class="number">33</span>:             <span class="comment">// åˆ›å»ºæ—¥å¿— Properties å¯¹è±¡ï¼Œå¹¶è®¾ç½®åˆ° PropertyConfigurator ä¸­ã€‚</span></span><br /><span class="line"><span class="number">34</span>:             Properties properties = <span class="keyword">new</span> Properties();</span><br /><span class="line"><span class="number">35</span>:             properties.setProperty(<span class="string">"log4j.rootLogger"</span>, level + <span class="string">",application"</span>); <span class="comment">// æ—¥å¿—çº§åˆ«</span></span><br /><span class="line"><span class="number">36</span>:             <span class="comment">// log4j.appender.application çš„é…ç½®</span></span><br /><span class="line"><span class="number">37</span>:             properties.setProperty(<span class="string">"log4j.appender.application"</span>, <span class="string">"org.apache.log4j.DailyRollingFileAppender"</span>); <span class="comment">// DailyRollingFileAppender</span></span><br /><span class="line"><span class="number">38</span>:             properties.setProperty(<span class="string">"log4j.appender.application.File"</span>, file); <span class="comment">// æ—¥å¿—æ–‡ä»¶è·¯å¾„</span></span><br /><span class="line"><span class="number">39</span>:             properties.setProperty(<span class="string">"log4j.appender.application.Append"</span>, <span class="string">"true"</span>);</span><br /><span class="line"><span class="number">40</span>:             properties.setProperty(<span class="string">"log4j.appender.application.DatePattern"</span>, <span class="string">"'.'yyyy-MM-dd"</span>);</span><br /><span class="line"><span class="number">41</span>:             properties.setProperty(<span class="string">"log4j.appender.application.layout"</span>, <span class="string">"org.apache.log4j.PatternLayout"</span>);</span><br /><span class="line"><span class="number">42</span>:             properties.setProperty(<span class="string">"log4j.appender.application.layout.ConversionPattern"</span>, <span class="string">"%d [%t] %-5p %C{6} (%F:%L) - %m%n"</span>);</span><br /><span class="line"><span class="number">43</span>:             PropertyConfigurator.configure(properties);</span><br /><span class="line"><span class="number">44</span>:         }</span><br /><span class="line"><span class="number">45</span>:         <span class="comment">// è·å¾—æ—¥å¿—å­ç›®å½•ï¼Œç”¨äºå¤šè¿›ç¨‹å¯åŠ¨ï¼Œé¿å…å†²çªã€‚</span></span><br /><span class="line"><span class="number">46</span>:         String subdirectory = ConfigUtils.getProperty(LOG4J_SUBDIRECTORY);</span><br /><span class="line"><span class="number">47</span>:         <span class="keyword">if</span> (subdirectory != <span class="keyword">null</span> &amp;&amp; subdirectory.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">48</span>:             <span class="comment">// å¾ªç¯æ¯ä¸ª Logger å¯¹è±¡</span></span><br /><span class="line"><span class="number">49</span>:             Enumeration&lt;org.apache.log4j.Logger&gt; ls = LogManager.getCurrentLoggers();</span><br /><span class="line"><span class="number">50</span>:             <span class="keyword">while</span> (ls.hasMoreElements()) {</span><br /><span class="line"><span class="number">51</span>:                 org.apache.log4j.Logger l = ls.nextElement();</span><br /><span class="line"><span class="number">52</span>:                 <span class="keyword">if</span> (l != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">53</span>:                     <span class="comment">// å¾ªç¯æ¯ä¸ª Logger å¯¹è±¡çš„ Appender å¯¹è±¡</span></span><br /><span class="line"><span class="number">54</span>:                     Enumeration&lt;Appender&gt; as = l.getAllAppenders();</span><br /><span class="line"><span class="number">55</span>:                     <span class="keyword">while</span> (as.hasMoreElements()) {</span><br /><span class="line"><span class="number">56</span>:                         Appender a = as.nextElement();</span><br /><span class="line"><span class="number">57</span>:                         <span class="keyword">if</span> (a <span class="keyword">instanceof</span> FileAppender) { <span class="comment">// å½“ä¸”ä»…å½“ FileAppender æ—¶</span></span><br /><span class="line"><span class="number">58</span>:                             FileAppender fa = (FileAppender) a;</span><br /><span class="line"><span class="number">59</span>:                             String f = fa.getFile();</span><br /><span class="line"><span class="number">60</span>:                             <span class="keyword">if</span> (f != <span class="keyword">null</span> &amp;&amp; f.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">61</span>:                                 <span class="keyword">int</span> i = f.replace(<span class="string">'\\'</span>, <span class="string">'/'</span>).lastIndexOf(<span class="string">'/'</span>);</span><br /><span class="line"><span class="number">62</span>:                                 <span class="comment">// æ‹¼æ¥æ—¥å¿—å­ç›®å½•</span></span><br /><span class="line"><span class="number">63</span>:                                 String path;</span><br /><span class="line"><span class="number">64</span>:                                 <span class="keyword">if</span> (i == -<span class="number">1</span>) { <span class="comment">// æ— è·¯å¾„</span></span><br /><span class="line"><span class="number">65</span>:                                     path = subdirectory;</span><br /><span class="line"><span class="number">66</span>:                                 } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">67</span>:                                     path = f.substring(<span class="number">0</span>, i);</span><br /><span class="line"><span class="number">68</span>:                                     <span class="keyword">if</span> (!path.endsWith(subdirectory)) { <span class="comment">// å·²ç»æ˜¯ subdirectory ç»“å°¾ï¼Œåˆ™ä¸ç”¨æ‹¼æ¥</span></span><br /><span class="line"><span class="number">69</span>:                                         path = path + <span class="string">"/"</span> + subdirectory;</span><br /><span class="line"><span class="number">70</span>:                                     }</span><br /><span class="line"><span class="number">71</span>:                                     f = f.substring(i + <span class="number">1</span>);</span><br /><span class="line"><span class="number">72</span>:                                 }</span><br /><span class="line"><span class="number">73</span>:                                 <span class="comment">// è®¾ç½®æ–°çš„æ–‡ä»¶å</span></span><br /><span class="line"><span class="number">74</span>:                                 fa.setFile(path + <span class="string">"/"</span> + f);</span><br /><span class="line"><span class="number">75</span>:                                 <span class="comment">// ç”Ÿæ•ˆé…ç½®</span></span><br /><span class="line"><span class="number">76</span>:                                 fa.activateOptions();</span><br /><span class="line"><span class="number">77</span>:                             }</span><br /><span class="line"><span class="number">78</span>:                         }</span><br /><span class="line"><span class="number">79</span>:                     }</span><br /><span class="line"><span class="number">80</span>:                 }</span><br /><span class="line"><span class="number">81</span>:             }</span><br /><span class="line"><span class="number">82</span>:         }</span><br /><span class="line"><span class="number">83</span>:     }</span><br /><span class="line"><span class="number">84</span>: </span><br /><span class="line"><span class="number">85</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">86</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">87</span>:     }</span><br /><span class="line"><span class="number">88</span>: </span><br /><span class="line"><span class="number">89</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>LOG4J_FILE</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼Œæ—¥å¿—æ–‡ä»¶è·¯å¾„é…ç½® KEY ã€‚ä¾‹å¦‚ï¼š<code>dubbo.log4j.file=/foo/bar.log</code>&nbsp;ã€‚</li>
<li><code>LOG4J_SUBDIRECTORY</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼Œæ—¥å¿—å­ç›®å½•å¾„é…ç½® KEY ã€‚ä¾‹å¦‚ï¼š<code>dubbo.log4j.subdirectory=20880</code>&nbsp;ã€‚
<ul>
<li>Log4j åœ¨<strong>å¤šè¿›ç¨‹</strong>å†™å…¥<strong>åŒä¸€</strong>æ—¥å¿—æ–‡ä»¶ï¼Œæç«¯æƒ…å†µä¼šå­˜åœ¨ä¸¢å¤±é—®é¢˜ï¼Œå‚è§&nbsp;<a href="http://hellojavaer.iteye.com/blog/977599" target="_blank" rel="external nofollow noopener noreferrer">ã€Šå¤šè¿›ç¨‹log4jæ—¥å¿—ä¸¢å¤±é—®é¢˜åˆ†æã€‹</a>&nbsp;æ–‡ç« çš„åˆ†æã€‚</li>
</ul>
</li>
<li><code>LOG4J_LEVEL</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼Œæ—¥å¿—çº§åˆ«é…ç½® KEYã€‚ä¾‹å¦‚ï¼š<code>dubbo.log4j.level=WARN</code>&nbsp;ã€‚
<ul>
<li><code>DEFAULT_LOG4J_LEVEL</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼Œ é»˜è®¤æ—¥å¿—çº§åˆ«ï¼Œ<strong>ERROR</strong>&nbsp;ã€‚</li>
</ul>
</li>
<li><code>#start()</code>&nbsp;æ–¹æ³•ï¼Œ<strong>è‡ªåŠ¨é…ç½®</strong>&nbsp;log4j çš„é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š
<ul>
<li>ç¬¬ 26 è¡Œï¼šè·å¾— log4j é…ç½®çš„<strong>æ—¥å¿—æ–‡ä»¶è·¯å¾„</strong>ã€‚</li>
<li>ç¬¬ 28 è‡³ 32 è¡Œï¼šè·å¾—æ—¥å¿—<strong>çº§åˆ«</strong>ã€‚</li>
<li>ç¬¬ 33 è‡³ 43 è¡Œï¼šåˆ›å»ºæ—¥å¿— Properties å¯¹è±¡ï¼Œå¹¶è®¾ç½®åˆ°&nbsp;<code>org.apache.log4j.PropertyConfigurator</code>&nbsp;ä¸­ã€‚</li>
<li>ç¬¬ 45 è‡³ 82 è¡Œï¼šè·å¾—æ—¥å¿—<strong>å­ç›®å½•</strong>ï¼Œç”¨äºå¤šè¿›ç¨‹å¯åŠ¨ï¼Œé¿å…å†²çªã€‚</li>
</ul>
</li>
<li><code>#stop()</code>&nbsp;æ–¹æ³•ï¼Œç©ºå®ç°ã€‚å› ä¸ºï¼Œæ— éœ€å…³é—­ã€‚</li>
</ul>
<h2 id="2-3-LogbackContainer">2.3 LogbackContainer</h2>
<p><code>com.alibaba.dubbo.container.logback.LogbackContainer</code>&nbsp;ï¼Œå®ç° Container æ¥å£ï¼Œ<strong>Logback</strong>&nbsp;å®¹å™¨å®ç°ç±»ï¼Œ<strong>è‡ªåŠ¨é…ç½®</strong>&nbsp;logback çš„é…ç½®ï¼Œè‡ªåŠ¨é€‚é… logback çš„é…ç½®ã€‚å±äº&nbsp;<code>dubbo-container-logback</code>&nbsp;é¡¹ç›®ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogbackContainer</span> <span class="keyword">implements</span> <span class="title">Container</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ—¥å¿—æ–‡ä»¶è·¯å¾„é…ç½® KEY</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOGBACK_FILE = <span class="string">"dubbo.logback.file"</span>;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ—¥å¿—ä¿ç•™å¤©æ•°é…ç½® KEY</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOGBACK_MAX_HISTORY = <span class="string">"dubbo.logback.maxhistory"</span>;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ—¥å¿—çº§åˆ«é…ç½® KEY</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String LOGBACK_LEVEL = <span class="string">"dubbo.logback.level"</span>;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * é»˜è®¤æ—¥å¿—çº§åˆ« - ERROR</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_LOGBACK_LEVEL = <span class="string">"ERROR"</span>;</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="comment">// è·å¾— logback é…ç½®çš„æ—¥å¿—æ–‡ä»¶è·¯å¾„</span></span><br /><span class="line">        String file = ConfigUtils.getProperty(LOGBACK_FILE);</span><br /><span class="line">        <span class="keyword">if</span> (file != <span class="keyword">null</span> &amp;&amp; file.length() &gt; <span class="number">0</span>) {</span><br /><span class="line">            <span class="comment">// è·å¾—æ—¥å¿—çº§åˆ«</span></span><br /><span class="line">            String level = ConfigUtils.getProperty(LOGBACK_LEVEL);</span><br /><span class="line">            <span class="keyword">if</span> (level == <span class="keyword">null</span> || level.length() == <span class="number">0</span>) {</span><br /><span class="line">                level = DEFAULT_LOGBACK_LEVEL;</span><br /><span class="line">            }</span><br /><span class="line">            <span class="comment">// è·å¾—æ—¥å¿—ä¿ç•™å¤©æ•°ã€‚è‹¥ä¸ºé›¶ï¼Œåˆ™æ— é™å¤©æ•°</span></span><br /><span class="line">            <span class="comment">// maxHistory=0 Infinite history</span></span><br /><span class="line">            <span class="keyword">int</span> maxHistory = StringUtils.parseInteger(ConfigUtils.getProperty(LOGBACK_MAX_HISTORY));</span><br /><span class="line">            <span class="comment">// åˆå§‹åŒ– logback</span></span><br /><span class="line">            doInitializer(file, level, maxHistory);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Initializer logback</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * åˆå§‹åŒ– logback</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> file æ—¥å¿—æ–‡ä»¶è·¯å¾„</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> level æ—¥å¿—çº§åˆ«</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> maxHistory æ—¥å¿—ä¿ç•™å¤©æ•°</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doInitializer</span><span class="params">(String file, String level, <span class="keyword">int</span> maxHistory)</span> </span>{</span><br /><span class="line">        LoggerContext loggerContext = (LoggerContext) LoggerFactory.getILoggerFactory();</span><br /><span class="line">        Logger rootLogger = loggerContext.getLogger(Logger.ROOT_LOGGER_NAME);</span><br /><span class="line">        rootLogger.detachAndStopAllAppenders();</span><br /><br /><span class="line">        <span class="comment">// appender</span></span><br /><span class="line">        RollingFileAppender&lt;ILoggingEvent&gt; fileAppender = <span class="keyword">new</span> RollingFileAppender&lt;ILoggingEvent&gt;();</span><br /><span class="line">        fileAppender.setContext(loggerContext);</span><br /><span class="line">        fileAppender.setName(<span class="string">"application"</span>);</span><br /><span class="line">        fileAppender.setFile(file);</span><br /><span class="line">        fileAppender.setAppend(<span class="keyword">true</span>);</span><br /><br /><span class="line">        <span class="comment">// policy</span></span><br /><span class="line">        TimeBasedRollingPolicy&lt;ILoggingEvent&gt; policy = <span class="keyword">new</span> TimeBasedRollingPolicy&lt;ILoggingEvent&gt;();</span><br /><span class="line">        policy.setContext(loggerContext);</span><br /><span class="line">        policy.setMaxHistory(maxHistory);</span><br /><span class="line">        policy.setFileNamePattern(file + <span class="string">".%d{yyyy-MM-dd}"</span>);</span><br /><span class="line">        policy.setParent(fileAppender);</span><br /><span class="line">        policy.start();</span><br /><span class="line">        fileAppender.setRollingPolicy(policy);</span><br /><br /><span class="line">        <span class="comment">// encoder</span></span><br /><span class="line">        PatternLayoutEncoder encoder = <span class="keyword">new</span> PatternLayoutEncoder();</span><br /><span class="line">        encoder.setContext(loggerContext);</span><br /><span class="line">        encoder.setPattern(<span class="string">"%date [%thread] %-5level %logger (%file:%line\\) - %msg%n"</span>);</span><br /><span class="line">        encoder.start();</span><br /><span class="line">        fileAppender.setEncoder(encoder);</span><br /><br /><span class="line">        fileAppender.start();</span><br /><br /><span class="line">        rootLogger.addAppender(fileAppender);</span><br /><span class="line">        rootLogger.setLevel(Level.toLevel(level));</span><br /><span class="line">        rootLogger.setAdditive(<span class="keyword">false</span>);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> </span>{</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>LOGBACK_FILE</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼Œæ—¥å¿—æ–‡ä»¶è·¯å¾„é…ç½® KEY ã€‚ä¾‹å¦‚ï¼š<code>dubbo.logback.file=/foo/bar.log</code>&nbsp;ã€‚</li>
<li><code>LOGBACK_MAX_HISTORY</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼Œæ—¥å¿—ä¿ç•™å¤©æ•°é…ç½® KEYã€‚ä¾‹å¦‚ï¼š<code>dubbo.logback.maxhistory=15</code>&nbsp;ã€‚</li>
<li><code>LOGBACK_LEVEL</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼Œæ—¥å¿—çº§åˆ«é…ç½® KEYã€‚ä¾‹å¦‚ï¼š<code>dubbo.logback.level=WARN</code>&nbsp;ã€‚
<ul>
<li><code>DEFAULT_LOGBACK_LEVEL</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼Œ é»˜è®¤æ—¥å¿—çº§åˆ«ï¼Œ<strong>ERROR</strong>&nbsp;ã€‚</li>
</ul>
</li>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œå’Œ Log4jContainer æ€è·¯ä¸€è‡´ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚å¦‚æœå¯¹ Logback ä¸äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹&nbsp;<a href="http://webinglin.github.io/2015/06/04/Logback-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠLogbackèƒŒæ™¯ã€‹</a>&nbsp;æ–‡ç« ã€‚</li>
</ul>
<h1 id="3-Main">3. Main</h1>
<p><code>com.alibaba.dubbo.container.Main</code>&nbsp;ï¼Œå¯åŠ¨ç¨‹åºï¼Œè´Ÿè´£åˆå§‹åŒ– Container æœåŠ¡å®¹å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>{</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(Main.class);</span><br /><span class="line"> <span class="number">4</span>: </span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 6:      * Container é…ç½® KEY</span></span><br /><span class="line"><span class="comment"> 7:      */</span></span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONTAINER_KEY = <span class="string">"dubbo.container"</span>;</span><br /><span class="line"> <span class="number">9</span>: </span><br /><span class="line"><span class="number">10</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment">11:      * ShutdownHook æ˜¯å¦å¼€å¯é…ç½® KEY</span></span><br /><span class="line"><span class="comment">12:      */</span></span><br /><span class="line"><span class="number">13</span>:     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SHUTDOWN_HOOK_KEY = <span class="string">"dubbo.shutdown.hook"</span>;</span><br /><span class="line"><span class="number">14</span>: </span><br /><span class="line"><span class="number">15</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment">16:      * Container æ‹“å±•ç‚¹å¯¹åº”çš„ ExtensionLoader å¯¹è±¡</span></span><br /><span class="line"><span class="comment">17:      */</span></span><br /><span class="line"><span class="number">18</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ExtensionLoader&lt;Container&gt; loader = ExtensionLoader.getExtensionLoader(Container.class);</span><br /><span class="line"><span class="number">19</span>: </span><br /><span class="line"><span class="number">20</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReentrantLock LOCK = <span class="keyword">new</span> ReentrantLock();</span><br /><span class="line"><span class="number">21</span>: </span><br /><span class="line"><span class="number">22</span>:     <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Condition STOP = LOCK.newCondition();</span><br /><span class="line"><span class="number">23</span>: </span><br /><span class="line"><span class="number">24</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br /><span class="line"><span class="number">25</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">26</span>:             <span class="comment">// è‹¥ main å‡½æ•°å‚æ•°ä¼ å…¥ä¸ºç©ºï¼Œä»é…ç½®ä¸­åŠ è½½ã€‚</span></span><br /><span class="line"><span class="number">27</span>:             <span class="keyword">if</span> (args == <span class="keyword">null</span> || args.length == <span class="number">0</span>) {</span><br /><span class="line"><span class="number">28</span>:                 String config = ConfigUtils.getProperty(CONTAINER_KEY, loader.getDefaultExtensionName()); <span class="comment">// é»˜è®¤ "spring"</span></span><br /><span class="line"><span class="number">29</span>:                 args = Constants.COMMA_SPLIT_PATTERN.split(config);</span><br /><span class="line"><span class="number">30</span>:             }</span><br /><span class="line"><span class="number">31</span>: </span><br /><span class="line"><span class="number">32</span>:             <span class="comment">// åŠ è½½å®¹å™¨æ•°ç»„</span></span><br /><span class="line"><span class="number">33</span>:             <span class="keyword">final</span> List&lt;Container&gt; containers = <span class="keyword">new</span> ArrayList&lt;Container&gt;();</span><br /><span class="line"><span class="number">34</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) {</span><br /><span class="line"><span class="number">35</span>:                 containers.add(loader.getExtension(args[i]));</span><br /><span class="line"><span class="number">36</span>:             }</span><br /><span class="line"><span class="number">37</span>:             logger.info(<span class="string">"Use container type("</span> + Arrays.toString(args) + <span class="string">") to run dubbo serivce."</span>);</span><br /><span class="line"><span class="number">38</span>: </span><br /><span class="line"><span class="number">39</span>:             <span class="comment">// ShutdownHook</span></span><br /><span class="line"><span class="number">40</span>:             <span class="keyword">if</span> (<span class="string">"true"</span>.equals(System.getProperty(SHUTDOWN_HOOK_KEY))) {</span><br /><span class="line"><span class="number">41</span>:                 Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread() {</span><br /><span class="line"><span class="number">42</span>: </span><br /><span class="line"><span class="number">43</span>:                     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">44</span>:                     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">45</span>:                         <span class="keyword">for</span> (Container container : containers) {</span><br /><span class="line"><span class="number">46</span>:                             <span class="comment">// å…³é—­å®¹å™¨</span></span><br /><span class="line"><span class="number">47</span>:                             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">48</span>:                                 container.stop();</span><br /><span class="line"><span class="number">49</span>:                                 logger.info(<span class="string">"Dubbo "</span> + container.getClass().getSimpleName() + <span class="string">" stopped!"</span>);</span><br /><span class="line"><span class="number">50</span>:                             } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">51</span>:                                 logger.error(t.getMessage(), t);</span><br /><span class="line"><span class="number">52</span>:                             }</span><br /><span class="line"><span class="number">53</span>:                             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">54</span>:                                 <span class="comment">// è·å¾— ReentrantLock</span></span><br /><span class="line"><span class="number">55</span>:                                 LOCK.lock();</span><br /><span class="line"><span class="number">56</span>:                                 <span class="comment">// å”¤é†’ Main ä¸»çº¿ç¨‹çš„ç­‰å¾…</span></span><br /><span class="line"><span class="number">57</span>:                                 STOP.signal();</span><br /><span class="line"><span class="number">58</span>:                             } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">59</span>:                                 <span class="comment">// é‡Šæ”¾ ReentrantLock</span></span><br /><span class="line"><span class="number">60</span>:                                 LOCK.unlock();</span><br /><span class="line"><span class="number">61</span>:                             }</span><br /><span class="line"><span class="number">62</span>:                         }</span><br /><span class="line"><span class="number">63</span>:                     }</span><br /><span class="line"><span class="number">64</span>:                     </span><br /><span class="line"><span class="number">65</span>:                 });</span><br /><span class="line"><span class="number">66</span>:             }</span><br /><span class="line"><span class="number">67</span>: </span><br /><span class="line"><span class="number">68</span>:             <span class="comment">// å¯åŠ¨å®¹å™¨</span></span><br /><span class="line"><span class="number">69</span>:             <span class="keyword">for</span> (Container container : containers) {</span><br /><span class="line"><span class="number">70</span>:                 container.start();</span><br /><span class="line"><span class="number">71</span>:                 logger.info(<span class="string">"Dubbo "</span> + container.getClass().getSimpleName() + <span class="string">" started!"</span>);</span><br /><span class="line"><span class="number">72</span>:             }</span><br /><span class="line"><span class="number">73</span>: </span><br /><span class="line"><span class="number">74</span>:             <span class="comment">// è¾“å‡ºæç¤ºï¼Œå¯åŠ¨æˆåŠŸ</span></span><br /><span class="line"><span class="number">75</span>:             System.out.println(<span class="keyword">new</span> SimpleDateFormat(<span class="string">"[yyyy-MM-dd HH:mm:ss]"</span>).format(<span class="keyword">new</span> Date()) + <span class="string">" Dubbo service server started!"</span>);</span><br /><span class="line"><span class="number">76</span>:         } <span class="keyword">catch</span> (RuntimeException e) {</span><br /><span class="line"><span class="number">77</span>:             <span class="comment">// å‘ç”Ÿå¼‚å¸¸ï¼ŒJVM é€€å‡º</span></span><br /><span class="line"><span class="number">78</span>:             e.printStackTrace();</span><br /><span class="line"><span class="number">79</span>:             logger.error(e.getMessage(), e);</span><br /><span class="line"><span class="number">80</span>:             System.exit(<span class="number">1</span>);</span><br /><span class="line"><span class="number">81</span>:         }</span><br /><span class="line"><span class="number">82</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">83</span>:             <span class="comment">// è·å¾— ReentrantLock</span></span><br /><span class="line"><span class="number">84</span>:             LOCK.lock();</span><br /><span class="line"><span class="number">85</span>:             <span class="comment">// é‡Šæ”¾é”ï¼Œå¹¶ä¸”å°†è‡ªå·±æ²‰ç¡ï¼Œç­‰å¾…å”¤é†’</span></span><br /><span class="line"><span class="number">86</span>:             STOP.await();</span><br /><span class="line"><span class="number">87</span>:         } <span class="keyword">catch</span> (InterruptedException e) {</span><br /><span class="line"><span class="number">88</span>:             logger.warn(<span class="string">"Dubbo service server stopped, interrupted by other thread!"</span>, e);</span><br /><span class="line"><span class="number">89</span>:         } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">90</span>:             <span class="comment">// é‡Šæ”¾ ReentrantLock</span></span><br /><span class="line"><span class="number">91</span>:             LOCK.unlock();</span><br /><span class="line"><span class="number">92</span>:         }</span><br /><span class="line"><span class="number">93</span>:     }</span><br /><span class="line"><span class="number">94</span>: </span><br /><span class="line"><span class="number">95</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>CONTAINER_KEY</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼ŒContainer é…ç½® KEY ã€‚ä¾‹å¦‚ï¼š<code>dubbo.container=spring,jetty,log4j</code>&nbsp;ã€‚</li>
<li><code>SHUTDOWN_HOOK_KEY</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼ŒShutdownHook æ˜¯å¦å¼€å¯é…ç½® KEYã€‚ä¾‹å¦‚ï¼š<code>-Ddubbo.shutdown.hook=true</code>ã€‚</li>
<li><code>loader</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼ŒContainer æ‹“å±•ç‚¹å¯¹åº”çš„ ExtensionLoader å¯¹è±¡ã€‚</li>
<li><code>#main(args)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>åˆå§‹åŒ–</strong>&nbsp;Container æœåŠ¡å®¹å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š
<ul>
<li>ç¬¬ 24 è¡Œï¼š<code>args</code>&nbsp;å¯åŠ¨å‚æ•°ï¼Œå¯é…ç½®è¦åŠ è½½çš„å®¹å™¨ã€‚ä¾‹å¦‚ï¼Œ<code>java com.alibaba.dubbo.container.Main spring jetty log4j</code>&nbsp;ã€‚</li>
<li>ç¬¬ 26 è‡³ 30 è¡Œï¼šè‹¥&nbsp;<code>args</code>&nbsp;ä¸ºç©ºï¼Œä»é…ç½®ä¸­åŠ è½½ã€‚ä¾‹å¦‚ï¼š<code>dubbo.container=spring,jetty,log4j</code>&nbsp;ã€‚è‹¥è·å–ä¸åˆ°ï¼Œä½¿ç”¨ Container çš„<strong>é»˜è®¤</strong>æ‹“å±•&nbsp;<code>"spring"</code>&nbsp;ã€‚</li>
<li>ç¬¬ 32 è‡³ 37 è¡Œï¼šä½¿ç”¨ Dubbo SPI æœºåˆ¶ï¼ŒåŠ è½½é…ç½®çš„ Container å¯¹è±¡ã€‚</li>
<li>ç¬¬ 68 è‡³ 72 è¡Œï¼šå¾ªç¯è°ƒç”¨&nbsp;<code>Container#start()</code>&nbsp;æ–¹æ³•ï¼Œå¯åŠ¨å®¹å™¨ã€‚</li>
<li>ç¬¬ 75 è¡Œï¼šè¾“å‡ºæç¤ºï¼Œå¯åŠ¨<strong>æˆåŠŸ</strong>ã€‚</li>
<li>ç¬¬ 76 è‡³ 81 è¡Œï¼šè‹¥å‘ç”Ÿå¼‚å¸¸ï¼Œæ‰“å°é”™è¯¯æ—¥å¿—ï¼Œå¹¶ JVM é€€å‡ºã€‚</li>
<li>ç¬¬ 84 è¡Œï¼šè°ƒç”¨&nbsp;<code>ReentrantLock#lock()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— ReentrantLock ã€‚</li>
<li>ç¬¬ 86 è¡Œï¼šè°ƒç”¨&nbsp;<code>Condition#await()</code>&nbsp;æ–¹æ³•ï¼Œ<strong>é‡Šæ”¾</strong>é”ï¼Œå¹¶ä¸”å°†è‡ªå·±<strong>æ²‰ç¡</strong>ï¼Œç­‰å¾…<strong>å”¤é†’</strong>ã€‚</li>
<li>========== ShutdownHook ==========</li>
<li>ç¬¬ 40 è‡³ 41 è¡Œï¼šå½“é…ç½® JVM å¯åŠ¨å‚æ•°å¸¦æœ‰&nbsp;<code>Ddubbo.shutdown.hook=true</code>&nbsp;æ—¶ï¼Œæ·»åŠ å…³é—­çš„ ShutdownHook ã€‚
<ul>
<li>å½“è¯»åˆ°æ­¤å¤„æ—¶ï¼Œè€è‰¿è‰¿å°±æœ‰ä¸ªç–‘æƒ‘ï¼Œå¦‚æœä¸å¼€å¯ ShutdownHook ï¼Œé‚£å²‚ä¸æ˜¯ Main ä¸€ç›´ç­‰å¾…ï¼ŒJVM æ— æ³•ç»“æŸäº†ï¼ŸğŸ™‚ ç­”æ¡ˆå®é™…æ˜¯ä¸ä¼šï¼ŒJVM æ­£å¸¸é€€å‡ºæ—¶ï¼Œä¾‹å¦‚ä½¿ç”¨&nbsp;<code>kill pid</code>&nbsp;æŒ‡å®šï¼Œåªè¦ ShutdownHook å…¨éƒ¨æ‰§è¡Œå®Œæˆå³å¯é€€å‡ºï¼Œæ— éœ€ Main å‡½æ•°æ‰§è¡Œå®Œæˆã€‚å¦‚æœæ²¡æœ‰ ShutdownHook ï¼Œé‚£å°±ç›´æ¥é€€å‡ºã€‚</li>
<li>é‚£ä¹ˆ Main çš„<strong>ç­‰å¾…å”¤é†’</strong>æœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿå¦‚æœã€ç¬¬ 86 è¡Œã€‘ä¸è¿›è¡Œç­‰å¾…ï¼ŒMain æ‰§è¡Œå®Œæˆï¼Œå°±ä¼šè§¦å‘ JVM é€€å‡ºï¼Œå¯¼è‡´ Dubbo æœåŠ¡é€€å‡ºã€‚æ‰€ä»¥ç›¸å½“äºï¼Œèµ·åˆ°äº† JVM è¿›ç¨‹å¸¸é©»çš„ä½œç”¨ã€‚</li>
</ul>
</li>
<li>ç¬¬ 45 è‡³ 52 è¡Œï¼šè°ƒç”¨&nbsp;<code>Container#stop()</code>&nbsp;æ–¹æ³•ï¼Œå…³é—­å®¹å™¨ã€‚</li>
<li>ç¬¬ 53 è‡³ 61 è¡Œï¼šè°ƒç”¨&nbsp;<code>Condition#signal()</code>&nbsp;æ–¹æ³•ï¼Œå”¤é†’ Main çš„ç­‰å¾…ã€‚</li>
</ul>
</li>
<li>åœ¨<strong>æ—©æœŸç‰ˆæœ¬</strong>&nbsp;çš„ Main å®ç°ï¼Œç­‰å¾…å”¤é†’åŸºäº&nbsp;<strong>Main.class çš„ wait/notify</strong>&nbsp;æœºåˆ¶å®ç°ã€‚è€ƒè™‘åˆ°å®‰å…¨æ€§ï¼Œ<code>Main.class#notify()</code>&nbsp;æ–¹æ³•ï¼Œå¯ä»¥è¢«ä»»æ„ä»£ç è®¿é—®ï¼Œå¯¼è‡´éæ­£å¸¸é€€å‡ºã€‚æ‰€ä»¥æ”¹æˆäº† ReentrantLock + Condition æ¥å®ç°ã€‚å€¼å¾—å€Ÿé‰´ã€‚è¯¦ç»†å‚è§&nbsp;<a href="https://github.com/apache/incubator-dubbo/pull/520" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠISSUE#520 shutdown with count down latchã€‹</a>&nbsp;ã€‚</li>
</ul>
<h1 id="4-å¯åŠ¨ä¸æš‚åœ">4. å¯åŠ¨ä¸æš‚åœ</h1>
<p>åœ¨&nbsp;<code>dubbo-container-api</code>&nbsp;é¡¹ç›®ï¼Œ<a href="https://github.com/apache/incubator-dubbo/tree/1de21470c95c9bf3724b39b79a0cc53eeb0594ce/dubbo-container/dubbo-container-api/src/main/resources/META-INF/assembly/bin" target="_blank" rel="external nofollow noopener noreferrer"><code>resources/META-INF/assembly/bin/</code></a>&nbsp;ä¸‹ï¼Œæä¾›äº†è„šæœ¬ï¼š</p>
<ul>
<li><code>start.sh</code></li>
<li><code>stop.sh</code></li>
<li><code>restart.sh</code></li>
<li><code>dump.sh</code></li>
</ul>
<blockquote>
<p>è¿˜æœ‰ä¸€ä¸ª&nbsp;<code>server.sh</code>&nbsp;ï¼Œæ˜¯æ ¹æ®<strong>å‚æ•°</strong>ï¼Œè°ƒç”¨ä¸Šè¿°è„šæœ¬ã€‚</p>
</blockquote>
<p>ğŸ™‚ ç¥ç§˜çš„å¾®ç¬‘ã€‚è¯¦ç»†è§£æï¼Œå‚è§&nbsp;<a href="https://blog.csdn.net/evankaka/article/details/61617483" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubboåº”ç”¨å¯åŠ¨ä¸åœæ­¢è„šæœ¬,è¶…è¯¦ç»†è§£æã€‹</a>&nbsp;æ–‡ç« ã€‚</p>
<h1 id="666-å½©è›‹">666. å½©è›‹</h1>
<p>æ¨èé˜…è¯»ï¼š</p>
<ul>
<li><a href="https://blog.csdn.net/vernonzheng/article/details/8288251" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠJavaå¤šçº¿ç¨‹ï¼ˆä¹ï¼‰ä¹‹ReentrantLockä¸Conditionã€‹</a></li>
<li><a href="https://www.cnkirito.moe/2018/01/14/gracefully-shutdown/" target="_blank" rel="external nofollow noopener noreferrer">ã€Šç ”ç©¶ä¼˜é›…åœæœºæ—¶çš„ä¸€ç‚¹æ€è€ƒã€‹</a></li>
</ul>
</div>
</header>