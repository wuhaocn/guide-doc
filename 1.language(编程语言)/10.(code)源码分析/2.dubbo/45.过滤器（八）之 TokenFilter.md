# è¿‡æ»¤å™¨ï¼ˆå…«ï¼‰ä¹‹ TokenFilter

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº« TokenFilter è¿‡æ»¤å™¨ï¼Œç”¨äºæœåŠ¡**æä¾›è€…**ä¸­ï¼Œæä¾› **ä»¤ç‰ŒéªŒè¯** çš„åŠŸèƒ½ã€‚åœ¨ [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” ä»¤ç‰ŒéªŒè¯ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/token-authorization.html) å®šä¹‰å¦‚ä¸‹ï¼š
é€šè¿‡ä»¤ç‰ŒéªŒè¯åœ¨**æ³¨å†Œä¸­å¿ƒ**æ§åˆ¶æƒé™ï¼Œä»¥å†³å®šè¦ä¸è¦ä¸‹å‘ä»¤ç‰Œç»™æ¶ˆè´¹è€…ï¼Œå¯ä»¥é˜²æ­¢æ¶ˆè´¹è€…ç»•è¿‡æ³¨å†Œä¸­å¿ƒè®¿é—®æä¾›è€…ã€‚

å¦å¤–é€šè¿‡æ³¨å†Œä¸­å¿ƒå¯çµæ´»æ”¹å˜æˆæƒæ–¹å¼ï¼Œè€Œä¸éœ€ä¿®æ”¹æˆ–å‡çº§æä¾›è€…ã€‚

![è®¤è¯æµç¨‹](http://static2.iocoder.cn/images/Dubbo/2018_11_19/01.png)

* å®˜æ–¹æ–‡æ¡£å†™çš„å¾ˆå…¨ï¼Œèƒ–å‹è¯·ç‚¹å‡»é“¾æ¥çœ‹å®Œå“ˆã€‚

So ï¼Œå¯èƒ½å’Œå¤§å¤šæ•°èƒ–å‹ï¼ˆåŒ…æ‹¬æˆ‘ï¼‰ï¼Œä¸€å¼€å§‹ç†è§£å’ŒæœŸæœ›çš„ä¸å¤ªä¸€æ · ğŸ™‚ ã€‚

# 2.ã€æœåŠ¡æ¶ˆè´¹è€…ã€‘éšæœº Token

åœ¨ ServiceConfig çš„

/#doExportUrlsFor1Protocol(protocolConfig, registryURLs)
æ–¹æ³•ä¸­ï¼Œéšæœºç”Ÿæˆ Token ï¼š
```
// token ï¼Œå‚è§ã€Šä»¤ç‰Œæ ¡éªŒã€‹http://dubbo.apache.org/zh-cn/docs/user/demos/token-authorization.html
if (!ConfigUtils.isEmpty(token)) {
if (ConfigUtils.isDefault(token)) { // true || default æ—¶ï¼ŒUUID éšæœºç”Ÿæˆ
map.put("token", UUID.randomUUID().toString());
} else {
map.put("token", token);
}
}
```

# 3.ã€æœåŠ¡æ¶ˆè´¹è€…ã€‘æ¥æ”¶ Token

æœåŠ¡**æ¶ˆè´¹è€…**ï¼Œä»æ³¨å†Œä¸­å¿ƒï¼Œè·å–æœåŠ¡æä¾›è€…çš„ **URL** ï¼Œä»è€Œè·å¾—è¯¥æœåŠ¡ç€çš„ Token ã€‚
æ‰€ä»¥ï¼Œå³ä½¿æœåŠ¡æä¾›è€…éšæœºç”Ÿæˆ Token ï¼Œæ¶ˆè´¹è€…ä¸€æ ·å¯ä»¥æ‹¿åˆ°ã€‚

# 3.ã€æœåŠ¡æ¶ˆè´¹è€…ã€‘å‘é€ Token

RpcInvocation åœ¨åˆ›å»ºæ—¶ï¼Œâ€œ**è‡ªåŠ¨**â€å¸¦ä¸Š Token ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![RpcInvocation](http://static2.iocoder.cn/images/Dubbo/2018_11_19/02.png)

# 4.ã€æœåŠ¡æä¾›è€…ã€‘è®¤è¯ Token

com.alibaba.dubbo.rpc.filter.TokenFilter
ï¼Œå®ç° Filter æ¥å£ï¼Œ**ä»¤ç‰ŒéªŒè¯** Filter å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
@Activate(group = Constants.PROVIDER, value = Constants.TOKEN_KEY)
public class TokenFilter implements Filter{
@Override
public Result invoke(Invoker<?> invoker, Invocation inv) throws RpcException{
// è·å¾—æœåŠ¡æä¾›è€…é…ç½®çš„ Token å€¼
String token = invoker.getUrl().getParameter(Constants.TOKEN_KEY);
if (ConfigUtils.isNotEmpty(token)) {
// ä»éšå¼å‚æ•°ä¸­ï¼Œè·å¾— Token å€¼ã€‚
Class<?> serviceType = invoker.getInterface();
Map<String, String> attachments = inv.getAttachments();
String remoteToken = attachments == null ? null : attachments.get(Constants.TOKEN_KEY);
// å¯¹æ¯”ï¼Œè‹¥ä¸ä¸€è‡´ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸
if (!token.equals(remoteToken)) {
throw new RpcException("Invalid token! Forbid invoke remote service " + serviceType + " method " + inv.getMethodName() + "() from consumer " + RpcContext.getContext().getRemoteHost() + " to provider " + RpcContext.getContext().getLocalHost());
}
}
// æœåŠ¡è°ƒç”¨
return invoker.invoke(inv);
}
}
```