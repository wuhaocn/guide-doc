# åºåˆ—åŒ–ï¼ˆä¸‰ï¼‰ä¹‹ Kryo å®ç°

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡åˆ†äº«åŸºäº **Kryo** çš„åºåˆ—åŒ–æ‹“å±•å®ç°ã€‚
**Javaå¯¹è±¡åºåˆ—åŒ–æ¡†æ¶ Kryo**

Kryo æ˜¯ä¸€ä¸ªå¿«é€Ÿé«˜æ•ˆçš„Javaå¯¹è±¡å›¾å½¢åºåˆ—åŒ–æ¡†æ¶ï¼Œä¸»è¦ç‰¹ç‚¹æ˜¯æ€§èƒ½ã€é«˜æ•ˆå’Œæ˜“ç”¨ã€‚è¯¥é¡¹ç›®ç”¨æ¥åºåˆ—åŒ–å¯¹è±¡åˆ°æ–‡ä»¶ã€æ•°æ®åº“æˆ–è€…ç½‘ç»œã€‚

ç¤ºä¾‹ä»£ç ï¼š
  ```
Kryo kryo = new Kryo();
// ...
Output output = new Output(new FileOutputStream("file.bin"));
SomeClass someObject = ...
kryo.writeObject(output, someObject);
output.close();
// ...
Input input = new Input(new FileInputStream("file.bin"));
SomeClass someObject = kryo.readObject(input, SomeClass.class);
input.close();
```

æœ¬æ–‡æ¶‰åŠï¼Œç±»å›¾å¦‚ä¸‹ï¼š

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2019_02_21/01.png)

# 2. KryoSerialization

com.alibaba.dubbo.common.serialize.support.kryo.KryoSerialization
ï¼Œå®ç° Serialization æ¥å£ï¼ŒKryo **åºåˆ—åŒ–**å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public class KryoSerialization implements Serialization{
@Override
public byte getContentTypeId(){
return 8;
}
@Override
public String getContentType(){
return "x-application/kryo";
}
@Override
public ObjectOutput serialize(URL url, OutputStream out) throws IOException{
return new KryoObjectOutput(out);
}
@Override
public ObjectInput deserialize(URL url, InputStream is) throws IOException{
return new KryoObjectInput(is);
}
}
```

# 3. KryoObjectInput

[
com.alibaba.dubbo.common.serialize.support.kryo.KryoObjectInput
](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/kryo/KryoObjectInput.java) ï¼Œå®ç° ObjectInput, Cleanable æ¥å£ï¼ŒKryo å¯¹è±¡**è¾“å…¥**å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**
```
//*/*
/* Kryo å¯¹è±¡
/*/
private Kryo kryo;
//*/*
/* Kryo è¾“å…¥
/*/
private Input input;
public KryoObjectInput(InputStream inputStream){
input = new Input(inputStream);
this.kryo = KryoUtils.get();
}
```

* kryo
å±æ€§ï¼Œé€šè¿‡

KryoUtils/#get()
æ–¹æ³•ï¼Œè·å–ã€‚

**ObjectInput å®ç°æ–¹æ³•**

â‘  æ¥è‡ª DataInput çš„å®ç°æ–¹æ³•ï¼Œè°ƒç”¨

input
å¯¹åº”çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š
```
@Override
public boolean readBool() throws IOException{
try {
return input.readBoolean();
} catch (KryoException e) {
throw new IOException(e);
}
}
```

â‘¡ æ¥è‡ª ObjectInput çš„å®ç°æ–¹æ³•ï¼Œè°ƒç”¨

kryo
å¯¹åº”çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š

```
@Override
public Object readObject() throws IOException, ClassNotFoundException{
// TODO optimization
try {
return kryo.readClassAndObject(input);
} catch (KryoException e) {
throw new IOException(e);
}
}
```

* é€šè¿‡è¯»å–**ç±»**ï¼Œåœ¨æ ¹æ®ç±»è§£æå…·ä½“å¯¹è±¡ï¼Œå­—èŠ‚å†…å®¹â€œ**å¤§ä½“**â€æ˜¯ [ Class, å¯¹è±¡äºŒè¿›åˆ¶æ•°æ® ] ã€‚åœ¨ [ã€Šæ·±å…¥ç†è§£RPCä¹‹åºåˆ—åŒ–ç¯‡ â€“ Kryoã€‹](https://www.cnkirito.moe/2017/11/28/rpc-serialize-1/) çš„ [ã€Œä¸‰ç§è¯»å†™æ–¹å¼ã€](http://svip.iocoder.cn/Dubbo/serialize-3-kryo/) ï¼Œå¯¹è¿™å—è§£æçš„ç›¸å½“ä¸é”™ã€‚

**Cleanable å®ç°æ–¹æ³•**
```
@Override
public void cleanup(){
// é‡Šæ”¾ Kryo å¯¹è±¡
KryoUtils.release(kryo);
// æ¸…ç©º
kryo = null;
}
```

# 4. KryoObjectOutput

[
com.alibaba.dubbo.common.serialize.support.kryo.KryoObjectOutput
](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/kryo/KryoObjectOutput.java) ï¼Œå®ç° ObjectOutput, Cleanable æ¥å£ï¼ŒKryo å¯¹è±¡**è¾“å‡º**å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**
```
//*/*
/* Kryo å¯¹è±¡
/*/
private Kryo kryo;
//*/*
/* Kryo è¾“å‡º
/*/
private Output output;
public KryoObjectOutput(OutputStream outputStream){
output = new Output(outputStream);
this.kryo = KryoUtils.get();
}
```

* kryo
å±æ€§ï¼Œé€šè¿‡

KryoUtils/#get()
æ–¹æ³•ï¼Œè·å–ã€‚

**ObjectOutput å®ç°æ–¹æ³•**

â‘  æ¥è‡ª DataOutput çš„å®ç°æ–¹æ³•ï¼Œè°ƒç”¨

input
å¯¹åº”çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š
```
@Override
public void writeBool(boolean v) throws IOException{
output.writeBoolean(v);
}
```

â‘¡ æ¥è‡ª ObjectOutput çš„å®ç°æ–¹æ³•ï¼Œè°ƒç”¨

kryo
å¯¹åº”çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š

```
@Override
@Override
public void writeObject(Object v) throws IOException{
// TODO carries class info every time.
kryo.writeClassAndObject(output, v);
}
```

* é€šè¿‡å†™å…¥**ç±»** + å…·ä½“å¯¹è±¡ï¼Œå­—èŠ‚å†…å®¹â€œ**å¤§ä½“**â€æ˜¯ [ Class, å¯¹è±¡äºŒè¿›åˆ¶æ•°æ® ] ã€‚åœ¨ [ã€Šæ·±å…¥ç†è§£RPCä¹‹åºåˆ—åŒ–ç¯‡ â€“ Kryoã€‹](https://www.cnkirito.moe/2017/11/28/rpc-serialize-1/) çš„ [ã€Œä¸‰ç§è¯»å†™æ–¹å¼ã€](http://svip.iocoder.cn/Dubbo/serialize-3-kryo/) ï¼Œå¯¹è¿™å—è§£æçš„ç›¸å½“ä¸é”™ã€‚

**Cleanable å®ç°æ–¹æ³•**
```
@Override
public void cleanup(){
// é‡Šæ”¾ Kryo å¯¹è±¡
KryoUtils.release(kryo);
// æ¸…ç©º
kryo = null;
}
```

# 5. CompatibleKryo

com.alibaba.dubbo.common.serialize.support.kryo.CompatibleKryo
ï¼Œå®ç° Kryo ç±»ï¼Œå…¼å®¹**ç©ºæ„é€ **æ–¹æ³•çš„ Kryo å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: @Override
2: public Serializer getDefaultSerializer(Class type){
3: if (type == null) {
4: throw new IllegalArgumentException("type cannot be null.");
5: }
6: // ç©ºæ„é€ æ–¹æ³•æ—¶ï¼Œä½¿ç”¨ JavaSerializer ï¼ŒJava åŸç”Ÿåºåˆ—åŒ–å®ç°
7: if (!type.isArray() && !type.isEnum() && !ReflectionUtils.checkZeroArgConstructor(type)) {
8: if (logger.isWarnEnabled()) {
9: logger.warn(type + " has no zero-arg constructor and this will affect the serialization performance");
10: }
11: return new JavaSerializer();
12: }
13: // ä½¿ç”¨ Kryo é»˜è®¤åºåˆ—åŒ–å®ç°
14: return super.getDefaultSerializer(type);
15: }
```

* ç¬¬ 6 è‡³ 12 è¡Œï¼šKryo ä¸æ”¯æŒä¸åŒ…å«**ç©ºæ„é€ æ–¹æ³•**çš„ç±»çš„åºåˆ—åŒ–ï¼Œå› æ­¤ï¼Œæ­¤æ—¶ä½¿ç”¨ Kryo å°è£… **Java åŸç”Ÿåºåˆ—åŒ–**å®ç°ç±»

com.esotericsoftware.kryo.serializers.JavaSerializer
ã€‚

* ReflectionUtils/#checkZeroArgConstructor(type)
æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* åˆ¤æ–­ç±»æ˜¯å¦æœ‰ç©ºæ„é€ æ–¹æ³•
/*
/* @param clazz ç±»
/* @return æ˜¯å¦
/*/
public static boolean checkZeroArgConstructor(Class clazz){
try {
clazz.getDeclaredConstructor();
return true;
} catch (NoSuchMethodException e) {
return false;
}
}
```
* x
* ç¬¬ 14 è¡Œï¼šä½¿ç”¨ Kryo **é»˜è®¤**åºåˆ—åŒ–å®ç°ã€‚

# 6. KryoFactory

## 6.1 AbstractKryoFactory

[
com.alibaba.dubbo.common.serialize.support.kryo.utils.AbstractKryoFactory
](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/kryo/utils/AbstractKryoFactory.java) ï¼Œå®ç°

com.esotericsoftware.kryo.pool.KryoFactory
æ¥å£ï¼ŒKryo **å·¥å‚**æŠ½è±¡ç±»ã€‚

**æ„é€ æ–¹æ³•**
```
//*/*
/* éœ€è¦æ³¨å†Œçš„ç±»çš„é›†åˆ
/*/
private final Set<Class> registrations = new LinkedHashSet<Class>();
//*/*
/* æ˜¯å¦å¼€å¯æ³¨å†Œè¡Œä¸º
/*/
private boolean registrationRequired;
//*/*
/* Kryo æ˜¯å¦å·²ç»åˆ›å»º
/*/
private volatile boolean kryoCreated;
```

* registrations
**é™æ€**å±æ€§ï¼Œéœ€è¦**æ³¨å†Œ**çš„ç±»çš„é›†åˆã€‚é€šè¿‡

/#registerClass(Class)
æ–¹æ³•ï¼Œå¯ä»¥æ·»åŠ ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* only supposed to be called at startup time
/*
/* later may consider adding support for custom serializer, custom id, etc
/*/
public void registerClass(Class clazz){
if (kryoCreated) {
throw new IllegalStateException("Can't register class after creating kryo instance");
}
registrations.add(clazz);
}
```
* registrationRequired
å±æ€§ï¼Œæ˜¯å¦å¼€å¯**æ³¨å†Œ**è¡Œä¸ºï¼Œé»˜è®¤**å…³é—­**ã€‚
Kryo æ”¯æŒå¯¹æ³¨å†Œè¡Œä¸ºï¼Œå¦‚

kryo.register(SomeClazz.class);
ï¼Œè¿™ä¼šèµ‹äºˆè¯¥ Class ä¸€ä¸ªä» 0 å¼€å§‹çš„ç¼–å·ï¼Œä½† Kryo ä½¿ç”¨æ³¨å†Œè¡Œä¸ºæœ€å¤§çš„é—®é¢˜åœ¨äºï¼Œå…¶ä¸ä¿è¯åŒä¸€ä¸ª Class æ¯ä¸€æ¬¡æ³¨å†Œçš„å·ç ç›¸åŒï¼Œè¿™ä¸æ³¨å†Œçš„é¡ºåºæœ‰å…³ï¼Œä¹Ÿå°±æ„å‘³ç€åœ¨ä¸åŒçš„æœºå™¨ã€åŒä¸€ä¸ªæœºå™¨é‡å¯å‰åéƒ½æœ‰å¯èƒ½æ‹¥æœ‰ä¸åŒçš„ç¼–å·ï¼Œè¿™ä¼šå¯¼è‡´åºåˆ—åŒ–äº§ç”Ÿé—®é¢˜ï¼Œæ‰€ä»¥åœ¨åˆ†å¸ƒå¼é¡¹ç›®ä¸­ï¼Œ**ä¸€èˆ¬å…³é—­æ³¨å†Œè¡Œä¸º**ã€‚
* kryoCreated
å±æ€§ï¼ŒKryo æ˜¯å¦å·²ç»åˆ›å»ºã€‚

**æŠ½è±¡æ–¹æ³•**
```
//*/*
/* è¿”è¿˜ Kryo å¯¹è±¡
/*
/* @param kryo Kyro
/*/
public abstract void returnKryo(Kryo kryo);
//*/*
/* è·å¾— Kryo å¯¹è±¡
/*
/* @return Kryo å¯¹è±¡
/*/
public abstract Kryo getKryo();
```

**create**

```
1: @Override
2: public Kryo create(){
3: // æ ‡è®°å·²åˆ›å»º
4: if (!kryoCreated) {
5: kryoCreated = true;
6: }
7:
8: // åˆ›å»º CompatibleKryo å¯¹è±¡
9: Kryo kryo = new CompatibleKryo();
10:
11: // TODO
12: // kryo.setReferences(false);
13: kryo.setRegistrationRequired(registrationRequired);
14:
15: // æ³¨å†Œå¸¸ç”¨ç±»
16: kryo.register(Collections.singletonList("").getClass(), new ArraysAsListSerializer());
17: kryo.register(GregorianCalendar.class, new GregorianCalendarSerializer());
18: kryo.register(InvocationHandler.class, new JdkProxySerializer());
19: kryo.register(BigDecimal.class, new DefaultSerializers.BigDecimalSerializer());
20: kryo.register(BigInteger.class, new DefaultSerializers.BigIntegerSerializer());
21: kryo.register(Pattern.class, new RegexSerializer());
22: kryo.register(BitSet.class, new BitSetSerializer());
23: kryo.register(URI.class, new URISerializer());
24: kryo.register(UUID.class, new UUIDSerializer());
25: UnmodifiableCollectionsSerializer.registerSerializers(kryo);
26: SynchronizedCollectionsSerializer.registerSerializers(kryo);
27:
28: // æ³¨å†Œå¸¸ç”¨æ•°æ®ç»“æ„
29: // now just added some very common classes
30: // TODO optimization
31: kryo.register(HashMap.class);
32: kryo.register(ArrayList.class);
33: kryo.register(LinkedList.class);
34: kryo.register(HashSet.class);
35: kryo.register(TreeSet.class);
36: kryo.register(Hashtable.class);
37: kryo.register(Date.class);
38: kryo.register(Calendar.class);
39: kryo.register(ConcurrentHashMap.class);
40: kryo.register(SimpleDateFormat.class);
41: kryo.register(GregorianCalendar.class);
42: kryo.register(Vector.class);
43: kryo.register(BitSet.class);
44: kryo.register(StringBuffer.class);
45: kryo.register(StringBuilder.class);
46: kryo.register(Object.class);
47: kryo.register(Object[].class);
48: kryo.register(String[].class);
49: kryo.register(byte[].class);
50: kryo.register(char[].class);
51: kryo.register(int[].class);
52: kryo.register(float[].class);
53: kryo.register(double[].class);
54:
55: // `registrations` çš„æ³¨å†Œ
56: for (Class clazz : registrations) {
57: kryo.register(clazz);
58: }
59:
60: // SerializableClassRegistry çš„æ³¨å†Œ
61: for (Class clazz : SerializableClassRegistry.getRegisteredClasses()) {
62: kryo.register(clazz);
63: }
64:
65: return kryo;
66: }
```

* ç¬¬ 3 è‡³ 6 è¡Œï¼šæ ‡è®°å·²åˆ›å»º

kryoCreated = true
ã€‚
* ç¬¬ 9 è¡Œï¼šåˆ›å»º CompatibleKryo å¯¹è±¡ã€‚
* ç¬¬ 13 è¡Œï¼šè°ƒç”¨

Kryo/#setRegistrationRequired(registrationRequired)
æ–¹æ³•ï¼Œè®¾ç½®æ˜¯å¦è¦**å¼€å¯**æ³¨å†Œçš„åŠŸèƒ½ã€‚
* ğŸ™‚ å¼€å§‹ä¸€é¡¿æ³¨å†Œã€‚

* ç¬¬ 15 è‡³ 26 è¡Œï¼šæ³¨å†Œ**å¸¸ç”¨ç±»**åˆ° Kryo å¯¹è±¡ã€‚
* ç¬¬ 28 è‡³ 53 è¡Œï¼šæ³¨å†Œ**å¸¸ç”¨æ•°æ®ç»“æ„**åˆ° Kryo å¯¹è±¡ã€‚
* ç¬¬ 55 è‡³ 58 è¡Œï¼šæ³¨å†Œ

registrations
åˆ° Kryo å¯¹è±¡ã€‚
* ç¬¬ 60 è‡³ 63 è¡Œï¼šæ³¨å†Œ SerializableClassRegistry åˆ° Kryo å¯¹è±¡ã€‚

## 6.2 ThreadLocalKryoFactory

[
com.alibaba.dubbo.common.serialize.support.kryo.utils.ThreadLocalKryoFactory
](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/kryo/utils/ThreadLocalKryoFactory.java) ï¼Œå®ç° AbstractKryoFactory æŠ½è±¡ç±»ï¼ŒåŸºäº **ThreadLocal** çš„ Kryo å·¥å‚å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public class ThreadLocalKryoFactory extends AbstractKryoFactory{
private final ThreadLocal<Kryo> holder = new ThreadLocal<Kryo>() {
@Override
protected Kryo initialValue(){
return create(); // åˆ›å»º Kryo
}
};
@Override
public void returnKryo(Kryo kryo){
// do nothing
}
@Override
public Kryo getKryo(){
return holder.get();
}
}
```

* Kryo çš„åºåˆ—åŒ–å’Œååºåˆ—çš„è¿‡ç¨‹ï¼Œæ˜¯**éçº¿ç¨‹å®‰å…¨**çš„ã€‚æ‰€ä»¥é€šè¿‡ ThreadLocal æ¥ä¿è¯ï¼Œæ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰ä¸€ä¸ª Kryo å¯¹è±¡ã€‚

## 6.3 KryoUtils

[
com.alibaba.dubbo.common.serialize.support.kryo.utils.KryoUtils
](https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/serialize/support/kryo/utils/KryoUtils.java) ï¼ŒKryo å·¥å…·ç±»ï¼Œç›®å‰ä»…ä»…å¯¹ KryoFactory è¿›è¡Œæ“ä½œã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public class KryoUtils{
private static AbstractKryoFactory kryoFactory = new ThreadLocalKryoFactory();
public static Kryo get(){
return kryoFactory.getKryo();
}
public static void release(Kryo kryo){
kryoFactory.returnKryo(kryo);
}
public static void register(Class<?> clazz){
kryoFactory.registerClass(clazz);
}
public static void setRegistrationRequired(boolean registrationRequired){
kryoFactory.setRegistrationRequired(registrationRequired);
}
}
```

# 666. å½©è›‹

æ¨èé˜…è¯»ï¼š

* [ã€Šæ·±å…¥ç†è§£RPCä¹‹åºåˆ—åŒ–ç¯‡ â€“ Kryoã€‹](https://www.cnkirito.moe/2017/11/28/rpc-serialize-1/)
* [ã€ŠKryoå®˜æ–¹æ–‡æ¡£-ä¸­æ–‡ç¿»è¯‘ã€‹](https://blog.csdn.net/fanjunjaden/article/details/72823866)