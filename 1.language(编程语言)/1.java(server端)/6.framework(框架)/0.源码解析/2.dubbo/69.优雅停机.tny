<header class="article-header">
<h1 class="article-title">ä¼˜é›…åœæœº</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡åˆ†äº« Dubbo çš„<strong>ä¼˜é›…åœæœº</strong>&nbsp;Graceful Shutdown ï¼Œå¯¹åº”&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/graceful-shutdown.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; ä¼˜é›…åœæœºã€‹</a>&nbsp;ã€‚</p>
<p>å®šä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>Dubbo æ˜¯é€šè¿‡ JDK çš„ ShutdownHook æ¥å®Œæˆä¼˜é›…åœæœºçš„ï¼Œæ‰€ä»¥å¦‚æœç”¨æˆ·ä½¿ç”¨&nbsp;<code>kill -9 PID</code>&nbsp;ç­‰å¼ºåˆ¶å…³é—­æŒ‡ä»¤ï¼Œæ˜¯ä¸ä¼šæ‰§è¡Œä¼˜é›…åœæœºçš„ï¼Œåªæœ‰é€šè¿‡&nbsp;<code>kill PID</code>&nbsp;æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œã€‚</p>
</blockquote>
<ul>
<li>è¿™å—ï¼Œæˆ‘ä»¬åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/graceful-shutdown/">ã€Œ2. ShutdownHookã€</a>&nbsp;ä¸­ï¼Œè¯¦ç»†è§£æã€‚</li>
</ul>
<p>åŸç†å¦‚ä¸‹ï¼š</p>
<blockquote>
<p><strong>æœåŠ¡æä¾›æ–¹</strong></p>
<ul>
<li>åœæ­¢æ—¶ï¼Œå…ˆæ ‡è®°ä¸ºä¸æ¥æ”¶æ–°è¯·æ±‚ï¼Œæ–°è¯·æ±‚è¿‡æ¥æ—¶ç›´æ¥æŠ¥é”™ï¼Œè®©å®¢æˆ·ç«¯é‡è¯•å…¶å®ƒæœºå™¨ã€‚ //&lt;1&gt;</li>
<li>ç„¶åï¼Œæ£€æµ‹çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Œå¦‚æœæœ‰ï¼Œç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæˆï¼Œé™¤éè¶…æ—¶ï¼Œåˆ™å¼ºåˆ¶å…³é—­ã€‚ // &lt;2&gt;</li>
</ul>
<p><strong>æœåŠ¡æ¶ˆè´¹æ–¹</strong></p>
<ul>
<li>åœæ­¢æ—¶ï¼Œä¸å†å‘èµ·æ–°çš„è°ƒç”¨è¯·æ±‚ï¼Œæ‰€æœ‰æ–°çš„è°ƒç”¨åœ¨å®¢æˆ·ç«¯å³æŠ¥é”™ã€‚ // &lt;3&gt;</li>
<li>ç„¶åï¼Œæ£€æµ‹æœ‰æ²¡æœ‰è¯·æ±‚çš„å“åº”è¿˜æ²¡æœ‰è¿”å›ï¼Œç­‰å¾…å“åº”è¿”å›ï¼Œé™¤éè¶…æ—¶ï¼Œåˆ™å¼ºåˆ¶å…³é—­ã€‚ // &lt;4&gt;</li>
</ul>
</blockquote>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;<code>&lt;2&gt;</code>ï¼šåŸºäº&nbsp;<strong>READONLYEVENT</strong>&nbsp;äº‹ä»¶ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-api-exchange/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ï¼ˆå››ï¼‰ä¹‹ Exchange å±‚ã€‹</a>ä¸­ï¼Œè§ HeaderExchangeServer çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/graceful-shutdown/">ã€Œ4.1.4 ä¼˜é›…å…³é—­ã€</a>&nbsp;ã€‚</li>
<li><code>&lt;3&gt;</code>&nbsp;<code>&lt;4&gt;</code>&nbsp;ï¼šåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-api-exchange/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ï¼ˆå››ï¼‰ä¹‹ Exchange å±‚ã€‹</a>&nbsp;ä¸­ï¼Œè§ HeaderExchangeChannel çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/graceful-shutdown/">ã€Œ2.1.2 å‘é€è¯·æ±‚ã€</a>&nbsp;å’Œ&nbsp;<a href="http://svip.iocoder.cn/Dubbo/graceful-shutdown/">ã€Œ2.1.3 ä¼˜é›…å…³é—­ã€</a>ã€‚</li>
<li>ğŸ˜ˆ å› ä¸ºä¹‹å‰æ–‡ç« æ˜¯<strong>æ‹†å¼€</strong>çš„ï¼Œæ‰€ä»¥ä¸‹æ–‡ä¼šæä¾›ä¸‹<strong>æ•´ä½“</strong>çš„é¡ºåºå›¾ã€‚</li>
</ul>
<h1 id="2-ShutdownHook">2. ShutdownHook</h1>
<p>Dubbo çš„ä¼˜é›…åœæœº&nbsp;<strong>ShutdownHook</strong>&nbsp;åœ¨ AbstractConfig çš„<strong>é™æ€ä»£ç å—</strong>åˆå§‹åŒ–ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">static</span> {</span><br /><span class="line">    Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() {</span><br /><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br /><span class="line">            <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line">                logger.info(<span class="string">"Run shutdown hook now."</span>);</span><br /><span class="line">            }</span><br /><span class="line">            ProtocolConfig.destroyAll();</span><br /><span class="line">        }</span><br /><span class="line">    }, <span class="string">"DubboShutdownHook"</span>));</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä»ä»£ç çš„ä½ç½®ä¸Šæ¥è¯´ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ª<strong>å¥½</strong>çš„ä½ç½®ã€‚ä½†æ˜¯è€ƒè™‘åˆ°ä¿è¯<strong>èƒ½å¤Ÿ</strong>è¢«åˆå§‹åŒ–åˆ° ShutdownHook ï¼Œè¿™åˆæ˜¯ä¸€ä¸ª<strong>åˆé€‚</strong>çš„ä½ç½®ã€‚å½“ç„¶ï¼Œä»å®˜æ–¹çš„ TODO æ¥è¯´ï¼Œæœªæ¥å¯èƒ½ä¼šæ¢åœ°æ–¹ã€‚</li>
<li>
<p><code>ProtocolConfig#destroyAll()</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">destroyAll</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// å¿½ç•¥ï¼Œè‹¥å·²ç»é”€æ¯</span></span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (!destroyed.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</span><br /><span class="line"> <span class="number">5</span>:     }</span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// é”€æ¯ Registry ç›¸å…³</span></span><br /><span class="line"> <span class="number">7</span>:     AbstractRegistryFactory.destroyAll();</span><br /><span class="line"> <span class="number">8</span>: </span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// ç­‰åˆ°æœåŠ¡æ¶ˆè´¹ï¼Œæ¥æ”¶åˆ°æ³¨å†Œä¸­å¿ƒé€šçŸ¥åˆ°è¯¥æœåŠ¡æä¾›è€…å·²ç»ä¸‹çº¿ï¼ŒåŠ å¤§äº†åœ¨ä¸é‡è¯•æƒ…å†µä¸‹ä¼˜é›…åœæœºçš„æˆåŠŸç‡ã€‚</span></span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// Wait for registry notification</span></span><br /><span class="line"><span class="number">11</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">12</span>:         Thread.sleep(ConfigUtils.getServerShutdownTimeout());</span><br /><span class="line"><span class="number">13</span>:     } <span class="keyword">catch</span> (InterruptedException e) {</span><br /><span class="line"><span class="number">14</span>:         logger.warn(<span class="string">"Interrupted unexpectedly when waiting for registry notification during shutdown process!"</span>);</span><br /><span class="line"><span class="number">15</span>:     }</span><br /><span class="line"><span class="number">16</span>: </span><br /><span class="line"><span class="number">17</span>:     <span class="comment">// é”€æ¯ Protocol ç›¸å…³</span></span><br /><span class="line"><span class="number">18</span>:     ExtensionLoader&lt;Protocol&gt; loader = ExtensionLoader.getExtensionLoader(Protocol.class);</span><br /><span class="line"><span class="number">19</span>:     <span class="keyword">for</span> (String protocolName : loader.getLoadedExtensions()) {</span><br /><span class="line"><span class="number">20</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">21</span>:             Protocol protocol = loader.getLoadedExtension(protocolName);</span><br /><span class="line"><span class="number">22</span>:             <span class="keyword">if</span> (protocol != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">23</span>:                 protocol.destroy();</span><br /><span class="line"><span class="number">24</span>:             }</span><br /><span class="line"><span class="number">25</span>:         } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">26</span>:             logger.warn(t.getMessage(), t);</span><br /><span class="line"><span class="number">27</span>:         }</span><br /><span class="line"><span class="number">28</span>:     }</span><br /><span class="line"><span class="number">29</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 2 è‡³ 5 è¡Œï¼š<strong>å¿½ç•¥</strong>ï¼Œè‹¥å·²ç»é”€æ¯ã€‚</li>
<li>ç¬¬ 7 è¡Œï¼šè°ƒç”¨&nbsp;<code>AbstractRegistryFactory#destroyAll()</code>&nbsp;æ–¹æ³•ï¼Œé”€æ¯<strong>æ‰€æœ‰</strong>&nbsp;Registry ï¼Œå–æ¶ˆ<strong>åº”ç”¨ç¨‹åº</strong>ä¸­çš„æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…çš„<strong>è®¢é˜…</strong>ä¸<strong>æ³¨å†Œ</strong>ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/graceful-shutdown/">ã€Œ2.1 AbstractRegistryFactoryã€</a>&nbsp;ä¸­ã€‚</li>
<li>
<p>ç¬¬ 9 è‡³ 15 è¡Œï¼šsleep&nbsp;<strong>ç­‰å¾…</strong>ä¸€æ®µæ—¶é—´ï¼Œç”¨äº<strong>å…¶ä»–åº”ç”¨ç¨‹åº</strong>çš„æœåŠ¡æ¶ˆè´¹è€…ï¼Œæ¥æ”¶åˆ°æ³¨å†Œä¸­å¿ƒé€šçŸ¥ï¼Œè¯¥<strong>åº”ç”¨ç¨‹åº</strong>çš„æœåŠ¡æä¾›è€…å·²ç»ä¸‹çº¿ï¼ŒåŠ å¤§äº†åœ¨ä¸é‡è¯•æƒ…å†µä¸‹ä¼˜é›…åœæœºçš„æˆåŠŸç‡ã€‚</p>
<ul>
<li>
<p>ğŸ˜ˆ å½“ç„¶ï¼Œè¿™ä¸æ˜¯<strong>ç»å¯¹</strong>èƒ½ç­‰å¾…åˆ°ï¼Œè€Œæ˜¯å¼€å‘è€…è‡ªå·±é…ç½®&nbsp;<code>"dubbo.service.shutdown.wait"</code>&nbsp;å‚æ•°ï¼Œè®¾ç½®ç­‰å¾…çš„æ—¶é•¿ï¼ˆå•ä½ï¼šæ¯«ç§’ï¼‰ã€‚<code>ConfigUtils#getServerShutdownTimeout()</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getServerShutdownTimeout</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// é»˜è®¤ï¼Œ10 * 1000 æ¯«ç§’</span></span><br /><span class="line">    <span class="keyword">int</span> timeout = Constants.DEFAULT_SERVER_SHUTDOWN_TIMEOUT;</span><br /><span class="line">    <span class="comment">// è·å¾— "dubbo.service.shutdown.wait" é…ç½®é¡¹ï¼Œå•ä½ï¼šæ¯«ç§’</span></span><br /><span class="line">    String value = ConfigUtils.getProperty(Constants.SHUTDOWN_WAIT_KEY);</span><br /><span class="line">    <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.length() &gt; <span class="number">0</span>) {</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            timeout = Integer.parseInt(value);</span><br /><span class="line">        } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line">        }</span><br /><span class="line">    <span class="comment">// è‹¥ä¸ºç©ºï¼Œè·å¾— "dubbo.service.shutdown.wait.seconds" é…ç½®é¡¹ï¼Œå•ä½ï¼šç§’ã€‚</span></span><br /><span class="line">    <span class="comment">// psï¼šç›®å‰å·²ç»åºŸå¼ƒè¯¥å‚æ•°ï¼Œæ¨èä½¿ç”¨ "dubbo.service.shutdown.wait"</span></span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        value = ConfigUtils.getProperty(Constants.SHUTDOWN_WAIT_SECONDS_KEY);</span><br /><span class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; value.length() &gt; <span class="number">0</span>) {</span><br /><span class="line">            <span class="keyword">try</span> {</span><br /><span class="line">                timeout = Integer.parseInt(value) * <span class="number">1000</span>;</span><br /><span class="line">            } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è¿”å›</span></span><br /><span class="line">    <span class="keyword">return</span> timeout;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><strong>é»˜è®¤</strong>&nbsp;10 * 1000 æ¯«ç§’ã€‚</li>
</ul>
</li>
<li>
<p>åœ¨&nbsp;<a href="https://github.com/apache/incubator-dubbo/pull/1021" target="_blank" rel="external nofollow noopener noreferrer">ISSUE#1021ï¼šEnhancement for graceful shutdown</a>&nbsp;ï¼Œæ˜¯é’ˆå¯¹è¿™å—çš„è®¨è®ºï¼Œéå¸¸æœ‰è¶£ï¼Œèƒ–å‹ä¸€å®šè¦çœ‹çœ‹ã€‚</p>
<blockquote>
<p>ç›®å‰ä¸ç®¡æ˜¯ç”¨çš„æœ€å¤šçš„2.5.3ç‰ˆæœ¬è¿˜æ˜¯æœ€æ–°çš„2.5.7ç‰ˆæœ¬ï¼Œäº²è‡ªæµ‹è¯•åœ¨ä¸è®¾ç½®é‡è¯•æœºåˆ¶ä¸‹æ˜¯æ— æ³•åšåˆ°ä¼˜é›…åœæœºçš„ï¼Œè¿™æ¬¡æ”¹åŠ¨ä¸»è¦æ˜¯ä¿®æ”¹ä¸€ç‚¹ç‚¹ä»£ç ï¼ŒåŠ ä¸Šå¯é…ç½®çš„ç­‰å¾…æ—¶é—´ï¼Œå°±èƒ½ç®€å•çš„åšåˆ°&ldquo;ä¸å¼€å¯é‡è¯•ä¹Ÿèƒ½ä¼˜é›…åœæœº&rdquo;ã€‚</p>
<p>å…¶ä¸»è¦å®ç°æœºåˆ¶å°±æ˜¯åœ¨ã€provideræ–­è¿æ³¨å†Œä¸­å¿ƒä¹‹åï¼Œå…³é—­åº”ç­”ä¹‹å‰ã€‘å’Œã€consumerç§»é™¤æ‰invokeråï¼Œå…³é—­clientä¹‹å‰ã€‘è¿™ä¸¤ä¸ªé˜¶æ®µåŠ å…¥å¯é…ç½®çš„ç­‰å¾…æ—¶é—´ï¼Œç›®å‰äº²æµ‹å¯ä»¥åšåˆ°ä¸é…ç½®é‡è¯•ä¹Ÿèƒ½ä¼˜é›…åœæœºã€‚</p>
<p>å› ä¸ºç°åœ¨å¤§å¤šæ•°ç”¨dubboçš„å…¬å¸ï¼Œä¸ºäº†é¿å…æç«¯æƒ…å†µä¸‹çš„é›ªå´©å’Œæµé‡é£æš´ï¼Œå¤§éƒ¨åˆ†æ¥å£éƒ½ä¼šå…³é—­é‡è¯•æœºåˆ¶ï¼Œè¿™æ ·ï¼Œå¯¹äºå½“å‰dubboä¼˜é›…åœæœºçš„è®¾å®šï¼Œå°±æ— æ³•åšåˆ°ä¼˜é›…åœæœºäº†ï¼Œæ‰€ä»¥è¿™é‡Œé€šè¿‡æ¯”è¾ƒç®€å•çš„æ–¹å¼ï¼ŒåŠ å¤§äº†åœ¨ä¸é‡è¯•æƒ…å†µä¸‹ä¼˜é›…åœæœºçš„æˆåŠŸç‡ã€‚</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ç¬¬ 17 è‡³ 28 è¡Œï¼šé”€æ¯<strong>æ‰€æœ‰</strong>&nbsp;Protocol ã€‚ç›®å‰åˆ†å±‚ä¸¤ç±» Protocol ï¼š</p>
<ul>
<li>å’Œ Registry é›†æˆçš„ Protocol å®ç°ç±»&nbsp;<strong>RegistryProtocol</strong>&nbsp;ï¼Œå…³æ³¨æœåŠ¡çš„<strong>æ³¨å†Œ</strong>ã€‚å…·ä½“çš„é”€æ¯é€»è¾‘ï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/graceful-shutdown/">ã€Œ2.3 RegistryProtocolã€</a>&nbsp;ä¸­ã€‚</li>
<li><strong>å…·ä½“åè®®</strong>å¯¹åº”çš„ Protocol å®ç°ç±»ï¼Œä¾‹å¦‚&nbsp;<code>dubbo://</code>&nbsp;å¯¹åº”çš„ DubboProtocol ã€<code>hessian://</code>&nbsp;å¯¹åº”çš„ HessianProtocol ï¼Œå…³æ³¨æœåŠ¡çš„<strong>æš´éœ²</strong>å’Œ<strong>å¼•ç”¨</strong>ã€‚å› ä¸º DubboProtocol æ˜¯æœ€<strong>å¸¸ç”¨</strong>çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä»¥å®ƒä¸ºä¾‹å­ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/graceful-shutdown/">ã€Œ2.2 DubboProtocolã€</a>&nbsp;ä¸­åˆ†äº«ã€‚</li>
</ul>
</li>
</ul>
<h2 id="2-1-AbstractRegistryFactory">2.1 AbstractRegistryFactory</h2>
<p><code>#destroyAll()</code>&nbsp;æ–¹æ³•ï¼Œé”€æ¯æ‰€æœ‰ Registry ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Registry&gt; REGISTRIES = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Registry&gt;();</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">destroyAll</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (LOGGER.isInfoEnabled()) {</span><br /><span class="line">        LOGGER.info(<span class="string">"Close all registries "</span> + getRegistries());</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è·å¾—é”</span></span><br /><span class="line">    LOCK.lock();</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="comment">// é”€æ¯</span></span><br /><span class="line">        <span class="keyword">for</span> (Registry registry : getRegistries()) {</span><br /><span class="line">            <span class="keyword">try</span> {</span><br /><span class="line">                registry.destroy();</span><br /><span class="line">            } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line">                LOGGER.error(e.getMessage(), e);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// æ¸…ç©ºç¼“å­˜</span></span><br /><span class="line">        REGISTRIES.clear();</span><br /><span class="line">    } <span class="keyword">finally</span> {</span><br /><span class="line">        <span class="comment">// é‡Šæ”¾é”</span></span><br /><span class="line">        LOCK.unlock();</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è°ƒç”¨&nbsp;<code>Registry#destroy()</code>&nbsp;æ–¹æ³•ï¼Œé”€æ¯æ¯ä¸ª Registry ã€‚</li>
<li>
<p>AbstractRegistry å®ç°äº†<strong>å…¬ç”¨</strong>çš„é”€æ¯é€»è¾‘ï¼šå–æ¶ˆ<strong>æ³¨å†Œ</strong>å’Œ<strong>è®¢é˜…</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// å·²é”€æ¯ï¼Œè·³è¿‡</span></span><br /><span class="line">    <span class="keyword">if</span> (!destroyed.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line">        logger.info(<span class="string">"Destroy registry:"</span> + getUrl());</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// å–æ¶ˆæ³¨å†Œ</span></span><br /><span class="line">    Set&lt;URL&gt; destroyRegistered = <span class="keyword">new</span> HashSet&lt;URL&gt;(getRegistered());</span><br /><span class="line">    <span class="keyword">if</span> (!destroyRegistered.isEmpty()) {</span><br /><span class="line">        <span class="keyword">for</span> (URL url : <span class="keyword">new</span> HashSet&lt;URL&gt;(getRegistered())) {</span><br /><span class="line">            <span class="keyword">if</span> (url.getParameter(Constants.DYNAMIC_KEY, <span class="keyword">true</span>)) {</span><br /><span class="line">                <span class="keyword">try</span> {</span><br /><span class="line">                    unregister(url); <span class="comment">// å–æ¶ˆæ³¨å†Œ</span></span><br /><span class="line">                    <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line">                        logger.info(<span class="string">"Destroy unregister url "</span> + url);</span><br /><span class="line">                    }</span><br /><span class="line">                } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">                    logger.warn(<span class="string">"Failed to unregister url "</span> + url + <span class="string">" to registry "</span> + getUrl() + <span class="string">" on destroy, cause: "</span> + t.getMessage(), t);</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// å–æ¶ˆè®¢é˜…</span></span><br /><span class="line">    Map&lt;URL, Set&lt;NotifyListener&gt;&gt; destroySubscribed = <span class="keyword">new</span> HashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;(getSubscribed());</span><br /><span class="line">    <span class="keyword">if</span> (!destroySubscribed.isEmpty()) {</span><br /><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;URL, Set&lt;NotifyListener&gt;&gt; entry : destroySubscribed.entrySet()) {</span><br /><span class="line">            URL url = entry.getKey();</span><br /><span class="line">            <span class="keyword">for</span> (NotifyListener listener : entry.getValue()) {</span><br /><span class="line">                <span class="keyword">try</span> {</span><br /><span class="line">                    unsubscribe(url, listener); <span class="comment">// å–æ¶ˆè®¢é˜…</span></span><br /><span class="line">                    <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line">                        logger.info(<span class="string">"Destroy unsubscribe url "</span> + url);</span><br /><span class="line">                    }</span><br /><span class="line">                } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">                    logger.warn(<span class="string">"Failed to unsubscribe url "</span> + url + <span class="string">" to registry "</span> + getUrl() + <span class="string">" on destroy, cause: "</span> + t.getMessage(), t);</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ— è®ºæ˜¯æœåŠ¡<strong>æä¾›è€…</strong>è¿˜æ˜¯<strong>æ¶ˆè´¹è€…</strong>ï¼Œéƒ½ä¼šå‘ Registry å‘èµ·<strong>æ³¨å†Œ</strong>å’Œ<strong>è®¢é˜…</strong>ï¼Œæ‰€ä»¥<strong>éƒ½</strong>éœ€è¦è¿›è¡Œå–æ¶ˆã€‚</li>
</ul>
</li>
<li>
<p>AbstractRegistry çš„<strong>å­ç±»</strong>&nbsp;FailbackRegistry ï¼Œå®ç°é”€æ¯<strong>å…¬ç”¨</strong>çš„<strong>é‡è¯•ä»»åŠ¡</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// å¿½ç•¥ï¼Œè‹¥å·²ç»é”€æ¯</span></span><br /><span class="line">    <span class="keyword">if</span> (!canDestroy()) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶æ–¹æ³•ï¼Œå–æ¶ˆæ³¨å†Œå’Œè®¢é˜…</span></span><br /><span class="line">    <span class="keyword">super</span>.destroy();</span><br /><span class="line">    <span class="comment">// é”€æ¯é‡è¯•ä»»åŠ¡</span></span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        retryFuture.cancel(<span class="keyword">true</span>);</span><br /><span class="line">    } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">        logger.warn(t.getMessage(), t);</span><br /><span class="line">    }</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">canDestroy</span><span class="params">()</span></span>{</span><br /><span class="line">    <span class="keyword">return</span> destroyed.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>FailbackRegistry æœ‰<strong>å¤šç§</strong>å®ç°ç±»ï¼Œä¼šæœ‰é”€æ¯å…¶å¯¹åº”çš„<strong>å®¢æˆ·ç«¯è¿æ¥</strong>çš„é€»è¾‘ã€‚ä»¥&nbsp;<strong>Zookeeper</strong>Registry ä¸¾ä¾‹å­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶æ–¹æ³•ï¼Œå–æ¶ˆæ³¨å†Œå’Œè®¢é˜…</span></span><br /><span class="line">    <span class="keyword">super</span>.destroy();</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="comment">// å…³é—­ Zookeeper å®¢æˆ·ç«¯è¿æ¥</span></span><br /><span class="line">        zkClient.close();</span><br /><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line">        logger.warn(<span class="string">"Failed to close zookeeper client "</span> + getUrl() + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<h2 id="2-2-DubboProtocol">2.2 DubboProtocol</h2>
<p><code>#destroy()</code>&nbsp;æ–¹æ³•ï¼Œé”€æ¯<strong>æ‰€æœ‰</strong>é€šä¿¡ ExchangeClient å’Œ ExchangeServer ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"Duplicates"</span>)</span><br /><span class="line"> <span class="number">2</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">3</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// é”€æ¯æ‰€æœ‰ ExchangeServer</span></span><br /><span class="line"> <span class="number">5</span>:     <span class="keyword">for</span> (String key : <span class="keyword">new</span> ArrayList&lt;String&gt;(serverMap.keySet())) {</span><br /><span class="line"> <span class="number">6</span>:         ExchangeServer server = serverMap.remove(key);</span><br /><span class="line"> <span class="number">7</span>:         <span class="keyword">if</span> (server != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">8</span>:             <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">9</span>:                 <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"><span class="number">10</span>:                     logger.info(<span class="string">"Close dubbo server: "</span> + server.getLocalAddress());</span><br /><span class="line"><span class="number">11</span>:                 }</span><br /><span class="line"><span class="number">12</span>:                 server.close(ConfigUtils.getServerShutdownTimeout());</span><br /><span class="line"><span class="number">13</span>:             } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">14</span>:                 logger.warn(t.getMessage(), t);</span><br /><span class="line"><span class="number">15</span>:             }</span><br /><span class="line"><span class="number">16</span>:         }</span><br /><span class="line"><span class="number">17</span>:     }</span><br /><span class="line"><span class="number">18</span>: </span><br /><span class="line"><span class="number">19</span>:     <span class="comment">// é”€æ¯æ‰€æœ‰ ExchangeClient</span></span><br /><span class="line"><span class="number">20</span>:     <span class="keyword">for</span> (String key : <span class="keyword">new</span> ArrayList&lt;String&gt;(referenceClientMap.keySet())) {</span><br /><span class="line"><span class="number">21</span>:         ExchangeClient client = referenceClientMap.remove(key);</span><br /><span class="line"><span class="number">22</span>:         <span class="keyword">if</span> (client != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">23</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">24</span>:                 <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"><span class="number">25</span>:                     logger.info(<span class="string">"Close dubbo connect: "</span> + client.getLocalAddress() + <span class="string">"--&gt;"</span> + client.getRemoteAddress());</span><br /><span class="line"><span class="number">26</span>:                 }</span><br /><span class="line"><span class="number">27</span>:                 client.close(ConfigUtils.getServerShutdownTimeout()); <span class="comment">// é”€æ¯</span></span><br /><span class="line"><span class="number">28</span>:             } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">29</span>:                 logger.warn(t.getMessage(), t);</span><br /><span class="line"><span class="number">30</span>:             }</span><br /><span class="line"><span class="number">31</span>:         }</span><br /><span class="line"><span class="number">32</span>:     }</span><br /><span class="line"><span class="number">33</span>:     <span class="comment">// é”€æ¯æ‰€æœ‰å¹½çµ ExchangeClient</span></span><br /><span class="line"><span class="number">34</span>:     <span class="keyword">for</span> (String key : <span class="keyword">new</span> ArrayList&lt;String&gt;(ghostClientMap.keySet())) {</span><br /><span class="line"><span class="number">35</span>:         ExchangeClient client = ghostClientMap.remove(key);</span><br /><span class="line"><span class="number">36</span>:         <span class="keyword">if</span> (client != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">37</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">38</span>:                 <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"><span class="number">39</span>:                     logger.info(<span class="string">"Close dubbo connect: "</span> + client.getLocalAddress() + <span class="string">"--&gt;"</span> + client.getRemoteAddress());</span><br /><span class="line"><span class="number">40</span>:                 }</span><br /><span class="line"><span class="number">41</span>:                 client.close(ConfigUtils.getServerShutdownTimeout()); <span class="comment">// é”€æ¯</span></span><br /><span class="line"><span class="number">42</span>:             } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">43</span>:                 logger.warn(t.getMessage(), t);</span><br /><span class="line"><span class="number">44</span>:             }</span><br /><span class="line"><span class="number">45</span>:         }</span><br /><span class="line"><span class="number">46</span>:     }</span><br /><span class="line"><span class="number">47</span>:     <span class="comment">// ã€TODO 8033ã€‘ å‚æ•°å›è°ƒ</span></span><br /><span class="line"><span class="number">48</span>:     stubServiceMethodsMap.clear();</span><br /><span class="line"><span class="number">49</span>:     <span class="keyword">super</span>.destroy();</span><br /><span class="line"><span class="number">50</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å®é™…æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºå³å¯ä»¥æ˜¯æœåŠ¡<strong>æä¾›è€…</strong>ï¼Œåˆæ˜¯æœåŠ¡<strong>æ¶ˆè´¹è€…</strong>ã€‚å› æ­¤ï¼Œéœ€è¦å…³é—­ ExchangeClient å’Œ ExchangeServer ã€‚</li>
<li>ç¬¬ 4 è‡³ 17 è¡Œï¼š<strong>å¾ªç¯</strong>è°ƒç”¨&nbsp;<code>HeaderExchangeServer#close(timeout)</code>&nbsp;æ–¹æ³•ï¼Œé”€æ¯æ‰€æœ‰ ExchangeServer ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/graceful-shutdown/">ã€Œ2.2.1 HeaderExchangeServerã€</a>&nbsp;ã€‚</li>
<li>ç¬¬ 19 è‡³ 32 è¡Œï¼š<strong>å¾ªç¯</strong>è°ƒç”¨&nbsp;<code>ReferenceCountExchangeClient#close(timeout)</code>&nbsp;æ–¹æ³•ï¼Œé”€æ¯æ‰€æœ‰ ReferenceCountExchangeClient ã€‚<strong>åœ¨è¯¥æ–¹æ³•å†…éƒ¨</strong>ï¼Œä¼šè°ƒç”¨&nbsp;<code>HeaderExchangeClient#close(timeout)</code>&nbsp;æ–¹æ³•ï¼Œå…³é—­ HeaderExchangeClient å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/graceful-shutdown/">ã€Œ2.2.2 HeaderExchangeClientã€</a>&nbsp;ã€‚</li>
<li>ç¬¬ 33 è‡³ 46 è¡Œï¼š<strong>å¾ªç¯</strong>è°ƒç”¨&nbsp;<code>LazyConnectExchangeClient#close(timeout)</code>&nbsp;æ–¹æ³•ï¼Œè¿›è¡Œå…³é—­ã€‚å…³äº LazyConnectExchangeClient ï¼Œè¯¦ç»†è§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/reference-refer-dubbo/?self">ç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡å¼•ç”¨ï¼ˆäºŒï¼‰ä¹‹è¿œç¨‹å¼•ç”¨ï¼ˆDubboï¼‰</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/graceful-shutdown/">ã€Œ5.2 LazyConnectExchangeClientã€</a>&nbsp;ã€‚</li>
<li>ç¬¬ 48 è¡Œï¼šã€TODO 8033ã€‘ å‚æ•°å›è°ƒ</li>
<li>
<p>ç¬¬ 49 è¡Œï¼šè°ƒç”¨<strong>çˆ¶</strong>&nbsp;<code>AbstractExporter#unexport()</code>&nbsp;æ–¹æ³•ï¼Œå–æ¶ˆæœåŠ¡çš„æš´éœ²( Exporter )ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">//  é”€æ¯åè®®å¯¹åº”çš„æœåŠ¡æ¶ˆè´¹è€…çš„æ‰€æœ‰ Invoker</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">for</span> (Invoker&lt;?&gt; invoker : invokers) {</span><br /><span class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (invoker != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">6</span>:             invokers.remove(invoker);</span><br /><span class="line"> <span class="number">7</span>:             <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">8</span>:                 <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"> <span class="number">9</span>:                     logger.info(<span class="string">"Destroy reference: "</span> + invoker.getUrl());</span><br /><span class="line"><span class="number">10</span>:                 }</span><br /><span class="line"><span class="number">11</span>:                 invoker.destroy();</span><br /><span class="line"><span class="number">12</span>:             } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">13</span>:                 logger.warn(t.getMessage(), t);</span><br /><span class="line"><span class="number">14</span>:             }</span><br /><span class="line"><span class="number">15</span>:         }</span><br /><span class="line"><span class="number">16</span>:     }</span><br /><span class="line"><span class="number">17</span>:     <span class="comment">// é”€æ¯åè®®å¯¹åº”çš„æœåŠ¡æä¾›è€…çš„æ‰€æœ‰ Exporter</span></span><br /><span class="line"><span class="number">18</span>:     <span class="keyword">for</span> (String key : <span class="keyword">new</span> ArrayList&lt;String&gt;(exporterMap.keySet())) {</span><br /><span class="line"><span class="number">19</span>:         Exporter&lt;?&gt; exporter = exporterMap.remove(key);</span><br /><span class="line"><span class="number">20</span>:         <span class="keyword">if</span> (exporter != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">21</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">22</span>:                 <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"><span class="number">23</span>:                     logger.info(<span class="string">"Unexport service: "</span> + exporter.getInvoker().getUrl());</span><br /><span class="line"><span class="number">24</span>:                 }</span><br /><span class="line"><span class="number">25</span>:                 exporter.unexport();</span><br /><span class="line"><span class="number">26</span>:             } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">27</span>:                 logger.warn(t.getMessage(), t);</span><br /><span class="line"><span class="number">28</span>:             }</span><br /><span class="line"><span class="number">29</span>:         }</span><br /><span class="line"><span class="number">30</span>:     }</span><br /><span class="line"><span class="number">31</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è‡³ 16 è¡Œï¼š<strong>å¾ªç¯</strong>ï¼Œé”€æ¯<strong>åè®®( æ­¤å¤„ä¸º DubboProtocol )å¯¹åº”</strong>çš„æœåŠ¡<em>æ¶ˆè´¹è€…</em>çš„æ‰€æœ‰ Invoker<strong>( æ­¤å¤„ä¸º DubboInvoker )</strong>&nbsp;ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/graceful-shutdown/">ã€Œ2.2.3 DubboInvokerã€</a>&nbsp;ã€‚</li>
<li>ç¬¬ 17 è‡³ 30 è¡Œï¼š<strong>å¾ªç¯</strong>ï¼Œé”€æ¯<strong>åè®®( æ­¤å¤„ä¸º DubboProtocol )å¯¹åº”</strong>çš„æœåŠ¡<em>æä¾›è€…</em>çš„æ‰€æœ‰ Exporter<strong>( æ­¤å¤„ä¸º DubboExporter )</strong>&nbsp;ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/graceful-shutdown/">ã€Œ2.2.4 DubboExporterã€</a>&nbsp;ã€‚</li>
</ul>
</li>
</ul>
<h3 id="2-2-1-HeaderExchangeServer">2.2.1 HeaderExchangeServer</h3>
<p><code>#close(timeout)</code>&nbsp;æ–¹æ³•ï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_06_01/01.png" alt="close" /></p>
<ul>
<li>
<p><strong>çº¢</strong>æ¡†éƒ¨åˆ†ï¼šå› ä¸º ProtocolListenerWrapper å’Œ ProtocolFilterWrapper å’Œ&nbsp;<strong>Protocol çš„ Dubbo SPI Wrapper å®ç°ç±»</strong>ï¼Œæ‰€ä»¥è°ƒç”¨&nbsp;<code>DubboProtocol#destroy()</code>&nbsp;æ–¹æ³•æ—¶ï¼Œä¼šå…ˆè°ƒç”¨å®ƒä»¬ã€‚ç›®å‰ä»…ä»…æ˜¯ä¸€å±‚åŒ…è£…ï¼Œæ²¡æœ‰é€»è¾‘ ğŸ˜ˆ ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="comment">// ProtocolListenerWrapper.java</span></span><br /><span class="line"> <span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line">    protocol.destroy();</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">// ProtocolFilterWrapper.java</span></span><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line">    protocol.destroy();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<ul>
<li><strong>ç»¿</strong>æ¡†éƒ¨åˆ†ï¼šHeaderExchangeServer çš„<strong>ä¼˜é›…</strong>å…³é—­æµç¨‹ï¼Œè¯¦ç»†è§£æè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-api-exchange/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ï¼ˆå››ï¼‰ä¹‹ Exchange å±‚ã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/graceful-shutdown/">ã€Œ4.1.4 ä¼˜é›…å…³é—­ã€</a>&nbsp;ã€‚</li>
<li><strong>é»„</strong>æ¡†éƒ¨åˆ†ï¼šNettyServer å…³é—­<strong>çœŸæ­£</strong>&nbsp;Netty ç›¸å…³<strong>æœåŠ¡å™¨</strong>ç»„ä»¶ï¼Œè¯¦ç»†è§£æè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-impl-netty4//?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ï¼ˆå…­ï¼‰ä¹‹ Netty4 å®ç°ã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/graceful-shutdown/">ã€Œå…³é—­æœåŠ¡å™¨ã€</a>&nbsp;ã€‚</li>
<li>ExecutorUtil æä¾›äº†ä¸¤ç§<strong>å…³é—­</strong>æ–¹æ³•ï¼Œåœ¨æœ¬æ–‡çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/graceful-shutdown/">ã€Œ3. ExecutorUtilã€</a>&nbsp;è¯¦ç»†è§£æ ã€‚</li>
</ul>
<h3 id="2-2-2-HeaderExchangeClient">2.2.2 HeaderExchangeClient</h3>
<p><code>#close(timeout)</code>&nbsp;æ–¹æ³•ï¼Œæ•´ä½“æµç¨‹å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_06_01/02.png" alt="close" /></p>
<ul>
<li><strong>çº¢</strong>æ¡†éƒ¨åˆ†ï¼šHeaderExchangeClient çš„<strong>ä¼˜é›…</strong>å…³é—­æµç¨‹ï¼Œè¯¦ç»†è§£æè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-api-exchange/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ï¼ˆå››ï¼‰ä¹‹ Exchange å±‚ã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/graceful-shutdown/">ã€Œ2.1.3 ä¼˜é›…å…³é—­ã€</a>ã€‚</li>
<li><strong>ç»¿</strong>æ¡†éƒ¨åˆ†ï¼šNettyClient å…³é—­<strong>çœŸæ­£</strong>&nbsp;Netty ç›¸å…³<strong>å®¢æˆ·ç«¯</strong>ç»„ä»¶ï¼Œè¯¦ç»†è§£æè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-impl-netty4//?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ï¼ˆå…­ï¼‰ä¹‹ Netty4 å®ç°ã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/graceful-shutdown/">ã€Œå…³é—­é€šé“ã€</a>&nbsp;ã€‚</li>
</ul>
<h3 id="2-2-3-DubboInvoker">2.2.3 DubboInvoker</h3>
<p><code>#destroy()</code>&nbsp;æ–¹æ³•ï¼Œé”€æ¯ ExchangeClient ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// å¿½ç•¥ï¼Œè‹¥å·²ç»é”€æ¯</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (<span class="keyword">super</span>.isDestroyed()) {</span><br /><span class="line"> <span class="number">5</span>:         <span class="keyword">return</span>;</span><br /><span class="line"> <span class="number">6</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">7</span>:         <span class="comment">// double check to avoid dup close</span></span><br /><span class="line"> <span class="number">8</span>:         <span class="comment">// åŒé‡é”æ ¡éªŒï¼Œé¿å…å·²ç»å…³é—­</span></span><br /><span class="line"> <span class="number">9</span>:         destroyLock.lock();</span><br /><span class="line"><span class="number">10</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">11</span>:             <span class="keyword">if</span> (<span class="keyword">super</span>.isDestroyed()) {</span><br /><span class="line"><span class="number">12</span>:                 <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">13</span>:             }</span><br /><span class="line"><span class="number">14</span>:             <span class="comment">// æ ‡è®°å…³é—­</span></span><br /><span class="line"><span class="number">15</span>:             <span class="keyword">super</span>.destroy();</span><br /><span class="line"><span class="number">16</span>:             <span class="comment">// ç§»é™¤å‡º `invokers`</span></span><br /><span class="line"><span class="number">17</span>:             <span class="keyword">if</span> (invokers != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">18</span>:                 invokers.remove(<span class="keyword">this</span>);</span><br /><span class="line"><span class="number">19</span>:             }</span><br /><span class="line"><span class="number">20</span>:             <span class="comment">// å…³é—­ ExchangeClient ä»¬</span></span><br /><span class="line"><span class="number">21</span>:             <span class="keyword">for</span> (ExchangeClient client : clients) {</span><br /><span class="line"><span class="number">22</span>:                 <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">23</span>:                     client.close(ConfigUtils.getServerShutdownTimeout());</span><br /><span class="line"><span class="number">24</span>:                 } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">25</span>:                     logger.warn(t.getMessage(), t);</span><br /><span class="line"><span class="number">26</span>:                 }</span><br /><span class="line"><span class="number">27</span>:             }</span><br /><span class="line"><span class="number">28</span>:         } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">29</span>:             <span class="comment">// é‡Šæ”¾é”</span></span><br /><span class="line"><span class="number">30</span>:             destroyLock.unlock();</span><br /><span class="line"><span class="number">31</span>:         }</span><br /><span class="line"><span class="number">32</span>:     }</span><br /><span class="line"><span class="number">33</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œèƒ–å‹çœ‹ä»£ç æ³¨é‡Šã€‚ä¸‹é¢åªæŒ‘é€‰å‡ ä¸ªæ–¹æ³•åˆ†äº«ã€‚</li>
<li>
<p><strong>çˆ¶</strong>&nbsp;<code>AbstractInvoker#isDestroyed()</code>&nbsp;æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»é”€æ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦é”€æ¯</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> AtomicBoolean destroyed = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDestroyed</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> destroyed.get();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><strong>çˆ¶</strong>&nbsp;<code>AbstractInvoker#destroy()</code>&nbsp;æ–¹æ³•ï¼Œæ ‡è®°å·²ç»é”€æ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦å¯ç”¨</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> available = <span class="keyword">true</span>;</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (!destroyed.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    setAvailable(<span class="keyword">false</span>);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setAvailable</span><span class="params">(<span class="keyword">boolean</span> available)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.available = available;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¹¶ä¸”ï¼Œä¼šæ ‡è®° DubboInvoker å·²ç»<strong>ä¸å¯ç”¨</strong>ã€‚</li>
<li>
<p>æ ‡è®°å·²ç»é”€æ¯åï¼Œå†è°ƒç”¨&nbsp;<code>#invoke(Invocation)</code>&nbsp;æ–¹æ³•ï¼Œä¼šæŠ›å‡º RpcException å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invocation inv)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">    <span class="keyword">if</span> (destroyed.get()) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Rpc invoker for service "</span> + <span class="keyword">this</span> + <span class="string">" on consumer "</span> + NetUtils.getLocalHost()</span><br /><span class="line">                + <span class="string">" use dubbo version "</span> + Version.getVersion()</span><br /><span class="line">                + <span class="string">" is DESTROYED, can not be invoked any more!"</span>);</span><br /><span class="line">    }</span><br />    <br /><span class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç </span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>x</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ç¬¬ 20 è‡³ 27 è¡Œï¼š<strong>å¾ªç¯</strong>ï¼Œè°ƒç”¨&nbsp;<code>ReferenceCountExchangeClient#close(timeout)</code>&nbsp;æ–¹æ³•ï¼Œå…³é—­å®¢æˆ·ç«¯ã€‚ğŸ˜ˆ å®é™…ä¸Šï¼Œåœ¨&nbsp;<code>DubboProtocol#destroy()</code>&nbsp;æ–¹æ³•ä¸­ï¼Œå·²ç»å…³é—­å®¢æˆ·ç«¯ã€‚è™½ç„¶çœ‹èµ·æ¥é‡å¤ï¼Œå®é™…ä¸ç„¶ã€‚å› ä¸ºè¿œç¨‹æœåŠ¡æä¾›è€…å…³é—­æ—¶ï¼Œ DubboInvoker éœ€è¦è¿›è¡Œé”€æ¯ï¼Œæ­¤æ—¶å¿…é¡»å…³é—­å®¢æˆ·ç«¯çš„é“¾æ¥ã€‚æ‰€ä»¥ï¼ŒDubboInvoker å¿…é¡»æœ‰è¿™å—é€»è¾‘ã€‚</p>
</li>
</ul>
<h3 id="2-2-4-DubboExporter">2.2.4 DubboExporter</h3>
<p><code>#unexport()</code>&nbsp;æ–¹æ³•ï¼Œå–æ¶ˆæš´éœ²ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æœåŠ¡é”®</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String key;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Exporter é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * key: æœåŠ¡é”®</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * è¯¥å€¼å®é™…å°±æ˜¯ {<span class="doctag">@link</span> com.alibaba.dubbo.rpc.protocol.AbstractProtocol#exporterMap}</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Exporter&lt;?&gt;&gt; exporterMap;</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unexport</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// å–æ¶ˆæš´éœ²</span></span><br /><span class="line">    <span class="keyword">super</span>.unexport();</span><br /><span class="line">    <span class="comment">// ç§»é™¤è‡ªå·±</span></span><br /><span class="line">    exporterMap.remove(key);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>è°ƒç”¨<strong>çˆ¶</strong>&nbsp;<code>AbstractExporter#unexport()</code>&nbsp;æ–¹æ³•ï¼Œå–æ¶ˆæš´éœ²ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Invoker&lt;T&gt; invoker;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦å–æ¶ˆæš´éœ²æœåŠ¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> unexported = <span class="keyword">false</span>;</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unexport</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// æ ‡è®°å·²ç»å–æ¶ˆæš´éœ²</span></span><br /><span class="line">    <span class="keyword">if</span> (unexported) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    unexported = <span class="keyword">true</span>;</span><br /><span class="line">    <span class="comment">// é”€æ¯</span></span><br /><span class="line">    getInvoker().destroy();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>å…¶ä¸­ï¼Œ<code>invoker</code>&nbsp;å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2019_06_01/03.png" alt="invoker" /></p>
<ul>
<li>
<p>è¿™ä¸ª Invoker é€šè¿‡ JavassistProxyFactory åˆ›å»ºï¼Œå®é™…å®ç°äº† AbstractProxyInvoker æŠ½è±¡ç±»ã€‚æ‰€ä»¥&nbsp;<code>#destroy()</code>&nbsp;æ–¹æ³•å¦‚ä¸‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ğŸ˜ˆ ç©ºçš„ï¼Œå˜¿å˜¿å˜¿ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="2-3-RegistryProtocol">2.3 RegistryProtocol</h2>
<p><code>#destroy()</code>&nbsp;æ–¹æ³•ï¼Œå–æ¶ˆæ‰€æœ‰ Exporter çš„æš´éœ²ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ç»‘å®šå…³ç³»é›†åˆã€‚</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * keyï¼šæœåŠ¡ Dubbo URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ExporterChangeableWrapper&lt;?&gt;&gt; bounds = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ExporterChangeableWrapper&lt;?&gt;&gt;();</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾— Exporter æ•°ç»„</span></span><br /><span class="line">    List&lt;Exporter&lt;?&gt;&gt; exporters = <span class="keyword">new</span> ArrayList&lt;Exporter&lt;?&gt;&gt;(bounds.values());</span><br /><span class="line">    <span class="comment">// å–æ¶ˆæ‰€æœ‰ Exporter çš„æš´éœ²</span></span><br /><span class="line">    <span class="keyword">for</span> (Exporter&lt;?&gt; exporter : exporters) {</span><br /><span class="line">        exporter.unexport();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// æ¸…ç©º</span></span><br /><span class="line">    bounds.clear();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><strong>å¾ªç¯</strong>ï¼Œè°ƒç”¨&nbsp;<code>ExporterChangeableWrapper#unexport()</code>&nbsp;æ–¹æ³•ï¼Œå–æ¶ˆæœåŠ¡<strong>æš´éœ²</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æš´éœ²çš„ Exporter å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Exporter&lt;T&gt; exporter;</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unexport</span><span class="params">()</span> </span>{</span><br /><span class="line">    String key = getCacheKey(<span class="keyword">this</span>.originInvoker);</span><br /><span class="line">    <span class="comment">// ç§»é™¤å‡º `bounds`</span></span><br /><span class="line">    bounds.remove(key);</span><br /><span class="line">    <span class="comment">// å–æ¶ˆæš´éœ²</span></span><br /><span class="line">    exporter.unexport();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å› ä¸ºæœåŠ¡æä¾›è€…<strong>é›†æˆ</strong>äº†é…ç½®è§„åˆ™ Configurator ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨åˆ° ExporterChangeableWrapper ï¼Œä¿å­˜åŸæœ‰ Invoker å¯¹è±¡ã€‚
<ul>
<li>ä¹Ÿå› æ­¤ï¼Œä¸Šè¿°æ‰€æœ‰å–æ¶ˆæš´éœ²é€»è¾‘ï¼Œæ˜¯æ— æ³•é”€æ¯ ExporterChangeableWrapper åœ¨&nbsp;<code>bounds</code>&nbsp;çš„æ˜ å°„ï¼Œéœ€è¦é€šè¿‡ RegistryProtocol çš„&nbsp;<code>#destroy()</code>&nbsp;æ–¹æ³•å®ç°ã€‚</li>
<li>ä¹Ÿå› æ­¤ï¼Œæ­¤å¤„è°ƒç”¨<strong>æš´éœ²çš„ Exporter å¯¹è±¡</strong>&nbsp;<code>exporter</code>&nbsp;ï¼Œå·²ç»è¢«&nbsp;<code>AbstractExporter#unexport()</code>&nbsp;æ–¹æ³•ï¼Œå–æ¶ˆæš´éœ²ã€‚ä½†æ˜¯å‘¢ï¼Œè¿™é‡Œåˆä¸èƒ½å»æ‰è¿™å—é€»è¾‘ï¼Œå› ä¸ºæ²¡å‡†æœ‰åœ°æ–¹ï¼Œéœ€è¦è°ƒç”¨&nbsp;<code>ExporterChangeableWrapper#unexport()</code>&nbsp;æ–¹æ³•å‘¢ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="3-ExecutorUtil">3. ExecutorUtil</h1>
<h2 id="3-1-gracefulShutdown">3.1 gracefulShutdown</h2>
<p><code>#gracefulShutdown(executor, timeout)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>ä¼˜é›…</strong>å…³é—­ï¼Œç¦æ­¢æ–°çš„ä»»åŠ¡æäº¤ï¼Œå°†åŸæœ‰ä»»åŠ¡æ‰§è¡Œå®Œã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">gracefulShutdown</span><span class="params">(Executor executor, <span class="keyword">int</span> timeout)</span> </span>{</span><br /><span class="line">    <span class="comment">// å¿½ç•¥ï¼Œè‹¥ä¸æ˜¯ ExecutorService ï¼Œæˆ–è€…å·²ç»å…³é—­</span></span><br /><span class="line">    <span class="keyword">if</span> (!(executor <span class="keyword">instanceof</span> ExecutorService) || isShutdown(executor)) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// å…³é—­ï¼Œç¦æ­¢æ–°çš„ä»»åŠ¡æäº¤ï¼Œå°†åŸæœ‰ä»»åŠ¡æ‰§è¡Œå®Œ</span></span><br /><span class="line">    <span class="keyword">final</span> ExecutorService es = (ExecutorService) executor;</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        es.shutdown(); <span class="comment">// Disable new tasks from being submitted &lt;1&gt;</span></span><br /><span class="line">    } <span class="keyword">catch</span> (SecurityException ex2) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    } <span class="keyword">catch</span> (NullPointerException ex2) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// ç­‰å¾…åŸæœ‰ä»»åŠ¡æ‰§è¡Œå®Œã€‚è‹¥ç­‰å¾…è¶…æ—¶ï¼Œå¼ºåˆ¶ç»“æŸæ‰€æœ‰ä»»åŠ¡</span></span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="keyword">if</span> (!es.awaitTermination(timeout, TimeUnit.MILLISECONDS)) {</span><br /><span class="line">            es.shutdownNow();</span><br /><span class="line">        }</span><br /><span class="line">    } <span class="keyword">catch</span> (InterruptedException ex) {</span><br /><span class="line">        <span class="comment">// å‘ç”Ÿ InterruptedException å¼‚å¸¸ï¼Œä¹Ÿå¼ºåˆ¶ç»“æŸæ‰€æœ‰ä»»åŠ¡</span></span><br /><span class="line">        es.shutdownNow();</span><br /><span class="line">        Thread.currentThread().interrupt();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è‹¥æœªå…³é—­æˆåŠŸï¼Œæ–°å¼€çº¿ç¨‹å»å…³é—­</span></span><br /><span class="line">    <span class="keyword">if</span> (!isShutdown(es)) {</span><br /><span class="line">        newThreadToCloseExecutor(es);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="3-2-shutdownNow">3.2 shutdownNow</h2>
<p><code>#shutdownNow(executor, timeout)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>å¼ºåˆ¶</strong>å…³é—­ï¼ŒåŒ…æ‹¬<strong>æ‰“æ–­</strong>åŸæœ‰æ‰§è¡Œä¸­çš„ä»»åŠ¡ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">shutdownNow</span><span class="params">(Executor executor, <span class="keyword">final</span> <span class="keyword">int</span> timeout)</span> </span>{</span><br /><span class="line">    <span class="comment">// å¿½ç•¥ï¼Œè‹¥ä¸æ˜¯ ExecutorService ï¼Œæˆ–è€…å·²ç»å…³é—­</span></span><br /><span class="line">    <span class="keyword">if</span> (!(executor <span class="keyword">instanceof</span> ExecutorService) || isShutdown(executor)) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// ç«‹å³å…³é—­ï¼ŒåŒ…æ‹¬åŸæœ‰ä»»åŠ¡ä¹Ÿæ‰“æ–­</span></span><br /><span class="line">    <span class="keyword">final</span> ExecutorService es = (ExecutorService) executor;</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        es.shutdownNow(); <span class="comment">// &lt;1&gt;</span></span><br /><span class="line">    } <span class="keyword">catch</span> (SecurityException ex2) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    } <span class="keyword">catch</span> (NullPointerException ex2) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// ç­‰å¾…åŸæœ‰ä»»åŠ¡è¢«æ‰“æ–­å®Œæˆ</span></span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        es.awaitTermination(timeout, TimeUnit.MILLISECONDS);</span><br /><span class="line">    } <span class="keyword">catch</span> (InterruptedException ex) {</span><br /><span class="line">        Thread.currentThread().interrupt();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è‹¥æœªå…³é—­æˆåŠŸï¼Œæ–°å¼€çº¿ç¨‹å»å…³é—­</span></span><br /><span class="line">    <span class="keyword">if</span> (!isShutdown(es)) {</span><br /><span class="line">        newThreadToCloseExecutor(es);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å’Œ&nbsp;<code>#gracefulShutdown(executor, timeout)</code>&nbsp;æ–¹æ³•ä¸åŒçš„æ˜¯ï¼Œ<code>&lt;1&gt;</code>&nbsp;å¤„è°ƒç”¨çš„æ˜¯&nbsp;<code>#shutdownNow()</code>&nbsp;æ–¹æ³•ï¼Œè€Œ<strong>ä¸æ˜¯</strong>&nbsp;<code>#shutdown()</code>&nbsp;æ–¹æ³•ã€‚</li>
</ul>
<h2 id="3-3-newThreadToCloseExecutor">3.3 newThreadToCloseExecutor</h2>
<p><code>#newThreadToCloseExecutor(ExecutorService)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>æ–°å¼€</strong>çº¿ç¨‹ï¼Œä¸æ–­å¼ºåˆ¶å…³é—­ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">newThreadToCloseExecutor</span><span class="params">(<span class="keyword">final</span> ExecutorService es)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (!isShutdown(es)) {</span><br /><span class="line">        shutdownExecutor.execute(<span class="keyword">new</span> Runnable() {</span><br /><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br /><span class="line">                <span class="keyword">try</span> {</span><br /><span class="line">                    <span class="comment">// å¾ªç¯ 1000 æ¬¡ï¼Œä¸æ–­å¼ºåˆ¶ç»“æŸçº¿ç¨‹æ± </span></span><br /><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) {</span><br /><span class="line">                        <span class="comment">// ç«‹å³å…³é—­ï¼ŒåŒ…æ‹¬åŸæœ‰ä»»åŠ¡ä¹Ÿæ‰“æ–­</span></span><br /><span class="line">                        es.shutdownNow();</span><br /><span class="line">                        <span class="comment">// ç­‰å¾…åŸæœ‰ä»»åŠ¡è¢«æ‰“æ–­å®Œæˆ</span></span><br /><span class="line">                        <span class="keyword">if</span> (es.awaitTermination(<span class="number">10</span>, TimeUnit.MILLISECONDS)) {</span><br /><span class="line">                            <span class="keyword">break</span>;</span><br /><span class="line">                        }</span><br /><span class="line">                    }</span><br /><span class="line">                } <span class="keyword">catch</span> (InterruptedException ex) {</span><br /><span class="line">                    Thread.currentThread().interrupt();</span><br /><span class="line">                } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line">                    logger.warn(e.getMessage(), e);</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">        });</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="666-å½©è›‹">666. å½©è›‹</h1>
<p><img src="http://static2.iocoder.cn/images/Architecture/2017_12_29/01.png" alt="çŸ¥è¯†æ˜Ÿçƒ" /></p>
<p>ç†è®ºæ¥è¯´ï¼ŒæœåŠ¡æä¾›è€…å¦‚æœè¦å…³é—­ï¼Œå¤§ä½“æµç¨‹å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>provider =&gt; registry ï¼šç§»é™¤è‡ªå·±<br />provider =&gt; consumer ï¼šæˆ‘å‡†å¤‡å…³é—­äº†ï¼Œä¸è¦è°ƒç”¨æˆ‘<br /><strong>æ‰€æœ‰</strong>&nbsp;consumer =&gt; provider ï¼šå¥½çš„ï¼Œæˆ‘çŸ¥é“äº†<br />provider =&gt; consumer ï¼šå¤„ç†å®Œæ‰€æœ‰åŸæœ‰è¯·æ±‚<br />provider å…³é—­</p>
</blockquote>
<p>ä½†æ˜¯å®é™…æƒ…å†µéå¸¸å¤æ‚ï¼Œå¦‚æœä¾èµ– consumer å»åº”ç­”å’Œç¡®è®¤ã€‚æ‰€ä»¥ Dubbo çš„é€‰æ‹©æ˜¯ï¼š</p>
<ul>
<li>provider ä» registry ï¼Œç§»é™¤è‡ªå·±ã€‚å¹¶ä¸” sleep ç­‰å¾…ä¸€å®šæ—¶é—´ï¼ˆå¼€å‘è€…å¯é…ï¼‰ï¼Œç­‰å¾… consumer è·å¾—åˆ°é€šçŸ¥ã€‚å½“ç„¶ï¼Œè¿™ä¸ªè¿‡ç¨‹<strong>ä¸æ˜¯ç»å¯¹èƒ½å¤ŸæˆåŠŸ</strong>çš„ã€‚ä¾‹å¦‚ï¼Œconsumer è¿æ¥ä¸ä¸Š registry ï¼Œä½†æ˜¯è¿çš„ä¸Š provider ã€‚</li>
<li>provider é€šçŸ¥ consumer ï¼Œè‡ªå·±å‡†å¤‡å…³é—­ï¼Œä¸è¦è¯·æ±‚è‡ªå·±ã€‚å…¨éƒ¨é€šçŸ¥å®Œæˆåï¼Œç­‰å¤„ç†å®ŒåŸæœ‰è¯·æ±‚ã€‚å®Œæˆåï¼Œå…³é—­æœ¬åœ°æœåŠ¡å™¨åŠçº¿ç¨‹æ± ã€‚</li>
</ul>
<p>å½“ç„¶ï¼Œconsumer ä¹Ÿæœ‰ä¼˜é›…å…³é—­ï¼Œç­‰å¾…æ‰€æœ‰å‘èµ·çš„è¯·æ±‚ç»“æŸã€‚ç›¸å¯¹ç®€å•çš„å¤šã€‚</p>
<p>æ¨èé˜…è¯»æ–‡ç« ï¼š</p>
<ul>
<li><a href="https://blog.csdn.net/manzhizhen/article/details/78756370" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubboæºä»£ç åˆ†æä¹ï¼šä¼˜é›…åœæœºã€‹</a></li>
<li><a href="https://www.jianshu.com/p/aa22eac09d8c" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ä¼˜é›…åœæœºã€‹</a></li>
<li><a href="https://my.oschina.net/u/1398931/blog/790709" target="_blank" rel="external nofollow noopener noreferrer">ã€Šè§£å†³dubboä¼˜é›…åœæœºã€‹</a></li>
</ul>
</div>
<div class="article-info article-info-index">
<div class="article-category tagcloud">
<ul class="article-tag-list">
<li class="article-tag-list-item"><a class="article-tag-list-link color1" href="http://svip.iocoder.cn/categories/Dubbo//">Dubbo</a></li>
</ul>
</div>
</div>