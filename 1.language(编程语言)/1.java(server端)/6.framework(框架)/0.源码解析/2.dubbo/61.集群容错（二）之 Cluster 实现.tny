<header class="article-header">
<h1 class="article-title">é›†ç¾¤å®¹é”™ï¼ˆäºŒï¼‰ä¹‹ Cluster å®ç°</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡æ¥&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-1-api-interface//?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹</a>&nbsp;ä¸€æ–‡ï¼Œåˆ†äº«&nbsp;<code>dubbo-cluster</code>&nbsp;æ¨¡å—ï¼Œ&nbsp;<code>support</code>&nbsp;åŒ…ï¼Œ<strong>å„ç§ Cluster å®ç°ç±»</strong>ã€‚</p>
<p>Cluster å­ç±»å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_04_01/01.png" alt="Cluster å­ç±»" /></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ª Cluster å®ç°ç±»ï¼Œå¯¹åº”ä¸€ä¸ª<strong>ä¸“å±</strong>äºå…¶çš„ Invoker å®ç°ç±»ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªå­ç±»å¾€ä¸‹çœ‹ã€‚</p>
<blockquote>
<p>è€è‰¿è‰¿ï¼šæœ¬æ–‡å¯¹åº”&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/fault-tolerent-strategy.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; é›†ç¾¤å®¹é”™ã€‹</a>&nbsp;æ–‡æ¡£ã€‚</p>
</blockquote>
<h1 id="2-AvailableCluster">2. AvailableCluster</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.support.AvailableCluster</code>&nbsp;ï¼Œå®ç° Cluster æ¥å£ï¼Œè°ƒç”¨<strong>é¦–ä¸ªå¯ç”¨</strong>æœåŠ¡å™¨ï¼Œç›®å‰ç”¨äº<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/multi-registry.html#%E5%A4%9A%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E6%B3%A8%E5%86%8C" target="_blank" rel="external nofollow noopener noreferrer">å¤šæ³¨å†Œä¸­å¿ƒå¼•ç”¨</a>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AvailableCluster</span> <span class="keyword">implements</span> <span class="title">Cluster</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">"available"</span>;</span><br /><br /><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">join</span><span class="params">(Directory&lt;T&gt; directory)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AvailableClusterInvoker&lt;T&gt;(directory);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¯¹åº” Invoker å®ç°ç±»ä¸º AvailableClusterInvoker ã€‚</li>
</ul>
<h2 id="2-1-AvailableClusterInvoker">2.1 AvailableClusterInvoker</h2>
<p><code>com.alibaba.dubbo.rpc.cluster.support.AvailableClusterInvoker</code>&nbsp;ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒAvailableCluster Invoker å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AvailableClusterInvoker</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractClusterInvoker</span>&lt;<span class="title">T</span>&gt; </span>{</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AvailableClusterInvoker</span><span class="params">(Directory&lt;T&gt; directory)</span> </span>{</span><br /><span class="line">        <span class="keyword">super</span>(directory);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">doInvoke</span><span class="params">(Invocation invocation, List&lt;Invoker&lt;T&gt;&gt; invokers, LoadBalance loadbalance)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="comment">// å¾ªç¯å€™é€‰çš„ Invoker é›†åˆï¼Œè°ƒç”¨é¦–ä¸ªå¯ç”¨çš„ Invoker å¯¹è±¡ã€‚</span></span><br /><span class="line">        <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokers) {</span><br /><span class="line">            <span class="keyword">if</span> (invoker.isAvailable()) { <span class="comment">// å¯ç”¨</span></span><br /><span class="line">                <span class="comment">// å‘èµ· RPC è°ƒç”¨</span></span><br /><span class="line">                <span class="keyword">return</span> invoker.invoke(invocation);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"No provider available in "</span> + invokers);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="3-BroadcastCluster">3. BroadcastCluster</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.support.BroadcastCluster</code>&nbsp;ï¼Œå®ç° Cluster æ¥å£ï¼Œå¹¿æ’­è°ƒç”¨<strong>æ‰€æœ‰</strong>æä¾›è€…ï¼Œé€ä¸ªè°ƒç”¨ï¼Œ<strong>ä»»æ„</strong>ä¸€å°æŠ¥é”™åˆ™æŠ¥é”™ã€‚é€šå¸¸ç”¨äºé€šçŸ¥æ‰€æœ‰æä¾›è€…æ›´æ–°ç¼“å­˜æˆ–æ—¥å¿—ç­‰æœ¬åœ°èµ„æºä¿¡æ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BroadcastCluster</span> <span class="keyword">implements</span> <span class="title">Cluster</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">join</span><span class="params">(Directory&lt;T&gt; directory)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BroadcastClusterInvoker&lt;T&gt;(directory);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¯¹åº” Invoker å®ç°ç±»ä¸º BroadcastClusterInvoker ã€‚</li>
</ul>
<h2 id="3-1-BroadcastClusterInvoker">3.1 BroadcastClusterInvoker</h2>
<p><code>com.alibaba.dubbo.rpc.cluster.support.BroadcastClusterInvoker</code>&nbsp;ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒBroadcastCluster Invoker å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BroadcastClusterInvoker</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractClusterInvoker</span>&lt;<span class="title">T</span>&gt; </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(BroadcastClusterInvoker.class);</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BroadcastClusterInvoker</span><span class="params">(Directory&lt;T&gt; directory)</span> </span>{</span><br /><span class="line">        <span class="keyword">super</span>(directory);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="meta">@SuppressWarnings</span>({<span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span>})</span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">doInvoke</span><span class="params">(<span class="keyword">final</span> Invocation invocation, List&lt;Invoker&lt;T&gt;&gt; invokers, LoadBalance loadbalance)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="comment">// æ£€æŸ¥ invokers å³å¯ç”¨Invokeré›†åˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œé‚£ä¹ˆæŠ›å‡ºå¼‚å¸¸</span></span><br /><span class="line">        checkInvokers(invokers, invocation);</span><br /><span class="line">        <span class="comment">// è®¾ç½®å·²ç»è°ƒç”¨çš„ Invoker é›†åˆï¼Œåˆ° Context ä¸­</span></span><br /><span class="line">        RpcContext.getContext().setInvokers((List) invokers);</span><br /><span class="line">        <span class="comment">// ä¿å­˜æœ€åä¸€æ¬¡è°ƒç”¨çš„å¼‚å¸¸</span></span><br /><span class="line">        RpcException exception = <span class="keyword">null</span>;</span><br /><span class="line">        <span class="comment">// ä¿å­˜æœ€åä¸€æ¬¡è°ƒç”¨çš„ç»“æœ</span></span><br /><span class="line">        Result result = <span class="keyword">null</span>;</span><br /><span class="line">        <span class="comment">// å¾ªç¯å€™é€‰çš„ Invoker é›†åˆï¼Œè°ƒç”¨æ‰€æœ‰ Invoker å¯¹è±¡ã€‚</span></span><br /><span class="line">        <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokers) {</span><br /><span class="line">            <span class="keyword">try</span> {</span><br /><span class="line">                <span class="comment">// å‘èµ· RPC è°ƒç”¨</span></span><br /><span class="line">                result = invoker.invoke(invocation);</span><br /><span class="line">            } <span class="keyword">catch</span> (RpcException e) {</span><br /><span class="line">                exception = e;</span><br /><span class="line">                logger.warn(e.getMessage(), e);</span><br /><span class="line">            } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line">                exception = <span class="keyword">new</span> RpcException(e.getMessage(), e); <span class="comment">// å°è£…æˆ RpcException å¼‚å¸¸</span></span><br /><span class="line">                logger.warn(e.getMessage(), e);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// è‹¥å­˜åœ¨ä¸€ä¸ªå¼‚å¸¸ï¼ŒæŠ›å‡ºè¯¥å¼‚å¸¸</span></span><br /><span class="line">        <span class="keyword">if</span> (exception != <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="keyword">throw</span> exception;</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span> result;</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="4-FailbackCluster">4. FailbackCluster</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.support.FailbackCluster</code>&nbsp;ï¼Œå®ç° Cluster æ¥å£ï¼Œå¤±è´¥è‡ªåŠ¨æ¢å¤ï¼Œåå°è®°å½•å¤±è´¥è¯·æ±‚ï¼Œå®šæ—¶é‡å‘ã€‚é€šå¸¸ç”¨äºæ¶ˆæ¯é€šçŸ¥æ“ä½œã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FailbackCluster</span> <span class="keyword">implements</span> <span class="title">Cluster</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String NAME = <span class="string">"failback"</span>;</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">join</span><span class="params">(Directory&lt;T&gt; directory)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FailbackClusterInvoker&lt;T&gt;(directory);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¯¹åº” Invoker å®ç°ç±»ä¸º FailbackClusterInvoker ã€‚</li>
</ul>
<h2 id="4-1-FailbackClusterInvoker">4.1 FailbackClusterInvoker</h2>
<p><code>com.alibaba.dubbo.rpc.cluster.support.FailbackClusterInvoker</code>&nbsp;ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒFailbackCluster Invoker å®ç°ç±»ã€‚</p>
<h3 id="4-1-1-æ„é€ æ–¹æ³•">4.1.1 æ„é€ æ–¹æ³•</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é‡è¯•é¢‘ç‡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> RETRY_FAILED_PERIOD = <span class="number">5</span> * <span class="number">1000</span>;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ScheduledExecutorService å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(<span class="number">2</span>, <span class="keyword">new</span> NamedThreadFactory(<span class="string">"failback-cluster-timer"</span>, <span class="keyword">true</span>));</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å¤±è´¥ä»»åŠ¡é›†åˆ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Invocation, AbstractClusterInvoker&lt;?&gt;&gt; failed = <span class="keyword">new</span> ConcurrentHashMap&lt;Invocation, AbstractClusterInvoker&lt;?&gt;&gt;();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é‡è¯•ä»»åŠ¡ Future</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> ScheduledFuture&lt;?&gt; retryFuture;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FailbackClusterInvoker</span><span class="params">(Directory&lt;T&gt; directory)</span> </span>{</span><br /><span class="line">    <span class="keyword">super</span>(directory);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ‰€æœ‰å­—æ®µï¼Œéƒ½æ˜¯å’Œé‡è¯•ç›¸å…³ï¼Œèƒ–å‹çœ‹ä¸‹æ³¨é‡Šã€‚</li>
</ul>
<h3 id="4-1-2-doInvoke">4.1.2 doInvoke</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> Result <span class="title">doInvoke</span><span class="params">(Invocation invocation, List&lt;Invoker&lt;T&gt;&gt; invokers, LoadBalance loadbalance)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="comment">// æ£€æŸ¥ invokers å³å¯ç”¨Invokeré›†åˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œé‚£ä¹ˆæŠ›å‡ºå¼‚å¸¸</span></span><br /><span class="line">        checkInvokers(invokers, invocation);</span><br /><span class="line">        <span class="comment">// æ ¹æ®è´Ÿè½½å‡è¡¡æœºåˆ¶ä» invokers ä¸­é€‰æ‹©ä¸€ä¸ªInvoker</span></span><br /><span class="line">        Invoker&lt;T&gt; invoker = select(loadbalance, invocation, invokers, <span class="keyword">null</span>);</span><br /><span class="line">        <span class="comment">// RPC è°ƒç”¨å¾—åˆ° Result</span></span><br /><span class="line">        <span class="keyword">return</span> invoker.invoke(invocation);</span><br /><span class="line">    } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line">        logger.error(<span class="string">"Failback to invoke method "</span> + invocation.getMethodName() + <span class="string">", wait for retry in background. Ignored exception: "</span> + e.getMessage() + <span class="string">", "</span>, e);</span><br /><span class="line">        <span class="comment">// æ·»åŠ åˆ°å¤±è´¥ä»»åŠ¡</span></span><br /><span class="line">        addFailed(invocation, <span class="keyword">this</span>);</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(); <span class="comment">// ignore</span></span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è‹¥ RPC è°ƒç”¨å¤±è´¥ï¼Œåˆ™è°ƒç”¨&nbsp;<code>#addFailed(invocation, this)</code>&nbsp;æ–¹æ³•ï¼Œæ·»åŠ åˆ°&nbsp;<code>failed</code>&nbsp;ä¸­ï¼Œåå°å®šæ—¶é‡è¯•ã€‚</li>
</ul>
<h3 id="4-1-3-addFailed">4.1.3 addFailed</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addFailed</span><span class="params">(Invocation invocation, AbstractClusterInvoker&lt;?&gt; router)</span> </span>{</span><br /><span class="line">    <span class="comment">// è‹¥å®šæ—¶ä»»åŠ¡æœªåˆå§‹åŒ–ï¼Œè¿›è¡Œåˆ›å»º</span></span><br /><span class="line">    <span class="keyword">if</span> (retryFuture == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</span><br /><span class="line">            <span class="keyword">if</span> (retryFuture == <span class="keyword">null</span>) {</span><br /><span class="line">                retryFuture = scheduledExecutorService.scheduleWithFixedDelay(<span class="keyword">new</span> Runnable() {</span><br /><br /><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br /><span class="line">                        <span class="comment">// collect retry statistics</span></span><br /><span class="line">                        <span class="keyword">try</span> {</span><br /><span class="line">                            retryFailed();</span><br /><span class="line">                        } <span class="keyword">catch</span> (Throwable t) { <span class="comment">// Defensive fault tolerance</span></span><br /><span class="line">                            logger.error(<span class="string">"Unexpected error occur at collect statistic"</span>, t);</span><br /><span class="line">                        }</span><br /><span class="line">                    }</span><br /><span class="line">                }, RETRY_FAILED_PERIOD, RETRY_FAILED_PERIOD, TimeUnit.MILLISECONDS);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// æ·»åŠ åˆ°å¤±è´¥ä»»åŠ¡</span></span><br /><span class="line">    failed.put(invocation, router);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>åˆ›å»ºçš„å®šæ—¶ä»»åŠ¡ï¼Œä¼šè°ƒç”¨&nbsp;<code>#retryFailed()</code>&nbsp;æ–¹æ³•ï¼Œé‡è¯•ä»»åŠ¡ï¼Œå‘èµ· RCP è°ƒç”¨ã€‚</li>
</ul>
<h3 id="4-1-4-retryFailed">4.1.4 retryFailed</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">retryFailed</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (failed.size() == <span class="number">0</span>) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// å¾ªç¯é‡è¯•ä»»åŠ¡ï¼Œé€ä¸ªè°ƒç”¨</span></span><br /><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;Invocation, AbstractClusterInvoker&lt;?&gt;&gt; entry : <span class="keyword">new</span> HashMap&lt;Invocation, AbstractClusterInvoker&lt;?&gt;&gt;(failed).entrySet()) { <span class="comment">// åˆ›å»ºé›†åˆ</span></span><br /><span class="line">        Invocation invocation = entry.getKey();</span><br /><span class="line">        Invoker&lt;?&gt; invoker = entry.getValue();</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            <span class="comment">// RPC è°ƒç”¨å¾—åˆ° Result</span></span><br /><span class="line">            invoker.invoke(invocation);</span><br /><span class="line">            <span class="comment">// ç§»é™¤å¤±è´¥ä»»åŠ¡</span></span><br /><span class="line">            failed.remove(invocation);</span><br /><span class="line">        } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line">            logger.error(<span class="string">"Failed retry to invoke method "</span> + invocation.getMethodName() + <span class="string">", waiting again."</span>, e);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¾ªç¯é‡è¯•ä»»åŠ¡ï¼Œé€ä¸ªå‘èµ· RPC è°ƒç”¨ã€‚è‹¥è°ƒç”¨æˆåŠŸï¼Œç§»é™¤è¯¥å¤±è´¥ä»»åŠ¡å‡º&nbsp;<code>failed</code>&nbsp;é›†åˆã€‚</li>
</ul>
<p>åœ¨æç«¯æƒ…å†µä¸‹ï¼Œå­˜åœ¨ä¸€ä¸ª BUG ï¼Œå¤ç°æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>å‡è®¾ç›®å‰æœ‰ä¸¤ä¸ªæœåŠ¡æä¾›è€… Aã€B ã€‚</li>
<li>é¦–å…ˆè°ƒç”¨ A æœåŠ¡ï¼Œå‡è®¾è¶…æ—¶ï¼Œæ·»åŠ åˆ°&nbsp;<code>failed</code>&nbsp;ä¸­ã€‚</li>
<li>é‡è¯•è°ƒç”¨ B æœåŠ¡ï¼ˆA æœåŠ¡äº¦å¯ï¼‰ï¼Œå‡è®¾å†æ¬¡è¶…æ—¶ï¼Œæ·»åŠ åˆ°&nbsp;<code>failed</code>&nbsp;ä¸­ã€‚</li>
<li>å› ä¸º&nbsp;<code>#doInvoker(...)</code>&nbsp;æ–¹æ³•ï¼Œè°ƒç”¨å¤±è´¥ï¼Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼ˆå½“ç„¶ä¹Ÿä¸èƒ½ï¼‰ï¼Œå¯¼è‡´&nbsp;<code>#retryFailed(...)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>è¯¯ä»¥ä¸º</strong>è°ƒç”¨æˆåŠŸï¼Œé”™è¯¯çš„ç§»é™¤è¯¥å¤±è´¥ä»»åŠ¡å‡º&nbsp;<code>failed</code>&nbsp;é›†åˆã€‚</li>
</ol>
<p>é‚£ä¹ˆèƒ½ä¸èƒ½åœ¨&nbsp;<code>#retryFailed(...)</code>&nbsp;æ–¹æ³•ä¸­ï¼Œå…ˆç§»é™¤è¯¥å¤±è´¥ä»»åŠ¡å‡º&nbsp;<code>failed</code>&nbsp;é›†åˆå‘¢ï¼Œå†å‘èµ· PRC è°ƒç”¨å‘¢ï¼Ÿç­”æ¡ˆæ˜¯<strong>ä¸å¯ä»¥</strong>ï¼Œå› ä¸ºåœ¨è°ƒç”¨&nbsp;<code>#doInvoke(...)</code>&nbsp;æ–¹æ³•ä¹‹å‰ï¼Œå¯èƒ½å‘ç”Ÿå¼‚å¸¸ï¼Œå¯¼è‡´å¤±è´¥ä»»åŠ¡çš„ä¸¢å¤±ã€‚</p>
<p>é‚£ä¹ˆè¯¥æ€ä¹ˆåŠï¼Ÿæœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
<ol>
<li>ä¸Šè¿°æ–¹æ¡ˆçš„åŸºç¡€ä¸Šï¼Œåœ¨&nbsp;<code>#retryFailed(...)</code>&nbsp;æ–¹æ³•çš„ç§»é™¤å¤„ç†ä¸­ï¼Œå¢åŠ è°ƒç”¨&nbsp;<code>#addFailed(...)</code>&nbsp;æ–¹æ³•ã€‚</li>
<li>æšä¸¾ä¸€ä¸ª&nbsp;<code>FAILED_RESULT</code>&nbsp;å¯¹è±¡ï¼Œè®©&nbsp;<code>#doInvoke(...)</code>&nbsp;æ–¹æ³•å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè¿”å›è¯¥å¯¹è±¡ã€‚è¿™æ ·&nbsp;<code>#retryFailed(...)</code>&nbsp;æ–¹æ³•ï¼Œåœ¨ç§»é™¤å‡º&nbsp;<code>failed</code>&nbsp;é›†åˆæ—¶ï¼Œå¢åŠ ä¸‹æ˜¯å¦æ‰§è¡ŒæˆåŠŸçš„åˆ¤æ–­ã€‚</li>
</ol>
<p>ç¬”è€…å€¾å‘ç¬¬äºŒç§ï¼Œé€»è¾‘æ›´åŠ çº¿æ€§å’Œæ˜“æ‡‚ã€‚</p>
<h1 id="5-FailfastCluster">5. FailfastCluster</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.support.FailfastCluster</code>&nbsp;ï¼Œå®ç° Cluster æ¥å£ï¼Œå¿«é€Ÿå¤±è´¥ï¼Œåªå‘èµ·ä¸€æ¬¡è°ƒç”¨ï¼Œ<strong>å¤±è´¥ç«‹å³æŠ¥é”™</strong>ã€‚é€šå¸¸ç”¨äº<strong>éå¹‚ç­‰æ€§çš„å†™æ“ä½œ</strong>ï¼Œæ¯”å¦‚æ–°å¢è®°å½•ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FailfastCluster</span> <span class="keyword">implements</span> <span class="title">Cluster</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String NAME = <span class="string">"failfast"</span>;</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">join</span><span class="params">(Directory&lt;T&gt; directory)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FailfastClusterInvoker&lt;T&gt;(directory);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¯¹åº” Invoker å®ç°ç±»ä¸º FailfastClusterInvoker ã€‚</li>
</ul>
<h2 id="5-1-FailfastInvoker">5.1 FailfastInvoker</h2>
<p><code>com.alibaba.dubbo.rpc.cluster.support.FailbackClusterInvoker</code>&nbsp;ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒFailfast Invoker å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FailfastClusterInvoker</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractClusterInvoker</span>&lt;<span class="title">T</span>&gt; </span>{</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FailfastClusterInvoker</span><span class="params">(Directory&lt;T&gt; directory)</span> </span>{</span><br /><span class="line">        <span class="keyword">super</span>(directory);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">doInvoke</span><span class="params">(Invocation invocation, List&lt;Invoker&lt;T&gt;&gt; invokers, LoadBalance loadbalance)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="comment">// æ£€æŸ¥ invokers å³å¯ç”¨Invokeré›†åˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œé‚£ä¹ˆæŠ›å‡ºå¼‚å¸¸</span></span><br /><span class="line">        checkInvokers(invokers, invocation);</span><br /><span class="line">        <span class="comment">// æ ¹æ®è´Ÿè½½å‡è¡¡æœºåˆ¶ä» invokers ä¸­é€‰æ‹©ä¸€ä¸ªInvoker</span></span><br /><span class="line">        Invoker&lt;T&gt; invoker = select(loadbalance, invocation, invokers, <span class="keyword">null</span>);</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            <span class="comment">// RPC è°ƒç”¨å¾—åˆ° Result</span></span><br /><span class="line">            <span class="keyword">return</span> invoker.invoke(invocation);</span><br /><span class="line">        } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line">            <span class="comment">// è‹¥æ˜¯ä¸šåŠ¡æ€§è´¨çš„å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º</span></span><br /><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RpcException &amp;&amp; ((RpcException) e).isBiz()) { <span class="comment">// biz exception.</span></span><br /><span class="line">                <span class="keyword">throw</span> (RpcException) e;</span><br /><span class="line">            }</span><br /><span class="line">            <span class="comment">// å°è£… RpcException å¼‚å¸¸ï¼Œå¹¶æŠ›å‡º</span></span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(e <span class="keyword">instanceof</span> RpcException ? ((RpcException) e).getCode() : <span class="number">0</span>,</span><br /><span class="line">                    <span class="string">"Failfast invoke providers "</span> + invoker.getUrl() + <span class="string">" "</span> + loadbalance.getClass().getSimpleName() + <span class="string">" select from all providers "</span> + invokers + <span class="string">" for service "</span> + getInterface().getName() + <span class="string">" method "</span> + invocation.getMethodName() + <span class="string">" on consumer "</span> + NetUtils.getLocalHost() + <span class="string">" use dubbo version "</span> + Version.getVersion() + <span class="string">", but no luck to perform the invocation. Last error is: "</span> + e.getMessage(), e.getCause() != <span class="keyword">null</span> ? e.getCause() : e);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å’Œ FailbackClusterInvoker å·®å¼‚ç‚¹ï¼Œåœ¨äºå¯¹å¼‚å¸¸çš„å¤„ç†ã€‚</li>
</ul>
<h1 id="6-FailsafeCluster">6. FailsafeCluster</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.support.FailsafeCluster</code>&nbsp;ï¼Œå®ç° Cluster æ¥å£ï¼Œå¤±è´¥å®‰å…¨ï¼Œ<strong>å‡ºç°å¼‚å¸¸æ—¶ï¼Œç›´æ¥å¿½ç•¥</strong>ã€‚é€šå¸¸ç”¨äºå†™å…¥å®¡è®¡æ—¥å¿—ç­‰æ“ä½œã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FailfastCluster</span> <span class="keyword">implements</span> <span class="title">Cluster</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String NAME = <span class="string">"failfast"</span>;</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">join</span><span class="params">(Directory&lt;T&gt; directory)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FailfastClusterInvoker&lt;T&gt;(directory);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¯¹åº” Invoker å®ç°ç±»ä¸º FailsafeClusterInvoker ã€‚</li>
</ul>
<h2 id="6-1-FailsafeClusterInvoker">6.1 FailsafeClusterInvoker</h2>
<p><code>com.alibaba.dubbo.rpc.cluster.support.FailsafeClusterInvoker</code>&nbsp;ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒFailsafe Invoker å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FailsafeClusterInvoker</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractClusterInvoker</span>&lt;<span class="title">T</span>&gt; </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(FailsafeClusterInvoker.class);</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FailsafeClusterInvoker</span><span class="params">(Directory&lt;T&gt; directory)</span> </span>{</span><br /><span class="line">        <span class="keyword">super</span>(directory);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">doInvoke</span><span class="params">(Invocation invocation, List&lt;Invoker&lt;T&gt;&gt; invokers, LoadBalance loadbalance)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            <span class="comment">// æ£€æŸ¥ invokers å³å¯ç”¨Invokeré›†åˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œé‚£ä¹ˆæŠ›å‡ºå¼‚å¸¸</span></span><br /><span class="line">            checkInvokers(invokers, invocation);</span><br /><span class="line">            <span class="comment">// æ ¹æ®è´Ÿè½½å‡è¡¡æœºåˆ¶ä» invokers ä¸­é€‰æ‹©ä¸€ä¸ªInvoker</span></span><br /><span class="line">            Invoker&lt;T&gt; invoker = select(loadbalance, invocation, invokers, <span class="keyword">null</span>);</span><br /><span class="line">            <span class="comment">// RPC è°ƒç”¨å¾—åˆ° Result</span></span><br /><span class="line">            <span class="keyword">return</span> invoker.invoke(invocation);</span><br /><span class="line">        } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line">            <span class="comment">// æ‰“å°å¼‚å¸¸æ—¥å¿—</span></span><br /><span class="line">            logger.error(<span class="string">"Failsafe ignore exception: "</span> + e.getMessage(), e);</span><br /><span class="line">            <span class="comment">// å¿½ç•¥å¼‚å¸¸</span></span><br /><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(); <span class="comment">// ignore</span></span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å’Œ FailfastInvoker å·®å¼‚ç‚¹ï¼Œåœ¨äºå¯¹å¼‚å¸¸çš„å¤„ç†ã€‚</li>
</ul>
<h1 id="7-ForkingCluster">7. ForkingCluster</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.support.ForkingCluster</code>&nbsp;ï¼Œå®ç° Cluster æ¥å£ï¼Œå¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡å™¨ï¼Œåªè¦ä¸€ä¸ªæˆåŠŸå³è¿”å›ã€‚é€šå¸¸ç”¨äºå®æ—¶æ€§è¦æ±‚è¾ƒé«˜çš„è¯»æ“ä½œï¼Œä½†éœ€è¦æµªè´¹æ›´å¤šæœåŠ¡èµ„æºã€‚å¯é€šè¿‡&nbsp;<code>forks="2"</code>&nbsp;æ¥è®¾ç½®æœ€å¤§å¹¶è¡Œæ•°ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForkingCluster</span> <span class="keyword">implements</span> <span class="title">Cluster</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String NAME = <span class="string">"forking"</span>;</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">join</span><span class="params">(Directory&lt;T&gt; directory)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ForkingClusterInvoker&lt;T&gt;(directory);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="7-1-ForkingClusterInvoker">7.1 ForkingClusterInvoker</h2>
<blockquote>
<p>è€è‰¿è‰¿ï¼šBlockQueue çš„ä½¿ç”¨ï¼Œéå¸¸ç²¾é«“ï¼</p>
</blockquote>
<p><code>com.alibaba.dubbo.rpc.cluster.support.ForkingClusterInvoker</code>&nbsp;ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼ŒForkingCluster Invoker å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ForkingClusterInvoker</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractClusterInvoker</span>&lt;<span class="title">T</span>&gt; </span>{</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 4:      * ExecutorService å¯¹è±¡ï¼Œå¹¶ä¸”ä¸º CachedThreadPool ã€‚</span></span><br /><span class="line"><span class="comment"> 5:      */</span></span><br /><span class="line"> <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService executor = Executors.newCachedThreadPool(<span class="keyword">new</span> NamedThreadFactory(<span class="string">"forking-cluster-timer"</span>, <span class="keyword">true</span>));</span><br /><span class="line"> <span class="number">7</span>: </span><br /><span class="line"> <span class="number">8</span>:     <span class="function"><span class="keyword">public</span> <span class="title">ForkingClusterInvoker</span><span class="params">(Directory&lt;T&gt; directory)</span> </span>{</span><br /><span class="line"> <span class="number">9</span>:         <span class="keyword">super</span>(directory);</span><br /><span class="line"><span class="number">10</span>:     }</span><br /><span class="line"><span class="number">11</span>: </span><br /><span class="line"><span class="number">12</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">13</span>:     <span class="meta">@SuppressWarnings</span>({<span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span>})</span><br /><span class="line"><span class="number">14</span>:     <span class="function"><span class="keyword">public</span> Result <span class="title">doInvoke</span><span class="params">(<span class="keyword">final</span> Invocation invocation, List&lt;Invoker&lt;T&gt;&gt; invokers, LoadBalance loadbalance)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"><span class="number">15</span>:         <span class="comment">// æ£€æŸ¥ invokers å³å¯ç”¨Invokeré›†åˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œé‚£ä¹ˆæŠ›å‡ºå¼‚å¸¸</span></span><br /><span class="line"><span class="number">16</span>:         checkInvokers(invokers, invocation);</span><br /><span class="line"><span class="number">17</span>:         <span class="comment">// ä¿å­˜é€‰æ‹©çš„ Invoker é›†åˆ</span></span><br /><span class="line"><span class="number">18</span>:         <span class="keyword">final</span> List&lt;Invoker&lt;T&gt;&gt; selected;</span><br /><span class="line"><span class="number">19</span>:         <span class="comment">// å¾—åˆ°æœ€å¤§å¹¶è¡Œæ•°ï¼Œé»˜è®¤ä¸º Constants.DEFAULT_FORKS = 2</span></span><br /><span class="line"><span class="number">20</span>:         <span class="keyword">final</span> <span class="keyword">int</span> forks = getUrl().getParameter(Constants.FORKS_KEY, Constants.DEFAULT_FORKS);</span><br /><span class="line"><span class="number">21</span>:         <span class="comment">// è·å¾—è°ƒç”¨è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º DEFAULT_TIMEOUT = 1000 æ¯«ç§’</span></span><br /><span class="line"><span class="number">22</span>:         <span class="keyword">final</span> <span class="keyword">int</span> timeout = getUrl().getParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);</span><br /><span class="line"><span class="number">23</span>:         <span class="comment">// è‹¥æœ€å¤§å¹¶è¡Œä¹¦å°äºç­‰äº 0ï¼Œæˆ–è€…å¤§äº invokers çš„æ•°é‡ï¼Œç›´æ¥ä½¿ç”¨ invokers</span></span><br /><span class="line"><span class="number">24</span>:         <span class="keyword">if</span> (forks &lt;= <span class="number">0</span> || forks &gt;= invokers.size()) {</span><br /><span class="line"><span class="number">25</span>:             selected = invokers;</span><br /><span class="line"><span class="number">26</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">27</span>:             <span class="comment">// å¾ªç¯ï¼Œæ ¹æ®è´Ÿè½½å‡è¡¡æœºåˆ¶ä» invokersï¼Œä¸­é€‰æ‹©ä¸€ä¸ªä¸ªInvoker ï¼Œä»è€Œç»„æˆ Invoker é›†åˆã€‚</span></span><br /><span class="line"><span class="number">28</span>:             <span class="comment">// æ³¨æ„ï¼Œå› ä¸ºå¢åŠ äº†æ’é‡é€»è¾‘ï¼Œæ‰€ä»¥ä¸èƒ½ä¿è¯è·å¾—çš„ Invoker é›†åˆçš„å¤§å°ï¼Œå°äºæœ€å¤§å¹¶è¡Œæ•°</span></span><br /><span class="line"><span class="number">29</span>:             selected = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;();</span><br /><span class="line"><span class="number">30</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; forks; i++) {</span><br /><span class="line"><span class="number">31</span>:                 <span class="comment">// åœ¨invokeråˆ—è¡¨(æ’é™¤selected)å,å¦‚æœæ²¡æœ‰é€‰å¤Ÿ,åˆ™å­˜åœ¨é‡å¤å¾ªç¯é—®é¢˜.è§selectå®ç°.</span></span><br /><span class="line"><span class="number">32</span>:                 Invoker&lt;T&gt; invoker = select(loadbalance, invocation, invokers, selected);</span><br /><span class="line"><span class="number">33</span>:                 <span class="keyword">if</span> (!selected.contains(invoker)) { <span class="comment">//Avoid add the same invoker several times. //é˜²æ­¢é‡å¤æ·»åŠ invoker</span></span><br /><span class="line"><span class="number">34</span>:                     selected.add(invoker);</span><br /><span class="line"><span class="number">35</span>:                 }</span><br /><span class="line"><span class="number">36</span>:             }</span><br /><span class="line"><span class="number">37</span>:         }</span><br /><span class="line"><span class="number">38</span>:         <span class="comment">// è®¾ç½®å·²ç»è°ƒç”¨çš„ Invoker é›†åˆï¼Œåˆ° Context ä¸­</span></span><br /><span class="line"><span class="number">39</span>:         RpcContext.getContext().setInvokers((List) selected);</span><br /><span class="line"><span class="number">40</span>:         <span class="comment">// å¼‚å¸¸è®¡æ•°å™¨</span></span><br /><span class="line"><span class="number">41</span>:         <span class="keyword">final</span> AtomicInteger count = <span class="keyword">new</span> AtomicInteger();</span><br /><span class="line"><span class="number">42</span>:         <span class="comment">// åˆ›å»ºé˜»å¡é˜Ÿåˆ—</span></span><br /><span class="line"><span class="number">43</span>:         <span class="keyword">final</span> BlockingQueue&lt;Object&gt; ref = <span class="keyword">new</span> LinkedBlockingQueue&lt;Object&gt;();</span><br /><span class="line"><span class="number">44</span>:         <span class="comment">// å¾ªç¯ selected é›†åˆï¼Œæäº¤çº¿ç¨‹æ± ï¼Œå‘èµ· RPC è°ƒç”¨</span></span><br /><span class="line"><span class="number">45</span>:         <span class="keyword">for</span> (<span class="keyword">final</span> Invoker&lt;T&gt; invoker : selected) {</span><br /><span class="line"><span class="number">46</span>:             executor.execute(<span class="keyword">new</span> Runnable() {</span><br /><span class="line"><span class="number">47</span>:                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">48</span>:                     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">49</span>:                         <span class="comment">// RPC è°ƒç”¨ï¼Œè·å¾— Result ç»“æœ</span></span><br /><span class="line"><span class="number">50</span>:                         Result result = invoker.invoke(invocation);</span><br /><span class="line"><span class="number">51</span>:                         <span class="comment">// æ·»åŠ  Result åˆ° `ref` é˜»å¡é˜Ÿåˆ—</span></span><br /><span class="line"><span class="number">52</span>:                         ref.offer(result);</span><br /><span class="line"><span class="number">53</span>:                     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">54</span>:                         <span class="comment">// å¼‚å¸¸è®¡æ•°å™¨ + 1</span></span><br /><span class="line"><span class="number">55</span>:                         <span class="keyword">int</span> value = count.incrementAndGet();</span><br /><span class="line"><span class="number">56</span>:                         <span class="comment">// è‹¥ RPC è°ƒç”¨ç»“æœéƒ½æ˜¯å¼‚å¸¸ï¼Œåˆ™æ·»åŠ å¼‚å¸¸åˆ° `ref` é˜»å¡é˜Ÿåˆ—</span></span><br /><span class="line"><span class="number">57</span>:                         <span class="keyword">if</span> (value &gt;= selected.size()) {</span><br /><span class="line"><span class="number">58</span>:                             ref.offer(e);</span><br /><span class="line"><span class="number">59</span>:                         }</span><br /><span class="line"><span class="number">60</span>:                     }</span><br /><span class="line"><span class="number">61</span>:                 }</span><br /><span class="line"><span class="number">62</span>:             });</span><br /><span class="line"><span class="number">63</span>:         }</span><br /><span class="line"><span class="number">64</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">65</span>:             <span class="comment">// ä» `ref` é˜Ÿåˆ—ä¸­ï¼Œé˜»å¡ç­‰å¾…ç»“æœ</span></span><br /><span class="line"><span class="number">66</span>:             Object ret = ref.poll(timeout, TimeUnit.MILLISECONDS);</span><br /><span class="line"><span class="number">67</span>:             <span class="comment">// è‹¥æ˜¯å¼‚å¸¸ç»“æœï¼ŒæŠ›å‡º RpcException å¼‚å¸¸</span></span><br /><span class="line"><span class="number">68</span>:             <span class="keyword">if</span> (ret <span class="keyword">instanceof</span> Throwable) {</span><br /><span class="line"><span class="number">69</span>:                 Throwable e = (Throwable) ret;</span><br /><span class="line"><span class="number">70</span>:                 <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(e <span class="keyword">instanceof</span> RpcException ? ((RpcException) e).getCode() : <span class="number">0</span>, <span class="string">"Failed to forking invoke provider "</span> + selected + <span class="string">", but no luck to perform the invocation. Last error is: "</span> + e.getMessage(), e.getCause() != <span class="keyword">null</span> ? e.getCause() : e);</span><br /><span class="line"><span class="number">71</span>:             }</span><br /><span class="line"><span class="number">72</span>:             <span class="comment">// è‹¥æ˜¯æ­£å¸¸ç»“æœï¼Œç›´æ¥è¿”å›</span></span><br /><span class="line"><span class="number">73</span>:             <span class="keyword">return</span> (Result) ret;</span><br /><span class="line"><span class="number">74</span>:         } <span class="keyword">catch</span> (InterruptedException e) {</span><br /><span class="line"><span class="number">75</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Failed to forking invoke provider "</span> + selected + <span class="string">", but no luck to perform the invocation. Last error is: "</span> + e.getMessage(), e);</span><br /><span class="line"><span class="number">76</span>:         }</span><br /><span class="line"><span class="number">77</span>:     }</span><br /><span class="line"><span class="number">78</span>: </span><br /><span class="line"><span class="number">79</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 15 è‡³ 39 è¡Œï¼šèƒ–å‹è‡ªå·±çœ‹ä»£ç æ³¨é‡Šï¼Œæ¯”è¾ƒæ˜“æ‡‚ã€‚</li>
<li>ç¬¬ 41 è¡Œï¼š<code>count</code>&nbsp;å˜é‡ï¼Œ<strong>å¼‚å¸¸</strong>è®¡æ•°å™¨ã€‚</li>
<li>ç¬¬ 43 è¡Œï¼š<code>ref</code>&nbsp;å˜é‡ï¼Œé˜»å¡é˜Ÿåˆ—ã€‚é€šè¿‡å®ƒï¼Œå®ç°çº¿ç¨‹æ± å¼‚æ­¥æ‰§è¡Œä»»åŠ¡çš„<strong>ç»“æœé€šçŸ¥</strong>ï¼Œéå¸¸äº®çœ¼ã€‚</li>
<li>ç¬¬ 44 è‡³ 63 è¡Œï¼šå¾ªç¯&nbsp;<code>selected</code>&nbsp;é›†åˆï¼Œæäº¤çº¿ç¨‹æ± ï¼Œå‘èµ· RPC è°ƒç”¨ã€‚
<ul>
<li>ç¬¬ 49 è‡³ 52 è¡Œï¼šè°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼ŒRPC è°ƒç”¨ï¼Œ<strong>æˆåŠŸ</strong>è·å¾— Result ç»“æœï¼Œå¹¶å°† Result æ·»åŠ åˆ°&nbsp;<code>ref</code>&nbsp;é˜»å¡é˜Ÿåˆ—ä¸­ã€‚</li>
<li>ç¬¬ 53 è‡³ 59 è¡Œï¼šè‹¥è°ƒç”¨<strong>å¤±è´¥</strong>ï¼Œå¼‚å¸¸è®¡æ•°å™¨&nbsp;<code>count</code>&nbsp;åŠ ä¸€ã€‚å½“æ‰€æœ‰çš„ RPC è°ƒç”¨éƒ½å®Œæˆï¼Œå¹¶ä¸”éƒ½æ˜¯å¼‚å¸¸æ—¶ï¼Œåˆ™æ·»åŠ <strong>æœ€åä¸€ä¸ª</strong>å¼‚å¸¸åˆ°&nbsp;<code>ref</code>&nbsp;é˜»å¡é˜Ÿåˆ—ã€‚ğŸ™‚ ç»†èŠ‚å¤„ç†å¾ˆåˆ°ä½ã€‚</li>
</ul>
</li>
<li>ç¬¬ 66 è¡Œï¼šä»&nbsp;<code>ref</code>&nbsp;é˜Ÿåˆ—ä¸­ï¼Œ<strong>é˜»å¡</strong>ç­‰å¾…ï¼Œç›´åˆ°è·å¾—åˆ°ç»“æœæˆ–è€…è¶…æ—¶ã€‚è‡³æ­¤ï¼ŒForkingClusterInvoker å®ç°äº†å¹¶è¡Œè°ƒç”¨ï¼Œä¸”åªè¦ä¸€ä¸ªæˆåŠŸå³è¿”å›ã€‚å½“ç„¶ï¼Œè¿˜æœ‰ä¸€ä¸ªéšæ€§çš„ï¼Œ<strong>æ‰€æœ‰éƒ½å¤±è´¥æ‰è¿”å›</strong>ã€‚</li>
<li>ç¬¬ 67 è‡³ 76 è¡Œï¼šå¤„ç†ç­‰å¾…çš„&ldquo;ç»“æœ&rdquo;ã€‚</li>
</ul>
<h1 id="8-FailoverCluster">8. FailoverCluster</h1>
<p>FailoverCluster ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-1-api-interface//?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹</a>&nbsp;ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å·²ç»è¯¦ç»†è§£æã€‚</p>
<h1 id="9-MergeableCluster">9. MergeableCluster</h1>
<p>MergeableCluster ï¼Œå¯¹åº”&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/group-merger.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; åˆ†ç»„èšåˆã€‹</a>&nbsp;æ–‡æ¡£ï¼Œæˆ‘ä»¬åç»­å•ç‹¬å†™æ–‡ç« åˆ†äº«ã€‚</p>
<h1 id="10-MockClusterWrapper">10. MockClusterWrapper</h1>
<p>MockClusterWrapper ï¼Œå¯¹åº”&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/local-mock.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash;æœ¬åœ°ä¼ªè£… ã€‹</a>&nbsp;æ–‡æ¡£ï¼Œæˆ‘ä»¬åç»­å•ç‹¬å†™æ–‡ç« åˆ†äº«ã€‚</p>
</div>