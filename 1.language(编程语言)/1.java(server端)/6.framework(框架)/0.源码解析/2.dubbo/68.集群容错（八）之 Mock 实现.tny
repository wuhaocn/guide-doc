<header class="article-header">
<h1 class="article-title">é›†ç¾¤å®¹é”™ï¼ˆå…«ï¼‰ä¹‹ Mock å®ç°</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡æ¥&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-7-impl-router/?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆä¸ƒï¼‰ä¹‹ Router å®ç°ã€‹</a>&nbsp;ä¸€æ–‡ï¼Œåˆ†äº«&nbsp;<code>dubbo-cluster</code>&nbsp;æ¨¡å—ï¼Œ&nbsp;<code>mock</code>&nbsp;åŒ…ï¼Œå®ç° Dubbo å¦‚ä¸‹åŠŸèƒ½ï¼š</p>
<ul>
<li><strong>æœ¬åœ°ä¼ªè£…</strong>ï¼šé€šå¸¸ç”¨äºæœåŠ¡é™çº§ï¼Œæ¯”å¦‚æŸéªŒæƒæœåŠ¡ï¼Œå½“æœåŠ¡æä¾›æ–¹å…¨éƒ¨æŒ‚æ‰åï¼Œå®¢æˆ·ç«¯ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯é€šè¿‡ Mock æ•°æ®è¿”å›æˆæƒå¤±è´¥ã€‚</li>
<li><strong>æœåŠ¡é™çº§</strong>ï¼šå¯ä»¥é€šè¿‡æœåŠ¡é™çº§åŠŸèƒ½ï¼Œä¸´æ—¶å±è”½æŸä¸ªå‡ºé”™çš„éå…³é”®æœåŠ¡ï¼Œå¹¶å®šä¹‰é™çº§åçš„è¿”å›ç­–ç•¥ã€‚</li>
</ul>
<blockquote>
<p>è€è‰¿è‰¿ï¼šå¦‚æœä¸ç†Ÿæ‚‰çš„èƒ–å‹ï¼Œæ¨èç»“åˆç€&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/local-mock.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; æœ¬åœ°ä¼ªè£…ã€‹</a>&nbsp;å’Œ&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/service-downgrade.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; æœåŠ¡é™çº§ã€‹</a>&nbsp;ä¸€èµ·å­¦ä¹ ã€‚</p>
</blockquote>
<ul>
<li><strong>æ³¨æ„</strong>ï¼Œ<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/local-mock.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; æœ¬åœ°ä¼ªè£…ã€‹</a>&nbsp;çš„æ–‡æ¡£æœ‰ç‚¹é—®é¢˜ï¼šSpring XML æ˜¯é€šè¿‡&nbsp;<code>&lt;dubbo:reference /&gt;</code>&nbsp;é…ç½®ï¼Œè€Œä¸æ˜¯&nbsp;<code>&lt;dubbo:service /&gt;</code>&nbsp;ã€‚</li>
</ul>
<p>æœ¬æ–‡æ¶‰åŠç±»å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_05_05/01.png" alt="Mock ç›¸å…³ç±»" /></p>
<ul>
<li>åˆ†æˆä¸¤ä¸ªéƒ¨åˆ†ï¼š
<ul>
<li>MockClusterWrapper + MockClusterInvoker + MockClusterSelector</li>
<li>MockProtocol + MockInvoker</li>
</ul>
</li>
</ul>
<h1 id="2-MockClusterWrapper">2. MockClusterWrapper</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.support.wrapper.MockClusterWrapper</code>&nbsp;ï¼Œå®ç° Cluster æ¥å£ï¼ŒMock Cluster&nbsp;<strong>Wrapper</strong>&nbsp;å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MockClusterWrapper</span> <span class="keyword">implements</span> <span class="title">Cluster</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * çœŸæ­£çš„ Cluster å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> Cluster cluster;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MockClusterWrapper</span><span class="params">(Cluster cluster)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.cluster = cluster;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">join</span><span class="params">(Directory&lt;T&gt; directory)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MockClusterInvoker&lt;T&gt;(directory, <span class="comment">// &lt;2&gt;</span></span><br /><span class="line">                <span class="keyword">this</span>.cluster.join(directory)); <span class="comment">// &lt;1&gt;</span></span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>cluster</code>&nbsp;å­—æ®µï¼Œ<strong>çœŸæ­£</strong>çš„ Cluster å¯¹è±¡ã€‚å› ä¸º MockClusterWrapper æ˜¯ Dubbo SPI Wrapper ç±»ï¼Œ<strong>æ‰€ä»¥å¯¹åº”çš„ Cluster å¯¹è±¡ï¼Œéƒ½ä¼šè¢«å®ƒæ‰€åŒ…è£…</strong>ã€‚ä¸ç†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹ä¸‹&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æ‹“å±•æœºåˆ¶ SPIã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-8-impl-mock/">ã€Œ4.4.2 createExtensionã€</a>&nbsp;çš„ã€ç¬¬ 24 è‡³ 30 è¡Œã€‘ã€‚</li>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼šè°ƒç”¨&nbsp;<code>Cluster#join(directory)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º<strong>çœŸæ­£</strong>çš„ Cluster Invoker å¯¹è±¡ã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼šåˆ›å»º MockClusterInvoker å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-8-impl-mock/">ã€Œ3. MockClusterInvokerã€</a>&nbsp;ã€‚</li>
</ul>
<h1 id="3-MockClusterInvoker">3. MockClusterInvoker</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.support.wrapper.MockClusterInvoker</code>&nbsp;ï¼Œå®ç° Invoker æ¥å£ï¼Œ<strong>MockClusterWrapper</strong>&nbsp;å¯¹åº”çš„ Invoker å®ç°ç±»ã€‚</p>
<h2 id="3-1-æ„é€ æ–¹æ³•">3.1 æ„é€ æ–¹æ³•</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Directory&lt;T&gt; directory;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * çœŸæ­£çš„ Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Invoker&lt;T&gt; invoker;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MockClusterInvoker</span><span class="params">(Directory&lt;T&gt; directory, Invoker&lt;T&gt; invoker)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.directory = directory;</span><br /><span class="line">    <span class="keyword">this</span>.invoker = invoker;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="3-2-invoke">3.2 invoke</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">3</span>:     Result result;</span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// è·å¾— "mock" é…ç½®é¡¹ï¼Œæœ‰å¤šç§é…ç½®æ–¹å¼</span></span><br /><span class="line"> <span class="number">5</span>:     String value = directory.getUrl().getMethodParameter(invocation.getMethodName(), Constants.MOCK_KEY, Boolean.FALSE.toString()).trim();</span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">//ã€ç¬¬ä¸€ç§ã€‘æ—  mock</span></span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (value.length() == <span class="number">0</span> || value.equalsIgnoreCase(<span class="string">"false"</span>)) {</span><br /><span class="line"> <span class="number">8</span>:         <span class="comment">// no mock</span></span><br /><span class="line"> <span class="number">9</span>:         <span class="comment">// è°ƒç”¨åŸ Invoker ï¼Œå‘èµ· RPC è°ƒç”¨</span></span><br /><span class="line"><span class="number">10</span>:         result = <span class="keyword">this</span>.invoker.invoke(invocation);</span><br /><span class="line"><span class="number">11</span>:     <span class="comment">//ã€ç¬¬äºŒç§ã€‘å¼ºåˆ¶æœåŠ¡é™çº§ http://dubbo.apache.org/zh-cn/docs/user/demos/service-downgrade.html</span></span><br /><span class="line"><span class="number">12</span>:     } <span class="keyword">else</span> <span class="keyword">if</span> (value.startsWith(<span class="string">"force"</span>)) {</span><br /><span class="line"><span class="number">13</span>:         <span class="keyword">if</span> (logger.isWarnEnabled()) {</span><br /><span class="line"><span class="number">14</span>:             logger.info(<span class="string">"force-mock: "</span> + invocation.getMethodName() + <span class="string">" force-mock enabled , url : "</span> + directory.getUrl());</span><br /><span class="line"><span class="number">15</span>:         }</span><br /><span class="line"><span class="number">16</span>:         <span class="comment">// force:direct mock</span></span><br /><span class="line"><span class="number">17</span>:         <span class="comment">// ç›´æ¥è°ƒç”¨ Mock Invoker ï¼Œæ‰§è¡Œæœ¬åœ° Mock é€»è¾‘</span></span><br /><span class="line"><span class="number">18</span>:         result = doMockInvoke(invocation, <span class="keyword">null</span>);</span><br /><span class="line"><span class="number">19</span>:     <span class="comment">// ã€ç¬¬ä¸‰ç§ã€‘å¤±è´¥æœåŠ¡é™çº§ http://dubbo.apache.org/zh-cn/docs/user/demos/service-downgrade.html</span></span><br /><span class="line"><span class="number">20</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">21</span>:         <span class="comment">// fail-mock</span></span><br /><span class="line"><span class="number">22</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">23</span>:             <span class="comment">// è°ƒç”¨åŸ Invoker ï¼Œå‘èµ· RPC è°ƒç”¨</span></span><br /><span class="line"><span class="number">24</span>:             result = <span class="keyword">this</span>.invoker.invoke(invocation);</span><br /><span class="line"><span class="number">25</span>:         } <span class="keyword">catch</span> (RpcException e) {</span><br /><span class="line"><span class="number">26</span>:             <span class="comment">// ä¸šåŠ¡æ€§å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º</span></span><br /><span class="line"><span class="number">27</span>:             <span class="keyword">if</span> (e.isBiz()) {</span><br /><span class="line"><span class="number">28</span>:                 <span class="keyword">throw</span> e;</span><br /><span class="line"><span class="number">29</span>:             } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">30</span>:                 <span class="keyword">if</span> (logger.isWarnEnabled()) {</span><br /><span class="line"><span class="number">31</span>:                     logger.info(<span class="string">"fail-mock: "</span> + invocation.getMethodName() + <span class="string">" fail-mock enabled , url : "</span> + directory.getUrl(), e);</span><br /><span class="line"><span class="number">32</span>:                 }</span><br /><span class="line"><span class="number">33</span>:                 <span class="comment">// å¤±è´¥åï¼Œè°ƒç”¨ Mock Invoker ï¼Œæ‰§è¡Œæœ¬åœ° Mock é€»è¾‘</span></span><br /><span class="line"><span class="number">34</span>:                 result = doMockInvoke(invocation, e);</span><br /><span class="line"><span class="number">35</span>:             }</span><br /><span class="line"><span class="number">36</span>:         }</span><br /><span class="line"><span class="number">37</span>:     }</span><br /><span class="line"><span class="number">38</span>:     <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">39</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 5 è¡Œï¼šè·å¾—&nbsp;<code>"mock"</code>&nbsp;é…ç½®é¡¹ã€‚æ ¹æ®ä¸åŒçš„é…ç½®ï¼Œåˆ†æˆ<strong>ä¸‰ç§</strong>æƒ…å†µã€‚</li>
<li>========== ç¬¬ä¸€ç§ï¼š<strong>æ—  Mock</strong>&nbsp;==========</li>
<li>ç¬¬ 10 è¡Œï¼šåªè°ƒç”¨<strong>çœŸæ­£çš„</strong>&nbsp;<code>invoker</code>&nbsp;çš„&nbsp;<code>#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼Œå‘èµ· RPC è°ƒç”¨ï¼Œ<strong>å³ä¸è¿›è¡Œ Mock é€»è¾‘</strong>ã€‚</li>
<li>========== ç¬¬äºŒç§ï¼š<strong>å¼ºåˆ¶æœåŠ¡é™çº§</strong>&nbsp;==========</li>
<li>ç¬¬ 12 è¡Œï¼š<code>"mock"</code>&nbsp;é…ç½®é¡¹ä»¥&nbsp;<code>"force"</code>&nbsp;<strong>å¼€å¤´</strong>ï¼Œ<strong>å¼ºåˆ¶</strong>æœåŠ¡é™çº§ï¼Œå³&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/service-downgrade.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; æœåŠ¡é™çº§ã€‹</a>&nbsp;ã€‚</li>
<li>ç¬¬ 18 è¡Œï¼š<strong>ç›´æ¥</strong>è°ƒç”¨&nbsp;<code>#doMockInvoke(invocation, null)</code>&nbsp;æ–¹æ³•ï¼Œè°ƒç”¨&nbsp;<strong>Mock Invoker</strong>&nbsp;ï¼Œæ‰§è¡Œæœ¬åœ° Mock é€»è¾‘ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-8-impl-mock/">ã€Œ3.3 doMockInvokeã€</a>&nbsp;ã€‚</li>
<li>========== ç¬¬ä¸‰ç§ï¼š<strong>å¤±è´¥æœåŠ¡é™çº§</strong>&nbsp;==========</li>
<li>ç¬¬ 24 è¡Œï¼š<strong>ä¼˜å…ˆ</strong>ï¼Œè°ƒç”¨<strong>çœŸæ­£çš„</strong>&nbsp;<code>invoker</code>&nbsp;çš„&nbsp;<code>#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼Œå‘èµ· RPC è°ƒç”¨ï¼Œ<strong>å³ä¸è¿›è¡Œ Mock é€»è¾‘</strong>ã€‚</li>
<li>ç¬¬ 25 è‡³ 36 è¡Œï¼šå¤„ç† RpcException å¼‚å¸¸ã€‚<strong>ä¹Ÿä»…ä»…å¤„ç†è¿™ç§ç±»å‹çš„å¼‚å¸¸</strong>ã€‚
<ul>
<li>ç¬¬ 26 è‡³ 28 è¡Œï¼šè‹¥å‘ç”Ÿ<strong>ä¸šåŠ¡æ€§</strong>å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>ç¬¬ 29 è‡³ 35 è¡Œï¼š<strong>å¤±è´¥å</strong>ï¼Œè°ƒç”¨&nbsp;<code>#doMockInvoke(invocation, null)</code>&nbsp;æ–¹æ³•ï¼Œè°ƒç”¨&nbsp;<strong>Mock Invoker</strong>&nbsp;ï¼Œæ‰§è¡Œæœ¬åœ° Mock é€»è¾‘ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-8-impl-mock/">ã€Œ3.3 doMockInvokeã€</a>&nbsp;ã€‚</li>
</ul>
</li>
</ul>
<p>ğŸ˜ˆ æ€»çš„æ¥è¯´ï¼ŒMockClusterInvoker çš„&nbsp;<code>#invoke(Invocation)</code>&nbsp;æ–¹æ³•çš„è¿‡ç¨‹ï¼Œæ ¹æ®ä¸åŒçš„&nbsp;<code>"mock"</code>&nbsp;é…ç½®ï¼Œ&ldquo;ç»„åˆ&rdquo;è°ƒç”¨<strong>çœŸæ­£çš„</strong>å’Œ&nbsp;<strong>Mock</strong>&nbsp;çš„ Invoker ã€‚</p>
<h2 id="3-3-doMockInvoke">3.3 doMockInvoke</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Result <span class="title">doMockInvoke</span><span class="params">(Invocation invocation, RpcException e)</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     Result result;</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// ç¬¬ä¸€æ­¥ï¼Œè·å¾— Mock Invoker å¯¹è±¡</span></span><br /><span class="line"> <span class="number">4</span>:     Invoker&lt;T&gt; mInvoker;</span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// è·¯ç”±åŒ¹é… Mock Invoker é›†åˆ</span></span><br /><span class="line"> <span class="number">6</span>:     List&lt;Invoker&lt;T&gt;&gt; mockInvokers = selectMockInvoker(invocation);</span><br /><span class="line"> <span class="number">7</span>:     <span class="comment">// å¦‚æœä¸å­˜åœ¨ï¼Œåˆ›å»º MockInvoker å¯¹è±¡</span></span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (mockInvokers == <span class="keyword">null</span> || mockInvokers.isEmpty()) {</span><br /><span class="line"> <span class="number">9</span>:         mInvoker = (Invoker&lt;T&gt;) <span class="keyword">new</span> MockInvoker(directory.getUrl());</span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// å¦‚æœå­˜åœ¨ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª</span></span><br /><span class="line"><span class="number">11</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">12</span>:         mInvoker = mockInvokers.get(<span class="number">0</span>);</span><br /><span class="line"><span class="number">13</span>:     }</span><br /><span class="line"><span class="number">14</span>:     <span class="comment">// ç¬¬äºŒæ­¥ï¼Œè°ƒç”¨ï¼Œæ‰§è¡Œæœ¬åœ° Mock é€»è¾‘</span></span><br /><span class="line"><span class="number">15</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">16</span>:         result = mInvoker.invoke(invocation);</span><br /><span class="line"><span class="number">17</span>:     } <span class="keyword">catch</span> (RpcException me) {</span><br /><span class="line"><span class="number">18</span>:         <span class="keyword">if</span> (me.isBiz()) {</span><br /><span class="line"><span class="number">19</span>:             result = <span class="keyword">new</span> RpcResult(me.getCause());</span><br /><span class="line"><span class="number">20</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">21</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(me.getCode(), getMockExceptionMessage(e, me), me.getCause());</span><br /><span class="line"><span class="number">22</span>:         }</span><br /><span class="line"><span class="number">23</span>:     } <span class="keyword">catch</span> (Throwable me) {</span><br /><span class="line"><span class="number">24</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(getMockExceptionMessage(e, me), me.getCause());</span><br /><span class="line"><span class="number">25</span>:     }</span><br /><span class="line"><span class="number">26</span>:     <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">27</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è‡³ 13 è¡Œï¼š<strong>ç¬¬ä¸€æ­¥</strong>ï¼Œè·å¾—&nbsp;<strong>MockInvoker</strong>&nbsp;å¯¹è±¡ã€‚
<ul>
<li>ç¬¬ 6 è¡Œï¼šè°ƒç”¨&nbsp;<code>#selectMockInvoker(invocation)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>è·¯ç”±åŒ¹é…</strong>&nbsp;Mock Invoker é›†åˆã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-8-impl-mock/">ã€Œ3.4 selectMockInvokerã€</a>&nbsp;ã€‚</li>
<li>ç¬¬ 7 è‡³ 9 è¡Œï¼šè‹¥<strong>ä¸</strong>å­˜åœ¨ï¼Œ<strong>åˆ›å»º</strong>&nbsp;MockInvoker å¯¹è±¡ã€‚</li>
<li>ç¬¬ 10 è‡³ 13 è¡Œï¼šè‹¥<strong>å·²</strong>ä¸èƒ½å†ï¼Œ<strong>é€‰æ‹©</strong>ç¬¬ä¸€ä¸ª Mock Invoker å¯¹è±¡ã€‚</li>
</ul>
</li>
<li>ç¬¬ 14 è‡³ 16 è¡Œï¼šè°ƒç”¨&nbsp;<code>MockInvoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œæœ¬åœ° Mock é€»è¾‘ã€‚</li>
<li>ç¬¬ 17 è‡³ 25 è¡Œï¼šå¤„ç†<strong>å¼‚å¸¸</strong>ã€‚</li>
</ul>
<h2 id="3-4-selectMockInvoker">3.4 selectMockInvoker</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">private</span> List&lt;Invoker&lt;T&gt;&gt; selectMockInvoker(Invocation invocation) {</span><br /><span class="line"> <span class="number">2</span>:     List&lt;Invoker&lt;T&gt;&gt; invokers = <span class="keyword">null</span>;</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (invocation <span class="keyword">instanceof</span> RpcInvocation) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="comment">// å­˜åœ¨éšå«å¥‘çº¦(è™½ç„¶åœ¨æ¥å£å£°æ˜ä¸­å¢åŠ æè¿°ï¼Œä½†æ‰©å±•æ€§ä¼šå­˜åœ¨é—®é¢˜.åŒæ—¶æ”¾åœ¨ attachment ä¸­çš„åšæ³•éœ€è¦æ”¹è¿›</span></span><br /><span class="line"> <span class="number">5</span>:         ((RpcInvocation) invocation).setAttachment(Constants.INVOCATION_NEED_MOCK, Boolean.TRUE.toString());</span><br /><span class="line"> <span class="number">6</span>:         <span class="comment">// directory æ ¹æ® invocation ä¸­ attachment æ˜¯å¦æœ‰ Constants.INVOCATION_NEED_MOCKï¼Œæ¥åˆ¤æ–­è·å–çš„æ˜¯ normal invokers or mock invokers</span></span><br /><span class="line"> <span class="number">7</span>:         <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">8</span>:             invokers = directory.list(invocation);</span><br /><span class="line"> <span class="number">9</span>:         } <span class="keyword">catch</span> (RpcException e) {</span><br /><span class="line"><span class="number">10</span>:             <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"><span class="number">11</span>:                 logger.info(<span class="string">"Exception when try to invoke mock. Get mock invokers error for service:"</span> + directory.getUrl().getServiceInterface() + <span class="string">", method:"</span> + invocation.getMethodName() + <span class="string">", will contruct a new mock with 'new MockInvoker()'."</span>, e);</span><br /><span class="line"><span class="number">12</span>:             }</span><br /><span class="line"><span class="number">13</span>:         }</span><br /><span class="line"><span class="number">14</span>:     }</span><br /><span class="line"><span class="number">15</span>:     <span class="keyword">return</span> invokers;</span><br /><span class="line"><span class="number">16</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 5 è¡Œï¼šè®¾ç½® RpcInvocation çš„&nbsp;<code>"invocation.need.mock"</code>&nbsp;ä¸º&nbsp;<strong>true</strong>&nbsp;ã€‚</li>
<li>ç¬¬ 8 è¡Œï¼šè°ƒç”¨&nbsp;<code>Directory#list(invocation)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—<strong>æ‰€æœ‰</strong>&nbsp;Invoker é›†åˆã€‚å› ä¸ºã€ç¬¬ 5 è¡Œã€‘è®¾ç½®äº†&nbsp;<code>"invocation.need.mock"</code>&nbsp;ä¸º&nbsp;<strong>true</strong>&nbsp;ï¼Œæ‰€ä»¥å®é™…è·å¾—çš„æ˜¯ MockInvoker é›†åˆã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-8-impl-mock/">ã€Œ3.4.1 MockInvokersSelectorã€</a>&nbsp;ã€‚</li>
</ul>
<h3 id="3-4-1-MockInvokersSelector">3.4.1 MockInvokersSelector</h3>
<p><code>com.alibaba.dubbo.rpc.cluster.router.MockInvokersSelector</code>&nbsp;ï¼Œå®ç° Router æ¥å£ï¼ŒMockInvoker è·¯ç”±<strong>é€‰æ‹©å™¨</strong>å®ç°ç±»ã€‚</p>
<p>å› ä¸º AbstractDirectory çš„&nbsp;<code>#setRouters(List&lt;Router&gt; routers)</code>&nbsp;æ–¹æ³•ä¸­ï¼Œéƒ½ä¼šæ·»åŠ &nbsp;<strong>MockInvokersSelector</strong>&nbsp;ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2019_05_05/02.png" alt="setRouters" /></p>
<ul>
<li>æ‰€ä»¥ï¼Œæ¯æ¬¡&nbsp;<code>Directory#list(invocation)</code>&nbsp;çš„è¿‡ç¨‹ä¸­ï¼Œéƒ½ä¼šæ‰§è¡Œ MockInvokersSelector çš„è·¯ç”±é€»è¾‘ã€‚</li>
</ul>
<hr />
<p><code>#route(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation)</code>&nbsp;æ–¹æ³•ï¼Œæ ¹æ®&nbsp;<code>"invocation.need.mock"</code>&nbsp;è·¯ç”±åŒ¹é…<strong>å¯¹åº”ç±»å‹</strong>çš„ Invoker é›†åˆï¼š</p>
<ul>
<li>1ã€è‹¥ä¸º&nbsp;<strong>true</strong>&nbsp;ï¼Œ<strong>Mock</strong>Invoker é›†åˆã€‚</li>
<li>2ã€è‹¥ä¸º&nbsp;<strong>false</strong>&nbsp;ï¼Œ<strong>æ™®é€š</strong>&nbsp;Invoker é›†åˆã€‚</li>
</ul>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">public</span> &lt;T&gt; List&lt;Invoker&lt;T&gt;&gt; route(<span class="keyword">final</span> List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, <span class="keyword">final</span> Invocation invocation) <span class="keyword">throws</span> RpcException {</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// è·å¾—æ™®é€š Invoker é›†åˆ</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (invocation.getAttachments() == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">5</span>:         <span class="keyword">return</span> getNormalInvokers(invokers);</span><br /><span class="line"> <span class="number">6</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">7</span>:         <span class="comment">// è·å¾— "invocation.need.mock" é…ç½®é¡¹</span></span><br /><span class="line"> <span class="number">8</span>:         String value = invocation.getAttachments().get(Constants.INVOCATION_NEED_MOCK);</span><br /><span class="line"> <span class="number">9</span>:         <span class="comment">// è·å¾—æ™®é€š Invoker é›†åˆ</span></span><br /><span class="line"><span class="number">10</span>:         <span class="keyword">if</span> (value == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">11</span>:             <span class="keyword">return</span> getNormalInvokers(invokers);</span><br /><span class="line"><span class="number">12</span>:         <span class="comment">// è·å¾— MockInvoker é›†åˆ</span></span><br /><span class="line"><span class="number">13</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (Boolean.TRUE.toString().equalsIgnoreCase(value)) {</span><br /><span class="line"><span class="number">14</span>:             <span class="keyword">return</span> getMockedInvokers(invokers);</span><br /><span class="line"><span class="number">15</span>:         }</span><br /><span class="line"><span class="number">16</span>:     }</span><br /><span class="line"><span class="number">17</span>:     <span class="comment">// å…¶å®ƒï¼Œä¸åŒ¹é…ï¼Œç›´æ¥è¿”å› `invokers` é›†åˆ</span></span><br /><span class="line"><span class="number">18</span>:     <span class="keyword">return</span> invokers;</span><br /><span class="line"><span class="number">19</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>åˆ†æˆ<strong>ä¸‰ç§</strong>æƒ…å†µï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸€ä¸ªæ¥çœ‹ã€‚åœ¨çœ‹å…·ä½“æƒ…å†µä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹&nbsp;<code>#hasMockProviders(invokers)</code>&nbsp;æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰ MockInvoker ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">hasMockProviders</span><span class="params">(<span class="keyword">final</span> List&lt;Invoker&lt;T&gt;&gt; invokers)</span> </span>{</span><br /><span class="line">    <span class="keyword">boolean</span> hasMockProvider = <span class="keyword">false</span>;</span><br /><span class="line">    <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokers) {</span><br /><span class="line">        <span class="keyword">if</span> (invoker.getUrl().getProtocol().equals(Constants.MOCK_PROTOCOL)) { <span class="comment">// åè®®ä¸º "mock"</span></span><br /><span class="line">            hasMockProvider = <span class="keyword">true</span>;</span><br /><span class="line">            <span class="keyword">break</span>;</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> hasMockProvider;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>é€šè¿‡&nbsp;<code>protocol = "mock"</code>&nbsp;æ¥åˆ¤æ–­ï¼Œæ˜¯å¦ä¸º&nbsp;<strong>Mock</strong>Invoker ã€‚æ‰€ä»¥åªè¦<strong>ä¸ä¸º</strong>&nbsp;MockInvoker ï¼Œå°±æ˜¯<strong>æ™®é€š</strong>&nbsp;Invoker ã€‚å…³äº&nbsp;<code>"mock"</code>&nbsp;åè®®ï¼Œæˆ‘ä»¬ç¨ååœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-8-impl-mock/">ã€Œ4. MockProtocolã€</a>&nbsp;ä¸­ï¼Œè¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>
<p>ã€ç¬¬<strong>ä¸€</strong>ç§ã€‘ç¬¬ 3 è‡³ 5 è¡Œ || ç¬¬ 9 è‡³ 11 è¡Œï¼šè‹¥<strong>æœªè®¾ç½®</strong>&nbsp;<code>"invocation.need.mock"</code>&nbsp;é…ç½®é¡¹ï¼Œè°ƒç”¨&nbsp;<code>#getNormalInvokers(invokers)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—<strong>æ™®é€š</strong>&nbsp;Invoker é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">private</span> &lt;T&gt; List&lt;Invoker&lt;T&gt;&gt; getNormalInvokers(<span class="keyword">final</span> List&lt;Invoker&lt;T&gt;&gt; invokers) {</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// ä¸åŒ…å« MockInvoker çš„æƒ…å†µä¸‹ï¼Œç›´æ¥è¿”å› `invokers` é›†åˆ</span></span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (!hasMockProviders(invokers)) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="keyword">return</span> invokers;</span><br /><span class="line"> <span class="number">5</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">6</span>:         <span class="comment">// è‹¥åŒ…å« MockInvoker çš„æƒ…å†µä¸‹ï¼Œè¿‡æ»¤æ‰ MockInvoker ï¼Œåˆ›å»ºæ™®é€š Invoker é›†åˆ</span></span><br /><span class="line"> <span class="number">7</span>:         List&lt;Invoker&lt;T&gt;&gt; sInvokers = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;(invokers.size());</span><br /><span class="line"> <span class="number">8</span>:         <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokers) {</span><br /><span class="line"> <span class="number">9</span>:             <span class="keyword">if</span> (!invoker.getUrl().getProtocol().equals(Constants.MOCK_PROTOCOL)) {</span><br /><span class="line"><span class="number">10</span>:                 sInvokers.add(invoker);</span><br /><span class="line"><span class="number">11</span>:             }</span><br /><span class="line"><span class="number">12</span>:         }</span><br /><span class="line"><span class="number">13</span>:         <span class="keyword">return</span> sInvokers;</span><br /><span class="line"><span class="number">14</span>:     }</span><br /><span class="line"><span class="number">15</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 2 è‡³ 4 è¡Œï¼šè°ƒç”¨&nbsp;<code>#hasMockProviders(invokers)</code>&nbsp;æ–¹æ³•ï¼Œåˆ¤æ–­<strong>ä¸åŒ…å«</strong>&nbsp;MockInvoker çš„æƒ…å†µï¼Œç›´æ¥è¿”å›&nbsp;<code>invokers</code>&nbsp;é›†åˆã€‚</li>
<li>ç¬¬ 6 è‡³ 13 è¡Œï¼šè‹¥<strong>åŒ…å«</strong>&nbsp;MockInvoker çš„æƒ…å†µï¼Œ<strong>è¿‡æ»¤</strong>æ‰ MockInvoker ï¼Œåˆ›å»º<strong>æ™®é€š</strong>&nbsp;Invoker é›†åˆã€‚</li>
</ul>
</li>
<li>
<p>ã€ç¬¬<strong>äºŒ</strong>ç§ã€‘ç¬¬ 12 è‡³ 15 è¡Œï¼šè‹¥è®¾ç½®&nbsp;<code>"invocation.need.mock"</code>&nbsp;é…ç½®é¡¹ä¸º&nbsp;<strong>true</strong>&nbsp;ï¼Œè°ƒç”¨&nbsp;<code>#getMockedInvokers(invokers)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—&nbsp;<strong>Mock</strong>Invoker é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> &lt;T&gt; List&lt;Invoker&lt;T&gt;&gt; getMockedInvokers(<span class="keyword">final</span> List&lt;Invoker&lt;T&gt;&gt; invokers) {</span><br /><span class="line">    <span class="comment">// ä¸åŒ…å« MockInvoker çš„æƒ…å†µä¸‹ï¼Œç›´æ¥è¿”å› null</span></span><br /><span class="line">    <span class="keyword">if</span> (!hasMockProviders(invokers)) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è¿‡æ»¤æ‰æ™®é€š kInvoker ï¼Œåˆ›å»º MockInvoker é›†åˆ</span></span><br /><span class="line">    List&lt;Invoker&lt;T&gt;&gt; sInvokers = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;(<span class="number">1</span>); <span class="comment">// ä¸€èˆ¬æƒ…å†µå°±ä¸€ä¸ªï¼Œæ‰€ä»¥è®¾ç½®äº†é»˜è®¤æ•°ç»„å¤§å°ä¸º 1 ã€‚</span></span><br /><span class="line">    <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokers) {</span><br /><span class="line">        <span class="keyword">if</span> (invoker.getUrl().getProtocol().equals(Constants.MOCK_PROTOCOL)) {</span><br /><span class="line">            sInvokers.add(invoker);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> sInvokers;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å’Œ&nbsp;<code>#getNormalInvokers(invokers)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>ç›¸å</strong>ã€‚æ¯”è¾ƒæ˜“æ‡‚ï¼Œèƒ–å‹çœ‹ä»£ç æ³¨é‡Šã€‚</li>
</ul>
</li>
<li>ã€ç¬¬<strong>ä¸‰</strong>ç§ã€‘ç¬¬ 18 è¡Œï¼šå…¶å®ƒï¼Œ<strong>ä¸åŒ¹é…</strong>ï¼Œç›´æ¥è¿”å›&nbsp;<code>invokers</code>&nbsp;é›†åˆã€‚ç†è®ºä¸Šï¼Œåº”è¯¥è°ƒç”¨å’Œã€ç¬¬<strong>ä¸€</strong>ç§ã€‘ä¸€æ ·ï¼Œè°ƒç”¨&nbsp;<code>#getNormalInvokers(invokers)</code>&nbsp;æ–¹æ³•ã€‚ä¸è¿‡æ²¡å…³ç³»ï¼ŒğŸ˜ˆ ä»ç›®å‰ä»£ç æ¥çœ‹ï¼Œè¿™å—æ˜¯èµ°ä¸åˆ°çš„ã€‚</li>
</ul>
<h1 id="4-MockProtocol">4. MockProtocol</h1>
<p><code>com.alibaba.dubbo.rpc.support.MockProtocol</code>&nbsp;ï¼Œå®ç° AbstractProtocol æŠ½è±¡ç±»ï¼Œç”¨äºåœ¨æœåŠ¡<strong>æ¶ˆè´¹è€…</strong>ï¼Œé€šè¿‡ç±»å‹ä¸º&nbsp;<code>"mock"</code>&nbsp;çš„ URL ï¼Œå¼•ç”¨åˆ›å»º MockInvoker å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MockProtocol</span> <span class="keyword">extends</span> <span class="title">AbstractProtocol</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(Invoker&lt;T&gt; invoker)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MockInvoker&lt;T&gt;(url);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDefaultPort</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>#export(Invoker)</code>&nbsp;<strong>å®ç°</strong>æ–¹æ³•ï¼Œä¸å…è®¸è°ƒç”¨ï¼Œç›´æ¥æŠ›å‡º UnsupportedOperationException å¼‚å¸¸ã€‚</li>
<li>
<p><code>#refer(Class&lt;T&gt; type, Url)</code>&nbsp;<strong>å®ç°</strong>æ–¹æ³•ï¼Œå¼•ç”¨åˆ›å»º&nbsp;<strong>MockInvoker</strong>&nbsp;å¯¹è±¡ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡&nbsp;<code>dubbo-admin</code>&nbsp;<strong>è¿ç»´å¹³å°</strong>æˆ–è€…ç›´æ¥å‘ Zookeeper å†™å…¥<strong>é™æ€</strong>&nbsp;URL ï¼Œä¾‹å¦‚ï¼š</p>
<figure class="highlight plain">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">// å®é™…å†™å…¥çš„ URL</span><br /><span class="line">/dubbo/com.alibaba.dubbo.demo.DemoService/providers/mock%3A%2F%2F10.20.153.11%2Fcom.alibaba.dubbo.demo.DemoService%3Fdynamic%3Dtrue%26application%3Dfoo</span><br /><br /><span class="line">// decode URL</span><br /><span class="line">/dubbo/com.alibaba.dubbo.demo.DemoService/providers/mock://10.20.153.11/com.alibaba.dubbo.demo.DemoService?dynamic=true&amp;application=foo</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä¸ºä»€ä¹ˆè¦æ˜¯<strong>é™æ€</strong>&nbsp;URL å‘¢ï¼Ÿå› ä¸ºéé™æ€ URL ï¼Œå¯èƒ½è¢«æ³¨å†Œä¸­å¿ƒåˆ é™¤ã€‚</li>
</ul>
</li>
</ul>
<p>ğŸ˜ˆ å½“ç„¶ï¼Œæˆ‘ä»¬åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-8-impl-mock/">ã€Œ3.3 doMockInvokeã€</a>&nbsp;ä¸­ä¹Ÿçœ‹åˆ°ï¼Œå³ä½¿ä¸<strong>æ‰‹åŠ¨</strong>æ·»åŠ &nbsp;<code>"mock"</code>&nbsp;URL ï¼Œåœ¨ã€ç¬¬ 9 è¡Œã€‘ä»£ç ä¸­ä¹Ÿä¼š<strong>è‡ªåŠ¨</strong>åˆ›å»º MockInvoker å¯¹è±¡ã€‚</p>
<h1 id="5-MockInvoker">5. MockInvoker</h1>
<p><code>com.alibaba.dubbo.rpc.support.MockInvoker</code>&nbsp;ï¼Œå®ç° Invoker æ¥å£ï¼Œ<strong>Mock</strong>&nbsp;Invoker å®ç°ç±»ã€‚</p>
<h2 id="5-1-æ„é€ æ–¹æ³•">5.1 æ„é€ æ–¹æ³•</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ProxyFactory$Adaptive å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> ProxyFactory proxyFactory = ExtensionLoader.getExtensionLoader(ProxyFactory.class).getAdaptiveExtension();</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * mock ä¸ Invoker å¯¹è±¡çš„æ˜ å°„ç¼“å­˜</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> #getInvoker(String)</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Map&lt;String, Invoker&lt;?&gt;&gt; mocks = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Invoker&lt;?&gt;&gt;();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * mock ä¸ Throwable å¯¹è±¡çš„æ˜ å°„ç¼“å­˜</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> #getThrowable(String)</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> Map&lt;String, Throwable&gt; throwables = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Throwable&gt;();</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * URL å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MockInvoker</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.url = url;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="5-2-invoke">5.2 invoke</h2>
<p><code>#invoke(Invocation)</code>&nbsp;<strong>å®ç°</strong>æ–¹æ³•ï¼Œæ‰§è¡Œ Mock é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (invocation <span class="keyword">instanceof</span> RpcInvocation) {</span><br /><span class="line"> <span class="number">4</span>:         ((RpcInvocation) invocation).setInvoker(<span class="keyword">this</span>);</span><br /><span class="line"> <span class="number">5</span>:     }</span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// è·å¾— `"mock"` é…ç½®é¡¹ï¼Œæ–¹æ³•çº§ &gt; ç±»çº§</span></span><br /><span class="line"> <span class="number">7</span>:     String mock = getUrl().getParameter(invocation.getMethodName() + <span class="string">"."</span> + Constants.MOCK_KEY);</span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (StringUtils.isBlank(mock)) {</span><br /><span class="line"> <span class="number">9</span>:         mock = getUrl().getParameter(Constants.MOCK_KEY);</span><br /><span class="line"><span class="number">10</span>:     }</span><br /><span class="line"><span class="number">11</span>:     <span class="keyword">if</span> (StringUtils.isBlank(mock)) { <span class="comment">// ä¸å…è®¸ä¸ºç©º</span></span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="keyword">new</span> IllegalAccessException(<span class="string">"mock can not be null. url :"</span> + url));</span><br /><span class="line"><span class="number">13</span>:     }</span><br /><span class="line"><span class="number">14</span>:     <span class="comment">// æ ‡å‡†åŒ– `"mock"` é…ç½®é¡¹</span></span><br /><span class="line"><span class="number">15</span>:     mock = normalizedMock(URL.decode(mock));</span><br /><span class="line"><span class="number">16</span>:     <span class="comment">// ç­‰äº "return " ï¼Œè¿”å›å€¼ä¸ºç©ºçš„ RpcResult å¯¹è±¡</span></span><br /><span class="line"><span class="number">17</span>:     <span class="keyword">if</span> (Constants.RETURN_PREFIX.trim().equalsIgnoreCase(mock.trim())) {</span><br /><span class="line"><span class="number">18</span>:         RpcResult result = <span class="keyword">new</span> RpcResult();</span><br /><span class="line"><span class="number">19</span>:         result.setValue(<span class="keyword">null</span>);</span><br /><span class="line"><span class="number">20</span>:         <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">21</span>:     <span class="comment">// ä»¥ "return " å¼€å¤´ï¼Œè¿”å›å¯¹åº”å€¼çš„ RpcResult å¯¹è±¡</span></span><br /><span class="line"><span class="number">22</span>:     } <span class="keyword">else</span> <span class="keyword">if</span> (mock.startsWith(Constants.RETURN_PREFIX)) {</span><br /><span class="line"><span class="number">23</span>:         mock = mock.substring(Constants.RETURN_PREFIX.length()).trim();</span><br /><span class="line"><span class="number">24</span>:         mock = mock.replace(<span class="string">'`'</span>, <span class="string">'"'</span>);</span><br /><span class="line"><span class="number">25</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">26</span>:             <span class="comment">// è§£æè¿”å›ç±»å‹</span></span><br /><span class="line"><span class="number">27</span>:             Type[] returnTypes = RpcUtils.getReturnTypes(invocation);</span><br /><span class="line"><span class="number">28</span>:             <span class="comment">// è§£æè¿”å›å€¼</span></span><br /><span class="line"><span class="number">29</span>:             Object value = parseMockValue(mock, returnTypes);</span><br /><span class="line"><span class="number">30</span>:             <span class="comment">// åˆ›å»ºå¯¹åº”å€¼çš„ RpcResult å¯¹è±¡ï¼Œå¹¶è¿”å›</span></span><br /><span class="line"><span class="number">31</span>:             <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(value);</span><br /><span class="line"><span class="number">32</span>:         } <span class="keyword">catch</span> (Exception ew) {</span><br /><span class="line"><span class="number">33</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"mock return invoke error. method :"</span> + invocation.getMethodName() + <span class="string">", mock:"</span> + mock + <span class="string">", url: "</span> + url, ew);</span><br /><span class="line"><span class="number">34</span>:         }</span><br /><span class="line"><span class="number">35</span>:     <span class="comment">// ä»¥ "throw" å¼€å¤´ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸</span></span><br /><span class="line"><span class="number">36</span>:     } <span class="keyword">else</span> <span class="keyword">if</span> (mock.startsWith(Constants.THROW_PREFIX)) {</span><br /><span class="line"><span class="number">37</span>:         mock = mock.substring(Constants.THROW_PREFIX.length()).trim();</span><br /><span class="line"><span class="number">38</span>:         mock = mock.replace(<span class="string">'`'</span>, <span class="string">'"'</span>);</span><br /><span class="line"><span class="number">39</span>:         <span class="keyword">if</span> (StringUtils.isBlank(mock)) { <span class="comment">// ç¦æ­¢ä¸ºç©º</span></span><br /><span class="line"><span class="number">40</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">" mocked exception for Service degradation. "</span>);</span><br /><span class="line"><span class="number">41</span>:         } <span class="keyword">else</span> { <span class="comment">// user customized class</span></span><br /><span class="line"><span class="number">42</span>:             <span class="comment">// åˆ›å»ºè‡ªå®šä¹‰å¼‚å¸¸</span></span><br /><span class="line"><span class="number">43</span>:             Throwable t = getThrowable(mock);</span><br /><span class="line"><span class="number">44</span>:             <span class="comment">// æŠ›å‡ºä¸šåŠ¡ç±»å‹çš„ RpcException å¼‚å¸¸</span></span><br /><span class="line"><span class="number">45</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(RpcException.BIZ_EXCEPTION, t);</span><br /><span class="line"><span class="number">46</span>:         }</span><br /><span class="line"><span class="number">47</span>:     <span class="comment">// è‡ªå®šä¹‰ Mock ç±»ï¼Œæ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘</span></span><br /><span class="line"><span class="number">48</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">49</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">50</span>:             <span class="comment">// åˆ›å»º Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="number">51</span>:             Invoker&lt;T&gt; invoker = getInvoker(mock);</span><br /><span class="line"><span class="number">52</span>:             <span class="comment">// æ‰§è¡Œ Invoker å¯¹è±¡çš„è°ƒç”¨é€»è¾‘</span></span><br /><span class="line"><span class="number">53</span>:             <span class="keyword">return</span> invoker.invoke(invocation);</span><br /><span class="line"><span class="number">54</span>:         } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">55</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Failed to create mock implemention class "</span> + mock, t);</span><br /><span class="line"><span class="number">56</span>:         }</span><br /><span class="line"><span class="number">57</span>:     }</span><br /><span class="line"><span class="number">58</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 6 è‡³ 13 è¡Œï¼šè·å¾—&nbsp;<code>"mock"</code>&nbsp;é…ç½®é¡¹ï¼Œä¼˜å…ˆä»<strong>æ–¹æ³•çº§</strong>çš„å‚æ•°ï¼Œå†ä»<strong>ç±»çº§</strong>çš„å‚æ•°ã€‚</li>
<li>ç¬¬ 15 è¡Œï¼šè°ƒç”¨&nbsp;<code>#normalizedMock(mock)</code>&nbsp;æ–¹æ³•ï¼Œæ ‡å‡†åŒ–&nbsp;<code>"mock"</code>&nbsp;é…ç½®é¡¹ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-8-impl-mock/">ã€Œ5.3 normalizedMockã€</a>&nbsp;ã€‚</li>
<li>ä¸‹é¢æ ¹æ®&nbsp;<code>mock</code>&nbsp;ï¼Œåˆ†æˆ<strong>ä¸‰ç§</strong>æƒ…å†µã€‚</li>
<li>ã€ç¬¬&nbsp;<strong>1.1</strong>&nbsp;ç§ã€‘ç¬¬ 16 è‡³ 20 è¡Œï¼šç­‰äº&nbsp;<code>"return "</code>&nbsp;ï¼Œè¿”å›å€¼ä¸º<strong>ç©º</strong>&nbsp;çš„ RpcResult å¯¹è±¡ã€‚</li>
<li>ã€ç¬¬&nbsp;<strong>1.2</strong>&nbsp;ç§ã€‘ç¬¬ 21 è‡³ 34 è¡Œï¼šä»¥&nbsp;<code>"return"</code>&nbsp;å¼€å¤´ï¼Œè¿”å›<strong>å¯¹åº”å€¼</strong>&nbsp;çš„ RpcResult å¯¹è±¡ã€‚
<ul>
<li>ç¬¬29 è¡Œï¼šè°ƒç”¨&nbsp;<code>#parseMockValue(mock, returnTypes)</code>&nbsp;æ–¹æ³•ï¼Œè§£æ<strong>è¿”å›å€¼</strong>ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-8-impl-mock/">ã€Œ5.4 parseMockValueã€</a>&nbsp;ã€‚</li>
</ul>
</li>
<li>ã€ç¬¬&nbsp;<strong>2</strong>&nbsp;ç§ã€‘ç¬¬ 35 è‡³ 46 è¡Œï¼šä»¥&nbsp;<code>"throw"</code>&nbsp;å¼€å¤´ï¼ŒæŠ›å‡º<strong>å¯¹åº”çš„</strong>&nbsp;RpcException å¼‚å¸¸ã€‚
<ul>
<li>ç¬¬ 43 è¡Œï¼šè°ƒç”¨&nbsp;<code>#getThrowable(mock)</code>&nbsp;å¯¹è±¡ï¼Œåˆ›å»º<strong>è‡ªå®šä¹‰</strong>å¼‚å¸¸ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-8-impl-mock/">ã€Œ5.5 getThrowableã€</a>&nbsp;ã€‚</li>
</ul>
</li>
<li>ã€ç¬¬&nbsp;<strong>3</strong>&nbsp;ç§ã€‘ç¬¬ 47 è‡³ 57 è¡Œï¼š<strong>è‡ªå®šä¹‰</strong>&nbsp;Mock ç±»ï¼Œæ‰§è¡Œè‡ªå®šä¹‰é€»è¾‘ã€‚
<ul>
<li>ç¬¬ 51 è¡Œï¼šè°ƒç”¨&nbsp;<code>#getInvoker(mock)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— Invoker å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-8-impl-mock/">ã€Œ5.6 getInvokerã€</a>&nbsp;ã€‚</li>
<li>ç¬¬ 53 è¡Œï¼šè°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œ<strong>è‡ªå®šä¹‰</strong>&nbsp;Mock é€»è¾‘ã€‚</li>
</ul>
</li>
</ul>
<h2 id="5-3-normalizedMock">5.3 normalizedMock</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> String <span class="title">normalizedMock</span><span class="params">(String mock)</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// è‹¥ä¸ºç©ºï¼Œç›´æ¥è¿”å›</span></span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (mock == <span class="keyword">null</span> || mock.trim().length() == <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="keyword">return</span> mock;</span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// è‹¥æœä¸º "true" "default" "fail" "force" å››ç§å­—ç¬¦ä¸²ï¼Œä¿®æ”¹ä¸ºå¯¹åº”æ¥å£ + "Mock" ç±»</span></span><br /><span class="line"> <span class="number">6</span>:     } <span class="keyword">else</span> <span class="keyword">if</span> (ConfigUtils.isDefault(mock) || <span class="string">"fail"</span>.equalsIgnoreCase(mock.trim()) || <span class="string">"force"</span>.equalsIgnoreCase(mock.trim())) {</span><br /><span class="line"> <span class="number">7</span>:         mock = url.getServiceInterface() + <span class="string">"Mock"</span>;</span><br /><span class="line"> <span class="number">8</span>:     }</span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// è‹¥ä»¥ "fail:" å¼€å¤´ï¼Œå»æ‰è¯¥å¼€å¤´</span></span><br /><span class="line"><span class="number">10</span>:     <span class="keyword">if</span> (mock.startsWith(Constants.FAIL_PREFIX)) {</span><br /><span class="line"><span class="number">11</span>:         mock = mock.substring(Constants.FAIL_PREFIX.length()).trim();</span><br /><span class="line"><span class="number">12</span>:     <span class="comment">// è‹¥ä»¥ "force:" å¼€å¤´ï¼Œå»æ‰è¯¥å¼€å¤´</span></span><br /><span class="line"><span class="number">13</span>:     } <span class="keyword">else</span> <span class="keyword">if</span> (mock.startsWith(Constants.FORCE_PREFIX)) {</span><br /><span class="line"><span class="number">14</span>:         mock = mock.substring(Constants.FORCE_PREFIX.length()).trim();</span><br /><span class="line"><span class="number">15</span>:     }</span><br /><span class="line"><span class="number">16</span>:     <span class="keyword">return</span> mock;</span><br /><span class="line"><span class="number">17</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ã€ç¬¬<strong>ä¸€</strong>ç§ã€‘ç¬¬ 2 è‡³ 4 è¡Œï¼šè‹¥ä¸º<strong>ç©º</strong>ï¼Œç›´æ¥è¿”å›ã€‚</li>
<li>ã€ç¬¬<strong>äºŒ</strong>ç§ã€‘ç¬¬ 5 è‡³ 8 è¡Œï¼šè‹¥ä¸º&nbsp;<strong><code>true</code>&nbsp;<code>default</code>&nbsp;<code>fail</code>&nbsp;<code>force</code></strong>&nbsp;ï¼Œä¿®æ”¹ä¸ºå¯¹åº”æ¥å£ +&nbsp;<code>"Mock"</code>&nbsp;ã€‚</li>
<li>ã€ç¬¬<strong>ä¸‰</strong>ç§ã€‘ç¬¬ 9 è‡³ 15 è¡Œï¼šè‹¥ä»¥&nbsp;<code>"fail:"</code>&nbsp;æˆ–&nbsp;<code>"force:"</code>&nbsp;<strong>å¼€å¤´</strong>&nbsp;ï¼Œå»æ‰<strong>å¼€å¤´</strong>ã€‚è¯¥å¼€å¤´ï¼Œä»…ç”¨äº MockClusterInvoker è¡¨ç¤º<strong>å¼ºåˆ¶</strong>&nbsp;Mock è¿˜æ˜¯<strong>å¤±è´¥</strong>&nbsp;Mock ã€‚</li>
</ul>
<h2 id="5-4-parseMockValue">5.4 parseMockValue</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">parseMockValue</span><span class="params">(String mock)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> parseMockValue(mock, <span class="keyword">null</span>);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">parseMockValue</span><span class="params">(String mock, Type[] returnTypes)</span> </span>{</span><br /><span class="line">    <span class="comment">// è§£æå€¼ï¼ˆä¸è€ƒè™‘è¿”å›ç±»å‹ï¼‰</span></span><br /><span class="line">    Object value;</span><br /><span class="line">    <span class="keyword">if</span> (<span class="string">"empty"</span>.equals(mock)) { <span class="comment">// æœªèµ‹å€¼çš„å¯¹è±¡ï¼Œå³ new XXX() å¯¹è±¡</span></span><br /><span class="line">        value = ReflectUtils.getEmptyObject(returnTypes != <span class="keyword">null</span> &amp;&amp; returnTypes.length &gt; <span class="number">0</span> ? (Class&lt;?&gt;) returnTypes[<span class="number">0</span>] : <span class="keyword">null</span>);</span><br /><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"null"</span>.equals(mock)) { <span class="comment">// null</span></span><br /><span class="line">        value = <span class="keyword">null</span>;</span><br /><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"true"</span>.equals(mock)) { <span class="comment">// true</span></span><br /><span class="line">        value = <span class="keyword">true</span>;</span><br /><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"false"</span>.equals(mock)) { <span class="comment">// false</span></span><br /><span class="line">        value = <span class="keyword">false</span>;</span><br /><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (mock.length() &gt;= <span class="number">2</span> &amp;&amp; (mock.startsWith(<span class="string">"\""</span>) &amp;&amp; mock.endsWith(<span class="string">"\""</span>)</span><br /><span class="line">            || mock.startsWith(<span class="string">"\'"</span>) &amp;&amp; mock.endsWith(<span class="string">"\'"</span>))) { <span class="comment">// ä½¿ç”¨ '' æˆ– "" çš„å­—ç¬¦ä¸²ï¼Œæˆªå–æ‰å¤´å°¾</span></span><br /><span class="line">        value = mock.subSequence(<span class="number">1</span>, mock.length() - <span class="number">1</span>);</span><br /><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (returnTypes != <span class="keyword">null</span> &amp;&amp; returnTypes.length &gt; <span class="number">0</span> &amp;&amp; returnTypes[<span class="number">0</span>] == String.class) { <span class="comment">// å­—ç¬¦ä¸²</span></span><br /><span class="line">        value = mock;</span><br /><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.isNumeric(mock)) { <span class="comment">// æ•°å­—</span></span><br /><span class="line">        value = JSON.parse(mock);</span><br /><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (mock.startsWith(<span class="string">"{"</span>)) { <span class="comment">// Map</span></span><br /><span class="line">        value = JSON.parseObject(mock, Map.class);</span><br /><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (mock.startsWith(<span class="string">"["</span>)) { <span class="comment">// List</span></span><br /><span class="line">        value = JSON.parseObject(mock, List.class);</span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        value = mock;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è½¬æ¢æˆå¯¹åº”çš„è¿”å›ç±»å‹</span></span><br /><span class="line">    <span class="keyword">if</span> (returnTypes != <span class="keyword">null</span> &amp;&amp; returnTypes.length &gt; <span class="number">0</span>) {</span><br /><span class="line">        value = PojoUtils.realize(value, (Class&lt;?&gt;) returnTypes[<span class="number">0</span>], returnTypes.length &gt; <span class="number">1</span> ? returnTypes[<span class="number">1</span>] <span class="comment">/* æ³›å‹ */</span>: <span class="keyword">null</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> value;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è§£æ<strong>å€¼</strong>ï¼Œå¹¶<strong>è½¬æ¢</strong>æˆå¯¹åº”çš„è¿”å›<strong>ç±»å‹</strong>ã€‚</li>
</ul>
<h2 id="5-5-getThrowable">5.5 getThrowable</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> Throwable <span class="title">getThrowable</span><span class="params">(String throwStr)</span> </span>{</span><br /><span class="line">    <span class="comment">// ä»ç¼“å­˜ä¸­ï¼Œè·å¾— Throwable å¯¹è±¡</span></span><br /><span class="line">    Throwable throwable = throwables.get(throwStr);</span><br /><span class="line">    <span class="keyword">if</span> (throwable != <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">return</span> throwable;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// ä¸å­˜åœ¨ï¼Œåˆ›å»º Throwable å¯¹è±¡</span></span><br /><span class="line">    Throwable t;</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="comment">// è·å¾—å¼‚å¸¸ç±»</span></span><br /><span class="line">        Class&lt;?&gt; bizException = ReflectUtils.forName(throwStr);</span><br /><span class="line">        <span class="comment">// è·å¾—æ„é€ æ–¹æ³•</span></span><br /><span class="line">        Constructor&lt;?&gt; constructor = ReflectUtils.findConstructor(bizException, String.class);</span><br /><span class="line">        <span class="comment">// åˆ›å»º Throwable å¯¹è±¡</span></span><br /><span class="line">        t = (Throwable) constructor.newInstance(<span class="keyword">new</span> Object[]{<span class="string">" mocked exception for Service degradation. "</span>});</span><br /><span class="line">        <span class="comment">// æ·»åŠ åˆ°ç¼“å­˜ä¸­</span></span><br /><span class="line">        <span class="keyword">if</span> (throwables.size() &lt; <span class="number">1000</span>) {</span><br /><span class="line">            throwables.put(throwStr, t);</span><br /><span class="line">        }</span><br /><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"mock throw error :"</span> + throwStr + <span class="string">" argument error."</span>, e);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> t;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œèƒ–å‹çœ‹ä»£ç æ³¨é‡Šã€‚</li>
</ul>
<h2 id="5-6-getInvoker">5.6 getInvoker</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> Invoker&lt;T&gt; <span class="title">getInvoker</span><span class="params">(String mockService)</span> </span>{</span><br /><span class="line">    <span class="comment">// ä»ç¼“å­˜ä¸­ï¼Œè·å¾— Invoker å¯¹è±¡</span></span><br /><span class="line">    Invoker&lt;T&gt; invoker = (Invoker&lt;T&gt;) mocks.get(mockService);</span><br /><span class="line">    <span class="keyword">if</span> (invoker != <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">return</span> invoker;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// ä¸å­˜åœ¨ï¼Œåˆ›å»º Invoker å¯¹è±¡</span></span><br /><span class="line">    <span class="comment">// 1. è·å¾—æ¥å£ç±»</span></span><br /><span class="line">    Class&lt;T&gt; serviceType = (Class&lt;T&gt;) ReflectUtils.forName(url.getServiceInterface());</span><br /><span class="line">    <span class="comment">// 2. è‹¥ä¸º `true` `default` ï¼Œä¿®æ”¹ä¿®æ”¹ä¸ºå¯¹åº”æ¥å£ + "Mock" ç±»ã€‚è¿™ç§æƒ…å†µå‡ºç°åœ¨åŸå§‹ `mock = fail:true` æˆ– `mock = force:true` ç­‰æƒ…å†µ</span></span><br /><span class="line">    <span class="keyword">if</span> (ConfigUtils.isDefault(mockService)) {</span><br /><span class="line">        mockService = serviceType.getName() + <span class="string">"Mock"</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// 3. è·å¾— Mock ç±»</span></span><br /><span class="line">    Class&lt;?&gt; mockClass = ReflectUtils.forName(mockService);</span><br /><span class="line">    <span class="comment">// 4. æ ¡éªŒ Mock ç±»ï¼Œå®ç°äº†æ¥å£ç±»</span></span><br /><span class="line">    <span class="keyword">if</span> (!serviceType.isAssignableFrom(mockClass)) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The mock implemention class "</span> + mockClass.getName() + <span class="string">" not implement interface "</span> + serviceType.getName());</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="comment">// 5. åˆ›å»º Mock å¯¹è±¡</span></span><br /><span class="line">        T mockObject = (T) mockClass.newInstance();</span><br /><span class="line">        <span class="comment">// 6. åˆ›å»º Mock å¯¹åº”ï¼Œå¯¹åº”çš„ Invoker å¯¹è±¡</span></span><br /><span class="line">        invoker = proxyFactory.getInvoker(mockObject, serviceType, url);</span><br /><span class="line">        <span class="comment">// 7. æ·»åŠ åˆ°ç¼“å­˜</span></span><br /><span class="line">        <span class="keyword">if</span> (mocks.size() &lt; <span class="number">10000</span>) {</span><br /><span class="line">            mocks.put(mockService, invoker);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span> invoker;</span><br /><span class="line">    } <span class="keyword">catch</span> (InstantiationException e) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such empty constructor \"public "</span> + mockClass.getSimpleName() + <span class="string">"()\" in mock implemention class "</span> + mockClass.getName(), e);</span><br /><span class="line">    } <span class="keyword">catch</span> (IllegalAccessException e) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œèƒ–å‹çœ‹ä»£ç æ³¨é‡Šã€‚</li>
</ul>
<h1 id="6-AbstractInterfaceConfig">6. AbstractInterfaceConfig</h1>
<p><code>#checkStubAndMock(Class&lt;?&gt; interfaceClass)</code>&nbsp;æ–¹æ³•ï¼Œæ ¡éªŒ Stub å’Œ&nbsp;<strong>Mock ç›¸å…³çš„é…ç½®</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkStubAndMock</span><span class="params">(Class&lt;?&gt; interfaceClass)</span> </span>{</span><br /><span class="line">    <span class="comment">// ã€çœç•¥ä»£ç ã€‘`local` é…ç½®é¡¹çš„æ ¡éªŒï¼Œå’Œ `stub` ä¸€æ ·ã€‚</span></span><br /><span class="line">    <span class="comment">// ã€çœç•¥ä»£ç ã€‘`stub` é…ç½®é¡¹çš„æ ¡éªŒ</span></span><br /><br /><span class="line">    <span class="comment">// mock é…ç½®æ ¡éªŒ</span></span><br /><span class="line">    <span class="keyword">if</span> (ConfigUtils.isNotEmpty(mock)) {</span><br /><span class="line">        <span class="keyword">if</span> (mock.startsWith(Constants.RETURN_PREFIX)) { <span class="comment">// å¤„ç† "return " å¼€å¤´çš„æƒ…å†µ</span></span><br /><span class="line">            String value = mock.substring(Constants.RETURN_PREFIX.length());</span><br /><span class="line">            <span class="comment">// æ ¡éªŒ Mock å€¼ï¼Œé…ç½®æ­£ç¡®</span></span><br /><span class="line">            <span class="keyword">try</span> {</span><br /><span class="line">                MockInvoker.parseMockValue(value);</span><br /><span class="line">            } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Illegal mock json value in &lt;dubbo:service ... mock=\""</span> + mock + <span class="string">"\" /&gt;"</span>);</span><br /><span class="line">            }</span><br /><span class="line">        } <span class="keyword">else</span> {</span><br /><span class="line">            <span class="comment">// è·å¾— Mock ç±»</span></span><br /><span class="line">            Class&lt;?&gt; mockClass = ConfigUtils.isDefault(mock) ? ReflectUtils.forName(interfaceClass.getName() + <span class="string">"Mock"</span>) : ReflectUtils.forName(mock);</span><br /><span class="line">            <span class="comment">// æ ¡éªŒæ˜¯å¦å®ç°æ¥å£ç±»</span></span><br /><span class="line">            <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(mockClass)) {</span><br /><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The mock implementation class "</span> + mockClass.getName() + <span class="string">" not implement interface "</span> + interfaceClass.getName());</span><br /><span class="line">            }</span><br /><span class="line">            <span class="comment">// æ ¡éªŒæ˜¯å¦æœ‰é»˜è®¤æ„é€ æ–¹æ³•</span></span><br /><span class="line">            <span class="keyword">try</span> {</span><br /><span class="line">                mockClass.getConstructor();</span><br /><span class="line">            } <span class="keyword">catch</span> (NoSuchMethodException e) {</span><br /><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such empty constructor \"public "</span> + mockClass.getSimpleName() + <span class="string">"()\" in mock implementation class "</span> + mockClass.getName());</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œèƒ–å‹çœ‹ä»£ç æ³¨é‡Šã€‚</li>
<li>ä» Mock é…ç½®æ ¡éªŒçš„é€»è¾‘æˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä¸å…è®¸é…ç½®&nbsp;<code>"force:"</code>&nbsp;å’Œ&nbsp;<code>"fail:"</code>&nbsp;ä¸ºå¼€å¤´ã€‚ğŸ˜ˆ æ‰€ä»¥ï¼Œ<strong>ä¸èƒ½é€šè¿‡</strong>&nbsp;Java API æˆ–è€… XML ï¼Œåˆæˆ–è€…æ³¨è§£æ¥é…ç½® Mock è§„åˆ™ï¼Œåªèƒ½é€šè¿‡<strong>é…ç½®è§„åˆ™</strong>æ¥å¼€å¯<strong>æœåŠ¡é™çº§</strong>ã€‚å…·ä½“çš„é…ç½®æ–¹å¼ï¼Œå‚è§&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/service-downgrade.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; æœåŠ¡é™çº§ã€‹</a>ã€‚
<ul>
<li>åŒæ ·ï¼Œä¹Ÿä¸å…è®¸é…ç½®&nbsp;<code>"throws "</code>&nbsp;å¼€å¤´ã€‚</li>
</ul>
</li>
</ul>
</div>