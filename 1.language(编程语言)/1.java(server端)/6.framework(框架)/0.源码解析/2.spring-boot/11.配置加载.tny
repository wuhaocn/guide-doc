<header class="article-header">
<h1 class="article-title">é…ç½®åŠ è½½</h1>
</header>
<div class="article-entry">
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>åœ¨ä½¿ç”¨ Spring Boot æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„åœ¨&nbsp;<code>application.properties</code>&nbsp;æˆ–&nbsp;<code>application.yml</code>&nbsp;é…ç½®æ–‡ä»¶ä¸­ï¼Œæ·»åŠ ç›¸åº”çš„åº”ç”¨æ‰€éœ€çš„é…ç½®ã€‚é‚£ä¹ˆï¼Œç©¶ç«Ÿ Spring Boot æ˜¯å¦‚ä½•å®ç°è¯¥åŠŸèƒ½çš„å‘¢ï¼Œä»Šå„¿æˆ‘ä»¬å°±é€šè¿‡ Spring Boot çš„æºç ï¼Œä¸€æ¢ç©¶ç«Ÿï¼</p>
<blockquote>
<p>è‰¿è‰¿çš„é«˜èƒ½æç¤ºï¼šè¿™ç¯‡ä¼šéå¸¸é•¿ï¼Œå»ºè®®èƒ–å‹ä¿æŒè€å¿ƒã€‚å¦å¤–ï¼Œæœ€å¥½è¾¹è°ƒè¯•è¾¹çœ‹~</p>
</blockquote>
<h1 id="2-Profiles">2. Profiles</h1>
<p>åœ¨è®²é…ç½®åŠ è½½ä¹‹å‰ï¼Œä¸å¾—ä¸å…ˆæä¸‹ Spring Profiles åŠŸèƒ½ã€‚</p>
<ul>
<li>å¦‚æœä¸ç†Ÿæ‚‰çš„èƒ–å‹ï¼Œå…ˆçœ‹çœ‹&nbsp;<a href="https://www.jianshu.com/p/948c303b2253" target="_blank" rel="external nofollow noopener noreferrer">ã€Šè¯¦è§£ Spring ä¸­çš„ Profileã€‹</a>&nbsp;æ–‡ç« ã€‚</li>
<li>å…³äºè¿™ä¸€å—ï¼Œä¹‹å‰åœ¨&nbsp;<a href="http://svip.iocoder.cn/Spring/PropertySource-and-Environment-and-Profile/">ã€Šã€æ­»ç£• Springã€‘&mdash;&mdash; ç¯å¢ƒ &amp; å±æ€§ï¼šPropertySourceã€Environmentã€Profileã€‹</a>&nbsp;ä¸­ï¼Œå·²ç»æœ‰è¯¦ç»†çš„æºç è§£æã€‚</li>
</ul>
<p>ğŸ˜ˆ Spring Boot åœ¨ Spring Framework çš„åŸºç¡€ä¹‹ä¸Šï¼Œå¯ä»¥æ‰‹åŠ¨é™„åŠ æ–°çš„ Profile ã€‚åœ¨&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/SpringApplication/">ã€Šç²¾å°½ Spring Boot æºç åˆ†æ &mdash;&mdash; SpringApplicationã€‹</a>&nbsp;çš„&nbsp;<code>#</code>&nbsp;ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringApplication.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é™„åŠ çš„ profiles çš„æ•°ç»„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Set&lt;String&gt; additionalProfiles = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br /><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configureProfiles</span><span class="params">(ConfigurableEnvironment environment, String[] args)</span> </span>{</span><br /><span class="line">    environment.getActiveProfiles(); <span class="comment">// ensure they are initialized ä¿è¯å·²ç»è¢«åˆå§‹åŒ–</span></span><br /><span class="line">    <span class="comment">// But these ones should go first (last wins in a property key clash)</span></span><br /><span class="line">    Set&lt;String&gt; profiles = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(<span class="keyword">this</span>.additionalProfiles);</span><br /><span class="line">    profiles.addAll(Arrays.asList(environment.getActiveProfiles())); <span class="comment">// &lt;X&gt;</span></span><br /><span class="line">    <span class="comment">// è®¾ç½® activeProfiles</span></span><br /><span class="line">    environment.setActiveProfiles(StringUtils.toStringArray(profiles));</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>additionalProfiles</code>&nbsp;å±æ€§ï¼Œå¯ä»¥è®¾ç½®åˆ›å»ºçš„ SpringApplication å¯ä»¥é™„åŠ çš„&nbsp;<code>additionalProfiles</code>&nbsp;å±æ€§ã€‚</li>
<li><code>&lt;X&gt;</code>&nbsp;å¤„ï¼Œåœ¨åŸæœ‰ Spring Framework ä¸­è®¾ç½®çš„ String Profiles çš„åŸºç¡€ä¸Šï¼Œåˆé™„åŠ ä¸Šäº†&nbsp;<code>SpringApplication.additionalProfiles</code>&nbsp;é…ç½®çš„ã€‚</li>
</ul>
<blockquote>
<p>è‰¿è‰¿ï¼šè¿™ä¸ªå°èŠ‚ï¼Œè®²çš„æœ‰ç‚¹ç»•ï¼Œèƒ–å‹è¾›è‹¦ç†è§£ä¸‹~</p>
</blockquote>
<h1 id="3-ConfigFileApplicationListener">3. ConfigFileApplicationListener</h1>
<p>Spring Boot å®ç°&nbsp;<code>application.properties</code>&nbsp;æˆ–&nbsp;<code>application.yml</code>&nbsp;é…ç½®æ–‡ä»¶çš„åŠ è½½ï¼Œå…³é”®åœ¨äº ConfigFileApplicationListener ç±»ã€‚åœ¨&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/ApplicationListener/">ã€Šç²¾å°½ Spring Boot æºç åˆ†æ &mdash;&mdash; ApplicationListenerã€‹</a>&nbsp;ä¸­ï¼Œæˆ‘ä»¬å·²ç»ç®€å•ä»‹ç»è¿‡å®ƒï¼š</p>
<blockquote>
<p><code>org.springframework.boot.context.config.ConfigFileApplicationListener</code>&nbsp;ï¼Œå®ç° SmartApplicationListenerã€Orderedã€EnvironmentPostProcessor æ¥å£ï¼Œå®ç° Spring Boot é…ç½®æ–‡ä»¶çš„åŠ è½½ã€‚</p>
</blockquote>
<ul>
<li>æ³¨æ„å“Ÿï¼ŒConfigFileApplicationListener å³æ˜¯ä¸€ä¸ª SmartApplicationListener å®ç°ç±»ï¼Œåˆæ˜¯ä¸€ä¸ª EnvironmentPostProcessor å®ç°ç±»ã€‚</li>
</ul>
<h2 id="3-1-onApplicationEvent">3.1 onApplicationEvent</h2>
<p>å®ç°&nbsp;<code>#onApplicationEvent(ApplicationEvent event)</code>&nbsp;æ–¹æ³•ï¼Œåˆ†åˆ«å¯¹ ApplicationEnvironmentPreparedEventã€ApplicationPreparedEvent äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supportsEventType</span><span class="params">(Class&lt;? extends ApplicationEvent&gt; eventType)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> ApplicationEnvironmentPreparedEvent.class.isAssignableFrom(eventType)</span><br /><span class="line">            || ApplicationPreparedEvent.class.isAssignableFrom(eventType);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; å¦‚æœæ˜¯ ApplicationEnvironmentPreparedEvent äº‹ä»¶ï¼Œè¯´æ˜ Spring ç¯å¢ƒå‡†å¤‡å¥½äº†ï¼Œåˆ™æ‰§è¡Œç›¸åº”çš„å¤„ç†</span></span><br /><span class="line">    <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationEnvironmentPreparedEvent) {</span><br /><span class="line">        onApplicationEnvironmentPreparedEvent((ApplicationEnvironmentPreparedEvent) event);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// &lt;2&gt; å¦‚æœæ˜¯ ApplicationPreparedEvent äº‹ä»¶ï¼Œè¯´æ˜ Spring å®¹å™¨åˆå§‹åŒ–å¥½äº†ï¼Œåˆ™è¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚</span></span><br /><span class="line">    <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationPreparedEvent) {</span><br /><span class="line">        onApplicationPreparedEvent(event);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œå¦‚æœæ˜¯ ApplicationEnvironmentPreparedEvent äº‹ä»¶ï¼Œè¯´æ˜ Spring ç¯å¢ƒå‡†å¤‡å¥½äº†ï¼Œåˆ™è°ƒç”¨&nbsp;<code>#onApplicationEnvironmentPreparedEvent(ApplicationEnvironmentPreparedEvent)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œç›¸åº”çš„å¤„ç†ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ3.2 onApplicationEnvironmentPreparedEventã€</a>&nbsp;ã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œå¦‚æœæ˜¯ ApplicationPreparedEvent äº‹ä»¶ï¼Œè¯´æ˜ Spring å®¹å™¨åˆå§‹åŒ–å¥½äº†ï¼Œåˆ™è°ƒç”¨&nbsp;<code>#onApplicationPreparedEvent(ApplicationPreparedEvent)</code>&nbsp;æ–¹æ³•ï¼Œè¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ3.3 onApplicationPreparedEventã€</a>&nbsp;ã€‚</li>
</ul>
<h2 id="3-2-onApplicationEnvironmentPreparedEvent">3.2 onApplicationEnvironmentPreparedEvent</h2>
<p><code>#onApplicationEnvironmentPreparedEvent(ApplicationEnvironmentPreparedEvent)</code>&nbsp;æ–¹æ³•ï¼Œå¤„ç† ApplicationEnvironmentPreparedEvent äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onApplicationEnvironmentPreparedEvent</span><span class="params">(ApplicationEnvironmentPreparedEvent event)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1.1&gt; åŠ è½½æŒ‡å®šç±»å‹ EnvironmentPostProcessor å¯¹åº”çš„ï¼Œåœ¨ `META-INF/spring.factories` é‡Œçš„ç±»åçš„æ•°ç»„</span></span><br /><span class="line">    List&lt;EnvironmentPostProcessor&gt; postProcessors = loadPostProcessors();</span><br /><span class="line">    <span class="comment">// åŠ å…¥è‡ªå·±</span></span><br /><span class="line">    postProcessors.add(<span class="keyword">this</span>);</span><br /><span class="line">    <span class="comment">// æ’åº postProcessors æ•°ç»„</span></span><br /><span class="line">    AnnotationAwareOrderComparator.sort(postProcessors);</span><br /><span class="line">    <span class="comment">// éå† postProcessors æ•°ç»„ï¼Œé€ä¸ªæ‰§è¡Œã€‚</span></span><br /><span class="line">    <span class="keyword">for</span> (EnvironmentPostProcessor postProcessor : postProcessors) {</span><br /><span class="line">        postProcessor.postProcessEnvironment(event.getEnvironment(), event.getSpringApplication());</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>&lt;1.1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#loadPostProcessors()</code>&nbsp;æ–¹æ³•ï¼ŒåŠ è½½æŒ‡å®šç±»å‹ EnvironmentPostProcessor å¯¹åº”çš„ï¼Œåœ¨&nbsp;<code>META-INF/spring.factories</code>&nbsp;é‡Œçš„ç±»åçš„æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener.java</span></span><br /><br /><span class="line"><span class="function">List&lt;EnvironmentPostProcessor&gt; <span class="title">loadPostProcessors</span><span class="params">()</span> </span>{</span><br /><span class="line">	<span class="keyword">return</span> SpringFactoriesLoader.loadFactories(EnvironmentPostProcessor.class, getClass().getClassLoader());</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿”å›çš„æ˜¯ SystemEnvironmentPropertySourceEnvironmentPostProcessorã€SpringApplicationJsonEnvironmentPostProcessorã€CloudFoundryVcapEnvironmentPostProcessor ç±»ã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;1.2&gt;</code>&nbsp;å¤„ï¼ŒåŠ å…¥è‡ªå·±ï¼Œåˆ°&nbsp;<code>postProcessors</code>&nbsp;æ•°ç»„ä¸­ã€‚å› ä¸ºè‡ªå·±ä¹Ÿæ˜¯ä¸€ä¸ª EnvironmentPostProcessor å®ç°ç±»ã€‚</p>
</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œæ’åº&nbsp;<code>postProcessors</code>&nbsp;æ•°ç»„ã€‚</li>
<li><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œéå†&nbsp;<code>postProcessors</code>&nbsp;æ•°ç»„ï¼Œè°ƒç”¨&nbsp;<code>EnvironmentPostProcessor#postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application)</code>&nbsp;æ–¹æ³•ï¼Œé€ä¸ªæ‰§è¡Œã€‚</li>
</ul>
<p>é‚£ä¹ˆï¼Œæˆ‘ä»¬å¼€å§‹æ¥é€ä¸ªçœ‹çœ‹æ¯ä¸ª EnvironmentPostProcessor å®ç°ç±»ã€‚è€ƒè™‘åˆ° EnvironmentPostProcessor åº”æœ‰çš„ç‹¬ç«‹æ€§ï¼ˆå°Šä¸¥!ï¼‰ï¼Œæˆ‘ä»¬å•ç‹¬å¼€äº†&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4. EnvironmentPostProcessorã€</a>&nbsp;å°èŠ‚ï¼Œæ‰€ä»¥èƒ–å‹å…ˆä¸€èµ·è·³è¿‡æ¥çœ‹çœ‹ã€‚</p>
<blockquote>
<p>è‰¿è‰¿ï¼šè¿™å—æ¶‰åŠçš„é€»è¾‘éå¸¸å¤šã€‚æœ¬æ–‡çš„ 4ã€5ã€6ã€7 å°èŠ‚ï¼Œéƒ½å’Œ&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ3.2 onApplicationEnvironmentPreparedEventã€</a>&nbsp;æœ‰å…³ã€‚</p>
</blockquote>
<h2 id="3-3-onApplicationPreparedEvent">3.3 onApplicationPreparedEvent</h2>
<p><code>#onApplicationPreparedEvent(ApplicationEvent event)</code>&nbsp;æ–¹æ³•ï¼Œå¤„ç† ApplicationPreparedEvent äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onApplicationPreparedEvent</span><span class="params">(ApplicationEvent event)</span> </span>{</span><br /><span class="line">    <span class="comment">// ä¿®æ”¹ logger æ–‡ä»¶ï¼Œæš‚æ—¶å¯ä»¥æ— è§†ã€‚</span></span><br /><span class="line">    <span class="keyword">this</span>.logger.switchTo(ConfigFileApplicationListener.class);</span><br /><span class="line">    <span class="comment">// æ·»åŠ  PropertySourceOrderingPostProcessor å¤„ç†å™¨</span></span><br /><span class="line">    addPostProcessors(((ApplicationPreparedEvent) event).getApplicationContext());</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addPostProcessors</span><span class="params">(ConfigurableApplicationContext context)</span> </span>{</span><br /><span class="line">    context.addBeanFactoryPostProcessor(<span class="keyword">new</span> PropertySourceOrderingPostProcessor(context));</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ·»åŠ  PropertySourceOrderingPostProcessor å¤„ç†å™¨ã€‚å…³äº PropertySourceOrderingPostProcessor ç±»ï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ3.3.1 PropertySourceOrderingPostProcessorã€</a>&nbsp;ä¸­ã€‚</li>
</ul>
<h3 id="3-3-1-PropertySourceOrderingPostProcessor">3.3.1 PropertySourceOrderingPostProcessor</h3>
<p>PropertySourceOrderingPostProcessor ï¼Œæ˜¯ ConfigFileApplicationListener å†…éƒ¨ç±»ï¼Œå®ç° BeanFactoryPostProcessorã€Ordered æ¥å£ï¼Œå°†&nbsp;<code>DEFAULT_PROPERTIES</code>&nbsp;çš„ PropertySource å±æ€§æºï¼Œæ·»åŠ åˆ°&nbsp;<code>environment</code>&nbsp;çš„å°¾éƒ¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener.java</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_PROPERTIES = <span class="string">"defaultProperties"</span>;</span><br /><br /><span class="line"><span class="comment">// ConfigFileApplicationListener#PropertySourceOrderingPostProcessor.java</span></span><br /><br /><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertySourceOrderingPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span>, <span class="title">Ordered</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> ConfigurableApplicationContext context;</span><br /><br /><span class="line">    PropertySourceOrderingPostProcessor(ConfigurableApplicationContext context) {</span><br /><span class="line">        <span class="keyword">this</span>.context = context;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> Ordered.HIGHEST_PRECEDENCE;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>{</span><br /><span class="line">        reorderSources(<span class="keyword">this</span>.context.getEnvironment());</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reorderSources</span><span class="params">(ConfigurableEnvironment environment)</span> </span>{</span><br /><span class="line">        <span class="comment">// ç§»é™¤ DEFAULT_PROPERTIES çš„å±æ€§æº</span></span><br /><span class="line">        PropertySource&lt;?&gt; defaultProperties = environment.getPropertySources().remove(DEFAULT_PROPERTIES);</span><br /><span class="line">        <span class="comment">// æ·»åŠ åˆ° environment å°¾éƒ¨</span></span><br /><span class="line">        <span class="keyword">if</span> (defaultProperties != <span class="keyword">null</span>) {</span><br /><span class="line">            environment.getPropertySources().addLast(defaultProperties);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>é‚£ä¹ˆ&nbsp;<code>DEFAULT_PROPERTIES</code>&nbsp;å¯¹åº”çš„ PropertySource å±æ€§æºï¼Œç©¶ç«Ÿæ˜¯å“ªé‡Œæ¥çš„å‘¢ï¼Ÿç­”æ¡ˆè§&nbsp;<code>SpringApplication.defaultProperties</code>&nbsp;ç›¸å…³ï¼Œä»£ç å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringApplication.java </span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é»˜è®¤çš„å±æ€§é›†åˆ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Map&lt;String, Object&gt; defaultProperties;</span><br /><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configurePropertySources</span><span class="params">(ConfigurableEnvironment environment, String[] args)</span> </span>{</span><br /><span class="line">	MutablePropertySources sources = environment.getPropertySources();</span><br /><span class="line">	<span class="comment">// é…ç½®çš„ defaultProperties</span></span><br /><span class="line">	<span class="keyword">if</span> (<span class="keyword">this</span>.defaultProperties != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.defaultProperties.isEmpty()) {</span><br /><span class="line">		sources.addLast(<span class="keyword">new</span> MapPropertySource(<span class="string">"defaultProperties"</span>, <span class="keyword">this</span>.defaultProperties));</span><br /><span class="line">	}</span><br />	<br /><span class="line">	<span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="4-EnvironmentPostProcessor">4. EnvironmentPostProcessor</h1>
<p><code>org.springframework.boot.context.config.EnvironmentPostProcessor</code>&nbsp;æ¥å£ï¼Œåœ¨ Environment åŠ è½½å®Œæˆä¹‹åï¼Œå¦‚æœæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œä¸€äº›é…ç½®ã€å¢åŠ ä¸€äº›è‡ªå·±çš„å¤„ç†é€»è¾‘ï¼Œé‚£ä¹ˆè¯·ä½¿ç”¨ EnvironmentPostProcessor ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// EnvironmentPostProcessor.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Allows for customization of the application's {<span class="doctag">@link</span> Environment} prior to the</span></span><br /><span class="line"><span class="comment"> * application context being refreshed.</span></span><br /><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br /><span class="line"><span class="comment"> * EnvironmentPostProcessor implementations have to be registered in</span></span><br /><span class="line"><span class="comment"> * {<span class="doctag">@code</span> META-INF/spring.factories}, using the fully qualified name of this class as the</span></span><br /><span class="line"><span class="comment"> * key.</span></span><br /><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br /><span class="line"><span class="comment"> * {<span class="doctag">@code</span> EnvironmentPostProcessor} processors are encouraged to detect whether Spring's</span></span><br /><span class="line"><span class="comment"> * {<span class="doctag">@link</span> org.springframework.core.Ordered Ordered} interface has been implemented or if</span></span><br /><span class="line"><span class="comment"> * the {<span class="doctag">@link</span> org.springframework.core.annotation.Order <span class="doctag">@Order</span>} annotation is present and</span></span><br /><span class="line"><span class="comment"> * to sort instances accordingly if so prior to invocation.</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@author</span> Andy Wilkinson</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@author</span> Stephane Nicoll</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.3.0</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="meta">@FunctionalInterface</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EnvironmentPostProcessor</span> </span>{</span><br /><br /><span class="line">	<span class="comment">/**</span></span><br /><span class="line"><span class="comment">	 * Post-process the given {<span class="doctag">@code</span> environment}.</span></span><br /><span class="line"><span class="comment">	 * <span class="doctag">@param</span> environment the environment to post-process</span></span><br /><span class="line"><span class="comment">	 * <span class="doctag">@param</span> application the application to which the environment belongs</span></span><br /><span class="line"><span class="comment">	 */</span></span><br /><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">postProcessEnvironment</span><span class="params">(ConfigurableEnvironment environment, SpringApplication application)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>ä»å®ç°ä¸Šå’Œä½œç”¨ä¸Šæ¥è¯´ï¼Œå’Œ&nbsp;<a href="http://svip.iocoder.cn/Spring/IoC-BeanPostProcessor/">ã€Šã€æ­»ç£• Springã€‘&mdash;&mdash; IoC ä¹‹æ·±å…¥åˆ†æ BeanPostProcessorã€‹</a>&nbsp;éƒ½æ˜¯éå¸¸ç±»ä¼¼çš„ã€‚</p>
<p>EnvironmentPostProcessor çš„å®ç°ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-01-28/01.jpg" alt="EnvironmentPostProcessor å®ç°ç±»" /></p>
<h2 id="4-1-CloudFoundryVcapEnvironmentPostProcessor">4.1 CloudFoundryVcapEnvironmentPostProcessor</h2>
<p><code>org.springframework.boot.cloud.CloudFoundryVcapEnvironmentPostProcessor</code>&nbsp;ï¼Œå®ç° EnvironmentPostProcessorã€Ordered æ¥å£ï¼Œå®ç°å¯¹&nbsp;<a href="https://www.cloudfoundry.org/" target="_blank" rel="external nofollow noopener noreferrer">Cloud Foundry</a>&nbsp;çš„æ”¯æŒã€‚å› ä¸ºæˆ‘ä»¬ä¸ä½¿ç”¨ Cloud Foundry ï¼Œæ‰€ä»¥å¯ä»¥è·³è¿‡å¯¹ CloudFoundryVcapEnvironmentPostProcessor æºç çš„äº†è§£ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥ç»“åˆ&nbsp;<a href="https://segmentfault.com/a/1190000015088555" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠSpring Boot å‚è€ƒæŒ‡å—ï¼ˆéƒ¨ç½²åˆ°äº‘ï¼‰ã€‹</a>&nbsp;æ–‡ç« ï¼Œå¯¹æºç è¿›è¡Œç ”ç©¶ã€‚</p>
<h2 id="4-2-SystemEnvironmentPropertySourceEnvironmentPostProcessor">4.2 SystemEnvironmentPropertySourceEnvironmentPostProcessor</h2>
<blockquote>
<p>è‰¿è‰¿ï¼šé€‰çœ‹~</p>
</blockquote>
<p><code>org.springframework.boot.env.SystemEnvironmentPropertySourceEnvironmentPostProcessor</code>&nbsp;ï¼Œå®ç° EnvironmentPostProcessorã€Ordered æ¥å£ï¼Œå®ç°å°†&nbsp;<code>environment</code>&nbsp;ä¸­çš„&nbsp;<code>systemEnvironment</code>&nbsp;å¯¹åº”çš„ PropertySource å±æ€§æºå¯¹è±¡ï¼Œæ›¿æ¢æˆ OriginAwareSystemEnvironmentPropertySource å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SystemEnvironmentPropertySourceEnvironmentPostProcessor.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessEnvironment</span><span class="params">(ConfigurableEnvironment environment, SpringApplication application)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; è·å¾— systemEnvironment å¯¹åº”çš„ PropertySource å±æ€§æº</span></span><br /><span class="line">    String sourceName = StandardEnvironment.SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME;</span><br /><span class="line">    PropertySource&lt;?&gt; propertySource = environment.getPropertySources().get(sourceName);</span><br /><span class="line">    <span class="comment">// &lt;2&gt; å°†åŸå§‹çš„ PropertySource å¯¹è±¡ï¼Œæ›¿æ¢æˆ OriginAwareSystemEnvironmentPropertySource å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">if</span> (propertySource != <span class="keyword">null</span>) {</span><br /><span class="line">        replacePropertySource(environment, sourceName, propertySource);</span><br /><span class="line">    }</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replacePropertySource</span><span class="params">(ConfigurableEnvironment environment, String sourceName, PropertySource&lt;?&gt; propertySource)</span> </span>{</span><br /><span class="line">    Map&lt;String, Object&gt; originalSource = (Map&lt;String, Object&gt;) propertySource.getSource();</span><br /><span class="line">    <span class="comment">// åˆ›å»º SystemEnvironmentPropertySource å¯¹è±¡</span></span><br /><span class="line">    SystemEnvironmentPropertySource source = <span class="keyword">new</span> OriginAwareSystemEnvironmentPropertySource(sourceName, originalSource);</span><br /><span class="line">    <span class="comment">// è¿›è¡Œæ›¿æ¢</span></span><br /><span class="line">    environment.getPropertySources().replace(sourceName, source);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè·å¾—&nbsp;<code>systemEnvironment</code>&nbsp;å¯¹åº”çš„ PropertySource å±æ€§æºã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#replacePropertySource(...)</code>&nbsp;æ–¹æ³•ï¼Œå°†åŸå§‹çš„ PropertySource å¯¹è±¡ï¼Œæ›¿æ¢æˆ OriginAwareSystemEnvironmentPropertySource å¯¹è±¡ã€‚</li>
<li>
<p>å…¶ä¸­ï¼ŒOriginAwareSystemEnvironmentPropertySource æ˜¯ SystemEnvironmentPropertySourceEnvironmentPostProcessor å†…éƒ¨ç±»ï¼Œç»§æ‰¿ SystemEnvironmentPropertySource ç±»ï¼Œå®ç° OriginLookup æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SystemEnvironmentPropertySourceEnvironmentPostProcessor#OriginAwareSystemEnvironmentPropertySource.java</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OriginAwareSystemEnvironmentPropertySource</span></span></span><br /><span class="line"><span class="class">		<span class="keyword">extends</span> <span class="title">SystemEnvironmentPropertySource</span> <span class="keyword">implements</span> <span class="title">OriginLookup</span>&lt;<span class="title">String</span>&gt; </span>{</span><br /><br /><span class="line">	OriginAwareSystemEnvironmentPropertySource(String name, Map&lt;String, Object&gt; source) {</span><br /><span class="line">		<span class="keyword">super</span>(name, source);</span><br /><span class="line">	}</span><br /><br /><span class="line">	<span class="meta">@Override</span></span><br /><span class="line">	<span class="function"><span class="keyword">public</span> Origin <span class="title">getOrigin</span><span class="params">(String key)</span> </span>{</span><br /><span class="line">	    <span class="comment">// è§£æ key å¯¹åº”çš„ property</span></span><br /><span class="line">		String property = resolvePropertyName(key);</span><br /><span class="line">		<span class="comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨ property å¯¹åº”çš„å€¼ã€‚å¦‚æœå­˜åœ¨ï¼Œåˆ™è¿”å› SystemEnvironmentOrigin å¯¹è±¡</span></span><br /><span class="line">		<span class="keyword">if</span> (<span class="keyword">super</span>.containsProperty(property)) {</span><br /><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> SystemEnvironmentOrigin(property);</span><br /><span class="line">		}</span><br /><span class="line">		<span class="comment">// ä¸å­˜åœ¨ï¼Œåˆ™è¿”å› null</span></span><br /><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">	}</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>é‡å¿ƒæ˜¯å¯¹&nbsp;<a href="https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot/src/main/java/org/springframework/boot/origin/OriginLookup.java" target="_blank" rel="external nofollow noopener noreferrer"><code>org.springframework.boot.origin.OriginLookup</code></a>&nbsp;æ¥å£çš„&nbsp;<code>#getOrigin(String key)</code>&nbsp;æ–¹æ³•çš„å®ç°ï¼Œå®ç°æŸ¥æ‰¾&nbsp;<code>key</code>&nbsp;å¯¹åº”çš„çœŸæ­£çš„&nbsp;<code>property</code>&nbsp;ã€‚éš¾é“ä¸¤è€…è¿˜ä¼šä¸åŒï¼Œç­”æ¡ˆæ˜¯çš„ã€‚ä¾‹å¦‚è¯´ï¼šä¼ å…¥çš„&nbsp;<code>key=foo.bar.baz</code>&nbsp;ï¼Œè¿”å›çš„æ˜¯&nbsp;<code>property=FOO_BAR_BAZ</code>&nbsp;ã€‚</li>
<li>
<p>ç­”æ¡ˆè§&nbsp;<code>SystemEnvironmentPropertySource#checkPropertyName(String name)</code>&nbsp;æ–¹æ³•ï¼Œå†…éƒ¨ä¼šè¿›è¡Œå„ç§çµæ´»çš„æ›¿æ¢&ldquo;æŸ¥æ‰¾&rdquo;ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SystemEnvironmentPropertySource.java</span></span><br /><br /><span class="line"><span class="meta">@Nullable</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">checkPropertyName</span><span class="params">(String name)</span> </span>{</span><br /><span class="line">	<span class="comment">// Check name as-is</span></span><br /><span class="line">	<span class="keyword">if</span> (containsKey(name)) {</span><br /><span class="line">		<span class="keyword">return</span> name;</span><br /><span class="line">	}</span><br /><span class="line">	<span class="comment">// Check name with just dots replaced</span></span><br /><span class="line">	String noDotName = name.replace(<span class="string">'.'</span>, <span class="string">'_'</span>);</span><br /><span class="line">	<span class="keyword">if</span> (!name.equals(noDotName) &amp;&amp; containsKey(noDotName)) {</span><br /><span class="line">		<span class="keyword">return</span> noDotName;</span><br /><span class="line">	}</span><br /><span class="line">	<span class="comment">// Check name with just hyphens replaced</span></span><br /><span class="line">	String noHyphenName = name.replace(<span class="string">'-'</span>, <span class="string">'_'</span>);</span><br /><span class="line">	<span class="keyword">if</span> (!name.equals(noHyphenName) &amp;&amp; containsKey(noHyphenName)) {</span><br /><span class="line">		<span class="keyword">return</span> noHyphenName;</span><br /><span class="line">	}</span><br /><span class="line">	<span class="comment">// Check name with dots and hyphens replaced</span></span><br /><span class="line">	String noDotNoHyphenName = noDotName.replace(<span class="string">'-'</span>, <span class="string">'_'</span>);</span><br /><span class="line">	<span class="keyword">if</span> (!noDotName.equals(noDotNoHyphenName) &amp;&amp; containsKey(noDotNoHyphenName)) {</span><br /><span class="line">		<span class="keyword">return</span> noDotNoHyphenName;</span><br /><span class="line">	}</span><br /><span class="line">	<span class="comment">// Give up</span></span><br /><span class="line">	<span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å„ç§ç¬¦å·ï¼Œè½¬æˆ&nbsp;<code>_</code>&nbsp;æ¥æŸ¥æ‰¾å¯¹åº”çš„å±æ€§ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>ğŸ˜ˆ é‚£ä¹ˆå…·ä½“æœ‰ä»€ä¹ˆæ ·çš„é€»è¾‘ä¸Šçš„éœ€è¦å‘¢ï¼Ÿæš‚æ—¶è¿˜æ²¡æ€ä¹ˆçœ‹åˆ°ï¼Œå˜¿å˜¿ã€‚æ‰€ä»¥ï¼ŒçŸ¥é“å°±å¥½ï¼Œæš‚æ—¶å…ˆä¸å»æ·±ç©¶ã€‚</p>
<h2 id="4-3-SpringApplicationJsonEnvironmentPostProcessor">4.3 SpringApplicationJsonEnvironmentPostProcessor</h2>
<blockquote>
<p>è‰¿è‰¿ï¼šé€‰çœ‹~</p>
</blockquote>
<p><code>org.springframework.boot.env.SpringApplicationJsonEnvironmentPostProcessor</code>&nbsp;ï¼Œå®ç° EnvironmentPostProcessorã€Ordered æ¥å£ï¼Œè§£æ&nbsp;<code>environment</code>&nbsp;ä¸­çš„&nbsp;<code>spring.application.json</code>&nbsp;æˆ–&nbsp;<code>SPRING_APPLICATION_JSON</code>&nbsp;å¯¹åº”çš„ JSON æ ¼å¼çš„å±æ€§å€¼ï¼Œåˆ›å»ºæ–°çš„ PropertySource å¯¹è±¡ï¼Œæ·»åŠ åˆ°å…¶ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringApplicationJsonEnvironmentPostProcessor.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é»˜è®¤çš„ {<span class="doctag">@link</span> #order} çš„å€¼</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * The default order for the processor.</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_ORDER = Ordered.HIGHEST_PRECEDENCE + <span class="number">5</span>;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é¡ºåº</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> order = DEFAULT_ORDER;</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessEnvironment</span><span class="params">(ConfigurableEnvironment environment, SpringApplication application)</span> </span>{</span><br /><span class="line">	MutablePropertySources propertySources = environment.getPropertySources();</span><br /><span class="line">	propertySources.stream().map(JsonPropertyValue::get).filter(Objects::nonNull)</span><br /><span class="line">			.findFirst().ifPresent((v) -&gt; processJson(environment, v));</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>map(JsonPropertyValue::get).filter(Objects::nonNull)</code>&nbsp;ä»£ç æ®µï¼Œè°ƒç”¨&nbsp;<code>JsonPropertyValue#get(PropertySource&lt;?&gt; propertySource)</code>&nbsp;æ–¹æ³•ï¼Œ<code>environment</code>&nbsp;ä¸­çš„&nbsp;<code>spring.application.json</code>&nbsp;æˆ–&nbsp;<code>SPRING_APPLICATION_JSON</code>&nbsp;å¯¹åº”çš„ JSON æ ¼å¼çš„å±æ€§å€¼ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringApplicationJsonEnvironmentPostProcessor.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SPRING_APPLICATION_JSON_PROPERTY = <span class="string">"spring.application.json"</span>;</span><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SPRING_APPLICATION_JSON_ENVIRONMENT_VARIABLE = <span class="string">"SPRING_APPLICATION_JSON"</span>;</span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonPropertyValue</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] CANDIDATES = { SPRING_APPLICATION_JSON_PROPERTY, SPRING_APPLICATION_JSON_ENVIRONMENT_VARIABLE };</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PropertySource&lt;?&gt; propertySource;</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String propertyName;</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String json;</span><br /><br /><span class="line">    JsonPropertyValue(PropertySource&lt;?&gt; propertySource, String propertyName, String json) {</span><br /><span class="line">        <span class="keyword">this</span>.propertySource = propertySource;</span><br /><span class="line">        <span class="keyword">this</span>.propertyName = propertyName;</span><br /><span class="line">        <span class="keyword">this</span>.json = json;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getJson</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.json;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> Origin <span class="title">getOrigin</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> PropertySourceOrigin.get(<span class="keyword">this</span>.propertySource, <span class="keyword">this</span>.propertyName);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JsonPropertyValue <span class="title">get</span><span class="params">(PropertySource&lt;?&gt; propertySource)</span> </span>{</span><br /><span class="line">        <span class="comment">// éå† CANDIDATES æ•°ç»„</span></span><br /><span class="line">        <span class="keyword">for</span> (String candidate : CANDIDATES) {</span><br /><span class="line">            <span class="comment">// è·å¾— candidate å¯¹åº”çš„å±æ€§å€¼</span></span><br /><span class="line">            Object value = propertySource.getProperty(candidate);</span><br /><span class="line">            <span class="keyword">if</span> (value <span class="keyword">instanceof</span> String</span><br /><span class="line">                    &amp;&amp; StringUtils.hasLength((String) value)) {</span><br /><span class="line">                <span class="comment">// åˆ›å»º JsonPropertyValue å¯¹è±¡ï¼Œç„¶åè¿”å›</span></span><br /><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> JsonPropertyValue(propertySource, candidate, (String) value);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹çœ‹ä¸‹å°±æ˜ç™½åˆ—ã€‚</li>
</ul>
</li>
<li>
<p>è°ƒç”¨&nbsp;<code>#processJson(ConfigurableEnvironment environment, JsonPropertyValue propertyValue)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œå¤„ç† JSON å­—ç¬¦ä¸²ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.3.1 processJsonã€</a>&nbsp;ã€‚</p>
</li>
</ul>
<h3 id="4-3-1-processJson">4.3.1 processJson</h3>
<p><code>#processJson(ConfigurableEnvironment environment, JsonPropertyValue propertyValue)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œå¤„ç† JSON å­—ç¬¦ä¸²ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringApplicationJsonEnvironmentPostProcessor.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processJson</span><span class="params">(ConfigurableEnvironment environment, JsonPropertyValue propertyValue)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; è§£æ json å­—ç¬¦ä¸²ï¼Œæˆ Map å¯¹è±¡</span></span><br /><span class="line">    JsonParser parser = JsonParserFactory.getJsonParser();</span><br /><span class="line">    Map&lt;String, Object&gt; map = parser.parseMap(propertyValue.getJson());</span><br /><span class="line">    <span class="comment">// &lt;2&gt; åˆ›å»º JsonPropertySource å¯¹è±¡ï¼Œæ·»åŠ åˆ° environment ä¸­</span></span><br /><span class="line">    <span class="keyword">if</span> (!map.isEmpty()) {</span><br /><span class="line">        <span class="comment">// &lt;2.2&gt;</span></span><br /><span class="line">        addJsonPropertySource(environment, <span class="keyword">new</span> JsonPropertySource(propertyValue, flatten(map))); <span class="comment">// &lt;2.1&gt;</span></span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè§£æ json å­—ç¬¦ä¸²ï¼Œæˆ Map å¯¹è±¡ã€‚</li>
<li>
<p><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œåˆ›å»º JsonPropertySource å¯¹è±¡ï¼Œæ·»åŠ åˆ°&nbsp;<code>environment</code>&nbsp;ä¸­ã€‚å…¶ä¸­ï¼ŒJsonPropertySource ç»§æ‰¿ MapPropertySource ç±»ï¼Œå®ç° OriginLookup æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringApplicationJsonEnvironmentPostProcessor#JsonPropertySource.java</span></span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JsonPropertySource</span> <span class="keyword">extends</span> <span class="title">MapPropertySource</span></span></span><br /><span class="line"><span class="class">		<span class="keyword">implements</span> <span class="title">OriginLookup</span>&lt;<span class="title">String</span>&gt; </span>{</span><br /><br /><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> JsonPropertyValue propertyValue;</span><br /><br /><span class="line">	JsonPropertySource(JsonPropertyValue propertyValue, Map&lt;String, Object&gt; source) {</span><br /><span class="line">		<span class="keyword">super</span>(SPRING_APPLICATION_JSON_PROPERTY, source);</span><br /><span class="line">		<span class="keyword">this</span>.propertyValue = propertyValue;</span><br /><span class="line">	}</span><br /><br /><span class="line">	<span class="meta">@Override</span></span><br /><span class="line">	<span class="function"><span class="keyword">public</span> Origin <span class="title">getOrigin</span><span class="params">(String key)</span> </span>{</span><br /><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.propertyValue.getOrigin();</span><br /><span class="line">	}</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä½¿ç”¨çš„&nbsp;<code>name</code>&nbsp;ä¸º&nbsp;<code>SPRING_APPLICATION_JSON_PROPERTY=spring.application.json</code>&nbsp;ã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;2.1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#flatten(String prefix, Map&lt;String, Object&gt; result, Map&lt;String, Object&gt; map)</code>&nbsp;æ–¹æ³•ï¼Œå°† JSON è§£æåçš„ Map å¯èƒ½å­˜åœ¨çš„å†…åµŒçš„ Map å¯¹è±¡ï¼Œè½¬æ¢æˆå¤šæ¡ KV æ ¼å¼çš„é…ç½®å¯¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringApplicationJsonEnvironmentPostProcessor.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title">flatten</span><span class="params">(Map&lt;String, Object&gt; map)</span> </span>{</span><br /><span class="line">    Map&lt;String, Object&gt; result = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br /><span class="line">    flatten(<span class="keyword">null</span>, result, map);</span><br /><span class="line">    <span class="keyword">return</span> result;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">flatten</span><span class="params">(String prefix, Map&lt;String, Object&gt; result, Map&lt;String, Object&gt; map)</span> </span>{</span><br /><span class="line">    String namePrefix = (prefix != <span class="keyword">null</span>) ? prefix + <span class="string">"."</span> : <span class="string">""</span>;</span><br /><span class="line">    map.forEach((key, value) -&gt; extract(namePrefix + key, result, value));</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">extract</span><span class="params">(String name, Map&lt;String, Object&gt; result, Object value)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Map) { <span class="comment">// å†…åµŒçš„ Map æ ¼å¼</span></span><br /><span class="line">        flatten(name, result, (Map&lt;String, Object&gt;) value);</span><br /><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (value <span class="keyword">instanceof</span> Collection) { <span class="comment">// å†…åµŒçš„ Collection</span></span><br /><span class="line">        <span class="keyword">int</span> index = <span class="number">0</span>;</span><br /><span class="line">        <span class="keyword">for</span> (Object object : (Collection&lt;Object&gt;) value) {</span><br /><span class="line">            extract(name + <span class="string">"["</span> + index + <span class="string">"]"</span>, result, object);</span><br /><span class="line">            index++;</span><br /><span class="line">        }</span><br /><span class="line">    } <span class="keyword">else</span> { <span class="comment">// æ™®é€šæ ¼å¼ï¼Œæ·»åŠ åˆ° result ä¸­</span></span><br /><span class="line">        result.put(name, value);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>&lt;2.2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#addJsonPropertySource(ConfigurableEnvironment environment, PropertySource&lt;?&gt; source)</code>&nbsp;æ–¹æ³•ï¼Œæ·»åŠ åˆ°&nbsp;<code>environment</code>&nbsp;ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringApplicationJsonEnvironmentPostProcessor.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addJsonPropertySource</span><span class="params">(ConfigurableEnvironment environment, PropertySource&lt;?&gt; source)</span> </span>{</span><br /><span class="line">    MutablePropertySources sources = environment.getPropertySources();</span><br /><span class="line">    <span class="comment">// è·å¾—éœ€è¦æ·»åŠ åˆ° source æ‰€åœ¨çš„ PropertySource ä¹‹å‰çš„åå­—</span></span><br /><span class="line">    String name = findPropertySource(sources);</span><br /><span class="line">    <span class="comment">// æ·»åŠ åˆ° environment çš„ sources ä¸­ã€‚</span></span><br /><span class="line">    <span class="comment">// è¿™ä¹ˆåšçš„æ•ˆæœæ˜¯ï¼Œsource é«˜äº SYSTEM_PROPERTIES_PROPERTY_SOURCE_NAME &amp;&amp; JNDI_PROPERTY_SOURCE_NAME ä¹‹å‰</span></span><br /><span class="line">    <span class="keyword">if</span> (sources.contains(name)) {</span><br /><span class="line">        sources.addBefore(name, source);</span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        sources.addFirst(source);</span><br /><span class="line">    }</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">findPropertySource</span><span class="params">(MutablePropertySources sources)</span> </span>{</span><br /><span class="line">    <span class="comment">// åœ¨ Servlet ç¯å¢ƒä¸‹ï¼Œä¸”æœ‰ JNDI_PROPERTY_SOURCE_NAME å±æ€§ï¼Œåˆ™è¿”å› StandardServletEnvironment.JNDI_PROPERTY_SOURCE_NAME</span></span><br /><span class="line">    <span class="keyword">if</span> (ClassUtils.isPresent(SERVLET_ENVIRONMENT_CLASS, <span class="keyword">null</span>)</span><br /><span class="line">            &amp;&amp; sources.contains(StandardServletEnvironment.JNDI_PROPERTY_SOURCE_NAME)) {</span><br /><span class="line">        <span class="keyword">return</span> StandardServletEnvironment.JNDI_PROPERTY_SOURCE_NAME;</span><br /><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// å¦åˆ™ï¼Œè¿”å› SYSTEM_PROPERTIES_PROPERTY_SOURCE_NAME å±æ€§</span></span><br /><span class="line">    <span class="keyword">return</span> StandardEnvironment.SYSTEM_PROPERTIES_PROPERTY_SOURCE_NAME;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<p>ğŸ˜ˆ å½“ç„¶ï¼Œå› ä¸ºç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šå»ä½¿ç”¨&nbsp;<code>spring.application.json</code>&nbsp;æˆ–&nbsp;<code>SPRING_APPLICATION_JSON</code>&nbsp;å»è¿›è¡Œé…ç½®ã€‚æ‰€ä»¥å‘¢ï¼Œè¿™å—é€»è¾‘ç­‰èƒ–å‹çœŸçš„æœ‰éœ€è¦ï¼Œå†æ¥ç…ç…è½ã€‚</p>
<h2 id="4-4-ConfigFileApplicationListener">4.4 ConfigFileApplicationListener</h2>
<blockquote>
<p>è‰¿è‰¿ï¼šçœŸæ­£çš„é‡å¤´æˆ~</p>
</blockquote>
<p>å®ç°&nbsp;<code>#addPropertySources(ConfigurableEnvironment environment,ResourceLoader resourceLoader)</code>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addPropertySources</span><span class="params">(ConfigurableEnvironment environment,ResourceLoader resourceLoader)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; æ·»åŠ  RandomValuePropertySource åˆ° environment ä¸­</span></span><br /><span class="line">    RandomValuePropertySource.addToEnvironment(environment);</span><br /><span class="line">    <span class="comment">// &lt;2&gt; åˆ›å»º Loader å¯¹è±¡ï¼Œè¿›è¡ŒåŠ è½½</span></span><br /><span class="line">    <span class="keyword">new</span> Loader(environment, resourceLoader).load();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œæ·»åŠ  RandomValuePropertySource åˆ°&nbsp;<code>environment</code>&nbsp;ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ5. RandomValuePropertySourceã€</a>&nbsp;ä¸­ã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œåˆ›å»º Loader å¯¹è±¡ï¼Œå¹¶è°ƒç”¨&nbsp;<code>Loader#load()</code>&nbsp;æ–¹æ³•ï¼Œè¿›è¡ŒåŠ è½½ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.4.1 Loaderã€</a>&nbsp;ä¸­ã€‚</li>
</ul>
<h3 id="4-4-1-Loader">4.4.1 Loader</h3>
<blockquote>
<p>è‰¿è‰¿ï¼šé«˜èƒ½é¢„è­¦ï¼Œå…³äºè¿™ä¸€å—ï¼Œå†…å®¹ä¼šæ¯”è¾ƒæ‰å®ï¼ˆå¾ˆå¤šï¼‰ï¼</p>
</blockquote>
<p>Loader æ˜¯ ConfigFileApplicationListener çš„å†…éƒ¨ç±»ï¼Œè´Ÿè´£åŠ è½½æŒ‡å®šçš„é…ç½®æ–‡ä»¶ã€‚æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener.java</span></span><br /><br /><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Loader</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Log logger = ConfigFileApplicationListener.<span class="keyword">this</span>.logger;</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConfigurableEnvironment environment;</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PropertySourcesPlaceholdersResolver placeholdersResolver;</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ResourceLoader resourceLoader;</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;PropertySourceLoader&gt; propertySourceLoaders;</span><br /><br /><span class="line">    <span class="keyword">private</span> Deque&lt;Profile&gt; profiles;</span><br /><br /><span class="line">    <span class="keyword">private</span> List&lt;Profile&gt; processedProfiles;</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> activatedProfiles;</span><br /><br /><span class="line">    <span class="keyword">private</span> Map&lt;Profile, MutablePropertySources&gt; loaded;</span><br /><br /><span class="line">    <span class="keyword">private</span> Map&lt;DocumentsCacheKey, List&lt;Document&gt;&gt; loadDocumentsCache = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br /><br /><span class="line">    Loader(ConfigurableEnvironment environment, ResourceLoader resourceLoader) {</span><br /><span class="line">        <span class="keyword">this</span>.environment = environment;</span><br /><span class="line">        <span class="comment">// &lt;1&gt; åˆ›å»º PropertySourcesPlaceholdersResolver å¯¹è±¡</span></span><br /><span class="line">        <span class="keyword">this</span>.placeholdersResolver = <span class="keyword">new</span> PropertySourcesPlaceholdersResolver(<span class="keyword">this</span>.environment);</span><br /><span class="line">        <span class="comment">// &lt;2&gt; åˆ›å»º DefaultResourceLoader å¯¹è±¡</span></span><br /><span class="line">        <span class="keyword">this</span>.resourceLoader = (resourceLoader != <span class="keyword">null</span>) ? resourceLoader : <span class="keyword">new</span> DefaultResourceLoader();</span><br /><span class="line">        <span class="comment">// &lt;3&gt; åŠ è½½æŒ‡å®šç±»å‹ PropertySourceLoader å¯¹åº”çš„ï¼Œåœ¨ `META-INF/spring.factories` é‡Œçš„ç±»åçš„æ•°ç»„</span></span><br /><span class="line">        <span class="keyword">this</span>.propertySourceLoaders = SpringFactoriesLoader.loadFactories(PropertySourceLoader.class, getClass().getClassLoader());</span><br /><span class="line">    }</span><br />    <br /><span class="line">    <span class="comment">// ... çœç•¥å…¶å®ƒæ–¹æ³•</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œåˆ›å»º PropertySourcesPlaceholdersResolver å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œèƒ–å‹å¯ä»¥è·³åˆ°&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ6. PropertySourcesPlaceholdersResolverã€</a>&nbsp;ä¸­ï¼Œç…ä¸€çœ¼ï¼Œç„¶åç»§ç»­å›åˆ°æ­¤å¤„ã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œåˆ›å»º DefaultResourceLoader å¯¹è±¡ã€‚è¿™ä¸ªæ˜¯ Spring Framework ä¸­çš„ç±»ï¼Œç”¨äºèµ„æºçš„åŠ è½½ã€‚å½“ç„¶ï¼Œè¿™ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œæš‚æ—¶å…ˆå¿½ç•¥ã€‚</li>
<li><code>&lt;3&gt;</code>&nbsp;å¤„ï¼ŒåŠ è½½æŒ‡å®šç±»å‹ PropertySourceLoader å¯¹åº”çš„ï¼Œåœ¨&nbsp;<code>META-INF/spring.factories</code>&nbsp;é‡Œçš„ç±»åçš„æ•°ç»„ã€‚
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿”å›çš„æ˜¯ PropertiesPropertySourceLoaderã€YamlPropertySourceLoader ç±»ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ7. PropertySourceLoaderã€</a>&nbsp;ã€‚</li>
</ul>
</li>
</ul>
<h4 id="4-4-1-1-load">4.4.1.1 load</h4>
<p><code>#load()</code>&nbsp;æ–¹æ³•ï¼ŒåŠ è½½é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; åˆå§‹åŒ–å˜é‡</span></span><br /><span class="line">    <span class="keyword">this</span>.profiles = <span class="keyword">new</span> LinkedList&lt;&gt;(); <span class="comment">// æœªå¤„ç†çš„ Profile é›†åˆ</span></span><br /><span class="line">    <span class="keyword">this</span>.processedProfiles = <span class="keyword">new</span> LinkedList&lt;&gt;(); <span class="comment">// å·²å¤„ç†çš„ Profile é›†åˆ</span></span><br /><span class="line">    <span class="keyword">this</span>.activatedProfiles = <span class="keyword">false</span>;</span><br /><span class="line">    <span class="keyword">this</span>.loaded = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br /><span class="line">    <span class="comment">// &lt;2&gt; åˆå§‹åŒ– Spring Profiles ç›¸å…³</span></span><br /><span class="line">    initializeProfiles();</span><br /><span class="line">    <span class="comment">// &lt;3&gt; éå† profiles æ•°ç»„</span></span><br /><span class="line">    <span class="keyword">while</span> (!<span class="keyword">this</span>.profiles.isEmpty()) {</span><br /><span class="line">        <span class="comment">// è·å¾— Profile å¯¹è±¡</span></span><br /><span class="line">        Profile profile = <span class="keyword">this</span>.profiles.poll();</span><br /><span class="line">        <span class="comment">// &lt;3.1&gt; æ·»åŠ  Profile åˆ° environment ä¸­</span></span><br /><span class="line">        <span class="keyword">if</span> (profile != <span class="keyword">null</span> &amp;&amp; !profile.isDefaultProfile()) {</span><br /><span class="line">            addProfileToEnvironment(profile.getName());</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// &lt;3.2&gt; åŠ è½½é…ç½®</span></span><br /><span class="line">        load(profile, <span class="keyword">this</span>::getPositiveProfileFilter,</span><br /><span class="line">                addToLoaded(MutablePropertySources::addLast, <span class="keyword">false</span>));</span><br /><span class="line">        <span class="comment">// &lt;3.3&gt; æ·»åŠ åˆ° processedProfiles ä¸­ï¼Œè¡¨ç¤ºå·²å¤„ç†</span></span><br /><span class="line">        <span class="keyword">this</span>.processedProfiles.add(profile);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// &lt;4&gt; è·å¾—çœŸæ­£åŠ è½½çš„ Profile ä»¬ï¼Œæ·»åŠ åˆ° environment ä¸­ã€‚</span></span><br /><span class="line">    resetEnvironmentProfiles(<span class="keyword">this</span>.processedProfiles);</span><br /><span class="line">    <span class="comment">// &lt;5&gt; åŠ è½½é…ç½®</span></span><br /><span class="line">    load(<span class="keyword">null</span>, <span class="keyword">this</span>::getNegativeProfileFilter,</span><br /><span class="line">            addToLoaded(MutablePropertySources::addFirst, <span class="keyword">true</span>));</span><br /><span class="line">    <span class="comment">// &lt;6&gt; å°†åŠ è½½çš„é…ç½®å¯¹åº”çš„ MutablePropertySources åˆ° environment ä¸­</span></span><br /><span class="line">    addLoadedPropertySources();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œåˆå§‹åŒ–å˜é‡ã€‚æ¯ä¸ªå˜é‡çš„æ„æ€ï¼Œçœ‹ä»£ç ä¸­çš„æ³¨é‡Šã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œåˆå§‹åŒ– Spring Profiles ç›¸å…³ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.4.1.1 initializeProfilesã€</a>&nbsp;ä¸­ã€‚èƒ–å‹å¯ä»¥å…ˆè·³è¿‡å»çœ‹ä¸€çœ¼ï¼Œç„¶åå›æ¥ã€‚</li>
<li>
<p><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œéå†&nbsp;<code>profiles</code>&nbsp;æ•°ç»„ï¼Œé€ä¸ªåŠ è½½å¯¹åº”çš„é…ç½®æ–‡ä»¶ã€‚</p>
<ul>
<li>
<p><code>&lt;3.1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#addProfileToEnvironment(String profile)</code>&nbsp;æ–¹æ³•ï¼Œæ·»åŠ åˆ°&nbsp;<code>environment.activeProfiles</code>&nbsp;ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addProfileToEnvironment</span><span class="params">(String profile)</span> </span>{</span><br /><span class="line">    <span class="comment">// å¦‚æœå·²ç»åœ¨ activeProfiles ä¸­ï¼Œåˆ™è¿”å›</span></span><br /><span class="line">    <span class="keyword">for</span> (String activeProfile : <span class="keyword">this</span>.environment.getActiveProfiles()) {</span><br /><span class="line">        <span class="keyword">if</span> (activeProfile.equals(profile)) {</span><br /><span class="line">            <span class="keyword">return</span>;</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// å¦‚æœä¸åœ¨ï¼Œåˆ™æ·»åŠ åˆ° environment ä¸­</span></span><br /><span class="line">    <span class="keyword">this</span>.environment.addActiveProfile(profile);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>~</li>
</ul>
</li>
<li>
<p><code>&lt;3.2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#load(Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)</code>&nbsp;æ–¹æ³•ï¼ŒåŠ è½½é…ç½®ã€‚è¿™å—ä¼šæ¯”è¾ƒå¤æ‚ï¼Œæ™šç‚¹å†æ±‚çœ‹&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.4.1.1.2 loadã€</a>&nbsp;ã€‚</p>
</li>
<li><code>&lt;3.3&gt;</code>&nbsp;å¤„ï¼Œæ·»åŠ åˆ°&nbsp;<code>processedProfiles</code>&nbsp;ä¸­ï¼Œè¡¨ç¤ºå·²å¤„ç†ã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;4&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#resetEnvironmentProfiles(List&lt;Profile&gt; processedProfiles)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—çœŸæ­£åŠ è½½çš„ Profile ä»¬ï¼Œæ·»åŠ åˆ° environment ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resetEnvironmentProfiles</span><span class="params">(List&lt;Profile&gt; processedProfiles)</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾—çœŸæ­£åŠ è½½çš„ Profile ä»¬ï¼Œæ·»åŠ åˆ° environment ä¸­ã€‚</span></span><br /><span class="line">    String[] names = processedProfiles.stream()</span><br /><span class="line">            .filter((profile) -&gt; profile != <span class="keyword">null</span> &amp;&amp; !profile.isDefaultProfile())</span><br /><span class="line">            .map(Profile::getName).toArray(String[]::<span class="keyword">new</span>);</span><br /><span class="line">    <span class="keyword">this</span>.environment.setActiveProfiles(names);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å› ä¸ºæ¯ä¸ª Profile å¯èƒ½ä¸å­˜åœ¨å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œåªæœ‰çœŸæ­£åŠ è½½åˆ°é…ç½®æ–‡ä»¶çš„ Profile ä»¬ï¼Œæ‰ä¼šè®¾ç½®åˆ°&nbsp;<code>environment.activeProfiles</code>&nbsp;å±æ€§ä¸­ã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;5&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#load(Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)</code>&nbsp;æ–¹æ³•ï¼ŒåŠ è½½é…ç½®ã€‚è¿™å—ä¼šæ¯”è¾ƒå¤æ‚ï¼Œæ™šç‚¹å†æ±‚çœ‹&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.4.1.1.2 loadã€</a>&nbsp;ã€‚</p>
<ul>
<li>å’Œ&nbsp;<code>&lt;3.2&gt;</code>&nbsp;å¤„ï¼Œæœ‰ä¸€äº›ä¸åŒï¼Œä¸»è¦å·®åˆ«åœ¨äºä¼ å…¥çš„æ–¹æ³•å‚æ•°ã€‚</li>
<li>åœ¨è¡¥å……ä¸€ç‚¹ï¼Œæœ‰ç‚¹ä¸é€ æ€ä¹ˆè§£é‡Šäº†ã€‚ğŸ˜ˆ&nbsp;<code>&lt;5&gt;</code>&nbsp;å¤„çš„ä½œç”¨æ˜¯ï¼Œå°†&nbsp;<code>profile=null</code>&nbsp;çš„æƒ…å†µä¸­ï¼Œå°†é…ç½®æ–‡ä»¶é‡Œæœ‰é…ç½®æ–‡ä»¶<code>spring.profiles</code>&nbsp;å†…å®¹ï¼Œä¸”å±äºåŸºäºçš„ Profile ï¼Œä¹Ÿæ·»åŠ åˆ°&nbsp;<code>profile=null</code>&nbsp;åœ¨&nbsp;<code>Loader.loaded</code>&nbsp;çš„æ˜ å°„ä¸­ã€‚å…·ä½“çš„ï¼Œå¯ä»¥çœ‹&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ666. å½©è›‹ã€</a>&nbsp;æä¾›çš„ç¤ºä¾‹ã€‚ğŸ˜ˆ çœŸçš„æ˜¯ï¼Œå¥½ç»•å•Šï¼ï¼ï¼ï¼</li>
</ul>
</li>
<li>
<p><code>&lt;6&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#addLoadedPropertySources()</code>&nbsp;æ–¹æ³•ï¼Œå°†åŠ è½½çš„é…ç½®å¯¹åº”çš„ MutablePropertySources åˆ°&nbsp;<code>environment</code>&nbsp;ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener.java</span></span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_PROPERTIES = <span class="string">"defaultProperties"</span>;</span><br /><br /><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addLoadedPropertySources</span><span class="params">()</span> </span>{</span><br /><span class="line">    MutablePropertySources destination = <span class="keyword">this</span>.environment.getPropertySources();</span><br /><span class="line">    <span class="comment">// è·å¾—å½“å‰åŠ è½½çš„ MutablePropertySources é›†åˆ</span></span><br /><span class="line">    List&lt;MutablePropertySources&gt; loaded = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="keyword">this</span>.loaded.values());</span><br /><span class="line">    Collections.reverse(loaded); <span class="comment">// &lt;Z&gt;</span></span><br /><span class="line">    <span class="comment">// å£°æ˜å˜é‡</span></span><br /><span class="line">    String lastAdded = <span class="keyword">null</span>; <span class="comment">// ä¸‹é¢å¾ªç¯ï¼Œæœ€åæ‰¾åˆ°çš„ MutablePropertySources çš„åå­—</span></span><br /><span class="line">    Set&lt;String&gt; added = <span class="keyword">new</span> HashSet&lt;&gt;(); <span class="comment">// å·²æ·»åŠ åˆ° destination ä¸­çš„ MutablePropertySources çš„åå­—çš„é›†åˆ</span></span><br /><span class="line">    <span class="comment">// &lt;X&gt; éå† loaded æ•°ç»„</span></span><br /><span class="line">    <span class="keyword">for</span> (MutablePropertySources sources : loaded) {</span><br /><span class="line">        <span class="comment">// &lt;Y&gt; éå† sources æ•°ç»„</span></span><br /><span class="line">        <span class="keyword">for</span> (PropertySource&lt;?&gt; source : sources) {</span><br /><span class="line">            <span class="comment">// æ·»åŠ åˆ° destination ä¸­</span></span><br /><span class="line">            <span class="keyword">if</span> (added.add(source.getName())) {</span><br /><span class="line">                addLoadedPropertySource(destination, lastAdded, source);</span><br /><span class="line">                lastAdded = source.getName();</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addLoadedPropertySource</span><span class="params">(MutablePropertySources destination, String lastAdded, PropertySource&lt;?&gt; source)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (lastAdded == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">if</span> (destination.contains(DEFAULT_PROPERTIES)) {</span><br /><span class="line">            destination.addBefore(DEFAULT_PROPERTIES, source);</span><br /><span class="line">        } <span class="keyword">else</span> {</span><br /><span class="line">            destination.addLast(source);</span><br /><span class="line">        }</span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        destination.addAfter(lastAdded, source);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;X&gt;</code>&nbsp;å’Œ&nbsp;<code>&lt;Y&gt;</code>&nbsp;å¤„ï¼Œä¸ºä»€ä¹ˆæ˜¯ä¸¤å±‚éå†å‘¢ï¼Ÿå› ä¸ºä¸€ä¸ª Profile å¯ä»¥å¯¹åº”å¤šä¸ªé…ç½®æ–‡ä»¶ã€‚ä¾‹å¦‚è¯´ï¼ŒProfile ä¸º&nbsp;<code>prod</code>&nbsp;ï¼Œå¯¹åº”&nbsp;<code>applicaion-prod.properties</code>&nbsp;å’Œ&nbsp;<code>application-prod.yml</code>&nbsp;ä¸¤ä¸ªé…ç½®æ–‡ä»¶ã€‚</li>
<li>è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»&nbsp;<code>environment</code>&nbsp;ä¸­ï¼Œè¯»å–åŠ è½½åˆ°çš„é…ç½®æ–‡ä»¶ã€‚</li>
<li><code>&lt;Z&gt;</code>&nbsp;å¤„ï¼Œä¸ºä»€ä¹ˆè¦åè½¬ä¸€ä¸‹å‘¢ï¼Ÿå› ä¸ºï¼Œé…ç½®åœ¨è¶Šåé¢çš„ Profile ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œåè½¬ã€‚ä¸¾ä¸ªä¾‹å­&nbsp;<code>spring.profiles.active=prod,dev</code>&nbsp;ï¼Œé‚£ä¹ˆ Profile çš„ä¼˜å…ˆçº§æ˜¯&nbsp;<code>dev &gt; prod &gt; null</code>&nbsp;ã€‚</li>
</ul>
</li>
</ul>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·³åˆ°&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.4.1.1.2 loadã€</a>&nbsp;å°èŠ‚ï¼Œçœ‹çœ‹è¿™ä¸ªå…³é”®çš„é€»è¾‘ã€‚</p>
<blockquote>
<p>è‰¿è‰¿ï¼šé€»è¾‘çœŸçš„æœ‰ç‚¹å¤æ‚ï¼ç›®çš„ç®€å•ï¼Œè¿‡ç¨‹ä¸­çš„é€»è¾‘ç»†èŠ‚æ¯”è¾ƒå¤šã€‚å’Œæˆ‘ä¸€èµ·ï¼Œä¿æŒè€å¿ƒï¼ï¼ï¼</p>
</blockquote>
<h5 id="4-4-1-1-1-initializeProfiles">4.4.1.1.1 initializeProfiles</h5>
<p>åœ¨&nbsp;<code>#initializeProfiles()</code>&nbsp;æ–¹æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ Profile ç±»ã€‚å®ƒæ˜¯ ConfigFileApplicationListener çš„å†…éƒ¨ç±»ï¼Œæ˜¯ Spring Profiles çš„å°è£…å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Profile.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * A Spring Profile that can be loaded.</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Profile</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Profile åå­—</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ˜¯å¦ä¸ºé»˜è®¤çš„ Profile</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> defaultProfile;</span><br /><br /><span class="line">    <span class="comment">// ... çœç•¥æ„é€ æ–¹æ³•ã€getting æ–¹æ³•ã€toString å’Œ hashCode æ–¹æ³•</span></span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>ç„¶åï¼Œç»§ç»­æ¥çœ‹&nbsp;<code>#initializeProfiles()</code>&nbsp;æ–¹æ³•ï¼Œåˆå§‹åŒ– Spring Profiles ç›¸å…³ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initializeProfiles</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// The default profile for these purposes is represented as null. We add it</span></span><br /><span class="line">    <span class="comment">// first so that it is processed first and has lowest priority.</span></span><br /><span class="line">    <span class="comment">// &lt;1&gt; æ·»åŠ  null åˆ° profiles ä¸­ã€‚ç”¨äºåŠ è½½é»˜è®¤çš„é…ç½®æ–‡ä»¶ã€‚ä¼˜å…ˆæ·»åŠ åˆ° profiles ä¸­ï¼Œå› ä¸ºå¸Œæœ›é»˜è®¤çš„é…ç½®æ–‡ä»¶å…ˆè¢«å¤„ç†ã€‚</span></span><br /><span class="line">    <span class="keyword">this</span>.profiles.add(<span class="keyword">null</span>);</span><br /><span class="line">    <span class="comment">// &lt;2.1&gt; è·å¾—æ¿€æ´»çš„ Profile ä»¬ï¼ˆä»é…ç½®ä¸­ï¼‰</span></span><br /><span class="line">    Set&lt;Profile&gt; activatedViaProperty = getProfilesActivatedViaProperty();</span><br /><span class="line">    <span class="comment">// &lt;2.2&gt; å…ˆæ·»åŠ æ¿€æ´»çš„ Profile ä»¬ï¼ˆä¸åœ¨é…ç½®ä¸­ï¼‰</span></span><br /><span class="line">    <span class="keyword">this</span>.profiles.addAll(getOtherActiveProfiles(activatedViaProperty));</span><br /><span class="line">    <span class="comment">// Any pre-existing active profiles set via property sources (e.g.</span></span><br /><span class="line">    <span class="comment">// System properties) take precedence over those added in config files.</span></span><br /><span class="line">    <span class="comment">// &lt;2.3&gt; å†æ·»åŠ æ¿€æ´»çš„ Profile ä»¬ï¼ˆåœ¨é…ç½®ä¸­ï¼‰</span></span><br /><span class="line">    addActiveProfiles(activatedViaProperty);</span><br /><span class="line">    <span class="comment">// &lt;3&gt; å¦‚æœæ²¡æœ‰æ¿€æ´»çš„ Profile ä»¬ï¼Œåˆ™æ·»åŠ é»˜è®¤çš„ Profile</span></span><br /><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.profiles.size() == <span class="number">1</span>) { <span class="comment">// only has null profile</span></span><br /><span class="line">        <span class="keyword">for</span> (String defaultProfileName : <span class="keyword">this</span>.environment.getDefaultProfiles()) {</span><br /><span class="line">            Profile defaultProfile = <span class="keyword">new</span> Profile(defaultProfileName, <span class="keyword">true</span>);</span><br /><span class="line">            <span class="keyword">this</span>.profiles.add(defaultProfile);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œæ·»åŠ &nbsp;<code>null</code>&nbsp;åˆ°&nbsp;<code>profiles</code>&nbsp;ä¸­ã€‚ç”¨äºåŠ è½½é»˜è®¤çš„é…ç½®æ–‡ä»¶ã€‚ä¼˜å…ˆæ·»åŠ åˆ°&nbsp;<code>profiles</code>&nbsp;ä¸­ï¼Œå› ä¸ºå¸Œæœ›é»˜è®¤çš„é…ç½®æ–‡ä»¶å…ˆè¢«å¤„ç†ã€‚</li>
<li>
<p><code>&lt;2.1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#getProfilesActivatedViaProperty()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æ¿€æ´»çš„ Profile ä»¬ï¼ˆä»é…ç½®ä¸­ï¼‰ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Set&lt;Profile&gt; <span class="title">getProfilesActivatedViaProperty</span><span class="params">()</span> </span>{</span><br /><span class="line">	<span class="keyword">if</span> (!<span class="keyword">this</span>.environment.containsProperty(ACTIVE_PROFILES_PROPERTY)</span><br /><span class="line">			&amp;&amp; !<span class="keyword">this</span>.environment.containsProperty(INCLUDE_PROFILES_PROPERTY)) {</span><br /><span class="line">		<span class="keyword">return</span> Collections.emptySet();</span><br /><span class="line">	}</span><br /><span class="line">	Binder binder = Binder.get(<span class="keyword">this</span>.environment);</span><br /><span class="line">	Set&lt;Profile&gt; activeProfiles = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br /><span class="line">	activeProfiles.addAll(getProfiles(binder, INCLUDE_PROFILES_PROPERTY)); <span class="comment">// spring.profiles.include</span></span><br /><span class="line">	activeProfiles.addAll(getProfiles(binder, ACTIVE_PROFILES_PROPERTY)); <span class="comment">// spring.profiles.active</span></span><br /><span class="line">	<span class="keyword">return</span> activeProfiles;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è¯»å–&nbsp;<code>"spring.profiles.include"</code>&nbsp;å’Œ&nbsp;<code>"spring.profiles.active"</code>&nbsp;å¯¹åº”çš„ Profile ä»¬ã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;2.2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#getOtherActiveProfiles(Set&lt;Profile&gt; activatedViaProperty)</code>&nbsp;æ–¹æ³•ï¼Œå…ˆæ·»åŠ æ¿€æ´»çš„ Profile ä»¬ï¼ˆ<strong>ä¸åœ¨é…ç½®ä¸­</strong>ï¼‰åˆ°&nbsp;<code>profiles</code>&nbsp;ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> List&lt;Profile&gt; <span class="title">getOtherActiveProfiles</span><span class="params">(Set&lt;Profile&gt; activatedViaProperty)</span> </span>{</span><br /><span class="line">	<span class="keyword">return</span> Arrays.stream(<span class="keyword">this</span>.environment.getActiveProfiles()).map(Profile::<span class="keyword">new</span>)</span><br /><span class="line">			.filter((profile) -&gt; !activatedViaProperty.contains(profile))</span><br /><span class="line">			.collect(Collectors.toList());</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>&ldquo;<strong>ä¸åœ¨é…ç½®ä¸­</strong>&rdquo;ï¼Œä¾‹å¦‚è¯´ï¼š<code>SpringApplication.additionalProfiles</code>&nbsp;ã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;2.3&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#addActiveProfiles(Set&lt;Profile&gt; profiles)</code>&nbsp;æ–¹æ³•ï¼Œå†æ·»åŠ æ¿€æ´»çš„ Profile ä»¬ï¼ˆåœ¨é…ç½®ä¸­ï¼‰åˆ°&nbsp;<code>profiles</code>&nbsp;ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addActiveProfiles</span><span class="params">(Set&lt;Profile&gt; profiles)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (profiles.isEmpty()) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// å¦‚æœå·²ç»æ ‡è®° activatedProfiles ä¸º true ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br /><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.activatedProfiles) {</span><br /><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) {</span><br /><span class="line">            <span class="keyword">this</span>.logger.debug(<span class="string">"Profiles already activated, '"</span> + profiles + <span class="string">"' will not be applied"</span>);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// æ·»åŠ åˆ° profiles ä¸­</span></span><br /><span class="line">    <span class="keyword">this</span>.profiles.addAll(profiles);</span><br /><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) {</span><br /><span class="line">        <span class="keyword">this</span>.logger.debug(<span class="string">"Activated activeProfiles "</span> + StringUtils.collectionToCommaDelimitedString(profiles));</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// æ ‡è®° activatedProfiles ä¸º true ã€‚</span></span><br /><span class="line">    <span class="keyword">this</span>.activatedProfiles = <span class="keyword">true</span>;</span><br /><span class="line">    <span class="comment">// ç§»é™¤ profiles ä¸­ï¼Œé»˜è®¤çš„é…ç½®ä»¬ã€‚</span></span><br /><span class="line">    removeUnprocessedDefaultProfiles();</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeUnprocessedDefaultProfiles</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.profiles.removeIf(</span><br /><span class="line">            (profile) -&gt; (profile != <span class="keyword">null</span> &amp;&amp; profile.isDefaultProfile()));</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œå¦‚æœæ²¡æœ‰æ¿€æ´»çš„ Profile ä»¬ï¼Œåˆ™æ·»åŠ é»˜è®¤çš„ Profile ã€‚æ­¤å¤„çš„&ldquo;é»˜è®¤&rdquo;æ˜¯ï¼ŒæŒ‡çš„æ˜¯é…ç½®æ–‡ä»¶ä¸­çš„&nbsp;<code>"spring.profiles.default"</code>&nbsp;å¯¹åº”çš„å€¼ã€‚</p>
</li>
<li>è¿™å—æ¯”è¾ƒç»•ï¼Œèƒ–å‹æœ€å¥½è‡ªå·±è°ƒè¯•ä¸‹ã€‚ä¾‹å¦‚è¯´ï¼Œæˆ‘ä»¬åœ¨ JVM å¯åŠ¨å¢åŠ &nbsp;<code>--spring.profiles.active=prod</code>&nbsp;ï¼Œåˆ™ç»“æœå¦‚ä¸‹å›¾ï¼š<img src="http://static2.iocoder.cn/images/Spring-Boot/2021-01-28/02.jpg" alt="&#96;profiles&#96;" /></li>
</ul>
<h5 id="4-4-1-1-2-load">4.4.1.1.2 load</h5>
<p><code>#load(Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)</code>&nbsp;æ–¹æ³•ï¼ŒåŠ è½½æŒ‡å®š Profile çš„é…ç½®æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">(Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; è·å¾—è¦æ£€ç´¢é…ç½®çš„è·¯å¾„</span></span><br /><span class="line">    getSearchLocations().forEach((location) -&gt; {</span><br /><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºæ–‡ä»¶å¤¹</span></span><br /><span class="line">        <span class="keyword">boolean</span> isFolder = location.endsWith(<span class="string">"/"</span>);</span><br /><span class="line">        <span class="comment">// &lt;2&gt; è·å¾—è¦æ£€ç´¢é…ç½®çš„æ–‡ä»¶åé›†åˆ</span></span><br /><span class="line">        Set&lt;String&gt; names = isFolder ? getSearchNames() : NO_SEARCH_NAMES;</span><br /><span class="line">        <span class="comment">// &lt;3&gt; éå†æ–‡ä»¶åé›†åˆï¼Œé€ä¸ªåŠ è½½é…ç½®æ–‡ä»¶</span></span><br /><span class="line">        names.forEach(</span><br /><span class="line">                (name) -&gt; load(location, name, profile, filterFactory, consumer));</span><br /><span class="line">    });</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#getSearchLocations()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—è¦æ£€ç´¢é…ç½®çš„è·¯å¾„ä»¬ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener.java</span></span><br /><br /><span class="line"><span class="comment">// Note the order is from least to most specific (last one wins)</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SEARCH_LOCATIONS = <span class="string">"classpath:/,classpath:/config/,file:./,file:./config/"</span>;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * The "config location" property name.</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONFIG_LOCATION_PROPERTY = <span class="string">"spring.config.location"</span>;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * The "config additional location" property name.</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONFIG_ADDITIONAL_LOCATION_PROPERTY = <span class="string">"spring.config.additional-location"</span>;</span><br /><br /><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Set&lt;String&gt; <span class="title">getSearchLocations</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾— `"spring.config.location"` å¯¹åº”çš„é…ç½®çš„å€¼</span></span><br /><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.environment.containsProperty(CONFIG_LOCATION_PROPERTY)) {</span><br /><span class="line">        <span class="keyword">return</span> getSearchLocations(CONFIG_LOCATION_PROPERTY);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è·å¾— `"spring.config.additional-location"` å¯¹åº”çš„é…ç½®çš„å€¼</span></span><br /><span class="line">    Set&lt;String&gt; locations = getSearchLocations(CONFIG_ADDITIONAL_LOCATION_PROPERTY);</span><br /><span class="line">    <span class="comment">// æ·»åŠ  searchLocations åˆ° locations ä¸­</span></span><br /><span class="line">    locations.addAll(asResolvedSet(ConfigFileApplicationListener.<span class="keyword">this</span>.searchLocations, DEFAULT_SEARCH_LOCATIONS));</span><br /><span class="line">    <span class="keyword">return</span> locations;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Set&lt;String&gt; <span class="title">getSearchLocations</span><span class="params">(String propertyName)</span> </span>{</span><br /><span class="line">    Set&lt;String&gt; locations = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br /><span class="line">    <span class="comment">// å¦‚æœ environment ä¸­å­˜åœ¨ propertyName å¯¹åº”çš„å€¼</span></span><br /><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.environment.containsProperty(propertyName)) {</span><br /><span class="line">        <span class="comment">// è¯»å–å±æ€§å€¼ï¼Œè¿›è¡Œåˆ†å‰²åï¼Œç„¶åéå†</span></span><br /><span class="line">        <span class="keyword">for</span> (String path : asResolvedSet(<span class="keyword">this</span>.environment.getProperty(propertyName), <span class="keyword">null</span>)) {</span><br /><span class="line">            <span class="comment">// å¤„ç† path</span></span><br /><span class="line">            <span class="keyword">if</span> (!path.contains(<span class="string">"$"</span>)) {</span><br /><span class="line">                path = StringUtils.cleanPath(path);</span><br /><span class="line">                <span class="keyword">if</span> (!ResourceUtils.isUrl(path)) {</span><br /><span class="line">                    path = ResourceUtils.FILE_URL_PREFIX + path;</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">            <span class="comment">// æ·»åŠ åˆ° path ä¸­</span></span><br /><span class="line">            locations.add(path);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> locations;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">// ä¼˜å…ˆä½¿ç”¨ value ã€‚å¦‚æœ value ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨ fallback</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> Set&lt;String&gt; <span class="title">asResolvedSet</span><span class="params">(String value, String fallback)</span> </span>{</span><br /><span class="line">    List&lt;String&gt; list = Arrays.asList(StringUtils.trimArrayElements(</span><br /><span class="line">            StringUtils.commaDelimitedListToStringArray((value != <span class="keyword">null</span>)</span><br /><span class="line">                    ? <span class="keyword">this</span>.environment.resolvePlaceholders(value) : fallback)));</span><br /><span class="line">    Collections.reverse(list);</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LinkedHashSet&lt;&gt;(list);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>çœ‹ä¼¼æ¯”è¾ƒé•¿ï¼Œé€»è¾‘å¹¶ä¸å¤æ‚ã€‚</li>
<li>å¦‚æœé…ç½®äº†&nbsp;<code>"spring.config.location"</code>&nbsp;ï¼Œåˆ™ä½¿ç”¨å®ƒçš„å€¼ï¼Œä½œä¸ºè¦æ£€ç´¢é…ç½®çš„è·¯å¾„ã€‚</li>
<li>å¦‚æœé…ç½®äº†&nbsp;<code>"spring.config.additional-location"</code>&nbsp;ï¼Œåˆ™ä½¿ç”¨å®ƒä½œä¸º<strong>é™„åŠ </strong>è¦æ£€ç´¢é…ç½®çš„è·¯å¾„ã€‚å½“ç„¶ï¼Œè¿˜æ˜¯ä¼šæ·»åŠ é»˜è®¤çš„&nbsp;<code>DEFAULT_SEARCH_LOCATIONS</code>&nbsp;è·¯å¾„ã€‚</li>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿”å›çš„å€¼æ˜¯&nbsp;<code>DEFAULT_SEARCH_LOCATIONS</code>&nbsp;ã€‚å› ä¸ºï¼Œç»å¤§æ•°æƒ…å†µï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šåšç›¸åº”çš„é…ç½®ã€‚ğŸ˜ˆ æ‰€ä»¥ï¼Œèƒ–å‹å¦‚æœæ‡’çš„çœ‹é€»è¾‘ï¼Œå°±è®°å¾—è¿™ä¸ªç»“è®ºå°±å¯ä»¥äº†ã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#getSearchNames()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—è¦æ£€ç´¢é…ç½®çš„æ–‡ä»¶åé›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener.java</span></span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_NAMES = <span class="string">"application"</span>;</span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;String&gt; NO_SEARCH_NAMES = Collections.singleton(<span class="keyword">null</span>);</span><br /><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONFIG_NAME_PROPERTY = <span class="string">"spring.config.name"</span>;</span><br /><br /><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Set&lt;String&gt; <span class="title">getSearchNames</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾— `"spring.config.name"` å¯¹åº”çš„é…ç½®çš„å€¼</span></span><br /><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.environment.containsProperty(CONFIG_NAME_PROPERTY)) {</span><br /><span class="line">        String property = <span class="keyword">this</span>.environment.getProperty(CONFIG_NAME_PROPERTY);</span><br /><span class="line">        <span class="keyword">return</span> asResolvedSet(property, <span class="keyword">null</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// æ·»åŠ  names or DEFAULT_NAMES åˆ° locations ä¸­</span></span><br /><span class="line">    <span class="keyword">return</span> asResolvedSet(ConfigFileApplicationListener.<span class="keyword">this</span>.names, DEFAULT_NAMES);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>é€šè¿‡&nbsp;<code>DEFAULT_NAMES</code>&nbsp;é™æ€å±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œé»˜è®¤éƒ½å»çš„é…ç½®æ–‡ä»¶åï¼ˆä¸è€ƒè™‘åç¼€ï¼‰ä¸º&nbsp;<code>"application"</code>&nbsp;ã€‚</li>
<li>å‰©ä½™çš„é€»è¾‘ï¼Œèƒ–å‹ç®€å•çœ‹çœ‹å³å¯ã€‚</li>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿”å›çš„å€¼æ˜¯&nbsp;<code>DEFAULT_NAMES</code>&nbsp;ã€‚å› ä¸ºï¼Œç»å¤§æ•°æƒ…å†µï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šåšç›¸åº”çš„é…ç½®ã€‚ğŸ˜ˆ æ‰€ä»¥ï¼Œèƒ–å‹å¦‚æœæ‡’çš„çœ‹é€»è¾‘ï¼Œå°±è®°å¾—è¿™ä¸ªç»“è®ºå°±å¯ä»¥äº†ã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œéå†&nbsp;<code>names</code>&nbsp;æ•°ç»„ï¼Œé€ä¸ªè°ƒç”¨&nbsp;<code>#load(String location, String name, Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)</code>&nbsp;æ–¹æ³•ï¼Œé€ä¸ªåŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.4.1.1.3 loadã€</a>&nbsp;ã€‚</p>
</li>
</ul>
<h5 id="4-4-1-1-3-load">4.4.1.1.3 load</h5>
<p><code>#load(String location, String name, Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)</code>&nbsp;æ–¹æ³•ï¼Œé€ä¸ªåŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">(String location, String name, Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; è¿™å—é€»è¾‘å…ˆæ— è§†ï¼Œå› ä¸ºæˆ‘ä»¬ä¸ä¼šé…ç½® name ä¸ºç©ºã€‚</span></span><br /><span class="line">    <span class="comment">// é»˜è®¤æƒ…å†µä¸‹ï¼Œname ä¸º DEFAULT_NAMES=application</span></span><br /><span class="line">    <span class="keyword">if</span> (!StringUtils.hasText(name)) {</span><br /><span class="line">        <span class="keyword">for</span> (PropertySourceLoader loader : <span class="keyword">this</span>.propertySourceLoaders) {</span><br /><span class="line">            <span class="keyword">if</span> (canLoadFileExtension(loader, location)) {</span><br /><span class="line">                load(loader, location, profile, filterFactory.getDocumentFilter(profile), consumer);</span><br /><span class="line">                <span class="keyword">return</span>;</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    Set&lt;String&gt; processed = <span class="keyword">new</span> HashSet&lt;&gt;(); <span class="comment">// å·²å¤„ç†çš„æ–‡ä»¶åç¼€é›†åˆ</span></span><br /><span class="line">    <span class="comment">// &lt;2&gt; éå† propertySourceLoaders æ•°ç»„ï¼Œé€ä¸ªä½¿ç”¨ PropertySourceLoader è¯»å–é…ç½®</span></span><br /><span class="line">    <span class="keyword">for</span> (PropertySourceLoader loader : <span class="keyword">this</span>.propertySourceLoaders) {</span><br /><span class="line">        <span class="comment">// &lt;3&gt; éå†æ¯ä¸ª PropertySourceLoader å¯å¤„ç†çš„æ–‡ä»¶åç¼€é›†åˆ</span></span><br /><span class="line">        <span class="keyword">for</span> (String fileExtension : loader.getFileExtensions()) {</span><br /><span class="line">            <span class="comment">// &lt;4&gt; æ·»åŠ åˆ° processed ä¸­ï¼Œä¸€ä¸ªæ–‡ä»¶åç¼€ï¼Œæœ‰ä¸”ä»…èƒ½è¢«ä¸€ä¸ª PropertySourceLoader æ‰€å¤„ç†</span></span><br /><span class="line">            <span class="keyword">if</span> (processed.add(fileExtension)) {</span><br /><span class="line">                <span class="comment">// åŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰</span></span><br /><span class="line">                loadForFileExtension(loader, location + name, <span class="string">"."</span> + fileExtension,</span><br /><span class="line">                        profile, filterFactory, consumer);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„çš„é€»è¾‘ï¼Œå¯ä»¥æ— è§†ã€‚å…·ä½“çš„åŸå› ï¼Œè§æˆ‘æ·»åŠ çš„æ³¨é‡Šã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œéå†&nbsp;<code>propertySourceLoaders</code>&nbsp;æ•°ç»„ï¼Œé€ä¸ªä½¿ç”¨ PropertySourceLoader è¯»å–é…ç½®ã€‚</li>
<li><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œéå†æ¯ä¸ª PropertySourceLoader å¯å¤„ç†çš„æ–‡ä»¶åç¼€é›†åˆã€‚ä¾‹å¦‚è¯´ï¼ŒPropertiesPropertySourceLoader å¯å¤„ç†&nbsp;<code>.properties</code>&nbsp;å’Œ&nbsp;<code>.xml</code>&nbsp;åç¼€ï¼ŒYamlPropertySourceLoader å¯å¤„ç†&nbsp;<code>.yml</code>&nbsp;å’Œ&nbsp;<code>.yaml</code>&nbsp;åç½®ã€‚</li>
<li><code>&lt;4&gt;</code>&nbsp;å¤„ï¼Œæ·»åŠ åˆ°&nbsp;<code>processed</code>&nbsp;ä¸­ã€‚ä¸€ä¸ªæ–‡ä»¶åç¼€ï¼Œæœ‰ä¸”ä»…èƒ½è¢«ä¸€ä¸ª PropertySourceLoader æ‰€å¤„ç†ã€‚</li>
<li><code>&lt;5&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#loadForFileExtension(PropertySourceLoader loader, String prefix, String fileExtension, Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)</code>&nbsp;æ–¹æ³•ï¼ŒåŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.4.1.1.7 loadForFileExtensionã€</a>&nbsp;ã€‚</li>
</ul>
<h5 id="4-4-1-1-4-Document">4.4.1.1.4 Document</h5>
<blockquote>
<p>å› ä¸ºç¨ååœ¨è®²è§£&nbsp;<code>#loadForFileExtension(...)</code>&nbsp;æ–¹æ³•éœ€è¦ç”¨åˆ°ï¼Œæ‰€ä»¥æ’æ’­ä¸‹ã€‚</p>
</blockquote>
<p>Document ï¼Œæ˜¯ ConfigFileApplicationListener çš„å†…éƒ¨ç±»ï¼Œç”¨äºå°è£… PropertySourceLoader åŠ è½½é…ç½®æ–‡ä»¶åã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Document.java</span></span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Document</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PropertySource&lt;?&gt; propertySource;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * å¯¹åº” `spring.profiles` å±æ€§å€¼</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> String[] profiles;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * å¯¹åº” `spring.profiles.active` å±æ€§å€¼</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Profile&gt; activeProfiles;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * å¯¹åº” `spring.profiles.include` å±æ€§å€¼</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Profile&gt; includeProfiles;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h6 id="4-4-1-1-4-1-DocumentsCacheKey">4.4.1.1.4.1 DocumentsCacheKey</h6>
<p>DocumentsCacheKey ï¼Œæ˜¯ ConfigFileApplicationListener çš„å†…éƒ¨ç±»ï¼Œç”¨äºè¡¨ç¤ºåŠ è½½ Documents çš„ç¼“å­˜ KEY ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#DocumentsCacheKey.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Cache key used to save loading the same document multiple times.</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DocumentsCacheKey</span> </span>{</span><br /><br /><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> PropertySourceLoader loader;</span><br /><br /><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Resource resource;</span><br /><br /><span class="line">	DocumentsCacheKey(PropertySourceLoader loader, Resource resource) {</span><br /><span class="line">		<span class="keyword">this</span>.loader = loader;</span><br /><span class="line">		<span class="keyword">this</span>.resource = resource;</span><br /><span class="line">	}</span><br /><br /><span class="line">	<span class="meta">@Override</span></span><br /><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>{</span><br /><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span> == obj) {</span><br /><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br /><span class="line">		}</span><br /><span class="line">		<span class="keyword">if</span> (obj == <span class="keyword">null</span> || getClass() != obj.getClass()) {</span><br /><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">		}</span><br /><span class="line">		DocumentsCacheKey other = (DocumentsCacheKey) obj;</span><br /><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.loader.equals(other.loader)</span><br /><span class="line">				&amp;&amp; <span class="keyword">this</span>.resource.equals(other.resource);</span><br /><span class="line">	}</span><br /><br /><span class="line">	<span class="meta">@Override</span></span><br /><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>{</span><br /><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.loader.hashCode() * <span class="number">31</span> + <span class="keyword">this</span>.resource.hashCode();</span><br /><span class="line">	}</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å› ä¸ºä¸€ä¸ªé…ç½®æ–‡ä»¶åœ¨&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.4.1.1.7 loadForFileExtensionã€</a>&nbsp;æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°å¯èƒ½å­˜åœ¨é‡å¤åŠ è½½çš„æƒ…å†µï¼Œæ‰€ä»¥é€šè¿‡ç¼“å­˜ï¼Œé¿å…é‡æ–°è¯»å–~</li>
</ul>
<h5 id="4-4-1-1-5-DocumentFilterFactory">4.4.1.1.5 DocumentFilterFactory</h5>
<blockquote>
<p>å› ä¸ºç¨ååœ¨è®²è§£&nbsp;<code>#loadForFileExtension(...)</code>&nbsp;æ–¹æ³•éœ€è¦ç”¨åˆ°ï¼Œæ‰€ä»¥æ’æ’­ä¸‹ã€‚</p>
</blockquote>
<p>DocumentFilterFactory ï¼Œæ˜¯ ConfigFileApplicationListener çš„å†…éƒ¨æ¥å£ï¼Œç”¨äºåˆ›å»º DocumentFilter å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#DocumentFilterFactory.java</span></span><br /><br /><span class="line"><span class="meta">@FunctionalInterface</span></span><br /><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">interface</span> <span class="title">DocumentFilterFactory</span> </span>{</span><br /><br /><span class="line">	<span class="function">DocumentFilter <span class="title">getDocumentFilter</span><span class="params">(Profile profile)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.4.1.1 loadã€</a>&nbsp;ä¸­ï¼Œæˆ‘ä»¬åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œå·²ç»çœ‹åˆ°å®ƒçš„ä¸¤ä¸ªåŒ¿åå®ç°ç±»ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line">ç¬¬ä¸€ä¸ªï¼š<span class="keyword">this</span>::getPositiveProfileFilter</span><br /><span class="line">ç¬¬äºŒä¸ªï¼š<span class="keyword">this</span>::getNegativeProfileFilter</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å®ƒä»¬åˆ†åˆ«è°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï¼Œåˆ›å»º DocumentFilter å¯¹è±¡ã€‚</li>
</ul>
<h6 id="4-4-1-1-5-1-DocumentFilter">4.4.1.1.5.1 DocumentFilter</h6>
<p>DocumentFilter ï¼Œæ˜¯ ConfigFileApplicationListener çš„å†…éƒ¨æ¥å£ï¼Œç”¨äºåŒ¹é…é…ç½®åŠ è½½åçš„ Document å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#DocumentFilter.java</span></span><br /><br /><span class="line"><span class="meta">@FunctionalInterface</span></span><br /><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">interface</span> <span class="title">DocumentFilter</span> </span>{</span><br /><br /><span class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">match</span><span class="params">(Document document)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>åœ¨ä¸‹é¢çš„æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼ŒåŠ è½½çš„é…ç½®æ–‡ä»¶åï¼Œè¿”å›çš„æ˜¯ Document å¯¹è±¡ã€‚ä½†æ˜¯ï¼Œè¿”å›çš„ Document å¯¹è±¡ï¼Œéœ€è¦å’Œ Profile è¿›è¡ŒåŒ¹é…ã€‚</li>
</ul>
<h6 id="4-4-1-1-5-2-getPositiveProfileFilter">4.4.1.1.5.2 getPositiveProfileFilter</h6>
<p><code>#getPositiveProfileFilter(Profile profile)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> DocumentFilter <span class="title">getPositiveProfileFilter</span><span class="params">(Profile profile)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> (Document document) -&gt; {</span><br /><span class="line">        <span class="comment">// &lt;1&gt; å½“ profile ä¸ºç©ºæ—¶ï¼Œdocument.profiles ä¹Ÿè¦ä¸ºç©º</span></span><br /><span class="line">        <span class="keyword">if</span> (profile == <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="keyword">return</span> ObjectUtils.isEmpty(document.getProfiles());</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// &lt;2&gt; è¦æ±‚ document.profiles åŒ…å« profile</span></span><br /><span class="line">        <span class="comment">// å¹¶ä¸”ï¼Œenvironment.activeProfiles åŒ…å« document.profiles</span></span><br /><span class="line">        <span class="comment">// æ€»ç»“æ¥è¯´ï¼Œenvironment.activeProfiles åŒ…å« document.profiles åŒ…å« profile</span></span><br /><span class="line">        <span class="keyword">return</span> ObjectUtils.containsElement(document.getProfiles(), profile.getName())</span><br /><span class="line">                &amp;&amp; <span class="keyword">this</span>.environment.acceptsProfiles(Profiles.of(document.getProfiles()));</span><br /><span class="line">    };</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œå½“ä¼ å…¥çš„&nbsp;<code>profile</code>&nbsp;ä¸ºç©ºæ—¶ï¼Œè¦æ±‚&nbsp;<code>document.profiles</code>&nbsp;ä¹Ÿè¦ä¸ºç©ºã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œå½“ä¼ å…¥çš„&nbsp;<code>profile</code>&nbsp;éç©ºæ—¶ï¼Œè¦æ±‚&nbsp;<code>environment.activeProfiles</code>&nbsp;åŒ…å«&nbsp;<code>document.profiles</code>&nbsp;åŒ…å«&nbsp;<code>profile</code>&nbsp;ã€‚</li>
</ul>
<p>å¯èƒ½æ¯”è¾ƒç»•ï¼Œèƒ–å‹å…ˆçœ‹&nbsp;<a href="https://spldeolin.com/posts/spring-boot-active-profiles/" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠSpring-bootåŠ¨æ€profilesçš„å®è·µã€‹</a>&nbsp;æ–‡ç« çš„&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€ŒSpring Bootçš„Profileså±æ€§ã€</a>&nbsp;éƒ¨åˆ†ã€‚</p>
<ul>
<li>
<p>ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå‡è®¾ä¸€ä¸ª&nbsp;<code>application-prod.properties</code>&nbsp;çš„é…ç½®æ–‡ä»¶ï¼Œä¸€èˆ¬æˆ‘ä»¬çš„ç†è§£æ˜¯å¯¹åº” Profile ä¸º&nbsp;<code>prod</code>&nbsp;çš„æƒ…å†µï¼Œå¯¹å§ï¼Ÿï¼ä½†æ˜¯ï¼Œå¦‚æœè¯´æˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­å¢åŠ äº†&nbsp;<code>spring.profiles=dev</code>&nbsp;ï¼Œé‚£å®ƒå®é™…æ˜¯å±äº Profile ä¸º&nbsp;<code>dev</code>&nbsp;çš„æƒ…å†µã€‚</p>
<blockquote>
<p>è‰¿è‰¿ï¼šç¬¬ä¸€æ¬¡çŸ¥é“è¿˜æœ‰è¿™æ ·çš„è®¾å®šï¼ï¼ï¼</p>
</blockquote>
</li>
<li>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬ç»å¤§éƒ½æ•°æƒ…å†µï¼Œå¹¶ä¸ä¼šå»å®šä¹‰&nbsp;<code>spring.profiles</code>&nbsp;å±æ€§ã€‚æ‰€ä»¥å‘¢ï¼Œåˆ†æˆä¸¤ç§æƒ…å†µï¼š</p>
<blockquote>
<p>è‰¿è‰¿ï¼šä»”ç»†ç†è§£ï¼Œæˆ‘ä¹Ÿæ‡µé€¼äº†å¥½å¤šå°æ—¶ï¼ï¼ï¼ï¼</p>
</blockquote>
<ul>
<li><code>profile</code>&nbsp;ä¸º&nbsp;<code>null</code>&nbsp;çš„æƒ…å†µï¼Œå¤„ç†é»˜è®¤æƒ…å†µï¼Œå³æˆ‘ä»¬æœªå®šä¹‰&nbsp;<code>spring.profiles</code>&nbsp;å±æ€§ã€‚</li>
<li><code>profile</code>&nbsp;é&nbsp;<code>null</code>&nbsp;çš„æƒ…å†µï¼Œå¤„ç†é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†&nbsp;<code>spring.profiles</code>&nbsp;å±æ€§ï¼Œåˆ™éœ€è¦ä½¿ç”¨&nbsp;<code>profile</code>&nbsp;å’Œ&nbsp;<code>spring.profiles</code>&nbsp;åŒ¹é…ï¼Œå¹¶ä¸”å®ƒè¦å±äº&nbsp;<code>environment.activeProfiles</code>&nbsp;ä¸­å·²ç»æ¿€æ´»çš„ã€‚</li>
</ul>
</li>
</ul>
<p>ğŸ˜ˆ æ‰€ä»¥å‘¢ï¼Œæˆ‘ä»¬åœ¨&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.4.1.1 loadã€</a>&nbsp;ä¸­ï¼Œçœ‹åˆ°å®ƒæ˜¯åœ¨åŠ è½½æŒ‡å®š Profile çš„é…ç½®æ–‡ä»¶æ‰€ä½¿ç”¨ã€‚</p>
<h6 id="4-4-1-1-5-3-getPositiveProfileFilter">4.4.1.1.5.3 getPositiveProfileFilter</h6>
<p><code>#getPositiveProfileFilter(Profile profile)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> DocumentFilter <span class="title">getNegativeProfileFilter</span><span class="params">(Profile profile)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> (Document document) -&gt; (profile == <span class="keyword">null</span> <span class="comment">// &lt;1&gt;</span></span><br /><span class="line">            &amp;&amp; !ObjectUtils.isEmpty(document.getProfiles()) <span class="comment">// &lt;2&gt; éç©º</span></span><br /><span class="line">            <span class="comment">// environment.activeProfiles åŒ…å« document.profiles</span></span><br /><span class="line">            &amp;&amp; <span class="keyword">this</span>.environment.acceptsProfiles(Profiles.of(document.getProfiles()))); <span class="comment">// &lt;3&gt;</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè¦æ±‚ä¼ å…¥çš„&nbsp;<code>profile</code>&nbsp;ä¸ºç©ºã€‚å› ä¸ºå‘¢ï¼Œ<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.4.1.1 loadã€</a>&nbsp;ä¸­ï¼Œçœ‹åˆ°å®ƒæ˜¯åœ¨åŠ è½½<strong>æ—  Profile</strong>&nbsp;çš„é…ç½®æ–‡ä»¶æ‰€ä½¿ç”¨ã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œè¦æ±‚&nbsp;<code>document.profiles</code>&nbsp;éç©ºã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨&nbsp;<code>application.properties</code>&nbsp;ä¸­ï¼Œä¹Ÿå¹¶ä¸ä¼šå¡«å†™&nbsp;<code>spring.profiles</code>&nbsp;å±æ€§å€¼ã€‚è¿™å°±æ˜¯è¯´ï¼Œè¿™ä¸ªæ–¹æ³•é»˜è®¤åŸºæœ¬è¿”å›&nbsp;<code>false</code>&nbsp;ã€‚</li>
<li><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œ<code>environment.activeProfiles</code>&nbsp;åŒ…å«&nbsp;<code>document.profiles</code>&nbsp;ã€‚</li>
</ul>
<h5 id="4-4-1-1-6-DocumentConsumer">4.4.1.1.6 DocumentConsumer</h5>
<blockquote>
<p>å› ä¸ºç¨ååœ¨è®²è§£&nbsp;<code>#loadForFileExtension(...)</code>&nbsp;æ–¹æ³•éœ€è¦ç”¨åˆ°ï¼Œæ‰€ä»¥æ’æ’­ä¸‹ã€‚</p>
</blockquote>
<p>DocumentConsumer ï¼Œæ˜¯ ConfigFileApplicationListener çš„å†…éƒ¨æ¥å£ï¼Œç”¨äºå¤„ç†ä¼ å…¥çš„ Document ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#DocumentConsumer.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Consumer used to handle a loaded {<span class="doctag">@link</span> Document}.</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="meta">@FunctionalInterface</span></span><br /><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">interface</span> <span class="title">DocumentConsumer</span> </span>{</span><br /><br /><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">accept</span><span class="params">(Profile profile, Document document)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.4.1.1 loadã€</a>&nbsp;ä¸­ï¼Œæˆ‘ä»¬åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œå·²ç»çœ‹åˆ°å®ƒçš„ä¸€ä¸ªåŒ¿åå®ç°ç±»ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line">ç¬¬ä¸€ä¸ªï¼šaddToLoaded(MutablePropertySources::addLast, <span class="keyword">false</span>))</span><br /><span class="line">ç¬¬äºŒä¸ªï¼šaddToLoaded(MutablePropertySources::addFirst, <span class="keyword">true</span>))</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å·®åˆ«åœ¨äºä¼ å…¥çš„&nbsp;<code>#addToLoaded(BiConsumer&lt;MutablePropertySources, PropertySource&lt;?&gt;&gt; addMethod, boolean checkForExisting)</code>&nbsp;æ–¹æ³•çš„&nbsp;<code>addMethod</code>&nbsp;å‚æ•°ä¸åŒã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ
<ul>
<li>å¯¹äºæœ‰ Profile çš„æƒ…å†µï¼Œä½¿ç”¨å‰è€…&nbsp;<code>MutablePropertySources::addLast</code>&nbsp;ï¼Œå°† Document çš„ PropertySource æ·»åŠ åˆ°å°¾éƒ¨ã€‚</li>
<li>å¯¹äºæ—  Profile çš„æƒ…å†µï¼Œä½¿ç”¨åè€…&nbsp;<code>MutablePropertySources::addFirst</code>&nbsp;ï¼Œå°† Document çš„ PropertySource æ·»åŠ åˆ°å¤´éƒ¨ã€‚</li>
<li>æœ€ç»ˆï¼Œæˆ‘ä»¬çœ‹åˆ°&nbsp;<code>#addLoadedPropertySources()</code>&nbsp;æ–¹æ³•ä¸­ï¼Œä¼šæ‰§è¡Œ&nbsp;<code>Collections.reverse(loaded)</code>&nbsp;ä»£ç æ®µï¼Œè¿›è¡Œé¢ å€’ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¿™æ ·ï¼Œå°±èƒ½å¾ˆå·§å¦™çš„å®ç°&nbsp;<code>application-prod.properties</code>&nbsp;çš„ä¼˜å…ˆçº§ï¼Œé«˜äº&nbsp;<code>application.properties</code>&nbsp;ï¼Œä»è€Œå®ç°ç›¸åŒå±æ€§æ—¶ï¼Œè¦†ç›–è¯»å–~ï¼Œå³è¯»å–çš„æ˜¯&nbsp;<code>application-prod.properties</code>çš„å±æ€§é…ç½®ã€‚</li>
</ul>
</li>
</ul>
<h6 id="4-4-1-1-6-1-addToLoaded">4.4.1.1.6.1 addToLoaded</h6>
<p><code>#addToLoaded(BiConsumer&lt;MutablePropertySources, PropertySource&lt;?&gt;&gt; addMethod, boolean checkForExisting)</code>&nbsp;æ–¹æ³•ï¼Œå°† Document çš„ PropertySource ï¼Œæ·»åŠ åˆ°&nbsp;<code>Loader.loaded</code>&nbsp;ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> DocumentConsumer <span class="title">addToLoaded</span><span class="params">(BiConsumer&lt;MutablePropertySources, PropertySource&lt;?&gt;&gt; addMethod, <span class="keyword">boolean</span> checkForExisting)</span> </span>{</span><br /><span class="line">    <span class="comment">// åˆ›å»º DocumentConsumer å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">return</span> (profile, document) -&gt; {</span><br /><span class="line">        <span class="comment">// å¦‚æœè¦æ ¡éªŒå·²ç»å­˜åœ¨çš„æƒ…å†µï¼Œåˆ™å¦‚æœå·²ç»å­˜åœ¨ï¼Œåˆ™ç›´æ¥ return</span></span><br /><span class="line">        <span class="keyword">if</span> (checkForExisting) {</span><br /><span class="line">            <span class="keyword">for</span> (MutablePropertySources merged : <span class="keyword">this</span>.loaded.values()) {</span><br /><span class="line">                <span class="keyword">if</span> (merged.contains(document.getPropertySource().getName())) {</span><br /><span class="line">                    <span class="keyword">return</span>;</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// è·å¾— profile å¯¹åº”çš„ MutablePropertySources å¯¹è±¡</span></span><br /><span class="line">        MutablePropertySources merged = <span class="keyword">this</span>.loaded.computeIfAbsent(profile,</span><br /><span class="line">                (k) -&gt; <span class="keyword">new</span> MutablePropertySources());</span><br /><span class="line">        <span class="comment">// å°†åŠ è½½çš„ document åˆå¹¶åˆ° merged ä¸­</span></span><br /><span class="line">        addMethod.accept(merged, document.getPropertySource());</span><br /><span class="line">    };</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>åˆ›å»ºäº†ä¸€ä¸ª DocumentConsumer å¯¹è±¡ã€‚è€Œå…¶å†…éƒ¨çš„é€»è¾‘ï¼Œå¾ˆç®€å•ï¼Œèƒ–å‹è‡ªå·±ç…ç…å³å¯ã€‚</li>
</ul>
<h5 id="4-4-1-1-7-loadForFileExtension">4.4.1.1.7 loadForFileExtension</h5>
<p><code>#loadForFileExtension(PropertySourceLoader loader, String prefix, String fileExtension, Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)</code>&nbsp;æ–¹æ³•ï¼ŒåŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadForFileExtension</span><span class="params">(PropertySourceLoader loader, String prefix,</span></span></span><br /><span class="line"><span class="function"><span class="params">        String fileExtension, Profile profile,</span></span></span><br /><span class="line"><span class="function"><span class="params">        DocumentFilterFactory filterFactory, DocumentConsumer consumer)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; è·å¾— DocumentFilter å¯¹è±¡</span></span><br /><span class="line">    DocumentFilter defaultFilter = filterFactory.getDocumentFilter(<span class="keyword">null</span>);</span><br /><span class="line">    DocumentFilter profileFilter = filterFactory.getDocumentFilter(profile);</span><br /><span class="line">    <span class="comment">// &lt;2&gt; åŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚</span></span><br /><span class="line">    <span class="keyword">if</span> (profile != <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="comment">// Try profile-specific file &amp; profile section in profile file (gh-340)</span></span><br /><span class="line">        <span class="comment">// åŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚</span></span><br /><span class="line">        String profileSpecificFile = prefix + <span class="string">"-"</span> + profile + fileExtension;</span><br /><span class="line">        load(loader, profileSpecificFile, profile, defaultFilter, consumer); <span class="comment">// &lt;2.1&gt; æƒ…å†µä¸€ï¼Œæœªé…ç½® spring.profile å±æ€§</span></span><br /><span class="line">        load(loader, profileSpecificFile, profile, profileFilter, consumer); <span class="comment">// &lt;2.2&gt; æƒ…å†µäºŒï¼Œæœ‰é…ç½® spring.profile å±æ€§</span></span><br /><span class="line">        <span class="comment">// Try profile specific sections in files we've already processed</span></span><br /><span class="line">        <span class="comment">// &lt;2.3ã€‹ ç‰¹æ®Šæƒ…å†µï¼Œä¹‹å‰è¯»å– Profile å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå¯è¢«å½“å‰ Profile æ‰€è¯»å–ã€‚</span></span><br /><span class="line">        <span class="comment">// ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ä¹‹å‰è¯»å–äº† Profile ä¸º common å¯¹åº”é…ç½®æ–‡ä»¶æ˜¯ application-common.properties ï¼Œé‡Œé¢é…ç½®äº† spring.profile=dev,prod</span></span><br /><span class="line">        <span class="comment">//         é‚£ä¹ˆï¼Œæ­¤æ—¶å¦‚æœè¯»å–çš„ Profile ä¸º dev æ—¶ï¼Œä¹Ÿèƒ½è¯»å– application-common.properties è¿™ä¸ªé…ç½®æ–‡ä»¶</span></span><br /><span class="line">        <span class="keyword">for</span> (Profile processedProfile : <span class="keyword">this</span>.processedProfiles) {</span><br /><span class="line">            <span class="keyword">if</span> (processedProfile != <span class="keyword">null</span>) {</span><br /><span class="line">                String previouslyLoaded = prefix + <span class="string">"-"</span> + processedProfile + fileExtension; <span class="comment">// æ‹¼æ¥ä¹‹å‰çš„é…ç½®æ–‡ä»¶å</span></span><br /><span class="line">                load(loader, previouslyLoaded, profile, profileFilter, consumer); <span class="comment">// æ³¨æ„å™¢ï¼Œä¼ å…¥çš„ profile æ˜¯å½“å‰çš„ profile</span></span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// Also try the profile-specific section (if any) of the normal file</span></span><br /><span class="line">    <span class="comment">// &lt;3&gt; åŠ è½½ï¼ˆæ— éœ€å¸¦ Profileï¼‰æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚</span></span><br /><span class="line">    load(loader, prefix + fileExtension, profile, profileFilter, consumer);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè·å¾—ä¸¤ä¸ª DocumentFilter å¯¹è±¡ã€‚ä¸ºä»€ä¹ˆæ˜¯ä¸¤ä¸ªå‘¢ï¼Ÿèƒ–å‹æ€è€ƒä¸‹ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬åœ¨&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.4.1.1.5.2 getPositiveProfileFilterã€</a>&nbsp;ä¸­ï¼Œå·²ç»è¯´æ˜äº†ç­”æ¡ˆã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼ŒåŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚æœ‰ä¸‰ç§æƒ…å†µï¼Œèƒ–å‹è®¤çœŸçœ‹&nbsp;<code>&lt;2.1&gt;</code>ã€<code>&lt;2.2&gt;</code>ã€<code>&lt;2.3&gt;</code>&nbsp;å¤„çš„ä»£ç æ³¨é‡Šã€‚</li>
<li><code>&lt;3&gt;</code>&nbsp;å¤„ï¼ŒåŠ è½½ï¼ˆæ— éœ€å¸¦ Profileï¼‰æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚</li>
<li>å…³äº&nbsp;<code>#load(PropertySourceLoader loader, String location, Profile profile, DocumentFilter filter, DocumentConsumer consumer)</code>&nbsp;æ–¹æ³•ï¼ŒçœŸæ­£åŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.4.1.1.8 loadã€</a>&nbsp;ã€‚</li>
</ul>
<h5 id="4-4-1-1-8-load">4.4.1.1.8 load</h5>
<p><code>#load(PropertySourceLoader loader, String location, Profile profile, DocumentFilter filter, DocumentConsumer consumer)</code>&nbsp;æ–¹æ³•ï¼ŒçœŸæ­£åŠ è½½ Profile æŒ‡å®šçš„é…ç½®æ–‡ä»¶ï¼ˆå¸¦åç¼€ï¼‰ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">(PropertySourceLoader loader, String location, Profile profile, DocumentFilter filter, DocumentConsumer consumer)</span> </span>{</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="comment">// &lt;1.1&gt; åˆ¤æ–­æŒ‡å®šçš„é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br /><span class="line">        Resource resource = <span class="keyword">this</span>.resourceLoader.getResource(location);</span><br /><span class="line">        <span class="keyword">if</span> (!resource.exists()) {</span><br /><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isTraceEnabled()) {</span><br /><span class="line">                StringBuilder description = getDescription(<span class="string">"Skipped missing config "</span>, location, resource, profile);</span><br /><span class="line">                <span class="keyword">this</span>.logger.trace(description);</span><br /><span class="line">            }</span><br /><span class="line">            <span class="keyword">return</span>;</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// &lt;1.2&gt; å¦‚æœæ²¡æœ‰æ–‡ä»¶åç¼€çš„é…ç½®æ–‡ä»¶ï¼Œåˆ™å¿½ç•¥ï¼Œä¸è¿›è¡Œè¯»å–</span></span><br /><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(StringUtils.getFilenameExtension(resource.getFilename()))) {</span><br /><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isTraceEnabled()) {</span><br /><span class="line">                StringBuilder description = getDescription(<span class="string">"Skipped empty config extension "</span>, location, resource, profile);</span><br /><span class="line">                <span class="keyword">this</span>.logger.trace(description);</span><br /><span class="line">            }</span><br /><span class="line">            <span class="keyword">return</span>;</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// &lt;1.3&gt; åŠ è½½é…ç½®æ–‡ä»¶ï¼Œè¿”å› Document æ•°ç»„</span></span><br /><span class="line">        String name = <span class="string">"applicationConfig: ["</span> + location + <span class="string">"]"</span>;</span><br /><span class="line">        List&lt;Document&gt; documents = loadDocuments(loader, name, resource);</span><br /><span class="line">        <span class="comment">// &lt;1.4&gt; å¦‚æœæ²¡åŠ è½½åˆ°ï¼Œåˆ™ç›´æ¥è¿”å›</span></span><br /><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(documents)) {</span><br /><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isTraceEnabled()) {</span><br /><span class="line">                StringBuilder description = getDescription(</span><br /><span class="line">                        <span class="string">"Skipped unloaded config "</span>, location, resource, profile);</span><br /><span class="line">                <span class="keyword">this</span>.logger.trace(description);</span><br /><span class="line">            }</span><br /><span class="line">            <span class="keyword">return</span>;</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// &lt;2&gt; ä½¿ç”¨ DocumentFilter è¿‡æ»¤åŒ¹é…çš„ Document ï¼Œæ·»åŠ åˆ° loaded æ•°ç»„ä¸­ã€‚</span></span><br /><span class="line">        List&lt;Document&gt; loaded = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br /><span class="line">        <span class="keyword">for</span> (Document document : documents) {</span><br /><span class="line">            <span class="keyword">if</span> (filter.match(document)) { <span class="comment">// åŒ¹é…</span></span><br /><span class="line">                addActiveProfiles(document.getActiveProfiles()); <span class="comment">// &lt;2.1&gt;</span></span><br /><span class="line">                addIncludedProfiles(document.getIncludeProfiles()); <span class="comment">// &lt;2.2&gt;</span></span><br /><span class="line">                loaded.add(document);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        Collections.reverse(loaded);</span><br /><span class="line">        <span class="comment">// &lt;3&gt; ä½¿ç”¨ DocumentConsumer è¿›è¡Œæ¶ˆè´¹ Document ï¼Œæ·»åŠ åˆ°æœ¬åœ°çš„ loaded ä¸­ã€‚</span></span><br /><span class="line">        <span class="keyword">if</span> (!loaded.isEmpty()) {</span><br /><span class="line">            loaded.forEach((document) -&gt; consumer.accept(profile, document));</span><br /><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) {</span><br /><span class="line">                StringBuilder description = getDescription(<span class="string">"Loaded config file "</span>, location, resource, profile);</span><br /><span class="line">                <span class="keyword">this</span>.logger.debug(description);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    } <span class="keyword">catch</span> (Exception ex) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed to load property "</span></span><br /><span class="line">                + <span class="string">"source from location '"</span> + location + <span class="string">"'"</span>, ex);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1.1&gt;</code>&nbsp;å¤„ï¼Œåˆ¤æ–­æŒ‡å®šçš„é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚</li>
<li><code>&lt;1.2&gt;</code>&nbsp;å¤„ï¼Œå¦‚æœæ²¡æœ‰æ–‡ä»¶åç¼€çš„é…ç½®æ–‡ä»¶ï¼Œåˆ™å¿½ç•¥ï¼Œä¸è¿›è¡Œè¯»å–ã€‚</li>
<li><code>&lt;1.3&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#loadDocuments(PropertySourceLoader loader, String name, Resource resource)</code>æ–¹æ³•ï¼ŒåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¹¶è¿”å› Document æ•°ç»„ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.4.1.1.8.1 loadDocumentsã€</a>&nbsp;å°èŠ‚ã€‚</li>
<li><code>&lt;1.4&gt;</code>&nbsp;å¤„ï¼Œå¦‚æœæ²¡åŠ è½½åˆ°ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚</li>
<li>
<p><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œéå†åŠ è½½åˆ°&nbsp;<code>documents</code>&nbsp;æ•°ç»„ï¼Œé€ä¸ªè°ƒç”¨&nbsp;<code>DocumentFilter#match(Document document)</code>&nbsp;æ–¹æ³•ï¼Œè¿›è¡ŒåŒ¹é…ã€‚è‹¥åŒ¹é…æˆåŠŸï¼Œåˆ™æ·»åŠ åˆ°&nbsp;<code>loaded</code>&nbsp;ä¸­ã€‚</p>
<ul>
<li><code>&lt;2.1&gt;</code>&nbsp;å¤„ï¼Œ<code>#addActiveProfiles(Set&lt;Profile&gt; profiles)</code>&nbsp;æ–¹æ³•ï¼Œå·²ç»åœ¨&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.4.1.1.1 initializeProfilesã€</a>&nbsp;ä¸­ï¼Œè¯¦ç»†è§£æã€‚</li>
<li>
<p><code>&lt;2.2&gt;</code>&nbsp;å¤„ï¼Œ<code>#addIncludedProfiles(Set&lt;Profile&gt; profiles)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addIncludedProfiles</span><span class="params">(Set&lt;Profile&gt; includeProfiles)</span> </span>{</span><br /><span class="line">    <span class="comment">// æ•´ä½“é€»è¾‘æ˜¯ includeProfiles - processedProfiles + profiles</span></span><br /><span class="line">	LinkedList&lt;Profile&gt; existingProfiles = <span class="keyword">new</span> LinkedList&lt;&gt;(<span class="keyword">this</span>.profiles);</span><br /><span class="line">	<span class="keyword">this</span>.profiles.clear();</span><br /><span class="line">	<span class="keyword">this</span>.profiles.addAll(includeProfiles);</span><br /><span class="line">	<span class="keyword">this</span>.profiles.removeAll(<span class="keyword">this</span>.processedProfiles);</span><br /><span class="line">	<span class="keyword">this</span>.profiles.addAll(existingProfiles);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>~</li>
</ul>
</li>
</ul>
<ul>
<li><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œéå†&nbsp;<code>loaded</code>&nbsp;æ•°ç»„ï¼Œè°ƒç”¨&nbsp;<code>DocumentConsumer#accept(Profile profile, Document document)</code>&nbsp;æ–¹æ³•ï¼Œæ·»åŠ åˆ°æœ¬åœ°çš„&nbsp;<code>Loader.loaded</code>&nbsp;ä¸­ã€‚æ­¤å¤„ï¼Œåœ¨ç»“åˆ&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ4.4.1.1.6 DocumentConsumerã€</a>&nbsp;ä¸€èµ·çœ‹ã€‚</li>
</ul>
</li>
</ul>
<p>ğŸ˜ˆ è‡³æ­¤ï¼ŒSpring Boot åŠ è½½é…ç½®çš„åŠŸèƒ½ï¼ŒåŸºæœ¬æ˜¯å®Œæˆäº†ã€‚æ€»çš„æ¥è¯´ï¼Œç†è§£å¤§ä½“çš„æµç¨‹ï¼Œè¿˜æ˜¯ç›¸å¯¹æ¯”è¾ƒå®¹æ˜“çš„ã€‚ä½†æ˜¯ï¼Œæƒ³è¦æ‰£æ‡‚è¿™ä¸ªè¿‡ç¨‹çš„æ¯ä¸€ä¸ªç»†èŠ‚ï¼Œéœ€è¦å¤šå¤šçš„è°ƒè¯•ã€‚</p>
<blockquote>
<p>è‰¿è‰¿ï¼šå¯èƒ½æœ‰äº›ç»†èŠ‚å†™çš„ä¸åˆ°ä½ï¼Œæˆ–è€…è§£é‡Šçš„ä¸åˆ°ä½ï¼Œåˆæˆ–è€…è®²çš„ä¸æ­£ç¡®ã€‚æ‰€ä»¥ï¼Œæœ‰ä»»ä½•ç–‘æƒ‘ï¼Œè¯·ç«‹åˆ»é©¬ä¸Šèµ¶ç´§ç»™æˆ‘æ˜Ÿçƒç•™è¨€æé—®å“ˆã€‚</p>
</blockquote>
<h6 id="4-4-1-1-8-1-loadDocuments">4.4.1.1.8.1 loadDocuments</h6>
<p><code>#loadDocuments(PropertySourceLoader loader, String name, Resource resource)</code>&nbsp;æ–¹æ³•ï¼ŒåŠ è½½é…ç½®æ–‡ä»¶ï¼Œå¹¶è¿”å› Document æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> List&lt;Document&gt; <span class="title">loadDocuments</span><span class="params">(PropertySourceLoader loader, String name, Resource resource)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; åˆ›å»º DocumentsCacheKey å¯¹è±¡ï¼Œä» loadDocumentsCache ç¼“å­˜ä¸­åŠ è½½ Document æ•°ç»„</span></span><br /><span class="line">    DocumentsCacheKey cacheKey = <span class="keyword">new</span> DocumentsCacheKey(loader, resource);</span><br /><span class="line">    List&lt;Document&gt; documents = <span class="keyword">this</span>.loadDocumentsCache.get(cacheKey);</span><br /><span class="line">    <span class="comment">// &lt;2.1&gt; å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨ PropertySourceLoader åŠ è½½æŒ‡å®šé…ç½®æ–‡ä»¶</span></span><br /><span class="line">    <span class="keyword">if</span> (documents == <span class="keyword">null</span>) {</span><br /><span class="line">        List&lt;PropertySource&lt;?&gt;&gt; loaded = loader.load(name, resource);</span><br /><span class="line">        <span class="comment">// &lt;2.2&gt; å°†è¿”å›çš„ PropertySource æ•°ç»„ï¼Œå°è£…æˆ Document æ•°ç»„</span></span><br /><span class="line">        documents = asDocuments(loaded);</span><br /><span class="line">        <span class="comment">// &lt;2.3&gt; æ·»åŠ åˆ° loadDocumentsCache ç¼“å­˜ä¸­</span></span><br /><span class="line">        <span class="keyword">this</span>.loadDocumentsCache.put(cacheKey, documents);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> documents;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œåˆ›å»º DocumentsCacheKey å¯¹è±¡ï¼Œä»&nbsp;<code>loadDocumentsCache</code>&nbsp;ç¼“å­˜ä¸­åŠ è½½ Document æ•°ç»„ã€‚</li>
<li><code>&lt;2.1&gt;</code>&nbsp;å¤„ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è°ƒç”¨&nbsp;<code>PropertySourceLoader#load(String name, Resource resource)</code>&nbsp;æ–¹æ³•ï¼ŒåŠ è½½æŒ‡å®šé…ç½®æ–‡ä»¶ã€‚è¯¦ç»†çš„è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ7. PropertySourceLoaderã€</a>&nbsp;ä¸­ã€‚</li>
<li>
<p><code>&lt;2.2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#asDocuments(List&lt;PropertySource&lt;?&gt;&gt; loaded)</code>&nbsp;æ–¹æ³•ï¼Œå°†è¿”å›çš„ PropertySource æ•°ç»„ï¼Œå°è£…æˆ Document æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ConfigFileApplicationListener#Loader.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> List&lt;Document&gt; <span class="title">asDocuments</span><span class="params">(List&lt;PropertySource&lt;?&gt;&gt; loaded)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (loaded == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> loaded.stream().map((propertySource) -&gt; {</span><br /><span class="line">        <span class="comment">// åˆ›å»º Binder å¯¹è±¡</span></span><br /><span class="line">        Binder binder = <span class="keyword">new</span> Binder(</span><br /><span class="line">                ConfigurationPropertySources.from(propertySource),</span><br /><span class="line">                <span class="keyword">this</span>.placeholdersResolver);</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Document(propertySource,</span><br /><span class="line">                binder.bind(<span class="string">"spring.profiles"</span>, STRING_ARRAY).orElse(<span class="keyword">null</span>), <span class="comment">// è¯»å– "spring.profiles" é…ç½®</span></span><br /><span class="line">                getProfiles(binder, ACTIVE_PROFILES_PROPERTY), <span class="comment">// è¯»å– "spring.profiles.active" é…ç½®</span></span><br /><span class="line">                getProfiles(binder, INCLUDE_PROFILES_PROPERTY)); <span class="comment">// è¯»å– "spring.profiles.include" é…ç½®</span></span><br /><span class="line">    }).collect(Collectors.toList());</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Set&lt;Profile&gt; <span class="title">getProfiles</span><span class="params">(Binder binder, String name)</span> </span>{</span><br /><span class="line">	<span class="keyword">return</span> binder.bind(name, STRING_ARRAY).map(<span class="keyword">this</span>::asProfileSet).orElse(Collections.emptySet());</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Set&lt;Profile&gt; <span class="title">asProfileSet</span><span class="params">(String[] profileNames)</span> </span>{</span><br /><span class="line">	List&lt;Profile&gt; profiles = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br /><span class="line">	<span class="keyword">for</span> (String profileName : profileNames) {</span><br /><span class="line">		profiles.add(<span class="keyword">new</span> Profile(profileName));</span><br /><span class="line">	}</span><br /><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> LinkedHashSet&lt;&gt;(profiles);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>&lt;2.3&gt;</code>&nbsp;å¤„ï¼Œæ·»åŠ åˆ°&nbsp;<code>loadDocumentsCache</code>&nbsp;ç¼“å­˜ä¸­ã€‚</p>
</li>
</ul>
<h1 id="5-RandomValuePropertySource">5. RandomValuePropertySource</h1>
<p><code>org.springframework.boot.env.RandomValuePropertySource</code>&nbsp;ï¼Œç»§æ‰¿ PropertySource ç±»ï¼Œæä¾›éšæœºå€¼çš„ PropertySource å®ç°ç±»ã€‚</p>
<p>ä¸äº†è§£ Spring Boot ä»é…ç½®æ–‡ä»¶ä¸­è·å–éšæœºæ•°ï¼Œå¯ä»¥çœ‹çœ‹&nbsp;<a href="https://blog.csdn.net/qq_35981283/article/details/77853069" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠSpring Bootå­¦ä¹ &ndash;ä»é…ç½®æ–‡ä»¶ä¸­è·å–éšæœºæ•°ã€‹</a>&nbsp;æ–‡ç« ã€‚</p>
<h2 id="5-1-addToEnvironment">5.1 addToEnvironment</h2>
<p><code>#addToEnvironment(ConfigurableEnvironment environment)</code>&nbsp;<strong>é™æ€</strong>æ–¹æ³•ï¼Œåˆ›å»º RandomValuePropertySource å¯¹è±¡ï¼Œæ·»åŠ åˆ°&nbsp;<code>environment</code>&nbsp;ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// RandomValuePropertySource.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Name of the random {<span class="doctag">@link</span> PropertySource}.</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String RANDOM_PROPERTY_SOURCE_NAME = <span class="string">"random"</span>;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addToEnvironment</span><span class="params">(ConfigurableEnvironment environment)</span> </span>{</span><br /><span class="line">	environment.getPropertySources().addAfter(StandardEnvironment.SYSTEM_ENVIRONMENT_PROPERTY_SOURCE_NAME, <span class="keyword">new</span> RandomValuePropertySource(RANDOM_PROPERTY_SOURCE_NAME));</span><br /><span class="line">	logger.trace(<span class="string">"RandomValuePropertySource add to Environment"</span>);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="5-2-getProperty">5.2 getProperty</h2>
<p>å®ç°&nbsp;<code>#getProperty(String name)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—&nbsp;<code>name</code>&nbsp;å¯¹åº”çš„éšæœºå€¼ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// RandomValuePropertySource.java</span></span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PREFIX = <span class="string">"random."</span>;</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">getProperty</span><span class="params">(String name)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; å¿…é¡»ä»¥ random. å‰ç¼€</span></span><br /><span class="line">    <span class="keyword">if</span> (!name.startsWith(PREFIX)) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">if</span> (logger.isTraceEnabled()) {</span><br /><span class="line">        logger.trace(<span class="string">"Generating random property for '"</span> + name + <span class="string">"'"</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// &lt;2&gt; æ ¹æ®ç±»å‹ï¼Œè·å¾—éšæœºå€¼</span></span><br /><span class="line">    <span class="keyword">return</span> getRandomValue(name.substring(PREFIX.length()));</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œå¿…é¡»ä»¥&nbsp;<code>"random."</code>&nbsp;å‰ç¼€ã€‚åœ¨è·å–å±æ€§å€¼ï¼Œ<code>name</code>&nbsp;å‰åçš„&nbsp;<code>${}</code>&nbsp;å·²ç»è¢«å»æ‰ã€‚</li>
<li>
<p><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#getRandomValue(String type)</code>&nbsp;æ–¹æ³•ï¼Œæ ¹æ®ç±»å‹ï¼Œè·å¾—éšæœºå€¼ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// RandomValuePropertySource.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getRandomValue</span><span class="params">(String type)</span> </span>{</span><br /><span class="line">    <span class="comment">// int</span></span><br /><span class="line">    <span class="keyword">if</span> (type.equals(<span class="string">"int"</span>)) {</span><br /><span class="line">        <span class="keyword">return</span> getSource().nextInt();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// long</span></span><br /><span class="line">    <span class="keyword">if</span> (type.equals(<span class="string">"long"</span>)) {</span><br /><span class="line">        <span class="keyword">return</span> getSource().nextLong();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// int èŒƒå›´</span></span><br /><span class="line">    String range = getRange(type, <span class="string">"int"</span>);</span><br /><span class="line">    <span class="keyword">if</span> (range != <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">return</span> getNextIntInRange(range);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// long èŒƒå›´</span></span><br /><span class="line">    range = getRange(type, <span class="string">"long"</span>);</span><br /><span class="line">    <span class="keyword">if</span> (range != <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">return</span> getNextLongInRange(range);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// uuid</span></span><br /><span class="line">    <span class="keyword">if</span> (type.equals(<span class="string">"uuid"</span>)) {</span><br /><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// md5</span></span><br /><span class="line">    <span class="keyword">return</span> getRandomBytes();</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getRange</span><span class="params">(String type, String prefix)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (type.startsWith(prefix)) {</span><br /><span class="line">        <span class="keyword">int</span> startIndex = prefix.length() + <span class="number">1</span>;</span><br /><span class="line">        <span class="keyword">if</span> (type.length() &gt; startIndex) {</span><br /><span class="line">            <span class="keyword">return</span> type.substring(startIndex, type.length() - <span class="number">1</span>);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getNextIntInRange</span><span class="params">(String range)</span> </span>{</span><br /><span class="line">    String[] tokens = StringUtils.commaDelimitedListToStringArray(range);</span><br /><span class="line">    <span class="keyword">int</span> start = Integer.parseInt(tokens[<span class="number">0</span>]);</span><br /><span class="line">    <span class="keyword">if</span> (tokens.length == <span class="number">1</span>) {</span><br /><span class="line">        <span class="keyword">return</span> getSource().nextInt(start);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> start + getSource().nextInt(Integer.parseInt(tokens[<span class="number">1</span>]) - start);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">getNextLongInRange</span><span class="params">(String range)</span> </span>{</span><br /><span class="line">    String[] tokens = StringUtils.commaDelimitedListToStringArray(range);</span><br /><span class="line">    <span class="keyword">if</span> (tokens.length == <span class="number">1</span>) {</span><br /><span class="line">        <span class="keyword">return</span> Math.abs(getSource().nextLong() % Long.parseLong(tokens[<span class="number">0</span>]));</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">long</span> lowerBound = Long.parseLong(tokens[<span class="number">0</span>]);</span><br /><span class="line">    <span class="keyword">long</span> upperBound = Long.parseLong(tokens[<span class="number">1</span>]) - lowerBound;</span><br /><span class="line">    <span class="keyword">return</span> lowerBound + Math.abs(getSource().nextLong() % upperBound);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">getRandomBytes</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">32</span>];</span><br /><span class="line">    getSource().nextBytes(bytes);</span><br /><span class="line">    <span class="keyword">return</span> DigestUtils.md5DigestAsHex(bytes);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ¯”è¾ƒç®€å•ï¼Œç…ç…å³æ˜ç™½ã€‚</li>
</ul>
</li>
</ul>
<p>ğŸ˜ˆ è¿™ä¸ªè°œé¢˜ï¼Œæ˜¯ä¸æ˜¯è¢«æ­æ™“äº†~</p>
<h1 id="6-PropertySourcesPlaceholdersResolver">6. PropertySourcesPlaceholdersResolver</h1>
<p><code>org.springframework.boot.context.properties.bind.PropertySourcesPlaceholdersResolver</code>&nbsp;ï¼Œå®ç° PropertySource å¯¹åº”çš„å€¼æ˜¯å ä½ç¬¦çš„è§£æå™¨ ã€‚</p>
<h2 id="6-1-æ„é€ æ–¹æ³•">6.1 æ„é€ æ–¹æ³•</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// PropertySourcesPlaceholdersResolver.java</span></span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Iterable&lt;PropertySource&lt;?&gt;&gt; sources;</span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PropertyPlaceholderHelper helper;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PropertySourcesPlaceholdersResolver</span><span class="params">(Environment environment)</span> </span>{</span><br /><span class="line">	<span class="keyword">this</span>(getSources(environment), <span class="keyword">null</span>);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PropertySourcesPlaceholdersResolver</span><span class="params">(Iterable&lt;PropertySource&lt;?&gt;&gt; sources)</span> </span>{</span><br /><span class="line">	<span class="keyword">this</span>(sources, <span class="keyword">null</span>);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PropertySourcesPlaceholdersResolver</span><span class="params">(Iterable&lt;PropertySource&lt;?&gt;&gt; sources,</span></span></span><br /><span class="line"><span class="function"><span class="params">		PropertyPlaceholderHelper helper)</span> </span>{</span><br /><span class="line">	<span class="keyword">this</span>.sources = sources;</span><br /><span class="line">	<span class="keyword">this</span>.helper = (helper != <span class="keyword">null</span>) ? helper</span><br /><span class="line">			: <span class="keyword">new</span> PropertyPlaceholderHelper(SystemPropertyUtils.PLACEHOLDER_PREFIX, <span class="comment">// ${</span></span><br /><span class="line">					SystemPropertyUtils.PLACEHOLDER_SUFFIX, <span class="comment">// }</span></span><br /><span class="line">					SystemPropertyUtils.VALUE_SEPARATOR, <span class="keyword">true</span>);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">// è·å¾— PropertySources ä»¬</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> PropertySources <span class="title">getSources</span><span class="params">(Environment environment)</span> </span>{</span><br /><span class="line">	Assert.notNull(environment, <span class="string">"Environment must not be null"</span>);</span><br /><span class="line">	Assert.isInstanceOf(ConfigurableEnvironment.class, environment, <span class="string">"Environment must be a ConfigurableEnvironment"</span>);</span><br /><span class="line">	<span class="keyword">return</span> ((ConfigurableEnvironment) environment).getPropertySources();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å…¶ä¸­ï¼Œåˆ›å»ºçš„&nbsp;<code>helper</code>&nbsp;å±æ€§ï¼Œä¸º PropertyPlaceholderHelper å¯¹è±¡ã€‚å…¶ä¸­&nbsp;<code>SystemPropertyUtils.PLACEHOLDER_PREFIX</code>&nbsp;ä¸º&nbsp;<code>${</code>&nbsp;ï¼Œ&nbsp;<code>SystemPropertyUtils.PLACEHOLDER_SUFFIX</code>&nbsp;ä¸º&nbsp;<code>}</code>ã€‚è¿™æ ·ï¼Œä¾‹å¦‚è¯´ RandomValuePropertySource çš„&nbsp;<code>${random.int}</code>&nbsp;ç­‰ç­‰ï¼Œå°±å¯ä»¥è¢« PropertySourcesPlaceholdersResolver æ‰€å¤„ç†ã€‚</li>
</ul>
<h2 id="6-2-resolvePlaceholders">6.2 resolvePlaceholders</h2>
<p>å®ç°&nbsp;<code>#resolvePlaceholders(Object value)</code>&nbsp;æ–¹æ³•ï¼Œè§£æå ä½ç¬¦ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// PropertySourcesPlaceholdersResolver.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">resolvePlaceholders</span><span class="params">(Object value)</span> </span>{</span><br /><span class="line">    <span class="comment">// å¦‚æœ value æ˜¯ String ç±»å‹ï¼Œæ‰æ˜¯å ä½ç¬¦</span></span><br /><span class="line">    <span class="keyword">if</span> (value <span class="keyword">instanceof</span> String) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.helper.replacePlaceholders((String) value, <span class="keyword">this</span>::resolvePlaceholder);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> value;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>å¦‚æœ&nbsp;<code>value</code>&nbsp;æ˜¯ String ç±»å‹ï¼Œæ‰<strong>å¯èƒ½</strong>æ˜¯å ä½ç¬¦ã€‚æ»¡è¶³æ—¶ï¼Œè°ƒç”¨&nbsp;<code>PropertyPlaceholderHelper#replacePlaceholders(String value, PlaceholderResolver placeholderResolver)</code>&nbsp;æ–¹æ³•ï¼Œè§£æå‡ºå ä½ç¬¦é‡Œé¢çš„å†…å®¹ã€‚</p>
<ul>
<li>ä¾‹å¦‚è¯´ï¼šPropertySourcesPlaceholdersResolver ä¸­ï¼Œå ä½ç¬¦æ˜¯&nbsp;<code>${}</code>&nbsp;ï¼Œé‚£ä¹ˆ&nbsp;<code>${random.int}</code>&nbsp;è¢«è§£æåçš„å†…å®¹æ˜¯&nbsp;<code>random.int</code>&nbsp;ã€‚</li>
<li>
<p>è§£æåˆ°å ä½ç¬¦åï¼Œåˆ™å›è°ƒ&nbsp;<code>#resolvePlaceholder(String placeholder)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—å ä½ç¬¦å¯¹åº”çš„å€¼ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// PropertySourcesPlaceholdersResolver.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">resolvePlaceholder</span><span class="params">(String placeholder)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.sources != <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="comment">// éå† sources æ•°ç»„ï¼Œé€ä¸ªè·å¾—å±æ€§å€¼ã€‚è‹¥è·å–åˆ°ï¼Œåˆ™è¿›è¡Œè¿”å›</span></span><br /><span class="line">        <span class="keyword">for</span> (PropertySource&lt;?&gt; source : <span class="keyword">this</span>.sources) {</span><br /><span class="line">            Object value = source.getProperty(placeholder);</span><br /><span class="line">            <span class="keyword">if</span> (value != <span class="keyword">null</span>) {</span><br /><span class="line">                <span class="keyword">return</span> String.valueOf(value);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è¿™æ ·ï¼ŒğŸ˜ˆ RandomValuePropertySource æ˜¯ä¸æ˜¯å°±è¢«ä¸²èµ·æ¥å–½ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="7-PropertySourceLoader">7. PropertySourceLoader</h1>
<p><code>org.springframework.boot.env.PropertySourceLoader</code>&nbsp;æ¥å£ï¼ŒåŠ è½½æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œè¿”å› PropertySource æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// PropertySourceLoader.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PropertySourceLoader</span> </span>{</span><br /><br /><span class="line">	<span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * è·å¾—å¯ä»¥å¤„ç†çš„é…ç½®æ–‡ä»¶çš„åç¼€</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">	 * Returns the file extensions that the loader supports (excluding the '.').</span></span><br /><span class="line"><span class="comment">	 * <span class="doctag">@return</span> the file extensions</span></span><br /><span class="line"><span class="comment">	 */</span></span><br /><span class="line">	String[] getFileExtensions();</span><br /><br /><span class="line">	<span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * åŠ è½½æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œè¿”å› PropertySource æ•°ç»„</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">	 * Load the resource into one or more property sources. Implementations may either</span></span><br /><span class="line"><span class="comment">	 * return a list containing a single source, or in the case of a multi-document format</span></span><br /><span class="line"><span class="comment">	 * such as yaml a source for each document in the resource.</span></span><br /><span class="line"><span class="comment">	 * <span class="doctag">@param</span> name the root name of the property source. If multiple documents are loaded</span></span><br /><span class="line"><span class="comment">	 * an additional suffix should be added to the name for each source loaded.</span></span><br /><span class="line"><span class="comment">     *             PropertySource çš„åå­—</span></span><br /><span class="line"><span class="comment">	 * <span class="doctag">@param</span> resource the resource to load</span></span><br /><span class="line"><span class="comment">     *             é…ç½®æ–‡ä»¶çš„ Resource å¯¹è±¡</span></span><br /><span class="line"><span class="comment">	 * <span class="doctag">@return</span> a list property sources</span></span><br /><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> IOException if the source cannot be loaded</span></span><br /><span class="line"><span class="comment">	 */</span></span><br /><span class="line">	List&lt;PropertySource&lt;?&gt;&gt; load(String name, Resource resource) <span class="keyword">throws</span> IOException;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¯èƒ½èƒ–å‹ï¼Œå’Œæˆ‘å¼€å§‹ä¸€æ ·ï¼Œä¸ºä»€ä¹ˆä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼ŒåŠ è½½åä¼šå­˜åœ¨å¤šä¸ª PropertySource å¯¹è±¡å‘¢ï¼Ÿä¸‹é¢ï¼Œæˆ‘ä»¬æ¥è§åˆ†æ™“~</li>
</ul>
<h2 id="7-1-PropertiesPropertySourceLoader">7.1 PropertiesPropertySourceLoader</h2>
<p><code>org.springframework.boot.env.PropertiesPropertySourceLoader</code>&nbsp;ï¼Œå®ç° PropertySourceLoader æ¥å£ï¼ŒåŠ è½½&nbsp;<code>.xml</code>&nbsp;å’Œ&nbsp;<code>.properties</code>&nbsp;ç±»å‹çš„é…ç½®æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// PropertiesPropertySourceLoader.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesPropertySourceLoader</span> <span class="keyword">implements</span> <span class="title">PropertySourceLoader</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String XML_FILE_EXTENSION = <span class="string">".xml"</span>;</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">public</span> String[] getFileExtensions() {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[] { <span class="string">"properties"</span>, <span class="string">"xml"</span> }; <span class="comment">// &lt;1&gt;</span></span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">public</span> List&lt;PropertySource&lt;?&gt;&gt; load(String name, Resource resource)</span><br /><span class="line">            <span class="keyword">throws</span> IOException {</span><br /><span class="line">        <span class="comment">// &lt;2.1&gt; è¯»å–æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œè¿”å› Map å¯¹è±¡</span></span><br /><span class="line">        Map&lt;String, ?&gt; properties = loadProperties(resource);</span><br /><span class="line">        <span class="comment">// &lt;2.2&gt; å¦‚æœ Map ä¸ºç©ºï¼Œè¿”å›ç©ºæ•°ç»„</span></span><br /><span class="line">        <span class="keyword">if</span> (properties.isEmpty()) {</span><br /><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// &lt;2.3&gt; å°† Map å°è£…æˆ OriginTrackedMapPropertySource å¯¹è±¡ï¼Œç„¶åè¿”å›å•å…ƒç´ çš„æ•°ç»„</span></span><br /><span class="line">        <span class="keyword">return</span> Collections.singletonList(<span class="keyword">new</span> OriginTrackedMapPropertySource(name, properties));</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè¿”å›å¯å¤„ç†çš„æ–‡ä»¶ç±»å‹ï¼Œä¸º&nbsp;<code>properties</code>&nbsp;å’Œ&nbsp;<code>xml</code>&nbsp;ã€‚</li>
<li>
<p><code>&lt;2.1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#loadProperties(Resource resource)</code>&nbsp;æ–¹æ³•ï¼Œè¯»å–æŒ‡å®šé…ç½®æ–‡ä»¶ï¼Œè¿”å› Map å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// PropertiesPropertySourceLoader.java</span></span><br /><br /><span class="line"><span class="keyword">private</span> Map&lt;String, ?&gt; loadProperties(Resource resource) <span class="keyword">throws</span> IOException {</span><br /><span class="line">    String filename = resource.getFilename();</span><br /><span class="line">    <span class="comment">// è¯»å– XML åç¼€çš„é…ç½®æ–‡ä»¶</span></span><br /><span class="line">    <span class="keyword">if</span> (filename != <span class="keyword">null</span> &amp;&amp; filename.endsWith(XML_FILE_EXTENSION)) {</span><br /><span class="line">        <span class="keyword">return</span> (Map) PropertiesLoaderUtils.loadProperties(resource);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è¯»å– Properties åç¼€çš„é…ç½®æ–‡ä»¶</span></span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> OriginTrackedPropertiesLoader(resource).load();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ ¹æ®&nbsp;<code>.xml</code>&nbsp;å’Œ&nbsp;<code>.properties</code>&nbsp;åç¼€ï¼Œä½¿ç”¨ä¸åŒçš„è¯»å–æ–¹æ³•ã€‚è‡³äºè¯»å–é…ç½®çš„é€»è¾‘ï¼Œæš‚æ—¶ä¸åœ¨æœ¬æ–‡çš„èŒƒç•´ï¼Œhoho ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œè‡ªå·±å»ç…ç…ã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;2.2&gt;</code>&nbsp;å¤„ï¼Œå¦‚æœ Map ä¸ºç©ºï¼Œè¿”å›ç©ºæ•°ç»„ã€‚</p>
</li>
<li><code>&lt;2.3&gt;</code>&nbsp;å¤„ï¼Œå°† Map å°è£…æˆ OriginTrackedMapPropertySource å¯¹è±¡ï¼Œç„¶åè¿”å›å•å…ƒç´ çš„æ•°ç»„ã€‚<code>org.springframework.boot.env.OriginTrackedMapPropertySource</code>&nbsp;ï¼Œç»§æ‰¿ MapPropertySource ç±»ï¼Œå®ç° OriginLookup æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// OriginTrackedMapPropertySource.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OriginTrackedMapPropertySource</span> <span class="keyword">extends</span> <span class="title">MapPropertySource</span></span></span><br /><span class="line"><span class="class">		<span class="keyword">implements</span> <span class="title">OriginLookup</span>&lt;<span class="title">String</span>&gt; </span>{</span><br /><br /><span class="line">	<span class="meta">@SuppressWarnings</span>({ <span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span> })</span><br /><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">OriginTrackedMapPropertySource</span><span class="params">(String name, Map source)</span> </span>{</span><br /><span class="line">		<span class="keyword">super</span>(name, source);</span><br /><span class="line">	}</span><br /><br /><span class="line">	<span class="meta">@Override</span></span><br /><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">getProperty</span><span class="params">(String name)</span> </span>{</span><br /><span class="line">	    <span class="comment">// è·å¾—å±æ€§å€¼</span></span><br /><span class="line">		Object value = <span class="keyword">super</span>.getProperty(name);</span><br /><span class="line">		<span class="comment">// å¦‚æœæ˜¯ OriginTrackedValue å°è£…ç±»å‹ï¼Œåˆ™è¿”å›å…¶çœŸå®çš„å€¼</span></span><br /><span class="line">		<span class="keyword">if</span> (value <span class="keyword">instanceof</span> OriginTrackedValue) {</span><br /><span class="line">			<span class="keyword">return</span> ((OriginTrackedValue) value).getValue();</span><br /><span class="line">		}</span><br /><span class="line">		<span class="keyword">return</span> value;</span><br /><span class="line">	}</span><br /><br /><span class="line">	<span class="meta">@Override</span></span><br /><span class="line">	<span class="function"><span class="keyword">public</span> Origin <span class="title">getOrigin</span><span class="params">(String name)</span> </span>{</span><br /><span class="line">        <span class="comment">// è·å¾—å±æ€§å€¼</span></span><br /><span class="line">        Object value = <span class="keyword">super</span>.getProperty(name);</span><br /><span class="line">        <span class="comment">// å¦‚æœæ˜¯ OriginTrackedValue å°è£…ç±»å‹ï¼Œåˆ™è¿”å›å…¶ Origin</span></span><br /><span class="line">		<span class="keyword">if</span> (value <span class="keyword">instanceof</span> OriginTrackedValue) {</span><br /><span class="line">			<span class="keyword">return</span> ((OriginTrackedValue) value).getOrigin();</span><br /><span class="line">		}</span><br /><span class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">	}</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<h2 id="7-2-YamlPropertySourceLoader">7.2 YamlPropertySourceLoader</h2>
<p><code>org.springframework.boot.env.YamlPropertySourceLoader</code>&nbsp;ï¼Œå®ç° PropertySourceLoader æ¥å£ï¼ŒåŠ è½½&nbsp;<code>.yaml</code>&nbsp;å’Œ&nbsp;<code>.yml</code>&nbsp;ç±»å‹çš„é…ç½®æ–‡ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// YamlPropertySourceLoader.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YamlPropertySourceLoader</span> <span class="keyword">implements</span> <span class="title">PropertySourceLoader</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">public</span> String[] getFileExtensions() {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[] { <span class="string">"yml"</span>, <span class="string">"yaml"</span> }; <span class="comment">// &lt;1&gt;</span></span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">public</span> List&lt;PropertySource&lt;?&gt;&gt; load(String name, Resource resource) <span class="keyword">throws</span> IOException {</span><br /><span class="line">        <span class="comment">// &lt;2&gt; å¦‚æœä¸å­˜åœ¨ org.yaml.snakeyaml.Yaml ç±»ï¼Œè¯´æ˜æ²¡æœ‰å¼•å…¥ snakeyaml ä¾èµ–</span></span><br /><span class="line">        <span class="keyword">if</span> (!ClassUtils.isPresent(<span class="string">"org.yaml.snakeyaml.Yaml"</span>, <span class="keyword">null</span>)) {</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Attempted to load "</span> + name</span><br /><span class="line">                    + <span class="string">" but snakeyaml was not found on the classpath"</span>);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// &lt;3.1&gt; åŠ è½½é…ç½®ï¼Œè¿”å› Map æ•°ç»„</span></span><br /><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; loaded = <span class="keyword">new</span> OriginTrackedYamlLoader(resource).load();</span><br /><span class="line">        <span class="comment">// &lt;3.2&gt; å¦‚æœæ•°ç»„ä¸ºç©ºï¼Œè¿”å›ç©ºæ•°ç»„</span></span><br /><span class="line">        <span class="keyword">if</span> (loaded.isEmpty()) {</span><br /><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// &lt;3.3&gt; å°† Map æ•°ç»„ï¼Œå°è£…æˆ OriginTrackedMapPropertySource æ•°ç»„ï¼Œè¿”å›</span></span><br /><span class="line">        List&lt;PropertySource&lt;?&gt;&gt; propertySources = <span class="keyword">new</span> ArrayList&lt;&gt;(loaded.size());</span><br /><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; loaded.size(); i++) {</span><br /><span class="line">            String documentNumber = (loaded.size() != <span class="number">1</span>) ? <span class="string">" (document #"</span> + i + <span class="string">")"</span> : <span class="string">""</span>;</span><br /><span class="line">            propertySources.add(<span class="keyword">new</span> OriginTrackedMapPropertySource(name + documentNumber, loaded.get(i)));</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span> propertySources;</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè¿”å›å¯å¤„ç†çš„æ–‡ä»¶ç±»å‹ï¼Œä¸º&nbsp;<code>yaml</code>&nbsp;å’Œ&nbsp;<code>yml</code>&nbsp;ã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œå¦‚æœä¸å­˜åœ¨&nbsp;<code>org.yaml.snakeyaml.Yaml</code>&nbsp;ç±»ï¼Œè¯´æ˜æ²¡æœ‰å¼•å…¥ snakeyaml ä¾èµ–ï¼Œåˆ™æŠ›å‡º IllegalStateException å¼‚å¸¸ã€‚</li>
<li><code>&lt;3.1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>OriginTrackedYamlLoader#load()</code>&nbsp;æ–¹æ³•ï¼ŒåŠ è½½é…ç½®ï¼Œè¿”å› Map æ•°ç»„ã€‚ğŸ˜ˆ å“å“Ÿï¼Œæ­¤å¤„å°±æ˜¯æˆ‘ä»¬çš„å¥½å¥‡äº†ï¼Œè¿”å›çš„æ˜¯ Map æ•°ç»„åˆ—ï¼æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹&nbsp;<a href="https://blog.csdn.net/yy756127197/article/details/78193398" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠSpring Boot ä½¿ç”¨ YML æ–‡ä»¶é…ç½®å¤šç¯å¢ƒã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Spring-Boot/properties-load/">ã€Œ1 ä¸€ä¸ªymlæ–‡ä»¶ã€</a>&nbsp;ï¼Œæ¯ä¸ª&nbsp;<code>----</code>&nbsp;åˆ†å‰²çº¿ï¼Œä¼šè§£ææˆä¸€ä¸ªå¯¹åº”çš„&nbsp;<code>Map&lt;String, Object&gt;</code>&nbsp;å¯¹è±¡ã€‚</li>
<li><code>&lt;3.2&gt;</code>&nbsp;å¤„ï¼Œå¦‚æœ Map æ•°ç»„ä¸ºç©ºï¼Œè¿”å›ç©ºæ•°ç»„ã€‚</li>
<li><code>&lt;3.3&gt;</code>&nbsp;å¤„ï¼Œå°† Map æ•°ç»„ï¼Œå°è£…æˆ OriginTrackedMapPropertySource æ•°ç»„ï¼Œç„¶åè¿”å›ã€‚</li>
</ul>
<h1 id="666-å½©è›‹">666. å½©è›‹</h1>
<p>å§æ§½ï¼ŒçœŸå¿ƒæ˜¯å†…å¿ƒæ— æ¯”å§æ§½ã€‚æ¯”æˆ‘é¢„å…ˆçš„ï¼Œé•¿å¤ªå¤ªå¤ªå¤šäº†ã€‚</p>
<p>å¦‚æœæœ‰è§£é‡Šä¸åˆ°ä½çš„åœ°æ–¹ï¼Œéº»çƒ¦èƒ–å‹åœ¨æ˜Ÿçƒæå‡ºä¸‹å“Ÿã€‚hoho ï¼Œæ˜¥èŠ‚æœŸé—´åˆäºŒï¼Œåœ¨è€å®¶å†™å®Œ~</p>
<p>å‚è€ƒå’Œæ¨èå¦‚ä¸‹æ–‡ç« ï¼š</p>
<ul>
<li>oldflame-Jm&nbsp;<a href="https://blog.csdn.net/jamet/article/details/77508182" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠSpring bootæºç åˆ†æ-profilesç¯å¢ƒï¼ˆ4ï¼‰ã€‹</a></li>
<li>oldflame-Jm&nbsp;<a href="https://blog.csdn.net/jamet/article/details/78042486" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠSpring bootæºç åˆ†æ-ApplicationListeneråº”ç”¨ç¯å¢ƒï¼ˆ5ï¼‰ã€‹</a></li>
<li>youzhibing2904&nbsp;<a href="https://www.cnblogs.com/youzhibing/p/9622441.html" target="_blank" rel="external nofollow noopener noreferrer">ã€Šspring-boot-2.0.3ä¸ä¸€æ ·ç³»åˆ—ä¹‹æºç ç¯‡ - runæ–¹æ³•ï¼ˆäºŒï¼‰ä¹‹prepareEnvironmentï¼Œç»å¯¹æœ‰å€¼å¾—ä½ çœ‹çš„åœ°æ–¹ã€‹</a></li>
</ul>
<hr />
<p>å¦‚ä¸‹å†…å®¹ï¼Œæ˜¯è‰¿è‰¿çš„è‰ç¨¿ï¼Œèƒ–å‹å¯ä»¥å…ˆä¸å»äº†è§£ã€‚</p>
<p>å‡è®¾ Profile ä¸º&nbsp;<code>prod,dev</code>&nbsp;ã€‚è¯»å–ç»“æœå¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å¦‚ä¸‹è¿‡ç¨‹ï¼Œçœç•¥è¯»å–ä¸åˆ°é…ç½®æ–‡ä»¶çš„æƒ…å†µã€‚</p>
</blockquote>
<ul>
<li>getPositiveProfileFilter çš„æƒ…å†µ
<ul>
<li><code>profile=null</code>&nbsp;éƒ¨åˆ†
<ul>
<li>è¯»å–&nbsp;<code>classpath:/application.properties</code>&nbsp;ï¼ŒåŒ¹é…æˆåŠŸã€‚</li>
<li>è¯»å–&nbsp;<code>classpath:/application.yaml</code>&nbsp;ï¼ŒåŒ¹é…æˆåŠŸã€‚</li>
</ul>
</li>
<li><code>profile=prod</code>
<ul>
<li>è¯»å–&nbsp;<code>classpath:/application-prod.properties</code>&nbsp;ï¼ŒåŒ¹é…æˆåŠŸï¼ˆåŸºäº&nbsp;<code>defaultFilter</code>ï¼‰ã€‚</li>
<li>è¯»å–&nbsp;<code>classpath:/application-prod.properties</code>&nbsp;ï¼ŒåŒ¹é…å¤±è´¥ï¼ˆåŸºäº&nbsp;<code>profileFilter</code>ï¼‰ã€‚</li>
<li>è¯»å–&nbsp;<code>classpath:/application-prod.properties</code>&nbsp;ï¼ŒåŒ¹é…å¤±è´¥ï¼ˆåŸºäº&nbsp;<code>profileFilter</code>ï¼‰ã€‚</li>
<li>è¯»å–&nbsp;<code>classpath:/application.yaml</code>&nbsp;ï¼ŒåŒ¹é…å¤±è´¥ï¼ˆåŸºäº&nbsp;<code>profileFilter</code>ï¼‰ã€‚ã€åŒ¹é…ä¸Š prod é‚£éƒ¨åˆ†ã€‘</li>
</ul>
</li>
<li><code>profile=dev</code>
<ul>
<li>è¯»å–&nbsp;<code>classpath:/application-dev.properties</code>&nbsp;ï¼ŒåŒ¹é…æˆåŠŸï¼ˆåŸºäº&nbsp;<code>defaultFilter</code>ï¼‰ã€‚</li>
<li>è¯»å–&nbsp;<code>classpath:/application-dev.properties</code>&nbsp;ï¼ŒåŒ¹é…å¤±è´¥ï¼ˆåŸºäº&nbsp;<code>profileFilter</code>ï¼‰ã€‚</li>
<li>è¯»å–&nbsp;<code>classpath:/application-dev.properties</code>&nbsp;ï¼ŒåŒ¹é…å¤±è´¥ï¼ˆåŸºäº&nbsp;<code>profileFilter</code>ï¼‰ã€‚</li>
<li>è¯»å–&nbsp;<code>classpath:/application.yaml</code>&nbsp;ï¼ŒåŒ¹é…å¤±è´¥ï¼ˆåŸºäº&nbsp;<code>profileFilter</code>ï¼‰ã€‚ã€åŒ¹é…ä¸Š dev é‚£éƒ¨åˆ†ã€‘</li>
</ul>
</li>
</ul>
</li>
<li>getNegativeProfileFilter çš„æƒ…å†µ
<ul>
<li><code>profile=null</code>&nbsp;éƒ¨åˆ†
<ul>
<li>è¯»å–&nbsp;<code>classpath:/application.properties</code>&nbsp;ï¼ŒåŒ¹é…å¤±è´¥ã€‚</li>
<li>ğŸ™‚ğŸ™‚ğŸ™‚ è¯»å–&nbsp;<code>classpath:/application.yaml</code>&nbsp;ï¼ŒåŒ¹é…æˆåŠŸã€åŒ¹é…ä¸Š prodã€dev é‚£éƒ¨åˆ†ã€‘ã€‚æ¯”è¾ƒæœ‰æ„æ€ ğŸ˜ˆ ï¼Œç”¨äºè§£å†³&nbsp;<code>profile=null</code>&nbsp;çš„æƒ…å†µï¼Œå¯ä»¥æŠŠæ¿€æ´»çš„ Profile ï¼Œä¹ŸåŒ¹é…ä¸Šã€‚ä½†æ˜¯åœ¨ç›®å‰è¿™ä¸ªæƒ…å†µä¸‹ï¼Œå³ä½¿åŒ¹é…ä¸Šï¼Œåœ¨&nbsp;<code>#addToLoaded(...)</code>&nbsp;æ–¹æ³•ä¸­çš„ DocumentConsumer çš„é€»è¾‘æ—¶ï¼Œä¼šåœ¨&nbsp;<code>checkForExisting</code>&nbsp;é‚£å—çš„é€»è¾‘ï¼Œå¦‚æœè¦æ ¡éªŒå·²ç»å­˜åœ¨çš„æƒ…å†µï¼Œåˆ™å¦‚æœå·²ç»å­˜åœ¨ï¼Œåˆ™ç›´æ¥&nbsp;<code>return</code>&nbsp;è¢«æ’é™¤æ‰ã€‚å› ä¸ºåœ¨&nbsp;<code>profile=prod</code>&nbsp;å’Œ&nbsp;<code>profile=dev</code>&nbsp;éƒ¨åˆ†ï¼Œå·²ç»åŒ¹é…ä¸Šè¯¥éƒ¨åˆ†çš„é…ç½®ã€‚
<ul>
<li>= =~å½“ç„¶ï¼Œå®åœ¨æä¸æ‡‚è¿™ä¸ªé€»è¾‘ï¼Œä¹Ÿä¸ç”¨çº ç»“è¿™ä¸ªã€‚é‡ç‚¹æ˜¯ææ‡‚ Spring Boot åŠ è½½é…ç½®çš„æ ¸å¿ƒé€»è¾‘ã€‚ä¹Ÿå°±æ˜¯ï¼ŒConfigFileApplicationListener æ•´ä½“çš„é€»è¾‘ã€‚</li>
<li>è‰¿è‰¿åˆæ€è€ƒäº†ä¸‹ï¼Œè²Œä¼¼çªç„¶ä¹Ÿæœ‰ç‚¹æƒ³ä¸é€šï¼Œä»€ä¹ˆæƒ…å†µä¸‹ï¼Œè¿™å—é€»è¾‘ä¼šæˆåŠŸåŠ è½½åˆ° Profile ä¸åŒ¹é…çš„é…ç½®æ–‡ä»¶ï¼Œå³åœ¨åœ¨&nbsp;<code>#addToLoaded(...)</code>&nbsp;æ–¹æ³•ä¸­çš„ DocumentConsumer çš„é€»è¾‘æ—¶ï¼Œä¼šåœ¨&nbsp;<code>checkForExisting</code>&nbsp;é‚£å—çš„é€»è¾‘ï¼Œå¦‚æœè¦æ ¡éªŒå·²ç»å­˜åœ¨çš„æƒ…å†µï¼Œåˆ™å¦‚æœä¸å­˜åœ¨ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>