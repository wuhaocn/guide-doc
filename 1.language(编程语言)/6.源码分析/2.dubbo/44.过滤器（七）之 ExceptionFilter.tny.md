<header class="article-header">
<h1 class="article-title">è¿‡æ»¤å™¨ï¼ˆä¸ƒï¼‰ä¹‹ ExceptionFilter</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡åˆ†äº«å¼‚å¸¸è¿‡æ»¤å™¨ ExceptionFilter ï¼Œç”¨äºæœåŠ¡<strong>æä¾›è€…</strong>ä¸­ã€‚ç”¨é€”å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>FROM ExceptionFilter ä¸Šçš„æ³¨é‡Šï¼š</p>
<ol>
<li>ä¸æœŸæœ›çš„å¼‚å¸¸æ‰“ ERROR æ—¥å¿—( Providerç«¯ )ã€‚ä¸æœŸæœ›çš„æ—¥å¿—å³æ˜¯ï¼Œæ²¡æœ‰çš„æ¥å£ä¸Šå£°æ˜çš„Uncheckedå¼‚å¸¸ã€‚</li>
<li>å¼‚å¸¸ä¸åœ¨ API åŒ…ä¸­ï¼Œåˆ™ Wrap ä¸€å±‚ RuntimeException ã€‚RPC å¯¹äºç¬¬ä¸€å±‚å¼‚å¸¸ä¼šç›´æ¥åºåˆ—åŒ–ä¼ è¾“( Cause å¼‚å¸¸ä¼š String åŒ–) ï¼Œé¿å…å¼‚å¸¸åœ¨ Client å‡ºä¸èƒ½<strong>ååºåˆ—åŒ–</strong>é—®é¢˜ã€‚</li>
</ol>
</blockquote>
<p>ğŸ™‚ å’Œæˆ‘ä»¬å¹³æ—¶ä¸šåŠ¡å†™çš„ç”¨äº<strong>æ•æ‰å¼‚å¸¸</strong>çš„è¿‡æ»¤å™¨æˆ–è€…æ‹¦æˆªå™¨<strong>ä¸å¤ªä¸€æ ·</strong>ï¼Œè€Œæ˜¯å…³æ³¨ç‚¹åœ¨æœåŠ¡æ¶ˆè´¹è€…ä¼šä¸ä¼šå‡ºç°ä¸å­˜åœ¨è¯¥å¼‚å¸¸ç±»ï¼Œå¯¼è‡´ååºåˆ—åŒ–çš„é—®é¢˜ã€‚</p>
<h1 id="2-ExceptionFilter">2. ExceptionFilter</h1>
<p><code>com.alibaba.dubbo.rpc.filter.ExceptionFilter</code>&nbsp;ï¼Œå®ç° Filter æ¥å£ï¼Œå¼‚å¸¸è¿‡æ»¤å™¨å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Activate</span>(group = Constants.PROVIDER)</span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>{</span><br /><span class="line"> <span class="number">3</span>: </span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Logger logger;</span><br /><span class="line"> <span class="number">5</span>: </span><br /><span class="line"> <span class="number">6</span>:     <span class="function"><span class="keyword">public</span> <span class="title">ExceptionFilter</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">7</span>:         <span class="keyword">this</span>(LoggerFactory.getLogger(ExceptionFilter.class));</span><br /><span class="line"> <span class="number">8</span>:     }</span><br /><span class="line"> <span class="number">9</span>: </span><br /><span class="line"><span class="number">10</span>:     <span class="function"><span class="keyword">public</span> <span class="title">ExceptionFilter</span><span class="params">(Logger logger)</span> </span>{</span><br /><span class="line"><span class="number">11</span>:         <span class="keyword">this</span>.logger = logger;</span><br /><span class="line"><span class="number">12</span>:     }</span><br /><span class="line"><span class="number">13</span>: </span><br /><span class="line"><span class="number">14</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">15</span>:     <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"><span class="number">16</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">17</span>:             <span class="comment">// æœåŠ¡è°ƒç”¨</span></span><br /><span class="line"><span class="number">18</span>:             Result result = invoker.invoke(invocation);</span><br /><span class="line"><span class="number">19</span>:             <span class="comment">// æœ‰å¼‚å¸¸ï¼Œå¹¶ä¸”éæ³›åŒ–è°ƒç”¨</span></span><br /><span class="line"><span class="number">20</span>:             <span class="keyword">if</span> (result.hasException() &amp;&amp; GenericService.class != invoker.getInterface()) {</span><br /><span class="line"><span class="number">21</span>:                 <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">22</span>:                     Throwable exception = result.getException();</span><br /><span class="line"><span class="number">23</span>: </span><br /><span class="line"><span class="number">24</span>:                     <span class="comment">// directly throw if it's checked exception</span></span><br /><span class="line"><span class="number">25</span>:                     <span class="comment">// å¦‚æœæ˜¯checkedå¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º</span></span><br /><span class="line"><span class="number">26</span>:                     <span class="keyword">if</span> (!(exception <span class="keyword">instanceof</span> RuntimeException) &amp;&amp; (exception <span class="keyword">instanceof</span> Exception)) {</span><br /><span class="line"><span class="number">27</span>:                         <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">28</span>:                     }</span><br /><span class="line"><span class="number">29</span>:                     <span class="comment">// directly throw if the exception appears in the signature</span></span><br /><span class="line"><span class="number">30</span>:                     <span class="comment">// åœ¨æ–¹æ³•ç­¾åä¸Šæœ‰å£°æ˜ï¼Œç›´æ¥æŠ›å‡º</span></span><br /><span class="line"><span class="number">31</span>:                     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">32</span>:                         Method method = invoker.getInterface().getMethod(invocation.getMethodName(), invocation.getParameterTypes());</span><br /><span class="line"><span class="number">33</span>:                         Class&lt;?&gt;[] exceptionClassses = method.getExceptionTypes();</span><br /><span class="line"><span class="number">34</span>:                         <span class="keyword">for</span> (Class&lt;?&gt; exceptionClass : exceptionClassses) {</span><br /><span class="line"><span class="number">35</span>:                             <span class="keyword">if</span> (exception.getClass().equals(exceptionClass)) {</span><br /><span class="line"><span class="number">36</span>:                                 <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">37</span>:                             }</span><br /><span class="line"><span class="number">38</span>:                         }</span><br /><span class="line"><span class="number">39</span>:                     } <span class="keyword">catch</span> (NoSuchMethodException e) {</span><br /><span class="line"><span class="number">40</span>:                         <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">41</span>:                     }</span><br /><span class="line"><span class="number">42</span>: </span><br /><span class="line"><span class="number">43</span>:                     <span class="comment">// æœªåœ¨æ–¹æ³•ç­¾åä¸Šå®šä¹‰çš„å¼‚å¸¸ï¼Œåœ¨æœåŠ¡å™¨ç«¯æ‰“å° ERROR æ—¥å¿—</span></span><br /><span class="line"><span class="number">44</span>:                     <span class="comment">// for the exception not found in method's signature, print ERROR message in server's log.</span></span><br /><span class="line"><span class="number">45</span>:                     logger.error(<span class="string">"Got unchecked and undeclared exception which called by "</span> + RpcContext.getContext().getRemoteHost()</span><br /><span class="line"><span class="number">46</span>:                             + <span class="string">". service: "</span> + invoker.getInterface().getName() + <span class="string">", method: "</span> + invocation.getMethodName()</span><br /><span class="line"><span class="number">47</span>:                             + <span class="string">", exception: "</span> + exception.getClass().getName() + <span class="string">": "</span> + exception.getMessage(), exception);</span><br /><span class="line"><span class="number">48</span>: </span><br /><span class="line"><span class="number">49</span>:                     <span class="comment">// å¼‚å¸¸ç±»å’Œæ¥å£ç±»åœ¨åŒä¸€ jar åŒ…é‡Œï¼Œç›´æ¥æŠ›å‡º</span></span><br /><span class="line"><span class="number">50</span>:                     <span class="comment">// directly throw if exception class and interface class are in the same jar file.</span></span><br /><span class="line"><span class="number">51</span>:                     String serviceFile = ReflectUtils.getCodeBase(invoker.getInterface());</span><br /><span class="line"><span class="number">52</span>:                     String exceptionFile = ReflectUtils.getCodeBase(exception.getClass());</span><br /><span class="line"><span class="number">53</span>:                     <span class="keyword">if</span> (serviceFile == <span class="keyword">null</span> || exceptionFile == <span class="keyword">null</span> || serviceFile.equals(exceptionFile)) {</span><br /><span class="line"><span class="number">54</span>:                         <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">55</span>:                     }</span><br /><span class="line"><span class="number">56</span>:                     <span class="comment">// æ˜¯JDKè‡ªå¸¦çš„å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º</span></span><br /><span class="line"><span class="number">57</span>:                     <span class="comment">// directly throw if it's JDK exception</span></span><br /><span class="line"><span class="number">58</span>:                     String className = exception.getClass().getName();</span><br /><span class="line"><span class="number">59</span>:                     <span class="keyword">if</span> (className.startsWith(<span class="string">"java."</span>) || className.startsWith(<span class="string">"javax."</span>)) {</span><br /><span class="line"><span class="number">60</span>:                         <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">61</span>:                     }</span><br /><span class="line"><span class="number">62</span>:                     <span class="comment">// æ˜¯Dubboæœ¬èº«çš„å¼‚å¸¸ï¼Œç›´æ¥æŠ›å‡º</span></span><br /><span class="line"><span class="number">63</span>:                     <span class="comment">// directly throw if it's dubbo exception</span></span><br /><span class="line"><span class="number">64</span>:                     <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> RpcException) {</span><br /><span class="line"><span class="number">65</span>:                         <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">66</span>:                     }</span><br /><span class="line"><span class="number">67</span>: </span><br /><span class="line"><span class="number">68</span>:                     <span class="comment">// å¦åˆ™ï¼ŒåŒ…è£…æˆRuntimeExceptionæŠ›ç»™å®¢æˆ·ç«¯</span></span><br /><span class="line"><span class="number">69</span>:                     <span class="comment">// otherwise, wrap with RuntimeException and throw back to the client</span></span><br /><span class="line"><span class="number">70</span>:                     <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(<span class="keyword">new</span> RuntimeException(StringUtils.toString(exception)));</span><br /><span class="line"><span class="number">71</span>:                 } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">72</span>:                     logger.warn(<span class="string">"Fail to ExceptionFilter when called by "</span> + RpcContext.getContext().getRemoteHost()</span><br /><span class="line"><span class="number">73</span>:                             + <span class="string">". service: "</span> + invoker.getInterface().getName() + <span class="string">", method: "</span> + invocation.getMethodName()</span><br /><span class="line"><span class="number">74</span>:                             + <span class="string">", exception: "</span> + e.getClass().getName() + <span class="string">": "</span> + e.getMessage(), e);</span><br /><span class="line"><span class="number">75</span>:                     <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">76</span>:                 }</span><br /><span class="line"><span class="number">77</span>:             }</span><br /><span class="line"><span class="number">78</span>:             <span class="comment">// è¿”å›</span></span><br /><span class="line"><span class="number">79</span>:             <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">80</span>:         } <span class="keyword">catch</span> (RuntimeException e) {</span><br /><span class="line"><span class="number">81</span>:             logger.error(<span class="string">"Got unchecked and undeclared exception which called by "</span> + RpcContext.getContext().getRemoteHost()</span><br /><span class="line"><span class="number">82</span>:                     + <span class="string">". service: "</span> + invoker.getInterface().getName() + <span class="string">", method: "</span> + invocation.getMethodName()</span><br /><span class="line"><span class="number">83</span>:                     + <span class="string">", exception: "</span> + e.getClass().getName() + <span class="string">": "</span> + e.getMessage(), e);</span><br /><span class="line"><span class="number">84</span>:             <span class="keyword">throw</span> e;</span><br /><span class="line"><span class="number">85</span>:         }</span><br /><span class="line"><span class="number">86</span>:     }</span><br /><span class="line"><span class="number">87</span>: </span><br /><span class="line"><span class="number">88</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 18 è¡Œï¼šè°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚</li>
<li>ç¬¬ 21 è¡Œï¼šè°ƒç”¨ç»“æœæœ‰å¼‚å¸¸ï¼Œå¹¶ä¸”é<strong>æ³›åŒ–è°ƒç”¨</strong>ã€‚</li>
<li>ç¬¬ 24 è‡³ 28 è¡Œï¼šå¦‚æœæ˜¯ checked å¼‚å¸¸ï¼Œç›´æ¥è¿”å›ã€‚å› ä¸ºï¼Œchecked å¼‚å¸¸ï¼Œè‚¯å®šå®šä¹‰åœ¨æ¥å£ä¸Šäº†ã€‚</li>
<li>ç¬¬ 29 è‡³ 41 è¡Œï¼šåœ¨æ¥å£æ–¹æ³•çš„ç­¾åæœ‰ç”Ÿå‘½ï¼Œç›´æ¥è¿”å›ç»“æœã€‚</li>
<li>ç¬¬ 45 è‡³ 47 è¡Œï¼šæœªåœ¨æ–¹æ³•ç­¾åä¸Šå®šä¹‰çš„å¼‚å¸¸ï¼Œåœ¨æœåŠ¡å™¨ç«¯æ‰“å° ERROR æ—¥å¿—ã€‚</li>
<li>
<p>ç¬¬ 49 è‡³ 55 è¡Œï¼šå¼‚å¸¸ç±»å’Œæ¥å£ç±»åœ¨åŒä¸€&nbsp;<strong>jar</strong>&nbsp;åŒ…é‡Œï¼Œç›´æ¥è¿”å›ç»“æœã€‚å› ä¸ºï¼ŒæœåŠ¡æ¶ˆè´¹è€…å¯ä»¥ååºåˆ—åŒ–è¯¥å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getCodeBase</span><span class="params">(Class&lt;?&gt; cls)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (cls == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">    }</span><br /><span class="line">    ProtectionDomain domain = cls.getProtectionDomain();</span><br /><span class="line">    <span class="keyword">if</span> (domain == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">    }</span><br /><span class="line">    CodeSource source = domain.getCodeSource();</span><br /><span class="line">    <span class="keyword">if</span> (source == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">    }</span><br /><span class="line">    URL location = source.getLocation();</span><br /><span class="line">    <span class="keyword">if</span> (location == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> location.getFile();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 56 è‡³ 61 è¡Œï¼šæ˜¯ JDK è‡ªå¸¦çš„å¼‚å¸¸ï¼Œç›´æ¥è¿”å›ç»“æœã€‚</p>
</li>
<li>ç¬¬ 62 è‡³ 66 è¡Œï¼šæ˜¯ Dubbo æœ¬èº«çš„å¼‚å¸¸ï¼Œç›´æ¥è¿”å›ç»“æœã€‚</li>
<li>
<p>ç¬¬ 70 è¡Œï¼šå¦åˆ™ï¼ŒåŒ…è£…æˆ RuntimeException å¼‚å¸¸è¿”å›ç»™æœåŠ¡æ¶ˆè´¹è€…ï¼ŒåŒæ—¶æŠŠå¼‚å¸¸å †æ ˆç»™åŒ…è¿›å»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">toString</span><span class="params">(Throwable e)</span> </span>{</span><br /><span class="line">    UnsafeStringWriter w = <span class="keyword">new</span> UnsafeStringWriter();</span><br /><span class="line">    PrintWriter p = <span class="keyword">new</span> PrintWriter(w);</span><br /><span class="line">    p.print(e.getClass().getName());</span><br /><span class="line">    <span class="keyword">if</span> (e.getMessage() != <span class="keyword">null</span>) {</span><br /><span class="line">        p.print(<span class="string">": "</span> + e.getMessage());</span><br /><span class="line">    }</span><br /><span class="line">    p.println();</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        e.printStackTrace(p);</span><br /><span class="line">        <span class="keyword">return</span> w.toString();</span><br /><span class="line">    } <span class="keyword">finally</span> {</span><br /><span class="line">        p.close();</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<h1 id="666-å½©è›‹">666. å½©è›‹</h1>
<p>ğŸ˜œ ä¸€å¼€å§‹æƒ³é”™äº†ï¼Œæ€ªä¸å¾—è§‰å¾—å¥½å¥‡æ€ªã€‚</p>
<p>å¦å¤–ï¼Œç¬”è€…æœ‰ä¸ªæƒ³æ³•ã€‚æˆ‘ä»¬åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œå¯èƒ½ä¼šå®šä¹‰é€šç”¨çš„ BusinessException ï¼Œå¹¶ä¸”æ¯ä¸ªæ¥å£ï¼Œå®é™…éƒ½ä¼šæŠ›å‡ºè¯¥å¼‚å¸¸ã€‚é‚£ä¹ˆè¦æ±‚å¼€å‘æ¯ä¸ªæ¥å£éƒ½å®šä¹‰æŠ›å‡º BusinessException æ˜¯æ¯”è¾ƒ&ldquo;éº»çƒ¦&rdquo;çš„ã€‚<br />ä½†æ˜¯ï¼ŒæŒ‰ç…§ ExceptionFilter çš„é€»è¾‘ï¼Œä¼šæ‰“å°å¼‚å¸¸æ—¥å¿—ã€‚<br />æ‰€ä»¥ï¼Œç¬”è€…çš„æƒ³æ³•æ˜¯ï¼Œé‡å†™ ExceptionFilter ï¼Œå®šä¹‰ä¸€äº›é€šç”¨å¼‚å¸¸ï¼Œå…è®¸ç›´æ¥è¿”å›ç»“æœã€‚ğŸ™‚</p>
</div>