<header class="article-header">
<h1 class="article-title">æœåŠ¡è°ƒç”¨ï¼ˆäº”ï¼‰ä¹‹è¿œç¨‹è°ƒç”¨ï¼ˆWebServiceï¼‰</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡ï¼Œæˆ‘ä»¬åˆ†äº«&nbsp;<code>webservice://</code>&nbsp;åè®®çš„è¿œç¨‹è°ƒç”¨ï¼Œä¸»è¦åˆ†æˆ<strong>ä¸‰ä¸ªéƒ¨åˆ†</strong>ï¼š</p>
<ul>
<li>æœåŠ¡æš´éœ²</li>
<li>æœåŠ¡å¼•ç”¨</li>
<li>æœåŠ¡è°ƒç”¨</li>
</ul>
<p>å¯¹åº”é¡¹ç›®ä¸º&nbsp;<code>dubbo-rpc-webservice</code>&nbsp;ã€‚</p>
<p>å¯¹åº”æ–‡æ¡£ä¸º&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/webservice.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; webservice://ã€‹</a>&nbsp;ã€‚å®šä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>åŸºäº WebService çš„è¿œç¨‹è°ƒç”¨åè®®ï¼ŒåŸºäº&nbsp;<a href="http://cxf.apache.org/" target="_blank" rel="external nofollow noopener noreferrer">Apache CXF</a>&nbsp;çš„ frontend-simple å’Œ transports-http å®ç°ã€‚</p>
</blockquote>
<blockquote>
<p>å¯ä»¥å’ŒåŸç”Ÿ WebService æœåŠ¡äº’æ“ä½œï¼Œå³ï¼š</p>
<ul>
<li>æä¾›è€…ç”¨ Dubbo çš„ WebService åè®®æš´éœ²æœåŠ¡ï¼Œæ¶ˆè´¹è€…ç›´æ¥ç”¨æ ‡å‡† WebService æ¥å£è°ƒç”¨ï¼Œ</li>
<li>æˆ–è€…æä¾›æ–¹ç”¨æ ‡å‡† WebService æš´éœ²æœåŠ¡ï¼Œæ¶ˆè´¹æ–¹ç”¨ Dubbo çš„ WebService åè®®è°ƒç”¨ã€‚</li>
</ul>
</blockquote>
<p>æœ¬æ–‡æ¶‰åŠç±»å›¾ï¼ˆçº¢åœˆéƒ¨åˆ†ï¼‰å¦‚ä¸‹ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_10_16/01.png" alt="ç±»å›¾" /></p>
<blockquote>
<p>æ—ç™½å›ï¼šæ•´ä½“å®ç°å’Œ&nbsp;<code>dubbo-rpc-http</code>&nbsp;ä¸€è‡´ï¼Œæ‰€ä»¥å†…å®¹ä¸Šå’Œ&nbsp;<a href="http://svip.iocoder.cn/Dubbo/rpc-http/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡è°ƒç”¨ï¼ˆä¸‰ï¼‰ä¹‹è¿œç¨‹è°ƒç”¨ï¼ˆHTTPï¼‰ã€‹</a>&nbsp;å·®ä¸å¤šã€‚</p>
</blockquote>
<h1 id="2-WebServiceProtocol">2. WebServiceProtocol</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-rpc/dubbo-rpc-webservice/src/main/java/com/alibaba/dubbo/rpc/protocol/webservice/WebServiceProtocol.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.rpc.protocol.webservice.WebServiceProtocol</code></a>&nbsp;ï¼Œå®ç° AbstractProxyProtocol æŠ½è±¡ç±»ï¼Œ<code>webservice://</code>&nbsp;åè®®å®ç°ç±»ã€‚</p>
<h2 id="2-1-æ„é€ æ–¹æ³•">2.1 æ„é€ æ–¹æ³•</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é»˜è®¤æœåŠ¡å™¨ç«¯å£</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_PORT = <span class="number">80</span>;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Http æœåŠ¡å™¨é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * keyï¼šip:port</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, HttpServer&gt; serverMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, HttpServer&gt;();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ã€Šæˆ‘çœ¼ä¸­çš„CXFä¹‹Busã€‹http://jnn.iteye.com/blog/94746</span></span><br /><span class="line"><span class="comment"> * ã€ŠCXF BUSã€‹https://blog.csdn.net/chen_fly2011/article/details/56664908</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ExtensionManagerBus bus = <span class="keyword">new</span> ExtensionManagerBus();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HTTPTransportFactory transportFactory = <span class="keyword">new</span> HTTPTransportFactory();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * HttpBinder$Adaptive å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> HttpBinder httpBinder;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">WebServiceProtocol</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">super</span>(Fault.class);</span><br /><span class="line">    bus.setExtension(<span class="keyword">new</span> ServletDestinationFactory(), HttpDestinationFactory.class);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHttpBinder</span><span class="params">(HttpBinder httpBinder)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.httpBinder = httpBinder;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>serverMap</code>&nbsp;å±æ€§ï¼ŒHttpServer é›†åˆã€‚é”®ä¸º&nbsp;<code>ip:port</code>&nbsp;ï¼Œé€šè¿‡&nbsp;<code>#getAddr(url)</code>&nbsp;æ–¹æ³•ï¼Œè®¡ç®—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// AbstractProxyProtocol.java</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getAddr</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    String bindIp = url.getParameter(Constants.BIND_IP_KEY, url.getHost());</span><br /><span class="line">    <span class="keyword">if</span> (url.getParameter(Constants.ANYHOST_KEY, <span class="keyword">false</span>)) {</span><br /><span class="line">        bindIp = Constants.ANYHOST_VALUE;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> NetUtils.getIpByHost(bindIp) + <span class="string">":"</span> + url.getParameter(Constants.BIND_PORT_KEY, url.getPort());</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>skeletonMap</code>&nbsp;å±æ€§ï¼Œ<code>com.caucho.hessian.server.HessianSkeleton</code>&nbsp;é›†åˆã€‚è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸º&nbsp;<code>HttpServer =&gt; DispatcherServlet =&gt; WebServiceHandler =&gt; ServletController</code>&nbsp;ã€‚</p>
</li>
<li><code>httpBinder</code>&nbsp;å±æ€§ï¼ŒHttpBinder$Adaptive å¯¹è±¡ï¼Œé€šè¿‡&nbsp;<code>#setHttpBinder(httpBinder)</code>&nbsp;æ–¹æ³•ï¼ŒDubbo SPI è°ƒç”¨è®¾ç½®ã€‚</li>
<li><code>rpcExceptions = Fault.class</code>&nbsp;ã€‚</li>
<li><code>bus</code>&nbsp;å’Œ&nbsp;<code>transportFactory</code>&nbsp;å±æ€§ï¼Œå¯ä»¥å‚çœ‹å¦‚ä¸‹æ–‡ç« ï¼š
<ul>
<li><a href="http://jnn.iteye.com/blog/94746" target="_blank" rel="external nofollow noopener noreferrer">ã€Šæˆ‘çœ¼ä¸­çš„CXFä¹‹Busã€‹</a></li>
<li><a href="https://blog.csdn.net/chen_fly2011/article/details/56664908" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠCXF BUSã€‹</a></li>
</ul>
</li>
<li>ğŸ™‚ è‰¿è‰¿å¯¹ Apache CXF äº†è§£ä¸å¤šï¼Œæ‰€ä»¥æœ¬æ–‡æ›´å¤šæ¢³ç†å¥½æ•´ä½“è„‰ç»œã€‚</li>
</ul>
<h2 id="2-2-doExport">2.2 doExport</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">protected</span> &lt;T&gt; <span class="function">Runnable <span class="title">doExport</span><span class="params">(T impl, Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// è·å¾—æœåŠ¡å™¨åœ°å€</span></span><br /><span class="line"> <span class="number">4</span>:     String addr = getAddr(url);</span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// è·å¾— HttpServer å¯¹è±¡ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿›è¡Œåˆ›å»ºã€‚</span></span><br /><span class="line"> <span class="number">6</span>:     HttpServer httpServer = serverMap.get(addr);</span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (httpServer == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">8</span>:         httpServer = httpBinder.bind(url, <span class="keyword">new</span> WebServiceHandler()); <span class="comment">// WebServiceHandler</span></span><br /><span class="line"> <span class="number">9</span>:         serverMap.put(addr, httpServer);</span><br /><span class="line"><span class="number">10</span>:     }</span><br /><span class="line"><span class="number">11</span>:     <span class="comment">// åˆ›å»º ServerFactoryBean å¯¹è±¡</span></span><br /><span class="line"><span class="number">12</span>:     <span class="keyword">final</span> ServerFactoryBean serverFactoryBean = <span class="keyword">new</span> ServerFactoryBean();</span><br /><span class="line"><span class="number">13</span>:     serverFactoryBean.setAddress(url.getAbsolutePath());</span><br /><span class="line"><span class="number">14</span>:     serverFactoryBean.setServiceClass(type);</span><br /><span class="line"><span class="number">15</span>:     serverFactoryBean.setServiceBean(impl);</span><br /><span class="line"><span class="number">16</span>:     serverFactoryBean.setBus(bus);</span><br /><span class="line"><span class="number">17</span>:     serverFactoryBean.setDestinationFactory(transportFactory);</span><br /><span class="line"><span class="number">18</span>:     serverFactoryBean.create();</span><br /><span class="line"><span class="number">19</span>:     <span class="comment">// è¿”å›å–æ¶ˆæš´éœ²çš„å›è°ƒ Runnable</span></span><br /><span class="line"><span class="number">20</span>:     <span class="keyword">return</span> <span class="keyword">new</span> Runnable() {</span><br /><span class="line"><span class="number">21</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">22</span>:             serverFactoryBean.destroy();</span><br /><span class="line"><span class="number">23</span>:         }</span><br /><span class="line"><span class="number">24</span>:     };</span><br /><span class="line"><span class="number">25</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>åŸºäº&nbsp;<code>dubbo-remoting-http</code>&nbsp;é¡¹ç›®ï¼Œä½œä¸º<strong>é€šä¿¡æœåŠ¡å™¨</strong>ã€‚</li>
<li>ç¬¬ 4 è¡Œï¼šè°ƒç”¨&nbsp;<code>#getAddr(url)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æœåŠ¡å™¨åœ°å€ã€‚</li>
<li>ç¬¬ 5 è‡³ 10 è¡Œï¼šä»&nbsp;<code>serverMap</code>&nbsp;ä¸­ï¼Œè·å¾— HttpServer å¯¹è±¡ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè°ƒç”¨&nbsp;<code>HttpBinder#bind(url, handler)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º HttpServer å¯¹è±¡ã€‚æ­¤å¤„ä½¿ç”¨çš„ WebServiceHandler ï¼Œä¸‹æ–‡è¯¦ç»†è§£æã€‚</li>
<li>ç¬¬ 11 è‡³ 18 è¡Œï¼šåˆ›å»º ServerFactoryBean å¯¹è±¡ã€‚</li>
<li>ç¬¬ 19 è‡³ 24 è¡Œï¼šè¿”å›å–æ¶ˆæš´éœ²çš„å›è°ƒ Runnable å¯¹è±¡ã€‚</li>
</ul>
<h3 id="2-2-1-WebServiceHandler">2.2.1 WebServiceHandler</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">WebServiceHandler</span> <span class="keyword">implements</span> <span class="title">HttpHandler</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ServletController servletController;</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException, ServletException </span>{</span><br /><span class="line">        <span class="comment">// åˆ›å»º ServletController å¯¹è±¡ï¼Œè®¾ç½®ä½¿ç”¨ DispatcherServlet ã€‚</span></span><br /><span class="line">        <span class="keyword">if</span> (servletController == <span class="keyword">null</span>) {</span><br /><span class="line">            HttpServlet httpServlet = DispatcherServlet.getInstance();</span><br /><span class="line">            <span class="keyword">if</span> (httpServlet == <span class="keyword">null</span>) {</span><br /><span class="line">                response.sendError(<span class="number">500</span>, <span class="string">"No such DispatcherServlet instance."</span>);</span><br /><span class="line">                <span class="keyword">return</span>;</span><br /><span class="line">            }</span><br /><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</span><br /><span class="line">                <span class="keyword">if</span> (servletController == <span class="keyword">null</span>) {</span><br /><span class="line">                    servletController = <span class="keyword">new</span> ServletController(transportFactory.getRegistry(), httpServlet.getServletConfig(), httpServlet);</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// è®¾ç½®è°ƒç”¨æ–¹åœ°å€</span></span><br /><span class="line">        RpcContext.getContext().setRemoteAddress(request.getRemoteAddr(), request.getRemotePort());</span><br /><span class="line">        <span class="comment">// æ‰§è¡Œè°ƒç”¨</span></span><br /><span class="line">        servletController.invoke(request, response);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="2-3-doRefer">2.3 doRefer</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line"> <span class="number">3</span>: <span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doRefer</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; serviceType, <span class="keyword">final</span> URL url)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// åˆ›å»º ClientProxyFactoryBean å¯¹è±¡</span></span><br /><span class="line"> <span class="number">5</span>:     ClientProxyFactoryBean proxyFactoryBean = <span class="keyword">new</span> ClientProxyFactoryBean();</span><br /><span class="line"> <span class="number">6</span>:     proxyFactoryBean.setAddress(url.setProtocol(<span class="string">"http"</span>).toIdentityString());</span><br /><span class="line"> <span class="number">7</span>:     proxyFactoryBean.setServiceClass(serviceType);</span><br /><span class="line"> <span class="number">8</span>:     proxyFactoryBean.setBus(bus);</span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// åˆ›å»º Service Proxy å¯¹è±¡</span></span><br /><span class="line"><span class="number">10</span>:     T ref = (T) proxyFactoryBean.create();</span><br /><span class="line"><span class="number">11</span>:     <span class="comment">// è®¾ç½®è¶…æ—¶ç›¸å…³å±æ€§</span></span><br /><span class="line"><span class="number">12</span>:     Client proxy = ClientProxy.getClient(ref);</span><br /><span class="line"><span class="number">13</span>:     HTTPConduit conduit = (HTTPConduit) proxy.getConduit();</span><br /><span class="line"><span class="number">14</span>:     HTTPClientPolicy policy = <span class="keyword">new</span> HTTPClientPolicy();</span><br /><span class="line"><span class="number">15</span>:     policy.setConnectionTimeout(url.getParameter(Constants.CONNECT_TIMEOUT_KEY, Constants.DEFAULT_CONNECT_TIMEOUT));</span><br /><span class="line"><span class="number">16</span>:     policy.setReceiveTimeout(url.getParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT));</span><br /><span class="line"><span class="number">17</span>:     conduit.setClient(policy);</span><br /><span class="line"><span class="number">18</span>:     <span class="keyword">return</span> ref;</span><br /><span class="line"><span class="number">19</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 4 è‡³ 8 è¡Œï¼šåˆ›å»º ClientProxyFactoryBean å¯¹è±¡ã€‚</li>
<li>ç¬¬ 10 è¡Œï¼šåˆ›å»º Service Proxy å¯¹è±¡ã€‚</li>
<li>ç¬¬ 11 è‡³ 17 è¡Œï¼šè®¾ç½®<strong>è¶…æ—¶ç›¸å…³</strong>å±æ€§ã€‚</li>
</ul>
<h3 id="2-3-1-getErrorCode">2.3.1 getErrorCode</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getErrorCode</span><span class="params">(Throwable e)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> Fault) {</span><br /><span class="line">        e = e.getCause();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> SocketTimeoutException) {</span><br /><span class="line">        <span class="keyword">return</span> RpcException.TIMEOUT_EXCEPTION;</span><br /><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IOException) {</span><br /><span class="line">        <span class="keyword">return</span> RpcException.NETWORK_EXCEPTION;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.getErrorCode(e);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å°†å¼‚å¸¸ï¼Œç¿»è¯‘æˆ Dubbo å¼‚å¸¸ç ã€‚</li>
</ul>
</div>