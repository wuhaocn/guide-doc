<header class="article-header">
<h1 class="article-title">æœåŠ¡è°ƒç”¨ï¼ˆä¸‰ï¼‰ä¹‹è¿œç¨‹è°ƒç”¨ï¼ˆHTTPï¼‰</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡ï¼Œæˆ‘ä»¬åˆ†äº«&nbsp;<code>http://</code>&nbsp;åè®®çš„è¿œç¨‹è°ƒç”¨ï¼Œä¸»è¦åˆ†æˆ<strong>ä¸‰ä¸ªéƒ¨åˆ†</strong>ï¼š</p>
<ul>
<li>æœåŠ¡æš´éœ²</li>
<li>æœåŠ¡å¼•ç”¨</li>
<li>æœåŠ¡è°ƒç”¨</li>
</ul>
<p>å¯¹åº”é¡¹ç›®ä¸º&nbsp;<code>dubbo-rpc-http</code>&nbsp;ã€‚</p>
<p>å¯¹åº”æ–‡æ¡£ä¸º&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/http.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; http://ã€‹</a>&nbsp;ã€‚å®šä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>åŸºäº HTTP è¡¨å•çš„è¿œç¨‹è°ƒç”¨åè®®ï¼Œé‡‡ç”¨ Spring çš„&nbsp;<strong>HttpInvoker</strong>&nbsp;å®ç°</p>
</blockquote>
<p><strong>æ³¨æ„</strong>ï¼Œä»å®šä¹‰ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä¸æ˜¯æˆ‘ä»¬å¸¸è§„ç†è§£çš„ HTTP è°ƒç”¨ï¼Œè€Œæ˜¯&nbsp;<strong>Spring çš„ HttpInvoker</strong>&nbsp;ã€‚</p>
<p>æœ¬æ–‡æ¶‰åŠç±»å›¾ï¼ˆçº¢åœˆéƒ¨åˆ†ï¼‰å¦‚ä¸‹ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_10_10/01.png" alt="ç±»å›¾" /></p>
<h1 id="2-AbstractProxyProtocol">2. AbstractProxyProtocol</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/protocol/AbstractProxyProtocol.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.rpc.protocol.AbstractProxyProtocol</code></a>&nbsp;ï¼Œå®ç° AbstractProtocol æŠ½è±¡ç±»ï¼Œ<strong>Proxy</strong>åè®®æŠ½è±¡ç±»ã€‚ä¸º HttpProtocol ã€RestProtocol ç­‰å­ç±»ï¼Œæä¾›å…¬ç”¨çš„æœåŠ¡æš´éœ²ã€æœåŠ¡å¼•ç”¨çš„<strong>å…¬ç”¨æ–¹æ³•</strong>ï¼ŒåŒæ—¶å®šä¹‰äº†å¦‚ä¸‹<strong>æŠ½è±¡æ–¹æ³•</strong>ï¼Œç”¨äºä¸åŒå­ç±»åè®®å®ç°ç±»çš„<strong>è‡ªå®šä¹‰</strong>çš„é€»è¾‘ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ‰§è¡Œæš´éœ²ï¼Œå¹¶è¿”å›å–æ¶ˆæš´éœ²çš„å›è°ƒ Runnable</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> impl æœåŠ¡ Proxy å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> type æœåŠ¡æ¥å£</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> url URL</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt; æœåŠ¡æ¥å£</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> æ¶ˆæš´éœ²çš„å›è°ƒ Runnable</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@throws</span> RpcException å½“å‘ç”Ÿå¼‚å¸¸</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> &lt;T&gt; <span class="function">Runnable <span class="title">doExport</span><span class="params">(T impl, Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException</span>;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ‰§è¡Œå¼•ç”¨ï¼Œå¹¶è¿”å›è°ƒç”¨è¿œç¨‹æœåŠ¡çš„ Service å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> type æœåŠ¡æ¥å£</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> url URL</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt; æœåŠ¡æ¥å£</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> è°ƒç”¨è¿œç¨‹æœåŠ¡çš„ Service å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@throws</span> RpcException å½“å‘ç”Ÿå¼‚å¸¸</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> &lt;T&gt; <span class="function">T <span class="title">doRefer</span><span class="params">(Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException</span>;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="2-1-æ„é€ æ–¹æ³•">2.1 æ„é€ æ–¹æ³•</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * éœ€è¦æŠ›å‡ºçš„å¼‚å¸¸ç±»é›†åˆï¼Œè¯¦è§ {<span class="doctag">@link</span> #reder(Class, URL)} æ–¹æ³•ã€‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Class&lt;?&gt;&gt; rpcExceptions = <span class="keyword">new</span> CopyOnWriteArrayList&lt;Class&lt;?&gt;&gt;();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ProxyFactory å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> ProxyFactory proxyFactory;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractProxyProtocol</span><span class="params">()</span> </span>{</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractProxyProtocol</span><span class="params">(Class&lt;?&gt;... exceptions)</span> </span>{</span><br /><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; exception : exceptions) {</span><br /><span class="line">        addRpcException(exception);</span><br /><span class="line">    }</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addRpcException</span><span class="params">(Class&lt;?&gt; exception)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.rpcExceptions.add(exception);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>rpcExceptions</code>&nbsp;å±æ€§ï¼Œä¸åŒåè®®çš„è¿œç¨‹è°ƒç”¨ï¼Œä¼šæŠ›å‡ºçš„å¼‚å¸¸æ˜¯ä¸åŒçš„ã€‚åœ¨&nbsp;<code>#refer(Class, URL)</code>&nbsp;æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°å¯¹è¿™ä¸ªå±æ€§çš„ä½¿ç”¨ï¼Œç†è§£ä¼šæ›´æ¸…æ™°ä¸€äº›ã€‚</li>
</ul>
<h2 id="2-2-export">2.2 export</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Exporter é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * key: æœåŠ¡é”® {<span class="doctag">@link</span> #serviceKey(URL)} æˆ– {<span class="doctag">@link</span> URL#getServiceKey()} ã€‚</span></span><br /><span class="line"><span class="comment"> *      ä¸åŒåè®®ä¼šä¸åŒ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Map&lt;String, Exporter&lt;?&gt;&gt; exporterMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Exporter&lt;?&gt;&gt;(); <span class="comment">// FROM AbstractProtocol.java</span></span><br /><br /><span class="line">  <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line">  <span class="number">2</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line">  <span class="number">3</span>: <span class="keyword">public</span> &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(<span class="keyword">final</span> Invoker&lt;T&gt; invoker)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">  <span class="number">4</span>:     <span class="comment">// è·å¾—æœåŠ¡é”®</span></span><br /><span class="line">  <span class="number">5</span>:     <span class="keyword">final</span> String uri = serviceKey(invoker.getUrl());</span><br /><span class="line">  <span class="number">6</span>:     <span class="comment">// è·å¾— Exporter å¯¹è±¡ã€‚è‹¥å·²ç»æš´éœ²ï¼Œç›´æ¥è¿”å›ã€‚</span></span><br /><span class="line">  <span class="number">7</span>:     Exporter&lt;T&gt; exporter = (Exporter&lt;T&gt;) exporterMap.get(uri);</span><br /><span class="line">  <span class="number">8</span>:     <span class="keyword">if</span> (exporter != <span class="keyword">null</span>) {</span><br /><span class="line">  <span class="number">9</span>:         <span class="keyword">return</span> exporter;</span><br /><span class="line"> <span class="number">10</span>:     }</span><br /><span class="line"> <span class="number">11</span>:     <span class="comment">// æ‰§è¡Œæš´éœ²æœåŠ¡</span></span><br /><span class="line"> <span class="number">12</span>:     <span class="keyword">final</span> Runnable runnable = doExport(proxyFactory.getProxy(invoker), invoker.getInterface(), invoker.getUrl());</span><br /><span class="line"> <span class="number">13</span>:     <span class="comment">// åˆ›å»º Exporter å¯¹è±¡</span></span><br /><span class="line"> <span class="number">14</span>:     exporter = <span class="keyword">new</span> AbstractExporter&lt;T&gt;(invoker) {</span><br /><span class="line"> <span class="number">15</span>: </span><br /><span class="line"> <span class="number">16</span>:         <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">17</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unexport</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">18</span>:             <span class="comment">// å–æ¶ˆæš´éœ²</span></span><br /><span class="line"> <span class="number">19</span>:             <span class="keyword">super</span>.unexport();</span><br /><span class="line"> <span class="number">20</span>:             exporterMap.remove(uri);</span><br /><span class="line"> <span class="number">21</span>:             <span class="comment">// æ‰§è¡Œå–æ¶ˆæš´éœ²çš„å›è°ƒ</span></span><br /><span class="line"> <span class="number">22</span>:             <span class="keyword">if</span> (runnable != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">23</span>:                 <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">24</span>:                     runnable.run();</span><br /><span class="line"> <span class="number">25</span>:                 } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"> <span class="number">26</span>:                     logger.warn(t.getMessage(), t);</span><br /><span class="line"> <span class="number">27</span>:                 }</span><br /><span class="line"> <span class="number">28</span>:             }</span><br /><span class="line"> <span class="number">29</span>:         }</span><br /><span class="line"> <span class="number">30</span>: </span><br /><span class="line"> <span class="number">31</span>:     };</span><br /><span class="line"> <span class="number">32</span>:     <span class="comment">// æ·»åŠ åˆ° Exporter é›†åˆ</span></span><br /><span class="line"> <span class="number">33</span>:     exporterMap.put(uri, exporter);</span><br /><span class="line"> <span class="number">34</span>:     <span class="keyword">return</span> exporter;</span><br /><span class="line"> <span class="number">35</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ç¬¬ 5 è¡Œï¼šè°ƒç”¨&nbsp;<code>#serviceKey(url)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æœåŠ¡é”®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> String <span class="title">serviceKey</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> ProtocolUtils.serviceKey(url);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 6 è‡³ 10 è¡Œï¼šä»&nbsp;<code>exporterMap</code>&nbsp;ä¸­ï¼Œè·å¾— Exporter å¯¹è±¡ã€‚è‹¥å·²ç»æš´éœ²ï¼Œç›´æ¥è¿”å›ã€‚</p>
</li>
<li>ç¬¬ 12 è¡Œï¼šè°ƒç”¨&nbsp;<code>ProxyFactory#getProxy(invoker)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— Service Proxy å¯¹è±¡ã€‚</li>
<li>ç¬¬ 12 è¡Œï¼šè°ƒç”¨&nbsp;<code>#doExport(impl, type, url)</code>&nbsp;<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œæ‰§è¡Œ<strong>å­ç±»å®ç°</strong>çš„æš´éœ²æœåŠ¡ã€‚</li>
<li>ç¬¬ 14 è‡³ 31 è¡Œï¼šåˆ›å»º Exporter å¯¹è±¡ã€‚åŸºäº AbstractExporter æŠ½è±¡ç±»å®ç°ï¼Œè¦†å†™&nbsp;<code>#unexport()</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
<ul>
<li>ç¬¬ 18 è‡³ 20 è¡Œï¼šå–æ¶ˆæš´éœ²ã€‚</li>
<li>ç¬¬ 22 è‡³ 28 è¡Œï¼šè°ƒç”¨&nbsp;<code>Runnable#run()</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œå–æ¶ˆæš´éœ²çš„å›è°ƒæ–¹æ³•ã€‚</li>
</ul>
</li>
<li>ç¬¬ 33 è¡Œï¼šæ·»åŠ åˆ° Exporter é›†åˆã€‚</li>
</ul>
<h2 id="2-3-refer">2.3 refer</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Invoker é›†åˆ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="comment">//TODO SOFEREFENCE</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Set&lt;Invoker&lt;?&gt;&gt; invokers = <span class="keyword">new</span> ConcurrentHashSet&lt;Invoker&lt;?&gt;&gt;(); <span class="comment">// FROM AbstractProtocol.java</span></span><br /><br /><span class="line">  <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line">  <span class="number">2</span>: <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; type, <span class="keyword">final</span> URL url)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">  <span class="number">3</span>:     <span class="comment">// æ‰§è¡Œå¼•ç”¨æœåŠ¡</span></span><br /><span class="line">  <span class="number">4</span>:     <span class="keyword">final</span> Invoker&lt;T&gt; target = proxyFactory.getInvoker(doRefer(type, url), type, url);</span><br /><span class="line">  <span class="number">5</span>:     <span class="comment">// åˆ›å»º Invoker å¯¹è±¡</span></span><br /><span class="line">  <span class="number">6</span>:     Invoker&lt;T&gt; invoker = <span class="keyword">new</span> AbstractInvoker&lt;T&gt;(type, url) {</span><br /><span class="line">  <span class="number">7</span>: </span><br /><span class="line">  <span class="number">8</span>:         <span class="meta">@Override</span></span><br /><span class="line">  <span class="number">9</span>:         <span class="function"><span class="keyword">protected</span> Result <span class="title">doInvoke</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable </span>{</span><br /><span class="line"> <span class="number">10</span>:             <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">11</span>:                 <span class="comment">// è°ƒç”¨</span></span><br /><span class="line"> <span class="number">12</span>:                 Result result = target.invoke(invocation);</span><br /><span class="line"> <span class="number">13</span>:                 <span class="comment">// è‹¥è¿”å›ç»“æœå¸¦æœ‰å¼‚å¸¸ï¼Œå¹¶ä¸”éœ€è¦æŠ›å‡ºï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br /><span class="line"> <span class="number">14</span>:                 Throwable e = result.getException();</span><br /><span class="line"> <span class="number">15</span>:                 <span class="keyword">if</span> (e != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">16</span>:                     <span class="keyword">for</span> (Class&lt;?&gt; rpcException : rpcExceptions) {</span><br /><span class="line"> <span class="number">17</span>:                         <span class="keyword">if</span> (rpcException.isAssignableFrom(e.getClass())) {</span><br /><span class="line"> <span class="number">18</span>:                             <span class="keyword">throw</span> getRpcException(type, url, invocation, e);</span><br /><span class="line"> <span class="number">19</span>:                         }</span><br /><span class="line"> <span class="number">20</span>:                     }</span><br /><span class="line"> <span class="number">21</span>:                 }</span><br /><span class="line"> <span class="number">22</span>:                 <span class="keyword">return</span> result;</span><br /><span class="line"> <span class="number">23</span>:             } <span class="keyword">catch</span> (RpcException e) {</span><br /><span class="line"> <span class="number">24</span>:                 <span class="comment">// è‹¥æ˜¯æœªçŸ¥å¼‚å¸¸ï¼Œè·å¾—å¼‚å¸¸å¯¹åº”çš„é”™è¯¯ç </span></span><br /><span class="line"> <span class="number">25</span>:                 <span class="keyword">if</span> (e.getCode() == RpcException.UNKNOWN_EXCEPTION) {</span><br /><span class="line"> <span class="number">26</span>:                     e.setCode(getErrorCode(e.getCause()));</span><br /><span class="line"> <span class="number">27</span>:                 }</span><br /><span class="line"> <span class="number">28</span>:                 <span class="keyword">throw</span> e;</span><br /><span class="line"> <span class="number">29</span>:             } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"> <span class="number">30</span>:                 <span class="comment">// æŠ›å‡º RpcException å¼‚å¸¸</span></span><br /><span class="line"> <span class="number">31</span>:                 <span class="keyword">throw</span> getRpcException(type, url, invocation, e);</span><br /><span class="line"> <span class="number">32</span>:             }</span><br /><span class="line"> <span class="number">33</span>:         }</span><br /><span class="line"> <span class="number">34</span>: </span><br /><span class="line"> <span class="number">35</span>:     };</span><br /><span class="line"> <span class="number">36</span>:     <span class="comment">// æ·»åŠ åˆ° Invoker é›†åˆã€‚</span></span><br /><span class="line"> <span class="number">37</span>:     invokers.add(invoker);</span><br /><span class="line"> <span class="number">38</span>:     <span class="keyword">return</span> invoker;</span><br /><span class="line"> <span class="number">39</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 4 è¡Œï¼šè°ƒç”¨&nbsp;<code>#doRefer(type, url)</code>&nbsp;<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œæ‰§è¡Œ<strong>å­ç±»å®ç°</strong>çš„å¼•ç”¨æœåŠ¡ã€‚</li>
<li>ç¬¬ 4 è¡Œï¼šè°ƒç”¨&nbsp;<code>ProxyFactory#getInvoker(proxy, type, url)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— Invoker å¯¹è±¡ã€‚</li>
<li>
<p>ç¬¬ 6 è‡³ 35 è¡Œï¼šåˆ›å»º Invoker å¯¹è±¡ã€‚åŸºäº AbstractExporter æŠ½è±¡ç±»å®ç°ï¼Œè¦†å†™&nbsp;<code>#doInvoke(invocation)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<ul>
<li>ç¬¬ 12 è¡Œï¼šè°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œ RPC è°ƒç”¨ã€‚</li>
<li>ç¬¬ 13 è‡³ 21 è¡Œï¼šè‹¥è¿”å›ç»“æœå¸¦æœ‰å¼‚å¸¸ï¼Œå¹¶ä¸”éœ€è¦æŠ›å‡º( å¼‚å¸¸åœ¨&nbsp;<code>rpcExceptions</code>&nbsp;ä¸­)ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>ç¬¬ 22 è¡Œï¼šè¿”å›è°ƒç”¨ç»“æœã€‚</li>
<li>
<p>ç¬¬ 23 è‡³ 28 è¡Œï¼šè‹¥æ•æ‰åˆ° RpcException å¼‚å¸¸ï¼Œè°ƒç”¨&nbsp;<code>#getErrorCode(Throwable)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—å¼‚å¸¸å¯¹åº”çš„é”™è¯¯ç ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·å¾—å¼‚å¸¸å¯¹åº”çš„é”™è¯¯ç </span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> e å¼‚å¸¸</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> é”™è¯¯ç </span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getErrorCode</span><span class="params">(Throwable e)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> RpcException.UNKNOWN_EXCEPTION;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å­ç±»åè®®å®ç°ç±»ï¼Œä¸€èˆ¬ä¼šè¦†å†™è¿™ä¸ªæ–¹æ³•ï¼Œå®ç°è‡ªå·±å¼‚å¸¸çš„ç¿»è¯‘ã€‚</li>
</ul>
</li>
<li>
<p>ç¬¬ 29 è‡³ 32 è¡Œï¼šè‹¥æ•æ‰åˆ° Throwable å¼‚å¸¸ï¼Œè°ƒç”¨&nbsp;<code>#getRpcException(type, url, invocation, e)</code>&nbsp;æ–¹æ³•ï¼ŒåŒ…è£…æˆ RpcException å¼‚å¸¸ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">protected</span> RpcException <span class="title">getRpcException</span><span class="params">(Class&lt;?&gt; type, URL url, Invocation invocation, Throwable e)</span> </span>{</span><br /><span class="line">    RpcException re = <span class="keyword">new</span> RpcException(<span class="string">"Failed to invoke remote service: "</span> + type + <span class="string">", method: "</span></span><br /><span class="line">            + invocation.getMethodName() + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br /><span class="line">    re.setCode(getErrorCode(e));</span><br /><span class="line">    <span class="keyword">return</span> re;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
</li>
<li>
<p>ç¬¬ 37 è¡Œï¼šæ·»åŠ åˆ° Invoker é›†åˆã€‚</p>
</li>
</ul>
<h1 id="3-HttpProtocol">3. HttpProtocol</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-rpc/dubbo-rpc-http/src/main/java/com/alibaba/dubbo/rpc/protocol/http/HttpProtocol.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.rpc.protocol.http.HttpProtocol</code></a>&nbsp;ï¼Œå®ç° AbstractProxyProtocol æŠ½è±¡ç±»ï¼Œ<code>dubbo://</code>&nbsp;åè®®å®ç°ç±»ã€‚</p>
<h2 id="3-1-æ„é€ æ–¹æ³•">3.1 æ„é€ æ–¹æ³•</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é»˜è®¤æœåŠ¡å™¨ç«¯å£</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_PORT = <span class="number">80</span>;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Http æœåŠ¡å™¨é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * keyï¼šip:port</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, HttpServer&gt; serverMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, HttpServer&gt;();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Spring HttpInvokerServiceExporter é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * keyï¼špath æœåŠ¡å</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, HttpInvokerServiceExporter&gt; skeletonMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, HttpInvokerServiceExporter&gt;();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * HttpBinder$Adaptive å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> HttpBinder httpBinder;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HttpProtocol</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">super</span>(RemoteAccessException.class);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHttpBinder</span><span class="params">(HttpBinder httpBinder)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.httpBinder = httpBinder;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>serverMap</code>&nbsp;å±æ€§ï¼ŒHttpServer é›†åˆã€‚é”®ä¸º&nbsp;<code>ip:port</code>&nbsp;ï¼Œé€šè¿‡&nbsp;<code>#getAddr(url)</code>&nbsp;æ–¹æ³•ï¼Œè®¡ç®—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// AbstractProxyProtocol.java</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getAddr</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    String bindIp = url.getParameter(Constants.BIND_IP_KEY, url.getHost());</span><br /><span class="line">    <span class="keyword">if</span> (url.getParameter(Constants.ANYHOST_KEY, <span class="keyword">false</span>)) {</span><br /><span class="line">        bindIp = Constants.ANYHOST_VALUE;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> NetUtils.getIpByHost(bindIp) + <span class="string">":"</span> + url.getParameter(Constants.BIND_PORT_KEY, url.getPort());</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>skeletonMap</code>&nbsp;å±æ€§ï¼ŒSpring HttpInvokerServiceExporter é›†åˆã€‚è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸º&nbsp;<code>HttpServer =&gt; DispatcherServlet =&gt; InternalHandler =&gt; HttpInvokerServiceExporter</code>&nbsp;ã€‚</p>
</li>
<li><code>httpBinder</code>&nbsp;å±æ€§ï¼ŒHttpBinder$Adaptive å¯¹è±¡ï¼Œé€šè¿‡&nbsp;<code>#setHttpBinder(httpBinder)</code>&nbsp;æ–¹æ³•ï¼ŒDubbo SPI è°ƒç”¨è®¾ç½®ã€‚</li>
<li><code>rpcExceptions = RemoteAccessException.class</code>&nbsp;ã€‚</li>
</ul>
<h2 id="3-2-doExport">3.2 doExport</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">protected</span> &lt;T&gt; <span class="function">Runnable <span class="title">doExport</span><span class="params">(<span class="keyword">final</span> T impl, Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// è·å¾—æœåŠ¡å™¨åœ°å€</span></span><br /><span class="line"> <span class="number">4</span>:     String addr = getAddr(url);</span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// è·å¾— HttpServer å¯¹è±¡ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿›è¡Œåˆ›å»ºã€‚</span></span><br /><span class="line"> <span class="number">6</span>:     HttpServer server = serverMap.get(addr);</span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (server == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">8</span>:         server = httpBinder.bind(url, <span class="keyword">new</span> InternalHandler()); <span class="comment">// InternalHandler</span></span><br /><span class="line"> <span class="number">9</span>:         serverMap.put(addr, server);</span><br /><span class="line"><span class="number">10</span>:     }</span><br /><span class="line"><span class="number">11</span>:     <span class="comment">// åˆ›å»º HttpInvokerServiceExporter å¯¹è±¡</span></span><br /><span class="line"><span class="number">12</span>:     <span class="keyword">final</span> HttpInvokerServiceExporter httpServiceExporter = <span class="keyword">new</span> HttpInvokerServiceExporter();</span><br /><span class="line"><span class="number">13</span>:     httpServiceExporter.setServiceInterface(type);</span><br /><span class="line"><span class="number">14</span>:     httpServiceExporter.setService(impl);</span><br /><span class="line"><span class="number">15</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">16</span>:         httpServiceExporter.afterPropertiesSet();</span><br /><span class="line"><span class="number">17</span>:     } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line"><span class="number">18</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(e.getMessage(), e);</span><br /><span class="line"><span class="number">19</span>:     }</span><br /><span class="line"><span class="number">20</span>:     <span class="comment">// æ·»åŠ åˆ° skeletonMap ä¸­</span></span><br /><span class="line"><span class="number">21</span>:     <span class="keyword">final</span> String path = url.getAbsolutePath();</span><br /><span class="line"><span class="number">22</span>:     skeletonMap.put(path, httpServiceExporter);</span><br /><span class="line"><span class="number">23</span>:     <span class="comment">// è¿”å›å–æ¶ˆæš´éœ²çš„å›è°ƒ Runnable</span></span><br /><span class="line"><span class="number">24</span>:     <span class="keyword">return</span> <span class="keyword">new</span> Runnable() {</span><br /><span class="line"><span class="number">25</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">26</span>:             skeletonMap.remove(path);</span><br /><span class="line"><span class="number">27</span>:         }</span><br /><span class="line"><span class="number">28</span>:     };</span><br /><span class="line"><span class="number">29</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>åŸºäº&nbsp;<code>dubbo-remoting-http</code>&nbsp;é¡¹ç›®ï¼Œä½œä¸º<strong>é€šä¿¡æœåŠ¡å™¨</strong>ã€‚</li>
<li>ç¬¬ 4 è¡Œï¼šè°ƒç”¨&nbsp;<code>#getAddr(url)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æœåŠ¡å™¨åœ°å€ã€‚</li>
<li>ç¬¬ 5 è‡³ 10 è¡Œï¼šä»&nbsp;<code>serverMap</code>&nbsp;ä¸­ï¼Œè·å¾— HttpServer å¯¹è±¡ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè°ƒç”¨&nbsp;<code>HttpBinder#bind(url, handler)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º HttpServer å¯¹è±¡ã€‚æ­¤å¤„ä½¿ç”¨çš„ InternalHandler ï¼Œä¸‹æ–‡è¯¦ç»†è§£æã€‚</li>
<li>ç¬¬ 11 è‡³ 19 è¡Œï¼šåˆ›å»º HttpInvokerServiceExporter å¯¹è±¡ã€‚</li>
<li>ç¬¬ 20 è‡³ 22 è¡Œï¼šæ·»åŠ åˆ°&nbsp;<code>skeletonMap</code>&nbsp;é›†åˆä¸­ã€‚</li>
<li>ç¬¬ 23 è‡³ 28 è¡Œï¼šè¿”å›å–æ¶ˆæš´éœ²çš„å›è°ƒ Runnable å¯¹è±¡ã€‚</li>
</ul>
<h3 id="3-2-1-InternalHandler">3.2.1 InternalHandler</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalHandler</span> <span class="keyword">implements</span> <span class="title">HttpHandler</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException </span>{</span><br /><span class="line">        String uri = request.getRequestURI();</span><br /><span class="line">        <span class="comment">// è·å¾— HttpInvokerServiceExporter å¯¹è±¡</span></span><br /><span class="line">        HttpInvokerServiceExporter skeleton = skeletonMap.get(uri);</span><br /><span class="line">        <span class="comment">// å¿…é¡»æ˜¯ POST è¯·æ±‚</span></span><br /><span class="line">        <span class="keyword">if</span> (!request.getMethod().equalsIgnoreCase(<span class="string">"POST"</span>)) {</span><br /><span class="line">            response.setStatus(<span class="number">500</span>);</span><br /><span class="line">        <span class="comment">// æ‰§è¡Œè°ƒç”¨</span></span><br /><span class="line">        } <span class="keyword">else</span> {</span><br /><span class="line">            RpcContext.getContext().setRemoteAddress(request.getRemoteAddr(), request.getRemotePort());</span><br /><span class="line">            <span class="keyword">try</span> {</span><br /><span class="line">                skeleton.handleRequest(request, response);</span><br /><span class="line">            } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(e);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="3-3-doRefer">3.3 doRefer</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line"> <span class="number">3</span>: <span class="keyword">protected</span> &lt;T&gt; <span class="function">T <span class="title">doRefer</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; serviceType, <span class="keyword">final</span> URL url)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// åˆ›å»º HttpInvokerProxyFactoryBean å¯¹è±¡</span></span><br /><span class="line"> <span class="number">5</span>:     <span class="keyword">final</span> HttpInvokerProxyFactoryBean httpProxyFactoryBean = <span class="keyword">new</span> HttpInvokerProxyFactoryBean();</span><br /><span class="line"> <span class="number">6</span>:     httpProxyFactoryBean.setServiceUrl(url.toIdentityString());</span><br /><span class="line"> <span class="number">7</span>:     httpProxyFactoryBean.setServiceInterface(serviceType);</span><br /><span class="line"> <span class="number">8</span>:     <span class="comment">// åˆ›å»ºæ‰§è¡Œå™¨ SimpleHttpInvokerRequestExecutor å¯¹è±¡</span></span><br /><span class="line"> <span class="number">9</span>:     String client = url.getParameter(Constants.CLIENT_KEY);</span><br /><span class="line"><span class="number">10</span>:     <span class="keyword">if</span> (client == <span class="keyword">null</span> || client.length() == <span class="number">0</span> || <span class="string">"simple"</span>.equals(client)) {</span><br /><span class="line"><span class="number">11</span>:         SimpleHttpInvokerRequestExecutor httpInvokerRequestExecutor = <span class="keyword">new</span> SimpleHttpInvokerRequestExecutor() {</span><br /><span class="line"><span class="number">12</span>:             <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareConnection</span><span class="params">(HttpURLConnection con,</span></span></span><br /><span class="line"><span class="function"><span class="params"><span class="number">13</span>:                                              <span class="keyword">int</span> contentLength)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line"><span class="number">14</span>:                 <span class="keyword">super</span>.prepareConnection(con, contentLength);</span><br /><span class="line"><span class="number">15</span>:                 con.setReadTimeout(url.getParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT));</span><br /><span class="line"><span class="number">16</span>:                 con.setConnectTimeout(url.getParameter(Constants.CONNECT_TIMEOUT_KEY, Constants.DEFAULT_CONNECT_TIMEOUT));</span><br /><span class="line"><span class="number">17</span>:             }</span><br /><span class="line"><span class="number">18</span>:         };</span><br /><span class="line"><span class="number">19</span>:         httpProxyFactoryBean.setHttpInvokerRequestExecutor(httpInvokerRequestExecutor);</span><br /><span class="line"><span class="number">20</span>:     <span class="comment">// åˆ›å»ºæ‰§è¡Œå™¨ HttpComponentsHttpInvokerRequestExecutor å¯¹è±¡</span></span><br /><span class="line"><span class="number">21</span>:     } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"commons"</span>.equals(client)) {</span><br /><span class="line"><span class="number">22</span>:         HttpComponentsHttpInvokerRequestExecutor httpInvokerRequestExecutor = <span class="keyword">new</span> HttpComponentsHttpInvokerRequestExecutor();</span><br /><span class="line"><span class="number">23</span>:         httpInvokerRequestExecutor.setReadTimeout(url.getParameter(Constants.CONNECT_TIMEOUT_KEY, Constants.DEFAULT_CONNECT_TIMEOUT));</span><br /><span class="line"><span class="number">24</span>:         httpProxyFactoryBean.setHttpInvokerRequestExecutor(httpInvokerRequestExecutor);</span><br /><span class="line"><span class="number">25</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">26</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Unsupported http protocol client "</span> + client + <span class="string">", only supported: simple, commons"</span>);</span><br /><span class="line"><span class="number">27</span>:     }</span><br /><span class="line"><span class="number">28</span>:     httpProxyFactoryBean.afterPropertiesSet();</span><br /><span class="line"><span class="number">29</span>:     <span class="comment">// è¿”å› HttpInvokerProxyFactoryBean å¯¹è±¡</span></span><br /><span class="line"><span class="number">30</span>:     <span class="keyword">return</span> (T) httpProxyFactoryBean.getObject();</span><br /><span class="line"><span class="number">31</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>åŸºäº HttpClient ï¼Œä½œä¸º<strong>é€šä¿¡å®¢æˆ·ç«¯</strong>ã€‚</li>
<li>ç¬¬ 4 è‡³ 7 è¡Œï¼šåˆ›å»º HttpInvokerProxyFactoryBean å¯¹è±¡ã€‚</li>
<li>ç¬¬ 9 è‡³ 27 è¡Œï¼šè·å¾—&nbsp;<code>client</code>&nbsp;é…ç½®é¡¹ï¼Œæ ¹æ®è¯¥é…ç½®é¡¹ï¼Œåˆ›å»ºå¯¹åº”çš„æ‰§è¡Œå™¨ã€‚
<ul>
<li><code>"simple"</code>ï¼šç¬¬ 10 è‡³ 19 è¡Œï¼šåˆ›å»ºæ‰§è¡Œå™¨ SimpleHttpInvokerRequestExecutor å¯¹è±¡ã€‚</li>
<li><code>"commons"</code>ï¼šç¬¬ 20 è‡³ 24 è¡Œï¼šåˆ›å»ºæ‰§è¡Œå™¨ HttpComponentsHttpInvokerRequestExecutor å¯¹è±¡ã€‚</li>
<li>ä¸¤è€…çš„å·®å¼‚ç‚¹åœ¨äºä½¿ç”¨çš„ HttpClient ä¸åŒï¼Œå‰è€…ä½¿ç”¨ JDK HttpClient ï¼Œåè€…ä½¿ç”¨ Apache HttpClient ã€‚</li>
</ul>
</li>
<li>ç¬¬ 30 è¡Œï¼šè¿”å› HttpInvokerProxyFactoryBean å¯¹è±¡ã€‚</li>
<li>ğŸ™‚ å…·ä½“ RPC è°ƒç”¨çš„å®ç°ï¼Œåœ¨çˆ¶ç±»&nbsp;<code>#refer()</code>&nbsp;æ–¹æ³•é‡Œã€‚</li>
</ul>
<h3 id="3-3-1-getErrorCode">3.3.1 getErrorCode</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"Duplicates"</span>)</span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getErrorCode</span><span class="params">(Throwable e)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RemoteAccessException) {</span><br /><span class="line">        e = e.getCause();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">if</span> (e != <span class="keyword">null</span>) {</span><br /><span class="line">        Class&lt;?&gt; cls = e.getClass();</span><br /><span class="line">        <span class="keyword">if</span> (SocketTimeoutException.class.equals(cls)) {</span><br /><span class="line">            <span class="keyword">return</span> RpcException.TIMEOUT_EXCEPTION;</span><br /><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (IOException.class.isAssignableFrom(cls)) {</span><br /><span class="line">            <span class="keyword">return</span> RpcException.NETWORK_EXCEPTION;</span><br /><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (ClassNotFoundException.class.isAssignableFrom(cls)) {</span><br /><span class="line">            <span class="keyword">return</span> RpcException.SERIALIZATION_EXCEPTION;</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.getErrorCode(e);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å°†å¼‚å¸¸ï¼Œç¿»è¯‘æˆ Dubbo å¼‚å¸¸ç ã€‚</li>
</ul>
</div>