<header class="article-header">
<h1 class="article-title">é›†ç¾¤å®¹é”™ï¼ˆäº”ï¼‰ä¹‹ Merger å®ç°</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡æ¥&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-4-impl-loadbalance/?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆå››ï¼‰ä¹‹ LoadBalance å®ç°ã€‹</a>&nbsp;ä¸€æ–‡ï¼Œåˆ†äº«&nbsp;<code>dubbo-cluster</code>æ¨¡å—ï¼Œ&nbsp;<code>merger</code>&nbsp;åŒ…ï¼Œ<strong>å„ç§ Merger å®ç°ç±»</strong>ã€‚</p>
<p>Merger ç›¸å…³ç±»ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_04_20/01.png" alt="Merger ç›¸å…³ç±»" /></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç›®å‰ä¸€å…±æœ‰<strong>ä¸¤éƒ¨åˆ†</strong>ï¼š</p>
<ul>
<li>Merger ä»¥åŠå…¶å®ç°ç±»ã€‚</li>
<li>MergerCluster ä»¥åŠå…¶ MergerClusterInvoker</li>
</ul>
<blockquote>
<p>è€è‰¿è‰¿ï¼šæœ¬æ–‡å¯¹åº”&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/group-merger.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; åˆ†ç»„èšåˆã€‹</a>&nbsp;æ–‡æ¡£ã€‚</p>
</blockquote>
<h1 id="2-Merger">2. Merger</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.Merger</code>&nbsp;ï¼ŒMerger&nbsp;<strong>æ¥å£</strong>ï¼Œæä¾›æ¥å£æ–¹æ³•ï¼Œå°†<strong>å¯¹è±¡æ•°ç»„</strong>åˆå¹¶æˆ<strong>ä¸€ä¸ªå¯¹è±¡</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@SPI</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Merger</span>&lt;<span class="title">T</span>&gt; </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * åˆå¹¶ T æ•°ç»„ï¼Œè¿”å›åˆå¹¶åçš„ T å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> items T æ•°ç»„</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> T å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function">T <span class="title">merge</span><span class="params">(T... items)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>@SPI</code>&nbsp;æ³¨è§£ï¼ŒDubbo SPI&nbsp;<strong>æ‹“å±•ç‚¹</strong>ï¼Œæ— é»˜è®¤å€¼ã€‚</li>
</ul>
<h2 id="2-1-Merger-å®ç°ç±»">2.1 Merger å®ç°ç±»</h2>
<p>Merger å†…ç½®<strong>åäºŒ</strong>ä¸ªå®ç°ç±»ï¼Œä»ä»£ç ä¸Šçœ‹åŸºæœ¬ç±»ä¼¼ã€‚æˆ‘ä»¬ä»¥ MapMerger å’Œ ShortArrayMerger ä½œä¸ºä¾‹å­ã€‚</p>
<h3 id="2-1-1-MapMerger">2.1.1 MapMerger</h3>
<p><code>com.alibaba.dubbo.rpc.cluster.merger.MapMerger</code>&nbsp;ï¼Œå®ç° Merger æ¥å£ï¼ŒMap Merger å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MapMerger</span> <span class="keyword">implements</span> <span class="title">Merger</span>&lt;<span class="title">Map</span>&lt;?, ?&gt;&gt; </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">public</span> Map&lt;?, ?&gt; merge(Map&lt;?, ?&gt;... items) {</span><br /><span class="line">        <span class="keyword">if</span> (items.length == <span class="number">0</span>) {</span><br /><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// åˆ›å»ºç»“æœ Map</span></span><br /><span class="line">        Map&lt;Object, Object&gt; result = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br /><span class="line">        <span class="comment">// åˆå¹¶å¤šä¸ª Map</span></span><br /><span class="line">        <span class="keyword">for</span> (Map&lt;?, ?&gt; item : items) {</span><br /><span class="line">            <span class="keyword">if</span> (item != <span class="keyword">null</span>) {</span><br /><span class="line">                result.putAll(item);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span> result;</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="2-1-2-ShortArrayMerger">2.1.2 ShortArrayMerger</h3>
<p><code>com.alibaba.dubbo.rpc.cluster.merger.ShortArrayMerger</code>&nbsp;ï¼Œå®ç° Merger æ¥å£ï¼ŒShort æ•°ç»„ Merger å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">public class ShortArrayMerger implements Merger&lt;short[]&gt; {</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">short</span>[] merge(<span class="keyword">short</span>[]... items) {</span><br /><span class="line">        <span class="comment">// è®¡ç®—åˆå¹¶åçš„æ•°ç»„å¤§å°</span></span><br /><span class="line">        <span class="keyword">int</span> total = <span class="number">0</span>;</span><br /><span class="line">        <span class="keyword">for</span> (<span class="keyword">short</span>[] array : items) {</span><br /><span class="line">            total += array.length;</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// åˆ›å»ºç»“æœæ•°ç»„</span></span><br /><span class="line">        <span class="keyword">short</span>[] result = <span class="keyword">new</span> <span class="keyword">short</span>[total];</span><br /><span class="line">        <span class="comment">// åˆå¹¶å¤šä¸ªæ•°ç»„</span></span><br /><span class="line">        <span class="keyword">int</span> index = <span class="number">0</span>;</span><br /><span class="line">        <span class="keyword">for</span> (<span class="keyword">short</span>[] array : items) {</span><br /><span class="line">            <span class="keyword">for</span> (<span class="keyword">short</span> item : array) {</span><br /><span class="line">                result[index++] = item;</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span> result;</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="2-2-MergerFactory">2.2 MergerFactory</h2>
<p><code>com.alibaba.dubbo.rpc.cluster.merger.MergerFactory</code>&nbsp;ï¼ŒMerger å·¥å‚ç±»ï¼Œæä¾›&nbsp;<code>#getMerger(Class&lt;T&gt; returnType)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—<strong>æŒ‡å®šç±»</strong>å¯¹åº”çš„ Merger å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MergerFactory</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Merger å¯¹è±¡ç¼“å­˜</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;Class&lt;?&gt;, Merger&lt;?&gt;&gt; mergerCache = <span class="keyword">new</span> ConcurrentHashMap&lt;Class&lt;?&gt;, Merger&lt;?&gt;&gt;();</span><br /><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Merger&lt;T&gt; <span class="title">getMerger</span><span class="params">(Class&lt;T&gt; returnType)</span> </span>{</span><br /><span class="line">        Merger result;</span><br /><span class="line">        <span class="comment">// æ•°ç»„ç±»å‹</span></span><br /><span class="line">        <span class="keyword">if</span> (returnType.isArray()) {</span><br /><span class="line">            Class type = returnType.getComponentType();</span><br /><span class="line">            <span class="comment">// ä»ç¼“å­˜ä¸­è·å¾— Merger å¯¹è±¡</span></span><br /><span class="line">            result = mergerCache.get(type);</span><br /><span class="line">            <span class="keyword">if</span> (result == <span class="keyword">null</span>) {</span><br /><span class="line">                loadMergers();</span><br /><span class="line">                result = mergerCache.get(type);</span><br /><span class="line">            }</span><br /><span class="line">            <span class="comment">// è·å–ä¸åˆ°ï¼Œä½¿ç”¨ ArrayMerger</span></span><br /><span class="line">            <span class="keyword">if</span> (result == <span class="keyword">null</span> &amp;&amp; !type.isPrimitive()) {</span><br /><span class="line">                result = ArrayMerger.INSTANCE;</span><br /><span class="line">            }</span><br /><span class="line">        <span class="comment">// æ™®é€šç±»å‹</span></span><br /><span class="line">        } <span class="keyword">else</span> {</span><br /><span class="line">            <span class="comment">// ä»ç¼“å­˜ä¸­è·å¾— Merger å¯¹è±¡</span></span><br /><span class="line">            result = mergerCache.get(returnType);</span><br /><span class="line">            <span class="keyword">if</span> (result == <span class="keyword">null</span>) {</span><br /><span class="line">                loadMergers();</span><br /><span class="line">                result = mergerCache.get(returnType);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span> result;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * åˆå§‹åŒ–æ‰€æœ‰çš„ Merger æ‹“å±•å¯¹è±¡ï¼Œåˆ° mergerCache ç¼“å­˜ä¸­ã€‚</span></span><br /><span class="line"><span class="comment">      */</span></span><br /><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">loadMergers</span><span class="params">()</span> </span>{</span><br /><span class="line">        Set&lt;String&gt; names = ExtensionLoader.getExtensionLoader(Merger.class).getSupportedExtensions();</span><br /><span class="line">        <span class="keyword">for</span> (String name : names) {</span><br /><span class="line">            Merger m = ExtensionLoader.getExtensionLoader(Merger.class).getExtension(name);</span><br /><span class="line">            mergerCache.putIfAbsent(ReflectUtils.getGenericClass(m.getClass()), m);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="3-MergeableCluster">3. MergeableCluster</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.support.MergeableCluster</code>&nbsp;ï¼Œå®ç° Cluster æ¥å£ï¼Œåˆ†ç»„èšåˆ Cluster å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MergeableCluster</span> <span class="keyword">implements</span> <span class="title">Cluster</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">"mergeable"</span>;</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">join</span><span class="params">(Directory&lt;T&gt; directory)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MergeableClusterInvoker&lt;T&gt;(directory);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¯¹åº” Invoker å®ç°ç±»ä¸º MergeableClusterInvoker ã€‚</li>
</ul>
<p>Merger çš„ä½¿ç”¨ï¼Œ<strong>éœ€è¦è®¾ç½® Cluster çš„å®ç°ç±»ä¸º MergeableCluster</strong>&nbsp;ã€‚ä½†æ˜¯å‘¢ï¼Œå®ƒçš„é…ç½®æ–¹å¼ï¼Œå’Œå…¶ä»– Cluster å®ç°ç±»ä¸åŒã€‚</p>
<ul>
<li>ä½¿ç”¨æ–¹å¼ï¼Œå‚è§&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/group-merger.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; åˆ†ç»„èšåˆã€‹</a>&nbsp;æ–‡æ¡£ã€‚</li>
<li>åŸå› ï¼Œå‚è§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆä¸‰ï¼‰ä¹‹ Directory å®ç°ã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-5-impl-merger/">ã€Œ4.3.3.3 toMergeMethodInvokerMapã€</a>&nbsp;ã€‚</li>
</ul>
<h2 id="3-1-MergeableClusterInvoker">3.1 MergeableClusterInvoker</h2>
<p><code>com.alibaba.dubbo.rpc.cluster.support.MergeableClusterInvoker</code>&nbsp;ï¼Œå®ç° Invoker æ¥å£ï¼ŒMergeableCluster Invoker å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Directory$Adaptive å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Directory&lt;T&gt; directory;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ExecutorService å¯¹è±¡ï¼Œå¹¶ä¸”ä¸º CachedThreadPool ã€‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> ExecutorService executor = Executors.newCachedThreadPool(<span class="keyword">new</span> NamedThreadFactory(<span class="string">"mergeable-cluster-executor"</span>, <span class="keyword">true</span>));</span><br /><br /><span class="line">  <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(<span class="keyword">final</span> Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">  <span class="number">3</span>:     <span class="comment">// è·å¾— Invoker é›†åˆ</span></span><br /><span class="line">  <span class="number">4</span>:     List&lt;Invoker&lt;T&gt;&gt; invokers = directory.list(invocation);</span><br /><span class="line">  <span class="number">5</span>:     <span class="comment">// è·å¾— Merger æ‹“å±•å</span></span><br /><span class="line">  <span class="number">6</span>:     String merger = getUrl().getMethodParameter(invocation.getMethodName(), Constants.MERGER_KEY);</span><br /><span class="line">  <span class="number">7</span>:     <span class="comment">// è‹¥æœæœªé…ç½®æ‹“å±•ï¼Œç›´æ¥è°ƒç”¨é¦–ä¸ªå¯ç”¨çš„ Invoker å¯¹è±¡</span></span><br /><span class="line">  <span class="number">8</span>:     <span class="keyword">if</span> (ConfigUtils.isEmpty(merger)) { <span class="comment">// If a method doesn't have a merger, only invoke one Group</span></span><br /><span class="line">  <span class="number">9</span>:         <span class="keyword">for</span> (<span class="keyword">final</span> Invoker&lt;T&gt; invoker : invokers) {</span><br /><span class="line"> <span class="number">10</span>:             <span class="keyword">if</span> (invoker.isAvailable()) {</span><br /><span class="line"> <span class="number">11</span>:                 <span class="keyword">return</span> invoker.invoke(invocation);</span><br /><span class="line"> <span class="number">12</span>:             }</span><br /><span class="line"> <span class="number">13</span>:         }</span><br /><span class="line"> <span class="number">14</span>:         <span class="keyword">return</span> invokers.iterator().next().invoke(invocation);</span><br /><span class="line"> <span class="number">15</span>:     }</span><br /><span class="line"> <span class="number">16</span>: </span><br /><span class="line"> <span class="number">17</span>:     <span class="comment">// é€šè¿‡åå°„ï¼Œè·å¾—è¿”å›ç±»å‹</span></span><br /><span class="line"> <span class="number">18</span>:     Class&lt;?&gt; returnType;</span><br /><span class="line"> <span class="number">19</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">20</span>:         returnType = getInterface().getMethod(invocation.getMethodName(), invocation.getParameterTypes()).getReturnType();</span><br /><span class="line"> <span class="number">21</span>:     } <span class="keyword">catch</span> (NoSuchMethodException e) {</span><br /><span class="line"> <span class="number">22</span>:         returnType = <span class="keyword">null</span>;</span><br /><span class="line"> <span class="number">23</span>:     }</span><br /><span class="line"> <span class="number">24</span>: </span><br /><span class="line"> <span class="number">25</span>:     <span class="comment">// æäº¤çº¿ç¨‹æ± ï¼Œå¹¶è¡Œæ‰§è¡Œï¼Œå‘èµ· RPC è°ƒç”¨ï¼Œå¹¶æ·»åŠ åˆ° results ä¸­</span></span><br /><span class="line"> <span class="number">26</span>:     Map&lt;String, Future&lt;Result&gt;&gt; results = <span class="keyword">new</span> HashMap&lt;String, Future&lt;Result&gt;&gt;();</span><br /><span class="line"> <span class="number">27</span>:     <span class="keyword">for</span> (<span class="keyword">final</span> Invoker&lt;T&gt; invoker : invokers) {</span><br /><span class="line"> <span class="number">28</span>:         Future&lt;Result&gt; future = executor.submit(<span class="keyword">new</span> Callable&lt;Result&gt;() {</span><br /><span class="line"> <span class="number">29</span>:             <span class="function"><span class="keyword">public</span> Result <span class="title">call</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">30</span>:                 <span class="comment">// RPC è°ƒç”¨</span></span><br /><span class="line"> <span class="number">31</span>:                 <span class="keyword">return</span> invoker.invoke(<span class="keyword">new</span> RpcInvocation(invocation, invoker));</span><br /><span class="line"> <span class="number">32</span>:             }</span><br /><span class="line"> <span class="number">33</span>:         });</span><br /><span class="line"> <span class="number">34</span>:         results.put(invoker.getUrl().getServiceKey(), future);</span><br /><span class="line"> <span class="number">35</span>:     }</span><br /><span class="line"> <span class="number">36</span>: </span><br /><span class="line"> <span class="number">37</span>:     <span class="comment">// é˜»å¡ç­‰å¾…æ‰§è¡Œæ‰§è¡Œç»“æœï¼Œå¹¶æ·»åŠ åˆ° resultList ä¸­</span></span><br /><span class="line"> <span class="number">38</span>:     List&lt;Result&gt; resultList = <span class="keyword">new</span> ArrayList&lt;Result&gt;(results.size());</span><br /><span class="line"> <span class="number">39</span>:     <span class="keyword">int</span> timeout = getUrl().getMethodParameter(invocation.getMethodName(), Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);</span><br /><span class="line"> <span class="number">40</span>:     <span class="keyword">for</span> (Map.Entry&lt;String, Future&lt;Result&gt;&gt; entry : results.entrySet()) {</span><br /><span class="line"> <span class="number">41</span>:         Future&lt;Result&gt; future = entry.getValue();</span><br /><span class="line"> <span class="number">42</span>:         <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">43</span>:             Result r = future.get(timeout, TimeUnit.MILLISECONDS);</span><br /><span class="line"> <span class="number">44</span>:             <span class="keyword">if</span> (r.hasException()) { <span class="comment">// å¼‚å¸¸ Result ï¼Œæ‰“å°é”™è¯¯æ—¥å¿—ï¼Œå¿½ç•¥</span></span><br /><span class="line"> <span class="number">45</span>:                 log.error(<span class="keyword">new</span> StringBuilder(<span class="number">32</span>).append(<span class="string">"Invoke "</span>).append(getGroupDescFromServiceKey(entry.getKey())).append(<span class="string">" failed: "</span>).append(r.getException().getMessage()).toString(), r.getException());</span><br /><span class="line"> <span class="number">46</span>:             } <span class="keyword">else</span> { <span class="comment">// æ­£å¸¸ Result ï¼Œæ·»åŠ åˆ° resultList ä¸­</span></span><br /><span class="line"> <span class="number">47</span>:                 resultList.add(r);</span><br /><span class="line"> <span class="number">48</span>:             }</span><br /><span class="line"> <span class="number">49</span>:         } <span class="keyword">catch</span> (Exception e) { <span class="comment">// å¼‚å¸¸ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸</span></span><br /><span class="line"> <span class="number">50</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="keyword">new</span> StringBuilder(<span class="number">32</span>).append(<span class="string">"Failed to invoke service "</span>).append(entry.getKey()).append(<span class="string">": "</span>).append(e.getMessage()).toString(), e);</span><br /><span class="line"> <span class="number">51</span>:         }</span><br /><span class="line"> <span class="number">52</span>:     }</span><br /><span class="line"> <span class="number">53</span>: </span><br /><span class="line"> <span class="number">54</span>:     <span class="comment">// ç»“æœå¤§å°ä¸ºç©ºï¼Œè¿”å›ç©ºçš„ RpcResult</span></span><br /><span class="line"> <span class="number">55</span>:     <span class="keyword">if</span> (resultList.isEmpty()) {</span><br /><span class="line"> <span class="number">56</span>:         <span class="keyword">return</span> <span class="keyword">new</span> RpcResult((Object) <span class="keyword">null</span>);</span><br /><span class="line"> <span class="number">57</span>:     <span class="comment">// ç»“æœå¤§å°ä¸º 1 ï¼Œè¿”å›é¦–ä¸ª RpcResult</span></span><br /><span class="line"> <span class="number">58</span>:     } <span class="keyword">else</span> <span class="keyword">if</span> (resultList.size() == <span class="number">1</span>) {</span><br /><span class="line"> <span class="number">59</span>:         <span class="keyword">return</span> resultList.iterator().next();</span><br /><span class="line"> <span class="number">60</span>:     }</span><br /><span class="line"> <span class="number">61</span>:     <span class="comment">// è¿”å›ç±»å‹ä¸º void ï¼Œè¿”å›ç©ºçš„ RpcResult</span></span><br /><span class="line"> <span class="number">62</span>:     <span class="keyword">if</span> (returnType == <span class="keyword">void</span>.class) {</span><br /><span class="line"> <span class="number">63</span>:         <span class="keyword">return</span> <span class="keyword">new</span> RpcResult((Object) <span class="keyword">null</span>);</span><br /><span class="line"> <span class="number">64</span>:     }</span><br /><span class="line"> <span class="number">65</span>: </span><br /><span class="line"> <span class="number">66</span>:     Object result;</span><br /><span class="line"> <span class="number">67</span>:     <span class="comment">// ã€ç¬¬ 1 ç§ã€‘åŸºäºåˆå¹¶æ–¹æ³•</span></span><br /><span class="line"> <span class="number">68</span>:     <span class="keyword">if</span> (merger.startsWith(<span class="string">"."</span>)) {</span><br /><span class="line"> <span class="number">69</span>:         <span class="comment">// è·å¾—åˆå¹¶æ–¹æ³• Method</span></span><br /><span class="line"> <span class="number">70</span>:         merger = merger.substring(<span class="number">1</span>);</span><br /><span class="line"> <span class="number">71</span>:         Method method;</span><br /><span class="line"> <span class="number">72</span>:         <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">73</span>:             method = returnType.getMethod(merger, returnType);</span><br /><span class="line"> <span class="number">74</span>:         } <span class="keyword">catch</span> (NoSuchMethodException e) {</span><br /><span class="line"> <span class="number">75</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="keyword">new</span> StringBuilder(<span class="number">32</span>).append(<span class="string">"Can not merge result because missing method [ "</span>).append(merger).append(<span class="string">" ] in class [ "</span>).append(returnType.getClass().getName()).append(<span class="string">" ]"</span>).toString());</span><br /><span class="line"> <span class="number">76</span>:         }</span><br /><span class="line"> <span class="number">77</span>:         <span class="comment">// æœ‰ Method ï¼Œè¿›è¡Œåˆå¹¶</span></span><br /><span class="line"> <span class="number">78</span>:         <span class="keyword">if</span> (method != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">79</span>:             <span class="keyword">if</span> (!Modifier.isPublic(method.getModifiers())) {</span><br /><span class="line"> <span class="number">80</span>:                 method.setAccessible(<span class="keyword">true</span>);</span><br /><span class="line"> <span class="number">81</span>:             }</span><br /><span class="line"> <span class="number">82</span>:             result = resultList.remove(<span class="number">0</span>).getValue();</span><br /><span class="line"> <span class="number">83</span>:             <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">84</span>:                 <span class="comment">// æ–¹æ³•è¿”å›ç±»å‹åŒ¹é…ï¼Œåˆå¹¶æ—¶ï¼Œä¿®æ”¹ result</span></span><br /><span class="line"> <span class="number">85</span>:                 <span class="keyword">if</span> (method.getReturnType() != <span class="keyword">void</span>.class &amp;&amp; method.getReturnType().isAssignableFrom(result.getClass())) {</span><br /><span class="line"> <span class="number">86</span>:                     <span class="keyword">for</span> (Result r : resultList) {</span><br /><span class="line"> <span class="number">87</span>:                         result = method.invoke(result, r.getValue());</span><br /><span class="line"> <span class="number">88</span>:                     }</span><br /><span class="line"> <span class="number">89</span>:                 <span class="comment">// æ–¹æ³•è¿”å›ç±»å‹ä¸åŒ¹é…ï¼Œåˆå¹¶æ—¶ï¼Œä¸ä¿®æ”¹ result</span></span><br /><span class="line"> <span class="number">90</span>:                 } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">91</span>:                     <span class="keyword">for</span> (Result r : resultList) {</span><br /><span class="line"> <span class="number">92</span>:                         method.invoke(result, r.getValue());</span><br /><span class="line"> <span class="number">93</span>:                     }</span><br /><span class="line"> <span class="number">94</span>:                 }</span><br /><span class="line"> <span class="number">95</span>:             } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line"> <span class="number">96</span>:                 <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="keyword">new</span> StringBuilder(<span class="number">32</span>).append(<span class="string">"Can not merge result: "</span>).append(e.getMessage()).toString(), e);</span><br /><span class="line"> <span class="number">97</span>:             }</span><br /><span class="line"> <span class="number">98</span>:         <span class="comment">// æ—  Method ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸</span></span><br /><span class="line"> <span class="number">99</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">100</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="keyword">new</span> StringBuilder(<span class="number">32</span>).append(<span class="string">"Can not merge result because missing method [ "</span>).append(merger).append(<span class="string">" ] in class [ "</span>).append(returnType.getClass().getName()).append(<span class="string">" ]"</span>).toString());</span><br /><span class="line"><span class="number">101</span>:         }</span><br /><span class="line"><span class="number">102</span>:     <span class="comment">// ã€ç¬¬ 2 ç§ã€‘åŸºäº Merger</span></span><br /><span class="line"><span class="number">103</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">104</span>:         Merger resultMerger;</span><br /><span class="line"><span class="number">105</span>:         <span class="comment">// ã€ç¬¬ 2.1 ç§ã€‘æ ¹æ®è¿”å›å€¼ç±»å‹è‡ªåŠ¨åŒ¹é… Merger</span></span><br /><span class="line"><span class="number">106</span>:         <span class="keyword">if</span> (ConfigUtils.isDefault(merger)) {</span><br /><span class="line"><span class="number">107</span>:             resultMerger = MergerFactory.getMerger(returnType);</span><br /><span class="line"><span class="number">108</span>:         <span class="comment">// ã€ç¬¬ 2.2 ç§ã€‘æŒ‡å®š Merger</span></span><br /><span class="line"><span class="number">109</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">110</span>:             resultMerger = ExtensionLoader.getExtensionLoader(Merger.class).getExtension(merger);</span><br /><span class="line"><span class="number">111</span>:         }</span><br /><span class="line"><span class="number">112</span>:         <span class="comment">// æœ‰ Merger ï¼Œè¿›è¡Œåˆå¹¶</span></span><br /><span class="line"><span class="number">113</span>:         <span class="keyword">if</span> (resultMerger != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">114</span>:             List&lt;Object&gt; rets = <span class="keyword">new</span> ArrayList&lt;Object&gt;(resultList.size());</span><br /><span class="line"><span class="number">115</span>:             <span class="keyword">for</span> (Result r : resultList) {</span><br /><span class="line"><span class="number">116</span>:                 rets.add(r.getValue());</span><br /><span class="line"><span class="number">117</span>:             }</span><br /><span class="line"><span class="number">118</span>:             result = resultMerger.merge(rets.toArray((Object[]) Array.newInstance(returnType, <span class="number">0</span>)));</span><br /><span class="line"><span class="number">119</span>:         <span class="comment">// æ—  Merger ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸</span></span><br /><span class="line"><span class="number">120</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">121</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"There is no merger to merge result."</span>);</span><br /><span class="line"><span class="number">122</span>:         }</span><br /><span class="line"><span class="number">123</span>:     }</span><br /><span class="line"><span class="number">124</span>:     <span class="comment">// è¿”å› RpcResult ç»“æœ</span></span><br /><span class="line"><span class="number">125</span>:     <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(result);</span><br /><span class="line"><span class="number">126</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ğŸ™‚ çœ‹ä¼¼æ¯”è¾ƒé•¿ï¼Œå®é™…å¾ˆæ˜“æ‡‚ã€‚</li>
<li>ç¬¬ 4 è¡Œï¼šè°ƒç”¨&nbsp;<code>Directory#list(invocation)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æœåŠ¡ Invoker&nbsp;<strong>é›†åˆ</strong>ã€‚</li>
<li>ç¬¬ 6 è¡Œï¼šè°ƒç”¨&nbsp;<code>URL#getMethodParameter(methodName, "merger")</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— Merger æ‹“å±•åï¼Œ<strong>æ–¹æ³•çº§</strong>ã€‚</li>
<li>ç¬¬ 7 è‡³ 15 è¡Œï¼šè‹¥<strong>æœªé…ç½®</strong>&nbsp;Merger æ‹“å±•åï¼Œä¼˜å…ˆè°ƒç”¨é¦–ä¸ª<strong>å¯ç”¨</strong>çš„ Invoker å¯¹è±¡ï¼Œå…¶æ¬¡è°ƒç”¨é¦–ä¸ª Invoker å¯¹è±¡ã€‚</li>
<li>ç¬¬ 17 è‡³ 23 è¡Œï¼šé€šè¿‡åå°„ï¼Œè·å¾—è°ƒç”¨æ–¹æ³•çš„<strong>è¿”å›ç±»å‹</strong>ã€‚</li>
<li>ç¬¬ 25 è‡³ 35 è¡Œï¼šæäº¤çº¿ç¨‹æ± ï¼Œ<strong>å¹¶è¡Œ</strong>æ‰§è¡Œï¼Œå‘èµ· RPC è°ƒç”¨ï¼Œå¹¶æ·»åŠ  Future åˆ°&nbsp;<code>results</code>&nbsp;ä¸­ã€‚</li>
<li>ç¬¬ 37 è‡³ 52 è¡Œï¼š<strong>é˜»å¡</strong>ç­‰å¾…æ‰§è¡Œç»“æœï¼Œå¹¶æ·»åŠ åˆ°&nbsp;<code>resultList</code>&nbsp;ä¸­ã€‚<strong>æ³¨æ„</strong>ï¼Œåˆ†æˆæ­£å¸¸ Resultã€å¼‚å¸¸ Resultï¼ˆ<strong>å¿½ç•¥</strong>ï¼‰ã€Exception ä¸‰ç§æƒ…å†µã€‚</li>
<li>ç¬¬ 54 è‡³ 56 è¡Œï¼šç»“æœå¤§å°ä¸º<strong>ç©º</strong>ï¼Œè¿”å›<strong>ç©º</strong>çš„ RpcResult ã€‚</li>
<li>ç¬¬ 57 è‡³ 60 è¡Œï¼šç»“æœå¤§å°ä¸º&nbsp;<strong>1</strong>&nbsp;ï¼Œè¿”å›<strong>é¦–ä¸ª</strong>&nbsp;RpcResult ã€‚</li>
<li>ç¬¬ 61 è‡³ 64 è¡Œï¼šè¿”å›ç±»å‹ä¸º&nbsp;<strong>void</strong>&nbsp;ï¼Œè¿”å›<strong>ç©º</strong>çš„ RpcResult ã€‚</li>
<li>========== ã€<strong>ç¬¬ 1 ç§</strong>ã€‘åŸºäº Method åˆå¹¶==========</li>
<li>ç¬¬ 68 è¡Œï¼šè‹¥&nbsp;<code>merger</code>&nbsp;ä¸º&nbsp;<code>"."</code>&nbsp;å¼€å¤´ï¼ŒæŒ‡å®šåˆå¹¶æ–¹æ³•ï¼Œå°†è°ƒç”¨è¿”å›ç»“æœçš„æŒ‡å®šæ–¹æ³•è¿›è¡Œåˆå¹¶ï¼Œåˆå¹¶æ–¹æ³•çš„å‚æ•°ç±»å‹å¿…é¡»æ˜¯è¿”å›ç»“æœç±»å‹<strong>æœ¬èº«</strong>ã€‚</li>
<li>ç¬¬ 69 è‡³ 76 è¡Œï¼šè°ƒç”¨&nbsp;<code>Class#getMethod(String name, Class&lt;?&gt;... parameterTypes)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—<strong>åˆå¹¶æ–¹æ³• Method</strong>&nbsp;ã€‚è¿™ä¸ªæ–¹æ³•ï¼Œæ„å‘³ç€&ldquo;åˆå¹¶æ–¹æ³•çš„å‚æ•°ç±»å‹å¿…é¡»æ˜¯è¿”å›ç»“æœç±»å‹<strong>æœ¬èº«</strong>&rdquo;ï¼ï¼ï¼å…·ä½“åŸå› ï¼Œè§&nbsp;<a href="https://www.jianshu.com/p/512e2211f84c" target="_blank" rel="external nofollow noopener noreferrer">ã€Šdubboæºç -é›†ç¾¤å®¹é”™ä¹‹MergeableClusterã€‹</a>&nbsp;ï¼Œæœç´¢&nbsp;<code>"åœ¨æ¡ä»¶åˆ†æ”¯if ( merger.startsWith(".") ) {}"</code>&nbsp;ã€‚</li>
<li>ç¬¬ 77 è‡³ 97 è¡Œï¼š<strong>æœ‰</strong>&nbsp;Method ï¼Œ<strong>å¾ªç¯</strong>è°ƒç”¨&nbsp;<code>Method#invoke(Object obj, Object... args)</code>&nbsp;æ–¹æ³•ï¼Œè¿›è¡Œåˆå¹¶ã€‚</li>
<li>ç¬¬ 98 è‡³ 101 è¡Œï¼š<strong>æ— </strong>&nbsp;Method ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚</li>
<li>========== ã€<strong>ç¬¬ 2 ç§</strong>ã€‘åŸºäº Merger åˆå¹¶ ==========</li>
<li>ã€ç¬¬&nbsp;<strong>2.1</strong>&nbsp;ç§ã€‘ç¬¬ 105 è‡³ 107 è¡Œï¼šå½“&nbsp;<code>merger</code>&nbsp;ä¸º&nbsp;<code>"default"</code>&nbsp;æˆ–&nbsp;<code>"true"</code>&nbsp;æ—¶ï¼Œè°ƒç”¨&nbsp;<code>MergerFactory#getMerger(Class&lt;T&gt; returnType)</code>&nbsp;æ–¹æ³•ï¼Œæ ¹æ®<strong>è¿”å›å€¼ç±»å‹</strong>è‡ªåŠ¨åŒ¹é… Merger ã€‚</li>
<li>ã€ç¬¬&nbsp;<strong>2.2</strong>&nbsp;ç§ã€‘ç¬¬ 108 è‡³ 111 è¡Œï¼šè°ƒç”¨&nbsp;<code>ExtensionLoader#getExtension(merger)</code>&nbsp;æ–¹æ³•å•Šï¼Œè·å¾—<strong>æŒ‡å®š</strong>&nbsp;Merger ã€‚</li>
<li>ç¬¬ 112 è‡³ 118 è¡Œï¼š<strong>æœ‰</strong>&nbsp;Merger ï¼Œ<strong>å¾ªç¯</strong>è°ƒç”¨&nbsp;<code>Merger#merge(T... items)</code>&nbsp;æ–¹æ³•ï¼Œè¿›è¡Œåˆå¹¶ã€‚</li>
<li>ç¬¬ 119 è‡³ 122 è¡Œï¼š<strong>æ— </strong>&nbsp;Method ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚</li>
</ul>
</div>