<header class="article-header">
<h1 class="article-title">&nbsp;æœåŠ¡è°ƒç”¨ï¼ˆäºŒï¼‰ä¹‹è¿œç¨‹è°ƒç”¨ï¼ˆDubboï¼‰ã€2ã€‘åŒæ­¥è°ƒç”¨</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡åˆ†äº«&nbsp;<code>dubbo://</code>&nbsp;åè®®çš„è¿œç¨‹è°ƒç”¨çš„<strong>ç¬¬äºŒéƒ¨åˆ†ï¼šåŒæ­¥è°ƒç”¨</strong>ã€‚</p>
<p>åœ¨&nbsp;<code>dubbo://</code>&nbsp;åè®®çš„è°ƒç”¨ï¼Œä¸€å…±åˆ†æˆä¸‰ç§ï¼š</p>
<ol>
<li>sync åŒæ­¥è°ƒç”¨</li>
<li>async å¼‚æ­¥è°ƒç”¨</li>
<li>oneway å•å‘è°ƒç”¨</li>
</ol>
<p>å‰ä¸¤ç§æ¯”è¾ƒå¥½ç†è§£ï¼Œéƒ½æ˜¯åŸºäº Request Response æ¨¡å‹ï¼Œå·®å¼‚ç‚¹åœ¨å¼‚æ­¥è°ƒç”¨ï¼ŒæœåŠ¡æ¶ˆè´¹è€…<strong>ä¸é˜»å¡</strong>ç­‰å¾…ç»“æœï¼Œè€Œæ˜¯é€šè¿‡<strong>å›è°ƒ</strong>çš„æ–¹å¼ï¼Œå¤„ç†æœåŠ¡æä¾›è€…è¿”å›çš„ç»“æœã€‚<br />æœ€åä¸€ç§ï¼ŒåŸºäº Message æ¨¡å‹ï¼Œå‘èµ·è°ƒç”¨ï¼Œè€Œä¸å…³æ³¨ç­‰å¾…å’Œå…³æ³¨æ‰§è¡Œç»“æœã€‚<br />å› æ­¤ï¼Œä»æ€§èƒ½ä¸Šï¼šoneway &gt; async &gt; sync ã€‚</p>
<blockquote>
<p>å‹æƒ…æç¤ºï¼šæœ¬æ–‡ä¼šåˆ†äº« sync å’Œ oneway ä¸¤ç§æ–¹å¼ã€‚</p>
</blockquote>
<h1 id="2-é¡ºåºå›¾">2. é¡ºåºå›¾</h1>
<ul>
<li>
<p>æ¶ˆè´¹è€…è°ƒç”¨æœåŠ¡çš„é¡ºåºå›¾ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_10_04/02_01.jpeg" alt="é¡ºåºå›¾" /></p>
<ul>
<li>æ­¤å›¾æ˜¯åœ¨&nbsp;<code>injvm://</code>&nbsp;åè®®çš„é¡ºåºå›¾çš„åŸºç¡€ä¸Šä¿®æ”¹ï¼š
<ul>
<li>å°† InjvmInvoker æ›¿æ¢æˆ DubboInvoker ã€‚</li>
<li>åœ¨&nbsp;<code>#doInvoker()</code>&nbsp;æ–¹æ³•ä¸­ï¼ŒDubboInvoker ä¼šè°ƒç”¨ Client ï¼Œå‘æœåŠ¡æä¾›è€…å‘èµ·è¯·æ±‚ã€‚</li>
</ul>
</li>
<li>å¯èƒ½ä¼šæœ‰èƒ–å‹é—®ï¼Œ<strong>é›†ç¾¤å®¹é”™</strong>å‘¢ï¼Ÿåœ¨ InvokerInvocationHandler ä¹‹åï¼ŒProtocolFilterWrapper$Invoker ä¹‹å‰ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_10_04/02_02.png" alt="é›†ç¾¤å®¹é”™" />
<ul>
<li>ğŸ™‚ æˆ‘ä»¬åé¢ä¸“é—¨å†™å‡ ç¯‡æ–‡ç« ï¼Œä¸“é—¨åˆ†äº«é›†ç¾¤å®¹é”™ï¼Œæ‰€ä»¥æœ¬æ–‡ç•¥è¿‡ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p>æä¾›è€…æä¾›æœåŠ¡çš„é¡ºåºå›¾ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_10_04/02_03.jpeg" alt="é¡ºåºå›¾" /></p>
<ul>
<li>æ­¤å›¾æ˜¯åœ¨&nbsp;<code>injvm://</code>&nbsp;åè®®çš„é¡ºåºå›¾çš„åŸºç¡€ä¸Šä¿®æ”¹ï¼š
<ul>
<li>InjvmInvoker æ›¿æ¢æˆ ExchangeServer ã€‚ä¾‹å¦‚åœ¨ Netty4 ä¸­ï¼ŒIO Worker è§£æè¯·æ±‚ï¼Œè½¬å‘ç»™ ExchangeHandler å¤„ç†ã€‚</li>
<li>InjvmProtocol æ›¿æ¢æˆ DubboProtocol ã€‚åœ¨è¯¥ç±»ä¸­ï¼Œå®ç°äº†è‡ªå®šä¹‰çš„ ExchangeHandler å¤„ç†è¯·æ±‚ã€‚<strong>æ³¨æ„</strong>ï¼Œåœ¨&nbsp;<strong>Dubbo ThreadPool</strong>&nbsp;ä¸­å¤„ç†è¯·æ±‚ï¼Œå‚è§&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/thread-model.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; çº¿ç¨‹æ¨¡å‹ã€‹</a>&nbsp;æ–‡æ¡£ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="3-æ¶ˆè´¹è€…è°ƒç”¨æœåŠ¡">3. æ¶ˆè´¹è€…è°ƒç”¨æœåŠ¡</h1>
<p>è°ƒç”¨&nbsp;<code>DubboInvoker#invoke(Invocation)</code>&nbsp;æ–¹æ³•ï¼Œè°ƒç”¨æœåŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ä½¿ç”¨çš„ {<span class="doctag">@link</span> #clients} çš„ä½ç½®</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicPositiveInteger index = <span class="keyword">new</span> AtomicPositiveInteger();</span><br /><br /><span class="line">  <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> Result <span class="title">doInvoke</span><span class="params">(<span class="keyword">final</span> Invocation invocation)</span> </span>{</span><br /><span class="line">  <span class="number">3</span>:     RpcInvocation inv = (RpcInvocation) invocation;</span><br /><span class="line">  <span class="number">4</span>:     <span class="comment">// è·å¾—æ–¹æ³•å</span></span><br /><span class="line">  <span class="number">5</span>:     <span class="keyword">final</span> String methodName = RpcUtils.getMethodName(invocation);</span><br /><span class="line">  <span class="number">6</span>:     <span class="comment">// è·å¾— `path`( æœåŠ¡å )ï¼Œ`version`</span></span><br /><span class="line">  <span class="number">7</span>:     inv.setAttachment(Constants.PATH_KEY, getUrl().getPath());</span><br /><span class="line">  <span class="number">8</span>:     inv.setAttachment(Constants.VERSION_KEY, version);</span><br /><span class="line">  <span class="number">9</span>: </span><br /><span class="line"> <span class="number">10</span>:     <span class="comment">// è·å¾— ExchangeClient å¯¹è±¡</span></span><br /><span class="line"> <span class="number">11</span>:     ExchangeClient currentClient;</span><br /><span class="line"> <span class="number">12</span>:     <span class="keyword">if</span> (clients.length == <span class="number">1</span>) {</span><br /><span class="line"> <span class="number">13</span>:         currentClient = clients[<span class="number">0</span>];</span><br /><span class="line"> <span class="number">14</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">15</span>:         currentClient = clients[index.getAndIncrement() % clients.length];</span><br /><span class="line"> <span class="number">16</span>:     }</span><br /><span class="line"> <span class="number">17</span>:     <span class="comment">// è¿œç¨‹è°ƒç”¨</span></span><br /><span class="line"> <span class="number">18</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">19</span>:         <span class="comment">// è·å¾—æ˜¯å¦å¼‚æ­¥è°ƒç”¨</span></span><br /><span class="line"> <span class="number">20</span>:         <span class="keyword">boolean</span> isAsync = RpcUtils.isAsync(getUrl(), invocation);</span><br /><span class="line"> <span class="number">21</span>:         <span class="comment">// è·å¾—æ˜¯å¦å•å‘è°ƒç”¨</span></span><br /><span class="line"> <span class="number">22</span>:         <span class="keyword">boolean</span> isOneway = RpcUtils.isOneway(getUrl(), invocation);</span><br /><span class="line"> <span class="number">23</span>:         <span class="comment">// è·å¾—è¶…æ—¶æ—¶é—´</span></span><br /><span class="line"> <span class="number">24</span>:         <span class="keyword">int</span> timeout = getUrl().getMethodParameter(methodName, Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);</span><br /><span class="line"> <span class="number">25</span>:         <span class="comment">// å•å‘è°ƒç”¨</span></span><br /><span class="line"> <span class="number">26</span>:         <span class="keyword">if</span> (isOneway) {</span><br /><span class="line"> <span class="number">27</span>:             <span class="keyword">boolean</span> isSent = getUrl().getMethodParameter(methodName, Constants.SENT_KEY, <span class="keyword">false</span>);</span><br /><span class="line"> <span class="number">28</span>:             currentClient.send(inv, isSent);</span><br /><span class="line"> <span class="number">29</span>:             RpcContext.getContext().setFuture(<span class="keyword">null</span>);</span><br /><span class="line"> <span class="number">30</span>:             <span class="keyword">return</span> <span class="keyword">new</span> RpcResult();</span><br /><span class="line"> <span class="number">31</span>:         <span class="comment">// å¼‚æ­¥è°ƒç”¨</span></span><br /><span class="line"> <span class="number">32</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (isAsync) {</span><br /><span class="line"> <span class="number">33</span>:             ResponseFuture future = currentClient.request(inv, timeout);</span><br /><span class="line"> <span class="number">34</span>:             RpcContext.getContext().setFuture(<span class="keyword">new</span> FutureAdapter&lt;Object&gt;(future));</span><br /><span class="line"> <span class="number">35</span>:             <span class="keyword">return</span> <span class="keyword">new</span> RpcResult();</span><br /><span class="line"> <span class="number">36</span>:         <span class="comment">// åŒæ­¥è°ƒç”¨</span></span><br /><span class="line"> <span class="number">37</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">38</span>:             RpcContext.getContext().setFuture(<span class="keyword">null</span>);</span><br /><span class="line"> <span class="number">39</span>:             <span class="keyword">return</span> (Result) currentClient.request(inv, timeout).get();</span><br /><span class="line"> <span class="number">40</span>:         }</span><br /><span class="line"> <span class="number">41</span>:     } <span class="keyword">catch</span> (TimeoutException e) {</span><br /><span class="line"> <span class="number">42</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(RpcException.TIMEOUT_EXCEPTION, <span class="string">"Invoke remote method timeout. method: "</span> + invocation.getMethodName() + <span class="string">", provider: "</span> + getUrl() + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br /><span class="line"> <span class="number">43</span>:     } <span class="keyword">catch</span> (RemotingException e) {</span><br /><span class="line"> <span class="number">44</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(RpcException.NETWORK_EXCEPTION, <span class="string">"Failed to invoke remote method: "</span> + invocation.getMethodName() + <span class="string">", provider: "</span> + getUrl() + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br /><span class="line"> <span class="number">45</span>:     }</span><br /><span class="line"> <span class="number">46</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ç¬¬ 5 è¡Œï¼šè°ƒç”¨&nbsp;<code>RpcUtils#getMethodName()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æ–¹æ³•åã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getMethodName</span><span class="params">(Invocation invocation)</span> </span>{</span><br /><span class="line">    <span class="comment">// æ³›åŒ–è°ƒç”¨ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ–¹æ³•å</span></span><br /><span class="line">    <span class="keyword">if</span> (Constants.$INVOKE.equals(invocation.getMethodName())</span><br /><span class="line">            &amp;&amp; invocation.getArguments() != <span class="keyword">null</span></span><br /><span class="line">            &amp;&amp; invocation.getArguments().length &gt; <span class="number">0</span></span><br /><span class="line">            &amp;&amp; invocation.getArguments()[<span class="number">0</span>] <span class="keyword">instanceof</span> String) {</span><br /><span class="line">        <span class="keyword">return</span> (String) invocation.getArguments()[<span class="number">0</span>];</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// æ™®é€šè°ƒç”¨ï¼Œç›´æ¥è·å¾—</span></span><br /><span class="line">    <span class="keyword">return</span> invocation.getMethodName();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 6 è‡³ 8 è¡Œï¼šè·å¾—&nbsp;<code>path</code>( æœåŠ¡å )ã€<code>version</code>&nbsp;ã€‚</p>
</li>
<li>ç¬¬ 10 è‡³ 16 è¡Œï¼š<strong>é¡ºåº</strong>ï¼Œè·å¾— ExchangeClient å¯¹è±¡ã€‚</li>
<li>
<p>ç¬¬ 20 è¡Œï¼šè°ƒç”¨&nbsp;<code>RpcUtils#isAsync(url, invocation)</code>&nbsp;æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å¼‚æ­¥è°ƒç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAsync</span><span class="params">(URL url, Invocation inv)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> Boolean.TRUE.toString().equals(inv.getAttachment(Constants.ASYNC_KEY)) <span class="comment">// RpcContext#asyncCall(Callable) æ–¹æ³•ï¼Œå¯ä»¥è®¾ç½®</span></span><br /><span class="line">            || url.getMethodParameter(getMethodName(inv), Constants.ASYNC_KEY, <span class="keyword">false</span>);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è·å¾—æ˜¯å¦å¼‚æ­¥ã€‚æœåŠ¡å¼•ç”¨æˆ–æ–¹æ³•ï¼Œä»»ä¸€é…ç½®&nbsp;<code>async = true</code>&nbsp;ï¼Œå³ä¸ºå¼‚æ­¥ã€‚</li>
</ul>
</li>
<li>
<p>ç¬¬ 22 è¡Œï¼šè°ƒç”¨&nbsp;<code>RpcUtils#isOneway(url, invocation)</code>&nbsp;æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å¼‚æ­¥è°ƒç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isOneway</span><span class="params">(URL url, Invocation inv)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> Boolean.FALSE.toString().equals(inv.getAttachment(Constants.RETURN_KEY)) <span class="comment">// RpcContext#asyncCall(Runnable) æ–¹æ³•ï¼Œå¯ä»¥è®¾ç½®</span></span><br /><span class="line">            || !url.getMethodParameter(getMethodName(inv), Constants.RETURN_KEY, <span class="keyword">true</span>);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è·å¾—æ˜¯å¦å•å‘ã€‚æ–¹æ³•é…ç½®&nbsp;<code>return = true</code>&nbsp;ï¼Œå³ä¸ºå•å‘ã€‚</li>
</ul>
</li>
<li>
<p>ç¬¬ 24 è¡Œï¼šè°ƒç”¨&nbsp;<code>URL#getMethodParameter(method, key, defaultValue)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—è¿œç¨‹è°ƒç”¨è¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚</p>
</li>
<li>ç¬¬ 25 è‡³ 30 è¡Œï¼šoneway å•å‘è°ƒç”¨ã€‚
<ul>
<li>ç¬¬ 28 è¡Œï¼š<strong>æ³¨æ„</strong>ï¼Œè°ƒç”¨çš„æ˜¯&nbsp;<code>ExchangeClient#send(invocation, sent)</code>&nbsp;æ–¹æ³•ï¼Œå‘é€<strong>æ¶ˆæ¯</strong>ï¼Œè€Œä¸æ˜¯<strong>è¯·æ±‚</strong>ã€‚</li>
<li>ç¬¬ 29 è¡Œï¼šè®¾ç½®&nbsp;<code>RpcContext.future = null</code>&nbsp;ï¼Œæ— éœ€ FutureFilter ï¼Œå¼‚æ­¥å›è°ƒã€‚</li>
<li>ç¬¬ 30 è¡Œï¼šåˆ›å»º RpcResult å¯¹è±¡ï¼Œ<strong>ç©ºè¿”å›</strong>ã€‚</li>
</ul>
</li>
<li>ç¬¬ 31 è‡³ 35 è¡Œï¼šasync å¼‚æ­¥è°ƒç”¨ã€‚
<ul>
<li>ç¬¬ 33 è¡Œï¼šè°ƒç”¨&nbsp;<code>ExchangeClient#request(invocation, timeout)</code>&nbsp;æ–¹æ³•ï¼Œå‘é€<strong>è¯·æ±‚</strong>ã€‚</li>
<li>ç¬¬ 34 è¡Œï¼šè°ƒç”¨&nbsp;<code>RpcContext#setFuture(future)</code>&nbsp;æ–¹æ³•ï¼Œåœ¨ FutureFitler ä¸­ï¼Œå¼‚æ­¥å›è°ƒã€‚</li>
<li>ç¬¬ 35 è¡Œï¼šåˆ›å»º RpcResult å¯¹è±¡ï¼Œ<strong>ç©ºè¿”å›</strong>ã€‚</li>
</ul>
</li>
<li>ç¬¬ 36 è‡³ 40 è¡Œï¼šsync åŒæ­¥è°ƒç”¨ã€‚
<ul>
<li>ç¬¬ 38 è¡Œï¼šè®¾ç½®&nbsp;<code>RpcContext.future = null</code>&nbsp;ï¼Œæ— éœ€ FutureFilter ï¼Œå¼‚æ­¥å›è°ƒã€‚</li>
<li>ç¬¬ 39 è¡Œï¼šè°ƒç”¨&nbsp;<code>ExchangeClient#request(invocation, timeout)</code>&nbsp;æ–¹æ³•ï¼Œå‘é€<strong>è¯·æ±‚</strong>ã€‚</li>
<li>ç¬¬ 39 è¡Œï¼šè°ƒç”¨&nbsp;<code>ResponseFuture#get()</code>&nbsp;æ–¹æ³•ï¼Œ<strong>é˜»å¡</strong>ç­‰å¾…ï¼Œè¿”å›ç»“æœã€‚</li>
</ul>
</li>
</ul>
<h1 id="4-æä¾›è€…æä¾›æœåŠ¡">4. æä¾›è€…æä¾›æœåŠ¡</h1>
<p>åœ¨ DubboProtocol ç±»ä¸­ï¼Œå®ç°äº†è‡ªå·±çš„ ExchangeHandler å¯¹è±¡ï¼Œå¤„ç†è¯·æ±‚ã€æ¶ˆæ¯ã€è¿æ¥ã€æ–­å¼€è¿æ¥ç­‰äº‹ä»¶ã€‚å¯¹äºæœåŠ¡æ¶ˆè´¹è€…çš„è¿œç¨‹è°ƒç”¨ï¼Œé€šè¿‡&nbsp;<code>#reply(ExchangeChannel channel, Object message)</code>&nbsp;å’Œ&nbsp;<code>#reply(Channel channel, Object message)</code>&nbsp;æ–¹æ³•æ¥å¤„ç†ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_10_04/02_04.png" alt="ExchangeHandler" /></p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹æ¯ä¸ªæ–¹æ³•çš„å®ç°ä»£ç ã€‚</p>
<h2 id="4-1-reply">4.1 reply</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Object <span class="title">reply</span><span class="params">(ExchangeChannel channel, Object message)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (message <span class="keyword">instanceof</span> Invocation) {</span><br /><span class="line"> <span class="number">4</span>:         Invocation inv = (Invocation) message;</span><br /><span class="line"> <span class="number">5</span>:         <span class="comment">// è·å¾—è¯·æ±‚å¯¹åº”çš„ Invoker å¯¹è±¡</span></span><br /><span class="line"> <span class="number">6</span>:         Invoker&lt;?&gt; invoker = getInvoker(channel, inv);</span><br /><span class="line"> <span class="number">7</span>:         <span class="comment">// å¦‚æœæ˜¯callback éœ€è¦å¤„ç†é«˜ç‰ˆæœ¬è°ƒç”¨ä½ç‰ˆæœ¬çš„é—®é¢˜</span></span><br /><span class="line"> <span class="number">8</span>:         <span class="comment">// need to consider backward-compatibility if it's a callback</span></span><br /><span class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (Boolean.TRUE.toString().equals(inv.getAttachments().get(IS_CALLBACK_SERVICE_INVOKE))) {</span><br /><span class="line"><span class="number">10</span>:             String methodsStr = invoker.getUrl().getParameters().get(<span class="string">"methods"</span>);</span><br /><span class="line"><span class="number">11</span>:             <span class="keyword">boolean</span> hasMethod = <span class="keyword">false</span>;</span><br /><span class="line"><span class="number">12</span>:             <span class="keyword">if</span> (methodsStr == <span class="keyword">null</span> || !methodsStr.contains(<span class="string">","</span>)) {</span><br /><span class="line"><span class="number">13</span>:                 hasMethod = inv.getMethodName().equals(methodsStr);</span><br /><span class="line"><span class="number">14</span>:             } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">15</span>:                 String[] methods = methodsStr.split(<span class="string">","</span>);</span><br /><span class="line"><span class="number">16</span>:                 <span class="keyword">for</span> (String method : methods) {</span><br /><span class="line"><span class="number">17</span>:                     <span class="keyword">if</span> (inv.getMethodName().equals(method)) {</span><br /><span class="line"><span class="number">18</span>:                         hasMethod = <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">19</span>:                         <span class="keyword">break</span>;</span><br /><span class="line"><span class="number">20</span>:                     }</span><br /><span class="line"><span class="number">21</span>:                 }</span><br /><span class="line"><span class="number">22</span>:             }</span><br /><span class="line"><span class="number">23</span>:             <span class="keyword">if</span> (!hasMethod) {</span><br /><span class="line"><span class="number">24</span>:                 logger.warn(<span class="keyword">new</span> IllegalStateException(<span class="string">"The methodName "</span> + inv.getMethodName() + <span class="string">" not found in callback service interface ,invoke will be ignored. please update the api interface. url is:"</span> + invoker.getUrl()) + <span class="string">" ,invocation is :"</span> + inv);</span><br /><span class="line"><span class="number">25</span>:                 <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">26</span>:             }</span><br /><span class="line"><span class="number">27</span>:         }</span><br /><span class="line"><span class="number">28</span>:         <span class="comment">// è®¾ç½®è°ƒç”¨æ–¹çš„åœ°å€</span></span><br /><span class="line"><span class="number">29</span>:         RpcContext.getContext().setRemoteAddress(channel.getRemoteAddress());</span><br /><span class="line"><span class="number">30</span>:         <span class="comment">// æ‰§è¡Œè°ƒç”¨</span></span><br /><span class="line"><span class="number">31</span>:         <span class="keyword">return</span> invoker.invoke(inv);</span><br /><span class="line"><span class="number">32</span>:     }</span><br /><span class="line"><span class="number">33</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(channel, message.getClass().getName() + <span class="string">": "</span> + message</span><br /><span class="line"><span class="number">34</span>:             + <span class="string">", channel: consumer: "</span> + channel.getRemoteAddress() + <span class="string">" --&gt; provider: "</span> + channel.getLocalAddress());</span><br /><span class="line"><span class="number">35</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç”¨äºå¤„ç†æœåŠ¡æ¶ˆè´¹è€…çš„åŒæ­¥è°ƒç”¨å’Œå¼‚æ­¥è°ƒç”¨çš„è¯·æ±‚ã€‚</li>
<li>
<p>ç¬¬ 6 è¡Œï¼šè°ƒç”¨&nbsp;<code>#getInvoker(channel, invocation)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—è¯·æ±‚å¯¹åº”çš„ Invoker å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Exporter é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * key: æœåŠ¡é”® {<span class="doctag">@link</span> #serviceKey(URL)} æˆ– {<span class="doctag">@link</span> URL#getServiceKey()} ã€‚</span></span><br /><span class="line"><span class="comment"> *      ä¸åŒåè®®ä¼šä¸åŒ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Map&lt;String, Exporter&lt;?&gt;&gt; exporterMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Exporter&lt;?&gt;&gt;(); <span class="comment">// FROM çˆ¶ç±» AbstractProtocol.java</span></span><br /><br /><span class="line">  <span class="number">1</span>: Invoker&lt;?&gt; getInvoker(Channel channel, Invocation inv) <span class="keyword">throws</span> RemotingException {</span><br /><span class="line">  <span class="number">2</span>:     <span class="keyword">boolean</span> isCallBackServiceInvoke;</span><br /><span class="line">  <span class="number">3</span>:     <span class="keyword">boolean</span> isStubServiceInvoke;</span><br /><span class="line">  <span class="number">4</span>:     <span class="keyword">int</span> port = channel.getLocalAddress().getPort();</span><br /><span class="line">  <span class="number">5</span>:     String path = inv.getAttachments().get(Constants.PATH_KEY);</span><br /><span class="line">  <span class="number">6</span>:     <span class="comment">// TODO ã€8033 å‚æ•°å›è°ƒã€‘</span></span><br /><span class="line">  <span class="number">7</span>:     <span class="comment">// if it's callback service on client side</span></span><br /><span class="line">  <span class="number">8</span>:     isStubServiceInvoke = Boolean.TRUE.toString().equals(inv.getAttachments().get(Constants.STUB_EVENT_KEY));</span><br /><span class="line">  <span class="number">9</span>:     <span class="keyword">if</span> (isStubServiceInvoke) {</span><br /><span class="line"> <span class="number">10</span>:         port = channel.getRemoteAddress().getPort();</span><br /><span class="line"> <span class="number">11</span>:     }</span><br /><span class="line"> <span class="number">12</span>:     <span class="comment">// å¦‚æœæ˜¯å‚æ•°å›è°ƒï¼Œè·å¾—çœŸæ­£çš„æœåŠ¡å `path` ã€‚</span></span><br /><span class="line"> <span class="number">13</span>:     <span class="comment">// callback</span></span><br /><span class="line"> <span class="number">14</span>:     isCallBackServiceInvoke = isClientSide(channel) &amp;&amp; !isStubServiceInvoke;</span><br /><span class="line"> <span class="number">15</span>:     <span class="keyword">if</span> (isCallBackServiceInvoke) {</span><br /><span class="line"> <span class="number">16</span>:         path = inv.getAttachments().get(Constants.PATH_KEY) + <span class="string">"."</span> + inv.getAttachments().get(Constants.CALLBACK_SERVICE_KEY);</span><br /><span class="line"> <span class="number">17</span>:         inv.getAttachments().put(IS_CALLBACK_SERVICE_INVOKE, Boolean.TRUE.toString());</span><br /><span class="line"> <span class="number">18</span>:     }</span><br /><span class="line"> <span class="number">19</span>:     <span class="comment">// è·å¾—æœåŠ¡å»º</span></span><br /><span class="line"> <span class="number">20</span>:     String serviceKey = serviceKey(port, path, inv.getAttachments().get(Constants.VERSION_KEY), inv.getAttachments().get(Constants.GROUP_KEY));</span><br /><span class="line"> <span class="number">21</span>:     <span class="comment">// è·å¾— Exporter å¯¹è±¡</span></span><br /><span class="line"> <span class="number">22</span>:     DubboExporter&lt;?&gt; exporter = (DubboExporter&lt;?&gt;) exporterMap.get(serviceKey);</span><br /><span class="line"> <span class="number">23</span>:     <span class="comment">// è·å¾— Invoker å¯¹è±¡</span></span><br /><span class="line"> <span class="number">24</span>:     <span class="keyword">if</span> (exporter == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">25</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(channel, <span class="string">"Not found exported service: "</span> + serviceKey + <span class="string">" in "</span> + exporterMap.keySet() + <span class="string">", may be version or group mismatch "</span> + <span class="string">", channel: consumer: "</span> + channel.getRemoteAddress() + <span class="string">" --&gt; provider: "</span> + channel.getLocalAddress() + <span class="string">", message:"</span> + inv);</span><br /><span class="line"> <span class="number">26</span>:     }</span><br /><span class="line"> <span class="number">27</span>:     <span class="keyword">return</span> exporter.getInvoker();</span><br /><span class="line"> <span class="number">28</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 6 è‡³ 11 è¡Œï¼šTODO ã€8033 å‚æ•°å›è°ƒã€‘</li>
<li>ç¬¬ 12 è‡³ 18 è¡Œï¼šå¦‚æœæ˜¯å‚æ•°å›è°ƒï¼Œè·å¾—çœŸæ­£çš„æœåŠ¡å&nbsp;<code>path</code>&nbsp;ã€‚åœ¨<strong>å‚æ•°å›è°ƒ</strong>ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬è¯¦ç»†è§£æã€‚</li>
<li>
<p>ç¬¬ 20 è¡Œï¼šè°ƒç”¨&nbsp;<code>#serviceKey(port, path, version)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æœåŠ¡é”®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> String <span class="title">serviceKey</span><span class="params">(<span class="keyword">int</span> port, String serviceName, String serviceVersion, String serviceGroup)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> ProtocolUtils.serviceKey(port, serviceName, serviceVersion, serviceGroup);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 22 è¡Œï¼šä»&nbsp;<code>exporterMap</code>&nbsp;é›†åˆä¸­ï¼Œè·å¾— Exporter å¯¹è±¡ã€‚</p>
</li>
<li>ç¬¬ 23 è‡³ 27 è¡Œï¼šè·å¾— Invoker å¯¹è±¡ã€‚</li>
</ul>
</li>
<li>
<p>ç¬¬ 8 è‡³ 27 è¡Œï¼šå¦‚æœæ˜¯<strong>å‚æ•°å›è°ƒ</strong>ï¼Œæ ¡éªŒæœåŠ¡æ¶ˆè´¹è€…å®é™…å­˜åœ¨å¯¹åº”çš„å›è°ƒæ–¹æ³•ï¼Œé€šè¿‡æ–¹æ³•ååˆ¤æ–­ã€‚</p>
</li>
<li>ç¬¬ 29 è¡Œï¼šè®¾ç½®è°ƒç”¨æ–¹çš„åœ°å€ã€‚</li>
<li>ç¬¬ 31 è¡Œï¼šè°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œè°ƒç”¨ï¼Œå¹¶è¿”å›ç»“æœã€‚åç»­çš„é€»è¾‘ï¼Œå’Œ&nbsp;<code>injvm://</code>&nbsp;åè®®æ˜¯ä¸€è‡´çš„ã€‚</li>
</ul>
<h2 id="4-2-received">4.2 received</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">received</span><span class="params">(Channel channel, Object message)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    <span class="keyword">if</span> (message <span class="keyword">instanceof</span> Invocation) {</span><br /><span class="line">        <span class="keyword">this</span>.reply((ExchangeChannel) channel, message);</span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        <span class="keyword">super</span>.received(channel, message);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç”¨äºå¤„ç†æœåŠ¡æ¶ˆè´¹è€…çš„<strong>å•æ¬¡è°ƒç”¨</strong>çš„æ¶ˆæ¯ï¼Œé€šè¿‡åˆ¤æ–­æ¶ˆæ¯ç±»å‹æ˜¯ä¸æ˜¯ Invocation ã€‚</li>
</ul>
<h2 id="4-3-connected-amp-amp-disconnected">4.3 connected &amp;&amp; disconnected</h2>
<blockquote>
<p>æœ¬å°èŠ‚å’Œ Dubbo RPC æ— å…³ç³»ï¼Œåªæ˜¯ä¸ºäº†å®Œæ•´åˆ†äº« DubboProtocol ExchangeHandler çš„å®Œæ•´ä»£ç å®ç°ã€‚</p>
</blockquote>
<p>åœ¨æœåŠ¡æä¾›è€…ä¸Šï¼Œæœ‰&nbsp;<code>"onconnect"</code>&nbsp;å’Œ&nbsp;<code>"ondisconnect"</code>&nbsp;é…ç½®é¡¹ï¼Œåœ¨æœåŠ¡æä¾›è€…è¿æ¥æˆ–æ–­å¼€è¿æ¥æ—¶ï¼Œè°ƒç”¨ Service å¯¹åº”çš„æ–¹æ³•ã€‚ç›®å‰è¿™ä¸ªé…ç½®é¡¹ï¼Œåœ¨ Dubbo æ–‡æ¡£é‡Œï¼Œæš‚æœªæåŠã€‚å½“ç„¶ï¼Œè¿™ä¸ªåœ¨å®é™…åœºæ™¯ä¸‹ï¼ŒåŸºæœ¬æ²¡ç”¨è¿‡ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connected</span><span class="params">(Channel channel)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.invoke(channel, Constants.ON_CONNECT_KEY);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disconnected</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line">        logger.info(<span class="string">"disconected from "</span> + channel.getRemoteAddress() + <span class="string">",url:"</span> + channel.getUrl());</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">this</span>.invoke(channel, Constants.ON_DISCONNECT_KEY);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>è°ƒç”¨&nbsp;<code>#invoke(channel, methodKey)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œå¯¹åº”çš„æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è°ƒç”¨æ–¹æ³•</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> channel é€šé“</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> methodKey æ–¹æ³•å</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Channel channel, String methodKey)</span> </span>{</span><br /><span class="line">    <span class="comment">// åˆ›å»º Invocation å¯¹è±¡</span></span><br /><span class="line">    Invocation invocation = createInvocation(channel, channel.getUrl(), methodKey);</span><br /><span class="line">    <span class="comment">// è°ƒç”¨ received æ–¹æ³•ï¼Œæ‰§è¡Œå¯¹åº”çš„æ–¹æ³•</span></span><br /><span class="line">    <span class="keyword">if</span> (invocation != <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            <span class="keyword">this</span>.received(channel, invocation);</span><br /><span class="line">        } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">            logger.warn(<span class="string">"Failed to invoke event method "</span> + invocation.getMethodName() + <span class="string">"(), cause: "</span> + t.getMessage(), t);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Invocation <span class="title">createInvocation</span><span class="params">(Channel channel, URL url, String methodKey)</span> </span>{</span><br /><span class="line">    String method = url.getParameter(methodKey);</span><br /><span class="line">    <span class="keyword">if</span> (method == <span class="keyword">null</span> || method.length() == <span class="number">0</span>) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">    }</span><br /><span class="line">    RpcInvocation invocation = <span class="keyword">new</span> RpcInvocation(method, <span class="keyword">new</span> Class&lt;?&gt;[<span class="number">0</span>], <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br /><span class="line">    invocation.setAttachment(Constants.PATH_KEY, url.getPath());</span><br /><span class="line">    invocation.setAttachment(Constants.GROUP_KEY, url.getParameter(Constants.GROUP_KEY));</span><br /><span class="line">    invocation.setAttachment(Constants.INTERFACE_KEY, url.getParameter(Constants.INTERFACE_KEY));</span><br /><span class="line">    invocation.setAttachment(Constants.VERSION_KEY, url.getParameter(Constants.VERSION_KEY));</span><br /><span class="line">    <span class="keyword">if</span> (url.getParameter(Constants.STUB_EVENT_KEY, <span class="keyword">false</span>)) {</span><br /><span class="line">        invocation.setAttachment(Constants.STUB_EVENT_KEY, Boolean.TRUE.toString());</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> invocation;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
</div>