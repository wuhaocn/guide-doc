<header class="article-header">
<h1 class="article-title">NIO æœåŠ¡å™¨ï¼ˆä¸ƒï¼‰ä¹‹ Netty3 å®ç°</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡æ¥&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-impl-netty4/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ï¼ˆå…­ï¼‰ä¹‹ Netty4 å®ç°ã€‹</a>&nbsp;ä¸€æ–‡ï¼Œåˆ†äº«åœ¨&nbsp;<code>dubbo-remoting-netty</code>&nbsp;ä¸­ï¼ŒNetty3 å¦‚ä½•æ¥å…¥å®ç°ã€‚</p>
<p>å› ä¸º Netty3 çš„æ¥å…¥ä»£ç ï¼Œå’Œ Netty4 åŸºæœ¬æ˜¯ä¸€è‡´ï¼Œä¸»è¦æ˜¯ä¸€äº› Netty ä¸åŒç‰ˆæœ¬çš„ API å·®å¼‚ï¼Œæ‰€ä»¥æœ¬æ–‡ï¼Œä¼šç›¸å¯¹ç®€ä»‹ï¼Œåªé‡ç‚¹åˆ†äº«ä¸€äº›å·®å¼‚çš„åœ°æ–¹ã€‚</p>
<p>æ¶‰åŠå¦‚ä¸‹ç±»ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_12_19/01.png" alt="ç±»å›¾" /></p>
<blockquote>
<p>å‹æƒ…æç¤ºï¼šåœ¨å½“å‰ç‰ˆæœ¬ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Netty3 ï¼Œå¦‚æœæƒ³é…ç½®æˆ Netty4 ï¼Œè¯·å‚è€ƒæ–‡æ¡£ï¼š<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/netty4.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; Netty4ã€‹</a></p>
</blockquote>
<h1 id="2-NettyTransporter">2. NettyTransporter</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyTransporter.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty.NettyTransporter</code></a>&nbsp;ï¼Œå’Œ&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;ä¸€è‡´ï¼Œçœç•¥ã€‚</p>
<h1 id="3-NettyChannel">3. NettyChannel</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyChannel.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty.NettyChannel</code></a>&nbsp;ï¼Œå’Œ&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;ä¸€è‡´ï¼Œçœç•¥ã€‚</p>
<h1 id="4-NettyHandler">4. NettyHandler</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyHandler.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty.NettyHandler</code></a>&nbsp;ï¼Œå®ç°&nbsp;<code>io.netty.channel.ChannelDuplexHandler</code>&nbsp;ç±»ï¼ŒNettyServer å’Œ NettyClient çš„å¤„ç†å™¨ï¼Œ<strong>ç»Ÿä¸€ä½¿ç”¨</strong>ã€‚è¿™ä¸€ç‚¹ï¼Œä¸åŒäº&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;ï¼ŒæœåŠ¡ç«¯å’ŒæœåŠ¡å™¨ä½¿ç”¨ä¸åŒçš„ä¸¤ä¸ªå¤„ç†å™¨ã€‚ç›¸æ¯”æ¥è¯´ï¼Œ<code>dubbo-remoting-netty4</code>&nbsp;æ§åˆ¶æ›´ç²¾ç»†ï¼Œå½±å“ä¸å¤§ã€‚</p>
<p>å½“ç„¶ä¹Ÿæœ‰ä¸€ä¸ªåŸå› ï¼ŒDubbo ChannelHandler åŸºäº&nbsp;<strong>Netty3 çš„ SimpleChannelHandler</strong>&nbsp;ä¸ºè®¾è®¡åŸå‹ã€‚å› æ­¤ï¼Œåœ¨&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;ä¸­ï¼Œéœ€è¦å°† DubboHandler çš„æ–¹æ³•ï¼Œé€‚é…åˆ°&nbsp;<strong>Netty4 çš„ ChannelDuplexHandler</strong>&nbsp;çš„æ–¹æ³•ã€‚</p>
<blockquote>
<p>NettyHandler å’Œ HeaderExchangeHandler ç±»ä¼¼ã€‚</p>
</blockquote>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Sharable</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelHandler</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Dubbo Channel é›†åˆ</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Channel&gt; channels = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Channel&gt;(); <span class="comment">// &lt;ip:port, channel&gt;</span></span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * URL</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Dubbo ChannelHandler</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChannelHandler handler;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NettyHandler</span><span class="params">(URL url, ChannelHandler handler)</span> </span>{</span><br /><span class="line">        <span class="keyword">if</span> (url == <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"url == null"</span>);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">if</span> (handler == <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"handler == null"</span>);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">this</span>.url = url;</span><br /><span class="line">        <span class="keyword">this</span>.handler = handler;</span><br /><span class="line">    }</span><br />    <br /><span class="line">    <span class="comment">// ... çœç•¥å®ç°æ–¹æ³•</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p><strong>å®ç°æ–¹æ³•</strong></p>
<p>æ¯ä¸ªå®ç°çš„æ–¹æ³•ï¼Œè°ƒç”¨&nbsp;<code>handler</code>&nbsp;å¯¹åº”çš„æ–¹æ³•ã€‚ä»¥&nbsp;<code>#channelActive(ChannelHandlerContext)</code>&nbsp;æ–¹æ³•ä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelConnected</span><span class="params">(ChannelHandlerContext ctx, ChannelStateEvent e)</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line">    <span class="comment">// åˆ›å»º NettyChannel å¯¹è±¡</span></span><br /><span class="line">    NettyChannel channel = NettyChannel.getOrAddChannel(ctx.getChannel(), url, handler);</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="comment">// æ·»åŠ åˆ° `channels` ä¸­</span></span><br /><span class="line">        <span class="keyword">if</span> (channel != <span class="keyword">null</span>) {</span><br /><span class="line">            channels.put(NetUtils.toAddressString((InetSocketAddress) ctx.getChannel().getRemoteAddress()), channel);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// æäº¤ç»™ `handler` å¤„ç†å™¨ã€‚</span></span><br /><span class="line">        handler.connected(channel);</span><br /><span class="line">    } <span class="keyword">finally</span> {</span><br /><span class="line">        <span class="comment">// ç§»é™¤ NettyChannel å¯¹è±¡ï¼Œè‹¥å·²æ–­å¼€</span></span><br /><span class="line">        NettyChannel.removeChannelIfDisconnected(ctx.getChannel());</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>ğŸ™‚ å…¶ä»–æ–¹æ³•ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚</p>
<h1 id="5-NettyServer">5. NettyServer</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyServer.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty.NettyServer</code></a>&nbsp;ï¼Œå®ç° Server æ¥å£ï¼Œç»§æ‰¿ AbstractServer æŠ½è±¡ç±»ï¼ŒNetty æœåŠ¡å™¨å®ç°ç±»ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é€šé“é›†åˆ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Map&lt;String, Channel&gt; channels; <span class="comment">// &lt;ip:port, channel&gt;</span></span><br /><br /><span class="line"><span class="keyword">private</span> ServerBootstrap bootstrap;</span><br /><br /><span class="line"><span class="keyword">private</span> org.jboss.netty.channel.Channel channel;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NettyServer</span><span class="params">(URL url, ChannelHandler handler)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    <span class="keyword">super</span>(url, ChannelHandlers.wrap(handler, ExecutorUtil.setThreadName(url, SERVER_THREAD_POOL_NAME)));</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å’Œ&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;åŸºæœ¬ä¸€è‡´ã€‚</li>
</ul>
<p><strong>å¯åŠ¨æœåŠ¡å™¨</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doOpen</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// è®¾ç½®æ—¥å¿—å·¥å‚</span></span><br /><span class="line"> <span class="number">4</span>:     NettyHelper.setNettyLoggerFactory();</span><br /><span class="line"> <span class="number">5</span>: </span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// åˆ›å»ºçº¿ç¨‹æ± </span></span><br /><span class="line"> <span class="number">7</span>:     ExecutorService boss = Executors.newCachedThreadPool(<span class="keyword">new</span> NamedThreadFactory(<span class="string">"NettyServerBoss"</span>, <span class="keyword">true</span>));</span><br /><span class="line"> <span class="number">8</span>:     ExecutorService worker = Executors.newCachedThreadPool(<span class="keyword">new</span> NamedThreadFactory(<span class="string">"NettyServerWorker"</span>, <span class="keyword">true</span>));</span><br /><span class="line"> <span class="number">9</span>: </span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// åˆ›å»º ChannelFactory å¯¹è±¡</span></span><br /><span class="line"><span class="number">11</span>:     ChannelFactory channelFactory = <span class="keyword">new</span> NioServerSocketChannelFactory(boss, worker, getUrl().getPositiveParameter(Constants.IO_THREADS_KEY, Constants.DEFAULT_IO_THREADS));</span><br /><span class="line"><span class="number">12</span>:     <span class="comment">// å®ä¾‹åŒ– ServerBootstrap</span></span><br /><span class="line"><span class="number">13</span>:     bootstrap = <span class="keyword">new</span> ServerBootstrap(channelFactory);</span><br /><span class="line"><span class="number">14</span>: </span><br /><span class="line"><span class="number">15</span>:     <span class="comment">// åˆ›å»º NettyHandler å¯¹è±¡</span></span><br /><span class="line"><span class="number">16</span>:     <span class="keyword">final</span> NettyHandler nettyHandler = <span class="keyword">new</span> NettyHandler(getUrl(), <span class="keyword">this</span>);</span><br /><span class="line"><span class="number">17</span>:     <span class="comment">// è®¾ç½® `channels` å±æ€§</span></span><br /><span class="line"><span class="number">18</span>:     channels = nettyHandler.getChannels();</span><br /><span class="line"><span class="number">19</span>:     <span class="comment">// https://issues.jboss.org/browse/NETTY-365</span></span><br /><span class="line"><span class="number">20</span>:     <span class="comment">// https://issues.jboss.org/browse/NETTY-379</span></span><br /><span class="line"><span class="number">21</span>:     <span class="comment">// final Timer timer = new HashedWheelTimer(new NamedThreadFactory("NettyIdleTimer", true));</span></span><br /><span class="line"><span class="number">22</span>:     bootstrap.setPipelineFactory(<span class="keyword">new</span> ChannelPipelineFactory() {</span><br /><span class="line"><span class="number">23</span>:         <span class="meta">@Override</span></span><br /><span class="line"><span class="number">24</span>:         <span class="function"><span class="keyword">public</span> ChannelPipeline <span class="title">getPipeline</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">25</span>:             <span class="comment">// åˆ›å»º NettyCodecAdapter å¯¹è±¡</span></span><br /><span class="line"><span class="number">26</span>:             NettyCodecAdapter adapter = <span class="keyword">new</span> NettyCodecAdapter(getCodec(), getUrl(), NettyServer.<span class="keyword">this</span>);</span><br /><span class="line"><span class="number">27</span>:             ChannelPipeline pipeline = Channels.pipeline();</span><br /><span class="line"><span class="number">28</span>:             <span class="comment">/*int idleTimeout = getIdleTimeout();</span></span><br /><span class="line"><span class="comment">29:             if (idleTimeout &gt; 10000) {</span></span><br /><span class="line"><span class="comment">30:                 pipeline.addLast("timer", new IdleStateHandler(timer, idleTimeout / 1000, 0, 0));</span></span><br /><span class="line"><span class="comment">31:             }*/</span></span><br /><span class="line"><span class="number">32</span>:             pipeline.addLast(<span class="string">"decoder"</span>, adapter.getDecoder()); <span class="comment">// è§£ç </span></span><br /><span class="line"><span class="number">33</span>:             pipeline.addLast(<span class="string">"encoder"</span>, adapter.getEncoder()); <span class="comment">// è§£ç </span></span><br /><span class="line"><span class="number">34</span>:             pipeline.addLast(<span class="string">"handler"</span>, nettyHandler); <span class="comment">// å¤„ç†å™¨</span></span><br /><span class="line"><span class="number">35</span>:             <span class="keyword">return</span> pipeline;</span><br /><span class="line"><span class="number">36</span>:         }</span><br /><span class="line"><span class="number">37</span>:     });</span><br /><span class="line"><span class="number">38</span>:     <span class="comment">// æœåŠ¡å™¨ç»‘å®šç«¯å£ç›‘å¬</span></span><br /><span class="line"><span class="number">39</span>:     <span class="comment">// bind</span></span><br /><span class="line"><span class="number">40</span>:     channel = bootstrap.bind(getBindAddress());</span><br /><span class="line"><span class="number">41</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å’Œ&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;åŸºæœ¬ä¸€è‡´ï¼Œä¸‹é¢åªè¯´ä¸€äº›å·®å¼‚çš„åœ°æ–¹ã€‚</li>
<li>ç¬¬ 6 è‡³ 8 è¡Œï¼šåˆ›å»ºçº¿ç¨‹æ± ï¼Œä¸åŒäº&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;ä¸­ï¼Œåˆ›å»ºçº¿ç¨‹ç»„ NioEventLoopGroup ã€‚</li>
<li>ç¬¬ 11 è¡Œï¼šåŸºäº&nbsp;<code>boss</code>&nbsp;<code>worker</code>&nbsp;ï¼Œåˆ›å»º ChannelFactory å¯¹è±¡ã€‚</li>
<li><strong>å¹¶æœªè®¾ç½®</strong>&nbsp;ServerBootstrap çš„å¯é€‰é¡¹ã€‚</li>
</ul>
<p><strong>å…³é—­æœåŠ¡å™¨</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doClose</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// å…³é—­æœåŠ¡å™¨é€šé“</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (channel != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">6</span>:             <span class="comment">// unbind.</span></span><br /><span class="line"> <span class="number">7</span>:             channel.close();</span><br /><span class="line"> <span class="number">8</span>:         }</span><br /><span class="line"> <span class="number">9</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">10</span>:         logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">11</span>:     }</span><br /><span class="line"><span class="number">12</span>:     <span class="comment">// å…³é—­è¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é€šé“</span></span><br /><span class="line"><span class="number">13</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">14</span>:         Collection&lt;com.alibaba.dubbo.remoting.Channel&gt; channels = getChannels();</span><br /><span class="line"><span class="number">15</span>:         <span class="keyword">if</span> (channels != <span class="keyword">null</span> &amp;&amp; !channels.isEmpty()) {</span><br /><span class="line"><span class="number">16</span>:             <span class="keyword">for</span> (com.alibaba.dubbo.remoting.Channel channel : channels) {</span><br /><span class="line"><span class="number">17</span>:                 <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">18</span>:                     channel.close();</span><br /><span class="line"><span class="number">19</span>:                 } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">20</span>:                     logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">21</span>:                 }</span><br /><span class="line"><span class="number">22</span>:             }</span><br /><span class="line"><span class="number">23</span>:         }</span><br /><span class="line"><span class="number">24</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">25</span>:         logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">26</span>:     }</span><br /><span class="line"><span class="number">27</span>:     <span class="comment">// ä¼˜é›…å…³é—­ ServerBootstrap</span></span><br /><span class="line"><span class="number">28</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">29</span>:         <span class="keyword">if</span> (bootstrap != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">30</span>:             <span class="comment">// release external resource.</span></span><br /><span class="line"><span class="number">31</span>:             bootstrap.releaseExternalResources();</span><br /><span class="line"><span class="number">32</span>:         }</span><br /><span class="line"><span class="number">33</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">34</span>:         logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">35</span>:     }</span><br /><span class="line"><span class="number">36</span>:     <span class="comment">// æ¸…ç©ºè¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é€šé“</span></span><br /><span class="line"><span class="number">37</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">38</span>:         <span class="keyword">if</span> (channels != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">39</span>:             channels.clear();</span><br /><span class="line"><span class="number">40</span>:         }</span><br /><span class="line"><span class="number">41</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">42</span>:         logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">43</span>:     }</span><br /><span class="line"><span class="number">44</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å’Œ&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;åŸºæœ¬ä¸€è‡´ï¼Œä¸‹é¢åªè¯´ä¸€äº›å·®å¼‚çš„åœ°æ–¹ã€‚</li>
<li>ç¬¬ 27 è‡³ 35 è¡Œï¼šè°ƒç”¨&nbsp;<code>Bootstrap#releaseExternalResources()</code>&nbsp;æ–¹æ³•ï¼Œé‡Šæ”¾ ServerBootstrap ç›¸å…³çš„èµ„æºã€‚</li>
</ul>
<h1 id="6-NettyClient">6. NettyClient</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyClient.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty.NettyClient</code></a>&nbsp;ï¼Œç»§æ‰¿ AbstractNettyClient æŠ½è±¡ç±»ï¼ŒNetty å®¢æˆ·ç«¯å®ç°ç±»ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ChannelFactory's closure has a DirectMemory leak, using static to avoid</span></span><br /><span class="line"><span class="comment">// https://issues.jboss.org/browse/NETTY-424</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ChannelFactory channelFactory = <span class="keyword">new</span> NioClientSocketChannelFactory(Executors.newCachedThreadPool(<span class="keyword">new</span> NamedThreadFactory(<span class="string">"NettyClientBoss"</span>, <span class="keyword">true</span>)),</span><br /><span class="line">        Executors.newCachedThreadPool(<span class="keyword">new</span> NamedThreadFactory(<span class="string">"NettyClientWorker"</span>, <span class="keyword">true</span>)),</span><br /><span class="line">        Constants.DEFAULT_IO_THREADS);</span><br /><br /><span class="line"><span class="keyword">private</span> ClientBootstrap bootstrap;</span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> org.jboss.netty.channel.Channel channel; <span class="comment">// volatile, please copy reference to use</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NettyClient</span><span class="params">(<span class="keyword">final</span> URL url, <span class="keyword">final</span> ChannelHandler handler)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    <span class="keyword">super</span>(url, wrapChannelHandler(url, handler));</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>channelFactory</code>&nbsp;å±æ€§ï¼Œã€TODO 8027ã€‘ä¸ºå•¥å…¬ç”¨</li>
</ul>
<p><strong>å¯åŠ¨å®¢æˆ·ç«¯</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doOpen</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// è®¾ç½®æ—¥å¿—å·¥å‚</span></span><br /><span class="line"> <span class="number">4</span>:     NettyHelper.setNettyLoggerFactory();</span><br /><span class="line"> <span class="number">5</span>: </span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// å®ä¾‹åŒ– ServerBootstrap</span></span><br /><span class="line"> <span class="number">7</span>:     bootstrap = <span class="keyword">new</span> ClientBootstrap(channelFactory);</span><br /><span class="line"> <span class="number">8</span>:     <span class="comment">// è®¾ç½®å¯é€‰é¡¹</span></span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// config</span></span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// @see org.jboss.netty.channel.socket.SocketChannelConfig</span></span><br /><span class="line"><span class="number">11</span>:     bootstrap.setOption(<span class="string">"keepAlive"</span>, <span class="keyword">true</span>);</span><br /><span class="line"><span class="number">12</span>:     bootstrap.setOption(<span class="string">"tcpNoDelay"</span>, <span class="keyword">true</span>);</span><br /><span class="line"><span class="number">13</span>:     bootstrap.setOption(<span class="string">"connectTimeoutMillis"</span>, getTimeout());</span><br /><span class="line"><span class="number">14</span>: </span><br /><span class="line"><span class="number">15</span>:     <span class="comment">// åˆ›å»º NettyHandler å¯¹è±¡</span></span><br /><span class="line"><span class="number">16</span>:     <span class="keyword">final</span> NettyHandler nettyHandler = <span class="keyword">new</span> NettyHandler(getUrl(), <span class="keyword">this</span>);</span><br /><span class="line"><span class="number">17</span>: </span><br /><span class="line"><span class="number">18</span>:     <span class="comment">// è®¾ç½®è´£ä»»é“¾è·¯</span></span><br /><span class="line"><span class="number">19</span>:     bootstrap.setPipelineFactory(<span class="keyword">new</span> ChannelPipelineFactory() {</span><br /><span class="line"><span class="number">20</span>:         <span class="function"><span class="keyword">public</span> ChannelPipeline <span class="title">getPipeline</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">21</span>:             <span class="comment">// åˆ›å»º NettyCodecAdapter å¯¹è±¡</span></span><br /><span class="line"><span class="number">22</span>:             NettyCodecAdapter adapter = <span class="keyword">new</span> NettyCodecAdapter(getCodec(), getUrl(), NettyClient.<span class="keyword">this</span>);</span><br /><span class="line"><span class="number">23</span>:             ChannelPipeline pipeline = Channels.pipeline();</span><br /><span class="line"><span class="number">24</span>:             pipeline.addLast(<span class="string">"decoder"</span>, adapter.getDecoder()); <span class="comment">// è§£ç </span></span><br /><span class="line"><span class="number">25</span>:             pipeline.addLast(<span class="string">"encoder"</span>, adapter.getEncoder()); <span class="comment">// ç¼–ç </span></span><br /><span class="line"><span class="number">26</span>:             pipeline.addLast(<span class="string">"handler"</span>, nettyHandler); <span class="comment">// å¤„ç†å™¨</span></span><br /><span class="line"><span class="number">27</span>:             <span class="keyword">return</span> pipeline;</span><br /><span class="line"><span class="number">28</span>:         }</span><br /><span class="line"><span class="number">29</span>:     });</span><br /><span class="line"><span class="number">30</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å’Œ&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;åŸºæœ¬ä¸€è‡´ã€‚</li>
</ul>
<p><strong>è¿æ¥æœåŠ¡å™¨</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doConnect</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">long</span> start = System.currentTimeMillis();</span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// è¿æ¥æœåŠ¡å™¨</span></span><br /><span class="line"> <span class="number">5</span>:     ChannelFuture future = bootstrap.connect(getConnectAddress());</span><br /><span class="line"> <span class="number">6</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">7</span>:         <span class="comment">// ç­‰å¾…è¿æ¥æˆåŠŸæˆ–è€…è¶…æ—¶</span></span><br /><span class="line"> <span class="number">8</span>:         <span class="keyword">boolean</span> ret = future.awaitUninterruptibly(getConnectTimeout(), TimeUnit.MILLISECONDS);</span><br /><span class="line"> <span class="number">9</span>:         <span class="comment">// è¿æ¥æˆåŠŸ</span></span><br /><span class="line"><span class="number">10</span>:         <span class="keyword">if</span> (ret &amp;&amp; future.isSuccess()) {</span><br /><span class="line"><span class="number">11</span>:             Channel newChannel = future.getChannel();</span><br /><span class="line"><span class="number">12</span>:             newChannel.setInterestOps(Channel.OP_READ_WRITE);</span><br /><span class="line"><span class="number">13</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">14</span>:                 <span class="comment">// å…³é—­è€çš„è¿æ¥</span></span><br /><span class="line"><span class="number">15</span>:                 <span class="comment">// Close old channel</span></span><br /><span class="line"><span class="number">16</span>:                 Channel oldChannel = NettyClient.<span class="keyword">this</span>.channel; <span class="comment">// copy reference</span></span><br /><span class="line"><span class="number">17</span>:                 <span class="keyword">if</span> (oldChannel != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">18</span>:                     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">19</span>:                         <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"><span class="number">20</span>:                             logger.info(<span class="string">"Close old netty channel "</span> + oldChannel + <span class="string">" on create new netty channel "</span> + newChannel);</span><br /><span class="line"><span class="number">21</span>:                         }</span><br /><span class="line"><span class="number">22</span>:                         oldChannel.close();</span><br /><span class="line"><span class="number">23</span>:                     } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">24</span>:                         NettyChannel.removeChannelIfDisconnected(oldChannel);</span><br /><span class="line"><span class="number">25</span>:                     }</span><br /><span class="line"><span class="number">26</span>:                 }</span><br /><span class="line"><span class="number">27</span>:             } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">28</span>:                 <span class="comment">// è‹¥ NettyClient è¢«å…³é—­ï¼Œå…³é—­è¿æ¥</span></span><br /><span class="line"><span class="number">29</span>:                 <span class="keyword">if</span> (NettyClient.<span class="keyword">this</span>.isClosed()) {</span><br /><span class="line"><span class="number">30</span>:                     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">31</span>:                         <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"><span class="number">32</span>:                             logger.info(<span class="string">"Close new netty channel "</span> + newChannel + <span class="string">", because the client closed."</span>);</span><br /><span class="line"><span class="number">33</span>:                         }</span><br /><span class="line"><span class="number">34</span>:                         newChannel.close();</span><br /><span class="line"><span class="number">35</span>:                     } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">36</span>:                         NettyClient.<span class="keyword">this</span>.channel = <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">37</span>:                         NettyChannel.removeChannelIfDisconnected(newChannel);</span><br /><span class="line"><span class="number">38</span>:                     }</span><br /><span class="line"><span class="number">39</span>:                 <span class="comment">// è®¾ç½®æ–°è¿æ¥</span></span><br /><span class="line"><span class="number">40</span>:                 } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">41</span>:                     NettyClient.<span class="keyword">this</span>.channel = newChannel;</span><br /><span class="line"><span class="number">42</span>:                 }</span><br /><span class="line"><span class="number">43</span>:             }</span><br /><span class="line"><span class="number">44</span>:         <span class="comment">// å‘ç”Ÿå¼‚å¸¸ï¼ŒæŠ›å‡º RemotingException å¼‚å¸¸</span></span><br /><span class="line"><span class="number">45</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (future.getCause() != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">46</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(<span class="keyword">this</span>, <span class="string">"client(url: "</span> + getUrl() + <span class="string">") failed to connect to server "</span></span><br /><span class="line"><span class="number">47</span>:                     + getRemoteAddress() + <span class="string">", error message is:"</span> + future.getCause().getMessage(), future.getCause());</span><br /><span class="line"><span class="number">48</span>:         <span class="comment">// æ— ç»“æœï¼ˆè¿æ¥è¶…æ—¶ï¼‰ï¼ŒæŠ›å‡º RemotingException å¼‚å¸¸</span></span><br /><span class="line"><span class="number">49</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">50</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(<span class="keyword">this</span>, <span class="string">"client(url: "</span> + getUrl() + <span class="string">") failed to connect to server "</span></span><br /><span class="line"><span class="number">51</span>:                     + getRemoteAddress() + <span class="string">" client-side timeout "</span></span><br /><span class="line"><span class="number">52</span>:                     + getConnectTimeout() + <span class="string">"ms (elapsed: "</span> + (System.currentTimeMillis() - start) + <span class="string">"ms) from netty client "</span></span><br /><span class="line"><span class="number">53</span>:                     + NetUtils.getLocalHost() + <span class="string">" using dubbo version "</span> + Version.getVersion());</span><br /><span class="line"><span class="number">54</span>:         }</span><br /><span class="line"><span class="number">55</span>:     } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">56</span>:         <span class="comment">// æœªè¿æ¥ï¼Œå–æ¶ˆä»»åŠ¡</span></span><br /><span class="line"><span class="number">57</span>:         <span class="keyword">if</span> (!isConnected()) {</span><br /><span class="line"><span class="number">58</span>:             future.cancel();</span><br /><span class="line"><span class="number">59</span>:         }</span><br /><span class="line"><span class="number">60</span>:     }</span><br /><span class="line"><span class="number">61</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å’Œ&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;åŸºæœ¬ä¸€è‡´ï¼Œä¸‹é¢åªè¯´ä¸€äº›å·®å¼‚çš„åœ°æ–¹ã€‚</li>
<li>ç¬¬ 9 è¡Œï¼šè°ƒç”¨&nbsp;<code>ChannelFuture#awaitUninterruptibly(timeout, TimeUnit)</code>&nbsp;æ–¹æ³•ï¼Œç­‰å¾…è¿æ¥æˆåŠŸæˆ–è¶…æ—¶ã€‚è¿™é‡Œä¼ å…¥çš„ä¸æ˜¯&nbsp;<code>3000</code>&nbsp;ã€‚</li>
<li>ç¬¬ 55 è‡³ 60 è¡Œï¼šæœ€ç»ˆç»“æœä¸ºæœªè¿æ¥ï¼Œè°ƒç”¨&nbsp;<code>ChannelFuture#cancel(true)</code>&nbsp;æ–¹æ³•ï¼Œå–æ¶ˆä»»åŠ¡ã€‚</li>
</ul>
<p><strong>å…³é—­è¿æ¥</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doClose</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>{</span><br /><span class="line">    <span class="comment">/*try {</span></span><br /><span class="line"><span class="comment">            bootstrap.releaseExternalResources();</span></span><br /><span class="line"><span class="comment">        } catch (Throwable t) {</span></span><br /><span class="line"><span class="comment">            logger.warn(t.getMessage());</span></span><br /><span class="line"><span class="comment">        }*/</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å› ä¸º&nbsp;<code>channelFactory</code>&nbsp;æ˜¯<strong>é™æ€</strong>å±æ€§ï¼Œè¢«å¤šä¸ª NettyClient å…±ç”¨ã€‚</li>
</ul>
<h1 id="7-Buffer">7. Buffer</h1>
<h2 id="7-1-NettyBackedChannelBuffer">7.1 NettyBackedChannelBuffer</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyBackedChannelBuffer.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty.NettyBackedChannelBuffer</code></a>&nbsp;ï¼Œå®ç° ChannelBuffer æ¥å£ï¼ŒåŸºäº&nbsp;<strong>Netty3 ChannelBuffer</strong>&nbsp;çš„ ChannelBuffer å®ç°ç±»ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> org.jboss.netty.buffer.ChannelBuffer buffer;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NettyBackedChannelBuffer</span><span class="params">(org.jboss.netty.buffer.ChannelBuffer buffer)</span> </span>{</span><br /><span class="line">    Assert.notNull(buffer, <span class="string">"buffer == null"</span>);</span><br /><span class="line">    <span class="keyword">this</span>.buffer = buffer;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p><strong>å·¥å‚</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> ChannelBufferFactory <span class="title">factory</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> NettyBackedChannelBufferFactory.getInstance();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¯¹åº”çš„å·¥å‚æ˜¯ NettyBackedChannelBufferFactory</li>
</ul>
<p><strong>å®ç°æ–¹æ³•</strong></p>
<p>æ¯ä¸ªæ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ Netty3 ChannelBuffer å¯¹åº”çš„æ–¹æ³•ã€‚</p>
<h2 id="7-2-NettyBackedChannelBufferFactory">7.2 NettyBackedChannelBufferFactory</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyBackedChannelBufferFactory.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty.NettyBackedChannelBufferFactory</code></a>&nbsp;ï¼Œå®ç° ChannelBufferFactory æ¥å£ï¼Œåˆ›å»º NettyBackedChannelBuffer çš„å·¥å‚ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> ChannelBuffer <span class="title">getBuffer</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NettyBackedChannelBuffer(ChannelBuffers.dynamicBuffer(capacity)); <span class="comment">// ChannelBuffers ä¸º `org.jboss.netty.buffer` åŒ…ä¸‹</span></span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> ChannelBuffer <span class="title">getBuffer</span><span class="params">(<span class="keyword">byte</span>[] array, <span class="keyword">int</span> offset, <span class="keyword">int</span> length)</span> </span>{</span><br /><span class="line">    <span class="comment">// åˆ›å»º Netty3 ChannelBuffer å¯¹è±¡</span></span><br /><span class="line">    org.jboss.netty.buffer.ChannelBuffer buffer = ChannelBuffers.dynamicBuffer(length); <span class="comment">// ChannelBuffers ä¸º `org.jboss.netty.buffer` åŒ…ä¸‹</span></span><br /><span class="line">    <span class="comment">// å†™å…¥æ•°æ®</span></span><br /><span class="line">    buffer.writeBytes(array, offset, length);</span><br /><span class="line">    <span class="comment">// åˆ›å»º NettyBackedChannelBuffer å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NettyBackedChannelBuffer(buffer);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> ChannelBuffer <span class="title">getBuffer</span><span class="params">(ByteBuffer nioBuffer)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> NettyBackedChannelBuffer(ChannelBuffers.wrappedBuffer(nioBuffer)); <span class="comment">// ChannelBuffers ä¸º `org.jboss.netty.buffer` åŒ…ä¸‹</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><strong>æ³¨æ„</strong>ï¼Œæ­¤å¤„çš„ ChannelBuffers æ˜¯&nbsp;<code>org.jboss.netty.buffer</code>&nbsp;åŒ…ä¸‹çš„ã€‚</li>
</ul>
<h1 id="8-NettyCodecAdapter">8. NettyCodecAdapter</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyCodecAdapter.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty.NettyCodecAdapter</code></a>&nbsp;ï¼ŒNetty ç¼–è§£ç <strong>é€‚é…å™¨</strong>ï¼Œå°†&nbsp;<strong>Dubbo ç¼–è§£ç å™¨</strong>&nbsp;é€‚é…æˆ Netty3 çš„ç¼–ç å™¨å’Œè§£ç å™¨ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Netty ç¼–ç å™¨</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelHandler encoder = <span class="keyword">new</span> InternalEncoder();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Netty è§£ç å™¨</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelHandler decoder = <span class="keyword">new</span> InternalDecoder();</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Dubbo ç¼–è§£ç å™¨</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Codec2 codec;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Dubbo URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ç½‘ç»œè¯»å†™ç¼“å†²åŒºå¤§å°</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> bufferSize;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Dubbo ChannelHandler</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> com.alibaba.dubbo.remoting.ChannelHandler handler;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NettyCodecAdapter</span><span class="params">(Codec2 codec, URL url, com.alibaba.dubbo.remoting.ChannelHandler handler)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.codec = codec;</span><br /><span class="line">    <span class="keyword">this</span>.url = url;</span><br /><span class="line">    <span class="keyword">this</span>.handler = handler;</span><br /><span class="line">    <span class="comment">// è®¾ç½® `bufferSize`</span></span><br /><span class="line">    <span class="keyword">int</span> b = url.getPositiveParameter(Constants.BUFFER_KEY, Constants.DEFAULT_BUFFER_SIZE);</span><br /><span class="line">    <span class="keyword">this</span>.bufferSize = b &gt;= Constants.MIN_BUFFER_SIZE &amp;&amp; b &lt;= Constants.MAX_BUFFER_SIZE ? b : Constants.DEFAULT_BUFFER_SIZE;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>bufferSize</code>&nbsp;å±æ€§ï¼Œç½‘ç»œè¯»å†™ç¼“å†²åŒºå¤§å°ï¼Œé»˜è®¤ 8K ã€‚è¿™æ˜¯&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;çš„ NettyCodecAdapter æ‰€<strong>ä¸éœ€è¦</strong>çš„ã€‚ç”¨äºä¸‹é¢&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-impl-netty3/">ã€Œ8.2 InternalDecoderã€</a>&nbsp;ï¼Œæ¶ˆæ¯è§£ç æ—¶ä½¿ç”¨ã€‚</li>
</ul>
<h2 id="8-1-InternalEncoder">8.1 InternalEncoder</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Sharable</span></span><br /><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalEncoder</span> <span class="keyword">extends</span> <span class="title">OneToOneEncoder</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, Channel ch, Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line">        <span class="comment">// åˆ›å»º HeapChannelBuffer å¯¹è±¡</span></span><br /><span class="line">        com.alibaba.dubbo.remoting.buffer.ChannelBuffer buffer = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.dynamicBuffer(<span class="number">1024</span>);</span><br /><span class="line">        <span class="comment">// è·å¾— NettyChannel å¯¹è±¡</span></span><br /><span class="line">        NettyChannel channel = NettyChannel.getOrAddChannel(ch, url, handler);</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            <span class="comment">// ç¼–ç </span></span><br /><span class="line">            codec.encode(channel, buffer, msg);</span><br /><span class="line">        } <span class="keyword">finally</span> {</span><br /><span class="line">            <span class="comment">// ç§»é™¤ NettyChannel å¯¹è±¡ï¼Œè‹¥æ–­å¼€è¿æ¥</span></span><br /><span class="line">            NettyChannel.removeChannelIfDisconnected(ch);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// è¿”å› Netty ChannelBuffer å¯¹è±¡</span></span><br /><span class="line">        <span class="keyword">return</span> ChannelBuffers.wrappedBuffer(buffer.toByteBuffer());</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>org.jboss.netty.handler.codec.oneone.OneToOneEncoder</code>&nbsp;ï¼ŒNetty3 ç¼–ç å™¨<strong>æŠ½è±¡ç±»</strong>ã€‚</li>
<li>ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚</li>
</ul>
<h2 id="8-2-InternalDecoder">8.2 InternalDecoder</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalDecoder</span> <span class="keyword">extends</span> <span class="title">SimpleChannelUpstreamHandler</span> </span>{</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 4:      * æœªè¯»å®Œçš„æ¶ˆæ¯ Buffer</span></span><br /><span class="line"><span class="comment"> 5:      */</span></span><br /><span class="line"> <span class="number">6</span>:     <span class="keyword">private</span> com.alibaba.dubbo.remoting.buffer.ChannelBuffer buffer = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.EMPTY_BUFFER;</span><br /><span class="line"> <span class="number">7</span>: </span><br /><span class="line"> <span class="number">8</span>:     <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">9</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">messageReceived</span><span class="params">(ChannelHandlerContext ctx, MessageEvent event)</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line"><span class="number">10</span>:         <span class="comment">// è·³è¿‡é ChannelBuffer</span></span><br /><span class="line"><span class="number">11</span>:         Object o = event.getMessage();</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> ChannelBuffer)) {</span><br /><span class="line"><span class="number">13</span>:             ctx.sendUpstream(event);</span><br /><span class="line"><span class="number">14</span>:             <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">15</span>:         }</span><br /><span class="line"><span class="number">16</span>: </span><br /><span class="line"><span class="number">17</span>:         <span class="comment">// æ— å¯è¯»ï¼Œè·³è¿‡</span></span><br /><span class="line"><span class="number">18</span>:         ChannelBuffer input = (ChannelBuffer) o;</span><br /><span class="line"><span class="number">19</span>:         <span class="keyword">int</span> readable = input.readableBytes();</span><br /><span class="line"><span class="number">20</span>:         <span class="keyword">if</span> (readable &lt;= <span class="number">0</span>) {</span><br /><span class="line"><span class="number">21</span>:             <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">22</span>:         }</span><br /><span class="line"><span class="number">23</span>: </span><br /><span class="line"><span class="number">24</span>:         <span class="comment">// åˆå¹¶ `buffer` + `input` æˆ `message`</span></span><br /><span class="line"><span class="number">25</span>:         com.alibaba.dubbo.remoting.buffer.ChannelBuffer message;</span><br /><span class="line"><span class="number">26</span>:         <span class="keyword">if</span> (buffer.readable()) { <span class="comment">// æœ‰æœªè¯»å®Œçš„ï¼Œéœ€è¦æ‹¼æ¥</span></span><br /><span class="line"><span class="number">27</span>:             <span class="keyword">if</span> (buffer <span class="keyword">instanceof</span> DynamicChannelBuffer) {</span><br /><span class="line"><span class="number">28</span>:                 buffer.writeBytes(input.toByteBuffer());</span><br /><span class="line"><span class="number">29</span>:                 message = buffer;</span><br /><span class="line"><span class="number">30</span>:             } <span class="keyword">else</span> { <span class="comment">// Netty3 ChannelBuffer ï¼Œè½¬æˆ DynamicChannelBuffer ã€‚</span></span><br /><span class="line"><span class="number">31</span>:                 <span class="keyword">int</span> size = buffer.readableBytes() + input.readableBytes();</span><br /><span class="line"><span class="number">32</span>:                 message = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.dynamicBuffer(size &gt; bufferSize ? size : bufferSize);</span><br /><span class="line"><span class="number">33</span>:                 message.writeBytes(buffer, buffer.readableBytes());</span><br /><span class="line"><span class="number">34</span>:                 message.writeBytes(input.toByteBuffer());</span><br /><span class="line"><span class="number">35</span>:             }</span><br /><span class="line"><span class="number">36</span>:         } <span class="keyword">else</span> { <span class="comment">// æ— æœªè¯»å®Œçš„ï¼Œç›´æ¥åˆ›å»º</span></span><br /><span class="line"><span class="number">37</span>:             message = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.wrappedBuffer(input.toByteBuffer());</span><br /><span class="line"><span class="number">38</span>:         }</span><br /><span class="line"><span class="number">39</span>: </span><br /><span class="line"><span class="number">40</span>:         <span class="comment">// è·å¾— NettyChannel å¯¹è±¡</span></span><br /><span class="line"><span class="number">41</span>:         NettyChannel channel = NettyChannel.getOrAddChannel(ctx.getChannel(), url, handler);</span><br /><span class="line"><span class="number">42</span>:         <span class="comment">// å¾ªç¯è§£æï¼Œç›´åˆ°ç»“æŸ</span></span><br /><span class="line"><span class="number">43</span>:         Object msg;</span><br /><span class="line"><span class="number">44</span>:         <span class="keyword">int</span> saveReaderIndex;</span><br /><span class="line"><span class="number">45</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">46</span>:             <span class="comment">// decode object.</span></span><br /><span class="line"><span class="number">47</span>:             <span class="keyword">do</span> {</span><br /><span class="line"><span class="number">48</span>:                 saveReaderIndex = message.readerIndex();</span><br /><span class="line"><span class="number">49</span>:                 <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">50</span>:                     msg = codec.decode(channel, message);</span><br /><span class="line"><span class="number">51</span>:                 } <span class="keyword">catch</span> (IOException e) {</span><br /><span class="line"><span class="number">52</span>:                     buffer = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.EMPTY_BUFFER;</span><br /><span class="line"><span class="number">53</span>:                     <span class="keyword">throw</span> e;</span><br /><span class="line"><span class="number">54</span>:                 }</span><br /><span class="line"><span class="number">55</span>:                 <span class="keyword">if</span> (msg == Codec2.DecodeResult.NEED_MORE_INPUT) {</span><br /><span class="line"><span class="number">56</span>:                     message.readerIndex(saveReaderIndex);</span><br /><span class="line"><span class="number">57</span>:                     <span class="keyword">break</span>;</span><br /><span class="line"><span class="number">58</span>:                 <span class="comment">// è§£ç åˆ°æ¶ˆæ¯ï¼Œè§¦å‘ä¸€æ¡æ¶ˆæ¯</span></span><br /><span class="line"><span class="number">59</span>:                 } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">60</span>:                     <span class="comment">//is it possible to go here ? èŠ‹è‰¿ï¼šä¸å¯èƒ½ï¼Œå“ˆå“ˆå“ˆ</span></span><br /><span class="line"><span class="number">61</span>:                     <span class="keyword">if</span> (saveReaderIndex == message.readerIndex()) {</span><br /><span class="line"><span class="number">62</span>:                         buffer = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.EMPTY_BUFFER;</span><br /><span class="line"><span class="number">63</span>:                         <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Decode without read data."</span>);</span><br /><span class="line"><span class="number">64</span>:                     }</span><br /><span class="line"><span class="number">65</span>:                     <span class="keyword">if</span> (msg != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">66</span>:                         Channels.fireMessageReceived(ctx, msg, event.getRemoteAddress());</span><br /><span class="line"><span class="number">67</span>:                     }</span><br /><span class="line"><span class="number">68</span>:                 }</span><br /><span class="line"><span class="number">69</span>:             } <span class="keyword">while</span> (message.readable());</span><br /><span class="line"><span class="number">70</span>:         } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">71</span>:             <span class="comment">// æœ‰å‰©ä½™å¯è¯»çš„ï¼Œå‹ç¼©å¹¶ç¼“å­˜</span></span><br /><span class="line"><span class="number">72</span>:             <span class="keyword">if</span> (message.readable()) {</span><br /><span class="line"><span class="number">73</span>:                 message.discardReadBytes();</span><br /><span class="line"><span class="number">74</span>:                 buffer = message;</span><br /><span class="line"><span class="number">75</span>:             <span class="comment">// æ— å‰©ä½™çš„ï¼Œè®¾ç½®ç©º Buffer</span></span><br /><span class="line"><span class="number">76</span>:             } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">77</span>:                 buffer = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.EMPTY_BUFFER;</span><br /><span class="line"><span class="number">78</span>:             }</span><br /><span class="line"><span class="number">79</span>:             <span class="comment">// ç§»é™¤ NettyChannel å¯¹è±¡ï¼Œè‹¥æ–­å¼€è¿æ¥</span></span><br /><span class="line"><span class="number">80</span>:             NettyChannel.removeChannelIfDisconnected(ctx.getChannel());</span><br /><span class="line"><span class="number">81</span>:         }</span><br /><span class="line"><span class="number">82</span>:     }</span><br /><span class="line"><span class="number">83</span>: </span><br /><span class="line"><span class="number">84</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">85</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, ExceptionEvent e)</span> </span>{</span><br /><span class="line"><span class="number">86</span>:         ctx.sendUpstream(e);</span><br /><span class="line"><span class="number">87</span>:     }</span><br /><span class="line"><span class="number">88</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç»§æ‰¿&nbsp;<code>org.jboss.netty.channel.SimpleChannelUpstreamHandler</code>&nbsp;ç±»ã€‚</li>
<li><code>buffer</code>&nbsp;å±æ€§ï¼Œæœªè¯»å®Œçš„æ¶ˆæ¯ Buffer ã€‚åœ¨&nbsp;<code>#messageReceived(ctx, event)</code>&nbsp;æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åœ¨åšæ‹†åŒ…ç²˜åŒ…çš„å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½æ”¶åˆ°æ•°æ®æ˜¯ä¸å®Œæ•´çš„ã€‚ä¾‹å¦‚ï¼Œä¸è¶³ä»¥è§£ææˆä¸€æ¡ Dubbo Request ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±éœ€è¦å°†æ”¶åˆ°çš„ï¼Œç¼“å­˜åˆ°&nbsp;<code>buffer</code>&nbsp;ä¸­ã€‚</li>
<li>ç¬¬ 10 è‡³ 15 è¡Œï¼šè·³è¿‡é ChannelBuffer ã€‚</li>
<li>ç¬¬ 17 è‡³ 22 è¡Œï¼šè·³è¿‡æ— å¯è¯»çš„ã€‚</li>
<li>ç¬¬ 24 è‡³ 38 è¡Œï¼šåˆå¹¶&nbsp;<code>buffer</code>&nbsp;+&nbsp;<code>input</code>&nbsp;æˆ&nbsp;<code>message</code>&nbsp;ã€‚æœ‰<strong>ä¸¤ç±»ä¸‰ç§</strong>æƒ…å†µï¼Œèƒ–å‹çœ‹ä¸‹æ³¨é‡Šã€‚</li>
<li>ç¬¬ 41 è¡Œï¼šè·å¾— NettyChannel å¯¹è±¡ã€‚</li>
<li>ç¬¬ 42 è‡³ 69 è¡Œï¼šå¾ªç¯è§£æï¼Œç›´åˆ°ç»“æŸã€‚æ­¤å¤„ï¼Œå’Œ&nbsp;<code>dubbo-remoting-netty4</code>&nbsp;çš„è§£ç æµç¨‹ï¼Œå°±æ˜¯ä¸€è‡´çš„äº†ã€‚</li>
<li>ç¬¬ 71 è‡³ 75 è¡Œï¼šæœ‰å‰©ä½™çš„éƒ¨åˆ†ï¼Œå‹ç¼©å¹¶ç¼“å­˜åˆ°&nbsp;<code>buffer</code>&nbsp;ä¸­ã€‚</li>
<li>ç¬¬ 75 è‡³ 78 è¡Œï¼šå®Œå…¨è¯»å®Œï¼Œè®¾ç½®&nbsp;<code>buffer</code>&nbsp;ä¸ºç©º(&nbsp;<code>EMPTY_BUFFER</code>&nbsp;)ã€‚</li>
<li>ç¬¬ 80 è¡Œï¼šç§»é™¤ NettyChannel å¯¹è±¡ï¼Œè‹¥æ–­å¼€è¿æ¥ã€‚</li>
</ul>
<h1 id="9-æ—¥å¿—å·¥å‚">9. æ—¥å¿—å·¥å‚</h1>
<p>å’Œ&nbsp;<code>netty-remoting-netty4</code>&nbsp;çš„<strong>æ—¥å¿—å·¥å‚</strong>ï¼ŒåŸºæœ¬ä¸€è‡´ã€‚å·®å¼‚ç‚¹æ˜¯&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyHelper.java#L43-L103" target="_blank" rel="external nofollow noopener noreferrer">DubboLogger</a>&nbsp;ï¼Œæ— éœ€å®ç°ç±»ä¼¼&nbsp;<code>#log(format, arguments)</code>&nbsp;ç­‰éœ€è¦æ ¼å¼åŒ–çš„æ–¹æ³•ã€‚å› æ­¤ï¼Œæ— éœ€å¤åˆ¶ FormattingTuple ã€MessageFormatter ç±»ã€‚</p>
</div>