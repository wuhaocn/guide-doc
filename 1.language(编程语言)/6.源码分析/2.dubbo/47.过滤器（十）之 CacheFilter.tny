<header class="article-header">
<h1 class="article-title">è¿‡æ»¤å™¨ï¼ˆåï¼‰ä¹‹ CacheFilter</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡åˆ†äº«&nbsp;<code>dubbo-filter-cache</code>&nbsp;é¡¹ç›®çš„ CacheFilter è¿‡æ»¤å™¨ï¼Œç”¨äºæœåŠ¡<strong>æ¶ˆè´¹è€…</strong>å’Œ<strong>æä¾›è€…</strong>ä¸­ï¼Œæä¾›&nbsp;<strong>ç»“æœç¼“å­˜</strong>çš„åŠŸèƒ½ã€‚åœ¨&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/result-cache.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; ç»“æœç¼“å­˜ã€‹</a>&nbsp;å®šä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>ç»“æœç¼“å­˜ ï¼Œç”¨äºåŠ é€Ÿçƒ­é—¨æ•°æ®çš„è®¿é—®é€Ÿåº¦ï¼ŒDubbo æä¾›å£°æ˜å¼ç¼“å­˜ï¼Œä»¥å‡å°‘ç”¨æˆ·åŠ ç¼“å­˜çš„å·¥ä½œé‡ã€‚</p>
</blockquote>
<p>Dubbo æä¾›äº†<strong>ä¸‰ç§</strong>å®ç°ï¼š</p>
<blockquote>
<ul>
<li><code>lru</code>&nbsp;ï¼šåŸºäºæœ€è¿‘æœ€å°‘ä½¿ç”¨åŸåˆ™åˆ é™¤å¤šä½™ç¼“å­˜ï¼Œä¿æŒæœ€çƒ­çš„æ•°æ®è¢«ç¼“å­˜ã€‚</li>
<li><code>threadlocal</code>&nbsp;ï¼šå½“å‰çº¿ç¨‹ç¼“å­˜ï¼Œæ¯”å¦‚ä¸€ä¸ªé¡µé¢æ¸²æŸ“ï¼Œç”¨åˆ°å¾ˆå¤š portalï¼Œæ¯ä¸ª portal éƒ½è¦å»æŸ¥ç”¨æˆ·ä¿¡æ¯ï¼Œé€šè¿‡çº¿ç¨‹ç¼“å­˜ï¼Œå¯ä»¥å‡å°‘è¿™ç§å¤šä½™è®¿é—®ã€‚</li>
<li><code>jcache</code>&nbsp;ï¼šä¸&nbsp;<a href="https://jcp.org/en/jsr/detail?id=107" target="_blank" rel="external nofollow noopener noreferrer">JSR107</a>&nbsp;é›†æˆï¼Œå¯ä»¥æ¡¥æ¥å„ç§ç¼“å­˜å®ç°ã€‚</li>
</ul>
</blockquote>
<ul>
<li>å…·ä½“çš„é…ç½®æ–¹å¼ï¼Œåœ¨&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/result-cache.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; ç»“æœç¼“å­˜ã€‹</a>&nbsp;æ–‡æ¡£ä¸­ï¼Œå·²ç»è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
<p>æœ¬æ–‡æ¶‰åŠçš„ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_11_21/01.png" alt="ç±»å›¾" /></p>
<h1 id="2-CacheFilter">2. CacheFilter</h1>
<p><code>com.alibaba.dubbo.cache.filter.CacheFilter</code>&nbsp;ï¼Œå®ç° Filter æ¥å£ï¼Œç¼“å­˜è¿‡æ»¤å™¨å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Activate</span>(group = {Constants.CONSUMER, Constants.PROVIDER}, value = Constants.CACHE_KEY)</span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>{</span><br /><span class="line"> <span class="number">3</span>: </span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 5:      * CacheFactory$Adaptive å¯¹è±¡ã€‚</span></span><br /><span class="line"><span class="comment"> 6:      *</span></span><br /><span class="line"><span class="comment"> 7:      * é€šè¿‡ Dubbo SPI æœºåˆ¶ï¼Œè°ƒç”¨ {<span class="doctag">@link</span> #setCacheFactory(CacheFactory)} æ–¹æ³•ï¼Œè¿›è¡Œæ³¨å…¥</span></span><br /><span class="line"><span class="comment"> 8:      */</span></span><br /><span class="line"> <span class="number">9</span>:     <span class="keyword">private</span> CacheFactory cacheFactory;</span><br /><span class="line"><span class="number">10</span>: </span><br /><span class="line"><span class="number">11</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCacheFactory</span><span class="params">(CacheFactory cacheFactory)</span> </span>{</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">this</span>.cacheFactory = cacheFactory;</span><br /><span class="line"><span class="number">13</span>:     }</span><br /><span class="line"><span class="number">14</span>: </span><br /><span class="line"><span class="number">15</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">16</span>:     <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"><span class="number">17</span>:         <span class="comment">// æ–¹æ³•å¼€å¯ Cache åŠŸèƒ½</span></span><br /><span class="line"><span class="number">18</span>:         <span class="keyword">if</span> (cacheFactory != <span class="keyword">null</span> &amp;&amp; ConfigUtils.isNotEmpty(invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.CACHE_KEY))) {</span><br /><span class="line"><span class="number">19</span>:             <span class="comment">// åŸºäº URL + Method ä¸ºç»´åº¦ï¼Œè·å¾— Cache å¯¹è±¡ã€‚</span></span><br /><span class="line"><span class="number">20</span>:             Cache cache = cacheFactory.getCache(invoker.getUrl().addParameter(Constants.METHOD_KEY, invocation.getMethodName())); <span class="comment">// æ·»åŠ  `method` å±æ€§ï¼Œæ˜¯å› ä¸º JCache éœ€è¦ã€‚</span></span><br /><span class="line"><span class="number">21</span>:             <span class="keyword">if</span> (cache != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">22</span>:                 <span class="comment">// è·å¾— Cache Key</span></span><br /><span class="line"><span class="number">23</span>:                 String key = StringUtils.toArgumentString(invocation.getArguments());</span><br /><span class="line"><span class="number">24</span>:                 <span class="comment">// ä»ç¼“å­˜ä¸­è·å¾—ç»“æœã€‚è‹¥å­˜åœ¨ï¼Œåˆ›å»º RpcResult å¯¹è±¡ã€‚</span></span><br /><span class="line"><span class="number">25</span>:                 Object value = cache.get(key);</span><br /><span class="line"><span class="number">26</span>:                 <span class="keyword">if</span> (value != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">27</span>:                     <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(value);</span><br /><span class="line"><span class="number">28</span>:                 }</span><br /><span class="line"><span class="number">29</span>:                 <span class="comment">// æœåŠ¡è°ƒç”¨</span></span><br /><span class="line"><span class="number">30</span>:                 Result result = invoker.invoke(invocation);</span><br /><span class="line"><span class="number">31</span>:                 <span class="comment">// è‹¥éå¼‚å¸¸ç»“æœï¼Œç¼“å­˜ç»“æœ</span></span><br /><span class="line"><span class="number">32</span>:                 <span class="keyword">if</span> (!result.hasException()) {</span><br /><span class="line"><span class="number">33</span>:                     cache.put(key, result.getValue());</span><br /><span class="line"><span class="number">34</span>:                 }</span><br /><span class="line"><span class="number">35</span>:                 <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">36</span>:             }</span><br /><span class="line"><span class="number">37</span>:         }</span><br /><span class="line"><span class="number">38</span>:         <span class="comment">// æœåŠ¡è°ƒç”¨</span></span><br /><span class="line"><span class="number">39</span>:         <span class="keyword">return</span> invoker.invoke(invocation);</span><br /><span class="line"><span class="number">40</span>:     }</span><br /><span class="line"><span class="number">41</span>: </span><br /><span class="line"><span class="number">42</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 18 è¡Œï¼šåˆ¤æ–­æ–¹æ³•<strong>å¼€å¯</strong>&nbsp;Cache åŠŸèƒ½ã€‚å› ä¸ºï¼Œä¸€ä¸ªæœåŠ¡é‡Œï¼Œå¯èƒ½åªæœ‰<strong>éƒ¨åˆ†</strong>æ–¹æ³•å¼€å¯äº† Cache åŠŸèƒ½ã€‚</li>
<li>ç¬¬ 20 è¡Œï¼šè°ƒç”¨&nbsp;<code>CacheFactory$Adaptive#getCache(url)</code>&nbsp;æ–¹æ³•ï¼ŒåŸºäº&nbsp;<strong>URL + Method</strong>&nbsp;ä¸ºç»´åº¦ï¼Œè·å¾— Cache å¯¹è±¡ã€‚</li>
<li>
<p>ç¬¬ 23 è¡Œï¼šè°ƒç”¨&nbsp;<code>StringUtils#toArgumentString(Object[] args)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— Cache Key ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å°†å‚æ•°æ•°ç»„ï¼Œæ‹¼æ¥æˆå­—ç¬¦ä¸²ã€‚</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * 1. ä½¿ç”¨é€—å·åˆ†éš”</span></span><br /><span class="line"><span class="comment"> * 2. ä½¿ç”¨ JSON æ ¼å¼åŒ–å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> args å‚æ•°æ•°ç»„</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> å­—ç¬¦ä¸²</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">toArgumentString</span><span class="params">(Object[] args)</span> </span>{</span><br /><span class="line">    StringBuilder buf = <span class="keyword">new</span> StringBuilder();</span><br /><span class="line">    <span class="keyword">for</span> (Object arg : args) {</span><br /><span class="line">        <span class="keyword">if</span> (buf.length() &gt; <span class="number">0</span>) {</span><br /><span class="line">            buf.append(Constants.COMMA_SEPARATOR); <span class="comment">// åˆ†éš”</span></span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// æ‹¼æ¥å‚æ•°</span></span><br /><span class="line">        <span class="keyword">if</span> (arg == <span class="keyword">null</span> || ReflectUtils.isPrimitives(arg.getClass())) {</span><br /><span class="line">            buf.append(arg);</span><br /><span class="line">        } <span class="keyword">else</span> {</span><br /><span class="line">            <span class="keyword">try</span> {</span><br /><span class="line">                buf.append(JSON.toJSONString(arg)); <span class="comment">// ä½¿ç”¨ JSON æ ¼å¼åŒ–å¯¹è±¡</span></span><br /><span class="line">            } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line">                logger.warn(e.getMessage(), e);</span><br /><span class="line">                buf.append(arg);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> buf.toString();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 24 è‡³ 28 è¡Œï¼šè°ƒç”¨&nbsp;<code>Cache#get(key)</code>&nbsp;æ–¹æ³•ï¼Œä»ç¼“å­˜ä¸­è·å¾—ç»“æœã€‚è‹¥<strong>å­˜åœ¨</strong>ï¼Œåˆ›å»º RpcResult å¯¹è±¡å¹¶è¿”å›ã€‚</p>
</li>
<li>ç¬¬ 30 è¡Œï¼šè°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚</li>
<li>ç¬¬ 31 è‡³ 34 è¡Œï¼šè‹¥<strong>éå¼‚å¸¸</strong>ï¼Œè°ƒç”¨&nbsp;<code>Cache#put(key, value)</code>&nbsp;æ–¹æ³•ï¼Œç¼“å­˜<strong>æ­£å¸¸çš„</strong>ç»“æœã€‚</li>
<li>ç¬¬ 35 è¡Œï¼šè¿”å›è°ƒç”¨ç»“æœã€‚</li>
<li>ç¬¬ 39 è¡Œï¼šè‹¥<strong>ä¸ä½¿ç”¨</strong>&nbsp;Cache åŠŸèƒ½ï¼Œ<strong>ç›´æ¥</strong>è°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚</li>
</ul>
<h1 id="3-API-å®šä¹‰">3. API å®šä¹‰</h1>
<h2 id="3-1-Cache">3.1 Cache</h2>
<p><code>com.alibaba.dubbo.cache.Cache</code>&nbsp;ï¼Œç¼“å­˜<strong>å®¹å™¨</strong>æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Cache</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ·»åŠ é”®å€¼</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”®</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> value å€¼</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">put</span><span class="params">(Object key, Object value)</span></span>;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * è·å¾—å€¼</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> key é”®</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> å€¼</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function">Object <span class="title">get</span><span class="params">(Object key)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>Cache æ˜¯ä¸ªç¼“å­˜<strong>å®¹å™¨</strong>ï¼Œå†…éƒ¨å¯ä»¥<strong>ç®¡ç†</strong>ç¼“å­˜çš„é”®å€¼ã€‚</li>
</ul>
<h2 id="3-2-CacheFactory">3.2 CacheFactory</h2>
<p><code>com.alibaba.dubbo.cache.CacheFactory</code>&nbsp;ï¼ŒCache å·¥å‚<strong>æ¥å£</strong>ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@SPI</span>(<span class="string">"lru"</span>)</span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CacheFactory</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * è·å¾—ç¼“å­˜å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> url URL å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> ç¼“å­˜å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="meta">@Adaptive</span>(<span class="string">"cache"</span>)</span><br /><span class="line">    <span class="function">Cache <span class="title">getCache</span><span class="params">(URL url)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>@SPI("lru")</code>&nbsp;æ³¨è§£ï¼ŒDubbo SPI&nbsp;<strong>æ‹“å±•ç‚¹</strong>ï¼Œé»˜è®¤ä¸º&nbsp;<code>"lru"</code>&nbsp;ã€‚</li>
<li><code>@Adaptive("cache")</code>&nbsp;æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Cache å®ç°ï¼Œä½¿ç”¨&nbsp;<code>URL.cache</code>&nbsp;å±æ€§ã€‚</li>
</ul>
<h3 id="3-2-1-AbstractCacheFactory">3.2.1 AbstractCacheFactory</h3>
<p><code>com.alibaba.dubbo.cache.support.AbstractCacheFactory</code>&nbsp;ï¼ŒCache å·¥å‚<strong>æŠ½è±¡ç±»</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractCacheFactory</span> <span class="keyword">implements</span> <span class="title">CacheFactory</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Cache é›†åˆ</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * keyï¼šURL</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, Cache&gt; caches = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Cache&gt;();</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Cache <span class="title">getCache</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">        <span class="comment">// è·å¾— Cache å¯¹è±¡</span></span><br /><span class="line">        String key = url.toFullString();</span><br /><span class="line">        Cache cache = caches.get(key);</span><br /><span class="line">        <span class="comment">// ä¸å­˜åœ¨ï¼Œåˆ›å»º Cache å¯¹è±¡ï¼Œå¹¶ç¼“å­˜</span></span><br /><span class="line">        <span class="keyword">if</span> (cache == <span class="keyword">null</span>) {</span><br /><span class="line">            caches.put(key, createCache(url));</span><br /><span class="line">            cache = caches.get(key);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span> cache;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * åˆ›å»º Cache å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> url URL</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> Cache å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Cache <span class="title">createCache</span><span class="params">(URL url)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="4-LRU-å®ç°">4. LRU å®ç°</h1>
<p><code>lru</code>&nbsp;ï¼ŒåŸºäºæœ€è¿‘æœ€å°‘ä½¿ç”¨åŸåˆ™åˆ é™¤å¤šä½™ç¼“å­˜ï¼Œä¿æŒæœ€çƒ­çš„æ•°æ®è¢«ç¼“å­˜ã€‚</p>
<h2 id="4-1-LruCache">4.1 LruCache</h2>
<p><code>com.alibaba.dubbo.cache.support.lru.LruCache</code>&nbsp;ï¼Œå®ç° Cache æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LruCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * ç¼“å­˜é›†åˆ</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, Object&gt; store;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LruCache</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">        <span class="comment">// `"cache.size"` é…ç½®é¡¹ï¼Œè®¾ç½®ç¼“å­˜å¤§å°</span></span><br /><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> max = url.getParameter(<span class="string">"cache.size"</span>, <span class="number">1000</span>);</span><br /><span class="line">        <span class="comment">// åˆ›å»º LRUCache å¯¹è±¡</span></span><br /><span class="line">        <span class="keyword">this</span>.store = <span class="keyword">new</span> LRUCache&lt;Object, Object&gt;(max);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object key, Object value)</span> </span>{</span><br /><span class="line">        store.put(key, value);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> store.get(key);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>"cache.size"</code>&nbsp;é…ç½®é¡¹ï¼Œè®¾ç½®ç¼“å­˜<strong>å¤§å°</strong>ã€‚</li>
<li>åŸºäº&nbsp;<code>com.alibaba.dubbo.common.utils.LRUCache</code>&nbsp;å®ç°ã€‚</li>
</ul>
<h3 id="4-1-1-LRUCache">4.1.1 LRUCache</h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/26d2f1811c23096224fc9a973b3526f01aabeb28/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/LRUCache.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.common.utils.LRUCache</code></a>&nbsp;ï¼Œå®ç° LinkedHashMap ç±»ï¼ŒLRU ç¼“å­˜å®ç°ç±»ã€‚ä»£ç æ¯”è¾ƒå¤šï¼Œèƒ–å‹ç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚ç¬”è€…è¯´å‡ ä¸ªå…³é”®ç‚¹ï¼š</p>
<ul>
<li>
<p>æ„é€ æ–¹æ³•ï¼Œè®¾ç½® LRUCache ä¸º<strong>æŒ‰è®¿é—®é¡ºåº(è°ƒç”¨getæ–¹æ³•)</strong>çš„é“¾è¡¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LRUCache</span><span class="params">(<span class="keyword">int</span> maxCapacity)</span> </span>{</span><br /><span class="line">    <span class="keyword">super</span>(<span class="number">16</span>, DEFAULT_LOAD_FACTOR, <span class="keyword">true</span>); <span class="comment">// æœ€åä¸€ä¸ªå‚æ•°ï¼ŒæŒ‰è®¿é—®é¡ºåº(è°ƒç”¨getæ–¹æ³•)çš„é“¾è¡¨</span></span><br /><span class="line">    <span class="keyword">this</span>.maxCapacity = maxCapacity;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>é‡å†™ removeEldestEntry æ–¹æ³•è¿”å› true å€¼ï¼ŒæŒ‡å®šæ’å…¥å…ƒç´ æ—¶ç§»é™¤æœ€è€çš„å…ƒç´ ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">removeEldestEntry</span><span class="params">(java.util.Map.Entry&lt;K, V&gt; eldest)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> size() &gt; maxCapacity;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ ¹æ®é“¾è¡¨ä¸­å…ƒç´ çš„é¡ºåºå¯ä»¥åˆ†ä¸ºï¼šæŒ‰æ’å…¥é¡ºåºçš„é“¾è¡¨ï¼Œå’ŒæŒ‰è®¿é—®é¡ºåº(è°ƒç”¨getæ–¹æ³•)çš„é“¾è¡¨ã€‚é»˜è®¤æ˜¯æŒ‰æ’å…¥é¡ºåºæ’åºï¼Œå¦‚æœæŒ‡å®šæŒ‰è®¿é—®é¡ºåºæ’åºï¼Œé‚£ä¹ˆè°ƒç”¨getæ–¹æ³•åï¼Œä¼šå°†è¿™æ¬¡è®¿é—®çš„å…ƒç´ ç§»è‡³é“¾è¡¨å°¾éƒ¨ï¼Œä¸æ–­è®¿é—®å¯ä»¥å½¢æˆæŒ‰è®¿é—®é¡ºåºæ’åºçš„é“¾è¡¨ã€‚</li>
</ul>
</li>
<li>
<p><code>lock</code>&nbsp;å±æ€§ï¼Œé”ã€‚é¿å…å¹¶å‘è¯»å†™ï¼Œå¯¼è‡´æ­»é”ã€‚å‚è§&nbsp;<a href="https://coolshell.cn/articles/9606.html" target="_blank" rel="external nofollow noopener noreferrer">ã€Šç–«è‹—ï¼šJAVA HashMap çš„æ­»å¾ªç¯ã€‹</a>&nbsp;ã€‚æ¶‰åŠè¯¥å±æ€§çš„æ–¹æ³•ç¤ºä¾‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>{</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        lock.lock();</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.put(key, value);</span><br /><span class="line">    } <span class="keyword">finally</span> {</span><br /><span class="line">        lock.unlock();</span><br /><span class="line">    }</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">remove</span><span class="params">(Object key)</span> </span>{</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        lock.lock();</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.remove(key);</span><br /><span class="line">    } <span class="keyword">finally</span> {</span><br /><span class="line">        lock.unlock();</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<h2 id="4-2-LruCacheFactory">4.2 LruCacheFactory</h2>
<p><code>com.alibaba.dubbo.cache.support.lru.LruCacheFactory</code>&nbsp;ï¼Œå®ç° AbstractCacheFactory æŠ½è±¡ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LruCacheFactory</span> <span class="keyword">extends</span> <span class="title">AbstractCacheFactory</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">protected</span> Cache <span class="title">createCache</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LruCache(url);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="5-ThreadLocal-å®ç°">5. ThreadLocal å®ç°</h1>
<p>åŸºäº&nbsp;<strong>ThreadLocal</strong>&nbsp;ï¼Œå½“å‰çº¿ç¨‹ç¼“å­˜ï¼Œæ¯”å¦‚ä¸€ä¸ªé¡µé¢æ¸²æŸ“ï¼Œç”¨åˆ°å¾ˆå¤š portalï¼Œæ¯ä¸ª portal éƒ½è¦å»æŸ¥ç”¨æˆ·ä¿¡æ¯ï¼Œé€šè¿‡çº¿ç¨‹ç¼“å­˜ï¼Œå¯ä»¥å‡å°‘è¿™ç§å¤šä½™è®¿é—®ã€‚</p>
<h2 id="5-1-ThreadLocalCache">5.1 ThreadLocalCache</h2>
<p><code>com.alibaba.dubbo.cache.support.threadlocal.ThreadLocalCache</code>&nbsp;ï¼Œå®ç° Cache æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalCache</span> <span class="keyword">implements</span> <span class="title">Cache</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ThreadLocal&lt;Map&lt;Object, Object&gt;&gt; store; <span class="comment">// çº¿ç¨‹å˜é‡</span></span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ThreadLocalCache</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.store = <span class="keyword">new</span> ThreadLocal&lt;Map&lt;Object, Object&gt;&gt;() {</span><br /><br /><span class="line">            <span class="meta">@Override</span></span><br /><span class="line">            <span class="function"><span class="keyword">protected</span> Map&lt;Object, Object&gt; <span class="title">initialValue</span><span class="params">()</span> </span>{</span><br /><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br /><span class="line">            }</span><br /><br /><span class="line">        };</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object key, Object value)</span> </span>{</span><br /><span class="line">        store.get().put(key, value);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> store.get().get(key);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>åŸºäº ThreadLocal å®ç°ï¼Œç›¸å½“äºä¸€ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ª ThreadLocalCache å¯¹è±¡ã€‚</li>
<li>ğŸ™‚ ThreadLocalCache ç›®å‰æ²¡æœ‰è¿‡æœŸæˆ–æ¸…ç†æœºåˆ¶ï¼Œæ‰€ä»¥<strong>éœ€è¦æ³¨æ„</strong>ã€‚</li>
</ul>
<h2 id="5-2-ThreadLocalCacheFactory">5.2 ThreadLocalCacheFactory</h2>
<p><code>com.alibaba.dubbo.cache.support.threadlocal.ThreadLocalCacheFactory</code>&nbsp;ï¼Œå®ç° AbstractCacheFactory æŠ½è±¡ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalCacheFactory</span> <span class="keyword">extends</span> <span class="title">AbstractCacheFactory</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">protected</span> Cache <span class="title">createCache</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ThreadLocalCache(url);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="6-JCache-å®ç°">6. JCache å®ç°</h1>
<p>ä¸&nbsp;<a href="https://jcp.org/en/jsr/detail?id=107" target="_blank" rel="external nofollow noopener noreferrer">JSR107</a>&nbsp;é›†æˆï¼Œå¯ä»¥æ¡¥æ¥å„ç§ç¼“å­˜å®ç°ã€‚</p>
<h2 id="6-1-JCache">6.1 JCache</h2>
<p><code>com.alibaba.dubbo.cache.support.jcache.JCache</code>&nbsp;ï¼Œå®ç° Cache æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JCache</span> <span class="keyword">implements</span> <span class="title">com</span>.<span class="title">alibaba</span>.<span class="title">dubbo</span>.<span class="title">cache</span>.<span class="title">Cache</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Cache&lt;Object, Object&gt; store;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JCache</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">        <span class="comment">// è·å¾— Cache Key</span></span><br /><span class="line">        String method = url.getParameter(Constants.METHOD_KEY, <span class="string">""</span>);</span><br /><span class="line">        String key = url.getAddress() + <span class="string">"."</span> + url.getServiceKey() + <span class="string">"."</span> + method;</span><br /><span class="line">        <span class="comment">// `"jcache"` é…ç½®é¡¹ï¼Œä¸º Java SPI å®ç°çš„å…¨é™å®šç±»å</span></span><br /><span class="line">        <span class="comment">// jcache parameter is the full-qualified class name of SPI implementation</span></span><br /><span class="line">        String type = url.getParameter(<span class="string">"jcache"</span>);</span><br /><br /><span class="line">        <span class="comment">// åŸºäºç±»å‹ï¼Œè·å¾— javax.cache.CachingProvider å¯¹è±¡ï¼Œ</span></span><br /><span class="line">        CachingProvider provider = type == <span class="keyword">null</span> || type.length() == <span class="number">0</span> ? Caching.getCachingProvider() : Caching.getCachingProvider(type);</span><br /><span class="line">        <span class="comment">// è·å¾— javax.cache.CacheManager å¯¹è±¡</span></span><br /><span class="line">        CacheManager cacheManager = provider.getCacheManager();</span><br /><span class="line">        <span class="comment">// è·å¾— javax.cache.Cache å¯¹è±¡</span></span><br /><span class="line">        Cache&lt;Object, Object&gt; cache = cacheManager.getCache(key);</span><br /><span class="line">        <span class="comment">// ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œåˆ›å»º</span></span><br /><span class="line">        <span class="keyword">if</span> (cache == <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="keyword">try</span> {</span><br /><span class="line">                <span class="comment">// è®¾ç½® Cache é…ç½®é¡¹</span></span><br /><span class="line">                <span class="comment">// configure the cache</span></span><br /><span class="line">                MutableConfiguration config =</span><br /><span class="line">                        <span class="keyword">new</span> MutableConfiguration&lt;Object, Object&gt;()</span><br /><span class="line">                                <span class="comment">// ç±»å‹</span></span><br /><span class="line">                                .setTypes(Object.class, Object.class)</span><br /><span class="line">                                <span class="comment">// è¿‡æœŸç­–ç•¥ï¼ŒæŒ‰ç…§å†™å…¥æ—¶é—´è¿‡æœŸã€‚é€šè¿‡ `"cache.write.expire"` é…ç½®é¡¹è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œé»˜è®¤ä¸º 1 åˆ†é’Ÿã€‚</span></span><br /><span class="line">                                .setExpiryPolicyFactory(CreatedExpiryPolicy.factoryOf(<span class="keyword">new</span> Duration(TimeUnit.MILLISECONDS, url.getMethodParameter(method, <span class="string">"cache.write.expire"</span>, <span class="number">60</span> * <span class="number">1000</span>))))</span><br /><span class="line">                                .setStoreByValue(<span class="keyword">false</span>)</span><br /><span class="line">                                <span class="comment">// è®¾ç½® MBean</span></span><br /><span class="line">                                .setManagementEnabled(<span class="keyword">true</span>)</span><br /><span class="line">                                .setStatisticsEnabled(<span class="keyword">true</span>);</span><br /><span class="line">                <span class="comment">// åˆ›å»º javax.cache.Cache å¯¹è±¡</span></span><br /><span class="line">                cache = cacheManager.createCache(key, config);</span><br /><span class="line">            } <span class="keyword">catch</span> (CacheException e) {</span><br /><span class="line">                <span class="comment">// åˆå§‹åŒ– cache çš„å¹¶å‘æƒ…å†µ</span></span><br /><span class="line">                <span class="comment">// concurrent cache initialization</span></span><br /><span class="line">                cache = cacheManager.getCache(key);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><br /><span class="line">        <span class="keyword">this</span>.store = cache;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(Object key, Object value)</span> </span>{</span><br /><span class="line">        store.put(key, value);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> store.get(key);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å·²ç»æ·»åŠ è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚</li>
<li>ç¬”è€…å¯¹ JCache äº†è§£ä¸å¤šï¼Œæ¨èé˜…è¯»&nbsp;<a href="https://blog.csdn.net/boonya/article/details/54632129" target="_blank" rel="external nofollow noopener noreferrer">ã€Š Java Caching(ç¼“å­˜)-ç­–ç•¥å’ŒJCache APIã€‹</a></li>
</ul>
<h2 id="6-2-JCacheFactory">6.2 JCacheFactory</h2>
<p><code>com.alibaba.dubbo.cache.support.jcache.JCacheFactory</code>&nbsp;ï¼Œå®ç° AbstractCacheFactory æŠ½è±¡ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JCacheFactory</span> <span class="keyword">extends</span> <span class="title">AbstractCacheFactory</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">protected</span> Cache <span class="title">createCache</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JCache(url);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</div>