<header class="article-header">
<h1 class="article-title">è¿‡æ»¤å™¨ï¼ˆåä¸€ï¼‰ä¹‹ ValidationFilter</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡åˆ†äº«&nbsp;<code>dubbo-filter-validation</code>&nbsp;é¡¹ç›®çš„ ValidationFilter è¿‡æ»¤å™¨ï¼Œç”¨äºæœåŠ¡<strong>æ¶ˆè´¹è€…</strong>å’Œ<strong>æä¾›è€…</strong>ä¸­ï¼Œæä¾›&nbsp;<strong>å‚æ•°éªŒè¯</strong>&nbsp;çš„åŠŸèƒ½ã€‚åœ¨&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/parameter-validation.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; å‚æ•°éªŒè¯ã€‹</a>&nbsp;å®šä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å‚æ•°éªŒè¯åŠŸèƒ½ï¼Œæ˜¯åŸºäº&nbsp;<a href="https://jcp.org/en/jsr/detail?id=303" target="_blank" rel="external nofollow noopener noreferrer">JSR303</a>&nbsp;Bean Validation å®ç°çš„ï¼Œç”¨æˆ·åªéœ€æ ‡è¯† JSR303 æ ‡å‡†çš„éªŒè¯ annotationï¼Œå¹¶é€šè¿‡å£°æ˜ filter æ¥å®ç°éªŒè¯ã€‚</p>
</blockquote>
<ul>
<li><strong>é…ç½®</strong>å’Œ<strong>ç¤ºä¾‹</strong>ï¼Œå®˜æ–¹æ–‡æ¡£å·²ç»å†™çš„å¾ˆé½å…¨ï¼Œç¬”è€…å°±ä¸å¤šå“”å“”äº†ã€‚</li>
<li>
<p>å¦‚ä¸‹æ˜¯æ–°ç‰ˆæœ¬çš„ Maven ä¾èµ–çš„ä¾‹å­ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">&lt;!-- JSR <span class="number">303</span> - Bean Validation begin --&gt;</span><br /><span class="line">&lt;dependency&gt;</span><br /><span class="line">    &lt;groupId&gt;javax.validation&lt;/groupId&gt;</span><br /><span class="line">    &lt;artifactId&gt;validation-api&lt;/artifactId&gt;</span><br /><span class="line">    &lt;version&gt;1.1.0.Final&lt;/version&gt;</span><br /><span class="line">&lt;/dependency&gt;</span><br /><span class="line">&lt;dependency&gt;</span><br /><span class="line">    &lt;groupId&gt;org.hibernate&lt;/groupId&gt;</span><br /><span class="line">    &lt;artifactId&gt;hibernate-validator&lt;/artifactId&gt;</span><br /><span class="line">    &lt;version&gt;5.3.4.Final&lt;/version&gt;</span><br /><span class="line">&lt;/dependency&gt;</span><br /><span class="line">&lt;dependency&gt;</span><br /><span class="line">    &lt;groupId&gt;javax.el&lt;/groupId&gt;</span><br /><span class="line">    &lt;artifactId&gt;javax.el-api&lt;/artifactId&gt;</span><br /><span class="line">    &lt;version&gt;2.2.4&lt;/version&gt;</span><br /><span class="line">&lt;/dependency&gt;</span><br /><span class="line">&lt;dependency&gt;</span><br /><span class="line">    &lt;groupId&gt;org.glassfish.web&lt;/groupId&gt;</span><br /><span class="line">    &lt;artifactId&gt;javax.el&lt;/artifactId&gt;</span><br /><span class="line">    &lt;version&gt;2.2.4&lt;/version&gt;</span><br /><span class="line">&lt;/dependency&gt;</span><br /><span class="line">&lt;!-- JSR <span class="number">303</span> - Bean Validation end --&gt;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<p>æœ¬æ–‡æ¶‰åŠçš„ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_11_22/02.png" alt="ç±»å›¾" /></p>
<h1 id="2-ValidationFilter">2. ValidationFilter</h1>
<p><code>com.alibaba.dubbo.validation.filter.ValidationFilter</code>&nbsp;ï¼Œå®ç° Filter æ¥å£ï¼Œå‚æ•°éªŒè¯è¿‡æ»¤å™¨å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Activate</span>(group = {Constants.CONSUMER, Constants.PROVIDER}, value = Constants.VALIDATION_KEY, order = <span class="number">10000</span>)</span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidationFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>{</span><br /><span class="line"> <span class="number">3</span>: </span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 5:      * Validation$Adaptive å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> 6:      *</span></span><br /><span class="line"><span class="comment"> 7:      * é€šè¿‡ Dubbo SPI æœºåˆ¶ï¼Œè°ƒç”¨ {<span class="doctag">@link</span> #setValidation(Validation)} æ–¹æ³•ï¼Œè¿›è¡Œæ³¨å…¥</span></span><br /><span class="line"><span class="comment"> 8:      */</span></span><br /><span class="line"> <span class="number">9</span>:     <span class="keyword">private</span> Validation validation;</span><br /><span class="line"><span class="number">10</span>: </span><br /><span class="line"><span class="number">11</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setValidation</span><span class="params">(Validation validation)</span> </span>{</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">this</span>.validation = validation;</span><br /><span class="line"><span class="number">13</span>:     }</span><br /><span class="line"><span class="number">14</span>: </span><br /><span class="line"><span class="number">15</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">16</span>:     <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"><span class="number">17</span>:         <span class="keyword">if</span> (validation != <span class="keyword">null</span> &amp;&amp; !invocation.getMethodName().startsWith(<span class="string">"$"</span>) <span class="comment">// éæ³›åŒ–è°ƒç”¨å’Œå›éŸ³è°ƒç”¨ç­‰æ–¹æ³•</span></span><br /><span class="line"><span class="number">18</span>:                 &amp;&amp; ConfigUtils.isNotEmpty(invoker.getUrl().getMethodParameter(invocation.getMethodName(), Constants.VALIDATION_KEY))) { <span class="comment">// æ–¹æ³•å¼€å¯ Validation åŠŸèƒ½</span></span><br /><span class="line"><span class="number">19</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">20</span>:                 <span class="comment">// è·å¾— Validator å¯¹è±¡</span></span><br /><span class="line"><span class="number">21</span>:                 Validator validator = validation.getValidator(invoker.getUrl());</span><br /><span class="line"><span class="number">22</span>:                 <span class="comment">// ä½¿ç”¨ Validator ï¼ŒéªŒè¯æ–¹æ³•å‚æ•°ã€‚è‹¥ä¸åˆæ³•ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</span></span><br /><span class="line"><span class="number">23</span>:                 <span class="keyword">if</span> (validator != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">24</span>:                     validator.validate(invocation.getMethodName(), invocation.getParameterTypes(), invocation.getArguments());</span><br /><span class="line"><span class="number">25</span>:                 }</span><br /><span class="line"><span class="number">26</span>:             } <span class="keyword">catch</span> (RpcException e) {</span><br /><span class="line"><span class="number">27</span>:                 <span class="keyword">throw</span> e;</span><br /><span class="line"><span class="number">28</span>:             } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">29</span>:                 <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(t);</span><br /><span class="line"><span class="number">30</span>:             }</span><br /><span class="line"><span class="number">31</span>:         }</span><br /><span class="line"><span class="number">32</span>:         <span class="comment">// æœåŠ¡è°ƒç”¨</span></span><br /><span class="line"><span class="number">33</span>:         <span class="keyword">return</span> invoker.invoke(invocation);</span><br /><span class="line"><span class="number">34</span>:     }</span><br /><span class="line"><span class="number">35</span>: </span><br /><span class="line"><span class="number">36</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 17 è¡Œï¼šéæ³›åŒ–è°ƒç”¨å’Œå›éŸ³è°ƒç”¨ç­‰æ–¹æ³•ã€‚</li>
<li>ç¬¬ 18 è¡Œï¼šåˆ¤æ–­æ–¹æ³•<strong>å¼€å¯</strong>&nbsp;Validation åŠŸèƒ½ã€‚å› ä¸ºï¼Œä¸€ä¸ªæœåŠ¡é‡Œï¼Œå¯èƒ½åªæœ‰<strong>éƒ¨åˆ†</strong>æ–¹æ³•å¼€å¯äº† Validation åŠŸèƒ½ã€‚</li>
<li>ç¬¬ 21 è¡Œï¼šè°ƒç”¨&nbsp;<code>Validation$Adaptive#getValidator(url)</code>&nbsp;æ–¹æ³•ï¼ŒåŸºäº&nbsp;<strong>URL</strong>&nbsp;ä¸ºç»´åº¦ï¼Œè·å¾— Validator å¯¹è±¡ã€‚</li>
<li>ç¬¬ 22 è‡³ 25 è¡Œï¼šè°ƒç”¨&nbsp;<code>Validator#validate(String methodName, Class&lt;?&gt;[] parameterTypes, Object[] arguments)</code>&nbsp;æ–¹æ³•ï¼Œæ–¹æ³•å‚æ•°éªŒè¯ã€‚è‹¥ä¸åˆæ³•ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>ç¬¬ 33 è¡Œï¼šè°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚</li>
</ul>
<h1 id="3-API-å®šä¹‰">3. API å®šä¹‰</h1>
<h2 id="3-1-Validator">3.1 Validator</h2>
<p><code>com.alibaba.dubbo.validation.Validator</code>&nbsp;ï¼ŒéªŒè¯å™¨æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Validator</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ–¹æ³•å‚æ•°éªŒè¯</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> methodName æ–¹æ³•å</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> parameterTypes å‚æ•°ç±»å‹æ•°ç»„</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> arguments å‚æ•°å€¼æ•°ç»„</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception å½“å‘ç”Ÿå¼‚å¸¸æ—¶</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">validate</span><span class="params">(String methodName, Class&lt;?&gt;[] parameterTypes, Object[] arguments)</span> <span class="keyword">throws</span> Exception</span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="3-2-Validation">3.2 Validation</h2>
<p><code>com.alibaba.dubbo.validation.Validation</code>&nbsp;ï¼ŒValidator å·¥å‚<strong>æ¥å£</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@SPI</span>(<span class="string">"jvalidation"</span>)</span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Validation</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * è·å¾— Validator å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> url URL</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> Validator</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="meta">@Adaptive</span>(Constants.VALIDATION_KEY)</span><br /><span class="line">    <span class="function">Validator <span class="title">getValidator</span><span class="params">(URL url)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>@SPI("jvalidation")</code>&nbsp;æ³¨è§£ï¼ŒDubbo SPI&nbsp;<strong>æ‹“å±•ç‚¹</strong>ï¼Œé»˜è®¤ä¸º&nbsp;<code>"jvalidation"</code>&nbsp;ã€‚</li>
<li><code>@Adaptive("validation")</code>&nbsp;æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Validator å®ç°ï¼Œä½¿ç”¨&nbsp;<code>URL.validation</code>&nbsp;å±æ€§ã€‚</li>
</ul>
<h3 id="3-2-1-AbstractValidation">3.2.1 AbstractValidation</h3>
<p><code>com.alibaba.dubbo.validation.support.AbstractValidation</code>&nbsp;ï¼Œå®ç° Validation æ¥å£ï¼ŒValidator å·¥å‚<strong>æŠ½è±¡ç±»</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractValidation</span> <span class="keyword">implements</span> <span class="title">Validation</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Validator é›†åˆ</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * keyï¼šURL</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, Validator&gt; validators = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Validator&gt;();</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Validator <span class="title">getValidator</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">        <span class="comment">// è·å¾— Validator å¯¹è±¡</span></span><br /><span class="line">        String key = url.toFullString();</span><br /><span class="line">        Validator validator = validators.get(key);</span><br /><span class="line">        <span class="comment">// ä¸å­˜åœ¨ï¼Œåˆ›å»º Validator å¯¹è±¡ï¼Œå¹¶ç¼“å­˜</span></span><br /><span class="line">        <span class="keyword">if</span> (validator == <span class="keyword">null</span>) {</span><br /><span class="line">            validators.put(key, createValidator(url));</span><br /><span class="line">            validator = validators.get(key);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span> validator;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * åˆ›å»º Validator å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> url URL</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> Validator å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Validator <span class="title">createValidator</span><span class="params">(URL url)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="3-3-MethodValidated">3.3 @MethodValidated</h1>
<p><code>com.alibaba.dubbo.validation.@MethodValidated</code>&nbsp;ï¼Œæ–¹æ³•åˆ†ç»„éªŒè¯<strong>æ³¨è§£</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Target</span>({ElementType.METHOD})</span><br /><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br /><span class="line"><span class="meta">@Documented</span></span><br /><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MethodValidated {</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> åˆ†ç»„é›†åˆ</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    Class&lt;?&gt;[] value() <span class="keyword">default</span> {};</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä½¿ç”¨åœºæ™¯ï¼šå½“è°ƒç”¨æŸä¸ªæ–¹æ³•æ—¶ï¼Œéœ€è¦æ£€æŸ¥å¤šä¸ªåˆ†ç»„ï¼Œå¯ä»¥åœ¨æ¥å£æ–¹æ³•ä¸ŠåŠ ä¸Šè¯¥æ³¨è§£ã€‚</li>
<li>
<p>ç”¨æ³•ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@MethodValidated</span>({Save.class, Update.class})</span><br /><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">relatedQuery</span><span class="params">(ValidationParameter parameter)</span></span>;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>åœ¨æ¥å£æ–¹æ³•ä¸Šå¢åŠ æ³¨è§£ï¼Œè¡¨ç¤º&nbsp;<code>#relatedQuery(ValidationParameter)</code>&nbsp;è¿™ä¸ªæ–¹æ³•ï¼Œéœ€è¦åŒæ—¶æ£€æŸ¥ Save å’Œ Update è¿™ä¸¤ä¸ªåˆ†ç»„ã€‚</li>
<li>å¦‚æœèƒ–å‹å¯¹ Java Bean Validation åˆ†ç»„ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥ç†è§£èµ·æ¥æ¯”è¾ƒç»•ã€‚å¯ä»¥è·‘ä¸‹å®˜æ–¹æä¾›çš„&nbsp;<a href="https://github.com/YunaiV/dubbo/tree/f4216485f5641ea5cf406d1e58503c5651f86432/dubbo-config/dubbo-config-api/src/test/java/com/alibaba/dubbo/config/validation" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.config.validation</code></a>&nbsp;çš„ç«‹è¶³ã€‚<img src="http://static2.iocoder.cn/images/Dubbo/2018_11_22/01.png" alt="relatedQuery" /></li>
</ul>
</li>
</ul>
<h1 id="4-JSR303-å®ç°">4. JSR303 å®ç°</h1>
<p>åŸºäº&nbsp;<a href="https://jcp.org/en/jsr/detail?id=303" target="_blank" rel="external nofollow noopener noreferrer">JSR303</a>&nbsp;Bean Validation å®ç°çš„ï¼Œç”¨æˆ·åªéœ€æ ‡è¯† JSR303 æ ‡å‡†çš„éªŒè¯ annotation ã€‚</p>
<h2 id="4-1-JValidator">4.1 JValidator</h2>
<p><code>com.alibaba.dubbo.validation.support.jvalidation.JValidator</code>&nbsp;ï¼Œå®ç° Validator æ¥å£ï¼ŒåŸºäº&nbsp;<a href="https://jcp.org/en/jsr/detail?id=303" target="_blank" rel="external nofollow noopener noreferrer">JSR303</a>&nbsp;çš„éªŒè¯å™¨å®ç°ç±»ã€‚</p>
<h3 id="4-1-1-æ„é€ æ–¹æ³•">4.1.1 æ„é€ æ–¹æ³•</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æœåŠ¡æ¥å£ç±»</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; clazz;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Validator å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> javax.validation.Validator validator;</span><br /><br /><span class="line"><span class="meta">@SuppressWarnings</span>({<span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span>})</span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">JValidator</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾—æœåŠ¡æ¥å£ç±»</span></span><br /><span class="line">    <span class="keyword">this</span>.clazz = ReflectUtils.forName(url.getServiceInterface());</span><br /><span class="line">    <span class="comment">// è·å¾— `"jvalidation"` é…ç½®é¡¹</span></span><br /><span class="line">    String jvalidation = url.getParameter(<span class="string">"jvalidation"</span>);</span><br /><span class="line">    <span class="comment">// è·å¾— ValidatorFactory å¯¹è±¡</span></span><br /><span class="line">    ValidatorFactory factory;</span><br /><span class="line">    <span class="keyword">if</span> (jvalidation != <span class="keyword">null</span> &amp;&amp; jvalidation.length() &gt; <span class="number">0</span>) { <span class="comment">// æŒ‡å®šå®ç°</span></span><br /><span class="line">        factory = Validation.byProvider((Class) ReflectUtils.forName(jvalidation)).configure().buildValidatorFactory();</span><br /><span class="line">    } <span class="keyword">else</span> { <span class="comment">// é»˜è®¤</span></span><br /><span class="line">        factory = Validation.buildDefaultValidatorFactory();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è·å¾— javax Validator å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">this</span>.validator = factory.getValidator();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>"jvalidation"</code>&nbsp;é…ç½®é¡¹ï¼Œå¯<strong>æŒ‡å®š</strong>å…·ä½“çš„ JSR303 çš„å®ç°ç±»ã€‚</li>
<li>å¦‚æœæˆ‘ä»¬<strong>æœªé…ç½®</strong>ï¼Œå¹¶ä¸”å¼•å…¥ Hibernate Validator ï¼Œåˆ™ä½¿ç”¨çš„æ˜¯ HibernateValidatorFactory ã€‚</li>
</ul>
<h3 id="4-1-2-validate">4.1.2 validate</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(String methodName, Class&lt;?&gt;[] parameterTypes, Object[] arguments)</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// éªŒè¯åˆ†ç»„é›†åˆ</span></span><br /><span class="line"> <span class="number">4</span>:     List&lt;Class&lt;?&gt;&gt; groups = <span class="keyword">new</span> ArrayList&lt;Class&lt;?&gt;&gt;();</span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// ã€ç¬¬ä¸€ç§ã€‘æ·»åŠ ä»¥æ–¹æ³•å‘½åçš„å†…éƒ¨æ¥å£ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚ä¾‹å¦‚ `ValidationService#save(...)` æ–¹æ³•ï¼Œå¯¹åº” `ValidationService.Save` æ¥å£ã€‚</span></span><br /><span class="line"> <span class="number">6</span>:     String methodClassName = clazz.getName() + <span class="string">"$"</span> + toUpperMethodName(methodName);</span><br /><span class="line"> <span class="number">7</span>:     Class&lt;?&gt; methodClass;</span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">9</span>:         methodClass = Class.forName(methodClassName, <span class="keyword">false</span>, Thread.currentThread().getContextClassLoader());</span><br /><span class="line"><span class="number">10</span>:         groups.add(methodClass);</span><br /><span class="line"><span class="number">11</span>:     } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br /><span class="line"><span class="number">12</span>:     }</span><br /><span class="line"><span class="number">13</span>:     <span class="comment">// ã€ç¬¬äºŒç§ã€‘æ·»åŠ æ–¹æ³•çš„ @MethodValidated æ³¨è§£çš„å€¼å¯¹åº”çš„ç±»ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚</span></span><br /><span class="line"><span class="number">14</span>:     Method method = clazz.getMethod(methodName, parameterTypes);</span><br /><span class="line"><span class="number">15</span>:     Class&lt;?&gt;[] methodClasses;</span><br /><span class="line"><span class="number">16</span>:     <span class="keyword">if</span> (method.isAnnotationPresent(MethodValidated.class)){</span><br /><span class="line"><span class="number">17</span>:         methodClasses = method.getAnnotation(MethodValidated.class).value();</span><br /><span class="line"><span class="number">18</span>:         groups.addAll(Arrays.asList(methodClasses));</span><br /><span class="line"><span class="number">19</span>:     }</span><br /><span class="line"><span class="number">20</span>:     <span class="comment">// ã€ç¬¬ä¸‰ç§ã€‘æ·»åŠ  Default.class ç±»ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚åœ¨ JSR 303 ä¸­ï¼Œæœªè®¾ç½®åˆ†ç»„çš„éªŒè¯æ³¨è§£ï¼Œä½¿ç”¨ Default.class ã€‚</span></span><br /><span class="line"><span class="number">21</span>:     <span class="comment">// add into default group</span></span><br /><span class="line"><span class="number">22</span>:     groups.add(<span class="number">0</span>, Default.class);</span><br /><span class="line"><span class="number">23</span>:     <span class="comment">// ã€ç¬¬å››ç§ã€‘æ·»åŠ æœåŠ¡æ¥å£ç±»ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚</span></span><br /><span class="line"><span class="number">24</span>:     groups.add(<span class="number">1</span>, clazz);</span><br /><span class="line"><span class="number">25</span>:     <span class="comment">// convert list to array</span></span><br /><span class="line"><span class="number">26</span>:     Class&lt;?&gt;[] classGroups = groups.toArray(<span class="keyword">new</span> Class[<span class="number">0</span>]);</span><br /><span class="line"><span class="number">27</span>: </span><br /><span class="line"><span class="number">28</span>:     <span class="comment">// éªŒè¯é”™è¯¯é›†åˆ</span></span><br /><span class="line"><span class="number">29</span>:     Set&lt;ConstraintViolation&lt;?&gt;&gt; violations = <span class="keyword">new</span> HashSet&lt;ConstraintViolation&lt;?&gt;&gt;();</span><br /><span class="line"><span class="number">30</span>:     <span class="comment">// ã€ç¬¬ä¸€æ­¥ã€‘è·å¾—æ–¹æ³•å‚æ•°çš„ Bean å¯¹è±¡ã€‚å› ä¸ºï¼ŒJSR 303 æ˜¯ Java Bean Validation ï¼Œä»¥ Bean ä¸ºç»´åº¦ã€‚</span></span><br /><span class="line"><span class="number">31</span>:     Object parameterBean = getMethodParameterBean(clazz, method, arguments);</span><br /><span class="line"><span class="number">32</span>:     <span class="comment">// ã€ç¬¬ä¸€æ­¥ã€‘éªŒè¯ Bean å¯¹è±¡ã€‚</span></span><br /><span class="line"><span class="number">33</span>:     <span class="keyword">if</span> (parameterBean != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">34</span>:         violations.addAll(validator.validate(parameterBean, classGroups));</span><br /><span class="line"><span class="number">35</span>:     }</span><br /><span class="line"><span class="number">36</span>:     <span class="comment">// ã€ç¬¬äºŒæ­¥ã€‘éªŒè¯é›†åˆå‚æ•°</span></span><br /><span class="line"><span class="number">37</span>:     <span class="keyword">for</span> (Object arg : arguments) {</span><br /><span class="line"><span class="number">38</span>:         validate(violations, arg, classGroups);</span><br /><span class="line"><span class="number">39</span>:     }</span><br /><span class="line"><span class="number">40</span>:     <span class="comment">// è‹¥æœ‰é”™è¯¯ï¼ŒæŠ›å‡º ConstraintViolationException å¼‚å¸¸ã€‚</span></span><br /><span class="line"><span class="number">41</span>:     <span class="keyword">if</span> (!violations.isEmpty()) {</span><br /><span class="line"><span class="number">42</span>:         logger.error(<span class="string">"Failed to validate service: "</span> + clazz.getName() + <span class="string">", method: "</span> + methodName + <span class="string">", cause: "</span> + violations);</span><br /><span class="line"><span class="number">43</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> ConstraintViolationException(<span class="string">"Failed to validate service: "</span> + clazz.getName() + <span class="string">", method: "</span> + methodName + <span class="string">", cause: "</span> + violations, violations);</span><br /><span class="line"><span class="number">44</span>:     }</span><br /><span class="line"><span class="number">45</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>============ ã€ç¬¬ä¸€æ­¥ã€‘è·å¾—éªŒè¯åˆ†ç»„é›†åˆ ============</li>
<li>ç¬¬ 4 è¡Œï¼šéªŒè¯åˆ†ç»„é›†åˆ&nbsp;<code>group</code>&nbsp;ï¼Œç›®å‰æœ‰å››ç§æ¥æºã€‚</li>
<li>ã€ç¬¬ä¸€ç§ã€‘ç¬¬ 5 è‡³ 12 è¡Œï¼šæ·»åŠ ä»¥æ–¹æ³•å‘½åçš„å†…éƒ¨æ¥å£ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚ä¾‹å¦‚&nbsp;<code>ValidationService#save(...)</code>&nbsp;æ–¹æ³•ï¼Œå¯¹åº”&nbsp;<code>ValidationService.Save</code>&nbsp;æ¥å£ã€‚</li>
<li>ã€ç¬¬äºŒç§ã€‘ç¬¬ 13 è‡³ 19 è¡Œï¼šæ·»åŠ æ–¹æ³•çš„&nbsp;<code>@MethodValidated</code>&nbsp;æ³¨è§£çš„å€¼å¯¹åº”çš„ç±»ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚</li>
<li>ã€ç¬¬ä¸‰ç§ã€‘ç¬¬ 22 è¡Œï¼šæ·»åŠ  Default.class ç±»ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚åœ¨ JSR 303 ä¸­ï¼Œæœªè®¾ç½®åˆ†ç»„çš„éªŒè¯æ³¨è§£ï¼Œä½¿ç”¨ Default.class ã€‚</li>
<li>ã€ç¬¬å››ç§ã€‘ç¬¬ 24 è¡Œï¼šæ·»åŠ æœåŠ¡æ¥å£ç±»&nbsp;<code>clazz</code>&nbsp;ï¼Œä½œä¸ºéªŒè¯åˆ†ç»„ã€‚</li>
<li>æœ€ç»ˆç”Ÿæˆçš„éªŒè¯åˆ†ç»„é›†åˆçš„é¡ºåºä¸ºï¼šã€ç¬¬ä¸‰ç§ã€‘ã€‹ã€ç¬¬å››ç§ã€‘ã€‹ã€ç¬¬ä¸€ç§ã€‘ã€‹ã€ç¬¬äºŒç§ã€‘ã€‚</li>
<li>============ ã€ç¬¬äºŒæ­¥ã€‘éªŒè¯æ–¹æ³•å‚æ•° ============</li>
<li>ç¬¬ 29 è¡Œï¼šéªŒè¯é”™è¯¯é›†åˆ&nbsp;<code>violations</code>&nbsp;ã€‚</li>
<li>ã€ç¬¬ä¸€æ­¥ã€‘è°ƒç”¨&nbsp;<code>#getMethodParameterBean(Class&lt;?&gt; clazz, Method method, Object[] args)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æ–¹æ³•å‚æ•°çš„ Bean å¯¹è±¡ã€‚å› ä¸ºï¼ŒJSR 303 æ˜¯ Java Bean Validation ï¼Œä»¥ Bean ä¸ºç»´åº¦ã€‚å…·ä½“çš„å®ç°ï¼Œæˆ‘ä»¬åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/filter-validation-filter/">ã€Œ4.1.3 getMethodParameterBeanã€</a>&nbsp;ä¸­ï¼Œè¯¦ç»†è§£æã€‚</li>
<li>ã€ç¬¬ä¸€æ­¥ã€‘è°ƒç”¨&nbsp;<code>Validator#validate(T object, Class&lt;?&gt;... groups)</code>&nbsp;æ–¹æ³•ï¼ŒéªŒè¯&nbsp;<strong>Bean</strong>&nbsp;å¯¹è±¡ã€‚</li>
<li>
<p>ã€ç¬¬äºŒæ­¥ã€‘å¾ªç¯æ–¹æ³•å‚æ•°ï¼Œè°ƒç”¨&nbsp;<code>#validate(violations, arg, classGroups)</code>&nbsp;æ–¹æ³•ï¼ŒéªŒè¯<strong>é›†åˆ</strong>å‚æ•°ã€‚<strong>ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¸€æ­¥</strong>ï¼Ÿå› ä¸ºï¼Œåœ¨ã€ç¬¬ä¸€æ­¥ã€‘ä¸­ï¼Œæ ¡éªŒçš„æ˜¯ Constraint æ³¨è§£çš„å‚æ•°( ä¾‹å¦‚&nbsp;<code>@NotNull</code>&nbsp;) ï¼Œä½†æ˜¯å‘¢ï¼Œè‹¥æ˜¯é›†åˆå‚æ•°ï¼Œ<strong>ä¸ä¼šæ ¡éªŒé›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ </strong>ã€‚æˆ‘ä»¬æ¥ä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saves</span><span class="params">(@NotNull(message = <span class="string">"è‡³å°‘éœ€è¦ä¿å­˜ä¸€ä¸ªç”¨æˆ·"</span>)</span> User[] users)</span>;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ã€ç¬¬ä¸€æ­¥ã€‘æ ¡éªŒ&nbsp;<code>users</code>&nbsp;å‚æ•°çš„&nbsp;<code>@NotNull</code>&nbsp;çº¦æŸã€‚</li>
<li>ã€ç¬¬äºŒæ­¥ã€‘æ ¡éªŒ&nbsp;<code>users</code>&nbsp;å‚æ•°ä¸­çš„<strong>æ¯ä¸ª User</strong>&nbsp;çš„çº¦æŸã€‚</li>
</ul>
</li>
<li>
<p>ç¬¬ 40 è‡³ 44 è¡Œï¼šè‹¥æœ‰éªŒè¯é”™è¯¯ï¼ŒæŠ›å‡º ConstraintViolationException å¼‚å¸¸ã€‚</p>
</li>
</ul>
<hr />
<p><code>#validate(Set&lt;ConstraintViolation&lt;?&gt;&gt; violations, Object arg, Class&lt;?&gt;... groups)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * éªŒè¯é›†åˆå‚æ•°</span></span><br /><span class="line"><span class="comment"> 3:  *</span></span><br /><span class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> violations éªŒè¯é”™è¯¯é›†åˆ</span></span><br /><span class="line"><span class="comment"> 5:  * <span class="doctag">@param</span> arg å‚æ•°</span></span><br /><span class="line"><span class="comment"> 6:  * <span class="doctag">@param</span> groups éªŒè¯åˆ†ç»„é›†åˆ</span></span><br /><span class="line"><span class="comment"> 7:  */</span></span><br /><span class="line"> <span class="number">8</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(Set&lt;ConstraintViolation&lt;?&gt;&gt; violations, Object arg, Class&lt;?&gt;... groups)</span> </span>{</span><br /><span class="line"> <span class="number">9</span>:     <span class="keyword">if</span> (arg != <span class="keyword">null</span> &amp;&amp; !isPrimitives(arg.getClass())) {</span><br /><span class="line"><span class="number">10</span>:         <span class="comment">// [] æ•°ç»„</span></span><br /><span class="line"><span class="number">11</span>:         <span class="keyword">if</span> (Object[].class.isInstance(arg)) {</span><br /><span class="line"><span class="number">12</span>:             <span class="keyword">for</span> (Object item : (Object[]) arg) {</span><br /><span class="line"><span class="number">13</span>:                 validate(violations, item, groups); <span class="comment">// å•ä¸ªå…ƒç´ </span></span><br /><span class="line"><span class="number">14</span>:             }</span><br /><span class="line"><span class="number">15</span>:         <span class="comment">// Collection</span></span><br /><span class="line"><span class="number">16</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (Collection.class.isInstance(arg)) {</span><br /><span class="line"><span class="number">17</span>:             <span class="keyword">for</span> (Object item : (Collection&lt;?&gt;) arg) {</span><br /><span class="line"><span class="number">18</span>:                 validate(violations, item, groups); <span class="comment">// å•ä¸ªå…ƒç´ </span></span><br /><span class="line"><span class="number">19</span>:             }</span><br /><span class="line"><span class="number">20</span>:         <span class="comment">// Map</span></span><br /><span class="line"><span class="number">21</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (Map.class.isInstance(arg)) {</span><br /><span class="line"><span class="number">22</span>:             <span class="keyword">for</span> (Map.Entry&lt;?, ?&gt; entry : ((Map&lt;?, ?&gt;) arg).entrySet()) {</span><br /><span class="line"><span class="number">23</span>:                 validate(violations, entry.getKey(), groups); <span class="comment">// å•ä¸ªå…ƒç´ </span></span><br /><span class="line"><span class="number">24</span>:                 validate(violations, entry.getValue(), groups); <span class="comment">// å•ä¸ªå…ƒç´ </span></span><br /><span class="line"><span class="number">25</span>:             }</span><br /><span class="line"><span class="number">26</span>:         <span class="comment">// å•ä¸ªå…ƒç´ </span></span><br /><span class="line"><span class="number">27</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">28</span>:             violations.addAll(validator.validate(arg, groups));</span><br /><span class="line"><span class="number">29</span>:         }</span><br /><span class="line"><span class="number">30</span>:     }</span><br /><span class="line"><span class="number">31</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ç¬¬ 9 è¡Œï¼šè°ƒç”¨&nbsp;<code>#isPrimitives(Class&lt;?&gt; cls)</code>&nbsp;æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦ä¸º<strong>åŸºæœ¬ç±»å‹</strong>ã€‚è‹¥æ˜¯åŸºæœ¬ç±»å‹ï¼Œå·²ç»è¢«ã€<strong>ç¬¬ä¸€æ­¥</strong>ã€‘ç»™éªŒè¯äº†ï¼Œé¿å…é‡å¤éªŒè¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isPrimitives</span><span class="params">(Class&lt;?&gt; cls)</span> </span>{</span><br /><span class="line">    <span class="comment">// [] æ•°ç»„ï¼Œä½¿ç”¨å†…éƒ¨çš„ç±»æ¥åˆ¤æ–­</span></span><br /><span class="line">    <span class="keyword">if</span> (cls.isArray()) {</span><br /><span class="line">        <span class="keyword">return</span> isPrimitive(cls.getComponentType());</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// ç›´æ¥åˆ¤æ–­</span></span><br /><span class="line">    <span class="keyword">return</span> isPrimitive(cls);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isPrimitive</span><span class="params">(Class&lt;?&gt; cls)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> cls.isPrimitive() || cls == String.class || cls == Boolean.class || cls == Character.class</span><br /><span class="line">            || Number.class.isAssignableFrom(cls) || Date.class.isAssignableFrom(cls);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 10 è‡³ 14 è¡Œï¼šéªŒè¯&nbsp;<code>[ ]</code>&nbsp;æ•°ç»„å‚æ•°ï¼Œå¾ªç¯è°ƒç”¨ã€ç¬¬ 26 è‡³ 29ã€‘çš„éªŒè¯ã€‚</p>
</li>
<li>ç¬¬ 15 è‡³ 19 è¡Œï¼šéªŒè¯ Collection å‚æ•°ï¼Œå¾ªç¯è°ƒç”¨ã€ç¬¬ 26 è‡³ 29ã€‘çš„éªŒè¯ã€‚</li>
<li>ç¬¬ 20 è‡³ 25 è¡Œï¼šéªŒè¯ Map å‚æ•°ï¼Œå¾ªç¯è°ƒç”¨ã€ç¬¬ 26 è‡³ 29ã€‘çš„éªŒè¯ã€‚</li>
<li><strong>ç¬¬ 26 è‡³ 29 è¡Œ</strong>ï¼šéªŒè¯<strong>å•ä¸ª</strong>å‚æ•°ã€‚</li>
</ul>
<h3 id="4-1-3-getMethodParameterBean">4.1.3 getMethodParameterBean</h3>
<p>åœ¨çœ‹&nbsp;<code>#getMethodParameterBean(Class&lt;?&gt; clazz, Method method, Object[] args)</code>&nbsp;çš„å…·ä½“å®ç°ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å®ƒï¼Œæ ¹æ®æ–¹æ³•ï¼Œ<strong>è‡ªåŠ¨ç”Ÿæˆ</strong>&nbsp;Bean ç±»çš„ä¾‹å­ã€‚</p>
<ul>
<li>
<p>æ¥å£æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">demo</span><span class="params">(@NotNull(message = <span class="string">"åå­—ä¸èƒ½ä¸ºç©º"</span>)</span> @<span class="title">Min</span><span class="params">(value = <span class="number">6</span>, message = <span class="string">"æ˜µç§°ä¸èƒ½å¤ªçŸ­"</span>)</span> String name,</span></span><br /><span class="line"><span class="function">          String password, <span class="comment">// ä¸æ ¡éªŒ</span></span></span><br /><span class="line"><span class="function">          @<span class="title">NotNull</span><span class="params">(message = <span class="string">"è‡³å°‘éœ€è¦ä¿å­˜ä¸€ä¸ªç”¨æˆ·"</span>)</span> User user)</span>;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç”Ÿæˆ Bean ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">package</span> com.alibaba.dubbo.demo.DemoService_DemoParameter_java.lang.String_java.lang.String_com.alibaba.dubbo.demo.entity;</span><br /><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@NotNull</span>(message = <span class="string">"åå­—ä¸èƒ½ä¸ºç©º"</span>) </span><br /><span class="line">    <span class="meta">@Min</span>(value = <span class="number">6</span>, message = <span class="string">"æ˜µç§°ä¸èƒ½å¤ªçŸ­"</span>)</span><br /><span class="line">    <span class="keyword">public</span> java.lang.String name;</span><br />    <br /><span class="line">    <span class="keyword">public</span> java.lang.String password;</span><br />    <br /><span class="line">    <span class="meta">@NotNull</span>(message = <span class="string">"è‡³å°‘éœ€è¦ä¿å­˜ä¸€ä¸ªç”¨æˆ·"</span>)</span><br /><span class="line">    <span class="keyword">public</span> com.alibaba.dubbo.demo.entity.User user;</span><br />    <br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">User</span><span class="params">()</span> </span>{}</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ğŸ˜ˆ Javassist ç”Ÿæˆçš„ç±»ï¼Œä½¿ç”¨ JD-GUI åç¼–è¯‘ä¸€ç›´æŠ¥é”™ã€‚æ‰€ä»¥ï¼Œè¯¥ç±»æ˜¯ç¬”è€…ï¼Œ<strong>æ‰‹å·¥</strong>ç”Ÿæˆçš„ã€‚å“ˆå“ˆå“ˆï¼Œæ„æ€èƒ½è¾¾åˆ°å°±å¥½ã€‚</li>
</ul>
</li>
</ul>
<hr />
<p><code>#getMethodParameterBean(Class&lt;?&gt; clazz, Method method, Object[] args)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * ä½¿ç”¨æ–¹æ³•å‚æ•°ï¼Œåˆ›å»º Bean å¯¹è±¡ã€‚</span></span><br /><span class="line"><span class="comment"> 3:  *</span></span><br /><span class="line"><span class="comment"> 4:  * å› ä¸ºè¯¥ Bean å¯¹è±¡ï¼Œå®é™…ä¸å­˜åœ¨å¯¹åº”ç±»ï¼Œä½¿ç”¨ Javassist åŠ¨æ€ç¼–è¯‘ç”Ÿæˆã€‚</span></span><br /><span class="line"><span class="comment"> 5:  *</span></span><br /><span class="line"><span class="comment"> 6:  * <span class="doctag">@param</span> clazz æœåŠ¡æ¥å£ç±»</span></span><br /><span class="line"><span class="comment"> 7:  * <span class="doctag">@param</span> method æ–¹æ³•</span></span><br /><span class="line"><span class="comment"> 8:  * <span class="doctag">@param</span> args å‚æ•°æ•°ç»„</span></span><br /><span class="line"><span class="comment"> 9:  * <span class="doctag">@return</span> Bean å¯¹è±¡</span></span><br /><span class="line"><span class="comment">10:  */</span></span><br /><span class="line"><span class="number">11</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">getMethodParameterBean</span><span class="params">(Class&lt;?&gt; clazz, Method method, Object[] args)</span> </span>{</span><br /><span class="line"><span class="number">12</span>:     <span class="comment">// æ—  Constraint æ³¨è§£çš„æ–¹æ³•å‚æ•°ï¼Œæ— éœ€åˆ›å»º Bean å¯¹è±¡ã€‚</span></span><br /><span class="line"><span class="number">13</span>:     <span class="keyword">if</span> (!hasConstraintParameter(method)) {</span><br /><span class="line"><span class="number">14</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">15</span>:     }</span><br /><span class="line"><span class="number">16</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">17</span>:         <span class="comment">// è·å¾— Bean ç±»å</span></span><br /><span class="line"><span class="number">18</span>:         String parameterClassName = generateMethodParameterClassName(clazz, method);</span><br /><span class="line"><span class="number">19</span>:         Class&lt;?&gt; parameterClass;</span><br /><span class="line"><span class="number">20</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">21</span>:             <span class="comment">// è·å¾— Bean ç±»</span></span><br /><span class="line"><span class="number">22</span>:             parameterClass = Class.forName(parameterClassName, <span class="keyword">true</span>, clazz.getClassLoader());</span><br /><span class="line"><span class="number">23</span>:         } <span class="keyword">catch</span> (ClassNotFoundException e) { <span class="comment">// ç±»ä¸å­˜åœ¨ï¼Œä½¿ç”¨ Javassist åŠ¨æ€ç¼–è¯‘ç”Ÿæˆ</span></span><br /><span class="line"><span class="number">24</span>:             <span class="comment">// åˆ›å»º ClassPool å¯¹è±¡</span></span><br /><span class="line"><span class="number">25</span>:             ClassPool pool = ClassGenerator.getClassPool(clazz.getClassLoader());</span><br /><span class="line"><span class="number">26</span>:             <span class="comment">// åˆ›å»º CtClass å¯¹è±¡</span></span><br /><span class="line"><span class="number">27</span>:             CtClass ctClass = pool.makeClass(parameterClassName);</span><br /><span class="line"><span class="number">28</span>:             <span class="comment">// è®¾ç½® Java ç‰ˆæœ¬ä¸º 5</span></span><br /><span class="line"><span class="number">29</span>:             ClassFile classFile = ctClass.getClassFile();</span><br /><span class="line"><span class="number">30</span>:             classFile.setVersionToJava5();</span><br /><span class="line"><span class="number">31</span>:             <span class="comment">// æ·»åŠ é»˜è®¤æ„é€ æ–¹æ³•</span></span><br /><span class="line"><span class="number">32</span>:             ctClass.addConstructor(CtNewConstructor.defaultConstructor(pool.getCtClass(parameterClassName)));</span><br /><span class="line"><span class="number">33</span>:             <span class="comment">// å¾ªç¯æ¯ä¸ªæ–¹æ³•å‚æ•°ï¼Œç”Ÿæˆå¯¹åº”çš„ç±»çš„å±æ€§</span></span><br /><span class="line"><span class="number">34</span>:             <span class="comment">// parameter fields</span></span><br /><span class="line"><span class="number">35</span>:             Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</span><br /><span class="line"><span class="number">36</span>:             Annotation[][] parameterAnnotations = method.getParameterAnnotations();</span><br /><span class="line"><span class="number">37</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterTypes.length; i++) {</span><br /><span class="line"><span class="number">38</span>:                 Class&lt;?&gt; type = parameterTypes[i];</span><br /><span class="line"><span class="number">39</span>:                 Annotation[] annotations = parameterAnnotations[i];</span><br /><span class="line"><span class="number">40</span>:                 <span class="comment">// åˆ›å»ºæ³¨è§£å±æ€§</span></span><br /><span class="line"><span class="number">41</span>:                 AnnotationsAttribute attribute = <span class="keyword">new</span> AnnotationsAttribute(classFile.getConstPool(), AnnotationsAttribute.visibleTag);</span><br /><span class="line"><span class="number">42</span>:                 <span class="comment">// å¾ªç¯æ¯ä¸ªæ–¹æ³•å‚æ•°çš„æ¯ä¸ªæ³¨è§£</span></span><br /><span class="line"><span class="number">43</span>:                 <span class="keyword">for</span> (Annotation annotation : annotations) {</span><br /><span class="line"><span class="number">44</span>:                     <span class="keyword">if</span> (annotation.annotationType().isAnnotationPresent(Constraint.class)) { <span class="comment">// çº¦æŸæ¡ä»¶çš„æ³¨è§£ï¼Œä¾‹å¦‚ @NotNull</span></span><br /><span class="line"><span class="number">45</span>:                         javassist.bytecode.annotation.Annotation ja = <span class="keyword">new</span> javassist.bytecode.annotation.Annotation(</span><br /><span class="line"><span class="number">46</span>:                                 classFile.getConstPool(), pool.getCtClass(annotation.annotationType().getName()));</span><br /><span class="line"><span class="number">47</span>:                         <span class="comment">// å¾ªç¯æ³¨è§£çš„æ¯ä¸ªæ–¹æ³•</span></span><br /><span class="line"><span class="number">48</span>:                         Method[] members = annotation.annotationType().getMethods();</span><br /><span class="line"><span class="number">49</span>:                         <span class="keyword">for</span> (Method member : members) {</span><br /><span class="line"><span class="number">50</span>:                             <span class="keyword">if</span> (Modifier.isPublic(member.getModifiers())</span><br /><span class="line"><span class="number">51</span>:                                     &amp;&amp; member.getParameterTypes().length == <span class="number">0</span></span><br /><span class="line"><span class="number">52</span>:                                     &amp;&amp; member.getDeclaringClass() == annotation.annotationType()) {</span><br /><span class="line"><span class="number">53</span>:                                 <span class="comment">// å°†æ³¨è§£ï¼Œæ·»åŠ åˆ°ç±»çš„å±æ€§ä¸Š</span></span><br /><span class="line"><span class="number">54</span>:                                 Object value = member.invoke(annotation);</span><br /><span class="line"><span class="number">55</span>:                                 <span class="keyword">if</span> (<span class="keyword">null</span> != value) {</span><br /><span class="line"><span class="number">56</span>:                                     MemberValue memberValue = createMemberValue(</span><br /><span class="line"><span class="number">57</span>:                                             classFile.getConstPool(), pool.get(member.getReturnType().getName()), value);</span><br /><span class="line"><span class="number">58</span>:                                     ja.addMemberValue(member.getName(), memberValue);</span><br /><span class="line"><span class="number">59</span>:                                 }</span><br /><span class="line"><span class="number">60</span>:                             }</span><br /><span class="line"><span class="number">61</span>:                         }</span><br /><span class="line"><span class="number">62</span>:                         attribute.addAnnotation(ja);</span><br /><span class="line"><span class="number">63</span>:                     }</span><br /><span class="line"><span class="number">64</span>:                 }</span><br /><span class="line"><span class="number">65</span>:                 <span class="comment">// åˆ›å»ºå±æ€§</span></span><br /><span class="line"><span class="number">66</span>:                 String fieldName = method.getName() + <span class="string">"Argument"</span> + i;</span><br /><span class="line"><span class="number">67</span>:                 CtField ctField = CtField.make(<span class="string">"public "</span> + type.getCanonicalName() + <span class="string">" "</span> + fieldName + <span class="string">";"</span>, pool.getCtClass(parameterClassName));</span><br /><span class="line"><span class="number">68</span>:                 ctField.getFieldInfo().addAttribute(attribute);</span><br /><span class="line"><span class="number">69</span>:                 <span class="comment">// æ·»åŠ å±æ€§</span></span><br /><span class="line"><span class="number">70</span>:                 ctClass.addField(ctField);</span><br /><span class="line"><span class="number">71</span>:             }</span><br /><span class="line"><span class="number">72</span>:             <span class="comment">// ç”Ÿæˆç±»</span></span><br /><span class="line"><span class="number">73</span>:             parameterClass = ctClass.toClass(clazz.getClassLoader(), <span class="keyword">null</span>);</span><br /><span class="line"><span class="number">74</span>:         }</span><br /><span class="line"><span class="number">75</span>:         <span class="comment">// åˆ›å»º Bean å¯¹è±¡</span></span><br /><span class="line"><span class="number">76</span>:         Object parameterBean = parameterClass.newInstance();</span><br /><span class="line"><span class="number">77</span>:         <span class="comment">// è®¾ç½® Bean å¯¹è±¡çš„æ¯ä¸ªå±æ€§çš„å€¼</span></span><br /><span class="line"><span class="number">78</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) {</span><br /><span class="line"><span class="number">79</span>:             Field field = parameterClass.getField(method.getName() + <span class="string">"Argument"</span> + i);</span><br /><span class="line"><span class="number">80</span>:             field.set(parameterBean, args[i]);</span><br /><span class="line"><span class="number">81</span>:         }</span><br /><span class="line"><span class="number">82</span>:         <span class="keyword">return</span> parameterBean;</span><br /><span class="line"><span class="number">83</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">84</span>:         logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">85</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">86</span>:     }</span><br /><span class="line"><span class="number">87</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ç¬¬ 13 è‡³ 15 è¡Œï¼šè°ƒç”¨&nbsp;<code>#hasConstraintParameter(method)</code>&nbsp;æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰&nbsp;<strong>Constraint</strong>&nbsp;æ³¨è§£( ä¾‹å¦‚ï¼Œ<code>@NotNull</code>&nbsp;)çš„æ–¹æ³•å‚æ•°ã€‚è‹¥æ²¡æœ‰ï¼Œåˆ™æ— éœ€åˆ›å»º Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hasConstraintParameter</span><span class="params">(Method method)</span> </span>{</span><br /><span class="line">    Annotation[][] parameterAnnotations = method.getParameterAnnotations();</span><br /><span class="line">    <span class="comment">// å¾ªç¯æ‰€æœ‰æ–¹æ³•å‚æ•°çš„æ³¨è§£</span></span><br /><span class="line">    <span class="keyword">if</span> (parameterAnnotations != <span class="keyword">null</span> &amp;&amp; parameterAnnotations.length &gt; <span class="number">0</span>) {</span><br /><span class="line">        <span class="comment">// å¾ªç¯æ¯ä¸ªæ–¹æ³•å‚æ•°çš„æ³¨è§£æ•°ç»„</span></span><br /><span class="line">        <span class="keyword">for</span> (Annotation[] annotations : parameterAnnotations) {</span><br /><span class="line">            <span class="comment">// æ˜¯å¦æœ‰ Constraint æ³¨è§£</span></span><br /><span class="line">            <span class="keyword">for</span> (Annotation annotation : annotations) {</span><br /><span class="line">                <span class="keyword">if</span> (annotation.annotationType().isAnnotationPresent(Constraint.class)) {</span><br /><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 17 è‡³ 22 è¡Œï¼šè·å¾— Bean ç±»ã€‚</p>
</li>
<li>
<p>ç¬¬ 23 è‡³ 73 è¡Œï¼šè‹¥ Bean ç±»<strong>ä¸å­˜åœ¨</strong>ï¼Œä½¿ç”¨ Javassist åŠ¨æ€ç¼–è¯‘ç”Ÿæˆã€‚ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œå·²ç»æ·»åŠ è¯¦ç»†æ³¨é‡Šï¼Œèƒ–å‹è€å¿ƒçœ‹çœ‹å“ˆã€‚å…¶ä¸­ï¼Œ<code>#createMemberValue(ConstPool cp, CtClass type, Object value)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æ³¨è§£<strong>æ¯ä¸ªå±æ€§çš„å€¼</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// Copy from javassist.bytecode.annotation.Annotation.createMemberValue(ConstPool, CtClass);</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> MemberValue <span class="title">createMemberValue</span><span class="params">(ConstPool cp, CtClass type, Object value)</span> <span class="keyword">throws</span> NotFoundException </span>{</span><br /><span class="line">    MemberValue memberValue = javassist.bytecode.annotation.Annotation.createMemberValue(cp, type);</span><br /><span class="line">    <span class="keyword">if</span> (memberValue <span class="keyword">instanceof</span> BooleanMemberValue) <span class="comment">// Boolean</span></span><br /><span class="line">        ((BooleanMemberValue) memberValue).setValue((Boolean) value);</span><br /><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (memberValue <span class="keyword">instanceof</span> ByteMemberValue) <span class="comment">// Byte</span></span><br /><span class="line">        ((ByteMemberValue) memberValue).setValue((Byte) value);</span><br /><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (memberValue <span class="keyword">instanceof</span> CharMemberValue) <span class="comment">// Char</span></span><br /><span class="line">        ((CharMemberValue) memberValue).setValue((Character) value);</span><br /><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (memberValue <span class="keyword">instanceof</span> ShortMemberValue) <span class="comment">// Short</span></span><br /><span class="line">        ((ShortMemberValue) memberValue).setValue((Short) value);</span><br /><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (memberValue <span class="keyword">instanceof</span> IntegerMemberValue) <span class="comment">// Integer</span></span><br /><span class="line">        ((IntegerMemberValue) memberValue).setValue((Integer) value);</span><br /><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (memberValue <span class="keyword">instanceof</span> LongMemberValue) <span class="comment">// Long</span></span><br /><span class="line">        ((LongMemberValue) memberValue).setValue((Long) value);</span><br /><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (memberValue <span class="keyword">instanceof</span> FloatMemberValue) <span class="comment">// Float</span></span><br /><span class="line">        ((FloatMemberValue) memberValue).setValue((Float) value);</span><br /><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (memberValue <span class="keyword">instanceof</span> DoubleMemberValue)</span><br /><span class="line">        ((DoubleMemberValue) memberValue).setValue((Double) value);</span><br /><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (memberValue <span class="keyword">instanceof</span> ClassMemberValue) <span class="comment">// Class</span></span><br /><span class="line">        ((ClassMemberValue) memberValue).setValue(((Class&lt;?&gt;) value).getName());</span><br /><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (memberValue <span class="keyword">instanceof</span> StringMemberValue) <span class="comment">// String</span></span><br /><span class="line">        ((StringMemberValue) memberValue).setValue((String) value);</span><br /><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (memberValue <span class="keyword">instanceof</span> EnumMemberValue) <span class="comment">// Enum</span></span><br /><span class="line">        ((EnumMemberValue) memberValue).setValue(((Enum&lt;?&gt;) value).name());</span><br /><span class="line">    <span class="comment">/* else if (memberValue instanceof AnnotationMemberValue) */</span></span><br /><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (memberValue <span class="keyword">instanceof</span> ArrayMemberValue) { <span class="comment">// æ•°ç»„</span></span><br /><span class="line">        CtClass arrayType = type.getComponentType();</span><br /><span class="line">        <span class="keyword">int</span> len = Array.getLength(value);</span><br /><span class="line">        <span class="comment">// å¾ªç¯ï¼Œé€’å½’</span></span><br /><span class="line">        MemberValue[] members = <span class="keyword">new</span> MemberValue[len];</span><br /><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) {</span><br /><span class="line">            members[i] = createMemberValue(cp, arrayType, Array.get(value, i));</span><br /><span class="line">        }</span><br /><span class="line">        ((ArrayMemberValue) memberValue).setValue(members);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> memberValue;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 75 è‡³ 81 è¡Œï¼šåˆ›å»º Bean å¯¹è±¡ï¼Œ<strong>è®¾ç½® Bean å¯¹è±¡çš„æ¯ä¸ªå±æ€§çš„å€¼</strong>ã€‚</p>
</li>
</ul>
<p>ğŸ˜ˆ åˆæ˜¯ä¸€å¤„ï¼Œä½¿ç”¨ Javassist åŠ¨æ€ç¼–è¯‘ç±»çš„ä»£ç ã€‚å¥½ç”¨ï¼ï¼ï¼</p>
<h2 id="4-2-JValidation">4.2 JValidation</h2>
<p><code>com.alibaba.dubbo.validation.support.jvalidation.JValidation</code>&nbsp;ï¼Œå®ç° AbstractValidation æŠ½è±¡ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JValidation</span> <span class="keyword">extends</span> <span class="title">AbstractValidation</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">protected</span> Validator <span class="title">createValidator</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JValidator(url);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="666-å½©è›‹">666. å½©è›‹</h1>
<p>ğŸ™‚ ç¾æ»‹æ»‹ï¼Œç»ˆäºå¼„æ‡‚ï¼Œä¸ºä»€ä¹ˆ JSR303 æ˜¯ Java Bean Validation ï¼Œç»“æœæ¥å£æ–¹æ³•ä¸Šï¼Œæ¯ä¸ªå‚æ•°éƒ½æ·»åŠ  Constraint çš„æ³¨è§£ï¼Œç»“æœä¹Ÿå¯ä»¥åšæ ¡éªŒã€‚</p>
</div>