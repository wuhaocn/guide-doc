<header class="article-header">
<h1 class="article-title">é›†ç¾¤å®¹é”™ï¼ˆå…­ï¼‰ä¹‹ Configurator å®ç°</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡æ¥&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-5-impl-merger/?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆäº”ï¼‰ä¹‹ Merger å®ç°ã€‹</a>&nbsp;ä¸€æ–‡ï¼Œåˆ†äº«&nbsp;<code>dubbo-cluster</code>&nbsp;æ¨¡å—ï¼Œ&nbsp;<code>configurator</code>&nbsp;åŒ…ï¼Œå®ç° Dubbo çš„<strong>é…ç½®è§„åˆ™</strong>åŠŸèƒ½ã€‚</p>
<p>Configurator ç›¸å…³ç±»ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_04_25/01.png" alt="Configurator ç›¸å…³ç±»" /></p>
<blockquote>
<p>è€è‰¿è‰¿ï¼šæœ¬æ–‡å¯¹åº”&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/config-rule.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; é…ç½®è§„åˆ™ã€‹</a>&nbsp;æ–‡æ¡£ã€‚å¦‚æœä¹‹å‰æ²¡äº†è§£è¿‡è¯¥åŠŸèƒ½çš„èƒ–å‹ï¼Œè¯·å…ˆé˜…è¯»äº†è§£ä¸‹å“ˆã€‚</p>
</blockquote>
<h1 id="2-ConfiguratorFactory">2. ConfiguratorFactory</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.ConfiguratorFactory</code>&nbsp;ï¼ŒConfigurator å·¥å‚æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@SPI</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfiguratorFactory</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * get the configurator instance.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> url - configurator url.</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> configurator instance.</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="meta">@Adaptive</span>(<span class="string">"protocol"</span>)</span><br /><span class="line">    <span class="function">Configurator <span class="title">getConfigurator</span><span class="params">(URL url)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>@SPI</code>&nbsp;æ³¨è§£ï¼ŒDubbo SPI&nbsp;<strong>æ‹“å±•ç‚¹</strong>ï¼Œæ— é»˜è®¤å€¼ã€‚</li>
<li><code>@Adaptive("protocol")</code>&nbsp;æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Configurator å®ç°ï¼Œä½¿ç”¨&nbsp;<code>URL.protocol</code>&nbsp;å±æ€§ã€‚</li>
<li><code>#getConfigurator(URL url)</code>&nbsp;æ¥å£æ–¹æ³•ï¼Œè·å¾— Configurator å¯¹è±¡ã€‚</li>
</ul>
<h2 id="2-1-OverrideConfiguratorFactory">2.1 OverrideConfiguratorFactory</h2>
<p><code>com.alibaba.dubbo.rpc.cluster.configurator.override.OverrideConfiguratorFactory</code>&nbsp;ï¼Œå®ç° ConfiguratorFactory æ¥å£ï¼Œ<strong>OverrideConfigurator</strong>&nbsp;å·¥å‚ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OverrideConfiguratorFactory</span> <span class="keyword">implements</span> <span class="title">ConfiguratorFactory</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Configurator <span class="title">getConfigurator</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OverrideConfigurator(url);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="2-2-AbsentConfiguratorFactory">2.2 AbsentConfiguratorFactory</h2>
<p><code>com.alibaba.dubbo.rpc.cluster.configurator.absent.AbsentConfiguratorFactory</code>&nbsp;ï¼Œå®ç° ConfiguratorFactory æ¥å£ï¼Œ<strong>AbsentConfigurator</strong>&nbsp;å·¥å‚ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AbsentConfiguratorFactory</span> <span class="keyword">implements</span> <span class="title">ConfiguratorFactory</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Configurator <span class="title">getConfigurator</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AbsentConfigurator(url);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="3-Configurator">3. Configurator</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.Configurator</code>&nbsp;ï¼Œå®ç° Comparable æ¥å£ï¼Œ<strong>é…ç½®è§„åˆ™</strong>æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Configurator</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;<span class="title">Configurator</span>&gt; </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * get the configurator url.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * é…ç½®è§„åˆ™</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> configurator url.</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function">URL <span class="title">getUrl</span><span class="params">()</span></span>;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Configure the provider url.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * é…ç½®åˆ° URL ä¸­</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> url - old rovider url.</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> new provider url.</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function">URL <span class="title">configure</span><span class="params">(URL url)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><strong>ä¸€ä¸ª Configurator å¯¹è±¡ï¼Œå¯¹åº”ä¸€æ¡é…ç½®è§„åˆ™</strong>ã€‚</li>
<li>Configurator æœ‰<strong>ä¼˜å…ˆçº§</strong>çš„è¦æ±‚ï¼Œæ‰€ä»¥å®ç° Comparable æ¥å£ã€‚</li>
<li><code>#getUrl()</code>&nbsp;æ¥å£æ–¹æ³•ï¼Œè·å¾—é…ç½® URL ï¼Œé‡Œé¢å¸¦æœ‰é…ç½®è§„åˆ™ã€‚</li>
<li><code>#configure(Url url)</code>&nbsp;æ¥å£æ–¹æ³•ï¼Œ<strong>è®¾ç½®</strong>é…ç½®è§„åˆ™åˆ°æŒ‡å®š URL ä¸­ã€‚</li>
</ul>
<h2 id="3-1-AbstractConfigurator">3.1 AbstractConfigurator</h2>
<p><code>com.alibaba.dubbo.rpc.cluster.configurator.AbstractConfigurator</code>&nbsp;ï¼Œå®ç° Configurator æ¥å£ï¼Œå®ç°å…¬ç”¨çš„é…ç½®è§„åˆ™çš„<strong>åŒ¹é…</strong>ã€<strong>æ’åº</strong>çš„é€»è¾‘ã€‚</p>
<h3 id="3-1-1-getUrl">3.1.1 getUrl</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é…ç½®è§„åˆ™ URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> URL configuratorUrl;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractConfigurator</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (url == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"configurator url == null"</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">this</span>.configuratorUrl = url;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> URL <span class="title">getUrl</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> configuratorUrl;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="3-1-2-configure">3.1.2 configure</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> URL <span class="title">configure</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (configuratorUrl.getHost() == <span class="keyword">null</span> || url == <span class="keyword">null</span> || url.getHost() == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="keyword">return</span> url;</span><br /><span class="line"> <span class="number">5</span>:     }</span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// If override url has port, means it is a provider address. We want to control a specific provider with this override url, it may take effect on the specific provider instance or on consumers holding this provider instance.</span></span><br /><span class="line"> <span class="number">7</span>:     <span class="comment">// é…ç½®è§„åˆ™ï¼ŒURL å¸¦æœ‰ç«¯å£( port )ï¼Œæ„å›¾æ˜¯æ§åˆ¶æä¾›è€…æœºå™¨ã€‚å¯ä»¥åœ¨æä¾›ç«¯ç”Ÿæ•ˆ ä¹Ÿå¯ä»¥åœ¨æ¶ˆè´¹ç«¯ç”Ÿæ•ˆ</span></span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (configuratorUrl.getPort() != <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (url.getPort() == configuratorUrl.getPort()) {</span><br /><span class="line"><span class="number">10</span>:             <span class="keyword">return</span> configureIfMatch(url.getHost(), url);</span><br /><span class="line"><span class="number">11</span>:         }</span><br /><span class="line"><span class="number">12</span>:     <span class="comment">// override url don't have a port, means the ip override url specify is a consumer address or 0.0.0.0</span></span><br /><span class="line"><span class="number">13</span>:     <span class="comment">// é…ç½®è§„åˆ™ï¼ŒURL æ²¡æœ‰ç«¯å£ï¼Œoverride è¾“å…¥æ¶ˆè´¹ç«¯åœ°å€ æˆ–è€… 0.0.0.0</span></span><br /><span class="line"><span class="number">14</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">15</span>:         <span class="comment">// 1.If it is a consumer ip address, the intention is to control a specific consumer instance, it must takes effect at the consumer side, any provider received this override url should ignore;</span></span><br /><span class="line"><span class="number">16</span>:         <span class="comment">// 2.If the ip is 0.0.0.0, this override url can be used on consumer, and also can be used on provider</span></span><br /><span class="line"><span class="number">17</span>:         <span class="comment">// 1. å¦‚æœæ˜¯æ¶ˆè´¹ç«¯åœ°å€ï¼Œåˆ™æ„å›¾æ˜¯æ§åˆ¶æ¶ˆè´¹è€…æœºå™¨ï¼Œå¿…å®šåœ¨æ¶ˆè´¹ç«¯ç”Ÿæ•ˆï¼Œæä¾›ç«¯å¿½ç•¥ï¼›</span></span><br /><span class="line"><span class="number">18</span>:         <span class="comment">// 2. å¦‚æœæ˜¯0.0.0.0å¯èƒ½æ˜¯æ§åˆ¶æä¾›ç«¯ï¼Œä¹Ÿå¯èƒ½æ˜¯æ§åˆ¶æä¾›ç«¯</span></span><br /><span class="line"><span class="number">19</span>:         <span class="keyword">if</span> (url.getParameter(Constants.SIDE_KEY, Constants.PROVIDER).equals(Constants.CONSUMER)) {</span><br /><span class="line"><span class="number">20</span>:             <span class="comment">// NetUtils.getLocalHostæ˜¯æ¶ˆè´¹ç«¯æ³¨å†Œåˆ°zkçš„æ¶ˆè´¹è€…åœ°å€</span></span><br /><span class="line"><span class="number">21</span>:             <span class="keyword">return</span> configureIfMatch(NetUtils.getLocalHost(), url);<span class="comment">// NetUtils.getLocalHost is the ip address consumer registered to registry.</span></span><br /><span class="line"><span class="number">22</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (url.getParameter(Constants.SIDE_KEY, Constants.CONSUMER).equals(Constants.PROVIDER)) {</span><br /><span class="line"><span class="number">23</span>:             <span class="comment">// æ§åˆ¶æ‰€æœ‰æä¾›ç«¯ï¼Œåœ°å€å¿…å®šæ˜¯0.0.0.0ï¼Œå¦åˆ™å°±è¦é…ç«¯å£ä»è€Œæ‰§è¡Œä¸Šé¢çš„ifåˆ†æ”¯äº†</span></span><br /><span class="line"><span class="number">24</span>:             <span class="keyword">return</span> configureIfMatch(Constants.ANYHOST_VALUE, url);<span class="comment">// take effect on all providers, so address must be 0.0.0.0, otherwise it won't flow to this if branch</span></span><br /><span class="line"><span class="number">25</span>:         }</span><br /><span class="line"><span class="number">26</span>:     }</span><br /><span class="line"><span class="number">27</span>:     <span class="keyword">return</span> url;</span><br /><span class="line"><span class="number">28</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œã€ç¬¬ 6 è‡³ 26 è¡Œã€‘ä¸€å…±æœ‰<strong>ä¸‰ç§</strong>æƒ…å†µçš„åˆ¤æ–­ï¼š
<ul>
<li>ã€ç¬¬ä¸€ç§ã€‘ç¬¬ 8 è¡Œï¼š&nbsp;<code>configuratorUrl</code>&nbsp;å¸¦æœ‰<strong>ç«¯å£( port )</strong>ï¼Œæ„å›¾æ˜¯åŒ¹é…<strong>æŒ‡å®šä¸€ä¸ª</strong>æœåŠ¡æä¾›è€…ï¼Œå› æ­¤ä½¿ç”¨&nbsp;<code>url.host</code>&nbsp;å±æ€§ã€‚</li>
<li>ã€ç¬¬äºŒç§ã€‘ç¬¬ 19 è¡Œï¼š<code>url</code>&nbsp;çš„&nbsp;<code>side = consumer</code>&nbsp;ï¼Œæ„å›¾æ˜¯åŒ¹é…æœåŠ¡æ¶ˆè´¹è€…ï¼Œå› æ­¤ä½¿ç”¨&nbsp;<code>NetUtils#getLocalHost()</code>&nbsp;å±æ€§ã€‚</li>
<li>ã€ç¬¬ä¸‰ç§ã€‘ç¬¬ 22 è¡Œï¼š<code>url</code>&nbsp;çš„&nbsp;<code>side = provider</code>&nbsp;ï¼Œæ„å›¾æ˜¯åŒ¹é…<strong>å…¨éƒ¨</strong>æœåŠ¡æä¾›è€…ï¼Œå› æ­¤ä½¿ç”¨&nbsp;<code>Constants.ANYHOST_VALUE = *</code>&nbsp;å±æ€§ã€‚ğŸ™‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œç›®å‰æš‚ä¸æ”¯æŒ<strong>æŒ‡å®šæœºå™¨</strong>æœåŠ¡æä¾›è€…ã€‚</li>
</ul>
</li>
<li>ç¬¬ 10 è¡Œ || ç¬¬ 21 è¡Œ || ç¬¬ 24 è¡Œï¼šè°ƒç”¨&nbsp;<code>#configureIfMatch(host, url)</code>&nbsp;æ–¹æ³•ï¼Œé…ç½®åˆ°&nbsp;<code>url</code>&nbsp;ä¸­ï¼Œè‹¥é…ç½®è§„åˆ™åŒ¹é…ã€‚</li>
</ul>
<h4 id="3-1-2-1-configureIfMatch">3.1.2.1 configureIfMatch</h4>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> URL <span class="title">configureIfMatch</span><span class="params">(String host, URL url)</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// åŒ¹é… Host</span></span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (Constants.ANYHOST_VALUE.equals(configuratorUrl.getHost()) || host.equals(configuratorUrl.getHost())) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="comment">// åŒ¹é… "application"</span></span><br /><span class="line"> <span class="number">5</span>:         String configApplication = configuratorUrl.getParameter(Constants.APPLICATION_KEY, configuratorUrl.getUsername()); <span class="comment">// TODO èŠ‹è‰¿ï¼Œä¸ºå•¥ username</span></span><br /><span class="line"> <span class="number">6</span>:         String currentApplication = url.getParameter(Constants.APPLICATION_KEY, url.getUsername());</span><br /><span class="line"> <span class="number">7</span>:         <span class="keyword">if</span> (configApplication == <span class="keyword">null</span> || Constants.ANY_VALUE.equals(configApplication)</span><br /><span class="line"> <span class="number">8</span>:                 || configApplication.equals(currentApplication)) {</span><br /><span class="line"> <span class="number">9</span>:             <span class="comment">// é…ç½® URL ä¸­çš„æ¡ä»¶ KEYS é›†åˆã€‚å…¶ä¸­ä¸‹é¢å››ä¸ª KEY ï¼Œä¸ç®—æ˜¯æ¡ä»¶ï¼Œè€Œæ˜¯å†…ç½®å±æ€§ã€‚è€ƒè™‘åˆ°ä¸‹é¢è¦ç§»é™¤ï¼Œæ‰€ä»¥æ·»åŠ åˆ°è¯¥é›†åˆä¸­ã€‚</span></span><br /><span class="line"><span class="number">10</span>:             Set&lt;String&gt; conditionKeys = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br /><span class="line"><span class="number">11</span>:             conditionKeys.add(Constants.CATEGORY_KEY);</span><br /><span class="line"><span class="number">12</span>:             conditionKeys.add(Constants.CHECK_KEY);</span><br /><span class="line"><span class="number">13</span>:             conditionKeys.add(Constants.DYNAMIC_KEY);</span><br /><span class="line"><span class="number">14</span>:             conditionKeys.add(Constants.ENABLED_KEY);</span><br /><span class="line"><span class="number">15</span>:             <span class="comment">// åˆ¤æ–­ä¼ å…¥çš„ url æ˜¯å¦åŒ¹é…é…ç½®è§„åˆ™ URL çš„æ¡ä»¶ã€‚é™¤äº† "application" å’Œ "side" ä¹‹å¤–ï¼Œå¸¦æœ‰ `"~"` å¼€å¤´çš„ KEY ï¼Œä¹Ÿæ˜¯æ¡ä»¶ã€‚</span></span><br /><span class="line"><span class="number">16</span>:             <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : configuratorUrl.getParameters().entrySet()) {</span><br /><span class="line"><span class="number">17</span>:                 String key = entry.getKey();</span><br /><span class="line"><span class="number">18</span>:                 String value = entry.getValue();</span><br /><span class="line"><span class="number">19</span>:                 <span class="keyword">if</span> (key.startsWith(<span class="string">"~"</span>) || Constants.APPLICATION_KEY.equals(key) || Constants.SIDE_KEY.equals(key)) {</span><br /><span class="line"><span class="number">20</span>:                     conditionKeys.add(key);</span><br /><span class="line"><span class="number">21</span>:                     <span class="comment">// è‹¥ä¸ç›¸ç­‰ï¼Œåˆ™ä¸åŒ¹é…é…ç½®è§„åˆ™ï¼Œç›´æ¥è¿”å›</span></span><br /><span class="line"><span class="number">22</span>:                     <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; !Constants.ANY_VALUE.equals(value)</span><br /><span class="line"><span class="number">23</span>:                             &amp;&amp; !value.equals(url.getParameter(key.startsWith(<span class="string">"~"</span>) ? key.substring(<span class="number">1</span>) : key))) {</span><br /><span class="line"><span class="number">24</span>:                         <span class="keyword">return</span> url;</span><br /><span class="line"><span class="number">25</span>:                     }</span><br /><span class="line"><span class="number">26</span>:                 }</span><br /><span class="line"><span class="number">27</span>:             }</span><br /><span class="line"><span class="number">28</span>:             <span class="comment">// ç§»é™¤æ¡ä»¶ KEYS é›†åˆï¼Œå¹¶é…ç½®åˆ° URL ä¸­</span></span><br /><span class="line"><span class="number">29</span>:             <span class="keyword">return</span> doConfigure(url, configuratorUrl.removeParameters(conditionKeys));</span><br /><span class="line"><span class="number">30</span>:         }</span><br /><span class="line"><span class="number">31</span>:     }</span><br /><span class="line"><span class="number">32</span>:     <span class="keyword">return</span> url;</span><br /><span class="line"><span class="number">33</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šåŒ¹é…&nbsp;<strong>HOST</strong>&nbsp;ã€‚</li>
<li>ç¬¬ 4 è‡³ 8 è¡Œï¼šåŒ¹é…&nbsp;<strong><code>"application"</code></strong>&nbsp;ã€‚</li>
<li>ç¬¬ 9 è‡³ 14 è¡Œï¼šé…ç½® URL ä¸­çš„<strong>æ¡ä»¶ KEYS é›†åˆ</strong>ã€‚å…¶ä¸­ä¸‹é¢å››ä¸ª KEY ï¼Œä¸ç®—æ˜¯æ¡ä»¶ï¼Œè€Œæ˜¯<strong>å†…ç½®å±æ€§</strong>ã€‚è€ƒè™‘åˆ°ä¸‹é¢è¦ç§»é™¤ï¼Œæ‰€ä»¥æ·»åŠ åˆ°è¯¥é›†åˆä¸­ã€‚</li>
<li>ç¬¬ 15 è‡³ 27 è¡Œï¼šåˆ¤æ–­ä¼ å…¥çš„&nbsp;<code>url</code>&nbsp;æ˜¯å¦åŒ¹é…é…ç½®è§„åˆ™ URL çš„æ¡ä»¶ã€‚é™¤äº†&nbsp;<code>"application"</code>&nbsp;å’Œ&nbsp;<code>"side"</code>&nbsp;ä¹‹å¤–ï¼Œ<strong>å¸¦æœ‰&nbsp;<code>"~"</code>&nbsp;å¼€å¤´çš„ KEY ï¼Œä¹Ÿæ˜¯æ¡ä»¶</strong>ã€‚
<ul>
<li>ç¬¬ 21 è‡³ 25 è¡Œï¼š è‹¥<strong>ä¸ç›¸ç­‰</strong>ï¼Œåˆ™<strong>ä¸åŒ¹é…</strong>é…ç½®è§„åˆ™ï¼Œç›´æ¥è¿”å›&nbsp;<code>url</code>&nbsp;ã€‚</li>
</ul>
</li>
<li>ç¬¬ 29 è¡Œï¼šä»&nbsp;<code>configuratorUrl</code>&nbsp;<strong>ç§»é™¤</strong>æ¡ä»¶ KEYS é›†åˆï¼Œå¹¶è°ƒç”¨&nbsp;<code>#doConfigure(URL currentUrl, URL configUrl)</code>&nbsp;<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå®ç°<strong>å­ç±»</strong>è®¾ç½®<strong>é…ç½®è§„åˆ™</strong>åˆ°&nbsp;<code>url</code>&nbsp;ä¸­ã€‚</li>
</ul>
<h4 id="3-1-2-2-doConfigure">3.1.2.2 doConfigure</h4>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> URL <span class="title">doConfigure</span><span class="params">(URL currentUrl, URL configUrl)</span></span>;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="3-1-3-compareTo">3.1.3 compareTo</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Configurator o)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (o == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// host å‡åº</span></span><br /><span class="line">    <span class="keyword">int</span> ipCompare = getUrl().getHost().compareTo(o.getUrl().getHost());</span><br /><span class="line">    <span class="comment">// è‹¥ host ç›¸åŒï¼ŒæŒ‰ç…§ priority é™åº</span></span><br /><span class="line">    <span class="keyword">if</span> (ipCompare == <span class="number">0</span>) {<span class="comment">//host is the same, sort by priority</span></span><br /><span class="line">        <span class="keyword">int</span> i = getUrl().getParameter(Constants.PRIORITY_KEY, <span class="number">0</span>);</span><br /><span class="line">        <span class="keyword">int</span> j = o.getUrl().getParameter(Constants.PRIORITY_KEY, <span class="number">0</span>);</span><br /><span class="line">        <span class="keyword">if</span> (i &lt; j) {</span><br /><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br /><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (i &gt; j) {</span><br /><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br /><span class="line">        } <span class="keyword">else</span> {</span><br /><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br /><span class="line">        }</span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        <span class="keyword">return</span> ipCompare;</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä¼˜å…ˆï¼ŒæŒ‰ç…§ host&nbsp;<strong>å‡åº</strong>ï¼Œå³<strong>ç‰¹å®š</strong>&nbsp;host&nbsp;<strong>é«˜</strong>äº&nbsp;<strong>anyhost</strong>(&nbsp;<code>"0.0.0.0"</code>&nbsp;) ã€‚</li>
<li>å…¶æ¬¡ï¼ŒæŒ‰ç…§&nbsp;<code>"priority"</code>&nbsp;<strong>é™åº</strong>ã€‚</li>
</ul>
<h2 id="3-2-OverrideConfigurator">3.2 OverrideConfigurator</h2>
<p><code>com.alibaba.dubbo.rpc.cluster.configurator.override.OverrideConfigurator</code>&nbsp;ï¼Œå®ç° AbstractConfigurator æŠ½è±¡ç±»ï¼Œ<code>override</code>&nbsp;Configurator å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OverrideConfigurator</span> <span class="keyword">extends</span> <span class="title">AbstractConfigurator</span> </span>{</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">OverrideConfigurator</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">        <span class="keyword">super</span>(url);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> URL <span class="title">doConfigure</span><span class="params">(URL currentUrl, URL configUrl)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> currentUrl.addParameters(configUrl.getParameters()); <span class="comment">// è¦†ç›–æ·»åŠ </span></span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><strong>è¦†ç›–</strong>æ·»åŠ ã€‚</li>
</ul>
<h2 id="3-3-AbsentConfigurator">3.3 AbsentConfigurator</h2>
<p><code>com.alibaba.dubbo.rpc.cluster.configurator.absent.AbsentConfigurator</code>&nbsp;ï¼Œå®ç° AbstractConfigurator æŠ½è±¡ç±»ï¼Œ<code>absent</code>&nbsp;Configurator å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AbsentConfigurator</span> <span class="keyword">extends</span> <span class="title">AbstractConfigurator</span> </span>{</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AbsentConfigurator</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">        <span class="keyword">super</span>(url);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> URL <span class="title">doConfigure</span><span class="params">(URL currentUrl, URL configUrl)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> currentUrl.addParametersIfAbsent(configUrl.getParameters()); <span class="comment">// ä¸å­˜åœ¨æ—¶æ·»åŠ </span></span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><strong>ä¸å­˜åœ¨æ—¶</strong>æ·»åŠ ã€‚</li>
</ul>
<p>ä»ç›®å‰&nbsp;<code>dubbo-admin</code>&nbsp;é¡¹ç›®æ¥çœ‹ï¼Œç›®å‰<strong>æš‚æœªä½¿ç”¨</strong>&nbsp;<code>absent</code>&nbsp;çš„é…ç½®è§„åˆ™ã€‚</p>
<h1 id="4-é›†æˆ-Configurator-æ¨¡å—">4. é›†æˆ Configurator æ¨¡å—</h1>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæœ‰<strong>ä¸‰ä¸ªç±»</strong>ï¼Œè°ƒç”¨&nbsp;<code>Configurator#configure(URL url)</code>&nbsp;æ–¹æ³•ï¼Œé›†æˆ Configurator æ¨¡å—ã€‚</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_04_25/02.png" alt="é›†æˆ" /></p>
<h2 id="4-1-RegistryDirectory">4.1 RegistryDirectory</h2>
<p>RegistryDirectory å°†é…ç½®è§„åˆ™é›†æˆåˆ°å…¶ä¸­ï¼Œä»è€Œé›†æˆåˆ°<strong>æœåŠ¡æ¶ˆè´¹è€…</strong>ä¸­ã€‚</p>
<h3 id="4-1-1-toConfigurators">4.1.1 toConfigurators</h3>
<p><code>#toConfigurators(List&lt;URL&gt; urls)</code>&nbsp;æ–¹æ³•ï¼Œå®˜æ–¹æ³¨é‡Šå¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å°†overrideURL è½¬æ¢ä¸º mapï¼Œä¾›é‡æ–° refer æ—¶ä½¿ç”¨.</span></span><br /><span class="line"><span class="comment"> * æ¯æ¬¡ä¸‹å‘å…¨éƒ¨è§„åˆ™ï¼Œå…¨éƒ¨é‡æ–°ç»„è£…è®¡ç®—</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> urls å¥‘çº¦ï¼š</span></span><br /><span class="line"><span class="comment"> *             &lt;/br&gt;1.override://0.0.0.0/...(æˆ–override://ip:port...?anyhost=true)&amp;para1=value1...è¡¨ç¤ºå…¨å±€è§„åˆ™(å¯¹æ‰€æœ‰çš„æä¾›è€…å…¨éƒ¨ç”Ÿæ•ˆ)</span></span><br /><span class="line"><span class="comment"> *             &lt;/br&gt;2.override://ip:port...?anyhost=false ç‰¹ä¾‹è§„åˆ™ï¼ˆåªé’ˆå¯¹æŸä¸ªæä¾›è€…ç”Ÿæ•ˆï¼‰</span></span><br /><span class="line"><span class="comment"> *             &lt;/br&gt;3.ä¸æ”¯æŒoverride://è§„åˆ™... éœ€è¦æ³¨å†Œä¸­å¿ƒè‡ªè¡Œè®¡ç®—.</span></span><br /><span class="line"><span class="comment"> *             &lt;/br&gt;4.ä¸å¸¦å‚æ•°çš„override://0.0.0.0/ è¡¨ç¤ºæ¸…é™¤override</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> Configurator é›†åˆ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Configurator&gt; <span class="title">toConfigurators</span><span class="params">(List&lt;URL&gt; urls)</span> </span>{</span><br /><span class="line">    <span class="comment">// ...çœç•¥ä»£ç </span></span><br /><span class="line"> }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å®é™…ä¸Šï¼Œè¯¥æ³¨é‡Šè¯´æ˜äº†é…ç½®è§„åˆ™ï¼Œåœ¨ RegistryDirectory ä¸­ï¼Œæ˜¯<strong>å¦‚ä½•é›†æˆé…ç½®è§„åˆ™æ¨¡å—</strong>ã€‚ç‰¹åˆ«æ˜¯<strong>å››æ¡</strong>å¥‘çº¦ï¼Œèƒ–å‹å¥½å¥½ç†è§£ä¸‹ã€‚</li>
</ul>
<p>è¯¥æ–¹æ³•çš„çœŸæ­£æ³¨é‡Šï¼Œåº”è¯¥æ˜¯ï¼šå°†é…ç½®è§„åˆ™ URL é›†åˆï¼Œ<strong>è½¬æ¢</strong>æˆå¯¹åº”çš„ Configurator é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Configurator&gt; <span class="title">toConfigurators</span><span class="params">(List&lt;URL&gt; urls)</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// å¿½ç•¥ï¼Œè‹¥é…ç½®è§„åˆ™ URL é›†åˆä¸ºç©º</span></span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (urls == <span class="keyword">null</span> || urls.isEmpty()) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="keyword">return</span> Collections.emptyList();</span><br /><span class="line"> <span class="number">5</span>:     }</span><br /><span class="line"> <span class="number">6</span>: </span><br /><span class="line"> <span class="number">7</span>:     <span class="comment">// åˆ›å»º Configurator é›†åˆ</span></span><br /><span class="line"> <span class="number">8</span>:     List&lt;Configurator&gt; configurators = <span class="keyword">new</span> ArrayList&lt;Configurator&gt;(urls.size());</span><br /><span class="line"> <span class="number">9</span>:     <span class="keyword">for</span> (URL url : urls) {</span><br /><span class="line"><span class="number">10</span>:         <span class="comment">// è‹¥åè®®ä¸º `empty://` ï¼Œæ„å‘³ç€æ¸…ç©ºæ‰€æœ‰é…ç½®è§„åˆ™ï¼Œå› æ­¤è¿”å›ç©º Configurator é›†åˆ</span></span><br /><span class="line"><span class="number">11</span>:         <span class="keyword">if</span> (Constants.EMPTY_PROTOCOL.equals(url.getProtocol())) {</span><br /><span class="line"><span class="number">12</span>:             configurators.clear();</span><br /><span class="line"><span class="number">13</span>:             <span class="keyword">break</span>;</span><br /><span class="line"><span class="number">14</span>:         }</span><br /><span class="line"><span class="number">15</span>:         <span class="comment">// å¯¹åº”ç¬¬ 4 æ¡å¥‘çº¦ï¼Œä¸å¸¦å‚æ•°çš„ override://0.0.0.0/ è¡¨ç¤ºæ¸…é™¤ override</span></span><br /><span class="line"><span class="number">16</span>:         Map&lt;String, String&gt; override = <span class="keyword">new</span> HashMap&lt;String, String&gt;(url.getParameters());</span><br /><span class="line"><span class="number">17</span>:         <span class="comment">// The anyhost parameter of override may be added automatically, it can't change the judgement of changing url</span></span><br /><span class="line"><span class="number">18</span>:         <span class="comment">// override ä¸Šçš„ anyhost å¯èƒ½æ˜¯è‡ªåŠ¨æ·»åŠ çš„ï¼Œä¸èƒ½å½±å“æ”¹å˜urlåˆ¤æ–­</span></span><br /><span class="line"><span class="number">19</span>:         override.remove(Constants.ANYHOST_KEY);</span><br /><span class="line"><span class="number">20</span>:         <span class="keyword">if</span> (override.size() == <span class="number">0</span>) {</span><br /><span class="line"><span class="number">21</span>:             configurators.clear();</span><br /><span class="line"><span class="number">22</span>:             <span class="keyword">continue</span>;</span><br /><span class="line"><span class="number">23</span>:         }</span><br /><span class="line"><span class="number">24</span>:         <span class="comment">// è·å¾— Configurator å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ° `configurators` ä¸­</span></span><br /><span class="line"><span class="number">25</span>:         configurators.add(configuratorFactory.getConfigurator(url));</span><br /><span class="line"><span class="number">26</span>:     }</span><br /><span class="line"><span class="number">27</span>:     <span class="comment">// æ’åº</span></span><br /><span class="line"><span class="number">28</span>:     Collections.sort(configurators);</span><br /><span class="line"><span class="number">29</span>:     <span class="keyword">return</span> configurators;</span><br /><span class="line"><span class="number">30</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 2 è‡³ 5 è¡Œï¼š<strong>å¿½ç•¥</strong>ï¼Œè‹¥&nbsp;<code>urls</code>&nbsp;é›†åˆä¸ºç©ºã€‚</li>
<li>çš„ 8 è¡Œï¼šåˆ›å»º Configurator é›†åˆ&nbsp;<code>configurators</code>&nbsp;å˜é‡ã€‚</li>
<li>ç¬¬ 9 è‡³ 26 è¡Œï¼š<strong>å¾ªç¯</strong>&nbsp;<code>urls</code>&nbsp;é›†åˆï¼Œ<strong>è½¬æ¢</strong>æˆå¯¹åº”çš„ Configurator é›†åˆã€‚ğŸ™‚ ä¸­é—´çš„è¿‡ç¨‹ï¼Œèƒ–å‹çœ‹ä¸‹æ³¨é‡Šã€‚</li>
<li>ç¬¬ 28 è¡Œï¼šå°†&nbsp;<code>configurators</code>&nbsp;é›†åˆï¼Œ<strong>æ’åº</strong>ã€‚å…·ä½“çš„æ’åºè§„åˆ™ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-6-impl-configurator/">ã€Œ3.13 compareToã€</a>&nbsp;å·²ç»è§£æã€‚</li>
</ul>
<h3 id="4-1-2-mergeUrl">4.1.2 mergeUrl</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> URL <span class="title">mergeUrl</span><span class="params">(URL providerUrl)</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// åˆå¹¶æ¶ˆè´¹ç«¯å‚æ•°</span></span><br /><span class="line"> <span class="number">3</span>:     providerUrl = ClusterUtils.mergeUrl(providerUrl, queryMap); <span class="comment">// Merge the consumer side parameters</span></span><br /><span class="line"> <span class="number">4</span>: </span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// åˆå¹¶é…ç½®è§„åˆ™</span></span><br /><span class="line"> <span class="number">6</span>:     List&lt;Configurator&gt; localConfigurators = <span class="keyword">this</span>.configurators; <span class="comment">// local reference</span></span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (localConfigurators != <span class="keyword">null</span> &amp;&amp; !localConfigurators.isEmpty()) {</span><br /><span class="line"> <span class="number">8</span>:         <span class="keyword">for</span> (Configurator configurator : localConfigurators) {</span><br /><span class="line"> <span class="number">9</span>:             providerUrl = configurator.configure(providerUrl);</span><br /><span class="line"><span class="number">10</span>:         }</span><br /><span class="line"><span class="number">11</span>:     }</span><br /><span class="line"><span class="number">12</span>: </span><br /><span class="line"><span class="number">13</span>:     <span class="comment">// ä¸æ£€æŸ¥è¿æ¥æ˜¯å¦æˆåŠŸï¼Œæ€»æ˜¯åˆ›å»º Invoker ï¼</span></span><br /><span class="line"><span class="number">14</span>:     providerUrl = providerUrl.addParameter(Constants.CHECK_KEY, String.valueOf(<span class="keyword">false</span>)); <span class="comment">// Do not check whether the connection is successful or not, always create Invoker!</span></span><br /><span class="line"><span class="number">15</span>: </span><br /><span class="line"><span class="number">16</span>:     <span class="comment">// The combination of directoryUrl and override is at the end of notify, which can't be handled here</span></span><br /><span class="line"><span class="number">17</span>:     <span class="comment">// ä»…åˆå¹¶æä¾›è€…å‚æ•°ï¼Œå› ä¸º directoryUrl ä¸ override åˆå¹¶æ˜¯åœ¨ notify çš„æœ€åï¼Œè¿™é‡Œä¸èƒ½å¤Ÿå¤„ç†</span></span><br /><span class="line"><span class="number">18</span>:     <span class="keyword">this</span>.overrideDirectoryUrl = <span class="keyword">this</span>.overrideDirectoryUrl.addParametersIfAbsent(providerUrl.getParameters()); <span class="comment">// Merge the provider side parameters</span></span><br /><span class="line"><span class="number">19</span>: </span><br /><span class="line"><span class="number">20</span>:     <span class="comment">// ã€å¿½ç•¥ã€‘å› ä¸ºæ˜¯å¯¹ 1.0 ç‰ˆæœ¬çš„å…¼å®¹</span></span><br /><span class="line"><span class="number">21</span>:     <span class="keyword">if</span> ((providerUrl.getPath() == <span class="keyword">null</span> || providerUrl.getPath().length() == <span class="number">0</span>)</span><br /><span class="line"><span class="number">22</span>:             &amp;&amp; <span class="string">"dubbo"</span>.equals(providerUrl.getProtocol())) { <span class="comment">// Compatible version 1.0</span></span><br /><span class="line"><span class="number">23</span>:         <span class="comment">//fix by tony.chenl DUBBO-44</span></span><br /><span class="line"><span class="number">24</span>:         String path = directoryUrl.getParameter(Constants.INTERFACE_KEY);</span><br /><span class="line"><span class="number">25</span>:         <span class="keyword">if</span> (path != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">26</span>:             <span class="keyword">int</span> i = path.indexOf(<span class="string">'/'</span>);</span><br /><span class="line"><span class="number">27</span>:             <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) {</span><br /><span class="line"><span class="number">28</span>:                 path = path.substring(i + <span class="number">1</span>);</span><br /><span class="line"><span class="number">29</span>:             }</span><br /><span class="line"><span class="number">30</span>:             i = path.lastIndexOf(<span class="string">':'</span>);</span><br /><span class="line"><span class="number">31</span>:             <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) {</span><br /><span class="line"><span class="number">32</span>:                 path = path.substring(<span class="number">0</span>, i);</span><br /><span class="line"><span class="number">33</span>:             }</span><br /><span class="line"><span class="number">34</span>:             providerUrl = providerUrl.setPath(path);</span><br /><span class="line"><span class="number">35</span>:         }</span><br /><span class="line"><span class="number">36</span>:     }</span><br /><span class="line"><span class="number">37</span>: </span><br /><span class="line"><span class="number">38</span>:     <span class="comment">// è¿”å›æœåŠ¡æä¾›è€… URL</span></span><br /><span class="line"><span class="number">39</span>:     <span class="keyword">return</span> providerUrl;</span><br /><span class="line"><span class="number">40</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 5 è‡³ 11 è¡Œï¼šå¾ªç¯&nbsp;<code>configurators</code>&nbsp;é›†åˆï¼Œè°ƒç”¨&nbsp;<code>Configurator#configure(URL url)</code>&nbsp;æ–¹æ³•ï¼Œåˆå¹¶<strong>é…ç½®è§„åˆ™</strong>åˆ°&nbsp;<code>providerUrl</code>&nbsp;ä¸­ã€‚</li>
<li>ç¬¬ 14 è¡Œï¼š<strong>ä»…</strong>åˆå¹¶æä¾›è€…å‚æ•°åˆ°&nbsp;<code>overrideDirectoryUrl</code>&nbsp;ä¸­ï¼Œå› ä¸º&nbsp;<code>directoryUrl</code>&nbsp;ä¸é…ç½®è§„åˆ™çš„åˆå¹¶æ˜¯åœ¨&nbsp;<code>#notify(List&lt;URL&gt; urls)</code>&nbsp;æ–¹æ³•çš„<strong>æœ€å</strong>ï¼Œå› è€Œè¿™é‡Œä¸èƒ½å¤Ÿå¤„ç†ã€‚ä»£ç å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2019_04_25/03.png" alt="notify" /></li>
</ul>
<h2 id="4-2-RegistryProtocol">4.2 RegistryProtocol</h2>
<p>RegistryProtocol é€šè¿‡å‘<strong>æ³¨å†Œä¸­å¿ƒ</strong>æ³¨å†Œ OverrideListener ç›‘å¬å™¨ï¼Œä»è€Œé›†æˆé…ç½®è§„åˆ™åˆ°<strong>æœåŠ¡æä¾›è€…</strong>ä¸­ã€‚</p>
<h3 id="4-2-1-export">4.2.1 export</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">public</span> &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(<span class="keyword">final</span> Invoker&lt;T&gt; originInvoker)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// æš´éœ²æœåŠ¡</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// export invoker</span></span><br /><span class="line"> <span class="number">5</span>:     <span class="keyword">final</span> ExporterChangeableWrapper&lt;T&gt; exporter = doLocalExport(originInvoker);</span><br /><span class="line"> <span class="number">6</span>: </span><br /><span class="line"> <span class="number">7</span>:     <span class="comment">// è·å¾—æ³¨å†Œä¸­å¿ƒ URL</span></span><br /><span class="line"> <span class="number">8</span>:     URL registryUrl = getRegistryUrl(originInvoker);</span><br /><span class="line"> <span class="number">9</span>: </span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// è·å¾—æ³¨å†Œä¸­å¿ƒå¯¹è±¡</span></span><br /><span class="line"><span class="number">11</span>:     <span class="comment">// registry provider</span></span><br /><span class="line"><span class="number">12</span>:     <span class="keyword">final</span> Registry registry = getRegistry(originInvoker);</span><br /><span class="line"><span class="number">13</span>: </span><br /><span class="line"><span class="number">14</span>:     <span class="comment">// è·å¾—æœåŠ¡æä¾›è€… URL</span></span><br /><span class="line"><span class="number">15</span>:     <span class="keyword">final</span> URL registedProviderUrl = getRegistedProviderUrl(originInvoker);</span><br /><span class="line"><span class="number">16</span>: </span><br /><span class="line"><span class="number">17</span>:     <span class="comment">//to judge to delay publish whether or not</span></span><br /><span class="line"><span class="number">18</span>:     <span class="keyword">boolean</span> register = registedProviderUrl.getParameter(<span class="string">"register"</span>, <span class="keyword">true</span>);</span><br /><span class="line"><span class="number">19</span>: </span><br /><span class="line"><span class="number">20</span>:     <span class="comment">// å‘æ³¨å†Œä¸­å¿ƒè®¢é˜…æœåŠ¡æ¶ˆè´¹è€…</span></span><br /><span class="line"><span class="number">21</span>:     ProviderConsumerRegTable.registerProvider(originInvoker, registryUrl, registedProviderUrl);</span><br /><span class="line"><span class="number">22</span>: </span><br /><span class="line"><span class="number">23</span>:     <span class="comment">// å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡æä¾›è€…ï¼ˆè‡ªå·±ï¼‰</span></span><br /><span class="line"><span class="number">24</span>:     <span class="keyword">if</span> (register) {</span><br /><span class="line"><span class="number">25</span>:         register(registryUrl, registedProviderUrl);</span><br /><span class="line"><span class="number">26</span>:         ProviderConsumerRegTable.getProviderWrapper(originInvoker).setReg(<span class="keyword">true</span>); <span class="comment">// // æ ‡è®°å‘æœ¬åœ°æ³¨å†Œè¡¨çš„æ³¨å†ŒæœåŠ¡æä¾›è€…ï¼Œå·²ç»æ³¨å†Œ</span></span><br /><span class="line"><span class="number">27</span>:     }</span><br /><span class="line"><span class="number">28</span>: </span><br /><span class="line"><span class="number">29</span>:     <span class="comment">// ä½¿ç”¨ OverrideListener å¯¹è±¡ï¼Œè®¢é˜…é…ç½®è§„åˆ™</span></span><br /><span class="line"><span class="number">30</span>:     <span class="comment">// Subscribe the override data</span></span><br /><span class="line"><span class="number">31</span>:     <span class="comment">// FIXME When the provider subscribes, it will affect the scene : a certain JVM exposes the service and call the same service. Because the subscribed is cached key with the name of the service, it causes the subscription information to cover.</span></span><br /><span class="line"><span class="number">32</span>:     <span class="comment">// åˆ›å»ºè®¢é˜…é…ç½®è§„åˆ™çš„ URL</span></span><br /><span class="line"><span class="number">33</span>:     <span class="keyword">final</span> URL overrideSubscribeUrl = getSubscribedOverrideUrl(registedProviderUrl);</span><br /><span class="line"><span class="number">34</span>:     <span class="comment">// åˆ›å»º OverrideListener å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ° `overrideListeners` ä¸­</span></span><br /><span class="line"><span class="number">35</span>:     <span class="keyword">final</span> OverrideListener overrideSubscribeListener = <span class="keyword">new</span> OverrideListener(overrideSubscribeUrl, originInvoker);</span><br /><span class="line"><span class="number">36</span>:     overrideListeners.put(overrideSubscribeUrl, overrideSubscribeListener);</span><br /><span class="line"><span class="number">37</span>:     <span class="comment">// å‘æ³¨å†Œä¸­å¿ƒï¼Œå‘èµ·è®¢é˜…</span></span><br /><span class="line"><span class="number">38</span>:     registry.subscribe(overrideSubscribeUrl, overrideSubscribeListener);</span><br /><span class="line"><span class="number">39</span>:     <span class="comment">//Ensure that a new exporter instance is returned every time export</span></span><br /><span class="line"><span class="number">40</span>:     <span class="keyword">return</span> <span class="keyword">new</span> DestroyableExporter&lt;T&gt;(exporter, originInvoker, overrideSubscribeUrl, registedProviderUrl);</span><br /><span class="line"><span class="number">41</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ç¬¬ 29 è‡³ 38 è¡Œï¼šä½¿ç”¨&nbsp;<strong>OverrideListener</strong>&nbsp;å¯¹è±¡ï¼Œè®¢é˜…é…ç½®è§„åˆ™ã€‚</p>
<ul>
<li>
<p>ç¬¬ 33 è¡Œï¼šè°ƒç”¨&nbsp;<code>#getSubscribedOverrideUrl(registedProviderUrl)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º<strong>è®¢é˜…é…ç½®è§„åˆ™</strong>çš„ URL ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> URL <span class="title">getSubscribedOverrideUrl</span><span class="params">(URL registedProviderUrl)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> registedProviderUrl.setProtocol(Constants.PROVIDER_PROTOCOL)</span><br /><span class="line">            .addParameters(Constants.CATEGORY_KEY, Constants.CONFIGURATORS_CATEGORY, <span class="comment">// configurators</span></span><br /><span class="line">                    Constants.CHECK_KEY, String.valueOf(<span class="keyword">false</span>)); <span class="comment">// è®¢é˜…å¤±è´¥ï¼Œä¸æ ¡éªŒ</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>x</li>
</ul>
</li>
<li>ç¬¬ 34 è‡³ 36 è¡Œï¼šåˆ›å»º&nbsp;<strong>OverrideListener</strong>&nbsp;å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°&nbsp;<code>overrideListeners</code>&nbsp;ä¸­ã€‚</li>
<li>ç¬¬ 38 è¡Œï¼šè°ƒç”¨&nbsp;<code>Registry#subscribe(overrideSubscribeUrl, overrideSubscribeListener)</code>&nbsp;æ–¹æ³•ï¼Œå‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œ&nbsp;<strong>OverrideListener</strong>&nbsp;ç›‘å¬å™¨ï¼Œè®¢é˜…é…ç½®è§„åˆ™çš„å˜åŒ–ã€‚</li>
</ul>
</li>
</ul>
<h3 id="4-2-2-OverrideListener">4.2.2 OverrideListener</h3>
<p>OverrideListener æ˜¯ RegistryProtocol&nbsp;<strong>å†…éƒ¨ç±»</strong>ï¼Œå®ç° NotifyListener æ¥å£ï¼Œå®˜æ–¹æ³¨é‡Šå¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é‡æ–° export ï¼šprotocol ä¸­çš„ exporter destroy é—®é¢˜</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * 1. è¦æ±‚ registry protocol è¿”å›çš„ exporter å¯ä»¥æ­£å¸¸ destroy</span></span><br /><span class="line"><span class="comment"> * 2. notify åä¸éœ€è¦é‡æ–°å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œ</span></span><br /><span class="line"><span class="comment"> * 3. export æ–¹æ³•ä¼ å…¥çš„ invoker æœ€å¥½èƒ½ä¸€ç›´ä½œä¸º exporter çš„ invoker.</span></span><br /><span class="line"><span class="comment"> */</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>åˆçœ‹æœ‰ç‚¹ç»•ï¼Œæˆ‘ä»¬æ¥ç…ç…ä»£ç ã€‚</li>
</ul>
<h4 id="4-2-2-1-æ„é€ æ–¹æ³•">4.2.2.1 æ„é€ æ–¹æ³•</h4>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è®¢é˜… URL å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> URL subscribeUrl;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * åŸå§‹ Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Invoker originInvoker;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">OverrideListener</span><span class="params">(URL subscribeUrl, Invoker originalInvoker)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.subscribeUrl = subscribeUrl;</span><br /><span class="line">    <span class="keyword">this</span>.originInvoker = originalInvoker;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h4 id="4-2-2-2-notify">4.2.2.2 notify</h4>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(List&lt;URL&gt; urls)</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// è·å¾—åŒ¹é…çš„è§„åˆ™é…ç½® URL é›†åˆ</span></span><br /><span class="line"> <span class="number">4</span>:     logger.debug(<span class="string">"original override urls: "</span> + urls);</span><br /><span class="line"> <span class="number">5</span>:     List&lt;URL&gt; matchedUrls = getMatchedUrls(urls, subscribeUrl);</span><br /><span class="line"> <span class="number">6</span>:     logger.debug(<span class="string">"subscribe url: "</span> + subscribeUrl + <span class="string">", override urls: "</span> + matchedUrls);</span><br /><span class="line"> <span class="number">7</span>:     <span class="comment">// No matching results</span></span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (matchedUrls.isEmpty()) {</span><br /><span class="line"> <span class="number">9</span>:         <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">10</span>:     }</span><br /><span class="line"><span class="number">11</span>:     <span class="comment">// å°†é…ç½®è§„åˆ™ URL é›†åˆï¼Œ**è½¬æ¢**æˆå¯¹åº”çš„ Configurator é›†åˆ</span></span><br /><span class="line"><span class="number">12</span>:     List&lt;Configurator&gt; configurators = RegistryDirectory.toConfigurators(matchedUrls);</span><br /><span class="line"><span class="number">13</span>: </span><br /><span class="line"><span class="number">14</span>:     <span class="comment">// è·å¾—çœŸå®çš„ Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="number">15</span>:     <span class="keyword">final</span> Invoker&lt;?&gt; invoker;</span><br /><span class="line"><span class="number">16</span>:     <span class="keyword">if</span> (originInvoker <span class="keyword">instanceof</span> InvokerDelegete) {</span><br /><span class="line"><span class="number">17</span>:         invoker = ((InvokerDelegete&lt;?&gt;) originInvoker).getInvoker();</span><br /><span class="line"><span class="number">18</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">19</span>:         invoker = originInvoker;</span><br /><span class="line"><span class="number">20</span>:     }</span><br /><span class="line"><span class="number">21</span>:     <span class="comment">// The origin invoker</span></span><br /><span class="line"><span class="number">22</span>:     <span class="comment">// è·å¾—çœŸå®çš„ Invoker çš„ URL å¯¹è±¡</span></span><br /><span class="line"><span class="number">23</span>:     URL originUrl = RegistryProtocol.<span class="keyword">this</span>.getProviderUrl(invoker);</span><br /><span class="line"><span class="number">24</span>: </span><br /><span class="line"><span class="number">25</span>:     <span class="comment">// å¿½ç•¥ï¼Œè‹¥å¯¹åº”çš„ Exporter å¯¹è±¡ä¸å­˜åœ¨</span></span><br /><span class="line"><span class="number">26</span>:     String key = getCacheKey(originInvoker);</span><br /><span class="line"><span class="number">27</span>:     ExporterChangeableWrapper&lt;?&gt; exporter = bounds.get(key);</span><br /><span class="line"><span class="number">28</span>:     <span class="keyword">if</span> (exporter == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">29</span>:         logger.warn(<span class="keyword">new</span> IllegalStateException(<span class="string">"error state, exporter should not be null"</span>));</span><br /><span class="line"><span class="number">30</span>:         <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">31</span>:     }</span><br /><span class="line"><span class="number">32</span>: </span><br /><span class="line"><span class="number">33</span>:     <span class="comment">// The current, may have been merged many times</span></span><br /><span class="line"><span class="number">34</span>:     <span class="comment">// è·å¾— Invoker å½“å‰çš„ URL å¯¹è±¡ï¼Œå¯èƒ½å·²ç»è¢«ä¹‹å‰çš„é…ç½®è§„åˆ™åˆå¹¶è¿‡</span></span><br /><span class="line"><span class="number">35</span>:     URL currentUrl = exporter.getInvoker().getUrl();</span><br /><span class="line"><span class="number">36</span>:     <span class="comment">// Merged with this configuration</span></span><br /><span class="line"><span class="number">37</span>:     <span class="comment">// åŸºäº originUrl å¯¹è±¡ï¼Œåˆå¹¶é…ç½®è§„åˆ™ï¼Œç”Ÿæˆæ–°çš„ newUrl å¯¹è±¡</span></span><br /><span class="line"><span class="number">38</span>:     URL newUrl = getConfigedInvokerUrl(configurators, originUrl);</span><br /><span class="line"><span class="number">39</span>:     <span class="comment">// åˆ¤æ–­æ–°è€ Url ä¸åŒ¹é…ï¼Œé‡æ–°æš´éœ² Invoker</span></span><br /><span class="line"><span class="number">40</span>:     <span class="keyword">if</span> (!currentUrl.equals(newUrl)) {</span><br /><span class="line"><span class="number">41</span>:         RegistryProtocol.<span class="keyword">this</span>.doChangeLocalExport(originInvoker, newUrl);</span><br /><span class="line"><span class="number">42</span>:         logger.info(<span class="string">"exported provider url changed, origin url: "</span> + originUrl + <span class="string">", old export url: "</span> + currentUrl + <span class="string">", new export url: "</span> + newUrl);</span><br /><span class="line"><span class="number">43</span>:     }</span><br /><span class="line"><span class="number">44</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ç¬¬ 3 è‡³ 10 è¡Œï¼šè°ƒç”¨&nbsp;<code>#getMatchedUrls(List&lt;URL&gt; configuratorUrls, URL currentSubscribe)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—åŒ¹é…çš„<strong>è§„åˆ™é…ç½®</strong>&nbsp;URL é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;URL&gt; <span class="title">getMatchedUrls</span><span class="params">(List&lt;URL&gt; configuratorUrls, URL currentSubscribe)</span> </span>{</span><br /><span class="line">    List&lt;URL&gt; result = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br /><span class="line">    <span class="keyword">for</span> (URL url : configuratorUrls) {</span><br /><span class="line">        URL overrideUrl = url;</span><br /><span class="line">        <span class="comment">// ã€å¿½ç•¥ã€‘ï¼Œå…¼å®¹è€ç‰ˆæœ¬</span></span><br /><span class="line">        <span class="comment">// Compatible with the old version</span></span><br /><span class="line">        <span class="keyword">if</span> (url.getParameter(Constants.CATEGORY_KEY) == <span class="keyword">null</span></span><br /><span class="line">                &amp;&amp; Constants.OVERRIDE_PROTOCOL.equals(url.getProtocol())) {</span><br /><span class="line">            overrideUrl = url.addParameter(Constants.CATEGORY_KEY, Constants.CONFIGURATORS_CATEGORY);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦åŒ¹é…</span></span><br /><span class="line">        <span class="comment">// Check whether url is to be applied to the current service</span></span><br /><span class="line">        <span class="keyword">if</span> (UrlUtils.isMatch(currentSubscribe, overrideUrl)) {</span><br /><span class="line">            result.add(url);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> result;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>é€šè¿‡è°ƒç”¨&nbsp;<code>UrlUtils#isMatch(currentSubscribe, overrideUrl)</code>&nbsp;æ–¹æ³•ï¼Œè¿›è¡Œåˆ¤æ–­<strong>æ˜¯å¦åŒ¹é…</strong>ã€‚è¯¥æ–¹æ³•å…·ä½“å®ç°çš„é€»è¾‘ï¼Œæ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥åˆ¤æ–­è‡ªå·±æŸ¥çœ‹ã€‚</li>
</ul>
</li>
<li>ç¬¬ 12 è¡Œï¼šè°ƒç”¨&nbsp;<code>RegistryDirectory#toConfigurators(matchedUrls)</code>&nbsp;æ–¹æ³•ï¼Œå°†é…ç½®è§„åˆ™ URL é›†åˆï¼Œ<strong>è½¬æ¢</strong>æˆå¯¹åº”çš„ Configurator é›†åˆã€‚</li>
<li>ç¬¬ 14 è‡³ 23 è¡Œï¼šè·å¾—<strong>çœŸå®</strong>çš„ Invoker å’Œ<strong>å¯¹åº”</strong>çš„ URL å¯¹åº”ã€‚</li>
<li>ç¬¬ 25 è‡³ 31 è¡Œï¼š<strong>å¿½ç•¥</strong>ï¼Œè‹¥å¯¹åº”çš„ Exporter å¯¹è±¡ä¸å­˜åœ¨ã€‚</li>
<li>==========&nbsp;<strong>é‡ç‚¹</strong>&nbsp;==========</li>
<li>ç¬¬ 35 è¡Œï¼šé€šè¿‡&nbsp;<code>exporter</code>&nbsp;çš„ Invoker ï¼Œè·å¾— Invoker&nbsp;<strong>å½“å‰</strong>çš„ URL å¯¹è±¡ï¼Œ<strong>å¯èƒ½å·²ç»è¢«ä¹‹å‰çš„é…ç½®è§„åˆ™åˆå¹¶è¿‡</strong>ã€‚</li>
<li>
<p>ç¬¬ 38 è¡Œï¼šè°ƒç”¨&nbsp;<code>#getConfigedInvokerUrl(configurators,originUrl)</code>&nbsp;æ–¹æ³•ï¼ŒåŸºäº&nbsp;<code>originUrl</code>&nbsp;å¯¹è±¡ï¼Œ<strong>åˆå¹¶é…ç½®è§„åˆ™</strong>ï¼Œç”Ÿæˆ<strong>æ–°çš„</strong>&nbsp;<code>newUrl</code>&nbsp;å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> URL <span class="title">getConfigedInvokerUrl</span><span class="params">(List&lt;Configurator&gt; configurators, URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">for</span> (Configurator configurator : configurators) {</span><br /><span class="line">        <span class="comment">// åˆå¹¶é…ç½®è§„åˆ™</span></span><br /><span class="line">        url = configurator.configure(url);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> url;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 39 è‡³ 43 è¡Œï¼šåˆ¤æ–­æ–°è€ URL è‹¥<strong>ä¸åŒ¹é…</strong>ï¼Œè°ƒç”¨&nbsp;<code>RegistryProtocol#doChangeLocalExport(originInvoker, newUrl)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>é‡æ–°æš´éœ²</strong>&nbsp;Invoker å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-6-impl-configurator/">ã€Œ4.2.3 doChangeLocalExportã€</a>&nbsp;ã€‚</p>
</li>
</ul>
<h3 id="4-2-3-doChangeLocalExport">4.2.3 doChangeLocalExport</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">doChangeLocalExport</span><span class="params">(<span class="keyword">final</span> Invoker&lt;T&gt; originInvoker, URL newInvokerUrl)</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// æ ¡éªŒå¯¹åº”çš„ Exporter æ˜¯å¦å­˜åœ¨ã€‚è‹¥ä¸å­˜åœ¨ï¼Œæ‰“å°å‘Šè­¦æ—¥å¿—ã€‚</span></span><br /><span class="line"> <span class="number">3</span>:     String key = getCacheKey(originInvoker);</span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">final</span> ExporterChangeableWrapper&lt;T&gt; exporter = (ExporterChangeableWrapper&lt;T&gt;) bounds.get(key);</span><br /><span class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (exporter == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">6</span>:         logger.warn(<span class="keyword">new</span> IllegalStateException(<span class="string">"error state, exporter should not be null"</span>));</span><br /><span class="line"> <span class="number">7</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">8</span>:         <span class="comment">// åˆ›å»º InvokerDelegete å¯¹è±¡</span></span><br /><span class="line"> <span class="number">9</span>:         <span class="keyword">final</span> Invoker&lt;T&gt; invokerDelegete = <span class="keyword">new</span> InvokerDelegete&lt;T&gt;(originInvoker, newInvokerUrl);</span><br /><span class="line"><span class="number">10</span>:         <span class="comment">// é‡æ–°æš´éœ² Invoker</span></span><br /><span class="line"><span class="number">11</span>:         <span class="comment">// è®¾ç½®åˆ° ExporterChangeableWrapper ä¸­</span></span><br /><span class="line"><span class="number">12</span>:         exporter.setExporter(protocol.export(invokerDelegete));</span><br /><span class="line"><span class="number">13</span>:     }</span><br /><span class="line"><span class="number">14</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 2 è‡³ 6 è¡Œï¼š<strong>æ ¡éªŒ</strong>å¯¹åº”çš„ ExporterChangeableWrapper æ˜¯å¦å­˜åœ¨ã€‚è‹¥ä¸å­˜åœ¨ï¼Œæ‰“å°<strong>å‘Šè­¦</strong>æ—¥å¿—ã€‚</li>
<li>ç¬¬ 9 è¡Œï¼šåˆ›å»º InvokerDelegete å¯¹è±¡ã€‚</li>
<li>ç¬¬ 12 è¡Œï¼šè°ƒç”¨&nbsp;<code>Protocol$Adaptive#export(Invoker)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>é‡æ–°æš´éœ²</strong>&nbsp;Invoker å¯¹è±¡ã€‚<br />ğŸ˜ˆ å¯èƒ½ä¼šæœ‰æœºæ™ºçš„èƒ–å‹ä¼šé—®ï¼ŒåŸæ¥çš„ Exporter ä¸è¿›è¡Œ<strong>é”€æ¯</strong>ä¹ˆ?å®é™…ä¸Š<strong>ä¸éœ€è¦</strong>ï¼ŒåŸå› æœ‰ä¸¤ç‚¹ï¼š
<ul>
<li>1ã€æ¯ä¸ªåè®®åˆå§‹åŒ–çš„ Server æœ‰<strong>ç¼“å­˜</strong>&nbsp;ï¼Œæ‰€ä»¥é‡æ–°åˆå§‹åŒ–ï¼Œå¯ä»¥é‡ç”¨<strong>ç¼“å­˜</strong>ä¸­çš„ Server ã€‚</li>
<li>2ã€å¦‚æœ<strong>é”€æ¯</strong>åŸæœ‰ Exporter ï¼Œä¼šå¯¼è‡´<strong>ç¼“å­˜</strong>çš„ Server ä¹Ÿä¸€èµ·é”€æ¯ã€‚<strong>è€Œä¸”ï¼Œå³ä½¿ä¸é”€æ¯ï¼ŒåŸæœ‰ Exporter ä¹Ÿå°±æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥è¢«å›æ”¶æ‰</strong>ã€‚</li>
</ul>
</li>
<li>ç¬¬ 12 è¡Œï¼šè°ƒç”¨&nbsp;<code>ExporterChangeableWrapper#setExporter(exporter)</code>&nbsp;æ–¹æ³•ï¼Œè®¾ç½®<strong>æ–°çš„</strong>&nbsp;Exporter å¯¹è±¡ã€‚</li>
</ul>
<h2 id="4-3-ServiceConfig">4.3 ServiceConfig</h2>
<p>TODO 8038 ServiceConfig ä¸ºå•¥åˆ¤æ–­äº† url.protocol</p>
</div>