<header class="article-header">
<h1 class="article-title">é›†ç¾¤å®¹é”™ï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ API</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>ä»æœ¬æ–‡å¼€å§‹ï¼Œæˆ‘ä»¬æ¥åˆ†äº« Dubbo çš„<strong>é›†ç¾¤å®¹é”™</strong>åŠŸèƒ½çš„å®ç°ã€‚</p>
<p>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/intro/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; é¡¹ç›®ç»“æ„ä¸€è§ˆã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-1-api-interface/">ã€Œ3.4 dubbo-clusterã€</a>&nbsp;ä¸­ï¼Œæˆ‘ä»¬å¯¹ Dubbo çš„&nbsp;<code>dubbo-cluster</code>&nbsp;é¡¹ç›®ï¼Œåšäº†æ•´ä½“çš„ä»£ç ç»“æ„åšäº†ä»‹ç»ã€‚å¦‚æœå·²ç»æ²¡ä»€ä¹ˆå°è±¡çš„èƒ–å‹ï¼Œè¯·å…ˆå›è¿‡å¤´æ‰¾å›å¤±æ•£çš„è®°å¿†ã€‚</p>
<p>Dubbo å¯¹é›†ç¾¤å®¹é”™åŠŸèƒ½ï¼Œå®ç°äº†å¾ˆå¥½çš„&nbsp;<code>package</code>&nbsp;æ‹†åˆ†ï¼Œå› æ­¤æˆ‘ä»¬æŒ‰ç…§å¦‚ä¸‹é¡ºåºï¼š</p>
<ol>
<li>æŠ½è±¡ API</li>
</ol>
<ul>
<li>Cluster å®ç°</li>
<li>Directory å®ç°</li>
<li>LoadBalance å®ç°</li>
<li>Merger å®ç°</li>
<li>Router å®ç°</li>
<li>Configurator å®ç°</li>
</ul>
<p><strong>ä¸€ä¸ªä¸»é¢˜ï¼Œå¯¹åº”ä¸€ç¯‡æ–‡ç« </strong>ã€‚é‚£ä¹ˆï¼Œæœ¬æ–‡å½“ç„¶æ˜¯åˆ†äº«<strong>æŠ½è±¡ API</strong>ã€‚è€ƒè™‘åˆ°å¹²å·´å·´çš„çœ‹æŠ½è±¡ API ä¼šå¾ˆå®¹æ˜“ä¸€è„¸æ‡µé€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šä½¿ç”¨&nbsp;<strong>FailoverCluster</strong>&nbsp;è´¯ç©¿æœ¬æ–‡ã€‚</p>
<h1 id="2-æ•´ä½“æµç¨‹">2. æ•´ä½“æµç¨‹</h1>
<blockquote>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_01_04/09.png" alt="é›†ç¾¤å®¹é”™" /></p>
</blockquote>
<ul>
<li>ğŸ™‚ åªçœ‹çº¢çº¿ã€‚</li>
<li><strong>å·¦è¾¹ invoke</strong>&nbsp;ï¼šé€šè¿‡ Cluster æš´éœ²&nbsp;<strong>Invoker</strong>&nbsp;å¯¹è±¡ï¼Œä»è€Œå®ç°<strong>ç»Ÿä¸€</strong>ã€<strong>é€æ˜</strong>çš„è°ƒç”¨è¿‡ç¨‹ã€‚
<ul>
<li>æ— æ³•ç†è§£ï¼Ÿè¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-1-api-interface/">ã€Œ3. Clusterã€</a>&nbsp;ã€‚</li>
</ul>
</li>
<li><strong>å³è¾¹ list</strong>&nbsp;ï¼šé€šè¿‡ Directory ä¸­ï¼Œ<strong>è·å–</strong>å¯è°ƒç”¨çš„ Invoker é›†åˆã€‚</li>
<li><strong>å³è¾¹ route</strong>&nbsp;ï¼šé€šè¿‡ Router ï¼Œ<strong>è¿‡æ»¤</strong>ç¬¦åˆ<strong>è·¯ç”±è§„åˆ™</strong>çš„ Invoker é›†åˆã€‚</li>
<li><strong>å³è¾¹ select</strong>&nbsp;ï¼šé€šè¿‡ LoadBalance ï¼Œæ ¹æ®<strong>è´Ÿè½½å‡è¡¡æœºåˆ¶</strong>ï¼Œ<strong>é€‰æ‹©</strong>ä¸€ä¸ªç¬¦åˆçš„ Invoker å¯¹è±¡ã€‚</li>
<li><strong>å³è¾¹ invoke</strong>&nbsp;ï¼šè°ƒç”¨è¯¥ Invoker å¯¹è±¡ã€‚</li>
</ul>
<h1 id="3-Cluster">3. Cluster</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.Cluster</code>&nbsp;ï¼Œé›†ç¾¤æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@SPI</span>(FailoverCluster.NAME)</span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Cluster</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Merge the directory invokers to a virtual invoker.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * åŸºäº Directory ï¼Œåˆ›å»º Invoker å¯¹è±¡ï¼Œå®ç°ç»Ÿä¸€ã€é€æ˜çš„ Invoker è°ƒç”¨è¿‡ç¨‹</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> directory Directory å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt;  æ³›å‹</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> cluster invoker</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RpcException</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="meta">@Adaptive</span></span><br /><span class="line">    &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">join</span><span class="params">(Directory&lt;T&gt; directory)</span> <span class="keyword">throws</span> RpcException</span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>@SPI(FailoverCluster.NAME)</code>&nbsp;æ³¨è§£ï¼ŒDubbo SPI&nbsp;<strong>æ‹“å±•ç‚¹</strong>ï¼Œé»˜è®¤ä¸º&nbsp;<code>"failover"</code>&nbsp;ï¼Œå³<strong>å¤±è´¥é‡è¯•</strong>ï¼Œä¹Ÿå°±æ˜¯ä¼šè´¯ç©¿æœ¬æ–‡çš„ FailoverCluster ç±»ã€‚</li>
<li><code>@Adaptive</code>&nbsp;æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Cluster å®ç°ï¼Œä½¿ç”¨&nbsp;<code>URL.cluster</code>&nbsp;å±æ€§ã€‚</li>
<li><code>#join(Directory&lt;T&gt;)</code>&nbsp;æ¥å£æ–¹æ³•ï¼ŒåŸºäº Directory ï¼Œåˆ›å»º Invoker å¯¹è±¡ï¼Œå®ç°ç»Ÿä¸€ã€é€æ˜çš„ Invoker è°ƒç”¨è¿‡ç¨‹ã€‚</li>
</ul>
<h2 id="3-1-join-æ–¹æ³•">3.1 join æ–¹æ³•</h2>
<p>åœ¨ RegistryProtocol çš„&nbsp;<code>#doRefer(Cluster, Registry, type, url)</code>&nbsp;æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨&nbsp;<code>Cluster#join(directory)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º Invoker å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> Cluster cluster; <span class="comment">// &lt;1&gt;</span></span><br /><br /><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">doRefer</span><span class="params">(Cluster cluster, Registry registry, Class&lt;T&gt; type, URL url)</span> </span>{</span><br /><span class="line">    <span class="comment">// åˆ›å»º RegistryDirectory å¯¹è±¡ï¼Œå¹¶è®¾ç½®æ³¨å†Œä¸­å¿ƒ &lt;2&gt;</span></span><br /><span class="line">    RegistryDirectory&lt;T&gt; directory = <span class="keyword">new</span> RegistryDirectory&lt;T&gt;(type, url);</span><br /><span class="line">    directory.setRegistry(registry);</span><br /><span class="line">    directory.setProtocol(protocol);</span><br />    <br /><span class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></span><br /><br /><span class="line">    <span class="comment">// åˆ›å»º Invoker å¯¹è±¡ &lt;3&gt;</span></span><br /><span class="line">    Invoker invoker = cluster.join(directory);</span><br /><span class="line">    <span class="comment">// å‘æœ¬åœ°æ³¨å†Œè¡¨ï¼Œæ³¨å†Œæ¶ˆè´¹è€…</span></span><br /><span class="line">    ProviderConsumerRegTable.registerConsumer(invoker, url, subscribeUrl, directory);</span><br /><span class="line">    <span class="keyword">return</span> invoker;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;ï¼š<code>cluster</code>&nbsp;å±æ€§ï¼Œ<code>Cluster$Adaptive</code>&nbsp;å¯¹è±¡</li>
<li><code>&lt;2&gt;</code>&nbsp;ï¼šåˆ›å»º RegistryDirectory å¯¹è±¡ã€‚é€šè¿‡å®ƒï¼Œå¯ä»¥æ³¨å†Œåˆ°<strong>ä¸€ä¸ª</strong>æ³¨å†Œä¸­å¿ƒçš„æ‰€æœ‰æœåŠ¡<strong>æä¾›è€…</strong>ï¼Œå³ä¸Šæ–‡æåˆ°çš„ã€å³è¾¹ listã€‘ã€‚</li>
<li><code>&lt;3&gt;</code>&nbsp;ï¼šè°ƒç”¨&nbsp;<code>Cluster#join(directory)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º Invoker å¯¹è±¡ã€‚å› ä¸º&nbsp;<code>cluster</code>&nbsp;æ˜¯ Dubbo SPI Adaptive ç±»ï¼Œæ‰€ä»¥å¯ä»¥è‡ªåŠ¨è·å–åˆ°<strong>å¯¹åº”çš„</strong>&nbsp;Cluster å®ç°ç±»ã€‚</li>
</ul>
<h2 id="3-2-å­ç±»">3.2 å­ç±»</h2>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_04_01/01.png" alt="Cluster å­ç±»" /></p>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ¯ä¸ª Cluster å®ç°ç±»ï¼Œå¯¹åº”ä¸€ä¸ª<strong>ä¸“å±</strong>äºå…¶çš„ Invoker å®ç°ç±»ã€‚æœ¬æ–‡åˆ†äº«çš„ FailoverCluster çš„å¯¹åº”çš„ Invoker ä¸º FailoverClusterInvoker ã€‚åœ¨çœ‹å…·ä½“çš„ä»£ç ä¹‹å‰ï¼Œå…ˆä¸€èµ·æ¥çœ‹çœ‹<strong>é›†ç¾¤å®¹é”™çš„è°ƒç”¨( invoke )è¿‡ç¨‹</strong>ã€‚</p>
<h1 id="4-è°ƒç”¨é¡ºåºå›¾">4. è°ƒç”¨é¡ºåºå›¾</h1>
<p>å¦‚ä¸‹æ˜¯æœåŠ¡<strong>æ¶ˆè´¹è€…</strong>çš„è°ƒç”¨é¡ºåºå›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_04_01/02.png" alt="é¡ºåºå›¾" /></p>
<ul>
<li>åœ¨ InvokerInvocationHandler çš„ ã€4ã€‘<code>#invoke(invocation)</code>&nbsp;å¤„<strong>æ’å…¥</strong>ï¼š<strong>å…ˆ</strong>è°ƒç”¨<strong>é›†ç¾¤å®¹é”™ Invoker</strong>&nbsp;çš„&nbsp;<code>#invoke(invocation)</code>&nbsp;ï¼Œ<strong>å†</strong>è°ƒç”¨&nbsp;<code>ProtocolFilterWrapper$Invoker</code>&nbsp;çš„&nbsp;<code>#invoke(invocation)</code>&nbsp;ã€‚</li>
<li><strong>è°ƒç”¨æ ˆ</strong>å¦‚ä¸‹å›¾ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2019_04_01/03.png" alt="è°ƒç”¨æ ˆ" />
<ul>
<li>MockClusterInvoker ï¼Œèƒ–å‹å…ˆæ— è§†ï¼Œåç»­æœ‰è¯¦ç»†æ–‡ç« ï¼Œè¿›è¡Œåˆ†äº«ã€‚</li>
</ul>
</li>
</ul>
<h1 id="5-FailoverCluster">5. FailoverCluster</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.support.FailoverCluster</code>&nbsp;ï¼Œå®ç° Cluster æ¥å£ï¼Œå¤±è´¥è‡ªåŠ¨åˆ‡æ¢ï¼Œå½“å‡ºç°å¤±è´¥ï¼Œé‡è¯•å…¶å®ƒæœåŠ¡å™¨ã€‚é€šå¸¸ç”¨äº<strong>è¯»æ“ä½œ</strong>ï¼Œä½†é‡è¯•ä¼šå¸¦æ¥æ›´é•¿å»¶è¿Ÿã€‚å¯é€šè¿‡&nbsp;<code>retries="2"</code>&nbsp;æ¥è®¾ç½®é‡è¯•æ¬¡æ•°(ä¸å«ç¬¬ä¸€æ¬¡)ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FailoverCluster</span> <span class="keyword">implements</span> <span class="title">Cluster</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String NAME = <span class="string">"failover"</span>;</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">join</span><span class="params">(Directory&lt;T&gt; directory)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> FailoverClusterInvoker&lt;T&gt;(directory);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¯¹åº” Invoker ä¸º FailoverClusterInvoker ã€‚</li>
</ul>
<h1 id="6-AbstractClusterInvoker">6. AbstractClusterInvoker</h1>
<p>å› ä¸ºï¼ŒFailoverClusterInvoker ç»§æ‰¿ AbstractClusterInvoker ï¼Œæ‰€ä»¥æˆ‘ä»¬æ¥åˆ†äº«å®ƒã€‚</p>
<p><code>com.alibaba.dubbo.rpc.cluster.support.AbstractClusterInvoker</code>&nbsp;ï¼Œå®ç° Invoker æ¥å£ï¼ŒCluster Invoker æŠ½è±¡ç±»ï¼š</p>
<ul>
<li><strong>å®ç°</strong>ä¾‹å¦‚é€‰æ‹©ä¸€ä¸ªç¬¦åˆ Invoker å¯¹è±¡ç­‰ç­‰<strong>å…¬ç”¨</strong>æ–¹æ³•</li>
<li>
<p><strong>å®šä¹‰</strong>&nbsp;<code>#doInvoke(Invocation, List&lt;Invoker&lt;T&gt;&gt;, LoadBalance)</code>&nbsp;<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå®ç°å­ Cluster çš„ Invoker å®ç°ç±»çš„<strong>æœåŠ¡è°ƒç”¨</strong>çš„å·®å¼‚é€»è¾‘ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Result <span class="title">doInvoke</span><span class="params">(Invocation invocation, List&lt;Invoker&lt;T&gt;&gt; invokers, LoadBalance loadbalance)</span> <span class="keyword">throws</span> RpcException</span>;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<h2 id="6-1-æ„é€ æ–¹æ³•">6.1 æ„é€ æ–¹æ³•</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Directory å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Directory&lt;T&gt; directory;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é›†ç¾¤æ—¶æ˜¯å¦æ’é™¤éå¯ç”¨( available )çš„ Invoker ï¼Œé»˜è®¤ä¸º true</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> availablecheck;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦å·²ç»é”€æ¯</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> AtomicBoolean destroyed = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ç²˜æ»è¿æ¥ Invoker</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * http://dubbo.apache.org/zh-cn/docs/user/demos/stickiness.html</span></span><br /><span class="line"><span class="comment"> * ç²˜æ»è¿æ¥ç”¨äºæœ‰çŠ¶æ€æœåŠ¡ï¼Œå°½å¯èƒ½è®©å®¢æˆ·ç«¯æ€»æ˜¯å‘åŒä¸€æä¾›è€…å‘èµ·è°ƒç”¨ï¼Œé™¤éè¯¥æä¾›è€…æŒ‚äº†ï¼Œå†è¿å¦ä¸€å°ã€‚</span></span><br /><span class="line"><span class="comment"> * ç²˜æ»è¿æ¥å°†è‡ªåŠ¨å¼€å¯å»¶è¿Ÿè¿æ¥ï¼Œä»¥å‡å°‘é•¿è¿æ¥æ•°ã€‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Invoker&lt;T&gt; stickyInvoker = <span class="keyword">null</span>;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractClusterInvoker</span><span class="params">(Directory&lt;T&gt; directory)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>(directory, directory.getUrl());</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractClusterInvoker</span><span class="params">(Directory&lt;T&gt; directory, URL url)</span> </span>{</span><br /><span class="line">    <span class="comment">// åˆå§‹åŒ– directory</span></span><br /><span class="line">    <span class="keyword">if</span> (directory == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"service directory == null"</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">this</span>.directory = directory;</span><br /><span class="line">    <span class="comment">// sticky: invoker.isAvailable() should always be checked before using when availablecheck is true.</span></span><br /><span class="line">    <span class="comment">// åˆå§‹åŒ– availablecheck</span></span><br /><span class="line">    <span class="keyword">this</span>.availablecheck = url.getParameter(Constants.CLUSTER_AVAILABLE_CHECK_KEY, Constants.DEFAULT_CLUSTER_AVAILABLE_CHECK);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>directory</code>&nbsp;å­—æ®µï¼ŒDirectory å¯¹è±¡ã€‚é€šè¿‡å®ƒï¼Œå¯ä»¥è·å¾—æ‰€æœ‰æœåŠ¡æä¾›è€…çš„ Invoker å¯¹è±¡ã€‚</li>
<li><code>availablecheck</code>&nbsp;å­—æ®µï¼Œé›†ç¾¤æ—¶æ˜¯å¦æ’é™¤éå¯ç”¨( available )çš„ Invoker ï¼Œé»˜è®¤ä¸º&nbsp;<code>"true"</code>&nbsp;ï¼Œé€šè¿‡&nbsp;<code>"cluster.availablecheck"</code>&nbsp;é…ç½®é¡¹è®¾ç½®ã€‚</li>
<li><code>destroyed</code>&nbsp;å­—æ®µï¼Œæ˜¯å¦å·²ç»é”€æ¯ã€‚è‹¥å·²ç»é”€æ¯ï¼Œåˆ™ä¸å…è®¸åœ¨è°ƒç”¨ã€‚</li>
<li>
<p><code>stickyInvoker</code>&nbsp;å­—æ®µï¼Œç²˜æ»è¿æ¥ Invoker ï¼Œå‚è§&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/stickiness.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; ç²˜æ»è¿æ¥<br />ã€‹</a>&nbsp;æ–‡æ¡£ã€‚</p>
<blockquote>
<p>ç²˜æ»è¿æ¥ç”¨äºæœ‰çŠ¶æ€æœåŠ¡ï¼Œå°½å¯èƒ½è®©å®¢æˆ·ç«¯æ€»æ˜¯å‘åŒä¸€æä¾›è€…å‘èµ·è°ƒç”¨ï¼Œé™¤éè¯¥æä¾›è€…æŒ‚äº†ï¼Œå†è¿å¦ä¸€å°ã€‚</p>
</blockquote>
</li>
</ul>
<h2 id="6-2-list">6.2 list</h2>
<p><code>#list(Invocation)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æ‰€æœ‰æœåŠ¡æä¾›è€… Invoker é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">protected</span> List&lt;Invoker&lt;T&gt;&gt; list(Invocation invocation) <span class="keyword">throws</span> RpcException {</span><br /><span class="line">    <span class="keyword">return</span> directory.list(invocation);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="6-3-select">6.3 select</h2>
<p><code>#select(LoadBalance, Invocation, invokers, selected)</code>&nbsp;æ–¹æ³•ï¼Œä»<strong>å€™é€‰</strong>çš„ Invoker é›†åˆï¼Œé€‰æ‹©ä¸€ä¸ª<strong>æœ€ç»ˆè°ƒç”¨</strong>çš„ Invoker å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ä½¿ç”¨ loadbalance é€‰æ‹© invoker.</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> loadbalance Loadbalance å¯¹è±¡ï¼Œæä¾›è´Ÿè´£å‡è¡¡ç­–ç•¥</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> invocation Invocation å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> invokers   å€™é€‰çš„ Invoker é›†åˆ</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> selected    å·²é€‰è¿‡çš„ Invoker é›†åˆ. æ³¨æ„ï¼šè¾“å…¥ä¿è¯ä¸é‡å¤</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> æœ€ç»ˆçš„ Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@throws</span> RpcException å½“å‘ç”Ÿ RpcException æ—¶</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">protected</span> Invoker&lt;T&gt; <span class="title">select</span><span class="params">(LoadBalance loadbalance, Invocation invocation, List&lt;Invoker&lt;T&gt;&gt; invokers, List&lt;Invoker&lt;T&gt;&gt; selected)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">  <span class="number">2</span>:     <span class="keyword">if</span> (invokers == <span class="keyword">null</span> || invokers.isEmpty()) {</span><br /><span class="line">  <span class="number">3</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">  <span class="number">4</span>:     }</span><br /><span class="line">  <span class="number">5</span>:     <span class="comment">// è·å¾— sticky é…ç½®é¡¹ï¼Œæ–¹æ³•çº§</span></span><br /><span class="line">  <span class="number">6</span>:     String methodName = invocation == <span class="keyword">null</span> ? <span class="string">""</span> : invocation.getMethodName();</span><br /><span class="line">  <span class="number">7</span>:     <span class="keyword">boolean</span> sticky = invokers.get(<span class="number">0</span>).getUrl().getMethodParameter(methodName, Constants.CLUSTER_STICKY_KEY, Constants.DEFAULT_CLUSTER_STICKY);</span><br /><span class="line">  <span class="number">8</span>:     {</span><br /><span class="line">  <span class="number">9</span>:         <span class="comment">// ignore overloaded method</span></span><br /><span class="line"> <span class="number">10</span>:         <span class="comment">// è‹¥ stickyInvoker ä¸å­˜åœ¨äº invokers ä¸­ï¼Œè¯´æ˜ä¸åœ¨å€™é€‰ä¸­ï¼Œéœ€è¦ç½®ç©ºï¼Œé‡æ–°é€‰æ‹©</span></span><br /><span class="line"> <span class="number">11</span>:         <span class="keyword">if</span> (stickyInvoker != <span class="keyword">null</span> &amp;&amp; !invokers.contains(stickyInvoker)) {</span><br /><span class="line"> <span class="number">12</span>:             stickyInvoker = <span class="keyword">null</span>;</span><br /><span class="line"> <span class="number">13</span>:         }</span><br /><span class="line"> <span class="number">14</span>:         <span class="comment">// ignore cucurrent problem</span></span><br /><span class="line"> <span class="number">15</span>:         <span class="comment">// è‹¥å¼€å¯ç²˜æ»è¿æ¥çš„ç‰¹æ€§ï¼Œä¸” stickyInvoker ä¸å­˜åœ¨äº selected ä¸­ï¼Œåˆ™è¿”å› stickyInvoker è¿™ä¸ª Invoker å¯¹è±¡</span></span><br /><span class="line"> <span class="number">16</span>:         <span class="keyword">if</span> (sticky &amp;&amp; stickyInvoker != <span class="keyword">null</span> &amp;&amp; (selected == <span class="keyword">null</span> || !selected.contains(stickyInvoker))) {</span><br /><span class="line"> <span class="number">17</span>:             <span class="comment">// è‹¥å¼€å¯æ’é™¤éå¯ç”¨çš„ Invoker çš„ç‰¹æ€§ï¼Œåˆ™æ ¡éªŒ stickyInvoker æ˜¯å¦å¯ç”¨ã€‚è‹¥å¯ç”¨ï¼Œåˆ™è¿›è¡Œè¿”å›</span></span><br /><span class="line"> <span class="number">18</span>:             <span class="keyword">if</span> (availablecheck &amp;&amp; stickyInvoker.isAvailable()) {</span><br /><span class="line"> <span class="number">19</span>:                 <span class="keyword">return</span> stickyInvoker;</span><br /><span class="line"> <span class="number">20</span>:             }</span><br /><span class="line"> <span class="number">21</span>:         }</span><br /><span class="line"> <span class="number">22</span>:     }</span><br /><span class="line"> <span class="number">23</span>: </span><br /><span class="line"> <span class="number">24</span>:     <span class="comment">// æ‰§è¡Œé€‰æ‹©</span></span><br /><span class="line"> <span class="number">25</span>:     Invoker&lt;T&gt; invoker = doselect(loadbalance, invocation, invokers, selected);</span><br /><span class="line"> <span class="number">26</span>: </span><br /><span class="line"> <span class="number">27</span>:     <span class="comment">// è‹¥å¼€å¯ç²˜æ»è¿æ¥çš„ç‰¹æ€§ï¼Œè®°å½•æœ€ç»ˆé€‰æ‹©çš„ Invoker åˆ° stickyInvoker</span></span><br /><span class="line"> <span class="number">28</span>:     <span class="keyword">if</span> (sticky) {</span><br /><span class="line"> <span class="number">29</span>:         stickyInvoker = invoker;</span><br /><span class="line"> <span class="number">30</span>:     }</span><br /><span class="line"> <span class="number">31</span>:     <span class="keyword">return</span> invoker;</span><br /><span class="line"> <span class="number">32</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è¯¥æ–¹æ³•ä¸»è¦å¤„ç†<strong>ç²˜æ»è¿æ¥</strong>çš„ç‰¹æ€§ï¼Œå…·ä½“ä½¿ç”¨ Loadbalance é€‰æ‹© Invoker å¯¹è±¡çš„é€»è¾‘ï¼Œåœ¨&nbsp;<code>#doselect(loadbalance, invocation, invokers, selected)</code>&nbsp;æ–¹æ³•ä¸­ã€‚</li>
<li>ç¬¬ 5 è‡³ 22 è¡Œï¼šè·å¾—<strong>ç²˜æ»è¿æ¥</strong>&nbsp;<code>stickyInvoker</code>&nbsp;å¯¹è±¡ã€‚
<ul>
<li>ç¬¬ 6 è‡³ 7 è¡Œï¼šè·å¾—æ–¹æ³•çº§çš„&nbsp;<code>sticky</code>&nbsp;é…ç½®é¡¹ã€‚</li>
<li>ç¬¬ 9 è‡³ 13 è¡Œï¼šè‹¥&nbsp;<code>stickyInvoker</code>&nbsp;ä¸å­˜åœ¨äº&nbsp;<code>invokers</code>&nbsp;ä¸­ï¼Œè¯´æ˜ä¸åœ¨å€™é€‰ä¸­ï¼Œéœ€è¦ç½®ç©ºï¼Œé‡æ–°é€‰æ‹©ã€‚</li>
<li>ç¬¬ 14 è‡³ 21 è¡Œï¼šè·å¾—<strong>ç²˜æ»è¿æ¥</strong>&nbsp;<code>stickyInvoker</code>&nbsp;å¯¹è±¡ã€‚å¦‚è¦æ»¡è¶³å¦‚ä¸‹<strong>æ¡ä»¶</strong>ï¼š
<ul>
<li>ç¬¬ 16 è¡Œï¼š1ï¼‰å¼€å¯ç²˜æ»è¿æ¥çš„ç‰¹æ€§ï¼›2ï¼‰<code>stickyInvoker</code>&nbsp;ä¸å­˜åœ¨äº&nbsp;<code>selected</code>&nbsp;ä¸­ã€‚</li>
<li>ç¬¬ 18 è¡Œï¼šè‹¥å¼€å¯<strong>æ’é™¤éå¯ç”¨</strong>çš„ Invoker çš„ç‰¹æ€§ï¼Œåˆ™æ ¡éªŒ&nbsp;<code>stickyInvoker</code>&nbsp;æ˜¯å¦å¯ç”¨ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 25 è¡Œï¼šè°ƒç”¨&nbsp;<code>#doselect(loadbalance, invocation, invokers, selected)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œé€‰æ‹©ä¸€ä¸ª Invoker å¯¹è±¡ã€‚</li>
<li>ç¬¬ 27 è‡³ 30 è¡Œï¼šè‹¥å¼€å¯<strong>ç²˜æ»è¿æ¥</strong>çš„ç‰¹æ€§ï¼Œè®°å½•æœ€ç»ˆé€‰æ‹©çš„ Invoker å¯¹è±¡ï¼Œåˆ°&nbsp;<code>stickyInvoker</code>&nbsp;ä¸­ã€‚</li>
</ul>
<h3 id="6-3-1-doselect">6.3.1 doselect</h3>
<p><code>#doselect(loadbalance, invocation, invokers, selected)</code>&nbsp;æ–¹æ³•ï¼Œä»<strong>å€™é€‰</strong>çš„ Invoker é›†åˆï¼Œé€‰æ‹©ä¸€ä¸ª<strong>æœ€ç»ˆè°ƒç”¨</strong>çš„ Invoker å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Invoker&lt;T&gt; <span class="title">doselect</span><span class="params">(LoadBalance loadbalance, Invocation invocation, List&lt;Invoker&lt;T&gt;&gt; invokers, List&lt;Invoker&lt;T&gt;&gt; selected)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (invokers == <span class="keyword">null</span> || invokers.isEmpty()) {</span><br /><span class="line"> <span class="number">3</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line"> <span class="number">4</span>:     }</span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// ã€ç¬¬ä¸€ç§ã€‘å¦‚æœåªæœ‰ä¸€ä¸ª Invoker ï¼Œç›´æ¥é€‰æ‹©</span></span><br /><span class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (invokers.size() == <span class="number">1</span>) {</span><br /><span class="line"> <span class="number">7</span>:         <span class="keyword">return</span> invokers.get(<span class="number">0</span>);</span><br /><span class="line"> <span class="number">8</span>:     }</span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// ã€ç¬¬äºŒç§ã€‘å¦‚æœåªæœ‰ä¸¤ä¸ª Invoker ï¼Œé€€åŒ–æˆè½®å¾ª</span></span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// If we only have two invokers, use round-robin instead.</span></span><br /><span class="line"><span class="number">11</span>:     <span class="keyword">if</span> (invokers.size() == <span class="number">2</span> &amp;&amp; selected != <span class="keyword">null</span> &amp;&amp; !selected.isEmpty()) {</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">return</span> selected.get(<span class="number">0</span>) == invokers.get(<span class="number">0</span>) ? invokers.get(<span class="number">1</span>) : invokers.get(<span class="number">0</span>);</span><br /><span class="line"><span class="number">13</span>:     }</span><br /><span class="line"><span class="number">14</span>: </span><br /><span class="line"><span class="number">15</span>:     <span class="comment">// ã€ç¬¬ä¸‰ç§ã€‘ä½¿ç”¨ Loadbalance ï¼Œé€‰æ‹©ä¸€ä¸ª Invoker å¯¹è±¡ã€‚</span></span><br /><span class="line"><span class="number">16</span>:     Invoker&lt;T&gt; invoker = loadbalance.select(invokers, getUrl(), invocation);</span><br /><span class="line"><span class="number">17</span>: </span><br /><span class="line"><span class="number">18</span>:     <span class="comment">// If the `invoker` is in the  `selected` or invoker is unavailable &amp;&amp; availablecheck is true, reselect.</span></span><br /><span class="line"><span class="number">19</span>:     <span class="comment">// å¦‚æœ selectedä¸­åŒ…å«ï¼ˆä¼˜å…ˆåˆ¤æ–­ï¼‰ æˆ–è€… ä¸å¯ç”¨&amp;&amp;availablecheck=true åˆ™é‡è¯•.</span></span><br /><span class="line"><span class="number">20</span>:     <span class="keyword">if</span> ((selected != <span class="keyword">null</span> &amp;&amp; selected.contains(invoker))</span><br /><span class="line"><span class="number">21</span>:             || (!invoker.isAvailable() &amp;&amp; getUrl() != <span class="keyword">null</span> &amp;&amp; availablecheck)) {</span><br /><span class="line"><span class="number">22</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">23</span>:             <span class="comment">//ã€ç¬¬å››ç§ã€‘é‡é€‰ä¸€ä¸ª Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="number">24</span>:             Invoker&lt;T&gt; rinvoker = reselect(loadbalance, invocation, invokers, selected, availablecheck);</span><br /><span class="line"><span class="number">25</span>:             <span class="keyword">if</span> (rinvoker != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">26</span>:                 invoker = rinvoker;</span><br /><span class="line"><span class="number">27</span>:             } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">28</span>:                 <span class="comment">// Check the index of current selected invoker, if it's not the last one, choose the one at index+1.</span></span><br /><span class="line"><span class="number">29</span>:                 <span class="comment">// ã€ç¬¬äº”ç§ã€‘çœ‹ä¸‹ç¬¬ä¸€æ¬¡é€‰çš„ä½ç½®ï¼Œå¦‚æœä¸æ˜¯æœ€åï¼Œé€‰+1ä½ç½®.</span></span><br /><span class="line"><span class="number">30</span>:                 <span class="keyword">int</span> index = invokers.indexOf(invoker);</span><br /><span class="line"><span class="number">31</span>:                 <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">32</span>:                     <span class="comment">// Avoid collision</span></span><br /><span class="line"><span class="number">33</span>:                     <span class="comment">// æœ€ååœ¨é¿å…ç¢°æ’</span></span><br /><span class="line"><span class="number">34</span>:                     invoker = index &lt; invokers.size() - <span class="number">1</span> ? invokers.get(index + <span class="number">1</span>) : invoker;</span><br /><span class="line"><span class="number">35</span>:                 } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line"><span class="number">36</span>:                     logger.warn(e.getMessage() + <span class="string">" may because invokers list dynamic change, ignore."</span>, e);</span><br /><span class="line"><span class="number">37</span>:                 }</span><br /><span class="line"><span class="number">38</span>:             }</span><br /><span class="line"><span class="number">39</span>:         } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">40</span>:             logger.error(<span class="string">"clustor relselect fail reason is :"</span> + t.getMessage() + <span class="string">" if can not slove ,you can set cluster.availablecheck=false in url"</span>, t);</span><br /><span class="line"><span class="number">41</span>:         }</span><br /><span class="line"><span class="number">42</span>:     }</span><br /><span class="line"><span class="number">43</span>:     <span class="keyword">return</span> invoker;</span><br /><span class="line"><span class="number">44</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æœ‰<strong>äº”ç§</strong>é€‰æ‹©æœ€ç»ˆè°ƒç”¨çš„ Invoker å¯¹è±¡çš„æ–¹å¼ã€‚</li>
<li>ã€ç¬¬ä¸€ç§ã€‘ç¬¬ 5 è‡³ 8 è¡Œï¼šå¦‚æœåªæœ‰<strong>ä¸€ä¸ªå€™é€‰</strong>çš„ Invoker å¯¹è±¡ï¼Œç›´æ¥é€‰æ‹©è¿”å›ã€‚ğŸ˜ˆ å› ä¸ºæ²¡çš„é€‰æ‹©äº†ã€‚</li>
<li>
<p>ã€ç¬¬äºŒç§ã€‘ç¬¬ 9 è‡³ 13 è¡Œï¼šå¦‚æœåªæœ‰<strong>ä¸¤ä¸ªå€™é€‰</strong>çš„ Invoker é›†åˆï¼Œé€€åŒ–ä¸ºè½®è¯¢ã€‚æ­¤å¤„å­˜åœ¨ä¸€ä¸ª BUG ï¼š</p>
<blockquote>
<p>è½¬è½½è‡ªæˆ‘<strong>é£å“¥</strong>ï¼Œ<a href="https://www.jianshu.com/p/10c30d7b8b6a" target="_blank" rel="external nofollow noopener noreferrer">ã€Šdubbo æºç  - è´Ÿè½½å‡è¡¡ã€‹</a></p>
<p>è¿™é‡Œé€€åŒ–æˆè½®è¯¢çš„å®ç°æœ‰é—®é¢˜ï¼Œå¯¹åº”æºç <code>return selected.get(0) == invokers.get(0) ? invokers.get(1) : invokers.get(0)ï¼›</code>å¦‚æœretries=4ï¼Œå³æœ€å¤šè°ƒç”¨5æ¬¡ï¼Œä¸”ä¸¤ä¸ªå¯é€‰invokeåˆ†åˆ«ä¸ºï¼š</p>
<p>10.0.0.1:20884ï¼Œ10.0.0.1:20886ï¼›</p>
<p>é‚£ä¹ˆ5æ¬¡é€‰æ‹©çš„invokeä¸ºï¼š</p>
<ul>
<li>10.0.0.1:20884</li>
<li>10.0.0.1:20886</li>
<li>10.0.0.1:20886</li>
<li>10.0.0.1:20886</li>
<li>10.0.0.1:20886ï¼Œ</li>
</ul>
<p>å³é™¤äº†ç¬¬1æ¬¡å¤–åé¢çš„é€‰æ‹©éƒ½æ˜¯é€‰æ‹©<strong>ç¬¬äºŒä¸ª</strong>invoker;</p>
<p>å› æ¬¡éœ€è¦æŠŠselected.get(0)ä¿®æ”¹ä¸ºï¼šselected.get(selected.size()-1)ï¼›</p>
<p>å³æ¯æ¬¡æ‹¿å‰ä¸€æ¬¡é€‰æ‹©çš„invokerä¸ invokers.get(0)æ¯”è¾ƒï¼Œå¦‚æœç›¸åŒï¼Œåˆ™é€‰åˆ™å¦ä¸€ä¸ªinvokerï¼›å¦åˆ™å°±é€‰ invokers.get(0)ï¼›</p>
</blockquote>
<ul>
<li>æ¯”è¾ƒæœ‰è¶£çš„æ˜¯ï¼Œ<a href="https://github.com/apache/incubator-dubbo/issues/934" target="_blank" rel="external nofollow noopener noreferrer">ISSUE#934ï¼šExtension of LoadBalance (a small suggestion for loadbalance policy when there&rsquo;s less than 2 providers)&nbsp;</a>ã€‚å’Œä¸Šè¿° BUG æ— å…³ï¼Œèƒ–å‹è‡ªå·±ç†è§£ä¸‹ã€‚</li>
</ul>
</li>
<li>
<p>ã€ç¬¬ä¸‰ç§ã€‘ç¬¬ 16 è‡³ 21 è¡Œï¼šè°ƒç”¨&nbsp;<code>Loadbalance#select(invokers, url, invocation)</code>&nbsp;æ–¹æ³•ï¼Œä½¿ç”¨ Loadbalance ï¼Œé€‰æ‹©ä¸€ä¸ª Invoker å¯¹è±¡ã€‚å…·ä½“çš„ä»£ç å®ç°ï¼Œè§ Loadbalance çš„æ–‡ç« ã€‚</p>
<ul>
<li>è¿™ç§æ–¹å¼çš„è¿”å›ï¼Œé€‰æ‹©çš„ Invoker å¯¹è±¡ï¼Œéœ€è¦æ»¡è¶³<strong>ä¸¤ä¸ª</strong>æ¡ä»¶ï¼š1ï¼‰ä¸å­˜åœ¨äº&nbsp;<code>selected</code>&nbsp;ä¸­ã€‚2ï¼‰Invoker æ˜¯å¯ç”¨çš„ï¼Œè‹¥å¼€å¯æ’é™¤éå¯ç”¨çš„ Invoker çš„ç‰¹æ€§ã€‚</li>
</ul>
</li>
<li>ã€ç¬¬å››ç§ã€‘è°ƒç”¨&nbsp;<code>#reselect(loadbalance, invocation, invokers, selected, availablecheck)</code>&nbsp;æ–¹æ³•ï¼Œé‡æ–°é€‰æ‹©ä¸€ä¸ª Invoker å¯¹è±¡ã€‚ğŸ˜ˆ å› ä¸ºæ­¤æ—¶&nbsp;<code>invokers</code>&nbsp;ä¸­ï¼Œæ— æ³•æ‰¾åˆ°ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„ Invoker å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-1-api-interface/">ã€Œ6.3.2 reselectã€</a>&nbsp;ã€‚</li>
<li>ã€ç¬¬äº”ç§ã€‘<strong>é¡ºåº</strong>ä»å€™é€‰çš„&nbsp;<code>invokers</code>&nbsp;é›†åˆä¸­ï¼Œé€‰æ‹©ä¸€ä¸ª Invoker å¯¹è±¡ï¼Œä¸è€ƒè™‘æ˜¯å¦<strong>å¯ç”¨</strong>ï¼Œåˆæˆ–è€…<strong>å·²ç»é€‰æ‹©è¿‡</strong>ï¼Œç±»ä¼¼ã€ç¬¬ä¸€ç§ã€‘ã€ç¬¬äºŒç§ã€‘çš„æ–¹å¼ã€‚ğŸ˜ˆæ€»ä¹‹ï¼Œä¿è¯èƒ½è·å–åˆ°ä¸€ä¸ª Invoker å¯¹è±¡ã€‚</li>
</ul>
<h3 id="6-3-2-reselect">6.3.2 reselect</h3>
<p><code>#reselect(loadbalance, invocation, invokers, selected, availablecheck)</code>&nbsp;æ–¹æ³•ï¼Œé‡æ–°é€‰æ‹©ä¸€ä¸ª Invoker å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> Invoker&lt;T&gt; <span class="title">reselect</span><span class="params">(LoadBalance loadbalance, Invocation invocation, List&lt;Invoker&lt;T&gt;&gt; invokers, List&lt;Invoker&lt;T&gt;&gt; selected, <span class="keyword">boolean</span> availablecheck)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// Allocating one in advance, this list is certain to be used.</span></span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// é¢„å…ˆåˆ†é…ä¸€ä¸ªï¼Œè¿™ä¸ªåˆ—è¡¨æ˜¯ä¸€å®šä¼šç”¨åˆ°çš„.</span></span><br /><span class="line"> <span class="number">4</span>:     List&lt;Invoker&lt;T&gt;&gt; reselectInvokers = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;(invokers.size() &gt; <span class="number">1</span> ? (invokers.size() - <span class="number">1</span>) : invokers.size());</span><br /><span class="line"> <span class="number">5</span>: </span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// First, try picking a invoker not in `selected`.</span></span><br /><span class="line"> <span class="number">7</span>:     <span class="comment">// å…ˆä»éselectä¸­é€‰</span></span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (availablecheck) { <span class="comment">// invoker.isAvailable() should be checked</span></span><br /><span class="line"> <span class="number">9</span>:         <span class="comment">// è·å¾—éé€‰æ‹©è¿‡ï¼Œå¹¶ä¸”å¯ç”¨çš„ Invoker é›†åˆ</span></span><br /><span class="line"><span class="number">10</span>:         <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokers) {</span><br /><span class="line"><span class="number">11</span>:             <span class="keyword">if</span> (invoker.isAvailable()) { <span class="comment">// å¹¶ä¸”å¯ç”¨</span></span><br /><span class="line"><span class="number">12</span>:                 <span class="keyword">if</span> (selected == <span class="keyword">null</span> || !selected.contains(invoker)) {</span><br /><span class="line"><span class="number">13</span>:                     reselectInvokers.add(invoker);</span><br /><span class="line"><span class="number">14</span>:                 }</span><br /><span class="line"><span class="number">15</span>:             }</span><br /><span class="line"><span class="number">16</span>:         }</span><br /><span class="line"><span class="number">17</span>:         <span class="comment">// ä½¿ç”¨ Loadbalance ï¼Œé€‰æ‹©ä¸€ä¸ª Invoker å¯¹è±¡ã€‚</span></span><br /><span class="line"><span class="number">18</span>:         <span class="keyword">if</span> (!reselectInvokers.isEmpty()) {</span><br /><span class="line"><span class="number">19</span>:             <span class="keyword">return</span> loadbalance.select(reselectInvokers, getUrl(), invocation);</span><br /><span class="line"><span class="number">20</span>:         }</span><br /><span class="line"><span class="number">21</span>:     } <span class="keyword">else</span> { <span class="comment">// do not check invoker.isAvailable()</span></span><br /><span class="line"><span class="number">22</span>:         <span class="comment">// è·å¾—éé€‰æ‹©è¿‡çš„ Invoker é›†åˆ</span></span><br /><span class="line"><span class="number">23</span>:         <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokers) {</span><br /><span class="line"><span class="number">24</span>:             <span class="keyword">if</span> (selected == <span class="keyword">null</span> || !selected.contains(invoker)) {</span><br /><span class="line"><span class="number">25</span>:                 reselectInvokers.add(invoker);</span><br /><span class="line"><span class="number">26</span>:             }</span><br /><span class="line"><span class="number">27</span>:         }</span><br /><span class="line"><span class="number">28</span>:         <span class="comment">// ä½¿ç”¨ Loadbalance ï¼Œé€‰æ‹©ä¸€ä¸ª Invoker å¯¹è±¡ã€‚</span></span><br /><span class="line"><span class="number">29</span>:         <span class="keyword">if</span> (!reselectInvokers.isEmpty()) {</span><br /><span class="line"><span class="number">30</span>:             <span class="keyword">return</span> loadbalance.select(reselectInvokers, getUrl(), invocation);</span><br /><span class="line"><span class="number">31</span>:         }</span><br /><span class="line"><span class="number">32</span>:     }</span><br /><span class="line"><span class="number">33</span>:     <span class="comment">// Just pick an available invoker using loadbalance policy</span></span><br /><span class="line"><span class="number">34</span>:     <span class="comment">// æœ€åä»selectä¸­é€‰å¯ç”¨çš„.</span></span><br /><span class="line"><span class="number">35</span>:     {</span><br /><span class="line"><span class="number">36</span>:         <span class="comment">// è·å¾—é€‰æ‹©è¿‡çš„ï¼Œå¹¶ä¸”å¯ç”¨çš„ Invoker é›†åˆ</span></span><br /><span class="line"><span class="number">37</span>:         <span class="keyword">if</span> (selected != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">38</span>:             <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : selected) {</span><br /><span class="line"><span class="number">39</span>:                 <span class="keyword">if</span> ((invoker.isAvailable()) <span class="comment">// available first</span></span><br /><span class="line"><span class="number">40</span>:                         &amp;&amp; !reselectInvokers.contains(invoker)) {</span><br /><span class="line"><span class="number">41</span>:                     reselectInvokers.add(invoker);</span><br /><span class="line"><span class="number">42</span>:                 }</span><br /><span class="line"><span class="number">43</span>:             }</span><br /><span class="line"><span class="number">44</span>:         }</span><br /><span class="line"><span class="number">45</span>:         <span class="comment">// ä½¿ç”¨ Loadbalance ï¼Œé€‰æ‹©ä¸€ä¸ª Invoker å¯¹è±¡ã€‚</span></span><br /><span class="line"><span class="number">46</span>:         <span class="keyword">if</span> (!reselectInvokers.isEmpty()) {</span><br /><span class="line"><span class="number">47</span>:             <span class="keyword">return</span> loadbalance.select(reselectInvokers, getUrl(), invocation);</span><br /><span class="line"><span class="number">48</span>:         }</span><br /><span class="line"><span class="number">49</span>:     }</span><br /><span class="line"><span class="number">50</span>:     <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">51</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 4 è¡Œï¼šé¢„å…ˆåˆ›å»ºä¸€ä¸ªé‡é€‰ Invoker é›†åˆï¼Œæˆ‘ä»¬ä¼šå‘ç°å¾ˆå¥‡æ€ªçš„ä¸€æ®µ&nbsp;<code>invokers.size() - 1</code>&nbsp;ä»£ç ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿç¬”è€…çš„ç†è§£æ˜¯ï¼Œå‡ºç°é‡é€‰&nbsp;<code>#reselect(...)</code>&nbsp;çš„åŸå› ï¼Œè¯´æ˜&nbsp;<code>#doselect(...)</code>&nbsp;çš„ã€ç¬¬ä¸‰ç§ã€‘é€‰æ‹©çš„ Invoker å¯¹è±¡ï¼Œåœ¨&nbsp;<code>selected</code>&nbsp;ä¸­ï¼Œå› æ­¤éœ€è¦<strong>å»æ‰ä¸€ä¸ª</strong>ã€‚</li>
<li>ä¸€å…±æœ‰<strong>ä¸¤ç±»ä¸‰ç§</strong>çš„é€‰æ‹©æ–¹å¼ï¼š
<ul>
<li>ã€ç¬¬ä¸€ç§ã€‘ç¬¬ 10 è‡³ 16 è¡Œï¼šè·å¾—<strong>éé€‰æ‹©è¿‡</strong>(&nbsp;<code>invokers</code>&nbsp;)ï¼Œ å¹¶ä¸”<strong>å¿…é¡»</strong>å¯ç”¨çš„ Invoker é›†åˆã€‚</li>
<li>ã€ç¬¬äºŒç§ã€‘ç¬¬ 22 è‡³ 27 è¡Œï¼šè·å¾—<strong>éé€‰æ‹©è¿‡</strong>(&nbsp;<code>invokers</code>&nbsp;)ï¼Œ å¹¶ä¸”<strong>ä¸è€ƒè™‘</strong>å¯ç”¨çš„ Invoker é›†åˆã€‚</li>
<li>ã€ç¬¬ä¸‰ç§ã€‘ç¬¬ 36 è‡³ 44 è¡Œï¼šè·å¾—<strong>é€‰æ‹©è¿‡</strong>(&nbsp;<code>selected</code>&nbsp;)ï¼Œå¹¶ä¸”<strong>å¿…é¡»</strong>å¯ç”¨çš„ Invoker é›†åˆã€‚</li>
</ul>
</li>
<li>ç¬¬ 19 è¡Œ || ç¬¬ 30 è¡Œ || ç¬¬ 47 è¡Œï¼šè°ƒç”¨&nbsp;<code>Loadbalance#select(invokers, url, invocation)</code>&nbsp;æ–¹æ³•ï¼Œä½¿ç”¨ Loadbalance ï¼Œé€‰æ‹©ä¸€ä¸ª Invoker å¯¹è±¡ã€‚</li>
</ul>
<h2 id="6-4-invoke">6.4 invoke</h2>
<p><code>#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼Œè°ƒç”¨æœåŠ¡<strong>æä¾›è€…</strong>çš„é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(<span class="keyword">final</span> Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// æ ¡éªŒæ˜¯å¦é”€æ¯</span></span><br /><span class="line"> <span class="number">4</span>:     checkWhetherDestroyed();</span><br /><span class="line"> <span class="number">5</span>: </span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// è·å¾—æ‰€æœ‰æœåŠ¡æä¾›è€… Invoker é›†åˆ</span></span><br /><span class="line"> <span class="number">7</span>:     List&lt;Invoker&lt;T&gt;&gt; invokers = list(invocation);</span><br /><span class="line"> <span class="number">8</span>: </span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// è·å¾— LoadBalance å¯¹è±¡</span></span><br /><span class="line"><span class="number">10</span>:     LoadBalance loadbalance;</span><br /><span class="line"><span class="number">11</span>:     <span class="keyword">if</span> (invokers != <span class="keyword">null</span> &amp;&amp; !invokers.isEmpty()) {</span><br /><span class="line"><span class="number">12</span>:         loadbalance = ExtensionLoader.getExtensionLoader(LoadBalance.class).getExtension(invokers.get(<span class="number">0</span>).getUrl()</span><br /><span class="line"><span class="number">13</span>:                 .getMethodParameter(invocation.getMethodName(), Constants.LOADBALANCE_KEY, Constants.DEFAULT_LOADBALANCE));</span><br /><span class="line"><span class="number">14</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">15</span>:         loadbalance = ExtensionLoader.getExtensionLoader(LoadBalance.class).getExtension(Constants.DEFAULT_LOADBALANCE);</span><br /><span class="line"><span class="number">16</span>:     }</span><br /><span class="line"><span class="number">17</span>: </span><br /><span class="line"><span class="number">18</span>:     <span class="comment">// è®¾ç½®è°ƒç”¨ç¼–å·ï¼Œè‹¥æ˜¯å¼‚æ­¥è°ƒç”¨</span></span><br /><span class="line"><span class="number">19</span>:     RpcUtils.attachInvocationIdIfAsync(getUrl(), invocation);</span><br /><span class="line"><span class="number">20</span>: </span><br /><span class="line"><span class="number">21</span>:     <span class="comment">// æ‰§è¡Œè°ƒç”¨</span></span><br /><span class="line"><span class="number">22</span>:     <span class="keyword">return</span> doInvoke(invocation, invokers, loadbalance);</span><br /><span class="line"><span class="number">23</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ç¬¬ 4 è¡Œï¼šè°ƒç”¨&nbsp;<code>#checkWhetherDestroyed()</code>&nbsp;æ–¹æ³•ï¼Œ<strong>æ ¡éªŒ</strong>æ˜¯å¦å·²ç»é”€æ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkWhetherDestroyed</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (destroyed.get()) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Rpc cluster invoker for "</span> + getInterface() + <span class="string">" on consumer "</span> + NetUtils.getLocalHost()</span><br /><span class="line">                + <span class="string">" use dubbo version "</span> + Version.getVersion()</span><br /><span class="line">                + <span class="string">" is now destroyed! Can not invoke any more."</span>);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 7 è¡Œï¼šè°ƒç”¨&nbsp;<code>#list(invocation)</code>&nbsp;æ–¹æ³•ï¼ŒåŸºäº Directory ï¼Œè·å¾—æ‰€æœ‰æœåŠ¡æä¾›è€… Invoker é›†åˆã€‚</p>
</li>
<li>ç¬¬ 9 è‡³ 16 è¡Œï¼šè·å¾— Loadbalance å¯¹è±¡ã€‚</li>
<li>ç¬¬ 19 è¡Œï¼šè°ƒç”¨&nbsp;<code>RpcUtils#attachInvocationIdIfAsync(url, invocation)</code>&nbsp;æ–¹æ³•ï¼Œè®¾ç½®<strong>è°ƒç”¨ç¼–å·</strong>ï¼Œè‹¥æ˜¯å¼‚æ­¥è°ƒç”¨ã€‚</li>
<li>ç¬¬ 22 è¡Œï¼šè°ƒç”¨&nbsp;<code>#doInvoke(invocation, invokers, loadbalance)</code>&nbsp;<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œæ‰§è¡Œè°ƒç”¨ã€‚ğŸ™‚ å­ Cluster çš„ Invoker å®ç°ç±»çš„<strong>æœåŠ¡è°ƒç”¨</strong>çš„å·®å¼‚é€»è¾‘ã€‚</li>
</ul>
<h2 id="6-5-å…¶å®ƒå®ç°æ–¹æ³•">6.5 å…¶å®ƒå®ç°æ–¹æ³•</h2>
<h3 id="6-5-1-getInterface">6.5.1 getInterface</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> Class&lt;T&gt; <span class="title">getInterface</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> directory.getInterface();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="6-5-2-getUrl">6.5.2 getUrl</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> URL <span class="title">getUrl</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> directory.getUrl();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="6-5-3-isAvailable">6.5.3 isAvailable</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// å¦‚æœ‰ç²˜æ»è¿æ¥ Invoker ï¼ŒåŸºäºå®ƒåˆ¤æ–­ã€‚</span></span><br /><span class="line">    Invoker&lt;T&gt; invoker = stickyInvoker; <span class="comment">// æŒ‡å‘ï¼Œé¿å…å¹¶å‘</span></span><br /><span class="line">    <span class="keyword">if</span> (invoker != <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">return</span> invoker.isAvailable();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// åŸºäº Directory åˆ¤æ–­</span></span><br /><span class="line">    <span class="keyword">return</span> directory.isAvailable();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="6-5-4-checkInvokers">6.5.4 checkInvokers</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkInvokers</span><span class="params">(List&lt;Invoker&lt;T&gt;&gt; invokers, Invocation invocation)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (invokers == <span class="keyword">null</span> || invokers.isEmpty()) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Failed to invoke the method "</span></span><br /><span class="line">                + invocation.getMethodName() + <span class="string">" in the service "</span> + getInterface().getName()</span><br /><span class="line">                + <span class="string">". No provider available for the service "</span> + directory.getUrl().getServiceKey()</span><br /><span class="line">                + <span class="string">" from registry "</span> + directory.getUrl().getAddress()</span><br /><span class="line">                + <span class="string">" on the consumer "</span> + NetUtils.getLocalHost()</span><br /><span class="line">                + <span class="string">" using the dubbo version "</span> + Version.getVersion()</span><br /><span class="line">                + <span class="string">". Please check if the providers have been started and registered."</span>);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="6-5-5-destroy">6.5.5 destroy</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (destroyed.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) {</span><br /><span class="line">        directory.destroy();</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="7-FailoverClusterInvoker">7. FailoverClusterInvoker</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.support.FailoverClusterInvoker</code>&nbsp;ï¼Œå®ç° AbstractClusterInvoker æŠ½è±¡ç±»ï¼Œ<strong>FailoverCluster</strong>&nbsp;Invoker å®ç°ç±»ã€‚</p>
<p>å¤±è´¥è‡ªåŠ¨åˆ‡æ¢ï¼Œå½“å‡ºç°å¤±è´¥ï¼Œé‡è¯•å…¶å®ƒæœåŠ¡å™¨ã€‚é€šå¸¸ç”¨äº<strong>è¯»æ“ä½œ</strong>ï¼Œä½†é‡è¯•ä¼šå¸¦æ¥æ›´é•¿å»¶è¿Ÿã€‚å¯é€šè¿‡&nbsp;<code>retries="2"</code>&nbsp;æ¥è®¾ç½®é‡è¯•æ¬¡æ•°(ä¸å«ç¬¬ä¸€æ¬¡)ã€‚</p>
<p>åœ¨çœ‹å…·ä½“çš„&nbsp;<code>#doInvoke(Invocation, List&lt;Invoker&lt;T&gt;&gt;, LoadBalance)</code>&nbsp;çš„å®ç°ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ç…ç…<strong>è°ƒç”¨é¡ºåºå›¾</strong>ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_04_01/04.png" alt="è°ƒç”¨é¡ºåºå›¾" /></p>
<ul>
<li>å®é™…é€»è¾‘å¾ˆç®€å•ï¼š<strong>å¾ªç¯</strong>ï¼ŒæŸ¥æ‰¾ä¸€ä¸ª Invoker å¯¹è±¡ï¼Œè¿›è¡Œè°ƒç”¨ï¼Œç›´åˆ°<strong>æˆåŠŸ</strong>ã€‚</li>
</ul>
<p><code>#doInvoke(Invocation, List&lt;Invoker&lt;T&gt;&gt;, LoadBalance)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Result <span class="title">doInvoke</span><span class="params">(Invocation invocation, <span class="keyword">final</span> List&lt;Invoker&lt;T&gt;&gt; invokers, LoadBalance loadbalance)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">3</span>:     List&lt;Invoker&lt;T&gt;&gt; copyinvokers = invokers;</span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// æ£€æŸ¥copyinvokerså³å¯ç”¨Invokeré›†åˆæ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œé‚£ä¹ˆæŠ›å‡ºå¼‚å¸¸</span></span><br /><span class="line"> <span class="number">5</span>:     checkInvokers(copyinvokers, invocation);</span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// å¾—åˆ°æœ€å¤§å¯è°ƒç”¨æ¬¡æ•°ï¼šæœ€å¤§å¯é‡è¯•æ¬¡æ•°+1ï¼Œé»˜è®¤æœ€å¤§å¯é‡è¯•æ¬¡æ•°Constants.DEFAULT_RETRIES=2</span></span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">int</span> len = getUrl().getMethodParameter(invocation.getMethodName(), Constants.RETRIES_KEY, Constants.DEFAULT_RETRIES) + <span class="number">1</span>;</span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (len &lt;= <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">9</span>:         len = <span class="number">1</span>;</span><br /><span class="line"><span class="number">10</span>:     }</span><br /><span class="line"><span class="number">11</span>:     <span class="comment">// ä¿å­˜æœ€åä¸€æ¬¡è°ƒç”¨çš„å¼‚å¸¸</span></span><br /><span class="line"><span class="number">12</span>:     RpcException le = <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">13</span>:     <span class="comment">// ä¿å­˜å·²ç»è°ƒç”¨è¿‡çš„Invoker</span></span><br /><span class="line"><span class="number">14</span>:     List&lt;Invoker&lt;T&gt;&gt; invoked = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;(copyinvokers.size()); <span class="comment">// invoked invokers.</span></span><br /><span class="line"><span class="number">15</span>:     Set&lt;String&gt; providers = <span class="keyword">new</span> HashSet&lt;String&gt;(len);</span><br /><span class="line"><span class="number">16</span>:     <span class="comment">// failoveræœºåˆ¶æ ¸å¿ƒå®ç°ï¼šå¦‚æœå‡ºç°è°ƒç”¨å¤±è´¥ï¼Œé‚£ä¹ˆé‡è¯•å…¶ä»–æœåŠ¡å™¨</span></span><br /><span class="line"><span class="number">17</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) {</span><br /><span class="line"><span class="number">18</span>:         <span class="comment">// é‡è¯•æ—¶ï¼Œè¿›è¡Œé‡æ–°é€‰æ‹©ï¼Œé¿å…é‡è¯•æ—¶invokeråˆ—è¡¨å·²å‘ç”Ÿå˜åŒ–.</span></span><br /><span class="line"><span class="number">19</span>:         <span class="comment">// æ³¨æ„ï¼šå¦‚æœåˆ—è¡¨å‘ç”Ÿäº†å˜åŒ–ï¼Œé‚£ä¹ˆinvokedåˆ¤æ–­ä¼šå¤±æ•ˆï¼Œå› ä¸ºinvokerç¤ºä¾‹å·²ç»æ”¹å˜</span></span><br /><span class="line"><span class="number">20</span>:         <span class="keyword">if</span> (i &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">21</span>:             checkWhetherDestroyed();</span><br /><span class="line"><span class="number">22</span>:             <span class="comment">// æ ¹æ®Invocationè°ƒç”¨ä¿¡æ¯ä»Directoryä¸­è·å–æ‰€æœ‰å¯ç”¨Invoker</span></span><br /><span class="line"><span class="number">23</span>:             copyinvokers = list(invocation);</span><br /><span class="line"><span class="number">24</span>:             <span class="comment">// check again</span></span><br /><span class="line"><span class="number">25</span>:             <span class="comment">// é‡æ–°æ£€æŸ¥ä¸€ä¸‹</span></span><br /><span class="line"><span class="number">26</span>:             checkInvokers(copyinvokers, invocation);</span><br /><span class="line"><span class="number">27</span>:         }</span><br /><span class="line"><span class="number">28</span>:         <span class="comment">// æ ¹æ®è´Ÿè½½å‡è¡¡æœºåˆ¶ä»copyinvokersä¸­é€‰æ‹©ä¸€ä¸ªInvoker</span></span><br /><span class="line"><span class="number">29</span>:         Invoker&lt;T&gt; invoker = select(loadbalance, invocation, copyinvokers, invoked);</span><br /><span class="line"><span class="number">30</span>:         <span class="comment">// ä¿å­˜æ¯æ¬¡è°ƒç”¨çš„Invoker</span></span><br /><span class="line"><span class="number">31</span>:         invoked.add(invoker);</span><br /><span class="line"><span class="number">32</span>:         <span class="comment">// è®¾ç½®å·²ç»è°ƒç”¨çš„ Invoker é›†åˆï¼Œåˆ° Context ä¸­</span></span><br /><span class="line"><span class="number">33</span>:         RpcContext.getContext().setInvokers((List) invoked);</span><br /><span class="line"><span class="number">34</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">35</span>:             <span class="comment">// RPC è°ƒç”¨å¾—åˆ° Result</span></span><br /><span class="line"><span class="number">36</span>:             Result result = invoker.invoke(invocation);</span><br /><span class="line"><span class="number">37</span>:             <span class="comment">// é‡è¯•è¿‡ç¨‹ä¸­ï¼Œå°†æœ€åä¸€æ¬¡è°ƒç”¨çš„å¼‚å¸¸ä¿¡æ¯ä»¥ warn çº§åˆ«æ—¥å¿—è¾“å‡º</span></span><br /><span class="line"><span class="number">38</span>:             <span class="keyword">if</span> (le != <span class="keyword">null</span> &amp;&amp; logger.isWarnEnabled()) {</span><br /><span class="line"><span class="number">39</span>:                 logger.warn(<span class="string">"Although retry the method "</span> + invocation.getMethodName()</span><br /><span class="line"><span class="number">40</span>:                         + <span class="string">" in the service "</span> + getInterface().getName()</span><br /><span class="line"><span class="number">41</span>:                         + <span class="string">" was successful by the provider "</span> + invoker.getUrl().getAddress()</span><br /><span class="line"><span class="number">42</span>:                         + <span class="string">", but there have been failed providers "</span> + providers</span><br /><span class="line"><span class="number">43</span>:                         + <span class="string">" ("</span> + providers.size() + <span class="string">"/"</span> + copyinvokers.size()</span><br /><span class="line"><span class="number">44</span>:                         + <span class="string">") from the registry "</span> + directory.getUrl().getAddress()</span><br /><span class="line"><span class="number">45</span>:                         + <span class="string">" on the consumer "</span> + NetUtils.getLocalHost()</span><br /><span class="line"><span class="number">46</span>:                         + <span class="string">" using the dubbo version "</span> + Version.getVersion() + <span class="string">". Last error is: "</span></span><br /><span class="line"><span class="number">47</span>:                         + le.getMessage(), le);</span><br /><span class="line"><span class="number">48</span>:             }</span><br /><span class="line"><span class="number">49</span>:             <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">50</span>:         } <span class="keyword">catch</span> (RpcException e) {</span><br /><span class="line"><span class="number">51</span>:             <span class="comment">// å¦‚æœæ˜¯ä¸šåŠ¡æ€§è´¨çš„å¼‚å¸¸ï¼Œä¸å†é‡è¯•ï¼Œç›´æ¥æŠ›å‡º</span></span><br /><span class="line"><span class="number">52</span>:             <span class="keyword">if</span> (e.isBiz()) { <span class="comment">// biz exception.</span></span><br /><span class="line"><span class="number">53</span>:                 <span class="keyword">throw</span> e;</span><br /><span class="line"><span class="number">54</span>:             }</span><br /><span class="line"><span class="number">55</span>:             <span class="comment">// å…¶ä»–æ€§è´¨çš„å¼‚å¸¸ç»Ÿä¸€å°è£…æˆRpcException</span></span><br /><span class="line"><span class="number">56</span>:             le = e;</span><br /><span class="line"><span class="number">57</span>:         } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">58</span>:             le = <span class="keyword">new</span> RpcException(e.getMessage(), e);</span><br /><span class="line"><span class="number">59</span>:         } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">60</span>:             providers.add(invoker.getUrl().getAddress());</span><br /><span class="line"><span class="number">61</span>:         }</span><br /><span class="line"><span class="number">62</span>:     }</span><br /><span class="line"><span class="number">63</span>:     <span class="comment">// æœ€å¤§å¯è°ƒç”¨æ¬¡æ•°ç”¨å®Œè¿˜å¾—åˆ°Resultçš„è¯ï¼ŒæŠ›å‡ºRpcExceptionå¼‚å¸¸ï¼šé‡è¯•äº†Næ¬¡è¿˜æ˜¯å¤±è´¥ï¼Œå¹¶è¾“å‡ºæœ€åä¸€æ¬¡å¼‚å¸¸ä¿¡æ¯</span></span><br /><span class="line"><span class="number">64</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(le != <span class="keyword">null</span> ? le.getCode() : <span class="number">0</span>, <span class="string">"Failed to invoke the method "</span></span><br /><span class="line"><span class="number">65</span>:             + invocation.getMethodName() + <span class="string">" in the service "</span> + getInterface().getName()</span><br /><span class="line"><span class="number">66</span>:             + <span class="string">". Tried "</span> + len + <span class="string">" times of the providers "</span> + providers</span><br /><span class="line"><span class="number">67</span>:             + <span class="string">" ("</span> + providers.size() + <span class="string">"/"</span> + copyinvokers.size()</span><br /><span class="line"><span class="number">68</span>:             + <span class="string">") from the registry "</span> + directory.getUrl().getAddress()</span><br /><span class="line"><span class="number">69</span>:             + <span class="string">" on the consumer "</span> + NetUtils.getLocalHost() + <span class="string">" using the dubbo version "</span></span><br /><span class="line"><span class="number">70</span>:             + Version.getVersion() + <span class="string">". Last error is: "</span></span><br /><span class="line"><span class="number">71</span>:             + (le != <span class="keyword">null</span> ? le.getMessage() : <span class="string">""</span>), le != <span class="keyword">null</span> &amp;&amp; le.getCause() != <span class="keyword">null</span> ? le.getCause() : le);</span><br /><span class="line"><span class="number">72</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼š<code>copyinvokers</code>&nbsp;å˜é‡ï¼Œå€™é€‰çš„ Invoker é›†åˆã€‚</li>
<li>ç¬¬ 5 è¡Œï¼šè°ƒç”¨<strong>çˆ¶</strong>&nbsp;<code>#checkInvokers(copyinvokers, invocation)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>æ ¡éªŒ</strong>å€™é€‰çš„ Invoker é›†åˆ<strong>éç©º</strong>ã€‚å¦‚æœä¸ºç©ºï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚</li>
<li>ç¬¬ 6 è‡³ 10 è¡Œï¼šè·å¾—<strong>æœ€å¤§å¯è°ƒç”¨æ¬¡æ•°</strong>ï¼šæœ€å¤§<strong>å¯é‡è¯•</strong>æ¬¡æ•° +1 ã€‚é»˜è®¤æœ€å¤§å¯é‡è¯•æ¬¡æ•°<code>Constants.DEFAULT_RETRIES = 2</code>&nbsp;ã€‚</li>
<li>ç¬¬ 12 è¡Œï¼š<code>le</code>&nbsp;å˜é‡ï¼Œä¿å­˜æœ€åä¸€æ¬¡è°ƒç”¨çš„<strong>å¼‚å¸¸</strong>ã€‚</li>
<li>ç¬¬ 14 è¡Œï¼š<code>invoked</code>&nbsp;å˜é‡ï¼Œä¿å­˜å·²ç»è°ƒç”¨çš„ Invoker é›†åˆã€‚</li>
<li>ç¬¬ 15 è¡Œï¼š<code>providers</code>&nbsp;å˜é‡ï¼Œä¿å­˜å·²ç»è°ƒç”¨çš„<strong>ç½‘ç»œåœ°å€</strong>é›†åˆã€‚</li>
<li>ç¬¬ 16 è‡³ 62 è¡Œï¼š<strong>failover æœºåˆ¶æ ¸å¿ƒå®ç°ï¼šå¦‚æœå‡ºç°è°ƒç”¨å¤±è´¥ï¼Œé‚£ä¹ˆé‡è¯•å…¶ä»–æœåŠ¡å™¨</strong>ã€‚
<ul>
<li>ç¬¬ 20 è‡³ 27 è¡Œï¼š<strong>é‡è¯•æ—¶</strong>(&nbsp;<code>i &gt; 0</code>&nbsp;)ï¼Œ è¿›è¡Œé‡æ–°é€‰æ‹©ï¼Œé¿å…é‡è¯•æ—¶ï¼Œå€™é€‰ Invoker é›†åˆï¼Œå·²å‘ç”Ÿå˜åŒ–ã€‚</li>
<li>ã€é‡è¦ã€‘ç¬¬ 29 è¡Œï¼šè°ƒç”¨<strong>çˆ¶</strong>&nbsp;<code>#select(loadbalance, invocation, copyinvokers, invoked)</code>&nbsp;æ–¹æ³•ï¼Œæ ¹æ® Loadbalance è´Ÿè½½å‡è¡¡æœºåˆ¶ï¼Œä»&nbsp;<code>copyinvokers</code>&nbsp;ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªè¢«è°ƒç”¨çš„ Invoker å¯¹è±¡ã€‚</li>
<li>ç¬¬ 31 è¡Œï¼šä¿å­˜æ¯æ¬¡è°ƒç”¨çš„ Invoker å¯¹è±¡ï¼Œåˆ°&nbsp;<code>invoked</code>&nbsp;ä¸­ã€‚</li>
<li>ç¬¬ 33 è¡Œï¼šä¿å­˜å·²ç»è°ƒç”¨çš„ Invoker é›†åˆï¼Œåˆ° Context ä¸­ã€‚</li>
<li>ã€é‡è¦ã€‘ç¬¬ 36 è¡Œï¼šè°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>å‘èµ· RPC è°ƒç”¨</strong>ã€‚</li>
<li>ç¬¬ 37 è‡³ 48 è¡Œï¼šè‹¥&nbsp;<code>le</code>&nbsp;éç©ºï¼Œè¯´æ˜æ­¤æ—¶æ˜¯<strong>é‡è¯•è°ƒç”¨æˆåŠŸ</strong>ï¼Œå°†æœ€åä¸€æ¬¡è°ƒç”¨çš„å¼‚å¸¸ä¿¡æ¯ä»¥&nbsp;<strong>warn</strong>&nbsp;çº§åˆ«æ—¥å¿—è¾“å‡ºï¼Œæ–¹ä¾¿æœªæ¥è¿½æº¯ã€‚</li>
<li>========== å¼‚å¸¸ç›¸å…³ ===========</li>
<li>ç¬¬ 55 è‡³ 54 è¡Œï¼šå¦‚æœæ˜¯ä¸šåŠ¡æ€§è´¨çš„å¼‚å¸¸ï¼Œä¸å†é‡è¯•ï¼Œç›´æ¥æŠ›å‡ºã€‚</li>
<li>ç¬¬ 56 è¡Œï¼šä¿å­˜å¼‚å¸¸åˆ°&nbsp;<code>le</code>&nbsp;ã€‚</li>
<li>ç¬¬ 58 è¡Œï¼šé RpcException å¼‚å¸¸ï¼Œ<strong>å°è£…</strong>æˆ RpcException å¼‚å¸¸ã€‚</li>
<li>ç¬¬ 59 è‡³ 61 è¡Œï¼šä¿å­˜æ¯æ¬¡è°ƒç”¨çš„<strong>ç½‘ç»œåœ°å€</strong>ï¼Œåˆ°&nbsp;<code>providers</code>&nbsp;ä¸­ã€‚</li>
</ul>
</li>
<li>ç¬¬ 63 è‡³ 71 è¡Œï¼šè¶…è¿‡æœ€å¤§è°ƒç”¨æ¬¡æ•°ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚è¯¥å¼‚å¸¸ä¸­ï¼Œå¸¦æœ‰æœ€åä¸€æ¬¡è°ƒç”¨å¼‚å¸¸çš„ä¿¡æ¯ã€‚</li>
</ul>
</div>