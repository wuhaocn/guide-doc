<header class="article-header">
<h1 class="article-title">æºç åˆ†æ &mdash;&mdash; æ‹“å±•æœºåˆ¶ SPI</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<blockquote>
<p>ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨<strong>å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘</strong>æœ‰ç¦åˆ©ï¼š</p>
<ol>
<li>RocketMQ / MyCAT / Sharding-JDBC&nbsp;<strong>æ‰€æœ‰</strong>æºç åˆ†ææ–‡ç« åˆ—è¡¨</li>
<li>RocketMQ / MyCAT / Sharding-JDBC&nbsp;<strong>ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€</strong></li>
<li>æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€<strong>éƒ½</strong>å°†å¾—åˆ°<strong>è®¤çœŸ</strong>å›å¤ã€‚<strong>ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢</strong>ã€‚</li>
<li><strong>æ–°çš„</strong>æºç è§£ææ–‡ç« <strong>å®æ—¶</strong>æ”¶åˆ°é€šçŸ¥ã€‚<strong>æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³</strong>ã€‚</li>
<li><strong>è®¤çœŸçš„</strong>æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚</li>
</ol>
</blockquote>
<hr />
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<blockquote>
<p>è‰¿è‰¿çš„å‹æƒ…æç¤ºï¼š</p>
<p>è¿™æ˜¯ä¸€ç¯‡ç›¸å¯¹é•¿çš„æ–‡ç« ã€‚</p>
<p>èƒ–å‹å¯ä»¥å¸¦ç€è¿™æ ·çš„æ€ç»´æ¥ç†è§£ Dubbo SPI ï¼Œå®ƒæä¾›äº† Spring IOCã€AOP çš„åŠŸèƒ½ã€‚ğŸ˜ˆ</p>
</blockquote>
<p>æœ¬æ–‡ä¸»è¦åˆ†äº«&nbsp;<strong>Dubbo çš„æ‹“å±•æœºåˆ¶ SPI</strong>ã€‚</p>
<p>æƒ³è¦ç†è§£ Dubbo ï¼Œç†è§£ Dubbo SPI æ˜¯éå¸¸å¿…é¡»çš„ã€‚åœ¨ Dubbo ä¸­ï¼Œæä¾›äº†å¤§é‡çš„<strong>æ‹“å±•ç‚¹</strong>ï¼ŒåŸºäº Dubbo SPI æœºåˆ¶åŠ è½½ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_03_04/01.png" alt="Dubbo æ‹“å±•ç‚¹" /></p>
<h1 id="2-æ”¹è¿›">2. æ”¹è¿›</h1>
<p>åœ¨çœ‹å…·ä½“çš„ Dubbo SPI å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç†è§£ Dubbo SPI äº§ç”Ÿçš„èƒŒæ™¯ï¼š</p>
<blockquote>
<p>FROM&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/dev/SPI.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo å¼€å‘æŒ‡å— &mdash;&mdash; æ‹“å±•ç‚¹åŠ è½½ã€‹</a></p>
<p>Dubbo çš„æ‰©å±•ç‚¹åŠ è½½ä» JDK æ ‡å‡†çš„ SPI (Service Provider Interface) æ‰©å±•ç‚¹å‘ç°æœºåˆ¶åŠ å¼ºè€Œæ¥ã€‚</p>
<p>Dubbo æ”¹è¿›äº† JDK æ ‡å‡†çš„ SPI çš„ä»¥ä¸‹é—®é¢˜ï¼š</p>
<ol>
<li>JDK æ ‡å‡†çš„ SPI ä¼šä¸€æ¬¡æ€§å®ä¾‹åŒ–æ‰©å±•ç‚¹æ‰€æœ‰å®ç°ï¼Œå¦‚æœæœ‰æ‰©å±•å®ç°åˆå§‹åŒ–å¾ˆè€—æ—¶ï¼Œä½†å¦‚æœæ²¡ç”¨ä¸Šä¹ŸåŠ è½½ï¼Œä¼šå¾ˆæµªè´¹èµ„æºã€‚</li>
<li>å¦‚æœæ‰©å±•ç‚¹åŠ è½½å¤±è´¥ï¼Œè¿æ‰©å±•ç‚¹çš„åç§°éƒ½æ‹¿ä¸åˆ°äº†ã€‚æ¯”å¦‚ï¼šJDK æ ‡å‡†çš„ ScriptEngineï¼Œé€šè¿‡ getName() è·å–è„šæœ¬ç±»å‹çš„åç§°ï¼Œä½†å¦‚æœ RubyScriptEngine å› ä¸ºæ‰€ä¾èµ–çš„ jruby.jar ä¸å­˜åœ¨ï¼Œå¯¼è‡´ RubyScriptEngine ç±»åŠ è½½å¤±è´¥ï¼Œè¿™ä¸ªå¤±è´¥åŸå› è¢«åƒæ‰äº†ï¼Œå’Œ ruby å¯¹åº”ä¸èµ·æ¥ï¼Œå½“ç”¨æˆ·æ‰§è¡Œ ruby è„šæœ¬æ—¶ï¼Œä¼šæŠ¥ä¸æ”¯æŒ rubyï¼Œè€Œä¸æ˜¯çœŸæ­£å¤±è´¥çš„åŸå› ã€‚</li>
<li>å¢åŠ äº†å¯¹æ‰©å±•ç‚¹ IoC å’Œ AOP çš„æ”¯æŒï¼Œä¸€ä¸ªæ‰©å±•ç‚¹å¯ä»¥ç›´æ¥ setter æ³¨å…¥å…¶å®ƒæ‰©å±•ç‚¹ã€‚</li>
</ol>
</blockquote>
<ul>
<li>Dubbo è‡ªå·±å®ç°äº†ä¸€å¥— SPI æœºåˆ¶ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ Java æ ‡å‡†çš„ SPI ã€‚</li>
<li>ç¬¬ä¸€ç‚¹é—®é¢˜ï¼ŒDubbo æœ‰å¾ˆå¤šçš„æ‹“å±•ç‚¹ï¼Œä¾‹å¦‚ Protocolã€Filter ç­‰ç­‰ã€‚å¹¶ä¸”æ¯ä¸ªæ‹“å±•ç‚¹æœ‰å¤šç§çš„å®ç°ï¼Œä¾‹å¦‚ Protocol æœ‰ DubboProtocolã€InjvmProtocolã€RestProtocol ç­‰ç­‰ã€‚é‚£ä¹ˆä½¿ç”¨ JDK SPI æœºåˆ¶ï¼Œä¼šåˆå§‹åŒ–æ— ç”¨çš„æ‹“å±•ç‚¹åŠå…¶å®ç°ï¼Œé€ æˆä¸å¿…è¦çš„è€—æ—¶ä¸èµ„æºæµªè´¹ã€‚
<ul>
<li>å¦‚æœæ— æ³•ç†è§£çš„èƒ–å‹ï¼Œè·Ÿç€&nbsp;<a href="http://blog.csdn.net/top_code/article/details/51934459" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠJava SPI(Service Provider Interface)ç®€ä»‹ã€‹</a>&nbsp;æ–‡ç« ï¼Œ<strong>å†™å¤šä¸ªæ‹“å±•å®ç°</strong>ï¼Œå°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚ğŸ™‚ è¿™å°±æ˜¯æ¦‚å¿µå‘€ã€‚</li>
</ul>
</li>
<li>ç¬¬äºŒç‚¹é—®é¢˜ï¼Œã€TODO 8009ã€‘ScriptEngine æ²¡çœ‹æ˜ç™½ï¼Œä¸å½±å“æœ¬æ–‡ç†è§£ã€‚</li>
<li>ç¬¬ä¸‰ç‚¹é—®é¢˜ï¼Œä¸¥æ ¼æ¥è¯´ï¼Œè¿™ä¸ç®—é—®é¢˜ï¼Œ<strong>è€Œæ˜¯å¢åŠ äº†åŠŸèƒ½ç‰¹æ€§</strong>ï¼Œåœ¨ä¸‹æ–‡æˆ‘ä»¬ä¼šçœ‹åˆ°ã€‚</li>
</ul>
<h1 id="3-ä»£ç ç»“æ„">3. ä»£ç ç»“æ„</h1>
<p>Dubbo SPI åœ¨&nbsp;<code>dubbo-common</code>&nbsp;çš„&nbsp;<a href="https://github.com/YunaiV/dubbo/tree/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension" target="_blank" rel="external nofollow noopener noreferrer"><code>extension</code></a>&nbsp;åŒ…å®ç°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_03_04/02.png" alt="ä»£ç ç»“æ„" /></p>
<h1 id="4-ExtensionLoader">4. ExtensionLoader</h1>
<p><a href="http://svip.iocoder.cn/Dubbo/spi/ExtensionLoader"><code>com.alibaba.dubbo.common.extension.ExtensionLoader</code></a>&nbsp;ï¼Œæ‹“å±•åŠ è½½å™¨ã€‚è¿™æ˜¯ Dubbo SPI çš„<strong>æ ¸å¿ƒ</strong>ã€‚</p>
<h2 id="4-1-å±æ€§">4.1 å±æ€§</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">  <span class="number">1</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICES_DIRECTORY = <span class="string">"META-INF/services/"</span>;</span><br /><span class="line">  <span class="number">2</span>: </span><br /><span class="line">  <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DUBBO_DIRECTORY = <span class="string">"META-INF/dubbo/"</span>;</span><br /><span class="line">  <span class="number">4</span>: </span><br /><span class="line">  <span class="number">5</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DUBBO_INTERNAL_DIRECTORY = DUBBO_DIRECTORY + <span class="string">"internal/"</span>;</span><br /><span class="line">  <span class="number">6</span>: </span><br /><span class="line">  <span class="number">7</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Pattern NAME_SEPARATOR = Pattern.compile(<span class="string">"\\s*[,]+\\s*"</span>);</span><br /><span class="line">  <span class="number">8</span>: </span><br /><span class="line">  <span class="number">9</span>: <span class="comment">// ============================== é™æ€å±æ€§ ==============================</span></span><br /><span class="line"> <span class="number">10</span>: </span><br /><span class="line"> <span class="number">11</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 12:  * æ‹“å±•åŠ è½½å™¨é›†åˆ</span></span><br /><span class="line"><span class="comment"> 13:  *</span></span><br /><span class="line"><span class="comment"> 14:  * keyï¼šæ‹“å±•æ¥å£</span></span><br /><span class="line"><span class="comment"> 15:  */</span></span><br /><span class="line"> <span class="number">16</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt; EXTENSION_LOADERS = <span class="keyword">new</span> ConcurrentHashMap&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt;();</span><br /><span class="line"> <span class="number">17</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 18:  * æ‹“å±•å®ç°ç±»é›†åˆ</span></span><br /><span class="line"><span class="comment"> 19:  *</span></span><br /><span class="line"><span class="comment"> 20:  * keyï¼šæ‹“å±•å®ç°ç±»</span></span><br /><span class="line"><span class="comment"> 21:  * valueï¼šæ‹“å±•å¯¹è±¡ã€‚</span></span><br /><span class="line"><span class="comment"> 22:  *</span></span><br /><span class="line"><span class="comment"> 23:  * ä¾‹å¦‚ï¼Œkey ä¸º Class&lt;AccessLogFilter&gt;</span></span><br /><span class="line"><span class="comment"> 24:  *  value ä¸º AccessLogFilter å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> 25:  */</span></span><br /><span class="line"> <span class="number">26</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;Class&lt;?&gt;, Object&gt; EXTENSION_INSTANCES = <span class="keyword">new</span> ConcurrentHashMap&lt;Class&lt;?&gt;, Object&gt;();</span><br /><span class="line"> <span class="number">27</span>: </span><br /><span class="line"> <span class="number">28</span>: <span class="comment">// ============================== å¯¹è±¡å±æ€§ ==============================</span></span><br /><span class="line"> <span class="number">29</span>: </span><br /><span class="line"> <span class="number">30</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 31:  * æ‹“å±•æ¥å£ã€‚</span></span><br /><span class="line"><span class="comment"> 32:  * ä¾‹å¦‚ï¼ŒProtocol</span></span><br /><span class="line"><span class="comment"> 33:  */</span></span><br /><span class="line"> <span class="number">34</span>: <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; type;</span><br /><span class="line"> <span class="number">35</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 36:  * å¯¹è±¡å·¥å‚</span></span><br /><span class="line"><span class="comment"> 37:  *</span></span><br /><span class="line"><span class="comment"> 38:  * ç”¨äºè°ƒç”¨ {<span class="doctag">@link</span> #injectExtension(Object)} æ–¹æ³•ï¼Œå‘æ‹“å±•å¯¹è±¡æ³¨å…¥ä¾èµ–å±æ€§ã€‚</span></span><br /><span class="line"><span class="comment"> 39:  *</span></span><br /><span class="line"><span class="comment"> 40:  * ä¾‹å¦‚ï¼ŒStubProxyFactoryWrapper ä¸­æœ‰ `Protocol protocol` å±æ€§ã€‚</span></span><br /><span class="line"><span class="comment"> 41:  */</span></span><br /><span class="line"> <span class="number">42</span>: <span class="keyword">private</span> <span class="keyword">final</span> ExtensionFactory objectFactory;</span><br /><span class="line"> <span class="number">43</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 44:  * ç¼“å­˜çš„æ‹“å±•åä¸æ‹“å±•ç±»çš„æ˜ å°„ã€‚</span></span><br /><span class="line"><span class="comment"> 45:  *</span></span><br /><span class="line"><span class="comment"> 46:  * å’Œ {<span class="doctag">@link</span> #cachedClasses} çš„ KV å¯¹è°ƒã€‚</span></span><br /><span class="line"><span class="comment"> 47:  *</span></span><br /><span class="line"><span class="comment"> 48:  * é€šè¿‡ {<span class="doctag">@link</span> #loadExtensionClasses} åŠ è½½</span></span><br /><span class="line"><span class="comment"> 49:  */</span></span><br /><span class="line"> <span class="number">50</span>: <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Class&lt;?&gt;, String&gt; cachedNames = <span class="keyword">new</span> ConcurrentHashMap&lt;Class&lt;?&gt;, String&gt;();</span><br /><span class="line"> <span class="number">51</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 52:  * ç¼“å­˜çš„æ‹“å±•å®ç°ç±»é›†åˆã€‚</span></span><br /><span class="line"><span class="comment"> 53:  *</span></span><br /><span class="line"><span class="comment"> 54:  * ä¸åŒ…å«å¦‚ä¸‹ä¸¤ç§ç±»å‹ï¼š</span></span><br /><span class="line"><span class="comment"> 55:  *  1. è‡ªé€‚åº”æ‹“å±•å®ç°ç±»ã€‚ä¾‹å¦‚ AdaptiveExtensionFactory</span></span><br /><span class="line"><span class="comment"> 56:  *  2. å¸¦å”¯ä¸€å‚æ•°ä¸ºæ‹“å±•æ¥å£çš„æ„é€ æ–¹æ³•çš„å®ç°ç±»ï¼Œæˆ–è€…è¯´æ‹“å±• Wrapper å®ç°ç±»ã€‚ä¾‹å¦‚ï¼ŒProtocolFilterWrapper ã€‚</span></span><br /><span class="line"><span class="comment"> 57:  *   æ‹“å±• Wrapper å®ç°ç±»ï¼Œä¼šæ·»åŠ åˆ° {<span class="doctag">@link</span> #cachedWrapperClasses} ä¸­</span></span><br /><span class="line"><span class="comment"> 58:  *</span></span><br /><span class="line"><span class="comment"> 59:  * é€šè¿‡ {<span class="doctag">@link</span> #loadExtensionClasses} åŠ è½½</span></span><br /><span class="line"><span class="comment"> 60:  */</span></span><br /><span class="line"> <span class="number">61</span>: <span class="keyword">private</span> <span class="keyword">final</span> Holder&lt;Map&lt;String, Class&lt;?&gt;&gt;&gt; cachedClasses = <span class="keyword">new</span> Holder&lt;Map&lt;String, Class&lt;?&gt;&gt;&gt;();</span><br /><span class="line"> <span class="number">62</span>: </span><br /><span class="line"> <span class="number">63</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 64:  * æ‹“å±•åä¸ <span class="doctag">@Activate</span> çš„æ˜ å°„</span></span><br /><span class="line"><span class="comment"> 65:  *</span></span><br /><span class="line"><span class="comment"> 66:  * ä¾‹å¦‚ï¼ŒAccessLogFilterã€‚</span></span><br /><span class="line"><span class="comment"> 67:  *</span></span><br /><span class="line"><span class="comment"> 68:  * ç”¨äº {<span class="doctag">@link</span> #getActivateExtension(URL, String)}</span></span><br /><span class="line"><span class="comment"> 69:  */</span></span><br /><span class="line"> <span class="number">70</span>: <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Activate&gt; cachedActivates = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Activate&gt;();</span><br /><span class="line"> <span class="number">71</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 72:  * ç¼“å­˜çš„æ‹“å±•å¯¹è±¡é›†åˆ</span></span><br /><span class="line"><span class="comment"> 73:  *</span></span><br /><span class="line"><span class="comment"> 74:  * keyï¼šæ‹“å±•å</span></span><br /><span class="line"><span class="comment"> 75:  * valueï¼šæ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> 76:  *</span></span><br /><span class="line"><span class="comment"> 77:  * ä¾‹å¦‚ï¼ŒProtocol æ‹“å±•</span></span><br /><span class="line"><span class="comment"> 78:  *      keyï¼šdubbo valueï¼šDubboProtocol</span></span><br /><span class="line"><span class="comment"> 79:  *      keyï¼šinjvm valueï¼šInjvmProtocol</span></span><br /><span class="line"><span class="comment"> 80:  *</span></span><br /><span class="line"><span class="comment"> 81:  * é€šè¿‡ {<span class="doctag">@link</span> #loadExtensionClasses} åŠ è½½</span></span><br /><span class="line"><span class="comment"> 82:  */</span></span><br /><span class="line"> <span class="number">83</span>: <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, Holder&lt;Object&gt;&gt; cachedInstances = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Holder&lt;Object&gt;&gt;();</span><br /><span class="line"> <span class="number">84</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 85:  * ç¼“å­˜çš„è‡ªé€‚åº”( Adaptive )æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> 86:  */</span></span><br /><span class="line"> <span class="number">87</span>: <span class="keyword">private</span> <span class="keyword">final</span> Holder&lt;Object&gt; cachedAdaptiveInstance = <span class="keyword">new</span> Holder&lt;Object&gt;();</span><br /><span class="line"> <span class="number">88</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 89:  * ç¼“å­˜çš„è‡ªé€‚åº”æ‹“å±•å¯¹è±¡çš„ç±»</span></span><br /><span class="line"><span class="comment"> 90:  *</span></span><br /><span class="line"><span class="comment"> 91:  * {<span class="doctag">@link</span> #getAdaptiveExtensionClass()}</span></span><br /><span class="line"><span class="comment"> 92:  */</span></span><br /><span class="line"> <span class="number">93</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> Class&lt;?&gt; cachedAdaptiveClass = <span class="keyword">null</span>;</span><br /><span class="line"> <span class="number">94</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 95:  * ç¼“å­˜çš„é»˜è®¤æ‹“å±•å</span></span><br /><span class="line"><span class="comment"> 96:  *</span></span><br /><span class="line"><span class="comment"> 97:  * é€šè¿‡ {<span class="doctag">@link</span> SPI} æ³¨è§£è·å¾—</span></span><br /><span class="line"><span class="comment"> 98:  */</span></span><br /><span class="line"> <span class="number">99</span>: <span class="keyword">private</span> String cachedDefaultName;</span><br /><span class="line"><span class="number">100</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">101:  * åˆ›å»º {<span class="doctag">@link</span> #cachedAdaptiveInstance} æ—¶å‘ç”Ÿçš„å¼‚å¸¸ã€‚</span></span><br /><span class="line"><span class="comment">102:  *</span></span><br /><span class="line"><span class="comment">103:  * å‘ç”Ÿå¼‚å¸¸åï¼Œä¸å†åˆ›å»ºï¼Œå‚è§ {<span class="doctag">@link</span> #createAdaptiveExtension()}</span></span><br /><span class="line"><span class="comment">104:  */</span></span><br /><span class="line"><span class="number">105</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> Throwable createAdaptiveInstanceError;</span><br /><span class="line"><span class="number">106</span>: </span><br /><span class="line"><span class="number">107</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">108:  * æ‹“å±• Wrapper å®ç°ç±»é›†åˆ</span></span><br /><span class="line"><span class="comment">109:  *</span></span><br /><span class="line"><span class="comment">110:  * å¸¦å”¯ä¸€å‚æ•°ä¸ºæ‹“å±•æ¥å£çš„æ„é€ æ–¹æ³•çš„å®ç°ç±»</span></span><br /><span class="line"><span class="comment">111:  *</span></span><br /><span class="line"><span class="comment">112:  * é€šè¿‡ {<span class="doctag">@link</span> #loadExtensionClasses} åŠ è½½</span></span><br /><span class="line"><span class="comment">113:  */</span></span><br /><span class="line"><span class="number">114</span>: <span class="keyword">private</span> Set&lt;Class&lt;?&gt;&gt; cachedWrapperClasses;</span><br /><span class="line"><span class="number">115</span>: </span><br /><span class="line"><span class="number">116</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">117:  * æ‹“å±•å ä¸ åŠ è½½å¯¹åº”æ‹“å±•ç±»å‘ç”Ÿçš„å¼‚å¸¸ çš„ æ˜ å°„</span></span><br /><span class="line"><span class="comment">118:  *</span></span><br /><span class="line"><span class="comment">119:  * keyï¼šæ‹“å±•å</span></span><br /><span class="line"><span class="comment">120:  * valueï¼šå¼‚å¸¸</span></span><br /><span class="line"><span class="comment">121:  *</span></span><br /><span class="line"><span class="comment">122:  * åœ¨ {<span class="doctag">@link</span> #loadFile(Map, String)} æ—¶ï¼Œè®°å½•</span></span><br /><span class="line"><span class="comment">123:  */</span></span><br /><span class="line"><span class="number">124</span>: <span class="keyword">private</span> Map&lt;String, IllegalStateException&gt; exceptions = <span class="keyword">new</span> ConcurrentHashMap&lt;String, IllegalStateException&gt;();</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 1 è‡³ 5 è¡Œï¼šåœ¨&nbsp;<code>META-INF/dubbo/internal/</code>&nbsp;å’Œ&nbsp;<code>META-INF/dubbo/</code>&nbsp;ç›®å½•ä¸‹ï¼Œæ”¾ç½®&nbsp;<strong>æ¥å£å…¨é™å®šå</strong>&nbsp;é…ç½®æ–‡ä»¶ï¼Œ<strong>æ¯è¡Œ</strong>å†…å®¹ä¸ºï¼š<strong>æ‹“å±•å=æ‹“å±•å®ç°ç±»å…¨é™å®šå</strong>ã€‚
<ul>
<li><code>META-INF/dubbo/internal/</code>&nbsp;ç›®å½•ä¸‹ï¼Œä»åå­—ä¸Šå¯ä»¥çœ‹å‡ºï¼Œç”¨äº Dubbo&nbsp;<strong>å†…éƒ¨</strong>æä¾›çš„æ‹“å±•å®ç°ã€‚ä¸‹å›¾æ˜¯ä¸€ä¸ªä¾‹å­ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_03_04/03.png" alt="META-INF/dubbo/internal/ ä¾‹å­" /></li>
<li><code>META-INF/dubbo/</code>&nbsp;ç›®å½•ä¸‹ï¼Œç”¨äºç”¨æˆ·<strong>è‡ªå®šä¹‰</strong>çš„æ‹“å±•å®ç°ã€‚</li>
<li><code>META-INF/service/</code>&nbsp;ç›®å½•ä¸‹ï¼ŒJava SPI çš„é…ç½®ç›®å½•ã€‚åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/">ã€Œ4.2 åŠ è½½æ‹“å±•é…ç½®ã€</a>&nbsp;ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ° Dubbo SPI å¯¹ Java SPI åšäº†<strong>å…¼å®¹</strong>ã€‚</li>
</ul>
</li>
<li>ç¬¬ 7 è¡Œï¼š<code>NAME_SEPARATOR</code>&nbsp;ï¼Œæ‹“å±•ååˆ†éš”ç¬¦ï¼Œä½¿ç”¨<strong>é€—å·</strong>ã€‚</li>
<li><strong>ç¬¬ 9 è‡³ 124 è¡Œ</strong>ï¼Œæˆ‘ä»¬å°†å±æ€§åˆ†æˆäº†ä¸¤ç±»ï¼š1ï¼‰é™æ€å±æ€§ï¼›2ï¼‰å¯¹è±¡å±æ€§ã€‚è¿™æ˜¯ä¸ºå•¥å‘¢ï¼Ÿ
<ul>
<li>ã€é™æ€å±æ€§ã€‘ä¸€æ–¹é¢ï¼ŒExtensionLoader æ˜¯ ExtensionLoader çš„<strong>ç®¡ç†å®¹å™¨</strong>ã€‚ä¸€ä¸ªæ‹“å±•( æ‹“å±•æ¥å£ )å¯¹åº”ä¸€ä¸ª ExtensionLoader å¯¹è±¡ã€‚ä¾‹å¦‚ï¼ŒProtocol å’Œ Filter&nbsp;<strong>åˆ†åˆ«</strong>å¯¹åº”ä¸€ä¸ª ExtensionLoader å¯¹è±¡ã€‚</li>
<li>ã€å¯¹è±¡å±æ€§ã€‘å¦ä¸€æ–¹é¢ï¼Œä¸€ä¸ªæ‹“å±•é€šè¿‡å…¶ ExtensionLoader å¯¹è±¡ï¼ŒåŠ è½½å®ƒçš„<strong>æ‹“å±•å®ç°ä»¬</strong>ã€‚æˆ‘ä»¬ä¼šå‘ç°å¤šä¸ªå±æ€§éƒ½æ˜¯ &ldquo;<strong>cached</strong>&ldquo; å¼€å¤´ã€‚ExtensionLoader è€ƒè™‘åˆ°æ€§èƒ½å’Œèµ„æºçš„ä¼˜åŒ–ï¼Œè¯»å–æ‹“å±•é…ç½®åï¼Œä¼šé¦–å…ˆè¿›è¡Œ<strong>ç¼“å­˜</strong>ã€‚ç­‰åˆ° Dubbo ä»£ç <strong>çœŸæ­£</strong>ç”¨åˆ°å¯¹åº”çš„æ‹“å±•å®ç°æ—¶ï¼Œè¿›è¡Œæ‹“å±•å®ç°çš„å¯¹è±¡çš„åˆå§‹åŒ–ã€‚å¹¶ä¸”ï¼Œåˆå§‹åŒ–å®Œæˆåï¼Œä¹Ÿä¼šè¿›è¡Œ<strong>ç¼“å­˜</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š
<ul>
<li>ç¼“å­˜åŠ è½½çš„æ‹“å±•é…ç½®</li>
<li>ç¼“å­˜åˆ›å»ºçš„æ‹“å±•å®ç°å¯¹è±¡</li>
</ul>
</li>
</ul>
</li>
<li>ğŸ™‚ èƒ–å‹å…ˆçœ‹ä¸‹å±æ€§çš„ä»£ç æ³¨é‡Šï¼Œæœ‰ä¸€ä¸ªæ•´ä½“çš„å°è±¡ã€‚ä¸‹é¢æˆ‘ä»¬åœ¨è¯»å®ç°ä»£ç æ—¶ï¼Œä¼šè¿›ä¸€æ­¥è§£æè¯´æ˜ã€‚</li>
</ul>
<hr />
<p>è€ƒè™‘åˆ°èƒ–å‹èƒ½æ›´å¥½çš„ç†è§£ä¸‹é¢çš„ä»£ç å®ç°ï¼Œæ¨èå…ˆé˜…è¯»ä¸‹&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/dev/SPI.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo å¼€å‘æŒ‡å— &mdash;&mdash; æ‰©å±•ç‚¹åŠ è½½ã€‹</a>&nbsp;æ–‡æ¡£ï¼Œå»ºç«‹ä¸‹å¯¹ ExtensionLoader ç‰¹ç‚¹çš„åˆæ­¥ç†è§£ï¼š</p>
<ul>
<li>æ‰©å±•ç‚¹è‡ªåŠ¨åŒ…è£…
<ul>
<li>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/">ã€Œ4.4.2 createExtensionã€</a>&nbsp;è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>æ‰©å±•ç‚¹è‡ªåŠ¨è£…é…
<ul>
<li>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/">ã€Œ4.4.3 injectExtensionã€</a>&nbsp;è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>æ‰©å±•ç‚¹è‡ªé€‚åº”
<ul>
<li>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/">ã€Œ4.5 è·å¾—è‡ªé€‚åº”çš„æ‹“å±•å¯¹è±¡ã€</a>&nbsp;è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>æ‰©å±•ç‚¹è‡ªåŠ¨æ¿€æ´»
<ul>
<li>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/">ã€Œ4.6 è·å¾—æ¿€æ´»çš„æ‹“å±•å¯¹è±¡æ•°ç»„ã€</a>&nbsp;è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
</ul>
<h2 id="4-2-è·å¾—æ‹“å±•é…ç½®">4.2 è·å¾—æ‹“å±•é…ç½®</h2>
<h3 id="4-2-1-getExtensionClasses">4.2.1 getExtensionClasses</h3>
<p><code>#getExtensionClasses()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æ‹“å±•å®ç°ç±»æ•°ç»„ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Holder&lt;Map&lt;String, Class&lt;?&gt;&gt;&gt; cachedClasses = <span class="keyword">new</span> Holder&lt;Map&lt;String, Class&lt;?&gt;&gt;&gt;();</span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Class&lt;?&gt; cachedAdaptiveClass = <span class="keyword">null</span>;</span><br /><br /><span class="line"><span class="keyword">private</span> Set&lt;Class&lt;?&gt;&gt; cachedWrapperClasses;</span><br /><br /><span class="line">  <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">  2:  * è·å¾—æ‹“å±•å®ç°ç±»æ•°ç»„</span></span><br /><span class="line"><span class="comment">  3:  *</span></span><br /><span class="line"><span class="comment">  4:  * <span class="doctag">@return</span> æ‹“å±•å®ç°ç±»æ•°ç»„</span></span><br /><span class="line"><span class="comment">  5:  */</span></span><br /><span class="line">  <span class="number">6</span>: <span class="keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; getExtensionClasses() {</span><br /><span class="line">  <span class="number">7</span>:     <span class="comment">// ä»ç¼“å­˜ä¸­ï¼Œè·å¾—æ‹“å±•å®ç°ç±»æ•°ç»„</span></span><br /><span class="line">  <span class="number">8</span>:     Map&lt;String, Class&lt;?&gt;&gt; classes = cachedClasses.get();</span><br /><span class="line">  <span class="number">9</span>:     <span class="keyword">if</span> (classes == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">10</span>:         <span class="keyword">synchronized</span> (cachedClasses) {</span><br /><span class="line"> <span class="number">11</span>:             classes = cachedClasses.get();</span><br /><span class="line"> <span class="number">12</span>:             <span class="keyword">if</span> (classes == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">13</span>:                 <span class="comment">// ä»é…ç½®æ–‡ä»¶ä¸­ï¼ŒåŠ è½½æ‹“å±•å®ç°ç±»æ•°ç»„</span></span><br /><span class="line"> <span class="number">14</span>:                 classes = loadExtensionClasses();</span><br /><span class="line"> <span class="number">15</span>:                 <span class="comment">// è®¾ç½®åˆ°ç¼“å­˜ä¸­</span></span><br /><span class="line"> <span class="number">16</span>:                 cachedClasses.set(classes);</span><br /><span class="line"> <span class="number">17</span>:             }</span><br /><span class="line"> <span class="number">18</span>:         }</span><br /><span class="line"> <span class="number">19</span>:     }</span><br /><span class="line"> <span class="number">20</span>:     <span class="keyword">return</span> classes;</span><br /><span class="line"> <span class="number">21</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>cachedClasses</code>&nbsp;å±æ€§ï¼Œç¼“å­˜çš„æ‹“å±•å®ç°ç±»é›†åˆã€‚å®ƒä¸åŒ…å«å¦‚ä¸‹ä¸¤ç§ç±»å‹çš„æ‹“å±•å®ç°ï¼š
<ul>
<li><strong>è‡ªé€‚åº”</strong>æ‹“å±•å®ç°ç±»ã€‚ä¾‹å¦‚ AdaptiveExtensionFactory ã€‚
<ul>
<li>æ‹“å±• Adaptive å®ç°ç±»ï¼Œä¼šæ·»åŠ åˆ°&nbsp;<code>cachedAdaptiveClass</code>&nbsp;å±æ€§ä¸­ã€‚</li>
</ul>
</li>
<li>å¸¦<strong>å”¯ä¸€å‚æ•°ä¸ºæ‹“å±•æ¥å£</strong>çš„æ„é€ æ–¹æ³•çš„å®ç°ç±»ï¼Œæˆ–è€…è¯´æ‹“å±• Wrapper å®ç°ç±»ã€‚ä¾‹å¦‚ï¼ŒProtocolFilterWrapper ã€‚
<ul>
<li>æ‹“å±• Wrapper å®ç°ç±»ï¼Œä¼šæ·»åŠ åˆ°&nbsp;<code>cachedWrapperClasses</code>&nbsp;å±æ€§ä¸­ã€‚</li>
</ul>
</li>
<li>æ€»ç»“æ¥è¯´ï¼Œ<code>cachedClasses</code>&nbsp;+&nbsp;<code>cachedAdaptiveClass</code>&nbsp;+&nbsp;<code>cachedWrapperClasses</code>&nbsp;æ‰æ˜¯<strong>å®Œæ•´</strong>ç¼“å­˜çš„æ‹“å±•å®ç°ç±»çš„é…ç½®ã€‚</li>
</ul>
</li>
<li>ç¬¬ 7 è‡³ 11 è¡Œï¼šä»ç¼“å­˜ä¸­ï¼Œè·å¾—æ‹“å±•å®ç°ç±»æ•°ç»„ã€‚</li>
<li>ç¬¬ 12 è‡³ 14 è¡Œï¼šå½“ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œè°ƒç”¨&nbsp;<code>#loadExtensionClasses()</code>&nbsp;æ–¹æ³•ï¼Œä»é…ç½®æ–‡ä»¶ä¸­ï¼ŒåŠ è½½æ‹“å±•å®ç°ç±»æ•°ç»„ã€‚</li>
<li>ç¬¬ 16 è¡Œï¼šè®¾ç½®åŠ è½½çš„å®ç°ç±»æ•°ç»„ï¼Œåˆ°ç¼“å­˜ä¸­ã€‚</li>
</ul>
<h3 id="4-2-2-loadExtensionClasses">4.2.2 loadExtensionClasses</h3>
<p><code>#loadExtensionClasses()</code>&nbsp;æ–¹æ³•ï¼Œä»<strong>å¤šä¸ª</strong>é…ç½®æ–‡ä»¶ä¸­ï¼ŒåŠ è½½æ‹“å±•å®ç°ç±»æ•°ç»„ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * åŠ è½½æ‹“å±•å®ç°ç±»æ•°ç»„</span></span><br /><span class="line"><span class="comment"> 3:  *</span></span><br /><span class="line"><span class="comment"> 4:  * æ— éœ€å£°æ˜ synchronized ï¼Œå› ä¸ºå”¯ä¸€è°ƒç”¨è¯¥æ–¹æ³•çš„ {<span class="doctag">@link</span> #getExtensionClasses()} å·²ç»å£°æ˜ã€‚</span></span><br /><span class="line"><span class="comment"> 5:  * // synchronized in getExtensionClasses</span></span><br /><span class="line"><span class="comment"> 6:  *</span></span><br /><span class="line"><span class="comment"> 7:  * <span class="doctag">@return</span> æ‹“å±•å®ç°ç±»æ•°ç»„</span></span><br /><span class="line"><span class="comment"> 8:  */</span></span><br /><span class="line"> <span class="number">9</span>: <span class="keyword">private</span> Map&lt;String, Class&lt;?&gt;&gt; loadExtensionClasses() {</span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// é€šè¿‡ @SPI æ³¨è§£ï¼Œè·å¾—é»˜è®¤çš„æ‹“å±•å®ç°ç±»å</span></span><br /><span class="line"><span class="number">11</span>:     <span class="keyword">final</span> SPI defaultAnnotation = type.getAnnotation(SPI.class);</span><br /><span class="line"><span class="number">12</span>:     <span class="keyword">if</span> (defaultAnnotation != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">13</span>:         String value = defaultAnnotation.value();</span><br /><span class="line"><span class="number">14</span>:         <span class="keyword">if</span> ((value = value.trim()).length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">15</span>:             String[] names = NAME_SEPARATOR.split(value);</span><br /><span class="line"><span class="number">16</span>:             <span class="keyword">if</span> (names.length &gt; <span class="number">1</span>) {</span><br /><span class="line"><span class="number">17</span>:                 <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"more than 1 default extension name on extension "</span> + type.getName()</span><br /><span class="line"><span class="number">18</span>:                         + <span class="string">": "</span> + Arrays.toString(names));</span><br /><span class="line"><span class="number">19</span>:             }</span><br /><span class="line"><span class="number">20</span>:             <span class="keyword">if</span> (names.length == <span class="number">1</span>) cachedDefaultName = names[<span class="number">0</span>];</span><br /><span class="line"><span class="number">21</span>:         }</span><br /><span class="line"><span class="number">22</span>:     }</span><br /><span class="line"><span class="number">23</span>: </span><br /><span class="line"><span class="number">24</span>:     <span class="comment">// ä»é…ç½®æ–‡ä»¶ä¸­ï¼ŒåŠ è½½æ‹“å±•å®ç°ç±»æ•°ç»„</span></span><br /><span class="line"><span class="number">25</span>:     Map&lt;String, Class&lt;?&gt;&gt; extensionClasses = <span class="keyword">new</span> HashMap&lt;String, Class&lt;?&gt;&gt;();</span><br /><span class="line"><span class="number">26</span>:     loadFile(extensionClasses, DUBBO_INTERNAL_DIRECTORY);</span><br /><span class="line"><span class="number">27</span>:     loadFile(extensionClasses, DUBBO_DIRECTORY);</span><br /><span class="line"><span class="number">28</span>:     loadFile(extensionClasses, SERVICES_DIRECTORY);</span><br /><span class="line"><span class="number">29</span>:     <span class="keyword">return</span> extensionClasses;</span><br /><span class="line"><span class="number">30</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 10 è‡³ 22 è¡Œï¼šé€šè¿‡&nbsp;<code>@SPI</code>&nbsp;æ³¨è§£ï¼Œè·å¾—æ‹“å±•æ¥å£å¯¹åº”çš„<strong>é»˜è®¤çš„</strong>æ‹“å±•å®ç°ç±»åã€‚åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/">ã€Œ5. @SPIã€</a>&nbsp;è¯¦ç»†è§£æã€‚</li>
<li>ç¬¬ 25 è‡³ 29 è¡Œï¼šè°ƒç”¨&nbsp;<code>#loadFile(extensionClasses, dir)</code>&nbsp;æ–¹æ³•ï¼Œä»é…ç½®æ–‡ä»¶ä¸­ï¼ŒåŠ è½½æ‹“å±•å®ç°ç±»æ•°ç»„ã€‚<strong>æ³¨æ„</strong>ï¼Œæ­¤å¤„é…ç½®æ–‡ä»¶çš„åŠ è½½é¡ºåºã€‚</li>
</ul>
<h3 id="4-2-3-loadFile">4.2.3 loadFile</h3>
<p><code>#loadFile(extensionClasses, dir)</code>&nbsp;æ–¹æ³•ï¼Œä»<strong>ä¸€ä¸ª</strong>é…ç½®æ–‡ä»¶ä¸­ï¼ŒåŠ è½½æ‹“å±•å®ç°ç±»æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ç¼“å­˜çš„è‡ªé€‚åº”æ‹“å±•å¯¹è±¡çš„ç±»</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #getAdaptiveExtensionClass()}</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Class&lt;?&gt; cachedAdaptiveClass = <span class="keyword">null</span>;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ‹“å±• Wrapper å®ç°ç±»é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * å¸¦å”¯ä¸€å‚æ•°ä¸ºæ‹“å±•æ¥å£çš„æ„é€ æ–¹æ³•çš„å®ç°ç±»</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * é€šè¿‡ {<span class="doctag">@link</span> #loadExtensionClasses} åŠ è½½</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Set&lt;Class&lt;?&gt;&gt; cachedWrapperClasses;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ‹“å±•åä¸ <span class="doctag">@Activate</span> çš„æ˜ å°„</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * ä¾‹å¦‚ï¼ŒAccessLogFilterã€‚</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * ç”¨äº {<span class="doctag">@link</span> #getActivateExtension(URL, String)}</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Activate&gt; cachedActivates = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Activate&gt;();</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ç¼“å­˜çš„æ‹“å±•åä¸æ‹“å±•ç±»çš„æ˜ å°„ã€‚</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * å’Œ {<span class="doctag">@link</span> #cachedClasses} çš„ KV å¯¹è°ƒã€‚</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * é€šè¿‡ {<span class="doctag">@link</span> #loadExtensionClasses} åŠ è½½</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;Class&lt;?&gt;, String&gt; cachedNames = <span class="keyword">new</span> ConcurrentHashMap&lt;Class&lt;?&gt;, String&gt;();</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ‹“å±•å ä¸ åŠ è½½å¯¹åº”æ‹“å±•ç±»å‘ç”Ÿçš„å¼‚å¸¸ çš„ æ˜ å°„</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * keyï¼šæ‹“å±•å</span></span><br /><span class="line"><span class="comment"> * valueï¼šå¼‚å¸¸</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * åœ¨ {<span class="doctag">@link</span> #loadFile(Map, String)} æ—¶ï¼Œè®°å½•</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Map&lt;String, IllegalStateException&gt; exceptions = <span class="keyword">new</span> ConcurrentHashMap&lt;String, IllegalStateException&gt;();</span><br /><br /><span class="line">  <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">  2:  * ä»ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­ï¼ŒåŠ è½½æ‹“å±•å®ç°ç±»æ•°ç»„ã€‚</span></span><br /><span class="line"><span class="comment">  3:  *</span></span><br /><span class="line"><span class="comment">  4:  * <span class="doctag">@param</span> extensionClasses æ‹“å±•ç±»åæ•°ç»„</span></span><br /><span class="line"><span class="comment">  5:  * <span class="doctag">@param</span> dir æ–‡ä»¶å</span></span><br /><span class="line"><span class="comment">  6:  */</span></span><br /><span class="line">  <span class="number">7</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadFile</span><span class="params">(Map&lt;String, Class&lt;?&gt;&gt; extensionClasses, String dir)</span> </span>{</span><br /><span class="line">  <span class="number">8</span>:     <span class="comment">// å®Œæ•´çš„æ–‡ä»¶å</span></span><br /><span class="line">  <span class="number">9</span>:     String fileName = dir + type.getName();</span><br /><span class="line"> <span class="number">10</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">11</span>:         Enumeration&lt;java.net.URL&gt; urls;</span><br /><span class="line"> <span class="number">12</span>:         <span class="comment">// è·å¾—æ–‡ä»¶åå¯¹åº”çš„æ‰€æœ‰æ–‡ä»¶æ•°ç»„</span></span><br /><span class="line"> <span class="number">13</span>:         ClassLoader classLoader = findClassLoader();</span><br /><span class="line"> <span class="number">14</span>:         <span class="keyword">if</span> (classLoader != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">15</span>:             urls = classLoader.getResources(fileName);</span><br /><span class="line"> <span class="number">16</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">17</span>:             urls = ClassLoader.getSystemResources(fileName);</span><br /><span class="line"> <span class="number">18</span>:         }</span><br /><span class="line"> <span class="number">19</span>:         <span class="comment">// éå†æ–‡ä»¶æ•°ç»„</span></span><br /><span class="line"> <span class="number">20</span>:         <span class="keyword">if</span> (urls != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">21</span>:             <span class="keyword">while</span> (urls.hasMoreElements()) {</span><br /><span class="line"> <span class="number">22</span>:                 java.net.URL url = urls.nextElement();</span><br /><span class="line"> <span class="number">23</span>:                 <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">24</span>:                     BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(url.openStream(), <span class="string">"utf-8"</span>));</span><br /><span class="line"> <span class="number">25</span>:                     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">26</span>:                         String line;</span><br /><span class="line"> <span class="number">27</span>:                         <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">28</span>:                             <span class="comment">// è·³è¿‡å½“å‰è¢«æ³¨é‡Šæ‰çš„æƒ…å†µï¼Œä¾‹å¦‚ #spring=xxxxxxxxx</span></span><br /><span class="line"> <span class="number">29</span>:                             <span class="keyword">final</span> <span class="keyword">int</span> ci = line.indexOf(<span class="string">'#'</span>);</span><br /><span class="line"> <span class="number">30</span>:                             <span class="keyword">if</span> (ci &gt;= <span class="number">0</span>) line = line.substring(<span class="number">0</span>, ci);</span><br /><span class="line"> <span class="number">31</span>:                             line = line.trim();</span><br /><span class="line"> <span class="number">32</span>:                             <span class="keyword">if</span> (line.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">33</span>:                                 <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">34</span>:                                     <span class="comment">// æ‹†åˆ†ï¼Œkey=value çš„é…ç½®æ ¼å¼</span></span><br /><span class="line"> <span class="number">35</span>:                                     String name = <span class="keyword">null</span>;</span><br /><span class="line"> <span class="number">36</span>:                                     <span class="keyword">int</span> i = line.indexOf(<span class="string">'='</span>);</span><br /><span class="line"> <span class="number">37</span>:                                     <span class="keyword">if</span> (i &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">38</span>:                                         name = line.substring(<span class="number">0</span>, i).trim();</span><br /><span class="line"> <span class="number">39</span>:                                         line = line.substring(i + <span class="number">1</span>).trim();</span><br /><span class="line"> <span class="number">40</span>:                                     }</span><br /><span class="line"> <span class="number">41</span>:                                     <span class="keyword">if</span> (line.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">42</span>:                                         <span class="comment">// åˆ¤æ–­æ‹“å±•å®ç°ï¼Œæ˜¯å¦å®ç°æ‹“å±•æ¥å£</span></span><br /><span class="line"> <span class="number">43</span>:                                         Class&lt;?&gt; clazz = Class.forName(line, <span class="keyword">true</span>, classLoader);</span><br /><span class="line"> <span class="number">44</span>:                                         <span class="keyword">if</span> (!type.isAssignableFrom(clazz)) {</span><br /><span class="line"> <span class="number">45</span>:                                             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Error when load extension class(interface: "</span> +</span><br /><span class="line"> <span class="number">46</span>:                                                     type + <span class="string">", class line: "</span> + clazz.getName() + <span class="string">"), class "</span></span><br /><span class="line"> <span class="number">47</span>:                                                     + clazz.getName() + <span class="string">"is not subtype of interface."</span>);</span><br /><span class="line"> <span class="number">48</span>:                                         }</span><br /><span class="line"> <span class="number">49</span>:                                         <span class="comment">// ç¼“å­˜è‡ªé€‚åº”æ‹“å±•å¯¹è±¡çš„ç±»åˆ° `cachedAdaptiveClass`</span></span><br /><span class="line"> <span class="number">50</span>:                                         <span class="keyword">if</span> (clazz.isAnnotationPresent(Adaptive.class)) {</span><br /><span class="line"> <span class="number">51</span>:                                             <span class="keyword">if</span> (cachedAdaptiveClass == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">52</span>:                                                 cachedAdaptiveClass = clazz;</span><br /><span class="line"> <span class="number">53</span>:                                             } <span class="keyword">else</span> <span class="keyword">if</span> (!cachedAdaptiveClass.equals(clazz)) {</span><br /><span class="line"> <span class="number">54</span>:                                                 <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"More than 1 adaptive class found: "</span></span><br /><span class="line"> <span class="number">55</span>:                                                         + cachedAdaptiveClass.getClass().getName()</span><br /><span class="line"> <span class="number">56</span>:                                                         + <span class="string">", "</span> + clazz.getClass().getName());</span><br /><span class="line"> <span class="number">57</span>:                                             }</span><br /><span class="line"> <span class="number">58</span>:                                         } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">59</span>:                                             <span class="comment">// ç¼“å­˜æ‹“å±• Wrapper å®ç°ç±»åˆ° `cachedWrapperClasses`</span></span><br /><span class="line"> <span class="number">60</span>:                                             <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">61</span>:                                                 clazz.getConstructor(type);</span><br /><span class="line"> <span class="number">62</span>:                                                 Set&lt;Class&lt;?&gt;&gt; wrappers = cachedWrapperClasses;</span><br /><span class="line"> <span class="number">63</span>:                                                 <span class="keyword">if</span> (wrappers == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">64</span>:                                                     cachedWrapperClasses = <span class="keyword">new</span> ConcurrentHashSet&lt;Class&lt;?&gt;&gt;();</span><br /><span class="line"> <span class="number">65</span>:                                                     wrappers = cachedWrapperClasses;</span><br /><span class="line"> <span class="number">66</span>:                                                 }</span><br /><span class="line"> <span class="number">67</span>:                                                 wrappers.add(clazz);</span><br /><span class="line"> <span class="number">68</span>:                                             <span class="comment">// ç¼“å­˜æ‹“å±•å®ç°ç±»åˆ° `extensionClasses`</span></span><br /><span class="line"> <span class="number">69</span>:                                             } <span class="keyword">catch</span> (NoSuchMethodException e) {</span><br /><span class="line"> <span class="number">70</span>:                                                 clazz.getConstructor();</span><br /><span class="line"> <span class="number">71</span>:                                                 <span class="comment">// æœªé…ç½®æ‹“å±•åï¼Œè‡ªåŠ¨ç”Ÿæˆã€‚ä¾‹å¦‚ï¼ŒDemoFilter ä¸º demo ã€‚ä¸»è¦ç”¨äºå…¼å®¹ Java SPI çš„é…ç½®ã€‚</span></span><br /><span class="line"> <span class="number">72</span>:                                                 <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">73</span>:                                                     name = findAnnotationName(clazz);</span><br /><span class="line"> <span class="number">74</span>:                                                     <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">75</span>:                                                         <span class="keyword">if</span> (clazz.getSimpleName().length() &gt; type.getSimpleName().length()</span><br /><span class="line"> <span class="number">76</span>:                                                                 &amp;&amp; clazz.getSimpleName().endsWith(type.getSimpleName())) {</span><br /><span class="line"> <span class="number">77</span>:                                                             name = clazz.getSimpleName().substring(<span class="number">0</span>, clazz.getSimpleName().length() - type.getSimpleName().length()).toLowerCase();</span><br /><span class="line"> <span class="number">78</span>:                                                         } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">79</span>:                                                             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such extension name for the class "</span> + clazz.getName() + <span class="string">" in the config "</span> + url);</span><br /><span class="line"> <span class="number">80</span>:                                                         }</span><br /><span class="line"> <span class="number">81</span>:                                                     }</span><br /><span class="line"> <span class="number">82</span>:                                                 }</span><br /><span class="line"> <span class="number">83</span>:                                                 <span class="comment">// è·å¾—æ‹“å±•åï¼Œå¯ä»¥æ˜¯æ•°ç»„ï¼Œæœ‰å¤šä¸ªæ‹“å±•åã€‚</span></span><br /><span class="line"> <span class="number">84</span>:                                                 String[] names = NAME_SEPARATOR.split(name);</span><br /><span class="line"> <span class="number">85</span>:                                                 <span class="keyword">if</span> (names != <span class="keyword">null</span> &amp;&amp; names.length &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">86</span>:                                                     <span class="comment">// ç¼“å­˜ @Activate åˆ° `cachedActivates` ã€‚</span></span><br /><span class="line"> <span class="number">87</span>:                                                     Activate activate = clazz.getAnnotation(Activate.class);</span><br /><span class="line"> <span class="number">88</span>:                                                     <span class="keyword">if</span> (activate != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">89</span>:                                                         cachedActivates.put(names[<span class="number">0</span>], activate);</span><br /><span class="line"> <span class="number">90</span>:                                                     }</span><br /><span class="line"> <span class="number">91</span>:                                                     <span class="keyword">for</span> (String n : names) {</span><br /><span class="line"> <span class="number">92</span>:                                                         <span class="comment">// ç¼“å­˜åˆ° `cachedNames`</span></span><br /><span class="line"> <span class="number">93</span>:                                                         <span class="keyword">if</span> (!cachedNames.containsKey(clazz)) {</span><br /><span class="line"> <span class="number">94</span>:                                                             cachedNames.put(clazz, n);</span><br /><span class="line"> <span class="number">95</span>:                                                         }</span><br /><span class="line"> <span class="number">96</span>:                                                         <span class="comment">// ç¼“å­˜æ‹“å±•å®ç°ç±»åˆ° `extensionClasses`</span></span><br /><span class="line"> <span class="number">97</span>:                                                         Class&lt;?&gt; c = extensionClasses.get(n);</span><br /><span class="line"> <span class="number">98</span>:                                                         <span class="keyword">if</span> (c == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">99</span>:                                                             extensionClasses.put(n, clazz);</span><br /><span class="line"><span class="number">100</span>:                                                         } <span class="keyword">else</span> <span class="keyword">if</span> (c != clazz) {</span><br /><span class="line"><span class="number">101</span>:                                                             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Duplicate extension "</span> + type.getName() + <span class="string">" name "</span> + n + <span class="string">" on "</span> + c.getName() + <span class="string">" and "</span> + clazz.getName());</span><br /><span class="line"><span class="number">102</span>:                                                         }</span><br /><span class="line"><span class="number">103</span>:                                                     }</span><br /><span class="line"><span class="number">104</span>:                                                 }</span><br /><span class="line"><span class="number">105</span>:                                             }</span><br /><span class="line"><span class="number">106</span>:                                         }</span><br /><span class="line"><span class="number">107</span>:                                     }</span><br /><span class="line"><span class="number">108</span>:                                 } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">109</span>:                                     <span class="comment">// å‘ç”Ÿå¼‚å¸¸ï¼Œè®°å½•åˆ°å¼‚å¸¸é›†åˆ</span></span><br /><span class="line"><span class="number">110</span>:                                     IllegalStateException e = <span class="keyword">new</span> IllegalStateException(<span class="string">"Failed to load extension class(interface: "</span> + type + <span class="string">", class line: "</span> + line + <span class="string">") in "</span> + url + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">111</span>:                                     exceptions.put(line, e);</span><br /><span class="line"><span class="number">112</span>:                                 }</span><br /><span class="line"><span class="number">113</span>:                             }</span><br /><span class="line"><span class="number">114</span>:                         } <span class="comment">// end of while read lines</span></span><br /><span class="line"><span class="number">115</span>:                     } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">116</span>:                         reader.close();</span><br /><span class="line"><span class="number">117</span>:                     }</span><br /><span class="line"><span class="number">118</span>:                 } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">119</span>:                     logger.error(<span class="string">"Exception when load extension class(interface: "</span> +</span><br /><span class="line"><span class="number">120</span>:                             type + <span class="string">", class file: "</span> + url + <span class="string">") in "</span> + url, t);</span><br /><span class="line"><span class="number">121</span>:                 }</span><br /><span class="line"><span class="number">122</span>:             } <span class="comment">// end of while urls</span></span><br /><span class="line"><span class="number">123</span>:         }</span><br /><span class="line"><span class="number">124</span>:     } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">125</span>:         logger.error(<span class="string">"Exception when load extension class(interface: "</span> +</span><br /><span class="line"><span class="number">126</span>:                 type + <span class="string">", description file: "</span> + fileName + <span class="string">")."</span>, t);</span><br /><span class="line"><span class="number">127</span>:     }</span><br /><span class="line"><span class="number">128</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 9 è¡Œï¼šè·å¾—å®Œæ•´çš„æ–‡ä»¶å( ç›¸å¯¹è·¯å¾„ )ã€‚ä¾‹å¦‚ï¼š<code>"META-INF/dubbo/internal/com.alibaba.dubbo.common.extension.ExtensionFactory"</code>&nbsp;ã€‚</li>
<li>ç¬¬ 12 è‡³ 18 è¡Œï¼šè·å¾—æ–‡ä»¶åå¯¹åº”çš„æ‰€æœ‰æ–‡ä»¶ URL æ•°ç»„ã€‚ä¾‹å¦‚ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_03_04/04.png" alt="ExtensionFactory çš„é…ç½®æ–‡ä»¶" /></li>
<li>ç¬¬ 21 è‡³ 24 è¡Œï¼šé€ä¸ª<strong>æ–‡ä»¶</strong>&nbsp;URL éå†ã€‚</li>
<li>ç¬¬ 27 è¡Œï¼šé€<strong>è¡Œ</strong>éå†ã€‚</li>
<li>ç¬¬ 29 è‡³ 32 è¡Œï¼šè·³è¿‡å½“å‰è¢«&nbsp;<code>"#"</code>&nbsp;æ³¨é‡Šæ‰çš„æƒ…å†µï¼Œä¾‹å¦‚&nbsp;<code>#spring=xxxxxxxxx</code>&nbsp;ã€‚</li>
<li>ç¬¬ 34 è‡³ 40 è¡Œï¼šæŒ‰ç…§&nbsp;<code>key=value</code>&nbsp;çš„é…ç½®æ‹†åˆ†ã€‚å…¶ä¸­&nbsp;<code>name</code>&nbsp;ä¸ºæ‹“å±•åï¼Œ<code>line</code>&nbsp;ä¸ºæ‹“å±•å®ç°ç±»åã€‚<strong>æ³¨æ„</strong>ï¼Œä¸Šæ–‡æˆ‘ä»¬æåˆ°è¿‡ Dubbo SPI ä¼šå…¼å®¹ Java SPI çš„é…ç½®æ ¼å¼ï¼Œé‚£ä¹ˆæŒ‰ç…§æ­¤å¤„çš„è§£ææ–¹å¼ï¼Œ<code>name</code>&nbsp;ä¼šä¸ºç©ºã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ‹“å±•åä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œè¯¦ç»†è§ç¬¬ 71 è‡³ 82 è¡Œçš„ä»£ç ã€‚</li>
<li>ç¬¬ 42 è‡³ 48 è¡Œï¼šåˆ¤æ–­æ‹“å±•å®ç°ç±»ï¼Œéœ€è¦å®ç°æ‹“å±•æ¥å£ã€‚</li>
<li>ç¬¬ 50 è‡³ 57 è¡Œï¼šç¼“å­˜è‡ªé€‚åº”æ‹“å±•å¯¹è±¡çš„ç±»åˆ°&nbsp;<code>cachedAdaptiveClass</code>&nbsp;å±æ€§ã€‚åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/">ã€Œ6. @Adaptiveã€</a>&nbsp;è¯¦ç»†è§£æã€‚</li>
<li>ç¬¬ 59 è‡³ 67 è¡Œï¼šç¼“å­˜æ‹“å±• Wrapper å®ç°ç±»åˆ°&nbsp;<code>cachedWrapperClasses</code>&nbsp;å±æ€§ã€‚
<ul>
<li>ç¬¬ 61 è¡Œï¼šè°ƒç”¨&nbsp;<code>Class#getConstructor(Class&lt;?&gt;... parameterTypes)</code>&nbsp;æ–¹æ³•ï¼Œé€šè¿‡<strong>åå°„</strong>çš„æ–¹å¼ï¼Œå‚æ•°ä¸ºæ‹“å±•æ¥å£ï¼Œåˆ¤æ–­å½“å‰é…ç½®çš„æ‹“å±•å®ç°ç±»ä¸º<strong>æ‹“å±• Wrapper å®ç°ç±»</strong>ã€‚è‹¥æˆåŠŸï¼ˆæœªæŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œåˆ™ä»£è¡¨ç¬¦åˆæ¡ä»¶ã€‚ä¾‹å¦‚ï¼Œ<a href="https://github.com/alibaba/dubbo/blob/master/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/protocol/ProtocolFilterWrapper.java#L39-L44" target="_blank" rel="external nofollow noopener noreferrer">ProtocolFilterWrapper(Protocol protocol)</a>&nbsp;è¿™ä¸ªæ„é€ æ–¹æ³•ã€‚</li>
</ul>
</li>
<li>ç¬¬ 69 è‡³ 105 è¡Œï¼šè‹¥è·å¾—æ„é€ æ–¹æ³•å¤±è´¥ï¼Œåˆ™ä»£è¡¨æ˜¯æ™®é€šçš„æ‹“å±•å®ç°ç±»ï¼Œç¼“å­˜åˆ°&nbsp;<code>extensionClasses</code>&nbsp;<strong>å˜é‡</strong>ä¸­ã€‚
<ul>
<li>ç¬¬ 70 è¡Œï¼šè°ƒç”¨&nbsp;<code>Class#getConstructor(Class&lt;?&gt;... parameterTypes)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—å‚æ•°ä¸ºç©ºçš„æ„é€ æ–¹æ³•ã€‚</li>
<li>ç¬¬ 72 è‡³ 82 è¡Œï¼šæœªé…ç½®æ‹“å±•åï¼Œè‡ªåŠ¨ç”Ÿæˆã€‚<strong>é€‚ç”¨äº Java SPI çš„é…ç½®æ–¹å¼</strong>ã€‚ä¾‹å¦‚ï¼Œxxx.yyy.DemoFilter ç”Ÿæˆçš„æ‹“å±•åä¸º&nbsp;<code>demo</code>&nbsp;ã€‚
<ul>
<li>ç¬¬ 73 è¡Œï¼šé€šè¿‡&nbsp;<code>@Extension</code>&nbsp;æ³¨è§£çš„æ–¹å¼è®¾ç½®æ‹“å±•åçš„æ–¹å¼å·²ç»<strong>åºŸå¼ƒ</strong>ï¼Œèƒ–å‹å¯ä»¥æ— è§†è¯¥æ–¹æ³•ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 84 è¡Œï¼šè·å¾—æ‹“å±•åã€‚ä½¿ç”¨é€—å·è¿›è¡Œåˆ†å‰²ï¼Œå³å¤šä¸ªæ‹“å±•åå¯ä»¥å¯¹åº”åŒä¸€ä¸ªæ‹“å±•å®ç°ç±»ã€‚</li>
<li>ç¬¬ 86 è‡³ 90 è¡Œï¼šç¼“å­˜&nbsp;<code>@Activate</code>&nbsp;åˆ°&nbsp;<code>cachedActivates</code>&nbsp;ã€‚åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/">ã€Œ7. @Activateã€</a>&nbsp;è¯¦ç»†è§£æã€‚</li>
<li>ç¬¬ 93 è‡³ 95 è¡Œï¼šç¼“å­˜åˆ°&nbsp;<code>cachedNames</code>&nbsp;å±æ€§ã€‚</li>
<li>ç¬¬ 96 è‡³ 102 è¡Œï¼šç¼“å­˜æ‹“å±•å®ç°ç±»åˆ°&nbsp;<code>extensionClasses</code>&nbsp;å˜é‡ã€‚<strong>æ³¨æ„</strong>ï¼Œç›¸åŒæ‹“å±•åï¼Œä¸èƒ½å¯¹åº”å¤šä¸ªä¸åŒçš„æ‹“å±•å®ç°ã€‚</li>
<li>ç¬¬ 108 è‡³ 112 è¡Œï¼šè‹¥å‘ç”Ÿå¼‚å¸¸ï¼Œè®°å½•åˆ°å¼‚å¸¸é›†åˆ&nbsp;<code>exceptions</code>&nbsp;å±æ€§ã€‚</li>
</ul>
<h3 id="4-2-4-å…¶ä»–æ–¹æ³•">4.2.4 å…¶ä»–æ–¹æ³•</h3>
<p>å¦‚ä¸‹æ–¹æ³•ï¼Œå’Œè¯¥æµç¨‹æ— å…³ï¼Œèƒ–å‹å¯è‡ªè¡ŒæŸ¥çœ‹ã€‚</p>
<ul>
<li><a href="https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L537-L546" target="_blank" rel="external nofollow noopener noreferrer"><code>#getExtensionClass(name)</code></a></li>
<li><a href="https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L459-L482" target="_blank" rel="external nofollow noopener noreferrer"><code>#findException(name)</code></a></li>
<li><a href="https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L129-L131" target="_blank" rel="external nofollow noopener noreferrer"><code>#getExtensionName(extensionInstance)</code></a></li>
<li><a href="https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L133-L135" target="_blank" rel="external nofollow noopener noreferrer"><code>#getExtensionName(extensionClass)</code></a></li>
<li><a href="https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L277-L286" target="_blank" rel="external nofollow noopener noreferrer"><code>#getSupportedExtensions()</code></a></li>
<li><a href="https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L344-L350" target="_blank" rel="external nofollow noopener noreferrer"><code>#getDefaultExtensionName()</code></a></li>
<li><a href="https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L337" target="_blank" rel="external nofollow noopener noreferrer"><code>#hasExtension(name)</code></a></li>
</ul>
<h2 id="4-3-è·å¾—æ‹“å±•åŠ è½½å™¨">4.3 è·å¾—æ‹“å±•åŠ è½½å™¨</h2>
<p>åœ¨ Dubbo çš„ä»£ç é‡Œï¼Œå¸¸å¸¸èƒ½çœ‹åˆ°å¦‚ä¸‹çš„ä»£ç ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">ExtensionLoader.getExtensionLoader(Protocol.class).getExtension(name)</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="4-3-1-getExtensionLoader">4.3.1 getExtensionLoader</h3>
<p><code>#getExtensionLoader(type)</code>&nbsp;<strong>é™æ€</strong>æ–¹æ³•ï¼Œæ ¹æ®æ‹“å±•ç‚¹çš„æ¥å£ï¼Œè·å¾—æ‹“å±•åŠ è½½å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ‹“å±•åŠ è½½å™¨é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * keyï¼šæ‹“å±•æ¥å£</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"> <span class="comment">// ã€é™æ€å±æ€§ã€‘</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt; EXTENSION_LOADERS = <span class="keyword">new</span> ConcurrentHashMap&lt;Class&lt;?&gt;, ExtensionLoader&lt;?&gt;&gt;(); </span><br /><br /><span class="line">  <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">  2:  * æ ¹æ®æ‹“å±•ç‚¹çš„æ¥å£ï¼Œè·å¾—æ‹“å±•åŠ è½½å™¨</span></span><br /><span class="line"><span class="comment">  3:  *</span></span><br /><span class="line"><span class="comment">  4:  * <span class="doctag">@param</span> type æ¥å£</span></span><br /><span class="line"><span class="comment">  5:  * <span class="doctag">@param</span> &lt;T&gt; æ³›å‹</span></span><br /><span class="line"><span class="comment">  6:  * <span class="doctag">@return</span> åŠ è½½å™¨</span></span><br /><span class="line"><span class="comment">  7:  */</span></span><br /><span class="line">  <span class="number">8</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line">  <span class="number">9</span>: <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">ExtensionLoader&lt;T&gt; <span class="title">getExtensionLoader</span><span class="params">(Class&lt;T&gt; type)</span> </span>{</span><br /><span class="line"> <span class="number">10</span>:     <span class="keyword">if</span> (type == <span class="keyword">null</span>)</span><br /><span class="line"> <span class="number">11</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Extension type == null"</span>);</span><br /><span class="line"> <span class="number">12</span>:     <span class="comment">// å¿…é¡»æ˜¯æ¥å£</span></span><br /><span class="line"> <span class="number">13</span>:     <span class="keyword">if</span> (!type.isInterface()) {</span><br /><span class="line"> <span class="number">14</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Extension type("</span> + type + <span class="string">") is not interface!"</span>);</span><br /><span class="line"> <span class="number">15</span>:     }</span><br /><span class="line"> <span class="number">16</span>:     <span class="comment">// å¿…é¡»åŒ…å« @SPI æ³¨è§£</span></span><br /><span class="line"> <span class="number">17</span>:     <span class="keyword">if</span> (!withExtensionAnnotation(type)) {</span><br /><span class="line"> <span class="number">18</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Extension type("</span> + type +</span><br /><span class="line"> <span class="number">19</span>:                 <span class="string">") is not extension, because WITHOUT @"</span> + SPI.class.getSimpleName() + <span class="string">" Annotation!"</span>);</span><br /><span class="line"> <span class="number">20</span>:     }</span><br /><span class="line"> <span class="number">21</span>: </span><br /><span class="line"> <span class="number">22</span>:     <span class="comment">// è·å¾—æ¥å£å¯¹åº”çš„æ‹“å±•ç‚¹åŠ è½½å™¨</span></span><br /><span class="line"> <span class="number">23</span>:     ExtensionLoader&lt;T&gt; loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type);</span><br /><span class="line"> <span class="number">24</span>:     <span class="keyword">if</span> (loader == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">25</span>:         EXTENSION_LOADERS.putIfAbsent(type, <span class="keyword">new</span> ExtensionLoader&lt;T&gt;(type));</span><br /><span class="line"> <span class="number">26</span>:         loader = (ExtensionLoader&lt;T&gt;) EXTENSION_LOADERS.get(type);</span><br /><span class="line"> <span class="number">27</span>:     }</span><br /><span class="line"> <span class="number">28</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 12 è‡³ 15 è¡Œï¼šå¿…é¡»æ˜¯æ¥å£ã€‚</li>
<li>ç¬¬ 16 è‡³ 20 è¡Œï¼šè°ƒç”¨&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L101-L103" target="_blank" rel="external nofollow noopener noreferrer"><code>#withExtensionAnnotation()</code></a>&nbsp;æ–¹æ³•ï¼Œæ ¡éªŒå¿…é¡»ä½¿ç”¨&nbsp;<code>@SPI</code>&nbsp;æ³¨è§£æ ‡è®°ã€‚</li>
<li>ç¬¬ 22 è‡³ 27 è¡Œï¼šä»&nbsp;<code>EXTENSION_LOADERS</code>&nbsp;<strong>é™æ€</strong>ä¸­è·å–æ‹“å±•æ¥å£å¯¹åº”çš„ ExtensionLoader å¯¹è±¡ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º ExtensionLoader å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°&nbsp;<code>EXTENSION_LOADERS</code>ã€‚</li>
</ul>
<h3 id="4-3-2-æ„é€ æ–¹æ³•">4.3.2 æ„é€ æ–¹æ³•</h3>
<p>æ„é€ æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ‹“å±•æ¥å£ã€‚</span></span><br /><span class="line"><span class="comment"> * ä¾‹å¦‚ï¼ŒProtocol</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; type;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å¯¹è±¡å·¥å‚</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * ç”¨äºè°ƒç”¨ {<span class="doctag">@link</span> #injectExtension(Object)} æ–¹æ³•ï¼Œå‘æ‹“å±•å¯¹è±¡æ³¨å…¥ä¾èµ–å±æ€§ã€‚</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * ä¾‹å¦‚ï¼ŒStubProxyFactoryWrapper ä¸­æœ‰ `Protocol protocol` å±æ€§ã€‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ExtensionFactory objectFactory;</span><br /><br /><span class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="title">ExtensionLoader</span><span class="params">(Class&lt;?&gt; type)</span> </span>{</span><br /><span class="line">  <span class="number">2</span>:     <span class="keyword">this</span>.type = type;</span><br /><span class="line">  <span class="number">3</span>:     objectFactory = (type == ExtensionFactory.class ? <span class="keyword">null</span> : ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getAdaptiveExtension());</span><br /><span class="line">  <span class="number">4</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>objectFactory</code>&nbsp;å±æ€§ï¼Œå¯¹è±¡å·¥å‚ï¼Œ<strong>åŠŸèƒ½ä¸Šå’Œ Spring IOC ä¸€è‡´</strong>ã€‚
<ul>
<li>ç”¨äºè°ƒç”¨&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L510-L535" target="_blank" rel="external nofollow noopener noreferrer"><code>#injectExtension(instance)</code></a>&nbsp;æ–¹æ³•æ—¶ï¼Œå‘åˆ›å»ºçš„æ‹“å±•æ³¨å…¥å…¶ä¾èµ–çš„å±æ€§ã€‚ä¾‹å¦‚ï¼Œ<a href="https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-filter/dubbo-filter-cache/src/main/java/com/alibaba/dubbo/cache/filter/CacheFilter.java#L38" target="_blank" rel="external nofollow noopener noreferrer"><code>CacheFilter.cacheFactory</code></a>&nbsp;å±æ€§ã€‚</li>
<li>ç¬¬ 3 è¡Œï¼šå½“æ‹“å±•æ¥å£é ExtensionFactory æ—¶( å¦‚æœä¸åŠ è¿™ä¸ªåˆ¤æ–­ï¼Œä¼šæ˜¯ä¸€ä¸ªæ­»å¾ªç¯ )ï¼Œè°ƒç”¨&nbsp;<code>ExtensionLoader#getAdaptiveExtension()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— ExtensionFactory æ‹“å±•æ¥å£çš„<strong>è‡ªé€‚åº”</strong>æ‹“å±•å®ç°å¯¹è±¡ã€‚<strong>ä¸ºä»€ä¹ˆå‘¢</strong>ï¼Ÿåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/">ã€Œ8. ExtensionFactoryã€</a>&nbsp;è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
</ul>
<h2 id="4-4-è·å¾—æŒ‡å®šæ‹“å±•å¯¹è±¡">4.4 è·å¾—æŒ‡å®šæ‹“å±•å¯¹è±¡</h2>
<p>åœ¨ Dubbo çš„ä»£ç é‡Œï¼Œå¸¸å¸¸èƒ½çœ‹åˆ°å¦‚ä¸‹çš„ä»£ç ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">ExtensionLoader.getExtensionLoader(Protocol.class).getExtension(name)</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="4-4-1-getExtension">4.4.1 getExtension</h3>
<p><code>#getExtension()</code>&nbsp;æ–¹æ³•ï¼Œè¿”å›æŒ‡å®šåå­—çš„æ‰©å±•å¯¹è±¡ã€‚å¦‚æœæŒ‡å®šåå­—çš„æ‰©å±•ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å¼‚å¸¸ IllegalStateException ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ç¼“å­˜çš„æ‹“å±•å¯¹è±¡é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * keyï¼šæ‹“å±•å</span></span><br /><span class="line"><span class="comment"> * valueï¼šæ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * ä¾‹å¦‚ï¼ŒProtocol æ‹“å±•</span></span><br /><span class="line"><span class="comment"> *          keyï¼šdubbo valueï¼šDubboProtocol</span></span><br /><span class="line"><span class="comment"> *          keyï¼šinjvm valueï¼šInjvmProtocol</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * é€šè¿‡ {<span class="doctag">@link</span> #loadExtensionClasses} åŠ è½½</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, Holder&lt;Object&gt;&gt; cachedInstances = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Holder&lt;Object&gt;&gt;();</span><br /><br /><span class="line">  <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">  2:  * Find the extension with the given name. If the specified name is not found, then {<span class="doctag">@link</span> IllegalStateException}</span></span><br /><span class="line"><span class="comment">  3:  * will be thrown.</span></span><br /><span class="line"><span class="comment">  4:  */</span></span><br /><span class="line">  <span class="number">5</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">  6:  * è¿”å›æŒ‡å®šåå­—çš„æ‰©å±•å¯¹è±¡ã€‚å¦‚æœæŒ‡å®šåå­—çš„æ‰©å±•ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å¼‚å¸¸ {<span class="doctag">@link</span> IllegalStateException}.</span></span><br /><span class="line"><span class="comment">  7:  *</span></span><br /><span class="line"><span class="comment">  8:  * <span class="doctag">@param</span> name æ‹“å±•å</span></span><br /><span class="line"><span class="comment">  9:  * <span class="doctag">@return</span> æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> 10:  */</span></span><br /><span class="line"> <span class="number">11</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line"> <span class="number">12</span>: <span class="function"><span class="keyword">public</span> T <span class="title">getExtension</span><span class="params">(String name)</span> </span>{</span><br /><span class="line"> <span class="number">13</span>:     <span class="keyword">if</span> (name == <span class="keyword">null</span> || name.length() == <span class="number">0</span>)</span><br /><span class="line"> <span class="number">14</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Extension name == null"</span>);</span><br /><span class="line"> <span class="number">15</span>:     <span class="comment">// æŸ¥æ‰¾ é»˜è®¤çš„ æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"> <span class="number">16</span>:     <span class="keyword">if</span> (<span class="string">"true"</span>.equals(name)) {</span><br /><span class="line"> <span class="number">17</span>:         <span class="keyword">return</span> getDefaultExtension();</span><br /><span class="line"> <span class="number">18</span>:     }</span><br /><span class="line"> <span class="number">19</span>:     <span class="comment">// ä» ç¼“å­˜ä¸­ è·å¾—å¯¹åº”çš„æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"> <span class="number">20</span>:     Holder&lt;Object&gt; holder = cachedInstances.get(name);</span><br /><span class="line"> <span class="number">21</span>:     <span class="keyword">if</span> (holder == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">22</span>:         cachedInstances.putIfAbsent(name, <span class="keyword">new</span> Holder&lt;Object&gt;());</span><br /><span class="line"> <span class="number">23</span>:         holder = cachedInstances.get(name);</span><br /><span class="line"> <span class="number">24</span>:     }</span><br /><span class="line"> <span class="number">25</span>:     Object instance = holder.get();</span><br /><span class="line"> <span class="number">26</span>:     <span class="keyword">if</span> (instance == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">27</span>:         <span class="keyword">synchronized</span> (holder) {</span><br /><span class="line"> <span class="number">28</span>:             instance = holder.get();</span><br /><span class="line"> <span class="number">29</span>:             <span class="comment">// ä» ç¼“å­˜ä¸­ æœªè·å–åˆ°ï¼Œè¿›è¡Œåˆ›å»ºç¼“å­˜å¯¹è±¡ã€‚</span></span><br /><span class="line"> <span class="number">30</span>:             <span class="keyword">if</span> (instance == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">31</span>:                 instance = createExtension(name);</span><br /><span class="line"> <span class="number">32</span>:                 <span class="comment">// è®¾ç½®åˆ›å»ºå¯¹è±¡åˆ°ç¼“å­˜ä¸­</span></span><br /><span class="line"> <span class="number">33</span>:                 holder.set(instance);</span><br /><span class="line"> <span class="number">34</span>:             }</span><br /><span class="line"> <span class="number">35</span>:         }</span><br /><span class="line"> <span class="number">36</span>:     }</span><br /><span class="line"> <span class="number">37</span>:     <span class="keyword">return</span> (T) instance;</span><br /><span class="line"> <span class="number">38</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 15 è‡³ 18 è¡Œï¼šè°ƒç”¨&nbsp;<code>#getDefaultExtension()</code>&nbsp;æ–¹æ³•ï¼ŒæŸ¥è¯¢<strong>é»˜è®¤çš„</strong>æ‹“å±•å¯¹è±¡ã€‚åœ¨è¯¥æ–¹æ³•çš„å®ç°ä»£ç ä¸­ï¼Œç®€åŒ–ä»£ç ä¸º&nbsp;<code>getExtension(cachedDefaultName);</code>&nbsp;ã€‚</li>
<li>ç¬¬ 19 è‡³ 28 è¡Œï¼šä»ç¼“å­˜ä¸­ï¼Œè·å¾—æ‹“å±•å¯¹è±¡ã€‚</li>
<li>ç¬¬ 29 è‡³ 31 è¡Œï¼šå½“ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œè°ƒç”¨&nbsp;<code>#createExtension(name)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºæ‹“å±•å¯¹è±¡ã€‚</li>
<li>ç¬¬ 33 è¡Œï¼šæ·»åŠ åˆ›å»ºçš„æ‹“å±•å¯¹è±¡ï¼Œåˆ°ç¼“å­˜ä¸­ã€‚</li>
</ul>
<h3 id="4-4-2-createExtension">4.4.2 createExtension</h3>
<p><code>#createExtension(name)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºæ‹“å±•åçš„æ‹“å±•å¯¹è±¡ï¼Œå¹¶ç¼“å­˜ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ‹“å±•å®ç°ç±»é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * keyï¼šæ‹“å±•å®ç°ç±»</span></span><br /><span class="line"><span class="comment"> * valueï¼šæ‹“å±•å¯¹è±¡ã€‚</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * ä¾‹å¦‚ï¼Œkey ä¸º Class&lt;AccessLogFilter&gt;</span></span><br /><span class="line"><span class="comment"> *      value ä¸º AccessLogFilter å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;Class&lt;?&gt;, Object&gt; EXTENSION_INSTANCES = <span class="keyword">new</span> ConcurrentHashMap&lt;Class&lt;?&gt;, Object&gt;();</span><br />    <br /><span class="line">  <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">  2:  * åˆ›å»ºæ‹“å±•åçš„æ‹“å±•å¯¹è±¡ï¼Œå¹¶ç¼“å­˜ã€‚</span></span><br /><span class="line"><span class="comment">  3:  *</span></span><br /><span class="line"><span class="comment">  4:  * <span class="doctag">@param</span> name æ‹“å±•å</span></span><br /><span class="line"><span class="comment">  5:  * <span class="doctag">@return</span> æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="comment">  6:  */</span></span><br /><span class="line">  <span class="number">7</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line">  <span class="number">8</span>: <span class="function"><span class="keyword">private</span> T <span class="title">createExtension</span><span class="params">(String name)</span> </span>{</span><br /><span class="line">  <span class="number">9</span>:     <span class="comment">// è·å¾—æ‹“å±•åå¯¹åº”çš„æ‹“å±•å®ç°ç±»</span></span><br /><span class="line"> <span class="number">10</span>:     Class&lt;?&gt; clazz = getExtensionClasses().get(name);</span><br /><span class="line"> <span class="number">11</span>:     <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">12</span>:         <span class="keyword">throw</span> findException(name); <span class="comment">// æŠ›å‡ºå¼‚å¸¸</span></span><br /><span class="line"> <span class="number">13</span>:     }</span><br /><span class="line"> <span class="number">14</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">15</span>:         <span class="comment">// ä»ç¼“å­˜ä¸­ï¼Œè·å¾—æ‹“å±•å¯¹è±¡ã€‚</span></span><br /><span class="line"> <span class="number">16</span>:         T instance = (T) EXTENSION_INSTANCES.get(clazz);</span><br /><span class="line"> <span class="number">17</span>:         <span class="keyword">if</span> (instance == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">18</span>:             <span class="comment">// å½“ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œåˆ›å»ºæ‹“å±•å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°ç¼“å­˜ä¸­ã€‚</span></span><br /><span class="line"> <span class="number">19</span>:             EXTENSION_INSTANCES.putIfAbsent(clazz, clazz.newInstance());</span><br /><span class="line"> <span class="number">20</span>:             instance = (T) EXTENSION_INSTANCES.get(clazz);</span><br /><span class="line"> <span class="number">21</span>:         }</span><br /><span class="line"> <span class="number">22</span>:         <span class="comment">// æ³¨å…¥ä¾èµ–çš„å±æ€§</span></span><br /><span class="line"> <span class="number">23</span>:         injectExtension(instance);</span><br /><span class="line"> <span class="number">24</span>:         <span class="comment">// åˆ›å»º Wrapper æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"> <span class="number">25</span>:         Set&lt;Class&lt;?&gt;&gt; wrapperClasses = cachedWrapperClasses;</span><br /><span class="line"> <span class="number">26</span>:         <span class="keyword">if</span> (wrapperClasses != <span class="keyword">null</span> &amp;&amp; !wrapperClasses.isEmpty()) {</span><br /><span class="line"> <span class="number">27</span>:             <span class="keyword">for</span> (Class&lt;?&gt; wrapperClass : wrapperClasses) {</span><br /><span class="line"> <span class="number">28</span>:                 instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));</span><br /><span class="line"> <span class="number">29</span>:             }</span><br /><span class="line"> <span class="number">30</span>:         }</span><br /><span class="line"> <span class="number">31</span>:         <span class="keyword">return</span> instance;</span><br /><span class="line"> <span class="number">32</span>:     } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"> <span class="number">33</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Extension instance(name: "</span> + name + <span class="string">", class: "</span> +</span><br /><span class="line"> <span class="number">34</span>:                 type + <span class="string">")  could not be instantiated: "</span> + t.getMessage(), t);</span><br /><span class="line"> <span class="number">35</span>:     }</span><br /><span class="line"> <span class="number">36</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 9 è‡³ 13 è¡Œï¼šè·å¾—æ‹“å±•åå¯¹åº”çš„æ‹“å±•å®ç°ç±»ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè°ƒç”¨&nbsp;<code>#findException(name)</code>&nbsp;æ–¹æ³•ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>ç¬¬ 16 è¡Œï¼šä»ç¼“å­˜&nbsp;<code>EXTENSION_INSTANCES</code>&nbsp;<strong>é™æ€</strong>å±æ€§ä¸­ï¼Œè·å¾—æ‹“å±•å¯¹è±¡ã€‚</li>
<li>ç¬¬ 17 è‡³ 21 è¡Œï¼šå½“ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œåˆ›å»ºæ‹“å±•å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°&nbsp;<code>EXTENSION_INSTANCES</code>&nbsp;ä¸­ã€‚å› ä¸º&nbsp;<code>#getExtension(name)</code>&nbsp;æ–¹æ³•ä¸­å·²ç»åŠ &nbsp;<code>synchronized</code>&nbsp;ä¿®é¥°ï¼Œæ‰€ä»¥æ­¤å¤„ä¸ç”¨åŒæ­¥ã€‚</li>
<li>ç¬¬ 23 è¡Œï¼šè°ƒç”¨&nbsp;<code>#injectExtension(instance)</code>&nbsp;æ–¹æ³•ï¼Œå‘åˆ›å»ºçš„æ‹“å±•æ³¨å…¥å…¶ä¾èµ–çš„å±æ€§ã€‚</li>
<li>
<p>ç¬¬ 24 è‡³ 30 è¡Œï¼šåˆ›å»º Wrapper æ‹“å±•å¯¹è±¡ï¼Œå°†&nbsp;<code>instance</code>&nbsp;<strong>åŒ…è£…åœ¨å…¶ä¸­</strong>ã€‚åœ¨&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/dev/SPI.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo å¼€å‘æŒ‡å— &mdash;&mdash; æ‰©å±•ç‚¹åŠ è½½ã€‹</a>&nbsp;æ–‡ç« ä¸­ï¼Œå¦‚æ­¤ä»‹ç» Wrapper ç±»ï¼š</p>
<blockquote>
<p>Wrapper ç±»åŒæ ·å®ç°äº†æ‰©å±•ç‚¹æ¥å£ï¼Œä½†æ˜¯ Wrapper ä¸æ˜¯æ‰©å±•ç‚¹çš„çœŸæ­£å®ç°ã€‚å®ƒçš„ç”¨é€”ä¸»è¦æ˜¯ç”¨äºä» ExtensionLoader è¿”å›æ‰©å±•ç‚¹æ—¶ï¼ŒåŒ…è£…åœ¨çœŸæ­£çš„æ‰©å±•ç‚¹å®ç°å¤–ã€‚å³ä» ExtensionLoader ä¸­è¿”å›çš„å®é™…ä¸Šæ˜¯ Wrapper ç±»çš„å®ä¾‹ï¼ŒWrapper æŒæœ‰äº†å®é™…çš„æ‰©å±•ç‚¹å®ç°ç±»ã€‚</p>
<p>æ‰©å±•ç‚¹çš„ Wrapper ç±»å¯ä»¥æœ‰å¤šä¸ªï¼Œä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦æ–°å¢ã€‚</p>
<p>é€šè¿‡ Wrapper ç±»å¯ä»¥æŠŠæ‰€æœ‰æ‰©å±•ç‚¹å…¬å…±é€»è¾‘ç§»è‡³ Wrapper ä¸­ã€‚æ–°åŠ çš„ Wrapper åœ¨æ‰€æœ‰çš„æ‰©å±•ç‚¹ä¸Šæ·»åŠ äº†é€»è¾‘ï¼Œæœ‰äº›ç±»ä¼¼ AOPï¼Œå³ Wrapper ä»£ç†äº†æ‰©å±•ç‚¹ã€‚</p>
</blockquote>
<ul>
<li>ä¾‹å¦‚ï¼š<a href="https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/listener/ListenerExporterWrapper.java" target="_blank" rel="external nofollow noopener noreferrer">ListenerExporterWrapper</a>ã€<a href="https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/protocol/ProtocolFilterWrapper.java" target="_blank" rel="external nofollow noopener noreferrer">ProtocolFilterWrapper</a>&nbsp;ã€‚</li>
</ul>
</li>
</ul>
<h3 id="4-4-3-injectExtension">4.4.3 injectExtension</h3>
<p><code>#injectExtension(instance)</code>&nbsp;æ–¹æ³•ï¼Œæ³¨å…¥ä¾èµ–çš„å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * æ³¨å…¥ä¾èµ–çš„å±æ€§</span></span><br /><span class="line"><span class="comment"> 3:  *</span></span><br /><span class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> instance æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> 5:  * <span class="doctag">@return</span> æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> 6:  */</span></span><br /><span class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">private</span> T <span class="title">injectExtension</span><span class="params">(T instance)</span> </span>{</span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (objectFactory != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">10</span>:             <span class="keyword">for</span> (Method method : instance.getClass().getMethods()) {</span><br /><span class="line"><span class="number">11</span>:                 <span class="keyword">if</span> (method.getName().startsWith(<span class="string">"set"</span>)</span><br /><span class="line"><span class="number">12</span>:                         &amp;&amp; method.getParameterTypes().length == <span class="number">1</span></span><br /><span class="line"><span class="number">13</span>:                         &amp;&amp; Modifier.isPublic(method.getModifiers())) { <span class="comment">// setting &amp;&amp; public æ–¹æ³•</span></span><br /><span class="line"><span class="number">14</span>:                     <span class="comment">// è·å¾—å±æ€§çš„ç±»å‹</span></span><br /><span class="line"><span class="number">15</span>:                     Class&lt;?&gt; pt = method.getParameterTypes()[<span class="number">0</span>];</span><br /><span class="line"><span class="number">16</span>:                     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">17</span>:                         <span class="comment">// è·å¾—å±æ€§</span></span><br /><span class="line"><span class="number">18</span>:                         String property = method.getName().length() &gt; <span class="number">3</span> ? method.getName().substring(<span class="number">3</span>, <span class="number">4</span>).toLowerCase() + method.getName().substring(<span class="number">4</span>) : <span class="string">""</span>;</span><br /><span class="line"><span class="number">19</span>:                         <span class="comment">// è·å¾—å±æ€§å€¼</span></span><br /><span class="line"><span class="number">20</span>:                         Object object = objectFactory.getExtension(pt, property);</span><br /><span class="line"><span class="number">21</span>:                         <span class="comment">// è®¾ç½®å±æ€§å€¼</span></span><br /><span class="line"><span class="number">22</span>:                         <span class="keyword">if</span> (object != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">23</span>:                             method.invoke(instance, object);</span><br /><span class="line"><span class="number">24</span>:                         }</span><br /><span class="line"><span class="number">25</span>:                     } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line"><span class="number">26</span>:                         logger.error(<span class="string">"fail to inject via method "</span> + method.getName()</span><br /><span class="line"><span class="number">27</span>:                                 + <span class="string">" of interface "</span> + type.getName() + <span class="string">": "</span> + e.getMessage(), e);</span><br /><span class="line"><span class="number">28</span>:                     }</span><br /><span class="line"><span class="number">29</span>:                 }</span><br /><span class="line"><span class="number">30</span>:             }</span><br /><span class="line"><span class="number">31</span>:         }</span><br /><span class="line"><span class="number">32</span>:     } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line"><span class="number">33</span>:         logger.error(e.getMessage(), e);</span><br /><span class="line"><span class="number">34</span>:     }</span><br /><span class="line"><span class="number">35</span>:     <span class="keyword">return</span> instance;</span><br /><span class="line"><span class="number">36</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 9 è¡Œï¼šå¿…é¡»æœ‰&nbsp;<code>objectFactory</code>&nbsp;å±æ€§ï¼Œå³ ExtensionFactory çš„æ‹“å±•å¯¹è±¡ï¼Œä¸éœ€è¦æ³¨å…¥ä¾èµ–çš„å±æ€§ã€‚</li>
<li>ç¬¬ 10 è‡³ 13 è¡Œï¼šåå°„è·å¾—æ‰€æœ‰çš„æ–¹æ³•ï¼Œä»…ä»…å¤„ç†&nbsp;<code>public setting</code>&nbsp;æ–¹æ³•ã€‚</li>
<li>ç¬¬ 15 è¡Œï¼šè·å¾—å±æ€§çš„ç±»å‹ã€‚</li>
<li>ç¬¬ 18 è¡Œï¼šè·å¾—å±æ€§åã€‚</li>
<li>ç¬¬ 20 è¡Œï¼šè·å¾—<strong>å±æ€§å€¼</strong>ã€‚<strong>æ³¨æ„</strong>ï¼Œæ­¤å¤„è™½ç„¶è°ƒç”¨çš„æ˜¯&nbsp;<code>ExtensionFactory#getExtension(type, name)</code>&nbsp;æ–¹æ³•ï¼Œå®é™…è·å–çš„ä¸ä»…ä»…æ˜¯æ‹“å±•å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ Spring Bean å¯¹è±¡ã€‚ç­”æ¡ˆåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/">ã€Œ8. ExtensionFactoryã€</a>&nbsp;æ­æ™“ã€‚</li>
<li>ç¬¬ 21 è‡³ 24 è¡Œï¼šè®¾ç½®å±æ€§å€¼ã€‚</li>
</ul>
<h3 id="4-4-4-å…¶ä»–æ–¹æ³•">4.4.4 å…¶ä»–æ–¹æ³•</h3>
<p>å¦‚ä¸‹æ–¹æ³•ï¼Œå’Œè¯¥æµç¨‹æ— å…³ï¼Œèƒ–å‹å¯è‡ªè¡ŒæŸ¥çœ‹ã€‚</p>
<ul>
<li><a href="https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L257-L275" target="_blank" rel="external nofollow noopener noreferrer"><code>#getLoadedExtension(name)</code></a></li>
<li><a href="https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L277-L286" target="_blank" rel="external nofollow noopener noreferrer"><code>#getLoadedExtensions()</code></a></li>
</ul>
<h2 id="4-5-è·å¾—è‡ªé€‚åº”çš„æ‹“å±•å¯¹è±¡">4.5 è·å¾—è‡ªé€‚åº”çš„æ‹“å±•å¯¹è±¡</h2>
<p>åœ¨ Dubbo çš„ä»£ç é‡Œï¼Œå¸¸å¸¸èƒ½çœ‹åˆ°å¦‚ä¸‹çš„ä»£ç ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">ExtensionLoader.getExtensionLoader(Protocol.class).getAdaptiveExtension()</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<blockquote>
<p>å‹æƒ…æç¤ºï¼Œèƒ–å‹å…ˆçœ‹ä¸‹&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/">ã€Œ6. Adaptiveã€</a>&nbsp;çš„å†…å®¹ï¼Œåœ¨å›åˆ°æ­¤å¤„ã€‚</p>
</blockquote>
<h3 id="4-5-1-getAdaptiveExtension">4.5.1 getAdaptiveExtension</h3>
<p><code>#getAdaptiveExtension()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—è‡ªé€‚åº”æ‹“å±•å¯¹è±¡ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ç¼“å­˜çš„è‡ªé€‚åº”( Adaptive )æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Holder&lt;Object&gt; cachedAdaptiveInstance = <span class="keyword">new</span> Holder&lt;Object&gt;();</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * åˆ›å»º {<span class="doctag">@link</span> #cachedAdaptiveInstance} æ—¶å‘ç”Ÿçš„å¼‚å¸¸ã€‚</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * å‘ç”Ÿå¼‚å¸¸åï¼Œä¸å†åˆ›å»ºï¼Œå‚è§ {<span class="doctag">@link</span> #createAdaptiveExtension()}</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Throwable createAdaptiveInstanceError;</span><br /><br /><span class="line">  <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">  2:  * è·å¾—è‡ªé€‚åº”æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="comment">  3:  *</span></span><br /><span class="line"><span class="comment">  4:  * <span class="doctag">@return</span> æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="comment">  5:  */</span></span><br /><span class="line">  <span class="number">6</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line">  <span class="number">7</span>: <span class="function"><span class="keyword">public</span> T <span class="title">getAdaptiveExtension</span><span class="params">()</span> </span>{</span><br /><span class="line">  <span class="number">8</span>:     <span class="comment">// ä»ç¼“å­˜ä¸­ï¼Œè·å¾—è‡ªé€‚åº”æ‹“å±•å¯¹è±¡</span></span><br /><span class="line">  <span class="number">9</span>:     Object instance = cachedAdaptiveInstance.get();</span><br /><span class="line"> <span class="number">10</span>:     <span class="keyword">if</span> (instance == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">11</span>:         <span class="comment">// è‹¥ä¹‹å‰æœªåˆ›å»ºæŠ¥é”™ï¼Œ</span></span><br /><span class="line"> <span class="number">12</span>:         <span class="keyword">if</span> (createAdaptiveInstanceError == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">13</span>:             <span class="keyword">synchronized</span> (cachedAdaptiveInstance) {</span><br /><span class="line"> <span class="number">14</span>:                 instance = cachedAdaptiveInstance.get();</span><br /><span class="line"> <span class="number">15</span>:                 <span class="keyword">if</span> (instance == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">16</span>:                     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">17</span>:                         <span class="comment">// åˆ›å»ºè‡ªé€‚åº”æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"> <span class="number">18</span>:                         instance = createAdaptiveExtension();</span><br /><span class="line"> <span class="number">19</span>:                         <span class="comment">// è®¾ç½®åˆ°ç¼“å­˜</span></span><br /><span class="line"> <span class="number">20</span>:                         cachedAdaptiveInstance.set(instance);</span><br /><span class="line"> <span class="number">21</span>:                     } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"> <span class="number">22</span>:                         <span class="comment">// è®°å½•å¼‚å¸¸</span></span><br /><span class="line"> <span class="number">23</span>:                         createAdaptiveInstanceError = t;</span><br /><span class="line"> <span class="number">24</span>:                         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"fail to create adaptive instance: "</span> + t.toString(), t);</span><br /><span class="line"> <span class="number">25</span>:                     }</span><br /><span class="line"> <span class="number">26</span>:                 }</span><br /><span class="line"> <span class="number">27</span>:             }</span><br /><span class="line"> <span class="number">28</span>:         <span class="comment">// è‹¥ä¹‹å‰åˆ›å»ºæŠ¥é”™ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ IllegalStateException</span></span><br /><span class="line"> <span class="number">29</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">30</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"fail to create adaptive instance: "</span> + createAdaptiveInstanceError.toString(), createAdaptiveInstanceError);</span><br /><span class="line"> <span class="number">31</span>:         }</span><br /><span class="line"> <span class="number">32</span>:     }</span><br /><span class="line"> <span class="number">33</span>:     <span class="keyword">return</span> (T) instance;</span><br /><span class="line"> <span class="number">34</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 9 è¡Œï¼šä»ç¼“å­˜&nbsp;<code>cachedAdaptiveInstance</code>&nbsp;å±æ€§ä¸­ï¼Œè·å¾—è‡ªé€‚åº”æ‹“å±•å¯¹è±¡ã€‚</li>
<li>ç¬¬ 28 è‡³ 30 è¡Œï¼šè‹¥ä¹‹å‰åˆ›å»ºæŠ¥é”™ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ IllegalStateException ã€‚</li>
<li>ç¬¬ 14 è‡³ 20 è¡Œï¼šå½“ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œè°ƒç”¨&nbsp;<code>#createAdaptiveExtension()</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºè‡ªé€‚åº”æ‹“å±•å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°&nbsp;<code>cachedAdaptiveInstance</code>&nbsp;ä¸­ã€‚</li>
<li>ç¬¬ 22 è‡³ 24 è¡Œï¼šè‹¥åˆ›å»ºå‘ç”Ÿå¼‚å¸¸ï¼Œè®°å½•å¼‚å¸¸åˆ°&nbsp;<code>createAdaptiveInstanceError</code>&nbsp;ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸ IllegalStateException ã€‚</li>
</ul>
<h3 id="4-5-2-createAdaptiveExtension">4.5.2 createAdaptiveExtension</h3>
<p><code>#createAdaptiveExtension()</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºè‡ªé€‚åº”æ‹“å±•å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * åˆ›å»ºè‡ªé€‚åº”æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line"><span class="function"><span class="keyword">private</span> T <span class="title">createAdaptiveExtension</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="keyword">return</span> injectExtension((T) getAdaptiveExtensionClass().newInstance());</span><br /><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Can not create adaptive extension "</span> + type + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è°ƒç”¨&nbsp;<code>#getAdaptiveExtensionClass()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—è‡ªé€‚åº”æ‹“å±•ç±»ã€‚</li>
<li>è°ƒç”¨&nbsp;<code>Class#newInstance()</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºè‡ªé€‚åº”æ‹“å±•å¯¹è±¡ã€‚</li>
<li>è°ƒç”¨&nbsp;<code>#injectExtension(instance)</code>&nbsp;æ–¹æ³•ï¼Œå‘åˆ›å»ºçš„è‡ªé€‚åº”æ‹“å±•å¯¹è±¡ï¼Œæ³¨å…¥ä¾èµ–çš„å±æ€§ã€‚</li>
</ul>
<h3 id="4-5-3-getAdaptiveExtensionClass">4.5.3 getAdaptiveExtensionClass</h3>
<p><code>#getAdaptiveExtensionClass()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—è‡ªé€‚åº”æ‹“å±•ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * <span class="doctag">@return</span> è‡ªé€‚åº”æ‹“å±•ç±»</span></span><br /><span class="line"><span class="comment"> 3:  */</span></span><br /><span class="line"> <span class="number">4</span>: <span class="keyword">private</span> Class&lt;?&gt; getAdaptiveExtensionClass() {</span><br /><span class="line"> <span class="number">5</span>:     getExtensionClasses();</span><br /><span class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (cachedAdaptiveClass != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">7</span>:         <span class="keyword">return</span> cachedAdaptiveClass;</span><br /><span class="line"> <span class="number">8</span>:     }</span><br /><span class="line"> <span class="number">9</span>:     <span class="keyword">return</span> cachedAdaptiveClass = createAdaptiveExtensionClass();</span><br /><span class="line"><span class="number">10</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ã€<code>@Adaptive</code>&nbsp;çš„ç¬¬ä¸€ç§ã€‘ç¬¬ 6 è‡³ 8 è¡Œï¼šè‹¥&nbsp;<code>cachedAdaptiveClass</code>&nbsp;å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›ã€‚çš„ç¬¬ä¸€ç§æƒ…å†µã€‚</li>
<li>ã€<code>@Adaptive</code>&nbsp;çš„ç¬¬äºŒç§ã€‘ç¬¬ 9 è¡Œï¼šè°ƒç”¨&nbsp;<code>#createAdaptiveExtensionClass()</code>&nbsp;æ–¹æ³•ï¼Œ<strong>è‡ªåŠ¨ç”Ÿæˆ</strong>è‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°ï¼Œå¹¶<strong>ç¼–è¯‘</strong>åè¿”å›è¯¥ç±»ã€‚</li>
</ul>
<h3 id="4-5-4-createAdaptiveExtensionClassCode">4.5.4 createAdaptiveExtensionClassCode</h3>
<p><code>#createAdaptiveExtensionClassCode()</code>&nbsp;æ–¹æ³•ï¼Œè‡ªåŠ¨ç”Ÿæˆè‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°ï¼Œå¹¶ç¼–è¯‘åè¿”å›è¯¥ç±»ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * è‡ªåŠ¨ç”Ÿæˆè‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°ï¼Œå¹¶ç¼–è¯‘åè¿”å›è¯¥ç±»ã€‚</span></span><br /><span class="line"><span class="comment"> 3:  *</span></span><br /><span class="line"><span class="comment"> 4:  * <span class="doctag">@return</span> ç±»</span></span><br /><span class="line"><span class="comment"> 5:  */</span></span><br /><span class="line"> <span class="number">6</span>: <span class="keyword">private</span> Class&lt;?&gt; createAdaptiveExtensionClass() {</span><br /><span class="line"> <span class="number">7</span>:     <span class="comment">// è‡ªåŠ¨ç”Ÿæˆè‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°çš„å­—ç¬¦ä¸²</span></span><br /><span class="line"> <span class="number">8</span>:     String code = createAdaptiveExtensionClassCode();</span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// ç¼–è¯‘ä»£ç ï¼Œå¹¶è¿”å›è¯¥ç±»</span></span><br /><span class="line"><span class="number">10</span>:     ClassLoader classLoader = findClassLoader();</span><br /><span class="line"><span class="number">11</span>:     com.alibaba.dubbo.common.compiler.Compiler compiler = ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.common.compiler.Compiler.class).getAdaptiveExtension();</span><br /><span class="line"><span class="number">12</span>:     <span class="keyword">return</span> compiler.compile(code, classLoader);</span><br /><span class="line"><span class="number">13</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 8 è¡Œï¼šè°ƒç”¨&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/4a877ee283af70c3f6a19c3b8b8e6918696540e6/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L1012-L1253" target="_blank" rel="external nofollow noopener noreferrer"><code>#createAdaptiveExtensionClassCode</code></a>&nbsp;æ–¹æ³•ï¼Œè‡ªåŠ¨ç”Ÿæˆè‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°çš„å­—ç¬¦ä¸²ã€‚
<ul>
<li>ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œå·²ç»æ·»åŠ è¯¦ç»†æ³¨é‡Šï¼Œèƒ–å‹ç‚¹å‡»æŸ¥çœ‹ã€‚</li>
<li>å¦‚ä¸‹æ˜¯ ProxyFactory çš„è‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°çš„å­—ç¬¦ä¸²ç”Ÿæˆ<strong>ä¾‹å­</strong>&nbsp;<img src="http://static2.iocoder.cn/images/Dubbo/2018_03_04/05.png" alt="è‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°çš„å­—ç¬¦ä¸²ç”Ÿæˆä¾‹å­" /></li>
</ul>
</li>
<li>ç¬¬ 9 è‡³ 12 è¡Œï¼šä½¿ç”¨ Dubbo SPI åŠ è½½ Compier æ‹“å±•æ¥å£å¯¹åº”çš„æ‹“å±•å®ç°å¯¹è±¡ï¼Œåè°ƒç”¨&nbsp;<code>Compiler#compile(code, classLoader)</code>&nbsp;æ–¹æ³•ï¼Œè¿›è¡Œç¼–è¯‘ã€‚ğŸ™‚ å› ä¸ºä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œåç»­å¦å¼€æ–‡ç« åˆ†äº«ã€‚</li>
</ul>
<h2 id="4-6-è·å¾—æ¿€æ´»çš„æ‹“å±•å¯¹è±¡æ•°ç»„">4.6 è·å¾—æ¿€æ´»çš„æ‹“å±•å¯¹è±¡æ•°ç»„</h2>
<p>åœ¨ Dubbo çš„ä»£ç é‡Œï¼Œçœ‹åˆ°ä½¿ç”¨ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">List&lt;Filter&gt; filters = ExtensionLoader.getExtensionLoader(Filter.class).getActivateExtension(invoker.getUrl(), key, group);</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="4-6-1-getExtensionLoader">4.6.1 getExtensionLoader</h3>
<p><code>#getExtensionLoader(url, key, group)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—ç¬¦åˆè‡ªåŠ¨æ¿€æ´»æ¡ä»¶çš„æ‹“å±•å¯¹è±¡æ•°ç»„ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * This is equivalent to {<span class="doctag">@code</span> getActivateExtension(url, url.getParameter(key).split(","), null)}</span></span><br /><span class="line"><span class="comment"> 3:  *</span></span><br /><span class="line"><span class="comment"> 4:  * è·å¾—ç¬¦åˆè‡ªåŠ¨æ¿€æ´»æ¡ä»¶çš„æ‹“å±•å¯¹è±¡æ•°ç»„</span></span><br /><span class="line"><span class="comment"> 5:  *</span></span><br /><span class="line"><span class="comment"> 6:  * <span class="doctag">@param</span> url   url</span></span><br /><span class="line"><span class="comment"> 7:  * <span class="doctag">@param</span> key   url parameter key which used to get extension point names</span></span><br /><span class="line"><span class="comment"> 8:  *              Dubbo URL å‚æ•°å</span></span><br /><span class="line"><span class="comment"> 9:  * <span class="doctag">@param</span> group group</span></span><br /><span class="line"><span class="comment">10:  *              è¿‡æ»¤åˆ†ç»„å</span></span><br /><span class="line"><span class="comment">11:  * <span class="doctag">@return</span> extension list which are activated.</span></span><br /><span class="line"><span class="comment">12:  * <span class="doctag">@see</span> #getActivateExtension(com.alibaba.dubbo.common.URL, String[], String)</span></span><br /><span class="line"><span class="comment">13:  */</span></span><br /><span class="line"><span class="number">14</span>: <span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getActivateExtension</span><span class="params">(URL url, String key, String group)</span> </span>{</span><br /><span class="line"><span class="number">15</span>:     <span class="comment">// ä» Dubbo URL è·å¾—å‚æ•°å€¼</span></span><br /><span class="line"><span class="number">16</span>:     String value = url.getParameter(key);</span><br /><span class="line"><span class="number">17</span>:     <span class="comment">// è·å¾—ç¬¦åˆè‡ªåŠ¨æ¿€æ´»æ¡ä»¶çš„æ‹“å±•å¯¹è±¡æ•°ç»„</span></span><br /><span class="line"><span class="number">18</span>:     <span class="keyword">return</span> getActivateExtension(url, value == <span class="keyword">null</span> || value.length() == <span class="number">0</span> ? <span class="keyword">null</span> : Constants.COMMA_SPLIT_PATTERN.split(value), group);</span><br /><span class="line"><span class="number">19</span>: }</span><br /><span class="line"><span class="number">20</span>: </span><br /><span class="line"><span class="number">21</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">22:  * Get activate extensions.</span></span><br /><span class="line"><span class="comment">23:  *</span></span><br /><span class="line"><span class="comment">24:  * è·å¾—ç¬¦åˆè‡ªåŠ¨æ¿€æ´»æ¡ä»¶çš„æ‹“å±•å¯¹è±¡æ•°ç»„</span></span><br /><span class="line"><span class="comment">25:  *</span></span><br /><span class="line"><span class="comment">26:  * <span class="doctag">@param</span> url    url</span></span><br /><span class="line"><span class="comment">27:  * <span class="doctag">@param</span> values extension point names</span></span><br /><span class="line"><span class="comment">28:  * <span class="doctag">@param</span> group  group</span></span><br /><span class="line"><span class="comment">29:  * <span class="doctag">@return</span> extension list which are activated</span></span><br /><span class="line"><span class="comment">30:  * <span class="doctag">@see</span> com.alibaba.dubbo.common.extension.Activate</span></span><br /><span class="line"><span class="comment">31:  */</span></span><br /><span class="line"><span class="number">32</span>: <span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getActivateExtension</span><span class="params">(URL url, String[] values, String group)</span> </span>{</span><br /><span class="line"><span class="number">33</span>:     List&lt;T&gt; exts = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br /><span class="line"><span class="number">34</span>:     List&lt;String&gt; names = values == <span class="keyword">null</span> ? <span class="keyword">new</span> ArrayList&lt;String&gt;(<span class="number">0</span>) : Arrays.asList(values);</span><br /><span class="line"><span class="number">35</span>:     <span class="comment">// å¤„ç†è‡ªåŠ¨æ¿€æ´»çš„æ‹“å±•å¯¹è±¡ä»¬</span></span><br /><span class="line"><span class="number">36</span>:     <span class="comment">// åˆ¤æ–­ä¸å­˜åœ¨é…ç½® `"-name"` ã€‚ä¾‹å¦‚ï¼Œ&lt;dubbo:service filter="-default" /&gt; ï¼Œä»£è¡¨ç§»é™¤æ‰€æœ‰é»˜è®¤è¿‡æ»¤å™¨ã€‚</span></span><br /><span class="line"><span class="number">37</span>:     <span class="keyword">if</span> (!names.contains(Constants.REMOVE_VALUE_PREFIX + Constants.DEFAULT_KEY)) {</span><br /><span class="line"><span class="number">38</span>:         <span class="comment">// è·å¾—æ‹“å±•å®ç°ç±»æ•°ç»„</span></span><br /><span class="line"><span class="number">39</span>:         getExtensionClasses();</span><br /><span class="line"><span class="number">40</span>:         <span class="comment">// å¾ªç¯</span></span><br /><span class="line"><span class="number">41</span>:         <span class="keyword">for</span> (Map.Entry&lt;String, Activate&gt; entry : cachedActivates.entrySet()) {</span><br /><span class="line"><span class="number">42</span>:             String name = entry.getKey();</span><br /><span class="line"><span class="number">43</span>:             Activate activate = entry.getValue();</span><br /><span class="line"><span class="number">44</span>:             <span class="keyword">if</span> (isMatchGroup(group, activate.group())) { <span class="comment">// åŒ¹é…åˆ†ç»„</span></span><br /><span class="line"><span class="number">45</span>:                 <span class="comment">// è·å¾—æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="number">46</span>:                 T ext = getExtension(name);</span><br /><span class="line"><span class="number">47</span>:                 <span class="keyword">if</span> (!names.contains(name) <span class="comment">// ä¸åŒ…å«åœ¨è‡ªå®šä¹‰é…ç½®é‡Œã€‚å¦‚æœåŒ…å«ï¼Œä¼šåœ¨ä¸‹é¢çš„ä»£ç å¤„ç†ã€‚</span></span><br /><span class="line"><span class="number">48</span>:                         &amp;&amp; !names.contains(Constants.REMOVE_VALUE_PREFIX + name) <span class="comment">// åˆ¤æ–­æ˜¯å¦é…ç½®ç§»é™¤ã€‚ä¾‹å¦‚ &lt;dubbo:service filter="-monitor" /&gt;ï¼Œåˆ™ MonitorFilter ä¼šè¢«ç§»é™¤</span></span><br /><span class="line"><span class="number">49</span>:                         &amp;&amp; isActive(activate, url)) { <span class="comment">// åˆ¤æ–­æ˜¯å¦æ¿€æ´»</span></span><br /><span class="line"><span class="number">50</span>:                     exts.add(ext);</span><br /><span class="line"><span class="number">51</span>:                 }</span><br /><span class="line"><span class="number">52</span>:             }</span><br /><span class="line"><span class="number">53</span>:         }</span><br /><span class="line"><span class="number">54</span>:         <span class="comment">// æ’åº</span></span><br /><span class="line"><span class="number">55</span>:         Collections.sort(exts, ActivateComparator.COMPARATOR);</span><br /><span class="line"><span class="number">56</span>:     }</span><br /><span class="line"><span class="number">57</span>:     <span class="comment">// å¤„ç†è‡ªå®šä¹‰é…ç½®çš„æ‹“å±•å¯¹è±¡ä»¬ã€‚ä¾‹å¦‚åœ¨ &lt;dubbo:service filter="demo" /&gt; ï¼Œä»£è¡¨éœ€è¦åŠ å…¥ DemoFilter ï¼ˆè¿™ä¸ªæ˜¯ç¬”è€…è‡ªå®šä¹‰çš„ï¼‰ã€‚</span></span><br /><span class="line"><span class="number">58</span>:     List&lt;T&gt; usrs = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br /><span class="line"><span class="number">59</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; names.size(); i++) {</span><br /><span class="line"><span class="number">60</span>:         String name = names.get(i);</span><br /><span class="line"><span class="number">61</span>:         <span class="keyword">if</span> (!name.startsWith(Constants.REMOVE_VALUE_PREFIX) &amp;&amp; !names.contains(Constants.REMOVE_VALUE_PREFIX + name)) { <span class="comment">// åˆ¤æ–­éç§»é™¤çš„</span></span><br /><span class="line"><span class="number">62</span>:             <span class="comment">// å°†é…ç½®çš„è‡ªå®šä¹‰åœ¨è‡ªåŠ¨æ¿€æ´»çš„æ‹“å±•å¯¹è±¡ä»¬å‰é¢ã€‚ä¾‹å¦‚ï¼Œ&lt;dubbo:service filter="demo,default,demo2" /&gt; ï¼Œåˆ™ DemoFilter å°±ä¼šæ”¾åœ¨é»˜è®¤çš„è¿‡æ»¤å™¨å‰é¢ã€‚</span></span><br /><span class="line"><span class="number">63</span>:             <span class="keyword">if</span> (Constants.DEFAULT_KEY.equals(name)) {</span><br /><span class="line"><span class="number">64</span>:                 <span class="keyword">if</span> (!usrs.isEmpty()) {</span><br /><span class="line"><span class="number">65</span>:                     exts.addAll(<span class="number">0</span>, usrs);</span><br /><span class="line"><span class="number">66</span>:                     usrs.clear();</span><br /><span class="line"><span class="number">67</span>:                 }</span><br /><span class="line"><span class="number">68</span>:             } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">69</span>:                 <span class="comment">// è·å¾—æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="number">70</span>:                 T ext = getExtension(name);</span><br /><span class="line"><span class="number">71</span>:                 usrs.add(ext);</span><br /><span class="line"><span class="number">72</span>:             }</span><br /><span class="line"><span class="number">73</span>:         }</span><br /><span class="line"><span class="number">74</span>:     }</span><br /><span class="line"><span class="number">75</span>:     <span class="comment">// æ·»åŠ åˆ°ç»“æœé›†</span></span><br /><span class="line"><span class="number">76</span>:     <span class="keyword">if</span> (!usrs.isEmpty()) {</span><br /><span class="line"><span class="number">77</span>:         exts.addAll(usrs);</span><br /><span class="line"><span class="number">78</span>:     }</span><br /><span class="line"><span class="number">79</span>:     <span class="keyword">return</span> exts;</span><br /><span class="line"><span class="number">80</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 16 è¡Œï¼šä» Dubbo URL è·å¾—å‚æ•°å€¼ã€‚ä¾‹å¦‚è¯´ï¼Œè‹¥ XML é…ç½® Service&nbsp;<code>&lt;dubbo:service filter="demo, demo2" /&gt;</code>&nbsp;ï¼Œå¹¶ä¸”åœ¨è·å¾— Filter è‡ªåŠ¨æ¿€æ´»æ‹“å±•æ—¶ï¼Œæ­¤å¤„å°±èƒ½è§£æåˆ°&nbsp;<code>value=demo,demo2</code>&nbsp;ã€‚å¦å¤–ï¼Œ<code>value</code>&nbsp;å¯ä»¥æ ¹æ®<strong>é€—å·</strong>æ‹†åˆ†ã€‚</li>
<li>ç¬¬ 18 è¡Œï¼šè°ƒç”¨&nbsp;<code>#getActivateExtension(url, values, group)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—ç¬¦åˆè‡ªåŠ¨æ¿€æ´»æ¡ä»¶çš„æ‹“å±•å¯¹è±¡æ•°ç»„ã€‚</li>
<li>ç¬¬ 35 è‡³ 56 è¡Œï¼šå¤„ç†è‡ªåŠ¨æ¿€æ´»çš„æ‹“å±•å¯¹è±¡ä»¬ã€‚
<ul>
<li><a href="https://github.com/YunaiV/dubbo/blob/4a877ee283af70c3f6a19c3b8b8e6918696540e6/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L357-L378" target="_blank" rel="external nofollow noopener noreferrer"><code>#isMatchGroup(group, groups)</code></a>&nbsp;æ–¹æ³•ï¼ŒåŒ¹é…åˆ†ç»„ã€‚</li>
<li><a href="https://github.com/YunaiV/dubbo/blob/4a877ee283af70c3f6a19c3b8b8e6918696540e6/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L380-L403" target="_blank" rel="external nofollow noopener noreferrer"><code>#isActive(Activate, url)</code></a>&nbsp;æ–¹æ³•ï¼Œæ˜¯å¦æ¿€æ´»ï¼Œé€šè¿‡ Dubbo URL ä¸­æ˜¯å¦å­˜åœ¨å‚æ•°åä¸º&nbsp;<a href="mailto:%60@Activate.value" target="_blank" rel="external nofollow noopener noreferrer">`@Activate.value</a>` ï¼Œå¹¶ä¸”å‚æ•°å€¼éç©ºã€‚</li>
</ul>
</li>
<li>ç¬¬ 57 è‡³ 74 è¡Œï¼šå¤„ç†è‡ªå®šä¹‰é…ç½®çš„æ‹“å±•å¯¹è±¡ä»¬ã€‚</li>
<li>ç¬¬ 75 è‡³ 78 è¡Œï¼šå°†&nbsp;<code>usrs</code>&nbsp;åˆå¹¶åˆ°&nbsp;<code>exts</code>&nbsp;<strong>å°¾éƒ¨</strong>ã€‚</li>
<li>ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹ç›´æ¥çœ‹æ³¨é‡Šã€‚</li>
</ul>
<h3 id="4-6-2-ActivateComparator">4.6.2 ActivateComparator</h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/4a877ee283af70c3f6a19c3b8b8e6918696540e6/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/support/ActivateComparator.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.common.extension.support.ActivateComparator</code></a>&nbsp;ï¼Œè‡ªåŠ¨æ¿€æ´»æ‹“å±•å¯¹è±¡æ’åºå™¨ã€‚</p>
<ul>
<li>ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹ç›´æ¥çœ‹æ³¨é‡Šã€‚</li>
</ul>
<h1 id="5-SPI">5. @SPI</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/SPI.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.common.extension.@SPI</code></a>&nbsp;ï¼Œæ‰©å±•ç‚¹æ¥å£çš„æ ‡è¯†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Documented</span></span><br /><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br /><span class="line"><span class="meta">@Target</span>({ElementType.TYPE})</span><br /><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SPI {</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * default extension name</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>value</code>&nbsp;ï¼Œé»˜è®¤æ‹“å±•å®ç°ç±»çš„åå­—ã€‚ä¾‹å¦‚ï¼ŒProtocol æ‹“å±•æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@SPI</span>(<span class="string">"dubbo"</span>)</span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Protocol</span> </span>{</span><br /><span class="line">    <span class="comment">// ... çœç•¥ä»£ç </span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å…¶ä¸­&nbsp;<code>"dubbo"</code>&nbsp;æŒ‡çš„æ˜¯ DubboProtocol ï¼ŒProtocol é»˜è®¤çš„æ‹“å±•å®ç°ç±»ã€‚</li>
</ul>
</li>
</ul>
<h1 id="6-Adaptive">6. @Adaptive</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/Adaptive.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.common.extension.@Adaptive</code></a>&nbsp;ï¼Œè‡ªé€‚åº”æ‹“å±•ä¿¡æ¯çš„æ ‡è®°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Documented</span></span><br /><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br /><span class="line"><span class="meta">@Target</span>({ElementType.TYPE, ElementType.METHOD})</span><br /><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Adaptive {</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Decide which target extension to be injected. The name of the target extension is decided by the parameter passed</span></span><br /><span class="line"><span class="comment">     * in the URL, and the parameter names are given by this method.</span></span><br /><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br /><span class="line"><span class="comment">     * If the specified parameters are not found from {<span class="doctag">@link</span> URL}, then the default extension will be used for</span></span><br /><span class="line"><span class="comment">     * dependency injection (specified in its interface's {<span class="doctag">@link</span> SPI}).</span></span><br /><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br /><span class="line"><span class="comment">     * For examples, given &lt;code&gt;String[] {"key1", "key2"}&lt;/code&gt;:</span></span><br /><span class="line"><span class="comment">     * &lt;ol&gt;</span></span><br /><span class="line"><span class="comment">     * &lt;li&gt;find parameter 'key1' in URL, use its value as the extension's name&lt;/li&gt;</span></span><br /><span class="line"><span class="comment">     * &lt;li&gt;try 'key2' for extension's name if 'key1' is not found (or its value is empty) in URL&lt;/li&gt;</span></span><br /><span class="line"><span class="comment">     * &lt;li&gt;use default extension if 'key2' doesn't appear either&lt;/li&gt;</span></span><br /><span class="line"><span class="comment">     * &lt;li&gt;otherwise, throw {<span class="doctag">@link</span> IllegalStateException}&lt;/li&gt;</span></span><br /><span class="line"><span class="comment">     * &lt;/ol&gt;</span></span><br /><span class="line"><span class="comment">     * If default extension's name is not give on interface's {<span class="doctag">@link</span> SPI}, then a name is generated from interface's</span></span><br /><span class="line"><span class="comment">     * class name with the rule: divide classname from capital char into several parts, and separate the parts with</span></span><br /><span class="line"><span class="comment">     * dot '.', for example: for {<span class="doctag">@code</span> com.alibaba.dubbo.xxx.YyyInvokerWrapper}, its default name is</span></span><br /><span class="line"><span class="comment">     * &lt;code&gt;String[] {"yyy.invoker.wrapper"}&lt;/code&gt;. This name will be used to search for parameter from URL.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> parameter key names in URL</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * ä» {<span class="doctag">@link</span> URL }çš„ Key åï¼Œå¯¹åº”çš„ Value ä½œä¸ºè¦ Adapt æˆçš„ Extension åã€‚</span></span><br /><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br /><span class="line"><span class="comment">     * å¦‚æœ {<span class="doctag">@link</span> URL} è¿™äº› Key éƒ½æ²¡æœ‰ Value ï¼Œä½¿ç”¨ ç¼ºçœçš„æ‰©å±•ï¼ˆåœ¨æ¥å£çš„{<span class="doctag">@link</span> SPI}ä¸­è®¾å®šçš„å€¼ï¼‰ã€‚&lt;br&gt;</span></span><br /><span class="line"><span class="comment">     * æ¯”å¦‚ï¼Œ&lt;code&gt;String[] {"key1", "key2"}&lt;/code&gt;ï¼Œè¡¨ç¤º</span></span><br /><span class="line"><span class="comment">     * &lt;ol&gt;</span></span><br /><span class="line"><span class="comment">     *      &lt;li&gt;å…ˆåœ¨URLä¸Šæ‰¾key1çš„Valueä½œä¸ºè¦Adaptæˆçš„Extensionåï¼›</span></span><br /><span class="line"><span class="comment">     *      &lt;li&gt;key1æ²¡æœ‰Valueï¼Œåˆ™ä½¿ç”¨key2çš„Valueä½œä¸ºè¦Adaptæˆçš„Extensionåã€‚</span></span><br /><span class="line"><span class="comment">     *      &lt;li&gt;key2æ²¡æœ‰Valueï¼Œä½¿ç”¨ç¼ºçœçš„æ‰©å±•ã€‚</span></span><br /><span class="line"><span class="comment">     *      &lt;li&gt;å¦‚æœæ²¡æœ‰è®¾å®šç¼ºçœæ‰©å±•ï¼Œåˆ™æ–¹æ³•è°ƒç”¨ä¼šæŠ›å‡º{<span class="doctag">@link</span> IllegalStateException}ã€‚</span></span><br /><span class="line"><span class="comment">     * &lt;/ol&gt;</span></span><br /><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br /><span class="line"><span class="comment">     * å¦‚æœä¸è®¾ç½®åˆ™ç¼ºçœä½¿ç”¨Extensionæ¥å£ç±»åçš„ç‚¹åˆ†éš”å°å†™å­—ä¸²ã€‚&lt;br&gt;</span></span><br /><span class="line"><span class="comment">     * å³å¯¹äºExtensionæ¥å£ {<span class="doctag">@code</span> com.alibaba.dubbo.xxx.YyyInvokerWrapper} çš„ç¼ºçœå€¼ä¸º &lt;code&gt;String[] {"yyy.invoker.wrapper"}&lt;/code&gt;</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@see</span> SPI#value()</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    String[] value() <span class="keyword">default</span> {};</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p><code>@Adaptive</code>&nbsp;æ³¨è§£ï¼Œå¯æ·»åŠ <strong>ç±»</strong>æˆ–<strong>æ–¹æ³•</strong>ä¸Šï¼Œåˆ†åˆ«ä»£è¡¨äº†ä¸¤ç§ä¸åŒçš„ä½¿ç”¨æ–¹å¼ã€‚</p>
<blockquote>
<p>å‹æƒ…æç¤ºï¼šä¸€ä¸ªæ‹“å±•æ¥å£ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€ä¸ª Adaptive æ‹“å±•å®ç°ç±»ã€‚</p>
</blockquote>
<ul>
<li>ç¬¬ä¸€ç§ï¼Œæ ‡è®°åœ¨<strong>ç±»</strong>ä¸Šï¼Œä»£è¡¨<strong>æ‰‹åŠ¨å®ç°</strong>å®ƒæ˜¯ä¸€ä¸ªæ‹“å±•æ¥å£çš„ Adaptive æ‹“å±•å®ç°ç±»ã€‚ç›®å‰ Dubbo é¡¹ç›®é‡Œï¼Œåªæœ‰ ExtensionFactory æ‹“å±•çš„å®ç°ç±» AdaptiveExtensionFactory æœ‰è¿™ä¹ˆç”¨ã€‚è¯¦ç»†è§£æè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/">ã€Œ8.1 AdaptiveExtensionFactoryã€</a>ã€‚</li>
<li>ç¬¬äºŒç§ï¼Œæ ‡è®°åœ¨æ‹“å±•æ¥å£çš„<strong>æ–¹æ³•</strong>ä¸Šï¼Œä»£è¡¨<strong>è‡ªåŠ¨ç”Ÿæˆä»£ç å®ç°</strong>è¯¥æ¥å£çš„ Adaptive æ‹“å±•å®ç°ç±»ã€‚
<ul>
<li><code>value</code>&nbsp;ï¼Œä» Dubbo URL è·å–å‚æ•°ä¸­ï¼Œä½¿ç”¨é”®å( Key )ï¼Œè·å–é”®å€¼ã€‚è¯¥å€¼ä¸º<strong>çœŸæ­£çš„</strong>æ‹“å±•åã€‚
<ul>
<li>è‡ªé€‚åº”æ‹“å±•å®ç°ç±»ï¼Œä¼šè·å–æ‹“å±•åå¯¹åº”çš„<strong>çœŸæ­£</strong>çš„æ‹“å±•å¯¹è±¡ã€‚é€šè¿‡è¯¥å¯¹è±¡ï¼Œæ‰§è¡ŒçœŸæ­£çš„é€»è¾‘ã€‚</li>
<li>å¯ä»¥è®¾ç½®<strong>å¤šä¸ª</strong>é”®å( Key )ï¼Œé¡ºåºè·å–ç›´åˆ°<strong>æœ‰å€¼</strong>ã€‚è‹¥æœ€ç»ˆè·å–ä¸åˆ°ï¼Œä½¿ç”¨<strong>é»˜è®¤æ‹“å±•å</strong>ã€‚</li>
</ul>
</li>
<li>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/">ã€Œ4.5.4 createAdaptiveExtensionClassCodeã€</a>&nbsp;è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
</ul>
<h1 id="7-Activate">7. @Activate</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/Activate.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.common.extension.@Activate</code></a>&nbsp;ï¼Œè‡ªåŠ¨æ¿€æ´»æ¡ä»¶çš„æ ‡è®°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Documented</span></span><br /><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br /><span class="line"><span class="meta">@Target</span>({ElementType.TYPE, ElementType.METHOD})</span><br /><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Activate {</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Activate the current extension when one of the groups matches. The group passed into</span></span><br /><span class="line"><span class="comment">     * {<span class="doctag">@link</span> ExtensionLoader#getActivateExtension(URL, String, String)} will be used for matching.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> group names to match</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@see</span> ExtensionLoader#getActivateExtension(URL, String, String)</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Groupè¿‡æ»¤æ¡ä»¶ã€‚</span></span><br /><span class="line"><span class="comment">     * &lt;br /&gt;</span></span><br /><span class="line"><span class="comment">     * åŒ…å«{<span class="doctag">@link</span> ExtensionLoader#getActivateExtension}çš„groupå‚æ•°ç»™çš„å€¼ï¼Œåˆ™è¿”å›æ‰©å±•ã€‚</span></span><br /><span class="line"><span class="comment">     * &lt;br /&gt;</span></span><br /><span class="line"><span class="comment">     * å¦‚æ²¡æœ‰Groupè®¾ç½®ï¼Œåˆ™ä¸è¿‡æ»¤ã€‚</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    String[] group() <span class="keyword">default</span> {};</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Activate the current extension when the specified keys appear in the URL's parameters.</span></span><br /><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br /><span class="line"><span class="comment">     * For example, given &lt;code&gt;<span class="doctag">@Activate</span>("cache, validation")&lt;/code&gt;, the current extension will be return only when</span></span><br /><span class="line"><span class="comment">     * there's either &lt;code&gt;cache&lt;/code&gt; or &lt;code&gt;validation&lt;/code&gt; key appeared in the URL's parameters.</span></span><br /><span class="line"><span class="comment">     * &lt;/p&gt;</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> URL parameter keys</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@see</span> ExtensionLoader#getActivateExtension(URL, String)</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@see</span> ExtensionLoader#getActivateExtension(URL, String, String)</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Keyè¿‡æ»¤æ¡ä»¶ã€‚åŒ…å«{<span class="doctag">@link</span> ExtensionLoader#getActivateExtension}çš„URLçš„å‚æ•°Keyä¸­æœ‰ï¼Œåˆ™è¿”å›æ‰©å±•ã€‚</span></span><br /><span class="line"><span class="comment">     * &lt;p/&gt;</span></span><br /><span class="line"><span class="comment">     * ç¤ºä¾‹ï¼š&lt;br/&gt;</span></span><br /><span class="line"><span class="comment">     * æ³¨è§£çš„å€¼ &lt;code&gt;<span class="doctag">@Activate</span>("cache,validatioin")&lt;/code&gt;ï¼Œ</span></span><br /><span class="line"><span class="comment">     * åˆ™{<span class="doctag">@link</span> ExtensionLoader#getActivateExtension}çš„URLçš„å‚æ•°æœ‰&lt;code&gt;cache&lt;/code&gt;Keyï¼Œæˆ–æ˜¯&lt;code&gt;validatioin&lt;/code&gt;åˆ™è¿”å›æ‰©å±•ã€‚</span></span><br /><span class="line"><span class="comment">     * &lt;br/&gt;</span></span><br /><span class="line"><span class="comment">     * å¦‚æ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä¸è¿‡æ»¤ã€‚</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    String[] value() <span class="keyword">default</span> {};</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Relative ordering info, optional</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> extension list which should be put before the current one</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ’åºä¿¡æ¯ï¼Œå¯ä»¥ä¸æä¾›ã€‚</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    String[] before() <span class="keyword">default</span> {};</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Relative ordering info, optional</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> extension list which should be put after the current one</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ’åºä¿¡æ¯ï¼Œå¯ä»¥ä¸æä¾›ã€‚</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    String[] after() <span class="keyword">default</span> {};</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Absolute ordering info, optional</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> absolute ordering info</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ’åºä¿¡æ¯ï¼Œå¯ä»¥ä¸æä¾›ã€‚</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">order</span><span class="params">()</span> <span class="keyword">default</span> 0</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¯¹äºå¯ä»¥è¢«æ¡†æ¶ä¸­è‡ªåŠ¨æ¿€æ´»åŠ è½½æ‰©å±•ï¼Œ<code>@Activate</code>&nbsp;ç”¨äºé…ç½®æ‰©å±•è¢«è‡ªåŠ¨æ¿€æ´»åŠ è½½æ¡ä»¶ã€‚æ¯”å¦‚ï¼ŒFilter æ‰©å±•ï¼Œæœ‰å¤šä¸ªå®ç°ï¼Œä½¿ç”¨&nbsp;<code>@Activate</code>&nbsp;çš„æ‰©å±•å¯ä»¥æ ¹æ®<strong>æ¡ä»¶</strong>è¢«è‡ªåŠ¨åŠ è½½ã€‚
<ul>
<li>è¿™å—çš„ä¾‹å­ï¼Œå¯ä»¥çœ‹ä¸‹&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/">ã€ŠDubbo å¼€å‘æŒ‡å— &mdash;&mdash; æ‰©å±•ç‚¹åŠ è½½ã€‹ã€Œæ‰©å±•ç‚¹è‡ªåŠ¨æ¿€æ´»ã€</a>&nbsp;æ–‡æ¡£æä¾›çš„ã€‚</li>
</ul>
</li>
<li>ğŸ™‚ åˆ†æˆè¿‡æ»¤æ¡ä»¶å’Œæ’åºä¿¡æ¯<strong>ä¸¤ç±»å±æ€§</strong>ï¼Œèƒ–å‹çœ‹ä¸‹ä»£ç é‡Œçš„æ³¨é‡Šã€‚</li>
<li>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/">ã€Œ4.6 è·å¾—æ¿€æ´»çš„æ‹“å±•å¯¹è±¡æ•°ç»„ã€</a>&nbsp;è¯¦ç»†è§£æã€‚</li>
</ul>
<h1 id="8-ExtensionFactory">8. ExtensionFactory</h1>
<p><a href="http://svip.iocoder.cn/Dubbo/spi/"><code>com.alibaba.dubbo.common.extension.ExtensionFactory</code></a>&nbsp;ï¼Œæ‹“å±•å·¥å‚æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ExtensionFactory</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * æ‹“å±•å·¥å‚æ¥å£</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="meta">@SPI</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExtensionFactory</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Get extension.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * è·å¾—æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> type object type. æ‹“å±•æ¥å£</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> name object name. æ‹“å±•å</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> object instance. æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    &lt;T&gt; <span class="function">T <span class="title">getExtension</span><span class="params">(Class&lt;T&gt; type, String name)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ExtensionFactory è‡ªèº«ä¹Ÿæ˜¯æ‹“å±•æ¥å£ï¼ŒåŸºäº Dubbo SPI åŠ è½½å…·ä½“æ‹“å±•å®ç°ç±»ã€‚</li>
<li><code>#getExtension(type, name)</code>&nbsp;æ–¹æ³•ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/">ã€Œ4.4.3 injectExtensionã€</a>&nbsp;ä¸­ï¼Œè·å¾—æ‹“å±•å¯¹è±¡ï¼Œå‘åˆ›å»ºçš„æ‹“å±•å¯¹è±¡<strong>æ³¨å…¥ä¾èµ–å±æ€§</strong>ã€‚åœ¨å®é™…ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸ä»…ä»…è·å¾—çš„æ˜¯æ‹“å±•å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ Spring ä¸­çš„ Bean å¯¹è±¡ã€‚</li>
<li>ExtensionFactory å­ç±»ç±»å›¾å¦‚ä¸‹ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_03_04/06.png" alt="ExtensionFactory ç±»å›¾" /></li>
</ul>
<h2 id="8-1-AdaptiveExtensionFactory">8.1 AdaptiveExtensionFactory</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/4a877ee283af70c3f6a19c3b8b8e6918696540e6/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/factory/AdaptiveExtensionFactory.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.common.extension.factory.AdaptiveExtensionFactory</code></a>&nbsp;ï¼Œè‡ªé€‚åº” ExtensionFactory æ‹“å±•å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Adaptive</span></span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdaptiveExtensionFactory</span> <span class="keyword">implements</span> <span class="title">ExtensionFactory</span> </span>{</span><br /><span class="line"> <span class="number">3</span>: </span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 5:      * ExtensionFactory æ‹“å±•å¯¹è±¡é›†åˆ</span></span><br /><span class="line"><span class="comment"> 6:      */</span></span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ExtensionFactory&gt; factories;</span><br /><span class="line"> <span class="number">8</span>: </span><br /><span class="line"> <span class="number">9</span>:     <span class="function"><span class="keyword">public</span> <span class="title">AdaptiveExtensionFactory</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">10</span>:         <span class="comment">// ä½¿ç”¨ ExtensionLoader åŠ è½½æ‹“å±•å¯¹è±¡å®ç°ç±»ã€‚</span></span><br /><span class="line"><span class="number">11</span>:         ExtensionLoader&lt;ExtensionFactory&gt; loader = ExtensionLoader.getExtensionLoader(ExtensionFactory.class);</span><br /><span class="line"><span class="number">12</span>:         List&lt;ExtensionFactory&gt; list = <span class="keyword">new</span> ArrayList&lt;ExtensionFactory&gt;();</span><br /><span class="line"><span class="number">13</span>:         <span class="keyword">for</span> (String name : loader.getSupportedExtensions()) {</span><br /><span class="line"><span class="number">14</span>:             list.add(loader.getExtension(name));</span><br /><span class="line"><span class="number">15</span>:         }</span><br /><span class="line"><span class="number">16</span>:         factories = Collections.unmodifiableList(list);</span><br /><span class="line"><span class="number">17</span>:     }</span><br /><span class="line"><span class="number">18</span>: </span><br /><span class="line"><span class="number">19</span>:     <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getExtension</span><span class="params">(Class&lt;T&gt; type, String name)</span> </span>{</span><br /><span class="line"><span class="number">20</span>:         <span class="comment">// éå†å·¥å‚æ•°ç»„ï¼Œç›´åˆ°è·å¾—åˆ°å±æ€§</span></span><br /><span class="line"><span class="number">21</span>:         <span class="keyword">for</span> (ExtensionFactory factory : factories) {</span><br /><span class="line"><span class="number">22</span>:             T extension = factory.getExtension(type, name);</span><br /><span class="line"><span class="number">23</span>:             <span class="keyword">if</span> (extension != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">24</span>:                 <span class="keyword">return</span> extension;</span><br /><span class="line"><span class="number">25</span>:             }</span><br /><span class="line"><span class="number">26</span>:         }</span><br /><span class="line"><span class="number">27</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">28</span>:     }</span><br /><span class="line"><span class="number">29</span>: </span><br /><span class="line"><span class="number">30</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>@Adaptive</code>&nbsp;æ³¨è§£ï¼Œä¸º ExtensionFactory çš„<strong>è‡ªé€‚åº”</strong>æ‹“å±•å®ç°ç±»ã€‚</li>
<li><strong>æ„é€ </strong>æ–¹æ³•ï¼Œä½¿ç”¨ ExtensionLoader åŠ è½½ ExtensionFactory æ‹“å±•å¯¹è±¡çš„å®ç°ç±»ã€‚è‹¥èƒ–å‹æ²¡è‡ªå·±å®ç° ExtensionFactory çš„æƒ…å†µä¸‹ï¼Œ<code>factories</code>&nbsp;ä¸º SpiExtensionFactory å’Œ SpringExtensionFactory ã€‚</li>
<li><code>#getExtension(type, name)</code>&nbsp;æ–¹æ³•ï¼Œéå†&nbsp;<code>factories</code>&nbsp;ï¼Œè°ƒç”¨å…¶&nbsp;<code>#getExtension(type, name)</code>&nbsp;æ–¹æ³•ï¼Œç›´åˆ°è·å¾—åˆ°å±æ€§å€¼ã€‚</li>
</ul>
<h2 id="8-2-SpiExtensionFactory">8.2 SpiExtensionFactory</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/4a877ee283af70c3f6a19c3b8b8e6918696540e6/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/factory/SpiExtensionFactory.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.common.extension.factory.SpiExtensionFactory</code></a>&nbsp;ï¼ŒSPI ExtensionFactory æ‹“å±•å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpiExtensionFactory</span> <span class="keyword">implements</span> <span class="title">ExtensionFactory</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * è·å¾—æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> type object type. æ‹“å±•æ¥å£</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> name object name. æ‹“å±•å</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> &lt;T&gt; æ³›å‹</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ‹“å±•å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getExtension</span><span class="params">(Class&lt;T&gt; type, String name)</span> </span>{</span><br /><span class="line">        <span class="keyword">if</span> (type.isInterface() &amp;&amp; type.isAnnotationPresent(SPI.class)) { <span class="comment">// æ ¡éªŒæ˜¯ @SPI</span></span><br /><span class="line">            <span class="comment">// åŠ è½½æ‹“å±•æ¥å£å¯¹åº”çš„ ExtensionLoader å¯¹è±¡</span></span><br /><span class="line">            ExtensionLoader&lt;T&gt; loader = ExtensionLoader.getExtensionLoader(type);</span><br /><span class="line">            <span class="comment">// åŠ è½½æ‹“å±•å¯¹è±¡</span></span><br /><span class="line">            <span class="keyword">if</span> (!loader.getSupportedExtensions().isEmpty()) {</span><br /><span class="line">                <span class="keyword">return</span> loader.getAdaptiveExtension();</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="8-3-SpringExtensionFactory">8.3 SpringExtensionFactory</h2>
<p><a href="http://svip.iocoder.cn/Dubbo/spi/SpringExtensionFactory"><code>com.alibaba.dubbo.config.spring.extension.SpringExtensionFactory</code></a>&nbsp;ï¼ŒSpring ExtensionFactory æ‹“å±•å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringExtensionFactory</span> <span class="keyword">implements</span> <span class="title">ExtensionFactory</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Spring Context é›†åˆ</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;ApplicationContext&gt; contexts = <span class="keyword">new</span> ConcurrentHashSet&lt;ApplicationContext&gt;();</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addApplicationContext</span><span class="params">(ApplicationContext context)</span> </span>{</span><br /><span class="line">        contexts.add(context);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeApplicationContext</span><span class="params">(ApplicationContext context)</span> </span>{</span><br /><span class="line">        contexts.remove(context);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getExtension</span><span class="params">(Class&lt;T&gt; type, String name)</span> </span>{</span><br /><span class="line">        <span class="keyword">for</span> (ApplicationContext context : contexts) {</span><br /><span class="line">            <span class="keyword">if</span> (context.containsBean(name)) {</span><br /><span class="line">                <span class="comment">// è·å¾—å±æ€§</span></span><br /><span class="line">                Object bean = context.getBean(name);</span><br /><span class="line">                <span class="comment">// åˆ¤æ–­ç±»å‹</span></span><br /><span class="line">                <span class="keyword">if</span> (type.isInstance(bean)) {</span><br /><span class="line">                    <span class="keyword">return</span> (T) bean;</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>#getExtension(type, name)</code>&nbsp;æ–¹æ³•ï¼Œéå†&nbsp;<code>contexts</code>&nbsp;ï¼Œè°ƒç”¨å…¶&nbsp;<code>ApplicationContext#getBean(name)</code>æ–¹æ³•ï¼Œè·å¾— Bean å¯¹è±¡ï¼Œç›´åˆ°æˆåŠŸå¹¶ä¸”å€¼ç±»å‹æ­£ç¡®ã€‚</li>
</ul>
<h3 id="8-3-1-ä¾‹å­">8.3.1 ä¾‹å­</h3>
<p>DemoFilter æ˜¯ç¬”è€…å®ç°çš„ Filter æ‹“å±•å®ç°ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> DemoDAO demoDAO;</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="keyword">return</span> invoker.invoke(invocation);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> DemoFilter <span class="title">setDemoDAO</span><span class="params">(DemoDAO demoDAO)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.demoDAO = demoDAO;</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>DemoDAO ï¼Œç¬”è€…åœ¨ Spring ä¸­å£°æ˜å¯¹åº”çš„ Bean å¯¹è±¡ã€‚</p>
<figure class="highlight xml">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"demoDAO"</span> <span class="attr">class</span>=<span class="string">"com.alibaba.dubbo.demo.provider.DemoDAO"</span> /&gt;</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spi/">ã€Œ4.4.3 injectExtensionã€</a>&nbsp;ä¸­ï¼Œä¼šè°ƒç”¨&nbsp;<code>#setDemoDAO(demo)</code>&nbsp;æ–¹æ³•ï¼Œå°† DemoFilter ä¾èµ–çš„å±æ€§&nbsp;<code>demoDAO</code>&nbsp;æ³¨å…¥ã€‚</p>
</li>
</ul>
</div>