<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆå››ï¼‰ä¹‹ EventLoop è¿è¡Œ
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡æˆ‘ä»¬åˆ†äº« EventLoop çš„<strong>è¿è¡Œ</strong>ç›¸å…³ä»£ç çš„å®ç°ã€‚</p>
<p>å› ä¸º EventLoop çš„<strong>è¿è¡Œ</strong>ä¸»è¦æ˜¯é€šè¿‡ NioEventLoop çš„ <code>#run()</code> æ–¹æ³•å®ç°ï¼Œè€ƒè™‘åˆ°å†…å®¹ç›¸å¯¹çš„å®Œæ•´æ€§ï¼Œåœ¨ <a href="http://svip.iocoder.cn">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆä¸‰ï¼‰ä¹‹ EventLoop åˆå§‹åŒ–ã€‹</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å¹¶æœªåˆ†äº« NioEventLoop çš„<strong>åˆå§‹åŒ–</strong>ï¼Œæ‰€ä»¥æœ¬æ–‡ä¹Ÿä¼šåˆ†äº«è¿™éƒ¨åˆ†çš„å†…å®¹ã€‚</p>
<p>OK ï¼Œè¿˜æ˜¯è€æ ·å­ï¼Œè‡ªä¸Šè€Œä¸‹çš„æ–¹å¼ï¼Œä¸€èµ·æ¥çœ‹çœ‹ NioEventLoop çš„ä»£ç å®ç°ã€‚</p>
<blockquote>
<p>è€è‰¿è‰¿ï¼Œæœ¬æ–‡çš„é‡ç‚¹åœ¨ <a href="#">ã€Œ2.9 runã€</a> å’Œ <a href="#">ã€Œ2.12 selectã€</a> ä¸­ã€‚</p>
</blockquote>
<h1 id="2-NioEventLoop"><a href="#2-NioEventLoop" class="headerlink" title="2. NioEventLoop"></a>2. NioEventLoop</h1><p><code>io.netty.channel.nio.NioEventLoop</code> ï¼Œç»§æ‰¿ SingleThreadEventLoop æŠ½è±¡ç±»ï¼ŒNIO EventLoop å®ç°ç±»ï¼Œå®ç°å¯¹æ³¨å†Œåˆ°å…¶ä¸­çš„ Channel çš„å°±ç»ªçš„ IO äº‹ä»¶ï¼Œå’Œå¯¹ç”¨æˆ·æäº¤çš„ä»»åŠ¡è¿›è¡Œå¤„ç†ã€‚</p>
<h2 id="2-1-static"><a href="#2-1-static" class="headerlink" title="2.1 static"></a>2.1 static</h2><p>åœ¨ <code>static</code> ä»£ç å—ä¸­ï¼Œåˆå§‹åŒ–äº† NioEventLoop çš„é™æ€å±æ€§ä»¬ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TODO 1007 NioEventLoop cancel</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CLEANUP_INTERVAL = <span class="number">256</span>; <span class="comment">// XXX Hard-coded value, but won't need customization.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦ç¦ç”¨ SelectionKey çš„ä¼˜åŒ–ï¼Œé»˜è®¤å¼€å¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> DISABLE_KEYSET_OPTIMIZATION = SystemPropertyUtil.getBoolean(<span class="string">"io.netty.noKeySetOptimization"</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°‘äºè¯¥ N å€¼ï¼Œä¸å¼€å¯ç©ºè½®è¯¢é‡å»ºæ–°çš„ Selector å¯¹è±¡çš„åŠŸèƒ½</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MIN_PREMATURE_SELECTOR_RETURNS = <span class="number">3</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * NIO Selector ç©ºè½®è¯¢è¯¥ N æ¬¡åï¼Œé‡å»ºæ–°çš„ Selector å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SELECTOR_AUTO_REBUILD_THRESHOLD;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> {</span><br><span class="line">    <span class="comment">// è§£å†³ Selector#open() æ–¹æ³• // &lt;1&gt;</span></span><br><span class="line">    <span class="keyword">final</span> String key = <span class="string">"sun.nio.ch.bugLevel"</span>;</span><br><span class="line">    <span class="keyword">final</span> String buglevel = SystemPropertyUtil.get(key);</span><br><span class="line">    <span class="keyword">if</span> (buglevel == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">                    System.setProperty(key, <span class="string">""</span>);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                }</span><br><span class="line">            });</span><br><span class="line">        } <span class="keyword">catch</span> (<span class="keyword">final</span> SecurityException e) {</span><br><span class="line">            logger.debug(<span class="string">"Unable to get/set System Property: "</span> + key, e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">int</span> selectorAutoRebuildThreshold = SystemPropertyUtil.getInt(<span class="string">"io.netty.selectorAutoRebuildThreshold"</span>, <span class="number">512</span>);</span><br><span class="line">    <span class="keyword">if</span> (selectorAutoRebuildThreshold &lt; MIN_PREMATURE_SELECTOR_RETURNS) {</span><br><span class="line">        selectorAutoRebuildThreshold = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    SELECTOR_AUTO_REBUILD_THRESHOLD = selectorAutoRebuildThreshold;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) {</span><br><span class="line">        logger.debug(<span class="string">"-Dio.netty.noKeySetOptimization: {}"</span>, DISABLE_KEYSET_OPTIMIZATION);</span><br><span class="line">        logger.debug(<span class="string">"-Dio.netty.selectorAutoRebuildThreshold: {}"</span>, SELECTOR_AUTO_REBUILD_THRESHOLD);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>CLEANUP_INTERVAL</code> å±æ€§ï¼ŒTODO 1007 NioEventLoop cancel</li>
<li><code>DISABLE_KEYSET_OPTIMIZATION</code> å±æ€§ï¼Œæ˜¯å¦ç¦ç”¨ SelectionKey çš„ä¼˜åŒ–ï¼Œé»˜è®¤å¼€å¯ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/EventLoop-5-EventLoop-handle-io-event?self">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆäº”ï¼‰ä¹‹ EventLoop å¤„ç† IO äº‹ä»¶ã€‹</a> ã€‚</li>
<li><code>SELECTOR_AUTO_REBUILD_THRESHOLD</code> å±æ€§ï¼ŒNIO Selector ç©ºè½®è¯¢è¯¥ N æ¬¡åï¼Œé‡å»ºæ–°çš„ Selector å¯¹è±¡ï¼Œç”¨ä»¥è§£å†³ JDK NIO çš„ epoll ç©ºè½®è¯¢ Bug ã€‚<ul>
<li><code>MIN_PREMATURE_SELECTOR_RETURNS</code> å±æ€§ï¼Œå°‘äºè¯¥ N å€¼ï¼Œä¸å¼€å¯ç©ºè½®è¯¢é‡å»ºæ–°çš„ Selector å¯¹è±¡çš„åŠŸèƒ½ã€‚</li>
</ul>
</li>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè§£å†³ <code>Selector#open()</code> æ–¹æ³•ï¼Œå‘ç”Ÿ NullPointException å¼‚å¸¸ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://bugs.sun.com/view_bug.do?bug_id=6427854" rel="external nofollow noopener noreferrer" target="_blank">http://bugs.sun.com/view_bug.do?bug_id=6427854</a> å’Œ <a href="https://github.com/netty/netty/issues/203" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/netty/netty/issues/203</a> ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œåˆå§‹åŒ– <code>SELECTOR_AUTO_REBUILD_THRESHOLD</code> å±æ€§ã€‚é»˜è®¤ 512 ã€‚</li>
</ul>
<h2 id="2-2-æ„é€ æ–¹æ³•"><a href="#2-2-æ„é€ æ–¹æ³•" class="headerlink" title="2.2 æ„é€ æ–¹æ³•"></a>2.2 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The NIO {<span class="doctag">@link</span> Selector}.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * åŒ…è£…çš„ Selector å¯¹è±¡ï¼Œç»è¿‡ä¼˜åŒ–</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #openSelector()}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Selector selector;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœªåŒ…è£…çš„ Selector å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Selector unwrappedSelector;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ³¨å†Œçš„ SelectionKey é›†åˆã€‚Netty è‡ªå·±å®ç°ï¼Œç»è¿‡ä¼˜åŒ–ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> SelectedSelectionKeySet selectedKeys;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SelectorProvider å¯¹è±¡ï¼Œç”¨äºåˆ›å»º Selector å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SelectorProvider provider;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Boolean that controls determines if a blocked Selector.select should</span></span><br><span class="line"><span class="comment"> * break out of its selection process. In our case we use a timeout for</span></span><br><span class="line"><span class="comment"> * the select method and the select method will block for that time unless</span></span><br><span class="line"><span class="comment"> * waken up.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å”¤é†’æ ‡è®°ã€‚å› ä¸ºå”¤é†’æ–¹æ³• {<span class="doctag">@link</span> Selector#wakeup()} å¼€é”€æ¯”è¾ƒå¤§ï¼Œé€šè¿‡è¯¥æ ‡è¯†ï¼Œå‡å°‘è°ƒç”¨ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #wakeup(boolean)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #run() </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> AtomicBoolean wakenUp = <span class="keyword">new</span> AtomicBoolean();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Select ç­–ç•¥</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #select(boolean)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SelectStrategy selectStrategy;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤„ç† Channel çš„å°±ç»ªçš„ IO äº‹ä»¶ï¼Œå å¤„ç†ä»»åŠ¡çš„æ€»æ—¶é—´çš„æ¯”ä¾‹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> ioRatio = <span class="number">50</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å–æ¶ˆ SelectionKey çš„æ•°é‡</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * TODO 1007 NioEventLoop cancel</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> cancelledKeys;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦éœ€è¦å†æ¬¡ select Selector å¯¹è±¡</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * TODO 1007 NioEventLoop cancel</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> needsToSelectAgain;</span><br><span class="line"></span><br><span class="line">NioEventLoop(NioEventLoopGroup parent, Executor executor, SelectorProvider selectorProvider,</span><br><span class="line">             SelectStrategy strategy, RejectedExecutionHandler rejectedExecutionHandler) {</span><br><span class="line">    <span class="keyword">super</span>(parent, executor, <span class="keyword">false</span>, DEFAULT_MAX_PENDING_TASKS, rejectedExecutionHandler);</span><br><span class="line">    <span class="keyword">if</span> (selectorProvider == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"selectorProvider"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (strategy == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"selectStrategy"</span>);</span><br><span class="line">    }</span><br><span class="line">    provider = selectorProvider;</span><br><span class="line">    <span class="comment">// åˆ›å»º Selector å¯¹è±¡ &lt;1&gt;</span></span><br><span class="line">    <span class="keyword">final</span> SelectorTuple selectorTuple = openSelector();</span><br><span class="line">    selector = selectorTuple.selector;</span><br><span class="line">    unwrappedSelector = selectorTuple.unwrappedSelector;</span><br><span class="line">    selectStrategy = strategy;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Selector ç›¸å…³ï¼š<ul>
<li><code>unwrappedSelector</code> å±æ€§ï¼ŒæœªåŒ…è£…çš„ NIO Selector å¯¹è±¡ã€‚</li>
<li><code>selector</code> å±æ€§ï¼ŒåŒ…è£…çš„ NIO Selector å¯¹è±¡ã€‚Netty å¯¹ NIO Selector åšäº†ä¼˜åŒ–ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/EventLoop-5-EventLoop-handle-io-event?self">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆäº”ï¼‰ä¹‹ EventLoop å¤„ç† IO äº‹ä»¶ã€‹</a> ã€‚</li>
<li><code>selectedKeys</code> å±æ€§ï¼Œæ³¨å†Œçš„ NIO SelectionKey é›†åˆã€‚Netty è‡ªå·±å®ç°ï¼Œç»è¿‡ä¼˜åŒ–ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/EventLoop-5-EventLoop-handle-io-event?self">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆäº”ï¼‰ä¹‹ EventLoop å¤„ç† IO äº‹ä»¶ã€‹</a> ã€‚ </li>
<li><code>provider</code> å±æ€§ï¼ŒNIO SelectorProvider å¯¹è±¡ï¼Œç”¨äºåˆ›å»º NIO Selector å¯¹è±¡ã€‚</li>
<li>åœ¨ <code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#openSelector()</code> æ–¹æ³•ï¼Œåˆ›å»º NIO Selector å¯¹è±¡ã€‚</li>
</ul>
</li>
<li><code>wakenUp</code> å±æ€§ï¼Œå”¤é†’æ ‡è®°ã€‚å› ä¸ºå”¤é†’æ–¹æ³• <code>Selector#wakeup()</code> å¼€é”€æ¯”è¾ƒå¤§ï¼Œé€šè¿‡è¯¥æ ‡è¯†ï¼Œå‡å°‘è°ƒç”¨ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.8 wakeupã€</a> ã€‚</li>
<li><code>selectStrategy</code> å±æ€§ï¼ŒSelect ç­–ç•¥ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.10 SelectStrategyã€</a> ã€‚</li>
<li><code>ioRatio</code> å±æ€§ï¼Œåœ¨ NioEventLoop ä¸­ï¼Œä¼šä¸‰ç§ç±»å‹çš„ä»»åŠ¡ï¼š1) Channel çš„å°±ç»ªçš„ IO äº‹ä»¶ï¼›2) æ™®é€šä»»åŠ¡ï¼›3) å®šæ—¶ä»»åŠ¡ã€‚è€Œ <code>ioRatio</code> å±æ€§ï¼Œå¤„ç† Channel çš„å°±ç»ªçš„ IO äº‹ä»¶ï¼Œå å¤„ç†ä»»åŠ¡çš„æ€»æ—¶é—´çš„æ¯”ä¾‹ã€‚</li>
<li>å–æ¶ˆ SelectionKey ç›¸å…³ï¼š<ul>
<li><code>cancelledKeys</code> å±æ€§ï¼Œ å–æ¶ˆ SelectionKey çš„æ•°é‡ã€‚TODO 1007 NioEventLoop cancel</li>
<li><code>needsToSelectAgain</code> å±æ€§ï¼Œæ˜¯å¦éœ€è¦å†æ¬¡ select Selector å¯¹è±¡ã€‚TODO 1007 NioEventLoop cancel</li>
</ul>
</li>
</ul>
<h2 id="2-3-openSelector"><a href="#2-3-openSelector" class="headerlink" title="2.3 openSelector"></a>2.3 openSelector</h2><p><code>#openSelector()</code> æ–¹æ³•ï¼Œåˆ›å»º NIO Selector å¯¹è±¡ã€‚</p>
<p>è€ƒè™‘åˆ°è®©æœ¬æ–‡æ›´ä¸“æ³¨åœ¨ EventLoop çš„é€»è¾‘ï¼Œå¹¶ä¸”ä¸å½±å“å¯¹æœ¬æ–‡çš„ç†è§£ï¼Œæ‰€ä»¥æš‚æ—¶ä¸è®²è§£å®ƒçš„å…·ä½“å®ç°ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/EventLoop-5-EventLoop-handle-io-event?self">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆäº”ï¼‰ä¹‹ EventLoop å¤„ç† IO äº‹ä»¶ã€‹</a> ã€‚ </p>
<h2 id="2-4-rebuildSelector"><a href="#2-4-rebuildSelector" class="headerlink" title="2.4 rebuildSelector"></a>2.4 rebuildSelector</h2><p><code>#rebuildSelector()</code> æ–¹æ³•ï¼Œé‡å»º NIO Selector å¯¹è±¡ã€‚</p>
<p>è€ƒè™‘åˆ°è®©æœ¬æ–‡æ›´ä¸“æ³¨åœ¨ EventLoop çš„é€»è¾‘ï¼Œå¹¶ä¸”ä¸å½±å“å¯¹æœ¬æ–‡çš„ç†è§£ï¼Œæ‰€ä»¥æš‚æ—¶ä¸è®²è§£å®ƒçš„å…·ä½“å®ç°ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/EventLoop-5-EventLoop-handle-io-event?self">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆäº”ï¼‰ä¹‹ EventLoop å¤„ç† IO äº‹ä»¶ã€‹</a> ã€‚</p>
<h2 id="2-5-newTaskQueue"><a href="#2-5-newTaskQueue" class="headerlink" title="2.5 newTaskQueue"></a>2.5 newTaskQueue</h2><p><code>#newTaskQueue(int maxPendingTasks)</code> æ–¹æ³•ï¼Œåˆ›å»ºä»»åŠ¡é˜Ÿåˆ—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>è¯¥æ–¹æ³•è¦†å†™çˆ¶ç±»çš„è¯¥æ–¹æ³•ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Queue&lt;Runnable&gt; <span class="title">newTaskQueue</span><span class="params">(<span class="keyword">int</span> maxPendingTasks)</span> </span>{</span><br><span class="line">    <span class="comment">// This event loop never calls takeTask()</span></span><br><span class="line">    <span class="keyword">return</span> maxPendingTasks == Integer.MAX_VALUE ? PlatformDependent.&lt;Runnable&gt;newMpscQueue()</span><br><span class="line">                                                : PlatformDependent.&lt;Runnable&gt;newMpscQueue(maxPendingTasks);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>PlatformDependent#newMpscQueue(...)</code> æ–¹æ³•ï¼Œåˆ›å»º mpsc é˜Ÿåˆ—ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç æ³¨é‡Šå¯¹ mpsc é˜Ÿåˆ—çš„æè¿°ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">Create a <span class="keyword">new</span> {<span class="meta">@link</span> Queue} <span class="function">which is safe to use <span class="keyword">for</span> multiple <span class="title">producers</span> <span class="params">(different threads)</span> and a single <span class="title">consumer</span> <span class="params">(one thread!)</span>.</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>mpsc æ˜¯ multiple producers and a single consumer çš„ç¼©å†™ã€‚</li>
<li>mpsc æ˜¯å¯¹<strong>å¤š</strong>çº¿ç¨‹ç”Ÿäº§ä»»åŠ¡ï¼Œ<strong>å•</strong>çº¿ç¨‹æ¶ˆè´¹ä»»åŠ¡çš„æ¶ˆè´¹ï¼Œæ°å¥½ç¬¦åˆ NioEventLoop çš„æƒ…å†µã€‚</li>
<li>è¯¦ç»†è§£æï¼Œè§åç»­æ–‡ç« ã€‚å½“ç„¶ï¼Œç€æ€¥çš„èƒ–å‹ï¼Œå¯ä»¥å…ˆçœ‹çœ‹ <a href="https://www.jianshu.com/p/119a03332619" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠåŸç†å‰–æï¼ˆç¬¬ 012 ç¯‡ï¼‰Netty ä¹‹æ— é”é˜Ÿåˆ— MpscUnboundedArrayQueue åŸç†åˆ†æã€‹</a> ã€‚</li>
</ul>
</li>
</ul>
<h2 id="2-6-pendingTasks"><a href="#2-6-pendingTasks" class="headerlink" title="2.6 pendingTasks"></a>2.6 pendingTasks</h2><p><code>#pendingTasks()</code> æ–¹æ³•ï¼Œè·å¾—å¾…æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>è¯¥æ–¹æ³•è¦†å†™çˆ¶ç±»çš„è¯¥æ–¹æ³•ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">pendingTasks</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// As we use a MpscQueue we need to ensure pendingTasks() is only executed from within the EventLoop as</span></span><br><span class="line">    <span class="comment">// otherwise we may see unexpected behavior (as size() is only allowed to be called by a single consumer).</span></span><br><span class="line">    <span class="comment">// See https://github.com/netty/netty/issues/5297</span></span><br><span class="line">    <span class="keyword">if</span> (inEventLoop()) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.pendingTasks();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> submit(pendingTasksCallable).syncUninterruptibly().getNow();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å› ä¸º MpscQueue ä»…å…è®¸å•æ¶ˆè´¹ï¼Œæ‰€ä»¥è·å¾—é˜Ÿåˆ—çš„å¤§å°ï¼Œä»…å…è®¸åœ¨ EventLoop çš„çº¿ç¨‹ä¸­è°ƒç”¨ã€‚</li>
</ul>
<h2 id="2-7-setIoRatio"><a href="#2-7-setIoRatio" class="headerlink" title="2.7 setIoRatio"></a>2.7 setIoRatio</h2><p><code>#setIoRatio(int ioRatio)</code> æ–¹æ³•ï¼Œè®¾ç½® <code>ioRatio</code> å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sets the percentage of the desired amount of time spent for I/O in the event loop.  The default value is</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@code</span> 50}, which means the event loop will try to spend the same amount of time for I/O as for non-I/O tasks.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIoRatio</span><span class="params">(<span class="keyword">int</span> ioRatio)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (ioRatio &lt;= <span class="number">0</span> || ioRatio &gt; <span class="number">100</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"ioRatio: "</span> + ioRatio + <span class="string">" (expected: 0 &lt; ioRatio &lt;= 100)"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">this</span>.ioRatio = ioRatio;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-8-wakeup"><a href="#2-8-wakeup" class="headerlink" title="2.8 wakeup"></a>2.8 wakeup</h2><p><code>#wakeup(boolean inEventLoop)</code> æ–¹æ³•ï¼Œå”¤é†’çº¿ç¨‹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">wakeup</span><span class="params">(<span class="keyword">boolean</span> inEventLoop)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!inEventLoop &amp;&amp; wakenUp.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) { <span class="comment">// &lt;2&gt;</span></span><br><span class="line">        selector.wakeup(); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œå› ä¸º NioEventLoop çš„çº¿ç¨‹é˜»å¡ï¼Œä¸»è¦æ˜¯è°ƒç”¨ <code>Selector#select(long timeout)</code> æ–¹æ³•ï¼Œé˜»å¡ç­‰å¾…æœ‰ Channel æ„Ÿå…´è¶£çš„ IO äº‹ä»¶ï¼Œæˆ–è€…è¶…æ—¶ã€‚æ‰€ä»¥éœ€è¦è°ƒç”¨ <code>Selector#wakeup()</code> æ–¹æ³•ï¼Œè¿›è¡Œå”¤é†’ Selector ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œå› ä¸º <code>Selector#wakeup()</code> æ–¹æ³•çš„å”¤é†’æ“ä½œæ˜¯å¼€é”€æ¯”è¾ƒå¤§çš„æ“ä½œï¼Œå¹¶ä¸”æ¯æ¬¡é‡å¤è°ƒç”¨ç›¸å½“äºé‡å¤å”¤é†’ã€‚æ‰€ä»¥ï¼Œé€šè¿‡ <code>wakenUp</code> å±æ€§ï¼Œé€šè¿‡ CAS ä¿®æ”¹ <code>false =&gt; true</code> ï¼Œä¿è¯æœ‰ä¸”ä»…æœ‰è¿›è¡Œä¸€æ¬¡å”¤é†’ã€‚</li>
<li>å½“ç„¶ï¼Œè¯¦ç»†çš„è§£æï¼Œå¯ä»¥ç»“åˆ <a href="#">ã€Œ2.9 runã€</a> ä¸€èµ·çœ‹ï¼Œè¿™æ ·ä¼šæ›´åŠ æ¸…æ™°æ˜äº†ã€‚</li>
</ul>
<h2 id="2-9-run"><a href="#2-9-run" class="headerlink" title="2.9 run"></a>2.9 run</h2><p><code>#run()</code> æ–¹æ³•ï¼ŒNioEventLoop è¿è¡Œï¼Œå¤„ç†ä»»åŠ¡ã€‚<strong>è¿™æ˜¯æœ¬æ–‡æœ€é‡è¦çš„æ–¹æ³•</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">for</span> (;;) {</span><br><span class="line"> <span class="number">4</span>:         <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">5</span>:             <span class="keyword">switch</span> (selectStrategy.calculateStrategy(selectNowSupplier, hasTasks())) {</span><br><span class="line"> <span class="number">6</span>:                 <span class="keyword">case</span> SelectStrategy.CONTINUE: <span class="comment">// é»˜è®¤å®ç°ä¸‹ï¼Œä¸å­˜åœ¨è¿™ä¸ªæƒ…å†µã€‚</span></span><br><span class="line"> <span class="number">7</span>:                     <span class="keyword">continue</span>;</span><br><span class="line"> <span class="number">8</span>:                 <span class="keyword">case</span> SelectStrategy.SELECT:</span><br><span class="line"> <span class="number">9</span>:                     <span class="comment">// é‡ç½® wakenUp æ ‡è®°ä¸º false</span></span><br><span class="line"><span class="number">10</span>:                     <span class="comment">// é€‰æ‹©( æŸ¥è¯¢ )ä»»åŠ¡</span></span><br><span class="line"><span class="number">11</span>:                     select(wakenUp.getAndSet(<span class="keyword">false</span>));</span><br><span class="line"><span class="number">12</span>: </span><br><span class="line"><span class="number">13</span>:                     <span class="comment">// 'wakenUp.compareAndSet(false, true)' is always evaluated</span></span><br><span class="line"><span class="number">14</span>:                     <span class="comment">// before calling 'selector.wakeup()' to reduce the wake-up</span></span><br><span class="line"><span class="number">15</span>:                     <span class="comment">// overhead. (Selector.wakeup() is an expensive operation.)</span></span><br><span class="line"><span class="number">16</span>:                     <span class="comment">//</span></span><br><span class="line"><span class="number">17</span>:                     <span class="comment">// However, there is a race condition in this approach.</span></span><br><span class="line"><span class="number">18</span>:                     <span class="comment">// The race condition is triggered when 'wakenUp' is set to</span></span><br><span class="line"><span class="number">19</span>:                     <span class="comment">// true too early.</span></span><br><span class="line"><span class="number">20</span>:                     <span class="comment">//</span></span><br><span class="line"><span class="number">21</span>:                     <span class="comment">// 'wakenUp' is set to true too early if:</span></span><br><span class="line"><span class="number">22</span>:                     <span class="comment">// 1) Selector is waken up between 'wakenUp.set(false)' and</span></span><br><span class="line"><span class="number">23</span>:                     <span class="comment">//    'selector.select(...)'. (BAD)</span></span><br><span class="line"><span class="number">24</span>:                     <span class="comment">// 2) Selector is waken up between 'selector.select(...)' and</span></span><br><span class="line"><span class="number">25</span>:                     <span class="comment">//    'if (wakenUp.get()) { ... }'. (OK)</span></span><br><span class="line"><span class="number">26</span>:                     <span class="comment">//</span></span><br><span class="line"><span class="number">27</span>:                     <span class="comment">// In the first case, 'wakenUp' is set to true and the</span></span><br><span class="line"><span class="number">28</span>:                     <span class="comment">// following 'selector.select(...)' will wake up immediately.</span></span><br><span class="line"><span class="number">29</span>:                     <span class="comment">// Until 'wakenUp' is set to false again in the next round,</span></span><br><span class="line"><span class="number">30</span>:                     <span class="comment">// 'wakenUp.compareAndSet(false, true)' will fail, and therefore</span></span><br><span class="line"><span class="number">31</span>:                     <span class="comment">// any attempt to wake up the Selector will fail, too, causing</span></span><br><span class="line"><span class="number">32</span>:                     <span class="comment">// the following 'selector.select(...)' call to block</span></span><br><span class="line"><span class="number">33</span>:                     <span class="comment">// unnecessarily.</span></span><br><span class="line"><span class="number">34</span>:                     <span class="comment">//</span></span><br><span class="line"><span class="number">35</span>:                     <span class="comment">// To fix this problem, we wake up the selector again if wakenUp</span></span><br><span class="line"><span class="number">36</span>:                     <span class="comment">// is true immediately after selector.select(...).</span></span><br><span class="line"><span class="number">37</span>:                     <span class="comment">// It is inefficient in that it wakes up the selector for both</span></span><br><span class="line"><span class="number">38</span>:                     <span class="comment">// the first case (BAD - wake-up required) and the second case</span></span><br><span class="line"><span class="number">39</span>:                     <span class="comment">// (OK - no wake-up required).</span></span><br><span class="line"><span class="number">40</span>: </span><br><span class="line"><span class="number">41</span>:                     <span class="comment">// å”¤é†’ã€‚åŸå› ï¼Œè§ä¸Šé¢ä¸­æ–‡æ³¨é‡Š</span></span><br><span class="line"><span class="number">42</span>:                     <span class="keyword">if</span> (wakenUp.get()) {</span><br><span class="line"><span class="number">43</span>:                         selector.wakeup();</span><br><span class="line"><span class="number">44</span>:                     }</span><br><span class="line"><span class="number">45</span>:                     <span class="comment">// fall through</span></span><br><span class="line"><span class="number">46</span>:                 <span class="keyword">default</span>:</span><br><span class="line"><span class="number">47</span>:             }</span><br><span class="line"><span class="number">48</span>: </span><br><span class="line"><span class="number">49</span>:             <span class="comment">// TODO 1007 NioEventLoop cancel æ–¹æ³•</span></span><br><span class="line"><span class="number">50</span>:             cancelledKeys = <span class="number">0</span>;</span><br><span class="line"><span class="number">51</span>:             needsToSelectAgain = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">52</span>: </span><br><span class="line"><span class="number">53</span>:             <span class="keyword">final</span> <span class="keyword">int</span> ioRatio = <span class="keyword">this</span>.ioRatio;</span><br><span class="line"><span class="number">54</span>:             <span class="keyword">if</span> (ioRatio == <span class="number">100</span>) {</span><br><span class="line"><span class="number">55</span>:                 <span class="keyword">try</span> {</span><br><span class="line"><span class="number">56</span>:                     <span class="comment">// å¤„ç† Channel æ„Ÿå…´è¶£çš„å°±ç»ª IO äº‹ä»¶</span></span><br><span class="line"><span class="number">57</span>:                     processSelectedKeys();</span><br><span class="line"><span class="number">58</span>:                 } <span class="keyword">finally</span> {</span><br><span class="line"><span class="number">59</span>:                     <span class="comment">// è¿è¡Œæ‰€æœ‰æ™®é€šä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ï¼Œä¸é™åˆ¶æ—¶é—´</span></span><br><span class="line"><span class="number">60</span>:                     <span class="comment">// Ensure we always run tasks.</span></span><br><span class="line"><span class="number">61</span>:                     runAllTasks();</span><br><span class="line"><span class="number">62</span>:                 }</span><br><span class="line"><span class="number">63</span>:             } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">64</span>:                 <span class="keyword">final</span> <span class="keyword">long</span> ioStartTime = System.nanoTime();</span><br><span class="line"><span class="number">65</span>:                 <span class="keyword">try</span> {</span><br><span class="line"><span class="number">66</span>:                     <span class="comment">// å¤„ç† Channel æ„Ÿå…´è¶£çš„å°±ç»ª IO äº‹ä»¶</span></span><br><span class="line"><span class="number">67</span>:                     processSelectedKeys();</span><br><span class="line"><span class="number">68</span>:                 } <span class="keyword">finally</span> {</span><br><span class="line"><span class="number">69</span>:                     <span class="comment">// è¿è¡Œæ‰€æœ‰æ™®é€šä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ï¼Œé™åˆ¶æ—¶é—´</span></span><br><span class="line"><span class="number">70</span>:                     <span class="comment">// Ensure we always run tasks.</span></span><br><span class="line"><span class="number">71</span>:                     <span class="keyword">final</span> <span class="keyword">long</span> ioTime = System.nanoTime() - ioStartTime;</span><br><span class="line"><span class="number">72</span>:                     runAllTasks(ioTime * (<span class="number">100</span> - ioRatio) / ioRatio);</span><br><span class="line"><span class="number">73</span>:                 }</span><br><span class="line"><span class="number">74</span>:             }</span><br><span class="line"><span class="number">75</span>:         } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line"><span class="number">76</span>:             handleLoopException(t);</span><br><span class="line"><span class="number">77</span>:         }</span><br><span class="line"><span class="number">78</span>:         <span class="comment">// TODO 1006 EventLoop ä¼˜é›…å…³é—­</span></span><br><span class="line"><span class="number">79</span>:         <span class="comment">// Always handle shutdown even if the loop processing threw an exception.</span></span><br><span class="line"><span class="number">80</span>:         <span class="keyword">try</span> {</span><br><span class="line"><span class="number">81</span>:             <span class="keyword">if</span> (isShuttingDown()) {</span><br><span class="line"><span class="number">82</span>:                 closeAll();</span><br><span class="line"><span class="number">83</span>:                 <span class="keyword">if</span> (confirmShutdown()) {</span><br><span class="line"><span class="number">84</span>:                     <span class="keyword">return</span>;</span><br><span class="line"><span class="number">85</span>:                 }</span><br><span class="line"><span class="number">86</span>:             }</span><br><span class="line"><span class="number">87</span>:         } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line"><span class="number">88</span>:             handleLoopException(t);</span><br><span class="line"><span class="number">89</span>:         }</span><br><span class="line"><span class="number">90</span>:     }</span><br><span class="line"><span class="number">91</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šâ€œæ­»â€å¾ªç¯ï¼Œç›´åˆ° NioEventLoop å…³é—­ï¼Œå³ã€ç¬¬ 78 è‡³ 89 è¡Œã€‘çš„ä»£ç ã€‚</li>
<li>ç¬¬ 5 è¡Œï¼šè°ƒç”¨ <code>SelectStrategy#calculateStrategy(IntSupplier selectSupplier, boolean hasTasks)</code> æ–¹æ³•ï¼Œè·å¾—ä½¿ç”¨çš„ select ç­–ç•¥ã€‚è¯¦ç»†è§£æï¼Œèƒ–å‹å…ˆè·³åˆ° <a href="#">ã€Œ2.10 SelectStrategyã€</a> ä¸­ç ”ç©¶ã€‚ğŸ˜ˆ çœ‹å®Œå›æ¥ã€‚<ul>
<li>æˆ‘ä»¬çŸ¥é“ <code>SelectStrategy#calculateStrategy(...)</code> æ–¹æ³•ï¼Œæœ‰ 3 ç§è¿”å›çš„æƒ…å†µã€‚</li>
<li>ç¬¬ 6 è‡³ 7 è¡Œï¼šç¬¬ä¸€ç§ï¼Œ<code>SelectStrategy.CONTINUE</code> ï¼Œé»˜è®¤å®ç°ä¸‹ï¼Œä¸å­˜åœ¨è¿™ä¸ªæƒ…å†µã€‚</li>
<li>ç¬¬ 8 è‡³ 44 è¡Œï¼šç¬¬äºŒç§ï¼Œ<code>SelectStrategy.SELECT</code> ï¼Œè¿›è¡Œ Selector <strong>é˜»å¡</strong> select ã€‚<ul>
<li>ç¬¬ 11 è¡Œï¼šé‡ç½® <code>wakeUp</code> æ ‡è¯†ä¸º <code>false</code> ï¼Œå¹¶è¿”å›ä¿®æ”¹å‰çš„å€¼ã€‚</li>
<li>ç¬¬ 11 è¡Œï¼šè°ƒç”¨ <code>#select(boolean oldWakeUp)</code> æ–¹æ³•ï¼Œé€‰æ‹©( æŸ¥è¯¢ )ä»»åŠ¡ã€‚ç›´æ¥çœ‹è¿™ä¸ªæ–¹æ³•ä¸èƒ½å®Œå…¨è¡¨è¾¾å‡ºè¯¥æ–¹æ³•çš„ç”¨é€”ï¼Œæ‰€ä»¥è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.12 selectã€</a> ã€‚</li>
<li>ç¬¬ 41 è‡³ 44 è¡Œï¼šè‹¥å”¤é†’æ ‡è¯† <code>wakeup</code> ä¸º <code>true</code> æ—¶ï¼Œè°ƒç”¨ <code>Selector#wakeup()</code> æ–¹æ³•ï¼Œå”¤é†’ Selector ã€‚å¯èƒ½çœ‹åˆ°æ­¤å¤„ï¼Œå¾ˆå¤šèƒ–å‹ä¼šå’Œæˆ‘ä¸€æ ·ï¼Œä¸€è„¸æ‡µé€¼ã€‚å®é™…ä¸Šï¼Œ<strong>è€ä¸‹æ€§å­</strong>ï¼Œç­”æ¡ˆåœ¨ä¸Šé¢çš„<strong>è‹±æ–‡æ³¨é‡Š</strong>ä¸­ã€‚ç¬”è€…æ¥ç®€å•è§£æä¸‹ï¼š<ul>
<li>1ï¼‰åœ¨ <code>wakenUp.getAndSet(false)</code> å’Œ <code>#select(boolean oldWakeUp)</code> ä¹‹é—´ï¼Œåœ¨æ ‡è¯† <code>wakeUp</code> è®¾ç½®ä¸º <code>false</code> æ—¶ï¼Œåœ¨ <code>#select(boolean oldWakeUp)</code> æ–¹æ³•ä¸­ï¼Œæ­£åœ¨è°ƒç”¨ <code>Selector#select(...)</code> æ–¹æ³•ï¼Œå¤„äº<strong>é˜»å¡</strong>ä¸­ã€‚</li>
<li>2ï¼‰æ­¤æ—¶ï¼Œæœ‰å¦å¤–çš„çº¿ç¨‹è°ƒç”¨äº† <code>#wakeup()</code> æ–¹æ³•ï¼Œä¼šå°†æ ‡è®° <code>wakeUp</code> è®¾ç½®ä¸º <code>true</code> ï¼Œå¹¶<strong>å”¤é†’</strong> <code>Selector#select(...)</code> æ–¹æ³•çš„é˜»å¡ç­‰å¾…ã€‚</li>
<li>3ï¼‰æ ‡è¯† <code>wakeUp</code> ä¸º <code>true</code> ï¼Œæ‰€ä»¥å†æœ‰å¦å¤–çš„çº¿ç¨‹è°ƒç”¨ <code>#wakeup()</code> æ–¹æ³•ï¼Œéƒ½æ— æ³•å”¤é†’ <code>Selector#select(...)</code> ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º <code>#wakeup()</code> çš„ CAS ä¿®æ”¹ <code>false =&gt; true</code> ä¼š<strong>å¤±è´¥</strong>ï¼Œå¯¼è‡´æ— æ³•è°ƒç”¨ <code>Selector#wakeup()</code> æ–¹æ³•ã€‚</li>
<li>è§£å†³æ–¹å¼ï¼šæ‰€ä»¥åœ¨ <code>#select(boolean oldWakeUp)</code> æ‰§è¡Œå®Œåï¼Œå¢åŠ äº†ã€ç¬¬ 41 è‡³ 44 è¡Œã€‘æ¥è§£å†³ã€‚</li>
<li>ğŸ˜ˆğŸ˜ˆğŸ˜ˆ æ•´ä½“æ¯”è¾ƒç»•ï¼Œèƒ–å‹ç»“åˆå®ç°ä»£ç  + è‹±æ–‡æ³¨é‡Šï¼Œå†å¥½å¥½ç†è§£ä¸‹ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 46 è¡Œï¼šç¬¬ä¸‰ç§ï¼Œ<code>&gt;= 0</code> ï¼Œå·²ç»æœ‰å¯ä»¥å¤„ç†çš„ä»»åŠ¡ï¼Œç›´æ¥å‘ä¸‹ã€‚</li>
</ul>
</li>
<li>ç¬¬ 49 è‡³ 51 è¡Œï¼šTODO 1007 NioEventLoop cancel æ–¹æ³•</li>
<li>ç¬¬ 53 è‡³ 74 è¡Œï¼šæ ¹æ® <code>ioRatio</code> çš„é…ç½®ä¸åŒï¼Œåˆ†æˆ<strong>ç•¥æœ‰å·®å¼‚</strong>çš„ 2 ç§ï¼š<ul>
<li>ç¬¬ä¸€ç§ï¼Œ<code>ioRatio</code> ä¸º 100 ï¼Œåˆ™<strong>ä¸è€ƒè™‘</strong>æ—¶é—´å æ¯”çš„åˆ†é…ã€‚<ul>
<li>ç¬¬ 57 è¡Œï¼šè°ƒç”¨ <code>#processSelectedKeys()</code> æ–¹æ³•ï¼Œå¤„ç† Channel æ„Ÿå…´è¶£çš„å°±ç»ª IO äº‹ä»¶ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/EventLoop-5-EventLoop-handle-io-event?self">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆäº”ï¼‰ä¹‹ EventLoop å¤„ç† IO äº‹ä»¶ã€‹</a> ã€‚</li>
<li>ç¬¬ 58 è‡³ 62 è¡Œï¼šè°ƒç”¨ <code>#runAllTasks()</code> æ–¹æ³•ï¼Œè¿è¡Œæ‰€æœ‰æ™®é€šä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ï¼Œ<strong>ä¸é™åˆ¶æ—¶é—´</strong>ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/EventLoop-5-EventLoop-handle-io-event?self">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆäº”ï¼‰ä¹‹ EventLoop å¤„ç† IO äº‹ä»¶ã€‹</a> ã€‚</li>
</ul>
</li>
<li>ç¬¬äºŒç§ï¼Œ<code>ioRatio</code> ä¸º <code>&lt; 100</code> ï¼Œåˆ™<strong>è€ƒè™‘</strong>æ—¶é—´å æ¯”çš„åˆ†é…ã€‚<ul>
<li>ç¬¬ 64 è¡Œï¼šè®°å½•å½“å‰æ—¶é—´ã€‚</li>
<li>ç¬¬ 67 è¡Œï¼šå’Œã€ç¬¬ 57 è¡Œã€‘çš„ä»£ç <strong>ä¸€æ ·</strong>ã€‚ </li>
<li>ç¬¬ 71 è‡³ 72 è¡Œï¼šğŸ™‚ æ¯”è¾ƒå·§å¦™çš„æ–¹å¼ï¼Œæ˜¯ä¸æ˜¯å’Œèƒ–å‹ä¹‹å‰è®¤ä¸ºçš„ä¸å¤ªä¸€æ ·ã€‚å®ƒæ˜¯ä»¥ <code>#processSelectedKeys()</code> æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ä½œä¸º<strong>åŸºå‡†</strong>ï¼Œè®¡ç®— <code>#runAllTasks(long timeoutNanos)</code> æ–¹æ³•å¯æ‰§è¡Œçš„æ—¶é—´ã€‚</li>
<li>ç¬¬ 72 è¡Œï¼šè°ƒç”¨ #runAllTasks(long timeoutNanos)` æ–¹æ³•ï¼Œè¿è¡Œæ‰€æœ‰æ™®é€šä»»åŠ¡å’Œå®šæ—¶ä»»åŠ¡ï¼Œ<strong>é™åˆ¶æ—¶é—´</strong>ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p>ç¬¬ 75 è‡³ 77 è¡Œï¼šå½“å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè°ƒç”¨ <code>#handleLoopException(Throwable t)</code> æ–¹æ³•ï¼Œå¤„ç†å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleLoopException</span><span class="params">(Throwable t)</span> </span>{</span><br><span class="line">    logger.warn(<span class="string">"Unexpected exception in the selector loop."</span>, t);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prevent possible consecutive immediate failures that lead to</span></span><br><span class="line">    <span class="comment">// excessive CPU consumption.</span></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    } <span class="keyword">catch</span> (InterruptedException e) {</span><br><span class="line">        <span class="comment">// Ignore.</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ç¬¬ 78 è‡³ 89 è¡Œï¼šTODO 1006 EventLoop ä¼˜é›…å…³é—­</p>
</li>
<li>æ€»çš„æ¥è¯´ï¼Œ<code>#run()</code> çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œå°±æ˜¯å¦‚ä¸‹ä¸€å¼ å›¾ï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_05_10/01.png" title="run" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_05_10/01.png" alt="run"></a><span class="caption">run</span></li>
</ul>
<h2 id="2-10-SelectStrategy"><a href="#2-10-SelectStrategy" class="headerlink" title="2.10 SelectStrategy"></a>2.10 SelectStrategy</h2><p><code>io.netty.channel.SelectStrategy</code> ï¼Œé€‰æ‹©( select )ç­–ç•¥æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SelectStrategy</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Indicates a blocking select should follow.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * è¡¨ç¤ºä½¿ç”¨é˜»å¡ select çš„ç­–ç•¥ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> SELECT = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Indicates the IO loop should be retried, no blocking select to follow directly.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * è¡¨ç¤ºéœ€è¦è¿›è¡Œé‡è¯•çš„ç­–ç•¥ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> CONTINUE = -<span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The {<span class="doctag">@link</span> SelectStrategy} can be used to steer the outcome of a potential select</span></span><br><span class="line"><span class="comment">     * call.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> selectSupplier The supplier with the result of a select result.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> hasTasks true if tasks are waiting to be processed.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> {<span class="doctag">@link</span> #SELECT} if the next step should be blocking select {<span class="doctag">@link</span> #CONTINUE} if</span></span><br><span class="line"><span class="comment">     *         the next step should be to not select but rather jump back to the IO loop and try</span></span><br><span class="line"><span class="comment">     *         again. Any value &gt;= 0 is treated as an indicator that work needs to be done.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">calculateStrategy</span><span class="params">(IntSupplier selectSupplier, <span class="keyword">boolean</span> hasTasks)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>calculateStrategy(IntSupplier selectSupplier, boolean hasTasks)</code> æ¥å£æ–¹æ³•æœ‰ <strong>3</strong> ç§è¿”å›çš„æƒ…å†µï¼š<ul>
<li><code>SELECT</code>ï¼Œ<code>-1</code> ï¼Œè¡¨ç¤ºä½¿ç”¨é˜»å¡ <strong>select</strong> çš„ç­–ç•¥ã€‚</li>
<li><code>CONTINUE</code>ï¼Œ<code>-2</code>ï¼Œè¡¨ç¤ºéœ€è¦è¿›è¡Œé‡è¯•çš„ç­–ç•¥ã€‚å®é™…ä¸Šï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä¸ä¼šè¿”å› <code>CONTINUE</code> çš„ç­–ç•¥ã€‚</li>
<li><code>&gt;= 0</code> ï¼Œè¡¨ç¤ºä¸éœ€è¦ select  ï¼Œç›®å‰å·²ç»æœ‰å¯ä»¥æ‰§è¡Œçš„ä»»åŠ¡äº†ã€‚</li>
</ul>
</li>
</ul>
<h3 id="2-10-1-DefaultSelectStrategy"><a href="#2-10-1-DefaultSelectStrategy" class="headerlink" title="2.10.1 DefaultSelectStrategy"></a>2.10.1 DefaultSelectStrategy</h3><p><code>io.netty.channel.DefaultSelectStrategy</code> ï¼Œå®ç° SelectStrategy æ¥å£ï¼Œé»˜è®¤é€‰æ‹©ç­–ç•¥å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultSelectStrategy</span> <span class="keyword">implements</span> <span class="title">SelectStrategy</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å•ä¾‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> SelectStrategy INSTANCE = <span class="keyword">new</span> DefaultSelectStrategy();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">DefaultSelectStrategy</span><span class="params">()</span> </span>{ }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">calculateStrategy</span><span class="params">(IntSupplier selectSupplier, <span class="keyword">boolean</span> hasTasks)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">return</span> hasTasks ? selectSupplier.get() : SelectStrategy.SELECT;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>å½“ <code>hasTasks</code> ä¸º <code>true</code> ï¼Œè¡¨ç¤ºå½“å‰å·²ç»æœ‰ä»»åŠ¡ï¼Œæ‰€ä»¥è°ƒç”¨ <code>IntSupplier#get()</code> æ–¹æ³•ï¼Œè¿”å›å½“å‰ Channel æ–°å¢çš„ IO å°±ç»ªäº‹ä»¶çš„æ•°é‡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> IntSupplier selectNowSupplier = <span class="keyword">new</span> IntSupplier() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">return</span> selectNow();</span><br><span class="line">    }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><code>io.netty.util.IntSupplier</code> ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IntSupplier</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Gets a result.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> a result</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç±»ä¼¼ Java è‡ªå¸¦çš„ <code>Callable&lt;Int&gt;</code> ã€‚</li>
</ul>
</li>
<li>IntSupplier åœ¨ NioEventLoop ä¸­çš„å®ç°ä¸º <code>selectNowSupplier</code> å±æ€§ã€‚åœ¨å®ƒçš„å†…éƒ¨ä¼šè°ƒç”¨ <code>#selectNow()</code> æ–¹æ³•ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.11 selectNowã€</a> ã€‚</li>
<li>å®é™…ä¸Šï¼Œè¿™é‡Œä¸è°ƒç”¨ <code>IntSupplier#get()</code> æ–¹æ³•ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„ã€‚åªä¸è¿‡è€ƒè™‘åˆ°ï¼Œå¯ä»¥é€šè¿‡ <code>#selectNow()</code> æ–¹æ³•ï¼Œ<strong>æ— é˜»å¡</strong>çš„ select Channel æ˜¯å¦æœ‰æ„Ÿå…´è¶£çš„å°±ç»ªäº‹ä»¶ã€‚</li>
</ul>
</li>
<li>å½“ <code>hasTasks</code> ä¸º <code>false</code> æ—¶ï¼Œç›´æ¥è¿”å› <code>SelectStrategy.SELECT</code> ï¼Œè¿›è¡Œ<strong>é˜»å¡</strong> select Channel æ„Ÿå…´è¶£çš„å°±ç»ª IO äº‹ä»¶ã€‚</li>
</ul>
<h2 id="2-11-selectNow"><a href="#2-11-selectNow" class="headerlink" title="2.11 selectNow"></a>2.11 selectNow</h2><p><code>#selectNow()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">selectNow</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">return</span> selector.selectNow(); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        <span class="comment">// restore wakeup state if needed &lt;2&gt;</span></span><br><span class="line">        <span class="keyword">if</span> (wakenUp.get()) {</span><br><span class="line">            selector.wakeup();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>Selector#selectorNow()</code> æ–¹æ³•ï¼Œç«‹å³( <strong>æ— é˜»å¡</strong> )è¿”å› Channel æ–°å¢çš„æ„Ÿå…´è¶£çš„å°±ç»ª IO äº‹ä»¶æ•°é‡ã€‚</li>
<li><p><code>&lt;2&gt;</code> å¤„ï¼Œè‹¥å”¤é†’æ ‡è¯† <code>wakeup</code> ä¸º <code>true</code> æ—¶ï¼Œè°ƒç”¨ <code>Selector#wakeup()</code> æ–¹æ³•ï¼Œå”¤é†’ Selector ã€‚å› ä¸º <code>&lt;1&gt;</code> å¤„çš„ <code>Selector#selectorNow()</code> ä¼šä½¿ç”¨æˆ‘ä»¬å¯¹ Selector çš„å”¤é†’ï¼Œæ‰€ä»¥éœ€è¦è¿›è¡Œ<strong>å¤åŸ</strong>ã€‚æœ‰ä¸€ä¸ªå†·çŸ¥é“ï¼Œå¯èƒ½æœ‰èƒ–å‹ä¸çŸ¥é“ï¼š</p>
<blockquote>
<p>æ³¨æ„ï¼Œå¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹è°ƒç”¨äº† <code>#wakeup()</code> æ–¹æ³•ï¼Œä½†å½“å‰æ²¡æœ‰çº¿ç¨‹é˜»å¡åœ¨ <code>#select()</code> æ–¹æ³•ä¸Šï¼Œä¸‹ä¸ªè°ƒç”¨ <code>#select()</code> æ–¹æ³•çš„çº¿ç¨‹ä¼šç«‹å³è¢«å”¤é†’ã€‚ğŸ˜ˆ æœ‰ç‚¹ç¥å¥‡ã€‚</p>
</blockquote>
</li>
</ul>
<h2 id="2-12-select"><a href="#2-12-select" class="headerlink" title="2.12 select"></a>2.12 select</h2><p><code>#select(boolean oldWakenUp)</code> æ–¹æ³•ï¼Œé€‰æ‹©( æŸ¥è¯¢ )ä»»åŠ¡ã€‚<strong>è¿™æ˜¯æœ¬æ–‡æœ€é‡è¦çš„æ–¹æ³•</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">select</span><span class="params">(<span class="keyword">boolean</span> oldWakenUp)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">  <span class="number">2</span>:     <span class="comment">// è®°å½•ä¸‹ Selector å¯¹è±¡</span></span><br><span class="line">  <span class="number">3</span>:     Selector selector = <span class="keyword">this</span>.selector;</span><br><span class="line">  <span class="number">4</span>:     <span class="keyword">try</span> {</span><br><span class="line">  <span class="number">5</span>:         <span class="comment">// select è®¡æ•°å™¨</span></span><br><span class="line">  <span class="number">6</span>:         <span class="keyword">int</span> selectCnt = <span class="number">0</span>; <span class="comment">// cnt ä¸º count çš„ç¼©å†™</span></span><br><span class="line">  <span class="number">7</span>:         <span class="comment">// è®°å½•å½“å‰æ—¶é—´ï¼Œå•ä½ï¼šçº³ç§’</span></span><br><span class="line">  <span class="number">8</span>:         <span class="keyword">long</span> currentTimeNanos = System.nanoTime();</span><br><span class="line">  <span class="number">9</span>:         <span class="comment">// è®¡ç®— select æˆªæ­¢æ—¶é—´ï¼Œå•ä½ï¼šçº³ç§’ã€‚</span></span><br><span class="line"> <span class="number">10</span>:         <span class="keyword">long</span> selectDeadLineNanos = currentTimeNanos + delayNanos(currentTimeNanos);</span><br><span class="line"> <span class="number">11</span>: </span><br><span class="line"> <span class="number">12</span>:         <span class="keyword">for</span> (;;) {</span><br><span class="line"> <span class="number">13</span>:             <span class="comment">// è®¡ç®—æœ¬æ¬¡ select çš„è¶…æ—¶æ—¶é•¿ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚</span></span><br><span class="line"> <span class="number">14</span>:             <span class="comment">// + 500000L æ˜¯ä¸ºäº†å››èˆäº”å…¥</span></span><br><span class="line"> <span class="number">15</span>:             <span class="comment">// / 1000000L æ˜¯ä¸ºäº†çº³ç§’è½¬ä¸ºæ¯«ç§’</span></span><br><span class="line"> <span class="number">16</span>:             <span class="keyword">long</span> timeoutMillis = (selectDeadLineNanos - currentTimeNanos + <span class="number">500000L</span>) / <span class="number">1000000L</span>;</span><br><span class="line"> <span class="number">17</span>:             <span class="comment">// å¦‚æœè¶…æ—¶æ—¶é•¿ï¼Œåˆ™ç»“æŸ select</span></span><br><span class="line"> <span class="number">18</span>:             <span class="keyword">if</span> (timeoutMillis &lt;= <span class="number">0</span>) {</span><br><span class="line"> <span class="number">19</span>:                 <span class="keyword">if</span> (selectCnt == <span class="number">0</span>) { <span class="comment">// å¦‚æœæ˜¯é¦–æ¬¡ select ï¼ŒselectNow ä¸€æ¬¡ï¼Œéé˜»å¡</span></span><br><span class="line"> <span class="number">20</span>:                     selector.selectNow();</span><br><span class="line"> <span class="number">21</span>:                     selectCnt = <span class="number">1</span>;</span><br><span class="line"> <span class="number">22</span>:                 }</span><br><span class="line"> <span class="number">23</span>:                 <span class="keyword">break</span>;</span><br><span class="line"> <span class="number">24</span>:             }</span><br><span class="line"> <span class="number">25</span>: </span><br><span class="line"> <span class="number">26</span>:             <span class="comment">// If a task was submitted when wakenUp value was true, the task didn't get a chance to call</span></span><br><span class="line"> <span class="number">27</span>:             <span class="comment">// Selector#wakeup. So we need to check task queue again before executing select operation.</span></span><br><span class="line"> <span class="number">28</span>:             <span class="comment">// If we don't, the task might be pended until select operation was timed out.</span></span><br><span class="line"> <span class="number">29</span>:             <span class="comment">// It might be pended until idle timeout if IdleStateHandler existed in pipeline.</span></span><br><span class="line"> <span class="number">30</span>:             <span class="comment">// è‹¥æœ‰æ–°çš„ä»»åŠ¡åŠ å…¥</span></span><br><span class="line"> <span class="number">31</span>:             <span class="keyword">if</span> (hasTasks() &amp;&amp; wakenUp.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) {</span><br><span class="line"> <span class="number">32</span>:                 <span class="comment">// selectNow ä¸€æ¬¡ï¼Œéé˜»å¡</span></span><br><span class="line"> <span class="number">33</span>:                 selector.selectNow();</span><br><span class="line"> <span class="number">34</span>:                 <span class="comment">// é‡ç½® select è®¡æ•°å™¨</span></span><br><span class="line"> <span class="number">35</span>:                 selectCnt = <span class="number">1</span>;</span><br><span class="line"> <span class="number">36</span>:                 <span class="keyword">break</span>;</span><br><span class="line"> <span class="number">37</span>:             }</span><br><span class="line"> <span class="number">38</span>: </span><br><span class="line"> <span class="number">39</span>:             <span class="comment">// é˜»å¡ select ï¼ŒæŸ¥è¯¢ Channel æ˜¯å¦æœ‰å°±ç»ªçš„ IO äº‹ä»¶</span></span><br><span class="line"> <span class="number">40</span>:             <span class="keyword">int</span> selectedKeys = selector.select(timeoutMillis);</span><br><span class="line"> <span class="number">41</span>:             <span class="comment">// select è®¡æ•°å™¨ ++</span></span><br><span class="line"> <span class="number">42</span>:             selectCnt ++;</span><br><span class="line"> <span class="number">43</span>: </span><br><span class="line"> <span class="number">44</span>:             <span class="comment">// ç»“æŸ select ï¼Œå¦‚æœæ»¡è¶³ä¸‹é¢ä»»ä¸€ä¸€ä¸ªæ¡ä»¶</span></span><br><span class="line"> <span class="number">45</span>:             <span class="keyword">if</span> (selectedKeys != <span class="number">0</span> || oldWakenUp || wakenUp.get() || hasTasks() || hasScheduledTasks()) {</span><br><span class="line"> <span class="number">46</span>:                 <span class="comment">// - Selected something,</span></span><br><span class="line"> <span class="number">47</span>:                 <span class="comment">// - waken up by user, or</span></span><br><span class="line"> <span class="number">48</span>:                 <span class="comment">// - the task queue has a pending task.</span></span><br><span class="line"> <span class="number">49</span>:                 <span class="comment">// - a scheduled task is ready for processing</span></span><br><span class="line"> <span class="number">50</span>:                 <span class="keyword">break</span>;</span><br><span class="line"> <span class="number">51</span>:             }</span><br><span class="line"> <span class="number">52</span>:             <span class="comment">// çº¿ç¨‹è¢«æ‰“æ–­ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šå‡ºç°ï¼Œå‡ºç°åŸºæœ¬æ˜¯ bug ï¼Œæˆ–è€…é”™è¯¯ä½¿ç”¨ã€‚</span></span><br><span class="line"> <span class="number">53</span>:             <span class="keyword">if</span> (Thread.interrupted()) {</span><br><span class="line"> <span class="number">54</span>:                 <span class="comment">// Thread was interrupted so reset selected keys and break so we not run into a busy loop.</span></span><br><span class="line"> <span class="number">55</span>:                 <span class="comment">// As this is most likely a bug in the handler of the user or it's client library we will</span></span><br><span class="line"> <span class="number">56</span>:                 <span class="comment">// also log it.</span></span><br><span class="line"> <span class="number">57</span>:                 <span class="comment">//</span></span><br><span class="line"> <span class="number">58</span>:                 <span class="comment">// See https://github.com/netty/netty/issues/2426</span></span><br><span class="line"> <span class="number">59</span>:                 <span class="keyword">if</span> (logger.isDebugEnabled()) {</span><br><span class="line"> <span class="number">60</span>:                     logger.debug(<span class="string">"Selector.select() returned prematurely because "</span> +</span><br><span class="line"> <span class="number">61</span>:                             <span class="string">"Thread.currentThread().interrupt() was called. Use "</span> +</span><br><span class="line"> <span class="number">62</span>:                             <span class="string">"NioEventLoop.shutdownGracefully() to shutdown the NioEventLoop."</span>);</span><br><span class="line"> <span class="number">63</span>:                 }</span><br><span class="line"> <span class="number">64</span>:                 selectCnt = <span class="number">1</span>;</span><br><span class="line"> <span class="number">65</span>:                 <span class="keyword">break</span>;</span><br><span class="line"> <span class="number">66</span>:             }</span><br><span class="line"> <span class="number">67</span>: </span><br><span class="line"> <span class="number">68</span>:             <span class="comment">// è®°å½•å½“å‰æ—¶é—´</span></span><br><span class="line"> <span class="number">69</span>:             <span class="keyword">long</span> time = System.nanoTime();</span><br><span class="line"> <span class="number">70</span>:             <span class="comment">// ç¬¦åˆ select è¶…æ—¶æ¡ä»¶ï¼Œé‡ç½® selectCnt ä¸º 1</span></span><br><span class="line"> <span class="number">71</span>:             <span class="keyword">if</span> (time - TimeUnit.MILLISECONDS.toNanos(timeoutMillis) &gt;= currentTimeNanos) {</span><br><span class="line"> <span class="number">72</span>:                 <span class="comment">// timeoutMillis elapsed without anything selected.</span></span><br><span class="line"> <span class="number">73</span>:                 selectCnt = <span class="number">1</span>;</span><br><span class="line"> <span class="number">74</span>:             <span class="comment">// ä¸ç¬¦åˆ select è¶…æ—¶çš„æäº¤ï¼Œè‹¥ select æ¬¡æ•°åˆ°è¾¾é‡å»º Selector å¯¹è±¡çš„ä¸Šé™ï¼Œè¿›è¡Œé‡å»º</span></span><br><span class="line"> <span class="number">75</span>:             } <span class="keyword">else</span> <span class="keyword">if</span> (SELECTOR_AUTO_REBUILD_THRESHOLD &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line"> <span class="number">76</span>:                     selectCnt &gt;= SELECTOR_AUTO_REBUILD_THRESHOLD) {</span><br><span class="line"> <span class="number">77</span>:                 <span class="comment">// The selector returned prematurely many times in a row.</span></span><br><span class="line"> <span class="number">78</span>:                 <span class="comment">// Rebuild the selector to work around the problem.</span></span><br><span class="line"> <span class="number">79</span>:                 logger.warn(<span class="string">"Selector.select() returned prematurely {} times in a row; rebuilding Selector {}."</span>, selectCnt, selector);</span><br><span class="line"> <span class="number">80</span>: </span><br><span class="line"> <span class="number">81</span>:                 <span class="comment">// é‡å»º Selector å¯¹è±¡</span></span><br><span class="line"> <span class="number">82</span>:                 rebuildSelector();</span><br><span class="line"> <span class="number">83</span>:                 <span class="comment">// ä¿®æ”¹ä¸‹ Selector å¯¹è±¡</span></span><br><span class="line"> <span class="number">84</span>:                 selector = <span class="keyword">this</span>.selector;</span><br><span class="line"> <span class="number">85</span>: </span><br><span class="line"> <span class="number">86</span>:                 <span class="comment">// Select again to populate selectedKeys.</span></span><br><span class="line"> <span class="number">87</span>:                 <span class="comment">// ç«‹å³ selectNow ä¸€æ¬¡ï¼Œéé˜»å¡</span></span><br><span class="line"> <span class="number">88</span>:                 selector.selectNow();</span><br><span class="line"> <span class="number">89</span>:                 <span class="comment">// é‡ç½® selectCnt ä¸º 1</span></span><br><span class="line"> <span class="number">90</span>:                 selectCnt = <span class="number">1</span>;</span><br><span class="line"> <span class="number">91</span>:                 <span class="comment">// ç»“æŸ select</span></span><br><span class="line"> <span class="number">92</span>:                 <span class="keyword">break</span>;</span><br><span class="line"> <span class="number">93</span>:             }</span><br><span class="line"> <span class="number">94</span>: </span><br><span class="line"> <span class="number">95</span>:             currentTimeNanos = time;</span><br><span class="line"> <span class="number">96</span>:         }</span><br><span class="line"> <span class="number">97</span>: </span><br><span class="line"> <span class="number">98</span>:         <span class="keyword">if</span> (selectCnt &gt; MIN_PREMATURE_SELECTOR_RETURNS) {</span><br><span class="line"> <span class="number">99</span>:             <span class="keyword">if</span> (logger.isDebugEnabled()) {</span><br><span class="line"><span class="number">100</span>:                 logger.debug(<span class="string">"Selector.select() returned prematurely {} times in a row for Selector {}."</span>, selectCnt - <span class="number">1</span>, selector);</span><br><span class="line"><span class="number">101</span>:             }</span><br><span class="line"><span class="number">102</span>:         }</span><br><span class="line"><span class="number">103</span>:     } <span class="keyword">catch</span> (CancelledKeyException e) {</span><br><span class="line"><span class="number">104</span>:         <span class="keyword">if</span> (logger.isDebugEnabled()) {</span><br><span class="line"><span class="number">105</span>:             logger.debug(CancelledKeyException.class.getSimpleName() + <span class="string">" raised by a Selector {} - JDK bug?"</span>, selector, e);</span><br><span class="line"><span class="number">106</span>:         }</span><br><span class="line"><span class="number">107</span>:         <span class="comment">// Harmless exception - log anyway</span></span><br><span class="line"><span class="number">108</span>:     }</span><br><span class="line"><span class="number">109</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šè·å¾—ä½¿ç”¨çš„ Selector å¯¹è±¡ï¼Œä¸éœ€è¦æ¯æ¬¡è®¿é—®ä½¿ç”¨ <code>volatile</code> ä¿®é¥°çš„ <code>selector</code> å±æ€§ã€‚</li>
<li>ç¬¬ 6 è¡Œï¼šè·å¾— select æ“ä½œçš„è®¡æ•°å™¨ã€‚ä¸»è¦ç”¨äºè®°å½• Selector ç©ºè½®è¯¢æ¬¡æ•°ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ­£åœ¨è½®è¯¢å®Œæˆ( ä¾‹å¦‚ï¼šè½®è¯¢è¶…æ—¶ )ï¼Œåˆ™é‡ç½® <code>selectCnt</code> ä¸º 1 ã€‚</li>
<li>ç¬¬ 8 è¡Œï¼šè®°å½•å½“å‰æ—¶é—´ï¼Œå•ä½ï¼šçº³ç§’ã€‚</li>
<li>ç¬¬ 10 è¡Œï¼šè®¡ç®— select æ“ä½œçš„æˆªæ­¢æ—¶é—´ï¼Œå•ä½ï¼šçº³ç§’ã€‚<ul>
<li><code>#delayNanos(currentTimeNanos)</code> æ–¹æ³•è¿”å›çš„ä¸ºä¸‹ä¸€ä¸ªå®šæ—¶ä»»åŠ¡è·ç¦»ç°åœ¨çš„æ—¶é—´ï¼Œå¦‚æœä¸å­˜åœ¨å®šæ—¶ä»»åŠ¡ï¼Œåˆ™é»˜è®¤è¿”å› 1000 ms ã€‚è¯¥æ–¹æ³•çš„è¯¦ç»†è§£æï¼Œè§åç»­æ–‡ç« ã€‚</li>
</ul>
</li>
<li>ç¬¬ 12 è¡Œï¼šâ€œæ­»â€å¾ªç¯ï¼Œç›´åˆ°ç¬¦åˆå¦‚ä¸‹<strong>ä»»ä¸€</strong>ä¸€ç§æƒ…å†µå<strong>ç»“æŸ</strong>ï¼š<ol>
<li>select æ“ä½œè¶…æ—¶ï¼Œå¯¹åº”ã€ç¬¬ 18 è‡³ 24 è¡Œã€‘ã€‚</li>
<li>è‹¥æœ‰æ–°çš„ä»»åŠ¡åŠ å…¥ï¼Œå¯¹åº”ã€ç¬¬ 26 è‡³ 37 è¡Œã€‘ã€‚</li>
<li>æŸ¥è¯¢åˆ°ä»»åŠ¡æˆ–è€…å”¤é†’ï¼Œå¯¹åº”ã€ç¬¬ 45 è‡³ 51 è¡Œã€‘ã€‚</li>
<li>çº¿ç¨‹è¢«å¼‚å¸¸æ‰“æ–­ï¼Œå¯¹åº”ã€ç¬¬ 52 è‡³ 66 è¡Œã€‘ã€‚</li>
<li>å‘ç”Ÿ NIO ç©ºè½®è¯¢çš„ Bug åé‡å»º Selector å¯¹è±¡åï¼Œå¯¹åº”ã€ç¬¬ 75 è‡³ 93 è¡Œã€‘ã€‚</li>
</ol>
</li>
<li>ç¬¬ 16 è¡Œï¼šè®¡ç®—æœ¬æ¬¡ select çš„<strong>è¶…æ—¶æ—¶é•¿</strong>ï¼Œå•ä½ï¼šæ¯«ç§’ã€‚å› ä¸ºã€ç¬¬ 40 è¡Œã€‘çš„ <code>Selector#select(timeoutMillis)</code> æ–¹æ³•ï¼Œå¯èƒ½å› ä¸º<strong>å„ç§æƒ…å†µç»“æŸ</strong>ï¼Œæ‰€ä»¥éœ€è¦å¾ªç¯ï¼Œå¹¶ä¸”æ¯æ¬¡<strong>é‡æ–°</strong>è®¡ç®—è¶…æ—¶æ—¶é—´ã€‚è‡³äº <code>+ 500000L</code> å’Œ <code>/ 1000000L</code> çš„ç”¨é€”ï¼Œçœ‹ä¸‹ä»£ç æ³¨é‡Šã€‚</li>
<li>ç¬¬ 17 è‡³ 24 è¡Œï¼šå¦‚æœè¶…è¿‡ select è¶…æ—¶æ—¶é•¿ï¼Œåˆ™ç»“æŸ select ã€‚<ul>
<li>ç¬¬ 19 è‡³ 21 è¡Œï¼šå¦‚æœæ˜¯é¦–æ¬¡ select ï¼Œåˆ™è°ƒç”¨ <code>Selector#selectNow()</code> æ–¹æ³•ï¼Œè·å¾—<strong>éé˜»å¡</strong>çš„ Channel æ„Ÿå…´è¶£çš„å°±ç»ªçš„ IO äº‹ä»¶ï¼Œå¹¶é‡ç½® <code>selectCnt</code> ä¸º 1 ã€‚</li>
</ul>
</li>
<li>ç¬¬ 26 è‡³ 37 è¡Œï¼šè‹¥æœ‰æ–°çš„ä»»åŠ¡åŠ å…¥ã€‚è¿™é‡Œå®é™…è¦åˆ†æˆä¸¤ç§æƒ…å†µï¼š<ul>
<li>ç¬¬ä¸€ç§ï¼Œæäº¤çš„ä»»åŠ¡çš„ç±»å‹æ˜¯ NonWakeupRunnable ï¼Œé‚£ä¹ˆå®ƒå¹¶ä¸ä¼šè°ƒç”¨ <code>#wakeup()</code> æ–¹æ³•ï¼ŒåŸå› èƒ–å‹è‡ªå·±çœ‹ <code>#execute(Runnable task)</code> æ€è€ƒä¸‹ã€‚Netty åœ¨ <code>#select()</code> æ–¹æ³•çš„è®¾è®¡ä¸Šï¼Œ<strong>èƒ½å°½å¿«æ‰§è¡Œä»»åŠ¡</strong>ã€‚æ­¤æ—¶å¦‚æœæ ‡è®° <code>wakeup</code> ä¸º <code>false</code> ï¼Œè¯´æ˜ç¬¦åˆè¿™ç§æƒ…å†µï¼Œç›´æ¥ç»“æŸ select ã€‚</li>
<li>ç¬¬äºŒç§ï¼Œæäº¤çš„ä»»åŠ¡çš„ç±»å‹<strong>ä¸æ˜¯</strong> NonWakeupRunnable ï¼Œé‚£ä¹ˆåœ¨ <code>#run()</code> æ–¹æ³•çš„ã€ç¬¬ 8 è‡³ 11 è¡Œã€‘çš„ <code>wakenUp.getAndSet(false)</code> ä¹‹å‰ï¼Œå‘èµ·äº†ä¸€æ¬¡ <code>#wakeup()</code> æ–¹æ³•ï¼Œé‚£ä¹ˆå› ä¸º <code>wakenUp.getAndSet(false)</code> ä¼šå°†æ ‡è®° <code>wakeUp</code> è®¾ç½®ä¸º <code>false</code> ï¼Œæ‰€ä»¥å°±èƒ½æ»¡è¶³ <code>hasTasks() &amp;&amp; wakenUp.compareAndSet(false, true)</code> çš„æ¡ä»¶ã€‚<ul>
<li>è¿™ä¸ªè§£é‡Šï¼Œå°±å’Œã€ç¬¬ 27 è‡³ 28 è¡Œã€‘çš„è‹±æ–‡æ³¨é‡Š <code>So we need to check task queue again before executing select operation.If we don't, the task might be pended until select operation was timed out.</code> æœ‰å‡ºå…¥äº†ï¼Ÿè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º Selector è¢«æå‰ wakeup äº†ï¼Œæ‰€ä»¥ä¸‹ä¸€æ¬¡ Selector çš„ select æ˜¯è¢«ç›´æ¥å”¤é†’ç»“æŸçš„ã€‚</li>
</ul>
</li>
<li>ç¬¬ 33 è¡Œï¼šè™½ç„¶å·²ç»å‘ç°ä»»åŠ¡ï¼Œä½†æ˜¯è¿˜æ˜¯è°ƒç”¨ <code>Selector#selectNow()</code> æ–¹æ³•ï¼Œ<strong>éé˜»å¡</strong>çš„è·å–ä¸€æ¬¡ Channel æ–°å¢çš„å°±ç»ªçš„ IO äº‹ä»¶ã€‚</li>
<li>å¯¹åº” Github çš„ä»£ç æäº¤ä¸º <a href="https://github.com/lightningMan/netty/commit/f44f3e7926f1676315ae86d0f18bdd9b95681d9f" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/lightningMan/netty/commit/f44f3e7926f1676315ae86d0f18bdd9b95681d9f</a> ã€‚</li>
</ul>
</li>
<li>ç¬¬ 40 è¡Œï¼šè°ƒç”¨ <code>Selector#select(timeoutMillis)</code> æ–¹æ³•ï¼Œ<strong>é˜»å¡</strong> select ï¼Œè·å¾— Channel æ–°å¢çš„å°±ç»ªçš„ IO äº‹ä»¶çš„æ•°é‡ã€‚</li>
<li>ç¬¬ 42 è¡Œï¼šselect è®¡æ•°å™¨åŠ  1 ã€‚</li>
<li>ç¬¬ 44 è‡³ 51 è¡Œï¼šå¦‚æœæ»¡è¶³ä¸‹é¢<strong>ä»»ä¸€</strong>ä¸€ä¸ªæ¡ä»¶ï¼Œç»“æŸ select ï¼š<ol>
<li><code>selectedKeys != 0</code> æ—¶ï¼Œè¡¨ç¤ºæœ‰ Channel æ–°å¢çš„å°±ç»ªçš„ IO äº‹ä»¶ï¼Œæ‰€ä»¥ç»“æŸ select ï¼Œå¾ˆå¥½ç†è§£ã€‚</li>
<li><code>oldWakenUp || wakenUp.get()</code> æ—¶ï¼Œè¡¨ç¤º Selector è¢«å”¤é†’ï¼Œæ‰€ä»¥ç»“æŸ select ã€‚</li>
<li><code>hasTasks()  || hasScheduledTasks()</code> ï¼Œè¡¨ç¤ºæœ‰æ™®é€šä»»åŠ¡æˆ–å®šæ—¶ä»»åŠ¡ï¼Œæ‰€ä»¥ç»“æŸ select ã€‚</li>
<li>é‚£ä¹ˆå‰©ä½™çš„æƒ…å†µï¼Œä¸»è¦æ˜¯ select <strong>è¶…æ—¶</strong>æˆ–è€…å‘ç”Ÿ<strong>ç©ºè½®è¯¢</strong>ï¼Œå³ã€ç¬¬ 68 è‡³ 93 è¡Œã€‘çš„ä»£ç ã€‚</li>
</ol>
</li>
<li>ç¬¬ 52 è‡³ 66 è¡Œï¼šçº¿ç¨‹è¢«æ‰“æ–­ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ä¸ä¼šå‡ºç°ï¼Œå‡ºç°åŸºæœ¬æ˜¯ <strong>bug</strong> ï¼Œæˆ–è€…é”™è¯¯ä½¿ç”¨ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ <a href="https://github.com/netty/netty/issues/2426" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/netty/netty/issues/2426</a> ã€‚</li>
<li>ç¬¬ 69 è¡Œï¼šè®°å½•å½“å‰æ—¶é—´ã€‚<ul>
<li>ç¬¬ 70 è‡³ 73 è¡Œï¼šè‹¥æ»¡è¶³ <code>time - TimeUnit.MILLISECONDS.toNanos(timeoutMillis) &gt;= currentTimeNanos</code> ï¼Œè¯´æ˜åˆ°è¾¾æ­¤å¤„æ—¶ï¼ŒSelector æ˜¯<strong>è¶…æ—¶</strong> select ï¼Œé‚£ä¹ˆæ˜¯<strong>æ­£å¸¸</strong>çš„ï¼Œæ‰€ä»¥é‡ç½® <code>selectCnt</code> ä¸º 1 ã€‚</li>
<li>ç¬¬ 74 è‡³ 93 è¡Œï¼šä¸ç¬¦åˆ select è¶…æ—¶çš„æäº¤ï¼Œè‹¥ select æ¬¡æ•°åˆ°è¾¾é‡å»º Selector å¯¹è±¡çš„ä¸Šé™ï¼Œè¿›è¡Œé‡å»ºã€‚<strong>è¿™å°±æ˜¯ Netty åˆ¤æ–­å‘ç”Ÿ NIO Selector ç©ºè½®è¯¢çš„æ–¹å¼</strong>ï¼ŒN ( é»˜è®¤ 512 )æ¬¡ select å¹¶æœªé˜»å¡è¶…æ—¶è¿™ä¹ˆé•¿ï¼Œé‚£ä¹ˆå°±è®¤ä¸ºå‘ç”Ÿ NIO Selector ç©ºè½®è¯¢ã€‚è¿‡å¤šçš„ NIO Selector å°†ä¼šå¯¼è‡´ CPU 100% ã€‚<ul>
<li>ç¬¬ 82 è¡Œï¼šè°ƒç”¨ <code>#rebuildSelector()</code> æ–¹æ³•ï¼Œé‡å»º Selector å¯¹è±¡ã€‚</li>
<li>ç¬¬ 84 è¡Œï¼š<strong>é‡æ–°</strong>è·å¾—ä½¿ç”¨çš„ Selector å¯¹è±¡ã€‚</li>
<li>ç¬¬ 86 è‡³ 90 è¡Œï¼šåŒã€ç¬¬ 20 è‡³ 21 è¡Œã€‘çš„ä»£ç ã€‚</li>
<li>ç¬¬ 92 è¡Œï¼šç»“æŸ select ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 95 è¡Œï¼šè®°å½•æ–°çš„å½“å‰æ—¶é—´ï¼Œç”¨äºã€ç¬¬ 16 è¡Œã€‘ï¼Œ<strong>é‡æ–°</strong>è®¡ç®—æœ¬æ¬¡ select çš„è¶…æ—¶æ—¶é•¿ã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ€»çš„æ¥è¯´è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œæ¯”è¾ƒå›°éš¾çš„ï¼Œåœ¨äºå¯¹æ ‡è®° <code>wakeup</code> çš„ç†è§£ã€‚çœŸçš„æ˜¯ï¼Œç»†æ€ææï¼ï¼ï¼æ„Ÿè°¢åœ¨ç†è§£è¿‡ç¨‹ä¸­ï¼Œé—ªç”µä¾ å’Œå¤§è¡¨å¼Ÿæ™®æ¶çš„å¸®åŠ©ã€‚</p>
<p>æ¨èé˜…è¯»æ–‡ç« ï¼š</p>
<ul>
<li>é—ªç”µä¾  <a href="https://www.jianshu.com/p/0d0eece6d467" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnetty æºç åˆ†æä¹‹æ­å¼€ reactor çº¿ç¨‹çš„é¢çº±ï¼ˆä¸€ï¼‰ã€‹</a></li>
<li>Hypercube <a href="https://www.jianshu.com/p/d0f06b13e2fb" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æ Nettyï¼ˆå››ï¼‰â€“EventLoop-2ã€‹</a></li>
</ul>
<blockquote>
<p>è€è‰¿è‰¿ï¼šå…¨æ–‡çš„ NIO Selector ç©ºè½®è¯¢ï¼ŒæŒ‡çš„æ˜¯ epoll cpu 100% çš„ bug ã€‚</p>
</blockquote>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/EventLoop-4-EventLoop-run/" data-id="ck4pl3fow00dffgcf8jgv02ba" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>