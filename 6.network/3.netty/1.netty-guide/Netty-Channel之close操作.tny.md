<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” Channelï¼ˆä¸ƒï¼‰ä¹‹ close æ“ä½œ
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« Netty NIO Channel å…³é—­( <strong>close</strong> )æ“ä½œçš„è¿‡ç¨‹ï¼Œåˆ†æˆå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ Channel <strong>ä¸¤ç§</strong>å…³é—­ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯ NioSocketChannel <ul>
<li>å®¢æˆ·ç«¯å…³é—­ NioSocketChannel ï¼Œæ–­å¼€å’ŒæœåŠ¡ç«¯çš„è¿æ¥ã€‚</li>
<li>æœåŠ¡ç«¯å…³é—­ NioSocketChannel ï¼Œæ–­å¼€å’Œå®¢æˆ·ç«¯çš„è¿æ¥ã€‚</li>
</ul>
</li>
<li>æœåŠ¡ç«¯ NioServerSocketChannel<ul>
<li>æœåŠ¡ç«¯å…³é—­ NioServerSocketChannel ï¼Œå–æ¶ˆç«¯å£ç»‘å®šï¼Œå…³é—­æœåŠ¡ã€‚</li>
</ul>
</li>
</ul>
<p>ä¸Šé¢çš„å…³é—­ï¼Œå¯èƒ½æ˜¯å®¢æˆ·ç«¯/æœåŠ¡ç«¯ä¸»åŠ¨å…³é—­ï¼Œä¹Ÿå¯èƒ½æ˜¯å¼‚å¸¸å…³é—­ã€‚</p>
<ul>
<li>å…³äº NioSocketChannel çš„å…³é—­ï¼Œåœ¨ <a href="#">ã€Œ2. NioSocketChannelã€</a> è¯¦ç»†è§£æã€‚  </li>
<li>å…³äº NioServerSocketChannel çš„å…³é—­ï¼Œåœ¨ <a href="#">ã€Œ3. NioSocketChannelã€</a> è¯¦ç»†è§£æã€‚</li>
</ul>
<h1 id="2-NioSocketChannel"><a href="#2-NioSocketChannel" class="headerlink" title="2. NioSocketChannel"></a>2. NioSocketChannel</h1><p>é€šè¿‡ <code>NioSocketChannel#close()</code> æ–¹æ³•ï¼Œåº”ç”¨ç¨‹åºé‡Œå¯ä»¥ä¸»åŠ¨å…³é—­ NioSocketChannel é€šé“ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractChannel.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">close</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> pipeline.close();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>NioSocketChannel ç»§æ‰¿ AbstractChannel æŠ½è±¡ç±»ï¼Œæ‰€ä»¥ <code>#close()</code> æ–¹æ³•å®é™…æ˜¯ AbstractChannel å®ç°çš„ã€‚</li>
<li><p>åœ¨æ–¹æ³•å†…éƒ¨ï¼Œä¼šè°ƒç”¨å¯¹åº”çš„ <code>ChannelPipeline#close()</code> æ–¹æ³•ï¼Œå°† close äº‹ä»¶åœ¨ pipeline ä¸Šä¼ æ’­ã€‚è€Œ close äº‹ä»¶å±äº Outbound äº‹ä»¶ï¼Œæ‰€ä»¥ä¼šä» <code>tail</code> èŠ‚ç‚¹å¼€å§‹ï¼Œæœ€ç»ˆä¼ æ’­åˆ° <code>head</code> èŠ‚ç‚¹ï¼Œä½¿ç”¨ Unsafe è¿›è¡Œå…³é—­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// DefaultChannelPipeline.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title">close</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> tail.close();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// TailContext.java</span></span><br><span class="line"><span class="meta">@Override</span> <span class="comment">// FROM AbstractChannelHandlerContext.java ã€‚å› ä¸º TailContext ç»§æ‰¿ AbstractChannelHandlerContext æŠ½è±¡ç±»ï¼Œè¯¥æ–¹æ³•æ˜¯å®ƒå®ç°çš„ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">close</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> close(newPromise());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// HeadContext.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(ChannelHandlerContext ctx, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    unsafe.close(promise);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="2-1-AbstractUnsafe-close"><a href="#2-1-AbstractUnsafe-close" class="headerlink" title="2.1 AbstractUnsafe#close"></a>2.1 AbstractUnsafe#close</h2><p><code>AbstractUnsafe#close()</code> æ–¹æ³•ï¼Œå…³é—­ Channel ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">final</span> ChannelPromise promise)</span> </span>{</span><br><span class="line">    assertEventLoop();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…³é—­</span></span><br><span class="line">    close(promise, CLOSE_CLOSED_CHANNEL_EXCEPTION, CLOSE_CLOSED_CHANNEL_EXCEPTION, <span class="keyword">false</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">final</span> ChannelPromise promise, <span class="keyword">final</span> Throwable cause, <span class="keyword">final</span> ClosedChannelException closeCause, <span class="keyword">final</span> <span class="keyword">boolean</span> notify)</span> </span>{</span><br><span class="line">  <span class="number">2</span>:     <span class="comment">// è®¾ç½® Promise ä¸å¯å–æ¶ˆ</span></span><br><span class="line">  <span class="number">3</span>:     <span class="keyword">if</span> (!promise.setUncancellable()) {</span><br><span class="line">  <span class="number">4</span>:         <span class="keyword">return</span>;</span><br><span class="line">  <span class="number">5</span>:     }</span><br><span class="line">  <span class="number">6</span>: </span><br><span class="line">  <span class="number">7</span>:     <span class="comment">// è‹¥å…³é—­å·²ç»æ ‡è®°åˆå§‹åŒ–</span></span><br><span class="line">  <span class="number">8</span>:     <span class="keyword">if</span> (closeInitiated) {</span><br><span class="line">  <span class="number">9</span>:         <span class="comment">// å…³é—­å·²ç»å®Œæˆï¼Œç›´æ¥é€šçŸ¥ Promise å¯¹è±¡</span></span><br><span class="line"> <span class="number">10</span>:         <span class="keyword">if</span> (closeFuture.isDone()) {</span><br><span class="line"> <span class="number">11</span>:             <span class="comment">// Closed already.</span></span><br><span class="line"> <span class="number">12</span>:             safeSetSuccess(promise);</span><br><span class="line"> <span class="number">13</span>:         <span class="comment">// å…³é—­æœªå®Œæˆï¼Œé€šè¿‡ç›‘å¬å™¨é€šçŸ¥ Promise å¯¹è±¡</span></span><br><span class="line"> <span class="number">14</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (!(promise <span class="keyword">instanceof</span> VoidChannelPromise)) { <span class="comment">// Only needed if no VoidChannelPromise.</span></span><br><span class="line"> <span class="number">15</span>:             <span class="comment">// This means close() was called before so we just register a listener and return</span></span><br><span class="line"> <span class="number">16</span>:             closeFuture.addListener(<span class="keyword">new</span> ChannelFutureListener() {</span><br><span class="line"> <span class="number">17</span>:                 <span class="meta">@Override</span></span><br><span class="line"> <span class="number">18</span>:                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"> <span class="number">19</span>:                     promise.setSuccess();</span><br><span class="line"> <span class="number">20</span>:                 }</span><br><span class="line"> <span class="number">21</span>:             });</span><br><span class="line"> <span class="number">22</span>:         }</span><br><span class="line"> <span class="number">23</span>:         <span class="keyword">return</span>;</span><br><span class="line"> <span class="number">24</span>:     }</span><br><span class="line"> <span class="number">25</span>: </span><br><span class="line"> <span class="number">26</span>:     <span class="comment">// æ ‡è®°å…³é—­å·²ç»åˆå§‹åŒ–</span></span><br><span class="line"> <span class="number">27</span>:     closeInitiated = <span class="keyword">true</span>;</span><br><span class="line"> <span class="number">28</span>: </span><br><span class="line"> <span class="number">29</span>:     <span class="comment">// è·å¾— Channel æ˜¯å¦æ¿€æ´»</span></span><br><span class="line"> <span class="number">30</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> wasActive = isActive();</span><br><span class="line"> <span class="number">31</span>:     <span class="comment">// æ ‡è®° outboundBuffer ä¸ºç©º</span></span><br><span class="line"> <span class="number">32</span>:     <span class="keyword">final</span> ChannelOutboundBuffer outboundBuffer = <span class="keyword">this</span>.outboundBuffer;</span><br><span class="line"> <span class="number">33</span>:     <span class="keyword">this</span>.outboundBuffer = <span class="keyword">null</span>; <span class="comment">// Disallow adding any messages and flushes to outboundBuffer.</span></span><br><span class="line"> <span class="number">34</span>:     <span class="comment">// æ‰§è¡Œå‡†å¤‡å…³é—­</span></span><br><span class="line"> <span class="number">35</span>:     Executor closeExecutor = prepareToClose();</span><br><span class="line"> <span class="number">36</span>:     <span class="comment">// è‹¥ closeExecutor éç©º</span></span><br><span class="line"> <span class="number">37</span>:     <span class="keyword">if</span> (closeExecutor != <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">38</span>:         closeExecutor.execute(<span class="keyword">new</span> Runnable() {</span><br><span class="line"> <span class="number">39</span>:             <span class="meta">@Override</span></span><br><span class="line"> <span class="number">40</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">41</span>:                 <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">42</span>:                     <span class="comment">// åœ¨ closeExecutor ä¸­ï¼Œæ‰§è¡Œå…³é—­</span></span><br><span class="line"> <span class="number">43</span>:                     <span class="comment">// Execute the close.</span></span><br><span class="line"> <span class="number">44</span>:                     doClose0(promise);</span><br><span class="line"> <span class="number">45</span>:                 } <span class="keyword">finally</span> {</span><br><span class="line"> <span class="number">46</span>:                     <span class="comment">// åœ¨ EventLoop ä¸­ï¼Œæ‰§è¡Œ</span></span><br><span class="line"> <span class="number">47</span>:                     <span class="comment">// Call invokeLater so closeAndDeregister is executed in the EventLoop again!</span></span><br><span class="line"> <span class="number">48</span>:                     invokeLater(<span class="keyword">new</span> Runnable() {</span><br><span class="line"> <span class="number">49</span>:                         <span class="meta">@Override</span></span><br><span class="line"> <span class="number">50</span>:                         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">51</span>:                             <span class="keyword">if</span> (outboundBuffer != <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">52</span>:                                 <span class="comment">// å†™å…¥æ•°æ®( æ¶ˆæ¯ )åˆ°å¯¹ç«¯å¤±è´¥ï¼Œé€šçŸ¥ç›¸åº”æ•°æ®å¯¹åº”çš„ Promise å¤±è´¥ã€‚</span></span><br><span class="line"> <span class="number">53</span>:                                 <span class="comment">// Fail all the queued messages</span></span><br><span class="line"> <span class="number">54</span>:                                 outboundBuffer.failFlushed(cause, notify);</span><br><span class="line"> <span class="number">55</span>:                                 <span class="comment">// å…³é—­å†…å­˜é˜Ÿåˆ—</span></span><br><span class="line"> <span class="number">56</span>:                                 outboundBuffer.close(closeCause);</span><br><span class="line"> <span class="number">57</span>:                             }</span><br><span class="line"> <span class="number">58</span>:                             <span class="comment">// æ‰§è¡Œå–æ¶ˆæ³¨å†Œï¼Œå¹¶è§¦å‘ Channel Inactive äº‹ä»¶åˆ° pipeline ä¸­</span></span><br><span class="line"> <span class="number">59</span>:                             fireChannelInactiveAndDeregister(wasActive);</span><br><span class="line"> <span class="number">60</span>:                         }</span><br><span class="line"> <span class="number">61</span>:                     });</span><br><span class="line"> <span class="number">62</span>:                 }</span><br><span class="line"> <span class="number">63</span>:             }</span><br><span class="line"> <span class="number">64</span>:         });</span><br><span class="line"> <span class="number">65</span>:     <span class="comment">// è‹¥ closeExecutor ä¸ºç©º</span></span><br><span class="line"> <span class="number">66</span>:     } <span class="keyword">else</span> {</span><br><span class="line"> <span class="number">67</span>:         <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">68</span>:             <span class="comment">// æ‰§è¡Œå…³é—­</span></span><br><span class="line"> <span class="number">69</span>:             <span class="comment">// Close the channel and fail the queued messages in all cases.</span></span><br><span class="line"> <span class="number">70</span>:             doClose0(promise);</span><br><span class="line"> <span class="number">71</span>:         } <span class="keyword">finally</span> {</span><br><span class="line"> <span class="number">72</span>:             <span class="keyword">if</span> (outboundBuffer != <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">73</span>:                 <span class="comment">// å†™å…¥æ•°æ®( æ¶ˆæ¯ )åˆ°å¯¹ç«¯å¤±è´¥ï¼Œé€šçŸ¥ç›¸åº”æ•°æ®å¯¹åº”çš„ Promise å¤±è´¥ã€‚</span></span><br><span class="line"> <span class="number">74</span>:                 <span class="comment">// Fail all the queued messages.</span></span><br><span class="line"> <span class="number">75</span>:                 outboundBuffer.failFlushed(cause, notify);</span><br><span class="line"> <span class="number">76</span>:                 <span class="comment">// å…³é—­å†…å­˜é˜Ÿåˆ—</span></span><br><span class="line"> <span class="number">77</span>:                 outboundBuffer.close(closeCause);</span><br><span class="line"> <span class="number">78</span>:             }</span><br><span class="line"> <span class="number">79</span>:         }</span><br><span class="line"> <span class="number">80</span>:         <span class="comment">// æ­£åœ¨ flush ä¸­ï¼Œåœ¨ EventLoop ä¸­æ‰§è¡Œæ‰§è¡Œå–æ¶ˆæ³¨å†Œï¼Œå¹¶è§¦å‘ Channel Inactive äº‹ä»¶åˆ° pipeline ä¸­</span></span><br><span class="line"> <span class="number">81</span>:         <span class="keyword">if</span> (inFlush0) {</span><br><span class="line"> <span class="number">82</span>:             invokeLater(<span class="keyword">new</span> Runnable() {</span><br><span class="line"> <span class="number">83</span>:                 <span class="meta">@Override</span></span><br><span class="line"> <span class="number">84</span>:                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">85</span>:                     fireChannelInactiveAndDeregister(wasActive);</span><br><span class="line"> <span class="number">86</span>:                 }</span><br><span class="line"> <span class="number">87</span>:             });</span><br><span class="line"> <span class="number">88</span>:         <span class="comment">// ä¸åœ¨ flush ä¸­ï¼Œç›´æ¥æ‰§è¡Œæ‰§è¡Œå–æ¶ˆæ³¨å†Œï¼Œå¹¶è§¦å‘ Channel Inactive äº‹ä»¶åˆ° pipeline ä¸­</span></span><br><span class="line"> <span class="number">89</span>:         } <span class="keyword">else</span> {</span><br><span class="line"> <span class="number">90</span>:             fireChannelInactiveAndDeregister(wasActive);</span><br><span class="line"> <span class="number">91</span>:         }</span><br><span class="line"> <span class="number">92</span>:     }</span><br><span class="line"> <span class="number">93</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>æ–¹æ³•å‚æ•° <code>cause</code>ã€<code>closeCause</code> ï¼Œå…³é—­çš„â€œåŸå› â€ã€‚å¯¹äº <strong>close</strong> æ“ä½œæ¥è¯´ï¼Œæ— è®ºæ˜¯æ­£å¸¸å…³é—­ï¼Œè¿˜æ˜¯å¼‚å¸¸å…³é—­ï¼Œé€šè¿‡ä½¿ç”¨ <strong>Exception</strong> æ¥è¡¨ç¤º<strong>æ¥æº</strong>ã€‚åœ¨ AbstractChannel ç±»ä¸­ï¼Œæšä¸¾äº†æ‰€æœ‰æ¥æºï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractChannel.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ClosedChannelException FLUSH0_CLOSED_CHANNEL_EXCEPTION = ThrowableUtil.unknownStackTrace(</span><br><span class="line">        <span class="keyword">new</span> ClosedChannelException(), AbstractUnsafe.class, <span class="string">"flush0()"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ClosedChannelException ENSURE_OPEN_CLOSED_CHANNEL_EXCEPTION = ThrowableUtil.unknownStackTrace(</span><br><span class="line">        <span class="keyword">new</span> ClosedChannelException(), AbstractUnsafe.class, <span class="string">"ensureOpen(...)"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ClosedChannelException CLOSE_CLOSED_CHANNEL_EXCEPTION = ThrowableUtil.unknownStackTrace(</span><br><span class="line">        <span class="keyword">new</span> ClosedChannelException(), AbstractUnsafe.class, <span class="string">"close(...)"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ClosedChannelException WRITE_CLOSED_CHANNEL_EXCEPTION = ThrowableUtil.unknownStackTrace(</span><br><span class="line">        <span class="keyword">new</span> ClosedChannelException(), AbstractUnsafe.class, <span class="string">"write(...)"</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> NotYetConnectedException FLUSH0_NOT_YET_CONNECTED_EXCEPTION = ThrowableUtil.unknownStackTrace(</span><br><span class="line">        <span class="keyword">new</span> NotYetConnectedException(), AbstractUnsafe.class, <span class="string">"flush0()"</span>);</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ç¬¬ 2 è‡³ 5 è¡Œï¼šè°ƒç”¨ <code>ChannelPromise#setUncancellable()</code> æ–¹æ³•ï¼Œè®¾ç½® Promise ä¸å¯å–æ¶ˆã€‚</p>
</li>
<li>ç¬¬ 8 è¡Œï¼šè‹¥ <code>AbstractChannel.closeInitiated</code> ä¸º <code>true</code> æ—¶ï¼Œè¡¨ç¤ºå…³é—­å·²ç»æ ‡è®°åˆå§‹åŒ–ï¼Œæ­¤æ—¶<strong>å¯èƒ½</strong>å·²ç»å…³é—­å®Œæˆã€‚<ul>
<li>ç¬¬ 10 è‡³ 12 è¡Œï¼šå…³é—­<strong>å·²ç»</strong>å®Œæˆï¼Œç›´æ¥é€šçŸ¥ Promise å¯¹è±¡ã€‚</li>
<li>ç¬¬ 13 è‡³ 22 è¡Œï¼šå…³é—­<strong>å¹¶æœª</strong>å®Œæˆï¼Œé€šè¿‡ç›‘å¬å™¨å›è°ƒé€šçŸ¥ Promise å¯¹è±¡ã€‚</li>
<li>ç¬¬ 23 è¡Œï¼š<code>return</code> ç»“æŸã€‚</li>
<li>ç¬¬ 27 è¡Œï¼šæ ‡è®°å…³é—­å·²ç»åˆå§‹åŒ–ã€‚</li>
</ul>
</li>
<li>ç¬¬ 30 è¡Œï¼šè°ƒç”¨ <code>#isActive()</code> æ–¹æ³•ï¼Œ è·å¾— Channel æ˜¯å¦æ¿€æ´»ã€‚</li>
<li>ç¬¬ 31 è‡³ 33 è¡Œï¼šæ ‡è®°å†…å­˜é˜Ÿåˆ— <code>outboundBuffer</code> ä¸ºç©ºã€‚</li>
<li>ç¬¬ 35 è¡Œï¼šè°ƒç”¨ <code>#prepareToClose()</code> æ–¹æ³•ï¼Œæ‰§è¡Œå‡†å¤‡å…³é—­ã€‚è¯¦ç»†è§£æï¼Œèƒ–å‹å…ˆè·³åˆ° <a href="#">ã€Œ2.2 NioSocketChannelUnsafe#prepareToCloseã€</a> ä¸­ã€‚</li>
<li>ç¬¬ 37 è¡Œï¼šè‹¥ <code>closeExecutor</code> éç©ºï¼Œåœ¨ <a href="#">ã€Œ2.2 NioSocketChannelUnsafe#prepareToCloseã€</a> ä¸­ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°å¦‚æœå¼€å¯ <code>SO_LINGER</code> åŠŸèƒ½ï¼Œä¼šè¿”å› <code>GlobalEventExecutor.INSTANCE</code> å¯¹è±¡ã€‚<ul>
<li>ç¬¬ 38 è‡³ 44 è¡Œï¼šæäº¤ä»»åŠ¡åˆ° <code>closeExecutor</code> ä¸­ï¼Œ<strong>åœ¨å®ƒçš„çº¿ç¨‹ä¸­</strong>ï¼Œæ‰§è¡Œ <code>#doClose0(promise)</code> æ–¹æ³•ï¼Œæ‰§è¡Œå…³é—­ã€‚ä¸ºä»€ä¹ˆè¦åœ¨â€œåœ¨å®ƒçš„çº¿ç¨‹ä¸­â€ä¸­ï¼Ÿå›ç­”ä¸å‡ºæ¥çš„èƒ–å‹ï¼Œå†å¥½å¥½é‡æ–°çœ‹ä¸‹ <a href="#">ã€Œ2.2 NioSocketChannelUnsafe#prepareToCloseã€</a> å°èŠ‚ã€‚</li>
<li>ç¬¬ 46 è‡³ 61 è¡Œï¼šæäº¤ä»»åŠ¡åˆ° Channel æ‰€åœ¨çš„ EventLoop ä¸­ï¼Œæ‰§è¡Œåç»­çš„ä»»åŠ¡ã€‚</li>
<li>æ•´ä½“çš„é€»è¾‘å’Œä»£ç ï¼Œå’Œã€ç¬¬ 66 è‡³ 91 è¡Œã€‘çš„ä»£ç æ˜¯<strong>åŸºæœ¬</strong>ä¸€è‡´ã€‚</li>
</ul>
</li>
<li>ç¬¬ 66 è¡Œï¼šè‹¥ <code>closeExecutor</code> ä¸ºç©ºã€‚<ul>
<li>ç¬¬ 70 è¡Œï¼šè°ƒç”¨ <code>#doClose0(promise)</code> æ–¹æ³•ï¼Œæ‰§è¡Œ<strong>çœŸæ­£çš„</strong>å…³é—­ã€‚è¯¦ç»†è§£æï¼Œèƒ–å‹å…ˆè·³åˆ° <a href="#">ã€Œ2.4 doClose0ã€</a> ä¸­ã€‚</li>
<li>ç¬¬ 75 è¡Œï¼šè°ƒç”¨ <code>ChannelOutboundBuffer#failFlushed(Throwable cause, boolean notify)</code> æ–¹æ³•ï¼Œå†™å…¥æ•°æ®( æ¶ˆæ¯ )åˆ°å¯¹ç«¯å¤±è´¥ï¼Œé€šçŸ¥ç›¸åº”æ•°æ®å¯¹åº”çš„ Promise å¤±è´¥ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/Channel-5-flush/">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Channelï¼ˆäº”ï¼‰ä¹‹ flush æ“ä½œã€‹</a> ã€‚</li>
<li>ç¬¬ 77 è¡Œï¼šè°ƒç”¨ <code>ChannelOutboundBuffer#close(Throwable cause)</code> æ–¹æ³•ï¼Œå…³é—­å†…å­˜é˜Ÿåˆ—ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/Channel-5-flush/">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Channelï¼ˆäº”ï¼‰ä¹‹ flush æ“ä½œã€‹</a> ã€‚</li>
<li>ç¬¬ 81 è¡Œï¼šè‹¥ <code>inFlush0</code> ä¸º <code>true</code> ï¼Œ<strong>æ­£åœ¨</strong> flush ä¸­ï¼Œ<strong>åœ¨ EventLoop ä¸­çš„çº¿ç¨‹ä¸­</strong>ï¼Œè°ƒç”¨ <code>#fireChannelInactiveAndDeregister(boolean wasActive)</code> æ–¹æ³•ï¼Œæ‰§è¡Œå–æ¶ˆæ³¨å†Œï¼Œå¹¶è§¦å‘ Channel Inactive äº‹ä»¶åˆ° pipeline ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.5 AbstractUnsafe#fireChannelInactiveAndDeregisterã€</a> ä¸­ã€‚<ul>
<li>ç¬¬ 90 è¡Œï¼šè‹¥ <code>inFlush0</code> ä¸º <code>false</code> ï¼Œ<strong>ä¸åœ¨</strong> flush ä¸­ï¼Œ<strong>ç›´æ¥</strong>è°ƒç”¨ <code>#fireChannelInactiveAndDeregister(boolean wasActive)</code> æ–¹æ³•ï¼Œæ‰§è¡Œå–æ¶ˆæ³¨å†Œï¼Œå¹¶è§¦å‘ Channel Inactive äº‹ä»¶åˆ° pipeline ä¸­ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="2-2-NioSocketChannelUnsafe-prepareToClose"><a href="#2-2-NioSocketChannelUnsafe-prepareToClose" class="headerlink" title="2.2 NioSocketChannelUnsafe#prepareToClose"></a>2.2 NioSocketChannelUnsafe#prepareToClose</h2><p><code>NioSocketChannelUnsafe#prepareToClose()</code> æ–¹æ³•ï¼Œæ‰§è¡Œå‡†å¤‡å…³é—­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> Executor <span class="title">prepareToClose</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">4</span>:         <span class="keyword">if</span> (javaChannel().isOpen() &amp;&amp; config().getSoLinger() &gt; <span class="number">0</span>) {</span><br><span class="line"> <span class="number">5</span>:             <span class="comment">// We need to cancel this key of the channel so we may not end up in a eventloop spin</span></span><br><span class="line"> <span class="number">6</span>:             <span class="comment">// because we try to read or write until the actual close happens which may be later due</span></span><br><span class="line"> <span class="number">7</span>:             <span class="comment">// SO_LINGER handling.</span></span><br><span class="line"> <span class="number">8</span>:             <span class="comment">// See https://github.com/netty/netty/issues/4449</span></span><br><span class="line"> <span class="number">9</span>:             doDeregister();</span><br><span class="line"><span class="number">10</span>:             <span class="comment">// è¿”å› GlobalEventExecutor å¯¹è±¡</span></span><br><span class="line"><span class="number">11</span>:             <span class="keyword">return</span> GlobalEventExecutor.INSTANCE;</span><br><span class="line"><span class="number">12</span>:         }</span><br><span class="line"><span class="number">13</span>:     } <span class="keyword">catch</span> (Throwable ignore) {</span><br><span class="line"><span class="number">14</span>:         <span class="comment">// Ignore the error as the underlying channel may be closed in the meantime and so</span></span><br><span class="line"><span class="number">15</span>:         <span class="comment">// getSoLinger() may produce an exception. In this case we just return null.</span></span><br><span class="line"><span class="number">16</span>:         <span class="comment">// See https://github.com/netty/netty/issues/4449</span></span><br><span class="line"><span class="number">17</span>:     }</span><br><span class="line"><span class="number">18</span>:     <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">19</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ç¬¬ 4 è¡Œï¼šå¦‚æœé…ç½® <code>StandardSocketOptions.SO_LINGER</code> å¤§äº 0 ã€‚è®©æˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å®ƒçš„å®šä¹‰ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">Socket å‚æ•°ï¼Œå…³é—­ Socket çš„å»¶è¿Ÿæ—¶é—´ï¼ŒNetty é»˜è®¤å€¼ä¸º -<span class="number">1</span> ï¼Œè¡¨ç¤ºç¦ç”¨è¯¥åŠŸèƒ½ã€‚</span><br><span class="line"></span><br><span class="line">* -<span class="number">1</span> è¡¨ç¤º socket.close() æ–¹æ³•ç«‹å³è¿”å›ï¼Œä½† OS åº•å±‚ä¼šå°†å‘é€ç¼“å†²åŒºå…¨éƒ¨å‘é€åˆ°å¯¹ç«¯ã€‚</span><br><span class="line">* <span class="number">0</span> è¡¨ç¤º socket.close() æ–¹æ³•ç«‹å³è¿”å›ï¼ŒOS æ”¾å¼ƒå‘é€ç¼“å†²åŒºçš„æ•°æ®ç›´æ¥å‘å¯¹ç«¯å‘é€RSTåŒ…ï¼Œå¯¹ç«¯æ”¶åˆ°å¤ä½é”™è¯¯ã€‚</span><br><span class="line">* é <span class="number">0</span> æ•´æ•°å€¼è¡¨ç¤ºè°ƒç”¨ socket.close() æ–¹æ³•çš„çº¿ç¨‹è¢«é˜»å¡ç›´åˆ°å»¶è¿Ÿæ—¶é—´åˆ°æˆ–å‘é€ç¼“å†²åŒºä¸­çš„æ•°æ®å‘é€å®Œæ¯•ï¼Œè‹¥è¶…æ—¶ï¼Œåˆ™å¯¹ç«¯ä¼šæ”¶åˆ°å¤ä½é”™è¯¯ã€‚</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æŒ‰ç…§è¿™ä¸ªå®šä¹‰ï¼Œå¦‚æœ<strong>å¤§äº 0</strong>ï¼Œå¦‚æœåœ¨<strong>çœŸæ­£å…³é—­</strong> Channel ï¼Œéœ€è¦<strong>é˜»å¡</strong>ç›´åˆ°å»¶è¿Ÿæ—¶é—´åˆ°æˆ–å‘é€ç¼“å†²åŒºä¸­çš„æ•°æ®å‘é€å®Œæ¯•ã€‚</li>
<li>å¦‚æœåœ¨ EventLoop ä¸­æ‰§è¡Œ<strong>çœŸæ­£å…³é—­</strong> Channel çš„æ“ä½œï¼Œé‚£ä¹ˆåŠ¿å¿…ä¼šé˜»å¡ EventLoop çš„çº¿ç¨‹ã€‚æ‰€ä»¥ï¼Œåœ¨ã€ç¬¬ 11 è¡Œã€‘çš„ä»£ç ï¼Œè¿”å› <code>GlobalEventExecutor.INSTANCE</code> å¯¹è±¡ï¼Œä½œä¸ºæ‰§è¡Œ<strong>çœŸæ­£å…³é—­</strong> Channel çš„æ“ä½œçš„<strong>æ‰§è¡Œå™¨</strong>( å®ƒä¹Ÿæœ‰ä¸€ä¸ªè‡ªå·±çš„çº¿ç¨‹å“Ÿ )ã€‚</li>
</ul>
</li>
<li>ç¬¬ 9 è¡Œï¼šè°ƒç”¨ <code>#doDeregister()</code> æ–¹æ³•ï¼Œæ‰§è¡Œå–æ¶ˆæ³¨å†Œã€‚è¯¦ç»†è§£æï¼Œèƒ–å‹å…ˆè·³åˆ° <a href="#">ã€Œ2.2 AbstractUnsafe#doDeregisterã€</a> ä¸­ã€‚</li>
<li>ã€æ¥è‡ªæˆ‘è¡¨å¼Ÿæ™®æ¶çš„ç‰›é€¼è§£ç­”ï¼Œæˆ‘è¡¨ç¤ºç‚¹èµæ”¯æŒã€‘ç¬¬ 9 è¡Œçš„ï¼šä¸ºä»€ä¹ˆè¦è°ƒç”¨ <code>#doDeregister()</code> æ–¹æ³•å‘¢ï¼Ÿå› ä¸º <code>SO_LINGER</code> å¤§äº 0 æ—¶ï¼Œ<strong>çœŸæ­£å…³é—­</strong> Channel ï¼Œéœ€è¦<strong>é˜»å¡</strong>ç›´åˆ°å»¶è¿Ÿæ—¶é—´åˆ°æˆ–å‘é€ç¼“å†²åŒºä¸­çš„æ•°æ®å‘é€å®Œæ¯•ã€‚å¦‚æœä¸å–æ¶ˆè¯¥ Channel çš„ <code>SelectionKey.OP_READ</code> äº‹ä»¶çš„æ„Ÿå…´è¶£ï¼Œå°±ä¼šä¸æ–­è§¦å‘è¯»äº‹ä»¶ï¼Œå¯¼è‡´ CPU ç©ºè½®è¯¢ã€‚ä¸ºä»€ä¹ˆå‘¢?åœ¨ Channel å…³é—­æ—¶ï¼Œä¼š<strong>è‡ªåŠ¨</strong>è§¦å‘ <code>SelectionKey.OP_READ</code> äº‹ä»¶ã€‚è€Œä¸”ï¼Œä¼šä¸æ–­ä¸æ–­ä¸æ–­çš„è§¦å‘ï¼Œå¦‚æœä¸è¿›è¡Œå–æ¶ˆ <code>SelectionKey.OP_READ</code> äº‹ä»¶çš„æ„Ÿå…´è¶£ã€‚<ul>
<li>ğŸ˜ˆ æ„Ÿå¹ä¸€å¥ï¼Œç»†æ€ææå•Šï¼Œå‰å®³äº†ï¼ŒNetty ã€‚ </li>
</ul>
</li>
<li>ç¬¬ 11 è¡Œï¼šå¦‚æœå¼€å¯ <code>SO_LINGER</code> åŠŸèƒ½ï¼Œè¿”å› <code>GlobalEventExecutor.INSTANCE</code> å¯¹è±¡ã€‚</li>
<li>ç¬¬ 18 è¡Œï¼šè‹¥æœå…³é—­ <code>SO_LINGER</code> åŠŸèƒ½ï¼Œè¿”å› <code>null</code> å¯¹è±¡ã€‚</li>
<li>ğŸ˜ˆ èƒ–å‹ï¼Œè°ƒå› <a href="#">ã€Œ2.1 AbstractUnsafe#closeã€</a> ç»§ç»­æŠŠã€‚</li>
</ul>
<h2 id="2-3-AbstractUnsafe-doDeregister"><a href="#2-3-AbstractUnsafe-doDeregister" class="headerlink" title="2.3 AbstractUnsafe#doDeregister"></a>2.3 AbstractUnsafe#doDeregister</h2><p><code>AbstractUnsafe#doDeregister()</code> æ–¹æ³•ï¼Œæ‰§è¡Œå–æ¶ˆæ³¨å†Œã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDeregister</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    eventLoop().cancel(selectionKey());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è°ƒç”¨ <code>EventLoop#cancel(SelectionKey key)</code> æ–¹æ³•ï¼Œå–æ¶ˆ SelectionKey ï¼Œå³ç›¸å½“äºè°ƒç”¨ <code>SelectionKey#cancel()</code> æ–¹æ³•ã€‚å¦‚æ­¤ï¼Œå¯¹é€šé“çš„è¯»å†™ç­‰ç­‰ IO å°±ç»ªäº‹ä»¶ä¸å†æ„Ÿå…´è¶£ï¼Œä¹Ÿä¸ä¼šåšå‡ºç›¸åº”çš„å¤„ç†ã€‚</li>
</ul>
<h2 id="2-4-AbstractUnsafe-doClose0"><a href="#2-4-AbstractUnsafe-doClose0" class="headerlink" title="2.4 AbstractUnsafe#doClose0"></a>2.4 AbstractUnsafe#doClose0</h2><p><code>AbstractUnsafe#doClose0(ChannelPromise promise)</code> æ–¹æ³•ï¼Œæ‰§è¡Œ<strong>çœŸæ­£çš„</strong>å…³é—­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doClose0</span><span class="params">(ChannelPromise promise)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">3</span>:         <span class="comment">// æ‰§è¡Œå…³é—­</span></span><br><span class="line"> <span class="number">4</span>:         doClose();</span><br><span class="line"> <span class="number">5</span>:         <span class="comment">// é€šçŸ¥ closeFuture å…³é—­å®Œæˆ</span></span><br><span class="line"> <span class="number">6</span>:         closeFuture.setClosed();</span><br><span class="line"> <span class="number">7</span>:         <span class="comment">// é€šçŸ¥ Promise å…³é—­æˆåŠŸ</span></span><br><span class="line"> <span class="number">8</span>:         safeSetSuccess(promise);</span><br><span class="line"> <span class="number">9</span>:     } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line"><span class="number">10</span>:         <span class="comment">// é€šçŸ¥ closeFuture å…³é—­å®Œæˆ</span></span><br><span class="line"><span class="number">11</span>:         closeFuture.setClosed();</span><br><span class="line"><span class="number">12</span>:         <span class="comment">// é€šçŸ¥ Promise å…³é—­å¼‚å¸¸</span></span><br><span class="line"><span class="number">13</span>:         safeSetFailure(promise, t);</span><br><span class="line"><span class="number">14</span>:     }</span><br><span class="line"><span class="number">15</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 4 è¡Œï¼šè°ƒç”¨ <code>#doClose()</code> æ–¹æ³•ï¼Œæ‰§è¡Œå…³é—­ã€‚è¿™æ˜¯ä¸€ä¸ª<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼ŒNioSocketChannel å¯¹å®ƒçš„å®ç°ï¼Œèƒ–å‹å…ˆè·³åˆ° <a href="#">ã€Œ2.4.1 NioSocketChannel#doCloseã€ </a> ä¸­ã€‚</li>
<li><p>ç¬¬ 6 è¡Œï¼šè°ƒç”¨ <code>CloseFuture#setClosed()</code> æ–¹æ³•ï¼Œé€šçŸ¥ <code>closeFuture</code> å…³é—­å®Œæˆã€‚æ­¤å¤„å°±ä¼šç»“æŸæˆ‘ä»¬åœ¨ EchoClient çš„é˜»å¡ç›‘å¬å®¢æˆ·ç«¯å…³é—­ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Wait until the connection is closed.</span></span><br><span class="line"><span class="comment">// ç›‘å¬å®¢æˆ·ç«¯å…³é—­ï¼Œå¹¶é˜»å¡ç­‰å¾…</span></span><br><span class="line">f.channel().closeFuture().sync();</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å“Ÿå“Ÿå“Ÿï¼Œå°±è¦ç»“æŸé˜»å¡ç­‰å¾…äº†ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 8 è¡Œï¼šè°ƒç”¨ <code>#safeSetSuccess(promise)</code> æ–¹æ³•ï¼Œé€šçŸ¥ é€šçŸ¥ Promise å…³é—­<strong>æˆåŠŸ</strong>ã€‚æ­¤å¤„å°±ä¼šå›è°ƒæˆ‘ä»¬å¯¹ <code>Channel#close()</code> æ–¹æ³•çš„è¿”å›çš„ ChannelFuture çš„ç›‘å¬ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">ctx.channel().close().addListener(<span class="keyword">new</span> ChannelFutureListener() { <span class="comment">// æˆ‘æ˜¯ä¸€ä¸ªèŒèŒå“’ç›‘å¬å™¨</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        System.out.println(Thread.currentThread() + <span class="string">"æˆ‘ä¼šè¢«å”¤é†’"</span>);</span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å“Ÿå“Ÿå“Ÿï¼Œè¦è¢«å›è°ƒäº†ã€‚</li>
</ul>
</li>
<li>è‹¥å‘ç”Ÿå¼‚å¸¸ï¼š<ul>
<li>ç¬¬ 11 è¡Œï¼šè°ƒç”¨ <code>CloseFuture#setClosed()</code> æ–¹æ³•ï¼Œé€šçŸ¥ <code>closeFuture</code> å…³é—­å®Œæˆã€‚</li>
<li>ç¬¬ 13 è¡Œ: è°ƒç”¨ <code>#safeSetFailure(promise, t)</code> æ–¹æ³•ï¼Œé€šçŸ¥ é€šçŸ¥ Promise å…³é—­<strong>å¼‚å¸¸</strong>ã€‚</li>
</ul>
</li>
</ul>
<h3 id="2-4-1-NioSocketChannel-doClose"><a href="#2-4-1-NioSocketChannel-doClose" class="headerlink" title="2.4.1  NioSocketChannel#doClose"></a>2.4.1  NioSocketChannel#doClose</h3><p><code>NioSocketChannel#doClose()</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Java åŸç”Ÿ NIO SocketChannel å…³é—­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"><span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doClose</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"><span class="number">3</span>:     <span class="comment">// æ‰§è¡Œçˆ¶ç±»å…³é—­æ–¹æ³•</span></span><br><span class="line"><span class="number">4</span>:     <span class="keyword">super</span>.doClose();</span><br><span class="line"><span class="number">5</span>:     <span class="comment">// æ‰§è¡Œ Java åŸç”Ÿ NIO SocketChannel å…³é—­</span></span><br><span class="line"><span class="number">6</span>:     javaChannel().close();</span><br><span class="line"><span class="number">7</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ç¬¬ 4 è¡Œï¼šè°ƒç”¨ <code>AbstractNioChannel#doClose()</code> æ–¹æ³•ï¼Œæ‰§è¡Œ<strong>çˆ¶ç±»</strong>å…³é—­æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doClose</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">// é€šçŸ¥ connectPromise å¼‚å¸¸å¤±è´¥</span></span><br><span class="line">    ChannelPromise promise = connectPromise;</span><br><span class="line">    <span class="keyword">if</span> (promise != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// Use tryFailure() instead of setFailure() to avoid the race against cancel().</span></span><br><span class="line">        promise.tryFailure(DO_CLOSE_CLOSED_CHANNEL_EXCEPTION);</span><br><span class="line">        connectPromise = <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å–æ¶ˆ connectTimeoutFuture ç­‰å¾…</span></span><br><span class="line">    ScheduledFuture&lt;?&gt; future = connectTimeoutFuture;</span><br><span class="line">    <span class="keyword">if</span> (future != <span class="keyword">null</span>) {</span><br><span class="line">        future.cancel(<span class="keyword">false</span>);</span><br><span class="line">        connectTimeoutFuture = <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é€‚ç”¨äºå®¢æˆ·ç«¯<strong>æ­£åœ¨</strong>å‘èµ·å¯¹æœåŠ¡ç«¯çš„è¿æ¥çš„é˜¶æ®µã€‚</li>
</ul>
</li>
<li>ã€é‡è¦ã€‘ç¬¬ 6 è¡Œï¼šè°ƒç”¨ <code>SocketChannel#close()</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Java åŸç”Ÿ NIO SocketChannel å…³é—­ã€‚</li>
</ul>
<h2 id="2-5-AbstractUnsafe-fireChannelInactiveAndDeregister"><a href="#2-5-AbstractUnsafe-fireChannelInactiveAndDeregister" class="headerlink" title="2.5 AbstractUnsafe#fireChannelInactiveAndDeregister"></a>2.5 AbstractUnsafe#fireChannelInactiveAndDeregister</h2><p><code>AbstractUnsafe#fireChannelInactiveAndDeregister(boolean wasActive)</code> æ–¹æ³•ï¼Œæ‰§è¡Œå–æ¶ˆæ³¨å†Œï¼Œå¹¶è§¦å‘ Channel Inactive äº‹ä»¶åˆ° pipeline ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fireChannelInactiveAndDeregister</span><span class="params">(<span class="keyword">final</span> <span class="keyword">boolean</span> wasActive)</span> </span>{</span><br><span class="line">    deregister(voidPromise() <span class="comment">/** &lt;1&gt; **/</span>, wasActive &amp;&amp; !isActive() <span class="comment">/** &lt;2&gt; **/</span>); </span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">deregister</span><span class="params">(<span class="keyword">final</span> ChannelPromise promise, <span class="keyword">final</span> <span class="keyword">boolean</span> fireChannelInactive)</span> </span>{</span><br><span class="line">  <span class="number">2</span>:     <span class="comment">// è®¾ç½® Promise ä¸å¯å–æ¶ˆ</span></span><br><span class="line">  <span class="number">3</span>:     <span class="keyword">if</span> (!promise.setUncancellable()) {</span><br><span class="line">  <span class="number">4</span>:         <span class="keyword">return</span>;</span><br><span class="line">  <span class="number">5</span>:     }</span><br><span class="line">  <span class="number">6</span>: </span><br><span class="line">  <span class="number">7</span>:     <span class="comment">// ä¸å¤„äºå·²ç»æ³¨å†ŒçŠ¶æ€ï¼Œç›´æ¥é€šçŸ¥ Promise å–æ¶ˆæ³¨å†ŒæˆåŠŸã€‚</span></span><br><span class="line">  <span class="number">8</span>:     <span class="keyword">if</span> (!registered) {</span><br><span class="line">  <span class="number">9</span>:         safeSetSuccess(promise);</span><br><span class="line"> <span class="number">10</span>:         <span class="keyword">return</span>;</span><br><span class="line"> <span class="number">11</span>:     }</span><br><span class="line"> <span class="number">12</span>: </span><br><span class="line"> <span class="number">13</span>:     <span class="comment">// As a user may call deregister() from within any method while doing processing in the ChannelPipeline,</span></span><br><span class="line"> <span class="number">14</span>:     <span class="comment">// we need to ensure we do the actual deregister operation later. This is needed as for example,</span></span><br><span class="line"> <span class="number">15</span>:     <span class="comment">// we may be in the ByteToMessageDecoder.callDecode(...) method and so still try to do processing in</span></span><br><span class="line"> <span class="number">16</span>:     <span class="comment">// the old EventLoop while the user already registered the Channel to a new EventLoop. Without delay,</span></span><br><span class="line"> <span class="number">17</span>:     <span class="comment">// the deregister operation this could lead to have a handler invoked by different EventLoop and so</span></span><br><span class="line"> <span class="number">18</span>:     <span class="comment">// threads.</span></span><br><span class="line"> <span class="number">19</span>:     <span class="comment">//</span></span><br><span class="line"> <span class="number">20</span>:     <span class="comment">// See:</span></span><br><span class="line"> <span class="number">21</span>:     <span class="comment">// https://github.com/netty/netty/issues/4435</span></span><br><span class="line"> <span class="number">22</span>:     invokeLater(<span class="keyword">new</span> Runnable() {</span><br><span class="line"> <span class="number">23</span>:         <span class="meta">@Override</span></span><br><span class="line"> <span class="number">24</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">25</span>:             <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">26</span>:                 <span class="comment">// æ‰§è¡Œå–æ¶ˆæ³¨å†Œ</span></span><br><span class="line"> <span class="number">27</span>:                 doDeregister();</span><br><span class="line"> <span class="number">28</span>:             } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line"> <span class="number">29</span>:                 logger.warn(<span class="string">"Unexpected exception occurred while deregistering a channel."</span>, t);</span><br><span class="line"> <span class="number">30</span>:             } <span class="keyword">finally</span> {</span><br><span class="line"> <span class="number">31</span>:                 <span class="comment">// è§¦å‘ Channel Inactive äº‹ä»¶åˆ° pipeline ä¸­</span></span><br><span class="line"> <span class="number">32</span>:                 <span class="keyword">if</span> (fireChannelInactive) {</span><br><span class="line"> <span class="number">33</span>:                     pipeline.fireChannelInactive();</span><br><span class="line"> <span class="number">34</span>:                 }</span><br><span class="line"> <span class="number">35</span>: </span><br><span class="line"> <span class="number">36</span>:                 <span class="comment">// Some transports like local and AIO does not allow the deregistration of</span></span><br><span class="line"> <span class="number">37</span>:                 <span class="comment">// an open channel.  Their doDeregister() calls close(). Consequently,</span></span><br><span class="line"> <span class="number">38</span>:                 <span class="comment">// close() calls deregister() again - no need to fire channelUnregistered, so check</span></span><br><span class="line"> <span class="number">39</span>:                 <span class="comment">// if it was registered.</span></span><br><span class="line"> <span class="number">40</span>:                 <span class="keyword">if</span> (registered) {</span><br><span class="line"> <span class="number">41</span>:                     <span class="comment">// æ ‡è®°ä¸ºæœªæ³¨å†Œ</span></span><br><span class="line"> <span class="number">42</span>:                     registered = <span class="keyword">false</span>;</span><br><span class="line"> <span class="number">43</span>:                     <span class="comment">// è§¦å‘ Channel Unregistered äº‹ä»¶åˆ° pipeline ä¸­</span></span><br><span class="line"> <span class="number">44</span>:                     pipeline.fireChannelUnregistered();</span><br><span class="line"> <span class="number">45</span>:                 }</span><br><span class="line"> <span class="number">46</span>: </span><br><span class="line"> <span class="number">47</span>:                 <span class="comment">// é€šçŸ¥ Promise å–æ¶ˆæ³¨å†ŒæˆåŠŸã€‚</span></span><br><span class="line"> <span class="number">48</span>:                 safeSetSuccess(promise);</span><br><span class="line"> <span class="number">49</span>:             }</span><br><span class="line"> <span class="number">50</span>:         }</span><br><span class="line"> <span class="number">51</span>:     });</span><br><span class="line"> <span class="number">52</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><code>&lt;1&gt;</code> å¤„ï¼Œä¼ å…¥ <code>#deregister(...)</code> æ–¹æ³•çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸º <code>unsafeVoidPromise</code> ï¼Œç±»å‹ä¸º VoidChannelPromise <strong>ç±»</strong>ï¼Œè¡¨ç¤ºéœ€è¦é€šçŸ¥ Promise ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿåœ¨ <code>#safeSetSuccess(promise)</code> æ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">safeSetSuccess</span><span class="params">(ChannelPromise promise)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!(promise <span class="keyword">instanceof</span> VoidChannelPromise) &amp;&amp; !promise.trySuccess()) {</span><br><span class="line">        logger.warn(<span class="string">"Failed to mark a promise as success because it is done already: {}"</span>, promise);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>!(promise instanceof VoidChannelPromise)</code> ä»£ç å—ï¼Œè¡¨ç¤ºæ’é™¤ VoidChannelPromise ç±»å‹çš„ <code>promise</code> ã€‚</li>
</ul>
</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œé€šè¿‡å¯¹æ¯”æ–°è€çš„ <code>active</code> çš„å€¼ï¼Œåˆ¤æ–­æ˜¯å¦ Channel çš„çŠ¶æ€æ˜¯å¦ä» Active å˜æˆ Inactive ã€‚</li>
<li>ç¬¬ 2 è‡³ 5 è¡Œï¼šè°ƒç”¨ <code>ChannelPromise#setUncancellable()</code> æ–¹æ³•ï¼Œè®¾ç½® Promise ä¸å¯å–æ¶ˆã€‚</li>
<li>ç¬¬ 7 è‡³ 11 è¡Œï¼šä¸å¤„äºå·²ç»æ³¨å†ŒçŠ¶æ€ï¼Œç›´æ¥é€šçŸ¥ Promise å–æ¶ˆæ³¨å†ŒæˆåŠŸï¼Œå¹¶ <code>return</code> è¿”å›ã€‚<ul>
<li>ğŸ˜ˆ åœ¨å½“å‰æƒ…å†µä¸‹ï¼Œ<code>registered = true</code> ï¼Œæ‰€ä»¥ä¸ç¬¦åˆæ¡ä»¶ã€‚ </li>
</ul>
</li>
<li>ç¬¬ 22 è¡Œï¼šè°ƒç”¨ <code>#invokeLater(Runnable)</code> æ–¹æ³•ï¼Œæäº¤ä»»åŠ¡åˆ° EventLoop çš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œä»¥é¿å…<strong>ä¸€ä¸ª</strong> Channel çš„ ChannelHandler åœ¨<strong>ä¸åŒ</strong>çš„ EventLoop æˆ–è€…çº¿ç¨‹ä¸­æ‰§è¡Œã€‚è¯¦ç»†çš„è¯´æ˜ï¼Œå¯ä»¥çœ‹ä¸‹ã€ç¬¬ 13 è‡³ 21 è¡Œã€‘çš„è‹±æ–‡è¯´æ˜ã€‚<ul>
<li>ğŸ˜ˆ å®é™…ä»ç›®å‰è¯¥æ–¹æ³•çš„è°ƒç”¨çœ‹ä¸‹æ¥ï¼Œæœ‰å¯èƒ½ä¸æ˜¯ä» EventLoop çš„çº¿ç¨‹ä¸­è°ƒç”¨ã€‚</li>
</ul>
</li>
<li>ç¬¬ 27 è¡Œï¼šè°ƒç”¨ <code>AbstractUnsafe#doDeregister()</code> æ–¹æ³•ï¼Œæ‰§è¡Œå–æ¶ˆæ³¨å†Œã€‚åœ¨ <a href="#">ã€Œ2.3 AbstractUnsafe#doDeregisterã€</a> ä¸­ï¼Œå·²ç»è¯¦ç»†è§£æã€‚</li>
<li>ç¬¬ 31 è‡³ 34 è¡Œï¼šå¦‚æœ <code>fireChannelInactive = true</code> ï¼Œè°ƒç”¨ <code>ChannelPipeline#fireChannelInactive()</code> æ–¹æ³•ï¼Œè§¦å‘ Channel Inactive äº‹ä»¶åˆ° pipeline ä¸­ã€‚è€Œ Channel Inactive äº‹ä»¶å±äº Inbound äº‹ä»¶ï¼Œæ‰€ä»¥ä¼šä» <code>head</code> èŠ‚ç‚¹å¼€å§‹ï¼Œæœ€ç»ˆä¼ æ’­åˆ° <code>tail</code> èŠ‚ç‚¹ï¼Œç›®å‰å¹¶æœªæ‰§è¡Œä»€ä¹ˆé€»è¾‘ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥è‡ªå·±å»çœ‹çœ‹ã€‚å¦‚æœèƒ–å‹ä¸šåŠ¡ä¸Šæœ‰éœ€è¦ï¼Œå¯ä»¥è‡ªå·±æ·»åŠ  ChannelHandler è¿›è¡Œå¤„ç†ã€‚</li>
<li>ç¬¬ 40 è‡³ 42 è¡Œï¼šæ ‡è®°ä¸ºæœªæ³¨å†Œã€‚</li>
<li>ç¬¬ 44 è¡Œï¼šè°ƒç”¨ <code>ChannelPipeline#fireChannelUnregistered()</code> æ–¹æ³•ï¼Œè§¦å‘ Channel Unregistered äº‹ä»¶åˆ° pipeline ä¸­ã€‚è€Œ Channel Unregistered äº‹ä»¶å±äº Inbound äº‹ä»¶ï¼Œæ‰€ä»¥ä¼šä» <code>head</code> èŠ‚ç‚¹å¼€å§‹ï¼Œæœ€ç»ˆä¼ æ’­åˆ° <code>tail</code> èŠ‚ç‚¹ï¼Œç›®å‰å¹¶æœªæ‰§è¡Œä»€ä¹ˆé€»è¾‘ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥è‡ªå·±å»çœ‹çœ‹ã€‚å¦‚æœèƒ–å‹ä¸šåŠ¡ä¸Šæœ‰éœ€è¦ï¼Œå¯ä»¥è‡ªå·±æ·»åŠ  ChannelHandler è¿›è¡Œå¤„ç†ã€‚<ul>
<li>ğŸ˜ˆ åˆå•°å—¦äº†ä¸€éï¼Œã€ç¬¬ 31 è‡³ 34 è¡Œã€‘çš„ä»£ç çš„é€»è¾‘ã€‚</li>
</ul>
</li>
<li>ç¬¬ 48 è¡Œï¼šè°ƒç”¨ <code>#safeSetSuccess(promise)</code> æ–¹æ³•ï¼Œé€šçŸ¥ Promise å–æ¶ˆæ³¨å†ŒæˆåŠŸã€‚</li>
</ul>
<h1 id="3-NioServerSocketChannel"><a href="#3-NioServerSocketChannel" class="headerlink" title="3. NioServerSocketChannel"></a>3. NioServerSocketChannel</h1><p>é€šè¿‡ <code>NioServerSocketChannel#close()</code> æ–¹æ³•ï¼Œåº”ç”¨ç¨‹åºé‡Œå¯ä»¥ä¸»åŠ¨å…³é—­ NioServerSocketChannel é€šé“ã€‚åœ¨å…·ä½“çš„ä»£ç å®ç°ä¸Šï¼Œå”¯ä¸€çš„å·®åˆ«å°±æ˜¯å¯¹ <code>AbstractNioChannel#doClose()</code> æ–¹æ³•çš„å®ç°ä¸åŒ( å¯¹åº” <a href="#">ã€Œ2.4.1 NioSocketChannel#doCloseã€</a> )ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<p><code>NioSocketChannel#doClose()</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Java åŸç”Ÿ NIO SocketServerChannel å…³é—­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doClose</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    javaChannel().close();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è°ƒç”¨ <code>SocketServerChannel#close()</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Java åŸç”Ÿ NIO SocketServerChannel å…³é—­ã€‚</li>
</ul>
<hr>
<p>é‚£ä¹ˆå¯èƒ½ä¼šæœ‰èƒ–å‹æœ‰ç–‘æƒ‘äº†ï¼Œ<code>#close()</code> æ–¹æ³•çš„å®ç°ï¼Œ99.99% éƒ½ç›¸ä¼¼ï¼Œé‚£ä¹ˆ NioSocketChannel å’Œ NioServerSocketChannel å·®å¼‚çš„å…³é—­é€»è¾‘æ€ä¹ˆå®ç°å‘¢ï¼Ÿç­”æ¡ˆå…¶å®å¾ˆç®€å•ï¼Œé€šè¿‡ç»™å®ƒä»¬é…ç½®ä¸åŒçš„ ChannelHandler å®ç°ç±»å³å¯ã€‚</p>
<h1 id="4-Unsafe-closeForcibly"><a href="#4-Unsafe-closeForcibly" class="headerlink" title="4. Unsafe#closeForcibly"></a>4. Unsafe#closeForcibly</h1><p>å®é™…ä¸Šï¼Œåœ¨ Unsafe æ¥å£ä¸Šå®šä¹‰äº† <code>#closeForcibly()</code> æ–¹æ³•ï¼Œè‹±æ–‡æ³¨é‡Šå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Closes the {<span class="doctag">@link</span> Channel} immediately without firing any events.  Probably only useful</span></span><br><span class="line"><span class="comment"> * when registration attempt failed.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">closeForcibly</span><span class="params">()</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç«‹å³å…³é—­ Channel ï¼Œå¹¶ä¸”ä¸è§¦å‘ pipeline ä¸Šçš„ä»»ä½•äº‹ä»¶ã€‚</li>
<li>ä»…ä»…ç”¨äº Channel æ³¨å†Œåˆ° EventLoop ä¸Šå¤±è´¥çš„æƒ…å†µä¸‹ã€‚ğŸ˜ˆ è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ <code>without firing any events</code> çš„åŸå› å•¦ã€‚</li>
</ul>
<p>AbstractUnsafe å¯¹è¯¥æ¥å£æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">closeForcibly</span><span class="params">()</span> </span>{</span><br><span class="line">    assertEventLoop();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        doClose();</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        logger.warn(<span class="string">"Failed to close a channel."</span>, e);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨æ–¹æ³•å†…éƒ¨ï¼Œè°ƒç”¨ <code>AbstractNioChannel#doClose()</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Java åŸç”Ÿ NIO SocketServerChannel æˆ– SocketChannel å…³é—­ã€‚</li>
<li>å¹¶ä¸”ï¼Œä»ä»£ç å®ç°ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç¡®å®å¹¶æœªè§¦å‘ä»»ä½• pipeline ä¸Šçš„äº‹ä»¶ã€‚</li>
</ul>
<h1 id="5-æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­è¿æ¥"><a href="#5-æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­è¿æ¥" class="headerlink" title="5. æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­è¿æ¥"></a>5. æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­è¿æ¥</h1><p>åœ¨å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­æ—¶ï¼ŒæœåŠ¡ç«¯ä¼šæ”¶åˆ°ä¸€ä¸ª <code>SelectionKey.OP_READ</code> äº‹ä»¶çš„å°±ç»ªï¼Œåœ¨è°ƒç”¨å®¢æˆ·ç«¯å¯¹åº”åœ¨æœåŠ¡ç«¯çš„ SocketChannel çš„ <code>#read()</code> æ–¹æ³•ä¼šè¿”å› <strong>-1</strong> ï¼Œä»è€Œå®ç°åœ¨æœåŠ¡ç«¯å…³é—­å®¢æˆ·ç«¯çš„é€»è¾‘ã€‚åœ¨ Netty çš„å®ç°ï¼Œåœ¨ <code>NioByteUnsafe#read()</code> æ–¹æ³•ä¸­ï¼Œç®€åŒ–ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// &lt;1&gt;</span></span><br><span class="line"><span class="comment">// è¯»å–æ•°æ®</span></span><br><span class="line"><span class="comment">// è®¾ç½®æœ€åè¯»å–å­—èŠ‚æ•°</span></span><br><span class="line">allocHandle.lastBytesRead(doReadBytes(byteBuf));</span><br><span class="line"><span class="comment">// å¦‚æœæœ€åè¯»å–çš„å­—èŠ‚ä¸ºå°äº 0 ï¼Œè¯´æ˜å¯¹ç«¯å·²ç»å…³é—­</span></span><br><span class="line">close = allocHandle.lastBytesRead() &lt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å…³é—­å®¢æˆ·ç«¯çš„è¿æ¥</span></span><br><span class="line"><span class="keyword">if</span> (close) {</span><br><span class="line">    closeOnRead(pipeline);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè¯»å–å®¢æˆ·ç«¯çš„ SocketChannel è¿”å› <strong>-1</strong> ï¼Œè¯´æ˜å®¢æˆ·ç«¯å·²ç»å…³é—­ã€‚</li>
<li><p><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#closeOnRead(ChannelPipeline pipeline)</code> æ–¹æ³•ï¼Œå…³é—­å®¢æˆ·ç«¯çš„è¿æ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeOnRead</span><span class="params">(ChannelPipeline pipeline)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (!isInputShutdown0()) {</span><br><span class="line"> <span class="number">3</span>:         <span class="comment">// å¼€å¯è¿æ¥åŠå…³é—­</span></span><br><span class="line"> <span class="number">4</span>:         <span class="keyword">if</span> (isAllowHalfClosure(config())) {</span><br><span class="line"> <span class="number">5</span>:             <span class="comment">// å…³é—­ Channel æ•°æ®çš„è¯»å–</span></span><br><span class="line"> <span class="number">6</span>:             shutdownInput();</span><br><span class="line"> <span class="number">7</span>:             <span class="comment">// è§¦å‘ ChannelInputShutdownEvent.INSTANCE äº‹ä»¶åˆ° pipeline ä¸­</span></span><br><span class="line"> <span class="number">8</span>:             pipeline.fireUserEventTriggered(ChannelInputShutdownEvent.INSTANCE);</span><br><span class="line"> <span class="number">9</span>:         } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">10</span>:             close(voidPromise());</span><br><span class="line"><span class="number">11</span>:         }</span><br><span class="line"><span class="number">12</span>:     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">13</span>:         <span class="comment">// æ ‡è®° inputClosedSeenErrorOnRead ä¸º true</span></span><br><span class="line"><span class="number">14</span>:         inputClosedSeenErrorOnRead = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">15</span>:         <span class="comment">// è§¦å‘ ChannelInputShutdownEvent.INSTANCE äº‹ä»¶åˆ° pipeline ä¸­</span></span><br><span class="line"><span class="number">16</span>:         pipeline.fireUserEventTriggered(ChannelInputShutdownReadComplete.INSTANCE);</span><br><span class="line"><span class="number">17</span>:     }</span><br><span class="line"><span class="number">18</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ç¬¬ 2 è¡Œï¼šè°ƒç”¨ <code>NioSocketChannel#isInputShutdown0()</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å…³é—­ Channel æ•°æ®çš„è¯»å–ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// NioSocketChannel.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">isInputShutdown0</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> isInputShutdown();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isInputShutdown</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> javaChannel().socket().isInputShutdown() || !isActive();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// java.net.Socket.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> shutIn = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns whether the read-half of the socket connection is closed.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> true if the input of the socket has been shutdown</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 1.4</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #shutdownInput</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isInputShutdown</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> shutIn;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ğŸ˜ˆ æ³¨æ„çœ‹ä¸‹è‹±æ–‡æ³¨é‡Šã€‚</li>
</ul>
</li>
<li><p><code>&lt;1&gt;</code> ç¬¬ 4 è¡Œï¼šè°ƒç”¨ <code>AbstractNioByteChannel#isAllowHalfClosure()</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å¼€å¯è¿æ¥<strong>åŠå…³é—­</strong>çš„åŠŸèƒ½ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractNioByteChannel.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isAllowHalfClosure</span><span class="params">(ChannelConfig config)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> config <span class="keyword">instanceof</span> SocketChannelConfig &amp;&amp;</span><br><span class="line">            ((SocketChannelConfig) config).isAllowHalfClosure();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¯é€šè¿‡ <code>ALLOW_HALF_CLOSURE</code> é…ç½®é¡¹å¼€å¯ã€‚<ul>
<li>Netty å‚æ•°ï¼Œä¸€ä¸ªè¿æ¥çš„è¿œç«¯å…³é—­æ—¶æœ¬åœ°ç«¯æ˜¯å¦å…³é—­ï¼Œé»˜è®¤å€¼ä¸º <code>false</code> ã€‚</li>
<li>å€¼ä¸º <code>false</code>æ—¶ï¼Œè¿æ¥è‡ªåŠ¨å…³é—­ã€‚</li>
<li>å€¼ä¸º <code>true</code> æ—¶ï¼Œè§¦å‘ ChannelInboundHandler çš„<code>#userEventTriggered()</code> æ–¹æ³•ï¼Œäº‹ä»¶ ChannelInputShutdownEvent ã€‚</li>
</ul>
</li>
<li><p><code>&lt;1.1&gt;</code> ç¬¬ 6 è¡Œï¼šè°ƒç”¨ <code>NioSocketChannel#shutdownInput()</code> æ–¹æ³•ï¼Œå…³é—­ Channel æ•°æ®çš„è¯»å–ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">shutdownInput</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> shutdownInput(newPromise());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">shutdownInput</span><span class="params">(<span class="keyword">final</span> ChannelPromise promise)</span> </span>{</span><br><span class="line">    EventLoop loop = eventLoop();</span><br><span class="line">    <span class="keyword">if</span> (loop.inEventLoop()) {</span><br><span class="line">        shutdownInput0(promise);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        loop.execute(<span class="keyword">new</span> Runnable() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">                shutdownInput0(promise);</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> promise;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">shutdownInput0</span><span class="params">(<span class="keyword">final</span> ChannelPromise promise)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// å…³é—­ Channel æ•°æ®çš„è¯»å–</span></span><br><span class="line">        shutdownInput0();</span><br><span class="line">        <span class="comment">// é€šçŸ¥ Promise æˆåŠŸ</span></span><br><span class="line">        promise.setSuccess();</span><br><span class="line">    } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line">        <span class="comment">// é€šçŸ¥ Promise å¤±è´¥</span></span><br><span class="line">        promise.setFailure(t);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">shutdownInput0</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">// è°ƒç”¨ Java NIO Channel çš„ shutdownInput æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (PlatformDependent.javaVersion() &gt;= <span class="number">7</span>) {</span><br><span class="line">        javaChannel().shutdownInput();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        javaChannel().socket().shutdownInput();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ ¸å¿ƒæ˜¯ï¼Œè°ƒç”¨ Java NIO Channel çš„ shutdownInput æ–¹æ³•ã€‚</li>
</ul>
</li>
<li><code>&lt;1.1&gt;</code> ç¬¬ 8 è¡Œï¼šè°ƒç”¨ <code>ChannelPipeline#fireUserEventTriggered(Object event)</code> æ–¹æ³•ï¼Œè§¦å‘ <code>ChannelInputShutdownEvent.INSTANCE</code> äº‹ä»¶åˆ° pipeline ä¸­ã€‚å…³äºè¿™ä¸ªäº‹ä»¶ï¼Œèƒ–å‹å¯ä»¥çœ‹çœ‹ <a href="https://my.oschina.net/chenleijava/blog/484667" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnetty å¤„ç†è¿œç¨‹ä¸»æœºå¼ºåˆ¶å…³é—­ä¸€ä¸ªè¿æ¥ã€‹</a> ã€‚</li>
<li><code>&lt;1.2&gt;</code> ç¬¬ 9 è‡³ 11 è¡Œï¼šè°ƒç”¨ <code>#close(Promise)</code> æ–¹æ³•ï¼Œå…³é—­å®¢æˆ·ç«¯çš„ Channel ã€‚åç»­çš„ï¼Œå°±æ˜¯ <a href="#">ã€Œ2. NioSocketChannelã€</a> ä¸­ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p>ç¬¬ 12 è‡³ 17 è¡Œï¼š</p>
<ul>
<li><p>ç¬¬ 14 è¡Œï¼šæ ‡è®° <code>inputClosedSeenErrorOnRead</code> ä¸º <code>true</code> ã€‚åŸå› å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é€šé“å…³é—­è¯»å–ï¼Œåˆé”™è¯¯è¯»å–çš„é”™è¯¯çš„æ ‡è¯†</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¯¦ç»†è§ https://github.com/netty/netty/commit/ed0668384b393c3502c2136e3cc412a5c8c9056e æäº¤</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> inputClosedSeenErrorOnRead;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>å¦‚ä¸‹æ˜¯æäº¤çš„è¯´æ˜ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">AbstractNioByteChannel will detect that the remote end of the socket has</span><br><span class="line">been closed and propagate a user event through the pipeline. However <span class="keyword">if</span></span><br><span class="line">the user has auto read on, or calls read again, we may propagate the</span><br><span class="line">same user events again. If the underlying transport continuously</span><br><span class="line">notifies us that there is read activity <span class="keyword">this</span> will happen in a spin loop</span><br><span class="line">which consumes unnecessary CPU.</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>èƒ–å‹è®¤çœŸçœ‹ä¸‹è‹±æ–‡æ³¨é‡Šã€‚ç»“åˆ <a href="https://github.com/netty/netty/pull/7801" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNIO read spin event loop spin when half closed #7801ã€‹</a> æä¾›çš„ç¤ºä¾‹ã€‚</li>
<li><p>åœ¨æ ‡è®° <code>inputClosedSeenErrorOnRead = true</code> åï¼Œåœ¨ <code>NioByteUnsafe#read()</code> æ–¹æ³•ä¸­ï¼Œä¼šä¸»åŠ¨å¯¹ <code>SelectionKey.OP_READ</code> çš„æ„Ÿå…´è¶£ï¼Œé¿å…ç©ºè½®è¯¢ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractNioByteUnsafe.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> ChannelConfig config = config();</span><br><span class="line">    <span class="comment">// è‹¥ inputClosedSeenErrorOnRead = true ï¼Œç§»é™¤å¯¹ SelectionKey.OP_READ äº‹ä»¶çš„æ„Ÿå…´è¶£ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (shouldBreakReadReady(config)) {</span><br><span class="line">        clearReadPending(); <span class="comment">// ç§»é™¤å¯¹ SelectionKey.OP_READ äº‹ä»¶çš„æ„Ÿå…´è¶£</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç ã€‚</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// AbstractNioByteChannel.java</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">shouldBreakReadReady</span><span class="params">(ChannelConfig config)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> isInputShutdown0() &amp;&amp; (inputClosedSeenErrorOnRead || !isAllowHalfClosure(config));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>x</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 16 è¡Œï¼šè°ƒç”¨ <code>ChannelPipeline#fireUserEventTriggered(Object event)</code> æ–¹æ³•ï¼Œè§¦å‘ <code>ChannelInputShutdownEvent.INSTANCE</code> äº‹ä»¶åˆ° pipeline ä¸­ã€‚</li>
</ul>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ¯”æƒ³è±¡ä¸­ç®€å•çš„æ–‡ç« ã€‚ä½†æ˜¯ï¼Œå¡äº†æ¯”è¾ƒä¹…çš„æ—¶é—´ã€‚ä¸»è¦æ˜¯é’ˆå¯¹ <a href="https://github.com/netty/netty/issues/4449" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠHigh CPU usage with SO_LINGER and sudden connection close (4.0.26.Final+) #4449ã€‹</a> çš„è®¨è®ºï¼Œä¸­é—´è¯·æ•™äº†åŸºå‹é—ªç”µä¾ å’Œè¡¨å¼Ÿæ™®æ¶ã€‚</p>
<p>ç—›å¹¶å¿«ä¹çš„è¿‡ç¨‹ã€‚å¦‚æœè‹±æ–‡å¥½ä¸€ç‚¹ï¼Œç›¸ä¿¡è§£å†³çš„è¿‡ç¨‹ï¼Œå¯èƒ½æ›´åŠ æ„‰å¿«ä¸€äº›æŠŠã€‚</p>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/Channel-7-close/" data-id="ck4pl3fp300dxfgcf9x6fgwps" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>