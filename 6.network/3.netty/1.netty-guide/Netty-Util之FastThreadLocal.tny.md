<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” Util ä¹‹ FastThreadLocal
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<p>ç¬”è€…å…ˆæŠŠ Netty ä¸»è¦çš„å†…å®¹å†™å®Œï¼Œæ‰€ä»¥å…³äº FastThreadLocal çš„åˆ†äº«ï¼Œå…ˆæ”¾åœ¨åç»­çš„è®¡åˆ’é‡Œã€‚</p>
<blockquote>
<p>è€è‰¿è‰¿ï¼šå…¶å®æ˜¯å› ä¸ºï¼Œè‡ªå·±æƒ³å»ç ”ç©¶ä¸‹ Service Mesh ï¼Œæ‰€ä»¥å…ˆç®€å•æ”¶ä¸ªå°å°¾ã€‚</p>
</blockquote>
<p>å½“ç„¶ï¼Œè‰¯å¿ƒå¦‚æˆ‘ï¼Œè¿˜æ˜¯ä¸ºå¯¹è¿™å—æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå…ˆå‡†å¤‡å¥½äº†ä¸€ç¯‡ä¸é”™çš„æ–‡ç« ï¼š</p>
<ul>
<li>è«é‚£ä¸€é²é“ <a href="https://www.jianshu.com/p/3fc2fbac4bb7" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty é«˜æ€§èƒ½ä¹‹é“ FastThreadLocal æºç åˆ†æï¼ˆå¿«ä¸”å®‰å…¨ï¼‰ã€‹</a><ul>
<li>ğŸ˜ˆ æˆ‘çš„å¥½åŸºå‹ï¼Œå¯ä»¥å…³æ³¨ä¸‹ä»–çš„ç®€ä¹¦ã€‚ </li>
</ul>
</li>
<li>æš—å¤œå›ç‹ <a href="https://segmentfault.com/a/1190000012926809" rel="external nofollow noopener noreferrer" target="_blank">ã€Šã€æºèµ·Netty å¤–ä¼ ã€‘FastThreadLocalæ€ä¹ˆFastï¼Ÿã€‹</a></li>
</ul>
<p>ä¸ºé¿å…å¯èƒ½ <a href="https://www.jianshu.com/p/3fc2fbac4bb7" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty é«˜æ€§èƒ½ä¹‹é“ FastThreadLocal æºç åˆ†æï¼ˆå¿«ä¸”å®‰å…¨ï¼‰ã€‹</a> è¢«ä½œè€…åˆ é™¤ï¼Œç¬”è€…è¿™é‡Œå…ˆå¤åˆ¶ä¸€ä»½ä½œä¸ºå¤‡ä»½ã€‚</p>
<h1 id="666-å¤‡ä»½"><a href="#666-å¤‡ä»½" class="headerlink" title="666. å¤‡ä»½"></a>666. å¤‡ä»½</h1><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>Netty ä½œä¸ºé«˜æ€§èƒ½æ¡†æ¶ï¼Œå¯¹ JDK ä¸­çš„å¾ˆå¤šç±»éƒ½è¿›è¡Œäº†å°è£…äº†å’Œä¼˜åŒ–ï¼Œä¾‹å¦‚ Thread ç±»ï¼ŒNetty ä½¿ç”¨äº† FastThreadLocalRunnable å¯¹æ‰€æœ‰ DefaultThreadFactory åˆ›å»ºå‡ºæ¥çš„ Runnable éƒ½è¿›è¡Œäº†åŒ…è£…ã€‚åŒ…è£…çš„ç›®çš„æ˜¯ run æ–¹æ³•çš„ä¸åŒï¼Œçœ‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        runnable.run();</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        FastThreadLocal.removeAll();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå¤šäº†ä¸€è¡Œ  FastThreadLocal.removeAll()ï¼Œä¼—æ‰€å‘¨çŸ¥ï¼ŒJDK ä¸­è‡ªå¸¦çš„ ThreadLocal åœ¨çº¿ç¨‹æ± ä½¿ç”¨ç¯å¢ƒä¸­ï¼Œæœ‰å†…å­˜æ³„æ¼çš„é£é™©ï¼Œå¾ˆæ˜æ˜¾ï¼ŒNetty ä¸ºäº†é¿å…è¿™ä¸ª bugï¼Œé‡æ–°è¿›è¡Œäº†å°è£…ï¼Œè€Œä¸”è¿™ä¸ªå°è£…çº¿ç¨‹çš„åå­—å«åš FastThreadLocalRunnableï¼Œè¯­ä¹‰å¾ˆæ˜æ˜¾ï¼šå¿«é€Ÿçš„ ThreadLocalï¼æ„æ€è¯´ JDK è‡ªå¸¦çš„æ…¢å–½ï¼Ÿé‚£æˆ‘ä»¬ä»Šå¤©å°±æ¥çœ‹çœ‹åˆ°åº•å¿«åœ¨å“ªé‡Œï¼Ÿå¯¹ ThreadLocal å†…å­˜æ³„æ¼ä¸æ¸…æ¥šæˆ–è€…å¯¹ ThreadLoca ä¸æ¸…æ¥šçš„å¯ä»¥ç§»æ­¥ <a href="https://www.jianshu.com/p/80284438bb97" rel="external nofollow noopener noreferrer" target="_blank">å¹¶å‘ç¼–ç¨‹ä¹‹ ThreadLocal æºç å‰–æ</a>ã€‚</p>
<h2 id="1-å¦‚ä½•ä½¿ç”¨ï¼Ÿ"><a href="#1-å¦‚ä½•ä½¿ç”¨ï¼Ÿ" class="headerlink" title="1. å¦‚ä½•ä½¿ç”¨ï¼Ÿ"></a>1. å¦‚ä½•ä½¿ç”¨ï¼Ÿ</h2><p><a href="https://upload-images.jianshu.io/upload_images/4236553-12c253f98742f4b2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/648/format/jpeg" title="img" class="fancybox" rel="article0"><img src="https:////upload-images.jianshu.io/upload_images/4236553-12c253f98742f4b2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/648/format/jpeg" alt="img"></a><span class="caption">img</span></p>
<p>æµ‹è¯•ç”¨ä¾‹</p>
<p><a href="https://upload-images.jianshu.io/upload_images/4236553-7ec7f64c3cbf86f8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/454/format/jpeg" title="img" class="fancybox" rel="article0"><img src="https:////upload-images.jianshu.io/upload_images/4236553-7ec7f64c3cbf86f8.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/454/format/jpeg" alt="img"></a><span class="caption">img</span></p>
<p>è¿è¡Œç»“æœ</p>
<h2 id="2-æ„é€ æ–¹æ³•è§£æ"><a href="#2-æ„é€ æ–¹æ³•è§£æ" class="headerlink" title="2. æ„é€ æ–¹æ³•è§£æ"></a>2. æ„é€ æ–¹æ³•è§£æ</h2><p><a href="https://upload-images.jianshu.io/upload_images/4236553-852af1ffc45a7a99.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/563/format/jpeg" title="img" class="fancybox" rel="article0"><img src="https:////upload-images.jianshu.io/upload_images/4236553-852af1ffc45a7a99.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/563/format/jpeg" alt="img"></a><span class="caption">img</span></p>
<p>æ„é€ æ–¹æ³•</p>
<p>æ„é€ æ–¹æ³•ä¸­å®šä¹‰äº†ä¸¤ä¸ªå˜é‡ã€‚ index å’Œ cleanerFlagIndexï¼Œè¿™ä¸¤ä¸ªå˜é‡ä¸”éƒ½æ˜¯ int final çš„ã€‚ä¸”éƒ½æ˜¯é€šè¿‡<br> InternalThreadLocalMap.nextVariableIndex() æ–¹æ³•è€Œæ¥ã€‚</p>
<p><a href="https://upload-images.jianshu.io/upload_images/4236553-266a99ac72429da7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/719/format/jpeg" title="img" class="fancybox" rel="article0"><img src="https:////upload-images.jianshu.io/upload_images/4236553-266a99ac72429da7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/719/format/jpeg" alt="img"></a><span class="caption">img</span></p>
<p>InternalThreadLocalMap.nextVariableIndex() æ–¹æ³•</p>
<p><a href="https://upload-images.jianshu.io/upload_images/4236553-5cdca30965ae3c19.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/552/format/jpeg" title="img" class="fancybox" rel="article0"><img src="https:////upload-images.jianshu.io/upload_images/4236553-5cdca30965ae3c19.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/552/format/jpeg" alt="img"></a><span class="caption">img</span></p>
<p>nextIndex å˜é‡</p>
<p>è¯¥æ–¹æ³•é€šè¿‡ä¸€ä¸ªåŸå­ int å˜é‡è‡ªå¢å¾—åˆ°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒcleanerFlagIndex å˜é‡æ¯” index å¤§1ï¼Œè¿™ä¸¤ä¸ªå˜é‡çš„ä½œç”¨ç¨åæˆ‘ä»¬ä¼šçœ‹åˆ°ä»–ä»¬å¦‚ä½•ä½¿ç”¨ã€‚è¿™é‡Œæš‚ä¸”ä¸è¡¨ã€‚</p>
<h2 id="3-set-æ–¹æ³•è§£æ"><a href="#3-set-æ–¹æ³•è§£æ" class="headerlink" title="3. set æ–¹æ³•è§£æ"></a>3. set æ–¹æ³•è§£æ</h2><p><a href="https://upload-images.jianshu.io/upload_images/4236553-30ec041c29b4c55d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/698/format/jpeg" title="img" class="fancybox" rel="article0"><img src="https:////upload-images.jianshu.io/upload_images/4236553-30ec041c29b4c55d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/698/format/jpeg" alt="img"></a><span class="caption">img</span></p>
<p>setï¼ˆï¼‰ æ–¹æ³•</p>
<p>è¯¥æ–¹æ³•æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ¤æ–­è®¾ç½®çš„ value å€¼æ˜¯å¦æ˜¯ç¼ºçœå€¼ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è°ƒç”¨ remove æ–¹æ³•ã€‚</li>
<li>å¦‚æœä¸æ˜¯ï¼Œåˆ™è·å–é“å½“å‰çº¿ç¨‹çš„ InternalThreadLocalMapã€‚ç„¶åå°†è¯¥ FastThreadLocal å¯¹åº”çš„ index ä¸‹æ ‡çš„ value æ›¿æ¢æˆæ–°çš„ valueã€‚è€çš„ value è®¾ç½®æˆç¼ºçœå€¼ã€‚</li>
</ol>
<p><strong>å°å°çš„ä¸€ä¸ª set æ–¹æ³•ï¼Œå†…éƒ¨å¯æ˜¯éå¸¸çš„å¤æ‚ï¼Œéæˆ˜æ–—äººå‘˜è¯·å°½å¿«æ’¤ç¦»ï¼</strong></p>
<p>å®é™…ä¸Šï¼Œè¿™é‡Œè°ƒç”¨äº†4ä¸ªæ–¹æ³•ï¼š</p>
<ol>
<li>InternalThreadLocalMap.get()ï¼›</li>
<li>setKnownNotUnset(threadLocalMap, value);</li>
<li>registerCleaner(threadLocalMap);</li>
<li>remove();</li>
</ol>
<p>è®©æˆ‘ä»¬æ…¢æ…¢è¯´é“è¯´é“ã€‚</p>
<h4 id="1-InternalThreadLocalMap-get-ï¼›"><a href="#1-InternalThreadLocalMap-get-ï¼›" class="headerlink" title="1. InternalThreadLocalMap.get()ï¼›"></a>1. InternalThreadLocalMap.get()ï¼›</h4><p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InternalThreadLocalMap <span class="title">get</span><span class="params">()</span> </span>{</span><br><span class="line">    Thread thread = Thread.currentThread();</span><br><span class="line">    <span class="keyword">if</span> (thread <span class="keyword">instanceof</span> FastThreadLocalThread) {</span><br><span class="line">        <span class="keyword">return</span> fastGet((FastThreadLocalThread) thread);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> slowGet();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>é¦–å…ˆæ˜¯ InternalThreadLocalMap çš„é™æ€æ–¹æ³•ï¼Œæ–¹æ³•é€»è¾‘å¾ˆç®€å•ï¼Œä¸»è¦æ˜¯æ ¹æ®å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ Netty çš„ FastThreadLocalThread æ¥è°ƒç”¨ä¸åŒçš„æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯ fast çš„ï¼Œä¸€ä¸ª æ˜¯ slow çš„ï¼ˆä¸æ˜¯ Netty çš„çº¿ç¨‹å°±æ˜¯ slow çš„ï¼‰ã€‚å“ˆå“ˆå“ˆï¼ŒNetty çš„ä½œè€…å‘½åè¿˜çœŸæ˜¯çŠ€åˆ©ã€‚é‚£æˆ‘ä»¬å°±çœ‹çœ‹ fastGet æ–¹æ³•æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> InternalThreadLocalMap <span class="title">fastGet</span><span class="params">(FastThreadLocalThread thread)</span> </span>{</span><br><span class="line">    InternalThreadLocalMap threadLocalMap = thread.threadLocalMap();</span><br><span class="line">    <span class="keyword">if</span> (threadLocalMap == <span class="keyword">null</span>) {</span><br><span class="line">        thread.setThreadLocalMap(threadLocalMap = <span class="keyword">new</span> InternalThreadLocalMap());</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> threadLocalMap;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>é€»è¾‘å¾ˆç®€å•ï¼Œè·å–å½“å‰çº¿ç¨‹çš„ InternalThreadLocalMapï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±åˆ›å»ºä¸€ä¸ªã€‚æˆ‘ä»¬çœ‹çœ‹ä»–çš„æ„é€ æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Object UNSET = <span class="keyword">new</span> Object();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">InternalThreadLocalMap</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">super</span>(newIndexedVariableTable());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Object[] newIndexedVariableTable() {</span><br><span class="line">    Object[] array = <span class="keyword">new</span> Object[<span class="number">32</span>];</span><br><span class="line">    Arrays.fill(array, UNSET);</span><br><span class="line">    <span class="keyword">return</span> array;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">UnpaddedInternalThreadLocalMap(Object[] indexedVariables) {</span><br><span class="line">    <span class="keyword">this</span>.indexedVariables = indexedVariables;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>æ¥¼ä¸»å°† 3 ä¸ªå…³è”çš„æ–¹æ³•éƒ½æ”¾åœ¨ä¸€èµ·äº†ï¼Œæ–¹ä¾¿æŸ¥çœ‹ï¼Œé¦–å…ˆï¼ŒInternalThreadLocalMap è°ƒç”¨çš„çˆ¶ç±» UnpaddedInternalThreadLocalMap çš„æ„é€ æ–¹æ³•ï¼Œå¹¶ä¼ å…¥äº†ä¸€ä¸ªæ•°ç»„ï¼Œè€Œè¿™ä¸ªæ•°ç»„é»˜è®¤å¤§å°æ˜¯ 32ï¼Œé‡Œé¢å¡«å……32 ä¸ªç©ºå¯¹è±¡çš„å¼•ç”¨ã€‚</p>
<p>é‚£ slowGet æ–¹æ³•åˆæ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;InternalThreadLocalMap&gt; slowThreadLocalMap = <span class="keyword">new</span> ThreadLocal&lt;InternalThreadLocalMap&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> InternalThreadLocalMap <span class="title">slowGet</span><span class="params">()</span> </span>{</span><br><span class="line">    ThreadLocal&lt;InternalThreadLocalMap&gt; slowThreadLocalMap = UnpaddedInternalThreadLocalMap.slowThreadLocalMap;</span><br><span class="line">    InternalThreadLocalMap ret = slowThreadLocalMap.get();</span><br><span class="line">    <span class="keyword">if</span> (ret == <span class="keyword">null</span>) {</span><br><span class="line">        ret = <span class="keyword">new</span> InternalThreadLocalMap();</span><br><span class="line">        slowThreadLocalMap.set(ret);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ä»£ç è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹ï¼šé¦–å…ˆä½¿ç”¨ JDK çš„ ThreadLocal è·å–ä¸€ä¸ª Netty çš„ InternalThreadLocalMapï¼Œå¦‚æœæ²¡æœ‰å°±åˆ›å»ºä¸€ä¸ªï¼Œå¹¶å°†è¿™ä¸ª InternalThreadLocalMap è®¾ç½®åˆ° JDK çš„ ThreadLocal ä¸­ï¼Œç„¶åè¿”å›è¿™ä¸ª InternalThreadLocalMapã€‚ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼ŒNetty è¿˜æ˜¯é¿å…ä½¿ç”¨äº†JDK çš„ threadLocalMapï¼Œä»–çš„æ–¹å¼æ˜¯æ›²çº¿æ•‘å›½ï¼šåœ¨JDK çš„ threadLocal ä¸­è®¾ç½® Netty çš„ InternalThreadLocalMap ï¼Œç„¶åï¼Œè¿™ä¸ª InternalThreadLocalMap ä¸­è®¾ç½® Netty çš„ FastThreadLcoalã€‚</p>
<p>å¥½ï¼Œåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬çš„ InternalThreadLocalMap.get() æ–¹æ³•å°±çœ‹å®Œäº†ï¼Œä¸»è¦æ˜¯è·å–å½“å‰çº¿ç¨‹çš„ InternalThreadLocalMapï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±åˆ›å»ºä¸€ä¸ªï¼Œè¿™ä¸ª Map å†…éƒ¨ç»´æŠ¤çš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå’Œ JDK ä¸åŒï¼ŒJDK<br> ç»´æŠ¤çš„æ˜¯ä¸€ä¸ªä½¿ç”¨çº¿æ€§æ¢æµ‹æ³•çš„ Mapï¼Œå¯è§ï¼Œä»åº•å±‚æ•°æ®ç»“æ„ä¸Šï¼ŒJDK å°±å·²ç»è¾“äº†ï¼Œä»–ä»¬çš„è¯»å–é€Ÿåº¦ç›¸å·®å¾ˆå¤§ï¼Œç‰¹åˆ«æ˜¯å½“æ•°æ®é‡å¾ˆå¤§çš„æ—¶å€™ï¼ŒNetty çš„æ•°æ®ç»“æ„é€Ÿåº¦ä¾ç„¶ä¸å˜ï¼Œè€Œ JDK ç”±äºä½¿ç”¨çº¿æ€§æ¢æµ‹æ³•ï¼Œé€Ÿåº¦ä¼šç›¸åº”çš„ä¸‹é™ã€‚</p>
<h4 id="2-setKnownNotUnset-threadLocalMap-value"><a href="#2-setKnownNotUnset-threadLocalMap-value" class="headerlink" title="2. setKnownNotUnset(threadLocalMap, value);"></a>2. setKnownNotUnset(threadLocalMap, value);</h4><p>å½“ InternalThreadLocalMap.get() è¿”å›äº† ä¸€ä¸ª InternalThreadLocalMapï¼Œè¿™ä¸ªæ—¶å€™è°ƒç”¨ setKnownNotUnset(threadLocalMap, value); æ–¹æ³•è¿›è¡Œæ“ä½œã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setKnownNotUnset</span><span class="params">(InternalThreadLocalMap threadLocalMap, V value)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (threadLocalMap.setIndexedVariable(index, value)) {</span><br><span class="line">        addToVariablesToRemove(threadLocalMap, <span class="keyword">this</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>çœ‹æ–¹æ³•åç§°ï¼Œæ˜¯è®¾ç½®ä¸€ä¸ªå€¼ï¼Œä½†ä¸æ˜¯ unsetï¼Œä¹Ÿå°±æ˜¯é‚£ä¸ªç©ºå¯¹è±¡ã€‚é€šè¿‡ threadLocalMap.setIndexedVariable(index, value) è¿›è¡Œè®¾ç½®ã€‚å¦‚æœè¿”å› trueï¼Œåˆ™è°ƒç”¨ addToVariablesToRemove(threadLocalMap, this) ã€‚è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬ä¸€èµ·çœ‹çœ‹ã€‚å…ˆçœ‹ç¬¬ä¸€ä¸ªï¼š</p>
<p>setIndexedVariable æ–¹æ³•</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setIndexedVariable</span><span class="params">(<span class="keyword">int</span> index, Object value)</span> </span>{</span><br><span class="line">    Object[] lookup = indexedVariables;</span><br><span class="line">    <span class="keyword">if</span> (index &lt; lookup.length) {</span><br><span class="line">        Object oldValue = lookup[index];</span><br><span class="line">        lookup[index] = value;</span><br><span class="line">        <span class="keyword">return</span> oldValue == UNSET;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        expandIndexedVariableTableAndSet(index, value);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>é¦–å…ˆï¼Œæ‹¿åˆ°é‚£ä¸ª 32 é•¿åº¦çš„æ•°ç»„ï¼Œå¦‚æœ FastThreadLocal çš„ index å±æ€§å°äºæ•°ç»„é•¿åº¦ï¼Œåˆ™å°†å€¼è®¾å®šåˆ°æŒ‡å®šæ§½ä½ã€‚å°†åŸæ¥æ§½ä½çš„å€¼è®¾ç½®ä¸ºç©ºå¯¹è±¡ã€‚å¦‚æœåŸæ¥çš„å¯¹è±¡ä¹Ÿæ˜¯ç©ºå¯¹è±¡ï¼Œåˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚</p>
<p>å¦‚æœä¸å¤Ÿå‘¢ï¼Ÿè°ƒç”¨ expandIndexedVariableTableAndSet(index, value) æ–¹æ³•ã€‚è¿›å…¥è¯¥æ–¹æ³•æŸ¥çœ‹ã€‚çœ‹æ–¹æ³•åç§°æ˜¯æ‰©å¤§ç´¢å¼•å¹¶è®¾ç½®å€¼ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">expandIndexedVariableTableAndSet</span><span class="params">(<span class="keyword">int</span> index, Object value)</span> </span>{</span><br><span class="line">    Object[] oldArray = indexedVariables;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> oldCapacity = oldArray.length;</span><br><span class="line">    <span class="keyword">int</span> newCapacity = index;</span><br><span class="line">    newCapacity |= newCapacity &gt;&gt;&gt;  <span class="number">1</span>;</span><br><span class="line">    newCapacity |= newCapacity &gt;&gt;&gt;  <span class="number">2</span>;</span><br><span class="line">    newCapacity |= newCapacity &gt;&gt;&gt;  <span class="number">4</span>;</span><br><span class="line">    newCapacity |= newCapacity &gt;&gt;&gt;  <span class="number">8</span>;</span><br><span class="line">    newCapacity |= newCapacity &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    newCapacity ++;</span><br><span class="line"></span><br><span class="line">    Object[] newArray = Arrays.copyOf(oldArray, newCapacity);</span><br><span class="line">    Arrays.fill(newArray, oldCapacity, newArray.length, UNSET);</span><br><span class="line">    newArray[index] = value;</span><br><span class="line">    indexedVariables = newArray;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™é‡Œä»£ç å¾ˆç†Ÿæ‚‰ï¼ŒHashMap ä¸­ä¹Ÿæœ‰è¿™æ ·çš„ä»£ç ï¼Œæˆ‘ä»¬å»çœ‹çœ‹ï¼š</p>
<p><a href="https://upload-images.jianshu.io/upload_images/4236553-bb4c10b59073c4f7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/647/format/jpeg" title="img" class="fancybox" rel="article0"><img src="https://upload-images.jianshu.io/upload_images/4236553-bb4c10b59073c4f7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/647/format/jpeg" alt="img"></a><span class="caption">img</span></p>
<p>HashMap ä¸­çš„ tableSizeFor æ–¹æ³•</p>
<p>è¿™æ®µä»£ç çš„ä½œç”¨å°±æ˜¯æŒ‰åŸæ¥çš„å®¹é‡æ‰©å®¹2å€ã€‚å¹¶ä¸”ä¿è¯ç»“æœæ˜¯2çš„å¹‚æ¬¡æ–¹ã€‚è¿™é‡Œ Netty çš„åšæ³•å’Œ HashMap ä¸€æ ·ï¼ŒæŒ‰ç…§åŸæ¥çš„å®¹é‡æ‰©å®¹åˆ°æœ€è¿‘çš„ 2 çš„å¹‚æ¬¡æ–¹å¤§å°ï¼Œæ¯”å¦‚åŸæ¥32ï¼Œå°±æ‰©å®¹åˆ°64ï¼Œç„¶åï¼Œå°†åŸæ¥æ•°ç»„çš„å†…å®¹å¡«å……åˆ°æ–°æ•°ç»„ä¸­ï¼Œå‰©ä½™çš„å¡«å……<code>ç©ºå¯¹è±¡</code>ï¼Œç„¶åå°†æ–°æ•°ç»„èµ‹å€¼ç»™æˆå‘˜å˜é‡ indexedVariablesã€‚å®Œæˆäº†ä¸€æ¬¡æ‰©å®¹ã€‚</p>
<p>å›åˆ° setKnownNotUnset æ–¹æ³•ä¸­ï¼ŒsetIndexedVariable æ–¹æ³•ä»€ä¹ˆæƒ…å†µä¸‹ä¼šè¿”å› ture å‘¢ï¼Ÿæ‰©å®¹äº†ï¼Œæˆ–è€…æ²¡æ‰©å®¹ï¼Œä½†æ’å…¥çš„å¯¹è±¡æ²¡æœ‰æ›¿æ¢æ‰åˆ«çš„å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯åŸæ§½ä½æ˜¯ç©ºå¯¹è±¡ã€‚æ¢å¥è¯è¯´ï¼Œåªæœ‰æ›´æ–°äº†å¯¹è±¡æ‰ä¼šè¿”å› falseã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æ–°å¢äº†å¯¹è±¡çš„æ—¶å€™ï¼Œä¼šè°ƒç”¨ addToVariablesToRemove æ–¹æ³•ï¼Œå¦‚åŒæ–¹æ³•åï¼Œæ·»åŠ å˜é‡ç„¶ååˆ é™¤ã€‚æˆ‘ä»¬çœ‹çœ‹ addToVariablesToRemove(threadLocalMap, this) æ–¹æ³•é€»è¾‘ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addToVariablesToRemove</span><span class="params">(InternalThreadLocalMap threadLocalMap, FastThreadLocal&lt;?&gt; variable)</span> </span>{</span><br><span class="line">    <span class="comment">// è¯¥å˜é‡æ˜¯ static final çš„ï¼Œå› æ­¤é€šå¸¸æ˜¯ 0</span></span><br><span class="line">    Object v = threadLocalMap.indexedVariable(variablesToRemoveIndex);</span><br><span class="line">    Set&lt;FastThreadLocal&lt;?&gt;&gt; variablesToRemove;</span><br><span class="line">    <span class="keyword">if</span> (v == InternalThreadLocalMap.UNSET || v == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ªåŸºäº IdentityHashMap çš„ Setï¼Œæ³›å‹æ˜¯ FastThreadLocal</span></span><br><span class="line">        variablesToRemove = Collections.newSetFromMap(<span class="keyword">new</span> IdentityHashMap&lt;FastThreadLocal&lt;?&gt;, Boolean&gt;());</span><br><span class="line">        <span class="comment">// å°†è¿™ä¸ª Set æ”¾åˆ°è¿™ä¸ª Map æ•°ç»„çš„ä¸‹æ ‡ 0 å¤„</span></span><br><span class="line">        threadLocalMap.setIndexedVariable(variablesToRemoveIndex, variablesToRemove);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// å¦‚æœæ‹¿åˆ°çš„ä¸æ˜¯ UNSET ï¼Œè¯´æ˜è¿™æ˜¯ç¬¬äºŒæ¬¡æ“ä½œäº†ï¼Œå› æ­¤å¯ä»¥å¼ºè½¬ä¸º Set</span></span><br><span class="line">        variablesToRemove = (Set&lt;FastThreadLocal&lt;?&gt;&gt;) v;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æœ€åçš„ç›®çš„å°±æ˜¯å°† FastThreadLocal æ”¾ç½®åˆ° Set ä¸­</span></span><br><span class="line">    variablesToRemove.add(variable);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™ä¸ªæ–¹æ³•çš„ç›®çš„æ˜¯å°† FastThreadLocal å¯¹è±¡ä¿å­˜åˆ°ä¸€ä¸ª Set ä¸­ï¼Œå› ä¸º Netty çš„ Map åªæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ²¡æœ‰é”®ï¼Œæ‰€ä»¥ä¿å­˜åˆ°ä¸€ä¸ª Set ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥åˆ¤æ–­æ˜¯å¦ set è¿‡è¿™ä¸ª mapï¼Œä¾‹å¦‚ Netty çš„ isSet æ–¹æ³•å°±æ˜¯æ ¹æ®è¿™ä¸ªåˆ¤æ–­çš„ã€‚</p>
<p>è¯´å®Œäº† setKnownNotUnset æ–¹æ³•ï¼Œæˆ‘ä»¬å†è¯´è¯´ registerCleaner æ–¹æ³•ã€‚</p>
<h4 id="3-registerCleaner-threadLocalMap"><a href="#3-registerCleaner-threadLocalMap" class="headerlink" title="3. registerCleaner(threadLocalMap);"></a>3. registerCleaner(threadLocalMap);</h4><p>è¿™ä¸ªæ–¹æ³•å¯ä»¥è¯´æœ‰ç‚¹å¤æ‚äº†ï¼Œè¯·è€ä½æ€§å­ï¼Œè¿™é‡Œæ˜¯ ftlï¼ˆFastThreadLocalï¼‰ çš„ç²¾é«“ã€‚</p>
<p>é¦–å…ˆè¯´ä¸‹è¯¥æ–¹æ³•çš„ä½œç”¨ï¼šå°†è¿™ä¸ª ftl æ³¨å†Œåˆ°ä¸€ä¸ª <code>æ¸…ç†çº¿ç¨‹</code> ä¸­ï¼Œå½“ thread å¯¹è±¡è¢« gc çš„æ—¶å€™ï¼Œåˆ™ä¼šè‡ªåŠ¨æ¸…ç†æ‰ ftlï¼Œé˜²æ­¢ JDK çš„å†…å­˜æ³„æ¼é—®é¢˜ã€‚</p>
<p>è®©æˆ‘ä»¬è¿›å…¥è¯¥æ–¹æ³•æŸ¥çœ‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerCleaner</span><span class="params">(<span class="keyword">final</span> InternalThreadLocalMap threadLocalMap)</span> </span>{</span><br><span class="line">    Thread current = Thread.currentThread();</span><br><span class="line">    <span class="keyword">if</span> (FastThreadLocalThread.willCleanupFastThreadLocals(current) ||</span><br><span class="line">        threadLocalMap.indexedVariable(cleanerFlagIndex) != InternalThreadLocalMap.UNSET) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    threadLocalMap.setIndexedVariable(cleanerFlagIndex, Boolean.TRUE);</span><br><span class="line">    ObjectCleaner.register(current, <span class="keyword">new</span> Runnable() {</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">            remove(threadLocalMap);</span><br><span class="line">        }</span><br><span class="line">    });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>æ¥¼ä¸»åˆ é™¤äº†æºç ä¸­çš„æ³¨é‡Šï¼Œæˆ‘ä»¬æ¥å¥½å¥½è¯´è¯´è¿™ä¸ªæ–¹æ³•ï¼š</p>
<ol>
<li>è·å–å½“å‰çº¿ç¨‹ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ˜¯ FastThreadLocalThread ç±»å‹ ä¸” cleanupFastThreadLocals æ˜¯ trueï¼Œåˆ™è¿”å› trueï¼Œç›´æ¥returnã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒNetty çº¿ç¨‹æ± é‡Œé¢åˆ›å»ºçš„çº¿ç¨‹éƒ½ç¬¦åˆè¿™æ¡ä»¶ï¼Œåªæœ‰ç”¨æˆ·è‡ªå®šä¹‰çš„çº¿ç¨‹æ± ä¸ç¬¦åˆã€‚<br> å½“ç„¶è¿˜æœ‰ä¸€ä¸ªæ¡ä»¶ï¼šå¦‚æœè¿™ä¸ª ftl çš„ index + 1 åœ¨ map ä¸­çš„å€¼ä¸æ˜¯ç©ºå¯¹è±¡ï¼Œåˆ™å·²ç»æ³¨å†Œè¿‡äº†ï¼Œä¹Ÿç›´æ¥ returnï¼Œä¸å†é‡å¤æ³¨å†Œã€‚</li>
<li>å½“ä¸ç¬¦åˆä¸Šé¢çš„æ¡ä»¶çš„æ—¶å€™ï¼Œå°† Map ä¸­å¯¹åº”çš„ ftl çš„ index  + 1 ä½ç½®çš„å€¼è®¾ç½®ä¸º TRUEã€‚æ ¹æ®ä¸Šé¢çš„åˆ¤æ–­ï¼Œé˜²æ­¢é‡å¤æ³¨å†Œã€‚</li>
<li>è°ƒç”¨ ObjectCleaner çš„ register æ–¹æ³•ï¼Œæ³¨å†Œä¸€ä¸ªä»»åŠ¡ï¼Œä»»åŠ¡çš„å†…å®¹å°±æ˜¯è°ƒç”¨ remove æ–¹æ³•ï¼Œåˆ é™¤ ftl åœ¨ map ä¸­çš„å¯¹è±¡å’Œç›¸åº”çš„å†…å®¹ã€‚</li>
</ol>
<p>é—®é¢˜æ¥äº†ï¼Œæ€ä¹ˆæ³¨å†Œçš„å‘¢ï¼Ÿä¸ºä»€ä¹ˆè¿˜å¸¦ç€ä¸€ä¸ª current å½“å‰çº¿ç¨‹å‘¢ï¼Ÿ</p>
<p>æˆ‘ä»¬çœ‹çœ‹æºç ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Object object, Runnable cleanupTask)</span> </span>{</span><br><span class="line">    AutomaticCleanerReference reference = <span class="keyword">new</span> AutomaticCleanerReference(object,</span><br><span class="line">            ObjectUtil.checkNotNull(cleanupTask, <span class="string">"cleanupTask"</span>));</span><br><span class="line">    LIVE_SET.add(reference);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if there is already a cleaner running.</span></span><br><span class="line">    <span class="keyword">if</span> (CLEANER_RUNNING.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) {</span><br><span class="line">        <span class="keyword">final</span> Thread cleanupThread = <span class="keyword">new</span> FastThreadLocalThread(CLEANER_TASK);</span><br><span class="line">        cleanupThread.setPriority(Thread.MIN_PRIORITY);</span><br><span class="line">        AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() {</span><br><span class="line">            <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">                cleanupThread.setContextClassLoader(<span class="keyword">null</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">        cleanupThread.setName(CLEANER_THREAD_NAME);</span><br><span class="line">        cleanupThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">        cleanupThread.start();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>é¦–å…ˆåˆ›å»ºä¸€ä¸ª AutomaticCleanerReference è‡ªåŠ¨æ¸…æ´å¯¹è±¡ï¼Œç»§æ‰¿äº† WeakReferenceï¼Œå…ˆä¸çœ‹ä»–çš„æ„é€ æ–¹æ³•ï¼Œå…ˆçœ‹ä¸‹é¢ï¼Œå°†è¿™ä¸ªæ„é€ å¥½çš„å®ä¾‹æ”¾å…¥åˆ° LIVE_SET ä¸­ï¼Œå®é™…ä¸Šï¼Œè¿™æ˜¯ä¸€ä¸ª Netty å°è£…çš„ ConcurrentSetï¼Œç„¶ååˆ¤æ–­æ¸…é™¤çº¿ç¨‹æ˜¯å¦åœ¨è¿è¡Œã€‚å¦‚æœæ²¡æœ‰ï¼Œå¹¶ä¸”CASæ”¹çŠ¶æ€æˆåŠŸã€‚å°±åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä»»åŠ¡æ˜¯ å®šä¹‰å¥½çš„ CLEANER_TASKï¼Œçº¿ç¨‹ä¼˜å…ˆçº§æ˜¯æœ€ä½ï¼Œä¸Šä¸‹ä½ç±»åŠ è½½å™¨æ˜¯nullï¼Œåå­—æ˜¯ objectCleanerThreadï¼Œå¹¶ä¸”æ˜¯åå°çº¿ç¨‹ã€‚ç„¶åå¯åŠ¨è¿™ä¸ªçº¿ç¨‹ã€‚è¿è¡Œ CLEANER_TASKã€‚</p>
<p>ä¸€æ­¥ä¸€æ­¥æ¥çœ‹çœ‹ã€‚</p>
<p>é¦–å…ˆ AutomaticCleanerReference  çš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReferenceQueue&lt;Object&gt; REFERENCE_QUEUE = <span class="keyword">new</span> ReferenceQueue&lt;Object&gt;();</span><br><span class="line"></span><br><span class="line">AutomaticCleanerReference(Object referent, Runnable cleanupTask) {</span><br><span class="line">    <span class="keyword">super</span>(referent, REFERENCE_QUEUE);</span><br><span class="line">    <span class="keyword">this</span>.cleanupTask = cleanupTask;</span><br><span class="line">}   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>{</span><br><span class="line">   cleanupTask.run();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ReferenceQueue çš„ä½œç”¨æ˜¯ï¼Œå½“å¯¹è±¡è¢«å›æ”¶çš„æ—¶å€™ï¼Œä¼šå°†è¿™ä¸ªå¯¹è±¡æ·»åŠ è¿›è¿™ä¸ªé˜Ÿåˆ—ï¼Œå°±å¯ä»¥è·Ÿè¸ªè¿™ä¸ªå¯¹è±¡ã€‚è®¾ç½®å¯ä»¥å¤æ´»è¿™ä¸ªå¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“è¿™ä¸ª Thread å¯¹è±¡è¢«å›æ”¶çš„æ—¶å€™ï¼Œä¼šå°†è¿™ä¸ªå¯¹è±¡æ”¾è¿›è¿™ä¸ªå¼•ç”¨é˜Ÿåˆ—ï¼Œæ”¾è¿›å…¥å¹²å˜›å‘¢ï¼Ÿä»€ä¹ˆæ—¶å€™å–å‡ºæ¥å‘¢ï¼Ÿæˆ‘ä»¬çœ‹çœ‹ä»€ä¹ˆæ—¶å€™å–å‡ºæ¥ï¼š</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Runnable CLEANER_TASK = <span class="keyword">new</span> Runnable() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">for</span> (;;) {</span><br><span class="line">            <span class="keyword">while</span> (!LIVE_SET.isEmpty()) {</span><br><span class="line">                <span class="keyword">final</span> AutomaticCleanerReference reference = (AutomaticCleanerReference) REFERENCE_QUEUE.remove(REFERENCE_QUEUE_POLL_TIMEOUT_MS);</span><br><span class="line">               </span><br><span class="line">                <span class="keyword">if</span> (reference != <span class="keyword">null</span>) {</span><br><span class="line">                    <span class="keyword">try</span> {</span><br><span class="line">                        reference.cleanup();</span><br><span class="line">                    } <span class="keyword">catch</span> (Throwable ignored) {</span><br><span class="line">                    }</span><br><span class="line">                    LIVE_SET.remove(reference);</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            CLEANER_RUNNING.set(<span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (LIVE_SET.isEmpty() || !CLEANER_RUNNING.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) {</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>å·§äº† ï¼ï¼ï¼ï¼æ­£æ˜¯ CLEANER_TASK åœ¨ä½¿ç”¨è¿™ä¸ª ReferenceQueueï¼ï¼ï¼ï¼åˆ«æ¿€åŠ¨ï¼Œæˆ‘ä»¬è¿˜æ˜¯æ…¢æ…¢çœ‹çœ‹è¿™ä¸ªä»»åŠ¡åˆ°åº•æ˜¯åšä»€ä¹ˆçš„ï¼š</p>
<ol>
<li>æ­»å¾ªç¯ï¼Œå¦‚æœ ConcurrentSet ä¸æ˜¯ç©ºï¼ˆè¿˜è®°å¾—æˆ‘ä»¬å°† AutomaticCleanerReference æ”¾è¿›è¿™é‡Œå—ï¼‰ï¼Œå°è¯•ä» REFERENCE_QUEUE ä¸­å–å‡º AutomaticCleanerReferenceï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆšåˆšæ”¾è¿›å…¥çš„ã€‚è¿™æ˜¯æ ‡å‡†çš„è·Ÿè¸ª GC å¯¹è±¡çš„åšæ³•ã€‚å› ä¸ºå½“ä¸€ä¸ªå¯¹è±¡è¢« GC æ—¶ï¼Œä¼šå°†ä¿è¯è¿™ä¸ªå¯¹è±¡çš„ Reference æ”¾è¿›æŒ‡å®šçš„å¼•ç”¨é˜Ÿåˆ—ï¼Œè¿™æ˜¯ JVM åšçš„ã€‚</li>
<li>å¦‚æœä¸æ˜¯ç©ºï¼Œå°±è°ƒç”¨åº”ç”¨çš„ cleanUp æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¼ è¿›å»çš„ä»»åŠ¡ï¼Œä»€ä¹ˆä»»åŠ¡ï¼Ÿå°±æ˜¯é‚£ä¸ªè°ƒç”¨ ftl çš„ remove æ–¹æ³•çš„ä»»åŠ¡ã€‚éšåä» Set ä¸­åˆ é™¤è¿™ä¸ªå¼•ç”¨ã€‚</li>
<li>å¦‚æœ Set æ˜¯ç©ºçš„è¯ï¼Œå°†æ¸…ç†çº¿ç¨‹çŠ¶æ€ï¼ˆåŸå­å˜é‡ï¼‰ è®¾ç½®æˆ fasleã€‚</li>
<li>ç»§ç»­åˆ¤æ–­ï¼Œå¦‚æœSet è¿˜æ˜¯ç©ºï¼Œæˆ–è€… Set ä¸æ˜¯ç©º ä¸” è®¾ç½® CAS è®¾ç½®çŠ¶æ€ä¸ºtrue å¤±è´¥ï¼ˆè¯´æ˜å…¶ä»–çº¿ç¨‹æ”¹äº†è¿™ä¸ªçŠ¶æ€ï¼‰åˆ™è·³å‡ºå¾ªç¯ï¼Œç»“æŸçº¿ç¨‹ã€‚</li>
</ol>
<p>æœ‰ç‚¹æ‡µï¼Ÿé‚£æˆ‘ä»¬å°±å¥½å¥½æ€»ç»“è¿™é‡Œä¸ºä»€ä¹ˆè¿™ä¹ˆåšï¼š</p>
<blockquote>
<p>å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªé Netty çº¿ç¨‹æ± åˆ›å»ºçš„çº¿ç¨‹ä¸­ä½¿ç”¨ ftl çš„æ—¶å€™ï¼ŒNetty ä¼šæ³¨å†Œä¸€ä¸ªåƒåœ¾æ¸…ç†çº¿ç¨‹ï¼ˆå› ä¸º Netty çº¿ç¨‹æ± åˆ›å»ºçš„çº¿ç¨‹æœ€ç»ˆéƒ½ä¼šæ‰§è¡Œ removeAll æ–¹æ³•ï¼Œä¸ä¼šå‡ºç°å†…å­˜æ³„æ¼ï¼‰ ï¼Œç”¨äºæ¸…ç†è¿™ä¸ªçº¿ç¨‹è¿™ä¸ª ftl å˜é‡ï¼Œä»ä¸Šé¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œé Netty çº¿ç¨‹å¦‚æœä½¿ç”¨ ftlï¼ŒNetty ä»ç„¶ä¼šå€ŸåŠ© JDK çš„ ThreadLocalï¼Œåªæ˜¯åªå€Ÿç”¨ä¸€ä¸ªæ§½ä½ï¼Œæ”¾ç½® Netty çš„ Mapï¼Œ Map ä¸­å†æ”¾ç½® Netty çš„ ftl ã€‚æ‰€ä»¥ï¼Œåœ¨ä½¿ç”¨çº¿ç¨‹æ± çš„æƒ…å†µä¸‹å¯èƒ½ä¼šå‡ºç°å†…å­˜æ³„æ¼ã€‚<strong>Netty ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨æ¯æ¬¡ä½¿ç”¨æ–°çš„ ftl çš„æ—¶å€™ï¼Œéƒ½å°†è¿™ä¸ª ftl æ³¨å†Œåˆ°å’Œçº¿ç¨‹å¯¹è±¡ç»‘å®šåˆ°ä¸€ä¸ª GC å¼•ç”¨ä¸Šï¼Œ å½“è¿™ä¸ªçº¿ç¨‹å¯¹è±¡è¢«å›æ”¶çš„æ—¶å€™ï¼Œä¹Ÿä¼šé¡ºä¾¿æ¸…ç†æ‰ä»–çš„ Map ä¸­çš„ æ‰€æœ‰ ftlï¼Œè§£å†³äº†è¯¥é—®é¢˜ï¼Œå°±åƒè§£å†³ JDK Nio bug ä¸€æ ·ã€‚</strong></p>
</blockquote>
<p>å¥½ï¼Œåˆ°è¿™é‡Œï¼ŒNetty çš„ FastThreadLocal çš„ç²¾åæˆ‘ä»¬åŸºæœ¬å°±å…¨éƒ¨å¸å–äº†ã€‚ftl ä¸ä»…å¿«ï¼Œè€Œä¸”å®‰å…¨ã€‚å¿«åœ¨ä½¿ç”¨æ•°ç»„ä»£æ›¿çº¿æ€§æ¢æµ‹æ³•çš„ Mapï¼Œå®‰å…¨åœ¨æ¯æ¬¡çº¿ç¨‹å›æ”¶çš„æ—¶å€™éƒ½æ¸…ç† ftlï¼Œä¸ç”¨æ‹…å¿ƒå†…å­˜æ³„æ¼ã€‚</p>
<p>å‰©ä¸‹çš„æ–¹æ³•éƒ½æ˜¯å¾ˆç®€å•çš„ã€‚æˆ‘ä»¬ä¸€èµ·çœ‹å®Œå§</p>
<h4 id="4-remove"><a href="#4-remove" class="headerlink" title="4. remove();"></a>4. remove();</h4><p>æ¯æ¬¡ Set ä¸€ä¸ªç©ºå¯¹è±¡çš„æ—¶å€™ï¼Œå°±æ˜¯è°ƒç”¨remove æ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹çœ‹è¯¥æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">()</span> </span>{</span><br><span class="line">     remove(InternalThreadLocalMap.getIfSet());</span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InternalThreadLocalMap <span class="title">getIfSet</span><span class="params">()</span> </span>{</span><br><span class="line">     Thread thread = Thread.currentThread();</span><br><span class="line">     <span class="keyword">if</span> (thread <span class="keyword">instanceof</span> FastThreadLocalThread) {</span><br><span class="line">         <span class="keyword">return</span> ((FastThreadLocalThread) thread).threadLocalMap();</span><br><span class="line">     }</span><br><span class="line">     <span class="keyword">return</span> slowThreadLocalMap.get();</span><br><span class="line"></span><br><span class="line"> }</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(InternalThreadLocalMap threadLocalMap)</span> </span>{</span><br><span class="line">     <span class="keyword">if</span> (threadLocalMap == <span class="keyword">null</span>) {</span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">     }</span><br><span class="line">     <span class="comment">// åˆ é™¤å¹¶è¿”å› Map æ•°ç»„ä¸­å½“å‰ ThreadLocal index å¯¹åº”çš„ value</span></span><br><span class="line">     Object v = threadLocalMap.removeIndexedVariable(index);</span><br><span class="line">     <span class="comment">// ä» Map æ•°ç»„ä¸‹æ ‡ 0 çš„ä½ç½®å–å‡º Set ï¼Œå¹¶åˆ é™¤å½“å‰çš„ ThreadLocal</span></span><br><span class="line">     removeFromVariablesToRemove(threadLocalMap, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (v != InternalThreadLocalMap.UNSET) {</span><br><span class="line">         <span class="keyword">try</span> {</span><br><span class="line">             <span class="comment">// é»˜è®¤å•¥ä¹Ÿä¸åšï¼Œç”¨æˆ·å¯ä»¥ç»§æ‰¿ FastThreadLocal é‡å®šä¹‰è¿™ä¸ªæ–¹æ³•ã€‚</span></span><br><span class="line">             onRemoval((V) v);</span><br><span class="line">         } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">             PlatformDependent.throwException(e);</span><br><span class="line">         }</span><br><span class="line">     }</span><br><span class="line"> }</span><br></pre></td></tr></tbody></table></figure>
<p>æ¥¼ä¸»å°†è¿™3ä¸ªæ–¹æ³•éƒ½åˆå¹¶åœ¨ä¸€èµ·äº†ï¼Œé¦–å…ˆè·å–å½“å‰çº¿ç¨‹çš„ threadLocalMapï¼Œç„¶åå°±åƒæ³¨é‡Šä¸­å†™çš„ï¼šåˆ é™¤ ftl å¯¹åº”ä¸‹æ ‡ä¸­ map çš„ valueï¼Œç„¶ååˆ é™¤ map ä¸‹æ ‡0 å¤„ Set ä¸­çš„ ftlã€‚é˜²æ­¢ isSet æ–¹æ³•è¯¯åˆ¤ã€‚æœ€åï¼Œå¦‚æœç”¨æˆ·é‡å†™äº† onRemoval æ–¹æ³•ï¼Œå°±è°ƒç”¨ï¼Œé»˜è®¤æ˜¯ä¸ªç©ºæ–¹æ³•ã€‚ç”¨æˆ·å¯ä»¥é‡å†™ onRemoval æ–¹æ³•å’Œ initialize æ–¹æ³•ã€‚</p>
<h2 id="4-get-æ–¹æ³•è§£æ"><a href="#4-get-æ–¹æ³•è§£æ" class="headerlink" title="4. get æ–¹æ³•è§£æ"></a>4. get æ–¹æ³•è§£æ</h2><p>get æ–¹æ³•å°±æ›´ç®€å•äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> V <span class="title">get</span><span class="params">()</span> </span>{</span><br><span class="line">    InternalThreadLocalMap threadLocalMap = InternalThreadLocalMap.get();</span><br><span class="line">    Object v = threadLocalMap.indexedVariable(index);</span><br><span class="line">    <span class="keyword">if</span> (v != InternalThreadLocalMap.UNSET) {</span><br><span class="line">        <span class="keyword">return</span> (V) v;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    V value = initialize(threadLocalMap);</span><br><span class="line">    registerCleaner(threadLocalMap);</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>é¦–å…ˆè·å–å½“å‰çº¿ç¨‹çš„mapï¼Œç„¶åæ ¹æ® ftl çš„ index è·å– valueï¼Œç„¶åè¿”å›ï¼Œå¦‚æœæ˜¯ç©ºå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰è®¾ç½®ï¼Œåˆ™é€šè¿‡ initialize è¿”å›ï¼Œinitialize æ–¹æ³•ä¼šå°†è¿”å›å€¼è®¾ç½®åˆ° map çš„æ§½ä½ä¸­ï¼Œå¹¶æ”¾è¿› Set ä¸­ã€‚æœ€åï¼Œå°è¯•æ³¨å†Œä¸€ä¸ªæ¸…æ´å™¨ã€‚</p>
<h2 id="5-remove-Allæ–¹æ³•è§£æ"><a href="#5-remove-Allæ–¹æ³•è§£æ" class="headerlink" title="5. remove Allæ–¹æ³•è§£æ"></a>5. remove Allæ–¹æ³•è§£æ</h2><p>è¿™ä¸ªæ–¹æ³•åœ¨ Netty çš„é»˜è®¤çº¿ç¨‹çš„ finally å—ä¸­è°ƒç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeAll</span><span class="params">()</span> </span>{</span><br><span class="line">    InternalThreadLocalMap threadLocalMap = InternalThreadLocalMap.getIfSet();</span><br><span class="line">    <span class="keyword">if</span> (threadLocalMap == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        Object v = threadLocalMap.indexedVariable(variablesToRemoveIndex);</span><br><span class="line">        <span class="keyword">if</span> (v != <span class="keyword">null</span> &amp;&amp; v != InternalThreadLocalMap.UNSET) {</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">            Set&lt;FastThreadLocal&lt;?&gt;&gt; variablesToRemove = (Set&lt;FastThreadLocal&lt;?&gt;&gt;) v;</span><br><span class="line">            FastThreadLocal&lt;?&gt;[] variablesToRemoveArray =</span><br><span class="line">                    variablesToRemove.toArray(<span class="keyword">new</span> FastThreadLocal[variablesToRemove.size()]);</span><br><span class="line">            <span class="keyword">for</span> (FastThreadLocal&lt;?&gt; tlv: variablesToRemoveArray) {</span><br><span class="line">                tlv.remove(threadLocalMap);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        InternalThreadLocalMap.remove();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>éå¸¸ç®€å•ï¼Œé¦–å…ˆè·å–å½“å‰çº¿ç¨‹mapï¼Œç„¶åè·å– Setï¼Œå°† Set è½¬æˆæ•°ç»„ï¼Œéå†æ•°ç»„ï¼Œè°ƒç”¨ ftl çš„ remove æ–¹æ³•ã€‚æœ€åï¼Œåˆ é™¤çº¿ç¨‹ä¸­ çš„ map å±æ€§ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ç°åœ¨æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹ FastThreadLocal ã€‚</p>
<p>ä¹‹æ‰€ä»¥ç§°ä¹‹ä¸º Fastï¼Œå› ä¸ºæ²¡æœ‰ä½¿ç”¨ JDK çš„ä½¿ç”¨çº¿æ€§æ¢æµ‹æ³•çš„ Mapï¼Œå¦‚æœä½ ä½¿ç”¨çš„æ˜¯Netty çº¿ç¨‹æ± å·¥å‚åˆ›å»ºçš„çº¿ç¨‹ï¼Œæ­é… Netty çš„ ftlï¼Œæ€§èƒ½éå¸¸å¥½ï¼Œå¦‚æœä½ ä½¿ç”¨è‡ªå®šä¹‰çš„çº¿ç¨‹ï¼Œæ­é… ftlï¼Œæ€§èƒ½ä¹Ÿä¼šæ¯” JDK çš„å¥½ï¼Œæ³¨æ„ï¼š ftl æ²¡æœ‰ JDK çš„å†…å­˜æ³„éœ²çš„é£é™©ã€‚</p>
<p>ä½†åšåˆ°è¿™äº›ä¸æ˜¯æ²¡æœ‰ä»£ä»·çš„ï¼Œç”±äºæ¯ä¸€ä¸ª ftl éƒ½æ˜¯ä¸€ä¸ªå”¯ä¸€çš„ä¸‹æ ‡ï¼Œè€Œè¿™ä¸ªä¸‹æ ‡æ˜¯æ¯æ¬¡åˆ›å»ºä¸€ä¸ª ftl å¯¹è±¡éƒ½æ˜¯é€’å¢ 2ï¼Œå½“ä½ çš„ä¸‹æ ‡å¾ˆå¤§ï¼Œä½ çš„çº¿ç¨‹ä¸­çš„ Map ç›¸åº”çš„ä¹Ÿè¦å¢å¤§ï¼Œå¯ä»¥æƒ³è±¡ï¼Œå¦‚æœåˆ›å»ºäº†æµ·é‡çš„ ftl å¯¹è±¡ï¼Œè¿™ä¸ªæ•°ç»„çš„æµªè´¹æ˜¯éå¸¸å®¢è§‚çš„ã€‚å¾ˆæ˜æ˜¾ï¼Œè¿™æ˜¯ä¸€ç§ç©ºé—´æ¢æ—¶é—´çš„åšæ³•ã€‚</p>
<p>é€šå¸¸ï¼Œftl éƒ½æ˜¯é™æ€å¯¹è±¡ï¼Œæ‰€ä»¥ä¸ä¼šæœ‰æˆ‘ä»¬å‡è®¾çš„é‚£ä¹ˆå¤šã€‚å¦‚æœä½¿ç”¨ä¸å½“ï¼Œç¡®å®ä¼šæµªè´¹å¤§é‡å†…å­˜ã€‚</p>
<p>ä½†è¿™ä¸ªé£é™©å¸¦æ¥çš„å¥½å¤„æ˜¯æ˜æ˜¾çš„ï¼Œåœ¨æ¥¼ä¸»çš„æœºå™¨ä¸Šæµ‹è¯•ï¼Œftl çš„è¯»å–æ€§èƒ½æ˜¯ JDK çš„ 5 å€å·¦å³ï¼Œå†™å…¥çš„é€Ÿåº¦ä¹Ÿè¦å¿« 20% å·¦å³ã€‚</p>
<p>FastThreadLocal äººå¦‚å…¶åï¼Œå¿«ä¸”å®‰å…¨ï¼</p>
<p>ä»Šå¤©å°±åˆ°è¿™é‡Œï¼Œgood luckï¼ï¼ï¼ï¼</p>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/Util-2-FastThreadLocal/" data-id="ck4pl3fpc00emfgcfxzh4hqly" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>