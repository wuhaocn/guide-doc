<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
精尽 Netty 源码解析 —— Codec 之 MessageToMessageCodec
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>本文，我们来分享 MessageToMessageCodec 部分的内容。</p>
<p>MessageToMessageCodec 负责消息和消息<strong>之间</strong>的编解码，主要由两部分构造：</p>
<ul>
<li>MessageToMessageEncoder ，将消息<strong>编码</strong>成另一种消息。</li>
<li>MessageToMessageDecoder ，将消息<strong>解码</strong>成另一种消息。</li>
</ul>
<p>所以，我们先来看 MessageToMessageDecoder 的代码实现，再看 MessageToMessageEncoder 的代码实现，最后看 MessageToMessageCodec 的代码实现。</p>
<blockquote>
<p>老艿艿：因为笔者平时比较少用这三个类，所以本文会分享的比较简单噢。</p>
</blockquote>
<h1 id="2-MessageToMessageEncoder"><a href="#2-MessageToMessageEncoder" class="headerlink" title="2. MessageToMessageEncoder"></a>2. MessageToMessageEncoder</h1><p><code>io.netty.handler.codec.MessageToMessageEncoder</code> ，继承 ChannelOutboundHandlerAdapter 抽象类，将消息<strong>编码</strong>成另一种消息。</p>
<h2 id="2-1-构造方法"><a href="#2-1-构造方法" class="headerlink" title="2.1 构造方法"></a>2.1 构造方法</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 类型匹配器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> TypeParameterMatcher matcher;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">MessageToMessageEncoder</span><span class="params">()</span> </span>{</span><br><span class="line">    matcher = TypeParameterMatcher.find(<span class="keyword">this</span>, MessageToMessageEncoder.class, <span class="string">"I"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">MessageToMessageEncoder</span><span class="params">(Class&lt;? extends I&gt; outboundMessageType)</span> </span>{</span><br><span class="line">    matcher = TypeParameterMatcher.get(outboundMessageType);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-2-acceptOutboundMessage"><a href="#2-2-acceptOutboundMessage" class="headerlink" title="2.2 acceptOutboundMessage"></a>2.2 acceptOutboundMessage</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns {<span class="doctag">@code</span> true} if the given message should be handled. If {<span class="doctag">@code</span> false} it will be passed to the next</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> ChannelOutboundHandler} in the {<span class="doctag">@link</span> ChannelPipeline}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acceptOutboundMessage</span><span class="params">(Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">return</span> matcher.match(msg);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-3-write"><a href="#2-3-write" class="headerlink" title="2.3 write"></a>2.3 write</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    CodecOutputList out = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 判断是否为匹配的消息</span></span><br><span class="line">        <span class="keyword">if</span> (acceptOutboundMessage(msg)) {</span><br><span class="line">            <span class="comment">// 创建 CodecOutputList 对象</span></span><br><span class="line">            out = CodecOutputList.newInstance();</span><br><span class="line">            <span class="comment">// 转化消息类型</span></span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">            I cast = (I) msg;</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 将消息编码成另外一个消息</span></span><br><span class="line">                encode(ctx, cast, out);</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                <span class="comment">// 释放 cast 原消息</span></span><br><span class="line">                ReferenceCountUtil.release(cast);</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果未编码出消息，抛出异常</span></span><br><span class="line">            <span class="keyword">if</span> (out.isEmpty()) {</span><br><span class="line">                <span class="comment">// 回收 CodecOutputList 对象</span></span><br><span class="line">                out.recycle();</span><br><span class="line">                out = <span class="keyword">null</span>;</span><br><span class="line">                <span class="comment">// 抛出异常</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> EncoderException(StringUtil.simpleClassName(<span class="keyword">this</span>) + <span class="string">" must produce at least one message."</span>);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 直接下一个节点</span></span><br><span class="line">            ctx.write(msg, promise);</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (EncoderException e) {</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> EncoderException(t);</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        <span class="keyword">if</span> (out != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> sizeMinusOne = out.size() - <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// 只编码出一条消息</span></span><br><span class="line">            <span class="keyword">if</span> (sizeMinusOne == <span class="number">0</span>) {</span><br><span class="line">                <span class="comment">// 直接写入新消息到下一个节点</span></span><br><span class="line">                ctx.write(out.get(<span class="number">0</span>), promise);</span><br><span class="line">            <span class="comment">// 编码出多条消息</span></span><br><span class="line">            } <span class="keyword">else</span> <span class="keyword">if</span> (sizeMinusOne &gt; <span class="number">0</span>) {</span><br><span class="line">                <span class="comment">// 第 [0, n-1) 条消息，写入下一个节点，使用 voidPromise ，即不需要回调</span></span><br><span class="line">                <span class="comment">// Check if we can use a voidPromise for our extra writes to reduce GC-Pressure</span></span><br><span class="line">                <span class="comment">// See https://github.com/netty/netty/issues/2525</span></span><br><span class="line">                ChannelPromise voidPromise = ctx.voidPromise();</span><br><span class="line">                <span class="keyword">boolean</span> isVoidPromise = promise == voidPromise;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sizeMinusOne; i ++) {</span><br><span class="line">                    ChannelPromise p;</span><br><span class="line">                    <span class="keyword">if</span> (isVoidPromise) {</span><br><span class="line">                        p = voidPromise;</span><br><span class="line">                    } <span class="keyword">else</span> {</span><br><span class="line">                        p = ctx.newPromise();</span><br><span class="line">                    }</span><br><span class="line">                    ctx.write(out.getUnsafe(i), p);</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">// 第 n-1 条消息，写入下一个节点，使用 promise ，即需要回调</span></span><br><span class="line">                ctx.write(out.getUnsafe(sizeMinusOne), promise);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 回收 CodecOutputList 对象</span></span><br><span class="line">            out.recycle();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>代码比较简单，胖友自己看注释。</li>
</ul>
<h2 id="2-4-encode"><a href="#2-4-encode" class="headerlink" title="2.4 encode"></a>2.4 encode</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Encode from one message to an other. This method will be called for each written message that can be handled</span></span><br><span class="line"><span class="comment"> * by this encoder.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ctx           the {<span class="doctag">@link</span> ChannelHandlerContext} which this {<span class="doctag">@link</span> MessageToMessageEncoder} belongs to</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> msg           the message to encode to an other one</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> out           the {<span class="doctag">@link</span> List} into which the encoded msg should be added</span></span><br><span class="line"><span class="comment"> *                      needs to do some kind of aggregation</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception    is thrown if an error occurs</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, I msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-5-子类"><a href="#2-5-子类" class="headerlink" title="2.5 子类"></a>2.5 子类</h2><p>MessageToMessageEncoder 子类比较多，感兴趣的胖友，可以看看负责实现 FrameEncoder 的两个类：</p>
<ul>
<li><code>io.netty.handler.codec.string.LineEncoder</code> ，基于<strong>指定行分隔符</strong>的 FrameEncoder 实现类。<ul>
<li>代码比较简单，胖友可以直接撸。 </li>
</ul>
</li>
<li><code>io.netty.handler.codec.LengthFieldPrepender</code> ，基于基于<strong>消息头指定消息长度</strong>的 FrameEncoder 实现类。<ul>
<li>相对复杂一些，胖友可以结合 <a href="https://liuzhengyang.github.io/2018/08/03/netty-7-messagetobyteencoder/" rel="external nofollow noopener noreferrer" target="_blank">《Netty源码分析-7-MessageToByteEncoder》</a> 一起撸。</li>
</ul>
</li>
</ul>
<h1 id="3-MessageToMessageDecoder"><a href="#3-MessageToMessageDecoder" class="headerlink" title="3. MessageToMessageDecoder"></a>3. MessageToMessageDecoder</h1><p><code>io.netty.handler.codec.MessageToMessageDecoder</code> ，继承 ChannelInboundHandlerAdapter 类，将消息<strong>解码</strong>成另一种消息。</p>
<h2 id="3-1-构造方法"><a href="#3-1-构造方法" class="headerlink" title="3.1 构造方法"></a>3.1 构造方法</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 类型匹配器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> TypeParameterMatcher matcher;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">MessageToMessageDecoder</span><span class="params">()</span> </span>{</span><br><span class="line">    matcher = TypeParameterMatcher.find(<span class="keyword">this</span>, MessageToMessageDecoder.class, <span class="string">"I"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">MessageToMessageDecoder</span><span class="params">(Class&lt;? extends I&gt; inboundMessageType)</span> </span>{</span><br><span class="line">    matcher = TypeParameterMatcher.get(inboundMessageType);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-2-acceptInboundMessage"><a href="#3-2-acceptInboundMessage" class="headerlink" title="3.2 acceptInboundMessage"></a>3.2 acceptInboundMessage</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acceptInboundMessage</span><span class="params">(Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">return</span> matcher.match(msg);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-3-channelRead"><a href="#3-3-channelRead" class="headerlink" title="3.3 channelRead"></a>3.3 channelRead</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">// 创建 CodecOutputList 对象</span></span><br><span class="line">    CodecOutputList out = CodecOutputList.newInstance();</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// 判断是否为匹配的消息</span></span><br><span class="line">        <span class="keyword">if</span> (acceptInboundMessage(msg)) {</span><br><span class="line">            <span class="comment">// 转化消息类型</span></span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">            I cast = (I) msg;</span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// 将消息解码成另外一个消息</span></span><br><span class="line">                decode(ctx, cast, out);</span><br><span class="line">            } <span class="keyword">finally</span> {</span><br><span class="line">                <span class="comment">// 释放 cast 原消息</span></span><br><span class="line">                ReferenceCountUtil.release(cast);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 不匹配，添加到 out</span></span><br><span class="line">            out.add(msg);</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (DecoderException e) {</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> DecoderException(e);</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        <span class="comment">// 遍历 out ，触发 Channel Read 事件到 pipeline 中</span></span><br><span class="line">        <span class="keyword">int</span> size = out.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i ++) {</span><br><span class="line">            ctx.fireChannelRead(out.getUnsafe(i));</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 回收 CodecOutputList 对象</span></span><br><span class="line">        out.recycle();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-4-decode"><a href="#3-4-decode" class="headerlink" title="3.4 decode"></a>3.4 decode</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Decode from one message to an other. This method will be called for each written message that can be handled</span></span><br><span class="line"><span class="comment"> * by this encoder.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ctx           the {<span class="doctag">@link</span> ChannelHandlerContext} which this {<span class="doctag">@link</span> MessageToMessageDecoder} belongs to</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> msg           the message to decode to an other one</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> out           the {<span class="doctag">@link</span> List} to which decoded messages should be added</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception    is thrown if an error occurs</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, I msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="4-MessageToMessageCodec"><a href="#4-MessageToMessageCodec" class="headerlink" title="4. MessageToMessageCodec"></a>4. MessageToMessageCodec</h1><p><code>io.netty.handler.codec.MessageToMessageCodec</code> ，继承 ChannelDuplexHandler 类，通过<strong>组合</strong> MessageToMessageEncoder 和 MessageToMessageDecoder 的功能，从而实现编解码的 Codec <strong>抽象类</strong>。</p>
<blockquote>
<p>老艿艿：从实现的方式上，和 ByteToMessageCodec 非常相似。</p>
</blockquote>
<h2 id="4-1-构造方法"><a href="#4-1-构造方法" class="headerlink" title="4.1 构造方法"></a>4.1 构造方法</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageToMessageCodec</span>&lt;<span class="title">INBOUND_IN</span>, <span class="title">OUTBOUND_IN</span>&gt; <span class="keyword">extends</span> <span class="title">ChannelDuplexHandler</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Encoder 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageToMessageEncoder&lt;Object&gt; encoder = <span class="keyword">new</span> MessageToMessageEncoder&lt;Object&gt;() {</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acceptOutboundMessage</span><span class="params">(Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            <span class="keyword">return</span> MessageToMessageCodec.<span class="keyword">this</span>.acceptOutboundMessage(msg);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, Object msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            MessageToMessageCodec.<span class="keyword">this</span>.encode(ctx, (OUTBOUND_IN) msg, out);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Decoder 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageToMessageDecoder&lt;Object&gt; decoder = <span class="keyword">new</span> MessageToMessageDecoder&lt;Object&gt;() {</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acceptInboundMessage</span><span class="params">(Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            <span class="keyword">return</span> MessageToMessageCodec.<span class="keyword">this</span>.acceptInboundMessage(msg);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, Object msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            MessageToMessageCodec.<span class="keyword">this</span>.decode(ctx, (INBOUND_IN) msg, out);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Decoder 的类型匹配器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TypeParameterMatcher inboundMsgMatcher;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Encoder 的类型匹配器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TypeParameterMatcher outboundMsgMatcher;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">MessageToMessageCodec</span><span class="params">()</span> </span>{</span><br><span class="line">        inboundMsgMatcher = TypeParameterMatcher.find(<span class="keyword">this</span>, MessageToMessageCodec.class, <span class="string">"INBOUND_IN"</span>);</span><br><span class="line">        outboundMsgMatcher = TypeParameterMatcher.find(<span class="keyword">this</span>, MessageToMessageCodec.class, <span class="string">"OUTBOUND_IN"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">MessageToMessageCodec</span><span class="params">(Class&lt;? extends INBOUND_IN&gt; inboundMessageType, Class&lt;? extends OUTBOUND_IN&gt; outboundMessageType)</span> </span>{</span><br><span class="line">        inboundMsgMatcher = TypeParameterMatcher.get(inboundMessageType);</span><br><span class="line">        outboundMsgMatcher = TypeParameterMatcher.get(outboundMessageType);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...  省略非构造方法相关</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="4-2-MessageToMessageEncoder-相关方法"><a href="#4-2-MessageToMessageEncoder-相关方法" class="headerlink" title="4.2 MessageToMessageEncoder 相关方法"></a>4.2 MessageToMessageEncoder 相关方法</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    encoder.write(ctx, msg, promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns {<span class="doctag">@code</span> true} if and only if the specified message can be decoded by this codec.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> msg the message</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acceptInboundMessage</span><span class="params">(Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">return</span> inboundMsgMatcher.match(msg);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> MessageToMessageEncoder#encode(ChannelHandlerContext, Object, List)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, OUTBOUND_IN msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="4-3-MessageToMessageDecoder-相关方法"><a href="#4-3-MessageToMessageDecoder-相关方法" class="headerlink" title="4.3 MessageToMessageDecoder 相关方法"></a>4.3 MessageToMessageDecoder 相关方法</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    decoder.channelRead(ctx, msg);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns {<span class="doctag">@code</span> true} if and only if the specified message can be encoded by this codec.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> msg the message</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acceptOutboundMessage</span><span class="params">(Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">return</span> outboundMsgMatcher.match(msg);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> MessageToMessageDecoder#decode(ChannelHandlerContext, Object, List)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, INBOUND_IN msg, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="666-彩蛋"><a href="#666-彩蛋" class="headerlink" title="666. 彩蛋"></a>666. 彩蛋</h1><p>还是一篇小水文。嘿嘿。</p>
<p>推荐阅读文章：</p>
<ul>
<li>wade&amp;luffy <a href="https://www.cnblogs.com/wade-luffy/p/6222960.html" rel="external nofollow noopener noreferrer" target="_blank">《ChannelHandler》</a></li>
<li>堆码时刻 <a href="https://blog.csdn.net/abc_key/article/details/38061079" rel="external nofollow noopener noreferrer" target="_blank">《Netty In Action中文版 - 第八章：附带的ChannelHandler和Codec》</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/Codec-4-1-MessageToMessageCodec/" data-id="ck4pl3fpb00eifgcfgfseryy5" class="article-share-link">分享</a>



</footer>
-->
</div>