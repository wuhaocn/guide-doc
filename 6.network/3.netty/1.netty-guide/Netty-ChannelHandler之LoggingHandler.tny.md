<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
精尽 Netty 源码解析 —— ChannelHandler（四）之 LoggingHandler
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>在 <code>netty-handler</code> 模块中，提供了多种 ChannelHandler 的实现类。如下图所示：<a href="http://static2.iocoder.cn/images/Netty/2018_10_10/01.png" title="`netty-handler`" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_10_10/01.png" alt="`netty-handler`"></a><span class="caption">`netty-handler`</span></p>
<ul>
<li>每个 <code>package</code> 包，对应一个<strong>功能特性</strong>的 ChannelHandler 实现。</li>
</ul>
<p>本文，我们来分享 <code>logger</code> 包下 <code>logging</code> 包的 LoggerHandler 。</p>
<h1 id="2-LogLevel"><a href="#2-LogLevel" class="headerlink" title="2. LogLevel"></a>2. LogLevel</h1><p><code>io.netty.handler.logging.LogLevel</code> ，日志级别枚举类。代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Maps the regular {<span class="doctag">@link</span> LogLevel}s with the {<span class="doctag">@link</span> InternalLogLevel} ones.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> LogLevel {</span><br><span class="line"></span><br><span class="line">    TRACE(InternalLogLevel.TRACE),</span><br><span class="line">    DEBUG(InternalLogLevel.DEBUG),</span><br><span class="line">    INFO(InternalLogLevel.INFO),</span><br><span class="line">    WARN(InternalLogLevel.WARN),</span><br><span class="line">    ERROR(InternalLogLevel.ERROR);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Netty 内部日志级别</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InternalLogLevel internalLevel;</span><br><span class="line"></span><br><span class="line">    LogLevel(InternalLogLevel internalLevel) {</span><br><span class="line">        <span class="keyword">this</span>.internalLevel = internalLevel;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * For internal use only.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p/&gt;Converts the specified {<span class="doctag">@link</span> LogLevel} to its {<span class="doctag">@link</span> InternalLogLevel} variant.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the converted level.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InternalLogLevel <span class="title">toInternalLevel</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> internalLevel;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Netty 提供了一套日志框架，方便接入 slf4j、log4j、jdk logger 等等日志框架。感兴趣的胖友，可以看看 <a href="https://segmentfault.com/a/1190000005797595" rel="external nofollow noopener noreferrer" target="_blank">《Netty4.x Internal Logger机制》</a> 。😈 现在，不看也不影响对本文的理解。</li>
<li>LogLevel 实现对 <code>io.netty.util.internal.logging.InternalLogLevel</code> 的<strong>一一</strong>映射。笔者暂时看不出有什么神奇的用途，难道是为了可以灵活的修改映射关系？！有了解的胖友，可以深刻教育下我噢。</li>
</ul>
<h1 id="3-LoggingHandler"><a href="#3-LoggingHandler" class="headerlink" title="3. LoggingHandler"></a>3. LoggingHandler</h1><p><code>io.netty.handler.logging.LoggingHandler</code> ，继承 ChannelDuplexHandler 类，日志处理器，对 Inbound/Outbound 事件进行日志的记录。一般情况下，用于开发测试时的调试之用。</p>
<h2 id="3-1-构造方法"><a href="#3-1-构造方法" class="headerlink" title="3.1 构造方法"></a>3.1 构造方法</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Sharable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggingHandler</span> <span class="keyword">extends</span> <span class="title">ChannelDuplexHandler</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 默认 {<span class="doctag">@link</span> #level} 日志级别</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LogLevel DEFAULT_LEVEL = LogLevel.DEBUG;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Netty 内部 Logger 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> InternalLogger logger;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Netty 内部 LogLevel 级别</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> InternalLogLevel internalLevel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置的 LogLevel 级别</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LogLevel level;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new instance whose logger name is the fully qualified class</span></span><br><span class="line"><span class="comment">     * name of the instance with hex dump enabled.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoggingHandler</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(DEFAULT_LEVEL);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new instance whose logger name is the fully qualified class</span></span><br><span class="line"><span class="comment">     * name of the instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> level the log level</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoggingHandler</span><span class="params">(LogLevel level)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (level == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"level"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得 logger</span></span><br><span class="line">        logger = InternalLoggerFactory.getInstance(getClass());</span><br><span class="line">        <span class="keyword">this</span>.level = level;</span><br><span class="line">        internalLevel = level.toInternalLevel();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new instance with the specified logger name and with hex dump</span></span><br><span class="line"><span class="comment">     * enabled.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz the class type to generate the logger for</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoggingHandler</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(clazz, DEFAULT_LEVEL);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new instance with the specified logger name.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz the class type to generate the logger for</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> level the log level</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoggingHandler</span><span class="params">(Class&lt;?&gt; clazz, LogLevel level)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"clazz"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (level == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"level"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得 logger</span></span><br><span class="line">        logger = InternalLoggerFactory.getInstance(clazz);</span><br><span class="line">        <span class="keyword">this</span>.level = level;</span><br><span class="line">        internalLevel = level.toInternalLevel();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new instance with the specified logger name using the default log level.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name the name of the class to use for the logger</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoggingHandler</span><span class="params">(String name)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(name, DEFAULT_LEVEL);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new instance with the specified logger name.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name the name of the class to use for the logger</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> level the log level</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoggingHandler</span><span class="params">(String name, LogLevel level)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"name"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (level == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"level"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得 logger</span></span><br><span class="line">        logger = InternalLoggerFactory.getInstance(name);</span><br><span class="line">        <span class="keyword">this</span>.level = level;</span><br><span class="line">        internalLevel = level.toInternalLevel();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略其他方法</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>通过 <code>@Sharable</code> 注解，支持共享。</li>
<li><code>level</code> 属性，配置的 LogLevel 级别。<ul>
<li><code>DEFAULT_LEVEL</code> <strong>静态</strong>属性，默认的 <code>level</code> 级别。构造方法如果未传递 <code>LogLevel level</code> 方法参数，则使用默认值。</li>
<li><code>internalLevel</code> 属性，Netty 内部 LogLevel 级别。通过 <code>LogLevel#toInternalLevel()</code> 方法，将 <code>level</code> 转化成 <code>internalLevel</code> 。</li>
</ul>
</li>
<li><code>logger</code> 属性，Netty 内部 Logger 对象。通过 <code>Class&lt;?&gt; clazz</code> 或 <code>String name</code> 方法参数，进行获得。</li>
</ul>
<h2 id="3-2-具体实现"><a href="#3-2-具体实现" class="headerlink" title="3.2 具体实现"></a>3.2 具体实现</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRegistered</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"REGISTERED"</span>));</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    ctx.fireChannelRegistered();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelUnregistered</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"UNREGISTERED"</span>));</span><br><span class="line">    }</span><br><span class="line">    ctx.fireChannelUnregistered();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">// 打印日志</span></span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"ACTIVE"</span>));</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 传递 Channel active 事件，给下一个节点</span></span><br><span class="line">    ctx.fireChannelActive();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"INACTIVE"</span>));</span><br><span class="line">    }</span><br><span class="line">    ctx.fireChannelInactive();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"EXCEPTION"</span>, cause), cause);</span><br><span class="line">    }</span><br><span class="line">    ctx.fireExceptionCaught(cause);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"USER_EVENT"</span>, evt));</span><br><span class="line">    }</span><br><span class="line">    ctx.fireUserEventTriggered(evt);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"BIND"</span>, localAddress));</span><br><span class="line">    }</span><br><span class="line">    ctx.bind(localAddress, promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ChannelHandlerContext ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">        SocketAddress remoteAddress, SocketAddress localAddress, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"CONNECT"</span>, remoteAddress, localAddress));</span><br><span class="line">    }</span><br><span class="line">    ctx.connect(remoteAddress, localAddress, promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disconnect</span><span class="params">(ChannelHandlerContext ctx, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"DISCONNECT"</span>));</span><br><span class="line">    }</span><br><span class="line">    ctx.disconnect(promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(ChannelHandlerContext ctx, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"CLOSE"</span>));</span><br><span class="line">    }</span><br><span class="line">    ctx.close(promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deregister</span><span class="params">(ChannelHandlerContext ctx, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"DEREGISTER"</span>));</span><br><span class="line">    }</span><br><span class="line">    ctx.deregister(promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"READ COMPLETE"</span>));</span><br><span class="line">    }</span><br><span class="line">    ctx.fireChannelReadComplete();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"READ"</span>, msg));</span><br><span class="line">    }</span><br><span class="line">    ctx.fireChannelRead(msg);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"WRITE"</span>, msg));</span><br><span class="line">    }</span><br><span class="line">    ctx.write(msg, promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelWritabilityChanged</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"WRITABILITY CHANGED"</span>));</span><br><span class="line">    }</span><br><span class="line">    ctx.fireChannelWritabilityChanged();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"FLUSH"</span>));</span><br><span class="line">    }</span><br><span class="line">    ctx.flush();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>里面的每个方法，都是使用 <code>logger</code> 打印日志，并继续传播事件到下一个节点。</p>
<p>而打印的日志的格式，通过 <code>#format(...)</code> 方法，进行拼接。</p>
<h2 id="3-3-format"><a href="#3-3-format" class="headerlink" title="3.3 format"></a>3.3 format</h2><p><code>#format(...)</code> 方法，根据参数的不同，分成三种。</p>
<p>① <code>#format(ChannelHandlerContext ctx, String eventName)</code> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Formats an event and returns the formatted message.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> eventName the name of the event</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">format</span><span class="params">(ChannelHandlerContext ctx, String eventName)</span> </span>{</span><br><span class="line">    String chStr = ctx.channel().toString();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StringBuilder(chStr.length() + <span class="number">1</span> + eventName.length())</span><br><span class="line">        .append(chStr)</span><br><span class="line">        .append(<span class="string">' '</span>)</span><br><span class="line">        .append(eventName)</span><br><span class="line">        .toString();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>② <code>#format(ChannelHandlerContext ctx, String eventName, Object arg)</code> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Formats an event and returns the formatted message.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> eventName the name of the event</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> arg       the argument of the event</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">format</span><span class="params">(ChannelHandlerContext ctx, String eventName, Object arg)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (arg <span class="keyword">instanceof</span> ByteBuf) {</span><br><span class="line">        <span class="keyword">return</span> formatByteBuf(ctx, eventName, (ByteBuf) arg);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (arg <span class="keyword">instanceof</span> ByteBufHolder) {</span><br><span class="line">        <span class="keyword">return</span> formatByteBufHolder(ctx, eventName, (ByteBufHolder) arg);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> formatSimple(ctx, eventName, arg);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>根据参数不同，会调用不同的 format 方法。</li>
</ul>
<p>③ <code>#format(ChannelHandlerContext ctx, String eventName, Object firstArg, Object secondArg)</code> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Formats an event and returns the formatted message.  This method is currently only used for formatting</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> ChannelOutboundHandler#connect(ChannelHandlerContext, SocketAddress, SocketAddress, ChannelPromise)}.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> eventName the name of the event</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> firstArg  the first argument of the event</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> secondArg the second argument of the event</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">format</span><span class="params">(ChannelHandlerContext ctx, String eventName, Object firstArg, Object secondArg)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (secondArg == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> formatSimple(ctx, eventName, firstArg);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    String chStr = ctx.channel().toString();</span><br><span class="line">    String arg1Str = String.valueOf(firstArg);</span><br><span class="line">    String arg2Str = secondArg.toString();</span><br><span class="line">    StringBuilder buf = <span class="keyword">new</span> StringBuilder(</span><br><span class="line">            chStr.length() + <span class="number">1</span> + eventName.length() + <span class="number">2</span> + arg1Str.length() + <span class="number">2</span> + arg2Str.length());</span><br><span class="line">    buf.append(chStr).append(<span class="string">' '</span>).append(eventName).append(<span class="string">": "</span>).append(arg1Str).append(<span class="string">", "</span>).append(arg2Str);</span><br><span class="line">    <span class="keyword">return</span> buf.toString();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="3-3-1-formatByteBuf"><a href="#3-3-1-formatByteBuf" class="headerlink" title="3.3.1 formatByteBuf"></a>3.3.1 formatByteBuf</h3><p><code>#formatByteBuf(ChannelHandlerContext ctx, String eventName, ByteBuf msg)</code> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Generates the default log message of the specified event whose argument is a {<span class="doctag">@link</span> ByteBuf}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">formatByteBuf</span><span class="params">(ChannelHandlerContext ctx, String eventName, ByteBuf msg)</span> </span>{</span><br><span class="line">    String chStr = ctx.channel().toString();</span><br><span class="line">    <span class="keyword">int</span> length = msg.readableBytes();</span><br><span class="line">    <span class="keyword">if</span> (length == <span class="number">0</span>) {</span><br><span class="line">        StringBuilder buf = <span class="keyword">new</span> StringBuilder(chStr.length() + <span class="number">1</span> + eventName.length() + <span class="number">4</span>);</span><br><span class="line">        buf.append(chStr).append(<span class="string">' '</span>).append(eventName).append(<span class="string">": 0B"</span>);</span><br><span class="line">        <span class="keyword">return</span> buf.toString();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">int</span> rows = length / <span class="number">16</span> + (length % <span class="number">15</span> == <span class="number">0</span>? <span class="number">0</span> : <span class="number">1</span>) + <span class="number">4</span>;</span><br><span class="line">        StringBuilder buf = <span class="keyword">new</span> StringBuilder(chStr.length() + <span class="number">1</span> + eventName.length() + <span class="number">2</span> + <span class="number">10</span> + <span class="number">1</span> + <span class="number">2</span> + rows * <span class="number">80</span>);</span><br><span class="line"></span><br><span class="line">        buf.append(chStr).append(<span class="string">' '</span>).append(eventName).append(<span class="string">": "</span>).append(length).append(<span class="string">'B'</span>).append(NEWLINE);</span><br><span class="line">        appendPrettyHexDump(buf, msg); <span class="comment">// &lt;1&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> buf.toString();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> 处的 <code>appendPrettyHexDump(buf, msg)</code> ，实际调用的是 <code>ByteBufUtil#appendPrettyHexDump(StringBuilder dump, ByteBuf buf)</code> 方法。</li>
</ul>
<p>如下是一个打印的示例：</p>
<blockquote>
<p>FROM <a href="https://www.jianshu.com/p/a9bcd89553f5" rel="external nofollow noopener noreferrer" target="_blank">《自顶向下深入分析Netty（八）–ChannelHandler》</a> </p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_10_10/02.png" title="示例" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_10_10/02.png" alt="示例"></a><span class="caption">示例</span></p>
</blockquote>
<h3 id="3-3-2-formatByteBufHolder"><a href="#3-3-2-formatByteBufHolder" class="headerlink" title="3.3.2 formatByteBufHolder"></a>3.3.2 formatByteBufHolder</h3><p><code>#formatByteBufHolder(ChannelHandlerContext ctx, String eventName, ByteBufHolder msg)</code> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Generates the default log message of the specified event whose argument is a {<span class="doctag">@link</span> ByteBufHolder}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">formatByteBufHolder</span><span class="params">(ChannelHandlerContext ctx, String eventName, ByteBufHolder msg)</span> </span>{</span><br><span class="line">    String chStr = ctx.channel().toString();</span><br><span class="line">    String msgStr = msg.toString();</span><br><span class="line">    ByteBuf content = msg.content();</span><br><span class="line">    <span class="keyword">int</span> length = content.readableBytes();</span><br><span class="line">    <span class="keyword">if</span> (length == <span class="number">0</span>) {</span><br><span class="line">        StringBuilder buf = <span class="keyword">new</span> StringBuilder(chStr.length() + <span class="number">1</span> + eventName.length() + <span class="number">2</span> + msgStr.length() + <span class="number">4</span>);</span><br><span class="line">        buf.append(chStr).append(<span class="string">' '</span>).append(eventName).append(<span class="string">", "</span>).append(msgStr).append(<span class="string">", 0B"</span>);</span><br><span class="line">        <span class="keyword">return</span> buf.toString();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">int</span> rows = length / <span class="number">16</span> + (length % <span class="number">15</span> == <span class="number">0</span>? <span class="number">0</span> : <span class="number">1</span>) + <span class="number">4</span>;</span><br><span class="line">        StringBuilder buf = <span class="keyword">new</span> StringBuilder(chStr.length() + <span class="number">1</span> + eventName.length() + <span class="number">2</span> + msgStr.length() + <span class="number">2</span> + <span class="number">10</span> + <span class="number">1</span> + <span class="number">2</span> + rows * <span class="number">80</span>);</span><br><span class="line"></span><br><span class="line">        buf.append(chStr).append(<span class="string">' '</span>).append(eventName).append(<span class="string">": "</span>).append(msgStr).append(<span class="string">", "</span>).append(length).append(<span class="string">'B'</span>).append(NEWLINE);</span><br><span class="line">        appendPrettyHexDump(buf, content);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> buf.toString();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>和 <code>#formatByteBuf(ChannelHandlerContext ctx, String eventName, ByteBuf msg)</code> 方法，实际打印的效果，非常相似。</li>
</ul>
<h3 id="3-3-3-formatSimple"><a href="#3-3-3-formatSimple" class="headerlink" title="3.3.3 formatSimple"></a>3.3.3 formatSimple</h3><p><code>#formatSimple(ChannelHandlerContext ctx, String eventName, Object msg)</code> 方法，代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Generates the default log message of the specified event whose argument is an arbitrary object.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">formatSimple</span><span class="params">(ChannelHandlerContext ctx, String eventName, Object msg)</span> </span>{</span><br><span class="line">    String chStr = ctx.channel().toString();</span><br><span class="line">    String msgStr = String.valueOf(msg);</span><br><span class="line">    StringBuilder buf = <span class="keyword">new</span> StringBuilder(chStr.length() + <span class="number">1</span> + eventName.length() + <span class="number">2</span> + msgStr.length());</span><br><span class="line">    <span class="keyword">return</span> buf.append(chStr).append(<span class="string">' '</span>).append(eventName).append(<span class="string">": "</span>).append(msgStr).toString();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="666-彩蛋"><a href="#666-彩蛋" class="headerlink" title="666. 彩蛋"></a>666. 彩蛋</h1><p>还是没有彩蛋。</p>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/ChannelHandler-4-LoggingHandler/" data-id="ck4pl3fp800ebfgcfwesx7tzu" class="article-share-link">分享</a>



</footer>
-->
</div>