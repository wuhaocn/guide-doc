<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
精尽 Netty 源码解析 —— Codec 之 ByteToMessageCodec
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h1><p>本文，我们来分享 ByteToMessageCodec 部分的内容。</p>
<p>在网络通信中，编解码是成对出现的，所以 Netty 提供了 ByteToMessageCodec 类，支持 Encoder 和 Decoder 两个功能。</p>
<h1 id="2-ByteToMessageCodec"><a href="#2-ByteToMessageCodec" class="headerlink" title="2. ByteToMessageCodec"></a>2. ByteToMessageCodec</h1><p><code>io.netty.handler.codec.ByteToMessageCodec</code> ，继承 ChannelDuplexHandler 类，通过<strong>组合</strong> MessageToByteEncoder 和 ByteToMessageDecoder 的功能，从而实现编解码的 Codec <strong>抽象类</strong>。</p>
<h2 id="2-1-构造方法"><a href="#2-1-构造方法" class="headerlink" title="2.1 构造方法"></a>2.1 构造方法</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ByteToMessageCodec</span>&lt;<span class="title">I</span>&gt; <span class="keyword">extends</span> <span class="title">ChannelDuplexHandler</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 类型匹配器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TypeParameterMatcher outboundMsgMatcher;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Encoder 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MessageToByteEncoder&lt;I&gt; encoder;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Decoder 对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ByteToMessageDecoder decoder = <span class="keyword">new</span> ByteToMessageDecoder() {</span><br><span class="line">    </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            ByteToMessageCodec.<span class="keyword">this</span>.decode(ctx, in, out);</span><br><span class="line">        }</span><br><span class="line">    </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decodeLast</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            ByteToMessageCodec.<span class="keyword">this</span>.decodeLast(ctx, in, out);</span><br><span class="line">        }</span><br><span class="line">    </span><br><span class="line">    };</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">ByteToMessageCodec</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">true</span>);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">ByteToMessageCodec</span><span class="params">(Class&lt;? extends I&gt; outboundMessageType)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(outboundMessageType, <span class="keyword">true</span>);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">ByteToMessageCodec</span><span class="params">(<span class="keyword">boolean</span> preferDirect)</span> </span>{</span><br><span class="line">        <span class="comment">// 禁止共享</span></span><br><span class="line">        ensureNotSharable();</span><br><span class="line">        <span class="comment">// &lt;1&gt; 获得 matcher</span></span><br><span class="line">        outboundMsgMatcher = TypeParameterMatcher.find(<span class="keyword">this</span>, ByteToMessageCodec.class, <span class="string">"I"</span>);</span><br><span class="line">        <span class="comment">// 创建 Encoder 对象</span></span><br><span class="line">        encoder = <span class="keyword">new</span> Encoder(preferDirect);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">ByteToMessageCodec</span><span class="params">(Class&lt;? extends I&gt; outboundMessageType, <span class="keyword">boolean</span> preferDirect)</span> </span>{</span><br><span class="line">        <span class="comment">// 禁止共享</span></span><br><span class="line">        ensureNotSharable();</span><br><span class="line">        <span class="comment">// &lt;2&gt; 获得 matcher</span></span><br><span class="line">        outboundMsgMatcher = TypeParameterMatcher.get(outboundMessageType);</span><br><span class="line">        <span class="comment">// 创建 Encoder 对象</span></span><br><span class="line">        encoder = <span class="keyword">new</span> Encoder(preferDirect);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... 省略其他无关代码</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Encoder</span> <span class="keyword">extends</span> <span class="title">MessageToByteEncoder</span>&lt;<span class="title">I</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">        Encoder(<span class="keyword">boolean</span> preferDirect) {</span><br><span class="line">            <span class="keyword">super</span>(preferDirect);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acceptOutboundMessage</span><span class="params">(Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            <span class="keyword">return</span> ByteToMessageCodec.<span class="keyword">this</span>.acceptOutboundMessage(msg);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, I msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">            ByteToMessageCodec.<span class="keyword">this</span>.encode(ctx, msg, out);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>MessageToByteEncoder 部分<ul>
<li><code>encoder</code> 属性，Encoder 对象，继承自 MessageToByteEncoder 抽象类。只能在构造方法中创建，因为他依赖构造方法的  <code>preferDirect</code> 方法参数，所以不能像 <code>decoder</code> 直接使用属性赋值。</li>
<li><code>outboundMsgMatcher</code> 属性，类型匹配器，在 <code>&lt;1&gt;</code> / <code>&lt;2&gt;</code> 处初始化。</li>
</ul>
</li>
<li>ByteToMessageDecoder 部分<ul>
<li><code>decoder</code> 属性，Decoder 对象，继承自 ByteToMessageDecoder 抽象类。</li>
</ul>
</li>
</ul>
<h2 id="2-2-ChannelHandler-相关方法"><a href="#2-2-ChannelHandler-相关方法" class="headerlink" title="2.2 ChannelHandler 相关方法"></a>2.2 ChannelHandler 相关方法</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    decoder.channelRead(ctx, msg);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    encoder.write(ctx, msg, promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    decoder.channelReadComplete(ctx);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    decoder.channelInactive(ctx);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlerAdded</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        decoder.handlerAdded(ctx);</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        encoder.handlerAdded(ctx);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlerRemoved</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        decoder.handlerRemoved(ctx);</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        encoder.handlerRemoved(ctx);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">## 2.3 MessageToByteEncoder 相关方法</span><br><span class="line"></span><br><span class="line">```Java</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ByteToMessageDecoder#decode(ChannelHandlerContext, ByteBuf, List)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> ByteToMessageDecoder#decodeLast(ChannelHandlerContext, ByteBuf, List)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decodeLast</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (in.isReadable()) {</span><br><span class="line">        <span class="comment">// Only call decode() if there is something left in the buffer to decode.</span></span><br><span class="line">        <span class="comment">// See https://github.com/netty/netty/issues/4386</span></span><br><span class="line">        decode(ctx, in, out);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-4-MessageToByteEncoder-相关方法"><a href="#2-4-MessageToByteEncoder-相关方法" class="headerlink" title="2.4 MessageToByteEncoder 相关方法"></a>2.4 MessageToByteEncoder 相关方法</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns {<span class="doctag">@code</span> true} if and only if the specified message can be encoded by this codec.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> msg the message</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acceptOutboundMessage</span><span class="params">(Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">return</span> outboundMsgMatcher.match(msg);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> MessageToByteEncoder#encode(ChannelHandlerContext, Object, ByteBuf)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, I msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="666-彩蛋"><a href="#666-彩蛋" class="headerlink" title="666. 彩蛋"></a>666. 彩蛋</h1><p>小小的水文一篇，嘿嘿。</p>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/Codec-3-1-ByteToMessageCodec/" data-id="ck4pl3fpa00ehfgcffqc41iru" class="article-share-link">分享</a>



</footer>
-->
</div>