<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆäº”ï¼‰PoolArena
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>åœ¨åº”ç”¨ç¨‹åºé‡Œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ PooledByteBufAllocator æ¥åˆ›å»º ByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">PooledByteBufAllocator.DEFAULT.buffer(<span class="number">1024</span>);</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨æ–¹æ³•çš„å†…éƒ¨å®ç°ï¼Œé€šè¿‡ PoolArena æ¥è¿›è¡Œå†…å­˜åˆ†é…ã€‚</li>
</ul>
<p>ä¸‹é¢ï¼Œå°±è®©æˆ‘ä»¬æ¥çœ‹çœ‹ PoolArena å…·ä½“çš„ä»£ç å®ç°ã€‚</p>
<blockquote>
<p>FROM <a href="https://www.jianshu.com/p/15304cd63175" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆåï¼‰â€“JEMallocåˆ†é…ç®—æ³•ã€‹</a></p>
<p>ä¸ºäº†æé«˜å†…å­˜åˆ†é…æ•ˆç‡å¹¶å‡å°‘å†…éƒ¨ç¢ç‰‡ï¼ŒJemalloc ç®—æ³•å°† Arena åˆ‡åˆ†ä¸ºå°å— Chunkï¼Œæ ¹æ®æ¯å—çš„å†…å­˜ä½¿ç”¨ç‡åˆå°†å°å—ç»„åˆä¸ºä»¥ä¸‹å‡ ç§çŠ¶æ€ï¼šQINITã€Q00ã€Q25ã€Q50ã€Q75ã€Q100 ã€‚Chunk å—å¯ä»¥åœ¨è¿™å‡ ç§çŠ¶æ€é—´éšç€å†…å­˜ä½¿ç”¨ç‡çš„å˜åŒ–è¿›è¡Œè½¬ç§»ï¼Œä»è€Œæé«˜åˆ†é…æ•ˆç‡ã€‚</p>
</blockquote>
<h1 id="2-PoolArena"><a href="#2-PoolArena" class="headerlink" title="2. PoolArena"></a>2. PoolArena</h1><p><code>io.netty.buffer.PoolArena</code> ï¼Œå®ç° PoolArenaMetric æ¥å£ï¼ŒNetty å¯¹ Jemalloc Arena çš„æŠ½è±¡å®ç°ç±»ã€‚</p>
<p>PoolArena æœ‰ä¸¤ä¸ªå­ç±»å®ç°ï¼š</p>
<ul>
<li>HeapArena ï¼Œå¯¹ Heap ç±»å‹çš„å†…å­˜åˆ†é…ã€‚</li>
<li>DirectArena ï¼Œå¯¹ Direct ç±»å‹çš„å†…å­˜åˆ†é…ã€‚</li>
</ul>
<h2 id="2-1-æ„é€ æ–¹æ³•"><a href="#2-1-æ„é€ æ–¹æ³•" class="headerlink" title="2.1 æ„é€ æ–¹æ³•"></a>2.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦æ”¯æŒ Unsafe æ“ä½œ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> HAS_UNSAFE = PlatformDependent.hasUnsafe();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å†…å­˜åˆ†ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">enum</span> SizeClass {</span><br><span class="line">    Tiny,</span><br><span class="line">    Small,</span><br><span class="line">    Normal</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿˜æœ‰ä¸€ä¸ªéšè—çš„ï¼ŒHuge</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #tinySubpagePools} æ•°ç»„çš„å¤§å°</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * é»˜è®¤ä¸º 32</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> numTinySubpagePools = <span class="number">512</span> &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰€å± PooledByteBufAllocator å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> PooledByteBufAllocator parent;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ»¡äºŒå‰æ ‘çš„é«˜åº¦ã€‚é»˜è®¤ä¸º 11 ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxOrder;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Page å¤§å°ï¼Œé»˜è®¤ 8KB = 8192B</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> pageSize;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä» 1 å¼€å§‹å·¦ç§»åˆ° {<span class="doctag">@link</span> #pageSize} çš„ä½æ•°ã€‚é»˜è®¤ 13 ï¼Œ1 &lt;&lt; 13 = 8192 ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> pageShifts;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Chunk å†…å­˜å—å ç”¨å¤§å°ã€‚é»˜è®¤ä¸º 16M = 16 * 1024  ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> chunkSize;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ¤æ–­åˆ†é…è¯·æ±‚å†…å­˜æ˜¯å¦ä¸º Tiny/Small ï¼Œå³åˆ†é… Subpage å†…å­˜å—ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Used to determine if the requested capacity is equal to or greater than pageSize.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> subpageOverflowMask;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #smallSubpagePools} æ•°ç»„çš„å¤§å°</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * é»˜è®¤ä¸º 23</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> numSmallSubpagePools;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯¹é½åŸºå‡†</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> directMemoryCacheAlignment;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #directMemoryCacheAlignment} æ©ç </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> directMemoryCacheAlignmentMask;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * tiny ç±»å‹çš„ PoolSubpage æ•°ç»„</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æ•°ç»„çš„æ¯ä¸ªå…ƒç´ ï¼Œéƒ½æ˜¯åŒå‘é“¾è¡¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolSubpage&lt;T&gt;[] tinySubpagePools;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * small ç±»å‹çš„ SubpagePools æ•°ç»„</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æ•°ç»„çš„æ¯ä¸ªå…ƒç´ ï¼Œéƒ½æ˜¯åŒå‘é“¾è¡¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolSubpage&lt;T&gt;[] smallSubpagePools;</span><br><span class="line"></span><br><span class="line"><span class="comment">// PoolChunkList ä¹‹é—´çš„åŒå‘é“¾è¡¨</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolChunkList&lt;T&gt; q050;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolChunkList&lt;T&gt; q025;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolChunkList&lt;T&gt; q000;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolChunkList&lt;T&gt; qInit;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolChunkList&lt;T&gt; q075;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolChunkList&lt;T&gt; q100;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * PoolChunkListMetric æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;PoolChunkListMetric&gt; chunkListMetrics;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Metrics for allocations and deallocations</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ†é… Normal å†…å­˜å—çš„æ¬¡æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> allocationsNormal;</span><br><span class="line"><span class="comment">// We need to use the LongCounter here as this is not guarded via synchronized block.</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ†é… Tiny å†…å­˜å—çš„æ¬¡æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LongCounter allocationsTiny = PlatformDependent.newLongCounter();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ†é… Small å†…å­˜å—çš„æ¬¡æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LongCounter allocationsSmall = PlatformDependent.newLongCounter();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ†é… Huge å†…å­˜å—çš„æ¬¡æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LongCounter allocationsHuge = PlatformDependent.newLongCounter();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ­£åœ¨ä½¿ç”¨ä¸­çš„ Huge å†…å­˜å—çš„æ€»å…±å ç”¨å­—èŠ‚æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LongCounter activeBytesHuge = PlatformDependent.newLongCounter();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é‡Šæ”¾ Tiny å†…å­˜å—çš„æ¬¡æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> deallocationsTiny;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é‡Šæ”¾ Small å†…å­˜å—çš„æ¬¡æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> deallocationsSmall;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é‡Šæ”¾ Normal å†…å­˜å—çš„æ¬¡æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> deallocationsNormal;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é‡Šæ”¾ Huge å†…å­˜å—çš„æ¬¡æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// We need to use the LongCounter here as this is not guarded via synchronized block.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> LongCounter deallocationsHuge = PlatformDependent.newLongCounter();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¯¥ PoolArena è¢«å¤šå°‘çº¿ç¨‹å¼•ç”¨çš„è®¡æ•°å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// Number of thread caches backed by this arena.</span></span><br><span class="line"><span class="keyword">final</span> AtomicInteger numThreadCaches = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">protected</span> <span class="title">PoolArena</span><span class="params">(PooledByteBufAllocator parent, <span class="keyword">int</span> pageSize,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="number">2</span>:       <span class="keyword">int</span> maxOrder, <span class="keyword">int</span> pageShifts, <span class="keyword">int</span> chunkSize, <span class="keyword">int</span> cacheAlignment)</span> </span>{</span><br><span class="line">  <span class="number">3</span>:     <span class="keyword">this</span>.parent = parent;</span><br><span class="line">  <span class="number">4</span>:     <span class="keyword">this</span>.pageSize = pageSize;</span><br><span class="line">  <span class="number">5</span>:     <span class="keyword">this</span>.maxOrder = maxOrder;</span><br><span class="line">  <span class="number">6</span>:     <span class="keyword">this</span>.pageShifts = pageShifts;</span><br><span class="line">  <span class="number">7</span>:     <span class="keyword">this</span>.chunkSize = chunkSize;</span><br><span class="line">  <span class="number">8</span>:     directMemoryCacheAlignment = cacheAlignment;</span><br><span class="line">  <span class="number">9</span>:     directMemoryCacheAlignmentMask = cacheAlignment - <span class="number">1</span>;</span><br><span class="line"> <span class="number">10</span>:     subpageOverflowMask = ~(pageSize - <span class="number">1</span>);</span><br><span class="line"> <span class="number">11</span>: </span><br><span class="line"> <span class="number">12</span>:     <span class="comment">// åˆå§‹åŒ– tinySubpagePools æ•°ç»„</span></span><br><span class="line"> <span class="number">13</span>:     tinySubpagePools = newSubpagePoolArray(numTinySubpagePools);</span><br><span class="line"> <span class="number">14</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; tinySubpagePools.length; i ++) {</span><br><span class="line"> <span class="number">15</span>:         tinySubpagePools[i] = newSubpagePoolHead(pageSize);</span><br><span class="line"> <span class="number">16</span>:     }</span><br><span class="line"> <span class="number">17</span>: </span><br><span class="line"> <span class="number">18</span>:     <span class="comment">// åˆå§‹åŒ– smallSubpagePools æ•°ç»„</span></span><br><span class="line"> <span class="number">19</span>:     numSmallSubpagePools = pageShifts - <span class="number">9</span>;</span><br><span class="line"> <span class="number">20</span>:     smallSubpagePools = newSubpagePoolArray(numSmallSubpagePools);</span><br><span class="line"> <span class="number">21</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; smallSubpagePools.length; i ++) {</span><br><span class="line"> <span class="number">22</span>:         smallSubpagePools[i] = newSubpagePoolHead(pageSize);</span><br><span class="line"> <span class="number">23</span>:     }</span><br><span class="line"> <span class="number">24</span>: </span><br><span class="line"> <span class="number">25</span>:     <span class="comment">// PoolChunkList ä¹‹é—´çš„åŒå‘é“¾è¡¨ï¼Œåˆå§‹åŒ–</span></span><br><span class="line"> <span class="number">26</span>: </span><br><span class="line"> <span class="number">27</span>:     q100 = <span class="keyword">new</span> PoolChunkList&lt;T&gt;(<span class="keyword">this</span>, <span class="keyword">null</span>, <span class="number">100</span>, Integer.MAX_VALUE, chunkSize);</span><br><span class="line"> <span class="number">28</span>:     q075 = <span class="keyword">new</span> PoolChunkList&lt;T&gt;(<span class="keyword">this</span>, q100, <span class="number">75</span>, <span class="number">100</span>, chunkSize);</span><br><span class="line"> <span class="number">29</span>:     q050 = <span class="keyword">new</span> PoolChunkList&lt;T&gt;(<span class="keyword">this</span>, q075, <span class="number">50</span>, <span class="number">100</span>, chunkSize);</span><br><span class="line"> <span class="number">30</span>:     q025 = <span class="keyword">new</span> PoolChunkList&lt;T&gt;(<span class="keyword">this</span>, q050, <span class="number">25</span>, <span class="number">75</span>, chunkSize);</span><br><span class="line"> <span class="number">31</span>:     q000 = <span class="keyword">new</span> PoolChunkList&lt;T&gt;(<span class="keyword">this</span>, q025, <span class="number">1</span>, <span class="number">50</span>, chunkSize);</span><br><span class="line"> <span class="number">32</span>:     qInit = <span class="keyword">new</span> PoolChunkList&lt;T&gt;(<span class="keyword">this</span>, q000, Integer.MIN_VALUE, <span class="number">25</span>, chunkSize);</span><br><span class="line"> <span class="number">33</span>: </span><br><span class="line"> <span class="number">34</span>:     q100.prevList(q075);</span><br><span class="line"> <span class="number">35</span>:     q075.prevList(q050);</span><br><span class="line"> <span class="number">36</span>:     q050.prevList(q025);</span><br><span class="line"> <span class="number">37</span>:     q025.prevList(q000);</span><br><span class="line"> <span class="number">38</span>:     q000.prevList(<span class="keyword">null</span>); <span class="comment">// æ— å‰ç½®èŠ‚ç‚¹</span></span><br><span class="line"> <span class="number">39</span>:     qInit.prevList(qInit); <span class="comment">// å‰ç½®èŠ‚ç‚¹ä¸ºè‡ªå·±</span></span><br><span class="line"> <span class="number">40</span>: </span><br><span class="line"> <span class="number">41</span>:     <span class="comment">// åˆ›å»º PoolChunkListMetric æ•°ç»„</span></span><br><span class="line"> <span class="number">42</span>:     List&lt;PoolChunkListMetric&gt; metrics = <span class="keyword">new</span> ArrayList&lt;PoolChunkListMetric&gt;(<span class="number">6</span>);</span><br><span class="line"> <span class="number">43</span>:     metrics.add(qInit);</span><br><span class="line"> <span class="number">44</span>:     metrics.add(q000);</span><br><span class="line"> <span class="number">45</span>:     metrics.add(q025);</span><br><span class="line"> <span class="number">46</span>:     metrics.add(q050);</span><br><span class="line"> <span class="number">47</span>:     metrics.add(q075);</span><br><span class="line"> <span class="number">48</span>:     metrics.add(q100);</span><br><span class="line"> <span class="number">49</span>:     chunkListMetrics = Collections.unmodifiableList(metrics);</span><br><span class="line"> <span class="number">50</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>è™½ç„¶å±æ€§æ¯”è¾ƒå¤šï¼Œä½†æ˜¯å†…éƒ¨ä¸»è¦è¿˜æ˜¯ä»¥ PoolSubpage å’Œ PoolChunkList å¯¹è±¡ä¸ºä¸»ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<blockquote>
<p>FROM <a href="https://www.jianshu.com/p/4856bd30dd56" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥æµ…å‡ºNettyå†…å­˜ç®¡ç† PoolArenaã€‹</a></p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_09_13/01.png" title="å¤§ä½“ç»“æ„" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_09_13/01.png" alt="å¤§ä½“ç»“æ„"></a><span class="caption">å¤§ä½“ç»“æ„</span></p>
</blockquote>
</li>
<li><p>SizeClass <strong>æšä¸¾ç±»</strong>ï¼Œå†…å­˜åˆ†ç±»ï¼Œä¸€å…±æœ‰å››ç§ï¼šTinyã€Smallã€Normalã€Huge ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_09_13/02.png" title="å†…å­˜åˆ†é…" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_09_13/02.png" alt="å†…å­˜åˆ†é…"></a><span class="caption">å†…å­˜åˆ†é…</span></p>
</li>
<li><p><code>parent</code> å±æ€§ï¼Œæ‰€å± PooledByteBufAllocator å¯¹è±¡ã€‚</p>
</li>
<li>å†…å­˜å±æ€§ç›¸å…³<ul>
<li><code>HAS_UNSAFE</code> <strong>é™æ€</strong>å±æ€§ï¼Œæ˜¯å¦æ”¯æŒ Unsafe æ“ä½œã€‚ </li>
<li><code>directMemoryCacheAlignment</code> å±æ€§ï¼Œå¯¹é½åŸºå‡†ï¼Œé»˜è®¤ä¸º 0 ã€‚ğŸ˜ˆ å®é™…å¯ä»¥å¿½ç•¥å“ˆã€‚</li>
<li><code>directMemoryCacheAlignmentMask</code> å±æ€§ï¼Œ<code>directMemoryCacheAlignment</code> çš„æ©ç ï¼Œé»˜è®¤ä¸º -1( ã€ç¬¬ 9 è¡Œã€‘çš„ä»£ç  <code>directMemoryCacheAlignment - 1</code> )ã€‚ğŸ˜ˆ å®é™…å¯ä»¥å¿½ç•¥å“ˆã€‚</li>
</ul>
</li>
<li>PoolChunk å±æ€§ç›¸å…³ï¼Œ<code>maxOrder</code>ã€<code>pageSize</code>ã€<code>pageShifts</code>ã€<code>chunkSize</code>ã€<code>subpageOverflowMask</code> ã€‚å·²ç»åœ¨ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-2-Jemalloc-chunk">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆäºŒï¼‰PoolChunkã€‹</a> ã€‚</li>
<li>PoolSubpage å±æ€§ç›¸å…³<ul>
<li><code>tinySubpagePools</code> å±æ€§ï¼Œtiny ç±»å‹çš„ PoolSubpage æ•°ç»„ã€‚æ•°ç»„çš„æ¯ä¸ªå…ƒç´ ï¼Œéƒ½æ˜¯<strong>åŒå‘é“¾è¡¨</strong>ã€‚<ul>
<li>åœ¨ã€ç¬¬ 12 è‡³ 16 è¡Œã€‘çš„ä»£ç ï¼Œè¿›è¡Œåˆå§‹åŒ–ã€‚</li>
<li><code>numTinySubpagePools</code> <strong>é™æ€</strong>å±æ€§ï¼Œæ•°ç»„å¤§å°ã€‚é»˜è®¤ä¸º 32 ã€‚</li>
</ul>
</li>
<li><code>smallSubpagePools</code> å±æ€§ï¼Œsmall ç±»å‹çš„ SubpagePools æ•°ç»„ã€‚æ•°ç»„çš„æ¯ä¸ªå…ƒç´ ï¼Œéƒ½æ˜¯<strong>åŒå‘é“¾è¡¨</strong>ã€‚<ul>
<li>åœ¨ã€ç¬¬ 18 è‡³ 23 è¡Œã€‘çš„ä»£ç ï¼Œè¿›è¡Œåˆå§‹åŒ–ã€‚</li>
<li><code>numSmallSubpagePools</code> å±æ€§ï¼Œæ•°ç»„å¤§å°ã€‚é»˜è®¤ä¸º 23( <code>numTinySubpagePools - 9</code> )ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>PoolChunkList å±æ€§ç›¸å…³ï¼Œ<code>qInit</code>ã€<code>q025</code>ã€<code>q050</code>ã€<code>q075</code>ã€<code>q100</code>ã€<code>chunkListMetrics</code> ã€‚å·²ç»åœ¨ <a href="http://svip.iocoder.cn/Netty/Netty/ByteBuf-3-4-Jemalloc-chunkList">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆå››ï¼‰PoolChunkListã€‹</a> ã€‚</li>
<li>PoolArenaMetric å±æ€§ç›¸å…³<ul>
<li>åˆ†é… <em>XXX</em> å†…å­˜å—çš„æ¬¡æ•°çš„å±æ€§ï¼š<code>allocationsNormal</code>ã€<code>allocationsTiny</code>ã€<code>allocationsSmall</code>ã€<code>allocationsHuge</code> ã€‚</li>
<li>é‡Šæ”¾ <em>XXX</em> å†…å­˜å—çš„æ¬¡æ•°çš„å±æ€§ï¼š<code>deallocationsTiny</code>ã€<code>deallocationsSmall</code>ã€<code>deallocationsNormal</code>ã€<code>deallocationsHuge</code> ã€‚</li>
<li>â†‘â†‘â†‘ ä¸Šè¿°å±æ€§ä½¿ç”¨ LongCounter è¿˜æ˜¯ <code>long</code> ç±»å‹ï¼Œä¸»è¦æ˜¯å˜é‡è®¿é—®æ—¶ï¼Œæ˜¯å¦åœ¨ <code>synchronized {}</code> ä»£ç å—ä¸­è®¿é—®ï¼Œä»è€Œä¿è¯<strong>å†…å­˜çš„å¯è§æ€§</strong>ã€‚ </li>
<li><code>activeBytesHuge</code> å±æ€§ï¼Œ<strong>æ­£åœ¨ä½¿ç”¨ä¸­</strong>çš„ Huge å†…å­˜å—çš„æ€»å…±å ç”¨å­—èŠ‚æ•°ã€‚</li>
<li><code>numThreadCaches</code> å±æ€§ï¼Œè¯¥ PoolArena è¢«å¤šå°‘çº¿ç¨‹å¼•ç”¨çš„è®¡æ•°å™¨ã€‚</li>
</ul>
</li>
<li>ğŸ˜ˆ æ„é€ æ–¹æ³•ï¼Œç®€å•çœ‹çœ‹å°±å¥½ï¼ŒåŸºæœ¬ä¸Šé¢éƒ½å·²ç»æåˆ°äº†ã€‚</li>
</ul>
<h2 id="2-2-å®¹é‡ç›¸å…³æ–¹æ³•"><a href="#2-2-å®¹é‡ç›¸å…³æ–¹æ³•" class="headerlink" title="2.2 å®¹é‡ç›¸å…³æ–¹æ³•"></a>2.2 å®¹é‡ç›¸å…³æ–¹æ³•</h2><h3 id="2-2-1-normalizeCapacity"><a href="#2-2-1-normalizeCapacity" class="headerlink" title="2.2.1 normalizeCapacity"></a>2.2.1 normalizeCapacity</h3><p><code>#normalizeCapacity(int reqCapacity)</code> æ–¹æ³•ï¼Œæ ‡å‡†åŒ–è¯·æ±‚åˆ†é…çš„å†…å­˜å¤§å°ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œ<strong>ä¿è¯åˆ†é…çš„å†…å­˜å—ç»Ÿä¸€</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">int</span> <span class="title">normalizeCapacity</span><span class="params">(<span class="keyword">int</span> reqCapacity)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (reqCapacity &lt; <span class="number">0</span>) {</span><br><span class="line"> <span class="number">3</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"capacity: "</span> + reqCapacity + <span class="string">" (expected: 0+)"</span>);</span><br><span class="line"> <span class="number">4</span>:     }</span><br><span class="line"> <span class="number">5</span>: </span><br><span class="line"> <span class="number">6</span>:     <span class="comment">// Huge å†…å­˜ç±»å‹ï¼Œç›´æ¥ä½¿ç”¨ reqCapacity ï¼Œæ— éœ€è¿›è¡Œæ ‡å‡†åŒ–ã€‚</span></span><br><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (reqCapacity &gt;= chunkSize) {</span><br><span class="line"> <span class="number">8</span>:         <span class="keyword">return</span> directMemoryCacheAlignment == <span class="number">0</span> ? reqCapacity : alignCapacity(reqCapacity);</span><br><span class="line"> <span class="number">9</span>:     }</span><br><span class="line"><span class="number">10</span>: </span><br><span class="line"><span class="number">11</span>:     <span class="comment">// é tiny å†…å­˜ç±»å‹</span></span><br><span class="line"><span class="number">12</span>:     <span class="keyword">if</span> (!isTiny(reqCapacity)) { <span class="comment">// &gt;= 512</span></span><br><span class="line"><span class="number">13</span>:         <span class="comment">// Doubled</span></span><br><span class="line"><span class="number">14</span>:         <span class="comment">// è½¬æ¢æˆæ¥è¿‘äºä¸¤å€çš„å®¹é‡</span></span><br><span class="line"><span class="number">15</span>:         <span class="keyword">int</span> normalizedCapacity = reqCapacity;</span><br><span class="line"><span class="number">16</span>:         normalizedCapacity --;</span><br><span class="line"><span class="number">17</span>:         normalizedCapacity |= normalizedCapacity &gt;&gt;&gt;  <span class="number">1</span>;</span><br><span class="line"><span class="number">18</span>:         normalizedCapacity |= normalizedCapacity &gt;&gt;&gt;  <span class="number">2</span>;</span><br><span class="line"><span class="number">19</span>:         normalizedCapacity |= normalizedCapacity &gt;&gt;&gt;  <span class="number">4</span>;</span><br><span class="line"><span class="number">20</span>:         normalizedCapacity |= normalizedCapacity &gt;&gt;&gt;  <span class="number">8</span>;</span><br><span class="line"><span class="number">21</span>:         normalizedCapacity |= normalizedCapacity &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line"><span class="number">22</span>:         normalizedCapacity ++;</span><br><span class="line"><span class="number">23</span>:         <span class="keyword">if</span> (normalizedCapacity &lt; <span class="number">0</span>) {</span><br><span class="line"><span class="number">24</span>:             normalizedCapacity &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line"><span class="number">25</span>:         }</span><br><span class="line"><span class="number">26</span>:         <span class="keyword">assert</span> directMemoryCacheAlignment == <span class="number">0</span> || (normalizedCapacity &amp; directMemoryCacheAlignmentMask) == <span class="number">0</span>;</span><br><span class="line"><span class="number">27</span>: </span><br><span class="line"><span class="number">28</span>:         <span class="keyword">return</span> normalizedCapacity;</span><br><span class="line"><span class="number">29</span>:     }</span><br><span class="line"><span class="number">30</span>: </span><br><span class="line"><span class="number">31</span>:     <span class="keyword">if</span> (directMemoryCacheAlignment &gt; <span class="number">0</span>) {</span><br><span class="line"><span class="number">32</span>:         <span class="keyword">return</span> alignCapacity(reqCapacity);</span><br><span class="line"><span class="number">33</span>:     }</span><br><span class="line"><span class="number">34</span>: </span><br><span class="line"><span class="number">35</span>:     <span class="comment">// è¡¥é½æˆ 16 çš„å€æ•°</span></span><br><span class="line"><span class="number">36</span>:     <span class="comment">// Quantum-spaced</span></span><br><span class="line"><span class="number">37</span>:     <span class="keyword">if</span> ((reqCapacity &amp; <span class="number">15</span>) == <span class="number">0</span>) {</span><br><span class="line"><span class="number">38</span>:         <span class="keyword">return</span> reqCapacity;</span><br><span class="line"><span class="number">39</span>:     }</span><br><span class="line"><span class="number">40</span>:     <span class="keyword">return</span> (reqCapacity &amp; ~<span class="number">15</span>) + <span class="number">16</span>;</span><br><span class="line"><span class="number">41</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 6 è‡³ 9 è¡Œï¼š<strong>Huge</strong> å†…å­˜ç±»å‹ï¼Œç›´æ¥ä½¿ç”¨ reqCapacity ï¼Œæ— éœ€è¿›è¡Œæ ‡å‡†åŒ–ã€‚</li>
<li>ç¬¬ 11 è‡³ 29 è¡Œï¼š<strong>Small</strong>ã€<strong>Normal</strong> å†…å­˜ç±»å‹ï¼Œè½¬æ¢æˆæ¥è¿‘äº<strong>ä¸¤å€</strong>çš„å®¹é‡ã€‚</li>
<li>ç¬¬ 35 è‡³ 40 è¡Œï¼š<strong>Tiny</strong> å†…å­˜ç±»å‹ï¼Œè¡¥é½æˆ <strong>16</strong> çš„å€æ•°ã€‚</li>
</ul>
<p>æ€»ç»“æ¥è¯´ï¼Œè¿˜æ˜¯ä¸‹å›¾ï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_09_13/03.png" title="å†…å­˜å®¹é‡" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_09_13/03.png" alt="å†…å­˜å®¹é‡"></a><span class="caption">å†…å­˜å®¹é‡</span></p>
<h3 id="2-2-2-alignCapacity"><a href="#2-2-2-alignCapacity" class="headerlink" title="2.2.2 alignCapacity"></a>2.2.2 alignCapacity</h3><p><code>#alignCapacity(int reqCapacity)</code> æ–¹æ³•ï¼Œå¯¹é½è¯·æ±‚åˆ†é…çš„å†…å­˜å¤§å°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">alignCapacity</span><span class="params">(<span class="keyword">int</span> reqCapacity)</span> </span>{</span><br><span class="line">    <span class="comment">// è·å¾— delta</span></span><br><span class="line">    <span class="keyword">int</span> delta = reqCapacity &amp; directMemoryCacheAlignmentMask;</span><br><span class="line">    <span class="comment">// è¡¥é½ directMemoryCacheAlignment ï¼Œå¹¶å‡å» delta</span></span><br><span class="line">    <span class="keyword">return</span> delta == <span class="number">0</span> ? reqCapacity : reqCapacity + directMemoryCacheAlignment - delta;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-2-3-isTinyOrSmall"><a href="#2-2-3-isTinyOrSmall" class="headerlink" title="2.2.3 isTinyOrSmall"></a>2.2.3 isTinyOrSmall</h3><p><code>#isTinyOrSmall(int normCapacity)</code> æ–¹æ³•ï¼Œåˆ¤æ–­è¯·æ±‚åˆ†é…çš„å†…å­˜ç±»å‹æ˜¯å¦ä¸º tiny æˆ– small ç±»å‹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// capacity &lt; pageSize</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isTinyOrSmall</span><span class="params">(<span class="keyword">int</span> normCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (normCapacity &amp; subpageOverflowMask) == <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-2-4-isTiny"><a href="#2-2-4-isTiny" class="headerlink" title="2.2.4 isTiny"></a>2.2.4 isTiny</h3><p><code>#isTiny(int normCapacity)</code> æ–¹æ³•ï¼Œåˆ¤æ–­è¯·æ±‚åˆ†é…çš„å†…å­˜ç±»å‹æ˜¯å¦ä¸º tiny ç±»å‹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// normCapacity &lt; 512</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isTiny</span><span class="params">(<span class="keyword">int</span> normCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (normCapacity &amp; <span class="number">0xFFFFFE00</span>) == <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-2-5-tinyIdx"><a href="#2-2-5-tinyIdx" class="headerlink" title="2.2.5 tinyIdx"></a>2.2.5 tinyIdx</h3><p><code>#tinyIdx(int normCapacity)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œè®¡ç®—è¯·æ±‚åˆ†é…çš„å†…å­˜å¤§å°åœ¨ <code>tinySubpagePools</code> æ•°ç»„çš„ä¸‹æ ‡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">tinyIdx</span><span class="params">(<span class="keyword">int</span> normCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> normCapacity &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-2-6-smallIdx"><a href="#2-2-6-smallIdx" class="headerlink" title="2.2.6 smallIdx"></a>2.2.6 smallIdx</h3><p><code>#smallIdx(int normCapacity)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œè®¡ç®—è¯·æ±‚åˆ†é…çš„å†…å­˜å¤§å°åœ¨ <code>smallSubpagePools</code> æ•°ç»„çš„ä¸‹æ ‡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">smallIdx</span><span class="params">(<span class="keyword">int</span> normCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">int</span> tableIdx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> i = normCapacity &gt;&gt;&gt; <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">while</span> (i != <span class="number">0</span>) {</span><br><span class="line">        i &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">        tableIdx ++;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> tableIdx;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-2-7-sizeClass"><a href="#2-2-7-sizeClass" class="headerlink" title="2.2.7 sizeClass"></a>2.2.7 sizeClass</h3><p><code>#sizeClass(int normCapacity)</code> æ–¹æ³•ï¼Œè®¡ç®—è¯·æ±‚åˆ†é…çš„å†…å­˜çš„å†…å­˜ç±»å‹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> SizeClass <span class="title">sizeClass</span><span class="params">(<span class="keyword">int</span> normCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!isTinyOrSmall(normCapacity)) {</span><br><span class="line">        <span class="keyword">return</span> SizeClass.Normal;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> isTiny(normCapacity) ? SizeClass.Tiny : SizeClass.Small;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-3-findSubpagePoolHead"><a href="#2-3-findSubpagePoolHead" class="headerlink" title="2.3 findSubpagePoolHead"></a>2.3 findSubpagePoolHead</h2><p><code>#findSubpagePoolHead(int elemSize)</code> æ–¹æ³•ï¼Œè·å¾—è¯·æ±‚åˆ†é…çš„ Subpage ç±»å‹çš„å†…å­˜çš„é“¾è¡¨çš„<strong>å¤´èŠ‚ç‚¹</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function">PoolSubpage&lt;T&gt; <span class="title">findSubpagePoolHead</span><span class="params">(<span class="keyword">int</span> elemSize)</span> </span>{</span><br><span class="line">    <span class="keyword">int</span> tableIdx;</span><br><span class="line">    PoolSubpage&lt;T&gt;[] table;</span><br><span class="line">    <span class="keyword">if</span> (isTiny(elemSize)) { <span class="comment">// &lt; 512</span></span><br><span class="line">        <span class="comment">// å®é™…ä¸Šï¼Œå°±æ˜¯ `#tinyIdx(int normCapacity)` æ–¹æ³•</span></span><br><span class="line">        tableIdx = elemSize &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">        <span class="comment">// è·å¾— table</span></span><br><span class="line">        table = tinySubpagePools;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// å®é™…ä¸Šï¼Œå°±æ˜¯ `#smallIdx(int normCapacity)` æ–¹æ³•</span></span><br><span class="line">        tableIdx = <span class="number">0</span>;</span><br><span class="line">        elemSize &gt;&gt;&gt;= <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">while</span> (elemSize != <span class="number">0</span>) {</span><br><span class="line">            elemSize &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line">            tableIdx ++;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// è·å¾— table</span></span><br><span class="line">        table = smallSubpagePools;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å¾— Subpage é“¾è¡¨çš„å¤´èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">return</span> table[tableIdx];</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-4-allocate"><a href="#2-4-allocate" class="headerlink" title="2.4 allocate"></a>2.4 allocate</h2><p>PoolArena æ ¹æ®ç”³è¯·åˆ†é…çš„å†…å­˜å¤§å°ä¸åŒï¼Œæä¾›äº†<strong>ä¸¤ç§</strong>æ–¹å¼åˆ†é…å†…å­˜ï¼š</p>
<ul>
<li>1ã€PoolSubpage ï¼Œç”¨äºåˆ†é…<strong>å°äº</strong> <code>8KB</code> çš„å†…å­˜å—<ul>
<li>1.1 <code>tinySubpagePools</code> å±æ€§ï¼Œç”¨äºåˆ†é…å°äº <code>512B</code> çš„ tiny <strong>Subpage</strong> å†…å­˜å—ã€‚</li>
<li>1.2  <code>smallSubpagePools</code> å±æ€§ï¼Œç”¨äºåˆ†é…å°äº <code>8KB</code> çš„ small <strong>Subpage</strong> å†…å­˜å—ã€‚</li>
</ul>
</li>
<li>2ã€PoolChunkList ï¼Œç”¨äºåˆ†é…<strong>å¤§äºç­‰äº</strong> <code>8KB</code> çš„å†…å­˜å—<ul>
<li>2.1 å°äº <code>32MB</code> ï¼Œåˆ†é… normal å†…å­˜å—ï¼Œå³ä¸€ä¸ª Chunk ä¸­çš„ <strong>Page</strong> å†…å­˜å—ã€‚</li>
<li>2.2 å¤§äºç­‰äº <code>32MB</code> ï¼Œåˆ†é… huge å†…å­˜å—ï¼Œå³ä¸€æ•´ä¸ª <strong>Chunk</strong> å†…å­˜å—ã€‚</li>
</ul>
</li>
</ul>
<hr>
<p><code>#allocate(PoolThreadCache cache, int reqCapacity, int maxCapacity)</code> æ–¹æ³•ï¼Œåˆ›å»º PooledByteBuf å¯¹è±¡ï¼Œå¹¶åˆ†é…å†…å­˜å—ç»™ PooledByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">allocate</span><span class="params">(PoolThreadCache cache, PooledByteBuf&lt;T&gt; buf, <span class="keyword">final</span> <span class="keyword">int</span> reqCapacity)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// æ ‡å‡†åŒ–è¯·æ±‚åˆ†é…çš„å®¹é‡</span></span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">final</span> <span class="keyword">int</span> normCapacity = normalizeCapacity(reqCapacity);</span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// PoolSubpage çš„æƒ…å†µ</span></span><br><span class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (isTinyOrSmall(normCapacity)) { <span class="comment">// capacity &lt; pageSize</span></span><br><span class="line"> <span class="number">6</span>:         <span class="keyword">int</span> tableIdx;</span><br><span class="line"> <span class="number">7</span>:         PoolSubpage&lt;T&gt;[] table;</span><br><span class="line"> <span class="number">8</span>:         <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸º tiny ç±»å‹çš„å†…å­˜å—ç”³è¯·</span></span><br><span class="line"> <span class="number">9</span>:         <span class="keyword">boolean</span> tiny = isTiny(normCapacity);</span><br><span class="line"><span class="number">10</span>:         <span class="keyword">if</span> (tiny) { <span class="comment">// &lt; 512 tiny ç±»å‹çš„å†…å­˜å—ç”³è¯·</span></span><br><span class="line"><span class="number">11</span>:             <span class="comment">// ä» PoolThreadCache ç¼“å­˜ä¸­ï¼Œåˆ†é… tiny å†…å­˜å—ï¼Œå¹¶åˆå§‹åŒ–åˆ° PooledByteBuf ä¸­ã€‚</span></span><br><span class="line"><span class="number">12</span>:             <span class="keyword">if</span> (cache.allocateTiny(<span class="keyword">this</span>, buf, reqCapacity, normCapacity)) {</span><br><span class="line"><span class="number">13</span>:                 <span class="comment">// was able to allocate out of the cache so move on</span></span><br><span class="line"><span class="number">14</span>:                 <span class="keyword">return</span>;</span><br><span class="line"><span class="number">15</span>:             }</span><br><span class="line"><span class="number">16</span>:             <span class="comment">// è·å¾— tableIdx å’Œ table å±æ€§</span></span><br><span class="line"><span class="number">17</span>:             tableIdx = tinyIdx(normCapacity);</span><br><span class="line"><span class="number">18</span>:             table = tinySubpagePools;</span><br><span class="line"><span class="number">19</span>:         } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">20</span>:             <span class="comment">// ä» PoolThreadCache ç¼“å­˜ä¸­ï¼Œåˆ†é… small å†…å­˜å—ï¼Œå¹¶åˆå§‹åŒ–åˆ° PooledByteBuf ä¸­ã€‚</span></span><br><span class="line"><span class="number">21</span>:             <span class="keyword">if</span> (cache.allocateSmall(<span class="keyword">this</span>, buf, reqCapacity, normCapacity)) {</span><br><span class="line"><span class="number">22</span>:                 <span class="comment">// was able to allocate out of the cache so move on</span></span><br><span class="line"><span class="number">23</span>:                 <span class="keyword">return</span>;</span><br><span class="line"><span class="number">24</span>:             }</span><br><span class="line"><span class="number">25</span>:             <span class="comment">// è·å¾— tableIdx å’Œ table å±æ€§</span></span><br><span class="line"><span class="number">26</span>:             tableIdx = smallIdx(normCapacity);</span><br><span class="line"><span class="number">27</span>:             table = smallSubpagePools;</span><br><span class="line"><span class="number">28</span>:         }</span><br><span class="line"><span class="number">29</span>: </span><br><span class="line"><span class="number">30</span>:         <span class="comment">// è·å¾— PoolSubpage é“¾è¡¨çš„å¤´èŠ‚ç‚¹</span></span><br><span class="line"><span class="number">31</span>:         <span class="keyword">final</span> PoolSubpage&lt;T&gt; head = table[tableIdx];</span><br><span class="line"><span class="number">32</span>: </span><br><span class="line"><span class="number">33</span>:         <span class="comment">// ä» PoolSubpage é“¾è¡¨ä¸­ï¼Œåˆ†é… Subpage å†…å­˜å—</span></span><br><span class="line"><span class="number">34</span>:         <span class="comment">/**</span></span><br><span class="line"><span class="comment">35:          * Synchronize on the head. This is needed as {<span class="doctag">@link</span> PoolChunk#allocateSubpage(int)} and</span></span><br><span class="line"><span class="comment">36:          * {<span class="doctag">@link</span> PoolChunk#free(long)} may modify the doubly linked list as well.</span></span><br><span class="line"><span class="comment">37:          */</span></span><br><span class="line"><span class="number">38</span>:         <span class="keyword">synchronized</span> (head) { <span class="comment">// åŒæ­¥ head ï¼Œé¿å…å¹¶å‘é—®é¢˜</span></span><br><span class="line"><span class="number">39</span>:             <span class="keyword">final</span> PoolSubpage&lt;T&gt; s = head.next;</span><br><span class="line"><span class="number">40</span>:             <span class="keyword">if</span> (s != head) {</span><br><span class="line"><span class="number">41</span>:                 <span class="keyword">assert</span> s.doNotDestroy &amp;&amp; s.elemSize == normCapacity;</span><br><span class="line"><span class="number">42</span>:                 <span class="comment">// åˆ†é… Subpage å†…å­˜å—</span></span><br><span class="line"><span class="number">43</span>:                 <span class="keyword">long</span> handle = s.allocate();</span><br><span class="line"><span class="number">44</span>:                 <span class="keyword">assert</span> handle &gt;= <span class="number">0</span>;</span><br><span class="line"><span class="number">45</span>:                 <span class="comment">// åˆå§‹åŒ– Subpage å†…å­˜å—åˆ° PooledByteBuf å¯¹è±¡ä¸­</span></span><br><span class="line"><span class="number">46</span>:                 s.chunk.initBufWithSubpage(buf, handle, reqCapacity);</span><br><span class="line"><span class="number">47</span>:                 <span class="comment">// å¢åŠ  allocationsTiny æˆ– allocationsSmall è®¡æ•°</span></span><br><span class="line"><span class="number">48</span>:                 incTinySmallAllocation(tiny);</span><br><span class="line"><span class="number">49</span>:                 <span class="comment">// è¿”å›ï¼Œå› ä¸ºå·²ç»åˆ†é…æˆåŠŸ</span></span><br><span class="line"><span class="number">50</span>:                 <span class="keyword">return</span>;</span><br><span class="line"><span class="number">51</span>:             }</span><br><span class="line"><span class="number">52</span>:         }</span><br><span class="line"><span class="number">53</span>:         <span class="comment">// ç”³è¯· Normal Page å†…å­˜å—ã€‚å®é™…ä¸Šï¼Œåªå ç”¨å…¶ä¸­ä¸€å— Subpage å†…å­˜å—ã€‚</span></span><br><span class="line"><span class="number">54</span>:         <span class="keyword">synchronized</span> (<span class="keyword">this</span>) { <span class="comment">// åŒæ­¥ arena ï¼Œé¿å…å¹¶å‘é—®é¢˜</span></span><br><span class="line"><span class="number">55</span>:             allocateNormal(buf, reqCapacity, normCapacity);</span><br><span class="line"><span class="number">56</span>:         }</span><br><span class="line"><span class="number">57</span>:         <span class="comment">// å¢åŠ  allocationsTiny æˆ– allocationsSmall è®¡æ•°</span></span><br><span class="line"><span class="number">58</span>:         incTinySmallAllocation(tiny);</span><br><span class="line"><span class="number">59</span>:         <span class="comment">// è¿”å›ï¼Œå› ä¸ºå·²ç»åˆ†é…æˆåŠŸ</span></span><br><span class="line"><span class="number">60</span>:         <span class="keyword">return</span>;</span><br><span class="line"><span class="number">61</span>:     }</span><br><span class="line"><span class="number">62</span>:     <span class="keyword">if</span> (normCapacity &lt;= chunkSize) {</span><br><span class="line"><span class="number">63</span>:         <span class="comment">// ä» PoolThreadCache ç¼“å­˜ä¸­ï¼Œåˆ†é… normal å†…å­˜å—ï¼Œå¹¶åˆå§‹åŒ–åˆ° PooledByteBuf ä¸­ã€‚</span></span><br><span class="line"><span class="number">64</span>:         <span class="keyword">if</span> (cache.allocateNormal(<span class="keyword">this</span>, buf, reqCapacity, normCapacity)) {</span><br><span class="line"><span class="number">65</span>:             <span class="comment">// was able to allocate out of the cache so move on</span></span><br><span class="line"><span class="number">66</span>:             <span class="keyword">return</span>;</span><br><span class="line"><span class="number">67</span>:         }</span><br><span class="line"><span class="number">68</span>:         <span class="comment">// ç”³è¯· Normal Page å†…å­˜å—</span></span><br><span class="line"><span class="number">69</span>:         <span class="keyword">synchronized</span> (<span class="keyword">this</span>) { <span class="comment">// åŒæ­¥ arena ï¼Œé¿å…å¹¶å‘é—®é¢˜</span></span><br><span class="line"><span class="number">70</span>:             allocateNormal(buf, reqCapacity, normCapacity);</span><br><span class="line"><span class="number">71</span>:             <span class="comment">// å¢åŠ  allocationsNormal</span></span><br><span class="line"><span class="number">72</span>:             ++allocationsNormal;</span><br><span class="line"><span class="number">73</span>:         }</span><br><span class="line"><span class="number">74</span>:     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">75</span>:         <span class="comment">// ç”³è¯· Huge Page å†…å­˜å—</span></span><br><span class="line"><span class="number">76</span>:         <span class="comment">// Huge allocations are never served via the cache so just call allocateHuge</span></span><br><span class="line"><span class="number">77</span>:         allocateHuge(buf, reqCapacity);</span><br><span class="line"><span class="number">78</span>:     }</span><br><span class="line"><span class="number">79</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šè°ƒç”¨ <code>#normalizeCapacity(int reqCapacity)</code> æ–¹æ³•ï¼Œæ ‡å‡†åŒ–è¯·æ±‚åˆ†é…çš„å†…å­˜å¤§å°ã€‚</li>
<li><p>ç¬¬ 5 è‡³ 61 è¡Œï¼šä¸Šè¿°â€œ1ã€PoolSubpage ï¼Œç”¨äºåˆ†é…å°äº 8KB çš„å†…å­˜å—â€ã€‚</p>
<ul>
<li>ç¬¬ 5 è¡Œï¼šè°ƒç”¨ <code>#isTinyOrSmall(int normCapacity)</code> æ–¹æ³•ï¼Œåˆ¤æ–­è¯·æ±‚åˆ†é…çš„å†…å­˜ç±»å‹æ˜¯å¦ä¸º tiny æˆ– small ç±»å‹ã€‚<ul>
<li>ç¬¬ 9 è¡Œï¼šè°ƒç”¨ <code>#isTiny(int normCapacity)</code> æ–¹æ³•ï¼Œåˆ¤æ–­è¯·æ±‚åˆ†é…çš„å†…å­˜ç±»å‹æ˜¯å¦ä¸º tiny ç±»å‹ã€‚</li>
</ul>
</li>
<li>ç¬¬ 10 è‡³ 31 è¡Œï¼šè·å¾— PoolSubpage é“¾è¡¨çš„å¤´èŠ‚ç‚¹ã€‚ä»å®ç°ä¸Šï¼Œå’Œ <a href="#">ã€Œ2.3 findSubpagePoolHeadã€</a> åŠŸèƒ½ä¸Šæ˜¯ä¸€è‡´çš„ã€‚<ul>
<li>ç¬¬ 11 è‡³ 15 è¡Œï¼šè°ƒç”¨ <code>PoolThreadCache#allocateTiny(this, buf, reqCapacity, normCapacity)</code> æ–¹æ³•ï¼Œä» PoolThreadCache ç¼“å­˜ä¸­ï¼Œåˆ†é… tiny å†…å­˜å—ï¼Œå¹¶åˆå§‹åŒ–åˆ° PooledByteBuf ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-6-Jemalloc-ThreadCache">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆå…­ï¼‰PoolThreadCacheã€‹</a> ä¸­ã€‚</li>
<li>ç¬¬ 20 è‡³ 24 è¡Œï¼šè°ƒç”¨ <code>PoolThreadCache#allocateSmall(this, buf, reqCapacity, normCapacity)</code> æ–¹æ³•ï¼Œä» PoolThreadCache ç¼“å­˜ä¸­ï¼Œåˆ†é… small å†…å­˜å—ï¼Œå¹¶åˆå§‹åŒ–åˆ° PooledByteBuf ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-6-Jemalloc-ThreadCache">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆå…­ï¼‰PoolThreadCacheã€‹</a> ä¸­ã€‚</li>
</ul>
</li>
<li>ç¬¬ 33 è‡³ 52 è¡Œï¼šä» PoolSubpage é“¾è¡¨ä¸­ï¼Œåˆ†é… Subpage å†…å­˜å—ã€‚<ul>
<li>ç¬¬ 43 è¡Œï¼šè°ƒç”¨ <code>head.next</code> èŠ‚ç‚¹çš„ <code>PoolSubpage#allocate()</code> æ–¹æ³•ï¼Œåˆ†é…ä¸€ä¸ª Subpage å†…å­˜å—ï¼Œå¹¶è¿”å›è¯¥å†…å­˜å—çš„ä½ç½® <code>handle</code> ã€‚å¦‚æœé—å¿˜è¿™ä¸ªè¿‡ç¨‹çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-3-Jemalloc-subpage">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆä¸‰ï¼‰PoolSubpageã€‹</a> çš„ <a href="#">ã€Œ2.4 allocateã€</a> ã€‚ </li>
<li>ç¬¬ 46 è¡Œï¼šè°ƒç”¨ <code>PoolChunk#initBufWithSubpage(buf, handle, reqCapacity)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Subpage å†…å­˜å—åˆ° PooledByteBuf å¯¹è±¡ä¸­ã€‚å¦‚æœé—å¿˜è¿™ä¸ªè¿‡ç¨‹çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-2-Jemalloc-chunk">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆäºŒï¼‰PoolChunkã€‹</a> çš„ <a href="#">ã€Œ2.5.1 initBufWithSubpageã€</a> ã€‚</li>
<li>ç¬¬ 48 è¡Œï¼šè°ƒç”¨ <code>#incTinySmallAllocation(boolean tiny)</code> æ–¹æ³•ï¼Œå¢åŠ  <code>allocationsTiny</code> æˆ– <code>allocationsSmall</code> è®¡æ•°ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.8.1 incTinySmallAllocationã€</a> ã€‚</li>
<li>ç¬¬ 50 è¡Œï¼š<code>return</code> è¿”å›ï¼Œå› ä¸ºå·²ç»åˆ†é…æˆåŠŸã€‚</li>
</ul>
</li>
<li>ç¬¬ 53 è‡³ 60 è¡Œï¼šåœ¨ PoolSubpage é“¾è¡¨ä¸­ï¼Œåˆ†é…ä¸åˆ° Subpage å†…å­˜å—ï¼Œæ‰€ä»¥ç”³è¯· Normal Page å†…å­˜å—ã€‚å®é™…ä¸Šï¼Œåªå ç”¨å…¶ä¸­ä¸€å— Subpage å†…å­˜å—ã€‚<ul>
<li>ç¬¬ 53 è‡³ 56 è¡Œï¼šè°ƒç”¨ <code>#allocateNormal(PooledByteBuf&lt;T&gt; buf, int reqCapacity, int normCapacity)</code> æ–¹æ³•ï¼Œç”³è¯· Normal Page å†…å­˜å—ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.4.1 allocateNormalã€</a> ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p>ç¬¬ 62 è‡³ 73 è¡Œï¼šä¸Šè¿°â€œ2.1 å°äº <code>32MB</code> ï¼Œåˆ†é… normal å†…å­˜å—ï¼Œå³ä¸€ä¸ª Chunk ä¸­çš„ <strong>Page</strong> å†…å­˜å—â€ã€‚</p>
<ul>
<li>ç¬¬ 62 è¡Œï¼šé€šè¿‡ <code>normCapacity &lt;= chunkSize</code> åˆ¤æ–­ï¼Œåˆ¤æ–­è¯·æ±‚åˆ†é…çš„å†…å­˜ç±»å‹æ˜¯å¦ä¸º normal ç±»å‹ã€‚</li>
<li>ç¬¬ 63 è‡³ 67 è¡Œï¼šè°ƒç”¨ <code>PoolThreadCache#allocateNormal(this, buf, reqCapacity, normCapacity)</code> æ–¹æ³•ï¼Œä» PoolThreadCache ç¼“å­˜ä¸­ï¼Œåˆ†é… normal å†…å­˜å—ï¼Œå¹¶åˆå§‹åŒ–åˆ° PooledByteBuf ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-6-Jemalloc-ThreadCache">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆå…­ï¼‰PoolThreadCacheã€‹</a> ä¸­ã€‚</li>
<li>ç¬¬ 68 è‡³ 70 è¡Œï¼šåŒã€ç¬¬ 53 è‡³ 56 è¡Œã€‘çš„ä»£ç ã€‚</li>
<li>ç¬¬ 72 è¡Œï¼šå¢åŠ  <code>allocationsNormal</code> ã€‚</li>
</ul>
</li>
<li>ç¬¬ 74 è‡³ 78 è¡Œï¼šä¸Šè¿°â€œ2.2 å¤§äºç­‰äº <code>32MB</code> ï¼Œåˆ†é… huge å†…å­˜å—ï¼Œå³ä¸€æ•´ä¸ª <strong>Chunk</strong> å†…å­˜å—ã€‚â€<ul>
<li>ç¬¬ 77 è¡Œï¼šè°ƒç”¨ <code>#allocateHuge(PooledByteBuf&lt;T&gt; buf, int reqCapacity)</code> æ–¹æ³•ï¼Œç”³è¯· Huge å†…å­˜å—ã€‚</li>
</ul>
</li>
</ul>
<h3 id="2-4-1-allocateNormal"><a href="#2-4-1-allocateNormal" class="headerlink" title="2.4.1 allocateNormal"></a>2.4.1 allocateNormal</h3><p><code>#allocateNormal(PooledByteBuf&lt;T&gt; buf, int reqCapacity, int normCapacity)</code> æ–¹æ³•ï¼Œç”³è¯· Normal Page å†…å­˜å—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">   <span class="comment">// Method must be called inside synchronized(this) { ... }&nbsp;block // å¿…é¡»åœ¨ synchronized(this) { ... } ä¸­æ‰§è¡Œ</span></span><br><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">allocateNormal</span><span class="params">(PooledByteBuf&lt;T&gt; buf, <span class="keyword">int</span> reqCapacity, <span class="keyword">int</span> normCapacity)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// æŒ‰ç…§ä¼˜å…ˆçº§ï¼Œä»å¤šä¸ª ChunkList ä¸­ï¼Œåˆ†é… Normal Page å†…å­˜å—ã€‚å¦‚æœæœ‰ä¸€åˆ†é…æˆåŠŸï¼Œè¿”å›</span></span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (q050.allocate(buf, reqCapacity, normCapacity) || q025.allocate(buf, reqCapacity, normCapacity) ||</span><br><span class="line"> <span class="number">4</span>:         q000.allocate(buf, reqCapacity, normCapacity) || qInit.allocate(buf, reqCapacity, normCapacity) ||</span><br><span class="line"> <span class="number">5</span>:         q075.allocate(buf, reqCapacity, normCapacity)) {</span><br><span class="line"> <span class="number">6</span>:         <span class="keyword">return</span>;</span><br><span class="line"> <span class="number">7</span>:     }</span><br><span class="line"> <span class="number">8</span>: </span><br><span class="line"> <span class="number">9</span>:     <span class="comment">// Add a new chunk.</span></span><br><span class="line"><span class="number">10</span>:     <span class="comment">// æ–°å»º Chunk å†…å­˜å—</span></span><br><span class="line"><span class="number">11</span>:     PoolChunk&lt;T&gt; c = newChunk(pageSize, maxOrder, pageShifts, chunkSize);</span><br><span class="line"><span class="number">12</span>:     <span class="comment">// ç”³è¯·å¯¹åº”çš„ Normal Page å†…å­˜å—ã€‚å®é™…ä¸Šï¼Œå¦‚æœç”³è¯·åˆ†é…çš„å†…å­˜ç±»å‹ä¸º tiny æˆ– small ç±»å‹ï¼Œå®é™…ç”³è¯·çš„æ˜¯ Subpage å†…å­˜å—ã€‚</span></span><br><span class="line"><span class="number">13</span>:     <span class="keyword">long</span> handle = c.allocate(normCapacity);</span><br><span class="line"><span class="number">14</span>:     <span class="keyword">assert</span> handle &gt; <span class="number">0</span>;</span><br><span class="line"><span class="number">15</span>:     <span class="comment">// åˆå§‹åŒ– Normal Page / Subpage å†…å­˜å—åˆ° PooledByteBuf å¯¹è±¡ä¸­</span></span><br><span class="line"><span class="number">16</span>:     c.initBuf(buf, handle, reqCapacity);</span><br><span class="line"><span class="number">17</span>:     <span class="comment">// æ·»åŠ åˆ° ChunkList åŒå‘é“¾ä¸­ã€‚</span></span><br><span class="line"><span class="number">18</span>:     qInit.add(c);</span><br><span class="line"><span class="number">19</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>æŒ‰ç…§ä¼˜å…ˆçº§ï¼Œä»å¤šä¸ª ChunkList ä¸­ï¼Œè°ƒç”¨ <code>PoolChunkList#allocate(normCapacity)</code> æ–¹æ³•ï¼Œåˆ†é… Normal Page å†…å­˜å—ã€‚å¦‚æœæœ‰ä¸€åˆ†é…æˆåŠŸï¼Œ<code>return</code> è¿”å›ã€‚å¦‚æœé—å¿˜è¿™ä¸ªè¿‡ç¨‹çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-4-Jemalloc-chunkList">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆå››ï¼‰PoolChunkListã€‹</a> çš„ <a href="#">ã€Œ2.2 allocateã€</a> ã€‚</p>
<blockquote>
<p>FROM <a href="https://www.jianshu.com/p/4856bd30dd56" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥æµ…å‡ºNettyå†…å­˜ç®¡ç† PoolArenaã€‹</a></p>
<p>åˆ†é…å†…å­˜æ—¶ï¼Œä¸ºä»€ä¹ˆä¸ä»å†…å­˜ä½¿ç”¨ç‡è¾ƒä½çš„ <code>q000</code> å¼€å§‹ï¼Ÿåœ¨ ChunkList ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ä¸€ä¸ª chunk éšç€å†…å­˜çš„é‡Šæ”¾ï¼Œä¼šå¾€å½“å‰ ChunkList çš„å‰ä¸€ä¸ªèŠ‚ç‚¹ç§»åŠ¨ã€‚</p>
<p><strong><code>q000</code> å­˜åœ¨çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ</strong></p>
<p><code>q000</code> æ˜¯ç”¨æ¥ä¿å­˜å†…å­˜åˆ©ç”¨ç‡åœ¨ <code>1%-50%</code> çš„ chunk ï¼Œé‚£ä¹ˆè¿™é‡Œä¸ºä»€ä¹ˆä¸åŒ…æ‹¬ <code>0%</code> çš„chunkï¼Ÿ<br>ç›´æ¥å¼„æ¸…æ¥šè¿™äº›ï¼Œæ‰å¥½ç†è§£ä¸ºä»€ä¹ˆä¸ä» <code>q000</code> å¼€å§‹åˆ†é…ã€‚`q000  ä¸­çš„chunkï¼Œå½“å†…å­˜åˆ©ç”¨ç‡ä¸º 0 æ—¶ï¼Œå°±ä»é“¾è¡¨ä¸­åˆ é™¤ï¼Œç›´æ¥é‡Šæ”¾ç‰©ç†å†…å­˜ï¼Œé¿å…è¶Šæ¥è¶Šå¤šçš„ chunk å¯¼è‡´å†…å­˜è¢«å æ»¡ã€‚</p>
<p>æƒ³è±¡ä¸€ä¸ªåœºæ™¯ï¼Œå½“åº”ç”¨åœ¨å®é™…è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç¢°åˆ°è®¿é—®é«˜å³°ï¼Œè¿™æ—¶éœ€è¦åˆ†é…çš„å†…å­˜æ˜¯å¹³æ—¶çš„å¥½å‡ å€ï¼Œå½“ç„¶ä¹Ÿéœ€è¦åˆ›å»ºå¥½å‡ å€çš„ chunk ï¼Œå¦‚æœå…ˆä» <code>q0000</code> å¼€å§‹ï¼Œè¿™äº›åœ¨é«˜å³°æœŸåˆ›å»ºçš„ chunk è¢«å›æ”¶çš„æ¦‚ç‡ä¼šå¤§å¤§é™ä½ï¼Œå»¶ç¼“äº†å†…å­˜çš„å›æ”¶è¿›åº¦ï¼Œé€ æˆå†…å­˜ä½¿ç”¨çš„æµªè´¹ã€‚</p>
<p><strong>é‚£ä¹ˆä¸ºä»€ä¹ˆé€‰æ‹©ä» <code>q050</code> å¼€å§‹ï¼Ÿ</strong></p>
<ul>
<li>1ã€<code>q050</code> ä¿å­˜çš„æ˜¯å†…å­˜åˆ©ç”¨ç‡ <code>50%~100%</code> çš„ chunk ï¼Œè¿™åº”è¯¥æ˜¯ä¸ªæŠ˜ä¸­çš„é€‰æ‹©ï¼è¿™æ ·å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œchunk çš„åˆ©ç”¨ç‡éƒ½ä¼šä¿æŒåœ¨ä¸€ä¸ªè¾ƒé«˜æ°´å¹³ï¼Œæé«˜æ•´ä¸ªåº”ç”¨çš„å†…å­˜åˆ©ç”¨ç‡ï¼›</li>
<li>2ã€<code>qinit</code> çš„ chunk åˆ©ç”¨ç‡ä½ï¼Œä½†ä¸ä¼šè¢«å›æ”¶ï¼›</li>
<li>3ã€<code>q075</code> å’Œ <code>q100</code> ç”±äºå†…å­˜åˆ©ç”¨ç‡å¤ªé«˜ï¼Œå¯¼è‡´å†…å­˜åˆ†é…çš„æˆåŠŸç‡å¤§å¤§é™ä½ï¼Œå› æ­¤æ”¾åˆ°æœ€åï¼›</li>
</ul>
</blockquote>
</li>
<li><p>ç¬¬ 11 è¡Œï¼šè°ƒç”¨ <code>#newChunk(pageSize, maxOrder, pageShifts, chunkSize)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œæ–°å»º Chunk å†…å­˜å—ã€‚éœ€è¦ PoolArea å­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> PoolChunk&lt;T&gt; <span class="title">newChunk</span><span class="params">(<span class="keyword">int</span> pageSize, <span class="keyword">int</span> maxOrder, <span class="keyword">int</span> pageShifts, <span class="keyword">int</span> chunkSize)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 13 è¡Œï¼šè°ƒç”¨æ–°ç”³è¯·çš„ Chunk å†…å­˜å—çš„ <code>PoolChunk#allocate(normCapacity)</code> æ–¹æ³•ï¼Œç”³è¯·å¯¹åº”çš„ Normal Page å†…å­˜å—ã€‚å®é™…ä¸Šï¼Œå¦‚æœç”³è¯·åˆ†é…çš„å†…å­˜ç±»å‹ä¸º tiny æˆ– small ç±»å‹ï¼Œå®é™…ç”³è¯·çš„æ˜¯ Subpage å†…å­˜å—ã€‚å¦‚æœé—å¿˜è¿™ä¸ªè¿‡ç¨‹çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-2-Jemalloc-chunk">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆäºŒï¼‰PoolChunkã€‹</a> çš„ <a href="#">ã€Œ2.2 allocateã€</a> ã€‚<ul>
<li>ç¬¬ 16 è¡Œï¼šè°ƒç”¨ <code>PoolChunk#initBuf(buf, handle, reqCapacity)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Normal Page / Subpage å†…å­˜å—åˆ° PooledByteBuf å¯¹è±¡ä¸­ã€‚</li>
</ul>
</li>
<li>ç¬¬ 18 è¡Œï¼šè°ƒç”¨ <code>PoolChunkList#add(PoolChunk)</code> æ–¹æ³•ï¼Œæ·»åŠ åˆ° ChunkList åŒå‘é“¾ä¸­ã€‚</li>
</ul>
</li>
</ul>
<h3 id="2-4-2-allocateHuge"><a href="#2-4-2-allocateHuge" class="headerlink" title="2.4.2 allocateHuge"></a>2.4.2 allocateHuge</h3><p><code>#allocateHuge(PooledByteBuf&lt;T&gt; buf, int reqCapacity)</code> æ–¹æ³•ï¼Œç”³è¯· Huge å†…å­˜å—ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">allocateHuge</span><span class="params">(PooledByteBuf&lt;T&gt; buf, <span class="keyword">int</span> reqCapacity)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// æ–°å»º Chunk å†…å­˜å—ï¼Œå®ƒæ˜¯ unpooled çš„</span></span><br><span class="line"> <span class="number">3</span>:     PoolChunk&lt;T&gt; chunk = newUnpooledChunk(reqCapacity);</span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// å¢åŠ  activeBytesHuge</span></span><br><span class="line"> <span class="number">5</span>:     activeBytesHuge.add(chunk.chunkSize());</span><br><span class="line"> <span class="number">6</span>:     <span class="comment">// åˆå§‹åŒ– Huge å†…å­˜å—åˆ° PooledByteBuf å¯¹è±¡ä¸­</span></span><br><span class="line"> <span class="number">7</span>:     buf.initUnpooled(chunk, reqCapacity);</span><br><span class="line"> <span class="number">8</span>:     <span class="comment">// å¢åŠ  allocationsHuge</span></span><br><span class="line"> <span class="number">9</span>:     allocationsHuge.increment();</span><br><span class="line"><span class="number">10</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ç¬¬ 3 è¡Œï¼šè°ƒç”¨ <code>#newUnpooledChunk(int capacity)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œæ–°å»º <strong>unpooled</strong> Chunk å†…å­˜å—ã€‚éœ€è¦ PoolArea å­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> PoolChunk&lt;T&gt; <span class="title">newUnpooledChunk</span><span class="params">(<span class="keyword">int</span> capacity)</span></span>; <span class="comment">//</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ç¬¬ 7 è¡Œï¼šè°ƒç”¨ <code>PoolChunk#initUnpooled(chunk, reqCapacity)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Huge å†…å­˜å—åˆ° PooledByteBuf å¯¹è±¡ä¸­ã€‚</p>
</li>
<li>ç¬¬ 5 è¡Œï¼šå¢åŠ  <code>activeBytesHuge</code> è®¡æ•°ã€‚</li>
<li>ç¬¬ 9 è¡Œï¼šå¢åŠ  <code>allocationsHuge</code> è®¡æ•°ã€‚</li>
</ul>
<h2 id="2-5-reallocate"><a href="#2-5-reallocate" class="headerlink" title="2.5 reallocate"></a>2.5 reallocate</h2><p><code>#reallocate(PooledByteBuf&lt;T&gt; buf, int newCapacity, boolean freeOldMemor)</code> æ–¹æ³•ï¼Œå› ä¸ºè¦æ‰©å®¹æˆ–ç¼©å®¹ï¼Œæ‰€ä»¥é‡æ–°åˆ†é…åˆé€‚çš„å†…å­˜å—ç»™ PooledByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">void</span> <span class="title">reallocate</span><span class="params">(PooledByteBuf&lt;T&gt; buf, <span class="keyword">int</span> newCapacity, <span class="keyword">boolean</span> freeOldMemory)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (newCapacity &lt; <span class="number">0</span> || newCapacity &gt; buf.maxCapacity()) {</span><br><span class="line"> <span class="number">3</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"newCapacity: "</span> + newCapacity);</span><br><span class="line"> <span class="number">4</span>:     }</span><br><span class="line"> <span class="number">5</span>: </span><br><span class="line"> <span class="number">6</span>:     <span class="comment">// å®¹é‡å¤§å°æ²¡æœ‰å˜åŒ–ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line"> <span class="number">7</span>:     <span class="keyword">int</span> oldCapacity = buf.length;</span><br><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (oldCapacity == newCapacity) {</span><br><span class="line"> <span class="number">9</span>:         <span class="keyword">return</span>;</span><br><span class="line"><span class="number">10</span>:     }</span><br><span class="line"><span class="number">11</span>: </span><br><span class="line"><span class="number">12</span>:     <span class="comment">// è®°å½•è€çš„å†…å­˜å—çš„ä¿¡æ¯</span></span><br><span class="line"><span class="number">13</span>:     PoolChunk&lt;T&gt; oldChunk = buf.chunk;</span><br><span class="line"><span class="number">14</span>:     <span class="keyword">long</span> oldHandle = buf.handle;</span><br><span class="line"><span class="number">15</span>:     T oldMemory = buf.memory;</span><br><span class="line"><span class="number">16</span>:     <span class="keyword">int</span> oldOffset = buf.offset;</span><br><span class="line"><span class="number">17</span>:     <span class="keyword">int</span> oldMaxLength = buf.maxLength;</span><br><span class="line"><span class="number">18</span>: </span><br><span class="line"><span class="number">19</span>:     <span class="comment">// è®°å½•è¯»å†™ç´¢å¼•</span></span><br><span class="line"><span class="number">20</span>:     <span class="keyword">int</span> readerIndex = buf.readerIndex();</span><br><span class="line"><span class="number">21</span>:     <span class="keyword">int</span> writerIndex = buf.writerIndex();</span><br><span class="line"><span class="number">22</span>: </span><br><span class="line"><span class="number">23</span>:     <span class="comment">// åˆ†é…æ–°çš„å†…å­˜å—ç»™ PooledByteBuf å¯¹è±¡</span></span><br><span class="line"><span class="number">24</span>:     allocate(parent.threadCache(), buf, newCapacity);</span><br><span class="line"><span class="number">25</span>: </span><br><span class="line"><span class="number">26</span>:     <span class="comment">// æ‰©å®¹</span></span><br><span class="line"><span class="number">27</span>:     <span class="keyword">if</span> (newCapacity &gt; oldCapacity) {</span><br><span class="line"><span class="number">28</span>:         <span class="comment">// å°†è€çš„å†…å­˜å—çš„æ•°æ®ï¼Œå¤åˆ¶åˆ°æ–°çš„å†…å­˜å—ä¸­</span></span><br><span class="line"><span class="number">29</span>:         memoryCopy(</span><br><span class="line"><span class="number">30</span>:                 oldMemory, oldOffset,</span><br><span class="line"><span class="number">31</span>:                 buf.memory, buf.offset, oldCapacity);</span><br><span class="line"><span class="number">32</span>:     <span class="comment">// ç¼©å®¹</span></span><br><span class="line"><span class="number">33</span>:     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">34</span>:         <span class="comment">// æœ‰éƒ¨åˆ†æ•°æ®æœªè¯»å–å®Œ</span></span><br><span class="line"><span class="number">35</span>:         <span class="keyword">if</span> (readerIndex &lt; newCapacity) {</span><br><span class="line"><span class="number">36</span>:             <span class="comment">// å¦‚æœ writerIndex å¤§äº newCapacity ï¼Œé‡ç½®ä¸º newCapacity ï¼Œé¿å…è¶Šç•Œ</span></span><br><span class="line"><span class="number">37</span>:             <span class="keyword">if</span> (writerIndex &gt; newCapacity) {</span><br><span class="line"><span class="number">38</span>:                 writerIndex = newCapacity;</span><br><span class="line"><span class="number">39</span>:             }</span><br><span class="line"><span class="number">40</span>:             <span class="comment">// å°†è€çš„å†…å­˜å—çš„æ•°æ®ï¼Œå¤åˆ¶åˆ°æ–°çš„å†…å­˜å—ä¸­</span></span><br><span class="line"><span class="number">41</span>:             memoryCopy(</span><br><span class="line"><span class="number">42</span>:                     oldMemory, oldOffset + readerIndex,</span><br><span class="line"><span class="number">43</span>:                     buf.memory, buf.offset + readerIndex, writerIndex - readerIndex);</span><br><span class="line"><span class="number">44</span>:         <span class="comment">// å…¨éƒ¨è¯»å®Œï¼Œé‡ç½® readerIndex å’Œ writerIndex ä¸º newCapacity ï¼Œé¿å…è¶Šç•Œ</span></span><br><span class="line"><span class="number">45</span>:         } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">46</span>:             readerIndex = writerIndex = newCapacity;</span><br><span class="line"><span class="number">47</span>:         }</span><br><span class="line"><span class="number">48</span>:     }</span><br><span class="line"><span class="number">49</span>: </span><br><span class="line"><span class="number">50</span>:     <span class="comment">// è®¾ç½®è¯»å†™ç´¢å¼•</span></span><br><span class="line"><span class="number">51</span>:     buf.setIndex(readerIndex, writerIndex);</span><br><span class="line"><span class="number">52</span>: </span><br><span class="line"><span class="number">53</span>:     <span class="comment">// é‡Šæ”¾è€çš„å†…å­˜å—</span></span><br><span class="line"><span class="number">54</span>:     <span class="keyword">if</span> (freeOldMemory) {</span><br><span class="line"><span class="number">55</span>:         free(oldChunk, oldHandle, oldMaxLength, buf.cache);</span><br><span class="line"><span class="number">56</span>:     }</span><br><span class="line"><span class="number">57</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 2 è‡³ 4 è¡Œï¼šæ–°çš„å®¹é‡( <code>newCapacity</code> ) ï¼Œä¸èƒ½<strong>è¶…è¿‡</strong> PooledByteBuf å¯¹è±¡çš„å¯åˆ†é…çš„æœ€å¤§å®¹é‡( <code>maxCapacity</code> ) ã€‚</li>
<li>ç¬¬ 6 è‡³ 10 è¡Œï¼šå®¹é‡å¤§å°æ²¡æœ‰å˜åŒ–ï¼Œç›´æ¥è¿”å›ã€‚</li>
<li>ç¬¬ 12 è‡³ 17 è¡Œï¼šè®°å½•<strong>è€çš„</strong>å†…å­˜å—çš„ä¿¡æ¯ã€‚<ul>
<li>ç¬¬ 20 è‡³ 21 è¡Œï¼šè®°å½•è¯»å†™ç´¢å¼•ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 26 è‡³ 31 è¡Œï¼šå®¹é‡å˜å¤§ï¼Œè¯´æ˜æ˜¯æ‰©å®¹ï¼Œè°ƒç”¨ <code>#memoryCopy(T src, int srcOffset, T dst, int dstOffset, int length)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå°†è€çš„å†…å­˜å—çš„æ•°æ®( æ­¤å¤„çš„å¤åˆ¶ï¼Œæ˜¯å…¨éƒ¨æ•°æ® )ï¼Œ<strong>å¤åˆ¶åˆ°æ–°çš„å†…å­˜å—ä¸­</strong>ã€‚éœ€è¦ PoolArea å­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">memoryCopy</span><span class="params">(T src, <span class="keyword">int</span> srcOffset, T dst, <span class="keyword">int</span> dstOffset, <span class="keyword">int</span> length)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ç¬¬ 33 è‡³ 48 è¡Œï¼šå®¹é‡å˜å°ï¼Œè¯´æ˜æ˜¯ç¼©å®¹ã€‚</p>
<ul>
<li>ç¬¬ 34 è‡³ 44 è¡Œï¼šæœ‰<strong>éƒ¨åˆ†</strong>æ•°æ®<strong>æœªè¯»å–å®Œ</strong>ï¼Œè°ƒç”¨ <code>#memoryCopy(T src, int srcOffset, T dst, int dstOffset, int length)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå°†è€çš„å†…å­˜å—çš„æ•°æ®( æ­¤å¤„çš„å¤åˆ¶ï¼Œæ˜¯å…¨éƒ¨æ•°æ® )ï¼Œå¤åˆ¶åˆ°æ–°çš„å†…å­˜å—ä¸­ã€‚ğŸ˜ˆ æ³¨æ„ï¼Œ<strong>æ­¤å¤„å¤åˆ¶çš„åªæœ‰æœªè¯»å–å®Œçš„éƒ¨åˆ†æ•°æ®</strong>ã€‚<ul>
<li>ç¬¬ 36 è‡³ 39 è¡Œï¼šå¦‚æœ <code>writerIndex</code> å¤§äº <code>newCapacity</code> ï¼Œé‡ç½®ä¸º <code>newCapacity</code> ï¼Œé¿å…è¶Šç•Œã€‚</li>
</ul>
</li>
<li>ç¬¬ 44 è‡³ 47 è¡Œï¼šå…¨éƒ¨è¯»å®Œï¼Œ<strong>æ— éœ€å¤åˆ¶</strong>ã€‚<ul>
<li>ç¬¬ 46 è¡Œ: å…¨éƒ¨è¯»å®Œï¼Œé‡ç½® <code>readerIndex</code> å’Œ <code>writerIndex</code> ä¸º <code>newCapacity</code> ï¼Œé¿å…è¶Šç•Œã€‚ </li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 51 è¡Œï¼šè®¾ç½®è¯»å†™ç´¢å¼•ã€‚</li>
<li>ç¬¬ 53 è‡³ 56 è¡Œï¼šå¦‚æœéœ€è¦é‡Šæ”¾è€çš„å†…å­˜å—( <code>freeOldMemory</code> ä¸º <code>true</code> ) æ—¶ï¼Œè°ƒç”¨ <code>#free(PoolChunk&lt;T&gt; chunk, long handle, int normCapacity, PoolThreadCache cache)</code> æ–¹æ³•ï¼Œè¿›è¡Œé‡Šæ”¾ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.6 freeã€</a> ã€‚</li>
</ul>
<h2 id="2-6-free"><a href="#2-6-free" class="headerlink" title="2.6 free"></a>2.6 free</h2><p><code>#free(PoolChunk&lt;T&gt; chunk, long handle, int normCapacity, PoolThreadCache cache)</code> æ–¹æ³•ï¼Œé‡Šæ”¾å†…å­˜å—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(PoolChunk&lt;T&gt; chunk, <span class="keyword">long</span> handle, <span class="keyword">int</span> normCapacity, PoolThreadCache cache)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (chunk.unpooled) {</span><br><span class="line"> <span class="number">3</span>:         <span class="keyword">int</span> size = chunk.chunkSize();</span><br><span class="line"> <span class="number">4</span>:         <span class="comment">// ç›´æ¥é”€æ¯ Chunk å†…å­˜å—ï¼Œå› ä¸ºå ç”¨ç©ºé—´è¾ƒå¤§</span></span><br><span class="line"> <span class="number">5</span>:         destroyChunk(chunk);</span><br><span class="line"> <span class="number">6</span>:         <span class="comment">// å‡å°‘ activeBytesHuge è®¡æ•°</span></span><br><span class="line"> <span class="number">7</span>:         activeBytesHuge.add(-size);</span><br><span class="line"> <span class="number">8</span>:         <span class="comment">// å‡å°‘ deallocationsHuge è®¡æ•°</span></span><br><span class="line"> <span class="number">9</span>:         deallocationsHuge.increment();</span><br><span class="line"><span class="number">10</span>:     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">11</span>:         <span class="comment">// è®¡ç®—å†…å­˜çš„ SizeClass</span></span><br><span class="line"><span class="number">12</span>:         SizeClass sizeClass = sizeClass(normCapacity);</span><br><span class="line"><span class="number">13</span>:         <span class="comment">// æ·»åŠ å†…å­˜å—åˆ° PoolThreadCache ç¼“å­˜</span></span><br><span class="line"><span class="number">14</span>:         <span class="keyword">if</span> (cache != <span class="keyword">null</span> &amp;&amp; cache.add(<span class="keyword">this</span>, chunk, handle, normCapacity, sizeClass)) {</span><br><span class="line"><span class="number">15</span>:             <span class="comment">// cached so not free it.</span></span><br><span class="line"><span class="number">16</span>:             <span class="keyword">return</span>;</span><br><span class="line"><span class="number">17</span>:         }</span><br><span class="line"><span class="number">18</span>:         <span class="comment">// é‡Šæ”¾ Page / Subpage å†…å­˜å—å› Chunk ä¸­</span></span><br><span class="line"><span class="number">19</span>:         freeChunk(chunk, handle, sizeClass);</span><br><span class="line"><span class="number">20</span>:     }</span><br><span class="line"><span class="number">21</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 2 è‡³ 9 è¡Œï¼š<strong>unpooled</strong> ç±»å‹çš„ Chunk å¯¹è±¡ï¼Œç›®å‰æ˜¯ Huge å†…å­˜å—ã€‚<ul>
<li>ç¬¬ 5 è¡Œï¼šè°ƒç”¨ <code>#destroyChunk(PoolChunk&lt;T&gt; chunk)</code> æ–¹æ³•ï¼Œç›´æ¥é”€æ¯ Chunk å†…å­˜å—ï¼Œå› ä¸ºå ç”¨ç©ºé—´è¾ƒå¤§ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.7 finalizeã€</a> ã€‚</li>
<li>ç¬¬ 6 è‡³ 9 è¡Œï¼šå‡å°‘ <code>activeBytesHuge</code>ã€<code>deallocationsHuge</code> è®¡æ•°ã€‚</li>
</ul>
</li>
<li>ç¬¬ 10 è‡³ 20 è¡Œï¼š<strong>pooled</strong> ç±»å‹çš„ Chunk å¯¹è±¡ï¼Œç›®å‰æ˜¯ Page / Subpage å†…å­˜å—ã€‚<ul>
<li>ç¬¬ 12 è¡Œï¼šè°ƒç”¨ <code>#size(normCapacity)</code> æ–¹æ³•ï¼Œè®¡ç®—å†…å­˜çš„ SizeClass å†…å­˜ç±»å‹ã€‚</li>
<li>ç¬¬ 12 è¡Œï¼šè®¡ç®—å†…å­˜çš„ SizeClass ã€‚</li>
<li>ç¬¬ 13 è‡³ 17 è¡Œï¼šè°ƒç”¨ <code>PoolThreadCache#add(PoolArena&lt;?&gt; area, PoolChunk chunk, long handle, int normCapacity, SizeClass sizeClass)</code> æ–¹æ³•ï¼Œæ·»åŠ å†…å­˜å—åˆ° PoolThreadCache çš„æŒ‡å®š MemoryRegionCache çš„é˜Ÿåˆ—ä¸­ï¼Œè¿›è¡Œç¼“å­˜ã€‚å¹¶ä¸”ï¼Œè¿”å›æ˜¯å¦æ·»åŠ æˆåŠŸã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-6-Jemalloc-ThreadCache/">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆå…­ï¼‰PoolThreadCacheã€‹</a> ã€‚</li>
<li>ç¬¬ 19 è¡Œï¼šè°ƒç”¨ <code>#freeChunk(PoolChunk&lt;T&gt; chunk, long handle, SizeClass sizeClass)</code> æ–¹æ³•ï¼Œé‡Šæ”¾æŒ‡å®šä½ç½®çš„ Page / Subpage å†…å­˜å—å› Chunk ä¸­ã€‚</li>
</ul>
</li>
</ul>
<h3 id="2-6-1-freeChunk"><a href="#2-6-1-freeChunk" class="headerlink" title="2.6.1 freeChunk"></a>2.6.1 freeChunk</h3><p><code>#freeChunk(PoolChunk&lt;T&gt; chunk, long handle, SizeClass sizeClass)</code> æ–¹æ³•ï¼Œé‡Šæ”¾æŒ‡å®šä½ç½®çš„ Page / Subpage å†…å­˜å—å› Chunk ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">void</span> <span class="title">freeChunk</span><span class="params">(PoolChunk&lt;T&gt; chunk, <span class="keyword">long</span> handle, SizeClass sizeClass)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> destroyChunk;</span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">synchronized</span> (<span class="keyword">this</span>) { <span class="comment">// é”ï¼Œé¿å…å¹¶å‘</span></span><br><span class="line"> <span class="number">4</span>:         <span class="comment">// å‡å°ç›¸åº”çš„è®¡æ•°</span></span><br><span class="line"> <span class="number">5</span>:         <span class="keyword">switch</span> (sizeClass) {</span><br><span class="line"> <span class="number">6</span>:         <span class="keyword">case</span> Normal:</span><br><span class="line"> <span class="number">7</span>:             ++deallocationsNormal;</span><br><span class="line"> <span class="number">8</span>:             <span class="keyword">break</span>;</span><br><span class="line"> <span class="number">9</span>:         <span class="keyword">case</span> Small:</span><br><span class="line"><span class="number">10</span>:             ++deallocationsSmall;</span><br><span class="line"><span class="number">11</span>:             <span class="keyword">break</span>;</span><br><span class="line"><span class="number">12</span>:         <span class="keyword">case</span> Tiny:</span><br><span class="line"><span class="number">13</span>:             ++deallocationsTiny;</span><br><span class="line"><span class="number">14</span>:             <span class="keyword">break</span>;</span><br><span class="line"><span class="number">15</span>:         <span class="keyword">default</span>:</span><br><span class="line"><span class="number">16</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> Error();</span><br><span class="line"><span class="number">17</span>:         }</span><br><span class="line"><span class="number">18</span>:         <span class="comment">// é‡Šæ”¾æŒ‡å®šä½ç½®çš„å†…å­˜å—</span></span><br><span class="line"><span class="number">19</span>:         destroyChunk = !chunk.parent.free(chunk, handle);</span><br><span class="line"><span class="number">20</span>:     }</span><br><span class="line"><span class="number">21</span>:     <span class="comment">// å½“ destroyChunk ä¸º true æ—¶ï¼Œæ„å‘³ç€ Chunk ä¸­ä¸å­˜åœ¨åœ¨ä½¿ç”¨çš„ Page / Subpage å†…å­˜å—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå†…å­˜ä½¿ç”¨ç‡ä¸º 0 ï¼Œæ‰€ä»¥é”€æ¯ Chunk</span></span><br><span class="line"><span class="number">22</span>:     <span class="keyword">if</span> (destroyChunk) {</span><br><span class="line"><span class="number">23</span>:         <span class="comment">// destroyChunk not need to be called while holding the synchronized lock.</span></span><br><span class="line"><span class="number">24</span>:         destroyChunk(chunk);</span><br><span class="line"><span class="number">25</span>:     }</span><br><span class="line"><span class="number">26</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 4 è‡³ 17 è¡Œï¼šå‡å°<strong>ç›¸åº”</strong>çš„è®¡æ•°ã€‚</li>
<li>ç¬¬ 19 è¡Œï¼šè°ƒç”¨ Chunk å¯¹è±¡æ‰€åœ¨çš„ ChunList çš„ <code>ChunkList#free(chunk, handle)</code> æ–¹æ³•ï¼Œé‡Šæ”¾æŒ‡å®šä½ç½®çš„å†…å­˜å—ã€‚å¦‚æœé—å¿˜è¿™ä¸ªè¿‡ç¨‹çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-4-Jemalloc-chunkList">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆå››ï¼‰PoolChunkListã€‹</a> çš„ <a href="#">ã€Œ2.3 freeã€</a> ã€‚</li>
<li>ç¬¬ 21 è‡³ 25 è¡Œï¼šå½“ <code>destroyChunk</code> ä¸º <code>true</code> æ—¶ï¼Œæ„å‘³ç€ Chunk ä¸­ä¸å­˜åœ¨åœ¨ä½¿ç”¨çš„ Page / Subpage å†…å­˜å—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå†…å­˜ä½¿ç”¨ç‡ä¸º 0 ï¼Œæ‰€ä»¥è°ƒç”¨ <code>#destroyChunk(PoolChunk&lt;T&gt; chunk)</code> æ–¹æ³•ï¼Œç›´æ¥é”€æ¯ Chunk å†…å­˜å—ï¼Œå›æ”¶å¯¹åº”çš„ç©ºé—´ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.7 finalizeã€</a> ã€‚</li>
</ul>
<h2 id="2-7-finalize"><a href="#2-7-finalize" class="headerlink" title="2.7 finalize"></a>2.7 finalize</h2><p>åœ¨ PoolArena å¯¹è±¡è¢« GC å›æ”¶æ—¶ï¼Œæ¸…ç†å…¶ç®¡ç†çš„å†…å­˜ã€‚ğŸ˜ˆ å®é™…ä¸Šï¼Œä¸»è¦æ˜¯ä¸ºäº†æ¸…ç†å¯¹å¤–å†…å­˜ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// è°ƒç”¨çˆ¶æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">super</span>.finalize();</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        <span class="comment">// æ¸…ç† tiny Subpage ä»¬</span></span><br><span class="line">        destroyPoolSubPages(smallSubpagePools);</span><br><span class="line">        <span class="comment">// æ¸…ç† small Subpage ä»¬</span></span><br><span class="line">        destroyPoolSubPages(tinySubpagePools);</span><br><span class="line">        <span class="comment">// æ¸…ç† ChunkList ä»¬</span></span><br><span class="line">        destroyPoolChunkLists(qInit, q000, q025, q050, q075, q100);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">destroyPoolSubPages</span><span class="params">(PoolSubpage&lt;?&gt;[] pages)</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (PoolSubpage&lt;?&gt; page : pages) {</span><br><span class="line">        page.destroy();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">destroyPoolChunkLists</span><span class="params">(PoolChunkList&lt;T&gt;... chunkLists)</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (PoolChunkList&lt;T&gt; chunkList: chunkLists) {</span><br><span class="line">        chunkList.destroy(<span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-8-PoolArenaMetric"><a href="#2-8-PoolArenaMetric" class="headerlink" title="2.8 PoolArenaMetric"></a>2.8 PoolArenaMetric</h2><blockquote>
<p>è€è‰¿è‰¿ï¼šè¿™ä¸ªå°èŠ‚ï¼Œä¸»è¦æ˜¯è¯»å– Metric æ•°æ®çš„æ–¹æ³•ï¼Œå¿«é€Ÿæµè§ˆæˆ–è·³è¿‡éƒ½å¯ä»¥ã€‚</p>
</blockquote>
<p><code>io.netty.buffer.PoolArenaMetric</code> ï¼ŒPoolArena Metric æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PoolArenaMetric</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the number of thread caches backed by this arena.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">numThreadCaches</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the number of tiny sub-pages for the arena.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">numTinySubpages</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the number of small sub-pages for the arena.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">numSmallSubpages</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the number of chunk lists for the arena.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">numChunkLists</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns an unmodifiable {<span class="doctag">@link</span> List} which holds {<span class="doctag">@link</span> PoolSubpageMetric}s for tiny sub-pages.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;PoolSubpageMetric&gt; <span class="title">tinySubpages</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns an unmodifiable {<span class="doctag">@link</span> List} which holds {<span class="doctag">@link</span> PoolSubpageMetric}s for small sub-pages.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;PoolSubpageMetric&gt; <span class="title">smallSubpages</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns an unmodifiable {<span class="doctag">@link</span> List} which holds {<span class="doctag">@link</span> PoolChunkListMetric}s.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">List&lt;PoolChunkListMetric&gt; <span class="title">chunkLists</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of allocations done via the arena. This includes all sizes.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">numAllocations</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of tiny allocations done via the arena.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">numTinyAllocations</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of small allocations done via the arena.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">numSmallAllocations</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of normal allocations done via the arena.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">numNormalAllocations</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of huge allocations done via the arena.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">numHugeAllocations</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of deallocations done via the arena. This includes all sizes.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">numDeallocations</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of tiny deallocations done via the arena.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">numTinyDeallocations</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of small deallocations done via the arena.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">numSmallDeallocations</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of normal deallocations done via the arena.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">numNormalDeallocations</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of huge deallocations done via the arena.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">numHugeDeallocations</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of currently active allocations.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">numActiveAllocations</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of currently active tiny allocations.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">numActiveTinyAllocations</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of currently active small allocations.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">numActiveSmallAllocations</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of currently active normal allocations.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">numActiveNormalAllocations</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of currently active huge allocations.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">numActiveHugeAllocations</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of active bytes that are currently allocated by the arena.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">numActiveBytes</span><span class="params">()</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p>PoolArena å¯¹ PoolArenaMetric æ¥å£çš„å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numThreadCaches</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> numThreadCaches.get();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numTinySubpages</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> tinySubpagePools.length;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numSmallSubpages</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> smallSubpagePools.length;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numChunkLists</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> chunkListMetrics.size();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;PoolSubpageMetric&gt; <span class="title">tinySubpages</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> subPageMetricList(tinySubpagePools);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;PoolSubpageMetric&gt; <span class="title">smallSubpages</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> subPageMetricList(smallSubpagePools);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;PoolChunkListMetric&gt; <span class="title">chunkLists</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> chunkListMetrics;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;PoolSubpageMetric&gt; <span class="title">subPageMetricList</span><span class="params">(PoolSubpage&lt;?&gt;[] pages)</span> </span>{</span><br><span class="line">    List&lt;PoolSubpageMetric&gt; metrics = <span class="keyword">new</span> ArrayList&lt;PoolSubpageMetric&gt;();</span><br><span class="line">    <span class="keyword">for</span> (PoolSubpage&lt;?&gt; head : pages) {</span><br><span class="line">        <span class="keyword">if</span> (head.next == head) {</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line">        PoolSubpage&lt;?&gt; s = head.next;</span><br><span class="line">        <span class="keyword">for</span> (;;) {</span><br><span class="line">            metrics.add(s);</span><br><span class="line">            s = s.next;</span><br><span class="line">            <span class="keyword">if</span> (s == head) {</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> metrics;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">numAllocations</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> allocsNormal;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</span><br><span class="line">        allocsNormal = allocationsNormal;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> allocationsTiny.value() + allocationsSmall.value() + allocsNormal + allocationsHuge.value();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">numTinyAllocations</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> allocationsTiny.value();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">numSmallAllocations</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> allocationsSmall.value();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">long</span> <span class="title">numNormalAllocations</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> allocationsNormal;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">numDeallocations</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> deallocs;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</span><br><span class="line">        deallocs = deallocationsTiny + deallocationsSmall + deallocationsNormal;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> deallocs + deallocationsHuge.value();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">long</span> <span class="title">numTinyDeallocations</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> deallocationsTiny;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">long</span> <span class="title">numSmallDeallocations</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> deallocationsSmall;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">long</span> <span class="title">numNormalDeallocations</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> deallocationsNormal;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">numHugeAllocations</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> allocationsHuge.value();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">numHugeDeallocations</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> deallocationsHuge.value();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span>  <span class="keyword">long</span> <span class="title">numActiveAllocations</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">long</span> val = allocationsTiny.value() + allocationsSmall.value() + allocationsHuge.value()</span><br><span class="line">            - deallocationsHuge.value();</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</span><br><span class="line">        val += allocationsNormal - (deallocationsTiny + deallocationsSmall + deallocationsNormal);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> max(val, <span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">numActiveTinyAllocations</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> max(numTinyAllocations() - numTinyDeallocations(), <span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">numActiveSmallAllocations</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> max(numSmallAllocations() - numSmallDeallocations(), <span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">numActiveNormalAllocations</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> val;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</span><br><span class="line">        val = allocationsNormal - deallocationsNormal;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> max(val, <span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">numActiveHugeAllocations</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> max(numHugeAllocations() - numHugeDeallocations(), <span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">numActiveBytes</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">long</span> val = activeBytesHuge.value();</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; chunkListMetrics.size(); i++) {</span><br><span class="line">            <span class="keyword">for</span> (PoolChunkMetric m: chunkListMetrics.get(i)) {</span><br><span class="line">                val += m.chunkSize();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> max(<span class="number">0</span>, val);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-8-1-incTinySmallAllocation"><a href="#2-8-1-incTinySmallAllocation" class="headerlink" title="2.8.1 incTinySmallAllocation"></a>2.8.1 incTinySmallAllocation</h3><p><code>#incTinySmallAllocation(boolean tiny)</code> æ–¹æ³•ï¼Œå¢åŠ  <code>allocationsTiny</code> æˆ– <code>allocationsSmall</code> è®¡æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">incTinySmallAllocation</span><span class="params">(<span class="keyword">boolean</span> tiny)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (tiny) {</span><br><span class="line">        allocationsTiny.increment();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        allocationsSmall.increment();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-9-æŠ½è±¡æ–¹æ³•"><a href="#2-9-æŠ½è±¡æ–¹æ³•" class="headerlink" title="2.9 æŠ½è±¡æ–¹æ³•"></a>2.9 æŠ½è±¡æ–¹æ³•</h2><p>è™½ç„¶ä¸Šæ–‡ä¸­ï¼Œå·²ç»æåˆ°äº†å‡ ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œè¿™é‡Œè¿˜æ˜¯åŒä¸€æ•´ç†å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isDirect</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> PoolChunk&lt;T&gt; <span class="title">newChunk</span><span class="params">(<span class="keyword">int</span> pageSize, <span class="keyword">int</span> maxOrder, <span class="keyword">int</span> pageShifts, <span class="keyword">int</span> chunkSize)</span></span>; <span class="comment">//</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> PoolChunk&lt;T&gt; <span class="title">newUnpooledChunk</span><span class="params">(<span class="keyword">int</span> capacity)</span></span>; <span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> PooledByteBuf&lt;T&gt; <span class="title">newByteBuf</span><span class="params">(<span class="keyword">int</span> maxCapacity)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">memoryCopy</span><span class="params">(T src, <span class="keyword">int</span> srcOffset, T dst, <span class="keyword">int</span> dstOffset, <span class="keyword">int</span> length)</span></span>; <span class="comment">//</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">destroyChunk</span><span class="params">(PoolChunk&lt;T&gt; chunk)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="3-HeapArena"><a href="#3-HeapArena" class="headerlink" title="3. HeapArena"></a>3. HeapArena</h1><p>HeapArena ï¼Œç»§æ‰¿ PoolArena æŠ½è±¡ç±»ï¼Œå¯¹ Heap ç±»å‹çš„å†…å­˜åˆ†é…ã€‚</p>
<blockquote>
<p>HeapArena æ˜¯ PoolArena çš„å†…éƒ¨é™æ€ç±»ã€‚ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹çœ‹å°±æˆã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">static final class HeapArena extends PoolArena&lt;byte[]&gt; { // ç®¡ç† byte[] æ•°ç»„</span><br><span class="line"></span><br><span class="line">    HeapArena(PooledByteBufAllocator parent, <span class="keyword">int</span> pageSize, <span class="keyword">int</span> maxOrder, <span class="keyword">int</span> pageShifts, <span class="keyword">int</span> chunkSize, <span class="keyword">int</span> directMemoryCacheAlignment) {</span><br><span class="line">        <span class="keyword">super</span>(parent, pageSize, maxOrder, pageShifts, chunkSize, directMemoryCacheAlignment);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] newByteArray(<span class="keyword">int</span> size) {</span><br><span class="line">        <span class="keyword">return</span> PlatformDependent.allocateUninitializedArray(size); <span class="comment">// åˆ›å»º byte[] æ•°ç»„</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isDirect</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> PoolChunk&lt;<span class="keyword">byte</span>[]&gt; newChunk(<span class="keyword">int</span> pageSize, <span class="keyword">int</span> maxOrder, <span class="keyword">int</span> pageShifts, <span class="keyword">int</span> chunkSize) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PoolChunk&lt;<span class="keyword">byte</span>[]&gt;(<span class="keyword">this</span>, newByteArray(chunkSize), pageSize, maxOrder, pageShifts, chunkSize, <span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> PoolChunk&lt;<span class="keyword">byte</span>[]&gt; newUnpooledChunk(<span class="keyword">int</span> capacity) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PoolChunk&lt;<span class="keyword">byte</span>[]&gt;(<span class="keyword">this</span>, newByteArray(capacity), capacity, <span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">destroyChunk</span><span class="params">(PoolChunk&lt;<span class="keyword">byte</span>[]&gt; chunk)</span> </span>{</span><br><span class="line">        <span class="comment">// Rely on GC. ä¾èµ– GC</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> PooledByteBuf&lt;<span class="keyword">byte</span>[]&gt; newByteBuf(<span class="keyword">int</span> maxCapacity) {</span><br><span class="line">        <span class="keyword">return</span> HAS_UNSAFE ? PooledUnsafeHeapByteBuf.newUnsafeInstance(maxCapacity)</span><br><span class="line">                : PooledHeapByteBuf.newInstance(maxCapacity);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">memoryCopy</span><span class="params">(<span class="keyword">byte</span>[] src, <span class="keyword">int</span> srcOffset, <span class="keyword">byte</span>[] dst, <span class="keyword">int</span> dstOffset, <span class="keyword">int</span> length)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (length == <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        System.arraycopy(src, srcOffset, dst, dstOffset, length);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="4-DirectArena"><a href="#4-DirectArena" class="headerlink" title="4. DirectArena"></a>4. DirectArena</h1><p>DirectArena ï¼Œç»§æ‰¿ PoolArena æŠ½è±¡ç±»ï¼Œå¯¹ Direct ç±»å‹çš„å†…å­˜åˆ†é…ã€‚</p>
<blockquote>
<p>DirectArena æ˜¯ PoolArena çš„å†…éƒ¨é™æ€ç±»ã€‚ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹çœ‹å°±æˆã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DirectArena</span> <span class="keyword">extends</span> <span class="title">PoolArena</span>&lt;<span class="title">ByteBuffer</span>&gt; </span>{ <span class="comment">// ç®¡ç† Direct ByteBuffer å¯¹è±¡</span></span><br><span class="line"></span><br><span class="line">    DirectArena(PooledByteBufAllocator parent, <span class="keyword">int</span> pageSize, <span class="keyword">int</span> maxOrder,</span><br><span class="line">            <span class="keyword">int</span> pageShifts, <span class="keyword">int</span> chunkSize, <span class="keyword">int</span> directMemoryCacheAlignment) {</span><br><span class="line">        <span class="keyword">super</span>(parent, pageSize, maxOrder, pageShifts, chunkSize, directMemoryCacheAlignment);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isDirect</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">offsetCacheLine</span><span class="params">(ByteBuffer memory)</span> </span>{</span><br><span class="line">        <span class="comment">// We can only calculate the offset if Unsafe is present as otherwise directBufferAddress(...) will</span></span><br><span class="line">        <span class="comment">// throw an NPE.</span></span><br><span class="line">        <span class="keyword">return</span> HAS_UNSAFE ?</span><br><span class="line">                (<span class="keyword">int</span>) (PlatformDependent.directBufferAddress(memory) &amp; directMemoryCacheAlignmentMask) : <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> PoolChunk&lt;ByteBuffer&gt; <span class="title">newChunk</span><span class="params">(<span class="keyword">int</span> pageSize, <span class="keyword">int</span> maxOrder,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> pageShifts, <span class="keyword">int</span> chunkSize)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (directMemoryCacheAlignment == <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PoolChunk&lt;ByteBuffer&gt;(<span class="keyword">this</span>, allocateDirect(chunkSize), pageSize, maxOrder, pageShifts, chunkSize, <span class="number">0</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">final</span> ByteBuffer memory = allocateDirect(chunkSize + directMemoryCacheAlignment);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PoolChunk&lt;ByteBuffer&gt;(<span class="keyword">this</span>, memory, pageSize, maxOrder, pageShifts, chunkSize, offsetCacheLine(memory));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> PoolChunk&lt;ByteBuffer&gt; <span class="title">newUnpooledChunk</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (directMemoryCacheAlignment == <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> PoolChunk&lt;ByteBuffer&gt;(<span class="keyword">this</span>,</span><br><span class="line">                    allocateDirect(capacity), capacity, <span class="number">0</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">final</span> ByteBuffer memory = allocateDirect(capacity + directMemoryCacheAlignment);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PoolChunk&lt;ByteBuffer&gt;(<span class="keyword">this</span>, memory, capacity, offsetCacheLine(memory));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> ByteBuffer <span class="title">allocateDirect</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>{ <span class="comment">// åˆ›å»º Direct ByteBuffer å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> PlatformDependent.useDirectBufferNoCleaner() ?</span><br><span class="line">                PlatformDependent.allocateDirectNoCleaner(capacity) : ByteBuffer.allocateDirect(capacity);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">destroyChunk</span><span class="params">(PoolChunk&lt;ByteBuffer&gt; chunk)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (PlatformDependent.useDirectBufferNoCleaner()) {</span><br><span class="line">            PlatformDependent.freeDirectNoCleaner(chunk.memory);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            PlatformDependent.freeDirectBuffer(chunk.memory);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> PooledByteBuf&lt;ByteBuffer&gt; <span class="title">newByteBuf</span><span class="params">(<span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (HAS_UNSAFE) {</span><br><span class="line">            <span class="keyword">return</span> PooledUnsafeDirectByteBuf.newInstance(maxCapacity);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">return</span> PooledDirectByteBuf.newInstance(maxCapacity);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">memoryCopy</span><span class="params">(ByteBuffer src, <span class="keyword">int</span> srcOffset, ByteBuffer dst, <span class="keyword">int</span> dstOffset, <span class="keyword">int</span> length)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (length == <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (HAS_UNSAFE) {</span><br><span class="line">            PlatformDependent.copyMemory(</span><br><span class="line">                    PlatformDependent.directBufferAddress(src) + srcOffset,</span><br><span class="line">                    PlatformDependent.directBufferAddress(dst) + dstOffset, length);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// We must duplicate the NIO buffers because they may be accessed by other Netty buffers.</span></span><br><span class="line">            src = src.duplicate();</span><br><span class="line">            dst = dst.duplicate();</span><br><span class="line">            src.position(srcOffset).limit(srcOffset + length);</span><br><span class="line">            dst.position(dstOffset);</span><br><span class="line">            dst.put(src);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ç»ˆäºçœ‹æ‡‚ Jemalloc ç®—æ³•çš„å¤§ä½“çš„å®ç°ã€‚ä¸€å¼€å§‹çœ‹ï¼Œä¸€è„¸æ‡µé€¼ï¼ï¼ï¼å…¶å®è€ä¸‹æ€§å­ï¼Œæ…¢æ…¢çœ‹ï¼Œæ€»èƒ½çœ‹æ‡‚çš„ã€‚</p>
<p>å½“ç„¶ï¼Œå¦‚æœè¿™ä¸ªæ—¶å€™è®©è‡ªå·±æ‰‹å†™ Jemalloc ç®—æ³•ï¼Œä¼°è®¡è¿˜æ˜¯ä¼šæ³ªå´©ã€‚å“ˆå“ˆå“ˆï¼Œç›¸æ¯”å†™ä»£ç æ¥è¯´ï¼Œè¯»æ‡‚ä»£ç è¿˜æ˜¯å®¹æ˜“å¾ˆå¤šçš„ã€‚</p>
<p>å˜¿å˜¿ï¼Œæ‰¾äº†ä¸€å¼ å‰å®³çš„å›¾ï¼Œèƒ–å‹åœ¨ç»“åˆè¿™ä¸ªå›¾ï¼Œç†è§£ç†è§£ã€‚</p>
<blockquote>
<p>FROM <a href="http://www.woowen.com/%E6%BA%90%E7%A0%81/2016/08/01/Netty%20buffer%20-%20%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%20PoolArena/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty Buffer - å†…å­˜ç®¡ç† PoolArenaã€‹</a></p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_09_13/04.png" title="å†…å­˜åˆ†é…" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_09_13/04.png" alt="å†…å­˜åˆ†é…"></a><span class="caption">å†…å­˜åˆ†é…</span></p>
</blockquote>
<hr>
<p>å‚è€ƒå¦‚ä¸‹æ–‡ç« ï¼š</p>
<ul>
<li>å å°ç‹¼ <a href="https://www.jianshu.com/p/4856bd30dd56" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥æµ…å‡ºNettyå†…å­˜ç®¡ç† PoolArenaã€‹</a> </li>
<li>Hypercube <a href="https://www.jianshu.com/p/86fbacdb68bd" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆåï¼‰â€“PoolArenaã€‹</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/ByteBuf-3-5-Jemalloc-Arena/" data-id="ck4pl3fp900ecfgcfbu2ekmuq" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>