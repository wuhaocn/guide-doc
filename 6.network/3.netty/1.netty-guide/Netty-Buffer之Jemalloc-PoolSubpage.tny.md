<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆä¸‰ï¼‰PoolSubpage
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>åœ¨ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-2-Jemalloc-chunk">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆä¸€ï¼‰PoolChunkã€‹</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼Œä¸ºäº†è¿›ä¸€æ­¥æä¾›æé«˜å†…å­˜<strong>åˆ†é…æ•ˆç‡</strong>å¹¶å‡å°‘<strong>å†…å­˜ç¢ç‰‡</strong>ï¼ŒJemalloc ç®—æ³•å°†æ¯ä¸ª Chunk åˆ‡åˆ†æˆå¤šä¸ª<strong>å°å—</strong> Page ã€‚</p>
<p>ä½†æ˜¯å®é™…åº”ç”¨ä¸­ï¼ŒPage ä¹Ÿæ˜¯<strong>æ¯”è¾ƒå¤§</strong>çš„å†…å­˜å—ï¼Œå¦‚æœç›´æ¥ä½¿ç”¨ï¼Œæ˜æ˜¾æ˜¯å¾ˆæµªè´¹çš„ã€‚å› æ­¤ï¼ŒJemalloc ç®—æ³•å°†æ¯ä¸ª Page æ›´è¿›ä¸€æ­¥çš„åˆ‡åˆ†ä¸º<strong>å¤šä¸ª</strong> Subpage å†…å­˜å—ã€‚Page åˆ‡åˆ†æˆ<strong>å¤šä¸ª</strong> Subpage å†…å­˜å—ï¼Œå¹¶æœªé‡‡ç”¨ç›¸å¯¹å¤æ‚çš„ç®—æ³•å’Œæ•°æ®ç»“æ„ï¼Œè€Œæ˜¯ç›´æ¥åŸºäº<strong>æ•°ç»„</strong>ï¼Œé€šè¿‡æ•°ç»„æ¥<strong>æ ‡è®°</strong>æ¯ä¸ª Subpage å†…å­˜å—æ˜¯å¦å·²ç»åˆ†é…ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_09_07/01.png" title="PoolSubpage" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_09_07/01.png" alt="PoolSubpage"></a><span class="caption">PoolSubpage</span></p>
<ul>
<li>ä¸€ä¸ª Page ï¼Œåˆ‡åˆ†å‡ºçš„<strong>å¤šä¸ª</strong> Subpage å†…å­˜å—<strong>å¤§å°å‡ç­‰</strong>ã€‚</li>
<li>æ¯ä¸ª Page æ‹†åˆ†çš„ Subpage å†…å­˜å—<strong>å¯ä»¥ä¸åŒ</strong>ï¼Œä»¥ Page ç¬¬ä¸€æ¬¡æ‹†åˆ†ä¸º Subpage å†…å­˜å—æ—¶è¯·æ±‚åˆ†é…çš„å†…å­˜å¤§å°ä¸ºå‡†ã€‚ä¾‹å¦‚ï¼š<ul>
<li>åˆå§‹æ—¶ï¼Œç”³è¯·ä¸€ä¸ª 16B çš„å†…å­˜å—ï¼Œé‚£ä¹ˆ Page0 è¢«æ‹†æˆæˆ 512( <code>8KB / 16B</code> )ä¸ª Subpage å—ï¼Œä½¿ç”¨ç¬¬ 0 å—ã€‚</li>
<li>ç„¶åï¼Œç”³è¯·ä¸€ä¸ª 32B çš„å†…å­˜å—ï¼Œé‚£ä¹ˆ Page1 è¢«æ‹†åˆ†æˆ 256( <code>8KB / 32B</code> )ä¸ª Subpage å—ï¼Œä½¿ç”¨ç¬¬ 0 å—ã€‚</li>
<li>æœ€åï¼Œç”³è¯·ä¸€ä¸ª 16B çš„å†…å­˜å—ï¼Œé‚£ä¹ˆé‡ç”¨ Page0 ï¼Œä½¿ç”¨ç¬¬ 1 å—ã€‚</li>
<li>æ€»ç»“æ¥è¯´ï¼Œç”³è¯· Subpage å†…å­˜å—æ—¶ï¼Œå…ˆå»æ‰¾<strong>å¤§å°åŒ¹é…</strong>ï¼Œä¸”æœ‰å¯åˆ†é… Subpage å†…å­˜å—çš„ Page ï¼š1ï¼‰å¦‚æœæœ‰ï¼Œåˆ™ä½¿ç”¨å…¶ä¸­çš„ä¸€å— Subpage ï¼›2ï¼‰å¦‚æœæ²¡æœ‰ï¼Œåˆ™é€‰æ‹©ä¸€ä¸ªæ–°çš„ Page æ‹†åˆ†æˆå¤šä¸ª Subpage å†…å­˜å—ï¼Œä½¿ç”¨ç¬¬ 0 å— Subpage ã€‚</li>
</ul>
</li>
<li>Subpage çš„å†…å­˜è§„æ ¼ï¼Œåˆ†æˆ Tiny å’Œ Small ä¸¤ç±»ï¼Œå¹¶ä¸”æ¯ç±»æœ‰å¤šç§å¤§å°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_09_07/02.png" title="Subpage å†…å­˜è§„æ ¼" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_09_07/02.png" alt="Subpage å†…å­˜è§„æ ¼"></a><span class="caption">Subpage å†…å­˜è§„æ ¼</span></li>
<li>ä¸ºäº†æ–¹ä¾¿æè¿°ï¼Œä¸‹æ–‡æˆ‘ä»¬ä¼šç»§ç»­å°† <code>ele</code> å°å—ï¼Œæè¿°æˆâ€œSubpage å†…å­˜å—â€ï¼Œç®€ç§°â€œSubpageâ€ ã€‚</li>
</ul>
<h1 id="2-PoolSubpage"><a href="#2-PoolSubpage" class="headerlink" title="2. PoolSubpage"></a>2. PoolSubpage</h1><p><code>io.netty.buffer.PoolSubpage</code> ï¼Œå®ç° PoolSubpageMetric æ¥å£ï¼ŒNetty å¯¹ Jemalloc Subpage çš„å®ç°ç±»ã€‚</p>
<p>è™½ç„¶ï¼ŒPoolSubpage ç±»çš„å‘½åæ˜¯â€œSubpageâ€ï¼Œå®é™…æè¿°çš„æ˜¯ï¼ŒPage åˆ‡åˆ†ä¸º<strong>å¤šä¸ª</strong> Subpage å†…å­˜å—çš„åˆ†é…æƒ…å†µã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆä¸ç›´æ¥å« PoolPage å‘¢ï¼Ÿåœ¨ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-2-Jemalloc-chunk">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆä¸€ï¼‰PoolChunkã€‹</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå½“ç”³è¯·åˆ†é…çš„å†…å­˜è§„æ ¼ä¸º Normal å’Œ Huge æ—¶ï¼Œä½¿ç”¨çš„æ˜¯ä¸€å—æˆ–å¤šå— Page å†…å­˜å—ã€‚å¦‚æœ PoolSubpage å‘½åæˆ PoolPage åï¼Œå’Œè¿™å—çš„åˆ†é…ç­–ç•¥æ˜¯æœ‰æ‰€å†²çªçš„ã€‚æˆ–è€…è¯´ï¼Œ<strong>Subpage ï¼Œåªæ˜¯ Page åˆ†é…å†…å­˜çš„ä¸€ç§å½¢å¼</strong>ã€‚</p>
<h2 id="2-1-æ„é€ æ–¹æ³•"><a href="#2-1-æ„é€ æ–¹æ³•" class="headerlink" title="2.1 æ„é€ æ–¹æ³•"></a>2.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰€å± PoolChunk å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> PoolChunk&lt;T&gt; chunk;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åœ¨ {<span class="doctag">@link</span> PoolChunk#memoryMap} çš„èŠ‚ç‚¹ç¼–å·</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> memoryMapIdx;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åœ¨ Chunk ä¸­ï¼Œåç§»å­—èŠ‚é‡</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> PoolChunk#runOffset(int) </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> runOffset;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Page å¤§å° {<span class="doctag">@link</span> PoolChunk#pageSize}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> pageSize;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Subpage åˆ†é…ä¿¡æ¯æ•°ç»„</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æ¯ä¸ª long çš„ bits ä½ä»£è¡¨ä¸€ä¸ª Subpage æ˜¯å¦åˆ†é…ã€‚</span></span><br><span class="line"><span class="comment"> * å› ä¸º PoolSubpage å¯èƒ½ä¼šè¶…è¿‡ 64 ä¸ª( long çš„ bits ä½æ•° )ï¼Œæ‰€ä»¥ä½¿ç”¨æ•°ç»„ã€‚</span></span><br><span class="line"><span class="comment"> *   ä¾‹å¦‚ï¼šPage é»˜è®¤å¤§å°ä¸º 8KB ï¼ŒSubpage é»˜è®¤æœ€å°ä¸º 16 B ï¼Œæ‰€ä»¥ä¸€ä¸ª Page æœ€å¤šå¯åŒ…å« 8 * 1024 / 16 = 512 ä¸ª Subpage ã€‚</span></span><br><span class="line"><span class="comment"> *        å› æ­¤ï¼Œbitmap æ•°ç»„å¤§å°ä¸º 512 / 64 = 8 ã€‚</span></span><br><span class="line"><span class="comment"> * å¦å¤–ï¼Œbitmap çš„æ•°ç»„å¤§å°ï¼Œä½¿ç”¨ {<span class="doctag">@link</span> #bitmapLength} æ¥æ ‡è®°ã€‚æˆ–è€…è¯´ï¼Œbitmap æ•°ç»„ï¼Œé»˜è®¤æŒ‰ç…§ Subpage çš„å¤§å°ä¸º 16B æ¥åˆå§‹åŒ–ã€‚</span></span><br><span class="line"><span class="comment"> *    ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„è®¾å®šå‘¢ï¼Ÿå› ä¸º PoolSubpage å¯é‡ç”¨ï¼Œé€šè¿‡ {<span class="doctag">@link</span> #init(PoolSubpage, int)} è¿›è¡Œé‡æ–°åˆå§‹åŒ–ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span>[] bitmap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŒå‘é“¾è¡¨ï¼Œå‰ä¸€ä¸ª PoolSubpage å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PoolSubpage&lt;T&gt; prev;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŒå‘é“¾è¡¨ï¼Œåä¸€ä¸ª PoolSubpage å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PoolSubpage&lt;T&gt; next;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦æœªé”€æ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">boolean</span> doNotDestroy;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¯ä¸ª Subpage çš„å ç”¨å†…å­˜å¤§å°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> elemSize;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ€»å…± Subpage çš„æ•°é‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> maxNumElems;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #bitmap} é•¿åº¦</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> bitmapLength;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸‹ä¸€ä¸ªå¯åˆ†é… Subpage çš„æ•°ç»„ä½ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> nextAvail;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‰©ä½™å¯ç”¨ Subpage çš„æ•°é‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> numAvail;</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span>: <span class="comment">// ã€æ„é€ æ–¹æ³• 1ã€‘ åŒå‘é“¾è¡¨ï¼Œå¤´èŠ‚ç‚¹</span></span><br><span class="line">  <span class="number">2</span>: <span class="comment">/** Special constructor that creates a linked list head */</span></span><br><span class="line">  <span class="number">3</span>: PoolSubpage(<span class="keyword">int</span> pageSize) {</span><br><span class="line">  <span class="number">4</span>:     chunk = <span class="keyword">null</span>;</span><br><span class="line">  <span class="number">5</span>:     memoryMapIdx = -<span class="number">1</span>;</span><br><span class="line">  <span class="number">6</span>:     runOffset = -<span class="number">1</span>;</span><br><span class="line">  <span class="number">7</span>:     elemSize = -<span class="number">1</span>;</span><br><span class="line">  <span class="number">8</span>:     <span class="keyword">this</span>.pageSize = pageSize;</span><br><span class="line">  <span class="number">9</span>:     bitmap = <span class="keyword">null</span>;</span><br><span class="line"> <span class="number">10</span>: }</span><br><span class="line"> <span class="number">11</span>: </span><br><span class="line"> <span class="number">12</span>: <span class="comment">// ã€æ„é€ æ–¹æ³• 2ã€‘ åŒå‘é“¾è¡¨ï¼ŒPage èŠ‚ç‚¹</span></span><br><span class="line"> <span class="number">13</span>: PoolSubpage(PoolSubpage&lt;T&gt; head, PoolChunk&lt;T&gt; chunk, <span class="keyword">int</span> memoryMapIdx, <span class="keyword">int</span> runOffset, <span class="keyword">int</span> pageSize, <span class="keyword">int</span> elemSize) {</span><br><span class="line"> <span class="number">14</span>:     <span class="keyword">this</span>.chunk = chunk;</span><br><span class="line"> <span class="number">15</span>:     <span class="keyword">this</span>.memoryMapIdx = memoryMapIdx;</span><br><span class="line"> <span class="number">16</span>:     <span class="keyword">this</span>.runOffset = runOffset;</span><br><span class="line"> <span class="number">17</span>:     <span class="keyword">this</span>.pageSize = pageSize;</span><br><span class="line"> <span class="number">18</span>:     <span class="comment">// åˆ›å»º bitmap æ•°ç»„</span></span><br><span class="line"> <span class="number">19</span>:     bitmap = <span class="keyword">new</span> <span class="keyword">long</span>[pageSize &gt;&gt;&gt; <span class="number">10</span>]; <span class="comment">// pageSize / 16 / 64</span></span><br><span class="line"> <span class="number">20</span>:     <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line"> <span class="number">21</span>:     init(head, elemSize);</span><br><span class="line"> <span class="number">22</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Chunk ç›¸å…³<ul>
<li><code>chunk</code> å±æ€§ï¼Œæ‰€å± PoolChunk å¯¹è±¡ã€‚</li>
<li><code>memoryMapIdx</code> å±æ€§ï¼Œåœ¨ <code>PoolChunk.memoryMap</code> çš„èŠ‚ç‚¹ç¼–å·ï¼Œä¾‹å¦‚èŠ‚ç‚¹ç¼–å· 2048 ã€‚</li>
<li><code>runOffset</code> å±æ€§ï¼Œåœ¨ Chunk ä¸­ï¼Œåç§»å­—èŠ‚é‡ï¼Œé€šè¿‡ <code>PoolChunk#runOffset(id)</code> æ–¹æ³•è®¡ç®—ã€‚åœ¨ PoolSubpage ä¸­ï¼Œæ— ç›¸å…³çš„é€»è¾‘ï¼Œä»…ç”¨äº <code>#toString()</code> æ–¹æ³•ï¼Œæ‰“å°ä¿¡æ¯ã€‚</li>
<li><code>pageSize</code> å±æ€§ï¼ŒPage å¤§å°ã€‚</li>
</ul>
</li>
<li>Subpage ç›¸å…³<ul>
<li><code>bitmap</code> å±æ€§ï¼ŒSubpage <strong>åˆ†é…ä¿¡æ¯</strong>æ•°ç»„ã€‚<ul>
<li>1ã€æ¯ä¸ª <code>long</code> çš„ bits ä½ä»£è¡¨ä¸€ä¸ª Subpage æ˜¯å¦åˆ†é…ã€‚å› ä¸º PoolSubpage å¯èƒ½ä¼šè¶…è¿‡ 64 ä¸ª( <code>long</code> çš„ bits ä½æ•° )ï¼Œæ‰€ä»¥ä½¿ç”¨æ•°ç»„ã€‚ä¾‹å¦‚ï¼šPage é»˜è®¤å¤§å°ä¸º <code>8KB</code> ï¼ŒSubpage é»˜è®¤æœ€å°ä¸º <code>16B</code> ï¼Œæ‰€ä»¥ä¸€ä¸ª Page æœ€å¤šå¯åŒ…å« <code>8 * 1024 / 16</code> = 512 ä¸ª Subpage ã€‚</li>
<li>2ã€åœ¨ã€ç¬¬ 19 è¡Œã€‘çš„ä»£ç ï¼Œåˆ›å»º <code>bitmap</code> æ•°ç»„ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>bitmap</code> æ•°ç»„çš„å¤§å°ä¸º 8(<code>pageSize &gt;&gt;&gt; 10 = pageSize / 16 / 64 = 512 / 64</code>) ä¸ªã€‚<ul>
<li>ä¸ºä»€ä¹ˆæ˜¯<strong>å›ºå®šå¤§å°</strong>å‘¢ï¼Ÿå› ä¸º PoolSubpage <strong>å¯é‡ç”¨</strong>ï¼Œé€šè¿‡ <code>#init(PoolSubpage, int)</code> è¿›è¡Œé‡æ–°åˆå§‹åŒ–ã€‚</li>
<li>é‚£ä¹ˆæ•°ç»„å¤§å°æ€ä¹ˆè·å¾—ï¼Ÿé€šè¿‡ <code>bitmapLength</code> å±æ€§æ¥æ ‡è®°<strong>çœŸæ­£</strong>ä½¿ç”¨çš„æ•°ç»„å¤§å°ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><code>bitmapLength</code> å±æ€§ï¼Œ<code>bitmap</code> æ•°ç»„çš„<strong>çœŸæ­£</strong>ä½¿ç”¨çš„æ•°ç»„å¤§å°ã€‚</li>
<li><code>elemSize</code> å±æ€§ï¼Œæ¯ä¸ª Subpage çš„å ç”¨å†…å­˜å¤§å°ï¼Œä¾‹å¦‚ <code>16B</code>ã€<code>32B</code> ç­‰ç­‰ã€‚</li>
<li><code>maxNumElems</code> å±æ€§ï¼Œæ€»å…± Subpage çš„æ•°é‡ã€‚ä¾‹å¦‚ <code>16B</code> ä¸º 512 ä¸ªï¼Œ<code>32b</code> ä¸º 256 ä¸ªã€‚</li>
<li><code>numAvail</code> å±æ€§ï¼Œå‰©ä½™å¯ç”¨ Subpage çš„æ•°é‡ã€‚</li>
<li><code>nextAvail</code> å±æ€§ï¼Œä¸‹ä¸€ä¸ªå¯åˆ†é… Subpage çš„æ•°ç»„( <code>bitmap</code> )ä½ç½®ã€‚å¯èƒ½ä¼šæœ‰èƒ–å‹æœ‰ç–‘é—®ï¼Œ<code>bitmap</code> åˆæ˜¯æ•°ç»„ï¼Œåˆè€ƒè™‘ bits ä½ï¼Œæ€ä¹ˆè®¡ç®—ä½ç½®å‘¢ï¼Ÿåœ¨ <a href="#">ã€Œ2.6 getNextAvailã€</a> è§åˆ†æ™“ã€‚</li>
<li><code>doNotDestroy</code> å±æ€§ï¼Œæ˜¯å¦æœªé”€æ¯ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.5 freeã€</a> ä¸­ã€‚</li>
</ul>
</li>
<li>Arena ç›¸å…³<ul>
<li><code>prev</code> å±æ€§ï¼ŒåŒå‘é“¾è¡¨ï¼Œå‰ä¸€ä¸ª PoolSubpage å¯¹è±¡ã€‚</li>
<li><code>next</code> å±æ€§ï¼ŒåŒå‘é“¾è¡¨ï¼Œåä¸€ä¸ª PoolSubpage å¯¹è±¡ã€‚</li>
<li>è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.3 åŒå‘é“¾è¡¨ã€</a> ã€‚</li>
</ul>
</li>
<li>æ„é€ æ–¹æ³• <strong>1</strong> ï¼Œç”¨äºåˆ›å»ºåŒå‘é“¾è¡¨çš„å¤´( head )èŠ‚ç‚¹ã€‚</li>
<li>æ„é€ æ–¹æ³• <strong>2</strong> ï¼Œç”¨äºåˆ›å»ºåŒå‘é“¾è¡¨çš„ Page èŠ‚ç‚¹ã€‚<ul>
<li>ç¬¬ 21 è¡Œï¼šè°ƒç”¨ <code>#init(PoolSubpage&lt;T&gt; head, int elemSize)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.2 initã€</a> ã€‚ </li>
</ul>
</li>
</ul>
<h2 id="2-2-init"><a href="#2-2-init" class="headerlink" title="2.2 init"></a>2.2 init</h2><p><code>#init(PoolSubpage&lt;T&gt; head, int elemSize)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(PoolSubpage&lt;T&gt; head, <span class="keyword">int</span> elemSize)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// æœªé”€æ¯</span></span><br><span class="line"> <span class="number">3</span>:     doNotDestroy = <span class="keyword">true</span>;</span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// åˆå§‹åŒ– elemSize</span></span><br><span class="line"> <span class="number">5</span>:     <span class="keyword">this</span>.elemSize = elemSize;</span><br><span class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (elemSize != <span class="number">0</span>) {</span><br><span class="line"> <span class="number">7</span>:         <span class="comment">// åˆå§‹åŒ– maxNumElems</span></span><br><span class="line"> <span class="number">8</span>:         maxNumElems = numAvail = pageSize / elemSize;</span><br><span class="line"> <span class="number">9</span>:         <span class="comment">// åˆå§‹åŒ– nextAvail</span></span><br><span class="line"><span class="number">10</span>:         nextAvail = <span class="number">0</span>;</span><br><span class="line"><span class="number">11</span>:         <span class="comment">// è®¡ç®— bitmapLength çš„å¤§å°</span></span><br><span class="line"><span class="number">12</span>:         bitmapLength = maxNumElems &gt;&gt;&gt; <span class="number">6</span>;</span><br><span class="line"><span class="number">13</span>:         <span class="keyword">if</span> ((maxNumElems &amp; <span class="number">63</span>) != <span class="number">0</span>) { <span class="comment">// æœªæ•´é™¤ï¼Œè¡¥ 1.</span></span><br><span class="line"><span class="number">14</span>:             bitmapLength ++;</span><br><span class="line"><span class="number">15</span>:         }</span><br><span class="line"><span class="number">16</span>: </span><br><span class="line"><span class="number">17</span>:         <span class="comment">// åˆå§‹åŒ– bitmap</span></span><br><span class="line"><span class="number">18</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bitmapLength; i ++) {</span><br><span class="line"><span class="number">19</span>:             bitmap[i] = <span class="number">0</span>;</span><br><span class="line"><span class="number">20</span>:         }</span><br><span class="line"><span class="number">21</span>:     }</span><br><span class="line"><span class="number">22</span>:     <span class="comment">// æ·»åŠ åˆ° Arena çš„åŒå‘é“¾è¡¨ä¸­ã€‚</span></span><br><span class="line"><span class="number">23</span>:     addToPool(head);</span><br><span class="line"><span class="number">24</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šæœªé”€æ¯ã€‚</li>
<li>ç¬¬ 5 è¡Œï¼šåˆå§‹åŒ– <code>elemSize</code> ã€‚<ul>
<li>ç¬¬ 8 è¡Œï¼šåˆå§‹åŒ– <code>maxNumElems</code> ã€‚</li>
</ul>
</li>
<li>ç¬¬ 10 è¡Œï¼šåˆå§‹åŒ– <code>nextAvail</code> ã€‚</li>
<li>ç¬¬ 11 è‡³ 15 è¡Œï¼šåˆå§‹åŒ– <code>bitmapLength</code> ã€‚<ul>
<li>ç¬¬ 17 è‡³ 20 è¡Œï¼šåˆå§‹åŒ– <code>bitmap</code> ã€‚</li>
</ul>
</li>
<li>ç¬¬ 23 è¡Œï¼šè°ƒç”¨ <code>#addToPool(PoolSubpage&lt;T&gt; head)</code> æ–¹æ³•ä¸­ï¼Œæ·»åŠ åˆ° Arena çš„åŒå‘é“¾è¡¨ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.3.1 addToPoolã€</a> ä¸­ã€‚</li>
</ul>
<h2 id="2-3-åŒå‘é“¾è¡¨"><a href="#2-3-åŒå‘é“¾è¡¨" class="headerlink" title="2.3 åŒå‘é“¾è¡¨"></a>2.3 åŒå‘é“¾è¡¨</h2><p>åœ¨æ¯ä¸ª Arena ä¸­ï¼Œæœ‰ <code>tinySubpagePools</code> å’Œ <code>smallSubpagePools</code> å±æ€§ï¼Œåˆ†åˆ«è¡¨ç¤º <strong>tiny</strong> å’Œ <strong>small</strong> ç±»å‹çš„ PoolSubpage æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// PoolArena.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * tiny ç±»å‹çš„ PoolSubpage æ•°ç»„</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æ•°ç»„çš„æ¯ä¸ªå…ƒç´ ï¼Œéƒ½æ˜¯åŒå‘é“¾è¡¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolSubpage&lt;T&gt;[] tinySubpagePools;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * small ç±»å‹çš„ SubpagePools æ•°ç»„</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æ•°ç»„çš„æ¯ä¸ªå…ƒç´ ï¼Œéƒ½æ˜¯åŒå‘é“¾è¡¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolSubpage&lt;T&gt;[] smallSubpagePools;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ•°ç»„çš„æ¯ä¸ªå…ƒç´ ï¼Œé€šè¿‡ <code>prev</code> å’Œ <code>next</code> å±æ€§ï¼Œå½¢æˆ<strong>åŒå‘</strong>é“¾è¡¨ã€‚å¹¶ä¸”ï¼Œæ¯ä¸ªå…ƒç´ ï¼Œè¡¨ç¤ºå¯¹åº”çš„ Subpage å†…å­˜è§„æ ¼çš„<strong>åŒå‘</strong>é“¾è¡¨ï¼Œä¾‹å¦‚ï¼š<code>tinySubpagePools[0]</code> è¡¨ç¤º <code>16B</code> ï¼Œ<code>tinySubpagePools[1]</code> è¡¨ç¤º <code>32B</code> ã€‚</li>
<li>é€šè¿‡ <code>tinySubpagePools</code> å’Œ <code>smallSubpagePools</code> å±æ€§ï¼Œå¯ä»¥ä»ä¸­æŸ¥æ‰¾ï¼Œæ˜¯å¦å·²ç»æœ‰ç¬¦åˆåˆ†é…å†…å­˜è§„æ ¼çš„ Subpage èŠ‚ç‚¹å¯åˆ†é…ã€‚</li>
<li><p>åˆå§‹æ—¶ï¼Œæ¯ä¸ªåŒå‘é“¾è¡¨ï¼Œä¼šåˆ›å»ºå¯¹åº”çš„ <code>head</code> èŠ‚ç‚¹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// PoolArena.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> PoolSubpage&lt;T&gt; <span class="title">newSubpagePoolHead</span><span class="params">(<span class="keyword">int</span> pageSize)</span> </span>{</span><br><span class="line">    PoolSubpage&lt;T&gt; head = <span class="keyword">new</span> PoolSubpage&lt;T&gt;(pageSize);</span><br><span class="line">    head.prev = head;</span><br><span class="line">    head.next = head;</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ¯”è¾ƒç¥å¥‡çš„æ˜¯ï¼Œ<code>head</code> çš„ä¸Šä¸‹èŠ‚ç‚¹éƒ½æ˜¯<strong>è‡ªå·±</strong>ã€‚ä¹Ÿå°±è¯´ï¼Œè¿™æ˜¯ä¸ªåŒå‘ç¯å½¢( å¾ªç¯ )é“¾è¡¨ã€‚</li>
</ul>
</li>
</ul>
<h3 id="2-3-1-addToPool"><a href="#2-3-1-addToPool" class="headerlink" title="2.3.1 addToPool"></a>2.3.1 addToPool</h3><p><code>#addToPool(PoolSubpage&lt;T&gt; head)</code> æ–¹æ³•ä¸­ï¼Œæ·»åŠ åˆ° Arena çš„åŒå‘é“¾è¡¨ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addToPool</span><span class="params">(PoolSubpage&lt;T&gt; head)</span> </span>{</span><br><span class="line">    <span class="keyword">assert</span> prev == <span class="keyword">null</span> &amp;&amp; next == <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// å°†å½“å‰èŠ‚ç‚¹ï¼Œæ’å…¥åˆ° head å’Œ head.next ä¸­é—´</span></span><br><span class="line">    prev = head;</span><br><span class="line">    next = head.next;</span><br><span class="line">    next.prev = <span class="keyword">this</span>;</span><br><span class="line">    head.next = <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å°†å½“å‰èŠ‚ç‚¹ï¼Œæ’å…¥åˆ° <code>head</code> å’Œ <code>head.next</code> ä¸­é—´ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_09_07/03.png" title="æ’å…¥è¿‡ç¨‹" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_09_07/03.png" alt="æ’å…¥è¿‡ç¨‹"></a><span class="caption">æ’å…¥è¿‡ç¨‹</span><ul>
<li>æ³¨æ„ï¼Œæ˜¯åœ¨ <code>head</code> å’Œ <code>head.next</code> <strong>ä¸­é—´</strong>æ’å…¥èŠ‚ç‚¹å™¢ã€‚</li>
</ul>
</li>
</ul>
<h3 id="2-3-2-removeFromPool"><a href="#2-3-2-removeFromPool" class="headerlink" title="2.3.2 removeFromPool"></a>2.3.2 removeFromPool</h3><p><code>#removeFromPool()</code> æ–¹æ³•ä¸­ï¼Œä»åŒå‘é“¾è¡¨ä¸­ç§»é™¤ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeFromPool</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">assert</span> prev != <span class="keyword">null</span> &amp;&amp; next != <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// å‰åèŠ‚ç‚¹ï¼Œäº’ç›¸æŒ‡å‘</span></span><br><span class="line">    prev.next = next;</span><br><span class="line">    next.prev = prev;</span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹ï¼Œç½®ç©º</span></span><br><span class="line">    next = <span class="keyword">null</span>;</span><br><span class="line">    prev = <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-4-allocate"><a href="#2-4-allocate" class="headerlink" title="2.4 allocate"></a>2.4 allocate</h2><p><code>#allocate()</code> æ–¹æ³•ï¼Œåˆ†é…ä¸€ä¸ª Subpage å†…å­˜å—ï¼Œå¹¶è¿”å›è¯¥å†…å­˜å—çš„ä½ç½® <code>handle</code> ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å…³äº <code>handle</code> æ€ä¹ˆç¿»è¯‘å’Œè§£é‡Šå¥½å‘¢ï¼Ÿç¬”è€…æš‚æ—¶æ²¡æƒ³å¥½ï¼Œå®˜æ–¹çš„å®šä¹‰æ˜¯ <code>"Returns the bitmap index of the subpage allocation."</code> ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">long</span> <span class="title">allocate</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// é˜²å¾¡æ€§ç¼–ç¨‹ï¼Œä¸å­˜åœ¨è¿™ç§æƒ…å†µã€‚</span></span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (elemSize == <span class="number">0</span>) {</span><br><span class="line"> <span class="number">4</span>:         <span class="keyword">return</span> toHandle(<span class="number">0</span>);</span><br><span class="line"> <span class="number">5</span>:     }</span><br><span class="line"> <span class="number">6</span>: </span><br><span class="line"> <span class="number">7</span>:     <span class="comment">// å¯ç”¨æ•°é‡ä¸º 0 ï¼Œæˆ–è€…å·²é”€æ¯ï¼Œè¿”å› -1 ï¼Œå³ä¸å¯åˆ†é…ã€‚</span></span><br><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (numAvail == <span class="number">0</span> || !doNotDestroy) {</span><br><span class="line"> <span class="number">9</span>:         <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line"><span class="number">10</span>:     }</span><br><span class="line"><span class="number">11</span>: </span><br><span class="line"><span class="number">12</span>:     <span class="comment">// è·å¾—ä¸‹ä¸€ä¸ªå¯ç”¨çš„ Subpage åœ¨ bitmap ä¸­çš„æ€»ä½“ä½ç½®</span></span><br><span class="line"><span class="number">13</span>:     <span class="keyword">final</span> <span class="keyword">int</span> bitmapIdx = getNextAvail();</span><br><span class="line"><span class="number">14</span>:     <span class="comment">// è·å¾—ä¸‹ä¸€ä¸ªå¯ç”¨çš„ Subpage åœ¨ bitmap ä¸­æ•°ç»„çš„ä½ç½®</span></span><br><span class="line"><span class="number">15</span>:     <span class="keyword">int</span> q = bitmapIdx &gt;&gt;&gt; <span class="number">6</span>;</span><br><span class="line"><span class="number">16</span>:     <span class="comment">// è·å¾—ä¸‹ä¸€ä¸ªå¯ç”¨çš„ Subpage åœ¨ bitmap ä¸­æ•°ç»„çš„ä½ç½®çš„ç¬¬å‡  bits</span></span><br><span class="line"><span class="number">17</span>:     <span class="keyword">int</span> r = bitmapIdx &amp; <span class="number">63</span>;</span><br><span class="line"><span class="number">18</span>:     <span class="keyword">assert</span> (bitmap[q] &gt;&gt;&gt; r &amp; <span class="number">1</span>) == <span class="number">0</span>;</span><br><span class="line"><span class="number">19</span>:     <span class="comment">// ä¿®æ”¹ Subpage åœ¨ bitmap ä¸­ä¸å¯åˆ†é…ã€‚</span></span><br><span class="line"><span class="number">20</span>:     bitmap[q] |= <span class="number">1L</span> &lt;&lt; r;</span><br><span class="line"><span class="number">21</span>: </span><br><span class="line"><span class="number">22</span>:     <span class="comment">// å¯ç”¨ Subpage å†…å­˜å—çš„è®¡æ•°å‡ä¸€</span></span><br><span class="line"><span class="number">23</span>:     <span class="keyword">if</span> (-- numAvail == <span class="number">0</span>) { <span class="comment">// æ— å¯ç”¨ Subpage å†…å­˜å—</span></span><br><span class="line"><span class="number">24</span>:         <span class="comment">// ä»åŒå‘é“¾è¡¨ä¸­ç§»é™¤</span></span><br><span class="line"><span class="number">25</span>:         removeFromPool();</span><br><span class="line"><span class="number">26</span>:     }</span><br><span class="line"><span class="number">27</span>: </span><br><span class="line"><span class="number">28</span>:     <span class="comment">// è®¡ç®— handle</span></span><br><span class="line"><span class="number">29</span>:     <span class="keyword">return</span> toHandle(bitmapIdx);</span><br><span class="line"><span class="number">30</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 2 è‡³ 5 è¡Œï¼šé˜²å¾¡æ€§ç¼–ç¨‹ï¼Œä¸å­˜åœ¨è¿™ç§æƒ…å†µã€‚</li>
<li>ç¬¬ 7 è‡³ 10 è¡Œï¼šå¯ç”¨æ•°é‡ä¸º 0 ï¼Œæˆ–è€…å·²é”€æ¯ï¼Œè¿”å› -1 ï¼Œå³<strong>ä¸å¯åˆ†é…</strong>ã€‚</li>
<li>ç¬¬ 12 è‡³ 20 è¡Œï¼šåˆ†é…ä¸€ä¸ª Subpage å†…å­˜å—ã€‚<ul>
<li>ç¬¬ 13 è¡Œï¼šè°ƒç”¨ <code>#getNextAvail()</code> æ–¹æ³•ï¼Œè·å¾—ä¸‹ä¸€ä¸ªå¯ç”¨çš„ Subpage åœ¨ bitmap ä¸­çš„<strong>æ€»ä½“</strong>ä½ç½®ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.6 getNextAvailã€</a> ã€‚</li>
<li>ç¬¬ 15 è¡Œï¼š<code>bitmapIdx &gt;&gt;&gt; 6 = bitmapIdx / 64</code> æ“ä½œï¼Œè·å¾—ä¸‹ä¸€ä¸ªå¯ç”¨çš„ Subpage åœ¨ bitmap ä¸­<strong>æ•°ç»„çš„ä½ç½®</strong>ã€‚</li>
<li>ç¬¬ 17 è¡Œï¼š<code>bitmapIdx &amp; 63 = bitmapIdx % 64</code> æ“ä½œï¼Œ è·å¾—ä¸‹ä¸€ä¸ªå¯ç”¨çš„ Subpage åœ¨ bitmap ä¸­æ•°ç»„çš„ä½ç½®çš„<strong>ç¬¬å‡  bit</strong> ã€‚</li>
<li>ç¬¬ 20 è¡Œï¼š<code>| (1L &lt;&lt; r)</code> æ“ä½œï¼Œä¿®æ”¹ Subpage åœ¨ bitmap ä¸­ä¸å¯åˆ†é…ã€‚</li>
</ul>
</li>
<li>ç¬¬ 23 è¡Œï¼šå¯ç”¨ Subpage å†…å­˜å—çš„è®¡æ•°å‡ä¸€ã€‚<ul>
<li>ç¬¬ 25 è¡Œï¼šå½“ <code>numAvail == 0</code> æ—¶ï¼Œè¡¨ç¤ºæ— å¯ç”¨ Subpage å†…å­˜å—ã€‚æ‰€ä»¥ï¼Œè°ƒç”¨ <code>#removeFromPool()</code> æ–¹æ³•ï¼Œä»åŒå‘é“¾è¡¨ä¸­ç§»é™¤ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.3.2 removeFromPoolã€</a> ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 29 è¡Œï¼šè°ƒç”¨ <code>#toHandle(bitmapIdx)</code> æ–¹æ³•ï¼Œè®¡ç®— <code>handle</code> å€¼ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">toHandle</span><span class="params">(<span class="keyword">int</span> bitmapIdx)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0x4000000000000000L</span> | (<span class="keyword">long</span>) bitmapIdx &lt;&lt; <span class="number">32</span> | memoryMapIdx;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä½ 32 bits ï¼š<code>memoryMapIdx</code> ï¼Œå¯ä»¥åˆ¤æ–­æ‰€å± Chunk çš„å“ªä¸ª Page èŠ‚ç‚¹ï¼Œå³ <code>memoryMap[memoryMapIdx]</code> ã€‚</li>
<li>é«˜ 32 bits ï¼š<code>bitmapIdx</code> ï¼Œå¯ä»¥åˆ¤æ–­ Page èŠ‚ç‚¹ä¸­çš„å“ªä¸ª Subpage çš„å†…å­˜å—ï¼Œå³ <code>bitmap[bitmapIdx]</code> ã€‚<ul>
<li>é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šæœ‰ <code>0x4000000000000000L</code> å‘¢ï¼Ÿå› ä¸ºåœ¨ <code>PoolChunk#allocate(int normCapacity)</code> ä¸­ï¼š<ul>
<li>å¦‚æœåˆ†é…çš„æ˜¯ Page å†…å­˜å—ï¼Œè¿”å›çš„æ˜¯ <code>memoryMapIdx</code> ã€‚</li>
<li>å¦‚æœåˆ†é…çš„æ˜¯ Subpage å†…å­˜å—ï¼Œè¿”å›çš„æ˜¯ <code>handle</code> ã€‚<strong>ä½†ä½†ä½†æ˜¯</strong>ï¼Œå¦‚æœè¯´ <code>bitmapIdx = 0</code> ï¼Œé‚£ä¹ˆæ²¡æœ‰ <code>0x4000000000000000L</code> æƒ…å†µä¸‹ï¼Œå°±ä¼šå’Œã€åˆ†é… Page å†…å­˜å—ã€‘å†²çªã€‚å› æ­¤ï¼Œéœ€è¦æœ‰ <code>0x4000000000000000L</code> ã€‚</li>
</ul>
</li>
<li>å› ä¸ºæœ‰äº† <code>0x4000000000000000L</code>(æœ€é«˜ä¸¤ä½ä¸º <code>01</code> ï¼Œå…¶å®ƒä½ä¸º <code>0</code> )ï¼Œæ‰€ä»¥è·å– <code>bitmapIdx</code> æ—¶ï¼Œé€šè¿‡ <code>handle &gt;&gt;&gt; 32 &amp; 0x3FFFFFFF</code> æ“ä½œã€‚ä½¿ç”¨ <code>0x3FFFFFFF</code>( æœ€é«˜ä¸¤ä½ä¸º <code>00</code> ï¼Œå…¶å®ƒä½ä¸º <code>1</code> ) è¿›è¡Œæ¶ˆé™¤ <code>0x4000000000000000L</code> å¸¦æ¥çš„å½±å“ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="2-5-free"><a href="#2-5-free" class="headerlink" title="2.5 free"></a>2.5 free</h2><p><code>#free(PoolSubpage&lt;T&gt; head, int bitmapIdx)</code> æ–¹æ³•ï¼Œé‡Šæ”¾æŒ‡å®šä½ç½®çš„ Subpage å†…å­˜å—ï¼Œå¹¶è¿”å›å½“å‰ Page <strong>æ˜¯å¦æ­£åœ¨ä½¿ç”¨ä¸­</strong>( <code>true</code> )ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">boolean</span> <span class="title">free</span><span class="params">(PoolSubpage&lt;T&gt; head, <span class="keyword">int</span> bitmapIdx)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// é˜²å¾¡æ€§ç¼–ç¨‹ï¼Œä¸å­˜åœ¨è¿™ç§æƒ…å†µã€‚</span></span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (elemSize == <span class="number">0</span>) {</span><br><span class="line"> <span class="number">4</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"> <span class="number">5</span>:     }</span><br><span class="line"> <span class="number">6</span>:     <span class="comment">// è·å¾— Subpage åœ¨ bitmap ä¸­æ•°ç»„çš„ä½ç½®</span></span><br><span class="line"> <span class="number">7</span>:     <span class="keyword">int</span> q = bitmapIdx &gt;&gt;&gt; <span class="number">6</span>;</span><br><span class="line"> <span class="number">8</span>:     <span class="comment">// è·å¾— Subpage åœ¨ bitmap ä¸­æ•°ç»„çš„ä½ç½®çš„ç¬¬å‡  bits</span></span><br><span class="line"> <span class="number">9</span>:     <span class="keyword">int</span> r = bitmapIdx &amp; <span class="number">63</span>;</span><br><span class="line"><span class="number">10</span>:     <span class="keyword">assert</span> (bitmap[q] &gt;&gt;&gt; r &amp; <span class="number">1</span>) != <span class="number">0</span>;</span><br><span class="line"><span class="number">11</span>:     <span class="comment">// ä¿®æ”¹ Subpage åœ¨ bitmap ä¸­å¯åˆ†é…ã€‚</span></span><br><span class="line"><span class="number">12</span>:     bitmap[q] ^= <span class="number">1L</span> &lt;&lt; r;</span><br><span class="line"><span class="number">13</span>: </span><br><span class="line"><span class="number">14</span>:     <span class="comment">// è®¾ç½®ä¸‹ä¸€ä¸ªå¯ç”¨ä¸ºå½“å‰ Subpage</span></span><br><span class="line"><span class="number">15</span>:     setNextAvail(bitmapIdx);</span><br><span class="line"><span class="number">16</span>: </span><br><span class="line"><span class="number">17</span>:     <span class="comment">// å¯ç”¨ Subpage å†…å­˜å—çš„è®¡æ•°åŠ ä¸€</span></span><br><span class="line"><span class="number">18</span>:     <span class="keyword">if</span> (numAvail ++ == <span class="number">0</span>) {</span><br><span class="line"><span class="number">19</span>:         <span class="comment">// æ·»åŠ åˆ° Arena çš„åŒå‘é“¾è¡¨ä¸­ã€‚</span></span><br><span class="line"><span class="number">20</span>:         addToPool(head);</span><br><span class="line"><span class="number">21</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">22</span>:     }</span><br><span class="line"><span class="number">23</span>: </span><br><span class="line"><span class="number">24</span>:     <span class="comment">// è¿˜æœ‰ Subpage åœ¨ä½¿ç”¨</span></span><br><span class="line"><span class="number">25</span>:     <span class="keyword">if</span> (numAvail != maxNumElems) {</span><br><span class="line"><span class="number">26</span>:         <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">27</span>:     <span class="comment">// æ²¡æœ‰ Subpage åœ¨ä½¿ç”¨</span></span><br><span class="line"><span class="number">28</span>:     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">29</span>:         <span class="comment">// åŒå‘é“¾è¡¨ä¸­ï¼Œåªæœ‰è¯¥èŠ‚ç‚¹ï¼Œä¸è¿›è¡Œç§»é™¤</span></span><br><span class="line"><span class="number">30</span>:         <span class="comment">// Subpage not in use (numAvail == maxNumElems)</span></span><br><span class="line"><span class="number">31</span>:         <span class="keyword">if</span> (prev == next) {</span><br><span class="line"><span class="number">32</span>:             <span class="comment">// Do not remove if this subpage is the only one left in the pool.</span></span><br><span class="line"><span class="number">33</span>:             <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">34</span>:         }</span><br><span class="line"><span class="number">35</span>: </span><br><span class="line"><span class="number">36</span>:         <span class="comment">// æ ‡è®°ä¸ºå·²é”€æ¯</span></span><br><span class="line"><span class="number">37</span>:         <span class="comment">// Remove this subpage from the pool if there are other subpages left in the pool.</span></span><br><span class="line"><span class="number">38</span>:         doNotDestroy = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">39</span>:         <span class="comment">// ä»åŒå‘é“¾è¡¨ä¸­ç§»é™¤</span></span><br><span class="line"><span class="number">40</span>:         removeFromPool();</span><br><span class="line"><span class="number">41</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">42</span>:     }</span><br><span class="line"><span class="number">43</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 2 è‡³ 5 è¡Œï¼šé˜²å¾¡æ€§ç¼–ç¨‹ï¼Œä¸å­˜åœ¨è¿™ç§æƒ…å†µã€‚</li>
<li>ç¬¬ 6 è‡³ 12 è¡Œï¼šé‡Šæ”¾æŒ‡å®šä½ç½®çš„ Subpage å†…å­˜å—ã€‚<ul>
<li>ç¬¬ 7 è¡Œï¼š<code>bitmapIdx &gt;&gt;&gt; 6 = bitmapIdx / 64</code> æ“ä½œï¼Œè·å¾—ä¸‹ä¸€ä¸ªå¯ç”¨çš„ Subpage åœ¨ bitmap ä¸­<strong>æ•°ç»„çš„ä½ç½®</strong>ã€‚</li>
<li>ç¬¬ 9 è¡Œï¼š<code>bitmapIdx &amp; 63 = bitmapIdx % 64</code> æ“ä½œï¼Œ è·å¾—ä¸‹ä¸€ä¸ªå¯ç”¨çš„ Subpage åœ¨ bitmap ä¸­æ•°ç»„çš„ä½ç½®çš„<strong>ç¬¬å‡  bit</strong> ã€‚</li>
<li>ç¬¬ 12 è¡Œï¼š<code>^ (1L &lt;&lt; r)</code> æ“ä½œï¼Œä¿®æ”¹ Subpage åœ¨ bitmap ä¸­å¯åˆ†é…ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 15 è¡Œï¼šè°ƒç”¨ <code>#setNextAvail(int bitmapIdx)</code> æ–¹æ³•ï¼Œè®¾ç½®ä¸‹ä¸€ä¸ªå¯ç”¨ä¸ºå½“å‰ Subpage çš„ä½ç½®ã€‚è¿™æ ·ï¼Œå°±èƒ½é¿å…ä¸‹æ¬¡åˆ†é… Subpage æ—¶ï¼Œå†å»æ‰¾ä½ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setNextAvail</span><span class="params">(<span class="keyword">int</span> bitmapIdx)</span> </span>{</span><br><span class="line">    nextAvail = bitmapIdx;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ç¬¬ 18 è¡Œï¼šå¯ç”¨ Subpage å†…å­˜å—çš„è®¡æ•°åŠ ä¸€ã€‚</p>
<ul>
<li>ç¬¬ 20 è¡Œï¼šå½“ä¹‹å‰ <code>numAvail == 0</code> æ—¶ï¼Œè¡¨ç¤º<strong>åˆæœ‰</strong>å¯ç”¨ Subpage å†…å­˜å—ã€‚æ‰€ä»¥ï¼Œè°ƒç”¨ <code>#addToPool(PoolSubpage&lt;T&gt; head)</code> æ–¹æ³•ï¼Œæ·»åŠ åˆ° Arena çš„åŒå‘é“¾è¡¨ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.3.1 addToPoolã€</a> ã€‚</li>
<li>ç¬¬ 21 è¡Œï¼šè¿”å› <code>true</code> ï¼Œæ­£åœ¨ä½¿ç”¨ä¸­ã€‚</li>
</ul>
</li>
<li>ç¬¬ 24 è‡³ 26 è¡Œï¼šè¿”å› <code>true</code> ï¼Œå› ä¸ºè¿˜æœ‰å…¶å®ƒåœ¨ä½¿ç”¨çš„ Subpage å†…å­˜å—ã€‚</li>
<li>ç¬¬ 27 è‡³ 42 è¡Œï¼šæ²¡æœ‰ Subpage åœ¨ä½¿ç”¨ã€‚<ul>
<li>ç¬¬ 29 è‡³ 34 è¡Œï¼šè¿”å› <code>true</code> ï¼Œå› ä¸ºé€šè¿‡ <code>prev == next</code> å¯åˆ¤æ–­ï¼Œå½“å‰èŠ‚ç‚¹ä¸ºåŒå‘é“¾è¡¨ä¸­çš„å”¯ä¸€èŠ‚ç‚¹ï¼Œä¸è¿›è¡Œç§»é™¤ã€‚ä¹Ÿå°±è¯´ï¼Œè¯¥èŠ‚ç‚¹åç»­ï¼Œç»§ç»­ä½¿ç”¨ã€‚</li>
<li>ç¬¬ 36 è‡³ 41 è¡Œï¼šè¿”å› <code>false</code> ï¼Œä¸åœ¨ä½¿ç”¨ä¸­ã€‚<ul>
<li>ç¬¬ 38 è¡Œï¼šæ ‡è®°ä¸ºå·²é”€æ¯ã€‚ </li>
<li>ç¬¬ 40 è¡Œï¼šè°ƒç”¨ <code>#removeFromPool()</code> æ–¹æ³•ï¼Œä»åŒå‘é“¾è¡¨ä¸­ç§»é™¤ã€‚å› ä¸ºæ­¤æ—¶åŒå‘é“¾è¡¨ä¸­ï¼Œè¿˜æœ‰å…¶å®ƒèŠ‚ç‚¹å¯ä½¿ç”¨ï¼Œ<strong>æ²¡å¿…è¦ä¿æŒå¤šä¸ªç›¸åŒè§„æ ¼çš„èŠ‚ç‚¹</strong>ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p>å…³äºä¸ºä»€ä¹ˆ <code>#free(PoolSubpage&lt;T&gt; head, int bitmapIdx)</code> æ–¹æ³•ï¼Œéœ€è¦è¿”å› <code>true</code> æˆ– <code>false</code> å‘¢ï¼Ÿèƒ–å‹å†çœ‹çœ‹ <code>PoolChunk#free(long handle)</code> æ–¹æ³•ï¼Œå°±èƒ½æ˜ç™½ã€‚ç­”æ¡ˆæ˜¯ï¼Œå¦‚æœä¸å†ä½¿ç”¨ï¼Œå¯ä»¥å°†è¯¥èŠ‚ç‚¹( Page )ä» Chunk ä¸­é‡Šæ”¾ï¼Œæ ‡è®°ä¸ºå¯ç”¨ã€‚ğŸ˜ˆğŸ˜ˆğŸ˜ˆ</p>
<h2 id="2-6-getNextAvail"><a href="#2-6-getNextAvail" class="headerlink" title="2.6 getNextAvail"></a>2.6 getNextAvail</h2><p><code>#getNextAvail()</code> æ–¹æ³•ï¼Œè·å¾—ä¸‹ä¸€ä¸ªå¯ç”¨çš„ Subpage åœ¨ bitmap ä¸­çš„<strong>æ€»ä½“</strong>ä½ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getNextAvail</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">int</span> nextAvail = <span class="keyword">this</span>.nextAvail;</span><br><span class="line">    <span class="comment">// &lt;1&gt; nextAvail å¤§äº 0 ï¼Œæ„å‘³ç€å·²ç»â€œç¼“å­˜â€å¥½ä¸‹ä¸€ä¸ªå¯ç”¨çš„ä½ç½®ï¼Œç›´æ¥è¿”å›å³å¯ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (nextAvail &gt;= <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">this</span>.nextAvail = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> nextAvail;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &lt;2&gt; å¯»æ‰¾ä¸‹ä¸€ä¸ª nextAvail</span></span><br><span class="line">    <span class="keyword">return</span> findNextAvail();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œå¦‚æœ <code>nextAvail</code> å¤§äº 0 ï¼Œæ„å‘³ç€å·²ç»â€œç¼“å­˜â€å¥½ä¸‹ä¸€ä¸ªå¯ç”¨çš„ä½ç½®ï¼Œç›´æ¥è¿”å›å³å¯ã€‚<ul>
<li>è·å–å¥½åï¼Œä¼šå°† <code>nextAvail</code> ç½®ä¸º -1 ã€‚æ„å‘³ç€ï¼Œä¸‹æ¬¡éœ€è¦å¯»æ‰¾ä¸‹ä¸€ä¸ª <code>nextAvail</code> ã€‚</li>
</ul>
</li>
<li><p><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#findNextAvail()</code> æ–¹æ³•ï¼Œå¯»æ‰¾ä¸‹ä¸€ä¸ª <code>nextAvail</code> ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">findNextAvail</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span>[] bitmap = <span class="keyword">this</span>.bitmap;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> bitmapLength = <span class="keyword">this</span>.bitmapLength;</span><br><span class="line">    <span class="comment">// å¾ªç¯ bitmap</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bitmapLength; i ++) {</span><br><span class="line">        <span class="keyword">long</span> bits = bitmap[i];</span><br><span class="line">        <span class="comment">// ~ æ“ä½œï¼Œå¦‚æœä¸ç­‰äº 0 ï¼Œè¯´æ˜æœ‰å¯ç”¨çš„ Subpage</span></span><br><span class="line">        <span class="keyword">if</span> (~bits != <span class="number">0</span>) {</span><br><span class="line">            <span class="comment">// åœ¨è¿™ bits å¯»æ‰¾å¯ç”¨ nextAvail</span></span><br><span class="line">            <span class="keyword">return</span> findNextAvail0(i, bits);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// æœªæ‰¾åˆ°</span></span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹ç›´æ¥çœ‹æ³¨é‡Šã€‚</li>
<li><p>è°ƒç”¨ <code>#findNextAvail0(int i, long bits)</code> æ–¹æ³•ï¼Œåœ¨è¿™ bits å¯»æ‰¾å¯ç”¨ <code>nextAvail</code> ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">findNextAvail0</span><span class="params">(<span class="keyword">int</span> i, <span class="keyword">long</span> bits)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">final</span> <span class="keyword">int</span> maxNumElems = <span class="keyword">this</span>.maxNumElems;</span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// è®¡ç®—åŸºç¡€å€¼ï¼Œè¡¨ç¤ºåœ¨ bitmap çš„æ•°ç»„ä¸‹æ ‡</span></span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">final</span> <span class="keyword">int</span> baseVal = i &lt;&lt; <span class="number">6</span>; <span class="comment">// ç›¸å½“äº * 64</span></span><br><span class="line"> <span class="number">5</span>: </span><br><span class="line"> <span class="number">6</span>:     <span class="comment">// éå† 64 bits</span></span><br><span class="line"> <span class="number">7</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="number">64</span>; j ++) {</span><br><span class="line"> <span class="number">8</span>:         <span class="comment">// è®¡ç®—å½“å‰ bit æ˜¯å¦æœªåˆ†é…</span></span><br><span class="line"> <span class="number">9</span>:         <span class="keyword">if</span> ((bits &amp; <span class="number">1</span>) == <span class="number">0</span>) {</span><br><span class="line"><span class="number">10</span>:             <span class="comment">// å¯èƒ½ bitmap æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå¹¶æ²¡æœ‰ 64 ä½ï¼Œé€šè¿‡ baseVal | j &lt; maxNumElems æ¥ä¿è¯ä¸è¶…è¿‡ä¸Šé™ã€‚</span></span><br><span class="line"><span class="number">11</span>:             <span class="keyword">int</span> val = baseVal | j;</span><br><span class="line"><span class="number">12</span>:             <span class="keyword">if</span> (val &lt; maxNumElems) {</span><br><span class="line"><span class="number">13</span>:                 <span class="keyword">return</span> val;</span><br><span class="line"><span class="number">14</span>:             } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">15</span>:                 <span class="keyword">break</span>;</span><br><span class="line"><span class="number">16</span>:             }</span><br><span class="line"><span class="number">17</span>:         }</span><br><span class="line"><span class="number">18</span>:         <span class="comment">// å»æ‰å½“å‰ bit</span></span><br><span class="line"><span class="number">19</span>:         bits &gt;&gt;&gt;= <span class="number">1</span>;</span><br><span class="line"><span class="number">20</span>:     }</span><br><span class="line"><span class="number">21</span>: </span><br><span class="line"><span class="number">22</span>:     <span class="comment">// æœªæ‰¾åˆ°</span></span><br><span class="line"><span class="number">23</span>:     <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line"><span class="number">24</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 4 è¡Œï¼šè®¡ç®—åŸºç¡€å€¼ï¼Œè¡¨ç¤ºåœ¨ <code>bitmap</code> çš„æ•°ç»„<strong>ä¸‹æ ‡</strong>ã€‚é€šè¿‡ <code>i &lt;&lt; 6 = i * 64</code> çš„è®¡ç®—ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>i &gt;&gt;&gt; 6 = i / 64</code> çš„æ–¹å¼ï¼ŒçŸ¥é“æ˜¯ <code>bitmap</code> æ•°ç»„çš„ç¬¬å‡ ä¸ªå…ƒç´ ã€‚</li>
<li>ç¬¬ 7 è¡Œï¼šå¾ªç¯ 64 bits ã€‚<ul>
<li>ç¬¬ 9 è¡Œï¼š<code>(bits &amp; 1) == 0</code> æ“ä½œï¼Œè®¡ç®—å½“å‰ bit æ˜¯å¦<strong>æœªåˆ†é…</strong>ã€‚<ul>
<li>ç¬¬ 11 è¡Œï¼š<code>baseVal | j</code> æ“ä½œï¼Œä½¿ç”¨<strong>ä½ 64 bits</strong> ï¼Œè¡¨ç¤ºåˆ†é… <code>bitmap</code> æ•°ç»„çš„å…ƒç´ çš„<strong>ç¬¬å‡  bit</strong> ã€‚</li>
<li>ç¬¬ 12 è¡Œï¼šå¯èƒ½ <code>bitmap</code> æ•°ç»„çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œå¹¶æ²¡æœ‰ 64 ä½ï¼Œé€šè¿‡ <code>baseVal | j &lt; maxNumElems</code> æ¥ä¿è¯ä¸è¶…è¿‡ä¸Šé™ã€‚å¦‚æœ<ul>
<li>ç¬¬ 13 è¡Œï¼šæœªè¶…è¿‡ï¼Œè¿”å› <code>val</code> ã€‚</li>
<li>ç¬¬ 15 è¡Œï¼šè¶…è¿‡ï¼Œç»“æŸå¾ªç¯ï¼Œæœ€ç»ˆè¿”å› <code>-1</code> ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 19 è¡Œï¼šå»æ‰å½“å‰ bit ã€‚è¿™æ ·ï¼Œä¸‹æ¬¡å¾ªç¯å°±å¯ä»¥åˆ¤æ–­ä¸‹ä¸€ä¸ª bit æ˜¯å¦<strong>æœªåˆ†é…</strong>ã€‚</li>
</ul>
</li>
<li>ç¬¬ 23 è¡Œï¼šè¿”å› <code>-1</code> ï¼Œè¡¨ç¤ºæœªæ‰¾åˆ°ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="2-6-destroy"><a href="#2-6-destroy" class="headerlink" title="2.6 destroy"></a>2.6 destroy</h2><p><code>#destroy()</code> æ–¹æ³•ï¼Œé”€æ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (chunk != <span class="keyword">null</span>) {</span><br><span class="line">        chunk.destroy();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-7-PoolSubpageMetric"><a href="#2-7-PoolSubpageMetric" class="headerlink" title="2.7 PoolSubpageMetric"></a>2.7 PoolSubpageMetric</h2><p><code>io.netty.buffer.PoolSubpageMetric</code> ï¼ŒPoolSubpage Metric æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PoolSubpageMetric</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of maximal elements that can be allocated out of the sub-page.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">maxNumElements</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of available elements to be allocated.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">numAvailable</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the size (in bytes) of the elements that will be allocated.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">elementSize</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the size (in bytes) of this page.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">pageSize</span><span class="params">()</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p>PoolChunk å¯¹ PoolChunkMetric æ¥å£çš„å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxNumElements</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">synchronized</span> (chunk.arena) {</span><br><span class="line">        <span class="keyword">return</span> maxNumElems;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">numAvailable</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">synchronized</span> (chunk.arena) {</span><br><span class="line">        <span class="keyword">return</span> numAvail;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">elementSize</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">synchronized</span> (chunk.arena) {</span><br><span class="line">        <span class="keyword">return</span> elemSize;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">pageSize</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> pageSize;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>PoolSubpage ç›¸æ¯” PoolChunk æ¥è¯´ï¼Œç®€å•å¥½å¤šã€‚å˜¿å˜¿ã€‚</p>
<p>å‚è€ƒå¦‚ä¸‹æ–‡ç« ï¼š</p>
<ul>
<li>å å°ç‹¼ <a href="https://www.jianshu.com/p/d91060311437" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥æµ…å‡ºNettyå†…å­˜ç®¡ç† PoolSubpageã€‹</a></li>
<li>Hypercube <a href="https://www.jianshu.com/p/7afd3a801b15" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆåï¼‰â€“PoolSubpageã€‹</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/ByteBuf-3-3-Jemalloc-subpage/" data-id="ck4pl3fp600e5fgcf7ybsopht" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>