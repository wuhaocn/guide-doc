<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆä¸€ï¼‰ä¹‹ Reactor æ¨¡å‹
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>ä»æœ¬æ–‡å¼€å§‹ï¼Œæˆ‘ä»¬æ¥åˆ†äº« Netty éå¸¸é‡è¦çš„ä¸€ä¸ªç»„ä»¶ EventLoop ã€‚åœ¨çœ‹ EventLoop çš„å…·ä½“å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥å¯¹ Reactor æ¨¡å‹åšä¸ªç®€å•çš„äº†è§£ã€‚</p>
<p>ä¸ºä»€ä¹ˆè¦äº†è§£ Reactor æ¨¡å‹å‘¢ï¼Ÿå› ä¸º EventLoop æ˜¯ Netty åŸºäº Reactor æ¨¡å‹çš„æ€æƒ³è¿›è¡Œå®ç°ã€‚æ‰€ä»¥ç†è§£ Reactor æ¨¡å‹ï¼Œå¯¹äºæˆ‘ä»¬ç†è§£ EventLoop ä¼šæœ‰å¾ˆå¤§å¸®åŠ©ã€‚</p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹ Reactor æ¨¡å‹çš„<strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼š</p>
<blockquote>
<p>å°†å…³æ³¨çš„ I/O äº‹ä»¶æ³¨å†Œåˆ°å¤šè·¯å¤ç”¨å™¨ä¸Šï¼Œä¸€æ—¦æœ‰ I/O äº‹ä»¶è§¦å‘ï¼Œå°†äº‹ä»¶åˆ†å‘åˆ°äº‹ä»¶å¤„ç†å™¨ä¸­ï¼Œæ‰§è¡Œå°±ç»ª I/O äº‹ä»¶å¯¹åº”çš„å¤„ç†å‡½æ•°ä¸­ã€‚æ¨¡å‹ä¸­æœ‰ä¸‰ä¸ªé‡è¦çš„ç»„ä»¶ï¼š</p>
<ul>
<li>å¤šè·¯å¤ç”¨å™¨ï¼šç”±æ“ä½œç³»ç»Ÿæä¾›æ¥å£ï¼ŒLinux æä¾›çš„ I/O å¤ç”¨æ¥å£æœ‰selectã€pollã€epoll ã€‚</li>
<li>äº‹ä»¶åˆ†ç¦»å™¨ï¼šå°†å¤šè·¯å¤ç”¨å™¨è¿”å›çš„å°±ç»ªäº‹ä»¶åˆ†å‘åˆ°äº‹ä»¶å¤„ç†å™¨ä¸­ã€‚</li>
<li>äº‹ä»¶å¤„ç†å™¨ï¼šå¤„ç†å°±ç»ªäº‹ä»¶å¤„ç†å‡½æ•°ã€‚</li>
</ul>
</blockquote>
<p>åˆæ­¥ä¸€çœ‹ï¼ŒJava NIO ç¬¦åˆ Reactor æ¨¡å‹å•Šï¼Ÿå› ä¸º Reactor æœ‰ 3 ç§æ¨¡å‹å®ç°ï¼š</p>
<ol>
<li>å• Reactor å•çº¿ç¨‹æ¨¡å‹</li>
<li>å• Reactor å¤šçº¿ç¨‹æ¨¡å‹</li>
<li>å¤š Reactor å¤šçº¿ç¨‹æ¨¡å‹</li>
</ol>
<blockquote>
<p>ğŸ˜ˆ ç”±äºè€è‰¿è‰¿ä¸æ“…é•¿ç›¸å¯¹ç†è®ºæ–‡ç« çš„å†…å®¹ç¼–å†™ï¼Œæ‰€ä»¥ <a href="#">ã€Œ2.ã€</a>ã€<a href="#">ã€Œ3.ã€</a>ã€<a href="#">ã€Œ4.ã€</a> å°èŠ‚çš„å†…å®¹ï¼Œæˆ‘å†³å®šä¸€æœ¬æ­£ç»çš„å¼•ç”¨åŸºå‹ wier çš„ <a href="https://my.oschina.net/u/1859679/blog/1844109" rel="external nofollow noopener noreferrer" target="_blank">ã€Šã€NIO ç³»åˆ—ã€‘â€”â€” ä¹‹Reactor æ¨¡å‹ã€‹</a> ã€‚</p>
</blockquote>
<h1 id="2-å•-Reactor-å•çº¿ç¨‹æ¨¡å‹"><a href="#2-å•-Reactor-å•çº¿ç¨‹æ¨¡å‹" class="headerlink" title="2. å• Reactor å•çº¿ç¨‹æ¨¡å‹"></a>2. å• Reactor å•çº¿ç¨‹æ¨¡å‹</h1><p>ç¤ºä¾‹å›¾å¦‚ä¸‹ï¼š</p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_05_01/01.png" title="å• Reactor å•çº¿ç¨‹æ¨¡å‹" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_05_01/01.png" alt="å• Reactor å•çº¿ç¨‹æ¨¡å‹"></a><span class="caption">å• Reactor å•çº¿ç¨‹æ¨¡å‹</span></p>
<blockquote>
<p>è€è‰¿è‰¿ï¼šç¤ºä¾‹ä»£ç ä¸»è¦è¡¨è¾¾å¤§ä½“é€»è¾‘ï¼Œæ¯”è¾ƒå¥”æ”¾ã€‚æ‰€ä»¥ï¼Œèƒ–å‹ç†è§£å¤§ä½“æ„æ€å°±å¥½ã€‚</p>
</blockquote>
<p>Reactor ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* ç­‰å¾…äº‹ä»¶åˆ°æ¥ï¼Œåˆ†å‘äº‹ä»¶å¤„ç†</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reactor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>{</span><br><span class="line">â€‹</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">Reactor</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">      SelectionKey sk = serverSocket.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">      <span class="comment">// attach Acceptor å¤„ç†æ–°è¿æ¥</span></span><br><span class="line">      sk.attach(<span class="keyword">new</span> Acceptor());</span><br><span class="line">  }</span><br><span class="line">â€‹</span><br><span class="line">â€‹  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">          <span class="keyword">while</span> (!Thread.interrupted()) {</span><br><span class="line">              selector.select();</span><br><span class="line">              Set selected = selector.selectedKeys();</span><br><span class="line">              Iterator it = selected.iterator();</span><br><span class="line">              <span class="keyword">while</span> (it.hasNext()) {</span><br><span class="line">                  it.remove();</span><br><span class="line">                  <span class="comment">//åˆ†å‘äº‹ä»¶å¤„ç†</span></span><br><span class="line">                  dispatch((SelectionKey) (it.next()));</span><br><span class="line">              }</span><br><span class="line">          }</span><br><span class="line">      } <span class="keyword">catch</span> (IOException ex) {</span><br><span class="line">          <span class="comment">//do something</span></span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line">â€‹</span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(SelectionKey k)</span> </span>{</span><br><span class="line">      <span class="comment">// è‹¥æ˜¯è¿æ¥äº‹ä»¶è·å–æ˜¯acceptor</span></span><br><span class="line">      <span class="comment">// è‹¥æ˜¯IOè¯»å†™äº‹ä»¶è·å–æ˜¯handler</span></span><br><span class="line">      Runnable runnable = (Runnable) (k.attachment());</span><br><span class="line">      <span class="keyword">if</span> (runnable != <span class="keyword">null</span>) {</span><br><span class="line">          runnable.run();</span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line">â€‹</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>è€è‰¿è‰¿ï¼šç¤ºä¾‹çš„ Handler çš„ä»£ç å®ç°åº”è¯¥æ˜¯æ¼äº†ã€‚èƒ–å‹è„‘è¡¥ä¸€ä¸ªå®ç° Runnable æ¥å£çš„ Handler ç±»ã€‚ğŸ˜ˆ</p>
</blockquote>
<p>è¿™æ˜¯æœ€åŸºç¡€çš„å• Reactor å•çº¿ç¨‹æ¨¡å‹ã€‚</p>
<p>Reactor çº¿ç¨‹ï¼Œè´Ÿè´£å¤šè·¯åˆ†ç¦»å¥—æ¥å­—ã€‚</p>
<ul>
<li>æœ‰æ–°è¿æ¥åˆ°æ¥è§¦å‘ <code>OP_ACCEPT</code> äº‹ä»¶ä¹‹åï¼Œ äº¤ç”± Acceptor è¿›è¡Œå¤„ç†ã€‚</li>
<li>æœ‰ IO è¯»å†™äº‹ä»¶ä¹‹åï¼Œäº¤ç»™ Handler å¤„ç†ã€‚</li>
</ul>
<p>Acceptor ä¸»è¦ä»»åŠ¡æ˜¯æ„é€  Handler ã€‚</p>
<ul>
<li>åœ¨è·å–åˆ° Client ç›¸å…³çš„ SocketChannel ä¹‹åï¼Œç»‘å®šåˆ°ç›¸åº”çš„ Handler ä¸Šã€‚</li>
<li>å¯¹åº”çš„ SocketChannel æœ‰è¯»å†™äº‹ä»¶ä¹‹åï¼ŒåŸºäº Reactor åˆ†å‘ï¼ŒHandler å°±å¯ä»¥å¤„ç†äº†ã€‚</li>
</ul>
<p><strong>æ³¨æ„ï¼Œæ‰€æœ‰çš„ IO äº‹ä»¶éƒ½ç»‘å®šåˆ° Selector ä¸Šï¼Œç”± Reactor ç»Ÿä¸€åˆ†å‘</strong>ã€‚</p>
<hr>
<p>è¯¥æ¨¡å‹é€‚ç”¨äºå¤„ç†å™¨é“¾ä¸­ä¸šåŠ¡å¤„ç†ç»„ä»¶èƒ½å¿«é€Ÿå®Œæˆçš„åœºæ™¯ã€‚ä¸è¿‡ï¼Œè¿™ç§å•çº¿ç¨‹æ¨¡å‹ä¸èƒ½å……åˆ†åˆ©ç”¨å¤šæ ¸èµ„æºï¼Œ<strong>æ‰€ä»¥å®é™…ä½¿ç”¨çš„ä¸å¤š</strong>ã€‚</p>
<h1 id="3-å•-Reactor-å¤šçº¿ç¨‹æ¨¡å‹"><a href="#3-å•-Reactor-å¤šçº¿ç¨‹æ¨¡å‹" class="headerlink" title="3. å• Reactor å¤šçº¿ç¨‹æ¨¡å‹"></a>3. å• Reactor å¤šçº¿ç¨‹æ¨¡å‹</h1><p>ç¤ºä¾‹å›¾å¦‚ä¸‹ï¼š</p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_05_01/02.png" title="å• Reactor å¤šçº¿ç¨‹æ¨¡å‹" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_05_01/02.png" alt="å• Reactor å¤šçº¿ç¨‹æ¨¡å‹"></a><span class="caption">å• Reactor å¤šçº¿ç¨‹æ¨¡å‹</span></p>
<p>ç›¸å¯¹äºç¬¬ä¸€ç§å•çº¿ç¨‹çš„æ¨¡å¼æ¥è¯´ï¼Œåœ¨å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯è·å–åˆ° IO çš„è¯»å†™äº‹ä»¶ä¹‹åï¼Œäº¤ç”±çº¿ç¨‹æ± æ¥å¤„ç†ï¼Œè¿™æ ·å¯ä»¥å‡å°ä¸» Reactor çš„æ€§èƒ½å¼€é”€ï¼Œä»è€Œæ›´ä¸“æ³¨çš„åšäº‹ä»¶åˆ†å‘å·¥ä½œäº†ï¼Œä»è€Œæå‡æ•´ä¸ªåº”ç”¨çš„ååã€‚</p>
<p>MultiThreadHandler ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* å¤šçº¿ç¨‹å¤„ç†è¯»å†™ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiThreadHandler</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>{</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> READING = <span class="number">0</span>, WRITING = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> state;</span><br><span class="line">  <span class="keyword">final</span> SocketChannel socket;</span><br><span class="line">  <span class="keyword">final</span> SelectionKey sk;</span><br><span class="line">â€‹</span><br><span class="line">  <span class="comment">//å¤šçº¿ç¨‹å¤„ç†ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">  ExecutorService executorService = Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors());</span><br><span class="line">â€‹</span><br><span class="line">â€‹</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MultiThreadHandler</span><span class="params">(SocketChannel socket, Selector sl)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">      <span class="keyword">this</span>.state = READING;</span><br><span class="line">      <span class="keyword">this</span>.socket = socket;</span><br><span class="line">      sk = socket.register(selector, SelectionKey.OP_READ);</span><br><span class="line">      sk.attach(<span class="keyword">this</span>);</span><br><span class="line">      socket.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">  }</span><br><span class="line">â€‹</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">      <span class="keyword">if</span> (state == READING) {</span><br><span class="line">          read();</span><br><span class="line">      } <span class="keyword">else</span> <span class="keyword">if</span> (state == WRITING) {</span><br><span class="line">          write();</span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line">â€‹</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>{</span><br><span class="line">      <span class="comment">//ä»»åŠ¡å¼‚æ­¥å¤„ç†</span></span><br><span class="line">      executorService.submit(() -&gt; process());</span><br><span class="line">â€‹</span><br><span class="line">      <span class="comment">//ä¸‹ä¸€æ­¥å¤„ç†å†™äº‹ä»¶</span></span><br><span class="line">      sk.interestOps(SelectionKey.OP_WRITE);</span><br><span class="line">      <span class="keyword">this</span>.state = WRITING;</span><br><span class="line">  }</span><br><span class="line">â€‹</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span> </span>{</span><br><span class="line">      <span class="comment">//ä»»åŠ¡å¼‚æ­¥å¤„ç†</span></span><br><span class="line">      executorService.submit(() -&gt; process());</span><br><span class="line">â€‹</span><br><span class="line">      <span class="comment">//ä¸‹ä¸€æ­¥å¤„ç†è¯»äº‹ä»¶</span></span><br><span class="line">      sk.interestOps(SelectionKey.OP_READ);</span><br><span class="line">      <span class="keyword">this</span>.state = READING;</span><br><span class="line">  }</span><br><span class="line">â€‹</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * task ä¸šåŠ¡å¤„ç†</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span> </span>{</span><br><span class="line">      <span class="comment">//do IO ,task,queue something</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨ <code>#read()</code> å’Œ <code>#write()</code> æ–¹æ³•ä¸­ï¼Œæäº¤ <code>executorService</code> çº¿ç¨‹æ± ï¼Œè¿›è¡Œå¤„ç†ã€‚</li>
</ul>
<h1 id="4-å¤š-Reactor-å¤šçº¿ç¨‹æ¨¡å‹"><a href="#4-å¤š-Reactor-å¤šçº¿ç¨‹æ¨¡å‹" class="headerlink" title="4. å¤š Reactor å¤šçº¿ç¨‹æ¨¡å‹"></a>4. å¤š Reactor å¤šçº¿ç¨‹æ¨¡å‹</h1><p>ç¤ºä¾‹å›¾å¦‚ä¸‹ï¼š</p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_05_01/03.png" title="å¤š Reactor å¤šçº¿ç¨‹æ¨¡å‹" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_05_01/03.png" alt="å¤š Reactor å¤šçº¿ç¨‹æ¨¡å‹"></a><span class="caption">å¤š Reactor å¤šçº¿ç¨‹æ¨¡å‹</span></p>
<p>ç¬¬ä¸‰ç§æ¨¡å‹æ¯”èµ·ç¬¬äºŒç§æ¨¡å‹ï¼Œæ˜¯å°† Reactor åˆ†æˆä¸¤éƒ¨åˆ†ï¼š</p>
<ol>
<li>mainReactor è´Ÿè´£ç›‘å¬ ServerSocketChannel ï¼Œç”¨æ¥å¤„ç†å®¢æˆ·ç«¯æ–°è¿æ¥çš„å»ºç«‹ï¼Œå¹¶å°†å»ºç«‹çš„å®¢æˆ·ç«¯çš„ SocketChannel æŒ‡å®šæ³¨å†Œç»™ subReactor ã€‚</li>
<li>subReactor ç»´æŠ¤è‡ªå·±çš„ Selector ï¼ŒåŸºäº mainReactor å»ºç«‹çš„å®¢æˆ·ç«¯çš„ SocketChannel å¤šè·¯åˆ†ç¦» IO è¯»å†™äº‹ä»¶ï¼Œè¯»å†™ç½‘ç»œæ•°æ®ã€‚å¯¹äºä¸šåŠ¡å¤„ç†çš„åŠŸèƒ½ï¼Œå¦å¤–æ‰”ç»™ worker çº¿ç¨‹æ± æ¥å®Œæˆã€‚</li>
</ol>
<p>MultiWorkThreadAcceptor ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* å¤šwork è¿æ¥äº‹ä»¶Acceptor,å¤„ç†è¿æ¥äº‹ä»¶</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiWorkThreadAcceptor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>{</span><br><span class="line">â€‹</span><br><span class="line">  <span class="comment">// cpuçº¿ç¨‹æ•°ç›¸åŒå¤šworkçº¿ç¨‹</span></span><br><span class="line">  <span class="keyword">int</span> workCount = Runtime.getRuntime().availableProcessors();</span><br><span class="line">  SubReactor[] workThreadHandlers = <span class="keyword">new</span> SubReactor[workCount];</span><br><span class="line">  <span class="keyword">volatile</span> <span class="keyword">int</span> nextHandler = <span class="number">0</span>;</span><br><span class="line">â€‹</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MultiWorkThreadAcceptor</span><span class="params">()</span> </span>{</span><br><span class="line">      <span class="keyword">this</span>.init();</span><br><span class="line">  }</span><br><span class="line">â€‹</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>{</span><br><span class="line">      nextHandler = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; workThreadHandlers.length; i++) {</span><br><span class="line">          <span class="keyword">try</span> {</span><br><span class="line">              workThreadHandlers[i] = <span class="keyword">new</span> SubReactor();</span><br><span class="line">          } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">          }</span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line">â€‹</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">      <span class="keyword">try</span> {</span><br><span class="line">          SocketChannel c = serverSocket.accept();</span><br><span class="line">          <span class="keyword">if</span> (c != <span class="keyword">null</span>) {<span class="comment">// æ³¨å†Œè¯»å†™</span></span><br><span class="line">              <span class="keyword">synchronized</span> (c) {</span><br><span class="line">                  <span class="comment">// é¡ºåºè·å–SubReactorï¼Œç„¶åæ³¨å†Œchannel </span></span><br><span class="line">                  SubReactor work = workThreadHandlers[nextHandler];</span><br><span class="line">                  work.registerChannel(c);</span><br><span class="line">                  nextHandler++;</span><br><span class="line">                  <span class="keyword">if</span> (nextHandler &gt;= workThreadHandlers.length) {</span><br><span class="line">                      nextHandler = <span class="number">0</span>;</span><br><span class="line">                  }</span><br><span class="line">              }</span><br><span class="line">          }</span><br><span class="line">      } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>SubReactor ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* å¤šworkçº¿ç¨‹å¤„ç†è¯»å†™ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubReactor</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>{</span><br><span class="line">  <span class="keyword">final</span> Selector mySelector;</span><br><span class="line">â€‹</span><br><span class="line">  <span class="comment">//å¤šçº¿ç¨‹å¤„ç†ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">  <span class="keyword">int</span> workCount =Runtime.getRuntime().availableProcessors();</span><br><span class="line">  ExecutorService executorService = Executors.newFixedThreadPool(workCount);</span><br><span class="line">â€‹</span><br><span class="line">â€‹</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">SubReactor</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">      <span class="comment">// æ¯ä¸ªSubReactor ä¸€ä¸ªselector </span></span><br><span class="line">      <span class="keyword">this</span>.mySelector = SelectorProvider.provider().openSelector();</span><br><span class="line">  }</span><br><span class="line">â€‹</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * æ³¨å†Œchanel</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> sc</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerChannel</span><span class="params">(SocketChannel sc)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">      sc.register(mySelector, SelectionKey.OP_READ | SelectionKey.OP_CONNECT);</span><br><span class="line">  }</span><br><span class="line">â€‹</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">      <span class="keyword">while</span> (<span class="keyword">true</span>) {</span><br><span class="line">          <span class="keyword">try</span> {</span><br><span class="line">          <span class="comment">//æ¯ä¸ªSubReactor è‡ªå·±åšäº‹ä»¶åˆ†æ´¾å¤„ç†è¯»å†™äº‹ä»¶</span></span><br><span class="line">              selector.select();</span><br><span class="line">              Set&lt;SelectionKey&gt; keys = selector.selectedKeys();</span><br><span class="line">              Iterator&lt;SelectionKey&gt; iterator = keys.iterator();</span><br><span class="line">              <span class="keyword">while</span> (iterator.hasNext()) {</span><br><span class="line">                  SelectionKey key = iterator.next();</span><br><span class="line">                  iterator.remove();</span><br><span class="line">                  <span class="keyword">if</span> (key.isReadable()) {</span><br><span class="line">                      read();</span><br><span class="line">                  } <span class="keyword">else</span> <span class="keyword">if</span> (key.isWritable()) {</span><br><span class="line">                      write();</span><br><span class="line">                  }</span><br><span class="line">              }</span><br><span class="line">â€‹</span><br><span class="line">          } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">â€‹</span><br><span class="line">          }</span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line">â€‹</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>{</span><br><span class="line">      <span class="comment">//ä»»åŠ¡å¼‚æ­¥å¤„ç†</span></span><br><span class="line">      executorService.submit(() -&gt; process());</span><br><span class="line">  }</span><br><span class="line">â€‹</span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">()</span> </span>{</span><br><span class="line">      <span class="comment">//ä»»åŠ¡å¼‚æ­¥å¤„ç†</span></span><br><span class="line">      executorService.submit(() -&gt; process());</span><br><span class="line">  }</span><br><span class="line">â€‹</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * task ä¸šåŠ¡å¤„ç†</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span> </span>{</span><br><span class="line">      <span class="comment">//do IO ,task,queue something</span></span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ä»ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š</p>
<ol>
<li>mainReactor ä¸»è¦ç”¨æ¥å¤„ç†ç½‘ç»œ IO è¿æ¥å»ºç«‹æ“ä½œï¼Œé€šå¸¸ï¼ŒmainReactor åªéœ€è¦ä¸€ä¸ªï¼Œå› ä¸ºå®ƒä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥å¤„ç†ã€‚</li>
<li>subReactor ä¸»è¦å’Œå»ºç«‹èµ·æ¥çš„å®¢æˆ·ç«¯çš„ SocketChannel åšæ•°æ®äº¤äº’å’Œäº‹ä»¶ä¸šåŠ¡å¤„ç†æ“ä½œã€‚é€šå¸¸ï¼ŒsubReactor çš„ä¸ªæ•°å’Œ CPU ä¸ªæ•°<strong>ç›¸ç­‰</strong>ï¼Œæ¯ä¸ª subReactor <strong>ç‹¬å </strong>ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ã€‚</li>
</ol>
<hr>
<p>æ­¤ç§æ¨¡å¼ä¸­ï¼Œæ¯ä¸ªæ¨¡å—çš„å·¥ä½œæ›´åŠ ä¸“ä¸€ï¼Œè€¦åˆåº¦æ›´ä½ï¼Œæ€§èƒ½å’Œç¨³å®šæ€§ä¹Ÿå¤§å¤§çš„æå‡ï¼Œæ”¯æŒçš„å¯å¹¶å‘å®¢æˆ·ç«¯æ•°é‡å¯è¾¾åˆ°ä¸Šç™¾ä¸‡çº§åˆ«ã€‚</p>
<blockquote>
<p>è€è‰¿è‰¿ï¼šä¸€èˆ¬æ¥è¯´ï¼Œæ˜¯è¾¾åˆ°æ•°åä¸‡çº§åˆ«ã€‚</p>
</blockquote>
<p>å…³äºæ­¤ç§æ¨¡å¼çš„åº”ç”¨ï¼Œç›®å‰æœ‰å¾ˆå¤šä¼˜ç§€çš„æ¡†æ¶å·²ç»åœ¨åº”ç”¨ï¼Œæ¯”å¦‚ Mina å’Œ Netty ç­‰ç­‰ã€‚<strong>ä¸Šè¿°ä¸­å»æ‰çº¿ç¨‹æ± çš„ç¬¬ä¸‰ç§å½¢å¼çš„å˜ç§ï¼Œä¹Ÿæ˜¯ Netty NIO çš„é»˜è®¤æ¨¡å¼</strong>ã€‚</p>
<h1 id="5-Netty-NIO-å®¢æˆ·ç«¯"><a href="#5-Netty-NIO-å®¢æˆ·ç«¯" class="headerlink" title="5. Netty NIO å®¢æˆ·ç«¯"></a>5. Netty NIO å®¢æˆ·ç«¯</h1><p>æˆ‘ä»¬æ¥çœ‹çœ‹ Netty NIO å®¢æˆ·ç«¯çš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œå’Œ EventLoop ç›¸å…³çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ª EventLoopGroup å¯¹è±¡</span></span><br><span class="line">EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line"><span class="comment">// åˆ›å»º Bootstrap å¯¹è±¡</span></span><br><span class="line">Bootstrap b = <span class="keyword">new</span> Bootstrap();</span><br><span class="line"><span class="comment">// è®¾ç½®ä½¿ç”¨çš„ EventLoopGroup</span></span><br><span class="line">b.group(group);</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¯¹äº Netty NIO å®¢æˆ·ç«¯æ¥è¯´ï¼Œä»…åˆ›å»ºä¸€ä¸ª EventLoopGroup ã€‚ </li>
<li>ä¸€ä¸ª EventLoop å¯ä»¥å¯¹åº”ä¸€ä¸ª Reactor ã€‚å› ä¸º EventLoopGroup æ˜¯ EventLoop çš„åˆ†ç»„ï¼Œæ‰€ä»¥å¯¹ç­‰ç†è§£ï¼ŒEventLoopGroup æ˜¯<strong>ä¸€ç§</strong> Reactor çš„åˆ†ç»„ã€‚</li>
<li>ä¸€ä¸ª Bootstrap çš„å¯åŠ¨ï¼Œåªèƒ½å‘èµ·å¯¹ä¸€ä¸ªè¿œç¨‹çš„åœ°å€ã€‚æ‰€ä»¥åªä¼šä½¿ç”¨ä¸€ä¸ª NIO Selector ï¼Œä¹Ÿå°±æ˜¯è¯´ä»…ä½¿ç”¨<strong>ä¸€ä¸ª</strong> Reactor ã€‚å³ä½¿ï¼Œæˆ‘ä»¬åœ¨å£°æ˜ä½¿ç”¨ä¸€ä¸ª EventLoopGroup ï¼Œè¯¥ EventLoopGroup ä¹Ÿåªä¼šåˆ†é…ä¸€ä¸ª EventLoop å¯¹ IO äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚</li>
<li>å› ä¸º Reactor æ¨¡å‹ä¸»è¦ä½¿ç”¨æœåŠ¡ç«¯çš„å¼€å‘ä¸­ï¼Œå¦‚æœå¥—ç”¨åœ¨ Netty NIO å®¢æˆ·ç«¯ä¸­ï¼Œåˆ°åº•ä½¿ç”¨äº†å“ªä¸€ç§æ¨¡å¼å‘¢ï¼Ÿ<ul>
<li>å¦‚æœåªæœ‰ä¸€ä¸ªä¸šåŠ¡çº¿ç¨‹ä½¿ç”¨ Netty NIO å®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆå¯ä»¥è®¤ä¸ºæ˜¯ã€å• Reactor <strong>å•</strong>çº¿ç¨‹æ¨¡å‹ã€‘ã€‚</li>
<li>å¦‚æœæœ‰<strong>å¤šä¸ª</strong>ä¸šåŠ¡çº¿ç¨‹ä½¿ç”¨ Netty NIO å®¢æˆ·ç«¯ï¼Œé‚£ä¹ˆå¯ä»¥è®¤ä¸ºæ˜¯ã€å• Reactor <strong>å¤š</strong>çº¿ç¨‹æ¨¡å‹ã€‘ã€‚</li>
</ul>
</li>
<li>é‚£ä¹ˆ Netty NIO å®¢æˆ·ç«¯æ˜¯å¦èƒ½å¤Ÿä½¿ç”¨ã€å¤š Reactor å¤šçº¿ç¨‹æ¨¡å‹ã€‘å‘¢ï¼ŸğŸ˜ˆ åˆ›å»ºå¤šä¸ª Netty NIO å®¢æˆ·ç«¯ï¼Œè¿æ¥åŒä¸€ä¸ªæœåŠ¡ç«¯ã€‚é‚£ä¹ˆå¤šä¸ª Netty å®¢æˆ·ç«¯å°±å¯ä»¥è®¤ä¸ºç¬¦åˆå¤š Reactor å¤šçº¿ç¨‹æ¨¡å‹äº†ã€‚<ul>
<li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ä¼šè¿™ä¹ˆå¹²ã€‚</li>
<li>å½“ç„¶ï¼Œå®é™…ä¹Ÿæœ‰è¿™æ ·çš„ç¤ºä¾‹ã€‚ä¾‹å¦‚ Dubbo æˆ– Motan è¿™ä¸¤ä¸ª RPC æ¡†æ¶ï¼Œæ”¯æŒé€šè¿‡é…ç½®ï¼ŒåŒä¸€ä¸ª Consumer å¯¹åŒä¸€ä¸ª Provider å®ä¾‹åŒæ—¶å»ºç«‹å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚ </li>
</ul>
</li>
</ul>
<h1 id="6-Netty-NIO-æœåŠ¡ç«¯"><a href="#6-Netty-NIO-æœåŠ¡ç«¯" class="headerlink" title="6. Netty NIO æœåŠ¡ç«¯"></a>6. Netty NIO æœåŠ¡ç«¯</h1><p>æˆ‘ä»¬æ¥çœ‹çœ‹ Netty NIO æœåŠ¡ç«¯çš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œå’Œ EventLoop ç›¸å…³çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸¤ä¸ª EventLoopGroup å¯¹è±¡</span></span><br><span class="line">EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>); <span class="comment">// åˆ›å»º boss çº¿ç¨‹ç»„ ç”¨äºæœåŠ¡ç«¯æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥</span></span><br><span class="line">EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup(); <span class="comment">// åˆ›å»º worker çº¿ç¨‹ç»„ ç”¨äºè¿›è¡Œ SocketChannel çš„æ•°æ®è¯»å†™</span></span><br><span class="line"><span class="comment">// åˆ›å»º ServerBootstrap å¯¹è±¡</span></span><br><span class="line">ServerBootstrap b = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line"><span class="comment">// è®¾ç½®ä½¿ç”¨çš„ EventLoopGroup</span></span><br><span class="line">b.group(bossGroup, workerGroup);</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¯¹äº Netty NIO æœåŠ¡ç«¯æ¥è¯´ï¼Œåˆ›å»ºä¸¤ä¸ª EventLoopGroup ã€‚<ul>
<li><code>bossGroup</code> å¯¹åº” Reactor æ¨¡å¼çš„ mainReactor ï¼Œç”¨äºæœåŠ¡ç«¯æ¥å—å®¢æˆ·ç«¯çš„è¿æ¥ã€‚æ¯”è¾ƒç‰¹æ®Šçš„æ˜¯ï¼Œä¼ å…¥äº†æ–¹æ³•å‚æ•° <code>nThreads = 1</code> ï¼Œè¡¨ç¤ºåªä½¿ç”¨ä¸€ä¸ª EventLoop ï¼Œå³åªä½¿ç”¨ä¸€ä¸ª Reactor ã€‚è¿™ä¸ªä¹Ÿç¬¦åˆæˆ‘ä»¬ä¸Šé¢æåˆ°çš„ï¼Œâ€œ<em>é€šå¸¸ï¼ŒmainReactor åªéœ€è¦ä¸€ä¸ªï¼Œå› ä¸ºå®ƒä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥å¤„ç†</em>â€ã€‚</li>
<li><code>workerGroup</code> å¯¹åº” Reactor æ¨¡å¼çš„ subReactor ï¼Œç”¨äºè¿›è¡Œ SocketChannel çš„æ•°æ®è¯»å†™ã€‚å¯¹äº EventLoopGroup ï¼Œå¦‚æœæœªä¼ é€’æ–¹æ³•å‚æ•° <code>nThreads</code> ï¼Œè¡¨ç¤ºä½¿ç”¨ CPU ä¸ªæ•° Reactor ã€‚è¿™ä¸ªä¹Ÿç¬¦åˆæˆ‘ä»¬ä¸Šé¢æåˆ°çš„ï¼Œâ€œ<em>é€šå¸¸ï¼ŒsubReactor çš„ä¸ªæ•°å’Œ CPU ä¸ªæ•°ç›¸ç­‰ï¼Œæ¯ä¸ª subReactor ç‹¬å ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†</em>â€ã€‚</li>
</ul>
</li>
<li>å› ä¸ºä½¿ç”¨ä¸¤ä¸ª EventLoopGroup ï¼Œæ‰€ä»¥ç¬¦åˆã€å¤š Reactor å¤šçº¿ç¨‹æ¨¡å‹ã€‘çš„å¤š Reactor çš„è¦æ±‚ã€‚å®é™…åœ¨ä½¿ç”¨æ—¶ï¼Œ<code>workerGroup</code> åœ¨è¯»å®Œæ•°æ®æ—¶ï¼Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œæˆ‘ä»¬ä¼šæäº¤åˆ°<strong>ä¸“é—¨çš„ä¸šåŠ¡é€»è¾‘çº¿ç¨‹æ± </strong>ï¼Œä¾‹å¦‚åœ¨ Dubbo æˆ– Motan è¿™ä¸¤ä¸ª RPC æ¡†æ¶ä¸­ã€‚è¿™æ ·ä¸€æ¥ï¼Œå°±å®Œå…¨ç¬¦åˆã€å¤š Reactor å¤šçº¿ç¨‹æ¨¡å‹ã€‘ã€‚</li>
<li>é‚£ä¹ˆå¯èƒ½æœ‰èƒ–å‹å¯èƒ½å’Œæˆ‘æœ‰ä¸€æ ·çš„ç–‘é—®ï¼Œ<code>bossGroup</code> å¦‚æœé…ç½®å¤šä¸ªçº¿ç¨‹ï¼Œæ˜¯å¦å¯ä»¥ä½¿ç”¨<strong>å¤šä¸ª mainReactor</strong> å‘¢ï¼Ÿæˆ‘ä»¬æ¥åˆ†æä¸€æ³¢ï¼Œä¸€ä¸ª Netty NIO æœåŠ¡ç«¯<strong>åŒä¸€æ—¶é—´</strong>ï¼Œåªèƒ½ bind ä¸€ä¸ªç«¯å£ï¼Œé‚£ä¹ˆåªèƒ½ä½¿ç”¨ä¸€ä¸ª Selector å¤„ç†å®¢æˆ·ç«¯è¿æ¥äº‹ä»¶ã€‚åˆå› ä¸ºï¼ŒSelector æ“ä½œæ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œæ‰€ä»¥æ— æ³•åœ¨å¤šä¸ª EventLoop ( å¤šä¸ªçº¿ç¨‹ )ä¸­ï¼ŒåŒæ—¶æ“ä½œã€‚æ‰€ä»¥è¿™æ ·å°±å¯¼è‡´ï¼Œå³ä½¿ <code>bossGroup</code> é…ç½®å¤šä¸ªçº¿ç¨‹ï¼Œå®é™…èƒ½å¤Ÿä½¿ç”¨çš„ä¹Ÿå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ã€‚</li>
<li>é‚£ä¹ˆå¦‚æœä¸€å®šä¸€å®šä¸€å®šè¦å¤šä¸ª mainReactor å‘¢ï¼Ÿåˆ›å»ºå¤šä¸ª Netty NIO æœåŠ¡ç«¯ï¼Œå¹¶ç»‘å®šå¤šä¸ªç«¯å£ã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å¦‚æœ Reactor æ¨¡å¼è®²è§£çš„ä¸å¤Ÿæ¸…æ™°ï¼Œæˆ–è€…æƒ³è¦æ›´åŠ æ·±å…¥çš„ç†è§£ï¼Œæ¨èé˜…è¯»å¦‚ä¸‹æ–‡ç« ï¼š</p>
<ul>
<li>wier <a href="https://my.oschina.net/u/1859679/blog/1844109" rel="external nofollow noopener noreferrer" target="_blank">ã€Šã€NIO ç³»åˆ—ã€‘â€”â€” ä¹‹ Reactor æ¨¡å‹ã€‹</a></li>
<li>æ°¸é¡º <a href="https://segmentfault.com/a/1190000007403873" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty æºç åˆ†æä¹‹ ä¸‰ æˆ‘å°±æ˜¯å¤§åé¼é¼çš„ EventLoop(ä¸€)ã€‹</a> é‡Œé¢æœ‰å‡ ä¸ªå›¾ä¸é”™ã€‚</li>
<li>Essviv <a href="https://essviv.github.io/2017/01/25/IO/netty/reactor%E6%A8%A1%E5%9E%8B/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠReactor æ¨¡å‹ã€‹</a> é‡Œé¢çš„ä»£ç ç¤ºä¾‹ä¸é”™ã€‚</li>
<li>xieshuang <a href="https://tech.youzan.com/yi-bu-wang-luo-mo-xing/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šå¼‚æ­¥ç½‘ç»œæ¨¡å‹ã€‹</a> å†…å®¹å¾ˆé«˜ç«¯ï¼Œä¸€çœ‹å°±æ˜¯é«˜ç©ã€‚</li>
</ul>
<p>å¦å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªç»å…¸çš„ Proactor æ¨¡å‹ï¼Œå› ä¸º Netty å¹¶æœªå®ç°ï¼Œæ‰€ä»¥ç¬”è€…å°±çœç•¥äº†ã€‚å¦‚æœæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥è‡ªè¡Œ Google ç†è§£ä¸‹ã€‚</p>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/EventLoop-1-Reactor-Model/" data-id="ck4pl3fou00dafgcf448tkf5f" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>A