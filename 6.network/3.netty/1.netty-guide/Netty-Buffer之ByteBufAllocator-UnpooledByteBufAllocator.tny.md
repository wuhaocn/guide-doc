<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ ByteBufAllocatorï¼ˆäºŒï¼‰UnpooledByteBufAllocator
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥åˆ†äº« UnpooledByteBufAllocator ï¼Œ<strong>æ™®é€š</strong>çš„ ByteBuf çš„åˆ†é…å™¨ï¼Œ<strong>ä¸åŸºäºå†…å­˜æ± </strong>ã€‚</p>
<h1 id="2-ByteBufAllocatorMetricProvider"><a href="#2-ByteBufAllocatorMetricProvider" class="headerlink" title="2. ByteBufAllocatorMetricProvider"></a>2. ByteBufAllocatorMetricProvider</h1><p><code>io.netty.buffer.ByteBufAllocatorMetricProvider</code> ï¼ŒByteBufAllocator Metric æä¾›è€…æ¥å£ï¼Œ<strong>ç”¨äºç›‘æ§ ByteBuf çš„ Heap å’Œ Direct å ç”¨å†…å­˜çš„æƒ…å†µ</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ByteBufAllocatorMetricProvider</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns a {<span class="doctag">@link</span> ByteBufAllocatorMetric} for a {<span class="doctag">@link</span> ByteBufAllocator}.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ByteBufAllocatorMetric <span class="title">metric</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ByteBufAllocatorMetricProvider æœ‰ä¸¤ä¸ªå­ç±»ï¼šUnpooledByteBufAllocator å’Œ PooledByteBufAllocator ã€‚</p>
<h1 id="3-ByteBufAllocatorMetric"><a href="#3-ByteBufAllocatorMetric" class="headerlink" title="3. ByteBufAllocatorMetric"></a>3. ByteBufAllocatorMetric</h1><p><code>io.netty.buffer.ByteBufAllocatorMetric</code> ï¼ŒByteBufAllocator Metric æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ByteBufAllocatorMetric</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the number of bytes of heap memory used by a {<span class="doctag">@link</span> ByteBufAllocator} or {<span class="doctag">@code</span> -1} if unknown.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * å·²ä½¿ç”¨ Heap å ç”¨å†…å­˜å¤§å°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">usedHeapMemory</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the number of bytes of direct memory used by a {<span class="doctag">@link</span> ByteBufAllocator} or {<span class="doctag">@code</span> -1} if unknown.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * å·²ä½¿ç”¨ Direct å ç”¨å†…å­˜å¤§å°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">usedDirectMemory</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ByteBufAllocatorMetric æœ‰ä¸¤ä¸ªå­ç±»ï¼šUnpooledByteBufAllocatorMetric å’Œ PooledByteBufAllocatorMetric ã€‚</p>
<h2 id="3-1-UnpooledByteBufAllocatorMetric"><a href="#3-1-UnpooledByteBufAllocatorMetric" class="headerlink" title="3.1 UnpooledByteBufAllocatorMetric"></a>3.1 UnpooledByteBufAllocatorMetric</h2><p>UnpooledByteBufAllocatorMetric ï¼Œåœ¨ UnpooledByteBufAllocator çš„<strong>å†…éƒ¨é™æ€ç±»</strong>ï¼Œå®ç° ByteBufAllocatorMetric æ¥å£ï¼ŒUnpooledByteBufAllocator Metric å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Direct ByteBuf å ç”¨å†…å­˜å¤§å°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> LongCounter directCounter = PlatformDependent.newLongCounter();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Heap ByteBuf å ç”¨å†…å­˜å¤§å°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> LongCounter heapCounter = PlatformDependent.newLongCounter();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">usedHeapMemory</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> heapCounter.value();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">usedDirectMemory</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> directCounter.value();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ¯”è¾ƒç®€å•ï¼Œä¸¤ä¸ªè®¡æ•°å™¨ã€‚</li>
<li><p><code>PlatformDependent#newLongCounter()</code> æ–¹æ³•ï¼Œè·å¾— LongCounter å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a new fastest {<span class="doctag">@link</span> LongCounter} implementation for the current platform.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LongCounter <span class="title">newLongCounter</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (javaVersion() &gt;= <span class="number">8</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LongAdderCounter();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AtomicLongCounter();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¹Ÿå°±æ˜¯è¯´ï¼ŒJDK <code>&gt;=8</code> ä½¿ç”¨ <code>java.util.concurrent.atomic.LongAdder</code> ï¼ŒJDK <code>&lt;7</code> ä½¿ç”¨ <code>java.util.concurrent.atomic.AtomicLong</code> ã€‚ç›¸æ¯”æ¥è¯´ï¼ŒMetric å†™å¤šè¯»å°‘ï¼Œæ‰€ä»¥ LongAdder æ¯” AtomicLong æ›´åˆé€‚ã€‚å¯¹æ¯”çš„è§£æï¼Œå¯ä»¥çœ‹çœ‹ <a href="https://www.cnkirito.moe/java-concurrent-counter/" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJavaå¹¶å‘è®¡æ•°å™¨æ¢ç§˜ã€‹</a> ã€‚</li>
</ul>
</li>
</ul>
<h1 id="4-UnpooledByteBufAllocator"><a href="#4-UnpooledByteBufAllocator" class="headerlink" title="4. UnpooledByteBufAllocator"></a>4. UnpooledByteBufAllocator</h1><p><code>io.netty.buffer.UnpooledByteBufAllocator</code> ï¼Œå®ç° ByteBufAllocatorMetricProvider æ¥å£ï¼Œç»§æ‰¿ AbstractByteBufAllocator æŠ½è±¡ç±»ï¼Œ<strong>æ™®é€š</strong>çš„ ByteBuf çš„åˆ†é…å™¨ï¼Œ<strong>ä¸åŸºäºå†…å­˜æ± </strong>ã€‚</p>
<h2 id="4-1-æ„é€ æ–¹æ³•"><a href="#4-1-æ„é€ æ–¹æ³•" class="headerlink" title="4.1 æ„é€ æ–¹æ³•"></a>4.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Metric</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> UnpooledByteBufAllocatorMetric metric = <span class="keyword">new</span> UnpooledByteBufAllocatorMetric();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦ç¦ç”¨å†…å­˜æ³„éœ²æ£€æµ‹åŠŸèƒ½</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> disableLeakDetector;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸ä½¿ç”¨ `io.netty.util.internal.Cleaner` é‡Šæ”¾ Direct ByteBuf</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> UnpooledUnsafeNoCleanerDirectByteBuf</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> noCleaner;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UnpooledByteBufAllocator</span><span class="params">(<span class="keyword">boolean</span> preferDirect)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>(preferDirect, <span class="keyword">false</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UnpooledByteBufAllocator</span><span class="params">(<span class="keyword">boolean</span> preferDirect, <span class="keyword">boolean</span> disableLeakDetector)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>(preferDirect, disableLeakDetector, PlatformDependent.useDirectBufferNoCleaner() <span class="comment">/** è¿”å› true **/</span> );</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a new instance</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> preferDirect {<span class="doctag">@code</span> true} if {<span class="doctag">@link</span> #buffer(int)} should try to allocate a direct buffer rather than</span></span><br><span class="line"><span class="comment"> *                     a heap buffer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> disableLeakDetector {<span class="doctag">@code</span> true} if the leak-detection should be disabled completely for this</span></span><br><span class="line"><span class="comment"> *                            allocator. This can be useful if the user just want to depend on the GC to handle</span></span><br><span class="line"><span class="comment"> *                            direct buffers when not explicit released.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> tryNoCleaner {<span class="doctag">@code</span> true} if we should try to use {<span class="doctag">@link</span> PlatformDependent#allocateDirectNoCleaner(int)}</span></span><br><span class="line"><span class="comment"> *                            to allocate direct memory.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UnpooledByteBufAllocator</span><span class="params">(<span class="keyword">boolean</span> preferDirect, <span class="keyword">boolean</span> disableLeakDetector, <span class="keyword">boolean</span> tryNoCleaner)</span> </span>{</span><br><span class="line">    <span class="keyword">super</span>(preferDirect);</span><br><span class="line">    <span class="keyword">this</span>.disableLeakDetector = disableLeakDetector;</span><br><span class="line">    noCleaner = tryNoCleaner &amp;&amp; PlatformDependent.hasUnsafe() <span class="comment">/** è¿”å› true **/</span></span><br><span class="line">            &amp;&amp; PlatformDependent.hasDirectBufferNoCleanerConstructor() <span class="comment">/** è¿”å› true **/</span> ;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>metric</code> å±æ€§ï¼ŒUnpooledByteBufAllocatorMetric å¯¹è±¡ã€‚</li>
<li><code>disableLeakDetector</code> å±æ€§ï¼Œæ˜¯å¦ç¦ç”¨å†…å­˜æ³„éœ²æ£€æµ‹åŠŸèƒ½ã€‚<ul>
<li>é»˜è®¤ä¸º <code>false</code> ã€‚</li>
</ul>
</li>
<li><code>noCleaner</code> å±æ€§ï¼Œæ˜¯å¦ä¸ä½¿ç”¨ <code>io.netty.util.internal.Cleaner</code> æ¥é‡Šæ”¾ Direct ByteBuf ã€‚<ul>
<li>é»˜è®¤ä¸º <code>true</code> ã€‚</li>
<li>è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5.5 InstrumentedUnpooledUnsafeNoCleanerDirectByteBufã€</a> ã€‚</li>
</ul>
</li>
</ul>
<h2 id="4-2-newHeapBuffer"><a href="#4-2-newHeapBuffer" class="headerlink" title="4.2 newHeapBuffer"></a>4.2 newHeapBuffer</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ByteBuf <span class="title">newHeapBuffer</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> PlatformDependent.hasUnsafe() ?</span><br><span class="line">            <span class="keyword">new</span> InstrumentedUnpooledUnsafeHeapByteBuf(<span class="keyword">this</span>, initialCapacity, maxCapacity) :</span><br><span class="line">            <span class="keyword">new</span> InstrumentedUnpooledHeapByteBuf(<span class="keyword">this</span>, initialCapacity, maxCapacity);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åˆ›å»ºçš„æ˜¯ä»¥ <code>"Instrumented"</code> çš„ Heap ByteBuf å¯¹è±¡ï¼Œå› ä¸ºè¦ç»“åˆ Metric ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5. Instrumented ByteBufã€</a> ã€‚</li>
</ul>
<h2 id="4-3-newDirectBuffer"><a href="#4-3-newDirectBuffer" class="headerlink" title="4.3 newDirectBuffer"></a>4.3 newDirectBuffer</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ByteBuf <span class="title">newDirectBuffer</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> ByteBuf buf;</span><br><span class="line">    <span class="keyword">if</span> (PlatformDependent.hasUnsafe()) {</span><br><span class="line">        buf = noCleaner ? <span class="keyword">new</span> InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf(<span class="keyword">this</span>, initialCapacity, maxCapacity) :</span><br><span class="line">                <span class="keyword">new</span> InstrumentedUnpooledUnsafeDirectByteBuf(<span class="keyword">this</span>, initialCapacity, maxCapacity);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        buf = <span class="keyword">new</span> InstrumentedUnpooledDirectByteBuf(<span class="keyword">this</span>, initialCapacity, maxCapacity);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> disableLeakDetector ? buf : toLeakAwareBuffer(buf);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åˆ›å»ºçš„æ˜¯ä»¥ <code>"Instrumented"</code> çš„ Heap ByteBuf å¯¹è±¡ï¼Œå› ä¸ºè¦ç»“åˆ Metric ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5. Instrumented ByteBufã€</a> ã€‚</li>
<li>ç»“åˆäº† <code>disableLeakDetector</code> å±æ€§ã€‚</li>
</ul>
<h2 id="4-4-compositeHeapBuffer"><a href="#4-4-compositeHeapBuffer" class="headerlink" title="4.4 compositeHeapBuffer"></a>4.4 compositeHeapBuffer</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CompositeByteBuf <span class="title">compositeHeapBuffer</span><span class="params">(<span class="keyword">int</span> maxNumComponents)</span> </span>{</span><br><span class="line">    CompositeByteBuf buf = <span class="keyword">new</span> CompositeByteBuf(<span class="keyword">this</span>, <span class="keyword">false</span>, maxNumComponents);</span><br><span class="line">    <span class="keyword">return</span> disableLeakDetector ? buf : toLeakAwareBuffer(buf);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç»“åˆäº† <code>disableLeakDetector</code> å±æ€§ã€‚</li>
</ul>
<h2 id="4-5-compositeDirectBuffer"><a href="#4-5-compositeDirectBuffer" class="headerlink" title="4.5 compositeDirectBuffer"></a>4.5 compositeDirectBuffer</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CompositeByteBuf <span class="title">compositeDirectBuffer</span><span class="params">(<span class="keyword">int</span> maxNumComponents)</span> </span>{</span><br><span class="line">    CompositeByteBuf buf = <span class="keyword">new</span> CompositeByteBuf(<span class="keyword">this</span>, <span class="keyword">true</span>, maxNumComponents);</span><br><span class="line">    <span class="keyword">return</span> disableLeakDetector ? buf : toLeakAwareBuffer(buf);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç»“åˆäº† <code>disableLeakDetector</code> å±æ€§ã€‚</li>
</ul>
<h2 id="4-6-isDirectBufferPooled"><a href="#4-6-isDirectBufferPooled" class="headerlink" title="4.6 isDirectBufferPooled"></a>4.6 isDirectBufferPooled</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDirectBufferPooled</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="4-7-Metric-ç›¸å…³æ“ä½œæ–¹æ³•"><a href="#4-7-Metric-ç›¸å…³æ“ä½œæ–¹æ³•" class="headerlink" title="4.7 Metric ç›¸å…³æ“ä½œæ–¹æ³•"></a>4.7 Metric ç›¸å…³æ“ä½œæ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBufAllocatorMetric <span class="title">metric</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> metric;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">incrementDirect</span><span class="params">(<span class="keyword">int</span> amount)</span> </span>{ <span class="comment">// å¢åŠ  Direct</span></span><br><span class="line">    metric.directCounter.add(amount);</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">decrementDirect</span><span class="params">(<span class="keyword">int</span> amount)</span> </span>{ <span class="comment">// å‡å°‘ Direct</span></span><br><span class="line">    metric.directCounter.add(-amount);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">incrementHeap</span><span class="params">(<span class="keyword">int</span> amount)</span> </span>{ <span class="comment">// å¢åŠ  Heap</span></span><br><span class="line">    metric.heapCounter.add(amount);</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">decrementHeap</span><span class="params">(<span class="keyword">int</span> amount)</span> </span>{ <span class="comment">// å‡å°‘ Heap</span></span><br><span class="line">    metric.heapCounter.add(-amount);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="5-Instrumented-ByteBuf"><a href="#5-Instrumented-ByteBuf" class="headerlink" title="5. Instrumented ByteBuf"></a>5. Instrumented ByteBuf</h1><p>å› ä¸ºè¦å’Œ Metric ç»“åˆï¼Œæ‰€ä»¥é€šè¿‡<strong>ç»§æ‰¿</strong>çš„æ–¹å¼ï¼Œè¿›è¡Œå¢å¼ºã€‚</p>
<h2 id="5-1-InstrumentedUnpooledUnsafeHeapByteBuf"><a href="#5-1-InstrumentedUnpooledUnsafeHeapByteBuf" class="headerlink" title="5.1 InstrumentedUnpooledUnsafeHeapByteBuf"></a>5.1 InstrumentedUnpooledUnsafeHeapByteBuf</h2><p><strong>Instrumented</strong>UnpooledUnsafeHeapByteBuf ï¼Œåœ¨ UnpooledByteBufAllocator çš„<strong>å†…éƒ¨é™æ€ç±»</strong>ï¼Œç»§æ‰¿ UnpooledUnsafeHeapByteBuf ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InstrumentedUnpooledUnsafeHeapByteBuf</span> <span class="keyword">extends</span> <span class="title">UnpooledUnsafeHeapByteBuf</span> </span>{</span><br><span class="line"></span><br><span class="line">    InstrumentedUnpooledUnsafeHeapByteBuf(UnpooledByteBufAllocator alloc, <span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity) {</span><br><span class="line">        <span class="keyword">super</span>(alloc, initialCapacity, maxCapacity);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">byte</span>[] allocateArray(<span class="keyword">int</span> initialCapacity) {</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">super</span>.allocateArray(initialCapacity);</span><br><span class="line">        <span class="comment">// Metric ++</span></span><br><span class="line">        ((UnpooledByteBufAllocator) alloc()).incrementHeap(bytes.length);</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">freeArray</span><span class="params">(<span class="keyword">byte</span>[] array)</span> </span>{</span><br><span class="line">        <span class="keyword">int</span> length = array.length;</span><br><span class="line">        <span class="keyword">super</span>.freeArray(array);</span><br><span class="line">        <span class="comment">// Metric --</span></span><br><span class="line">        ((UnpooledByteBufAllocator) alloc()).decrementHeap(length);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨åŸå…ˆçš„åŸºç¡€ä¸Šï¼Œè°ƒç”¨ Metric ç›¸åº”çš„å¢å‡æ“ä½œæ–¹æ³•ï¼Œå¾—ä»¥è®°å½• Heap å ç”¨å†…å­˜çš„å¤§å°ã€‚</li>
</ul>
<h2 id="5-2-InstrumentedUnpooledHeapByteBuf"><a href="#5-2-InstrumentedUnpooledHeapByteBuf" class="headerlink" title="5.2 InstrumentedUnpooledHeapByteBuf"></a>5.2 InstrumentedUnpooledHeapByteBuf</h2><p><strong>Instrumented</strong>UnpooledHeapByteBuf ï¼Œåœ¨ UnpooledByteBufAllocator çš„<strong>å†…éƒ¨é™æ€ç±»</strong>ï¼Œç»§æ‰¿ UnpooledHeapByteBuf ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InstrumentedUnpooledHeapByteBuf</span> <span class="keyword">extends</span> <span class="title">UnpooledHeapByteBuf</span> </span>{</span><br><span class="line"></span><br><span class="line">    InstrumentedUnpooledHeapByteBuf(UnpooledByteBufAllocator alloc, <span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity) {</span><br><span class="line">        <span class="keyword">super</span>(alloc, initialCapacity, maxCapacity);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">byte</span>[] allocateArray(<span class="keyword">int</span> initialCapacity) {</span><br><span class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">super</span>.allocateArray(initialCapacity);</span><br><span class="line">        <span class="comment">// Metric ++</span></span><br><span class="line">        ((UnpooledByteBufAllocator) alloc()).incrementHeap(bytes.length);</span><br><span class="line">        <span class="keyword">return</span> bytes;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">freeArray</span><span class="params">(<span class="keyword">byte</span>[] array)</span> </span>{</span><br><span class="line">        <span class="keyword">int</span> length = array.length;</span><br><span class="line">        <span class="keyword">super</span>.freeArray(array);</span><br><span class="line">        <span class="comment">// Metric --</span></span><br><span class="line">        ((UnpooledByteBufAllocator) alloc()).decrementHeap(length);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨åŸå…ˆçš„åŸºç¡€ä¸Šï¼Œè°ƒç”¨ Metric ç›¸åº”çš„å¢å‡æ“ä½œæ–¹æ³•ï¼Œå¾—ä»¥è®°å½• Heap å ç”¨å†…å­˜çš„å¤§å°ã€‚</li>
</ul>
<h2 id="5-3-InstrumentedUnpooledUnsafeDirectByteBuf"><a href="#5-3-InstrumentedUnpooledUnsafeDirectByteBuf" class="headerlink" title="5.3 InstrumentedUnpooledUnsafeDirectByteBuf"></a>5.3 InstrumentedUnpooledUnsafeDirectByteBuf</h2><p><strong>Instrumented</strong>UnpooledUnsafeDirectByteBuf ï¼Œåœ¨ UnpooledByteBufAllocator çš„<strong>å†…éƒ¨é™æ€ç±»</strong>ï¼Œç»§æ‰¿ UnpooledUnsafeDirectByteBuf ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InstrumentedUnpooledUnsafeDirectByteBuf</span> <span class="keyword">extends</span> <span class="title">UnpooledUnsafeDirectByteBuf</span> </span>{</span><br><span class="line">    InstrumentedUnpooledUnsafeDirectByteBuf(</span><br><span class="line">            UnpooledByteBufAllocator alloc, <span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity) {</span><br><span class="line">        <span class="keyword">super</span>(alloc, initialCapacity, maxCapacity);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ByteBuffer <span class="title">allocateDirect</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>{</span><br><span class="line">        ByteBuffer buffer = <span class="keyword">super</span>.allocateDirect(initialCapacity);</span><br><span class="line">        <span class="comment">// Metric ++</span></span><br><span class="line">        ((UnpooledByteBufAllocator) alloc()).incrementDirect(buffer.capacity());</span><br><span class="line">        <span class="keyword">return</span> buffer;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">freeDirect</span><span class="params">(ByteBuffer buffer)</span> </span>{</span><br><span class="line">        <span class="keyword">int</span> capacity = buffer.capacity();</span><br><span class="line">        <span class="keyword">super</span>.freeDirect(buffer);</span><br><span class="line">        <span class="comment">// Metric --</span></span><br><span class="line">        ((UnpooledByteBufAllocator) alloc()).decrementDirect(capacity);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨åŸå…ˆçš„åŸºç¡€ä¸Šï¼Œè°ƒç”¨ Metric ç›¸åº”çš„å¢å‡æ“ä½œæ–¹æ³•ï¼Œå¾—ä»¥è®°å½• Direct å ç”¨å†…å­˜çš„å¤§å°ã€‚</li>
</ul>
<h2 id="5-4-InstrumentedUnpooledDirectByteBuf"><a href="#5-4-InstrumentedUnpooledDirectByteBuf" class="headerlink" title="5.4 InstrumentedUnpooledDirectByteBuf"></a>5.4 InstrumentedUnpooledDirectByteBuf</h2><p><strong>Instrumented</strong>UnpooledDirectByteBuf çš„<strong>å†…éƒ¨é™æ€ç±»</strong>ï¼Œç»§æ‰¿ UnpooledDirectByteBuf ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InstrumentedUnpooledDirectByteBuf</span> <span class="keyword">extends</span> <span class="title">UnpooledDirectByteBuf</span> </span>{</span><br><span class="line"></span><br><span class="line">    InstrumentedUnpooledDirectByteBuf(</span><br><span class="line">            UnpooledByteBufAllocator alloc, <span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity) {</span><br><span class="line">        <span class="keyword">super</span>(alloc, initialCapacity, maxCapacity);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ByteBuffer <span class="title">allocateDirect</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>{</span><br><span class="line">        ByteBuffer buffer = <span class="keyword">super</span>.allocateDirect(initialCapacity);</span><br><span class="line">        <span class="comment">// Metric ++</span></span><br><span class="line">        ((UnpooledByteBufAllocator) alloc()).incrementDirect(buffer.capacity());</span><br><span class="line">        <span class="keyword">return</span> buffer;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">freeDirect</span><span class="params">(ByteBuffer buffer)</span> </span>{</span><br><span class="line">        <span class="keyword">int</span> capacity = buffer.capacity();</span><br><span class="line">        <span class="keyword">super</span>.freeDirect(buffer);</span><br><span class="line">        <span class="comment">// Metric --</span></span><br><span class="line">        ((UnpooledByteBufAllocator) alloc()).decrementDirect(capacity);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨åŸå…ˆçš„åŸºç¡€ä¸Šï¼Œè°ƒç”¨ Metric ç›¸åº”çš„å¢å‡æ“ä½œæ–¹æ³•ï¼Œå¾—ä»¥è®°å½• Direct å ç”¨å†…å­˜çš„å¤§å°ã€‚</li>
</ul>
<h2 id="5-5-InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf"><a href="#5-5-InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf" class="headerlink" title="5.5 InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf"></a>5.5 InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf</h2><p><strong>Instrumented</strong>UnpooledDirectByteBuf çš„<strong>å†…éƒ¨é™æ€ç±»</strong>ï¼Œç»§æ‰¿ UnpooledUnsafeNoCleanerDirectByteBuf ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf</span></span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">UnpooledUnsafeNoCleanerDirectByteBuf</span> </span>{</span><br><span class="line"></span><br><span class="line">    InstrumentedUnpooledUnsafeNoCleanerDirectByteBuf(</span><br><span class="line">            UnpooledByteBufAllocator alloc, <span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity) {</span><br><span class="line">        <span class="keyword">super</span>(alloc, initialCapacity, maxCapacity);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ByteBuffer <span class="title">allocateDirect</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>{</span><br><span class="line">        ByteBuffer buffer = <span class="keyword">super</span>.allocateDirect(initialCapacity);</span><br><span class="line">        <span class="comment">// Metric ++</span></span><br><span class="line">        ((UnpooledByteBufAllocator) alloc()).incrementDirect(buffer.capacity());</span><br><span class="line">        <span class="keyword">return</span> buffer;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">ByteBuffer <span class="title">reallocateDirect</span><span class="params">(ByteBuffer oldBuffer, <span class="keyword">int</span> initialCapacity)</span> </span>{</span><br><span class="line">        <span class="keyword">int</span> capacity = oldBuffer.capacity();</span><br><span class="line">        ByteBuffer buffer = <span class="keyword">super</span>.reallocateDirect(oldBuffer, initialCapacity);</span><br><span class="line">        <span class="comment">// Metric ++</span></span><br><span class="line">        ((UnpooledByteBufAllocator) alloc()).incrementDirect(buffer.capacity() - capacity);</span><br><span class="line">        <span class="keyword">return</span> buffer;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">freeDirect</span><span class="params">(ByteBuffer buffer)</span> </span>{</span><br><span class="line">        <span class="keyword">int</span> capacity = buffer.capacity();</span><br><span class="line">        <span class="keyword">super</span>.freeDirect(buffer);</span><br><span class="line">        <span class="comment">// Metric --</span></span><br><span class="line">        ((UnpooledByteBufAllocator) alloc()).decrementDirect(capacity);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨åŸå…ˆçš„åŸºç¡€ä¸Šï¼Œè°ƒç”¨ Metric ç›¸åº”çš„å¢å‡æ“ä½œæ–¹æ³•ï¼Œå¾—ä»¥è®°å½• Heap å ç”¨å†…å­˜çš„å¤§å°ã€‚</li>
</ul>
<h3 id="5-5-1-UnpooledUnsafeNoCleanerDirectByteBuf"><a href="#5-5-1-UnpooledUnsafeNoCleanerDirectByteBuf" class="headerlink" title="5.5.1 UnpooledUnsafeNoCleanerDirectByteBuf"></a>5.5.1 UnpooledUnsafeNoCleanerDirectByteBuf</h3><p><code>io.netty.buffer.UnpooledUnsafeNoCleanerDirectByteBuf</code> ï¼Œç»§æ‰¿ UnpooledUnsafeDirectByteBuf ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnpooledUnsafeNoCleanerDirectByteBuf</span> <span class="keyword">extends</span> <span class="title">UnpooledUnsafeDirectByteBuf</span> </span>{</span><br><span class="line"></span><br><span class="line">    UnpooledUnsafeNoCleanerDirectByteBuf(ByteBufAllocator alloc, <span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity) {</span><br><span class="line">        <span class="keyword">super</span>(alloc, initialCapacity, maxCapacity);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> ByteBuffer <span class="title">allocateDirect</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>{</span><br><span class="line">        <span class="comment">// åå°„ï¼Œç›´æ¥åˆ›å»º ByteBuffer å¯¹è±¡ã€‚å¹¶ä¸”è¯¥å¯¹è±¡ä¸å¸¦ Cleaner å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> PlatformDependent.allocateDirectNoCleaner(initialCapacity);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function">ByteBuffer <span class="title">reallocateDirect</span><span class="params">(ByteBuffer oldBuffer, <span class="keyword">int</span> initialCapacity)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> PlatformDependent.reallocateDirectNoCleaner(oldBuffer, initialCapacity);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">freeDirect</span><span class="params">(ByteBuffer buffer)</span> </span>{</span><br><span class="line">        <span class="comment">// ç›´æ¥é‡Šæ”¾ ByteBuffer å¯¹è±¡</span></span><br><span class="line">        PlatformDependent.freeDirectNoCleaner(buffer);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ByteBuf <span class="title">capacity</span><span class="params">(<span class="keyword">int</span> newCapacity)</span> </span>{</span><br><span class="line">        checkNewCapacity(newCapacity);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> oldCapacity = capacity();</span><br><span class="line">        <span class="keyword">if</span> (newCapacity == oldCapacity) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é‡æ–°åˆ†é… ByteBuf å¯¹è±¡</span></span><br><span class="line">        ByteBuffer newBuffer = reallocateDirect(buffer, newCapacity);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (newCapacity &lt; oldCapacity) {</span><br><span class="line">            <span class="keyword">if</span> (readerIndex() &lt; newCapacity) {</span><br><span class="line">                <span class="comment">// é‡ç½® writerIndex ä¸º newCapacity ï¼Œé¿å…è¶Šç•Œ</span></span><br><span class="line">                <span class="keyword">if</span> (writerIndex() &gt; newCapacity) {</span><br><span class="line">                    writerIndex(newCapacity);</span><br><span class="line">                }</span><br><span class="line">            } <span class="keyword">else</span> {</span><br><span class="line">                <span class="comment">// é‡ç½® writerIndex å’Œ readerIndex ä¸º newCapacity ï¼Œé¿å…è¶Šç•Œ</span></span><br><span class="line">                setIndex(newCapacity, newCapacity);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½® ByteBuf å¯¹è±¡</span></span><br><span class="line">        setByteBuffer(newBuffer, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>FROM <a href="https://www.jianshu.com/p/b833254908f7" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNettyæºç åˆ†æï¼ˆä¸€ï¼‰ ByteBufã€‹</a></p>
<p>å’Œ UnpooledUnsafeDirectByteBuf æœ€å¤§åŒºåˆ«åœ¨äº UnpooledUnsafeNoCleanerDirectByteBuf åœ¨ allocateçš„æ—¶å€™é€šè¿‡åå°„æ„é€ å‡½æ•°çš„æ–¹å¼åˆ›å»ºDirectByteBufferï¼Œè¿™æ ·åœ¨DirectByteBufferä¸­æ²¡æœ‰å¯¹åº”çš„Cleanerå‡½æ•°(é€šè¿‡ByteBuffer.allocateDirectçš„æ–¹å¼ä¼šè‡ªåŠ¨ç”ŸæˆCleanerå‡½æ•°ï¼ŒCleanerç”¨äºå†…å­˜å›æ”¶ï¼Œå…·ä½“å¯ä»¥çœ‹æºç )ï¼Œå†…å­˜å›æ”¶æ—¶ï¼ŒUnpooledUnsafeDirectByteBufé€šè¿‡è°ƒç”¨DirectByteBufferä¸­çš„Cleanerå‡½æ•°å›æ”¶ï¼Œè€ŒUnpooledUnsafeNoCleanerDirectByteBufç›´æ¥ä½¿ç”¨UNSAFE.freeMemory(address)é‡Šæ”¾å†…å­˜åœ°å€ã€‚</p>
</blockquote>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ğŸ˜ˆ å°æ°´æ–‡ä¸€ç¯‡ã€‚é“ºå«é“ºå«ï¼Œä½ æ‡‚çš„ã€‚</p>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/ByteBuf-2-2-ByteBufAllocator-unpooled/" data-id="ck4pl3fp500e3fgcf5q3frs4k" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>