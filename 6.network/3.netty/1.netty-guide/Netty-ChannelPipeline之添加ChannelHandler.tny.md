<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” ChannelPipelineï¼ˆäºŒï¼‰ä¹‹æ·»åŠ  ChannelHandler
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡æˆ‘ä»¬æ¥åˆ†äº«ï¼Œ<strong>æ·»åŠ </strong> ChannelHandler åˆ° pipeline ä¸­çš„ä»£ç å…·ä½“å®ç°ã€‚</p>
<p>åœ¨ <a href="http://svip.iocoder.cn/Netty/ChannelPipeline-1-init">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” ChannelPipelineï¼ˆä¸€ï¼‰ä¹‹åˆå§‹åŒ–ã€‹</a> ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° ChannelPipeline å®šä¹‰äº†ä¸€å¤§å †<strong>æ·»åŠ </strong> ChannelHandler çš„æ¥å£æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function">ChannelPipeline <span class="title">addFirst</span><span class="params">(String name, ChannelHandler handler)</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">addFirst</span><span class="params">(EventExecutorGroup group, String name, ChannelHandler handler)</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">addLast</span><span class="params">(String name, ChannelHandler handler)</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">addLast</span><span class="params">(EventExecutorGroup group, String name, ChannelHandler handler)</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">addBefore</span><span class="params">(String baseName, String name, ChannelHandler handler)</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">addBefore</span><span class="params">(EventExecutorGroup group, String baseName, String name, ChannelHandler handler)</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">addAfter</span><span class="params">(String baseName, String name, ChannelHandler handler)</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">addAfter</span><span class="params">(EventExecutorGroup group, String baseName, String name, ChannelHandler handler)</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">addFirst</span><span class="params">(ChannelHandler... handlers)</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">addFirst</span><span class="params">(EventExecutorGroup group, ChannelHandler... handlers)</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">addLast</span><span class="params">(ChannelHandler... handlers)</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">addLast</span><span class="params">(EventExecutorGroup group, ChannelHandler... handlers)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è€ƒè™‘åˆ°å®é™…å½“ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>#addLast(ChannelHandler... handlers)</code> æ–¹æ³•è¾ƒå¤šï¼Œæ‰€ä»¥æœ¬æ–‡åªåˆ†äº«è¿™ä¸ªæ–¹æ³•çš„å…·ä½“å®ç°ã€‚</li>
</ul>
<h1 id="2-addLast"><a href="#2-addLast" class="headerlink" title="2. addLast"></a>2. addLast</h1><p><code>#addLast(ChannelHandler... handlers)</code> æ–¹æ³•ï¼Œæ·»åŠ ä»»æ„æ•°é‡çš„ ChannelHandler å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">addLast</span><span class="params">(ChannelHandler... handlers)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> addLast(<span class="keyword">null</span>, handlers);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">addLast</span><span class="params">(EventExecutorGroup executor, ChannelHandler... handlers)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (handlers == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"handlers"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (ChannelHandler h: handlers) {</span><br><span class="line">        <span class="keyword">if</span> (h == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        addLast(executor, <span class="keyword">null</span>, h); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#addLast(EventExecutorGroup group, String name, ChannelHandler handler)</code> æ–¹æ³•ï¼Œæ·»åŠ ä¸€ä¸ª ChannelHandler å¯¹è±¡åˆ° pipeline ä¸­ã€‚</li>
</ul>
<p><code>#addLast(EventExecutorGroup group, String name, ChannelHandler handler)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"Duplicates"</span>)</span><br><span class="line"> <span class="number">3</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">addLast</span><span class="params">(EventExecutorGroup group, String name, ChannelHandler handler)</span> </span>{</span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">final</span> AbstractChannelHandlerContext newCtx;</span><br><span class="line"> <span class="number">5</span>:     <span class="keyword">synchronized</span> (<span class="keyword">this</span>) { <span class="comment">// åŒæ­¥ï¼Œä¸ºäº†é˜²æ­¢å¤šçº¿ç¨‹å¹¶å‘æ“ä½œ pipeline åº•å±‚çš„åŒå‘é“¾è¡¨</span></span><br><span class="line"> <span class="number">6</span>:         <span class="comment">// æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤ handler</span></span><br><span class="line"> <span class="number">7</span>:         checkMultiplicity(handler);</span><br><span class="line"> <span class="number">8</span>: </span><br><span class="line"> <span class="number">9</span>:         <span class="comment">// åˆ›å»ºèŠ‚ç‚¹å</span></span><br><span class="line"><span class="number">10</span>:         <span class="comment">// åˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line"><span class="number">11</span>:         newCtx = newContext(group, filterName(name, handler), handler);</span><br><span class="line"><span class="number">12</span>: </span><br><span class="line"><span class="number">13</span>:         <span class="comment">// æ·»åŠ èŠ‚ç‚¹</span></span><br><span class="line"><span class="number">14</span>:         addLast0(newCtx);</span><br><span class="line"><span class="number">15</span>: </span><br><span class="line"><span class="number">16</span>:         <span class="comment">// &lt;1&gt; pipeline æš‚æœªæ³¨å†Œï¼Œæ·»åŠ å›è°ƒã€‚å†æ³¨å†Œå®Œæˆåï¼Œæ‰§è¡Œå›è°ƒã€‚è¯¦ç»†è§£æï¼Œè§ {@link #invokeHandlerAddedIfNeeded} æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="number">17</span>:         <span class="comment">// If the registered is false it means that the channel was not registered on an eventloop yet.</span></span><br><span class="line"><span class="number">18</span>:         <span class="comment">// In this case we add the context to the pipeline and add a task that will call</span></span><br><span class="line"><span class="number">19</span>:         <span class="comment">// ChannelHandler.handlerAdded(...) once the channel is registered.</span></span><br><span class="line"><span class="number">20</span>:         <span class="keyword">if</span> (!registered) {</span><br><span class="line"><span class="number">21</span>:             <span class="comment">// è®¾ç½® AbstractChannelHandlerContext å‡†å¤‡æ·»åŠ ä¸­</span></span><br><span class="line"><span class="number">22</span>:             newCtx.setAddPending();</span><br><span class="line"><span class="number">23</span>:             <span class="comment">// æ·»åŠ  PendingHandlerCallback å›è°ƒ</span></span><br><span class="line"><span class="number">24</span>:             callHandlerCallbackLater(newCtx, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">25</span>:             <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line"><span class="number">26</span>:         }</span><br><span class="line"><span class="number">27</span>: </span><br><span class="line"><span class="number">28</span>:         <span class="comment">// &lt;2&gt; ä¸åœ¨ EventLoop çš„çº¿ç¨‹ä¸­ï¼Œæäº¤ EventLoop ä¸­ï¼Œæ‰§è¡Œå›è°ƒç”¨æˆ·æ–¹æ³•</span></span><br><span class="line"><span class="number">29</span>:         EventExecutor executor = newCtx.executor();</span><br><span class="line"><span class="number">30</span>:         <span class="keyword">if</span> (!executor.inEventLoop()) {</span><br><span class="line"><span class="number">31</span>:             <span class="comment">// è®¾ç½® AbstractChannelHandlerContext å‡†å¤‡æ·»åŠ ä¸­</span></span><br><span class="line"><span class="number">32</span>:             newCtx.setAddPending();</span><br><span class="line"><span class="number">33</span>:             <span class="comment">// æäº¤ EventLoop ä¸­ï¼Œæ‰§è¡Œå›è°ƒ ChannelHandler added äº‹ä»¶</span></span><br><span class="line"><span class="number">34</span>:             executor.execute(<span class="keyword">new</span> Runnable() {</span><br><span class="line"><span class="number">35</span>:                 <span class="meta">@Override</span></span><br><span class="line"><span class="number">36</span>:                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="number">37</span>:                     callHandlerAdded0(newCtx);</span><br><span class="line"><span class="number">38</span>:                 }</span><br><span class="line"><span class="number">39</span>:             });</span><br><span class="line"><span class="number">40</span>:             <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line"><span class="number">41</span>:         }</span><br><span class="line"><span class="number">42</span>:     }</span><br><span class="line"><span class="number">43</span>: </span><br><span class="line"><span class="number">44</span>:     <span class="comment">// &lt;3&gt; å›è°ƒ ChannelHandler added äº‹ä»¶</span></span><br><span class="line"><span class="number">45</span>:     callHandlerAdded0(newCtx);</span><br><span class="line"><span class="number">46</span>:     <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line"><span class="number">47</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 5 è¡Œï¼š<code>synchronized</code> åŒæ­¥ï¼Œä¸ºäº†é˜²æ­¢å¤šçº¿ç¨‹å¹¶å‘æ“ä½œ pipeline åº•å±‚çš„åŒå‘é“¾è¡¨ã€‚</li>
<li>ç¬¬ 7 è¡Œï¼šè°ƒç”¨ <code>#checkMultiplicity(ChannelHandler)</code> æ–¹æ³•ï¼Œæ ¡éªŒæ˜¯å¦é‡å¤çš„ ChannelHandler ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ3. checkMultiplicityã€</a> ã€‚</li>
<li>ç¬¬ 11 è¡Œï¼šè°ƒç”¨ <code>#filterName(String name, ChannelHandler handler)</code> æ–¹æ³•ï¼Œè·å¾— ChannelHandler çš„åå­—ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ4. filterNameã€</a> ã€‚</li>
<li>ç¬¬ 11 è¡Œï¼šè°ƒç”¨ <code>#newContext(EventExecutorGroup group, String name, ChannelHandler handler)</code> æ–¹æ³•ï¼Œåˆ›å»º <strong>DefaultChannelHandlerContext</strong> èŠ‚ç‚¹ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5. newContextã€</a> ã€‚</li>
<li>ç¬¬ 14 è¡Œï¼š<code>#addLast0(AbstractChannelHandlerContext newCtx)</code> æ–¹æ³•ï¼Œæ·»åŠ åˆ°æœ€åä¸€ä¸ªèŠ‚ç‚¹ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ6. addLast0ã€</a> ã€‚</li>
<li>========== åç»­åˆ†æˆ 3 ç§æƒ…å†µ ==========</li>
<li><code>&lt;1&gt;</code></li>
<li>ç¬¬ 20 è¡Œï¼šChannel å¹¶æœªæ³¨å†Œã€‚è¿™ç§æƒ…å†µï¼Œå‘ç”Ÿäº ServerBootstrap å¯åŠ¨çš„è¿‡ç¨‹ä¸­ã€‚åœ¨ <code>ServerBootstrap#init(Channel channel)</code> æ–¹æ³•ä¸­ï¼Œä¼šæ·»åŠ  ChannelInitializer å¯¹è±¡åˆ° pipeline ä¸­ï¼Œæ°å¥½æ­¤æ—¶ Channel å¹¶æœªæ³¨å†Œã€‚</li>
<li>ç¬¬ 22 è¡Œï¼šè°ƒç”¨ <code>AbstractChannelHandlerContext#setAddPending()</code> æ–¹æ³•ï¼Œè®¾ç½® AbstractChannelHandlerContext <strong>å‡†å¤‡æ·»åŠ ä¸­</strong>ã€‚</li>
<li>ç¬¬ 24 è¡Œï¼šè°ƒç”¨ <code>#callHandlerCallbackLater(AbstractChannelHandlerContext, added)</code> æ–¹æ³•ï¼Œæ·»åŠ  PendingHandlerAddedTask å›è°ƒã€‚åœ¨ Channel æ³¨å†Œå®Œæˆåï¼Œæ‰§è¡Œè¯¥å›è°ƒã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8. PendingHandlerCallbackã€</a> ã€‚</li>
<li><code>&lt;2&gt;</code></li>
<li>ç¬¬ 30 è¡Œï¼šä¸åœ¨ EventLoop çš„çº¿ç¨‹ä¸­ã€‚</li>
<li>ç¬¬ 32 è¡Œï¼šè°ƒç”¨ <code>AbstractChannelHandlerContext#setAddPending()</code> æ–¹æ³•ï¼Œè®¾ç½® AbstractChannelHandlerContext <strong>å‡†å¤‡æ·»åŠ ä¸­</strong>ã€‚</li>
<li>ç¬¬ 34 è‡³ 39 è¡Œï¼šæäº¤ EventLoop ä¸­ï¼Œè°ƒç”¨ <code>#callHandlerAdded0(AbstractChannelHandlerContext)</code> æ–¹æ³•ï¼Œæ‰§è¡Œå›è°ƒ ChannelHandler æ·»åŠ å®Œæˆ( added )äº‹ä»¶ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ7. callHandlerAdded0ã€</a> ã€‚</li>
<li><code>&lt;3&gt;</code> </li>
<li>è¿™ç§æƒ…å†µï¼Œæ˜¯ <code>&lt;2&gt;</code> åœ¨ EventLoop çš„çº¿ç¨‹ä¸­çš„ç‰ˆæœ¬ã€‚ä¹Ÿå› ä¸ºæ­¤ï¼Œå·²ç»ç¡®è®¤åœ¨ EventLoop çš„çº¿ç¨‹ä¸­ï¼Œæ‰€ä»¥ä¸éœ€è¦åœ¨ <code>synchronized</code> ä¸­ã€‚</li>
<li>ç¬¬ 45 è¡Œï¼šå’Œã€ç¬¬ 37 è¡Œã€‘çš„ä»£ç ä¸€æ ·ï¼Œè°ƒç”¨ <code>#callHandlerAdded0(AbstractChannelHandlerContext)</code> æ–¹æ³•ï¼Œæ‰§è¡Œå›è°ƒ ChannelHandler æ·»åŠ å®Œæˆ( added )äº‹ä»¶ã€‚</li>
</ul>
<h1 id="3-checkMultiplicity"><a href="#3-checkMultiplicity" class="headerlink" title="3. checkMultiplicity"></a>3. checkMultiplicity</h1><p><code>#checkMultiplicity(ChannelHandler handler)</code> æ–¹æ³•ï¼Œæ ¡éªŒæ˜¯å¦é‡å¤çš„ ChannelHandler ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkMultiplicity</span><span class="params">(ChannelHandler handler)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (handler <span class="keyword">instanceof</span> ChannelHandlerAdapter) {</span><br><span class="line">        ChannelHandlerAdapter h = (ChannelHandlerAdapter) handler;</span><br><span class="line">        <span class="comment">// è‹¥å·²ç»æ·»åŠ ï¼Œå¹¶ä¸”æœªä½¿ç”¨ @Sharable æ³¨è§£ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (!h.isSharable() &amp;&amp; h.added) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ChannelPipelineException(</span><br><span class="line">                    h.getClass().getName() +</span><br><span class="line">                    <span class="string">" is not a @Sharable handler, so can't be added or removed multiple times."</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// æ ‡è®°å·²ç»æ·»åŠ </span></span><br><span class="line">        h.added = <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨ pipeline ä¸­ï¼Œä¸€ä¸ªåˆ›å»ºçš„ ChannelHandler å¯¹è±¡ï¼Œå¦‚æœä¸ä½¿ç”¨ Netty <code>@Sharable</code> æ³¨è§£ï¼Œåˆ™åªèƒ½æ·»åŠ åˆ°ä¸€ä¸ª Channel çš„ pipeline ä¸­ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦é‡ç”¨ä¸€ä¸ª ChannelHandler å¯¹è±¡( ä¾‹å¦‚åœ¨ Spring ç¯å¢ƒä¸­ )ï¼Œåˆ™å¿…é¡»ç»™è¿™ä¸ª ChannelHandler æ·»åŠ  <code>@Sharable</code> æ³¨è§£ã€‚</li>
</ul>
<p>ä¾‹å¦‚ï¼Œåœ¨ Dubbo çš„ <code>com.alibaba.dubbo.remoting.transport.netty.NettyHandler</code> å¤„ç†å™¨ï¼Œå®ƒå°±ä½¿ç”¨äº† <code>@Sharable</code> æ³¨è§£ã€‚</p>
<h1 id="4-filterName"><a href="#4-filterName" class="headerlink" title="4. filterName"></a>4. filterName</h1><p><code>#filterName(String name, ChannelHandler handler)</code> æ–¹æ³•ï¼Œè·å¾— ChannelHandler çš„åå­—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">filterName</span><span class="params">(String name, ChannelHandler handler)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="keyword">null</span>) { <span class="comment">// &lt;1&gt;</span></span><br><span class="line">        <span class="keyword">return</span> generateName(handler);</span><br><span class="line">    }</span><br><span class="line">    checkDuplicateName(name); <span class="comment">// &lt;2&gt;</span></span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè‹¥<strong>æœª</strong>ä¼ å…¥é»˜è®¤çš„åå­— <code>name</code> ï¼Œåˆ™è°ƒç”¨ <code>#generateName(ChannelHandler)</code> æ–¹æ³•ï¼Œæ ¹æ® ChannelHandler ç”Ÿæˆä¸€ä¸ª<strong>å”¯ä¸€</strong>çš„åå­—ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ4.1 generateNameã€</a> ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œè‹¥<strong>å·²</strong>ä¼ å…¥é»˜è®¤çš„åå­— <code>name</code> ï¼Œåˆ™è°ƒç”¨ <code>#checkDuplicateName(String name)</code> æ–¹æ³•ï¼Œæ ¡éªŒåå­—å”¯ä¸€ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ4.2 checkDuplicateNameã€</a> ã€‚</li>
</ul>
<h2 id="4-1-generateName"><a href="#4-1-generateName" class="headerlink" title="4.1 generateName"></a>4.1 generateName</h2><p><code>#generateName(ChannelHandler)</code> æ–¹æ³•ï¼Œæ ¹æ® ChannelHandler ç”Ÿæˆä¸€ä¸ª<strong>å”¯ä¸€</strong>åå­—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> String <span class="title">generateName</span><span class="params">(ChannelHandler handler)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// ä»ç¼“å­˜ä¸­æŸ¥è¯¢ï¼Œæ˜¯å¦å·²ç»ç”Ÿæˆé»˜è®¤åå­—</span></span><br><span class="line"> <span class="number">3</span>:     Map&lt;Class&lt;?&gt;, String&gt; cache = nameCaches.get();</span><br><span class="line"> <span class="number">4</span>:     Class&lt;?&gt; handlerType = handler.getClass();</span><br><span class="line"> <span class="number">5</span>:     String name = cache.get(handlerType);</span><br><span class="line"> <span class="number">6</span>:     <span class="comment">// è‹¥æœªç”Ÿæˆè¿‡ï¼Œè¿›è¡Œç”Ÿæˆ</span></span><br><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (name == <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">8</span>:         name = generateName0(handlerType);</span><br><span class="line"> <span class="number">9</span>:         cache.put(handlerType, name);</span><br><span class="line"><span class="number">10</span>:     }</span><br><span class="line"><span class="number">11</span>: </span><br><span class="line"><span class="number">12</span>:     <span class="comment">// åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç›¸åŒåå­—çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="number">13</span>:     <span class="comment">// It's not very likely for a user to put more than one handler of the same type, but make sure to avoid</span></span><br><span class="line"><span class="number">14</span>:     <span class="comment">// any name conflicts.  Note that we don't cache the names generated here.</span></span><br><span class="line"><span class="number">15</span>:     <span class="keyword">if</span> (context0(name) != <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">16</span>:         <span class="comment">// è‹¥å­˜åœ¨ï¼Œåˆ™ä½¿ç”¨åŸºç¡€åå­— + ç¼–å·ï¼Œå¾ªç¯ç”Ÿæˆï¼Œç›´åˆ°ä¸€ä¸ªæ˜¯å”¯ä¸€çš„</span></span><br><span class="line"><span class="number">17</span>:         String baseName = name.substring(<span class="number">0</span>, name.length() - <span class="number">1</span>); <span class="comment">// Strip the trailing '0'.</span></span><br><span class="line"><span class="number">18</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>;; i ++) {</span><br><span class="line"><span class="number">19</span>:             String newName = baseName + i;</span><br><span class="line"><span class="number">20</span>:             <span class="keyword">if</span> (context0(newName) == <span class="keyword">null</span>) { <span class="comment">// // åˆ¤æ–­æ˜¯å¦å­˜åœ¨ç›¸åŒåå­—çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="number">21</span>:                 name = newName;</span><br><span class="line"><span class="number">22</span>:                 <span class="keyword">break</span>;</span><br><span class="line"><span class="number">23</span>:             }</span><br><span class="line"><span class="number">24</span>:         }</span><br><span class="line"><span class="number">25</span>:     }</span><br><span class="line"><span class="number">26</span>:     <span class="keyword">return</span> name;</span><br><span class="line"><span class="number">27</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 2 è‡³ 5 è¡Œï¼šä»ç¼“å­˜ <code>nameCaches</code> ä¸­ï¼ŒæŸ¥è¯¢æ˜¯å¦å·²ç»ç”Ÿæˆ<strong>é»˜è®¤</strong>åå­—ã€‚<ul>
<li>è‹¥æœªç”Ÿæˆè¿‡ï¼Œè°ƒç”¨ <code>#generateName0(ChannelHandler)</code> æ–¹æ³•ï¼Œè¿›è¡Œç”Ÿæˆã€‚è€Œåï¼Œæ·»åŠ åˆ°ç¼“å­˜ <code>nameCaches</code> ä¸­ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 15 è¡Œï¼šè°ƒç”¨ <code>#context0(String name)</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å­˜åœ¨ç›¸åŒåå­—çš„èŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> AbstractChannelHandlerContext <span class="title">context0</span><span class="params">(String name)</span> </span>{</span><br><span class="line">    AbstractChannelHandlerContext context = head.next;</span><br><span class="line">    <span class="comment">// é¡ºåºå‘ä¸‹éå†èŠ‚ç‚¹ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æŒ‡å®šåå­—çš„èŠ‚ç‚¹ã€‚å¦‚æœæœ‰ï¼Œåˆ™è¿”å›è¯¥èŠ‚ç‚¹ã€‚</span></span><br><span class="line">    <span class="keyword">while</span> (context != tail) {</span><br><span class="line">        <span class="keyword">if</span> (context.name().equals(name)) {</span><br><span class="line">            <span class="keyword">return</span> context;</span><br><span class="line">        }</span><br><span class="line">        context = context.next;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é¡ºåºå‘ä¸‹éå†èŠ‚ç‚¹ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æŒ‡å®šåå­—çš„èŠ‚ç‚¹ã€‚å¦‚æœæœ‰ï¼Œåˆ™è¿”å›è¯¥èŠ‚ç‚¹ã€‚</li>
</ul>
</li>
<li>ç¬¬ 15 è‡³ 25 è¡Œï¼šè‹¥å­˜åœ¨ç›¸åŒåå­—çš„èŠ‚ç‚¹ï¼Œåˆ™ä½¿ç”¨<strong>åŸºç¡€</strong>åå­— + ç¼–å·ï¼Œå¾ªç¯ç”Ÿæˆï¼Œç›´åˆ°ä¸€ä¸ªåå­—æ˜¯<strong>å”¯ä¸€</strong>çš„ï¼Œç„¶åç»“æŸå¾ªç¯ã€‚</li>
</ul>
<h2 id="4-2-checkDuplicateName"><a href="#4-2-checkDuplicateName" class="headerlink" title="4.2 checkDuplicateName"></a>4.2 checkDuplicateName</h2><p><code>#checkDuplicateName(String name)</code> æ–¹æ³•ï¼Œæ ¡éªŒåå­—å”¯ä¸€ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkDuplicateName</span><span class="params">(String name)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (context0(name) != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Duplicate handler name: "</span> + name);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é€šè¿‡è°ƒç”¨ <code>#context0(String name)</code> æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šåå­—çš„èŠ‚ç‚¹ã€‚è‹¥å­˜åœ¨èŠ‚ç‚¹ï¼Œæ„å‘³ç€<strong>ä¸å”¯ä¸€</strong>ï¼ŒæŠ›å‡º IllegalArgumentException å¼‚å¸¸ã€‚</li>
</ul>
<h1 id="5-newContext"><a href="#5-newContext" class="headerlink" title="5. newContext"></a>5. newContext</h1><p><code>#newContext(EventExecutorGroup group, String name, ChannelHandler handler)</code> æ–¹æ³•ï¼Œåˆ›å»º <strong>DefaultChannelHandlerContext</strong> èŠ‚ç‚¹ã€‚è€Œè¿™ä¸ªèŠ‚ç‚¹ï¼Œ<strong>å†…åµŒ</strong>ä¼ å…¥çš„ ChannelHandler å‚æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> AbstractChannelHandlerContext <span class="title">newContext</span><span class="params">(EventExecutorGroup group, String name, ChannelHandler handler)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DefaultChannelHandlerContext(<span class="keyword">this</span>, childExecutor(group) <span class="comment">/** &lt;1&gt; **/</span>, name, handler);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#childExecutor(EventExecutorGroup group)</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>å­</strong>æ‰§è¡Œå™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> EventExecutor <span class="title">childExecutor</span><span class="params">(EventExecutorGroup group)</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;1&gt; ä¸åˆ›å»ºå­æ‰§è¡Œå™¨</span></span><br><span class="line">    <span class="keyword">if</span> (group == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &lt;2&gt; æ ¹æ®é…ç½®é¡¹ SINGLE_EVENTEXECUTOR_PER_GROUP ï¼Œæ¯ä¸ª Channel ä» EventExecutorGroup è·å¾—ä¸åŒ EventExecutor æ‰§è¡Œå™¨</span></span><br><span class="line">    Boolean pinEventExecutor = channel.config().getOption(ChannelOption.SINGLE_EVENTEXECUTOR_PER_GROUP);</span><br><span class="line">    <span class="keyword">if</span> (pinEventExecutor != <span class="keyword">null</span> &amp;&amp; !pinEventExecutor) {</span><br><span class="line">        <span class="keyword">return</span> group.next();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &lt;3&gt; é€šè¿‡ childExecutors ç¼“å­˜å®ç°ï¼Œä¸€ä¸ª Channel ä» EventExecutorGroup è·å¾—ç›¸åŒ EventExecutor æ‰§è¡Œå™¨</span></span><br><span class="line">    Map&lt;EventExecutorGroup, EventExecutor&gt; childExecutors = <span class="keyword">this</span>.childExecutors;</span><br><span class="line">    <span class="keyword">if</span> (childExecutors == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// Use size of 4 as most people only use one extra EventExecutor.</span></span><br><span class="line">        childExecutors = <span class="keyword">this</span>.childExecutors = <span class="keyword">new</span> IdentityHashMap&lt;EventExecutorGroup, EventExecutor&gt;(<span class="number">4</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Pin one of the child executors once and remember it so that the same child executor</span></span><br><span class="line">    <span class="comment">// is used to fire events for the same channel.</span></span><br><span class="line">    EventExecutor childExecutor = childExecutors.get(group);</span><br><span class="line">    <span class="comment">// ç¼“å­˜ä¸å­˜åœ¨ï¼Œè¿›è¡Œ ä» EventExecutorGroup è·å¾— EventExecutor æ‰§è¡Œå™¨</span></span><br><span class="line">    <span class="keyword">if</span> (childExecutor == <span class="keyword">null</span>) {</span><br><span class="line">        childExecutor = group.next();</span><br><span class="line">        childExecutors.put(group, childExecutor); <span class="comment">// è¿›è¡Œç¼“å­˜</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> childExecutor;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¸€å…±æœ‰ä¸‰ç§æƒ…å†µï¼š<ul>
<li><code>&lt;1&gt;</code> ï¼Œå½“<strong>ä¸ä¼ å…¥</strong> EventExecutorGroup æ—¶ï¼Œä¸åˆ›å»º<strong>å­</strong>æ‰§è¡Œå™¨ã€‚å³ï¼Œä½¿ç”¨ Channel æ‰€æ³¨å†Œçš„ EventLoop ä½œä¸ºæ‰§è¡Œå™¨ã€‚<strong>å¯¹äºæˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨ï¼ŒåŸºæœ¬å®Œå…¨éƒ½æ˜¯è¿™ç§æƒ…å†µ</strong>ã€‚æ‰€ä»¥ï¼Œä¸‹é¢ä¸¤ç§æƒ…å†µï¼Œèƒ–å‹ä¸ç†è§£ä¹Ÿæ˜¯æ²¡å…³ç³»çš„ã€‚</li>
<li><code>&lt;2&gt;</code> ï¼Œæ ¹æ®é…ç½®é¡¹ <code>ChannelOption.SINGLE_EVENTEXECUTOR_PER_GROUP</code> ï¼Œæ¯ä¸ª Channel ä» EventExecutorGroup è·å¾—<strong>ä¸åŒ</strong> EventExecutor æ‰§è¡Œå™¨ã€‚</li>
<li><code>&lt;3&gt;</code> ï¼Œé€šè¿‡ <code>childExecutors</code> ç¼“å­˜å®ç°ï¼Œæ¯ä¸ª Channel ä» EventExecutorGroup è·å¾—<strong>ç›¸åŒ</strong> EventExecutor æ‰§è¡Œå™¨ã€‚æ˜¯å¦è·å¾—ç›¸åŒçš„ EventExecutor æ‰§è¡Œå™¨ï¼Œè¿™å°±æ˜¯ <code>&lt;2&gt;</code>ã€<code>&lt;3&gt;</code> çš„ä¸åŒã€‚</li>
</ul>
</li>
</ul>
</li>
<li><strong>æ³¨æ„</strong>ï¼Œåˆ›å»ºçš„æ˜¯ DefaultChannelHandlerContext å¯¹è±¡ã€‚</li>
</ul>
<h1 id="6-addLast0"><a href="#6-addLast0" class="headerlink" title="6. addLast0"></a>6. addLast0</h1><p><code>#addLast0(AbstractChannelHandlerContext newCtx)</code> æ–¹æ³•ï¼Œæ·»åŠ åˆ°æœ€åä¸€ä¸ªèŠ‚ç‚¹ã€‚<strong>æ³¨æ„</strong>ï¼Œå®é™…ä¸Šï¼Œæ˜¯æ·»åŠ åˆ° <code>tail</code> èŠ‚ç‚¹<strong>ä¹‹å‰</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addLast0</span><span class="params">(AbstractChannelHandlerContext newCtx)</span> </span>{</span><br><span class="line">    <span class="comment">// è·å¾— tail èŠ‚ç‚¹çš„å‰ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    AbstractChannelHandlerContext prev = tail.prev;</span><br><span class="line">    <span class="comment">// æ–°èŠ‚ç‚¹ï¼ŒæŒ‡å‘ prev å’Œ tail èŠ‚ç‚¹</span></span><br><span class="line">    newCtx.prev = prev; <span class="comment">// &lt;1&gt;</span></span><br><span class="line">    newCtx.next = tail; <span class="comment">// &lt;2&gt;</span></span><br><span class="line">    <span class="comment">// åœ¨ prev å’Œ tail ï¼ŒæŒ‡å‘æ–°èŠ‚ç‚¹</span></span><br><span class="line">    prev.next = newCtx; <span class="comment">// &lt;3&gt;</span></span><br><span class="line">    tail.prev = newCtx; <span class="comment">// &lt;4&gt;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>FROM é—ªç”µä¾  <a href="https://www.jianshu.com/p/6efa9c5fa702" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty æºç åˆ†æä¹‹pipeline(ä¸€)ã€‹</a></p>
<ul>
<li><p>ç”¨ä¸‹é¢è¿™å¹…å›¾å¯è§ç®€å•çš„è¡¨ç¤ºè¿™æ®µè¿‡ç¨‹ï¼Œè¯´ç™½äº†ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨çš„æ’å…¥æ“ä½œï¼š</p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_06_04/01.png" title="æ·»åŠ èŠ‚ç‚¹è¿‡ç¨‹" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_06_04/01.png" alt="æ·»åŠ èŠ‚ç‚¹è¿‡ç¨‹"></a><span class="caption">æ·»åŠ èŠ‚ç‚¹è¿‡ç¨‹</span></p>
</li>
<li><p>æ“ä½œå®Œæ¯•ï¼Œè¯¥èŠ‚ç‚¹å°±åŠ å…¥åˆ° pipeline ä¸­ï¼š</p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_06_04/02.png" title="æ·»åŠ èŠ‚ç‚¹ä¹‹å" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_06_04/02.png" alt="æ·»åŠ èŠ‚ç‚¹ä¹‹å"></a><span class="caption">æ·»åŠ èŠ‚ç‚¹ä¹‹å</span></p>
</li>
</ul>
</blockquote>
<h1 id="7-callHandlerAdded0"><a href="#7-callHandlerAdded0" class="headerlink" title="7. callHandlerAdded0"></a>7. callHandlerAdded0</h1><p><code>#callHandlerAdded0(AbstractChannelHandlerContext)</code> æ–¹æ³•ï¼Œæ‰§è¡Œå›è°ƒ ChannelHandler æ·»åŠ å®Œæˆ( added )äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callHandlerAdded0</span><span class="params">(<span class="keyword">final</span> AbstractChannelHandlerContext ctx)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">3</span>:         <span class="comment">// We must call setAddComplete before calling handlerAdded. Otherwise if the handlerAdded method generates</span></span><br><span class="line"> <span class="number">4</span>:         <span class="comment">// any pipeline events ctx.handler() will miss them because the state will not allow it.</span></span><br><span class="line"> <span class="number">5</span>:         <span class="comment">// è®¾ç½® AbstractChannelHandlerContext å·²æ·»åŠ </span></span><br><span class="line"> <span class="number">6</span>:         ctx.setAddComplete();</span><br><span class="line"> <span class="number">7</span>:         <span class="comment">// å›è°ƒ ChannelHandler æ·»åŠ å®Œæˆ( added )äº‹ä»¶</span></span><br><span class="line"> <span class="number">8</span>:         ctx.handler().handlerAdded(ctx);</span><br><span class="line"> <span class="number">9</span>:     } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line"><span class="number">10</span>:         <span class="comment">// å‘ç”Ÿå¼‚å¸¸ï¼Œç§»é™¤è¯¥èŠ‚ç‚¹</span></span><br><span class="line"><span class="number">11</span>:         <span class="keyword">boolean</span> removed = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">12</span>:         <span class="keyword">try</span> {</span><br><span class="line"><span class="number">13</span>:             remove0(ctx); <span class="comment">// ç§»é™¤</span></span><br><span class="line"><span class="number">14</span>:             <span class="keyword">try</span> {</span><br><span class="line"><span class="number">15</span>:                 ctx.handler().handlerRemoved(ctx); <span class="comment">// å›è°ƒ ChannelHandler ç§»é™¤å®Œæˆ( removed )äº‹ä»¶</span></span><br><span class="line"><span class="number">16</span>:             } <span class="keyword">finally</span> {</span><br><span class="line"><span class="number">17</span>:                 ctx.setRemoved(); <span class="comment">// æ ‡è®°èŠ‚ç‚¹å·²ç§»é™¤</span></span><br><span class="line"><span class="number">18</span>:             }</span><br><span class="line"><span class="number">19</span>:             removed = <span class="keyword">true</span>; <span class="comment">// æ ‡è®°ç§»é™¤æˆåŠŸ</span></span><br><span class="line"><span class="number">20</span>:         } <span class="keyword">catch</span> (Throwable t2) {</span><br><span class="line"><span class="number">21</span>:             <span class="keyword">if</span> (logger.isWarnEnabled()) {</span><br><span class="line"><span class="number">22</span>:                 logger.warn(<span class="string">"Failed to remove a handler: "</span> + ctx.name(), t2);</span><br><span class="line"><span class="number">23</span>:             }</span><br><span class="line"><span class="number">24</span>:         }</span><br><span class="line"><span class="number">25</span>: </span><br><span class="line"><span class="number">26</span>:         <span class="comment">// è§¦å‘å¼‚å¸¸çš„ä¼ æ’­</span></span><br><span class="line"><span class="number">27</span>:         <span class="keyword">if</span> (removed) {</span><br><span class="line"><span class="number">28</span>:             fireExceptionCaught(<span class="keyword">new</span> ChannelPipelineException(</span><br><span class="line"><span class="number">29</span>:                     ctx.handler().getClass().getName() +</span><br><span class="line"><span class="number">30</span>:                     <span class="string">".handlerAdded() has thrown an exception; removed."</span>, t));</span><br><span class="line"><span class="number">31</span>:         } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">32</span>:             fireExceptionCaught(<span class="keyword">new</span> ChannelPipelineException(</span><br><span class="line"><span class="number">33</span>:                     ctx.handler().getClass().getName() +</span><br><span class="line"><span class="number">34</span>:                     <span class="string">".handlerAdded() has thrown an exception; also failed to remove."</span>, t));</span><br><span class="line"><span class="number">35</span>:         }</span><br><span class="line"><span class="number">36</span>:     }</span><br><span class="line"><span class="number">37</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 6 è¡Œï¼šè°ƒç”¨ <code>AbstractChannelHandlerContext#setAddComplete()</code> æ–¹æ³•ï¼Œè®¾ç½® AbstractChannelHandlerContext å·²æ·»åŠ ã€‚</li>
<li>ç¬¬ 8 è¡Œï¼šè°ƒç”¨ <code>ChannelHandler#handlerAdded(AbstractChannelHandlerContext)</code> æ–¹æ³•ï¼Œå›è°ƒ ChannelHandler æ·»åŠ å®Œæˆ( added )äº‹ä»¶ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œé€šè¿‡è¿™ä¸ªæ–¹æ³•ï¼Œæ¥åˆå§‹åŒ– ChannelHandler ã€‚<strong>æ³¨æ„</strong>ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•çš„æ‰§è¡Œåœ¨ EventLoop çš„çº¿ç¨‹ä¸­ï¼Œæ‰€ä»¥è¦å°½é‡é¿å…æ‰§è¡Œæ—¶é—´è¿‡é•¿ã€‚</li>
<li>ç¬¬ 9 è¡Œï¼šå‘ç”Ÿå¼‚å¸¸ã€‚<ul>
<li>ç¬¬ 10 è‡³ 24 è¡Œï¼šç§»é™¤è¯¥èŠ‚ç‚¹( ChannelHandler )ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/ChannelPipeline-3-remove-channel-handler">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” ChannelPipelineï¼ˆä¸‰ï¼‰ä¹‹ç§»é™¤ ChannelHandlerã€‹</a> ã€‚<ul>
<li>ğŸ˜ˆ æ‰€ä»¥ï¼Œ<code>ChannelHandler#handlerAdded(AbstractChannelHandlerContext)</code> æ–¹æ³•çš„æ‰§è¡Œ<strong>å¼‚å¸¸</strong>æ—¶ï¼Œå°†è¢«ç§»é™¤ã€‚</li>
</ul>
</li>
<li>ç¬¬ 26 è‡³ 35 è¡Œï¼šè§¦å‘å¼‚å¸¸çš„ä¼ æ’­ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/ChannelPipeline-6-exception">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” ChannelPipelineï¼ˆå…­ï¼‰ä¹‹å¼‚å¸¸äº‹ä»¶çš„ä¼ æ’­ã€‹</a> ã€‚</li>
</ul>
</li>
</ul>
<h1 id="8-PendingHandlerCallback"><a href="#8-PendingHandlerCallback" class="headerlink" title="8. PendingHandlerCallback"></a>8. PendingHandlerCallback</h1><p>PendingHandlerCallback ï¼Œå®ç° Runnable æ¥å£ï¼Œç­‰å¾…æ·»åŠ  ChannelHandler å›è°ƒæŠ½è±¡ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>PendingHandlerCallback æ˜¯ DefaultChannelPipeline çš„å†…éƒ¨é™æ€ç±»ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PendingHandlerCallback</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * AbstractChannelHandlerContext èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> AbstractChannelHandlerContext ctx;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ä¸‹ä¸€ä¸ªå›è°ƒ PendingHandlerCallback å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PendingHandlerCallback next;</span><br><span class="line"></span><br><span class="line">    PendingHandlerCallback(AbstractChannelHandlerContext ctx) {</span><br><span class="line">        <span class="keyword">this</span>.ctx = ctx;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ‰§è¡Œæ–¹æ³•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é€šè¿‡ <code>ctx</code> å’Œ <code>next</code> å­—æ®µï¼Œå½¢æˆ<strong>å›è°ƒé“¾</strong>ã€‚</li>
<li><code>#execute()</code> æŠ½è±¡æ–¹æ³•ï¼Œé€šè¿‡å®ç°å®ƒï¼Œæ‰§è¡Œå›è°ƒé€»è¾‘ã€‚</li>
</ul>
<hr>
<p><strong>ä¸ºä»€ä¹ˆä¼šæœ‰ PendingHandlerCallback å‘¢</strong>ï¼Ÿ</p>
<p>å› ä¸º ChannelHandler æ·»åŠ åˆ° pipeline ä¸­ï¼Œä¼šè§¦å‘ ChannelHandler çš„æ·»åŠ å®Œæˆ( added )äº‹ä»¶ï¼Œå¹¶ä¸”è¯¥äº‹ä»¶éœ€è¦åœ¨ Channel æ‰€å±çš„ EventLoop ä¸­æ‰§è¡Œã€‚</p>
<p>ä½†æ˜¯ Channel å¹¶æœªæ³¨å†Œåœ¨ EventLoop ä¸Šæ—¶ï¼Œéœ€è¦æš‚æ—¶å°†â€œè§¦å‘ ChannelHandler çš„æ·»åŠ å®Œæˆ( added )äº‹ä»¶â€çš„é€»è¾‘ï¼Œä½œä¸ºä¸€ä¸ª PendingHandlerCallback è¿›è¡Œâ€œç¼“å­˜â€ã€‚åœ¨ Channel æ³¨å†Œåˆ° EventLoop ä¸Šæ—¶ï¼Œè¿›è¡Œå›è°ƒæ‰§è¡Œã€‚</p>
<hr>
<p>PendingHandlerCallback æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼š</p>
<ul>
<li>PendingHandlerAddedTask</li>
<li>PendingHandlerRemovedTask</li>
</ul>
<p>æœ¬æ–‡åªåˆ†äº« PendingHandlerAddedTask çš„ä»£ç å®ç°ã€‚</p>
<h2 id="8-1-PendingHandlerAddedTask"><a href="#8-1-PendingHandlerAddedTask" class="headerlink" title="8.1 PendingHandlerAddedTask"></a>8.1 PendingHandlerAddedTask</h2><p>PendingHandlerAddedTask å®ç° PendingHandlerCallback æŠ½è±¡ç±»ï¼Œç”¨äºå›è°ƒæ·»åŠ  ChannelHandler èŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PendingHandlerAddedTask</span> <span class="keyword">extends</span> <span class="title">PendingHandlerCallback</span> </span>{</span><br><span class="line"></span><br><span class="line">    PendingHandlerAddedTask(AbstractChannelHandlerContext ctx) {</span><br><span class="line">        <span class="keyword">super</span>(ctx);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">        callHandlerAdded0(ctx);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">execute</span><span class="params">()</span> </span>{</span><br><span class="line">        EventExecutor executor = ctx.executor();</span><br><span class="line">        <span class="comment">// åœ¨ EventLoop çš„çº¿ç¨‹ä¸­ï¼Œå›è°ƒ ChannelHandler added äº‹ä»¶</span></span><br><span class="line">        <span class="keyword">if</span> (executor.inEventLoop()) {</span><br><span class="line">            callHandlerAdded0(ctx);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// æäº¤ EventLoop ä¸­ï¼Œæ‰§è¡Œå›è°ƒ ChannelHandler added äº‹ä»¶</span></span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                executor.execute(<span class="keyword">this</span>); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">            } <span class="keyword">catch</span> (RejectedExecutionException e) {</span><br><span class="line">                <span class="keyword">if</span> (logger.isWarnEnabled()) {</span><br><span class="line">                    logger.warn(</span><br><span class="line">                            <span class="string">"Can't invoke handlerAdded() as the EventExecutor {} rejected it, removing handler {}."</span>,</span><br><span class="line">                            executor, ctx.name(), e);</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">// å‘ç”Ÿå¼‚å¸¸ï¼Œè¿›è¡Œç§»é™¤</span></span><br><span class="line">                remove0(ctx);</span><br><span class="line">                <span class="comment">// æ ‡è®° AbstractChannelHandlerContext ä¸ºå·²ç§»é™¤</span></span><br><span class="line">                ctx.setRemoved();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨ <code>#execute()</code> å®ç°æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå’Œ <code>#addLast(EventExecutorGroup group, String name, ChannelHandler handler)</code> æ–¹æ³•çš„ã€ç¬¬ 28 è‡³ 45 è¡Œã€‘çš„ä»£ç æ¯”è¾ƒç±»ä¼¼ï¼Œç›®çš„æ˜¯ï¼Œåœ¨ EventLoop çš„çº¿ç¨‹ä¸­ï¼Œæ‰§è¡Œ <code>#callHandlerAdded0(AbstractChannelHandlerContext)</code> æ–¹æ³•ï¼Œå›è°ƒ ChannelHandler æ·»åŠ å®Œæˆ( added )äº‹ä»¶ã€‚</li>
<li><code>&lt;1&gt;</code> å¤„ï¼Œä¸ºä»€ä¹ˆ PendingHandlerAddedTask å¯ä»¥ç›´æ¥æäº¤åˆ° EventLoop ä¸­å‘¢ï¼Ÿå› ä¸º PendingHandlerAddedTask æ˜¯ä¸ª Runnable ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆ PendingHandlerCallback å®ç° Runnable æ¥å£çš„åŸå› ã€‚</li>
</ul>
<blockquote>
<p>è€è‰¿è‰¿ï¼šä¸‹é¢å¼€å§‹åˆ†äº«çš„æ–¹æ³•ï¼Œå±äº DefaultChannelPipeline ç±»ã€‚</p>
</blockquote>
<h2 id="8-2-callHandlerCallbackLater"><a href="#8-2-callHandlerCallbackLater" class="headerlink" title="8.2 callHandlerCallbackLater"></a>8.2 callHandlerCallbackLater</h2><p><code>#callHandlerCallbackLater(AbstractChannelHandlerContext ctx, boolean added)</code> æ–¹æ³•ï¼Œæ·»åŠ  PendingHandlerCallback å›è°ƒã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is the head of a linked list that is processed by {<span class="doctag">@link</span> #callHandlerAddedForAllHandlers()} and so process</span></span><br><span class="line"><span class="comment"> * all the pending {<span class="doctag">@link</span> #callHandlerAdded0(AbstractChannelHandlerContext)}.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We only keep the head because it is expected that the list is used infrequently and its size is small.</span></span><br><span class="line"><span class="comment"> * Thus full iterations to do insertions is assumed to be a good compromised to saving memory and tail management</span></span><br><span class="line"><span class="comment"> * complexity.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å‡†å¤‡æ·»åŠ  ChannelHandler çš„å›è°ƒ</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #callHandlerCallbackLater(AbstractChannelHandlerContext, boolean)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> PendingHandlerCallback pendingHandlerCallbackHead;</span><br><span class="line">    </span><br><span class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callHandlerCallbackLater</span><span class="params">(AbstractChannelHandlerContext ctx, <span class="keyword">boolean</span> added)</span> </span>{</span><br><span class="line">  <span class="number">2</span>:     <span class="keyword">assert</span> !registered;</span><br><span class="line">  <span class="number">3</span>: </span><br><span class="line">  <span class="number">4</span>:     <span class="comment">// åˆ›å»º PendingHandlerCallback å¯¹è±¡</span></span><br><span class="line">  <span class="number">5</span>:     PendingHandlerCallback task = added ? <span class="keyword">new</span> PendingHandlerAddedTask(ctx) : <span class="keyword">new</span> PendingHandlerRemovedTask(ctx);</span><br><span class="line">  <span class="number">6</span>:     PendingHandlerCallback pending = pendingHandlerCallbackHead;</span><br><span class="line">  <span class="number">7</span>:     <span class="comment">// è‹¥åŸ pendingHandlerCallbackHead ä¸å­˜åœ¨ï¼Œåˆ™èµ‹å€¼ç»™å®ƒ</span></span><br><span class="line">  <span class="number">8</span>:     <span class="keyword">if</span> (pending == <span class="keyword">null</span>) {</span><br><span class="line">  <span class="number">9</span>:         pendingHandlerCallbackHead = task;</span><br><span class="line"> <span class="number">10</span>:     <span class="comment">// è‹¥åŸ pendingHandlerCallbackHead å·²å­˜åœ¨ï¼Œåˆ™æœ€åä¸€ä¸ªå›è°ƒæŒ‡å‘æ–°åˆ›å»ºçš„å›è°ƒ</span></span><br><span class="line"> <span class="number">11</span>:     } <span class="keyword">else</span> {</span><br><span class="line"> <span class="number">12</span>:         <span class="comment">// Find the tail of the linked-list.</span></span><br><span class="line"> <span class="number">13</span>:         <span class="keyword">while</span> (pending.next != <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">14</span>:             pending = pending.next;</span><br><span class="line"> <span class="number">15</span>:         }</span><br><span class="line"> <span class="number">16</span>:         pending.next = task;</span><br><span class="line"> <span class="number">17</span>:     }</span><br><span class="line"> <span class="number">18</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>added</code> æ–¹æ³•å‚æ•°ï¼Œè¡¨ç¤ºæ˜¯å¦æ˜¯æ·»åŠ  ChannelHandler çš„å›è°ƒã€‚æ‰€ä»¥åœ¨ã€ç¬¬ 5 è¡Œã€‘çš„ä»£ç ï¼Œæ ¹æ® <code>added</code> æ˜¯å¦ä¸º <code>true</code> ï¼Œåˆ›å»º PendingHandlerAddedTask æˆ– PendingHandlerRemovedTask å¯¹è±¡ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œå½“ç„¶åˆ›å»ºçš„æ˜¯ PendingHandlerAddedTask ã€‚</li>
<li>ç¬¬ 7 è‡³ 17 è¡Œï¼šå°†åˆ›å»ºçš„ PendingHandlerCallback å¯¹è±¡ï¼Œâ€œæ·»åŠ â€åˆ° <code>pendingHandlerCallbackHead</code> ä¸­ã€‚</li>
</ul>
<h2 id="8-3-invokeHandlerAddedIfNeeded"><a href="#8-3-invokeHandlerAddedIfNeeded" class="headerlink" title="8.3 invokeHandlerAddedIfNeeded"></a>8.3 invokeHandlerAddedIfNeeded</h2><p><code>#invokeHandlerAddedIfNeeded()</code> æ–¹æ³•ï¼Œæ‰§è¡Œ<strong>åœ¨ PendingHandlerCallback ä¸­</strong>çš„ ChannelHandler æ·»åŠ å®Œæˆ( added )äº‹ä»¶ã€‚å®ƒè¢«ä¸¤ä¸ªæ–¹æ³•æ‰€è°ƒç”¨ï¼š</p>
<ul>
<li><p><code>AbstractUnsafe#register0(ChannelPromise promise)</code> æ–¹æ³•</p>
<ul>
<li><p>åŸå› æ˜¯ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Ensure we call handlerAdded(...) before we actually notify the promise. This is needed as the</span></span><br><span class="line"><span class="comment">// user may already fire events through the pipeline in the ChannelFutureListener.</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¾‹å¦‚ ServerBootstrap é€šè¿‡ ChannelInitializer æ³¨å†Œè‡ªå®šä¹‰çš„ ChannelHandler åˆ° pipeline ä¸Šçš„æƒ…å†µã€‚</li>
</ul>
</li>
<li>è°ƒç”¨æ ˆå¦‚ä¸‹å›¾ï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_06_04/03.png" title="register0" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_06_04/03.png" alt="register0"></a><span class="caption">register0</span></li>
</ul>
</li>
<li><code>HeadContext#channelRegistered(ChannelHandlerContext ctx)</code> æ–¹æ³•ã€‚<ul>
<li>ç¬”è€…è°ƒè¯•ä¸‹æ¥ï¼Œå¯¹äº Netty NIO Server å’Œ NIO Client è²Œä¼¼æ²¡å•¥ä½œç”¨ï¼Œå› ä¸ºå·²ç»åœ¨ <code>AbstractUnsafe#register0(ChannelPromise promise)</code> ä¸­è§¦å‘ã€‚èƒ–å‹ä¹Ÿå¯ä»¥è‡ªå·±è°ƒè¯•ä¸‹ã€‚</li>
<li>è°ƒç”¨æ ˆå¦‚ä¸‹å›¾ï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_06_04/04.png" title="channelRegistered" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_06_04/04.png" alt="channelRegistered"></a><span class="caption">channelRegistered</span></li>
</ul>
</li>
</ul>
<hr>
<p><code>#invokeHandlerAddedIfNeeded()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦é¦–æ¬¡æ³¨å†Œ</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #invokeHandlerAddedIfNeeded()}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> firstRegistration = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invokeHandlerAddedIfNeeded</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">assert</span> channel.eventLoop().inEventLoop(); <span class="comment">// å¿…é¡»åœ¨ EventLoop çš„çº¿ç¨‹ä¸­</span></span><br><span class="line">    <span class="comment">// ä»…æœ‰é¦–æ¬¡æ³¨å†Œæœ‰æ•ˆ &lt;1&gt;</span></span><br><span class="line">    <span class="keyword">if</span> (firstRegistration) {</span><br><span class="line">        <span class="comment">// æ ‡è®°éé¦–æ¬¡æ³¨å†Œ</span></span><br><span class="line">        firstRegistration = <span class="keyword">false</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰§è¡Œåœ¨ PendingHandlerCallback ä¸­çš„ ChannelHandler æ·»åŠ å®Œæˆ( added )äº‹ä»¶ // &lt;2&gt;</span></span><br><span class="line">        <span class="comment">// We are now registered to the EventLoop. It's time to call the callbacks for the ChannelHandlers,</span></span><br><span class="line">        <span class="comment">// that were added before the registration was done.</span></span><br><span class="line">        callHandlerAddedForAllHandlers();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œä»…æœ‰é¦–æ¬¡æ³¨å†Œæœ‰æ•ˆ( <code>firstRegistration = true</code> ) æ—¶ã€‚è€Œåï¼Œæ ‡è®° <code>firstRegistration = false</code> ã€‚<ul>
<li>è¿™ä¹Ÿå°±æ˜¯ç¬”è€…ä¸ºä»€ä¹ˆè¯´ï¼Œ<code>HeadContext#channelRegistered(ChannelHandlerContext ctx)</code> æ–¹æ³•å¯¹è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨ï¼Œæ˜¯æ²¡æœ‰æ•ˆæœçš„ã€‚</li>
</ul>
</li>
<li><p><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#callHandlerAddedForAllHandlers()</code> æ–¹æ³•ï¼Œæ‰§è¡Œ<strong>åœ¨ PendingHandlerCallback ä¸­</strong>çš„ ChannelHandler æ·»åŠ å®Œæˆ( added )äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">callHandlerAddedForAllHandlers</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">final</span> PendingHandlerCallback pendingHandlerCallbackHead;</span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// è·å¾— pendingHandlerCallbackHead</span></span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">synchronized</span> (<span class="keyword">this</span>) {</span><br><span class="line"> <span class="number">5</span>:         <span class="keyword">assert</span> !registered;</span><br><span class="line"> <span class="number">6</span>: </span><br><span class="line"> <span class="number">7</span>:         <span class="comment">// This Channel itself was registered.</span></span><br><span class="line"> <span class="number">8</span>:         registered = <span class="keyword">true</span>; <span class="comment">// æ ‡è®°å·²æ³¨å†Œ</span></span><br><span class="line"> <span class="number">9</span>: </span><br><span class="line"><span class="number">10</span>:         pendingHandlerCallbackHead = <span class="keyword">this</span>.pendingHandlerCallbackHead;</span><br><span class="line"><span class="number">11</span>:         <span class="comment">// Null out so it can be GC'ed.</span></span><br><span class="line"><span class="number">12</span>:         <span class="keyword">this</span>.pendingHandlerCallbackHead = <span class="keyword">null</span>; <span class="comment">// ç½®ç©ºï¼Œhelp gc</span></span><br><span class="line"><span class="number">13</span>:     }</span><br><span class="line"><span class="number">14</span>: </span><br><span class="line"><span class="number">15</span>:     <span class="comment">// é¡ºåºå‘ä¸‹ï¼Œæ‰§è¡Œ PendingHandlerCallback çš„å›è°ƒ</span></span><br><span class="line"><span class="number">16</span>:     <span class="comment">// This must happen outside of the synchronized(...) block as otherwise handlerAdded(...) may be called while</span></span><br><span class="line"><span class="number">17</span>:     <span class="comment">// holding the lock and so produce a deadlock if handlerAdded(...) will try to add another handler from outside</span></span><br><span class="line"><span class="number">18</span>:     <span class="comment">// the EventLoop.</span></span><br><span class="line"><span class="number">19</span>:     PendingHandlerCallback task = pendingHandlerCallbackHead;</span><br><span class="line"><span class="number">20</span>:     <span class="keyword">while</span> (task != <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">21</span>:         task.execute();</span><br><span class="line"><span class="number">22</span>:         task = task.next;</span><br><span class="line"><span class="number">23</span>:     }</span><br><span class="line"><span class="number">24</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è‡³ 13 è¡Œï¼šè·å¾— <code>pendingHandlerCallbackHead</code> å˜é‡ã€‚<ul>
<li>ç¬¬ 8 è¡Œï¼šæ ‡è®° <code>registered = true</code> ï¼Œè¡¨ç¤ºå·²æ³¨å†Œã€‚</li>
<li>ç¬¬ 10 è‡³ 12 è¡Œï¼šç½®ç©ºå¯¹è±¡çš„ <code>pendingHandlerCallbackHead</code> å±æ€§ï¼Œhelp GC ã€‚</li>
<li>ä½¿ç”¨ <code>synchronized</code> çš„åŸå› ï¼Œå’Œ <code>#addLast(EventExecutorGroup group, String name, ChannelHandler handler)</code> çš„ã€ç¬¬ 16 è‡³ 26 è¡Œã€‘çš„ä»£ç éœ€è¦å¯¹ <code>pendingHandlerCallbackHead</code> äº’æ–¥ï¼Œé¿å…å¹¶å‘ä¿®æ”¹çš„é—®é¢˜ã€‚</li>
</ul>
</li>
<li>ç¬¬ 15 è‡³ 23 è¡Œï¼šé¡ºåºå¾ªç¯å‘ä¸‹ï¼Œè°ƒç”¨ <code>PendingHandlerCallback#execute()</code> æ–¹æ³•ï¼Œæ‰§è¡Œ PendingHandlerCallback çš„å›è°ƒï¼Œä»è€Œå°† ChannelHandler æ·»åŠ åˆ° pipeline ä¸­ã€‚<ul>
<li>è¿™é‡Œä¸é€‚ç”¨ <code>synchronized</code> çš„åŸå› ï¼Œçœ‹è‹±æ–‡æ³¨é‡Šå“ˆã€‚ </li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p><strong>æ·»åŠ </strong> ChannelHandler åˆ° pipeline ä¸­çš„ä»£ç ï¼Œå¤§éƒ¨åˆ†çš„æ¯”è¾ƒç®€å•ã€‚æ¯”è¾ƒå¤æ‚çš„å¯èƒ½æ˜¯ï¼Œ<a href="#">ã€Œ8. PendingHandlerCallbackã€</a> ä¸­ï¼Œè°ƒç”¨çš„è¿‡ç¨‹æ¶‰åŠ<strong>å›è°ƒ</strong>ï¼Œæ‰€ä»¥ç†è§£ä¸Šç¨å¾®å¯èƒ½å›°éš¾ã€‚èƒ–å‹å¯ä»¥å¤šå¤šè°ƒè¯•è¿›è¡Œè§£å†³å™¢ã€‚</p>
<p>æ¨èé˜…è¯»æ–‡ç« ï¼š</p>
<ul>
<li>é—ªç”µä¾  <a href="https://www.jianshu.com/p/6efa9c5fa702" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty æºç åˆ†æä¹‹ pipeline(ä¸€)ã€‹</a></li>
<li>Hypercube <a href="https://www.jianshu.com/p/0e15165714fc" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æ Nettyï¼ˆä¸ƒï¼‰â€“ChannelPipeline æºç å®ç°ã€‹</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/Pipeline-2-add-channel-handler/" data-id="ck4pl3foy00dkfgcf5y268937" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>