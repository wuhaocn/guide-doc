<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” Codec ä¹‹ ByteToMessageDecoderï¼ˆä¸€ï¼‰Cumulator
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>åœ¨ <a href="http://svip.iocoder.cn/Netty/ChannelHandler-1-intro">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” ChannelHandlerï¼ˆä¸€ï¼‰ä¹‹ç®€ä»‹ã€‹</a> ä¸­ï¼Œæˆ‘ä»¬çœ‹äº† ChannelHandler çš„æ ¸å¿ƒç±»å›¾ï¼Œå¦‚ä¸‹ï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_10_01/01.png" title="æ ¸å¿ƒç±»å›¾" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_10_01/01.png" alt="æ ¸å¿ƒç±»å›¾"></a><span class="caption">æ ¸å¿ƒç±»å›¾</span></p>
<ul>
<li><p><strong>ç»¿æ¡†</strong>éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒNetty åŸºäº ChannelHandler å®ç°äº†è¯»å†™çš„æ•°æ®( æ¶ˆæ¯ )çš„ç¼–è§£ç ã€‚</p>
<blockquote>
<p>Codec( ç¼–è§£ç  ) = Encode( ç¼–ç  ) + Decode( è§£ç  )ã€‚</p>
</blockquote>
</li>
<li><p>å›¾ä¸­æœ‰äº”ä¸ªå’Œ Codec ç›¸å…³çš„ç±»ï¼Œæ•´ç†å¦‚ä¸‹ï¼š</p>
<ul>
<li>ğŸ˜ˆ ï¼Œå®é™…åº”è¯¥æ˜¯å…­ä¸ªï¼Œæ¼ç”»äº† MessageToMessageDecoder ç±»ã€‚</li>
<li>ByteToMessageCodec ï¼ŒByteToMessageDecoder + MessageByteEncoder çš„<strong>ç»„åˆ</strong>ã€‚<ul>
<li>ByteToMessageDecoder ï¼Œå°†å­—èŠ‚<strong>è§£ç </strong>æˆæ¶ˆæ¯ã€‚</li>
<li>MessageByteEncoder ï¼Œå°†æ¶ˆæ¯<strong>ç¼–ç </strong>æˆå­—èŠ‚ã€‚</li>
</ul>
</li>
<li>MessageToMessageCodec ï¼ŒMessageToMessageDecoder + MessageToMessageEncoder çš„<strong>ç»„åˆ</strong>ã€‚<ul>
<li>MessageToMessageDecoder ï¼Œå°†æ¶ˆæ¯<strong>è§£ç </strong>æˆå¦ä¸€ç§æ¶ˆæ¯ã€‚</li>
<li>MessageToMessageEncoder ï¼Œå°†æ¶ˆæ¯<strong>ç¼–ç </strong>æˆå¦ä¸€ç§æ¶ˆæ¯ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p>è€Œæœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥åˆ†äº« ByteToMessageDecoder éƒ¨åˆ†çš„å†…å®¹ã€‚</p>
<h1 id="2-ByteToMessageDecoder-æ ¸å¿ƒç±»å›¾"><a href="#2-ByteToMessageDecoder-æ ¸å¿ƒç±»å›¾" class="headerlink" title="2. ByteToMessageDecoder æ ¸å¿ƒç±»å›¾"></a>2. ByteToMessageDecoder æ ¸å¿ƒç±»å›¾</h1><p><a href="http://static2.iocoder.cn/images/Netty/2018_12_01/01.png" title="æ ¸å¿ƒç±»å›¾" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_12_01/01.png" alt="æ ¸å¿ƒç±»å›¾"></a><span class="caption">æ ¸å¿ƒç±»å›¾</span></p>
<p>ByteToMessageDecoder æœ¬èº«æ˜¯ä¸ª<strong>æŠ½è±¡</strong>ç±»ï¼Œå…¶ä¸‹æœ‰å¤šä¸ªå­ç±»ï¼Œç¬”è€…ç®€å•æ•´ç†æˆä¸‰ç±»ï¼Œå¯èƒ½ä¸å…¨å“ˆï¼š</p>
<ul>
<li><strong>ç»¿æ¡†</strong>éƒ¨åˆ† FrameDecoder ï¼šæ¶ˆæ¯å¸§( Frame )è§£ç å™¨ã€‚ä¹Ÿå°±æ˜¯è¯´è¯¥ç±»è§£ç å™¨ï¼Œç”¨äºå¤„ç† TCP çš„<strong>ç²˜åŒ…</strong>ç°è±¡ï¼Œå°†ç½‘ç»œå‘é€çš„å­—èŠ‚æµè§£ç ä¸ºå…·æœ‰ç¡®å®šå«ä¹‰çš„æ¶ˆæ¯å¸§ã€‚ä¹‹åçš„è§£ç å™¨å†å°†æ¶ˆæ¯å¸§è§£ç ä¸ºå®é™…çš„ POJO å¯¹è±¡ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_12_01/02.png" rel="external nofollow noopener noreferrer" target="_blank">decode</a></li>
<li><strong>é»„æ¡†</strong>éƒ¨åˆ†ï¼Œå°†å­—èŠ‚æµä½¿ç”¨<strong>æŒ‡å®šåºåˆ—åŒ–æ–¹å¼</strong>ååºåˆ—åŒ–æˆ<strong>æ¶ˆæ¯</strong>ï¼Œä¾‹å¦‚ï¼šXMLã€JSON ç­‰ç­‰ã€‚<ul>
<li>å¯¹äºè¯¥ç±»è§£ç å™¨ï¼Œä¸å¤„ç† TCP çš„<strong>ç²˜åŒ…</strong>ç°è±¡ï¼Œæ‰€ä»¥éœ€è¦æ­é… FrameDecoder ä¸€èµ·ä½¿ç”¨ã€‚</li>
</ul>
</li>
<li><strong>è“æ¡†</strong>éƒ¨åˆ†ï¼Œå°†å­—èŠ‚æµ<strong>è§£å‹</strong>ï¼Œä¸»è¦æ¶‰åŠç›¸å…³å‹ç¼©ç®—æ³•ï¼Œä¾‹å¦‚ï¼šGZipã€BZip ç­‰ç­‰ã€‚<ul>
<li>å¯¹äºè¯¥ç±»è§£ç å™¨ï¼Œä¸å¤„ç† TCP çš„<strong>ç²˜åŒ…</strong>ç°è±¡ï¼Œæ‰€ä»¥éœ€è¦æ­é… FrameDecoder ä¸€èµ·ä½¿ç”¨ã€‚</li>
</ul>
</li>
</ul>
<h1 id="3-ä¸ºä»€ä¹ˆè¦ç²˜åŒ…æ‹†åŒ…"><a href="#3-ä¸ºä»€ä¹ˆè¦ç²˜åŒ…æ‹†åŒ…" class="headerlink" title="3. ä¸ºä»€ä¹ˆè¦ç²˜åŒ…æ‹†åŒ…"></a>3. ä¸ºä»€ä¹ˆè¦ç²˜åŒ…æ‹†åŒ…</h1><p>ğŸ˜ˆ å› ä¸ºæœ‰äº›æœ‹å‹ä¸äº†è§£ç²˜åŒ…å’Œæ‹†åŒ…çš„æ¦‚å¿µå’ŒåŸç†ï¼Œè¿™é‡Œå¼•ç”¨ç¬”è€…çš„åŸºå‹ã€é—ªç”µä¾ ã€‘åœ¨ <a href="https://www.jianshu.com/p/dc26e944da95" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnetty æºç åˆ†æä¹‹æ‹†åŒ…å™¨çš„å¥¥ç§˜ã€‹</a> å¯¹è¿™å—çš„æè¿°ã€‚</p>
<h2 id="3-1-ä¸ºä»€ä¹ˆè¦ç²˜åŒ…"><a href="#3-1-ä¸ºä»€ä¹ˆè¦ç²˜åŒ…" class="headerlink" title="3.1 ä¸ºä»€ä¹ˆè¦ç²˜åŒ…"></a>3.1 ä¸ºä»€ä¹ˆè¦ç²˜åŒ…</h2><blockquote>
<p>é¦–å…ˆä½ å¾—äº†è§£ä¸€ä¸‹ TCP/IP åè®®ï¼Œåœ¨ç”¨æˆ·æ•°æ®é‡éå¸¸å°çš„æƒ…å†µä¸‹ï¼Œæç«¯æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå­—èŠ‚ï¼Œè¯¥ TCP æ•°æ®åŒ…çš„æœ‰æ•ˆè½½è·éå¸¸ä½ï¼Œä¼ é€’ 100 å­—èŠ‚çš„æ•°æ®ï¼Œéœ€è¦ 100 æ¬¡TCPä¼ é€ï¼Œ 100 æ¬¡ACKï¼Œåœ¨åº”ç”¨åŠæ—¶æ€§è¦æ±‚ä¸é«˜çš„æƒ…å†µä¸‹ï¼Œå°†è¿™ 100 ä¸ªæœ‰æ•ˆæ•°æ®æ‹¼æ¥æˆä¸€ä¸ªæ•°æ®åŒ…ï¼Œé‚£ä¼šç¼©çŸ­åˆ°ä¸€ä¸ªTCPæ•°æ®åŒ…ï¼Œä»¥åŠä¸€ä¸ª ack ï¼Œæœ‰æ•ˆè½½è·æé«˜äº†ï¼Œå¸¦å®½ä¹ŸèŠ‚çœäº†ã€‚</p>
<p>éæç«¯æƒ…å†µï¼Œæœ‰å¯èƒ½<strong>ä¸¤ä¸ª</strong>æ•°æ®åŒ…æ‹¼æ¥æˆä¸€ä¸ªæ•°æ®åŒ…ï¼Œä¹Ÿæœ‰å¯èƒ½<strong>ä¸€ä¸ªåŠ</strong>çš„æ•°æ®åŒ…æ‹¼æ¥æˆä¸€ä¸ªæ•°æ®åŒ…ï¼Œä¹Ÿæœ‰å¯èƒ½<strong>ä¸¤ä¸ªåŠ</strong>çš„æ•°æ®åŒ…æ‹¼æ¥æˆä¸€ä¸ªæ•°æ®åŒ…ã€‚</p>
</blockquote>
<h2 id="3-2-ä¸ºä»€ä¹ˆè¦æ‹†åŒ…"><a href="#3-2-ä¸ºä»€ä¹ˆè¦æ‹†åŒ…" class="headerlink" title="3.2 ä¸ºä»€ä¹ˆè¦æ‹†åŒ…"></a>3.2 ä¸ºä»€ä¹ˆè¦æ‹†åŒ…</h2><blockquote>
<p>æ‹†åŒ…å’Œç²˜åŒ…æ˜¯ç›¸å¯¹çš„ï¼Œä¸€ç«¯ç²˜äº†åŒ…ï¼Œå¦å¤–ä¸€ç«¯å°±éœ€è¦å°†ç²˜è¿‡çš„åŒ…æ‹†å¼€ã€‚ä¸¾ä¸ªæ —å­ï¼Œå‘é€ç«¯å°†ä¸‰ä¸ªæ•°æ®åŒ…ç²˜æˆä¸¤ä¸ªTCPæ•°æ®åŒ…å‘é€åˆ°æ¥æ”¶ç«¯ï¼Œæ¥æ”¶ç«¯å°±éœ€è¦æ ¹æ®åº”ç”¨åè®®å°†ä¸¤ä¸ªæ•°æ®åŒ…é‡æ–°ç»„è£…æˆä¸‰ä¸ªæ•°æ®åŒ…ã€‚</p>
<p>è¿˜æœ‰ä¸€ç§æƒ…å†µå°±æ˜¯ç”¨æˆ·æ•°æ®åŒ…è¶…è¿‡äº† mss(æœ€å¤§æŠ¥æ–‡é•¿åº¦)ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°æ®åŒ…åœ¨å‘é€çš„æ—¶å€™å¿…é¡»æ‹†åˆ†æˆå‡ ä¸ªæ•°æ®åŒ…ï¼Œæ¥æ”¶ç«¯æ”¶åˆ°ä¹‹åéœ€è¦å°†è¿™äº›æ•°æ®åŒ…ç²˜åˆèµ·æ¥ä¹‹åï¼Œå†æ‹†å¼€ã€‚</p>
</blockquote>
<h2 id="3-3-æ‹†åŒ…çš„åŸç†"><a href="#3-3-æ‹†åŒ…çš„åŸç†" class="headerlink" title="3.3 æ‹†åŒ…çš„åŸç†"></a>3.3 æ‹†åŒ…çš„åŸç†</h2><blockquote>
<p>æ•°æ®ï¼Œæ¯æ¬¡è¯»å–å®Œéƒ½éœ€è¦åˆ¤æ–­æ˜¯å¦æ˜¯ä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ…ï¼š</p>
<ol>
<li>å¦‚æœå½“å‰è¯»å–çš„æ•°æ®ä¸è¶³ä»¥æ‹¼æ¥æˆä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡æ•°æ®åŒ…ï¼Œé‚£å°±ä¿ç•™è¯¥æ•°æ®ï¼Œç»§ç»­ä»tcpç¼“å†²åŒºä¸­è¯»å–ï¼Œç›´åˆ°å¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„æ•°æ®åŒ…ã€‚</li>
<li>å¦‚æœå½“å‰è¯»åˆ°çš„æ•°æ®åŠ ä¸Šå·²ç»è¯»å–çš„æ•°æ®è¶³å¤Ÿæ‹¼æ¥æˆä¸€ä¸ªæ•°æ®åŒ…ï¼Œé‚£å°±å°†å·²ç»è¯»å–çš„æ•°æ®æ‹¼æ¥ä¸Šæœ¬æ¬¡è¯»å–çš„æ•°æ®ï¼Œå¤Ÿæˆä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡æ•°æ®åŒ…ä¼ é€’åˆ°ä¸šåŠ¡é€»è¾‘ï¼Œå¤šä½™çš„æ•°æ®ä»ç„¶ä¿ç•™ï¼Œä»¥ä¾¿å’Œä¸‹æ¬¡è¯»åˆ°çš„æ•°æ®å°è¯•æ‹¼æ¥ã€‚</li>
</ol>
</blockquote>
<h1 id="4-Cumulator"><a href="#4-Cumulator" class="headerlink" title="4. Cumulator"></a>4. Cumulator</h1><p>Cumulator ï¼Œæ˜¯ ByteToMessageDecoder çš„<strong>å†…éƒ¨</strong>æ¥å£ã€‚ä¸­æ–‡ç¿»è¯‘ä¸ºâ€œç´¯åŠ å™¨â€ï¼Œç”¨äºå°†è¯»å–åˆ°çš„æ•°æ®è¿›è¡Œç´¯åŠ åˆ°ä¸€èµ·ï¼Œç„¶åå†å°è¯•<strong>è§£ç </strong>ï¼Œä»è€Œå®ç°<strong>æ‹†åŒ…</strong>ã€‚</p>
<p>ä¹Ÿæ˜¯å› ä¸º Cumulator çš„ç´¯åŠ ï¼Œæ‰€ä»¥èƒ½å°†ä¸å®Œæ•´çš„åŒ…ç´¯åŠ åˆ°ä¸€èµ·ï¼Œä»è€Œå®Œæ•´ã€‚å½“ç„¶ï¼Œç´¯åŠ çš„è¿‡ç¨‹ï¼Œæ²¡å‡†åˆè¿›å…¥äº†ä¸€ä¸ªä¸å®Œæ•´çš„åŒ…ã€‚æ‰€ä»¥ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸æ–­ç´¯åŠ ï¼Œä¸æ–­è§£ç æ‹†åŒ…çš„è¿‡ç¨‹ã€‚</p>
<hr>
<p>Cumulator æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ByteBuf ç´¯ç§¯å™¨æ¥å£</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Cumulate {<span class="doctag">@link</span> ByteBuf}s.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Cumulator</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cumulate the given {<span class="doctag">@link</span> ByteBuf}s and return the {<span class="doctag">@link</span> ByteBuf} that holds the cumulated bytes.</span></span><br><span class="line"><span class="comment">     * The implementation is responsible to correctly handle the life-cycle of the given {<span class="doctag">@link</span> ByteBuf}s and so</span></span><br><span class="line"><span class="comment">     * call {<span class="doctag">@link</span> ByteBuf#release()} if a {<span class="doctag">@link</span> ByteBuf} is fully consumed.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> alloc ByteBuf åˆ†é…å™¨</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cumulation ByteBuf å½“å‰ç´¯ç§¯ç»“æœ</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> in å½“å‰è¯»å–( è¾“å…¥ ) ByteBuf</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ByteBuf æ–°çš„ç´¯ç§¯ç»“æœ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ByteBuf <span class="title">cumulate</span><span class="params">(ByteBufAllocator alloc, ByteBuf cumulation, ByteBuf in)</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¯¹äº <code>Cumulator#cumulate(ByteBufAllocator alloc, ByteBuf cumulation, ByteBuf in)</code> æ–¹æ³•ï¼Œå°†<strong>åŸæœ‰</strong> <code>cumulation</code> ç´¯åŠ ä¸Š<strong>æ–°çš„</strong> <code>in</code> ï¼Œè¿”å›â€œæ–°â€çš„ ByteBuf å¯¹è±¡ã€‚</li>
<li>å¦‚æœ <code>in</code> è¿‡å¤§ï¼Œè¶…è¿‡ <code>cumulation</code> çš„ç©ºé—´ä¸Šé™ï¼Œä½¿ç”¨ <code>alloc</code> è¿›è¡Œæ‰©å®¹åå†ç´¯åŠ ã€‚</li>
</ul>
<hr>
<p>Cumulator æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Cumulator MERGE_CUMULATOR = <span class="keyword">new</span> Cumulator() {</span><br><span class="line">    <span class="comment">// ... çœç•¥ä»£ç </span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Cumulator COMPOSITE_CUMULATOR = <span class="keyword">new</span> Cumulator() {</span><br><span class="line">    <span class="comment">// ... çœç•¥ä»£ç </span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸¤è€…çš„ç´¯åŠ æ–¹å¼ä¸åŒï¼Œæˆ‘ä»¬æ¥è¯¦ç»†è§£æã€‚</p>
<h2 id="4-1-MERGE-CUMULATOR"><a href="#4-1-MERGE-CUMULATOR" class="headerlink" title="4.1 MERGE_CUMULATOR"></a>4.1 MERGE_CUMULATOR</h2><p><code>MERGE_CUMULATOR</code> æ€è·¯æ˜¯ï¼Œä¸æ–­ä½¿ç”¨<strong>è€çš„</strong> ByteBuf ç´¯ç§¯ã€‚å¦‚æœç©ºé—´ä¸å¤Ÿï¼Œæ‰©å®¹å‡º<strong>æ–°çš„</strong> ByteBuf ï¼Œå†ç»§ç»­è¿›è¡Œç´¯ç§¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ByteToMessageDecoder.java</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cumulate {<span class="doctag">@link</span> ByteBuf}s by merge them into one {<span class="doctag">@link</span> ByteBuf}'s, using memory copies.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="number">1</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Cumulator MERGE_CUMULATOR = <span class="keyword">new</span> Cumulator() {</span><br><span class="line">  <span class="number">2</span>: </span><br><span class="line">  <span class="number">3</span>:     <span class="meta">@Override</span></span><br><span class="line">  <span class="number">4</span>:     <span class="function"><span class="keyword">public</span> ByteBuf <span class="title">cumulate</span><span class="params">(ByteBufAllocator alloc, ByteBuf cumulation, ByteBuf in)</span> </span>{</span><br><span class="line">  <span class="number">5</span>:         <span class="keyword">final</span> ByteBuf buffer;</span><br><span class="line">  <span class="number">6</span>:         <span class="keyword">if</span> (cumulation.writerIndex() &gt; cumulation.maxCapacity() - in.readableBytes() <span class="comment">// è¶…è¿‡ç©ºé—´å¤§å°ï¼Œéœ€è¦æ‰©å®¹</span></span><br><span class="line">  <span class="number">7</span>:                 || cumulation.refCnt() &gt; <span class="number">1</span> <span class="comment">// å¼•ç”¨å¤§äº 1 ï¼Œè¯´æ˜ç”¨æˆ·ä½¿ç”¨äº† slice().retain() æˆ– duplicate().retain() ä½¿refCntå¢åŠ å¹¶ä¸”å¤§äº 1 ï¼Œ</span></span><br><span class="line">  <span class="number">8</span>:                                            <span class="comment">// æ­¤æ—¶æ‰©å®¹è¿”å›ä¸€ä¸ªæ–°çš„ç´¯ç§¯åŒºByteBufï¼Œæ–¹ä¾¿ç”¨æˆ·å¯¹è€çš„ç´¯ç§¯åŒºByteBufè¿›è¡Œåç»­å¤„ç†ã€‚</span></span><br><span class="line">  <span class="number">9</span>:                 || cumulation.isReadOnly()) { <span class="comment">// åªè¯»ï¼Œä¸å¯ç´¯åŠ ï¼Œæ‰€ä»¥éœ€è¦æ”¹æˆå¯å†™</span></span><br><span class="line"> <span class="number">10</span>:             <span class="comment">// Expand cumulation (by replace it) when either there is not more room in the buffer</span></span><br><span class="line"> <span class="number">11</span>:             <span class="comment">// or if the refCnt is greater then 1 which may happen when the user use slice().retain() or</span></span><br><span class="line"> <span class="number">12</span>:             <span class="comment">// duplicate().retain() or if its read-only.</span></span><br><span class="line"> <span class="number">13</span>:             <span class="comment">//</span></span><br><span class="line"> <span class="number">14</span>:             <span class="comment">// See:</span></span><br><span class="line"> <span class="number">15</span>:             <span class="comment">// - https://github.com/netty/netty/issues/2327</span></span><br><span class="line"> <span class="number">16</span>:             <span class="comment">// - https://github.com/netty/netty/issues/1764</span></span><br><span class="line"> <span class="number">17</span>:             <span class="comment">// æ‰©å®¹ï¼Œè¿”å›æ–°çš„ buffer</span></span><br><span class="line"> <span class="number">18</span>:             buffer = expandCumulation(alloc, cumulation, in.readableBytes());</span><br><span class="line"> <span class="number">19</span>:         } <span class="keyword">else</span> {</span><br><span class="line"> <span class="number">20</span>:             <span class="comment">// ä½¿ç”¨è€çš„ buffer</span></span><br><span class="line"> <span class="number">21</span>:             buffer = cumulation;</span><br><span class="line"> <span class="number">22</span>:         }</span><br><span class="line"> <span class="number">23</span>:         <span class="comment">// å†™å…¥ in åˆ° buffer ä¸­</span></span><br><span class="line"> <span class="number">24</span>:         buffer.writeBytes(in);</span><br><span class="line"> <span class="number">25</span>:         <span class="comment">// é‡Šæ”¾è¾“å…¥ in</span></span><br><span class="line"> <span class="number">26</span>:         in.release();</span><br><span class="line"> <span class="number">27</span>:         <span class="comment">// è¿”å› buffer</span></span><br><span class="line"> <span class="number">28</span>:         <span class="keyword">return</span> buffer;</span><br><span class="line"> <span class="number">29</span>:     }</span><br><span class="line"> <span class="number">30</span>: </span><br><span class="line"> <span class="number">31</span>: };</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>è·å– <code>buffer</code> å¯¹è±¡ã€‚</p>
<ul>
<li>ç¬¬ 6 è‡³ 9 è¡Œï¼šå¦‚ä¸‹ä¸‰ä¸ªæ¡ä»¶ï¼Œæ»¡è¶³ä»»æ„ï¼Œéœ€è¦è¿›è¡Œæ‰©å®¹ã€‚<ul>
<li>â‘  ç¬¬ 6 è¡Œï¼š<code>cumulation.writerIndex() &gt; cumulation.maxCapacity() - in.readableBytes()</code> ï¼Œè¶…è¿‡ç©ºé—´å¤§å°ï¼Œéœ€è¦æ‰©å®¹ã€‚<ul>
<li>è¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ã€‚</li>
</ul>
</li>
<li>â‘¡ ç¬¬ 7 è¡Œï¼š<code>cumulation.refCnt() &gt; 1</code> ï¼Œå¼•ç”¨å¤§äº 1 ï¼Œè¯´æ˜ç”¨æˆ·ä½¿ç”¨äº† <code>ByteBuf#slice()#retain()</code> æˆ– <code>ByteBuf#duplicate()#retain()</code> æ–¹æ³•ï¼Œä½¿ <code>refCnt</code> å¢åŠ å¹¶ä¸”å¤§äº 1 ã€‚<ul>
<li>å…³äºè¿™å—ï¼Œåœ¨ã€ç¬¬ 11 è¡Œã€‘çš„è‹±æ–‡æ³¨é‡Šï¼Œä¹Ÿç›¸åº”çš„æåˆ°ã€‚</li>
</ul>
</li>
<li>â‘¢ ç¬¬ 9 è¡Œï¼šåªè¯»ï¼Œä¸å¯ç´¯åŠ ï¼Œæ‰€ä»¥éœ€è¦æ”¹æˆå¯å†™ã€‚<ul>
<li>è¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p>ã€éœ€è¦æ‰©å®¹ã€‘ç¬¬ 18 è¡Œï¼šè°ƒç”¨ <code>ByteToMessageDecoder#expandCumulation(ByteBufAllocator alloc, ByteBuf cumulation, int readable)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œæ‰©å®¹ï¼Œå¹¶è¿”å›æ–°çš„ï¼Œå¹¶èµ‹å€¼ç»™ <code>buffer</code> ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> ByteBuf <span class="title">expandCumulation</span><span class="params">(ByteBufAllocator alloc, ByteBuf cumulation, <span class="keyword">int</span> readable)</span> </span>{</span><br><span class="line">    <span class="comment">// è®°å½•è€çš„ ByteBuf å¯¹è±¡</span></span><br><span class="line">    ByteBuf oldCumulation = cumulation;</span><br><span class="line">    <span class="comment">// åˆ†é…æ–°çš„ ByteBuf å¯¹è±¡</span></span><br><span class="line">    cumulation = alloc.buffer(oldCumulation.readableBytes() + readable);</span><br><span class="line">    <span class="comment">// å°†è€çš„æ•°æ®ï¼Œå†™å…¥åˆ°æ–°çš„ ByteBuf å¯¹è±¡</span></span><br><span class="line">    cumulation.writeBytes(oldCumulation);</span><br><span class="line">    <span class="comment">// é‡Šæ”¾è€çš„ ByteBuf å¯¹è±¡</span></span><br><span class="line">    oldCumulation.release();</span><br><span class="line">    <span class="comment">// è¿”å›æ–°çš„ ByteBuf å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> cumulation;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ ‡å‡†çš„æ‰©å®¹ï¼Œå¹¶å¤åˆ¶è€æ•°æ®çš„è¿‡ç¨‹ã€‚èƒ–å‹è‡ªå·±çœ‹ä¸‹æ³¨é‡Šå™¢ã€‚</li>
</ul>
</li>
<li>ã€æ— éœ€æ‰©å®¹ã€‘ç¬¬ 21 è¡Œï¼š<code>buffer</code> ç›´æ¥ä½¿ç”¨çš„ <code>cumulation</code> å¯¹è±¡ã€‚</li>
</ul>
</li>
<li>ç¬¬ 24 è¡Œï¼šå†™å…¥ <code>in</code> åˆ° <code>buffer</code> ä¸­ï¼Œè¿›è¡Œç´¯ç§¯ã€‚<ul>
<li>ç¬¬ 26 è¡Œï¼šé‡Šæ”¾ <code>in</code> ã€‚</li>
</ul>
</li>
<li>ç¬¬ 28 è¡Œï¼šè¿”å› <code>buffer</code> ã€‚ </li>
</ul>
<h2 id="4-2-COMPOSITE-CUMULATOR"><a href="#4-2-COMPOSITE-CUMULATOR" class="headerlink" title="4.2 COMPOSITE_CUMULATOR"></a>4.2 COMPOSITE_CUMULATOR</h2><p><code>COMPOSITE_CUMULATOR</code> æ€è·¯æ˜¯ï¼Œä½¿ç”¨ CompositeByteBuf ï¼Œç»„åˆæ–°è¾“å…¥çš„ ByteBuf å¯¹è±¡ï¼Œä»è€Œé¿å…å†…å­˜æ‹·è´ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ByteToMessageDecoder.java</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Cumulate {<span class="doctag">@link</span> ByteBuf}s by add them to a {<span class="doctag">@link</span> CompositeByteBuf} and so do no memory copy whenever possible.</span></span><br><span class="line"><span class="comment">     * Be aware that {<span class="doctag">@link</span> CompositeByteBuf} use a more complex indexing implementation so depending on your use-case</span></span><br><span class="line"><span class="comment">     * and the decoder implementation this may be slower then just use the {<span class="doctag">@link</span> #MERGE_CUMULATOR}.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * ç›¸æ¯” MERGE_CUMULATOR æ¥è¯´ï¼š</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * å¥½å¤„æ˜¯ï¼Œå†…å­˜é›¶æ‹·è´</span></span><br><span class="line"><span class="comment">     * åå¤„æ˜¯ï¼Œå› ä¸ºç»´æŠ¤å¤æ‚ç´¢å¼•ï¼Œæ‰€ä»¥æŸäº›ä½¿ç”¨åœºæ™¯ä¸‹ï¼Œæ…¢äº MERGE_CUMULATOR</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="number">1</span>: <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Cumulator COMPOSITE_CUMULATOR = <span class="keyword">new</span> Cumulator() {</span><br><span class="line">  <span class="number">2</span>: </span><br><span class="line">  <span class="number">3</span>:     <span class="meta">@Override</span></span><br><span class="line">  <span class="number">4</span>:     <span class="function"><span class="keyword">public</span> ByteBuf <span class="title">cumulate</span><span class="params">(ByteBufAllocator alloc, ByteBuf cumulation, ByteBuf in)</span> </span>{</span><br><span class="line">  <span class="number">5</span>:         ByteBuf buffer;</span><br><span class="line">  <span class="number">6</span>:         <span class="comment">// å’Œ MERGE_CUMULATOR çš„æƒ…å†µç±»ä¼¼</span></span><br><span class="line">  <span class="number">7</span>:         <span class="keyword">if</span> (cumulation.refCnt() &gt; <span class="number">1</span>) {</span><br><span class="line">  <span class="number">8</span>:             <span class="comment">// Expand cumulation (by replace it) when the refCnt is greater then 1 which may happen when the user</span></span><br><span class="line">  <span class="number">9</span>:             <span class="comment">// use slice().retain() or duplicate().retain().</span></span><br><span class="line"> <span class="number">10</span>:             <span class="comment">//</span></span><br><span class="line"> <span class="number">11</span>:             <span class="comment">// See:</span></span><br><span class="line"> <span class="number">12</span>:             <span class="comment">// - https://github.com/netty/netty/issues/2327</span></span><br><span class="line"> <span class="number">13</span>:             <span class="comment">// - https://github.com/netty/netty/issues/1764</span></span><br><span class="line"> <span class="number">14</span>:             buffer = expandCumulation(alloc, cumulation, in.readableBytes());</span><br><span class="line"> <span class="number">15</span>:             buffer.writeBytes(in);</span><br><span class="line"> <span class="number">16</span>:             in.release();</span><br><span class="line"> <span class="number">17</span>:         } <span class="keyword">else</span> {</span><br><span class="line"> <span class="number">18</span>:             CompositeByteBuf composite;</span><br><span class="line"> <span class="number">19</span>:             <span class="comment">// åŸæ¥æ˜¯ CompositeByteBuf ç±»å‹ï¼Œç›´æ¥ä½¿ç”¨</span></span><br><span class="line"> <span class="number">20</span>:             <span class="keyword">if</span> (cumulation <span class="keyword">instanceof</span> CompositeByteBuf) {</span><br><span class="line"> <span class="number">21</span>:                 composite = (CompositeByteBuf) cumulation;</span><br><span class="line"> <span class="number">22</span>:             <span class="comment">// åŸæ¥ä¸æ˜¯ CompositeByteBuf ç±»å‹ï¼Œåˆ›å»ºï¼Œå¹¶æ·»åŠ åˆ°å…¶ä¸­</span></span><br><span class="line"> <span class="number">23</span>:             } <span class="keyword">else</span> {</span><br><span class="line"> <span class="number">24</span>:                 composite = alloc.compositeBuffer(Integer.MAX_VALUE);</span><br><span class="line"> <span class="number">25</span>:                 composite.addComponent(<span class="keyword">true</span>, cumulation);</span><br><span class="line"> <span class="number">26</span>:             }</span><br><span class="line"> <span class="number">27</span>:             <span class="comment">// æ·»åŠ  in åˆ° composite ä¸­</span></span><br><span class="line"> <span class="number">28</span>:             composite.addComponent(<span class="keyword">true</span>, in);</span><br><span class="line"> <span class="number">29</span>:             <span class="comment">// èµ‹å€¼ç»™ buffer</span></span><br><span class="line"> <span class="number">30</span>:             buffer = composite;</span><br><span class="line"> <span class="number">31</span>:         }</span><br><span class="line"> <span class="number">32</span>:         <span class="comment">// è¿”å› buffer</span></span><br><span class="line"> <span class="number">33</span>:         <span class="keyword">return</span> buffer;</span><br><span class="line"> <span class="number">34</span>:     }</span><br><span class="line"> <span class="number">35</span>: </span><br><span class="line"> <span class="number">36</span>: };</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 7 è‡³ 16 è¡Œï¼š<code>cumulation.refCnt() &gt; 1</code> æˆç«‹ï¼Œå’Œ <code>MERGE_CUMULATOR</code> çš„æƒ…å†µä¸€è‡´ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ ByteBuf å¯¹è±¡ã€‚è¿™æ ·ï¼Œå†ä¸‹ä¸€æ¬¡ <code>#cumulate(...)</code> æ—¶ï¼Œå°±ä¼šèµ°ã€ç¬¬ 22 è‡³ 26 è¡Œã€‘çš„æƒ…å†µã€‚</li>
<li>è·å¾— <code>composite</code> å¯¹è±¡<ul>
<li>ç¬¬ 19 è‡³ 21 è¡Œï¼šå¦‚æœåŸæ¥<strong>å°±æ˜¯</strong> CompositeByteBuf ç±»å‹ï¼Œç›´æ¥ä½¿ç”¨ã€‚</li>
<li>ç¬¬ 22 è‡³ 26 è¡Œï¼šå¦‚æœåŸæ¥<strong>ä¸æ˜¯</strong> CompositeByteBuf ç±»å‹ï¼Œåˆ›å»º CompositeByteBuf å¯¹è±¡ï¼Œå¹¶æ·»åŠ  <code>cumulation</code> åˆ°å…¶ä¸­ã€‚</li>
</ul>
</li>
<li>ç¬¬ 28 è¡Œï¼šæ·»åŠ  <code>in</code> åˆ° <code>composite</code> ä¸­ï¼Œé¿å…å†…å­˜æ‹·è´ã€‚</li>
</ul>
<h2 id="4-3-å¯¹æ¯”"><a href="#4-3-å¯¹æ¯”" class="headerlink" title="4.3 å¯¹æ¯”"></a>4.3 å¯¹æ¯”</h2><p>å…³äº <code>MERGE_CUMULATOR</code> å’Œ <code>COMPOSITE_CUMULATOR</code> çš„å¯¹æ¯”ï¼Œå·²ç»å†™åœ¨ <code>COMPOSITE_CUMULATOR</code> çš„<strong>å¤´ä¸Š</strong>çš„æ³¨é‡Šã€‚</p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒByteToMessageDecoder ä½¿ç”¨ <code>MERGE_CUMULATOR</code> ä½œä¸ºç´¯åŠ å™¨ã€‚</p>
<h1 id="5-ByteToMessageDecoder"><a href="#5-ByteToMessageDecoder" class="headerlink" title="5. ByteToMessageDecoder"></a>5. ByteToMessageDecoder</h1><p><code>io.netty.handler.codec.ByteToMessageDecoder</code> ï¼Œç»§æ‰¿ ChannelInboundHandlerAdapter ç±»ï¼Œ<strong>æŠ½è±¡åŸºç±»</strong>ï¼Œè´Ÿè´£å°† Byte è§£ç æˆ Message ã€‚</p>
<blockquote>
<p>è€è‰¿è‰¿ï¼šByteToMessageDecoder çš„ç»†èŠ‚æ¯”è¾ƒå¤šï¼Œå»ºè®®èƒ–å‹ç†è§£å¦‚ä¸‹å°èŠ‚å³å¯ï¼š</p>
<ul>
<li><a href="#">5.1 æ„é€ æ–¹æ³•</a></li>
<li><a href="#">5.2 channelRead</a></li>
<li><a href="#">5.3 callDecode</a></li>
<li><a href="#">5.4 channelReadComplete</a></li>
</ul>
</blockquote>
<h2 id="5-1-æ„é€ æ–¹æ³•"><a href="#5-1-æ„é€ æ–¹æ³•" class="headerlink" title="5.1 æ„é€ æ–¹æ³•"></a>5.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> STATE_INIT = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> STATE_CALLING_CHILD_DECODE = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> STATE_HANDLER_REMOVED_PENDING = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å·²ç´¯ç§¯çš„ ByteBuf å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ByteBuf cumulation;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç´¯è®¡å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Cumulator cumulator = MERGE_CUMULATOR;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦æ¯æ¬¡åªè§£ç ä¸€æ¡æ¶ˆæ¯ï¼Œé»˜è®¤ä¸º false ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * éƒ¨åˆ†è§£ç å™¨ä¸º true ï¼Œä¾‹å¦‚ï¼šSocks4ClientDecoder</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #callDecode(ChannelHandlerContext, ByteBuf, List)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> singleDecode;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦è§£ç åˆ°æ¶ˆæ¯ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * WasNull ï¼Œè¯´æ˜å°±æ˜¯æ²¡è§£ç åˆ°æ¶ˆæ¯</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #channelReadComplete(ChannelHandlerContext)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> decodeWasNull;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦é¦–æ¬¡è¯»å–ï¼Œå³ {<span class="doctag">@link</span> #cumulation} ä¸ºç©º</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> first;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A bitmask where the bits are defined as</span></span><br><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;li&gt;{<span class="doctag">@link</span> #STATE_INIT}&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;li&gt;{<span class="doctag">@link</span> #STATE_CALLING_CHILD_DECODE}&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> *     &lt;li&gt;{<span class="doctag">@link</span> #STATE_HANDLER_REMOVED_PENDING}&lt;/li&gt;</span></span><br><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è§£ç çŠ¶æ€</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 0 - åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"> * 1 - è°ƒç”¨ {<span class="doctag">@link</span> #decode(ChannelHandlerContext, ByteBuf, List)} æ–¹æ³•ä¸­ï¼Œæ­£åœ¨è¿›è¡Œè§£ç </span></span><br><span class="line"><span class="comment"> * 2 - å‡†å¤‡ç§»é™¤</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span> decodeState = STATE_INIT;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¯»å–é‡Šæ”¾é˜€å€¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> discardAfterReads = <span class="number">16</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å·²è¯»å–æ¬¡æ•°ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å†è¯»å– {<span class="doctag">@link</span> #discardAfterReads} æ¬¡æ•°æ®åï¼Œå¦‚æœæ— æ³•å…¨éƒ¨è§£ç å®Œï¼Œåˆ™è¿›è¡Œé‡Šæ”¾ï¼Œé¿å… OOM</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> numReads;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">ByteToMessageDecoder</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// æ ¡éªŒï¼Œä¸å¯å…±äº«</span></span><br><span class="line">    ensureNotSharable();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>å±æ€§æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚</p>
<h2 id="5-2-channelRead"><a href="#5-2-channelRead" class="headerlink" title="5.2 channelRead"></a>5.2 channelRead</h2><p><code>#channelRead(ChannelHandlerContext ctx, Object msg)</code> æ–¹æ³•ï¼Œè¯»å–åˆ°æ–°çš„æ•°æ®ï¼Œè¿›è¡Œè§£ç ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> ByteBuf) {</span><br><span class="line"> <span class="number">4</span>:         <span class="comment">// åˆ›å»º CodecOutputList å¯¹è±¡</span></span><br><span class="line"> <span class="number">5</span>:         CodecOutputList out = CodecOutputList.newInstance();</span><br><span class="line"> <span class="number">6</span>:         <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">7</span>:             ByteBuf data = (ByteBuf) msg;</span><br><span class="line"> <span class="number">8</span>:             <span class="comment">// åˆ¤æ–­æ˜¯å¦é¦–æ¬¡</span></span><br><span class="line"> <span class="number">9</span>:             first = cumulation == <span class="keyword">null</span>;</span><br><span class="line"><span class="number">10</span>:             <span class="comment">// è‹¥é¦–æ¬¡ï¼Œç›´æ¥ä½¿ç”¨è¯»å–çš„ data</span></span><br><span class="line"><span class="number">11</span>:             <span class="keyword">if</span> (first) {</span><br><span class="line"><span class="number">12</span>:                 cumulation = data;</span><br><span class="line"><span class="number">13</span>:             <span class="comment">// è‹¥éé¦–æ¬¡ï¼Œå°†è¯»å–çš„ data ï¼Œç´¯ç§¯åˆ° cumulation ä¸­</span></span><br><span class="line"><span class="number">14</span>:             } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">15</span>:                 cumulation = cumulator.cumulate(ctx.alloc(), cumulation, data);</span><br><span class="line"><span class="number">16</span>:             }</span><br><span class="line"><span class="number">17</span>:             <span class="comment">// æ‰§è¡Œè§£ç </span></span><br><span class="line"><span class="number">18</span>:             callDecode(ctx, cumulation, out);</span><br><span class="line"><span class="number">19</span>:         } <span class="keyword">catch</span> (DecoderException e) {</span><br><span class="line"><span class="number">20</span>:             <span class="keyword">throw</span> e; <span class="comment">// æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="number">21</span>:         } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line"><span class="number">22</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> DecoderException(e); <span class="comment">// å°è£…æˆ DecoderException å¼‚å¸¸ï¼ŒæŠ›å‡º</span></span><br><span class="line"><span class="number">23</span>:         } <span class="keyword">finally</span> {</span><br><span class="line"><span class="number">24</span>:             <span class="comment">// cumulation ä¸­æ‰€æœ‰æ•°æ®è¢«è¯»å–å®Œï¼Œç›´æ¥é‡Šæ”¾å…¨éƒ¨</span></span><br><span class="line"><span class="number">25</span>:             <span class="keyword">if</span> (cumulation != <span class="keyword">null</span> &amp;&amp; !cumulation.isReadable()) {</span><br><span class="line"><span class="number">26</span>:                 numReads = <span class="number">0</span>; <span class="comment">// é‡ç½® numReads æ¬¡æ•°</span></span><br><span class="line"><span class="number">27</span>:                 cumulation.release(); <span class="comment">// é‡Šæ”¾ cumulation</span></span><br><span class="line"><span class="number">28</span>:                 cumulation = <span class="keyword">null</span>; <span class="comment">// ç½®ç©º cumulation</span></span><br><span class="line"><span class="number">29</span>:             <span class="comment">// è¯»å–æ¬¡æ•°åˆ°è¾¾ discardAfterReads ä¸Šé™ï¼Œé‡Šæ”¾éƒ¨åˆ†çš„å·²è¯»</span></span><br><span class="line"><span class="number">30</span>:             } <span class="keyword">else</span> <span class="keyword">if</span> (++ numReads &gt;= discardAfterReads) {</span><br><span class="line"><span class="number">31</span>:                 <span class="comment">// We did enough reads already try to discard some bytes so we not risk to see a OOME.</span></span><br><span class="line"><span class="number">32</span>:                 <span class="comment">// See https://github.com/netty/netty/issues/4275</span></span><br><span class="line"><span class="number">33</span>:                 numReads = <span class="number">0</span>; <span class="comment">// é‡ç½® numReads æ¬¡æ•°</span></span><br><span class="line"><span class="number">34</span>:                 discardSomeReadBytes(); <span class="comment">// é‡Šæ”¾éƒ¨åˆ†çš„å·²è¯»</span></span><br><span class="line"><span class="number">35</span>:             }</span><br><span class="line"><span class="number">36</span>: </span><br><span class="line"><span class="number">37</span>:             <span class="comment">// è§£ç æ¶ˆæ¯çš„æ•°é‡</span></span><br><span class="line"><span class="number">38</span>:             <span class="keyword">int</span> size = out.size();</span><br><span class="line"><span class="number">39</span>:             <span class="comment">// æ˜¯å¦è§£ç åˆ°æ¶ˆæ¯</span></span><br><span class="line"><span class="number">40</span>:             decodeWasNull = !out.insertSinceRecycled();</span><br><span class="line"><span class="number">41</span>: </span><br><span class="line"><span class="number">42</span>:             <span class="comment">// è§¦å‘ Channel Read äº‹ä»¶ã€‚å¯èƒ½æ˜¯å¤šæ¡æ¶ˆæ¯</span></span><br><span class="line"><span class="number">43</span>:             fireChannelRead(ctx, out, size);</span><br><span class="line"><span class="number">44</span>: </span><br><span class="line"><span class="number">45</span>:             <span class="comment">// å›æ”¶ CodecOutputList å¯¹è±¡</span></span><br><span class="line"><span class="number">46</span>:             out.recycle();</span><br><span class="line"><span class="number">47</span>:         }</span><br><span class="line"><span class="number">48</span>:     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">49</span>:         <span class="comment">// è§¦å‘ Channel Read äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="number">50</span>:         ctx.fireChannelRead(msg);</span><br><span class="line"><span class="number">51</span>:     }</span><br><span class="line"><span class="number">52</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 48 è‡³ 51 è¡Œï¼šæ¶ˆæ¯çš„ç±»å‹<strong>ä¸æ˜¯</strong> ByteBuf ç±»ï¼Œç›´æ¥è§¦å‘ Channel Read äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ä¹Ÿå°±è¯´ï¼Œä¸è¿›è¡Œè§£ç ã€‚</li>
<li>ç¬¬ 3 è¡Œï¼šæ¶ˆæ¯çš„ç±»å‹<strong>æ˜¯</strong> ByteBuf ç±»ï¼Œå¼€å§‹è§£ç ã€‚</li>
<li><p>ç¬¬ 5 è¡Œï¼šåˆ›å»º CodecOutputList å¯¹è±¡ã€‚CodecOutputList çš„ç®€åŒ–ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Special {<span class="doctag">@link</span> AbstractList} implementation which is used within our codec base classes.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CodecOutputList</span> <span class="keyword">extends</span> <span class="title">AbstractList</span>&lt;<span class="title">Object</span>&gt; <span class="keyword">implements</span> <span class="title">RandomAccess</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... çœç•¥ä»£ç </span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>å¦‚ä¸‹å†…å®¹ï¼Œå¼•ç”¨è‡ª <a href="https://www.jianshu.com/p/7c439cc7b01c" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆå…«ï¼‰â€“CodecHandlerã€‹</a></p>
<blockquote>
<p>è§£ç ç»“æœåˆ—è¡¨ CodecOutputList æ˜¯ Netty å®šåˆ¶çš„ä¸€ä¸ªç‰¹æ®Šåˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨åœ¨çº¿ç¨‹ä¸­è¢«ç¼“å­˜ï¼Œå¯å¾ªç¯ä½¿ç”¨æ¥å­˜å‚¨è§£ç ç»“æœï¼Œå‡å°‘ä¸å¿…è¦çš„åˆ—è¡¨å®ä¾‹åˆ›å»ºï¼Œä»è€Œæå‡æ€§èƒ½ã€‚ç”±äºè§£ç ç»“æœéœ€è¦é¢‘ç¹å­˜å‚¨ï¼Œæ™®é€šçš„ ArrayList éš¾ä»¥æ»¡è¶³è¯¥éœ€æ±‚ï¼Œæ•…å®šåˆ¶åŒ–äº†ä¸€ä¸ªç‰¹æ®Šåˆ—è¡¨ï¼Œç”±æ­¤å¯è§ Netty å¯¹ä¼˜åŒ–çš„æè‡´è¿½æ±‚ã€‚</p>
</blockquote>
</li>
</ul>
<ul>
<li>ç¬¬ 7 è‡³ 9 è¡Œï¼šé€šè¿‡ <code>cumulation</code> æ˜¯å¦ä¸º <code>null</code> æ¥åˆ¤æ–­ï¼Œæ˜¯å¦ä¸ºé¦–æ¬¡ <code>first</code> ã€‚<ul>
<li>è‹¥<strong>æ˜¯</strong>é¦–æ¬¡ï¼Œç›´æ¥ä½¿ç”¨è¯»å–çš„ <code>data</code> ( <code>ByteBuf data = (ByteBuf) msg</code> )ã€‚</li>
<li>è‹¥<strong>é</strong>é¦–æ¬¡ï¼Œå°†è¯»å–çš„ <code>data</code> ï¼Œç´¯ç§¯åˆ° <code>cumulation</code> ä¸­ã€‚åœ¨ <a href="#">ã€Œ4. Cumulatorã€</a> ä¸­ï¼Œæˆ‘ä»¬å·²ç»è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p>ç¬¬ 18 è¡Œï¼šè°ƒç”¨ <code>#callDecode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code> æ–¹æ³•ï¼Œæ‰§è¡Œè§£ç ã€‚è€Œè§£ç çš„ç»“æœï¼Œä¼šæ·»åŠ åˆ° <code>out</code> æ•°ç»„ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5.3 callDecodeã€</a> ã€‚</p>
</li>
<li>ç¬¬ 19 è‡³ 22 è¡Œï¼šè‹¥å‘ç”Ÿå¼‚å¸¸ï¼ŒæŠ›å‡º DecoderException å¼‚å¸¸ã€‚</li>
<li><p>ç¬¬ 24 è‡³ 35 è¡Œï¼šæ ¹æ® <code>cumulation</code> çš„æƒ…å†µï¼Œé‡Šæ”¾ <code>cumulation</code> ã€‚</p>
<ul>
<li>ç¬¬ 24 è‡³ 28 è¡Œï¼š<code>cumulation</code> ä¸­æ‰€æœ‰æ•°æ®è¢«è¯»å–å®Œï¼Œç›´æ¥<strong>é‡Šæ”¾å…¨éƒ¨</strong>ã€‚</li>
<li><p>ç¬¬ 29 è‡³ 35 è¡Œï¼šè¯»å–æ¬¡æ•°( <code>numReads</code> )åˆ°è¾¾ <code>discardAfterReads</code> ä¸Šé™ï¼Œé‡ç½®è®¡æ•°ï¼Œå¹¶è°ƒç”¨ <code>#discardSomeReadBytes()</code> æ–¹æ³•ï¼Œé‡Šæ”¾éƒ¨åˆ†çš„å·²è¯»ã€‚ğŸ˜ˆ å¦‚æœä¸€ç›´ä¸å»é‡Šæ”¾ï¼Œç­‰åˆ°æ»¡è¶³ã€ç¬¬ 24 è‡³ 28 è¡Œã€‘çš„æ¡ä»¶ï¼Œå¾ˆæœ‰å¯èƒ½ä¼šå‡ºç° OOM çš„æƒ…å†µã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">discardSomeReadBytes</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (cumulation != <span class="keyword">null</span> &amp;&amp; !first</span><br><span class="line">            &amp;&amp; cumulation.refCnt() == <span class="number">1</span>) { <span class="comment">// &lt;1&gt; å¦‚æœç”¨æˆ·ä½¿ç”¨äº† slice().retain() å’Œ duplicate().retain() ä½¿ refCnt &gt; 1 ï¼Œè¡¨æ˜è¯¥ç´¯ç§¯åŒºè¿˜åœ¨è¢«ç”¨æˆ·ä½¿ç”¨ï¼Œä¸¢å¼ƒæ•°æ®å¯èƒ½å¯¼è‡´ç”¨æˆ·çš„å›°æƒ‘ï¼Œæ‰€ä»¥é¡»ç¡®å®šç”¨æˆ·ä¸å†ä½¿ç”¨è¯¥ç´¯ç§¯åŒºçš„å·²è¯»æ•°æ®ï¼Œæ­¤æ—¶æ‰ä¸¢å¼ƒã€‚</span></span><br><span class="line">        <span class="comment">// discard some bytes if possible to make more room in the</span></span><br><span class="line">        <span class="comment">// buffer but only if the refCnt == 1  as otherwise the user may have</span></span><br><span class="line">        <span class="comment">// used slice().retain() or duplicate().retain().</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// See:</span></span><br><span class="line">        <span class="comment">// - https://github.com/netty/netty/issues/2327</span></span><br><span class="line">        <span class="comment">// - https://github.com/netty/netty/issues/1764</span></span><br><span class="line">        <span class="comment">// &lt;2&gt; é‡Šæ”¾éƒ¨åˆ†</span></span><br><span class="line">        cumulation.discardSomeReadBytes();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼ŒåŸå› è§ä¸­æ–‡æ³¨é‡Šã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œé‡Šæ”¾<strong>éƒ¨åˆ†</strong>å·²è¯»å­—èŠ‚åŒºã€‚æ³¨æ„ï¼Œæ˜¯â€œéƒ¨åˆ†â€ï¼Œè€Œä¸æ˜¯â€œå…¨éƒ¨â€ï¼Œé¿å…ä¸€æ¬¡æ€§é‡Šæ”¾å…¨éƒ¨ï¼Œæ—¶é—´è¿‡é•¿ã€‚å¹¶ä¸”ï¼Œèƒ½å¤Ÿè¯»å–åˆ°è¿™ä¹ˆâ€œå¤§â€ï¼Œå¾€å¾€å­—èŠ‚æ•°å®¹é‡ä¸å°ã€‚å¦‚æœç›´æ¥é‡Šæ”¾æ‰â€œå…¨éƒ¨â€ï¼Œé‚£ä¹ˆåç»­è¿˜éœ€è¦å†é‡å¤æ‰©å®¹ï¼Œåå€’ä¸å¥½ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 38 è¡Œï¼šè·å¾—è§£ç æ¶ˆæ¯çš„æ•°é‡ã€‚<ul>
<li>ç¬¬ 40 è¡Œï¼šæ˜¯å¦è§£ç åˆ°æ¶ˆæ¯ã€‚ä¸ºä»€ä¹ˆä¸ç›´æ¥ä½¿ç”¨ <code>size</code> æ¥åˆ¤æ–­å‘¢ï¼Ÿå› ä¸ºå¦‚æœæ·»åŠ äº†æ¶ˆæ¯ï¼Œç„¶ååˆç§»é™¤è¯¥æ¶ˆæ¯ï¼Œæ­¤æ—¶ <code>size</code> ä¸º 0 ï¼Œä½†æ˜¯ <code>!out.insertSinceRecycled()</code> ä¸º <code>true</code> ã€‚<ul>
<li>å¦å¤–ï¼Œæˆ‘ä»¬åœ¨ <a href="#">ã€Œ5.3 callDecodeã€</a> ä¸­ï¼Œå°†ä¼šçœ‹åˆ°ä¸€ä¸ª <code>out</code> çš„æ¸…ç†æ“ä½œï¼Œåˆ°æ—¶ä¼šæ›´åŠ æ˜ç™½ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p>ç¬¬ 43 è¡Œï¼šè°ƒç”¨ <code>#fireChannelRead(ChannelHandlerContext ctx, List&lt;Object&gt; msgs, int numElements)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œè§¦å‘ Channel Read äº‹ä»¶ã€‚å¯èƒ½æ˜¯å¤šæ¡æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get {<span class="doctag">@code</span> numElements} out of the {<span class="doctag">@link</span> List} and forward these through the pipeline.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fireChannelRead</span><span class="params">(ChannelHandlerContext ctx, List&lt;Object&gt; msgs, <span class="keyword">int</span> numElements)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (msgs <span class="keyword">instanceof</span> CodecOutputList) { <span class="comment">// å¦‚æœæ˜¯ CodecOutputList ç±»å‹ï¼Œç‰¹æ®Šä¼˜åŒ–</span></span><br><span class="line">        fireChannelRead(ctx, (CodecOutputList) msgs, numElements);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numElements; i++) {</span><br><span class="line">            ctx.fireChannelRead(msgs.get(i));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get {<span class="doctag">@code</span> numElements} out of the {<span class="doctag">@link</span> CodecOutputList} and forward these through the pipeline.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fireChannelRead</span><span class="params">(ChannelHandlerContext ctx, CodecOutputList msgs, <span class="keyword">int</span> numElements)</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numElements; i ++) {</span><br><span class="line">        ctx.fireChannelRead(msgs.getUnsafe(i)); <span class="comment">// getUnsafe æ˜¯è‡ªå®šä¹‰çš„æ–¹æ³•ï¼Œå‡å°‘è¶Šç•Œåˆ¤æ–­ï¼Œæ•ˆç‡æ›´é«˜</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>éå† <code>msgs</code> æ•°ç»„ï¼Œæ¯æ¡æ¶ˆæ¯è§¦å‘ä¸€æ¬¡ Channel Read äº‹ä»¶ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 46 è¡Œï¼šå›æ”¶ CodecOutputList å¯¹è±¡ã€‚</p>
</li>
</ul>
<h2 id="5-3-callDecode"><a href="#5-3-callDecode" class="headerlink" title="5.3 callDecode"></a>5.3 callDecode</h2><p><code>#callDecode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code> æ–¹æ³•ï¼Œæ‰§è¡Œè§£ç ã€‚è€Œè§£ç çš„ç»“æœï¼Œä¼šæ·»åŠ åˆ° <code>out</code> æ•°ç»„ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">callDecode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">3</span>:         <span class="comment">// å¾ªç¯è¯»å–ï¼Œç›´åˆ°ä¸å¯è¯»</span></span><br><span class="line"> <span class="number">4</span>:         <span class="keyword">while</span> (in.isReadable()) {</span><br><span class="line"> <span class="number">5</span>:             <span class="comment">// è®°å½•</span></span><br><span class="line"> <span class="number">6</span>:             <span class="keyword">int</span> outSize = out.size();</span><br><span class="line"> <span class="number">7</span>:             <span class="comment">// out éç©ºï¼Œè¯´æ˜ä¸Šä¸€æ¬¡è§£ç æœ‰è§£ç åˆ°æ¶ˆæ¯</span></span><br><span class="line"> <span class="number">8</span>:             <span class="keyword">if</span> (outSize &gt; <span class="number">0</span>) {</span><br><span class="line"> <span class="number">9</span>:                 <span class="comment">// è§¦å‘ Channel Read äº‹ä»¶ã€‚å¯èƒ½æ˜¯å¤šæ¡æ¶ˆæ¯</span></span><br><span class="line"><span class="number">10</span>:                 fireChannelRead(ctx, out, outSize);</span><br><span class="line"><span class="number">11</span>:                 <span class="comment">// æ¸…ç©º</span></span><br><span class="line"><span class="number">12</span>:                 out.clear();</span><br><span class="line"><span class="number">13</span>: </span><br><span class="line"><span class="number">14</span>:                 <span class="comment">// ç”¨æˆ·ä¸»åŠ¨åˆ é™¤è¯¥ Handler ï¼Œç»§ç»­æ“ä½œ in æ˜¯ä¸å®‰å…¨çš„</span></span><br><span class="line"><span class="number">15</span>:                 <span class="comment">// Check if this handler was removed before continuing with decoding.</span></span><br><span class="line"><span class="number">16</span>:                 <span class="comment">// If it was removed, it is not safe to continue to operate on the buffer.</span></span><br><span class="line"><span class="number">17</span>:                 <span class="comment">//</span></span><br><span class="line"><span class="number">18</span>:                 <span class="comment">// See:</span></span><br><span class="line"><span class="number">19</span>:                 <span class="comment">// - https://github.com/netty/netty/issues/4635</span></span><br><span class="line"><span class="number">20</span>:                 <span class="keyword">if</span> (ctx.isRemoved()) {</span><br><span class="line"><span class="number">21</span>:                     <span class="keyword">break</span>;</span><br><span class="line"><span class="number">22</span>:                 }</span><br><span class="line"><span class="number">23</span>:                 outSize = <span class="number">0</span>;</span><br><span class="line"><span class="number">24</span>:             }</span><br><span class="line"><span class="number">25</span>: </span><br><span class="line"><span class="number">26</span>:             <span class="comment">// è®°å½•å½“å‰å¯è¯»å­—èŠ‚æ•°</span></span><br><span class="line"><span class="number">27</span>:             <span class="keyword">int</span> oldInputLength = in.readableBytes();</span><br><span class="line"><span class="number">28</span>: </span><br><span class="line"><span class="number">29</span>:             <span class="comment">// æ‰§è¡Œè§£ç ã€‚å¦‚æœ Handler å‡†å¤‡ç§»é™¤ï¼Œåœ¨è§£ç å®Œæˆåï¼Œè¿›è¡Œç§»é™¤ã€‚</span></span><br><span class="line"><span class="number">30</span>:             decodeRemovalReentryProtection(ctx, in, out);</span><br><span class="line"><span class="number">31</span>: </span><br><span class="line"><span class="number">32</span>:             <span class="comment">// ç”¨æˆ·ä¸»åŠ¨åˆ é™¤è¯¥ Handler ï¼Œç»§ç»­æ“ä½œ in æ˜¯ä¸å®‰å…¨çš„</span></span><br><span class="line"><span class="number">33</span>:             <span class="comment">// Check if this handler was removed before continuing the loop.</span></span><br><span class="line"><span class="number">34</span>:             <span class="comment">// If it was removed, it is not safe to continue to operate on the buffer.</span></span><br><span class="line"><span class="number">35</span>:             <span class="comment">//</span></span><br><span class="line"><span class="number">36</span>:             <span class="comment">// See https://github.com/netty/netty/issues/1664</span></span><br><span class="line"><span class="number">37</span>:             <span class="keyword">if</span> (ctx.isRemoved()) {</span><br><span class="line"><span class="number">38</span>:                 <span class="keyword">break</span>;</span><br><span class="line"><span class="number">39</span>:             }</span><br><span class="line"><span class="number">40</span>: </span><br><span class="line"><span class="number">41</span>:             <span class="comment">// æ•´åˆ—åˆ¤æ–­ `out.size() == 0` æ¯”è¾ƒåˆé€‚ã€‚å› ä¸ºï¼Œå¦‚æœ `outSize &gt; 0` é‚£æ®µï¼Œå·²ç»æ¸…ç†äº† out ã€‚</span></span><br><span class="line"><span class="number">42</span>:             <span class="keyword">if</span> (outSize == out.size()) {</span><br><span class="line"><span class="number">43</span>:                 <span class="comment">// å¦‚æœæœªè¯»å–ä»»ä½•å­—èŠ‚ï¼Œç»“æŸå¾ªç¯</span></span><br><span class="line"><span class="number">44</span>:                 <span class="keyword">if</span> (oldInputLength == in.readableBytes()) {</span><br><span class="line"><span class="number">45</span>:                     <span class="keyword">break</span>;</span><br><span class="line"><span class="number">46</span>:                 <span class="comment">// å¦‚æœå¯è¯»å­—èŠ‚å‘ç”Ÿå˜åŒ–ï¼Œç»§ç»­è¯»å–</span></span><br><span class="line"><span class="number">47</span>:                 } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">48</span>:                     <span class="keyword">continue</span>;</span><br><span class="line"><span class="number">49</span>:                 }</span><br><span class="line"><span class="number">50</span>:             }</span><br><span class="line"><span class="number">51</span>: </span><br><span class="line"><span class="number">52</span>:             <span class="comment">// å¦‚æœè§£ç äº†æ¶ˆæ¯ï¼Œä½†æ˜¯å¯è¯»å­—èŠ‚æ•°æœªå˜ï¼ŒæŠ›å‡º DecoderException å¼‚å¸¸ã€‚è¯´æ˜ï¼Œæœ‰é—®é¢˜ã€‚</span></span><br><span class="line"><span class="number">53</span>:             <span class="keyword">if</span> (oldInputLength == in.readableBytes()) {</span><br><span class="line"><span class="number">54</span>:                 <span class="keyword">throw</span> <span class="keyword">new</span> DecoderException(StringUtil.simpleClassName(getClass()) + <span class="string">".decode() did not read anything but decoded a message."</span>);</span><br><span class="line"><span class="number">55</span>:             }</span><br><span class="line"><span class="number">56</span>: </span><br><span class="line"><span class="number">57</span>:             <span class="comment">// å¦‚æœå¼€å¯ singleDecode ï¼Œè¡¨ç¤ºåªè§£æä¸€æ¬¡ï¼Œç»“æŸå¾ªç¯</span></span><br><span class="line"><span class="number">58</span>:             <span class="keyword">if</span> (isSingleDecode()) {</span><br><span class="line"><span class="number">59</span>:                 <span class="keyword">break</span>;</span><br><span class="line"><span class="number">60</span>:             }</span><br><span class="line"><span class="number">61</span>:         }</span><br><span class="line"><span class="number">62</span>:     } <span class="keyword">catch</span> (DecoderException e) {</span><br><span class="line"><span class="number">63</span>:         <span class="keyword">throw</span> e;</span><br><span class="line"><span class="number">64</span>:     } <span class="keyword">catch</span> (Exception cause) {</span><br><span class="line"><span class="number">65</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> DecoderException(cause);</span><br><span class="line"><span class="number">66</span>:     }</span><br><span class="line"><span class="number">67</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 4 è¡Œï¼šå¾ªç¯è¯»å– <code>in</code> ï¼Œç›´åˆ°ä¸å¯è¯»ã€‚</li>
<li>ç¬¬ 5 è¡Œï¼šè®°å½• <code>out</code> çš„å¤§å°ã€‚<ul>
<li>ç¬¬ 8 è¡Œï¼šå¦‚æœ <code>out</code> éç©ºï¼Œè¯´æ˜ä¸Šä¸€æ¬¡è§£ç æœ‰è§£ç åˆ°æ¶ˆæ¯ã€‚</li>
<li>ç¬¬ 10 è¡Œï¼šè°ƒç”¨ <code>#fireChannelRead(ChannelHandlerContext ctx, List&lt;Object&gt; msgs, int numElements)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œè§¦å‘ Channel Read äº‹ä»¶ã€‚å¯èƒ½æ˜¯å¤šæ¡æ¶ˆæ¯ã€‚ğŸ˜ˆ å…³äºè¯¥æ–¹æ³•ï¼Œä¸Šæ–‡å·²ç»è¯¦ç»†è§£æã€‚</li>
<li>ç¬¬ 12 è¡Œï¼šæ¸…ç©º <code>out</code> ã€‚æ‰€ä»¥ï¼Œæœ‰å¯èƒ½ä¼šå‡ºç° <code>#channelRead(ChannelHandlerContext ctx, Object msg)</code> æ–¹æ³•çš„ã€ç¬¬ 40 è¡Œã€‘çš„æƒ…å†µã€‚</li>
<li>ç¬¬ 14 è‡³ 22 è¡Œï¼šç”¨æˆ·ä¸»åŠ¨åˆ é™¤è¯¥ Handler ï¼Œç»§ç»­æ“ä½œ <code>in</code> æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥ç»“æŸå¾ªç¯ã€‚</li>
<li>ç¬¬ 23 è¡Œï¼šè®°å½• <code>out</code> çš„å¤§å°ä¸º<strong>é›¶</strong>ã€‚æ‰€ä»¥ï¼Œå®é™…ä¸Šï¼Œ<code>outSize</code> æ²¡æœ‰å¿…è¦è®°å½•ã€‚å› ä¸ºï¼Œä¸€å®šæ˜¯ä¸º<strong>é›¶</strong>ã€‚</li>
</ul>
</li>
<li>ç¬¬ 27 è¡Œï¼šè®°å½•å½“å‰å¯è¯»å­—èŠ‚æ•°ã€‚</li>
<li>ç¬¬ 30 è¡Œï¼šè°ƒç”¨ <code>#decodeRemovalReentryProtection(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code> æ–¹æ³•ï¼Œæ‰§è¡Œè§£ç ã€‚å¦‚æœ Handler å‡†å¤‡ç§»é™¤ï¼Œåœ¨è§£ç å®Œæˆåï¼Œè¿›è¡Œç§»é™¤ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5.3.1 decodeRemovalReentryProtectionã€</a> ä¸­ã€‚</li>
<li>ç¬¬ 32 è‡³ 39 è¡Œï¼šç”¨æˆ·ä¸»åŠ¨åˆ é™¤è¯¥ Handler ï¼Œç»§ç»­æ“ä½œ <code>in</code> æ˜¯ä¸å®‰å…¨çš„ï¼Œæ‰€ä»¥ç»“æŸå¾ªç¯ã€‚</li>
<li>ç¬¬ 42 è¡Œï¼šç›´æ¥åˆ¤æ–­ <code>out.size() == 0</code> æ¯”è¾ƒåˆé€‚ã€‚å› ä¸ºã€ç¬¬ 8 è‡³ 24 è¡Œã€‘çš„ä»£ç ï¼Œèƒ½å¤Ÿä¿è¯ <code>outSize</code> ç­‰äº<strong>é›¶</strong>ã€‚<ul>
<li>ç¬¬ 43 è‡³ 45 è¡Œï¼šå¦‚æœ<strong>æœªè¯»å–</strong>ä»»ä½•å­—èŠ‚ï¼Œ<code>break</code> ç»“æŸå¾ªç¯ã€‚</li>
<li>ç¬¬ 46 è‡³ 49 è¡Œï¼šå¦‚æœå¯è¯»å­—èŠ‚<strong>å‘ç”Ÿå˜åŒ–</strong>ï¼Œ<code>continue</code> é‡æ–°å¼€å§‹å¾ªç¯ï¼Œå³ç»§ç»­è¯»å–ã€‚</li>
</ul>
</li>
<li>ç¬¬ 52 è‡³ 55 è¡Œï¼šå¦‚æœè§£ç äº†æ¶ˆæ¯ï¼Œä½†æ˜¯å¯è¯»å­—èŠ‚æ•°æœªå˜ï¼ŒæŠ›å‡º DecoderException å¼‚å¸¸ã€‚è¯´æ˜ï¼Œæœ‰é—®é¢˜ã€‚</li>
<li>ç¬¬ 57 è‡³ 60 è¡Œï¼šå¦‚æœå¼€å¯ <code>singleDecode</code> ï¼Œè¡¨ç¤ºåªè§£æä¸€æ¬¡ï¼Œ<code>break</code> ç»“æŸå¾ªç¯ã€‚</li>
<li>ç¬¬ 62 è‡³ 66 è¡Œï¼šå¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼ŒæŠ›å‡º DecoderException å¼‚å¸¸ã€‚</li>
</ul>
<p>ğŸ˜ˆ ä»£ç æœ‰ä¸€äº›é•¿ï¼Œèƒ–å‹ä¿æŒè€å¿ƒçœ‹å®Œå“ˆã€‚å…¶å®ï¼Œè›®ç®€å•çš„ã€‚</p>
<h3 id="5-3-1-decodeRemovalReentryProtection"><a href="#5-3-1-decodeRemovalReentryProtection" class="headerlink" title="5.3.1 decodeRemovalReentryProtection"></a>5.3.1 decodeRemovalReentryProtection</h3><p><code>#decodeRemovalReentryProtection(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code> æ–¹æ³•ï¼Œæ‰§è¡Œè§£ç ã€‚å¦‚æœ Handler å‡†å¤‡ç§»é™¤ï¼Œåœ¨è§£ç å®Œæˆåï¼Œè¿›è¡Œç§»é™¤ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">decodeRemovalReentryProtection</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// è®¾ç½®çŠ¶æ€ä¸º STATE_CALLING_CHILD_DECODE</span></span><br><span class="line"> <span class="number">3</span>:     decodeState = STATE_CALLING_CHILD_DECODE;</span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">5</span>:         <span class="comment">// æ‰§è¡Œè§£ç </span></span><br><span class="line"> <span class="number">6</span>:         decode(ctx, in, out);</span><br><span class="line"> <span class="number">7</span>:     } <span class="keyword">finally</span> {</span><br><span class="line"> <span class="number">8</span>:         <span class="comment">// åˆ¤æ–­æ˜¯å¦å‡†å¤‡ç§»é™¤</span></span><br><span class="line"> <span class="number">9</span>:         <span class="keyword">boolean</span> removePending = decodeState == STATE_HANDLER_REMOVED_PENDING;</span><br><span class="line"><span class="number">10</span>:         <span class="comment">// è®¾ç½®çŠ¶æ€ä¸º STATE_INIT</span></span><br><span class="line"><span class="number">11</span>:         decodeState = STATE_INIT;</span><br><span class="line"><span class="number">12</span>:         <span class="comment">// ç§»é™¤å½“å‰ Handler</span></span><br><span class="line"><span class="number">13</span>:         <span class="keyword">if</span> (removePending) {</span><br><span class="line"><span class="number">14</span>:             handlerRemoved(ctx);</span><br><span class="line"><span class="number">15</span>:         }</span><br><span class="line"><span class="number">16</span>:     }</span><br><span class="line"><span class="number">17</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šè®¾ç½®çŠ¶æ€(<code>decodeState</code>) ä¸º <code>STATE_CALLING_CHILD_DECODE</code> ã€‚</li>
<li><p>ç¬¬ 6 è¡Œï¼šè°ƒç”¨ <code>#decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code> æ–¹æ³•ï¼Œæ‰§è¡Œè§£ç ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Decode the from one {<span class="doctag">@link</span> ByteBuf} to an other. This method will be called till either the input</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> ByteBuf} has nothing to read when return from this method or till nothing was read from the input</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> ByteBuf}.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ctx           the {<span class="doctag">@link</span> ChannelHandlerContext} which this {<span class="doctag">@link</span> ByteToMessageDecoder} belongs to</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> in            the {<span class="doctag">@link</span> ByteBuf} from which to read data</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> out           the {<span class="doctag">@link</span> List} to which decoded messages should be added</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception    is thrown if an error occurs</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œå°±å¯ä»¥æ„‰å¿«çš„è§£ç æ¶ˆæ¯äº†ï¼Œ<strong>å¹¶ä¸”ï¼Œä¹Ÿåªéœ€è¦å®ç°è¯¥æ–¹æ³•</strong>ã€‚å…¶å®ƒçš„é€»è¾‘ï¼ŒByteToMessageDecoder å·²ç»å…¨éƒ¨å¸®å¿™å®ç°äº†ã€‚</li>
</ul>
</li>
<li>ç¬¬ 9 è¡Œï¼šåˆ¤æ–­æ˜¯å¦å‡†å¤‡ç§»é™¤ã€‚é‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¸‹ï¼Œä¼šå‡ºç° <code>decodeState == STATE_HANDLER_REMOVED_PENDING</code> æˆç«‹å‘¢ï¼Ÿè¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5.7 handlerRemovedã€</a> ã€‚<ul>
<li>ç¬¬ 11 è¡Œï¼šè®¾ç½®çŠ¶æ€(<code>decodeState</code>) ä¸º <code>STATE_HANDLER_REMOVED_PENDING</code> ã€‚</li>
<li>ç¬¬ 12 è‡³ 15 è¡Œï¼šå¦‚æœå‡†å¤‡ç§»é™¤ï¼Œåˆ™è°ƒç”¨ <code>#handlerRemoved(ChannelHandlerContext ctx)</code> æ–¹æ³•ï¼Œç§»é™¤å½“å‰ Handler ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5.7 handlerRemovedã€</a> ã€‚</li>
</ul>
</li>
</ul>
<h2 id="5-4-channelReadComplete"><a href="#5-4-channelReadComplete" class="headerlink" title="5.4 channelReadComplete"></a>5.4 channelReadComplete</h2><p><code>#channelReadComplete(ChannelHandlerContext ctx)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// é‡ç½® numReads</span></span><br><span class="line"> <span class="number">4</span>:     numReads = <span class="number">0</span>;</span><br><span class="line"> <span class="number">5</span>:     <span class="comment">// é‡Šæ”¾éƒ¨åˆ†çš„å·²è¯»</span></span><br><span class="line"> <span class="number">6</span>:     discardSomeReadBytes();</span><br><span class="line"> <span class="number">7</span>:     <span class="comment">// æœªè§£ç åˆ°æ¶ˆæ¯ï¼Œå¹¶ä¸”æœªå¼€å¯è‡ªåŠ¨è¯»å–ï¼Œåˆ™å†æ¬¡å‘èµ·è¯»å–ï¼ŒæœŸæœ›è¯»å–åˆ°æ›´å¤šæ•°æ®ï¼Œä»¥ä¾¿è§£ç åˆ°æ¶ˆæ¯</span></span><br><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (decodeWasNull) {</span><br><span class="line"> <span class="number">9</span>:         decodeWasNull = <span class="keyword">false</span>; <span class="comment">// é‡ç½® decodeWasNull</span></span><br><span class="line"><span class="number">10</span>:         <span class="keyword">if</span> (!ctx.channel().config().isAutoRead()) {</span><br><span class="line"><span class="number">11</span>:             ctx.read();</span><br><span class="line"><span class="number">12</span>:         }</span><br><span class="line"><span class="number">13</span>:     }</span><br><span class="line"><span class="number">14</span>:     <span class="comment">// è§¦å‘ Channel ReadComplete äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="number">15</span>:     ctx.fireChannelReadComplete();</span><br><span class="line"><span class="number">16</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 4 è¡Œï¼šé‡ç½® <code>numReads</code> ã€‚</li>
<li>ç¬¬ 6 è¡Œï¼šè°ƒç”¨ <code>#discardSomeReadBytes()</code> æ–¹æ³•ï¼Œé‡Šæ”¾éƒ¨åˆ†çš„å·²è¯»ã€‚</li>
<li>ç¬¬ 7 è‡³ 13 è¡Œï¼šæœªè§£ç åˆ°æ¶ˆæ¯( <code>decodeWasNull == true</code> )ï¼Œå¹¶ä¸”æœªå¼€å¯è‡ªåŠ¨è¯»å–( <code>ctx.channel().config().isAutoRead() == false</code> )ï¼Œåˆ™å†æ¬¡å‘èµ·è¯»å–ï¼ŒæœŸæœ›è¯»å–åˆ°æ›´å¤šæ•°æ®ï¼Œä»¥ä¾¿è§£ç åˆ°æ¶ˆæ¯ã€‚</li>
<li>ç¬¬ 15 è¡Œï¼šè§¦å‘ Channel ReadComplete äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li>
</ul>
<h2 id="5-5-channelInactive"><a href="#5-5-channelInactive" class="headerlink" title="5.5 channelInactive"></a>5.5 channelInactive</h2><p><code>#channelInactive(ChannelHandlerContext ctx)</code> æ–¹æ³•ï¼Œé€šé“å¤„äºæœªæ¿€æ´»( Inactive )ï¼Œè§£ç å®Œå‰©ä½™çš„æ¶ˆæ¯ï¼Œå¹¶é‡Šæ”¾ç›¸å…³èµ„æºã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    channelInputClosed(ctx, <span class="keyword">true</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>#channelInputClosed(ChannelHandlerContext ctx, boolean callChannelInactive)</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Channel è¯»å–å…³é—­çš„é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">channelInputClosed</span><span class="params">(ChannelHandlerContext ctx, <span class="keyword">boolean</span> callChannelInactive)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// åˆ›å»º CodecOutputList å¯¹è±¡</span></span><br><span class="line"> <span class="number">3</span>:     CodecOutputList out = CodecOutputList.newInstance();</span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">5</span>:         <span class="comment">// å½“ Channel è¯»å–å…³é—­æ—¶ï¼Œæ‰§è¡Œè§£ç å‰©ä½™æ¶ˆæ¯çš„é€»è¾‘</span></span><br><span class="line"> <span class="number">6</span>:         channelInputClosed(ctx, out);</span><br><span class="line"> <span class="number">7</span>:     } <span class="keyword">catch</span> (DecoderException e) {</span><br><span class="line"> <span class="number">8</span>:         <span class="keyword">throw</span> e;</span><br><span class="line"> <span class="number">9</span>:     } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line"><span class="number">10</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> DecoderException(e);</span><br><span class="line"><span class="number">11</span>:     } <span class="keyword">finally</span> {</span><br><span class="line"><span class="number">12</span>:         <span class="keyword">try</span> {</span><br><span class="line"><span class="number">13</span>:             <span class="comment">// é‡Šæ”¾ cumulation</span></span><br><span class="line"><span class="number">14</span>:             <span class="keyword">if</span> (cumulation != <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">15</span>:                 cumulation.release();</span><br><span class="line"><span class="number">16</span>:                 cumulation = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">17</span>:             }</span><br><span class="line"><span class="number">18</span>:             <span class="keyword">int</span> size = out.size();</span><br><span class="line"><span class="number">19</span>:             <span class="comment">// è§¦å‘ Channel Read äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚å¯èƒ½æ˜¯å¤šæ¡æ¶ˆæ¯</span></span><br><span class="line"><span class="number">20</span>:             fireChannelRead(ctx, out, size);</span><br><span class="line"><span class="number">21</span>:             <span class="comment">// å¦‚æœæœ‰è§£ç åˆ°æ¶ˆæ¯ï¼Œåˆ™è§¦å‘ Channel ReadComplete äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="number">22</span>:             <span class="keyword">if</span> (size &gt; <span class="number">0</span>) {</span><br><span class="line"><span class="number">23</span>:                 <span class="comment">// Something was read, call fireChannelReadComplete()</span></span><br><span class="line"><span class="number">24</span>:                 ctx.fireChannelReadComplete();</span><br><span class="line"><span class="number">25</span>:             }</span><br><span class="line"><span class="number">26</span>:             <span class="comment">// å¦‚æœæ–¹æ³•è°ƒç”¨æ¥æºæ˜¯ `#channelInactive(...)` ï¼Œåˆ™è§¦å‘ Channel Inactive äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="number">27</span>:             <span class="keyword">if</span> (callChannelInactive) {</span><br><span class="line"><span class="number">28</span>:                 ctx.fireChannelInactive();</span><br><span class="line"><span class="number">29</span>:             }</span><br><span class="line"><span class="number">30</span>:         } <span class="keyword">finally</span> {</span><br><span class="line"><span class="number">31</span>:             <span class="comment">// å›æ”¶ CodecOutputList å¯¹è±¡</span></span><br><span class="line"><span class="number">32</span>:             <span class="comment">// Recycle in all cases</span></span><br><span class="line"><span class="number">33</span>:             out.recycle();</span><br><span class="line"><span class="number">34</span>:         }</span><br><span class="line"><span class="number">35</span>:     }</span><br><span class="line"><span class="number">36</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ç¬¬ 3 è¡Œï¼šåˆ›å»º CodecOutputList å¯¹è±¡ã€‚</p>
<ul>
<li><p>ç¬¬ 6 è¡Œï¼šè°ƒç”¨ <code>#channelInputClosed(ChannelHandlerContext ctx, List&lt;Object&gt; out)</code> æ–¹æ³•ï¼Œå½“ Channel è¯»å–å…³é—­æ—¶ï¼Œæ‰§è¡Œè§£ç å‰©ä½™æ¶ˆæ¯çš„é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Called when the input of the channel was closed which may be because it changed to inactive or because of</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> ChannelInputShutdownEvent}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">channelInputClosed</span><span class="params">(ChannelHandlerContext ctx, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (cumulation != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// æ‰§è¡Œè§£ç </span></span><br><span class="line">        callDecode(ctx, cumulation, out);</span><br><span class="line">        <span class="comment">// æœ€åä¸€æ¬¡ï¼Œæ‰§è¡Œè§£ç </span></span><br><span class="line">        decodeLast(ctx, cumulation, out);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// æœ€åä¸€æ¬¡ï¼Œæ‰§è¡Œè§£ç </span></span><br><span class="line">        decodeLast(ctx, Unpooled.EMPTY_BUFFER, out);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Is called one last time when the {<span class="doctag">@link</span> ChannelHandlerContext} goes in-active. Which means the</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #channelInactive(ChannelHandlerContext)} was triggered.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * By default this will just call {<span class="doctag">@link</span> #decode(ChannelHandlerContext, ByteBuf, List)} but sub-classes may</span></span><br><span class="line"><span class="comment"> * override this for some special cleanup operation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decodeLast</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (in.isReadable()) {</span><br><span class="line">        <span class="comment">// Only call decode() if there is something left in the buffer to decode.</span></span><br><span class="line">        <span class="comment">// See https://github.com/netty/netty/issues/4386</span></span><br><span class="line">        decodeRemovalReentryProtection(ctx, in, out);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å…¶ä¸­ï¼Œ<code>#decodeLast(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code> æ–¹æ³•ï¼Œæ˜¯å¯ä»¥è¢«é‡å†™çš„ã€‚ä¾‹å¦‚ï¼ŒHttpObjectDecoder å°±é‡å†™äº†è¯¥æ–¹æ³•ã€‚</li>
</ul>
</li>
<li>ç¬¬ 7 è‡³ 10 è¡Œï¼šå¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œå°±æŠ›å‡º DecoderException å¼‚å¸¸ã€‚</li>
</ul>
</li>
<li>ç¬¬ 13 è‡³ 17 è¡Œï¼šé‡Šæ”¾ <code>cumulation</code> ã€‚</li>
<li>ç¬¬ 20 è¡Œï¼šè°ƒç”¨ <code>#fireChannelRead(ChannelHandlerContext ctx, List&lt;Object&gt; msgs, int numElements)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œè§¦å‘ Channel Read äº‹ä»¶ã€‚å¯èƒ½æ˜¯å¤šæ¡æ¶ˆæ¯ã€‚</li>
<li>ç¬¬ 21 è‡³ 25 è¡Œï¼šå¦‚æœæœ‰è§£ç åˆ°æ¶ˆæ¯( <code>size &gt; 0</code> )ï¼Œåˆ™è§¦å‘ Channel ReadComplete äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li>
<li>ç¬¬ 26 è‡³ 29 è¡Œï¼šå¦‚æœæ–¹æ³•è°ƒç”¨æ¥æºæ˜¯ <code>#channelInactive(...)</code> ï¼Œåˆ™è§¦å‘ Channel Inactive äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li>
<li>ç¬¬ 30 è‡³ 35 è¡Œï¼šå›æ”¶ CodecOutputList å¯¹è±¡ã€‚</li>
</ul>
</li>
</ul>
<p>ğŸ˜ˆ å¯¹äºè¯¥æ–¹æ³•çš„ç›®çš„ï¼Œç¬”è€…çš„ç†è§£æ˜¯ï¼Œå°½å¯èƒ½åœ¨è§£ç ä¸€æ¬¡å‰©ä½™çš„ <code>cumulation</code> ï¼Œåœ¨ Channel å˜æˆæœªæ¿€æ´»æ—¶ã€‚ç»†èŠ‚å¥½å¤šå‘€ï¼ï¼ï¼</p>
<h2 id="5-6-userEventTriggered"><a href="#5-6-userEventTriggered" class="headerlink" title="5.6 userEventTriggered"></a>5.6 userEventTriggered</h2><p><code>#userEventTriggered(ChannelHandlerContext ctx, Object evt)</code> æ–¹æ³•ï¼Œå¤„ç† ChannelInputShutdownEvent äº‹ä»¶ï¼Œå³ Channel å…³é—­è¯»å–ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (evt <span class="keyword">instanceof</span> ChannelInputShutdownEvent) {</span><br><span class="line">        <span class="comment">// The decodeLast method is invoked when a channelInactive event is encountered.</span></span><br><span class="line">        <span class="comment">// This method is responsible for ending requests in some situations and must be called</span></span><br><span class="line">        <span class="comment">// when the input has been shutdown.</span></span><br><span class="line">        channelInputClosed(ctx, <span class="keyword">false</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// ç»§ç»­ä¼ æ’­ evt åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">super</span>.userEventTriggered(ctx, evt);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è°ƒç”¨ <code>#channelInputClosed(ChannelHandlerContext ctx, boolean callChannelInactive)</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Channel è¯»å–å…³é—­çš„é€»è¾‘ã€‚</li>
<li>ç»§ç»­ä¼ æ’­ <code>evt</code> åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li>
</ul>
<p>ğŸ˜ˆ å¯¹äºè¯¥æ–¹æ³•çš„ç›®çš„ï¼Œç¬”è€…çš„ç†è§£æ˜¯ï¼Œå°½å¯èƒ½åœ¨è§£ç ä¸€æ¬¡å‰©ä½™çš„ <code>cumulation</code> ï¼Œåœ¨ Channel å…³é—­è¯»å–ã€‚ç»†èŠ‚å¥½å¤šå‘€ï¼ï¼ï¼</p>
<h2 id="5-7-handlerRemoved"><a href="#5-7-handlerRemoved" class="headerlink" title="5.7 handlerRemoved"></a>5.7 handlerRemoved</h2><p><code>#handlerRemoved(ChannelHandlerContext ctx)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handlerRemoved</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// çŠ¶æ€å¤„äº STATE_CALLING_CHILD_DECODE æ—¶ï¼Œæ ‡è®°çŠ¶æ€ä¸º STATE_HANDLER_REMOVED_PENDING</span></span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (decodeState == STATE_CALLING_CHILD_DECODE) {</span><br><span class="line"> <span class="number">5</span>:         decodeState = STATE_HANDLER_REMOVED_PENDING;</span><br><span class="line"> <span class="number">6</span>:         <span class="keyword">return</span>; <span class="comment">// è¿”å›ï¼ï¼ï¼ï¼ç»“åˆ `#decodeRemovalReentryProtection(...)` æ–¹æ³•ï¼Œä¸€èµ·çœ‹ã€‚</span></span><br><span class="line"> <span class="number">7</span>:     }</span><br><span class="line"> <span class="number">8</span>:     ByteBuf buf = cumulation;</span><br><span class="line"> <span class="number">9</span>:     <span class="keyword">if</span> (buf != <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">10</span>:         <span class="comment">// ç½®ç©º cumulation</span></span><br><span class="line"><span class="number">11</span>:         <span class="comment">// Directly set this to null so we are sure we not access it in any other method here anymore.</span></span><br><span class="line"><span class="number">12</span>:         cumulation = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">13</span>: </span><br><span class="line"><span class="number">14</span>:         <span class="keyword">int</span> readable = buf.readableBytes();</span><br><span class="line"><span class="number">15</span>:         <span class="comment">// æœ‰å¯è¯»å­—èŠ‚</span></span><br><span class="line"><span class="number">16</span>:         <span class="keyword">if</span> (readable &gt; <span class="number">0</span>) {</span><br><span class="line"><span class="number">17</span>:             <span class="comment">// è¯»å–å‰©ä½™å­—èŠ‚ï¼Œå¹¶é‡Šæ”¾ buf</span></span><br><span class="line"><span class="number">18</span>:             ByteBuf bytes = buf.readBytes(readable);</span><br><span class="line"><span class="number">19</span>:             buf.release();</span><br><span class="line"><span class="number">20</span>:             <span class="comment">// è§¦å‘ Channel Read åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="number">21</span>:             ctx.fireChannelRead(bytes);</span><br><span class="line"><span class="number">22</span>:         <span class="comment">// æ— å¯è¯»å­—èŠ‚</span></span><br><span class="line"><span class="number">23</span>:         } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">24</span>:             <span class="comment">// é‡Šæ”¾ buf</span></span><br><span class="line"><span class="number">25</span>:             buf.release();</span><br><span class="line"><span class="number">26</span>:         }</span><br><span class="line"><span class="number">27</span>: </span><br><span class="line"><span class="number">28</span>:         <span class="comment">// ç½®ç©º numReads</span></span><br><span class="line"><span class="number">29</span>:         numReads = <span class="number">0</span>;</span><br><span class="line"><span class="number">30</span>:         <span class="comment">// è§¦å‘ Channel ReadComplete åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="number">31</span>:         ctx.fireChannelReadComplete();</span><br><span class="line"><span class="number">32</span>:     }</span><br><span class="line"><span class="number">33</span>:     <span class="comment">// æ‰§è¡Œç§»é™¤é€»è¾‘</span></span><br><span class="line"><span class="number">34</span>:     handlerRemoved0(ctx);</span><br><span class="line"><span class="number">35</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è‡³ 7 è¡Œï¼šå¦‚æœçŠ¶æ€( <code>decodeState</code> )å¤„äº <code>STATE_CALLING_CHILD_DECODE</code> æ—¶ï¼Œè¯´æ˜æ­£åœ¨æ‰§è¡Œ <code>#decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code> æ–¹æ³•ä¸­ã€‚å¦‚æœæ­¤æ—¶ï¼Œç›´æ¥å¾€ä¸‹æ‰§è¡Œï¼Œ<code>cumulation</code> å°†è¢«ç›´æ¥é‡Šæ”¾ï¼Œè€Œ <code>#decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code> æ–¹æ³•å¯èƒ½æ­£åœ¨è§£ç ä¸­ï¼Œå¾ˆå¤§å¯èƒ½æ€§é€ æˆå½±å“ï¼Œå¯¼è‡´é”™è¯¯ã€‚æ‰€ä»¥ï¼Œæ­¤å¤„ä»…ä»…æ ‡è®°çŠ¶æ€( <code>decodeState</code> )ä¸º <code>STATE_HANDLER_REMOVED_PENDING</code> ã€‚ç­‰åˆ° <code>#decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code> æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œåœ¨è¿›è¡Œç§»é™¤ã€‚èƒ–å‹ï¼Œæ­¤æ—¶å¯ä»¥å†è·³å› <a href="#">ã€Œ5.3.1 decodeRemovalReentryProtectionã€</a> ï¼Œè¿›è¡Œå†æ¬¡ç†è§£ã€‚</li>
<li>ã€æœ‰å¯è¯»å­—èŠ‚ã€‘ç¬¬ 15 è‡³ 21 è¡Œï¼šè¯»å–å‰©ä½™å­—èŠ‚ï¼Œå¹¶é‡Šæ”¾ <code>buf</code> ã€‚ç„¶åï¼Œè§¦å‘ Channel Read åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œé¿å… <code>cumulation</code> ä¸­ï¼Œæœ‰å­—èŠ‚è¢«â€œä¸¢å¤±â€ï¼Œå³ä½¿å½“å‰å¯èƒ½æ— æ³•è§£ç æˆä¸€ä¸ªæ•°æ®åŒ…ã€‚</li>
<li>ã€æ— å¯è¯»å­—èŠ‚ã€‘ç¬¬ 22 è‡³ 26 è¡Œï¼šç›´æ¥é‡Šæ”¾ <code>buf</code> ã€‚</li>
<li>ç¬¬ 29 è¡Œï¼šç½®ç©º <code>numReads</code> ã€‚</li>
<li><p>ç¬¬ 34 è¡Œï¼šè°ƒç”¨ <code>#handlerRemoved0(ChannelHandlerContext ctx)</code> æ–¹æ³•ï¼Œæ‰§è¡Œç§»é™¤é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Gets called after the {<span class="doctag">@link</span> ByteToMessageDecoder} was removed from the actual context and it doesn't handle</span></span><br><span class="line"><span class="comment"> * events anymore.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">handlerRemoved0</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{ }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥æ–¹æ³•å®ç°ä¸ºç©ºã€‚ç›®å‰å¯é‡å†™è¯¥æ–¹æ³•ï¼Œå®ç°è‡ªå®šä¹‰çš„èµ„æºé‡Šæ”¾ã€‚ç›®å‰é‡å†™è¯¥æ–¹æ³•çš„ç±»ï¼Œä¾‹å¦‚ï¼šHttp2ConnectionHandlerã€SslHandler ç­‰ç­‰ã€‚</li>
</ul>
</li>
</ul>
<h2 id="5-8-internalBuffer"><a href="#5-8-internalBuffer" class="headerlink" title="5.8 internalBuffer"></a>5.8 internalBuffer</h2><p><code>#internalBuffer()</code> æ–¹æ³•ï¼Œè·å¾— ByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns the internal cumulative buffer of this decoder. You usually</span></span><br><span class="line"><span class="comment"> * do not need to access the internal buffer directly to write a decoder.</span></span><br><span class="line"><span class="comment"> * Use it only when you must use it at your own risk.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ByteBuf <span class="title">internalBuffer</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (cumulation != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> cumulation;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> Unpooled.EMPTY_BUFFER;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="5-9-actualReadableBytes"><a href="#5-9-actualReadableBytes" class="headerlink" title="5.9 actualReadableBytes"></a>5.9 actualReadableBytes</h2><p><code>#actualReadableBytes()</code> æ–¹æ³•ï¼Œè·å¾—å¯è¯»å­—èŠ‚æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns the actual number of readable bytes in the internal cumulative</span></span><br><span class="line"><span class="comment"> * buffer of this decoder. You usually do not need to rely on this value</span></span><br><span class="line"><span class="comment"> * to write a decoder. Use it only when you must use it at your own risk.</span></span><br><span class="line"><span class="comment"> * This method is a shortcut to {<span class="doctag">@link</span> #internalBuffer() internalBuffer().readableBytes()}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">actualReadableBytes</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> internalBuffer().readableBytes();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ç»†èŠ‚æœ‰ç‚¹å¤šï¼Œå¯èƒ½å¯¹å¦‚ä¸‹å°èŠ‚ç†è§£ä¸å¤Ÿåˆ°ä½ã€‚å¦‚æœ‰é”™è¯¯ï¼Œçƒ¦è¯·èƒ–å‹æ•™è‚²ã€‚</p>
<ul>
<li><a href="#">ã€Œ5.5 channelInactiveã€</a></li>
<li><a href="#">ã€Œ5.6 userEventTriggeredã€</a></li>
<li><a href="#">ã€Œ5.7 handlerRemovedã€</a></li>
</ul>
<hr>
<p>æœ¬æ–‡å‚è€ƒå¦‚ä¸‹æ–‡ç« ï¼š</p>
<ul>
<li>ç®€ä¹¦é—ªç”µä¾  <a href="https://www.jianshu.com/p/dc26e944da95" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnettyæºç åˆ†æä¹‹æ‹†åŒ…å™¨çš„å¥¥ç§˜ã€‹</a></li>
<li>Hypercube <a href="https://www.jianshu.com/p/7c439cc7b01c" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆå…«ï¼‰â€“CodecHandlerã€‹</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/Codec-1-1-ByteToMessageDecoder-core-impl/" data-id="ck4pl3fpb00ekfgcfqsfar0b8" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>