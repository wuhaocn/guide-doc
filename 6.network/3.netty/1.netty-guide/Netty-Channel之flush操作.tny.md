<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” Channelï¼ˆäº”ï¼‰ä¹‹ flush æ“ä½œ
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡æ¥ <a href="http://svip.iocoder.cn/Netty/Channel-4-write/">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Channelï¼ˆå››ï¼‰ä¹‹ write æ“ä½œã€‹</a> ï¼Œåˆ†äº« Netty Channel çš„ <code>#flush()</code> æ–¹æ³•ï¼Œåˆ·æ–°<strong>å†…å­˜é˜Ÿåˆ—</strong>ï¼Œå°†å…¶ä¸­çš„æ•°æ®å†™å…¥åˆ°å¯¹ç«¯ã€‚</p>
<p>åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œ<code>#flush()</code> æ–¹æ³•å’Œ <code>#write(Object msg, ...)</code> <strong>æ­£å¸¸</strong>æƒ…å†µä¸‹ï¼Œç»å†çš„æµç¨‹æ˜¯<strong>å·®ä¸å¤š</strong>çš„ï¼Œä¾‹å¦‚åœ¨ pipeline ä¸­å¯¹äº‹ä»¶çš„ä¼ æ’­ï¼Œä» <code>tail</code> èŠ‚ç‚¹ä¼ æ’­åˆ° <code>head</code> èŠ‚ç‚¹ï¼Œæœ€ç»ˆäº¤ç”± Unsafe å¤„ç†ï¼Œè€Œå·®å¼‚ç‚¹å°±æ˜¯ Unsafe çš„å¤„ç†æ–¹å¼<strong>ä¸åŒ</strong>ï¼š</p>
<ul>
<li>write æ–¹æ³•ï¼šå°†æ•°æ®å†™åˆ°<strong>å†…å­˜é˜Ÿåˆ—</strong>ä¸­ã€‚</li>
<li>flush æ–¹æ³•ï¼šåˆ·æ–°<strong>å†…å­˜é˜Ÿåˆ—</strong>ï¼Œå°†å…¶ä¸­çš„æ•°æ®å†™å…¥åˆ°å¯¹ç«¯ã€‚</li>
</ul>
<p>å½“ç„¶ï¼Œä¸Šè¿°æè¿°ä»…ä»…æŒ‡çš„æ˜¯<strong>æ­£å¸¸</strong>æƒ…å†µä¸‹ï¼Œåœ¨<strong>å¼‚å¸¸</strong>æƒ…å†µä¸‹ä¼šæœ‰æ‰€ä¸åŒã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒChannel å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯<strong>å¯å†™</strong>çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦ä¸“é—¨å»æ³¨å†Œ <code>SelectionKey.OP_WRITE</code> äº‹ä»¶ã€‚æ‰€ä»¥åœ¨ Netty çš„å®ç°ä¸­ï¼Œé»˜è®¤ Channel æ˜¯<strong>å¯å†™</strong>çš„ï¼Œå½“å†™å…¥å¤±è´¥çš„æ—¶å€™ï¼Œå†å»æ³¨å†Œ <code>SelectionKey.OP_WRITE</code> äº‹ä»¶ã€‚è¿™æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿåœ¨ <code>#flush()</code> æ–¹æ³•ä¸­ï¼Œå¦‚æœå†™å…¥æ•°æ®åˆ° Channel å¤±è´¥ï¼Œä¼šé€šè¿‡æ³¨å†Œ <code>SelectionKey.OP_WRITE</code> äº‹ä»¶ï¼Œç„¶ååœ¨è½®è¯¢åˆ° Channel <strong>å¯å†™</strong> æ—¶ï¼Œå†â€œå›è°ƒâ€ <code>#forceFlush()</code> æ–¹æ³•ã€‚</p>
<p>æ˜¯ä¸æ˜¯éå¸¸å·§å¦™ï¼Ÿï¼è®©æˆ‘ç›´å¥”ä»£ç ï¼Œå¤§å£åƒè‚‰ï¼Œæ½‡æ´’æ’¸ç ã€‚</p>
<blockquote>
<p>ä¸‹æ–‡çš„ <a href="#">ã€Œ2.ã€</a>ã€<a href="#">ã€Œ3.ã€</a>ã€<a href="#">ã€Œ4.ã€</a>ã€<a href="#">ã€Œ5.ã€</a> å’Œ <a href="http://svip.iocoder.cn/Netty/Channel-4-write">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Channelï¼ˆå››ï¼‰ä¹‹ write æ“ä½œã€‹</a> éå¸¸<strong>ç±»ä¼¼</strong>ï¼Œæ‰€ä»¥èƒ–å‹å¯ä»¥å¿«é€Ÿæµè§ˆã€‚çœŸæ­£çš„<strong>å·®å¼‚</strong>ï¼Œä» <a href="#">ã€Œ6.ã€</a> å¼€å§‹ã€‚</p>
</blockquote>
<h1 id="2-AbstractChannel"><a href="#2-AbstractChannel" class="headerlink" title="2. AbstractChannel"></a>2. AbstractChannel</h1><p>AbstractChannel å¯¹ <code>#flush()</code> æ–¹æ³•çš„å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Channel <span class="title">flush</span><span class="params">()</span> </span>{</span><br><span class="line">    pipeline.flush();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨æ–¹æ³•å†…éƒ¨ï¼Œä¼šè°ƒç”¨å¯¹åº”çš„ <code>ChannelPipeline#flush()</code> æ–¹æ³•ï¼Œå°† flush äº‹ä»¶åœ¨ pipeline ä¸Šä¼ æ’­ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ3. DefaultChannelPipelineã€</a> ã€‚<ul>
<li>æœ€ç»ˆä¼šä¼ æ’­ flush äº‹ä»¶åˆ° <code>head</code> èŠ‚ç‚¹ï¼Œåˆ·æ–°<strong>å†…å­˜é˜Ÿåˆ—</strong>ï¼Œå°†å…¶ä¸­çš„æ•°æ®å†™å…¥åˆ°å¯¹ç«¯ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5. HeadContextã€</a> ã€‚</li>
</ul>
</li>
</ul>
<h1 id="3-DefaultChannelPipeline"><a href="#3-DefaultChannelPipeline" class="headerlink" title="3. DefaultChannelPipeline"></a>3. DefaultChannelPipeline</h1><p><code>DefaultChannelPipeline#flush()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelPipeline <span class="title">flush</span><span class="params">()</span> </span>{</span><br><span class="line">    tail.flush();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨æ–¹æ³•å†…éƒ¨ï¼Œä¼šè°ƒç”¨ <code>TailContext#flush()</code> æ–¹æ³•ï¼Œå°† flush äº‹ä»¶åœ¨ pipeline ä¸­ï¼Œä»å°¾èŠ‚ç‚¹å‘å¤´èŠ‚ç‚¹ä¼ æ’­ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ4. TailContextã€</a> ã€‚</li>
</ul>
<h1 id="4-TailContext"><a href="#4-TailContext" class="headerlink" title="4. TailContext"></a>4. TailContext</h1><p>TailContext å¯¹ <code>TailContext#flush()</code> æ–¹æ³•çš„å®ç°ï¼Œæ˜¯ä» AbstractChannelHandlerContext æŠ½è±¡ç±»ç»§æ‰¿ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> ChannelHandlerContext <span class="title">flush</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// è·å¾—ä¸‹ä¸€ä¸ª Outbound èŠ‚ç‚¹</span></span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">final</span> AbstractChannelHandlerContext next = findContextOutbound();</span><br><span class="line"> <span class="number">5</span>:     EventExecutor executor = next.executor();</span><br><span class="line"> <span class="number">6</span>:     <span class="comment">// åœ¨ EventLoop çš„çº¿ç¨‹ä¸­</span></span><br><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (executor.inEventLoop()) {</span><br><span class="line"> <span class="number">8</span>:         <span class="comment">// æ‰§è¡Œ flush äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"> <span class="number">9</span>:         next.invokeFlush();</span><br><span class="line"><span class="number">10</span>:     <span class="comment">// ä¸åœ¨ EventLoop çš„çº¿ç¨‹ä¸­</span></span><br><span class="line"><span class="number">11</span>:     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">12</span>:         <span class="comment">// åˆ›å»º flush ä»»åŠ¡</span></span><br><span class="line"><span class="number">13</span>:         Runnable task = next.invokeFlushTask;</span><br><span class="line"><span class="number">14</span>:         <span class="keyword">if</span> (task == <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">15</span>:             next.invokeFlushTask = task = <span class="keyword">new</span> Runnable() {</span><br><span class="line"><span class="number">16</span>:                 <span class="meta">@Override</span></span><br><span class="line"><span class="number">17</span>:                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="number">18</span>:                     next.invokeFlush();</span><br><span class="line"><span class="number">19</span>:                 }</span><br><span class="line"><span class="number">20</span>:             };</span><br><span class="line"><span class="number">21</span>:         }</span><br><span class="line"><span class="number">22</span>:         <span class="comment">// æäº¤åˆ° EventLoop çš„çº¿ç¨‹ä¸­ï¼Œæ‰§è¡Œè¯¥ä»»åŠ¡</span></span><br><span class="line"><span class="number">23</span>:         safeExecute(executor, task, channel().voidPromise(), <span class="keyword">null</span>);</span><br><span class="line"><span class="number">24</span>:     }</span><br><span class="line"><span class="number">25</span>: </span><br><span class="line"><span class="number">26</span>:     <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line"><span class="number">27</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 4 è¡Œï¼šè°ƒç”¨ <code>#findContextOutbound()</code> æ–¹æ³•ï¼Œè·å¾—<strong>ä¸‹ä¸€ä¸ª</strong> Outbound èŠ‚ç‚¹ã€‚</li>
<li>ç¬¬ 7 è¡Œï¼š<strong>åœ¨</strong> EventLoop çš„çº¿ç¨‹ä¸­ã€‚<ul>
<li>ç¬¬ 12 è‡³ 15 è¡Œï¼šè°ƒç”¨ <code>AbstractChannelHandlerContext#invokeFlush()()</code> æ–¹æ³•ï¼Œæ‰§è¡Œ flush äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li>
<li>åç»­çš„é€»è¾‘ï¼Œå’Œ <a href="http://svip.iocoder.cn/Netty/Pipeline-4-outbound/">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” ChannelPipelineï¼ˆå››ï¼‰ä¹‹ Outbound äº‹ä»¶çš„ä¼ æ’­ã€‹</a> åˆ†äº«çš„ <strong>bind</strong> äº‹ä»¶åœ¨ pipeline ä¸­çš„ä¼ æ’­æ˜¯<strong>åŸºæœ¬ä¸€è‡´</strong>çš„ã€‚</li>
<li>éšç€ flush <strong>äº‹ä»¶</strong>ä¸æ–­çš„å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¼ æ’­ï¼Œæœ€ç»ˆä¼šåˆ°è¾¾ HeadContext èŠ‚ç‚¹ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5. HeadContextã€</a> ã€‚</li>
</ul>
</li>
<li>ç¬¬ 16 è¡Œï¼š<strong>ä¸åœ¨</strong> EventLoop çš„çº¿ç¨‹ä¸­ã€‚<ul>
<li>ç¬¬ 12 è‡³ 21 è¡Œï¼šåˆ›å»º flush ä»»åŠ¡ã€‚è¯¥ä»»åŠ¡çš„å†…éƒ¨çš„è°ƒç”¨ã€ç¬¬ 18 è¡Œã€‘çš„ä»£ç ï¼Œå’Œã€ç¬¬ 9 è¡Œã€‘çš„ä»£ç æ˜¯<strong>ä¸€è‡´</strong>çš„ã€‚</li>
<li>ç¬¬ 23 è¡Œï¼šè°ƒç”¨ <code>#safeExecute(executor, task, promise, m)</code> æ–¹æ³•ï¼Œæäº¤åˆ° EventLoop çš„çº¿ç¨‹ä¸­ï¼Œæ‰§è¡Œè¯¥ä»»åŠ¡ã€‚ä»è€Œå®ç°ï¼Œ<strong>åœ¨</strong> EventLoop çš„çº¿ç¨‹ä¸­ï¼Œæ‰§è¡Œ flush äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li>
</ul>
</li>
</ul>
<h1 id="5-HeadContext"><a href="#5-HeadContext" class="headerlink" title="5. HeadContext"></a>5. HeadContext</h1><p>åœ¨ pipeline ä¸­ï¼Œflush äº‹ä»¶æœ€ç»ˆä¼šåˆ°è¾¾ HeadContext èŠ‚ç‚¹ã€‚è€Œ HeadContext çš„ <code>#flush()</code> æ–¹æ³•ï¼Œä¼šå¤„ç†è¯¥äº‹ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    unsafe.flush();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨æ–¹æ³•å†…éƒ¨ï¼Œä¼šè°ƒç”¨ <code>AbstractUnsafe#flush()</code> æ–¹æ³•ï¼Œåˆ·æ–°<strong>å†…å­˜é˜Ÿåˆ—</strong>ï¼Œå°†å…¶ä¸­çš„æ•°æ®å†™å…¥åˆ°å¯¹ç«¯ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ6. AbstractUnsafeã€</a> ã€‚</li>
</ul>
<h1 id="6-AbstractUnsafe"><a href="#6-AbstractUnsafe" class="headerlink" title="6. AbstractUnsafe"></a>6. AbstractUnsafe</h1><p><code>AbstractUnsafe#flush()</code> æ–¹æ³•ï¼Œåˆ·æ–°<strong>å†…å­˜é˜Ÿåˆ—</strong>ï¼Œå°†å…¶ä¸­çš„æ•°æ®å†™å…¥åˆ°å¯¹ç«¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">3</span>:     assertEventLoop();</span><br><span class="line"> <span class="number">4</span>: </span><br><span class="line"> <span class="number">5</span>:     <span class="comment">// å†…å­˜é˜Ÿåˆ—ä¸º null ï¼Œä¸€èˆ¬æ˜¯ Channel å·²ç»å…³é—­ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›ã€‚</span></span><br><span class="line"> <span class="number">6</span>:     ChannelOutboundBuffer outboundBuffer = <span class="keyword">this</span>.outboundBuffer;</span><br><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (outboundBuffer == <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">8</span>:         <span class="keyword">return</span>;</span><br><span class="line"> <span class="number">9</span>:     }</span><br><span class="line"><span class="number">10</span>: </span><br><span class="line"><span class="number">11</span>:     <span class="comment">// æ ‡è®°å†…å­˜é˜Ÿåˆ—å¼€å§‹ flush</span></span><br><span class="line"><span class="number">12</span>:     outboundBuffer.addFlush();</span><br><span class="line"><span class="number">13</span>:     <span class="comment">// æ‰§è¡Œ flush</span></span><br><span class="line"><span class="number">14</span>:     flush0();</span><br><span class="line"><span class="number">15</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 5 è‡³ 9 è¡Œï¼šå†…å­˜é˜Ÿåˆ—ä¸º <code>null</code> ï¼Œä¸€èˆ¬æ˜¯ Channel <strong>å·²ç»å…³é—­</strong>ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›ã€‚</li>
<li>ç¬¬ 12 è¡Œï¼šè°ƒç”¨ <code>ChannelOutboundBuffer#addFlush()</code> æ–¹æ³•ï¼Œæ ‡è®°å†…å­˜é˜Ÿåˆ—å¼€å§‹ <strong>flush</strong> ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8.4 addFlushã€</a> ã€‚</li>
<li><p>ç¬¬ 14 è¡Œï¼šè°ƒç”¨ <code>#flush0()</code> æ–¹æ³•ï¼Œæ‰§è¡Œ flush æ“ä½œã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦æ­£åœ¨ flush ä¸­ï¼Œå³æ­£åœ¨è°ƒç”¨ {<span class="doctag">@link</span> #flush0()} ä¸­</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> inFlush0;</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</span><br><span class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">flush0</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="number">3</span>:     <span class="comment">// æ­£åœ¨ flush ä¸­ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›ã€‚</span></span><br><span class="line">  <span class="number">4</span>:     <span class="keyword">if</span> (inFlush0) {</span><br><span class="line">  <span class="number">5</span>:         <span class="comment">// Avoid re-entrance</span></span><br><span class="line">  <span class="number">6</span>:         <span class="keyword">return</span>;</span><br><span class="line">  <span class="number">7</span>:     }</span><br><span class="line">  <span class="number">8</span>: </span><br><span class="line">  <span class="number">9</span>:     <span class="comment">// å†…å­˜é˜Ÿåˆ—ä¸º null ï¼Œä¸€èˆ¬æ˜¯ Channel å·²ç»å…³é—­ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›ã€‚</span></span><br><span class="line"> <span class="number">10</span>:     <span class="comment">// å†…å­˜é˜Ÿåˆ—ä¸ºç©ºï¼Œæ— éœ€ flush ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›</span></span><br><span class="line"> <span class="number">11</span>:     <span class="keyword">final</span> ChannelOutboundBuffer outboundBuffer = <span class="keyword">this</span>.outboundBuffer;</span><br><span class="line"> <span class="number">12</span>:     <span class="keyword">if</span> (outboundBuffer == <span class="keyword">null</span> || outboundBuffer.isEmpty()) {</span><br><span class="line"> <span class="number">13</span>:         <span class="keyword">return</span>;</span><br><span class="line"> <span class="number">14</span>:     }</span><br><span class="line"> <span class="number">15</span>: </span><br><span class="line"> <span class="number">16</span>:     <span class="comment">// æ ‡è®°æ­£åœ¨ flush ä¸­ã€‚</span></span><br><span class="line"> <span class="number">17</span>:     inFlush0 = <span class="keyword">true</span>;</span><br><span class="line"> <span class="number">18</span>: </span><br><span class="line"> <span class="number">19</span>:     <span class="comment">// è‹¥æœªæ¿€æ´»ï¼Œé€šçŸ¥ flush å¤±è´¥</span></span><br><span class="line"> <span class="number">20</span>:     <span class="comment">// Mark all pending write requests as failure if the channel is inactive.</span></span><br><span class="line"> <span class="number">21</span>:     <span class="keyword">if</span> (!isActive()) {</span><br><span class="line"> <span class="number">22</span>:         <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">23</span>:             <span class="keyword">if</span> (isOpen()) {</span><br><span class="line"> <span class="number">24</span>:                 outboundBuffer.failFlushed(FLUSH0_NOT_YET_CONNECTED_EXCEPTION, <span class="keyword">true</span>);</span><br><span class="line"> <span class="number">25</span>:             } <span class="keyword">else</span> {</span><br><span class="line"> <span class="number">26</span>:                 <span class="comment">// Do not trigger channelWritabilityChanged because the channel is closed already.</span></span><br><span class="line"> <span class="number">27</span>:                 outboundBuffer.failFlushed(FLUSH0_CLOSED_CHANNEL_EXCEPTION, <span class="keyword">false</span>);</span><br><span class="line"> <span class="number">28</span>:             }</span><br><span class="line"> <span class="number">29</span>:         } <span class="keyword">finally</span> {</span><br><span class="line"> <span class="number">30</span>:             <span class="comment">// æ ‡è®°ä¸åœ¨ flush ä¸­ã€‚</span></span><br><span class="line"> <span class="number">31</span>:             inFlush0 = <span class="keyword">false</span>;</span><br><span class="line"> <span class="number">32</span>:         }</span><br><span class="line"> <span class="number">33</span>:         <span class="keyword">return</span>;</span><br><span class="line"> <span class="number">34</span>:     }</span><br><span class="line"> <span class="number">35</span>: </span><br><span class="line"> <span class="number">36</span>:     <span class="comment">// æ‰§è¡ŒçœŸæ­£çš„å†™å…¥åˆ°å¯¹ç«¯</span></span><br><span class="line"> <span class="number">37</span>:     <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">38</span>:         doWrite(outboundBuffer);</span><br><span class="line"> <span class="number">39</span>:     } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line"> <span class="number">40</span>:         <span class="comment">// TODO èŠ‹è‰¿ ç»†èŠ‚</span></span><br><span class="line"> <span class="number">41</span>:         <span class="keyword">if</span> (t <span class="keyword">instanceof</span> IOException &amp;&amp; config().isAutoClose()) {</span><br><span class="line"> <span class="number">42</span>:             <span class="comment">/**</span></span><br><span class="line"><span class="comment"> 43:              * Just call {<span class="doctag">@link</span> #close(ChannelPromise, Throwable, boolean)} here which will take care of</span></span><br><span class="line"><span class="comment"> 44:              * failing all flushed messages and also ensure the actual close of the underlying transport</span></span><br><span class="line"><span class="comment"> 45:              * will happen before the promises are notified.</span></span><br><span class="line"><span class="comment"> 46:              *</span></span><br><span class="line"><span class="comment"> 47:              * This is needed as otherwise {<span class="doctag">@link</span> #isActive()} , {<span class="doctag">@link</span> #isOpen()} and {<span class="doctag">@link</span> #isWritable()}</span></span><br><span class="line"><span class="comment"> 48:              * may still return {<span class="doctag">@code</span> true} even if the channel should be closed as result of the exception.</span></span><br><span class="line"><span class="comment"> 49:              */</span></span><br><span class="line"> <span class="number">50</span>:             close(voidPromise(), t, FLUSH0_CLOSED_CHANNEL_EXCEPTION, <span class="keyword">false</span>);</span><br><span class="line"> <span class="number">51</span>:         } <span class="keyword">else</span> {</span><br><span class="line"> <span class="number">52</span>:             <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">53</span>:                 shutdownOutput(voidPromise(), t);</span><br><span class="line"> <span class="number">54</span>:             } <span class="keyword">catch</span> (Throwable t2) {</span><br><span class="line"> <span class="number">55</span>:                 close(voidPromise(), t2, FLUSH0_CLOSED_CHANNEL_EXCEPTION, <span class="keyword">false</span>);</span><br><span class="line"> <span class="number">56</span>:             }</span><br><span class="line"> <span class="number">57</span>:         }</span><br><span class="line"> <span class="number">58</span>:     } <span class="keyword">finally</span> {</span><br><span class="line"> <span class="number">59</span>:         <span class="comment">// æ ‡è®°ä¸åœ¨ flush ä¸­ã€‚</span></span><br><span class="line"> <span class="number">60</span>:         inFlush0 = <span class="keyword">false</span>;</span><br><span class="line"> <span class="number">61</span>:     }</span><br><span class="line"> <span class="number">62</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>inFlush0</code> å­—æ®µï¼Œæ˜¯å¦æ­£åœ¨ flush ä¸­ï¼Œå³æ­£åœ¨è°ƒç”¨ <code>#flush0()</code> ä¸­ã€‚</li>
<li>ç¬¬ 3 è‡³ 7 è¡Œï¼šæ­£åœ¨ flush ä¸­ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›ã€‚</li>
<li>ç¬¬ 9 è‡³ 14 è¡Œï¼š<ul>
<li><code>outboundBuffer == null</code> ï¼Œå†…å­˜é˜Ÿåˆ—ä¸º <code>null</code> ï¼Œä¸€èˆ¬æ˜¯ Channel å·²ç»<strong>å…³é—­</strong>ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›ã€‚</li>
<li><code>outboundBuffer.isEmpty()</code> ï¼Œå†…å­˜é˜Ÿåˆ—ä¸ºç©ºï¼Œæ— éœ€ flush ï¼Œæ‰€ä»¥ç›´æ¥è¿”å›ã€‚</li>
</ul>
</li>
<li>ç¬¬ 17 è¡Œï¼šè®¾ç½® <code>inFlush0</code> ä¸º <code>true</code> ï¼Œè¡¨ç¤ºæ­£åœ¨ flush ä¸­ã€‚</li>
<li>ç¬¬ 19 è‡³ 34 è¡Œï¼šè°ƒç”¨ <code>#isActive()</code> æ–¹æ³•ï¼Œå‘ç° Channel <strong>æœªæ¿€æ´»</strong>ï¼Œåœ¨æ ¹æ® Channel <strong>æ˜¯å¦æ‰“å¼€</strong>ï¼Œè°ƒç”¨ <code>ChannelOutboundBuffer#failFlushed(Throwable cause, boolean notify)</code> æ–¹æ³•ï¼Œé€šçŸ¥ flush å¤±è´¥<strong>å¼‚å¸¸</strong>ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8.6 failFlushedã€</a> ã€‚<ul>
<li>ç¬¬ 29 è‡³ 33 è¡Œï¼šæœ€ç»ˆï¼Œè®¾ç½® <code>inFlush0</code> ä¸º <code>false</code> ï¼Œè¡¨ç¤ºç»“æŸ flush æ“ä½œï¼Œæœ€å <code>return</code> è¿”å›ã€‚</li>
</ul>
</li>
<li>ç¬¬ 38 è¡Œï¼šè°ƒç”¨ <code>AbstractChannel#doWrite(outboundBuffer)</code> æ–¹æ³•ï¼Œ<strong>æ‰§è¡ŒçœŸæ­£çš„å†™å…¥åˆ°å¯¹ç«¯</strong>ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ7. NioSocketChannelã€</a> ã€‚<ul>
<li>ç¬¬ 39 è‡³ 57 è¡Œï¼šTODO èŠ‹è‰¿ ç»†èŠ‚</li>
<li>ç¬¬ 58 è‡³ 61 è¡Œï¼šåŒã€ç¬¬ 29 è‡³ 33ã€‘çš„ä»£ç å’Œç›®çš„ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p>å®é™…ä¸Šï¼ŒAbstractNioUnsafe <strong>é‡å†™</strong>äº† <code>#flush0()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">flush0</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// Flush immediately only when there's no pending flush.</span></span><br><span class="line">    <span class="comment">// If there's a pending flush operation, event loop will call forceFlush() later,</span></span><br><span class="line">    <span class="comment">// and thus there's no need to call it now.</span></span><br><span class="line">    <span class="keyword">if</span> (!isFlushPending()) {</span><br><span class="line">        <span class="keyword">super</span>.flush0();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>åœ¨æ‰§è¡Œçˆ¶ç±» AbstractUnsafe çš„ <code>#flush0()</code> æ–¹æ³•æ—¶ï¼Œå…ˆè°ƒç”¨ <code>AbstractNioUnsafe#isFlushPending()</code> åˆ¤æ–­ï¼Œæ˜¯å¦å·²ç»å¤„äº flush <strong>å‡†å¤‡</strong>ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isFlushPending</span><span class="params">()</span> </span>{</span><br><span class="line">    SelectionKey selectionKey = selectionKey();</span><br><span class="line">    <span class="keyword">return</span> selectionKey.isValid() <span class="comment">// åˆæ³•</span></span><br><span class="line">            &amp;&amp; (selectionKey.interestOps() &amp; SelectionKey.OP_WRITE) != <span class="number">0</span>; <span class="comment">// å¯¹ SelectionKey.OP_WRITE äº‹ä»¶ä¸æ„Ÿå…´è¶£ã€‚</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ˜¯ä¸æ˜¯æœ‰ç‚¹æ‡µ x ï¼Ÿåœ¨æ–‡åˆï¼Œæˆ‘ä»¬æåˆ°ï¼šâ€œæ‰€ä»¥åœ¨ Netty çš„å®ç°ä¸­ï¼Œé»˜è®¤ Channel æ˜¯<strong>å¯å†™</strong>çš„ï¼Œå½“å†™å…¥å¤±è´¥çš„æ—¶å€™ï¼Œå†å»æ³¨å†Œ <code>SelectionKey.OP_WRITE</code> äº‹ä»¶ã€‚è¿™æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿåœ¨ <code>#flush()</code> æ–¹æ³•ä¸­ï¼Œå¦‚æœå†™å…¥æ•°æ®åˆ° Channel å¤±è´¥ï¼Œä¼šé€šè¿‡æ³¨å†Œ <code>SelectionKey.OP_WRITE</code> äº‹ä»¶ï¼Œç„¶ååœ¨è½®è¯¢åˆ° Channel <strong>å¯å†™</strong> æ—¶ï¼Œå†â€œå›è°ƒâ€ <code>#forceFlush()</code> æ–¹æ³•â€ã€‚</li>
<li>è¿™å°±æ˜¯è¿™æ®µä»£ç çš„ç›®çš„ï¼Œå¦‚æœå¤„äºå¯¹ <code>SelectionKey.OP_WRITE</code> äº‹ä»¶æ„Ÿå…´è¶£ï¼Œè¯´æ˜ Channel æ­¤æ—¶æ˜¯<strong>ä¸å¯å†™</strong>çš„ï¼Œé‚£ä¹ˆè°ƒç”¨çˆ¶ç±» AbstractUnsafe çš„ <code>#flush0()</code> æ–¹æ³•ï¼Œ<strong>ä¹Ÿæ²¡æœ‰æ„ä¹‰</strong>ï¼Œæ‰€ä»¥å°±ä¸è°ƒç”¨ã€‚</li>
<li>ğŸ˜ˆ é€»è¾‘ä¸Šï¼Œç•¥å¾®æœ‰ç‚¹å¤æ‚ï¼Œèƒ–å‹å¥½å¥½ç†è§£ä¸‹ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="7-NioSocketChannel"><a href="#7-NioSocketChannel" class="headerlink" title="7. NioSocketChannel"></a>7. NioSocketChannel</h1><p><code>AbstractChannel#doWrite(ChannelOutboundBuffer in)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œ<strong>æ‰§è¡ŒçœŸæ­£çš„å†™å…¥åˆ°å¯¹ç«¯</strong>ã€‚å®šä¹‰åœ¨ AbstractChannel <strong>æŠ½è±¡</strong>ç±»ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Flush the content of the given buffer to the remote peer.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">doWrite</span><span class="params">(ChannelOutboundBuffer in)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p>NioSocketChannel å¯¹è¯¥<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doWrite</span><span class="params">(ChannelOutboundBuffer in)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"> <span class="number">3</span>:     SocketChannel ch = javaChannel();</span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// è·å¾—è‡ªæ—‹å†™å…¥æ¬¡æ•°</span></span><br><span class="line"> <span class="number">5</span>:     <span class="keyword">int</span> writeSpinCount = config().getWriteSpinCount();</span><br><span class="line"> <span class="number">6</span>:     <span class="keyword">do</span> {</span><br><span class="line"> <span class="number">7</span>:         <span class="comment">// å†…å­˜é˜Ÿåˆ—ä¸ºç©ºï¼Œç»“æŸå¾ªç¯ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (in.isEmpty()) {</span><br><span class="line"> <span class="number">9</span>:             <span class="comment">// å–æ¶ˆå¯¹ SelectionKey.OP_WRITE çš„æ„Ÿå…´è¶£</span></span><br><span class="line"><span class="number">10</span>:             <span class="comment">// All written so clear OP_WRITE</span></span><br><span class="line"><span class="number">11</span>:             clearOpWrite();</span><br><span class="line"><span class="number">12</span>:             <span class="comment">// Directly return here so incompleteWrite(...) is not called.</span></span><br><span class="line"><span class="number">13</span>:             <span class="keyword">return</span>;</span><br><span class="line"><span class="number">14</span>:         }</span><br><span class="line"><span class="number">15</span>: </span><br><span class="line"><span class="number">16</span>:         <span class="comment">// è·å¾—æ¯æ¬¡å†™å…¥çš„æœ€å¤§å­—èŠ‚æ•°</span></span><br><span class="line"><span class="number">17</span>:         <span class="comment">// Ensure the pending writes are made of ByteBufs only.</span></span><br><span class="line"><span class="number">18</span>:         <span class="keyword">int</span> maxBytesPerGatheringWrite = ((NioSocketChannelConfig) config).getMaxBytesPerGatheringWrite();</span><br><span class="line"><span class="number">19</span>:         <span class="comment">// ä»å†…å­˜é˜Ÿåˆ—ä¸­ï¼Œè·å¾—è¦å†™å…¥çš„ ByteBuffer æ•°ç»„</span></span><br><span class="line"><span class="number">20</span>:         ByteBuffer[] nioBuffers = in.nioBuffers(<span class="number">1024</span>, maxBytesPerGatheringWrite);</span><br><span class="line"><span class="number">21</span>:         <span class="comment">// å†™å…¥çš„ ByteBuffer æ•°ç»„çš„ä¸ªæ•°</span></span><br><span class="line"><span class="number">22</span>:         <span class="keyword">int</span> nioBufferCnt = in.nioBufferCount();</span><br><span class="line"><span class="number">23</span>: </span><br><span class="line"><span class="number">24</span>:         <span class="comment">// å†™å…¥ ByteBuffer æ•°ç»„ï¼Œåˆ°å¯¹ç«¯</span></span><br><span class="line"><span class="number">25</span>:         <span class="comment">// Always us nioBuffers() to workaround data-corruption.</span></span><br><span class="line"><span class="number">26</span>:         <span class="comment">// See https://github.com/netty/netty/issues/2761</span></span><br><span class="line"><span class="number">27</span>:         <span class="keyword">switch</span> (nioBufferCnt) {</span><br><span class="line"><span class="number">28</span>:             <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line"><span class="number">29</span>:                 <span class="comment">// èŠ‹è‰¿ TODO 1014 æ‰£ doWrite0 çš„ç»†èŠ‚</span></span><br><span class="line"><span class="number">30</span>:                 <span class="comment">// We have something else beside ByteBuffers to write so fallback to normal writes.</span></span><br><span class="line"><span class="number">31</span>:                 writeSpinCount -= doWrite0(in);</span><br><span class="line"><span class="number">32</span>:                 <span class="keyword">break</span>;</span><br><span class="line"><span class="number">33</span>:             <span class="keyword">case</span> <span class="number">1</span>: {</span><br><span class="line"><span class="number">34</span>:                 <span class="comment">// Only one ByteBuf so use non-gathering write</span></span><br><span class="line"><span class="number">35</span>:                 <span class="comment">// Zero length buffers are not added to nioBuffers by ChannelOutboundBuffer, so there is no need</span></span><br><span class="line"><span class="number">36</span>:                 <span class="comment">// to check if the total size of all the buffers is non-zero.</span></span><br><span class="line"><span class="number">37</span>:                 ByteBuffer buffer = nioBuffers[<span class="number">0</span>];</span><br><span class="line"><span class="number">38</span>:                 <span class="keyword">int</span> attemptedBytes = buffer.remaining();</span><br><span class="line"><span class="number">39</span>:                 <span class="comment">// æ‰§è¡Œ NIO write è°ƒç”¨ï¼Œå†™å…¥å•ä¸ª ByteBuffer å¯¹è±¡åˆ°å¯¹ç«¯</span></span><br><span class="line"><span class="number">40</span>:                 <span class="keyword">final</span> <span class="keyword">int</span> localWrittenBytes = ch.write(buffer);</span><br><span class="line"><span class="number">41</span>:                 <span class="comment">// å†™å…¥å­—èŠ‚å°äºç­‰äº 0 ï¼Œè¯´æ˜ NIO Channel ä¸å¯å†™ï¼Œæ‰€ä»¥æ³¨å†Œ SelectionKey.OP_WRITE ï¼Œç­‰å¾… NIO Channel å¯å†™ï¼Œå¹¶è¿”å›ä»¥ç»“æŸå¾ªç¯</span></span><br><span class="line"><span class="number">42</span>:                 <span class="keyword">if</span> (localWrittenBytes &lt;= <span class="number">0</span>) {</span><br><span class="line"><span class="number">43</span>:                     incompleteWrite(<span class="keyword">true</span>);</span><br><span class="line"><span class="number">44</span>:                     <span class="keyword">return</span>;</span><br><span class="line"><span class="number">45</span>:                 }</span><br><span class="line"><span class="number">46</span>:                 <span class="comment">// TODO èŠ‹è‰¿ è°ƒæ•´æ¯æ¬¡å†™å…¥çš„æœ€å¤§å­—èŠ‚æ•°</span></span><br><span class="line"><span class="number">47</span>:                 adjustMaxBytesPerGatheringWrite(attemptedBytes, localWrittenBytes, maxBytesPerGatheringWrite);</span><br><span class="line"><span class="number">48</span>:                 <span class="comment">// ä»å†…å­˜é˜Ÿåˆ—ä¸­ï¼Œç§»é™¤å·²ç»å†™å…¥çš„æ•°æ®( æ¶ˆæ¯ )</span></span><br><span class="line"><span class="number">49</span>:                 in.removeBytes(localWrittenBytes);</span><br><span class="line"><span class="number">50</span>:                 <span class="comment">// å†™å…¥æ¬¡æ•°å‡ä¸€</span></span><br><span class="line"><span class="number">51</span>:                 --writeSpinCount;</span><br><span class="line"><span class="number">52</span>:                 <span class="keyword">break</span>;</span><br><span class="line"><span class="number">53</span>:             }</span><br><span class="line"><span class="number">54</span>:             <span class="keyword">default</span>: {</span><br><span class="line"><span class="number">55</span>:                 <span class="comment">// Zero length buffers are not added to nioBuffers by ChannelOutboundBuffer, so there is no need</span></span><br><span class="line"><span class="number">56</span>:                 <span class="comment">// to check if the total size of all the buffers is non-zero.</span></span><br><span class="line"><span class="number">57</span>:                 <span class="comment">// We limit the max amount to int above so cast is safe</span></span><br><span class="line"><span class="number">58</span>:                 <span class="keyword">long</span> attemptedBytes = in.nioBufferSize();</span><br><span class="line"><span class="number">59</span>:                 <span class="comment">// æ‰§è¡Œ NIO write è°ƒç”¨ï¼Œå†™å…¥å¤šä¸ª ByteBuffer åˆ°å¯¹ç«¯</span></span><br><span class="line"><span class="number">60</span>:                 <span class="keyword">final</span> <span class="keyword">long</span> localWrittenBytes = ch.write(nioBuffers, <span class="number">0</span>, nioBufferCnt);</span><br><span class="line"><span class="number">61</span>:                 <span class="comment">// å†™å…¥å­—èŠ‚å°äºç­‰äº 0 ï¼Œè¯´æ˜ NIO Channel ä¸å¯å†™ï¼Œæ‰€ä»¥æ³¨å†Œ SelectionKey.OP_WRITE ï¼Œç­‰å¾… NIO Channel å¯å†™ï¼Œå¹¶è¿”å›ä»¥ç»“æŸå¾ªç¯</span></span><br><span class="line"><span class="number">62</span>:                 <span class="keyword">if</span> (localWrittenBytes &lt;= <span class="number">0</span>) {</span><br><span class="line"><span class="number">63</span>:                     incompleteWrite(<span class="keyword">true</span>);</span><br><span class="line"><span class="number">64</span>:                     <span class="keyword">return</span>;</span><br><span class="line"><span class="number">65</span>:                 }</span><br><span class="line"><span class="number">66</span>:                 <span class="comment">// TODO èŠ‹è‰¿ è°ƒæ•´æ¯æ¬¡å†™å…¥çš„æœ€å¤§å­—èŠ‚æ•°</span></span><br><span class="line"><span class="number">67</span>:                 <span class="comment">// Casting to int is safe because we limit the total amount of data in the nioBuffers to int above.</span></span><br><span class="line"><span class="number">68</span>:                 adjustMaxBytesPerGatheringWrite((<span class="keyword">int</span>) attemptedBytes, (<span class="keyword">int</span>) localWrittenBytes, maxBytesPerGatheringWrite);</span><br><span class="line"><span class="number">69</span>:                 <span class="comment">// ä»å†…å­˜é˜Ÿåˆ—ä¸­ï¼Œç§»é™¤å·²ç»å†™å…¥çš„æ•°æ®( æ¶ˆæ¯ )</span></span><br><span class="line"><span class="number">70</span>:                 in.removeBytes(localWrittenBytes);</span><br><span class="line"><span class="number">71</span>:                 <span class="comment">// å†™å…¥æ¬¡æ•°å‡ä¸€</span></span><br><span class="line"><span class="number">72</span>:                 --writeSpinCount;</span><br><span class="line"><span class="number">73</span>:                 <span class="keyword">break</span>;</span><br><span class="line"><span class="number">74</span>:             }</span><br><span class="line"><span class="number">75</span>:         }</span><br><span class="line"><span class="number">76</span>:     } <span class="keyword">while</span> (writeSpinCount &gt; <span class="number">0</span>); <span class="comment">// å¾ªç¯è‡ªæ—‹å†™å…¥</span></span><br><span class="line"><span class="number">77</span>: </span><br><span class="line"><span class="number">78</span>:     <span class="comment">// å†…å­˜é˜Ÿåˆ—ä¸­çš„æ•°æ®æœªå®Œå…¨å†™å…¥ï¼Œè¯´æ˜ NIO Channel ä¸å¯å†™ï¼Œæ‰€ä»¥æ³¨å†Œ SelectionKey.OP_WRITE ï¼Œç­‰å¾… NIO Channel å¯å†™</span></span><br><span class="line"><span class="number">79</span>:     incompleteWrite(writeSpinCount &lt; <span class="number">0</span>);</span><br><span class="line"><span class="number">80</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šè°ƒç”¨ <code>#javaChannel()</code> æ–¹æ³•ï¼Œè·å¾— Java NIO <strong>åŸç”Ÿ</strong> SocketChannel ã€‚</li>
<li><p>ç¬¬ 5 è¡Œï¼šè°ƒç”¨ <code>ChannelConfig#getWriteSpinCount()</code> æ–¹æ³•ï¼Œè·å¾—<strong>è‡ªæ—‹</strong>å†™å…¥æ¬¡æ•° N ã€‚åœ¨ã€ç¬¬ 6 è‡³ 76 è¡Œã€‘çš„ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸æ–­<strong>è‡ªæ—‹</strong>å†™å…¥ N æ¬¡ï¼Œç›´åˆ°å®Œæˆå†™å…¥ç»“æŸã€‚å…³äºè¯¥é…ç½®é¡¹ï¼Œå®˜æ–¹æ³¨é‡Šå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns the maximum loop count for a write operation until {<span class="doctag">@link</span> WritableByteChannel#write(ByteBuffer)} returns a non-zero value.</span></span><br><span class="line"><span class="comment"> * It is similar to what a spin lock is used for in concurrency programming.</span></span><br><span class="line"><span class="comment"> * It improves memory utilization and write throughput depending on the platform that JVM runs on.  The default value is {<span class="doctag">@code</span> 16}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getWriteSpinCount</span><span class="params">()</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é»˜è®¤å€¼ä¸º <code>DefaultChannelConfig.writeSpinCount = 16</code> ï¼Œå¯é…ç½®ä¿®æ”¹ï¼Œä¸€èˆ¬ä¸éœ€è¦ã€‚</li>
</ul>
</li>
<li>ç¬¬ 6 è‡³ 76 è¡Œï¼šä¸æ–­<strong>è‡ªæ—‹</strong>å†™å…¥ N æ¬¡ï¼Œç›´åˆ°å®Œæˆå†™å…¥ç»“æŸã€‚</li>
<li><p>ç¬¬ 8 è¡Œï¼šè°ƒç”¨ <code>ChannelOutboundBuffer#isEmpty()</code> æ–¹æ³•ï¼Œå†…å­˜é˜Ÿåˆ—ä¸ºç©ºï¼Œç»“æŸå¾ªç¯ï¼Œç›´æ¥è¿”å›ã€‚</p>
<ul>
<li><p>ç¬¬ 10 è¡Œï¼šå› ä¸ºåœ¨ Channel <strong>ä¸å¯å†™</strong>çš„æ—¶å€™ï¼Œä¼šæ³¨å†Œ <code>SelectionKey.OP_WRITE</code> ï¼Œç­‰å¾… NIO Channel å¯å†™ã€‚è€Œåä¼šâ€å›è°ƒâ€ <code>#forceFlush()</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…éƒ¨ä¹Ÿä¼šè°ƒç”¨ <code>#doWrite(ChannelOutboundBuffer in)</code> æ–¹æ³•ã€‚æ‰€ä»¥åœ¨å®Œæˆå†…éƒ¨é˜Ÿåˆ—çš„æ•°æ®å‘å¯¹ç«¯å†™å…¥æ—¶å€™ï¼Œéœ€è¦è°ƒç”¨ <code>#clearOpWrite()</code>  æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clearOpWrite</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> SelectionKey key = selectionKey();</span><br><span class="line">    <span class="comment">// Check first if the key is still valid as it may be canceled as part of the deregistration</span></span><br><span class="line">    <span class="comment">// from the EventLoop</span></span><br><span class="line">    <span class="comment">// See https://github.com/netty/netty/issues/2104</span></span><br><span class="line">    <span class="keyword">if</span> (!key.isValid()) { <span class="comment">// åˆæ³•</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> interestOps = key.interestOps();</span><br><span class="line">    <span class="comment">// è‹¥æ³¨å†Œäº† SelectionKey.OP_WRITE ï¼Œåˆ™è¿›è¡Œå–æ¶ˆ</span></span><br><span class="line">    <span class="keyword">if</span> ((interestOps &amp; SelectionKey.OP_WRITE) != <span class="number">0</span>) {</span><br><span class="line">        key.interestOps(interestOps &amp; ~SelectionKey.OP_WRITE);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ğŸ˜ˆ èƒ–å‹çœ‹ä¸‹ä»£ç æ³¨é‡Šã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 18 è¡Œï¼šè°ƒç”¨ <code>NioSocketChannelConfig#getMaxBytesPerGatheringWrite()</code> æ–¹æ³•ï¼Œè·å¾—æ¯æ¬¡å†™å…¥çš„æœ€å¤§å­—èŠ‚æ•°ã€‚// TODO èŠ‹è‰¿ è°ƒæ•´æ¯æ¬¡å†™å…¥çš„æœ€å¤§å­—èŠ‚æ•°</li>
<li>ç¬¬ 20 è¡Œï¼šè°ƒç”¨ <code>ChannelOutboundBuffer#nioBuffers(int maxCount, long maxBytes)</code> æ–¹æ³•ï¼Œä»å†…å­˜é˜Ÿåˆ—ä¸­ï¼Œè·å¾—è¦å†™å…¥çš„ ByteBuffer æ•°ç»„ã€‚<strong>æ³¨æ„</strong>ï¼Œå¦‚æœå†…å­˜é˜Ÿåˆ—ä¸­æ•°æ®é‡å¾ˆå¤§ï¼Œå¯èƒ½è·å¾—çš„ä»…ä»…æ˜¯ä¸€éƒ¨åˆ†æ•°æ®ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8.5 nioBuffersã€</a> ã€‚<ul>
<li>ç¬¬ 22 è¡Œï¼šè·å¾—å†™å…¥çš„ ByteBuffer æ•°ç»„çš„ä¸ªæ•°ã€‚ä¸ºä»€ä¹ˆä¸ç›´æ¥è°ƒç”¨æ•°ç»„çš„ <code>#length()</code> æ–¹æ³•å‘¢ï¼Ÿå› ä¸ºè¿”å›çš„ ByteBuffer æ•°ç»„æ˜¯<strong>é¢„å…ˆç”Ÿæˆçš„æ•°ç»„ç¼“å­˜</strong>ï¼Œå­˜åœ¨ä¸æ–­é‡ç”¨çš„æƒ…å†µï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥ä½¿ç”¨ <code>#length()</code> æ–¹æ³•ï¼Œè€Œæ˜¯è¦è°ƒç”¨ <code>ChannelOutboundBuffer#nioBufferCount()</code> æ–¹æ³•ï¼Œè·å¾—å†™å…¥çš„ ByteBuffer æ•°ç»„çš„ä¸ªæ•°ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8.5 nioBuffersã€</a> ã€‚</li>
<li>åç»­æ ¹æ® <code>nioBufferCnt</code> çš„æ•°å€¼ï¼Œåˆ†æˆ<strong>ä¸‰ç§</strong>æƒ…å†µã€‚</li>
</ul>
</li>
<li><strong>(ã¥ï¿£3ï¿£)ã¥â•­â¤ï½ ç¬¬ä¸€ç§</strong>ï¼Œ<code>nioBufferCnt = 0</code> ã€‚</li>
<li>èŠ‹è‰¿ TODO 1014 æ‰£ doWrite0 çš„ç»†èŠ‚ï¼Œåº”è¯¥æ˜¯å†…éƒ¨çš„æ•°æ®ä¸º FileRegion ï¼Œå¯ä»¥æš‚æ—¶æ— è§†ï¼Œä¸å½±å“æœ¬æ–‡ç†è§£ã€‚</li>
<li><strong>(ã¥ï¿£3ï¿£)ã¥â•­â¤ï½ ç¬¬äºŒç§</strong>ï¼Œ<code>nioBufferCnt = 1</code> ã€‚</li>
<li>ç¬¬ 40 è¡Œï¼šè°ƒç”¨ Java <strong>åŸç”Ÿ</strong> <code>SocketChannel#write(ByteBuffer buffer)</code> æ–¹æ³•ï¼Œæ‰§è¡Œ NIO write è°ƒç”¨ï¼Œå†™å…¥<strong>å•ä¸ª</strong> ByteBuffer å¯¹è±¡åˆ°å¯¹ç«¯ã€‚</li>
<li><p>ç¬¬ 42 è¡Œï¼šå†™å…¥å­—èŠ‚å°äºç­‰äº 0 ï¼Œè¯´æ˜ NIO Channel <strong>ä¸å¯å†™</strong>ï¼Œæ‰€ä»¥æ³¨å†Œ <code>SelectionKey.OP_WRITE</code> ï¼Œç­‰å¾… NIO Channel <strong>å¯å†™</strong>ï¼Œå¹¶è¿”å›ä»¥ç»“æŸå¾ªç¯ã€‚</p>
<ul>
<li><p>ç¬¬ 43 è¡Œï¼šè°ƒç”¨ <code>AbstractNioByteChannel#incompleteWrite(true)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">incompleteWrite</span><span class="params">(<span class="keyword">boolean</span> setOpWrite)</span> </span>{</span><br><span class="line">    <span class="comment">// Did not write completely.</span></span><br><span class="line">    <span class="comment">// true ï¼Œæ³¨å†Œå¯¹ SelectionKey.OP_WRITE äº‹ä»¶æ„Ÿå…´è¶£</span></span><br><span class="line">    <span class="keyword">if</span> (setOpWrite) {</span><br><span class="line">        setOpWrite();</span><br><span class="line">    <span class="comment">// false ï¼Œå–æ¶ˆå¯¹ SelectionKey.OP_WRITE äº‹ä»¶æ„Ÿå…´è¶£</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// It is possible that we have set the write OP, woken up by NIO because the socket is writable, and then</span></span><br><span class="line">        <span class="comment">// use our write quantum. In this case we no longer want to set the write OP because the socket is still</span></span><br><span class="line">        <span class="comment">// writable (as far as we know). We will find out next time we attempt to write if the socket is writable</span></span><br><span class="line">        <span class="comment">// and set the write OP if necessary.</span></span><br><span class="line">        clearOpWrite();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Schedule flush again later so other tasks can be picked up in the meantime</span></span><br><span class="line">        <span class="comment">// ç«‹å³å‘èµ·ä¸‹ä¸€æ¬¡ flush ä»»åŠ¡</span></span><br><span class="line">        eventLoop().execute(flushTask); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><code>setOpWrite</code> ä¸º <code>true</code> ï¼Œè°ƒç”¨ <code>#setOpWrite()</code> æ–¹æ³•ï¼Œæ³¨å†Œå¯¹ <code>SelectionKey.OP_WRITE</code> äº‹ä»¶æ„Ÿå…´è¶£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setOpWrite</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> SelectionKey key = selectionKey();</span><br><span class="line">    <span class="comment">// Check first if the key is still valid as it may be canceled as part of the deregistration</span></span><br><span class="line">    <span class="comment">// from the EventLoop</span></span><br><span class="line">    <span class="comment">// See https://github.com/netty/netty/issues/2104</span></span><br><span class="line">    <span class="keyword">if</span> (!key.isValid()) { <span class="comment">// åˆæ³•</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> interestOps = key.interestOps();</span><br><span class="line">    <span class="comment">// æ³¨å†Œ SelectionKey.OP_WRITE äº‹ä»¶çš„æ„Ÿå…´è¶£</span></span><br><span class="line">    <span class="keyword">if</span> ((interestOps &amp; SelectionKey.OP_WRITE) == <span class="number">0</span>) {</span><br><span class="line">        key.interestOps(interestOps | SelectionKey.OP_WRITE);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ã€ç¬¬ 43 è¡Œã€‘çš„ä»£ç ï¼Œå°±æ˜¯è¿™ç§æƒ…å†µã€‚</li>
</ul>
</li>
<li><code>setOpWrite</code> ä¸º <code>false</code> ï¼Œè°ƒç”¨ <code>#clearOpWrite()</code> æ–¹æ³•ï¼Œå–æ¶ˆå¯¹ SelectionKey.OP_WRITE äº‹ä»¶æ„Ÿå…´è¶£ã€‚è€Œåï¼Œåœ¨ <code>&lt;1&gt;</code> å¤„ï¼Œç«‹å³å‘èµ·ä¸‹ä¸€æ¬¡ flush ä»»åŠ¡ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 47 è¡Œï¼šTODO èŠ‹è‰¿ è°ƒæ•´æ¯æ¬¡å†™å…¥çš„æœ€å¤§å­—èŠ‚æ•°</li>
<li>ç¬¬ 49 è¡Œï¼šè°ƒç”¨ <code>ChannelOutboundBuffer#removeBytes(long writtenBytes)</code> æ–¹æ³•å•Šï¼Œä»å†…å­˜é˜Ÿåˆ—ä¸­ï¼Œç§»é™¤å·²ç»å†™å…¥çš„æ•°æ®( æ¶ˆæ¯ )ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8.7 removeBytesã€</a> ã€‚</li>
<li>ç¬¬ 51 è¡Œï¼šå†™å…¥æ¬¡æ•°å‡ä¸€ã€‚</li>
<li><strong>(ã¥ï¿£3ï¿£)ã¥â•­â¤ï½ ç¬¬ä¸‰ç§</strong>ï¼Œ<code>nioBufferCnt &gt; 1</code> ã€‚å’Œã€ç¬¬äºŒç§ã€‘åŸºæœ¬ç›¸åŒï¼Œå·®åˆ«æ˜¯åœ¨äºã€ç¬¬ 60 è¡Œã€‘çš„ä»£ç ï¼Œè°ƒç”¨ Java <strong>åŸç”Ÿ</strong> <code>SocketChannel#write(ByteBuffer[] srcs, int offset, int length)</code> æ–¹æ³•ï¼Œæ‰§è¡Œ NIO write è°ƒç”¨ï¼Œå†™å…¥<strong>å¤šä¸ª</strong> ByteBuffer å¯¹è±¡åˆ°å¯¹ç«¯ã€‚ğŸ˜ˆ æ‰¹é‡ä¸€æ¬¡æ€§å†™å…¥ï¼Œæå‡æ€§èƒ½ã€‚</li>
<li>=========== ç»“æŸ ===========</li>
<li>ç¬¬ 79 è¡Œï¼šé€šè¿‡ <code>writeSpinCount &lt; 0</code> æ¥åˆ¤æ–­ï¼Œå†…å­˜é˜Ÿåˆ—ä¸­çš„æ•°æ®<strong>æ˜¯å¦</strong>æœªå®Œå…¨å†™å…¥ã€‚ä»ç›®å‰é€»è¾‘çœ‹ä¸‹æ¥ï¼Œç¬”è€…è®¤ä¸ºåªä¼šè¿”å› <code>true</code> ï¼Œå³å†…å­˜é˜Ÿåˆ—ä¸­çš„æ•°æ®æœªå®Œå…¨å†™å…¥ï¼Œè¯´æ˜ NIO Channel ä¸å¯å†™ï¼Œæ‰€ä»¥æ³¨å†Œ <code>SelectionKey.OP_WRITE</code> ï¼Œç­‰å¾… NIO Channel å¯å†™ã€‚å› æ­¤ï¼Œè°ƒç”¨ <code>#incompleteWrite(true)</code> æ–¹æ³•ã€‚<ul>
<li>ä¸¾ä¸ªä¾‹å­ï¼Œæœ€åä¸€æ¬¡å†™å…¥ï¼ŒChannel çš„ç¼“å†²åŒºè¿˜å‰©ä¸‹ 10 å­—èŠ‚å¯å†™ï¼Œå†…å­˜é˜Ÿåˆ—ä¸­å‰©ä½™ 90 å­—èŠ‚ï¼Œé‚£ä¹ˆå¯ä»¥æˆåŠŸå†™å…¥ 10 å­—èŠ‚ï¼Œå‰©ä½™ 80 å­—èŠ‚ã€‚ğŸ˜ˆ  ä¹Ÿå°±è¯´ï¼Œæ­¤æ—¶ Channel ä¸å¯å†™è½ã€‚</li>
</ul>
</li>
</ul>
<h2 id="7-1-ä¹±å…¥"><a href="#7-1-ä¹±å…¥" class="headerlink" title="7.1 ä¹±å…¥"></a>7.1 ä¹±å…¥</h2><blockquote>
<p>è€è‰¿è‰¿ï¼šä¸´æ—¶æ’å…¥ä¸‹ AbstractNioByteChannel å’Œ AbstractNioMessageChannel å®ç°ç±»å¯¹ <code>#doWrite(ChannelOutboundBuffer in)</code> æ–¹æ³•çš„å®ç°ã€‚ä¸æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡ã€‚</p>
</blockquote>
<p><strong>AbstractNioByteChannel</strong></p>
<p>è™½ç„¶ï¼ŒAbstractNioByteChannel å®ç°äº† <code>#doWrite(ChannelOutboundBuffer in)</code> æ–¹æ³•ï¼Œä½†æ˜¯å­ç±» NioSocketChannel åˆè¦†ç›–å®ç°äº†è¯¥æ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥å¿½ç•¥ AbstractNioByteChannel çš„å®ç°æ–¹æ³•äº†ã€‚</p>
<p>é‚£ä¹ˆä¸ºä»€ä¹ˆ AbstractNioByteChannel ä¼šå®ç°äº† <code>#doWrite(ChannelOutboundBuffer in)</code> æ–¹æ³•å‘¢ï¼Ÿå› ä¸º NioUdtByteConnectorChannel å’Œ NioUdtByteRendezvousChannel ä¼šä½¿ç”¨åˆ°è¯¥æ–¹æ³•ã€‚ä½†æ˜¯ï¼Œè¿™ä¸¤ä¸ªç±»å·²ç»è¢«<strong>æ ‡è®°åºŸå¼ƒ</strong>ï¼Œå› ä¸ºï¼š</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">transport udt is deprecated and so the user knows it will be removed in the future.</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ¥è‡ª Netty å®˜æ–¹æäº¤çš„æ³¨é‡Šè¯´æ˜ã€‚</li>
</ul>
<p><strong>AbstractNioMessageChannel</strong></p>
<p>è™½ç„¶ï¼ŒAbstractNioMessageChannel å®ç°äº† <code>#doWrite(ChannelOutboundBuffer in)</code> æ–¹æ³•ï¼Œä½†æ˜¯å¯¹äº NioServerSocketChannel æ¥è¯´ï¼Œæš‚æ—¶æ²¡æœ‰æ„ä¹‰ï¼Œå› ä¸ºï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">doWriteMessage</span><span class="params">(Object msg, ChannelOutboundBuffer in)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> Object <span class="title">filterOutboundMessage</span><span class="params">(Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¸¤ä¸ªæ–¹æ³•ï¼Œéƒ½æ˜¯ç›´æ¥æŠ›å‡º UnsupportedOperationException å¼‚å¸¸ã€‚</li>
</ul>
<p>é‚£ä¹ˆä¸ºä»€ä¹ˆ AbstractNioMessageChannel ä¼šå®ç°äº† <code>#doWrite(ChannelOutboundBuffer in)</code> æ–¹æ³•å‘¢ï¼Ÿå› ä¸º NioDatagramChannel å’Œ NioSctpChannel <strong>ç­‰ç­‰</strong>ä¼šä½¿ç”¨åˆ°è¯¥æ–¹æ³•ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥è‡ªå·±ç ”ç©¶ä¸‹ã€‚</p>
<h1 id="8-ChannelOutboundBuffer"><a href="#8-ChannelOutboundBuffer" class="headerlink" title="8. ChannelOutboundBuffer"></a>8. ChannelOutboundBuffer</h1><p><code>io.netty.channel.ChannelOutboundBuffer</code> ï¼Œ<strong>å†…å­˜é˜Ÿåˆ—</strong>ã€‚</p>
<ul>
<li>åœ¨ write æ“ä½œæ—¶ï¼Œå°†æ•°æ®å†™åˆ° ChannelOutboundBuffer ä¸­ã€‚</li>
<li>åœ¨ flush æ“ä½œæ—¶ï¼Œå°† ChannelOutboundBuffer çš„æ•°æ®å†™å…¥åˆ°å¯¹ç«¯ã€‚</li>
</ul>
<h2 id="8-1-Entry"><a href="#8-1-Entry" class="headerlink" title="8.1 Entry"></a>8.1 Entry</h2><p>åœ¨ write æ“ä½œæ—¶ï¼Œå°†æ•°æ®å†™åˆ° ChannelOutboundBuffer ä¸­ï¼Œéƒ½ä¼šäº§ç”Ÿä¸€ä¸ª Entry å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Recycler å¯¹è±¡ï¼Œç”¨äºé‡ç”¨ Entry å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Recycler&lt;Entry&gt; RECYCLER = <span class="keyword">new</span> Recycler&lt;Entry&gt;() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Entry <span class="title">newObject</span><span class="params">(Handle&lt;Entry&gt; handle)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Entry(handle);</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Recycler å¤„ç†å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Handle&lt;Entry&gt; handle;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸‹ä¸€æ¡ Entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Entry next;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¶ˆæ¯ï¼ˆæ•°æ®ï¼‰</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">Object msg;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #msg} è½¬åŒ–çš„ NIO ByteBuffer æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ByteBuffer[] bufs;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #msg} è½¬åŒ–çš„ NIO ByteBuffer å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ByteBuffer buf;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Promise å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ChannelPromise promise;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å·²å†™å…¥çš„å­—èŠ‚æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">long</span> progress;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é•¿åº¦ï¼Œå¯è¯»å­—èŠ‚æ•°æ•°ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">long</span> total;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¯ä¸ª Entry é¢„è®¡å ç”¨çš„å†…å­˜å¤§å°ï¼Œè®¡ç®—æ–¹å¼ä¸ºæ¶ˆæ¯( {<span class="doctag">@link</span> #msg} )çš„å­—èŠ‚æ•° + Entry å¯¹è±¡è‡ªèº«å ç”¨å†…å­˜çš„å¤§å°ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> pendingSize;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #msg} è½¬åŒ–çš„ NIO ByteBuffer çš„æ•°é‡ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å½“ = 1 æ—¶ï¼Œä½¿ç”¨ {<span class="doctag">@link</span> #buf}</span></span><br><span class="line"><span class="comment"> * å½“ &gt; 1 æ—¶ï¼Œä½¿ç”¨ {<span class="doctag">@link</span> #bufs}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> count = -<span class="number">1</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦å–æ¶ˆå†™å…¥å¯¹ç«¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">boolean</span> cancelled;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Entry</span><span class="params">(Handle&lt;Entry&gt; handle)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.handle = handle;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>RECYCLER</code> <strong>é™æ€</strong>å±æ€§ï¼Œç”¨äº<strong>é‡ç”¨</strong> Entry å¯¹è±¡ã€‚<ul>
<li><code>handle</code> å±æ€§ï¼ŒRecycler å¤„ç†å™¨ï¼Œç”¨äº<strong>å›æ”¶</strong> Entry å¯¹è±¡ã€‚</li>
</ul>
</li>
<li><code>next</code> å±æ€§ï¼ŒæŒ‡å‘<strong>ä¸‹ä¸€æ¡</strong> Entry ã€‚é€šè¿‡å®ƒï¼Œå½¢æˆ ChannelOutboundBuffer å†…éƒ¨çš„é“¾å¼å­˜å‚¨<strong>æ¯æ¡å†™å…¥æ•°æ®</strong>çš„æ•°æ®ç»“æ„ã€‚</li>
<li><p><code>msg</code> å±æ€§ï¼Œå†™å…¥çš„æ¶ˆæ¯( æ•°æ® )ã€‚</p>
<ul>
<li><code>promise</code> å±æ€§ï¼ŒPromise å¯¹è±¡ã€‚å½“æ•°æ®å†™å…¥æˆåŠŸåï¼Œå¯ä»¥é€šè¿‡å®ƒå›è°ƒé€šçŸ¥ç»“æœã€‚</li>
<li><p><code>total</code> å±æ€§ï¼Œé•¿åº¦ï¼Œå¯è¯»å­—èŠ‚æ•°ã€‚é€šè¿‡ <code>#total(Object msg)</code> æ–¹æ³•æ¥è®¡ç®—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">total</span><span class="params">(Object msg)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> ByteBuf) {</span><br><span class="line">        <span class="keyword">return</span> ((ByteBuf) msg).readableBytes();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> FileRegion) {</span><br><span class="line">        <span class="keyword">return</span> ((FileRegion) msg).count();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> ByteBufHolder) {</span><br><span class="line">        <span class="keyword">return</span> ((ByteBufHolder) msg).content().readableBytes();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»è¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬çœ‹åˆ°ï¼Œ<code>msg</code> çš„ç±»å‹ï¼Œæœ‰ ByteBufã€FileRegionã€ByteBufHolder ã€‚</li>
</ul>
</li>
<li><code>process</code> å±æ€§ï¼Œå·²å†™å…¥çš„å­—èŠ‚æ•°ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8.7.1 processã€</a> ã€‚</li>
</ul>
</li>
<li><code>count</code> å±æ€§ï¼Œ<code>msg</code> å±æ€§è½¬åŒ–çš„ NIO ByteBuffer çš„æ•°é‡ã€‚<ul>
<li><code>bufs</code> å±æ€§ï¼Œå½“ <code>count &gt; 0</code> æ—¶ä½¿ç”¨ï¼Œè¡¨ç¤º <code>msg</code> å±æ€§è½¬åŒ–çš„ NIO ByteBuffer æ•°ç»„ã€‚</li>
<li><code>buf</code> å±æ€§ï¼Œå½“ <code>count = 0</code> æ—¶ä½¿ç”¨ï¼Œè¡¨ç¤º <code>msg</code> å±æ€§è½¬åŒ–çš„ NIO ByteBuffer å¯¹è±¡ã€‚</li>
</ul>
</li>
<li><code>cancelled</code> å±æ€§ï¼Œæ˜¯å¦å–æ¶ˆå†™å…¥å¯¹ç«¯ã€‚</li>
<li><code>pendingSize</code> å±æ€§ï¼Œæ¯ä¸ª Entry é¢„è®¡å ç”¨çš„å†…å­˜å¤§å°ï¼Œè®¡ç®—æ–¹å¼ä¸ºæ¶ˆæ¯( <code>msg</code> )çš„å­—èŠ‚æ•° + Entry å¯¹è±¡è‡ªèº«å ç”¨å†…å­˜çš„å¤§å°ã€‚</li>
</ul>
<h3 id="8-1-1-newInstance"><a href="#8-1-1-newInstance" class="headerlink" title="8.1.1 newInstance"></a>8.1.1 newInstance</h3><p><code>#newInstance(Object msg, int size, long total, ChannelPromise promise)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œåˆ›å»º Entry å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> Entry <span class="title">newInstance</span><span class="params">(Object msg, <span class="keyword">int</span> size, <span class="keyword">long</span> total, ChannelPromise promise)</span> </span>{</span><br><span class="line">    <span class="comment">// é€šè¿‡ Recycler é‡ç”¨å¯¹è±¡</span></span><br><span class="line">    Entry entry = RECYCLER.get();</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å±æ€§</span></span><br><span class="line">    entry.msg = msg;</span><br><span class="line">    entry.pendingSize = size + CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD;</span><br><span class="line">    entry.total = total;</span><br><span class="line">    entry.promise = promise;</span><br><span class="line">    <span class="keyword">return</span> entry;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é€šè¿‡ Recycler æ¥<strong>é‡ç”¨</strong> Entry å¯¹è±¡ã€‚</li>
</ul>
<h3 id="8-1-2-recycle"><a href="#8-1-2-recycle" class="headerlink" title="8.1.2 recycle"></a>8.1.2 recycle</h3><p><code>#recycle()</code> æ–¹æ³•ï¼Œ<strong>å›æ”¶</strong> Entry å¯¹è±¡ï¼Œä»¥ä¸ºä¸‹æ¬¡<strong>é‡ç”¨</strong>è¯¥å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">recycle</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// é‡ç½®å±æ€§</span></span><br><span class="line">    next = <span class="keyword">null</span>;</span><br><span class="line">    bufs = <span class="keyword">null</span>;</span><br><span class="line">    buf = <span class="keyword">null</span>;</span><br><span class="line">    msg = <span class="keyword">null</span>;</span><br><span class="line">    promise = <span class="keyword">null</span>;</span><br><span class="line">    progress = <span class="number">0</span>;</span><br><span class="line">    total = <span class="number">0</span>;</span><br><span class="line">    pendingSize = <span class="number">0</span>;</span><br><span class="line">    count = -<span class="number">1</span>;</span><br><span class="line">    cancelled = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// å›æ”¶ Entry å¯¹è±¡</span></span><br><span class="line">    handle.recycle(<span class="keyword">this</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="8-1-3-recycleAndGetNext"><a href="#8-1-3-recycleAndGetNext" class="headerlink" title="8.1.3 recycleAndGetNext"></a>8.1.3 recycleAndGetNext</h3><p><code>#recycleAndGetNext()</code> æ–¹æ³•ï¼Œè·å¾—ä¸‹ä¸€ä¸ª Entry å¯¹è±¡ï¼Œå¹¶<strong>å›æ”¶</strong>å½“å‰ Entry å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function">Entry <span class="title">recycleAndGetNext</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// è·å¾—ä¸‹ä¸€ä¸ª Entry å¯¹è±¡</span></span><br><span class="line">    Entry next = <span class="keyword">this</span>.next;</span><br><span class="line">    <span class="comment">// å›æ”¶å½“å‰ Entry å¯¹è±¡</span></span><br><span class="line">    recycle();</span><br><span class="line">    <span class="comment">// è¿”å›ä¸‹ä¸€ä¸ª Entry å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> next;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="8-1-4-cancel"><a href="#8-1-4-cancel" class="headerlink" title="8.1.4 cancel"></a>8.1.4 cancel</h3><p><code>#cancel()</code> æ–¹æ³•ï¼Œæ ‡è®° Entry å¯¹è±¡ï¼Œå–æ¶ˆå†™å…¥åˆ°å¯¹ç«¯ã€‚åœ¨ ChannelOutboundBuffer é‡Œï¼ŒEntry æ•°ç»„æ˜¯é€šè¿‡<strong>é“¾å¼</strong>çš„æ–¹å¼è¿›è¡Œç»„ç»‡ï¼Œè€Œå½“æŸä¸ª Entry å¯¹è±¡( <strong>èŠ‚ç‚¹</strong> )å¦‚æœéœ€è¦å–æ¶ˆå†™å…¥åˆ°å¯¹ç«¯ï¼Œæ˜¯é€šè¿‡è®¾ç½® <code>canceled = true</code> æ¥<strong>æ ‡è®°åˆ é™¤</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">cancel</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (!cancelled) {</span><br><span class="line">        <span class="comment">// æ ‡è®°å–æ¶ˆ</span></span><br><span class="line">        cancelled = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">int</span> pSize = pendingSize;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é‡Šæ”¾æ¶ˆæ¯( æ•°æ® )ç›¸å…³çš„èµ„æº</span></span><br><span class="line">        <span class="comment">// release message and replace with an empty buffer</span></span><br><span class="line">        ReferenceCountUtil.safeRelease(msg);</span><br><span class="line">        <span class="comment">// è®¾ç½®ä¸ºç©º ByteBuf</span></span><br><span class="line">        msg = Unpooled.EMPTY_BUFFER;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ç½®ç©ºå±æ€§</span></span><br><span class="line">        pendingSize = <span class="number">0</span>;</span><br><span class="line">        total = <span class="number">0</span>;</span><br><span class="line">        progress = <span class="number">0</span>;</span><br><span class="line">        bufs = <span class="keyword">null</span>;</span><br><span class="line">        buf = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¿”å› pSize</span></span><br><span class="line">        <span class="keyword">return</span> pSize;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="8-2-æ„é€ æ–¹æ³•"><a href="#8-2-æ„é€ æ–¹æ³•" class="headerlink" title="8.2 æ„é€ æ–¹æ³•"></a>8.2 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Entry å¯¹è±¡è‡ªèº«å ç”¨å†…å­˜çš„å¤§å°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// Assuming a 64-bit JVM:</span></span><br><span class="line"><span class="comment">//  - 16 bytes object header</span></span><br><span class="line"><span class="comment">//  - 8 reference fields</span></span><br><span class="line"><span class="comment">//  - 2 long fields</span></span><br><span class="line"><span class="comment">//  - 2 int fields</span></span><br><span class="line"><span class="comment">//  - 1 boolean field</span></span><br><span class="line"><span class="comment">//  - padding</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD = SystemPropertyUtil.getInt(<span class="string">"io.netty.transport.outboundBufferEntrySizeOverhead"</span>, <span class="number">96</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> InternalLogger logger = InternalLoggerFactory.getInstance(ChannelOutboundBuffer.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * çº¿ç¨‹å¯¹åº”çš„ ByteBuffer æ•°ç»„ç¼“å­˜</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * æ¯æ¬¡è°ƒç”¨ {<span class="doctag">@link</span> #nioBuffers(int, long)} ä¼šé‡æ–°ç”Ÿæˆ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> FastThreadLocal&lt;ByteBuffer[]&gt; NIO_BUFFERS = <span class="keyword">new</span> FastThreadLocal&lt;ByteBuffer[]&gt;() {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> ByteBuffer[] initialValue() <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ByteBuffer[<span class="number">1024</span>];</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Channel å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Channel channel;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Entry(flushedEntry) --&gt; ... Entry(unflushedEntry) --&gt; ... Entry(tailEntry)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç¬¬ä¸€ä¸ª( å¼€å§‹ ) flush Entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// The Entry that is the first in the linked-list structure that was flushed</span></span><br><span class="line"><span class="keyword">private</span> Entry flushedEntry;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç¬¬ä¸€ä¸ªæœª flush Entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// The Entry which is the first unflushed in the linked-list structure</span></span><br><span class="line"><span class="keyword">private</span> Entry unflushedEntry;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å°¾ Entry</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// The Entry which represents the tail of the buffer</span></span><br><span class="line"><span class="keyword">private</span> Entry tailEntry;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å·² flush ä½†æœªå†™å…¥å¯¹ç«¯çš„ Entry æ•°é‡</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #addFlush()}</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The number of flushed entries that are not written yet</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> flushed;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #NIO_BUFFERS} æ•°ç»„å¤§å°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> nioBufferCount;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #NIO_BUFFERS} å­—èŠ‚æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> nioBufferSize;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ­£åœ¨é€šçŸ¥ flush å¤±è´¥ä¸­</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> inFail;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #totalPendingSize} çš„åŸå­æ›´æ–°å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicLongFieldUpdater&lt;ChannelOutboundBuffer&gt; TOTAL_PENDING_SIZE_UPDATER = AtomicLongFieldUpdater.newUpdater(ChannelOutboundBuffer.class, <span class="string">"totalPendingSize"</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ€»å…±ç­‰å¾… flush åˆ°å¯¹ç«¯çš„å†…å­˜å¤§å°ï¼Œé€šè¿‡ {<span class="doctag">@link</span> Entry#pendingSize} æ¥åˆè®¡ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"UnusedDeclaration"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> totalPendingSize;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #unwritable} çš„åŸå­æ›´æ–°å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicIntegerFieldUpdater&lt;ChannelOutboundBuffer&gt; UNWRITABLE_UPDATER = AtomicIntegerFieldUpdater.newUpdater(ChannelOutboundBuffer.class, <span class="string">"unwritable"</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦ä¸å¯å†™</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"UnusedDeclaration"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> unwritable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è§¦å‘ Channel å¯å†™çš„æ”¹å˜çš„ä»»åŠ¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Runnable fireChannelWritabilityChangedTask;</span><br><span class="line"></span><br><span class="line">ChannelOutboundBuffer(AbstractChannel channel) {</span><br><span class="line">    <span class="keyword">this</span>.channel = channel;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>channel</code> å±æ€§ï¼Œæ‰€å±çš„ Channel å¯¹è±¡ã€‚</li>
<li>é“¾å¼ç»“æ„<ul>
<li><code>flushedEntry</code> å±æ€§ï¼Œç¬¬ä¸€ä¸ª( å¼€å§‹ ) flush Entry ã€‚</li>
<li><code>unflushedEntry</code> å±æ€§ï¼Œç¬¬ä¸€ä¸ª<strong>æœª</strong> flush Entry ã€‚</li>
<li><code>tailEntry</code> å±æ€§ï¼Œå°¾ Entry ã€‚</li>
<li><code>flushed</code> å±æ€§ï¼Œ å·² flush ä½†æœªå†™å…¥å¯¹ç«¯çš„ Entry æ•°é‡ã€‚</li>
<li>æŒ‡å‘å…³ç³»æ˜¯ <code>Entry(flushedEntry) --&gt; ... Entry(unflushedEntry) --&gt; ... Entry(tailEntry)</code> ã€‚è¿™æ ·çœ‹ï¼Œå¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œä¸‹æ–‡æºç è§£æè¯¦ç»†ç†è§£ã€‚</li>
</ul>
</li>
<li><code>NIO_BUFFERS</code> <strong>é™æ€</strong>å±æ€§ï¼Œçº¿ç¨‹å¯¹åº”çš„ NIO ByteBuffer æ•°ç»„ç¼“å­˜ã€‚åœ¨ <code>AbstractChannel#doWrite(ChannelOutboundBuffer)</code> æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ <code>ChannelOutbound#nioBuffers(int maxCount, long maxBytes)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–æ•°ç»„ç¼“å­˜ã€‚ è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8.6 nioBuffersã€</a> ä¸­ã€‚<ul>
<li><code>nioBufferCount</code> å±æ€§ï¼šNIO ByteBuffer æ•°ç»„çš„<strong>æ•°ç»„</strong>å¤§å°ã€‚</li>
<li><code>nioBufferSize</code> å±æ€§ï¼šNIO ByteBuffer æ•°ç»„çš„å­—<strong>èŠ‚</strong>å¤§å°ã€‚</li>
</ul>
</li>
<li><code>inFail</code> å±æ€§ï¼Œæ­£åœ¨é€šçŸ¥ flush å¤±è´¥ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8.8 failFlushedã€</a> ä¸­ã€‚ </li>
<li>ChannelOutboundBuffer å†™å…¥æ§åˆ¶ç›¸å…³ã€‚ğŸ˜ˆ è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ10. ChannelOutboundBufferã€</a> ã€‚ <ul>
<li><code>unwritable</code> å±æ€§ï¼Œæ˜¯å¦ä¸å¯å†™ã€‚<ul>
<li><code>UNWRITABLE_UPDATER</code> é™æ€å±æ€§ï¼Œ<code>unwritable</code> å±æ€§çš„åŸå­æ›´æ–°å™¨ã€‚</li>
</ul>
</li>
<li><code>totalPendingSize</code> å±æ€§ï¼Œæ‰€æœ‰ Entry é¢„è®¡å ç”¨çš„å†…å­˜å¤§å°ï¼Œé€šè¿‡ <code>Entry.pendingSize</code> æ¥åˆè®¡ã€‚<ul>
<li><code>TOTAL_PENDING_SIZE_UPDATER</code> é™æ€å±æ€§ï¼Œ<code>totalPendingSize</code> å±æ€§çš„åŸå­æ›´æ–°å™¨ã€‚         </li>
</ul>
</li>
<li><code>fireChannelWritabilityChangedTask</code> å±æ€§ï¼Œè§¦å‘ Channel å¯å†™çš„æ”¹å˜çš„<strong>ä»»åŠ¡</strong>ã€‚</li>
<li><code>CHANNEL_OUTBOUND_BUFFER_ENTRY_OVERHEAD</code> <strong>é™æ€</strong>å±æ€§ï¼Œæ¯ä¸ª Entry å¯¹è±¡è‡ªèº«å ç”¨å†…å­˜çš„å¤§å°ã€‚ä¸ºä»€ä¹ˆå ç”¨çš„ 96 å­—èŠ‚å‘¢ï¼Ÿ<ul>
<li><code>- 16 bytes object header</code> ï¼Œå¯¹è±¡å¤´ï¼Œ16 å­—èŠ‚ã€‚</li>
<li><code>- 8 reference fields</code> ï¼Œå®é™…æ˜¯ 6 ä¸ª<strong>å¯¹è±¡å¼•ç”¨</strong>å­—æ®µï¼Œ6 * 8 = 48 å­—èŠ‚ã€‚</li>
<li><code>- 2 long fields</code> ï¼Œ2 ä¸ª <code>long</code> å­—æ®µï¼Œ2 * 8 = 16 å­—èŠ‚ã€‚</li>
<li><code>- 2 int fields</code> ï¼Œ1 ä¸ª <code>int</code> å­—æ®µï¼Œ2 * 4 = 8 å­—èŠ‚ã€‚</li>
<li><code>- 1 boolean field</code> ï¼Œ1 ä¸ª <code>boolean</code> å­—æ®µï¼Œ1 å­—èŠ‚ã€‚</li>
<li><code>padding</code> ï¼Œè¡¥é½ 8 å­—èŠ‚çš„æ•´æ•°å€ï¼Œå› æ­¤ 7 å­—èŠ‚ã€‚</li>
<li>å› æ­¤ï¼Œåˆè®¡ 96 å­—èŠ‚( 64 ä½çš„ JVM è™šæ‹Ÿæœºï¼Œå¹¶ä¸”ä¸è€ƒè™‘å‹ç¼© )ã€‚</li>
<li>å¦‚æœä¸ç†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ <a href="https://www.jianshu.com/p/12a3c97dc2b7" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJVMä¸­ å¯¹è±¡çš„å†…å­˜å¸ƒå±€ ä»¥åŠ å®ä¾‹åˆ†æã€‹</a> ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="8-3-addMessage"><a href="#8-3-addMessage" class="headerlink" title="8.3 addMessage"></a>8.3 addMessage</h2><p><code>#addMessage(Object msg, int size, ChannelPromise promise)</code> æ–¹æ³•ï¼Œå†™å…¥æ¶ˆæ¯( æ•°æ® )åˆ°å†…å­˜é˜Ÿåˆ—ã€‚<strong>æ³¨æ„</strong>ï¼Œ<code>promise</code> åªæœ‰åœ¨çœŸæ­£å®Œæˆå†™å…¥åˆ°å¯¹ç«¯æ“ä½œï¼Œæ‰ä¼šè¿›è¡Œé€šçŸ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br><span class="line"><span class="comment"> 2:  * Add given message to this {<span class="doctag">@link</span> ChannelOutboundBuffer}. The given {<span class="doctag">@link</span> ChannelPromise} will be notified once</span></span><br><span class="line"><span class="comment"> 3:  * the message was written.</span></span><br><span class="line"><span class="comment"> 4:  */</span></span><br><span class="line"> <span class="number">5</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addMessage</span><span class="params">(Object msg, <span class="keyword">int</span> size, ChannelPromise promise)</span> </span>{</span><br><span class="line"> <span class="number">6</span>:     <span class="comment">// åˆ›å»ºæ–° Entry å¯¹è±¡</span></span><br><span class="line"> <span class="number">7</span>:     Entry entry = Entry.newInstance(msg, size, total(msg), promise);</span><br><span class="line"> <span class="number">8</span>:     <span class="comment">// è‹¥ tailEntry ä¸ºç©ºï¼Œå°† flushedEntry ä¹Ÿè®¾ç½®ä¸ºç©ºã€‚é˜²å¾¡å‹ç¼–ç¨‹ï¼Œå®é™…ä¸ä¼šå‡ºç°</span></span><br><span class="line"> <span class="number">9</span>:     <span class="keyword">if</span> (tailEntry == <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">10</span>:         flushedEntry = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">11</span>:     <span class="comment">// è‹¥ tailEntry éç©ºï¼Œå°†åŸ tailEntry æŒ‡å‘æ–° Entry</span></span><br><span class="line"><span class="number">12</span>:     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">13</span>:         Entry tail = tailEntry;</span><br><span class="line"><span class="number">14</span>:         tail.next = entry;</span><br><span class="line"><span class="number">15</span>:     }</span><br><span class="line"><span class="number">16</span>:     <span class="comment">// æ›´æ–° tailEntry ä¸ºæ–° Entry</span></span><br><span class="line"><span class="number">17</span>:     tailEntry = entry;</span><br><span class="line"><span class="number">18</span>:     <span class="comment">// è‹¥ unflushedEntry ä¸ºç©ºï¼Œæ›´æ–°ä¸ºæ–° Entry</span></span><br><span class="line"><span class="number">19</span>:     <span class="keyword">if</span> (unflushedEntry == <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">20</span>:         unflushedEntry = entry;</span><br><span class="line"><span class="number">21</span>:     }</span><br><span class="line"><span class="number">22</span>: </span><br><span class="line"><span class="number">23</span>:     <span class="comment">// å¢åŠ  totalPendingSize è®¡æ•°</span></span><br><span class="line"><span class="number">24</span>:     <span class="comment">// increment pending bytes after adding message to the unflushed arrays.</span></span><br><span class="line"><span class="number">25</span>:     <span class="comment">// See https://github.com/netty/netty/issues/1619</span></span><br><span class="line"><span class="number">26</span>:     incrementPendingOutboundBytes(entry.pendingSize, <span class="keyword">false</span>);</span><br><span class="line"><span class="number">27</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 7 è¡Œï¼šè°ƒç”¨ <code>#newInstance(Object msg, int size, long total, ChannelPromise promise)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œåˆ›å»º Entry å¯¹è±¡ã€‚</li>
<li>ç¬¬ 11 è‡³ 17 è¡Œï¼šä¿®æ”¹<strong>å°¾</strong>èŠ‚ç‚¹ <code>tailEntry</code> ä¸ºæ–°çš„ Entry èŠ‚ç‚¹ã€‚<ul>
<li>ç¬¬ 8 è‡³ 10 è¡Œï¼šè‹¥ <code>tailEntry</code> ä¸ºç©ºï¼Œå°† <code>flushedEntry</code> ä¹Ÿè®¾ç½®ä¸ºç©ºã€‚é˜²å¾¡å‹ç¼–ç¨‹ï¼Œå®é™…ä¸ä¼šå‡ºç°ï¼Œèƒ–å‹å¯ä»¥å¿½ç•¥ã€‚ğŸ˜ˆ å½“ç„¶ï¼ŒåŸå› åœ¨ <code>#removeEntry(Entry e)</code> æ–¹æ³•ã€‚</li>
<li>ç¬¬ 11 è‡³ 15 è¡Œï¼šè‹¥ <code>tailEntry</code> éç©ºï¼Œå°†åŸ <code>tailEntry.next</code> æŒ‡å‘<strong>æ–°</strong> Entry ã€‚</li>
<li>ç¬¬ 17 è¡Œï¼šæ›´æ–°åŸ <code>tailEntry</code> ä¸ºæ–° Entry ã€‚</li>
</ul>
</li>
<li>ç¬¬ 18 è‡³ 21 è¡Œï¼šè‹¥ <code>unflushedEntry</code> ä¸ºç©ºï¼Œåˆ™æ›´æ–°ä¸ºæ–° Entry ï¼Œæ­¤æ—¶ç›¸å½“äº<strong>é¦–</strong>èŠ‚ç‚¹ã€‚</li>
<li>ç¬¬ 23 è‡³ 26 è¡Œï¼š<code>#incrementPendingOutboundBytes(long size, ...)</code> æ–¹æ³•ï¼Œå¢åŠ  <code>totalPendingSize</code> è®¡æ•°ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ10.1 incrementPendingOutboundBytesã€</a> ã€‚</li>
</ul>
<hr>
<p>å¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹åŸºå‹ã€é—ªç”µä¾ ã€‘å¯¹è¿™å—çš„è§£æï¼š</p>
<blockquote>
<p>FROM é—ªç”µä¾  <a href="https://www.jianshu.com/p/feaeaab2ce56" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnetty æºç åˆ†æä¹‹ writeAndFlush å…¨è§£æã€‹</a></p>
<p>åˆæ¬¡è°ƒç”¨ <code>addMessage</code> ä¹‹åï¼Œå„ä¸ªæŒ‡é’ˆçš„æƒ…å†µä¸º</p>
<p><a href="http://static2.iocoder.cn/1ff7a5d2b08b9e6160dd92e74e68145f" title="" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/1ff7a5d2b08b9e6160dd92e74e68145f" alt=""></a></p>
<p><code>fushedEntry</code>æŒ‡å‘ç©ºï¼Œ<code>unFushedEntry</code>å’Œ <code>tailEntry</code> éƒ½æŒ‡å‘æ–°åŠ å…¥çš„èŠ‚ç‚¹</p>
<p>ç¬¬äºŒæ¬¡è°ƒç”¨ <code>addMessage</code> ä¹‹åï¼Œå„ä¸ªæŒ‡é’ˆçš„æƒ…å†µä¸º</p>
<p><a href="http://static2.iocoder.cn/1f939423f079ff491b90c8300e7ef3ea" title="" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/1f939423f079ff491b90c8300e7ef3ea" alt=""></a></p>
<p>ç¬¬ n æ¬¡è°ƒç”¨ <code>addMessage</code>ä¹‹åï¼Œå„ä¸ªæŒ‡é’ˆçš„æƒ…å†µä¸º</p>
<p><a href="http://static2.iocoder.cn/c0077b0dc86ecf1b791a99eeb9664fc3" title="" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/c0077b0dc86ecf1b791a99eeb9664fc3" alt=""></a></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨ n æ¬¡ <code>addMessage</code> ï¼Œ<code>flushedEntry</code> æŒ‡é’ˆä¸€ç›´æŒ‡å‘ NULL ï¼Œè¡¨ç¤ºç°åœ¨è¿˜æœªæœ‰èŠ‚ç‚¹éœ€è¦å†™å‡ºåˆ° Socket ç¼“å†²åŒºï¼Œè€Œ<code>unFushedEntry</code> ä¹‹åæœ‰ n ä¸ªèŠ‚ç‚¹ï¼Œè¡¨ç¤ºå½“å‰è¿˜æœ‰nä¸ªèŠ‚ç‚¹å°šæœªå†™å‡ºåˆ° Socket ç¼“å†²åŒºä¸­å»</p>
</blockquote>
<h2 id="8-4-addFlush"><a href="#8-4-addFlush" class="headerlink" title="8.4 addFlush"></a>8.4 addFlush</h2><p><code>#addFlush()</code> æ–¹æ³•ï¼Œæ ‡è®°å†…å­˜é˜Ÿåˆ—æ¯ä¸ª Entry å¯¹è±¡ï¼Œå¼€å§‹ <strong>flush</strong> ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>è€è‰¿è‰¿ï¼šæ€»è§‰å¾—è¿™ä¸ªæ–¹æ³•åå–çš„æœ‰ç‚¹å¥‡æ€ªï¼Œèƒ–å‹å¯ä»¥ç›´æ¥çœ‹è‹±æ–‡æ³¨é‡Šã€‚ğŸ˜ˆ æˆ‘â€œç¿»è¯‘â€ä¸å¥½ï¼Œå“ˆå“ˆå“ˆã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addFlush</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// There is no need to process all entries if there was already a flush before and no new messages</span></span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// where added in the meantime.</span></span><br><span class="line"> <span class="number">4</span>:     <span class="comment">//</span></span><br><span class="line"> <span class="number">5</span>:     <span class="comment">// See https://github.com/netty/netty/issues/2577</span></span><br><span class="line"> <span class="number">6</span>:     Entry entry = unflushedEntry;</span><br><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (entry != <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">8</span>:         <span class="comment">// è‹¥ flushedEntry ä¸ºç©ºï¼Œèµ‹å€¼ä¸º unflushedEntry ï¼Œç”¨äºè®°å½•ç¬¬ä¸€ä¸ª( å¼€å§‹ ) flush çš„ Entry ã€‚</span></span><br><span class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (flushedEntry == <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">10</span>:             <span class="comment">// there is no flushedEntry yet, so start with the entry</span></span><br><span class="line"><span class="number">11</span>:             flushedEntry = entry;</span><br><span class="line"><span class="number">12</span>:         }</span><br><span class="line"><span class="number">13</span>:         <span class="comment">// è®¡ç®— flush çš„æ•°é‡ï¼Œå¹¶è®¾ç½®æ¯ä¸ª Entry å¯¹åº”çš„ Promise ä¸å¯å–æ¶ˆ</span></span><br><span class="line"><span class="number">14</span>:         <span class="keyword">do</span> {</span><br><span class="line"><span class="number">15</span>:             <span class="comment">// å¢åŠ  flushed</span></span><br><span class="line"><span class="number">16</span>:             flushed ++;</span><br><span class="line"><span class="number">17</span>:             <span class="comment">// è®¾ç½® Promise ä¸å¯å–æ¶ˆ</span></span><br><span class="line"><span class="number">18</span>:             <span class="keyword">if</span> (!entry.promise.setUncancellable()) { <span class="comment">// è®¾ç½®å¤±è´¥</span></span><br><span class="line"><span class="number">19</span>:                 <span class="comment">// å‡å°‘ totalPending è®¡æ•°</span></span><br><span class="line"><span class="number">20</span>:                 <span class="comment">// Was cancelled so make sure we free up memory and notify about the freed bytes</span></span><br><span class="line"><span class="number">21</span>:                 <span class="keyword">int</span> pending = entry.cancel();</span><br><span class="line"><span class="number">22</span>:                 decrementPendingOutboundBytes(pending, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">23</span>:             }</span><br><span class="line"><span class="number">24</span>:             <span class="comment">// è·å¾—ä¸‹ä¸€ä¸ª Entry</span></span><br><span class="line"><span class="number">25</span>:             entry = entry.next;</span><br><span class="line"><span class="number">26</span>:         } <span class="keyword">while</span> (entry != <span class="keyword">null</span>);</span><br><span class="line"><span class="number">27</span>: </span><br><span class="line"><span class="number">28</span>:         <span class="comment">// è®¾ç½® unflushedEntry ä¸ºç©ºï¼Œè¡¨ç¤ºæ‰€æœ‰éƒ½ flush</span></span><br><span class="line"><span class="number">29</span>:         <span class="comment">// All flushed so reset unflushedEntry</span></span><br><span class="line"><span class="number">30</span>:         unflushedEntry = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">31</span>:     }</span><br><span class="line"><span class="number">32</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 6 è‡³ 7 è¡Œï¼šè‹¥ <code>unflushedEntry</code> ä¸ºç©ºï¼Œè¯´æ˜æ¯ä¸ª Entry å¯¹è±¡å·²ç»â€œæ ‡è®°â€ flush ã€‚<strong>æ³¨æ„</strong>ï¼Œâ€œæ ‡è®°â€çš„æ–¹å¼ï¼Œä¸æ˜¯é€šè¿‡ Entry å¯¹è±¡æœ‰ä¸€ä¸ª <code>flushed</code> å­—æ®µï¼Œè€Œæ˜¯ <code>flushedEntry</code> å±æ€§ï¼ŒæŒ‡å‘ç¬¬ä¸€ä¸ª( å¼€å§‹ ) flush çš„ Entry ï¼Œè€Œ <code>unflushedEntry</code> ç½®ç©ºã€‚</li>
<li>ç¬¬ 8 è‡³ 12 è¡Œï¼šè‹¥ <code>flushedEntry</code> ä¸ºç©ºï¼Œèµ‹å€¼ä¸º <code>unflushedEntry</code> ï¼Œç”¨äºè®°å½•ç¬¬ä¸€ä¸ª( å¼€å§‹ ) flush çš„ Entry ã€‚</li>
<li>ç¬¬ 13 è‡³ 26 è¡Œï¼šè®¡ç®—éœ€è¦ flush çš„ Entry æ•°é‡ï¼Œå¹¶è®¾ç½®æ¯ä¸ª Entry å¯¹åº”çš„ Promise <strong>ä¸å¯å–æ¶ˆ</strong>ã€‚<ul>
<li>ç¬¬ 18 è‡³ 23 è¡Œï¼š<code>#decrementPendingOutboundBytes(long size, ...)</code> æ–¹æ³•ï¼Œå‡å°‘ <code>totalPendingSize</code> è®¡æ•°ã€‚</li>
</ul>
</li>
<li>ç¬¬ 30 è¡Œï¼šè®¾ç½® <code>unflushedEntry</code> ä¸ºç©ºã€‚</li>
</ul>
<hr>
<p>å¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹åŸºå‹ã€é—ªç”µä¾ ã€‘å¯¹è¿™å—çš„è§£æï¼š</p>
<blockquote>
<p>FROM é—ªç”µä¾  <a href="https://www.jianshu.com/p/feaeaab2ce56" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnetty æºç åˆ†æä¹‹ writeAndFlush å…¨è§£æã€‹</a></p>
<p>å¯ä»¥ç»“åˆå‰é¢çš„å›¾æ¥çœ‹ï¼Œé¦–å…ˆæ‹¿åˆ° <code>unflushedEntry</code> æŒ‡é’ˆï¼Œç„¶åå°† <code>flushedEntry</code> æŒ‡å‘ <code>unflushedEntry</code> æ‰€æŒ‡å‘çš„èŠ‚ç‚¹ï¼Œè°ƒç”¨å®Œæ¯•ä¹‹åï¼Œä¸‰ä¸ªæŒ‡é’ˆçš„æƒ…å†µå¦‚ä¸‹æ‰€ç¤º</p>
<p><a href="http://static2.iocoder.cn/ecb3df153a3df70464b524838b559232" title="" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/ecb3df153a3df70464b524838b559232" alt=""></a></p>
</blockquote>
<hr>
<blockquote>
<p>è€è‰¿è‰¿ï¼šå†æ¬¡åˆ‡å›åˆ°è€è‰¿è‰¿çš„é¢‘é“ï¼Œå‘¼å‘¼ã€‚</p>
</blockquote>
<p>å½“ä¸€æ¬¡éœ€è¦ä»å†…å­˜é˜Ÿåˆ—å†™åˆ°å¯¹ç«¯çš„æ•°æ®é‡éå¸¸å¤§ï¼Œé‚£ä¹ˆå¯èƒ½å†™ç€å†™ç€ Channel çš„ç¼“å­˜åŒºä¸å¤Ÿï¼Œå¯¼è‡´ Channel æ­¤æ—¶ä¸å¯å†™ã€‚ä½†æ˜¯ï¼Œè¿™ä¸€è½® <code>#addFlush(...)</code> æ ‡è®°çš„ Entry å¯¹è±¡å¹¶æ²¡æœ‰éƒ½å†™åˆ°å¯¹ç«¯ã€‚ä¾‹å¦‚ï¼Œå‡†å¤‡å†™åˆ°å¯¹ç«¯çš„ Entry çš„æ•°é‡æ˜¯ <code>flush = 10</code> ä¸ªï¼Œç»“æœåªå†™äº† 6 ä¸ªï¼Œé‚£ä¹ˆå°±å‰©ä¸‹ <code>flush = 4</code> ã€‚</p>
<p>ä½†æ˜¯çš„ä½†æ˜¯ï¼Œ<code>#addMessage(...)</code> å¯èƒ½åˆä¸æ–­å†™å…¥æ–°çš„æ¶ˆæ¯( æ•°æ® )åˆ° ChannelOutboundBuffer ä¸­ã€‚é‚£ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿä¼šâ€œåˆ†â€æˆä¸¤æ®µï¼š</p>
<ul>
<li><code>&lt;1&gt;</code> æ®µï¼šè‡ªèŠ‚ç‚¹ <code>flushedEntry</code> å¼€å§‹çš„ <code>flush</code> ä¸ª Entry èŠ‚ç‚¹ï¼Œéœ€è¦å†™å…¥åˆ°å¯¹ç«¯ã€‚</li>
<li><code>&lt;2&gt;</code> æ®µï¼šè‡ªèŠ‚ç‚¹ <code>unFlushedEntry</code> å¼€å§‹çš„ Entry èŠ‚ç‚¹ï¼Œéœ€è¦è°ƒç”¨ <code>#addFlush()</code> æ–¹æ³•ï¼Œæ·»åŠ åˆ° <code>&lt;1&gt;</code> æ®µä¸­ã€‚</li>
</ul>
<p>è¿™å°±å¾ˆå¥½çš„è§£é‡Šä¸¤ä¸ªäº‹æƒ…ï¼š</p>
<ol>
<li>ä¸ºä»€ä¹ˆ <code>#addFlush()</code> æ–¹æ³•ï¼Œå‘½åæ˜¯ä»¥ <code>"add"</code> å¼€å¤´ã€‚</li>
<li>ChannelOutboundBuffer çš„é“¾å¼ç»“æ„ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯ <code>head</code> å’Œ <code>tail</code> <strong>ä¸¤ä¸ª</strong>èŠ‚ç‚¹ï¼Œè€Œæ˜¯ <code>flushedEntry</code>ã€<code>unFlushedEntry</code>ã€<code>flushedEntry</code> <strong>ä¸‰ä¸ª</strong>èŠ‚ç‚¹ã€‚åœ¨æ­¤å¤„ï¼Œè¯·å…è®¸è€è‰¿è‰¿çˆ†ä¸ªç²—å£ï¼šçœŸä»– x çš„å·§å¦™å•Šã€‚</li>
</ol>
<h3 id="8-4-1-size"><a href="#8-4-1-size" class="headerlink" title="8.4.1 size"></a>8.4.1 size</h3><p><code>#size()</code> æ–¹æ³•ï¼Œè·å¾— <code>flushed</code> å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns the number of flushed messages in this {<span class="doctag">@link</span> ChannelOutboundBuffer}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> flushed;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="8-4-2-isEmpty"><a href="#8-4-2-isEmpty" class="headerlink" title="8.4.2 isEmpty"></a>8.4.2 isEmpty</h3><p><code>#isEmpty()</code> æ–¹æ³•ï¼Œæ˜¯å¦ä¸ºç©ºã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns {<span class="doctag">@code</span> true} if there are flushed messages in this {<span class="doctag">@link</span> ChannelOutboundBuffer} or {<span class="doctag">@code</span> false}</span></span><br><span class="line"><span class="comment"> * otherwise.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEmpty</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> flushed == <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="8-5-current"><a href="#8-5-current" class="headerlink" title="8.5 current"></a>8.5 current</h2><p><code>#current()</code> æ–¹æ³•ï¼Œè·å¾—<strong>å½“å‰</strong>è¦å†™å…¥å¯¹ç«¯çš„æ¶ˆæ¯( æ•°æ® )ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the current message to write or {<span class="doctag">@code</span> null} if nothing was flushed before and so is ready to be written.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">current</span><span class="params">()</span> </span>{</span><br><span class="line">    Entry entry = flushedEntry;</span><br><span class="line">    <span class="keyword">if</span> (entry == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entry.msg;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å³ï¼Œè¿”å›çš„æ˜¯ <code>flushedEntry</code> çš„æ¶ˆæ¯( æ•°æ® )ã€‚</li>
</ul>
<h2 id="8-6-nioBuffers"><a href="#8-6-nioBuffers" class="headerlink" title="8.6 nioBuffers"></a>8.6 nioBuffers</h2><p><code>#nioBuffers(int maxCount, long maxBytes)</code> æ–¹æ³•ï¼Œè·å¾—å½“å‰è¦å†™å…¥åˆ°å¯¹ç«¯çš„ NIO ByteBuffer æ•°ç»„ï¼Œå¹¶ä¸”è·å¾—çš„æ•°ç»„å¤§å°ä¸å¾—è¶…è¿‡ <code>maxCount</code> ï¼Œå­—èŠ‚æ•°ä¸å¾—è¶…è¿‡ <code>maxBytes</code> ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨å†™å…¥æ•°æ®åˆ° ChannelOutboundBuffer æ—¶ï¼Œä¸€èˆ¬ä½¿ç”¨çš„æ˜¯ Netty ByteBuf å¯¹è±¡ï¼Œä½†æ˜¯å†™åˆ° NIO SocketChannel æ—¶ï¼Œåˆ™å¿…é¡»ä½¿ç”¨ NIO ByteBuffer å¯¹è±¡ï¼Œå› æ­¤æ‰æœ‰äº†è¿™ä¸ªæ–¹æ³•ã€‚è€ƒè™‘åˆ°æ€§èƒ½ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œä¼šä½¿ç”¨åˆ°â€œ<strong>ç¼“å­˜</strong>â€ï¼Œæ‰€ä»¥çœ‹èµ·æ¥ä¼šæ¯”è¾ƒç»•ä¸€ä¸¢ä¸¢ã€‚OKï¼Œå¼€å§‹çœ‹ä»£ç è½ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns an array of direct NIO buffers if the currently pending messages are made of {<span class="doctag">@link</span> ByteBuf} only.</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #nioBufferCount()} and {<span class="doctag">@link</span> #nioBufferSize()} will return the number of NIO buffers in the returned</span></span><br><span class="line"><span class="comment"> * array and the total number of readable bytes of the NIO buffers respectively.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Note that the returned array is reused and thus should not escape</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> AbstractChannel#doWrite(ChannelOutboundBuffer)}.</span></span><br><span class="line"><span class="comment"> * Refer to {<span class="doctag">@link</span> NioSocketChannel#doWrite(ChannelOutboundBuffer)} for an example.</span></span><br><span class="line"><span class="comment"> * &lt;/p&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> maxCount The maximum amount of buffers that will be added to the return value.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> maxBytes A hint toward the maximum number of bytes to include as part of the return value. Note that this</span></span><br><span class="line"><span class="comment"> *                 value maybe exceeded because we make a best effort to include at least 1 {<span class="doctag">@link</span> ByteBuffer}</span></span><br><span class="line"><span class="comment"> *                 in the return value to ensure write progress is made.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">     </span><br><span class="line">  <span class="number">1</span>: <span class="keyword">public</span> ByteBuffer[] nioBuffers(<span class="keyword">int</span> maxCount, <span class="keyword">long</span> maxBytes) {</span><br><span class="line">  <span class="number">2</span>:     <span class="keyword">assert</span> maxCount &gt; <span class="number">0</span>;</span><br><span class="line">  <span class="number">3</span>:     <span class="keyword">assert</span> maxBytes &gt; <span class="number">0</span>;</span><br><span class="line">  <span class="number">4</span>:     <span class="keyword">long</span> nioBufferSize = <span class="number">0</span>;</span><br><span class="line">  <span class="number">5</span>:     <span class="keyword">int</span> nioBufferCount = <span class="number">0</span>;</span><br><span class="line">  <span class="number">6</span>:     <span class="comment">// è·å¾—å½“å‰çº¿ç¨‹çš„ NIO ByteBuffer æ•°ç»„ç¼“å­˜ã€‚</span></span><br><span class="line">  <span class="number">7</span>:     <span class="keyword">final</span> InternalThreadLocalMap threadLocalMap = InternalThreadLocalMap.get();</span><br><span class="line">  <span class="number">8</span>:     ByteBuffer[] nioBuffers = NIO_BUFFERS.get(threadLocalMap);</span><br><span class="line">  <span class="number">9</span>:     <span class="comment">// ä» flushedEntry èŠ‚ç‚¹ï¼Œå¼€å§‹å‘ä¸‹éå†</span></span><br><span class="line"> <span class="number">10</span>:     Entry entry = flushedEntry;</span><br><span class="line"> <span class="number">11</span>:     <span class="keyword">while</span> (isFlushedEntry(entry) &amp;&amp; entry.msg <span class="keyword">instanceof</span> ByteBuf) {</span><br><span class="line"> <span class="number">12</span>:         <span class="comment">// è‹¥ Entry èŠ‚ç‚¹å·²ç»å–æ¶ˆï¼Œå¿½ç•¥ã€‚</span></span><br><span class="line"> <span class="number">13</span>:         <span class="keyword">if</span> (!entry.cancelled) {</span><br><span class="line"> <span class="number">14</span>:             ByteBuf buf = (ByteBuf) entry.msg;</span><br><span class="line"> <span class="number">15</span>:             <span class="comment">// è·å¾—æ¶ˆæ¯( æ•°æ® )å¼€å§‹è¯»å–ä½ç½®</span></span><br><span class="line"> <span class="number">16</span>:             <span class="keyword">final</span> <span class="keyword">int</span> readerIndex = buf.readerIndex();</span><br><span class="line"> <span class="number">17</span>:             <span class="comment">// è·å¾—æ¶ˆæ¯( æ•°æ® )å¯è¯»å–çš„å­—èŠ‚æ•°</span></span><br><span class="line"> <span class="number">18</span>:             <span class="keyword">final</span> <span class="keyword">int</span> readableBytes = buf.writerIndex() - readerIndex;</span><br><span class="line"> <span class="number">19</span>: </span><br><span class="line"> <span class="number">20</span>:             <span class="comment">// è‹¥æ— å¯è¯»å–çš„æ•°æ®ï¼Œå¿½ç•¥ã€‚</span></span><br><span class="line"> <span class="number">21</span>:             <span class="keyword">if</span> (readableBytes &gt; <span class="number">0</span>) {</span><br><span class="line"> <span class="number">22</span>:                 <span class="comment">// å‰åŠæ®µï¼Œå¯è¯»å–çš„å­—èŠ‚æ•°ï¼Œä¸èƒ½è¶…è¿‡ maxBytes</span></span><br><span class="line"> <span class="number">23</span>:                 <span class="comment">// ååŠæ®µï¼Œå¦‚æœç¬¬ä¸€æ¡æ•°æ®ï¼Œå°±å·²ç»è¶…è¿‡ maxBytes ï¼Œé‚£ä¹ˆåªèƒ½â€œå¼ºè¡Œâ€è¯»å–ï¼Œå¦åˆ™ä¼šå‡ºç°ä¸€ç›´æ— æ³•è¯»å–çš„æƒ…å†µã€‚</span></span><br><span class="line"> <span class="number">24</span>:                 <span class="keyword">if</span> (maxBytes - readableBytes &lt; nioBufferSize &amp;&amp; nioBufferCount != <span class="number">0</span>) {</span><br><span class="line"> <span class="number">25</span>:                     <span class="comment">// If the nioBufferSize + readableBytes will overflow maxBytes, and there is at least one entry</span></span><br><span class="line"> <span class="number">26</span>:                     <span class="comment">// we stop populate the ByteBuffer array. This is done for 2 reasons:</span></span><br><span class="line"> <span class="number">27</span>:                     <span class="comment">// 1. bsd/osx don't allow to write more bytes then Integer.MAX_VALUE with one writev(...) call</span></span><br><span class="line"> <span class="number">28</span>:                     <span class="comment">// and so will return 'EINVAL', which will raise an IOException. On Linux it may work depending</span></span><br><span class="line"> <span class="number">29</span>:                     <span class="comment">// on the architecture and kernel but to be safe we also enforce the limit here.</span></span><br><span class="line"> <span class="number">30</span>:                     <span class="comment">// 2. There is no sense in putting more data in the array than is likely to be accepted by the</span></span><br><span class="line"> <span class="number">31</span>:                     <span class="comment">// OS.</span></span><br><span class="line"> <span class="number">32</span>:                     <span class="comment">//</span></span><br><span class="line"> <span class="number">33</span>:                     <span class="comment">// See also:</span></span><br><span class="line"> <span class="number">34</span>:                     <span class="comment">// - https://www.freebsd.org/cgi/man.cgi?query=write&amp;sektion=2</span></span><br><span class="line"> <span class="number">35</span>:                     <span class="comment">// - http://linux.die.net/man/2/writev</span></span><br><span class="line"> <span class="number">36</span>:                     <span class="keyword">break</span>;</span><br><span class="line"> <span class="number">37</span>:                 }</span><br><span class="line"> <span class="number">38</span>:                 <span class="comment">// å¢åŠ  nioBufferSize</span></span><br><span class="line"> <span class="number">39</span>:                 nioBufferSize += readableBytes;</span><br><span class="line"> <span class="number">40</span>:                 <span class="comment">// åˆå§‹ Entry èŠ‚ç‚¹çš„ NIO ByteBuffer æ•°é‡</span></span><br><span class="line"> <span class="number">41</span>:                 <span class="keyword">int</span> count = entry.count;</span><br><span class="line"> <span class="number">42</span>:                 <span class="keyword">if</span> (count == -<span class="number">1</span>) {</span><br><span class="line"> <span class="number">43</span>:                     <span class="comment">//noinspection ConstantValueVariableUse</span></span><br><span class="line"> <span class="number">44</span>:                     entry.count = count = buf.nioBufferCount();</span><br><span class="line"> <span class="number">45</span>:                 }</span><br><span class="line"> <span class="number">46</span>:                 <span class="comment">// å¦‚æœè¶…è¿‡ NIO ByteBuffer æ•°ç»„çš„å¤§å°ï¼Œè¿›è¡Œæ‰©å®¹ã€‚</span></span><br><span class="line"> <span class="number">47</span>:                 <span class="keyword">int</span> neededSpace = min(maxCount, nioBufferCount + count);</span><br><span class="line"> <span class="number">48</span>:                 <span class="keyword">if</span> (neededSpace &gt; nioBuffers.length) {</span><br><span class="line"> <span class="number">49</span>:                     nioBuffers = expandNioBufferArray(nioBuffers, neededSpace, nioBufferCount);</span><br><span class="line"> <span class="number">50</span>:                     NIO_BUFFERS.set(threadLocalMap, nioBuffers);</span><br><span class="line"> <span class="number">51</span>:                 }</span><br><span class="line"> <span class="number">52</span>:                 <span class="comment">// åˆå§‹åŒ– Entry èŠ‚ç‚¹çš„ buf / bufs å±æ€§</span></span><br><span class="line"> <span class="number">53</span>:                 <span class="keyword">if</span> (count == <span class="number">1</span>) {</span><br><span class="line"> <span class="number">54</span>:                     ByteBuffer nioBuf = entry.buf;</span><br><span class="line"> <span class="number">55</span>:                     <span class="keyword">if</span> (nioBuf == <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">56</span>:                         <span class="comment">// cache ByteBuffer as it may need to create a new ByteBuffer instance if its a</span></span><br><span class="line"> <span class="number">57</span>:                         <span class="comment">// derived buffer</span></span><br><span class="line"> <span class="number">58</span>:                         entry.buf = nioBuf = buf.internalNioBuffer(readerIndex, readableBytes);</span><br><span class="line"> <span class="number">59</span>:                     }</span><br><span class="line"> <span class="number">60</span>:                     nioBuffers[nioBufferCount++] = nioBuf;</span><br><span class="line"> <span class="number">61</span>:                 } <span class="keyword">else</span> {</span><br><span class="line"> <span class="number">62</span>:                     ByteBuffer[] nioBufs = entry.bufs;</span><br><span class="line"> <span class="number">63</span>:                     <span class="keyword">if</span> (nioBufs == <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">64</span>:                         <span class="comment">// cached ByteBuffers as they may be expensive to create in terms</span></span><br><span class="line"> <span class="number">65</span>:                         <span class="comment">// of Object allocation</span></span><br><span class="line"> <span class="number">66</span>:                         entry.bufs = nioBufs = buf.nioBuffers();</span><br><span class="line"> <span class="number">67</span>:                     }</span><br><span class="line"> <span class="number">68</span>:                     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nioBufs.length &amp;&amp; nioBufferCount &lt; maxCount; ++i) {</span><br><span class="line"> <span class="number">69</span>:                         ByteBuffer nioBuf = nioBufs[i];</span><br><span class="line"> <span class="number">70</span>:                         <span class="keyword">if</span> (nioBuf == <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">71</span>:                             <span class="keyword">break</span>;</span><br><span class="line"> <span class="number">72</span>:                         } <span class="keyword">else</span> <span class="keyword">if</span> (!nioBuf.hasRemaining()) {</span><br><span class="line"> <span class="number">73</span>:                             <span class="keyword">continue</span>;</span><br><span class="line"> <span class="number">74</span>:                         }</span><br><span class="line"> <span class="number">75</span>:                         nioBuffers[nioBufferCount++] = nioBuf;</span><br><span class="line"> <span class="number">76</span>:                     }</span><br><span class="line"> <span class="number">77</span>:                 }</span><br><span class="line"> <span class="number">78</span>: </span><br><span class="line"> <span class="number">79</span>:                 <span class="comment">// åˆ°è¾¾ maxCount ä¸Šé™ï¼Œç»“æŸå¾ªç¯ã€‚è€è‰¿è‰¿çš„æƒ³æ³•ï¼Œè¿™é‡Œæœ€å¥½æ”¹æˆ nioBufferCount &gt;= maxCount ï¼Œæ˜¯æœ‰å¯èƒ½ä¼šè¶…è¿‡çš„</span></span><br><span class="line"> <span class="number">80</span>:                 <span class="keyword">if</span> (nioBufferCount == maxCount) {</span><br><span class="line"> <span class="number">81</span>:                     <span class="keyword">break</span>;</span><br><span class="line"> <span class="number">82</span>:                 }</span><br><span class="line"> <span class="number">83</span>:             }</span><br><span class="line"> <span class="number">84</span>:         }</span><br><span class="line"> <span class="number">85</span>: </span><br><span class="line"> <span class="number">86</span>:         <span class="comment">// ä¸‹ä¸€ä¸ª EntryèŠ‚ç‚¹</span></span><br><span class="line"> <span class="number">87</span>:         entry = entry.next;</span><br><span class="line"> <span class="number">88</span>:     }</span><br><span class="line"> <span class="number">89</span>: </span><br><span class="line"> <span class="number">90</span>:     <span class="comment">// è®¾ç½® nioBufferCount å’Œ nioBufferSize å±æ€§</span></span><br><span class="line"> <span class="number">91</span>:     <span class="keyword">this</span>.nioBufferCount = nioBufferCount;</span><br><span class="line"> <span class="number">92</span>:     <span class="keyword">this</span>.nioBufferSize = nioBufferSize;</span><br><span class="line"> <span class="number">93</span>: </span><br><span class="line"> <span class="number">94</span>:     <span class="keyword">return</span> nioBuffers;</span><br><span class="line"> <span class="number">95</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 4 è‡³ 5 è¡Œï¼šåˆå§‹ <code>nioBufferSize</code>ã€<code>nioBufferCount</code> è®¡æ•°ã€‚</li>
<li>ç¬¬ 6 è‡³ 8 è¡Œï¼šè·å¾—å½“å‰çº¿ç¨‹çš„ NIO ByteBuffer æ•°ç»„ç¼“å­˜ã€‚<ul>
<li>å…³äº InternalThreadLocalMap å’Œ FastThreadLocal ï¼Œèƒ–å‹å¯ä»¥æš‚æ—¶å¿½ç•¥ï¼Œåç»­çš„æ–‡ç« ï¼Œè¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 10 è‡³ 11 è¡Œï¼šä» <code>flushedEntry</code> èŠ‚ç‚¹ï¼Œå¼€å§‹å‘ä¸‹éå†ã€‚</p>
<ul>
<li><p>è°ƒç”¨ <code>#isFlushedEntry(Entry entry)</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºå·²ç»â€œæ ‡è®°â€ä¸º flush çš„ Entry èŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isFlushedEntry</span><span class="params">(Entry e)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> e != <span class="keyword">null</span> &amp;&amp; e != unflushedEntry;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>e != unflushedEntry</code> ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨ <a href="#">ã€Œ8.4 addFlushã€</a> æœ€åéƒ¨åˆ†è®²çš„ï¼Œæ€è€ƒä¸‹ã€‚</li>
</ul>
</li>
<li><code>entry.msg instanceof ByteBuf</code> ï¼Œæ¶ˆæ¯( æ•°æ® )ç±»å‹ä¸º ByteBuf ã€‚å®é™…ä¸Šï¼Œ<code>msg</code> çš„ç±»å‹ä¹Ÿå¯èƒ½æ˜¯ FileRegion ã€‚å¦‚æœ ChannelOutboundBuffer é‡Œçš„æ¶ˆæ¯éƒ½æ˜¯ FileRegion ç±»å‹ï¼Œé‚£å°±ä¼šå¯¼è‡´è¿™ä¸ªæ–¹æ³•è¿”å›ä¸º<strong>ç©º</strong> NIO ByteBuffer æ•°ç»„ã€‚</li>
</ul>
</li>
<li>ç¬¬ 13 è¡Œï¼šè‹¥ Entry èŠ‚ç‚¹å·²ç»å–æ¶ˆï¼Œå¿½ç•¥ã€‚</li>
<li>ç¬¬ 14 è‡³ 18 è¡Œï¼šè·å¾—æ¶ˆæ¯( æ•°æ® )å¼€å§‹è¯»å–ä½ç½®å’Œå¯è¯»å–çš„å­—èŠ‚æ•°ã€‚<ul>
<li>ç¬¬ 21 è¡Œï¼šè‹¥æ— å¯è¯»å–çš„æ•°æ®ï¼Œå¿½ç•¥ã€‚</li>
</ul>
</li>
<li>ç¬¬ 22 è‡³ 37 è¡Œï¼š<ul>
<li>å‰åŠæ®µ <code>maxBytes - readableBytes &lt; nioBufferSize</code> ï¼Œå½“å‰ ByteBuf å¯è¯»å–çš„å­—èŠ‚æ•°ï¼Œä¸èƒ½è¶…è¿‡ <code>maxBytes</code> ã€‚è¿™ä¸ªæ¯”è¾ƒå¥½ç†è§£ã€‚</li>
<li>ååŠæ®µ <code>nioBufferCount != 0</code> ï¼Œå¦‚æœ<strong>ç¬¬ä¸€æ¡</strong>æ•°æ®ï¼Œå°±å·²ç»è¶…è¿‡ <code>maxBytes</code> ï¼Œé‚£ä¹ˆåªèƒ½â€œå¼ºè¡Œâ€è¯»å–ï¼Œå¦åˆ™ä¼šå‡ºç°ä¸€ç›´æ— æ³•è¯»å–çš„æƒ…å†µ( å› ä¸ºä¸èƒ½è·³è¿‡è¿™æ¡ ğŸ˜ˆ )ã€‚</li>
</ul>
</li>
<li>ç¬¬ 39 è¡Œï¼šå¢åŠ  <code>nioBufferSize</code> ã€‚</li>
<li>ç¬¬ 40 è‡³ 45 è¡Œï¼šè°ƒç”¨ <code>ByteBuf#nioBufferCount()</code> æ–¹æ³•ï¼Œåˆå§‹ Entry èŠ‚ç‚¹çš„  <code>count</code> å±æ€§( NIO ByteBuffer æ•°é‡)ã€‚<ul>
<li>ä½¿ç”¨ <code>count == -1</code> çš„åŸå› æ˜¯ï¼Œ<code>Entry.count</code> æœªåˆå§‹åŒ–æ—¶ï¼Œä¸º <code>-1</code> ã€‚</li>
</ul>
</li>
<li>ç¬¬ 47 è‡³ 51 è¡Œï¼šå¦‚æœè¶…è¿‡ NIO ByteBuffer æ•°ç»„çš„å¤§å°ï¼Œè°ƒç”¨ <code>#expandNioBufferArray(ByteBuffer[] array, int neededSpace, int size)</code> æ–¹æ³•ï¼Œè¿›è¡Œæ‰©å®¹ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8.6.1 expandNioBufferArrayã€</a> ã€‚</li>
<li>ç¬¬ 52 è‡³ 77 è¡Œï¼šåˆå§‹ Entry èŠ‚ç‚¹çš„  <code>buf</code> æˆ– <code>bufs</code> å±æ€§ã€‚<ul>
<li>å½“ <code>count = 1</code> æ—¶ï¼Œè°ƒç”¨ <code>ByteBuf#internalNioBuffer(readerIndex, readableBytes)</code> æ–¹æ³•ï¼Œè·å¾— NIO ByteBuffer å¯¹è±¡ã€‚</li>
<li>å½“ <code>count &gt; 1</code> æ—¶ï¼Œè°ƒç”¨ <code>ByteBuf#nioBuffers()</code> æ–¹æ³•ï¼Œè·å¾— NIO ByteBuffer æ•°ç»„ã€‚</li>
<li>é€šè¿‡ <code>nioBuffers[nioBufferCount++] = nioBuf</code> ï¼Œå°† NIO ByteBuffer èµ‹å€¼åˆ°ç»“æœæ•°ç»„ <code>nioBuffers</code> ä¸­ï¼Œå¹¶å¢åŠ  <code>nioBufferCount</code> ã€‚</li>
</ul>
</li>
<li>ç¬¬ 79 è‡³ 82 è¡Œï¼šåˆ°è¾¾ <code>maxCount</code> ä¸Šé™ï¼Œç»“æŸå¾ªç¯ã€‚è€è‰¿è‰¿çš„æƒ³æ³•ï¼Œè¿™é‡Œæœ€å¥½æ”¹æˆ <code>nioBufferCount &gt;= maxCount</code> ï¼Œæ˜¯æœ‰å¯èƒ½ä¼šè¶…è¿‡çš„ã€‚</li>
<li>ç¬¬ 87 è¡Œï¼š<strong>ä¸‹ä¸€ä¸ª Entry èŠ‚ç‚¹</strong>ã€‚</li>
<li>ç¬¬ 90 è‡³ 92 è¡Œï¼šè®¾ç½® ChannelOutboundBuffer çš„ <code>nioBufferCount</code> å’Œ <code>nioBufferSize</code> å±æ€§ã€‚</li>
</ul>
<h3 id="8-6-1-expandNioBufferArray"><a href="#8-6-1-expandNioBufferArray" class="headerlink" title="8.6.1 expandNioBufferArray"></a>8.6.1 expandNioBufferArray</h3><p><code>#expandNioBufferArray(ByteBuffer[] array, int neededSpace, int size)</code> æ–¹æ³•ï¼Œè¿›è¡Œ NIO ByteBuff æ•°ç»„çš„<strong>æ‰©å®¹</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ByteBuffer[] expandNioBufferArray(ByteBuffer[] array, <span class="keyword">int</span> neededSpace, <span class="keyword">int</span> size) {</span><br><span class="line">    <span class="comment">// è®¡ç®—æ‰©å®¹åçš„æ•°ç»„çš„å¤§å°ï¼ŒæŒ‰ç…§ 2 å€è®¡ç®—</span></span><br><span class="line">    <span class="keyword">int</span> newCapacity = array.length;</span><br><span class="line">    <span class="keyword">do</span> {</span><br><span class="line">        <span class="comment">// double capacity until it is big enough</span></span><br><span class="line">        <span class="comment">// See https://github.com/netty/netty/issues/1890</span></span><br><span class="line">        newCapacity &lt;&lt;= <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (newCapacity &lt; <span class="number">0</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    } <span class="keyword">while</span> (neededSpace &gt; newCapacity);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºæ–°çš„ ByteBuffer æ•°ç»„</span></span><br><span class="line">    ByteBuffer[] newArray = <span class="keyword">new</span> ByteBuffer[newCapacity];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤åˆ¶è€çš„ ByteBuffer æ•°ç»„åˆ°æ–°çš„ ByteBuffer æ•°ç»„ä¸­</span></span><br><span class="line">    System.arraycopy(array, <span class="number">0</span>, newArray, <span class="number">0</span>, size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newArray;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹æ³¨é‡Šã€‚</li>
</ul>
<h3 id="8-6-2-nioBufferCount"><a href="#8-6-2-nioBufferCount" class="headerlink" title="8.6.2 nioBufferCount"></a>8.6.2 nioBufferCount</h3><p><code>#nioBufferCount()</code> æ–¹æ³•ï¼Œè¿”å› <code>nioBufferCount</code> å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns the number of {<span class="doctag">@link</span> ByteBuffer} that can be written out of the {<span class="doctag">@link</span> ByteBuffer} array that was</span></span><br><span class="line"><span class="comment"> * obtained via {<span class="doctag">@link</span> #nioBuffers()}. This method &lt;strong&gt;MUST&lt;/strong&gt; be called after {<span class="doctag">@link</span> #nioBuffers()}</span></span><br><span class="line"><span class="comment"> * was called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">nioBufferCount</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> nioBufferCount;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="8-6-3-nioBufferSize"><a href="#8-6-3-nioBufferSize" class="headerlink" title="8.6.3 nioBufferSize"></a>8.6.3 nioBufferSize</h3><p><code>#nioBufferSize()</code> æ–¹æ³•ï¼Œè¿”å› <code>nioBufferSize</code> å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns the number of bytes that can be written out of the {<span class="doctag">@link</span> ByteBuffer} array that was</span></span><br><span class="line"><span class="comment"> * obtained via {<span class="doctag">@link</span> #nioBuffers()}. This method &lt;strong&gt;MUST&lt;/strong&gt; be called after {<span class="doctag">@link</span> #nioBuffers()}</span></span><br><span class="line"><span class="comment"> * was called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">nioBufferSize</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> nioBufferSize;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="8-7-removeBytes"><a href="#8-7-removeBytes" class="headerlink" title="8.7 removeBytes"></a>8.7 removeBytes</h2><p><code>#removeBytes(long writtenBytes)</code> æ–¹æ³•ï¼Œç§»é™¤å·²ç»å†™å…¥ <code>writtenBytes</code> å­—èŠ‚å¯¹åº”çš„ Entry å¯¹è±¡ / å¯¹è±¡ä»¬ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeBytes</span><span class="params">(<span class="keyword">long</span> writtenBytes)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// å¾ªç¯ç§»é™¤</span></span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">for</span> (;;) {</span><br><span class="line"> <span class="number">4</span>:         <span class="comment">// è·å¾—å½“å‰æ¶ˆæ¯( æ•°æ® )</span></span><br><span class="line"> <span class="number">5</span>:         Object msg = current();</span><br><span class="line"> <span class="number">6</span>:         <span class="keyword">if</span> (!(msg <span class="keyword">instanceof</span> ByteBuf)) {</span><br><span class="line"> <span class="number">7</span>:             <span class="keyword">assert</span> writtenBytes == <span class="number">0</span>;</span><br><span class="line"> <span class="number">8</span>:             <span class="keyword">break</span>;</span><br><span class="line"> <span class="number">9</span>:         }</span><br><span class="line"><span class="number">10</span>: </span><br><span class="line"><span class="number">11</span>:         <span class="keyword">final</span> ByteBuf buf = (ByteBuf) msg;</span><br><span class="line"><span class="number">12</span>:         <span class="comment">// è·å¾—æ¶ˆæ¯( æ•°æ® )å¼€å§‹è¯»å–ä½ç½®</span></span><br><span class="line"><span class="number">13</span>:         <span class="keyword">final</span> <span class="keyword">int</span> readerIndex = buf.readerIndex();</span><br><span class="line"><span class="number">14</span>:         <span class="comment">// è·å¾—æ¶ˆæ¯( æ•°æ® )å¯è¯»å–çš„å­—èŠ‚æ•°</span></span><br><span class="line"><span class="number">15</span>:         <span class="keyword">final</span> <span class="keyword">int</span> readableBytes = buf.writerIndex() - readerIndex;</span><br><span class="line"><span class="number">16</span>: </span><br><span class="line"><span class="number">17</span>:         <span class="comment">// å½“å‰æ¶ˆæ¯( æ•°æ® )å·²è¢«å†™å®Œåˆ°å¯¹ç«¯</span></span><br><span class="line"><span class="number">18</span>:         <span class="keyword">if</span> (readableBytes &lt;= writtenBytes) {</span><br><span class="line"><span class="number">19</span>:             <span class="keyword">if</span> (writtenBytes != <span class="number">0</span>) {</span><br><span class="line"><span class="number">20</span>:                 <span class="comment">// å¤„ç†å½“å‰æ¶ˆæ¯çš„ Entry çš„å†™å…¥è¿›åº¦</span></span><br><span class="line"><span class="number">21</span>:                 progress(readableBytes);</span><br><span class="line"><span class="number">22</span>:                 <span class="comment">// å‡å° writtenBytes</span></span><br><span class="line"><span class="number">23</span>:                 writtenBytes -= readableBytes;</span><br><span class="line"><span class="number">24</span>:             }</span><br><span class="line"><span class="number">25</span>:             <span class="comment">// ç§»é™¤å½“å‰æ¶ˆæ¯å¯¹åº”çš„ Entry</span></span><br><span class="line"><span class="number">26</span>:             remove();</span><br><span class="line"><span class="number">27</span>:         <span class="comment">// å½“å‰æ¶ˆæ¯( æ•°æ® )æœªè¢«å†™å®Œåˆ°å¯¹ç«¯</span></span><br><span class="line"><span class="number">28</span>:         } <span class="keyword">else</span> { <span class="comment">// readableBytes &gt; writtenBytes</span></span><br><span class="line"><span class="number">29</span>:             <span class="keyword">if</span> (writtenBytes != <span class="number">0</span>) {</span><br><span class="line"><span class="number">30</span>:                 <span class="comment">// æ ‡è®°å½“å‰æ¶ˆæ¯çš„ ByteBuf çš„è¯»å–ä½ç½®</span></span><br><span class="line"><span class="number">31</span>:                 buf.readerIndex(readerIndex + (<span class="keyword">int</span>) writtenBytes);</span><br><span class="line"><span class="number">32</span>:                 <span class="comment">// å¤„ç†å½“å‰æ¶ˆæ¯çš„ Entry çš„å†™å…¥è¿›åº¦</span></span><br><span class="line"><span class="number">33</span>:                 progress(writtenBytes);</span><br><span class="line"><span class="number">34</span>:             }</span><br><span class="line"><span class="number">35</span>:             <span class="keyword">break</span>;</span><br><span class="line"><span class="number">36</span>:         }</span><br><span class="line"><span class="number">37</span>:     }</span><br><span class="line"><span class="number">38</span>: </span><br><span class="line"><span class="number">39</span>:     <span class="comment">// æ¸…é™¤ NIO ByteBuff æ•°ç»„çš„ç¼“å­˜</span></span><br><span class="line"><span class="number">40</span>:     clearNioBuffers();</span><br><span class="line"><span class="number">41</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼š<strong>å¾ªç¯</strong>ï¼Œç§»é™¤å·²ç»å†™å…¥ <code>writtenBytes</code> å­—èŠ‚å¯¹åº”çš„ Entry å¯¹è±¡ã€‚<ul>
<li>ç¬¬ 5 è¡Œï¼šè°ƒç”¨ <code>#current()</code> æ–¹æ³•ï¼Œè·å¾—å½“å‰æ¶ˆæ¯( æ•°æ® )ã€‚</li>
<li>ç¬¬ 12 è‡³ 15 è¡Œï¼šè·å¾—æ¶ˆæ¯( æ•°æ® )å¼€å§‹è¯»å–ä½ç½®å’Œå¯è¯»å–çš„å­—èŠ‚æ•°ã€‚</li>
<li><code>&lt;1&gt;</code> å½“å‰æ¶ˆæ¯( æ•°æ® )<strong>å·²</strong>è¢«å†™å®Œåˆ°å¯¹ç«¯ã€‚</li>
<li>ç¬¬ 21 è¡Œï¼šè°ƒç”¨ <code>#progress(long amount)</code> æ–¹æ³•ï¼Œå¤„ç†å½“å‰æ¶ˆæ¯çš„ Entry çš„å†™å…¥è¿›åº¦ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8.7.1 progressã€</a> ã€‚</li>
<li>ç¬¬ 23 è¡Œï¼šå‡å° <code>writtenBytes</code> ã€‚</li>
<li>ç¬¬ 26 è¡Œï¼šè°ƒç”¨ <code>#remove()</code> æ–¹æ³•ï¼Œç§»é™¤å½“å‰æ¶ˆæ¯å¯¹åº”çš„ Entry å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8.7.2 removeã€</a> ã€‚</li>
<li><code>&lt;2ã€‹</code> å½“å‰æ¶ˆæ¯( æ•°æ® )<strong>æœª</strong>è¢«å†™å®Œåˆ°å¯¹ç«¯ã€‚</li>
<li>ç¬¬ 31 è¡Œï¼šè°ƒç”¨ <code>ByteBuf#readerIndex(readerIndex)</code> æ–¹æ³•ï¼Œæ ‡è®°å½“å‰æ¶ˆæ¯çš„ ByteBuf çš„<strong>è¯»å–ä½ç½®</strong>ã€‚</li>
<li>ç¬¬ 33 è¡Œï¼šè°ƒç”¨ <code>#progress(long amount)</code> æ–¹æ³•ï¼Œå¤„ç†å½“å‰æ¶ˆæ¯çš„ Entry çš„å†™å…¥è¿›åº¦ã€‚</li>
<li>ç¬¬ 35 è¡Œï¼š<code>break</code> ï¼Œç»“æŸå¾ªç¯ã€‚</li>
</ul>
</li>
<li>ç¬¬ 40 è¡Œï¼šè°ƒç”¨ <code>#clearNioBuffers()</code> æ–¹æ³•ï¼Œ<strong>æ¸…é™¤</strong> NIO ByteBuff æ•°ç»„çš„ç¼“å­˜ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8.7.4 clearNioBuffersã€</a> ã€‚ </li>
</ul>
<h3 id="8-7-1-progress"><a href="#8-7-1-progress" class="headerlink" title="8.7.1 progress"></a>8.7.1 progress</h3><p><code>#progress(long amount)</code> æ–¹æ³•ï¼Œå¤„ç†å½“å‰æ¶ˆæ¯çš„ Entry çš„å†™å…¥è¿›åº¦ï¼Œä¸»è¦æ˜¯<strong>é€šçŸ¥</strong> Promise æ¶ˆæ¯å†™å…¥çš„è¿›åº¦ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Notify the {<span class="doctag">@link</span> ChannelPromise} of the current message about writing progress.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">progress</span><span class="params">(<span class="keyword">long</span> amount)</span> </span>{</span><br><span class="line">  <span class="number">2</span>:     Entry e = flushedEntry;</span><br><span class="line">  <span class="number">3</span>:     <span class="keyword">assert</span> e != <span class="keyword">null</span>;</span><br><span class="line">  <span class="number">4</span>:     ChannelPromise p = e.promise;</span><br><span class="line">  <span class="number">5</span>:     <span class="keyword">if</span> (p <span class="keyword">instanceof</span> ChannelProgressivePromise) {</span><br><span class="line">  <span class="number">6</span>:         <span class="comment">// è®¾ç½® Entry å¯¹è±¡çš„ progress å±æ€§</span></span><br><span class="line">  <span class="number">7</span>:         <span class="keyword">long</span> progress = e.progress + amount;</span><br><span class="line">  <span class="number">8</span>:         e.progress = progress;</span><br><span class="line">  <span class="number">9</span>:         <span class="comment">// é€šçŸ¥ ChannelProgressivePromise è¿›åº¦</span></span><br><span class="line"> <span class="number">10</span>:         ((ChannelProgressivePromise) p).tryProgress(progress, e.total);</span><br><span class="line"> <span class="number">11</span>:     }</span><br><span class="line"> <span class="number">12</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 5 è¡Œï¼šè‹¥ <code>promise</code> çš„ç±»å‹æ˜¯ ChannelProgressivePromise ç±»å‹ã€‚</li>
<li>ç¬¬ 6 è‡³ 8 è¡Œï¼šè®¾ç½® Entry å¯¹è±¡çš„ <code>progress</code> å±æ€§ã€‚</li>
<li>ç¬¬ 10 è¡Œï¼šè°ƒç”¨ <code>ChannelProgressivePromise#tryProgress(progress, total)</code> æ–¹æ³•ï¼Œé€šçŸ¥ ChannelProgressivePromise è¿›åº¦ã€‚</li>
</ul>
<h3 id="8-7-2-remove"><a href="#8-7-2-remove" class="headerlink" title="8.7.2 remove"></a>8.7.2 remove</h3><p><code>#remove()</code> æ–¹æ³•ï¼Œç§»é™¤å½“å‰æ¶ˆæ¯å¯¹åº”çš„ Entry å¯¹è±¡ï¼Œå¹¶ Promise é€šçŸ¥æˆåŠŸã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     Entry e = flushedEntry;</span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (e == <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">4</span>:         <span class="comment">// æ¸…é™¤ NIO ByteBuff æ•°ç»„çš„ç¼“å­˜</span></span><br><span class="line"> <span class="number">5</span>:         clearNioBuffers();</span><br><span class="line"> <span class="number">6</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"> <span class="number">7</span>:     }</span><br><span class="line"> <span class="number">8</span>:     Object msg = e.msg;</span><br><span class="line"> <span class="number">9</span>: </span><br><span class="line"><span class="number">10</span>:     ChannelPromise promise = e.promise;</span><br><span class="line"><span class="number">11</span>:     <span class="keyword">int</span> size = e.pendingSize;</span><br><span class="line"><span class="number">12</span>: </span><br><span class="line"><span class="number">13</span>:     <span class="comment">// ç§»é™¤æŒ‡å®š Entry å¯¹è±¡</span></span><br><span class="line"><span class="number">14</span>:     removeEntry(e);</span><br><span class="line"><span class="number">15</span>: </span><br><span class="line"><span class="number">16</span>:     <span class="keyword">if</span> (!e.cancelled) {</span><br><span class="line"><span class="number">17</span>:         <span class="comment">// é‡Šæ”¾æ¶ˆæ¯( æ•°æ® )ç›¸å…³çš„èµ„æº</span></span><br><span class="line"><span class="number">18</span>:         <span class="comment">// only release message, notify and decrement if it was not canceled before.</span></span><br><span class="line"><span class="number">19</span>:         ReferenceCountUtil.safeRelease(msg);</span><br><span class="line"><span class="number">20</span>:         <span class="comment">// é€šçŸ¥ Promise æ‰§è¡ŒæˆåŠŸ</span></span><br><span class="line"><span class="number">21</span>:         safeSuccess(promise);</span><br><span class="line"><span class="number">22</span>:         <span class="comment">// å‡å°‘ totalPending è®¡æ•°</span></span><br><span class="line"><span class="number">23</span>:         decrementPendingOutboundBytes(size, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">24</span>:     }</span><br><span class="line"><span class="number">25</span>: </span><br><span class="line"><span class="number">26</span>:     <span class="comment">// å›æ”¶ Entry å¯¹è±¡</span></span><br><span class="line"><span class="number">27</span>:     <span class="comment">// recycle the entry</span></span><br><span class="line"><span class="number">28</span>:     e.recycle();</span><br><span class="line"><span class="number">29</span>: </span><br><span class="line"><span class="number">30</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">31</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 14 è¡Œï¼šè°ƒç”¨ <code>#removeEntry(Entry e)</code> æ–¹æ³•ï¼Œç§»é™¤<strong>æŒ‡å®š</strong> Entry å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8.7.3 removeEntryã€</a> ã€‚</li>
<li>ç¬¬ 16 è¡Œï¼šè‹¥ Entry å·²å–æ¶ˆï¼Œåˆ™å¿½ç•¥ã€‚</li>
<li>ç¬¬ 19 è¡Œï¼š<code>ReferenceCountUtil#safeRelease(msg)</code> æ–¹æ³•ï¼Œé‡Šæ”¾æ¶ˆæ¯( æ•°æ® )ç›¸å…³çš„èµ„æºã€‚</li>
<li><p>ç¬¬ 21 è¡Œï¼šã€<strong>é‡è¦</strong>ã€‘è°ƒç”¨ <code>#safeSuccess(promise)</code> æ–¹æ³•ï¼Œé€šçŸ¥ Promise æ‰§è¡ŒæˆåŠŸã€‚æ­¤å¤„æ‰æ˜¯ï¼ŒçœŸæ­£è§¦å‘ <code>Channel#write(...)</code> æˆ– <code>Channel#writeAndFlush(...)</code> æ–¹æ³•ï¼Œè¿”å›çš„ Promise çš„é€šçŸ¥ã€‚<code>#safeSuccess(promise)</code> æ–¹æ³•çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">safeSuccess</span><span class="params">(ChannelPromise promise)</span> </span>{</span><br><span class="line">    <span class="comment">// Only log if the given promise is not of type VoidChannelPromise as trySuccess(...) is expected to return</span></span><br><span class="line">    <span class="comment">// false.</span></span><br><span class="line">    PromiseNotificationUtil.trySuccess(promise, <span class="keyword">null</span>, promise <span class="keyword">instanceof</span> VoidChannelPromise ? <span class="keyword">null</span> : logger);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ç¬¬ 23 è¡Œï¼š<code>#decrementPendingOutboundBytes(long size, ...)</code> æ–¹æ³•ï¼Œå‡å°‘ <code>totalPendingSize</code> è®¡æ•°ã€‚</p>
</li>
<li>ç¬¬ 28 è¡Œï¼šè°ƒç”¨ <code>Entry#recycle()</code> æ–¹æ³•ï¼Œ<strong>å›æ”¶</strong> Entry å¯¹è±¡ã€‚</li>
</ul>
<h3 id="8-7-3-removeEntry"><a href="#8-7-3-removeEntry" class="headerlink" title="8.7.3 removeEntry"></a>8.7.3 removeEntry</h3><p><code>#removeEntry(Entry e)</code> æ–¹æ³•ï¼Œç§»é™¤<strong>æŒ‡å®š</strong> Entry å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeEntry</span><span class="params">(Entry e)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// å·²ç§»é™¤å®Œå·² flush çš„ Entry èŠ‚ç‚¹ï¼Œç½®ç©º flushedEntryã€tailEntryã€unflushedEntry ã€‚</span></span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (-- flushed == <span class="number">0</span>) {</span><br><span class="line"> <span class="number">4</span>:         <span class="comment">// processed everything</span></span><br><span class="line"> <span class="number">5</span>:         flushedEntry = <span class="keyword">null</span>;</span><br><span class="line"> <span class="number">6</span>:         <span class="keyword">if</span> (e == tailEntry) {</span><br><span class="line"> <span class="number">7</span>:             tailEntry = <span class="keyword">null</span>;</span><br><span class="line"> <span class="number">8</span>:             unflushedEntry = <span class="keyword">null</span>;</span><br><span class="line"> <span class="number">9</span>:         }</span><br><span class="line"><span class="number">10</span>:     <span class="comment">// æœªç§»é™¤å®Œå·² flush çš„ Entry èŠ‚ç‚¹ï¼ŒflushedEntry æŒ‡å‘ä¸‹ä¸€ä¸ª Entry å¯¹è±¡</span></span><br><span class="line"><span class="number">11</span>:     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">12</span>:         flushedEntry = e.next;</span><br><span class="line"><span class="number">13</span>:     }</span><br><span class="line"><span class="number">14</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è‡³ 9 è¡Œï¼š<strong>å·²</strong>ç§»é™¤å®Œå·² flush çš„<strong>æ‰€æœ‰</strong> Entry èŠ‚ç‚¹ï¼Œç½®ç©º <code>flushedEntry</code>ã€<code>tailEntry</code>ã€<code>unflushedEntry</code> ã€‚</li>
<li>ç¬¬ 10 è‡³ 13 è¡Œï¼š<strong>æœª</strong>ç§»é™¤å®Œå·² flush çš„<strong>æ‰€æœ‰</strong> Entry èŠ‚ç‚¹ï¼Œ<code>flushedEntry</code> æŒ‡å‘<strong>ä¸‹ä¸€ä¸ª</strong> Entry å¯¹è±¡ã€‚</li>
</ul>
<h3 id="8-7-4-clearNioBuffers"><a href="#8-7-4-clearNioBuffers" class="headerlink" title="8.7.4 clearNioBuffers"></a>8.7.4 clearNioBuffers</h3><p><code>#clearNioBuffers()</code> æ–¹æ³•ï¼Œ<strong>æ¸…é™¤</strong> NIO ByteBuff æ•°ç»„çš„ç¼“å­˜ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Clear all ByteBuffer from the array so these can be GC'ed.</span></span><br><span class="line"><span class="comment">// See https://github.com/netty/netty/issues/3837</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearNioBuffers</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">int</span> count = nioBufferCount;</span><br><span class="line">    <span class="keyword">if</span> (count &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="comment">// å½’é›¶ nioBufferCount ã€‚è€è‰¿è‰¿è§‰å¾—ï¼Œåº”è¯¥æŠŠ nioBufferSize ä¹Ÿå½’é›¶</span></span><br><span class="line">        nioBufferCount = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// ç½®ç©º NIO ByteBuf æ•°ç»„</span></span><br><span class="line">        Arrays.fill(NIO_BUFFERS.get(), <span class="number">0</span>, count, <span class="keyword">null</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚ä¸»è¦ç›®çš„æ˜¯ help gc ã€‚</li>
</ul>
<h2 id="8-8-failFlushed"><a href="#8-8-failFlushed" class="headerlink" title="8.8 failFlushed"></a>8.8 failFlushed</h2><p><code>#failFlushed(Throwable cause, boolean notify)</code> æ–¹æ³•ï¼Œå†™å…¥æ•°æ®åˆ°å¯¹ç«¯<strong>å¤±è´¥</strong>ï¼Œè¿›è¡Œåç»­çš„å¤„ç†ï¼Œè¯¦ç»†çœ‹ä»£ç ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">void</span> <span class="title">failFlushed</span><span class="params">(Throwable cause, <span class="keyword">boolean</span> notify)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// æ­£åœ¨é€šçŸ¥ flush å¤±è´¥ä¸­ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// Make sure that this method does not reenter.  A listener added to the current promise can be notified by the</span></span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// current thread in the tryFailure() call of the loop below, and the listener can trigger another fail() call</span></span><br><span class="line"> <span class="number">5</span>:     <span class="comment">// indirectly (usually by closing the channel.)</span></span><br><span class="line"> <span class="number">6</span>:     <span class="comment">//</span></span><br><span class="line"> <span class="number">7</span>:     <span class="comment">// See https://github.com/netty/netty/issues/1501</span></span><br><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (inFail) {</span><br><span class="line"> <span class="number">9</span>:         <span class="keyword">return</span>;</span><br><span class="line"><span class="number">10</span>:     }</span><br><span class="line"><span class="number">11</span>: </span><br><span class="line"><span class="number">12</span>:     <span class="keyword">try</span> {</span><br><span class="line"><span class="number">13</span>:         <span class="comment">// æ ‡è®°æ­£åœ¨é€šçŸ¥ flush å¤±è´¥ä¸­</span></span><br><span class="line"><span class="number">14</span>:         inFail = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">15</span>:         <span class="comment">// å¾ªç¯ï¼Œç§»é™¤æ‰€æœ‰å·² flush çš„ Entry èŠ‚ç‚¹ä»¬</span></span><br><span class="line"><span class="number">16</span>:         <span class="keyword">for</span> (;;) {</span><br><span class="line"><span class="number">17</span>:             <span class="keyword">if</span> (!remove0(cause, notify)) {</span><br><span class="line"><span class="number">18</span>:                 <span class="keyword">break</span>;</span><br><span class="line"><span class="number">19</span>:             }</span><br><span class="line"><span class="number">20</span>:         }</span><br><span class="line"><span class="number">21</span>:     } <span class="keyword">finally</span> {</span><br><span class="line"><span class="number">22</span>:         <span class="comment">// æ ‡è®°ä¸åœ¨é€šçŸ¥ flush å¤±è´¥ä¸­</span></span><br><span class="line"><span class="number">23</span>:         inFail = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">24</span>:     }</span><br><span class="line"><span class="number">25</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 2 è‡³ 10 è¡Œï¼šæ­£åœ¨é€šçŸ¥ flush å¤±è´¥ä¸­ï¼Œç›´æ¥è¿”å›ã€‚</li>
<li>ç¬¬ 14 è¡Œï¼šæ ‡è®°æ­£åœ¨é€šçŸ¥ flush å¤±è´¥ä¸­ï¼Œå³ <code>inFail = true</code> ã€‚</li>
<li>ç¬¬ 15 è‡³ 20 è¡Œï¼šå¾ªç¯ï¼Œè°ƒç”¨ <code>#remove0(Throwable cause, boolean notifyWritability)</code> æ–¹æ³•ï¼Œç§»é™¤<strong>æ‰€æœ‰</strong>å·² flush çš„ Entry èŠ‚ç‚¹ä»¬ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8. remove0ã€</a> ä¸­ã€‚</li>
<li>ç¬¬ 21 è‡³ 24 è¡Œï¼šæ ‡è®°ä¸åœ¨é€šçŸ¥ flush å¤±è´¥ä¸­ï¼Œå³ <code>inFail = false</code> ã€‚</li>
</ul>
<h3 id="8-8-1-remove0"><a href="#8-8-1-remove0" class="headerlink" title="8.8.1 remove0"></a>8.8.1 remove0</h3><p><code>#remove0(Throwable cause, boolean notifyWritability)</code> æ–¹æ³•ï¼Œç§»é™¤å½“å‰æ¶ˆæ¯å¯¹åº”çš„ Entry å¯¹è±¡ï¼Œå¹¶ Promise é€šçŸ¥å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">remove0</span><span class="params">(Throwable cause, <span class="keyword">boolean</span> notifyWritability)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     Entry e = flushedEntry;</span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// æ‰€æœ‰ flush çš„ Entry èŠ‚ç‚¹ï¼Œéƒ½å·²ç»å†™åˆ°å¯¹ç«¯</span></span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (e == <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">5</span>:         <span class="comment">// // æ¸…é™¤ NIO ByteBuff æ•°ç»„çš„ç¼“å­˜</span></span><br><span class="line"> <span class="number">6</span>:         clearNioBuffers();</span><br><span class="line"> <span class="number">7</span>:         <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// æ²¡æœ‰åç»­çš„ flush çš„ Entry èŠ‚ç‚¹</span></span><br><span class="line"> <span class="number">8</span>:     }</span><br><span class="line"> <span class="number">9</span>:     Object msg = e.msg;</span><br><span class="line"><span class="number">10</span>: </span><br><span class="line"><span class="number">11</span>:     ChannelPromise promise = e.promise;</span><br><span class="line"><span class="number">12</span>:     <span class="keyword">int</span> size = e.pendingSize;</span><br><span class="line"><span class="number">13</span>: </span><br><span class="line"><span class="number">14</span>:     removeEntry(e);</span><br><span class="line"><span class="number">15</span>: </span><br><span class="line"><span class="number">16</span>:     <span class="keyword">if</span> (!e.cancelled) {</span><br><span class="line"><span class="number">17</span>:         <span class="comment">// é‡Šæ”¾æ¶ˆæ¯( æ•°æ® )ç›¸å…³çš„èµ„æº</span></span><br><span class="line"><span class="number">18</span>:         <span class="comment">// only release message, fail and decrement if it was not canceled before.</span></span><br><span class="line"><span class="number">19</span>:         ReferenceCountUtil.safeRelease(msg);</span><br><span class="line"><span class="number">20</span>:         <span class="comment">// é€šçŸ¥ Promise æ‰§è¡Œå¤±è´¥</span></span><br><span class="line"><span class="number">21</span>:         safeFail(promise, cause);</span><br><span class="line"><span class="number">22</span>:         <span class="comment">// å‡å°‘ totalPendingSize è®¡æ•°</span></span><br><span class="line"><span class="number">23</span>:         decrementPendingOutboundBytes(size, <span class="keyword">false</span>, notifyWritability);</span><br><span class="line"><span class="number">24</span>:     }</span><br><span class="line"><span class="number">25</span>: </span><br><span class="line"><span class="number">26</span>:     <span class="comment">// å›æ”¶ Entry å¯¹è±¡</span></span><br><span class="line"><span class="number">27</span>:     <span class="comment">// recycle the entry</span></span><br><span class="line"><span class="number">28</span>:     e.recycle();</span><br><span class="line"><span class="number">29</span>: </span><br><span class="line"><span class="number">30</span>:     <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// è¿˜æœ‰åç»­çš„ flush çš„ Entry èŠ‚ç‚¹</span></span><br><span class="line"><span class="number">31</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è‡³ 8 è¡Œï¼šè‹¥<strong>æ‰€æœ‰</strong> flush çš„ Entry èŠ‚ç‚¹ï¼Œéƒ½å·²ç»å†™åˆ°å¯¹ç«¯ï¼Œåˆ™è°ƒç”¨ <code>#clearNioBuffers()</code> æ–¹æ³•ï¼Œæ¸…é™¤ NIO ByteBuff æ•°ç»„çš„ç¼“å­˜ã€‚</li>
<li>ç¬¬ 14 è¡Œï¼šè°ƒç”¨ <code>#removeEntry(Entry e)</code> æ–¹æ³•ï¼Œç§»é™¤<strong>æŒ‡å®š</strong> Entry å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8.7.3 removeEntryã€</a> ã€‚</li>
<li>ç¬¬ 16 è¡Œï¼šè‹¥ Entry å·²å–æ¶ˆï¼Œåˆ™å¿½ç•¥ã€‚</li>
<li>ç¬¬ 19 è¡Œï¼š<code>ReferenceCountUtil#safeRelease(msg)</code> æ–¹æ³•ï¼Œé‡Šæ”¾æ¶ˆæ¯( æ•°æ® )ç›¸å…³çš„èµ„æºã€‚</li>
<li><p>ç¬¬ 21 è¡Œï¼šã€<strong>é‡è¦</strong>ã€‘è°ƒç”¨ <code>#safeFail(promise)</code> æ–¹æ³•ï¼Œé€šçŸ¥ Promise æ‰§è¡Œå¤±è´¥ã€‚æ­¤å¤„æ‰æ˜¯ï¼ŒçœŸæ­£è§¦å‘ <code>Channel#write(...)</code> æˆ– <code>Channel#writeAndFlush(...)</code> æ–¹æ³•ï¼Œè¿”å›çš„ Promise çš„é€šçŸ¥ã€‚<code>#safeFail(promise)</code> æ–¹æ³•çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">safeFail</span><span class="params">(ChannelPromise promise, Throwable cause)</span> </span>{</span><br><span class="line">    <span class="comment">// Only log if the given promise is not of type VoidChannelPromise as tryFailure(...) is expected to return</span></span><br><span class="line">    <span class="comment">// false.</span></span><br><span class="line">    PromiseNotificationUtil.tryFailure(promise, cause, promise <span class="keyword">instanceof</span> VoidChannelPromise ? <span class="keyword">null</span> : logger);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ç¬¬ 23 è¡Œï¼šè°ƒç”¨ <code>#decrementPendingOutboundBytes(long size, ...)</code> æ–¹æ³•ï¼Œå‡å°‘ <code>totalPendingSize</code> è®¡æ•°ã€‚</p>
</li>
<li>ç¬¬ 28 è¡Œï¼šè°ƒç”¨ <code>Entry#recycle()</code> æ–¹æ³•ï¼Œ<strong>å›æ”¶</strong> Entry å¯¹è±¡ã€‚</li>
</ul>
<h2 id="8-9-forEachFlushedMessage"><a href="#8-9-forEachFlushedMessage" class="headerlink" title="8.9 forEachFlushedMessage"></a>8.9 forEachFlushedMessage</h2><p>TODO 1015 forEachFlushedMessage åœ¨ <code>netty-transport-native-poll</code> å’Œ <code>netty-transport-native-kqueue</code> ä¸­ä½¿ç”¨ï¼Œåœ¨åç»­çš„æ–‡ç« è§£æã€‚</p>
<h2 id="8-10-close"><a href="#8-10-close" class="headerlink" title="8.10 close"></a>8.10 close</h2><p><code>#close(...)</code> æ–¹æ³•ï¼Œå…³é—­ ChannelOutboundBuffer ï¼Œè¿›è¡Œåç»­çš„å¤„ç†ï¼Œè¯¦ç»†çœ‹ä»£ç ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">(ClosedChannelException cause)</span> </span>{</span><br><span class="line">    close(cause, <span class="keyword">false</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">final</span> Throwable cause, <span class="keyword">final</span> <span class="keyword">boolean</span> allowChannelOpen)</span> </span>{</span><br><span class="line">  <span class="number">2</span>:     <span class="comment">// æ­£åœ¨é€šçŸ¥ flush å¤±è´¥ä¸­</span></span><br><span class="line">  <span class="number">3</span>:     <span class="keyword">if</span> (inFail) {</span><br><span class="line">  <span class="number">4</span>:         <span class="comment">// æäº¤ EventLoop çš„çº¿ç¨‹ä¸­ï¼Œæ‰§è¡Œå…³é—­</span></span><br><span class="line">  <span class="number">5</span>:         channel.eventLoop().execute(<span class="keyword">new</span> Runnable() {</span><br><span class="line">  <span class="number">6</span>:             <span class="meta">@Override</span></span><br><span class="line">  <span class="number">7</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">  <span class="number">8</span>:                 close(cause, allowChannelOpen);</span><br><span class="line">  <span class="number">9</span>:             }</span><br><span class="line"> <span class="number">10</span>:         });</span><br><span class="line"> <span class="number">11</span>:         <span class="comment">// è¿”å›</span></span><br><span class="line"> <span class="number">12</span>:         <span class="keyword">return</span>;</span><br><span class="line"> <span class="number">13</span>:     }</span><br><span class="line"> <span class="number">14</span>: </span><br><span class="line"> <span class="number">15</span>:     <span class="comment">// æ ‡è®°æ­£åœ¨é€šçŸ¥ flush å¤±è´¥ä¸­</span></span><br><span class="line"> <span class="number">16</span>:     inFail = <span class="keyword">true</span>;</span><br><span class="line"> <span class="number">17</span>: </span><br><span class="line"> <span class="number">18</span>:     <span class="keyword">if</span> (!allowChannelOpen &amp;&amp; channel.isOpen()) {</span><br><span class="line"> <span class="number">19</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"close() must be invoked after the channel is closed."</span>);</span><br><span class="line"> <span class="number">20</span>:     }</span><br><span class="line"> <span class="number">21</span>: </span><br><span class="line"> <span class="number">22</span>:     <span class="keyword">if</span> (!isEmpty()) {</span><br><span class="line"> <span class="number">23</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"close() must be invoked after all flushed writes are handled."</span>);</span><br><span class="line"> <span class="number">24</span>:     }</span><br><span class="line"> <span class="number">25</span>: </span><br><span class="line"> <span class="number">26</span>:     <span class="comment">// Release all unflushed messages.</span></span><br><span class="line"> <span class="number">27</span>:     <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">28</span>:         <span class="comment">// ä» unflushedEntry èŠ‚ç‚¹ï¼Œå¼€å§‹å‘ä¸‹éå†</span></span><br><span class="line"> <span class="number">29</span>:         Entry e = unflushedEntry;</span><br><span class="line"> <span class="number">30</span>:         <span class="keyword">while</span> (e != <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">31</span>:             <span class="comment">// å‡å°‘ totalPendingSize</span></span><br><span class="line"> <span class="number">32</span>:             <span class="comment">// Just decrease; do not trigger any events via decrementPendingOutboundBytes()</span></span><br><span class="line"> <span class="number">33</span>:             <span class="keyword">int</span> size = e.pendingSize;</span><br><span class="line"> <span class="number">34</span>:             TOTAL_PENDING_SIZE_UPDATER.addAndGet(<span class="keyword">this</span>, -size);</span><br><span class="line"> <span class="number">35</span>: </span><br><span class="line"> <span class="number">36</span>:             <span class="keyword">if</span> (!e.cancelled) {</span><br><span class="line"> <span class="number">37</span>:                 <span class="comment">// é‡Šæ”¾æ¶ˆæ¯( æ•°æ® )ç›¸å…³çš„èµ„æº</span></span><br><span class="line"> <span class="number">38</span>:                 ReferenceCountUtil.safeRelease(e.msg);</span><br><span class="line"> <span class="number">39</span>:                 <span class="comment">// é€šçŸ¥ Promise æ‰§è¡Œå¤±è´¥</span></span><br><span class="line"> <span class="number">40</span>:                 safeFail(e.promise, cause);</span><br><span class="line"> <span class="number">41</span>:             }</span><br><span class="line"> <span class="number">42</span>:             <span class="comment">// å›æ”¶å½“å‰èŠ‚ç‚¹ï¼Œå¹¶è·å¾—ä¸‹ä¸€ä¸ª Entry èŠ‚ç‚¹</span></span><br><span class="line"> <span class="number">43</span>:             e = e.recycleAndGetNext();</span><br><span class="line"> <span class="number">44</span>:         }</span><br><span class="line"> <span class="number">45</span>:     } <span class="keyword">finally</span> {</span><br><span class="line"> <span class="number">46</span>:         <span class="comment">// æ ‡è®°åœ¨åœ¨é€šçŸ¥ flush å¤±è´¥ä¸­</span></span><br><span class="line"> <span class="number">47</span>:         inFail = <span class="keyword">false</span>;</span><br><span class="line"> <span class="number">48</span>:     }</span><br><span class="line"> <span class="number">49</span>: </span><br><span class="line"> <span class="number">50</span>:     <span class="comment">// æ¸…é™¤ NIO ByteBuff æ•°ç»„çš„ç¼“å­˜ã€‚</span></span><br><span class="line"> <span class="number">51</span>:     clearNioBuffers();</span><br><span class="line"> <span class="number">52</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šæ­£åœ¨é€šçŸ¥ flush å¤±è´¥ä¸­ï¼š<ul>
<li>ç¬¬ 5 è‡³ 10 è¡Œ: æäº¤ EventLoop çš„çº¿ç¨‹ä¸­ï¼Œæ‰§è¡Œå…³é—­ã€‚</li>
<li>ç¬¬ 12 è¡Œï¼š<code>return</code> è¿”å›ã€‚</li>
</ul>
</li>
<li>ç¬¬ 16 è¡Œï¼šæ ‡è®°æ­£åœ¨é€šçŸ¥ flush å¤±è´¥ä¸­ï¼Œå³ <code>inFail = true</code> ã€‚</li>
<li>ç¬¬ 28 è‡³ 30 è¡Œï¼šä» <code>unflushedEntry</code> èŠ‚ç‚¹ï¼Œå¼€å§‹å‘ä¸‹éå†ã€‚<ul>
<li>ç¬¬ 31 è‡³ 34 è¡Œï¼šå‡å°‘ <code>totalPendingSize</code> è®¡æ•°ã€‚</li>
<li>ç¬¬ 36 è¡Œï¼šè‹¥ Entry å·²å–æ¶ˆï¼Œåˆ™å¿½ç•¥ã€‚</li>
<li>ç¬¬ 38 è¡Œï¼šè°ƒç”¨ <code>ReferenceCountUtil#safeRelease(msg)</code> æ–¹æ³•ï¼Œé‡Šæ”¾æ¶ˆæ¯( æ•°æ® )ç›¸å…³çš„èµ„æºã€‚</li>
<li>ç¬¬ 40 è¡Œï¼šã€<strong>é‡è¦</strong>ã€‘è°ƒç”¨ <code>#safeFail(promise)</code> æ–¹æ³•ï¼Œé€šçŸ¥ Promise æ‰§è¡Œå¤±è´¥ã€‚æ­¤å¤„æ‰æ˜¯ï¼ŒçœŸæ­£è§¦å‘ <code>Channel#write(...)</code> æˆ– <code>Channel#writeAndFlush(...)</code> æ–¹æ³•ï¼Œè¿”å›çš„ Promise çš„é€šçŸ¥ã€‚</li>
<li>ç¬¬ 43 è¡Œï¼šè°ƒç”¨ <code>Entry#recycleAndGetNext()</code> æ–¹æ³•ï¼Œå›æ”¶å½“å‰èŠ‚ç‚¹ï¼Œå¹¶è·å¾—ä¸‹ä¸€ä¸ª Entry èŠ‚ç‚¹ã€‚</li>
</ul>
</li>
<li>ç¬¬ 45 è‡³ 48 è¡Œï¼šæ ‡è®°ä¸åœ¨é€šçŸ¥ flush å¤±è´¥ä¸­ï¼Œå³ <code>inFail = false</code> ã€‚</li>
<li>ç¬¬ 51 è¡Œï¼šè°ƒç”¨ <code>#clearNioBuffers()</code> æ–¹æ³•ï¼Œ<strong>æ¸…é™¤</strong> NIO ByteBuff æ•°ç»„çš„ç¼“å­˜ã€‚</li>
</ul>
<h1 id="9-NioEventLoop"><a href="#9-NioEventLoop" class="headerlink" title="9. NioEventLoop"></a>9. NioEventLoop</h1><p>åœ¨ä¸Šæ–‡ <a href="#">ã€Œ7. NioSocketChannelã€</a> ä¸­ï¼Œåœ¨å†™å…¥åˆ° Channel åˆ°å¯¹ç«¯ï¼Œè‹¥ TCP æ•°æ®å‘é€ç¼“å†²åŒº<strong>å·²æ»¡</strong>ï¼Œè¿™å°†å¯¼è‡´ Channel <strong>ä¸å†™å¯</strong>ï¼Œæ­¤æ—¶ä¼šæ³¨å†Œå¯¹è¯¥ Channel çš„ <code>SelectionKey.OP_WRITE</code> äº‹ä»¶æ„Ÿå…´è¶£ã€‚ä»è€Œå®ç°ï¼Œå†åœ¨ Channel å¯å†™åï¼Œè¿›è¡Œ<strong>å¼ºåˆ¶</strong> flush ã€‚è¿™å—çš„é€»è¾‘ï¼Œåœ¨ <code>NioEventLoop#processSelectedKey(SelectionKey k, AbstractNioChannel ch)</code> ä¸­å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// OP_WRITE äº‹ä»¶å°±ç»ª</span></span><br><span class="line"><span class="comment">// Process OP_WRITE first as we may be able to write some queued buffers and so free memory.</span></span><br><span class="line"><span class="keyword">if</span> ((readyOps &amp; SelectionKey.OP_WRITE) != <span class="number">0</span>) {</span><br><span class="line">    <span class="comment">// Call forceFlush which will also take care of clear the OP_WRITE once there is nothing left to write</span></span><br><span class="line">    <span class="comment">// å‘ Channel å†™å…¥æ•°æ®</span></span><br><span class="line">    ch.unsafe().forceFlush();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>é€šè¿‡ Selector è½®è¯¢åˆ° Channel çš„ <code>OP_WRITE</code> å°±ç»ªæ—¶ï¼Œè°ƒç”¨ <code>AbstractNioUnsafe#forceFlush()</code> æ–¹æ³•ï¼Œå¼ºåˆ¶ flush ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractNioUnsafe.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">forceFlush</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// directly call super.flush0() to force a flush now</span></span><br><span class="line">    <span class="keyword">super</span>.flush0();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åç»­çš„é€»è¾‘ï¼Œåˆå›åˆ° <a href="#">ã€Œ6. AbstractUnsafeã€</a> å°èŠ‚çš„ <code>#flush0()</code> æµç¨‹ã€‚</li>
<li>åœ¨å®Œæˆå¼ºåˆ¶ flush ä¹‹åï¼Œä¼šå–æ¶ˆå¯¹ <code>SelectionKey.OP_WRITE</code> äº‹ä»¶çš„æ„Ÿå…´è¶£ã€‚</li>
</ul>
</li>
</ul>
<h2 id="9-1-å¦‚ä½•æ¨¡æ‹Ÿ"><a href="#9-1-å¦‚ä½•æ¨¡æ‹Ÿ" class="headerlink" title="9.1 å¦‚ä½•æ¨¡æ‹Ÿ"></a>9.1 å¦‚ä½•æ¨¡æ‹Ÿ</h2><ol>
<li><p>é…ç½®æœåŠ¡ç«¯ ServerBootstrap çš„å¯åŠ¨å‚æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">.childOption(ChannelOption.SO_SNDBUF, <span class="number">5</span>) <span class="comment">// Socket å‚æ•°ï¼ŒTCP æ•°æ®å‘é€ç¼“å†²åŒºå¤§å°ã€‚</span></span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p><code>telnet</code> åˆ°å¯åŠ¨çš„æœåŠ¡ç«¯ï¼Œå‘é€ç›¸å¯¹é•¿çš„å‘½ä»¤ï¼Œä¾‹å¦‚ <code>"abcdefghijklmnopqrstuvw11321321321nhdkslk"</code> ã€‚</p>
</li>
</ol>
<h1 id="10-ChannelOutboundBuffer-å†™å…¥æ§åˆ¶"><a href="#10-ChannelOutboundBuffer-å†™å…¥æ§åˆ¶" class="headerlink" title="10. ChannelOutboundBuffer å†™å…¥æ§åˆ¶"></a>10. ChannelOutboundBuffer å†™å…¥æ§åˆ¶</h1><p>å½“æˆ‘ä»¬ä¸æ–­è°ƒç”¨ <code>#addMessage(Object msg, int size, ChannelPromise promise)</code> æ–¹æ³•ï¼Œæ·»åŠ æ¶ˆæ¯åˆ° ChannelOutboundBuffer å†…å­˜é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœ<strong>ä¸åŠæ—¶</strong> flush å†™åˆ°å¯¹ç«¯( ä¾‹å¦‚ç¨‹åºä¸€ç›´æœªè°ƒç”¨ <code>Channel#flush()</code> æ–¹æ³•ï¼Œæˆ–è€…å¯¹ç«¯æ¥æ”¶æ•°æ®æ¯”è¾ƒæ…¢å¯¼è‡´ Channel ä¸å¯å†™ )ï¼Œå¯èƒ½ä¼šå¯¼è‡´ <strong>OOM å†…å­˜æº¢å‡º</strong>ã€‚æ‰€ä»¥ï¼Œåœ¨ ChannelOutboundBuffer ä½¿ç”¨ <code>totalPendingSize</code> å±æ€§ï¼Œå­˜å‚¨æ‰€æœ‰ Entry é¢„è®¡å ç”¨çš„å†…å­˜å¤§å°( <code>pendingSize</code> )ã€‚</p>
<ul>
<li>åœ¨ <code>totalPendingSize</code> å¤§äºé«˜æ°´ä½é˜€å€¼æ—¶( <code>ChannelConfig.writeBufferHighWaterMark</code> ï¼Œé»˜è®¤å€¼ä¸º 64 KB )ï¼Œ<strong>å…³é—­</strong>å†™å¼€å…³( <code>unwritable</code> )ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ10.1 incrementPendingOutboundBytesã€</a> ã€‚</li>
<li>åœ¨ <code>totalPendingSize</code> å°äºä½æ°´ä½é˜€å€¼æ—¶( <code>ChannelConfig.writeBufferLowWaterMark</code> ï¼Œé»˜è®¤å€¼ä¸º 32 KB )ï¼Œ<strong>æ‰“å¼€</strong>å†™å¼€å…³( <code>unwritable</code> )ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ10.2 decrementPendingOutboundBytesã€</a> ã€‚</li>
</ul>
<p>è¯¥åŠŸèƒ½ï¼Œå¯¹åº” Github æäº¤ä¸º <a href="https://github.com/netty/netty/commit/e3cb9935c0b63357e3d51867cffe624129e7e1dd" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠTake memory overhead of ChannelOutboundBuffer / PendingWriteQueue into accountã€‹</a> ã€‚</p>
<h2 id="10-1-incrementPendingOutboundBytes"><a href="#10-1-incrementPendingOutboundBytes" class="headerlink" title="10.1 incrementPendingOutboundBytes"></a>10.1 incrementPendingOutboundBytes</h2><p><code>#incrementPendingOutboundBytes(long size, ...)</code> æ–¹æ³•ï¼Œå¢åŠ  <code>totalPendingSize</code> è®¡æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br><span class="line"><span class="comment"> 2:  * Increment the pending bytes which will be written at some point.</span></span><br><span class="line"><span class="comment"> 3:  * This method is thread-safe!</span></span><br><span class="line"><span class="comment"> 4:  */</span></span><br><span class="line"> <span class="number">5</span>: <span class="function"><span class="keyword">void</span> <span class="title">incrementPendingOutboundBytes</span><span class="params">(<span class="keyword">long</span> size)</span> </span>{</span><br><span class="line"> <span class="number">6</span>:     incrementPendingOutboundBytes(size, <span class="keyword">true</span>);</span><br><span class="line"> <span class="number">7</span>: }</span><br><span class="line"> <span class="number">8</span>: </span><br><span class="line"> <span class="number">9</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">incrementPendingOutboundBytes</span><span class="params">(<span class="keyword">long</span> size, <span class="keyword">boolean</span> invokeLater)</span> </span>{</span><br><span class="line"><span class="number">10</span>:     <span class="keyword">if</span> (size == <span class="number">0</span>) {</span><br><span class="line"><span class="number">11</span>:         <span class="keyword">return</span>;</span><br><span class="line"><span class="number">12</span>:     }</span><br><span class="line"><span class="number">13</span>: </span><br><span class="line"><span class="number">14</span>:     <span class="comment">// å¢åŠ  totalPendingSize è®¡æ•°</span></span><br><span class="line"><span class="number">15</span>:     <span class="keyword">long</span> newWriteBufferSize = TOTAL_PENDING_SIZE_UPDATER.addAndGet(<span class="keyword">this</span>, size);</span><br><span class="line"><span class="number">16</span>:     <span class="comment">// totalPendingSize å¤§äºé«˜æ°´ä½é˜€å€¼æ—¶ï¼Œè®¾ç½®ä¸ºä¸å¯å†™</span></span><br><span class="line"><span class="number">17</span>:     <span class="keyword">if</span> (newWriteBufferSize &gt; channel.config().getWriteBufferHighWaterMark()) {</span><br><span class="line"><span class="number">18</span>:         setUnwritable(invokeLater);</span><br><span class="line"><span class="number">19</span>:     }</span><br><span class="line"><span class="number">20</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 15 è¡Œï¼šå¢åŠ  <code>totalPendingSize</code> è®¡æ•°ã€‚</li>
<li><p>ç¬¬ 16 è‡³ 19 è¡Œï¼š<code>totalPendingSize</code> å¤§äºé«˜æ°´ä½é˜€å€¼æ—¶ï¼Œè°ƒç”¨ <code>#setUnwritable(boolean invokeLater)</code> æ–¹æ³•ï¼Œè®¾ç½®ä¸ºä¸å¯å†™ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setUnwritable</span><span class="params">(<span class="keyword">boolean</span> invokeLater)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">for</span> (;;) {</span><br><span class="line"> <span class="number">3</span>:         <span class="keyword">final</span> <span class="keyword">int</span> oldValue = unwritable;</span><br><span class="line"> <span class="number">4</span>:         <span class="comment">// æˆ–ä½æ“ä½œï¼Œä¿®æ”¹ç¬¬ 0 ä½ bits ä¸º 1</span></span><br><span class="line"> <span class="number">5</span>:         <span class="keyword">final</span> <span class="keyword">int</span> newValue = oldValue | <span class="number">1</span>;</span><br><span class="line"> <span class="number">6</span>:         <span class="comment">// CAS è®¾ç½® unwritable ä¸ºæ–°å€¼</span></span><br><span class="line"> <span class="number">7</span>:         <span class="keyword">if</span> (UNWRITABLE_UPDATER.compareAndSet(<span class="keyword">this</span>, oldValue, newValue)) {</span><br><span class="line"> <span class="number">8</span>:             <span class="comment">// è‹¥ä¹‹å‰å¯å†™ï¼Œç°åœ¨ä¸å¯å†™ï¼Œè§¦å‘ Channel WritabilityChanged äº‹ä»¶åˆ° pipeline ä¸­ã€‚</span></span><br><span class="line"> <span class="number">9</span>:             <span class="keyword">if</span> (oldValue == <span class="number">0</span> &amp;&amp; newValue != <span class="number">0</span>) {</span><br><span class="line"><span class="number">10</span>:                 fireChannelWritabilityChanged(invokeLater);</span><br><span class="line"><span class="number">11</span>:             }</span><br><span class="line"><span class="number">12</span>:             <span class="keyword">break</span>;</span><br><span class="line"><span class="number">13</span>:         }</span><br><span class="line"><span class="number">14</span>:     }</span><br><span class="line"><span class="number">15</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 2 è¡Œï¼š<code>for</code> å¾ªç¯ï¼Œç›´åˆ° CAS ä¿®æ”¹æˆåŠŸ</li>
<li>ç¬¬ 5 è¡Œï¼šæˆ–ä½æ“ä½œï¼Œä¿®æ”¹ç¬¬ 0 ä½ bits ä¸º 1 ã€‚ğŸ˜ˆ æ¯”è¾ƒç¥å¥‡çš„æ˜¯ï¼Œ<code>unwritable</code> çš„ç±»å‹ä¸æ˜¯ <code>boolean</code> ï¼Œè€Œæ˜¯ <code>int</code> ç±»å‹ã€‚é€šè¿‡æ¯ä¸ª bits ï¼Œæ¥è¡¨ç¤º<strong>å“ªç§</strong>ç±»å‹ä¸å¯å†™ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ <code>io.netty.handler.traffic.AbstractTrafficShapingHandler</code> ï¼Œä½¿ç”¨äº†ç¬¬ 1ã€2ã€3 bits ã€‚</li>
<li>ç¬¬ 7 è¡Œï¼šCAS è®¾ç½® <code>unwritable</code> ä¸ºæ–°å€¼ã€‚</li>
<li>ç¬¬ 8 è‡³ 11 è¡Œï¼šè‹¥ä¹‹å‰å¯å†™ï¼Œç°åœ¨ä¸å¯å†™ï¼Œè°ƒç”¨ <code>#fireChannelWritabilityChanged(boolean invokeLater)</code> æ–¹æ³•ï¼Œè§¦å‘ Channel WritabilityChanged äº‹ä»¶åˆ° pipeline ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ10.3 fireChannelWritabilityChangedã€</a> ã€‚</li>
</ul>
</li>
</ul>
<h3 id="10-1-1-bytesBeforeUnwritable"><a href="#10-1-1-bytesBeforeUnwritable" class="headerlink" title="10.1.1 bytesBeforeUnwritable"></a>10.1.1 bytesBeforeUnwritable</h3><p><code>#bytesBeforeUnwritable()</code> æ–¹æ³•ï¼Œè·å¾—è·ç¦»<strong>ä¸å¯å†™</strong>è¿˜æœ‰å¤šå°‘å­—èŠ‚æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">bytesBeforeUnwritable</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">long</span> bytes = channel.config().getWriteBufferHighWaterMark() - totalPendingSize;</span><br><span class="line">    <span class="comment">// If bytes is negative we know we are not writable, but if bytes is non-negative we have to check writability.</span></span><br><span class="line">    <span class="comment">// Note that totalPendingSize and isWritable() use different volatile variables that are not synchronized</span></span><br><span class="line">    <span class="comment">// together. totalPendingSize will be updated before isWritable().</span></span><br><span class="line">    <span class="keyword">if</span> (bytes &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> isWritable() ? bytes : <span class="number">0</span>; <span class="comment">// åˆ¤æ–­ #isWritable() çš„åŸå› æ˜¯ï¼Œå¯èƒ½å·²ç»è¢«è®¾ç½®ä¸å¯å†™</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åŸºäº<strong>é«˜æ°´ä½</strong>é˜€å€¼æ¥åˆ¤æ–­ã€‚</li>
</ul>
<h2 id="10-2-decrementPendingOutboundBytes"><a href="#10-2-decrementPendingOutboundBytes" class="headerlink" title="10.2 decrementPendingOutboundBytes"></a>10.2 decrementPendingOutboundBytes</h2><p><code>#decrementPendingOutboundBytes(long size, ...)</code> æ–¹æ³•ï¼Œå‡å°‘ <code>totalPendingSize</code> è®¡æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br><span class="line"><span class="comment"> 2:  * Decrement the pending bytes which will be written at some point.</span></span><br><span class="line"><span class="comment"> 3:  * This method is thread-safe!</span></span><br><span class="line"><span class="comment"> 4:  */</span></span><br><span class="line"> <span class="number">5</span>: <span class="function"><span class="keyword">void</span> <span class="title">decrementPendingOutboundBytes</span><span class="params">(<span class="keyword">long</span> size)</span> </span>{</span><br><span class="line"> <span class="number">6</span>:     decrementPendingOutboundBytes(size, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line"> <span class="number">7</span>: }</span><br><span class="line"> <span class="number">8</span>: </span><br><span class="line"> <span class="number">9</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">decrementPendingOutboundBytes</span><span class="params">(<span class="keyword">long</span> size, <span class="keyword">boolean</span> invokeLater, <span class="keyword">boolean</span> notifyWritability)</span> </span>{</span><br><span class="line"><span class="number">10</span>:     <span class="keyword">if</span> (size == <span class="number">0</span>) {</span><br><span class="line"><span class="number">11</span>:         <span class="keyword">return</span>;</span><br><span class="line"><span class="number">12</span>:     }</span><br><span class="line"><span class="number">13</span>: </span><br><span class="line"><span class="number">14</span>:     <span class="comment">// å‡å°‘ totalPendingSize è®¡æ•°</span></span><br><span class="line"><span class="number">15</span>:     <span class="keyword">long</span> newWriteBufferSize = TOTAL_PENDING_SIZE_UPDATER.addAndGet(<span class="keyword">this</span>, -size);</span><br><span class="line"><span class="number">16</span>:     <span class="comment">// totalPendingSize å°äºä½æ°´ä½é˜€å€¼æ—¶ï¼Œè®¾ç½®ä¸ºå¯å†™</span></span><br><span class="line"><span class="number">17</span>:     <span class="keyword">if</span> (notifyWritability &amp;&amp; newWriteBufferSize &lt; channel.config().getWriteBufferLowWaterMark()) {</span><br><span class="line"><span class="number">18</span>:         setWritable(invokeLater);</span><br><span class="line"><span class="number">19</span>:     }</span><br><span class="line"><span class="number">20</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 15 è¡Œï¼šå‡å°‘ <code>totalPendingSize</code> è®¡æ•°ã€‚</li>
<li><p>ç¬¬ 16 è‡³ 19 è¡Œï¼š<code>totalPendingSize</code> å°äºä½æ°´ä½é˜€å€¼æ—¶ï¼Œè°ƒç”¨ <code>#setWritable(boolean invokeLater)</code> æ–¹æ³•ï¼Œè®¾ç½®ä¸ºå¯å†™ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setWritable</span><span class="params">(<span class="keyword">boolean</span> invokeLater)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">for</span> (;;) {</span><br><span class="line"> <span class="number">3</span>:         <span class="keyword">final</span> <span class="keyword">int</span> oldValue = unwritable;</span><br><span class="line"> <span class="number">4</span>:         <span class="comment">// å¹¶ä½æ“ä½œï¼Œä¿®æ”¹ç¬¬ 0 ä½ bits ä¸º 0</span></span><br><span class="line"> <span class="number">5</span>:         <span class="keyword">final</span> <span class="keyword">int</span> newValue = oldValue &amp; ~<span class="number">1</span>;</span><br><span class="line"> <span class="number">6</span>:         <span class="comment">// CAS è®¾ç½® unwritable ä¸ºæ–°å€¼</span></span><br><span class="line"> <span class="number">7</span>:         <span class="keyword">if</span> (UNWRITABLE_UPDATER.compareAndSet(<span class="keyword">this</span>, oldValue, newValue)) {</span><br><span class="line"> <span class="number">8</span>:             <span class="comment">// è‹¥ä¹‹å‰ä¸å¯å†™ï¼Œç°åœ¨å¯å†™ï¼Œè§¦å‘ Channel WritabilityChanged äº‹ä»¶åˆ° pipeline ä¸­ã€‚</span></span><br><span class="line"> <span class="number">9</span>:             <span class="keyword">if</span> (oldValue != <span class="number">0</span> &amp;&amp; newValue == <span class="number">0</span>) {</span><br><span class="line"><span class="number">10</span>:                 fireChannelWritabilityChanged(invokeLater);</span><br><span class="line"><span class="number">11</span>:             }</span><br><span class="line"><span class="number">12</span>:             <span class="keyword">break</span>;</span><br><span class="line"><span class="number">13</span>:         }</span><br><span class="line"><span class="number">14</span>:     }</span><br><span class="line"><span class="number">15</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 2 è¡Œï¼š<code>for</code> å¾ªç¯ï¼Œç›´åˆ° CAS ä¿®æ”¹æˆåŠŸ</li>
<li>ç¬¬ 5 è¡Œï¼šå¹¶ä½æ“ä½œï¼Œä¿®æ”¹ç¬¬ 0 ä½ bits ä¸º 0 ã€‚</li>
<li>ç¬¬ 7 è¡Œï¼šCAS è®¾ç½® <code>unwritable</code> ä¸ºæ–°å€¼ã€‚</li>
<li>ç¬¬ 8 è‡³ 11 è¡Œï¼šè‹¥ä¹‹å‰å¯å†™ï¼Œç°åœ¨ä¸å¯å†™ï¼Œè°ƒç”¨ <code>#fireChannelWritabilityChanged(boolean invokeLater)</code> æ–¹æ³•ï¼Œè§¦å‘ Channel WritabilityChanged äº‹ä»¶åˆ° pipeline ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ10.3 fireChannelWritabilityChangedã€</a> ã€‚</li>
</ul>
</li>
</ul>
<h3 id="10-2-1-bytesBeforeWritable"><a href="#10-2-1-bytesBeforeWritable" class="headerlink" title="10.2.1 bytesBeforeWritable"></a>10.2.1 bytesBeforeWritable</h3><p><code>#bytesBeforeWritable()</code> æ–¹æ³•ï¼Œè·å¾—è·ç¦»<strong>å¯å†™</strong>è¿˜è¦å¤šå°‘å­—èŠ‚æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Get how many bytes must be drained from the underlying buffer until {<span class="doctag">@link</span> #isWritable()} returns {<span class="doctag">@code</span> true}.</span></span><br><span class="line"><span class="comment"> * This quantity will always be non-negative. If {<span class="doctag">@link</span> #isWritable()} is {<span class="doctag">@code</span> true} then 0.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">bytesBeforeWritable</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">long</span> bytes = totalPendingSize - channel.config().getWriteBufferLowWaterMark();</span><br><span class="line">    <span class="comment">// If bytes is negative we know we are writable, but if bytes is non-negative we have to check writability.</span></span><br><span class="line">    <span class="comment">// Note that totalPendingSize and isWritable() use different volatile variables that are not synchronized</span></span><br><span class="line">    <span class="comment">// together. totalPendingSize will be updated before isWritable().</span></span><br><span class="line">    <span class="keyword">if</span> (bytes &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> isWritable() ? <span class="number">0</span> : bytes; <span class="comment">// åˆ¤æ–­ #isWritable() çš„åŸå› æ˜¯ï¼Œå¯èƒ½å·²ç»è¢«è®¾ç½®ä¸å¯å†™</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åŸºäº<strong>ä½æ°´ä½</strong>é˜€å€¼æ¥åˆ¤æ–­ã€‚</li>
</ul>
<h2 id="10-3-fireChannelWritabilityChanged"><a href="#10-3-fireChannelWritabilityChanged" class="headerlink" title="10.3 fireChannelWritabilityChanged"></a>10.3 fireChannelWritabilityChanged</h2><p><code>#fireChannelWritabilityChanged(boolean invokeLater)</code> æ–¹æ³•ï¼Œè§¦å‘ Channel WritabilityChanged äº‹ä»¶åˆ° pipeline ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fireChannelWritabilityChanged</span><span class="params">(<span class="keyword">boolean</span> invokeLater)</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> ChannelPipeline pipeline = channel.pipeline();</span><br><span class="line">    <span class="comment">// å»¶è¿Ÿæ‰§è¡Œï¼Œå³æäº¤ EventLoop ä¸­è§¦å‘ Channel WritabilityChanged äº‹ä»¶åˆ° pipeline ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (invokeLater) {</span><br><span class="line">        Runnable task = fireChannelWritabilityChangedTask;</span><br><span class="line">        <span class="keyword">if</span> (task == <span class="keyword">null</span>) {</span><br><span class="line">            fireChannelWritabilityChangedTask = task = <span class="keyword">new</span> Runnable() {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">                    pipeline.fireChannelWritabilityChanged();</span><br><span class="line">                }</span><br><span class="line">            };</span><br><span class="line">        }</span><br><span class="line">        channel.eventLoop().execute(task);</span><br><span class="line">    <span class="comment">// ç›´æ¥è§¦å‘ Channel WritabilityChanged äº‹ä»¶åˆ° pipeline ä¸­</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        pipeline.fireChannelWritabilityChanged();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ ¹æ® <code>invokeLater</code> çš„å€¼ï¼Œåˆ†æˆä¸¤ç§æ–¹å¼ï¼Œè°ƒç”¨ <code>ChannelPipeline#fireChannelWritabilityChanged()</code> æ–¹æ³•ï¼Œè§¦å‘ Channel WritabilityChanged äº‹ä»¶åˆ° pipeline ä¸­ã€‚å…·ä½“ï¼Œèƒ–å‹çœ‹ä¸‹ä»£ç æ³¨é‡Šã€‚</li>
<li>åç»­çš„æµç¨‹ï¼Œå°±æ˜¯ <a href="http://svip.iocoder.cn/Netty/Pipeline-5-inbound/">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” ChannelPipelineï¼ˆäº”ï¼‰ä¹‹ Inbound äº‹ä»¶çš„ä¼ æ’­ã€‹</a> ã€‚</li>
<li>é€šè¿‡ Channel WritabilityChanged äº‹ä»¶ï¼Œé…åˆ <code>io.netty.handler.stream.ChunkedWriteHandler</code> å¤„ç†å™¨ï¼Œå®ç° ChannelOutboundBuffer å†™å…¥çš„æ§åˆ¶ï¼Œé¿å… OOM ã€‚ChunkedWriteHandler çš„å…·ä½“ä»£ç å®ç°ï¼Œæˆ‘ä»¬åœ¨åç»­çš„æ–‡ç« ï¼Œè¯¦ç»†è§£æã€‚<ul>
<li>æ‰€ä»¥ï¼Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼ŒChannelOutboundBuffer çš„ <code>unwritable</code> å±æ€§ï¼Œä»…ä»…ä½œä¸ºä¸€ä¸ªæ˜¯å¦ä¸å¯å†™çš„<strong>å¼€å…³</strong>ï¼Œå…·ä½“éœ€è¦é…åˆå“åº”çš„ ChannelHandler å¤„ç†å™¨ï¼Œæ‰èƒ½å®ç°â€œä¸å¯å†™â€çš„åŠŸèƒ½ã€‚</li>
</ul>
</li>
</ul>
<h2 id="10-4-isWritable"><a href="#10-4-isWritable" class="headerlink" title="10.4 isWritable"></a>10.4 isWritable</h2><p><code>#isWritable()</code> æ–¹æ³•ï¼Œæ˜¯å¦å¯å†™ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns {<span class="doctag">@code</span> true} if and only if {<span class="doctag">@linkplain</span> #totalPendingWriteBytes() the total number of pending bytes} did</span></span><br><span class="line"><span class="comment"> * not exceed the write watermark of the {<span class="doctag">@link</span> Channel} and</span></span><br><span class="line"><span class="comment"> * no {<span class="doctag">@linkplain</span> #setUserDefinedWritability(int, boolean) user-defined writability flag} has been set to</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@code</span> false}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isWritable</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> unwritable == <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¦‚æœ <code>unwritable</code> å¤§äº 0 ï¼Œåˆ™è¡¨ç¤ºä¸å¯å†™ã€‚ğŸ˜ˆ ä¸€å®šè¦æ³¨æ„ï¼ï¼ï¼</li>
</ul>
<h3 id="10-4-1-getUserDefinedWritability"><a href="#10-4-1-getUserDefinedWritability" class="headerlink" title="10.4.1 getUserDefinedWritability"></a>10.4.1 getUserDefinedWritability</h3><p><code>#getUserDefinedWritability(int index)</code> æ–¹æ³•ï¼Œè·å¾—æŒ‡å®š bits æ˜¯å¦å¯å†™ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns {<span class="doctag">@code</span> true} if and only if the user-defined writability flag at the specified index is set to</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@code</span> true}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getUserDefinedWritability</span><span class="params">(<span class="keyword">int</span> index)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (unwritable &amp; writabilityMask(index)) == <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">writabilityMask</span><span class="params">(<span class="keyword">int</span> index)</span> </span>{</span><br><span class="line">    <span class="comment">// ä¸èƒ½ &lt; 1 ï¼Œå› ä¸ºç¬¬ 0 bits ä¸º ChannelOutboundBuffer è‡ªå·±ä½¿ç”¨</span></span><br><span class="line">    <span class="comment">// ä¸èƒ½ &gt; 31 ï¼Œå› ä¸ºè¶…è¿‡ int çš„ bits èŒƒå›´</span></span><br><span class="line">    <span class="keyword">if</span> (index &lt; <span class="number">1</span> || index &gt; <span class="number">31</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"index: "</span> + index + <span class="string">" (expected: 1~31)"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> &lt;&lt; index;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¸ºä»€ä¹ˆæ–¹æ³•åå­—ä¸Šä¼šå¸¦æœ‰ <code>"UserDefined"</code> å‘¢ï¼Ÿå› ä¸º <code>index</code> ä¸èƒ½ä½¿ç”¨ 0 ï¼Œè¡¨ç¤ºåªå…è®¸ä½¿ç”¨ç”¨æˆ·å®šä¹‰( <code>"UserDefined"</code> ) bits ä½ï¼Œå³ <code>[1, 31]</code> ã€‚</li>
</ul>
<h3 id="10-4-2-setUserDefinedWritability"><a href="#10-4-2-setUserDefinedWritability" class="headerlink" title="10.4.2 setUserDefinedWritability"></a>10.4.2 setUserDefinedWritability</h3><p><code>#setUserDefinedWritability(int index, boolean writable)</code> æ–¹æ³•ï¼Œè®¾ç½®æŒ‡å®š bits æ˜¯å¦å¯å†™ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Sets a user-defined writability flag at the specified index.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserDefinedWritability</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">boolean</span> writable)</span> </span>{</span><br><span class="line">    <span class="comment">// è®¾ç½®å¯å†™</span></span><br><span class="line">    <span class="keyword">if</span> (writable) {</span><br><span class="line">        setUserDefinedWritability(index);</span><br><span class="line">    <span class="comment">// è®¾ç½®ä¸å¯å†™</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        clearUserDefinedWritability(index);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setUserDefinedWritability</span><span class="params">(<span class="keyword">int</span> index)</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mask = ~writabilityMask(index);</span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> oldValue = unwritable;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> newValue = oldValue &amp; mask;</span><br><span class="line">        <span class="comment">// CAS è®¾ç½® unwritable ä¸ºæ–°å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (UNWRITABLE_UPDATER.compareAndSet(<span class="keyword">this</span>, oldValue, newValue)) {</span><br><span class="line">            <span class="comment">// è‹¥ä¹‹å‰ä¸å¯å†™ï¼Œç°åœ¨å¯å†™ï¼Œè§¦å‘ Channel WritabilityChanged äº‹ä»¶åˆ° pipeline ä¸­ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (oldValue != <span class="number">0</span> &amp;&amp; newValue == <span class="number">0</span>) {</span><br><span class="line">                fireChannelWritabilityChanged(<span class="keyword">true</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearUserDefinedWritability</span><span class="params">(<span class="keyword">int</span> index)</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mask = writabilityMask(index);</span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> oldValue = unwritable;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> newValue = oldValue | mask;</span><br><span class="line">        <span class="keyword">if</span> (UNWRITABLE_UPDATER.compareAndSet(<span class="keyword">this</span>, oldValue, newValue)) {</span><br><span class="line">            <span class="comment">// è‹¥ä¹‹å‰å¯å†™ï¼Œç°åœ¨ä¸å¯å†™ï¼Œè§¦å‘ Channel WritabilityChanged äº‹ä»¶åˆ° pipeline ä¸­ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (oldValue == <span class="number">0</span> &amp;&amp; newValue != <span class="number">0</span>) {</span><br><span class="line">                fireChannelWritabilityChanged(<span class="keyword">true</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹å™¢ã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ¯”æƒ³è±¡ä¸­ï¼Œé•¿çš„å¤šçš„å¤šçš„ä¸€ç¯‡æ–‡ç« ã€‚æ€»çš„æ¥è¯´ï¼Œç»å¤§éƒ¨åˆ†ç»†èŠ‚ï¼Œéƒ½å·²ç»æ‰£åˆ°ï¼Œç¾æ»‹æ»‹ã€‚å¦‚æœæœ‰è§£é‡Šä¸å¤Ÿæ¸…æ™°æˆ–é”™è¯¯çš„ç»†èŠ‚ï¼Œä¸€èµ·å¤šå¤šæ²Ÿé€šå‘€ã€‚</p>
<p>å†™å®Œè¿™ç¯‡ï¼Œæˆ‘ç®€ç›´ç–¯äº†ã€‚ã€‚ã€‚ã€‚</p>
<p>æ¨èé˜…è¯»æ–‡ç« ï¼š</p>
<ul>
<li>è«é‚£ä¸€é²é“ <a href="https://www.jianshu.com/p/311425d1c72f" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty å‡ºç«™ç¼“å†²åŒº ChannelOutboundBuffer æºç è§£æï¼ˆisWritable å±æ€§çš„é‡è¦æ€§ï¼‰ã€‹</a></li>
<li>tomaså®¶çš„å°æ‹¨æµªé¼“ <a href="https://www.jianshu.com/p/a3443cacd081" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty æºç è§£æ â€”â€”â€” writeAndFlushæµç¨‹åˆ†æã€‹</a></li>
<li>é—ªç”µä¾  <a href="https://www.jianshu.com/p/feaeaab2ce56" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnetty æºç åˆ†æä¹‹ writeAndFlush å…¨è§£æã€‹</a></li>
<li>å å°ç‹¼ <a href="https://www.jianshu.com/p/1ad424c53e80" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥æµ…å‡º Netty writeã€‹</a></li>
<li>Hypercube <a href="https://www.jianshu.com/p/9258af254e1d" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆå…­ï¼‰â€“Channelæºç å®ç°ã€‹</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/Channel-5-flush/" data-id="ck4pl3fr100hbfgcfsc4t9ar0" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>