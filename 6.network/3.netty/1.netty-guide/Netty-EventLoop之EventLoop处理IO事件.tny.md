<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆäº”ï¼‰ä¹‹ EventLoop å¤„ç† IO äº‹ä»¶
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡æˆ‘ä»¬åˆ†äº« EventLoop çš„<strong>å¤„ç† IO äº‹ä»¶</strong>ç›¸å…³ä»£ç çš„å®ç°ã€‚å¯¹åº”å¦‚ä¸‹å›¾çš„ç»¿æ¡ <strong>process selected keys</strong> éƒ¨åˆ†ï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_05_10/01.png" title="run" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_05_10/01.png" alt="run"></a><span class="caption">run</span></p>
<p>å› ä¸ºåœ¨ <a href="http://svip.iocoder.cn/Netty/EventLoop-5-EventLoop-handle-io-event?self">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆå››ï¼‰ä¹‹ EventLoop è¿è¡Œã€‹</a> ä¸­ï¼Œ<code>#openSelector()</code> å’Œ <code>#rebuildSelector()</code> æ–¹æ³•å¹¶æœªåšåˆ†äº«ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥ä¸€èµ·çœ‹çœ‹ã€‚</p>
<h1 id="2-SelectorTuple"><a href="#2-SelectorTuple" class="headerlink" title="2. SelectorTuple"></a>2. SelectorTuple</h1><p>SelectorTuple ï¼ŒSelector å…ƒç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>SelectorTuple å†…åµŒåœ¨ NioEventLoop </p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectorTuple</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœªåŒ…è£…çš„ Selector å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> Selector unwrappedSelector;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æœªåŒ…è£…çš„ Selector å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> Selector selector;</span><br><span class="line"></span><br><span class="line">    SelectorTuple(Selector unwrappedSelector) {</span><br><span class="line">        <span class="keyword">this</span>.unwrappedSelector = unwrappedSelector;</span><br><span class="line">        <span class="keyword">this</span>.selector = unwrappedSelector;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    SelectorTuple(Selector unwrappedSelector, Selector selector) {</span><br><span class="line">        <span class="keyword">this</span>.unwrappedSelector = unwrappedSelector;</span><br><span class="line">        <span class="keyword">this</span>.selector = selector;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="3-openSelector"><a href="#3-openSelector" class="headerlink" title="3. openSelector"></a>3. openSelector</h1><p><code>#openSelector()</code> æ–¹æ³•ï¼Œåˆ›å»º Selector å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> SelectorTuple <span class="title">openSelector</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// åˆ›å»º Selector å¯¹è±¡ï¼Œä½œä¸º unwrappedSelector</span></span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">final</span> Selector unwrappedSelector;</span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">5</span>:         unwrappedSelector = provider.openSelector();</span><br><span class="line"> <span class="number">6</span>:     } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line"> <span class="number">7</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> ChannelException(<span class="string">"failed to open a new selector"</span>, e);</span><br><span class="line"> <span class="number">8</span>:     }</span><br><span class="line"> <span class="number">9</span>: </span><br><span class="line"><span class="number">10</span>:     <span class="comment">// ç¦ç”¨ SelectionKey çš„ä¼˜åŒ–ï¼Œåˆ™ç›´æ¥è¿”å› SelectorTuple å¯¹è±¡ã€‚å³ï¼Œselector ä¹Ÿä½¿ç”¨ unwrappedSelector ã€‚</span></span><br><span class="line"><span class="number">11</span>:     <span class="keyword">if</span> (DISABLE_KEYSET_OPTIMIZATION) {</span><br><span class="line"><span class="number">12</span>:         <span class="keyword">return</span> <span class="keyword">new</span> SelectorTuple(unwrappedSelector);</span><br><span class="line"><span class="number">13</span>:     }</span><br><span class="line"><span class="number">14</span>: </span><br><span class="line"><span class="number">15</span>:     <span class="comment">// è·å¾— SelectorImpl ç±»</span></span><br><span class="line"><span class="number">16</span>:     Object maybeSelectorImplClass = AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Object&gt;() {</span><br><span class="line"><span class="number">17</span>:         <span class="meta">@Override</span></span><br><span class="line"><span class="number">18</span>:         <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="number">19</span>:             <span class="keyword">try</span> {</span><br><span class="line"><span class="number">20</span>:                 <span class="keyword">return</span> Class.forName(</span><br><span class="line"><span class="number">21</span>:                         <span class="string">"sun.nio.ch.SelectorImpl"</span>,</span><br><span class="line"><span class="number">22</span>:                         <span class="keyword">false</span>,</span><br><span class="line"><span class="number">23</span>:                         PlatformDependent.getSystemClassLoader()); <span class="comment">// æˆåŠŸï¼Œåˆ™è¿”å›è¯¥ç±»</span></span><br><span class="line"><span class="number">24</span>:             } <span class="keyword">catch</span> (Throwable cause) {</span><br><span class="line"><span class="number">25</span>:                 <span class="keyword">return</span> cause; <span class="comment">// å¤±è´¥ï¼Œåˆ™è¿”å›è¯¥å¼‚å¸¸</span></span><br><span class="line"><span class="number">26</span>:             }</span><br><span class="line"><span class="number">27</span>:         }</span><br><span class="line"><span class="number">28</span>:     });</span><br><span class="line"><span class="number">29</span>: </span><br><span class="line"><span class="number">30</span>:     <span class="comment">// è·å¾— SelectorImpl ç±»å¤±è´¥ï¼Œåˆ™ç›´æ¥è¿”å› SelectorTuple å¯¹è±¡ã€‚å³ï¼Œselector ä¹Ÿä½¿ç”¨ unwrappedSelector ã€‚</span></span><br><span class="line"><span class="number">31</span>:     <span class="keyword">if</span> (!(maybeSelectorImplClass <span class="keyword">instanceof</span> Class) ||</span><br><span class="line"><span class="number">32</span>:             <span class="comment">// ensure the current selector implementation is what we can instrument.</span></span><br><span class="line"><span class="number">33</span>:             !((Class&lt;?&gt;) maybeSelectorImplClass).isAssignableFrom(unwrappedSelector.getClass())) {</span><br><span class="line"><span class="number">34</span>:         <span class="keyword">if</span> (maybeSelectorImplClass <span class="keyword">instanceof</span> Throwable) {</span><br><span class="line"><span class="number">35</span>:             Throwable t = (Throwable) maybeSelectorImplClass;</span><br><span class="line"><span class="number">36</span>:             logger.trace(<span class="string">"failed to instrument a special java.util.Set into: {}"</span>, unwrappedSelector, t);</span><br><span class="line"><span class="number">37</span>:         }</span><br><span class="line"><span class="number">38</span>:         <span class="keyword">return</span> <span class="keyword">new</span> SelectorTuple(unwrappedSelector);</span><br><span class="line"><span class="number">39</span>:     }</span><br><span class="line"><span class="number">40</span>: </span><br><span class="line"><span class="number">41</span>:     <span class="keyword">final</span> Class&lt;?&gt; selectorImplClass = (Class&lt;?&gt;) maybeSelectorImplClass;</span><br><span class="line"><span class="number">42</span>: </span><br><span class="line"><span class="number">43</span>:     <span class="comment">// åˆ›å»º SelectedSelectionKeySet å¯¹è±¡</span></span><br><span class="line"><span class="number">44</span>:     <span class="keyword">final</span> SelectedSelectionKeySet selectedKeySet = <span class="keyword">new</span> SelectedSelectionKeySet();</span><br><span class="line"><span class="number">45</span>: </span><br><span class="line"><span class="number">46</span>:     <span class="comment">// è®¾ç½® SelectedSelectionKeySet å¯¹è±¡åˆ° unwrappedSelector ä¸­</span></span><br><span class="line"><span class="number">47</span>:     Object maybeException = AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Object&gt;() {</span><br><span class="line"><span class="number">48</span>:         <span class="meta">@Override</span></span><br><span class="line"><span class="number">49</span>:         <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="number">50</span>:             <span class="keyword">try</span> {</span><br><span class="line"><span class="number">51</span>:                 <span class="comment">// è·å¾— "selectedKeys" "publicSelectedKeys" çš„ Field</span></span><br><span class="line"><span class="number">52</span>:                 Field selectedKeysField = selectorImplClass.getDeclaredField(<span class="string">"selectedKeys"</span>);</span><br><span class="line"><span class="number">53</span>:                 Field publicSelectedKeysField = selectorImplClass.getDeclaredField(<span class="string">"publicSelectedKeys"</span>);</span><br><span class="line"><span class="number">54</span>: </span><br><span class="line"><span class="number">55</span>:                 <span class="comment">// è®¾ç½® Field å¯è®¿é—®</span></span><br><span class="line"><span class="number">56</span>:                 Throwable cause = ReflectionUtil.trySetAccessible(selectedKeysField, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">57</span>:                 <span class="keyword">if</span> (cause != <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">58</span>:                     <span class="keyword">return</span> cause;</span><br><span class="line"><span class="number">59</span>:                 }</span><br><span class="line"><span class="number">60</span>:                 cause = ReflectionUtil.trySetAccessible(publicSelectedKeysField, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">61</span>:                 <span class="keyword">if</span> (cause != <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">62</span>:                     <span class="keyword">return</span> cause;</span><br><span class="line"><span class="number">63</span>:                 }</span><br><span class="line"><span class="number">64</span>: </span><br><span class="line"><span class="number">65</span>:                 <span class="comment">// è®¾ç½® SelectedSelectionKeySet å¯¹è±¡åˆ° unwrappedSelector çš„ Field ä¸­</span></span><br><span class="line"><span class="number">66</span>:                 selectedKeysField.set(unwrappedSelector, selectedKeySet);</span><br><span class="line"><span class="number">67</span>:                 publicSelectedKeysField.set(unwrappedSelector, selectedKeySet);</span><br><span class="line"><span class="number">68</span>:                 <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">69</span>:             } <span class="keyword">catch</span> (NoSuchFieldException e) {</span><br><span class="line"><span class="number">70</span>:                 <span class="keyword">return</span> e; <span class="comment">// å¤±è´¥ï¼Œåˆ™è¿”å›è¯¥å¼‚å¸¸</span></span><br><span class="line"><span class="number">71</span>:             } <span class="keyword">catch</span> (IllegalAccessException e) {</span><br><span class="line"><span class="number">72</span>:                 <span class="keyword">return</span> e; <span class="comment">// å¤±è´¥ï¼Œåˆ™è¿”å›è¯¥å¼‚å¸¸</span></span><br><span class="line"><span class="number">73</span>:             }</span><br><span class="line"><span class="number">74</span>:         }</span><br><span class="line"><span class="number">75</span>:     });</span><br><span class="line"><span class="number">76</span>: </span><br><span class="line"><span class="number">77</span>:     <span class="comment">// è®¾ç½® SelectedSelectionKeySet å¯¹è±¡åˆ° unwrappedSelector ä¸­å¤±è´¥ï¼Œåˆ™ç›´æ¥è¿”å› SelectorTuple å¯¹è±¡ã€‚å³ï¼Œselector ä¹Ÿä½¿ç”¨ unwrappedSelector ã€‚</span></span><br><span class="line"><span class="number">78</span>:     <span class="keyword">if</span> (maybeException <span class="keyword">instanceof</span> Exception) {</span><br><span class="line"><span class="number">79</span>:         selectedKeys = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">80</span>:         Exception e = (Exception) maybeException;</span><br><span class="line"><span class="number">81</span>:         logger.trace(<span class="string">"failed to instrument a special java.util.Set into: {}"</span>, unwrappedSelector, e);</span><br><span class="line"><span class="number">82</span>:         <span class="keyword">return</span> <span class="keyword">new</span> SelectorTuple(unwrappedSelector);</span><br><span class="line"><span class="number">83</span>:     }</span><br><span class="line"><span class="number">84</span>: </span><br><span class="line"><span class="number">85</span>:     <span class="comment">// è®¾ç½® SelectedSelectionKeySet å¯¹è±¡åˆ° selectedKeys ä¸­</span></span><br><span class="line"><span class="number">86</span>:     selectedKeys = selectedKeySet;</span><br><span class="line"><span class="number">87</span>:     logger.trace(<span class="string">"instrumented a special java.util.Set into: {}"</span>, unwrappedSelector);</span><br><span class="line"><span class="number">88</span>: </span><br><span class="line"><span class="number">89</span>:     <span class="comment">// åˆ›å»º SelectedSelectionKeySetSelector å¯¹è±¡</span></span><br><span class="line"><span class="number">90</span>:     <span class="comment">// åˆ›å»º SelectorTuple å¯¹è±¡ã€‚å³ï¼Œselector ä¹Ÿä½¿ç”¨ SelectedSelectionKeySetSelector å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="number">91</span>:     <span class="keyword">return</span> <span class="keyword">new</span> SelectorTuple(unwrappedSelector, <span class="keyword">new</span> SelectedSelectionKeySetSelector(unwrappedSelector, selectedKeySet));</span><br><span class="line"><span class="number">92</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 2 è‡³ 8 è¡Œï¼šåˆ›å»º Selector å¯¹è±¡ï¼Œä½œä¸º <code>unwrappedSelector</code> ã€‚</li>
<li>ç¬¬ 10 è‡³ 13 è¡Œï¼šç¦ç”¨ SelectionKey çš„ä¼˜åŒ–ï¼Œåˆ™ç›´æ¥è¿”å› SelectorTuple å¯¹è±¡ã€‚å³ï¼Œ<code>selector</code> ä¹Ÿä½¿ç”¨ <code>unwrappedSelector</code> ã€‚</li>
<li>ç¬¬ 15 è‡³ 28 è¡Œï¼šè·å¾— SelectorImpl ç±»ã€‚èƒ–å‹å¯ä»¥è‡ªåŠ¨è¿‡æ»¤æ‰ <code>AccessController#.doPrivileged(...)</code> å¤–å±‚ä»£ç ã€‚åœ¨æ–¹æ³•å†…éƒ¨ï¼Œè°ƒç”¨ <code>Class#forName(String name, boolean initialize, ClassLoader loader)</code> æ–¹æ³•ï¼ŒåŠ è½½ <code>sun.nio.ch.SelectorImpl</code> ç±»ã€‚åŠ è½½æˆåŠŸï¼Œåˆ™è¿”å›è¯¥ç±»ï¼Œå¦åˆ™è¿”å›å¼‚å¸¸ã€‚<ul>
<li>ç¬¬ 30 è‡³ 39 è¡Œï¼š è·å¾— SelectorImpl ç±»å¤±è´¥ï¼Œåˆ™ç›´æ¥è¿”å› SelectorTuple å¯¹è±¡ã€‚å³ï¼Œ<code>selector</code> ä¹Ÿä½¿ç”¨ <code>unwrappedSelector</code> ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 44 è¡Œï¼šåˆ›å»º SelectedSelectionKeySet å¯¹è±¡ã€‚è¿™æ˜¯ Netty å¯¹ Selector çš„ <code>selectionKeys</code> çš„ä¼˜åŒ–ã€‚å…³äº SelectedSelectionKeySet çš„è¯¦ç»†å®ç°ï¼Œè§ <a href="#">ã€Œ4. SelectedSelectionKeySetã€</a> ã€‚</p>
<ul>
<li>ç¬¬ 46 è‡³ 75 è¡Œï¼š è®¾ç½® SelectedSelectionKeySet å¯¹è±¡åˆ° <code>unwrappedSelector</code> ä¸­çš„ <code>selectedKeys</code> å’Œ <code>publicSelectedKeys</code> å±æ€§ã€‚æ•´ä¸ªè¿‡ç¨‹ï¼Œç¬”è€…å·²ç»æ·»åŠ ä¸­æ–‡æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹ã€‚</li>
<li><p><code>selectedKeys</code> å’Œ <code>publicSelectedKeys</code> å±æ€§åœ¨ SelectorImpl ç±»ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> HashSet&lt;SelectionKey&gt; keys = <span class="keyword">new</span> HashSet(); <span class="comment">// =&gt; publicKeys</span></span><br><span class="line"><span class="keyword">private</span> Set&lt;SelectionKey&gt; publicKeys;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> Set&lt;SelectionKey&gt; selectedKeys = <span class="keyword">new</span> HashSet(); <span class="comment">// =&gt; publicSelectedKeys</span></span><br><span class="line"><span class="keyword">private</span> Set&lt;SelectionKey&gt; publicSelectedKeys;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">SelectorImpl</span><span class="params">(SelectorProvider var1)</span> </span>{</span><br><span class="line">    <span class="keyword">super</span>(var1);</span><br><span class="line">    <span class="keyword">if</span> (Util.atBugLevel(<span class="string">"1.4"</span>)) { <span class="comment">// å¯ä»¥æ— è§†</span></span><br><span class="line">        <span class="keyword">this</span>.publicKeys = <span class="keyword">this</span>.keys;</span><br><span class="line">        <span class="keyword">this</span>.publicSelectedKeys = <span class="keyword">this</span>.selectedKeys;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">this</span>.publicKeys = Collections.unmodifiableSet(<span class="keyword">this</span>.keys);</span><br><span class="line">        <span class="keyword">this</span>.publicSelectedKeys = Util.ungrowableSet(<span class="keyword">this</span>.selectedKeys);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¯ä»¥çœ‹åˆ°ï¼Œ<code>selectedKeys</code> å’Œ <code>publicSelectedKeys</code> çš„ç±»å‹éƒ½æ˜¯ HashSet ã€‚</li>
</ul>
</li>
<li>ç¬¬ 77 è‡³ 83 è¡Œï¼šè®¾ç½® SelectedSelectionKeySet å¯¹è±¡åˆ° <code>unwrappedSelector</code> ä¸­å¤±è´¥ï¼Œåˆ™ç›´æ¥è¿”å› SelectorTuple å¯¹è±¡ã€‚å³ï¼Œ<code>selector</code> ä¹Ÿä½¿ç”¨ <code>unwrappedSelector</code> ã€‚</li>
</ul>
</li>
<li>ç¬¬ 86 è¡Œï¼šè®¾ç½® SelectedSelectionKeySet å¯¹è±¡åˆ° <code>selectedKeys</code> ä¸­ã€‚åœ¨ä¸‹æ–‡ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œæ˜¯å¦æˆåŠŸä¼˜åŒ– Selector å¯¹è±¡ï¼Œæ˜¯é€šè¿‡ <code>selectedKeys</code> æ˜¯å¦æˆåŠŸåˆå§‹åŒ–æ¥åˆ¤æ–­ã€‚</li>
<li>ç¬¬ 91 è¡Œï¼šåˆ›å»º SelectedSelectionKeySetSelector å¯¹è±¡ã€‚è¿™æ˜¯ Netty å¯¹ Selector çš„ä¼˜åŒ–å®ç°ç±»ã€‚å…³äº SelectedSelectionKeySetSelector çš„è¯¦ç»†å®ç°ï¼Œè§ <a href="#">ã€Œ5. SelectedSelectionKeySetSelectorã€</a> ã€‚</li>
<li>ç¬¬ 91 è¡Œï¼šåˆ›å»º SelectorTuple å¯¹è±¡ã€‚å³ï¼Œ<code>selector</code> ä½¿ç”¨ SelectedSelectionKeySetSelector å¯¹è±¡ã€‚ğŸ˜ˆ æ€»ç®—ï¼Œåˆ›å»ºæˆåŠŸä¼˜åŒ–çš„ <code>selector</code> å¯¹è±¡äº†ã€‚</li>
</ul>
<h1 id="4-SelectedSelectionKeySet"><a href="#4-SelectedSelectionKeySet" class="headerlink" title="4. SelectedSelectionKeySet"></a>4. SelectedSelectionKeySet</h1><p><code>io.netty.channel.nio.SelectedSelectionKeySet</code> ï¼Œç»§æ‰¿ AbstractSet æŠ½è±¡ç±»ï¼Œå·² <strong>select</strong> çš„ NIO SelectionKey é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectedSelectionKeySet</span> <span class="keyword">extends</span> <span class="title">AbstractSet</span>&lt;<span class="title">SelectionKey</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SelectionKey æ•°ç»„</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SelectionKey[] keys;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ•°ç»„å¯è¯»å¤§å°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line"></span><br><span class="line">    SelectedSelectionKeySet() {</span><br><span class="line">        keys = <span class="keyword">new</span> SelectionKey[<span class="number">1024</span>]; <span class="comment">// é»˜è®¤ 1024 å¤§å°</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(SelectionKey o)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ·»åŠ åˆ°æ•°ç»„</span></span><br><span class="line">        keys[size++] = o;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¶…è¿‡æ•°ç»„å¤§å°ä¸Šé™ï¼Œè¿›è¡Œæ‰©å®¹</span></span><br><span class="line">        <span class="keyword">if</span> (size == keys.length) {</span><br><span class="line">            increaseCapacity();</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> size;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(Object o)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Iterator&lt;SelectionKey&gt; <span class="title">iterator</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>{</span><br><span class="line">        reset(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reset</span><span class="params">(<span class="keyword">int</span> start)</span> </span>{</span><br><span class="line">        <span class="comment">// é‡ç½®æ•°ç»„å†…å®¹ä¸ºç©º</span></span><br><span class="line">        Arrays.fill(keys, start, size, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// é‡ç½®å¯è¯»å¤§å°ä¸º 0</span></span><br><span class="line">        size = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">increaseCapacity</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// ä¸¤å€æ‰©å®¹</span></span><br><span class="line">        SelectionKey[] newKeys = <span class="keyword">new</span> SelectionKey[keys.length &lt;&lt; <span class="number">1</span>];</span><br><span class="line">        <span class="comment">// å¤åˆ¶è€æ•°ç»„åˆ°æ–°æ•°ç»„</span></span><br><span class="line">        System.arraycopy(keys, <span class="number">0</span>, newKeys, <span class="number">0</span>, size);</span><br><span class="line">        <span class="comment">// èµ‹å€¼ç»™è€æ•°ç»„</span></span><br><span class="line">        keys = newKeys;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é€šè¿‡ <code>keys</code> å’Œ <code>size</code> ä¸¤ä¸ªå±æ€§ï¼Œå®ç°<strong>å¯é‡ç”¨</strong>çš„æ•°ç»„ã€‚</li>
<li><code>#add(SelectionKey o)</code> æ–¹æ³•ï¼Œæ·»åŠ æ–° <strong>select</strong> åˆ°å°±ç»ªäº‹ä»¶çš„ SelectionKey åˆ° <code>keys</code> ä¸­ã€‚å½“è¶…è¿‡æ•°ç»„å¤§å°ä¸Šé™æ—¶ï¼Œè°ƒç”¨ <code>#increaseCapacity()</code> æ–¹æ³•ï¼Œè¿›è¡Œ<strong>ä¸¤å€</strong>æ‰©å®¹ã€‚ç›¸æ¯” SelectorImpl ä¸­ä½¿ç”¨çš„ <code>selectedKeys</code> æ‰€ä½¿ç”¨çš„ HashSet çš„ <code>#add(E e)</code> æ–¹æ³•ï¼Œäº‹ä»¶å¤æ‚åº¦ä» <code>O(lgn)</code> <strong>é™ä½</strong>åˆ° <code>O(1)</code> ã€‚</li>
<li><code>#reset(...)</code> æ–¹æ³•ï¼Œæ¯æ¬¡è¯»å–ä½¿ç”¨å®Œæ•°æ®ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼Œè¿›è¡Œé‡ç½®ã€‚</li>
<li>å› ä¸º <code>#remove(Object o)</code>ã€<code>#contains(Object o)</code>ã€<code>#iterator()</code> ä¸ä¼šä½¿ç”¨åˆ°ï¼Œç´¢æ€§ä¸è¿›è¡Œå®ç°ã€‚</li>
</ul>
<h1 id="5-SelectedSelectionKeySetSelector"><a href="#5-SelectedSelectionKeySetSelector" class="headerlink" title="5. SelectedSelectionKeySetSelector"></a>5. SelectedSelectionKeySetSelector</h1><p><code>io.netty.channel.nio.SelectedSelectionKeySetSelector</code> ï¼ŒåŸºäº Netty SelectedSelectionKeySet ä½œä¸º <code>selectionKeys</code> çš„ Selector å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SelectedSelectionKeySetSelector</span> <span class="keyword">extends</span> <span class="title">Selector</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * SelectedSelectionKeySet å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SelectedSelectionKeySet selectionKeys;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŸå§‹ Java NIO Selector å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Selector delegate;</span><br><span class="line"></span><br><span class="line">    SelectedSelectionKeySetSelector(Selector delegate, SelectedSelectionKeySet selectionKeys) {</span><br><span class="line">        <span class="keyword">this</span>.delegate = delegate;</span><br><span class="line">        <span class="keyword">this</span>.selectionKeys = selectionKeys;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isOpen</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> delegate.isOpen();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SelectorProvider <span class="title">provider</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> delegate.provider();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;SelectionKey&gt; <span class="title">keys</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> delegate.keys();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;SelectionKey&gt; <span class="title">selectedKeys</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> delegate.selectedKeys();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">selectNow</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">        <span class="comment">// é‡ç½® selectionKeys</span></span><br><span class="line">        selectionKeys.reset();</span><br><span class="line">        <span class="comment">// selectNow</span></span><br><span class="line">        <span class="keyword">return</span> delegate.selectNow();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">select</span><span class="params">(<span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">        <span class="comment">// é‡ç½® selectionKeys</span></span><br><span class="line">        selectionKeys.reset();</span><br><span class="line">        <span class="comment">// select</span></span><br><span class="line">        <span class="keyword">return</span> delegate.select(timeout);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">select</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">        <span class="comment">// é‡ç½® selectionKeys</span></span><br><span class="line">        selectionKeys.reset();</span><br><span class="line">        <span class="comment">// select</span></span><br><span class="line">        <span class="keyword">return</span> delegate.select();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Selector <span class="title">wakeup</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> delegate.wakeup();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">        delegate.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é™¤äº† <strong>select</strong> ç›¸å…³çš„ 3 ä¸ªæ–¹æ³•ï¼Œæ¯ä¸ªå®ç°æ–¹æ³•ï¼Œéƒ½æ˜¯åŸºäº Java NIO Selector å¯¹åº”çš„æ–¹æ³•çš„è°ƒç”¨ã€‚</li>
<li><strong>select</strong> ç›¸å…³çš„ 3 ä¸ªæ–¹æ³•ï¼Œåœ¨è°ƒç”¨å¯¹åº”çš„ Java NIO Selector æ–¹æ³•ä¹‹å‰ï¼Œä¼šè°ƒç”¨ <code>SelectedSelectionKeySet#reset()</code> æ–¹æ³•ï¼Œé‡ç½® <code>selectionKeys</code> ã€‚ä»è€Œå®ç°ï¼Œæ¯æ¬¡ select ä¹‹åï¼Œéƒ½æ˜¯<strong>æ–°çš„</strong>å·² select çš„ NIO SelectionKey é›†åˆã€‚</li>
</ul>
<h1 id="6-rebuildSelector"><a href="#6-rebuildSelector" class="headerlink" title="6. rebuildSelector"></a>6. rebuildSelector</h1><p><code>#rebuildSelector()</code> æ–¹æ³•ï¼Œé‡å»º Selector å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>è¯¥æ–¹æ³•ç”¨äº NIO Selector å‘ç”Ÿ epoll bug æ—¶ï¼Œé‡å»º Selector å¯¹è±¡ã€‚</p>
<p>ğŸ˜ˆ çªç„¶åˆæ‰¾åˆ°ä¸€ä¸ªè®¨è®ºï¼Œå¯ä»¥çœ‹çœ‹ <a href="https://github.com/Yhzhtk/note/issues/26" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJDK 1.7 åŠä»¥ä¸‹ NIO çš„ epoll bugã€‹</a> å’Œ <a href="http://www.10tiao.com/html/308/201602/401718035/1.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šåº”ç”¨æœåŠ¡å™¨ä¸­å¯¹JDKçš„epollç©ºè½¬bugçš„å¤„ç†ã€‹</a> ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rebuildSelector</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// åªå…è®¸åœ¨ EventLoop çš„çº¿ç¨‹ä¸­æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">if</span> (!inEventLoop()) {</span><br><span class="line">        execute(<span class="keyword">new</span> Runnable() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">                rebuildSelector0();</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    rebuildSelector0();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åªå…è®¸åœ¨ EventLoop çš„çº¿ç¨‹ä¸­ï¼Œè°ƒç”¨ <code>#rebuildSelector0()</code> æ–¹æ³•ï¼Œé‡å»º Selector å¯¹è±¡ã€‚</li>
</ul>
<h2 id="6-1-rebuildSelector0"><a href="#6-1-rebuildSelector0" class="headerlink" title="6.1 rebuildSelector0"></a>6.1 rebuildSelector0</h2><p><code>#rebuildSelector0()</code> æ–¹æ³•ï¼Œé‡å»º Selector å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rebuildSelector0</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">final</span> Selector oldSelector = selector;</span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (oldSelector == <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</span><br><span class="line"> <span class="number">5</span>:     }</span><br><span class="line"> <span class="number">6</span>: </span><br><span class="line"> <span class="number">7</span>:     <span class="comment">// åˆ›å»ºæ–°çš„ Selector å¯¹è±¡</span></span><br><span class="line"> <span class="number">8</span>:     <span class="keyword">final</span> SelectorTuple newSelectorTuple;</span><br><span class="line"> <span class="number">9</span>:     <span class="keyword">try</span> {</span><br><span class="line"><span class="number">10</span>:         newSelectorTuple = openSelector();</span><br><span class="line"><span class="number">11</span>:     } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line"><span class="number">12</span>:         logger.warn(<span class="string">"Failed to create a new Selector."</span>, e);</span><br><span class="line"><span class="number">13</span>:         <span class="keyword">return</span>;</span><br><span class="line"><span class="number">14</span>:     }</span><br><span class="line"><span class="number">15</span>: </span><br><span class="line"><span class="number">16</span>:     <span class="comment">// Register all channels to the new Selector.</span></span><br><span class="line"><span class="number">17</span>:     <span class="comment">// å°†æ³¨å†Œåœ¨ NioEventLoop ä¸Šçš„æ‰€æœ‰ Channel ï¼Œæ³¨å†Œåˆ°æ–°åˆ›å»º Selector å¯¹è±¡ä¸Š</span></span><br><span class="line"><span class="number">18</span>:     <span class="keyword">int</span> nChannels = <span class="number">0</span>; <span class="comment">// è®¡ç®—é‡æ–°æ³¨å†ŒæˆåŠŸçš„ Channel æ•°é‡</span></span><br><span class="line"><span class="number">19</span>:     <span class="keyword">for</span> (SelectionKey key: oldSelector.keys()) {</span><br><span class="line"><span class="number">20</span>:         Object a = key.attachment();</span><br><span class="line"><span class="number">21</span>:         <span class="keyword">try</span> {</span><br><span class="line"><span class="number">22</span>:             <span class="keyword">if</span> (!key.isValid() || key.channel().keyFor(newSelectorTuple.unwrappedSelector) != <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">23</span>:                 <span class="keyword">continue</span>;</span><br><span class="line"><span class="number">24</span>:             }</span><br><span class="line"><span class="number">25</span>: </span><br><span class="line"><span class="number">26</span>:             <span class="keyword">int</span> interestOps = key.interestOps();</span><br><span class="line"><span class="number">27</span>:             <span class="comment">// å–æ¶ˆè€çš„ SelectionKey</span></span><br><span class="line"><span class="number">28</span>:             key.cancel();</span><br><span class="line"><span class="number">29</span>:             <span class="comment">// å°† Channel æ³¨å†Œåˆ°æ–°çš„ Selector å¯¹è±¡ä¸Š</span></span><br><span class="line"><span class="number">30</span>:             SelectionKey newKey = key.channel().register(newSelectorTuple.unwrappedSelector, interestOps, a);</span><br><span class="line"><span class="number">31</span>:             <span class="comment">// ä¿®æ”¹ Channel çš„ selectionKey æŒ‡å‘æ–°çš„ SelectionKey ä¸Š</span></span><br><span class="line"><span class="number">32</span>:             <span class="keyword">if</span> (a <span class="keyword">instanceof</span> AbstractNioChannel) {</span><br><span class="line"><span class="number">33</span>:                 <span class="comment">// Update SelectionKey</span></span><br><span class="line"><span class="number">34</span>:                 ((AbstractNioChannel) a).selectionKey = newKey;</span><br><span class="line"><span class="number">35</span>:             }</span><br><span class="line"><span class="number">36</span>: </span><br><span class="line"><span class="number">37</span>:             <span class="comment">// è®¡æ•° ++</span></span><br><span class="line"><span class="number">38</span>:             nChannels ++;</span><br><span class="line"><span class="number">39</span>:         } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line"><span class="number">40</span>:             logger.warn(<span class="string">"Failed to re-register a Channel to the new Selector."</span>, e);</span><br><span class="line"><span class="number">41</span>:             <span class="comment">// å…³é—­å‘ç”Ÿå¼‚å¸¸çš„ Channel</span></span><br><span class="line"><span class="number">42</span>:             <span class="keyword">if</span> (a <span class="keyword">instanceof</span> AbstractNioChannel) {</span><br><span class="line"><span class="number">43</span>:                 AbstractNioChannel ch = (AbstractNioChannel) a;</span><br><span class="line"><span class="number">44</span>:                 ch.unsafe().close(ch.unsafe().voidPromise());</span><br><span class="line"><span class="number">45</span>:             <span class="comment">// è°ƒç”¨ NioTask çš„å–æ¶ˆæ³¨å†Œäº‹ä»¶</span></span><br><span class="line"><span class="number">46</span>:             } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">47</span>:                 <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="number">48</span>:                 NioTask&lt;SelectableChannel&gt; task = (NioTask&lt;SelectableChannel&gt;) a;</span><br><span class="line"><span class="number">49</span>:                 invokeChannelUnregistered(task, key, e);</span><br><span class="line"><span class="number">50</span>:             }</span><br><span class="line"><span class="number">51</span>:         }</span><br><span class="line"><span class="number">52</span>:     }</span><br><span class="line"><span class="number">53</span>: </span><br><span class="line"><span class="number">54</span>:     <span class="comment">// ä¿®æ”¹ selector å’Œ unwrappedSelector æŒ‡å‘æ–°çš„ Selector å¯¹è±¡</span></span><br><span class="line"><span class="number">55</span>:     selector = newSelectorTuple.selector;</span><br><span class="line"><span class="number">56</span>:     unwrappedSelector = newSelectorTuple.unwrappedSelector;</span><br><span class="line"><span class="number">57</span>: </span><br><span class="line"><span class="number">58</span>:     <span class="comment">// å…³é—­è€çš„ Selector å¯¹è±¡</span></span><br><span class="line"><span class="number">59</span>:     <span class="keyword">try</span> {</span><br><span class="line"><span class="number">60</span>:         <span class="comment">// time to close the old selector as everything else is registered to the new one</span></span><br><span class="line"><span class="number">61</span>:         oldSelector.close();</span><br><span class="line"><span class="number">62</span>:     } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line"><span class="number">63</span>:         <span class="keyword">if</span> (logger.isWarnEnabled()) {</span><br><span class="line"><span class="number">64</span>:             logger.warn(<span class="string">"Failed to close the old Selector."</span>, t);</span><br><span class="line"><span class="number">65</span>:         }</span><br><span class="line"><span class="number">66</span>:     }</span><br><span class="line"><span class="number">67</span>: </span><br><span class="line"><span class="number">68</span>:     <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br><span class="line"><span class="number">69</span>:         logger.info(<span class="string">"Migrated "</span> + nChannels + <span class="string">" channel(s) to the new Selector."</span>);</span><br><span class="line"><span class="number">70</span>:     }</span><br><span class="line"><span class="number">71</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 7 è¡Œï¼šè°ƒç”¨ <code>#openSelector()</code> æ–¹æ³•ï¼Œåˆ›å»ºæ–°çš„ Selector å¯¹è±¡ã€‚</li>
<li>ç¬¬ 16 è‡³ 52 è¡Œï¼šéå†<strong>è€</strong>çš„ Selector å¯¹è±¡çš„ <code>selectionKeys</code> ï¼Œå°†æ³¨å†Œåœ¨ NioEventLoop ä¸Šçš„æ‰€æœ‰ Channel ï¼Œæ³¨å†Œåˆ°<strong>æ–°</strong>åˆ›å»º Selector å¯¹è±¡ä¸Šã€‚<ul>
<li>ç¬¬ 22 è‡³ 24 è¡Œï¼šæ ¡éªŒ SelectionKey æœ‰æ•ˆï¼Œå¹¶ä¸” Java NIO Channel å¹¶æœªæ³¨å†Œåœ¨<strong>æ–°</strong>çš„ Selector å¯¹è±¡ä¸Šã€‚</li>
<li>ç¬¬ 28 è¡Œï¼šè°ƒç”¨ <code>SelectionKey#cancel()</code> æ–¹æ³•ï¼Œå–æ¶ˆ<strong>è€</strong>çš„ SelectionKey ã€‚</li>
<li>ç¬¬ 30 è¡Œï¼šå°† Java NIO Channel æ³¨å†Œåˆ°<strong>æ–°</strong>çš„ Selector å¯¹è±¡ä¸Šï¼Œè¿”å›<strong>æ–°</strong>çš„ SelectionKey å¯¹è±¡ã€‚</li>
<li>ç¬¬ 31 è‡³ 35 è¡Œï¼šä¿®æ”¹ Channel çš„ <code>selectionKey</code> æŒ‡å‘<strong>æ–°</strong>çš„ SelectionKey å¯¹è±¡</li>
<li>ç¬¬ 39 è‡³ 51 è¡Œï¼šå½“å‘ç”Ÿå¼‚å¸¸æ—¶å€™ï¼Œæ ¹æ®ä¸åŒçš„ SelectionKey çš„ <code>attachment</code> æ¥åˆ¤æ–­å¤„ç†æ–¹å¼ï¼š<ul>
<li>ç¬¬ 41 è‡³ 44 è¡Œï¼šå½“ <code>attachment</code> æ˜¯ Netty NIO Channel æ—¶ï¼Œè°ƒç”¨ <code>Unsafe#close(ChannelPromise promise)</code> æ–¹æ³•ï¼Œ<strong>å…³é—­</strong>å‘ç”Ÿå¼‚å¸¸çš„ Channel ã€‚</li>
<li>ç¬¬ 45 è‡³ 50 è¡Œï¼šå½“ <code>attachment</code> æ˜¯ Netty NioTask æ—¶ï¼Œè°ƒç”¨ <code>#invokeChannelUnregistered(NioTask&lt;SelectableChannel&gt; task, SelectionKey k, Throwable cause)</code> æ–¹æ³•ï¼Œé€šçŸ¥ Channel å–æ¶ˆæ³¨å†Œã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8. NioTaskã€</a> ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 54 è‡³ 56 è¡Œï¼šä¿®æ”¹ <code>selector</code> å’Œ <code>unwrappedSelector</code> æŒ‡å‘<strong>æ–°</strong>çš„ Selector å¯¹è±¡ã€‚</li>
<li>ç¬¬ 58 è‡³ 66 è¡Œï¼šè°ƒç”¨ <code>Selector#close()</code> æ–¹æ³•ï¼Œå…³é—­<strong>è€</strong>çš„ Selector å¯¹è±¡ã€‚</li>
</ul>
<p>æ€»çš„æ¥è¯´ï¼Œ<code>#rebuildSelector()</code> æ–¹æ³•ï¼Œç›¸æ¯” <code>#openSelector()</code> æ–¹æ³•ï¼Œä¸»è¦æ˜¯éœ€è¦å°†è€çš„ Selector å¯¹è±¡çš„â€œæ•°æ®â€å¤åˆ¶åˆ°æ–°çš„ Selector å¯¹è±¡ä¸Šï¼Œå¹¶å…³é—­è€çš„ Selector å¯¹è±¡ã€‚</p>
<h1 id="7-processSelectedKeys"><a href="#7-processSelectedKeys" class="headerlink" title="7. processSelectedKeys"></a>7. processSelectedKeys</h1><p>åœ¨ <code>#run()</code> æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨ <code>#processSelectedKeys()</code> æ–¹æ³•ï¼Œå¤„ç† Channel <strong>æ–°å¢</strong>å°±ç»ªçš„ IO äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processSelectedKeys</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (selectedKeys != <span class="keyword">null</span>) {</span><br><span class="line">        processSelectedKeysOptimized();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        processSelectedKeysPlain(selector.selectedKeys());</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å½“ <code>selectedKeys</code> éç©ºï¼Œæ„å‘³ç€ä½¿ç”¨ä¼˜åŒ–çš„ SelectedSelectionKeySetSelector ï¼Œæ‰€ä»¥è°ƒç”¨ <code>#processSelectedKeysOptimized()</code> æ–¹æ³•ï¼›å¦åˆ™ï¼Œè°ƒç”¨ <code>#processSelectedKeysPlain()</code> æ–¹æ³•ã€‚</li>
</ul>
<h2 id="7-1-processSelectedKeysOptimized"><a href="#7-1-processSelectedKeysOptimized" class="headerlink" title="7.1 processSelectedKeysOptimized"></a>7.1 processSelectedKeysOptimized</h2><p><code>#processSelectedKeysOptimized()</code> æ–¹æ³•ï¼ŒåŸºäº Netty SelectedSelectionKeySetSelector ï¼Œå¤„ç† Channel <strong>æ–°å¢</strong>å°±ç»ªçš„ IO äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>è€è‰¿è‰¿ï¼šä»æ–¹æ³•åï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œè¿™æ˜¯ä¸ªç»è¿‡<strong>ä¼˜åŒ–</strong>çš„å®ç°ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processSelectedKeysOptimized</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// éå†æ•°ç»„</span></span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; selectedKeys.size; ++i) {</span><br><span class="line"> <span class="number">4</span>:         <span class="keyword">final</span> SelectionKey k = selectedKeys.keys[i];</span><br><span class="line"> <span class="number">5</span>:         <span class="comment">// null out entry in the array to allow to have it GC'ed once the Channel close</span></span><br><span class="line"> <span class="number">6</span>:         <span class="comment">// See https://github.com/netty/netty/issues/2363</span></span><br><span class="line"> <span class="number">7</span>:         selectedKeys.keys[i] = <span class="keyword">null</span>;</span><br><span class="line"> <span class="number">8</span>: </span><br><span class="line"> <span class="number">9</span>:         <span class="keyword">final</span> Object a = k.attachment();</span><br><span class="line"><span class="number">10</span>: </span><br><span class="line"><span class="number">11</span>:         <span class="comment">// å¤„ç†ä¸€ä¸ª Channel å°±ç»ªçš„ IO äº‹ä»¶</span></span><br><span class="line"><span class="number">12</span>:         <span class="keyword">if</span> (a <span class="keyword">instanceof</span> AbstractNioChannel) {</span><br><span class="line"><span class="number">13</span>:             processSelectedKey(k, (AbstractNioChannel) a);</span><br><span class="line"><span class="number">14</span>:         <span class="comment">// ä½¿ç”¨ NioTask å¤„ç†ä¸€ä¸ª Channel å°±ç»ªçš„ IO äº‹ä»¶</span></span><br><span class="line"><span class="number">15</span>:         } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">16</span>:             <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="number">17</span>:             NioTask&lt;SelectableChannel&gt; task = (NioTask&lt;SelectableChannel&gt;) a;</span><br><span class="line"><span class="number">18</span>:             processSelectedKey(k, task);</span><br><span class="line"><span class="number">19</span>:         }</span><br><span class="line"><span class="number">20</span>: </span><br><span class="line"><span class="number">21</span>:         <span class="comment">// TODO 1007 NioEventLoop cancel æ–¹æ³•</span></span><br><span class="line"><span class="number">22</span>:         <span class="keyword">if</span> (needsToSelectAgain) {</span><br><span class="line"><span class="number">23</span>:             <span class="comment">// null out entries in the array to allow to have it GC'ed once the Channel close</span></span><br><span class="line"><span class="number">24</span>:             <span class="comment">// See https://github.com/netty/netty/issues/2363</span></span><br><span class="line"><span class="number">25</span>:             selectedKeys.reset(i + <span class="number">1</span>);</span><br><span class="line"><span class="number">26</span>: </span><br><span class="line"><span class="number">27</span>:             selectAgain();</span><br><span class="line"><span class="number">28</span>:             i = -<span class="number">1</span>;</span><br><span class="line"><span class="number">29</span>:         }</span><br><span class="line"><span class="number">30</span>:     }</span><br><span class="line"><span class="number">31</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šå¾ªç¯ <code>selectedKeys</code> æ•°ç»„ã€‚<ul>
<li>ç¬¬ 4 è‡³ 7 è¡Œï¼šç½®ç©ºï¼ŒåŸå› è§ <a href="https://github.com/netty/netty/issues/2363" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/netty/netty/issues/2363</a> ã€‚</li>
<li>ç¬¬ 11 è‡³ 13 è¡Œï¼šå½“ <code>attachment</code> æ˜¯ Netty NIO Channel æ—¶ï¼Œè°ƒç”¨ <code>#processSelectedKey(SelectionKey k, AbstractNioChannel ch)</code> æ–¹æ³•ï¼Œå¤„ç†ä¸€ä¸ª Channel å°±ç»ªçš„ IO äº‹ä»¶ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ7.3 processSelectedKeyã€</a> ã€‚</li>
<li>ç¬¬ 14 è‡³ 19 è¡Œï¼šå½“ <code>attachment</code> æ˜¯ Netty NioTask æ—¶ï¼Œè°ƒç”¨ <code>#processSelectedKey(SelectionKey k, NioTask&lt;SelectableChannel&gt; task)</code> æ–¹æ³•ï¼Œä½¿ç”¨ NioTask å¤„ç†ä¸€ä¸ª Channel çš„ IO äº‹ä»¶ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8. NioTaskã€</a> ã€‚</li>
<li>ç¬¬ 21 è‡³ 29 è¡Œï¼šTODO 1007 NioEventLoop cancel æ–¹æ³•</li>
</ul>
</li>
</ul>
<h2 id="7-2-processSelectedKeysPlain"><a href="#7-2-processSelectedKeysPlain" class="headerlink" title="7.2 processSelectedKeysPlain"></a>7.2 processSelectedKeysPlain</h2><p><code>#processSelectedKeysOptimized()</code> æ–¹æ³•ï¼ŒåŸºäº Java NIO åŸç”Ÿ Selecotr ï¼Œå¤„ç† Channel <strong>æ–°å¢</strong>å°±ç»ªçš„ IO äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>è€è‰¿è‰¿ï¼šæ€»ä½“å’Œ <code>#processSelectedKeysOptimized()</code> æ–¹æ³•<strong>ç±»ä¼¼</strong>ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processSelectedKeysPlain</span><span class="params">(Set&lt;SelectionKey&gt; selectedKeys)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// check if the set is empty and if so just return to not create garbage by</span></span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// creating a new Iterator every time even if there is nothing to process.</span></span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// See https://github.com/netty/netty/issues/597</span></span><br><span class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (selectedKeys.isEmpty()) {</span><br><span class="line"> <span class="number">6</span>:         <span class="keyword">return</span>;</span><br><span class="line"> <span class="number">7</span>:     }</span><br><span class="line"> <span class="number">8</span>: </span><br><span class="line"> <span class="number">9</span>:     <span class="comment">// éå† SelectionKey è¿­ä»£å™¨</span></span><br><span class="line"><span class="number">10</span>:     Iterator&lt;SelectionKey&gt; i = selectedKeys.iterator();</span><br><span class="line"><span class="number">11</span>:     <span class="keyword">for</span> (;;) {</span><br><span class="line"><span class="number">12</span>:         <span class="comment">// è·å¾— SelectionKey å¯¹è±¡</span></span><br><span class="line"><span class="number">13</span>:         <span class="keyword">final</span> SelectionKey k = i.next();</span><br><span class="line"><span class="number">14</span>:         <span class="comment">// ä»è¿­ä»£å™¨ä¸­ç§»é™¤</span></span><br><span class="line"><span class="number">15</span>:         i.remove();</span><br><span class="line"><span class="number">16</span>: </span><br><span class="line"><span class="number">17</span>:         <span class="keyword">final</span> Object a = k.attachment();</span><br><span class="line"><span class="number">18</span>:         <span class="comment">// å¤„ç†ä¸€ä¸ª Channel å°±ç»ªçš„ IO äº‹ä»¶</span></span><br><span class="line"><span class="number">19</span>:         <span class="keyword">if</span> (a <span class="keyword">instanceof</span> AbstractNioChannel) {</span><br><span class="line"><span class="number">20</span>:             processSelectedKey(k, (AbstractNioChannel) a);</span><br><span class="line"><span class="number">21</span>:         <span class="comment">// ä½¿ç”¨ NioTask å¤„ç†ä¸€ä¸ª Channel å°±ç»ªçš„ IO äº‹ä»¶</span></span><br><span class="line"><span class="number">22</span>:         } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">23</span>:             <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="number">24</span>:             NioTask&lt;SelectableChannel&gt; task = (NioTask&lt;SelectableChannel&gt;) a;</span><br><span class="line"><span class="number">25</span>:             processSelectedKey(k, task);</span><br><span class="line"><span class="number">26</span>:         }</span><br><span class="line"><span class="number">27</span>: </span><br><span class="line"><span class="number">28</span>:         <span class="comment">// æ— ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œç»“æŸ</span></span><br><span class="line"><span class="number">29</span>:         <span class="keyword">if</span> (!i.hasNext()) {</span><br><span class="line"><span class="number">30</span>:             <span class="keyword">break</span>;</span><br><span class="line"><span class="number">31</span>:         }</span><br><span class="line"><span class="number">32</span>: </span><br><span class="line"><span class="number">33</span>:         <span class="comment">// TODO 1007 NioEventLoop cancel æ–¹æ³•</span></span><br><span class="line"><span class="number">34</span>:         <span class="keyword">if</span> (needsToSelectAgain) {</span><br><span class="line"><span class="number">35</span>:             selectAgain();</span><br><span class="line"><span class="number">36</span>:             selectedKeys = selector.selectedKeys();</span><br><span class="line"><span class="number">37</span>: </span><br><span class="line"><span class="number">38</span>:             <span class="comment">// Create the iterator again to avoid ConcurrentModificationException</span></span><br><span class="line"><span class="number">39</span>:             <span class="keyword">if</span> (selectedKeys.isEmpty()) {</span><br><span class="line"><span class="number">40</span>:                 <span class="keyword">break</span>;</span><br><span class="line"><span class="number">41</span>:             } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">42</span>:                 i = selectedKeys.iterator();</span><br><span class="line"><span class="number">43</span>:             }</span><br><span class="line"><span class="number">44</span>:         }</span><br><span class="line"><span class="number">45</span>:     }</span><br><span class="line"><span class="number">46</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 10 è‡³ 11 è¡Œï¼šéå† SelectionKey <strong>è¿­ä»£å™¨</strong>ã€‚<ul>
<li>ç¬¬ 12 è‡³ 15 è¡Œï¼šè·å¾—ä¸‹ä¸€ä¸ª SelectionKey å¯¹è±¡ï¼Œå¹¶ä»è¿­ä»£å™¨ä¸­ç§»é™¤ã€‚</li>
<li>ç¬¬ 18 è‡³ 20 è¡Œï¼šå½“ <code>attachment</code> æ˜¯ Netty NIO Channel æ—¶ï¼Œè°ƒç”¨ <code>#processSelectedKey(SelectionKey k, AbstractNioChannel ch)</code> æ–¹æ³•ï¼Œå¤„ç†ä¸€ä¸ª Channel å°±ç»ªçš„ IO äº‹ä»¶ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ7.3 processSelectedKeyã€</a> ã€‚</li>
<li>ç¬¬ 21 è‡³ 26 è¡Œï¼šå½“ <code>attachment</code> æ˜¯ Netty NioTask æ—¶ï¼Œè°ƒç”¨ <code>#processSelectedKey(SelectionKey k, NioTask&lt;SelectableChannel&gt; task)</code> æ–¹æ³•ï¼Œä½¿ç”¨ NioTask å¤„ç†ä¸€ä¸ª Channel çš„ IO äº‹ä»¶ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8. NioTaskã€</a> ã€‚</li>
<li>ç¬¬ 33 è‡³ 44 è¡Œï¼šTODO 1007 NioEventLoop cancel æ–¹æ³•</li>
</ul>
</li>
</ul>
<h2 id="7-3-processSelectedKey"><a href="#7-3-processSelectedKey" class="headerlink" title="7.3 processSelectedKey"></a>7.3 processSelectedKey</h2><p><code>#processSelectedKey(SelectionKey k, AbstractNioChannel ch)</code> æ–¹æ³•ï¼Œå¤„ç†ä¸€ä¸ª Channel å°±ç»ªçš„ IO äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processSelectedKey</span><span class="params">(SelectionKey k, AbstractNioChannel ch)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// å¦‚æœ SelectionKey æ˜¯ä¸åˆæ³•çš„ï¼Œåˆ™å…³é—­ Channel</span></span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">final</span> AbstractNioChannel.NioUnsafe unsafe = ch.unsafe();</span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (!k.isValid()) {</span><br><span class="line"> <span class="number">5</span>:         <span class="keyword">final</span> EventLoop eventLoop;</span><br><span class="line"> <span class="number">6</span>:         <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">7</span>:             eventLoop = ch.eventLoop();</span><br><span class="line"> <span class="number">8</span>:         } <span class="keyword">catch</span> (Throwable ignored) {</span><br><span class="line"> <span class="number">9</span>:             <span class="comment">// If the channel implementation throws an exception because there is no event loop, we ignore this</span></span><br><span class="line"><span class="number">10</span>:             <span class="comment">// because we are only trying to determine if ch is registered to this event loop and thus has authority</span></span><br><span class="line"><span class="number">11</span>:             <span class="comment">// to close ch.</span></span><br><span class="line"><span class="number">12</span>:             <span class="keyword">return</span>;</span><br><span class="line"><span class="number">13</span>:         }</span><br><span class="line"><span class="number">14</span>:         <span class="comment">// Only close ch if ch is still registered to this EventLoop. ch could have deregistered from the event loop</span></span><br><span class="line"><span class="number">15</span>:         <span class="comment">// and thus the SelectionKey could be cancelled as part of the deregistration process, but the channel is</span></span><br><span class="line"><span class="number">16</span>:         <span class="comment">// still healthy and should not be closed.</span></span><br><span class="line"><span class="number">17</span>:         <span class="comment">// See https://github.com/netty/netty/issues/5125</span></span><br><span class="line"><span class="number">18</span>:         <span class="keyword">if</span> (eventLoop != <span class="keyword">this</span>) {</span><br><span class="line"><span class="number">19</span>:             <span class="keyword">return</span>;</span><br><span class="line"><span class="number">20</span>:         }</span><br><span class="line"><span class="number">21</span>:         <span class="comment">// close the channel if the key is not valid anymore</span></span><br><span class="line"><span class="number">22</span>:         unsafe.close(unsafe.voidPromise());</span><br><span class="line"><span class="number">23</span>:         <span class="keyword">return</span>;</span><br><span class="line"><span class="number">24</span>:     }</span><br><span class="line"><span class="number">25</span>: </span><br><span class="line"><span class="number">26</span>:     <span class="keyword">try</span> {</span><br><span class="line"><span class="number">27</span>:         <span class="comment">// è·å¾—å°±ç»ªçš„ IO äº‹ä»¶çš„ ops</span></span><br><span class="line"><span class="number">28</span>:         <span class="keyword">int</span> readyOps = k.readyOps();</span><br><span class="line"><span class="number">29</span>: </span><br><span class="line"><span class="number">30</span>:         <span class="comment">// OP_CONNECT äº‹ä»¶å°±ç»ª</span></span><br><span class="line"><span class="number">31</span>:         <span class="comment">// We first need to call finishConnect() before try to trigger a read(...) or write(...) as otherwise</span></span><br><span class="line"><span class="number">32</span>:         <span class="comment">// the NIO JDK channel implementation may throw a NotYetConnectedException.</span></span><br><span class="line"><span class="number">33</span>:         <span class="keyword">if</span> ((readyOps &amp; SelectionKey.OP_CONNECT) != <span class="number">0</span>) {</span><br><span class="line"><span class="number">34</span>:             <span class="comment">// ç§»é™¤å¯¹ OP_CONNECT æ„Ÿå…´è¶£</span></span><br><span class="line"><span class="number">35</span>:             <span class="comment">// remove OP_CONNECT as otherwise Selector.select(..) will always return without blocking</span></span><br><span class="line"><span class="number">36</span>:             <span class="comment">// See https://github.com/netty/netty/issues/924</span></span><br><span class="line"><span class="number">37</span>:             <span class="keyword">int</span> ops = k.interestOps();</span><br><span class="line"><span class="number">38</span>:             ops &amp;= ~SelectionKey.OP_CONNECT;</span><br><span class="line"><span class="number">39</span>:             k.interestOps(ops);</span><br><span class="line"><span class="number">40</span>:             <span class="comment">// å®Œæˆè¿æ¥</span></span><br><span class="line"><span class="number">41</span>:             unsafe.finishConnect();</span><br><span class="line"><span class="number">42</span>:         }</span><br><span class="line"><span class="number">43</span>: </span><br><span class="line"><span class="number">44</span>:         <span class="comment">// OP_WRITE äº‹ä»¶å°±ç»ª</span></span><br><span class="line"><span class="number">45</span>:         <span class="comment">// Process OP_WRITE first as we may be able to write some queued buffers and so free memory.</span></span><br><span class="line"><span class="number">46</span>:         <span class="keyword">if</span> ((readyOps &amp; SelectionKey.OP_WRITE) != <span class="number">0</span>) {</span><br><span class="line"><span class="number">47</span>:             <span class="comment">// Call forceFlush which will also take care of clear the OP_WRITE once there is nothing left to write</span></span><br><span class="line"><span class="number">48</span>:             <span class="comment">// å‘ Channel å†™å…¥æ•°æ®</span></span><br><span class="line"><span class="number">49</span>:             ch.unsafe().forceFlush();</span><br><span class="line"><span class="number">50</span>:         }</span><br><span class="line"><span class="number">51</span>: </span><br><span class="line"><span class="number">52</span>:         <span class="comment">// SelectionKey.OP_READ æˆ– SelectionKey.OP_ACCEPT å°±ç»ª</span></span><br><span class="line"><span class="number">53</span>:         <span class="comment">// readyOps == 0 æ˜¯å¯¹ JDK Bug çš„å¤„ç†ï¼Œé˜²æ­¢ç©ºçš„æ­»å¾ªç¯</span></span><br><span class="line"><span class="number">54</span>:         <span class="comment">// Also check for readOps of 0 to workaround possible JDK bug which may otherwise lead</span></span><br><span class="line"><span class="number">55</span>:         <span class="comment">// to a spin loop</span></span><br><span class="line"><span class="number">56</span>:         <span class="keyword">if</span> ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != <span class="number">0</span> || readyOps == <span class="number">0</span>) {</span><br><span class="line"><span class="number">57</span>:             unsafe.read();</span><br><span class="line"><span class="number">58</span>:         }</span><br><span class="line"><span class="number">59</span>:     } <span class="keyword">catch</span> (CancelledKeyException ignored) {</span><br><span class="line"><span class="number">60</span>:         <span class="comment">// å‘ç”Ÿå¼‚å¸¸ï¼Œå…³é—­ Channel</span></span><br><span class="line"><span class="number">61</span>:         unsafe.close(unsafe.voidPromise());</span><br><span class="line"><span class="number">62</span>:     }</span><br><span class="line"><span class="number">63</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 2 è‡³ 24 è¡Œï¼šå¦‚æœ SelectionKey æ˜¯ä¸åˆæ³•çš„ï¼Œåˆ™å…³é—­ Channel ã€‚</li>
<li>ç¬¬ 30 è‡³ 42 è¡Œï¼šå¦‚æœå¯¹ <code>OP_CONNECT</code> äº‹ä»¶å°±ç»ªï¼š<ul>
<li>ç¬¬ 34 è‡³ 39 è¡Œï¼šç§»é™¤å¯¹ <code>OP_CONNECT</code> çš„æ„Ÿå…´è¶£ï¼Œå³ä¸å†ç›‘å¬è¿æ¥äº‹ä»¶ã€‚</li>
<li>ã€é‡è¦ã€‘ç¬¬ 41 è¡Œï¼šè°ƒç”¨ <code>Unsafe#finishConnect()</code> æ–¹æ³•ï¼Œå®Œæˆè¿æ¥ã€‚åç»­çš„é€»è¾‘ï¼Œå¯¹åº” <a href="http://svip.iocoder.cn/Netty/bootstrap-2-client/">ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” å¯åŠ¨ï¼ˆäºŒï¼‰ä¹‹å®¢æˆ·ç«¯ã€‹</a> çš„ <a href="#">ã€Œ3.6.4 finishConnectã€</a> å°èŠ‚ã€‚</li>
</ul>
</li>
<li>ç¬¬ 44 è‡³ 50 è¡Œï¼šå¦‚æœå¯¹ <code>OP_WRITE</code> äº‹ä»¶å°±ç»ªï¼Œè°ƒç”¨ <code>Unsafe#forceFlush()</code> æ–¹æ³•ï¼Œå‘ Channel å†™å…¥æ•°æ®ã€‚åœ¨å®Œæˆå†™å…¥æ•°æ®åï¼Œä¼šç§»é™¤å¯¹ <code>OP_WRITE</code> çš„æ„Ÿå…´è¶£ã€‚æƒ³è¦æå‰äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥è‡ªå·±çœ‹ä¸‹ <code>AbstractNioByteChannel#clearOpWrite()</code> å’Œ <code>AbstractNioMessageChannel#doWrite(ChannelOutboundBuffer in)</code> æ–¹æ³•ã€‚</li>
<li>ç¬¬ 52 è‡³ 58 è¡Œï¼šå¦‚æœå¯¹ <code>OP_READ</code> æˆ– <code>OP_ACCEPT</code> äº‹ä»¶å°±ç»ªï¼šè°ƒç”¨ <code>Unsafe#read()</code> æ–¹æ³•ï¼Œå¤„ç†è¯»<strong>æˆ–è€…</strong>è€…æ¥å—å®¢æˆ·ç«¯è¿æ¥çš„äº‹ä»¶ã€‚</li>
</ul>
<h1 id="8-NioTask"><a href="#8-NioTask" class="headerlink" title="8. NioTask"></a>8. NioTask</h1><p><code>io.netty.channel.nio.NioTask</code> ï¼Œç”¨äºè‡ªå®šä¹‰ Nio äº‹ä»¶å¤„ç†<strong>æ¥å£</strong>ã€‚å¯¹äºæ¯ä¸ª Nio äº‹ä»¶ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªä»»åŠ¡( Task )ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NioTask</span>&lt;<span class="title">C</span> <span class="keyword">extends</span> <span class="title">SelectableChannel</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invoked when the {<span class="doctag">@link</span> SelectableChannel} has been selected by the {<span class="doctag">@link</span> Selector}.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">channelReady</span><span class="params">(C ch, SelectionKey key)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Invoked when the {<span class="doctag">@link</span> SelectionKey} of the specified {<span class="doctag">@link</span> SelectableChannel} has been cancelled and thus</span></span><br><span class="line"><span class="comment">     * this {<span class="doctag">@link</span> NioTask} will not be notified anymore.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cause the cause of the unregistration. {<span class="doctag">@code</span> null} if a user called {<span class="doctag">@link</span> SelectionKey#cancel()} or</span></span><br><span class="line"><span class="comment">     *              the event loop has been shut down.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">channelUnregistered</span><span class="params">(C ch, Throwable cause)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>#channelReady(C ch, SelectionKey key)</code> æ–¹æ³•ï¼Œå¤„ç† Channel IO å°±ç»ªçš„äº‹ä»¶ã€‚ç›¸å½“äºè¯´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç°è¯¥æ¥å£æ–¹æ³•ï¼Œå®ç° <a href="#">ã€Œ7.3 processSelectedKeyã€</a> çš„é€»è¾‘ã€‚</li>
<li><code>#channelUnregistered(C ch, Throwable cause)</code> æ–¹æ³•ï¼ŒChannel å–æ¶ˆæ³¨å†Œã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç°è¯¥æ¥å£æ–¹æ³•ï¼Œå…³é—­ Channel ã€‚</li>
</ul>
<p>ğŸ˜ˆ å®é™…ä¸Šï¼ŒNioTask åœ¨ Netty è‡ªèº«ä¸­å¹¶æœªæœ‰ç›¸å…³çš„å®ç°ç±»ï¼Œå¹¶ä¸”å’Œé—ªç”µä¾ æ²Ÿé€šäº†ä¸‹ï¼Œä»–åœ¨é¡¹ç›®ä¸­ï¼Œä¹Ÿå¹¶æœªä½¿ç”¨ã€‚æ‰€ä»¥å¯¹ NioTask ä¸æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥è·³è¿‡æœ¬å°èŠ‚ã€‚å¦å¤–ï¼ŒNioTask æ˜¯åœ¨ <a href="https://github.com/netty/netty/issues/681" rel="external nofollow noopener noreferrer" target="_blank">Allow a user to access the Selector of an EventLoop</a> ä¸­æœ‰ç›¸å…³çš„è®¨è®ºã€‚</p>
<h2 id="8-1-register"><a href="#8-1-register" class="headerlink" title="8.1 register"></a>8.1 register</h2><p><code>#register(final SelectableChannel ch, final int interestOps, final NioTask&lt;?&gt; task)</code> æ–¹æ³•ï¼Œæ³¨å†Œ Java NIO Channel ( ä¸ä¸€å®šéœ€è¦é€šè¿‡ Netty åˆ›å»ºçš„ Channel )åˆ° Selector ä¸Šï¼Œç›¸å½“äºè¯´ï¼Œä¹Ÿæ³¨å†Œåˆ°äº† EventLoop ä¸Šã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Registers an arbitrary {<span class="doctag">@link</span> SelectableChannel}, not necessarily created by Netty, to the {<span class="doctag">@link</span> Selector}</span></span><br><span class="line"><span class="comment"> * of this event loop.  Once the specified {<span class="doctag">@link</span> SelectableChannel} is registered, the specified {<span class="doctag">@code</span> task} will</span></span><br><span class="line"><span class="comment"> * be executed by this event loop when the {<span class="doctag">@link</span> SelectableChannel} is ready.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(<span class="keyword">final</span> SelectableChannel ch, <span class="keyword">final</span> <span class="keyword">int</span> interestOps, <span class="keyword">final</span> NioTask&lt;?&gt; task)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (ch == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"ch"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (interestOps == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"interestOps must be non-zero."</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> ((interestOps &amp; ~ch.validOps()) != <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                <span class="string">"invalid interestOps: "</span> + interestOps + <span class="string">"(validOps: "</span> + ch.validOps() + <span class="string">')'</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"task"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isShutdown()) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"event loop shut down"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &lt;1&gt;</span></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        ch.register(selector, interestOps, task);</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> EventLoopException(<span class="string">"failed to register a channel"</span>, e);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>SelectableChannel#register(Selector sel, int ops, Object att)</code> æ–¹æ³•ï¼Œæ³¨å†Œ Java NIO Channel åˆ° Selector ä¸Šã€‚è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>attachment</code> ä¸º NioTask å¯¹è±¡ï¼Œè€Œä¸æ˜¯ Netty Channel å¯¹è±¡ã€‚</li>
</ul>
<h2 id="8-2-invokeChannelUnregistered"><a href="#8-2-invokeChannelUnregistered" class="headerlink" title="8.2 invokeChannelUnregistered"></a>8.2 invokeChannelUnregistered</h2><p><code>#invokeChannelUnregistered(NioTask&lt;SelectableChannel&gt; task, SelectionKey k, Throwable cause)</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Channel å–æ¶ˆæ³¨å†Œã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">invokeChannelUnregistered</span><span class="params">(NioTask&lt;SelectableChannel&gt; task, SelectionKey k, Throwable cause)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        task.channelUnregistered(k.channel(), cause);</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        logger.warn(<span class="string">"Unexpected exception while running NioTask.channelUnregistered()"</span>, e);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨æ–¹æ³•å†…éƒ¨ï¼Œè°ƒç”¨ <code>NioTask#channelUnregistered()</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Channel å–æ¶ˆæ³¨å†Œã€‚</li>
</ul>
<h2 id="8-3-processSelectedKey"><a href="#8-3-processSelectedKey" class="headerlink" title="8.3 processSelectedKey"></a>8.3 processSelectedKey</h2><p><code>#processSelectedKey(SelectionKey k, NioTask&lt;SelectableChannel&gt; task)</code> æ–¹æ³•ï¼Œä½¿ç”¨ NioTask ï¼Œè‡ªå®šä¹‰å®ç° Channel å¤„ç† Channel IO å°±ç»ªçš„äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">processSelectedKey</span><span class="params">(SelectionKey k, NioTask&lt;SelectableChannel&gt; task)</span> </span>{</span><br><span class="line">    <span class="keyword">int</span> state = <span class="number">0</span>; <span class="comment">// æœªæ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// è°ƒç”¨ NioTask çš„ Channel å°±ç»ªäº‹ä»¶</span></span><br><span class="line">        task.channelReady(k.channel(), k);</span><br><span class="line">        state = <span class="number">1</span>; <span class="comment">// æ‰§è¡ŒæˆåŠŸ</span></span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        <span class="comment">// SelectionKey å–æ¶ˆ</span></span><br><span class="line">        k.cancel();</span><br><span class="line">        <span class="comment">// æ‰§è¡Œ Channel å–æ¶ˆæ³¨å†Œ</span></span><br><span class="line">        invokeChannelUnregistered(task, k, e);</span><br><span class="line">        state = <span class="number">2</span>; <span class="comment">// æ‰§è¡Œå¼‚å¸¸</span></span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        <span class="keyword">switch</span> (state) {</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            <span class="comment">// SelectionKey å–æ¶ˆ</span></span><br><span class="line">            k.cancel();</span><br><span class="line">            <span class="comment">// æ‰§è¡Œ Channel å–æ¶ˆæ³¨å†Œ</span></span><br><span class="line">            invokeChannelUnregistered(task, k, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            <span class="comment">// SelectionKey ä¸åˆæ³•ï¼Œåˆ™æ‰§è¡Œ Channel å–æ¶ˆæ³¨å†Œ</span></span><br><span class="line">            <span class="keyword">if</span> (!k.isValid()) { <span class="comment">// Cancelled by channelReady()</span></span><br><span class="line">                invokeChannelUnregistered(task, k, <span class="keyword">null</span>);</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸­æ–‡æ³¨é‡Šã€‚ä¸»è¦æ˜¯çœ‹æ‡‚ <code>state</code> æœ‰ 3 ç§æƒ…å†µï¼š<ul>
<li><code>0</code> ï¼šæœªæ‰§è¡Œã€‚</li>
<li><code>1</code> ï¼šæ‰§è¡ŒæˆåŠŸã€‚</li>
<li><code>2</code> ï¼šæ‰§è¡Œå¼‚å¸¸ã€‚</li>
</ul>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p> ç®€å•å°æ–‡ä¸€ç¯‡ï¼Œæ²¡ä»€ä¹ˆå¤ªå¤§éš¾åº¦çš„ä¸€ç¯‡ã€‚</p>
<p> å¦‚æœæœ‰ä¸ç†è§£çš„åœ°æ–¹ï¼Œä¹Ÿå¯ä»¥çœ‹çœ‹ä¸‹é¢çš„æ–‡ç« ï¼š</p>
<ul>
<li>é—ªç”µä¾  <a href="https://www.jianshu.com/p/467a9b41833e" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnetty æºç åˆ†æä¹‹æ­å¼€ reactor çº¿ç¨‹çš„é¢çº±ï¼ˆäºŒï¼‰ã€‹</a></li>
<li>Hypercube <a href="https://www.jianshu.com/p/d0f06b13e2fb" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æ Nettyï¼ˆå››ï¼‰â€“EventLoop-2ã€‹</a></li>
<li>æ¨æ­¦å…µ <a href="https://my.oschina.net/ywbrj042/blog/889748" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnetty æºç åˆ†æç³»åˆ— â€”â€” EventLoopã€‹</a></li>
<li>å å°ç‹¼ <a href="https://www.jianshu.com/p/9acf36f7e025" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty æºç åˆ†æä¹‹ NioEventLoopã€‹</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/EventLoop-5-EventLoop-handle-io-event/" data-id="ck4pl3fp100dpfgcfaw5kbjtj" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>