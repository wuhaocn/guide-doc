<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ ByteBufï¼ˆäºŒï¼‰æ ¸å¿ƒå­ç±»
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>åœ¨ <a href="http://svip.iocoder.cn/Netty/ByteBuf-1-1-ByteBuf-intro/">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” ByteBufï¼ˆä¸€ï¼‰ä¹‹ç®€ä»‹ã€‹</a> ä¸­ï¼Œæˆ‘ä»¬å¯¹ ByteBuf æœ‰äº†æ•´ä½“çš„è®¤è¯†ï¼Œç‰¹åˆ«æ˜¯æ ¸å¿ƒ API éƒ¨åˆ†ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°ï¼ŒByteBuf æœ‰éå¸¸éå¸¸éå¸¸å¤šçš„å­ç±»ï¼Œé‚£ä¹ˆæ€ä¹ˆåŠå‘¢ï¼Ÿå®é™…ä¸Šï¼Œ<strong>ByteBuf æœ‰ 8 ä¸ªæœ€æœ€æœ€æ ¸å¿ƒçš„å­ç±»å®ç°</strong>ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_08_04/01.png" title="æ ¸å¿ƒå­ç±»" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_08_04/01.png" alt="æ ¸å¿ƒå­ç±»"></a><span class="caption">æ ¸å¿ƒå­ç±»</span></p>
<p>ä¸€å…±å¯ä»¥æŒ‰ç…§ä¸‰ä¸ªç»´åº¦æ¥çœ‹è¿™ 8 ä¸ªæ ¸å¿ƒå­ç±»ï¼Œåˆšå¥½æ˜¯ 2 x 2 x 2 = 8 ï¼š</p>
<ul>
<li>æŒ‰ç…§<strong>å†…å­˜ç±»å‹</strong>åˆ†ç±»ï¼š<ul>
<li>â‘  å †å†…å­˜å­—èŠ‚ç¼“å†²åŒº( <strong>Heap</strong>ByteBuf )ï¼šåº•å±‚ä¸º JVM å †å†…çš„å­—èŠ‚æ•°ç»„ï¼Œå…¶ç‰¹ç‚¹æ˜¯ç”³è¯·å’Œé‡Šæ”¾æ•ˆç‡è¾ƒé«˜ã€‚ä½†æ˜¯å¦‚æœè¦è¿›è¡Œ Socket çš„ I/O è¯»å†™ï¼Œéœ€è¦é¢å¤–å¤šåšä¸€æ¬¡å†…å­˜å¤åˆ¶ï¼Œéœ€è¦å°†å †å†…å­˜å¯¹åº”çš„ç¼“å†²åŒºå¤åˆ¶åˆ°å†…æ ¸ Channel ä¸­ï¼Œæ€§èƒ½å¯èƒ½ä¼šæœ‰ä¸€å®šç¨‹åº¦çš„æŸè€—ã€‚</li>
<li>â‘¡ ç›´æ¥å†…å­˜å­—èŠ‚ç¼“å†²åŒº( <strong>Direct</strong>ByteBuf )ï¼šå †å¤–å†…å­˜ï¼Œä¸ºæ“ä½œç³»ç»Ÿå†…æ ¸ç©ºé—´çš„å­—èŠ‚æ•°ç»„ï¼Œå®ƒç”±æ“ä½œç³»ç»Ÿç›´æ¥ç®¡ç†å’Œæ“ä½œï¼Œå…¶ç”³è¯·å’Œé‡Šæ”¾çš„æ•ˆç‡ä¼šæ…¢äºå †ç¼“å†²åŒºã€‚ä½†æ˜¯å°†å®ƒå†™å…¥æˆ–è€…ä» SocketChannel ä¸­è¯»å–æ—¶ï¼Œä¼šå°‘ä¸€æ¬¡å†…å­˜å¤åˆ¶ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§æé«˜ I/O æ•ˆç‡ï¼Œå®ç°é›¶æ‹·è´ã€‚</li>
<li>å…³äºè¿™ä¸¤è€…çš„å¯¹æ¯”ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥å†çœ‹çœ‹ <a href="https://www.zhihu.com/question/60892134" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJava NIO direct buffer çš„ä¼˜åŠ¿åœ¨å“ªå„¿ï¼Ÿã€‹</a> å’Œ <a href="http://eyesmore.iteye.com/blog/1133335" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJAVA NIO ä¹‹ Direct Buffer ä¸ Heap Bufferçš„åŒºåˆ«ï¼Ÿã€‹</a></li>
</ul>
</li>
<li>æŒ‰ç…§ <strong>å¯¹è±¡æ± </strong> åˆ†ç±»ï¼š<ul>
<li>â‘  åŸºäºå¯¹è±¡æ± ( <strong>Pooled</strong>ByteBuf )ï¼šåŸºäºå¯¹è±¡æ± çš„ ByteBuf å¯ä»¥é‡ç”¨ ByteBuf ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒè‡ªå·±å†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ªå¯¹è±¡æ± ï¼Œå½“å¯¹è±¡é‡Šæ”¾åä¼šå½’è¿˜ç»™å¯¹è±¡æ± ï¼Œè¿™æ ·å°±å¯ä»¥å¾ªç¯åœ°åˆ©ç”¨åˆ›å»ºçš„ ByteBufï¼Œæå‡å†…å­˜çš„ä½¿ç”¨ç‡ï¼Œé™ä½ç”±äºé«˜è´Ÿè½½å¯¼è‡´çš„é¢‘ç¹ GCã€‚å½“éœ€è¦å¤§é‡ä¸”é¢‘ç¹åˆ›å»ºç¼“å†²åŒºæ—¶ï¼Œæ¨èä½¿ç”¨è¯¥ç±»ç¼“å†²åŒºã€‚ </li>
<li>â‘¡ ä¸ä½¿ç”¨å¯¹è±¡æ± ( <strong>Unpooled</strong>ByteBuf )ï¼šå¯¹è±¡æ± çš„ç®¡ç†å’Œç»´æŠ¤ä¼šæ¯”è¾ƒå›°éš¾ï¼Œæ‰€ä»¥åœ¨ä¸éœ€è¦åˆ›å»ºå¤§é‡ç¼“å†²åŒºå¯¹è±¡æ—¶ï¼Œæ¨èä½¿ç”¨æ­¤ç±»ç¼“å†²åŒºã€‚</li>
</ul>
</li>
<li>æŒ‰ç…§ <strong>Unsafe</strong> åˆ†ç±»ï¼š<ul>
<li>â‘  ä½¿ç”¨ Unsafe ï¼šåŸºäº Java <code>sun.misc.Unsafe.Unsafe</code> çš„ API ï¼Œç›´æ¥è®¿é—®å†…å­˜ä¸­çš„æ•°æ®ã€‚</li>
<li>â‘¡ ä¸ä½¿ç”¨ Unsafe ï¼š åŸºäº <strong>Heap</strong>ByteBuf å’Œ <strong>Direct</strong>ByteBuf çš„æ ‡å‡† API ï¼Œè¿›è¡Œè®¿é—®å¯¹åº”çš„æ•°æ®ã€‚</li>
<li>å…³äº Unsafe ï¼ŒJVM å¤§ä½¬ R å¤§åœ¨çŸ¥ä¹ä¸Šæœ‰ä¸ªå›ç­”ï¼š<a href="https://www.zhihu.com/question/29266773" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä¸ºä»€ä¹ˆ JUC ä¸­å¤§é‡ä½¿ç”¨äº† sun.misc.Unsafe è¿™ä¸ªç±»ï¼Œä½†å®˜æ–¹å´ä¸å»ºè®®å¼€å‘è€…ä½¿ç”¨ï¼Ÿã€‹</a> ã€‚å…³äºä¸ºä»€ä¹ˆ Unsafe çš„æ€§èƒ½ä¼šæ›´å¥½ï¼šâ€å…¶ä¸­ä¸€ç§æ˜¯å«Œ Java æ€§èƒ½ä¸å¤Ÿå¥½ï¼Œä¾‹å¦‚è¯´æ•°ç»„è®¿é—®çš„è¾¹ç•Œæ£€æŸ¥è¯­ä¹‰ï¼Œå«Œè¿™ä¸ªå¼€é”€å¤ªå¤§ï¼Œè§‰å¾—ç”¨ Unsafe ä¼šæ›´å¿«ï¼›â€ã€‚</li>
</ul>
</li>
</ul>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ PooledUnsafeDirectByteBuf ç±»å‹ã€‚æ‰€ä»¥ï¼Œé‡ç‚¹é‡ç‚¹é‡ç‚¹ï¼Œçœ‹ <a href="#">ã€Œ2.4 PooledUnsafeDirectByteBufã€</a> ã€‚</p>
<h1 id="2-PooledByteBuf"><a href="#2-PooledByteBuf" class="headerlink" title="2. PooledByteBuf"></a>2. PooledByteBuf</h1><p><code>io.netty.buffer.PooledByteBuf</code> ï¼Œç»§æ‰¿ AbstractReferenceCountedByteBuf æŠ½è±¡ç±»ï¼Œ<strong>å¯¹è±¡æ± åŒ–</strong>çš„ ByteBuf æŠ½è±¡åŸºç±»ï¼Œä¸ºåŸºäº<strong>å¯¹è±¡æ± </strong>çš„ ByteBuf å®ç°ç±»ï¼Œæä¾›å…¬ç”¨çš„æ–¹æ³•ã€‚</p>
<p>å…³äº <code>io.netty.util.AbstractReferenceCountedByteBuf</code> æŠ½è±¡ç±»ï¼Œå¯¹è±¡å¼•ç”¨è®¡æ•°å™¨æŠ½è±¡ç±»ã€‚æœ¬æ–‡æš‚æ—¶ä¸è§£æï¼Œæˆ‘ä»¬ä¼šåœ¨ <a href="http://svip.iocoder.cn/Netty/ByteBuf-1-3-ByteBuf-resource-leak-detector/">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ ByteBufï¼ˆä¸‰ï¼‰å†…å­˜æ³„éœ²æ£€æµ‹ã€‹</a> è¯¦ç»†è§£æã€‚</p>
<h2 id="2-1-å†…éƒ¨æ–¹æ³•"><a href="#2-1-å†…éƒ¨æ–¹æ³•" class="headerlink" title="2.1 å†…éƒ¨æ–¹æ³•"></a>2.1 å†…éƒ¨æ–¹æ³•</h2><h3 id="2-1-1-æ„é€ æ–¹æ³•"><a href="#2-1-1-æ„é€ æ–¹æ³•" class="headerlink" title="2.1.1 æ„é€ æ–¹æ³•"></a>2.1.1 æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Recycler å¤„ç†å™¨ï¼Œç”¨äºå›æ”¶å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Recycler.Handle&lt;PooledByteBuf&lt;T&gt;&gt; recyclerHandle;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Chunk å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> PoolChunk&lt;T&gt; chunk;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä» Chunk å¯¹è±¡ä¸­åˆ†é…çš„å†…å­˜å—æ‰€å¤„çš„ä½ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">long</span> handle;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å†…å­˜ç©ºé—´ã€‚å…·ä½“ä»€ä¹ˆæ ·çš„æ•°æ®ï¼Œé€šè¿‡å­ç±»è®¾ç½®æ³›å‹ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> T memory;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #memory} å¼€å§‹ä½ç½®</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #idx(int)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> offset;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®¹é‡</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #capacity()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">int</span> length;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å ç”¨ {<span class="doctag">@link</span> #memory} çš„å¤§å°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> maxLength;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TODO 1013 Chunk</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PoolThreadCache cache;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸´æ—¶ ByteBuff å¯¹è±¡</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #internalNioBuffer()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ByteBuffer tmpNioBuf;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ByteBuf åˆ†é…å™¨å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ByteBufAllocator allocator;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">PooledByteBuf</span><span class="params">(Recycler.Handle&lt;? extends PooledByteBuf&lt;T&gt;&gt; recyclerHandle, <span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">super</span>(maxCapacity);</span><br><span class="line">    <span class="keyword">this</span>.recyclerHandle = (Handle&lt;PooledByteBuf&lt;T&gt;&gt;) recyclerHandle;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>recyclerHandle</code> å±æ€§ï¼ŒRecycler å¤„ç†å™¨ï¼Œç”¨äºå›æ”¶<strong>å½“å‰</strong>å¯¹è±¡ã€‚</li>
<li><code>chunk</code> å±æ€§ï¼ŒPoolChunk å¯¹è±¡ã€‚åœ¨ Netty ä¸­ï¼Œä½¿ç”¨ Jemalloc ç®—æ³•ç®¡ç†å†…å­˜ï¼Œè€Œ Chunk æ˜¯é‡Œé¢çš„ä¸€ç§<strong>å†…å­˜å—</strong>ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ <code>memory</code> æ‰€å±çš„ PoolChunk å¯¹è±¡ã€‚<ul>
<li><code>handle</code> å±æ€§ï¼Œä» Chunk å¯¹è±¡ä¸­åˆ†é…çš„å†…å­˜å—æ‰€å¤„çš„ä½ç½®ã€‚å…·ä½“çš„ï¼Œèƒ–å‹åé¢ä»”ç»†çœ‹çœ‹ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-2-Jemalloc-chunk/">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆäºŒï¼‰PoolChunkã€‹</a> å’Œ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-3-Jemalloc-subpage/">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆä¸‰ï¼‰PoolSubpageã€‹</a> ã€‚</li>
<li><code>memory</code> å±æ€§ï¼Œå†…å­˜ç©ºé—´ã€‚å…·ä½“ä»€ä¹ˆæ ·çš„æ•°æ®ï¼Œé€šè¿‡å­ç±»è®¾ç½®æ³›å‹( <code>T</code> )ã€‚ä¾‹å¦‚ï¼š1) PooledDirectByteBuf å’Œ PooledUnsafeDirectByteBuf ä¸º <strong>ByteBuffer</strong> ï¼›2) PooledHeapByteBuf å’Œ PooledUnsafeHeapByteBuf ä¸º <code>byte[]</code> ã€‚<ul>
<li><code>offset</code> å±æ€§ï¼Œä½¿ç”¨ <code>memory</code> çš„å¼€å§‹ä½ç½®ã€‚</li>
<li><code>maxLength</code> å±æ€§ï¼Œ<strong>æœ€å¤§</strong>ä½¿ç”¨ <code>memory</code> çš„é•¿åº¦( å¤§å° )ã€‚</li>
<li><code>length</code> å±æ€§ï¼Œ<strong>ç›®å‰</strong>ä½¿ç”¨ <code>memory</code> çš„é•¿åº¦( å¤§å° )ã€‚</li>
<li>ğŸ˜ˆ å› ä¸º <code>memory</code> å±æ€§ï¼Œå¯ä»¥è¢«<strong>å¤šä¸ª</strong> ByteBuf ä½¿ç”¨ã€‚<strong>æ¯ä¸ª</strong> ByteBuf ä½¿ç”¨èŒƒå›´ä¸º <code>[offset, maxLength)</code> ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><code>cache</code> å±æ€§ï¼ŒTODO 1013 Chunk</li>
<li><code>tmpNioBuf</code> å±æ€§ï¼Œä¸´æ—¶ ByteBuff å¯¹è±¡ï¼Œé€šè¿‡ <code>#tmpNioBuf()</code> æ–¹æ³•ç”Ÿæˆã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.1.9 internalNioBufferã€</a> ã€‚ </li>
<li><code>allocator</code> å±æ€§ï¼ŒByteBuf åˆ†é…å™¨ã€‚</li>
</ul>
<h3 id="2-1-2-init0"><a href="#2-1-2-init0" class="headerlink" title="2.1.2 init0"></a>2.1.2 init0</h3><p><code>#init0(PoolChunk&lt;T&gt; chunk, long handle, int offset, int length, int maxLength, PoolThreadCache cache)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– PooledByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init0</span><span class="params">(PoolChunk&lt;T&gt; chunk, <span class="keyword">long</span> handle, <span class="keyword">int</span> offset, <span class="keyword">int</span> length, <span class="keyword">int</span> maxLength, PoolThreadCache cache)</span> </span>{</span><br><span class="line">    <span class="keyword">assert</span> handle &gt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">assert</span> chunk != <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// From PoolChunk å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">this</span>.chunk = chunk;</span><br><span class="line">    memory = chunk.memory;</span><br><span class="line">    allocator = chunk.arena.parent;</span><br><span class="line">    <span class="comment">// å…¶ä»–</span></span><br><span class="line">    <span class="keyword">this</span>.cache = cache;</span><br><span class="line">    <span class="keyword">this</span>.handle = handle;</span><br><span class="line">    <span class="keyword">this</span>.offset = offset;</span><br><span class="line">    <span class="keyword">this</span>.length = length;</span><br><span class="line">    <span class="keyword">this</span>.maxLength = maxLength;</span><br><span class="line">    tmpNioBuf = <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ä»”ç»†çš„èƒ–å‹ï¼Œå¯èƒ½ä¼šå‘ç°ï¼Œè¿™æ˜¯ä¸€ä¸ª <code>private</code> ç§æœ‰æ–¹æ³•ã€‚ç›®å‰å®ƒè¢«ä¸¤ä¸ªæ–¹æ³•è°ƒç”¨ï¼š</p>
<ul>
<li><p>â‘  <code>#init(PoolChunk&lt;T&gt; chunk, long handle, int offset, int length, int maxLength, PoolThreadCache cache)</code> æ–¹æ³•ï¼Œä¸€èˆ¬æ˜¯åŸºäº <strong>pooled</strong> çš„ PoolChunk å¯¹è±¡ï¼Œåˆå§‹åŒ– PooledByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(PoolChunk&lt;T&gt; chunk, <span class="keyword">long</span> handle, <span class="keyword">int</span> offset, <span class="keyword">int</span> length, <span class="keyword">int</span> maxLength, PoolThreadCache cache)</span> </span>{</span><br><span class="line">    init0(chunk, handle, offset, length, maxLength, cache);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>â‘¡ <code>#initUnpooled(PoolChunk&lt;T&gt; chunk, int length)</code> æ–¹æ³•ï¼ŒåŸºäº <strong>unPoolooled</strong> çš„ PoolChunk å¯¹è±¡ï¼Œåˆå§‹åŒ– PooledByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initUnpooled</span><span class="params">(PoolChunk&lt;T&gt; chunk, <span class="keyword">int</span> length)</span> </span>{</span><br><span class="line">    init0(chunk, <span class="number">0</span>, chunk.offset, length, length, <span class="keyword">null</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¾‹å¦‚è¯´ <strong>Huge</strong> å¤§å°çš„ PoolChunk å¯¹è±¡ã€‚</li>
<li>æ³¨æ„ï¼Œä¼ å…¥çš„ç»™ <code>#init0(...)</code> æ–¹æ³•çš„ <code>length</code> å’Œ <code>maxLength</code> æ–¹æ³•å‚æ•°ï¼Œ<strong>éƒ½æ˜¯</strong> <code>length</code> ã€‚</li>
</ul>
</li>
</ul>
<p>å¯èƒ½èƒ–å‹è¯»åˆ°æ­¤å¤„ä¼šä¸€è„¸æ‡µé€¼ã€‚å…¶å®ï¼Œè¿™æ˜¯å¾ˆæ­£å¸¸çš„ã€‚å¯ä»¥åœ¨çœ‹å®Œ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-2-Jemalloc-chunk/">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆäºŒï¼‰PoolChunkã€‹</a> åï¼Œåœ¨å›è¿‡å¤´æ¥ï¼Œç†è§£ç†è§£ã€‚</p>
<h3 id="2-1-3-reuse"><a href="#2-1-3-reuse" class="headerlink" title="2.1.3 reuse"></a>2.1.3 reuse</h3><p><code>#reuse(int maxCapacity)</code> æ–¹æ³•ï¼Œæ¯æ¬¡åœ¨é‡ç”¨ PooledByteBuf å¯¹è±¡æ—¶ï¼Œéœ€è¦è°ƒç”¨è¯¥æ–¹æ³•ï¼Œé‡ç½®å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Method must be called before reuse this {<span class="doctag">@link</span> PooledByteBufAllocator}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">reuse</span><span class="params">(<span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">    <span class="comment">// è®¾ç½®æœ€å¤§å®¹é‡</span></span><br><span class="line">    maxCapacity(maxCapacity);</span><br><span class="line">    <span class="comment">// è®¾ç½®å¼•ç”¨æ•°é‡ä¸º 0</span></span><br><span class="line">    setRefCnt(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// é‡ç½®è¯»å†™ç´¢å¼•ä¸º 0</span></span><br><span class="line">    setIndex0(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// é‡ç½®è¯»å†™æ ‡è®°ä½ä¸º 0</span></span><br><span class="line">    discardMarks();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥æ–¹æ³•åœ¨ <a href="#">ã€Œ2.1.2 init9ã€</a> <strong>ä¹‹å‰</strong>å°±è°ƒç”¨äº†ã€‚åœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œè¯¥æ–¹æ³•çš„è°ƒç”¨ã€‚</p>
<h3 id="2-1-4-capacity"><a href="#2-1-4-capacity" class="headerlink" title="2.1.4 capacity"></a>2.1.4 capacity</h3><p><code>#capacity()</code> æ–¹æ³•ï¼Œè·å¾—å®¹é‡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">capacity</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> length;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><strong>å½“å‰</strong>å®¹é‡çš„å€¼ä¸º <code>length</code> å±æ€§ã€‚<br>ä½†æ˜¯ï¼Œè¦æ³¨æ„çš„æ˜¯ï¼Œ<code>maxLength</code> å±æ€§ï¼Œ<strong>ä¸æ˜¯è¡¨ç¤ºæœ€å¤§å®¹é‡</strong>ã€‚<code>maxCapacity</code> å±æ€§ï¼Œæ‰æ˜¯çœŸæ­£è¡¨ç¤ºæœ€å¤§å®¹é‡ã€‚<br>é‚£ä¹ˆï¼Œ<code>maxLength</code> å±æ€§æœ‰ä»€ä¹ˆç”¨ï¼Ÿè¡¨ç¤º<strong>å ç”¨</strong> <code>memory</code> çš„æœ€å¤§å®¹é‡( è€Œä¸æ˜¯ PooledByteBuf å¯¹è±¡çš„æœ€å¤§å®¹é‡ )ã€‚åœ¨å†™å…¥æ•°æ®è¶…è¿‡ <code>maxLength</code> å®¹é‡æ—¶ï¼Œä¼šè¿›è¡Œæ‰©å®¹ï¼Œä½†æ˜¯å®¹é‡çš„ä¸Šé™ï¼Œä¸º <code>maxCapacity</code> ã€‚</p>
<hr>
<p><code>#capacity(int newCapacity)</code> æ–¹æ³•ï¼Œè°ƒæ•´å®¹é‡å¤§å°ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®æƒ…å†µï¼Œå¯èƒ½å¯¹ <code>memory</code> æ‰©å®¹æˆ–ç¼©å®¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ByteBuf <span class="title">capacity</span><span class="params">(<span class="keyword">int</span> newCapacity)</span> </span>{</span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// æ ¡éªŒæ–°çš„å®¹é‡ï¼Œä¸èƒ½è¶…è¿‡æœ€å¤§å®¹é‡</span></span><br><span class="line"> <span class="number">4</span>:     checkNewCapacity(newCapacity);</span><br><span class="line"> <span class="number">5</span>: </span><br><span class="line"> <span class="number">6</span>:     <span class="comment">// Chunk å†…å­˜ï¼Œéæ± åŒ–</span></span><br><span class="line"> <span class="number">7</span>:     <span class="comment">// If the request capacity does not require reallocation, just update the length of the memory.</span></span><br><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (chunk.unpooled) {</span><br><span class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (newCapacity == length) { <span class="comment">// ç›¸ç­‰ï¼Œæ— éœ€æ‰©å®¹ / ç¼©å®¹</span></span><br><span class="line"><span class="number">10</span>:             <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line"><span class="number">11</span>:         }</span><br><span class="line"><span class="number">12</span>:     <span class="comment">// Chunk å†…å­˜ï¼Œæ˜¯æ± åŒ–</span></span><br><span class="line"><span class="number">13</span>:     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">14</span>:         <span class="comment">// æ‰©å®¹</span></span><br><span class="line"><span class="number">15</span>:         <span class="keyword">if</span> (newCapacity &gt; length) {</span><br><span class="line"><span class="number">16</span>:             <span class="keyword">if</span> (newCapacity &lt;= maxLength) {</span><br><span class="line"><span class="number">17</span>:                 length = newCapacity;</span><br><span class="line"><span class="number">18</span>:                 <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line"><span class="number">19</span>:             }</span><br><span class="line"><span class="number">20</span>:         <span class="comment">// ç¼©å®¹</span></span><br><span class="line"><span class="number">21</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (newCapacity &lt; length) {</span><br><span class="line"><span class="number">22</span>:             <span class="comment">// å¤§äº maxLength çš„ä¸€åŠ</span></span><br><span class="line"><span class="number">23</span>:             <span class="keyword">if</span> (newCapacity &gt; maxLength &gt;&gt;&gt; <span class="number">1</span>) {</span><br><span class="line"><span class="number">24</span>:                 <span class="keyword">if</span> (maxLength &lt;= <span class="number">512</span>) {</span><br><span class="line"><span class="number">25</span>:                     <span class="comment">// å› ä¸º Netty SubPage æœ€å°æ˜¯ 16 ï¼Œå¦‚æœå°äºç­‰ 16 ï¼Œæ— æ³•ç¼©å®¹ã€‚</span></span><br><span class="line"><span class="number">26</span>:                     <span class="keyword">if</span> (newCapacity &gt; maxLength - <span class="number">16</span>) {</span><br><span class="line"><span class="number">27</span>:                         length = newCapacity;</span><br><span class="line"><span class="number">28</span>:                         <span class="comment">// è®¾ç½®è¯»å†™ç´¢å¼•ï¼Œé¿å…è¶…è¿‡æœ€å¤§å®¹é‡</span></span><br><span class="line"><span class="number">29</span>:                         setIndex(Math.min(readerIndex(), newCapacity), Math.min(writerIndex(), newCapacity));</span><br><span class="line"><span class="number">30</span>:                         <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line"><span class="number">31</span>:                     }</span><br><span class="line"><span class="number">32</span>:                 } <span class="keyword">else</span> { <span class="comment">// &gt; 512 (i.e. &gt;= 1024)</span></span><br><span class="line"><span class="number">33</span>:                     length = newCapacity;</span><br><span class="line"><span class="number">34</span>:                     <span class="comment">// è®¾ç½®è¯»å†™ç´¢å¼•ï¼Œé¿å…è¶…è¿‡æœ€å¤§å®¹é‡</span></span><br><span class="line"><span class="number">35</span>:                     setIndex(Math.min(readerIndex(), newCapacity), Math.min(writerIndex(), newCapacity));</span><br><span class="line"><span class="number">36</span>:                     <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line"><span class="number">37</span>:                 }</span><br><span class="line"><span class="number">38</span>:             }</span><br><span class="line"><span class="number">39</span>:         <span class="comment">// ç›¸ç­‰ï¼Œæ— éœ€æ‰©å®¹ / ç¼©å®¹</span></span><br><span class="line"><span class="number">40</span>:         } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">41</span>:             <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line"><span class="number">42</span>:         }</span><br><span class="line"><span class="number">43</span>:     }</span><br><span class="line"><span class="number">44</span>: </span><br><span class="line"><span class="number">45</span>:     <span class="comment">// é‡æ–°åˆ†é…æ–°çš„å†…å­˜ç©ºé—´ï¼Œå¹¶å°†æ•°æ®å¤åˆ¶åˆ°å…¶ä¸­ã€‚å¹¶ä¸”ï¼Œé‡Šæ”¾è€çš„å†…å­˜ç©ºé—´ã€‚</span></span><br><span class="line"><span class="number">46</span>:     <span class="comment">// Reallocation required.</span></span><br><span class="line"><span class="number">47</span>:     chunk.arena.reallocate(<span class="keyword">this</span>, newCapacity, <span class="keyword">true</span>);</span><br><span class="line"><span class="number">48</span>:     <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line"><span class="number">49</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ç¬¬ 4 è¡Œï¼šè°ƒç”¨ <code>AbstractByteBuf#checkNewCapacity(int newCapacity)</code> æ–¹æ³•ï¼Œæ ¡éªŒæ–°çš„å®¹é‡ï¼Œä¸èƒ½è¶…è¿‡æœ€å¤§å®¹é‡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">checkNewCapacity</span><span class="params">(<span class="keyword">int</span> newCapacity)</span> </span>{</span><br><span class="line">    ensureAccessible();</span><br><span class="line">    <span class="keyword">if</span> (newCapacity &lt; <span class="number">0</span> || newCapacity &gt; maxCapacity()) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"newCapacity: "</span> + newCapacity + <span class="string">" (expected: 0-"</span> + maxCapacity() + <span class="string">')'</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ç¬¬ 6 è‡³ 11 è¡Œï¼šå¯¹äºåŸºäº <strong>unPoolooled</strong> çš„ PoolChunk å¯¹è±¡ï¼Œé™¤éå®¹é‡ä¸å˜ï¼Œå¦åˆ™ä¼šæ‰©å®¹æˆ–ç¼©å®¹ï¼Œå³ã€ç¬¬ 47 è¡Œã€‘çš„ä»£ç ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿåœ¨ <code>#initUnpooled(PoolChunk&lt;T&gt; chunk, int length)</code> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œ<code>maxLength</code> å’Œ <code>length</code> æ˜¯ç›¸ç­‰çš„ï¼Œæ‰€ä»¥å¤§äºæˆ–å°äºæ—¶ï¼Œéœ€è¦è¿›è¡Œæ‰©å®¹æˆ–ç¼©å®¹ã€‚</p>
</li>
<li>ç¬¬ 13 è¡Œï¼šå¯¹äºåŸºäº <strong>poolooled</strong> çš„ PoolChunk å¯¹è±¡ï¼Œéœ€è¦æ ¹æ®æƒ…å†µï¼š<ul>
<li>ç¬¬ 39 è‡³ 42 è¡Œï¼šå®¹é‡æœªå˜ï¼Œä¸è¿›è¡Œæ‰©å®¹ã€‚ç±»ä¼¼ã€ç¬¬ 9 è‡³ 11 è¡Œã€‘çš„ä»£ç ã€‚</li>
<li>ç¬¬ 14 è‡³ 19 è¡Œï¼šæ–°å®¹é‡<strong>å¤§äº</strong>å½“å‰å®¹é‡ï¼Œä½†æ˜¯å°äº <code>memory</code> æœ€å¤§å®¹é‡ï¼Œä»…ä»…ä¿®æ”¹å½“å‰å®¹é‡ï¼Œæ— éœ€è¿›è¡Œæ‰©å®¹ã€‚å¦åˆ™ï¼Œç¬¬ã€ç¬¬ 47 è¡Œã€‘çš„ä»£ç ï¼Œè¿›è¡Œ<strong>æ‰©å®¹</strong>ã€‚</li>
<li>ç¬¬ 20 è‡³ 38 è¡Œï¼šæ–°å®¹é‡<strong>å°äº</strong>å½“å‰å®¹é‡ï¼Œä½†æ˜¯ä¸åˆ° <code>memory</code> æœ€å¤§å®¹é‡çš„<strong>ä¸€åŠ</strong>ï¼Œå› ä¸ºç¼©å®¹<strong>ç›¸å¯¹</strong>é‡Šæ”¾ä¸å¤šï¼Œæ— éœ€è¿›è¡Œç¼©å®¹ã€‚å¦åˆ™ï¼Œç¬¬ã€ç¬¬ 47 è¡Œã€‘çš„ä»£ç ï¼Œè¿›è¡Œ<strong>ç¼©å®¹</strong>ã€‚<ul>
<li>æ¯”è¾ƒç¥å¥‡çš„æ˜¯ã€ç¬¬ 26 è¡Œã€‘çš„ <code>newCapacity &gt; maxLength - 16</code> ä»£ç å—ã€‚ ç¬”è€…çš„ç†è§£æ˜¯ï¼ŒNetty SubPage <strong>æœ€å°</strong>æ˜¯ 16 B ï¼Œå¦‚æœå°äºç­‰ 16 ï¼Œæ— æ³•ç¼©å®¹ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 47 è¡Œï¼šè°ƒç”¨ <code>PoolArena#reallocate(PooledByteBuf&lt;T&gt; buf, int newCapacity, boolean freeOldMemory)</code> æ–¹æ³•ï¼Œ<strong>é‡æ–°åˆ†é…</strong>æ–°çš„å†…å­˜ç©ºé—´ï¼Œå¹¶å°†æ•°æ®<strong>å¤åˆ¶</strong>åˆ°å…¶ä¸­ã€‚å¹¶ä¸”ï¼Œ<strong>é‡Šæ”¾</strong>è€çš„å†…å­˜ç©ºé—´ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€ŠTODO 1013 Chunkã€‹</a> ä¸­ã€‚</li>
</ul>
<h3 id="2-1-5-order"><a href="#2-1-5-order" class="headerlink" title="2.1.5 order"></a>2.1.5 order</h3><p><code>#order()</code> æ–¹æ³•ï¼Œè¿”å›å­—èŠ‚åºä¸º <code>ByteOrder.BIG_ENDIAN</code> å¤§ç«¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ByteOrder <span class="title">order</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> ByteOrder.BIG_ENDIAN;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ç»Ÿä¸€<strong>å¤§ç«¯</strong>æ¨¡å¼ã€‚</p>
<blockquote>
<p>FROM <a href="https://www.bysocket.com/?p=615" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥æµ…å‡ºï¼š å¤§å°ç«¯æ¨¡å¼ã€‹</a></p>
<p>åœ¨ç½‘ç»œä¸Šä¼ è¾“æ•°æ®æ—¶ï¼Œç”±äºæ•°æ®ä¼ è¾“çš„ä¸¤ç«¯å¯¹åº”ä¸åŒçš„ç¡¬ä»¶å¹³å°ï¼Œé‡‡ç”¨çš„å­˜å‚¨å­—èŠ‚é¡ºåºå¯èƒ½ä¸ä¸€è‡´ã€‚æ‰€ä»¥åœ¨ TCP/IP åè®®è§„å®šäº†åœ¨ç½‘ç»œä¸Šå¿…é¡»é‡‡ç”¨ç½‘ç»œå­—èŠ‚é¡ºåºï¼Œä¹Ÿå°±æ˜¯å¤§ç«¯æ¨¡å¼ã€‚</p>
</blockquote>
<h3 id="2-1-6-unwrap"><a href="#2-1-6-unwrap" class="headerlink" title="2.1.6 unwrap"></a>2.1.6 unwrap</h3><p><code>#unwrap()</code> æ–¹æ³•ï¼Œè¿”å›ç©ºï¼Œå› ä¸ºæ²¡æœ‰è¢«è£…é¥°çš„ ByteBuffer å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ByteBuf <span class="title">unwrap</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-1-7-retainedSlice"><a href="#2-1-7-retainedSlice" class="headerlink" title="2.1.7 retainedSlice"></a>2.1.7 retainedSlice</h3><p><code>#retainedSlice()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ByteBuf <span class="title">retainedSlice</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> index = readerIndex();</span><br><span class="line">    <span class="keyword">return</span> retainedSlice(index, writerIndex() - index);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ByteBuf <span class="title">retainedSlice</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> PooledSlicedByteBuf.newInstance(<span class="keyword">this</span>, <span class="keyword">this</span>, index, length);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è°ƒç”¨ <code>PooledSlicedByteBuf#newInstance(AbstractByteBuf unwrapped, ByteBuf wrapped, int index, int length)</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>æ± åŒ–çš„</strong> PooledSlicedByteBuf å¯¹è±¡ã€‚</li>
<li>TODO 1016 æ´¾ç”Ÿç±»</li>
</ul>
<h3 id="2-1-8-retainedDuplicate"><a href="#2-1-8-retainedDuplicate" class="headerlink" title="2.1.8 retainedDuplicate"></a>2.1.8 retainedDuplicate</h3><p><code>#retainedDuplicate()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ByteBuf <span class="title">retainedDuplicate</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> PooledDuplicatedByteBuf.newInstance(<span class="keyword">this</span>, <span class="keyword">this</span>, readerIndex(), writerIndex());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è°ƒç”¨ <code>PooledSlicedByteBuf#newInstance(AbstractByteBuf unwrapped, ByteBuf wrapped, int readerIndex, int writerIndex)</code> æ–¹æ³•ï¼Œåˆ›å»º<strong>æ± åŒ–çš„</strong> PooledDuplicatedByteBuf.newInstance å¯¹è±¡ã€‚</li>
<li>TODO 1016 æ´¾ç”Ÿç±»</li>
</ul>
<h3 id="2-1-9-internalNioBuffer"><a href="#2-1-9-internalNioBuffer" class="headerlink" title="2.1.9 internalNioBuffer"></a>2.1.9 internalNioBuffer</h3><p><code>#internalNioBuffer()</code> æ–¹æ³•ï¼Œè·å¾—ä¸´æ—¶ ByteBuf å¯¹è±¡( <code>tmpNioBuf</code> ) ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> ByteBuffer <span class="title">internalNioBuffer</span><span class="params">()</span> </span>{</span><br><span class="line">    ByteBuffer tmpNioBuf = <span class="keyword">this</span>.tmpNioBuf;</span><br><span class="line">    <span class="comment">// ä¸ºç©ºï¼Œåˆ›å»ºä¸´æ—¶ ByteBuf å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (tmpNioBuf == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">this</span>.tmpNioBuf = tmpNioBuf = newInternalNioBuffer(memory);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> tmpNioBuf;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>å½“ <code>tmpNioBuf</code> å±æ€§ä¸ºç©ºæ—¶ï¼Œè°ƒç”¨ <code>#newInternalNioBuffer(T memory)</code> æ–¹æ³•ï¼Œåˆ›å»º ByteBuffer å¯¹è±¡ã€‚å› ä¸º <code>memory</code> çš„ç±»å‹ä¸ç¡®å®šï¼Œæ‰€ä»¥è¯¥æ–¹æ³•å®šä¹‰æˆ<strong>æŠ½è±¡æ–¹æ³•</strong>ï¼Œç”±å­ç±»å®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">newInternalNioBuffer</span><span class="params">(T memory)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<hr>
<p>ä¸ºä»€ä¹ˆè¦æœ‰ <code>tmpNioBuf</code> è¿™ä¸ªå±æ€§å‘¢ï¼Ÿä»¥ PooledDirectByteBuf ä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">setBytes</span><span class="params">(<span class="keyword">int</span> index, FileChannel in, <span class="keyword">long</span> position, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    checkIndex(index, length);</span><br><span class="line">    <span class="comment">// è·å¾—ä¸´æ—¶ ByteBuf å¯¹è±¡</span></span><br><span class="line">    ByteBuffer tmpBuf = internalNioBuffer();</span><br><span class="line">    index = idx(index);</span><br><span class="line">    tmpBuf.clear().position(index).limit(index + length);</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// å†™å…¥ä¸´æ—¶ ByteBuf å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> in.read(tmpBuf, position);</span><br><span class="line">    } <span class="keyword">catch</span> (ClosedChannelException ignored) {</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getBytes</span><span class="params">(<span class="keyword">int</span> index, FileChannel out, <span class="keyword">long</span> position, <span class="keyword">int</span> length, <span class="keyword">boolean</span> internal)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    checkIndex(index, length);</span><br><span class="line">    <span class="keyword">if</span> (length == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å¾—ä¸´æ—¶ ByteBuf å¯¹è±¡</span></span><br><span class="line">    ByteBuffer tmpBuf = internal ? internalNioBuffer() : memory.duplicate();</span><br><span class="line">    index = idx(index);</span><br><span class="line">    tmpBuf.clear().position(index).limit(index + length);</span><br><span class="line">    <span class="comment">// å†™å…¥åˆ° FileChannel ä¸­</span></span><br><span class="line">    <span class="keyword">return</span> out.write(tmpBuf, position);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-1-10-deallocate"><a href="#2-1-10-deallocate" class="headerlink" title="2.1.10 deallocate"></a>2.1.10 deallocate</h3><p><code>#deallocate()</code> æ–¹æ³•ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼Œè¿›è¡Œå†…å­˜å›æ”¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">deallocate</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (handle &gt;= <span class="number">0</span>) {</span><br><span class="line">        <span class="comment">// é‡ç½®å±æ€§</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> handle = <span class="keyword">this</span>.handle;</span><br><span class="line">        <span class="keyword">this</span>.handle = -<span class="number">1</span>;</span><br><span class="line">        memory = <span class="keyword">null</span>;</span><br><span class="line">        tmpNioBuf = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾å†…å­˜å› Arena ä¸­</span></span><br><span class="line">        chunk.arena.free(chunk, handle, maxLength, cache);</span><br><span class="line">        chunk = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// å›æ”¶å¯¹è±¡</span></span><br><span class="line">        recycle();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recycle</span><span class="params">()</span> </span>{</span><br><span class="line">    recyclerHandle.recycle(<span class="keyword">this</span>); <span class="comment">// å›æ”¶å¯¹è±¡</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-1-11-idx"><a href="#2-1-11-idx" class="headerlink" title="2.1.11 idx"></a>2.1.11 idx</h3><p><code>#idx(int index)</code> æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šä½ç½®åœ¨ <code>memory</code> å˜é‡ä¸­çš„ä½ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">idx</span><span class="params">(<span class="keyword">int</span> index)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> offset + index;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-2-PooledDirectByteBuf"><a href="#2-2-PooledDirectByteBuf" class="headerlink" title="2.2 PooledDirectByteBuf"></a>2.2 PooledDirectByteBuf</h2><p><code>io.netty.buffer.PooledDirectByteBuf</code> ï¼Œå®ç° PooledByteBuf æŠ½è±¡ç±»ï¼ŒåŸºäº <strong>ByteBuffer</strong> çš„<strong>å¯é‡ç”¨</strong> ByteBuf å®ç°ç±»ã€‚æ‰€ä»¥ï¼Œæ³›å‹ <code>T</code> ä¸º ByteBuffer ï¼Œå³ï¼š</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">final class PooledDirectByteBuf extends PooledByteBuf&lt;ByteBuffer&gt;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-2-1-æ„é€ æ–¹æ³•"><a href="#2-2-1-æ„é€ æ–¹æ³•" class="headerlink" title="2.2.1 æ„é€ æ–¹æ³•"></a>2.2.1 æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">PooledDirectByteBuf</span><span class="params">(Recycler.Handle&lt;PooledDirectByteBuf&gt; recyclerHandle, <span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">super</span>(recyclerHandle, maxCapacity);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-2-2-newInstance"><a href="#2-2-2-newInstance" class="headerlink" title="2.2.2 newInstance"></a>2.2.2 newInstance</h3><p><code>#newInstance(int maxCapacity)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œâ€œåˆ›å»ºâ€ PooledDirectByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Recycler å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Recycler&lt;PooledDirectByteBuf&gt; RECYCLER = <span class="keyword">new</span> Recycler&lt;PooledDirectByteBuf&gt;() {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> PooledDirectByteBuf <span class="title">newObject</span><span class="params">(Handle&lt;PooledDirectByteBuf&gt; handle)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> PooledDirectByteBuf(handle, <span class="number">0</span>); <span class="comment">// çœŸæ­£åˆ›å»º PooledDirectByteBuf å¯¹è±¡</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> PooledDirectByteBuf <span class="title">newInstance</span><span class="params">(<span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">    <span class="comment">// ä» Recycler çš„å¯¹è±¡æ± ä¸­è·å¾— PooledDirectByteBuf å¯¹è±¡</span></span><br><span class="line">    PooledDirectByteBuf buf = RECYCLER.get();</span><br><span class="line">    <span class="comment">// é‡ç½® PooledDirectByteBuf çš„å±æ€§</span></span><br><span class="line">    buf.reuse(maxCapacity);</span><br><span class="line">    <span class="keyword">return</span> buf;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-2-3-newInternalNioBuffer"><a href="#2-2-3-newInternalNioBuffer" class="headerlink" title="2.2.3 newInternalNioBuffer"></a>2.2.3 newInternalNioBuffer</h3><p><code>#newInternalNioBuffer(ByteBuffer memory)</code> æ–¹æ³•ï¼Œè·å¾—ä¸´æ—¶ ByteBuf å¯¹è±¡( <code>tmpNioBuf</code> ) ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ByteBuffer <span class="title">newInternalNioBuffer</span><span class="params">(ByteBuffer memory)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> memory.duplicate();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è°ƒç”¨ <code>ByteBuffer#duplicate()</code> æ–¹æ³•ï¼Œå¤åˆ¶ä¸€ä¸ª ByteBuffer å¯¹è±¡ï¼Œ<strong>å…±äº«</strong>é‡Œé¢çš„æ•°æ®ã€‚</li>
</ul>
<h3 id="2-2-4-isDirect"><a href="#2-2-4-isDirect" class="headerlink" title="2.2.4 isDirect"></a>2.2.4 isDirect</h3><p><code>#isDirect()</code> æ–¹æ³•ï¼Œè·å¾—å†…éƒ¨ç±»å‹æ˜¯å¦ä¸º Direct ï¼Œè¿”å› <code>true</code> ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDirect</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-2-5-è¯»å–-å†™å…¥æ“ä½œ"><a href="#2-2-5-è¯»å–-å†™å…¥æ“ä½œ" class="headerlink" title="2.2.5 è¯»å– / å†™å…¥æ“ä½œ"></a>2.2.5 è¯»å– / å†™å…¥æ“ä½œ</h3><p>è€æ ·å­ï¼Œæˆ‘ä»¬ä»¥ Int ç±»å‹ä¸ºä¾‹å­ï¼Œæ¥çœ‹çœ‹å®ƒçš„è¯»å–å’Œå†™å…¥æ“ä½œçš„å®ç°ä»£ç ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">_getInt</span><span class="params">(<span class="keyword">int</span> index)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> memory.getInt(idx(index));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">_setInt</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> value)</span> </span>{</span><br><span class="line">    memory.putInt(idx(index), value);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-2-6-copy"><a href="#2-2-6-copy" class="headerlink" title="2.2.6 copy"></a>2.2.6 copy</h3><p><code>#copy(int index, int length)</code> æ–¹æ³•ï¼Œå¤åˆ¶æŒ‡å®šèŒƒå›´çš„æ•°æ®åˆ°æ–°åˆ›å»ºçš„ Direct ByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">copy</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length)</span> </span>{</span><br><span class="line">    <span class="comment">// æ ¡éªŒç´¢å¼•</span></span><br><span class="line">    checkIndex(index, length);</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ª Direct ByteBuf å¯¹è±¡</span></span><br><span class="line">    ByteBuf copy = alloc().directBuffer(length, maxCapacity());</span><br><span class="line">    <span class="comment">// å†™å…¥æ•°æ®</span></span><br><span class="line">    copy.writeBytes(<span class="keyword">this</span>, index, length);</span><br><span class="line">    <span class="keyword">return</span> copy;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-2-7-è½¬æ¢-NIO-ByteBuffer-æ“ä½œ"><a href="#2-2-7-è½¬æ¢-NIO-ByteBuffer-æ“ä½œ" class="headerlink" title="2.2.7 è½¬æ¢ NIO ByteBuffer æ“ä½œ"></a>2.2.7 è½¬æ¢ NIO ByteBuffer æ“ä½œ</h3><h4 id="2-2-7-1-nioBufferCount"><a href="#2-2-7-1-nioBufferCount" class="headerlink" title="2.2.7.1 nioBufferCount"></a>2.2.7.1 nioBufferCount</h4><p><code>#nioBufferCount()</code> æ–¹æ³•ï¼Œè¿”å› ByteBuf åŒ…å« ByteBuffer æ•°é‡ä¸º <strong>1</strong> ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">nioBufferCount</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="2-2-7-2-nioBuffer"><a href="#2-2-7-2-nioBuffer" class="headerlink" title="2.2.7.2 nioBuffer"></a>2.2.7.2 nioBuffer</h4><p><code>#nioBuffer(int index, int length)</code> æ–¹æ³•ï¼Œè¿”å› ByteBuf <strong>æŒ‡å®šèŒƒå›´</strong>åŒ…å«çš„ ByteBuffer å¯¹è±¡( <strong>å…±äº«</strong> )ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuffer <span class="title">nioBuffer</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length)</span> </span>{</span><br><span class="line">    checkIndex(index, length);</span><br><span class="line">    <span class="comment">// memory ä¸­çš„å¼€å§‹ä½ç½®</span></span><br><span class="line">    index = idx(index);</span><br><span class="line">    <span class="comment">// duplicate å¤åˆ¶ä¸€ä¸ª ByteBuffer å¯¹è±¡ï¼Œå…±äº«æ•°æ®</span></span><br><span class="line">    <span class="comment">// position + limit è®¾ç½®ä½ç½®å’Œå¤§å°é™åˆ¶</span></span><br><span class="line">    <span class="comment">// slice åˆ›å»º [position, limit] å­ç¼“å†²åŒºï¼Œå…±äº«æ•°æ®</span></span><br><span class="line">    <span class="keyword">return</span> ((ByteBuffer) memory.duplicate().position(index).limit(index + length)).slice();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œçœ‹å…·ä½“æ³¨é‡Šã€‚</li>
</ul>
<h4 id="2-2-7-3-nioBuffers"><a href="#2-2-7-3-nioBuffers" class="headerlink" title="2.2.7.3 nioBuffers"></a>2.2.7.3 nioBuffers</h4><p><code>#nioBuffers(int index, int length)</code> æ–¹æ³•ï¼Œè¿”å› ByteBuf <strong>æŒ‡å®šèŒƒå›´</strong>å†…åŒ…å«çš„ ByteBuffer æ•°ç»„( <strong>å…±äº«</strong> )ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ByteBuffer[] nioBuffers(<span class="keyword">int</span> index, <span class="keyword">int</span> length) {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ByteBuffer[] { nioBuffer(index, length) };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨ <code>#nioBuffer(int index, int length)</code> æ–¹æ³•çš„åŸºç¡€ä¸Šï¼Œåˆ›å»ºå¤§å°ä¸º 1 çš„ ByteBuffer æ•°ç»„ã€‚</li>
</ul>
<h4 id="2-2-7-4-internalNioBuffer"><a href="#2-2-7-4-internalNioBuffer" class="headerlink" title="2.2.7.4 internalNioBuffer"></a>2.2.7.4 internalNioBuffer</h4><p><code>#internalNioBuffer(int index, int length)</code> æ–¹æ³•ï¼Œè¿”å› ByteBuf <strong>æŒ‡å®šèŒƒå›´</strong>å†…çš„ ByteBuffer å¯¹è±¡( <strong>å…±äº«</strong> )ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuffer <span class="title">internalNioBuffer</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length)</span> </span>{</span><br><span class="line">    checkIndex(index, length);</span><br><span class="line">    <span class="comment">// memory ä¸­çš„å¼€å§‹ä½ç½®</span></span><br><span class="line">    index = idx(index);</span><br><span class="line">    <span class="comment">// clear æ ‡è®°æ¸…ç©ºï¼ˆä¸ä¼šæ¸…ç†æ•°æ®ï¼‰</span></span><br><span class="line">    <span class="comment">// position + limit è®¾ç½®ä½ç½®å’Œå¤§å°é™åˆ¶</span></span><br><span class="line">    <span class="keyword">return</span> (ByteBuffer) internalNioBuffer().clear().position(index).limit(index + length);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œçœ‹å…·ä½“æ³¨é‡Šã€‚</li>
<li>å› ä¸ºæ˜¯åŸºäº <code>tmpNioBuf</code> å±æ€§å®ç°ï¼Œæ‰€ä»¥æ–¹æ³•åœ¨å‘½åä¸Šï¼Œä»¥ <code>"internal"</code> æ‰“å¤´ã€‚</li>
</ul>
<h3 id="2-2-8-Heap-ç›¸å…³æ–¹æ³•"><a href="#2-2-8-Heap-ç›¸å…³æ–¹æ³•" class="headerlink" title="2.2.8 Heap ç›¸å…³æ–¹æ³•"></a>2.2.8 Heap ç›¸å…³æ–¹æ³•</h3><p>ä¸æ”¯æŒ Heap ç›¸å…³æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasArray</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">byte</span>[] array() {</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"direct buffer"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">arrayOffset</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"direct buffer"</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-2-9-Unsafe-ç›¸å…³æ–¹æ³•"><a href="#2-2-9-Unsafe-ç›¸å…³æ–¹æ³•" class="headerlink" title="2.2.9 Unsafe ç›¸å…³æ–¹æ³•"></a>2.2.9 Unsafe ç›¸å…³æ–¹æ³•</h3><p>ä¸æ”¯æŒ Unsafe ç›¸å…³æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasMemoryAddress</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">memoryAddress</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-3-PooledHeapByteBuf"><a href="#2-3-PooledHeapByteBuf" class="headerlink" title="2.3 PooledHeapByteBuf"></a>2.3 PooledHeapByteBuf</h2><p><code>io.netty.buffer.PooledHeapByteBuf</code> ï¼Œå®ç° PooledByteBuf æŠ½è±¡ç±»ï¼ŒåŸºäº <strong>ByteBuffer</strong> çš„<strong>å¯é‡ç”¨</strong> ByteBuf å®ç°ç±»ã€‚æ‰€ä»¥ï¼Œæ³›å‹ <code>T</code> ä¸º <code>byte[]</code> ï¼Œå³ï¼š</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">class PooledHeapByteBuf extends PooledByteBuf&lt;byte[]&gt; {</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-3-1-æ„é€ æ–¹æ³•"><a href="#2-3-1-æ„é€ æ–¹æ³•" class="headerlink" title="2.3.1 æ„é€ æ–¹æ³•"></a>2.3.1 æ„é€ æ–¹æ³•</h3><p>å’Œ <a href="#">ã€Œ2.2.1 æ„é€ æ–¹æ³•ã€</a> ç›¸åŒã€‚</p>
<h3 id="2-3-2-newInstance"><a href="#2-3-2-newInstance" class="headerlink" title="2.3.2 newInstance"></a>2.3.2 newInstance</h3><p>å’Œ <a href="#">ã€Œ2.2.2 newInstanceã€</a> ç›¸åŒã€‚</p>
<h3 id="2-3-3-newInternalNioBuffer"><a href="#2-3-3-newInternalNioBuffer" class="headerlink" title="2.3.3 newInternalNioBuffer"></a>2.3.3 newInternalNioBuffer</h3><p><code>#newInternalNioBuffer(byte[] memory)</code> æ–¹æ³•ï¼Œè·å¾—ä¸´æ—¶ ByteBuf å¯¹è±¡( <code>tmpNioBuf</code> ) ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> ByteBuffer <span class="title">newInternalNioBuffer</span><span class="params">(<span class="keyword">byte</span>[] memory)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> ByteBuffer.wrap(memory);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è°ƒç”¨ <code>ByteBuffer#wrap(byte[] array)</code> æ–¹æ³•ï¼Œåˆ›å»º ByteBuffer å¯¹è±¡ã€‚æ³¨æ„ï¼Œè¿”å›çš„æ˜¯ HeapByteBuffer å¯¹è±¡ã€‚</li>
</ul>
<h3 id="2-3-4-isDirect"><a href="#2-3-4-isDirect" class="headerlink" title="2.3.4 isDirect"></a>2.3.4 isDirect</h3><p><code>#isDirect()</code> æ–¹æ³•ï¼Œè·å¾—å†…éƒ¨ç±»å‹æ˜¯å¦ä¸º Direct ï¼Œè¿”å› <code>false</code> ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDirect</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-3-5-è¯»å–-å†™å…¥æ“ä½œ"><a href="#2-3-5-è¯»å–-å†™å…¥æ“ä½œ" class="headerlink" title="2.3.5 è¯»å– / å†™å…¥æ“ä½œ"></a>2.3.5 è¯»å– / å†™å…¥æ“ä½œ</h3><p>è€æ ·å­ï¼Œæˆ‘ä»¬ä»¥ Int ç±»å‹ä¸ºä¾‹å­ï¼Œæ¥çœ‹çœ‹å®ƒçš„è¯»å–å’Œå†™å…¥æ“ä½œçš„å®ç°ä»£ç ã€‚</p>
<p>â‘  <strong>è¯»å–</strong>æ“ä½œï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">_getInt</span><span class="params">(<span class="keyword">int</span> index)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> HeapByteBufUtil.getInt(memory, idx(index));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// HeapByteBufUtil.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">byte</span>[] memory, <span class="keyword">int</span> index)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span>  (memory[index]     &amp; <span class="number">0xff</span>) &lt;&lt; <span class="number">24</span> |</span><br><span class="line">            (memory[index + <span class="number">1</span>] &amp; <span class="number">0xff</span>) &lt;&lt; <span class="number">16</span> |</span><br><span class="line">            (memory[index + <span class="number">2</span>] &amp; <span class="number">0xff</span>) &lt;&lt;  <span class="number">8</span> |</span><br><span class="line">            memory[index + <span class="number">3</span>] &amp; <span class="number">0xff</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>â‘¡ <strong>å†™å…¥</strong>æ“ä½œï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">_setInt</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span>   value)</span> </span>{</span><br><span class="line">    HeapByteBufUtil.setInt(memory, idx(index), value);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// HeapByteBufUtil.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setInt</span><span class="params">(<span class="keyword">byte</span>[] memory, <span class="keyword">int</span> index, <span class="keyword">int</span> value)</span> </span>{</span><br><span class="line">    memory[index]     = (<span class="keyword">byte</span>) (value &gt;&gt;&gt; <span class="number">24</span>);</span><br><span class="line">    memory[index + <span class="number">1</span>] = (<span class="keyword">byte</span>) (value &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">    memory[index + <span class="number">2</span>] = (<span class="keyword">byte</span>) (value &gt;&gt;&gt; <span class="number">8</span>);</span><br><span class="line">    memory[index + <span class="number">3</span>] = (<span class="keyword">byte</span>) value;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-3-6-copy"><a href="#2-3-6-copy" class="headerlink" title="2.3.6 copy"></a>2.3.6 copy</h3><p><code>#copy(int index, int length)</code> æ–¹æ³•ï¼Œå¤åˆ¶æŒ‡å®šèŒƒå›´çš„æ•°æ®åˆ°æ–°åˆ›å»ºçš„ Heap ByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">copy</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length)</span> </span>{</span><br><span class="line">    <span class="comment">// æ ¡éªŒç´¢å¼•</span></span><br><span class="line">    checkIndex(index, length);</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ª Heap ByteBuf å¯¹è±¡</span></span><br><span class="line">    ByteBuf copy = alloc().heapBuffer(length, maxCapacity());</span><br><span class="line">    <span class="comment">// å†™å…¥æ•°æ®</span></span><br><span class="line">    copy.writeBytes(<span class="keyword">this</span>, index, length);</span><br><span class="line">    <span class="keyword">return</span> copy;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>å’Œ PooledDirectByteBuf <a href="#">ã€Œ2.2.6 copyã€</a> çš„å·®å¼‚åœ¨äºï¼Œåˆ›å»ºçš„æ˜¯ <strong>Heap</strong> ByteBuf å¯¹è±¡ã€‚</p>
<h3 id="2-3-7-è½¬æ¢-NIO-ByteBuffer-æ“ä½œ"><a href="#2-3-7-è½¬æ¢-NIO-ByteBuffer-æ“ä½œ" class="headerlink" title="2.3.7 è½¬æ¢ NIO ByteBuffer æ“ä½œ"></a>2.3.7 è½¬æ¢ NIO ByteBuffer æ“ä½œ</h3><h4 id="2-3-7-1-nioBufferCount"><a href="#2-3-7-1-nioBufferCount" class="headerlink" title="2.3.7.1 nioBufferCount"></a>2.3.7.1 nioBufferCount</h4><p>å’Œ <a href="#">ã€Œ2.2.7.1 nioBufferCountã€</a> ä¸€è‡´ã€‚</p>
<h4 id="2-3-7-2-nioBuffer"><a href="#2-3-7-2-nioBuffer" class="headerlink" title="2.3.7.2 nioBuffer"></a>2.3.7.2 nioBuffer</h4><p><code>#nioBuffer(int index, int length)</code> æ–¹æ³•ï¼Œè¿”å› ByteBuf <strong>æŒ‡å®šèŒƒå›´</strong>åŒ…å«çš„ ByteBuffer å¯¹è±¡( <strong>å…±äº«</strong> )ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ByteBuffer <span class="title">nioBuffer</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length)</span> </span>{</span><br><span class="line">    checkIndex(index, length);</span><br><span class="line">    <span class="comment">// memory ä¸­çš„å¼€å§‹ä½ç½®</span></span><br><span class="line">    index = idx(index);</span><br><span class="line">    <span class="comment">// åˆ›å»º ByteBuffer å¯¹è±¡</span></span><br><span class="line">    ByteBuffer buf =  ByteBuffer.wrap(memory, index, length);</span><br><span class="line">    <span class="comment">// slice åˆ›å»º [position, limit] å­ç¼“å†²åŒº</span></span><br><span class="line">    <span class="keyword">return</span> buf.slice();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œçœ‹å…·ä½“æ³¨é‡Šã€‚</li>
</ul>
<h4 id="2-3-7-3-nioBuffers"><a href="#2-3-7-3-nioBuffers" class="headerlink" title="2.3.7.3 nioBuffers"></a>2.3.7.3 nioBuffers</h4><p>å’Œ <a href="#">ã€Œ2.2.7.3 nioBuffersã€</a> ä¸€è‡´ã€‚</p>
<h4 id="2-3-7-4-internalNioBuffer"><a href="#2-3-7-4-internalNioBuffer" class="headerlink" title="2.3.7.4 internalNioBuffer"></a>2.3.7.4 internalNioBuffer</h4><p>å’Œ <a href="#">ã€Œ2.2.7.4 nioBuffersã€</a> ä¸€è‡´ã€‚</p>
<h3 id="2-3-8-Heap-ç›¸å…³æ–¹æ³•"><a href="#2-3-8-Heap-ç›¸å…³æ–¹æ³•" class="headerlink" title="2.3.8 Heap ç›¸å…³æ–¹æ³•"></a>2.3.8 Heap ç›¸å…³æ–¹æ³•</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasArray</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] array() {</span><br><span class="line">    ensureAccessible();</span><br><span class="line">    <span class="keyword">return</span> memory;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">arrayOffset</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> offset;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-3-8-Unsafe-ç›¸å…³æ–¹æ³•"><a href="#2-3-8-Unsafe-ç›¸å…³æ–¹æ³•" class="headerlink" title="2.3.8 Unsafe ç›¸å…³æ–¹æ³•"></a>2.3.8 Unsafe ç›¸å…³æ–¹æ³•</h3><p>å’Œ <a href="#">ã€Œ2.2.9 Unsafe ç›¸å…³æ–¹æ³•ã€</a> ä¸€è‡´ã€‚</p>
<h2 id="2-4-PooledUnsafeDirectByteBuf"><a href="#2-4-PooledUnsafeDirectByteBuf" class="headerlink" title="2.4 PooledUnsafeDirectByteBuf"></a>2.4 PooledUnsafeDirectByteBuf</h2><blockquote>
<p>è€è‰¿è‰¿ï¼šå®ƒæ˜¯ <a href="#">ã€Œ2.2 PooledDirectByteBufã€</a> å¯¹åº”çš„åŸºäº Unsafe ç‰ˆæœ¬çš„å®ç°ç±»ã€‚</p>
</blockquote>
<p><code>io.netty.buffer.PooledUnsafeDirectByteBuf</code> ï¼Œå®ç° PooledByteBuf æŠ½è±¡ç±»ï¼ŒåŸºäº <strong>ByteBuffer</strong> + <strong>Unsafe</strong> çš„<strong>å¯é‡ç”¨</strong> ByteBuf å®ç°ç±»ã€‚æ‰€ä»¥ï¼Œæ³›å‹ <code>T</code> ä¸º <code>ByteBuffer</code> ï¼Œå³ï¼š</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">final class PooledUnsafeDirectByteBuf extends PooledByteBuf&lt;ByteBuffer&gt;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-4-1-æ„é€ æ–¹æ³•"><a href="#2-4-1-æ„é€ æ–¹æ³•" class="headerlink" title="2.4.1 æ„é€ æ–¹æ³•"></a>2.4.1 æ„é€ æ–¹æ³•</h3><p>å’Œ <a href="#">ã€Œ2.2.1 æ„é€ æ–¹æ³•ã€</a> ç›¸åŒã€‚</p>
<h3 id="2-4-2-newInstance"><a href="#2-4-2-newInstance" class="headerlink" title="2.4.2 newInstance"></a>2.4.2 newInstance</h3><p>å’Œ <a href="#">ã€Œ2.2.2 newInstanceã€</a> ç›¸åŒã€‚</p>
<h3 id="2-4-3-åˆå§‹åŒ–"><a href="#2-4-3-åˆå§‹åŒ–" class="headerlink" title="2.4.3 åˆå§‹åŒ–"></a>2.4.3 åˆå§‹åŒ–</h3><p>PooledUnsafeDirectByteBuf é‡å†™äº†åˆå§‹åŒ–ç›¸å…³çš„æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(PoolChunk&lt;ByteBuffer&gt; chunk, <span class="keyword">long</span> handle, <span class="keyword">int</span> offset, <span class="keyword">int</span> length, <span class="keyword">int</span> maxLength,</span></span></span><br><span class="line"><span class="function"><span class="params">          PoolThreadCache cache)</span> </span>{</span><br><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶åˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">super</span>.init(chunk, handle, offset, length, maxLength, cache);</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å†…å­˜åœ°å€</span></span><br><span class="line">    initMemoryAddress(); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">initUnpooled</span><span class="params">(PoolChunk&lt;ByteBuffer&gt; chunk, <span class="keyword">int</span> length)</span> </span>{</span><br><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶åˆå§‹åŒ–æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">super</span>.initUnpooled(chunk, length);</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å†…å­˜åœ°å€</span></span><br><span class="line">    initMemoryAddress(); <span class="comment">// &lt;2&gt;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>åœ¨ <code>&lt;1&gt;</code> å¤„ï¼Œå¢åŠ è°ƒç”¨ <code>#initMemoryAddress()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–å†…å­˜åœ°å€ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å†…å­˜åœ°å€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> memoryAddress;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initMemoryAddress</span><span class="params">()</span> </span>{</span><br><span class="line">    memoryAddress = PlatformDependent.directBufferAddress(memory) + offset; <span class="comment">// &lt;2&gt;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>PlatformDependent#directBufferAddress(ByteBuffer buffer)</code> æ–¹æ³•ï¼Œè·å¾— ByteBuffer å¯¹è±¡çš„èµ·å§‹å†…å­˜åœ°å€ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// PlatformDependent.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">directBufferAddress</span><span class="params">(ByteBuffer buffer)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> PlatformDependent0.directBufferAddress(buffer);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// PlatformDependent0.java</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> Unsafe UNSAFE;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">directBufferAddress</span><span class="params">(ByteBuffer buffer)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> getLong(buffer, ADDRESS_FIELD_OFFSET);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getLong</span><span class="params">(Object object, <span class="keyword">long</span> fieldOffset)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> UNSAFE.getLong(object, fieldOffset);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¯¹äº Unsafe ç±»ä¸ç†Ÿæ‚‰çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ <a href="https://blog.csdn.net/zhxdick/article/details/52003123" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJava Unsafe ç±»ã€‹</a></li>
</ul>
</li>
<li><p>æ³¨æ„ï¼Œ<code>&lt;2&gt;</code> å¤„çš„ä»£ç ï¼Œå·²ç»å°† <code>offset</code> æ·»åŠ åˆ° <code>memoryAddress</code> ä¸­ã€‚æ‰€ä»¥åœ¨ <code>#addr(int index)</code> æ–¹æ³•ä¸­ï¼Œæ±‚æŒ‡å®šä½ç½®( <code>index</code> ) åœ¨å†…å­˜åœ°å€çš„é¡ºåºï¼Œä¸ç”¨å†æ·»åŠ ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">addr</span><span class="params">(<span class="keyword">int</span> index)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> memoryAddress + index;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>x</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="2-4-4-newInternalNioBuffer"><a href="#2-4-4-newInternalNioBuffer" class="headerlink" title="2.4.4 newInternalNioBuffer"></a>2.4.4 newInternalNioBuffer</h3><p>å’Œ <a href="#">ã€Œ2.2.3 newInternalNioBufferã€</a> ç›¸åŒã€‚</p>
<h3 id="2-4-5-isDirect"><a href="#2-4-5-isDirect" class="headerlink" title="2.4.5 isDirect"></a>2.4.5 isDirect</h3><p>å’Œ <a href="#">ã€Œ2.2.4 isDirectã€</a> ç›¸åŒã€‚</p>
<h3 id="2-4-6-è¯»å–-å†™å…¥æ“ä½œ"><a href="#2-4-6-è¯»å–-å†™å…¥æ“ä½œ" class="headerlink" title="2.4.6 è¯»å– / å†™å…¥æ“ä½œ"></a>2.4.6 è¯»å– / å†™å…¥æ“ä½œ</h3><p>è€æ ·å­ï¼Œæˆ‘ä»¬ä»¥ Int ç±»å‹ä¸ºä¾‹å­ï¼Œæ¥çœ‹çœ‹å®ƒçš„è¯»å–å’Œå†™å…¥æ“ä½œçš„å®ç°ä»£ç ã€‚</p>
<p>â‘  <strong>è¯»å–</strong>æ“ä½œï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">_getInt</span><span class="params">(<span class="keyword">int</span> index)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> UnsafeByteBufUtil.getInt(addr(index));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// UnsafeByteBufUtil.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">long</span> address)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (UNALIGNED) {</span><br><span class="line">        <span class="keyword">int</span> v = PlatformDependent.getInt(address);</span><br><span class="line">        <span class="keyword">return</span> BIG_ENDIAN_NATIVE_ORDER ? v : Integer.reverseBytes(v);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> PlatformDependent.getByte(address) &lt;&lt; <span class="number">24</span> |</span><br><span class="line">           (PlatformDependent.getByte(address + <span class="number">1</span>) &amp; <span class="number">0xff</span>) &lt;&lt; <span class="number">16</span> |</span><br><span class="line">           (PlatformDependent.getByte(address + <span class="number">2</span>) &amp; <span class="number">0xff</span>) &lt;&lt;  <span class="number">8</span> |</span><br><span class="line">           PlatformDependent.getByte(address + <span class="number">3</span>)  &amp; <span class="number">0xff</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// PlatformDependent.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">long</span> address)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> PlatformDependent0.getInt(address);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// PlatformDependent0.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">long</span> address)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> UNSAFE.getInt(address);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>â‘¡ <strong>å†™å…¥</strong>æ“ä½œï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">_setInt</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> value)</span> </span>{</span><br><span class="line">    UnsafeByteBufUtil.setInt(addr(index), value);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// UnsafeByteBufUtil.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setInt</span><span class="params">(<span class="keyword">long</span> address, <span class="keyword">int</span> value)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (UNALIGNED) {</span><br><span class="line">        PlatformDependent.putInt(address, BIG_ENDIAN_NATIVE_ORDER ? value : Integer.reverseBytes(value));</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        PlatformDependent.putByte(address, (<span class="keyword">byte</span>) (value &gt;&gt;&gt; <span class="number">24</span>));</span><br><span class="line">        PlatformDependent.putByte(address + <span class="number">1</span>, (<span class="keyword">byte</span>) (value &gt;&gt;&gt; <span class="number">16</span>));</span><br><span class="line">        PlatformDependent.putByte(address + <span class="number">2</span>, (<span class="keyword">byte</span>) (value &gt;&gt;&gt; <span class="number">8</span>));</span><br><span class="line">        PlatformDependent.putByte(address + <span class="number">3</span>, (<span class="keyword">byte</span>) value);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// PlatformDependent.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putInt</span><span class="params">(<span class="keyword">long</span> address, <span class="keyword">int</span> value)</span> </span>{</span><br><span class="line">    PlatformDependent0.putInt(address, value);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// PlatformDependent0.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putInt</span><span class="params">(<span class="keyword">long</span> address, <span class="keyword">int</span> value)</span> </span>{</span><br><span class="line">    UNSAFE.putInt(address, value);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-4-7-copy"><a href="#2-4-7-copy" class="headerlink" title="2.4.7 copy"></a>2.4.7 copy</h3><p><code>#copy(int index, int length)</code> æ–¹æ³•ï¼Œå¤åˆ¶æŒ‡å®šèŒƒå›´çš„æ•°æ®åˆ°æ–°åˆ›å»ºçš„ Direct ByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">copy</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> UnsafeByteBufUtil.copy(<span class="keyword">this</span>, addr(index), index, length);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// UnsafeByteBufUtil.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> ByteBuf <span class="title">copy</span><span class="params">(AbstractByteBuf buf, <span class="keyword">long</span> addr, <span class="keyword">int</span> index, <span class="keyword">int</span> length)</span> </span>{</span><br><span class="line">    buf.checkIndex(index, length);</span><br><span class="line">    <span class="comment">// åˆ›å»º Direct ByteBuffer å¯¹è±¡</span></span><br><span class="line">    ByteBuf copy = buf.alloc().directBuffer(length, buf.maxCapacity());</span><br><span class="line">    <span class="keyword">if</span> (length != <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">if</span> (copy.hasMemoryAddress()) {</span><br><span class="line">            <span class="comment">// ä½¿ç”¨ Unsafe æ“ä½œæ¥å¤åˆ¶</span></span><br><span class="line">            PlatformDependent.copyMemory(addr, copy.memoryAddress(), length);</span><br><span class="line">            copy.setIndex(<span class="number">0</span>, length);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            copy.writeBytes(buf, index, length);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> copy;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// PlatformDependent.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyMemory</span><span class="params">(<span class="keyword">long</span> srcAddr, <span class="keyword">long</span> dstAddr, <span class="keyword">long</span> length)</span> </span>{</span><br><span class="line">    PlatformDependent0.copyMemory(srcAddr, dstAddr, length);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// PlatformDependent0.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">copyMemory</span><span class="params">(<span class="keyword">long</span> srcAddr, <span class="keyword">long</span> dstAddr, <span class="keyword">long</span> length)</span> </span>{</span><br><span class="line">    <span class="comment">//UNSAFE.copyMemory(srcAddr, dstAddr, length);</span></span><br><span class="line">    <span class="keyword">while</span> (length &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">long</span> size = Math.min(length, UNSAFE_COPY_THRESHOLD);</span><br><span class="line">        UNSAFE.copyMemory(srcAddr, dstAddr, size);</span><br><span class="line">        length -= size;</span><br><span class="line">        srcAddr += size;</span><br><span class="line">        dstAddr += size;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-4-8-è½¬æ¢-NIO-ByteBuffer-æ“ä½œ"><a href="#2-4-8-è½¬æ¢-NIO-ByteBuffer-æ“ä½œ" class="headerlink" title="2.4.8 è½¬æ¢ NIO ByteBuffer æ“ä½œ"></a>2.4.8 è½¬æ¢ NIO ByteBuffer æ“ä½œ</h3><h4 id="2-4-8-1-nioBufferCount"><a href="#2-4-8-1-nioBufferCount" class="headerlink" title="2.4.8.1 nioBufferCount"></a>2.4.8.1 nioBufferCount</h4><p>å’Œ <a href="#">ã€Œ2.2.7.1 nioBufferCountã€</a> ä¸€è‡´ã€‚</p>
<h4 id="2-4-8-2-nioBuffer"><a href="#2-4-8-2-nioBuffer" class="headerlink" title="2.4.8.2 nioBuffer"></a>2.4.8.2 nioBuffer</h4><p>å’Œ <a href="#">ã€Œ2.2.7.2 nioBufferã€</a> ä¸€è‡´ã€‚</p>
<h4 id="2-4-8-3-nioBuffers"><a href="#2-4-8-3-nioBuffers" class="headerlink" title="2.4.8.3 nioBuffers"></a>2.4.8.3 nioBuffers</h4><p>å’Œ <a href="#">ã€Œ2.2.7.3 nioBuffersã€</a> ä¸€è‡´ã€‚</p>
<h4 id="2-4-8-4-internalNioBuffer"><a href="#2-4-8-4-internalNioBuffer" class="headerlink" title="2.4.8.4 internalNioBuffer"></a>2.4.8.4 internalNioBuffer</h4><p>å’Œ <a href="#">ã€Œ2.2.7.4 internalNioBufferã€</a> ä¸€è‡´ã€‚</p>
<h3 id="2-4-9-Heap-ç›¸å…³æ–¹æ³•"><a href="#2-4-9-Heap-ç›¸å…³æ–¹æ³•" class="headerlink" title="2.4.9 Heap ç›¸å…³æ–¹æ³•"></a>2.4.9 Heap ç›¸å…³æ–¹æ³•</h3><p>ä¸æ”¯æŒ Heap ç›¸å…³æ–¹æ³•ã€‚</p>
<h3 id="2-4-10-Unsafe-ç›¸å…³æ–¹æ³•ã€‚"><a href="#2-4-10-Unsafe-ç›¸å…³æ–¹æ³•ã€‚" class="headerlink" title="2.4.10 Unsafe ç›¸å…³æ–¹æ³•ã€‚"></a>2.4.10 Unsafe ç›¸å…³æ–¹æ³•ã€‚</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasMemoryAddress</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">memoryAddress</span><span class="params">()</span> </span>{</span><br><span class="line">    ensureAccessible();</span><br><span class="line">    <span class="keyword">return</span> memoryAddress;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-4-11-newSwappedByteBuf"><a href="#2-4-11-newSwappedByteBuf" class="headerlink" title="2.4.11 newSwappedByteBuf"></a>2.4.11 newSwappedByteBuf</h3><blockquote>
<p><code>#newSwappedByteBuf()</code> æ–¹æ³•çš„<strong>é‡å†™</strong>ï¼Œæ˜¯ Unsafe ç±»å‹ç‹¬æœ‰çš„ã€‚</p>
</blockquote>
<p><code>#newSwappedByteBuf()</code> æ–¹æ³•ï¼Œåˆ›å»º SwappedByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> SwappedByteBuf <span class="title">newSwappedByteBuf</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (PlatformDependent.isUnaligned()) { <span class="comment">// æ”¯æŒ</span></span><br><span class="line">        <span class="comment">// Only use if unaligned access is supported otherwise there is no gain.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UnsafeDirectSwappedByteBuf(<span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.newSwappedByteBuf();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¯¹äº Linux ç¯å¢ƒä¸‹ï¼Œä¸€èˆ¬æ˜¯æ”¯æŒ unaligned access( å¯¹é½è®¿é—® )ï¼Œæ‰€ä»¥è¿”å›çš„æ˜¯ UnsafeDirectSwappedByteBuf å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€ŠTODO 1016 æ´¾ç”Ÿç±»ã€‹</a> ã€‚</li>
<li>ä¸ºä»€ä¹ˆè¦å¯¹é½è®¿é—®å‘¢ï¼Ÿå¯çœ‹ <a href="https://www.zhihu.com/question/23791224" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä»€ä¹ˆæ˜¯å­—èŠ‚å¯¹é½ï¼Œä¸ºä»€ä¹ˆè¦å¯¹é½?ã€‹</a> ã€‚æœ‰è¶£ã€‚</li>
</ul>
<h2 id="2-5-PooledUnsafeHeapByteBuf"><a href="#2-5-PooledUnsafeHeapByteBuf" class="headerlink" title="2.5 PooledUnsafeHeapByteBuf"></a>2.5 PooledUnsafeHeapByteBuf</h2><p><code>io.netty.buffer.PooledUnsafeHeapByteBuf</code> ï¼Œå®ç° PooledHeapByteBuf ç±»ï¼Œåœ¨ <a href="#">ã€Œ2.3 PooledHeapByteBufã€</a> çš„åŸºç¡€ä¸Šï¼ŒåŸºäº <strong>Unsafe</strong> çš„<strong>å¯é‡ç”¨</strong> ByteBuf å®ç°ç±»ã€‚æ‰€ä»¥ï¼Œæ³›å‹ <code>T</code> ä¸º <code>byte[]</code> ï¼Œå³ï¼š</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">final class PooledUnsafeHeapByteBuf extends PooledHeapByteBuf</span><br></pre></td></tr></tbody></table></figure>
<p>ä¹Ÿå› æ­¤ï¼ŒPooledUnsafeHeapByteBuf éœ€è¦å®ç°çš„æ–¹æ³•ï¼Œç°å¸¸å°‘ã€‚</p>
<h3 id="2-5-1-æ„é€ æ–¹æ³•"><a href="#2-5-1-æ„é€ æ–¹æ³•" class="headerlink" title="2.5.1 æ„é€ æ–¹æ³•"></a>2.5.1 æ„é€ æ–¹æ³•</h3><p>å’Œ <a href="#">ã€Œ2.2.1 æ„é€ æ–¹æ³•ã€</a> ç›¸åŒã€‚</p>
<h3 id="2-5-2-newInstance"><a href="#2-5-2-newInstance" class="headerlink" title="2.5.2 newInstance"></a>2.5.2 newInstance</h3><p>å’Œ <a href="#">ã€Œ2.2.2 newInstanceã€</a> ç›¸åŒã€‚</p>
<h3 id="2-5-3-è¯»å–-å†™å…¥æ“ä½œ"><a href="#2-5-3-è¯»å–-å†™å…¥æ“ä½œ" class="headerlink" title="2.5.3 è¯»å– / å†™å…¥æ“ä½œ"></a>2.5.3 è¯»å– / å†™å…¥æ“ä½œ</h3><p>è€æ ·å­ï¼Œæˆ‘ä»¬ä»¥ Int ç±»å‹ä¸ºä¾‹å­ï¼Œæ¥çœ‹çœ‹å®ƒçš„è¯»å–å’Œå†™å…¥æ“ä½œçš„å®ç°ä»£ç ã€‚</p>
<p>â‘  <strong>è¯»å–</strong>æ“ä½œï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">_getInt</span><span class="params">(<span class="keyword">int</span> index)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> UnsafeByteBufUtil.getInt(memory, idx(index));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// UnsafeByteBufUtil.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">byte</span>[] array, <span class="keyword">int</span> index)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (UNALIGNED) {</span><br><span class="line">        <span class="keyword">int</span> v = PlatformDependent.getInt(array, index);</span><br><span class="line">        <span class="keyword">return</span> BIG_ENDIAN_NATIVE_ORDER ? v : Integer.reverseBytes(v);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> PlatformDependent.getByte(array, index) &lt;&lt; <span class="number">24</span> |</span><br><span class="line">           (PlatformDependent.getByte(array, index + <span class="number">1</span>) &amp; <span class="number">0xff</span>) &lt;&lt; <span class="number">16</span> |</span><br><span class="line">           (PlatformDependent.getByte(array, index + <span class="number">2</span>) &amp; <span class="number">0xff</span>) &lt;&lt;  <span class="number">8</span> |</span><br><span class="line">           PlatformDependent.getByte(array, index + <span class="number">3</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// PlatformDependent.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">byte</span>[] data, <span class="keyword">int</span> index)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> PlatformDependent0.getInt(data, index);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// PlatformDependent0.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">byte</span>[] data, <span class="keyword">int</span> index)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> UNSAFE.getInt(data, BYTE_ARRAY_BASE_OFFSET + index);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åŸºäº Unsafe æ“ä½œ <code>byte[]</code> æ•°ç»„ã€‚</li>
</ul>
<p>â‘¡ <strong>å†™å…¥</strong>æ“ä½œï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">_setInt</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> value)</span> </span>{</span><br><span class="line">    UnsafeByteBufUtil.setInt(memory, idx(index), value);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// UnsafeByteBufUtil.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setInt</span><span class="params">(<span class="keyword">byte</span>[] array, <span class="keyword">int</span> index, <span class="keyword">int</span> value)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (UNALIGNED) {</span><br><span class="line">        PlatformDependent.putInt(array, index, BIG_ENDIAN_NATIVE_ORDER ? value : Integer.reverseBytes(value));</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        PlatformDependent.putByte(array, index, (<span class="keyword">byte</span>) (value &gt;&gt;&gt; <span class="number">24</span>));</span><br><span class="line">        PlatformDependent.putByte(array, index + <span class="number">1</span>, (<span class="keyword">byte</span>) (value &gt;&gt;&gt; <span class="number">16</span>));</span><br><span class="line">        PlatformDependent.putByte(array, index + <span class="number">2</span>, (<span class="keyword">byte</span>) (value &gt;&gt;&gt; <span class="number">8</span>));</span><br><span class="line">        PlatformDependent.putByte(array, index + <span class="number">3</span>, (<span class="keyword">byte</span>) value);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// PlatformDependent.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putInt</span><span class="params">(<span class="keyword">byte</span>[] data, <span class="keyword">int</span> index, <span class="keyword">int</span> value)</span> </span>{</span><br><span class="line">    PlatformDependent0.putInt(data, index, value);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// PlatformDependent0.java</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">putInt</span><span class="params">(<span class="keyword">byte</span>[] data, <span class="keyword">int</span> index, <span class="keyword">int</span> value)</span> </span>{</span><br><span class="line">    UNSAFE.putInt(data, BYTE_ARRAY_BASE_OFFSET + index, value);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-5-4-newSwappedByteBuf"><a href="#2-5-4-newSwappedByteBuf" class="headerlink" title="2.5.4 newSwappedByteBuf"></a>2.5.4 newSwappedByteBuf</h3><blockquote>
<p><code>#newSwappedByteBuf()</code> æ–¹æ³•çš„<strong>é‡å†™</strong>ï¼Œæ˜¯ Unsafe ç±»å‹ç‹¬æœ‰çš„ã€‚</p>
</blockquote>
<p><code>#newSwappedByteBuf()</code> æ–¹æ³•ï¼Œåˆ›å»º SwappedByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> SwappedByteBuf <span class="title">newSwappedByteBuf</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (PlatformDependent.isUnaligned()) {</span><br><span class="line">        <span class="comment">// Only use if unaligned access is supported otherwise there is no gain.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UnsafeHeapSwappedByteBuf(<span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.newSwappedByteBuf();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¯¹äº Linux ç¯å¢ƒä¸‹ï¼Œä¸€èˆ¬æ˜¯æ”¯æŒ unaligned access( å¯¹é½è®¿é—® )ï¼Œæ‰€ä»¥è¿”å›çš„æ˜¯ UnsafeHeapSwappedByteBuf å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€ŠTODO 1016 æ´¾ç”Ÿç±»ã€‹</a> ã€‚</li>
</ul>
<h1 id="3-UnpooledByteBuf"><a href="#3-UnpooledByteBuf" class="headerlink" title="3. UnpooledByteBuf"></a>3. UnpooledByteBuf</h1><p>ğŸ˜ˆ ä¸å­˜åœ¨ UnpooledByteBuf è¿™æ ·ä¸€ä¸ªç±»ï¼Œä¸»è¦æ˜¯ä¸ºäº†<strong>èšåˆ</strong>æ‰€æœ‰ Unpooled ç±»å‹çš„ ByteBuf å®ç°ç±»ã€‚</p>
<h2 id="3-1-UnpooledDirectByteBuf"><a href="#3-1-UnpooledDirectByteBuf" class="headerlink" title="3.1 UnpooledDirectByteBuf"></a>3.1 UnpooledDirectByteBuf</h2><p><code>io.netty.buffer.UnpooledDirectByteBuf</code> ï¼Œå®ç° AbstractReferenceCountedByteBuf æŠ½è±¡ç±»ï¼Œå¯¹åº” <a href="#">ã€Œ2.2 PooledDirectByteBufã€</a> çš„<strong>éæ± åŒ–</strong> ByteBuf å®ç°ç±»ã€‚</p>
<h3 id="3-1-1-æ„é€ æ–¹æ³•"><a href="#3-1-1-æ„é€ æ–¹æ³•" class="headerlink" title="3.1.1 æ„é€ æ–¹æ³•"></a>3.1.1 æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ByteBuf åˆ†é…å™¨å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ByteBufAllocator alloc;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ•°æ® ByteBuffer å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ByteBuffer buffer;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸´æ—¶ ByteBuffer å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ByteBuffer tmpNioBuf;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®¹é‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> capacity;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦éœ€è¦é‡Šæ”¾ &lt;1&gt;</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å¦‚æœ {<span class="doctag">@link</span> #buffer} ä»å¤–éƒ¨ä¼ å…¥ï¼Œåˆ™éœ€è¦è¿›è¡Œé‡Šæ”¾ï¼Œå³ {<span class="doctag">@link</span> #UnpooledDirectByteBuf(ByteBufAllocator, ByteBuffer, int)} æ„é€ æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> doNotFree;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UnpooledDirectByteBuf</span><span class="params">(ByteBufAllocator alloc, <span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">    <span class="comment">// è®¾ç½®æœ€å¤§å®¹é‡</span></span><br><span class="line">    <span class="keyword">super</span>(maxCapacity);</span><br><span class="line">    <span class="keyword">if</span> (alloc == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"alloc"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"initialCapacity: "</span> + initialCapacity);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (maxCapacity &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"maxCapacity: "</span> + maxCapacity);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; maxCapacity) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(<span class="string">"initialCapacity(%d) &gt; maxCapacity(%d)"</span>, initialCapacity, maxCapacity));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.alloc = alloc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º Direct ByteBuffer å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// è®¾ç½®æ•°æ® ByteBuffer å¯¹è±¡</span></span><br><span class="line">    setByteBuffer(ByteBuffer.allocateDirect(initialCapacity));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">UnpooledDirectByteBuf</span><span class="params">(ByteBufAllocator alloc, ByteBuffer initialBuffer, <span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">    <span class="comment">// è®¾ç½®æœ€å¤§å®¹é‡</span></span><br><span class="line">    <span class="keyword">super</span>(maxCapacity);</span><br><span class="line">    <span class="keyword">if</span> (alloc == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"alloc"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (initialBuffer == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"initialBuffer"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (!initialBuffer.isDirect()) { <span class="comment">// å¿…é¡»æ˜¯ Direct</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"initialBuffer is not a direct buffer."</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (initialBuffer.isReadOnly()) { <span class="comment">// å¿…é¡»å¯å†™</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"initialBuffer is a read-only buffer."</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è·å¾—å‰©ä½™å¯è¯»å­—èŠ‚æ•°ï¼Œä½œä¸ºåˆå§‹å®¹é‡å¤§å° &lt;2&gt;</span></span><br><span class="line">    <span class="keyword">int</span> initialCapacity = initialBuffer.remaining();</span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; maxCapacity) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(</span><br><span class="line">                <span class="string">"initialCapacity(%d) &gt; maxCapacity(%d)"</span>, initialCapacity, maxCapacity));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.alloc = alloc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ‡è®°ä¸º true ã€‚å› ä¸º initialBuffer æ˜¯ä»å¤–éƒ¨ä¼ é€’è¿›æ¥ï¼Œé‡Šæ”¾çš„å·¥ä½œï¼Œä¸äº¤ç»™å½“å‰ UnpooledDirectByteBuf å¯¹è±¡ã€‚</span></span><br><span class="line">    doNotFree = <span class="keyword">true</span>; &lt;<span class="number">1</span>&gt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// slice åˆ‡ç‰‡</span></span><br><span class="line">    <span class="comment">// è®¾ç½®æ•°æ® ByteBuffer å¯¹è±¡</span></span><br><span class="line">    setByteBuffer(initialBuffer.slice().order(ByteOrder.BIG_ENDIAN));</span><br><span class="line">    <span class="comment">// è®¾ç½®å†™ç´¢å¼• &lt;2&gt;</span></span><br><span class="line">    writerIndex(initialCapacity);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œä¸»è¦è¦ç†è§£ä¸‹ <code>&lt;1&gt;</code> å’Œ <code>&lt;2&gt;</code> ä¸¤å¤„ã€‚</li>
<li><p>è°ƒç”¨ <code>#allocateDirect(int initialCapacity)</code> æ–¹æ³•ï¼Œåˆ›å»º Direct ByteBuffer å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ByteBuffer <span class="title">allocateDirect</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> ByteBuffer.allocateDirect(initialCapacity);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>è°ƒç”¨ <code>#setByteBuffer(ByteBuffer buffer)</code> æ–¹æ³•ï¼Œè®¾ç½®æ•°æ® ByteBuffer å¯¹è±¡ã€‚å¦‚æœæœ‰è€çš„<strong>è‡ªå·±çš„</strong>( æŒ‡çš„æ˜¯è‡ªå·±åˆ›å»ºçš„ ) <code>buffer</code> å¯¹è±¡ï¼Œéœ€è¦è¿›è¡Œé‡Šæ”¾ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setByteBuffer</span><span class="params">(ByteBuffer buffer)</span> </span>{</span><br><span class="line">    ByteBuffer oldBuffer = <span class="keyword">this</span>.buffer;</span><br><span class="line">    <span class="keyword">if</span> (oldBuffer != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// æ ‡è®°ä¸º false ã€‚å› ä¸ºè®¾ç½®çš„ ByteBuffer å¯¹è±¡ï¼Œæ˜¯ UnpooledDirectByteBuf è‡ªå·±åˆ›å»ºçš„</span></span><br><span class="line">        <span class="keyword">if</span> (doNotFree) {</span><br><span class="line">            doNotFree = <span class="keyword">false</span>;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// é‡Šæ”¾è€çš„ buffer å¯¹è±¡</span></span><br><span class="line">            freeDirect(oldBuffer); <span class="comment">// &lt;3&gt;</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½® buffer</span></span><br><span class="line">    <span class="keyword">this</span>.buffer = buffer;</span><br><span class="line">    <span class="comment">// é‡ç½® tmpNioBuf ä¸º null</span></span><br><span class="line">    tmpNioBuf = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// è®¾ç½®å®¹é‡</span></span><br><span class="line">    capacity = buffer.remaining();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;3&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#freeDirect(ByteBuffer buffer)</code> æ–¹æ³•ï¼Œé‡Šæ”¾<strong>è€çš„</strong> <code>buffer</code> å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ3.1.3 deallocateã€</a> ã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-1-2-capacity"><a href="#3-1-2-capacity" class="headerlink" title="3.1.2 capacity"></a>3.1.2 capacity</h3><p><code>#capacity()</code> æ–¹æ³•ï¼Œè·å¾—å®¹é‡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">capacity</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> capacity;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p><code>#capacity(int newCapacity)</code> æ–¹æ³•ï¼Œè°ƒæ•´å®¹é‡å¤§å°ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®æƒ…å†µï¼Œå¯èƒ½å¯¹ <code>buffer</code> æ‰©å®¹æˆ–ç¼©å®¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"Duplicates"</span>)</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">capacity</span><span class="params">(<span class="keyword">int</span> newCapacity)</span> </span>{</span><br><span class="line">    <span class="comment">// æ ¡éªŒæ–°çš„å®¹é‡ï¼Œä¸èƒ½è¶…è¿‡æœ€å¤§å®¹é‡</span></span><br><span class="line">    checkNewCapacity(newCapacity);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> readerIndex = readerIndex();</span><br><span class="line">    <span class="keyword">int</span> writerIndex = writerIndex();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> oldCapacity = capacity;</span><br><span class="line">    <span class="comment">// æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (newCapacity &gt; oldCapacity) {</span><br><span class="line">        ByteBuffer oldBuffer = buffer;</span><br><span class="line">        <span class="comment">// åˆ›å»ºæ–°çš„ Direct ByteBuffer å¯¹è±¡</span></span><br><span class="line">        ByteBuffer newBuffer = allocateDirect(newCapacity);</span><br><span class="line">        <span class="comment">// å¤åˆ¶æ•°æ®åˆ°æ–°çš„ buffer å¯¹è±¡</span></span><br><span class="line">        oldBuffer.position(<span class="number">0</span>).limit(oldBuffer.capacity());</span><br><span class="line">        newBuffer.position(<span class="number">0</span>).limit(oldBuffer.capacity());</span><br><span class="line">        newBuffer.put(oldBuffer);</span><br><span class="line">        newBuffer.clear(); <span class="comment">// å› ä¸ºè¯»å–å’Œå†™å…¥ï¼Œä½¿ç”¨ readerIndex å’Œ writerIndex ï¼Œæ‰€ä»¥æ²¡å…³ç³»ã€‚</span></span><br><span class="line">        <span class="comment">// è®¾ç½®æ–°çš„ buffer å¯¹è±¡ï¼Œå¹¶æ ¹æ®æ¡ä»¶é‡Šæ”¾è€çš„ buffer å¯¹è±¡</span></span><br><span class="line">        setByteBuffer(newBuffer);</span><br><span class="line">    <span class="comment">// ç¼©å®¹</span></span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (newCapacity &lt; oldCapacity) {</span><br><span class="line">        ByteBuffer oldBuffer = buffer;</span><br><span class="line">        <span class="comment">// åˆ›å»ºæ–°çš„ Direct ByteBuffer å¯¹è±¡</span></span><br><span class="line">        ByteBuffer newBuffer = allocateDirect(newCapacity);</span><br><span class="line">        <span class="keyword">if</span> (readerIndex &lt; newCapacity) {</span><br><span class="line">            <span class="comment">// å¦‚æœå†™ç´¢å¼•è¶…è¿‡æ–°å®¹é‡ï¼Œéœ€è¦é‡ç½®ä¸‹ï¼Œè®¾ç½®ä¸ºæœ€å¤§å®¹é‡ã€‚å¦åˆ™å°±è¶Šç•Œäº†ã€‚</span></span><br><span class="line">            <span class="keyword">if</span> (writerIndex &gt; newCapacity) {</span><br><span class="line">                writerIndex(writerIndex = newCapacity);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// å¤åˆ¶æ•°æ®åˆ°æ–°çš„ buffer å¯¹è±¡</span></span><br><span class="line">            oldBuffer.position(readerIndex).limit(writerIndex);</span><br><span class="line">            newBuffer.position(readerIndex).limit(writerIndex);</span><br><span class="line">            newBuffer.put(oldBuffer);</span><br><span class="line">            newBuffer.clear(); <span class="comment">// å› ä¸ºè¯»å–å’Œå†™å…¥ï¼Œä½¿ç”¨ readerIndex å’Œ writerIndex ï¼Œæ‰€ä»¥æ²¡å…³ç³»ã€‚</span></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// å› ä¸ºè¯»ç´¢å¼•è¶…è¿‡æ–°å®¹é‡ï¼Œæ‰€ä»¥å†™ç´¢å¼•è¶…è¿‡æ–°å®¹é‡</span></span><br><span class="line">            <span class="comment">// å¦‚æœè¯»å†™ç´¢å¼•éƒ½è¶…è¿‡æ–°å®¹é‡ï¼Œéœ€è¦é‡ç½®ä¸‹ï¼Œéƒ½è®¾ç½®ä¸ºæœ€å¤§å®¹é‡ã€‚å¦åˆ™å°±è¶Šç•Œäº†ã€‚</span></span><br><span class="line">            setIndex(newCapacity, newCapacity);</span><br><span class="line">            <span class="comment">// è¿™é‡Œè¦æ³¨æ„ä¸‹ï¼Œè€çš„æ•°æ®ï¼Œç›¸å½“äºä¸è¿›è¡Œå¤åˆ¶ï¼Œå› ä¸ºå·²ç»è¯»å–å®Œäº†ã€‚</span></span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// è®¾ç½®æ–°çš„ buffer å¯¹è±¡ï¼Œå¹¶æ ¹æ®æ¡ä»¶é‡Šæ”¾è€çš„ buffer å¯¹è±¡</span></span><br><span class="line">        setByteBuffer(newBuffer);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è™½ç„¶ä»£ç æ¯”è¾ƒé•¿ï¼Œå®é™…å¾ˆç®€å•ã€‚èƒ–å‹è‡ªå·±è€å¿ƒçœ‹ä¸‹æ³¨é‡Šè¿›è¡Œç†è§£ä¸‹å™¢ã€‚</li>
</ul>
<h3 id="3-1-3-deallocate"><a href="#3-1-3-deallocate" class="headerlink" title="3.1.3 deallocate"></a>3.1.3 deallocate</h3><p><code>#deallocate()</code> æ–¹æ³•ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼Œè¿›è¡Œå†…å­˜å›æ”¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deallocate</span><span class="params">()</span> </span>{</span><br><span class="line">    ByteBuffer buffer = <span class="keyword">this</span>.buffer;</span><br><span class="line">    <span class="keyword">if</span> (buffer == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// ç½®ç©º buffer å±æ€§</span></span><br><span class="line">    <span class="keyword">this</span>.buffer = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾ buffer å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (!doNotFree) {</span><br><span class="line">        freeDirect(buffer);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><code>#freeDirect(ByteBuffer buffer)</code> æ–¹æ³•ï¼Œé‡Šæ”¾ <code>buffer</code> å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">freeArray</span><span class="params">(<span class="keyword">byte</span>[] array)</span> </span>{</span><br><span class="line">    PlatformDependent.freeDirectBuffer(buffer);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// PlatformDependent.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Cleaner NOOP = <span class="keyword">new</span> Cleaner() { ... }</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">freeDirectBuffer</span><span class="params">(ByteBuffer buffer)</span> </span>{</span><br><span class="line">    CLEANER.freeDirectBuffer(buffer);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é€šè¿‡è°ƒç”¨ <code>io.netty.util.internal.Cleaner#freeDirectBuffer(ByteBuffer buffer)</code> æ–¹æ³•ï¼Œé‡Šæ”¾ Direct ByteBuffer å¯¹è±¡ã€‚å› ä¸º Java çš„ç‰ˆæœ¬ä¸åŒï¼Œè°ƒç”¨çš„æ–¹æ³•ï¼Œæ‰€ä»¥ Cleaner æœ‰ä¸¤ä¸ª å®ç°ç±»ï¼š</li>
<li><code>io.netty.util.internal.CleanerJava9</code> ï¼Œé€‚ç”¨äº Java9+ çš„ç‰ˆæœ¬ï¼Œé€šè¿‡åå°„è°ƒç”¨ DirectByteBuffer å¯¹è±¡çš„ <code>#invokeCleaner()</code> æ–¹æ³•ï¼Œè¿›è¡Œé‡Šæ”¾ã€‚</li>
<li><code>io.netty.util.internal.CleanerJava6</code> ï¼Œé€‚ç”¨äº Java6+ çš„ç‰ˆæœ¬ï¼Œé€šè¿‡åå°„è·å¾— DirectByteBuffer å¯¹è±¡çš„ <code>#cleaner()</code> æ–¹æ³•ï¼Œä»è€Œè°ƒç”¨ <code>sun.misc.Cleaner#clean()</code> æ–¹æ³•ï¼Œè¿›è¡Œé‡Šæ”¾ã€‚</li>
<li>è™½ç„¶å®ç°ç•¥æœ‰ä¸åŒï¼Œä½†æ˜¯åŸç†æ˜¯ä¸€è‡´çš„ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œè‡ªå·±çœ‹ä¸‹ CleanerJava9 å’Œ CleanerJava6 çš„å®ç°ä»£ç ã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-1-4-å…¶å®ƒæ–¹æ³•"><a href="#3-1-4-å…¶å®ƒæ–¹æ³•" class="headerlink" title="3.1.4 å…¶å®ƒæ–¹æ³•"></a>3.1.4 å…¶å®ƒæ–¹æ³•</h3><p>å…¶ä»–æ–¹æ³•ï¼Œå’Œ <a href="#">ã€Œ2.2 PooledDirectByteBufã€</a> åŸºæœ¬ä¸€è‡´ã€‚</p>
<h2 id="3-2-UnpooledHeapByteBuf"><a href="#3-2-UnpooledHeapByteBuf" class="headerlink" title="3.2 UnpooledHeapByteBuf"></a>3.2 UnpooledHeapByteBuf</h2><p><code>io.netty.buffer.UnpooledHeapByteBuf</code> ï¼Œå®ç° AbstractReferenceCountedByteBuf æŠ½è±¡ç±»ï¼Œå¯¹åº” <a href="#">ã€Œ2.3 PooledHeapByteBufã€</a> çš„<strong>éæ± åŒ–</strong> ByteBuf å®ç°ç±»ã€‚</p>
<h3 id="3-2-1-æ„é€ æ–¹æ³•"><a href="#3-2-1-æ„é€ æ–¹æ³•" class="headerlink" title="3.2.1 æ„é€ æ–¹æ³•"></a>3.2.1 æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ByteBuf åˆ†é…å™¨å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ByteBufAllocator alloc;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å­—èŠ‚æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">byte</span>[] array;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸´æ—¶ ByteBuff å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ByteBuffer tmpNioBuf;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">UnpooledHeapByteBuf</span><span class="params">(ByteBufAllocator alloc, <span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">    <span class="comment">// è®¾ç½®æœ€å¤§å®¹é‡</span></span><br><span class="line">    <span class="keyword">super</span>(maxCapacity);</span><br><span class="line"></span><br><span class="line">    checkNotNull(alloc, <span class="string">"alloc"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; maxCapacity) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(</span><br><span class="line">                <span class="string">"initialCapacity(%d) &gt; maxCapacity(%d)"</span>, initialCapacity, maxCapacity));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.alloc = alloc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»ºå¹¶è®¾ç½®å­—èŠ‚æ•°ç»„</span></span><br><span class="line">    setArray(allocateArray(initialCapacity));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®è¯»å†™ç´¢å¼•</span></span><br><span class="line">    setIndex(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">UnpooledHeapByteBuf</span><span class="params">(ByteBufAllocator alloc, <span class="keyword">byte</span>[] initialArray, <span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">    <span class="comment">// è®¾ç½®æœ€å¤§å®¹é‡</span></span><br><span class="line">    <span class="keyword">super</span>(maxCapacity);</span><br><span class="line"></span><br><span class="line">    checkNotNull(alloc, <span class="string">"alloc"</span>);</span><br><span class="line">    checkNotNull(initialArray, <span class="string">"initialArray"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (initialArray.length &gt; maxCapacity) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(</span><br><span class="line">                <span class="string">"initialCapacity(%d) &gt; maxCapacity(%d)"</span>, initialArray.length, maxCapacity));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.alloc = alloc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®å­—èŠ‚æ•°ç»„</span></span><br><span class="line">    setArray(initialArray);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®è¯»å†™ç´¢å¼•</span></span><br><span class="line">    setIndex(<span class="number">0</span>, initialArray.length);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ä¸€ã€äºŒä¸ªæ„é€ æ–¹æ³•çš„åŒºåˆ«ï¼Œåè€…å­—èŠ‚æ•°ç»„æ˜¯å¦ä»æ–¹æ³•å‚æ•°( <code>initialArray</code> )ä¼ é€’è¿›æ¥ã€‚</li>
<li><p>è°ƒç”¨ <code>#allocateArray(int initialCapacity)</code> æ–¹æ³•ï¼Œåˆ›å»ºå­—èŠ‚æ•°ç»„ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">byte</span>[] allocateArray(<span class="keyword">int</span> initialCapacity) {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="keyword">byte</span>[initialCapacity];</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>è°ƒç”¨ <code>#setArray(byte[] initialArray)</code> æ–¹æ³•ï¼Œè®¾ç½® <code>array</code> å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setArray</span><span class="params">(<span class="keyword">byte</span>[] initialArray)</span> </span>{</span><br><span class="line">        array = initialArray;</span><br><span class="line">        tmpNioBuf = <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">    ```    </span><br><span class="line"></span><br><span class="line">### 3.2.2 capacity</span><br><span class="line"></span><br><span class="line">`#capacity()` æ–¹æ³•ï¼Œè·å¾—å®¹é‡ã€‚ä»£ç å¦‚ä¸‹ï¼š</span><br><span class="line"></span><br><span class="line">```Java</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">capacity</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> array.length;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ä½¿ç”¨å­—èŠ‚æ•°ç»„çš„å¤§å°ï¼Œä½œä¸ºå½“å‰å®¹é‡ä¸Šé™ã€‚</p>
</li>
</ul>
<hr>
<p><code>#capacity(int newCapacity)</code> æ–¹æ³•ï¼Œè°ƒæ•´å®¹é‡å¤§å°ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ ¹æ®æƒ…å†µï¼Œå¯èƒ½å¯¹ <code>array</code> æ‰©å®¹æˆ–ç¼©å®¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">capacity</span><span class="params">(<span class="keyword">int</span> newCapacity)</span> </span>{</span><br><span class="line">    <span class="comment">// // æ ¡éªŒæ–°çš„å®¹é‡ï¼Œä¸èƒ½è¶…è¿‡æœ€å¤§å®¹é‡</span></span><br><span class="line">    checkNewCapacity(newCapacity);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> oldCapacity = array.length;</span><br><span class="line">    <span class="keyword">byte</span>[] oldArray = array;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (newCapacity &gt; oldCapacity) {</span><br><span class="line">        <span class="comment">// åˆ›å»ºæ–°æ•°ç»„</span></span><br><span class="line">        <span class="keyword">byte</span>[] newArray = allocateArray(newCapacity);</span><br><span class="line">        <span class="comment">// å¤åˆ¶ã€å…¨éƒ¨ã€‘æ•°æ®åˆ°æ–°æ•°ç»„</span></span><br><span class="line">        System.arraycopy(oldArray, <span class="number">0</span>, newArray, <span class="number">0</span>, oldArray.length);</span><br><span class="line">        <span class="comment">// è®¾ç½®æ•°ç»„</span></span><br><span class="line">        setArray(newArray);</span><br><span class="line">        <span class="comment">// é‡Šæ”¾è€æ•°ç»„</span></span><br><span class="line">        freeArray(oldArray);</span><br><span class="line">    <span class="comment">// ç¼©å®¹</span></span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (newCapacity &lt; oldCapacity) {</span><br><span class="line">        <span class="comment">// åˆ›å»ºæ–°æ•°ç»„</span></span><br><span class="line">        <span class="keyword">byte</span>[] newArray = allocateArray(newCapacity);</span><br><span class="line">        <span class="keyword">int</span> readerIndex = readerIndex();</span><br><span class="line">        <span class="keyword">if</span> (readerIndex &lt; newCapacity) {</span><br><span class="line">            <span class="comment">// å¦‚æœå†™ç´¢å¼•è¶…è¿‡æ–°å®¹é‡ï¼Œéœ€è¦é‡ç½®ä¸‹ï¼Œè®¾ç½®ä¸ºæœ€å¤§å®¹é‡ã€‚å¦åˆ™å°±è¶Šç•Œäº†ã€‚</span></span><br><span class="line">            <span class="keyword">int</span> writerIndex = writerIndex();</span><br><span class="line">            <span class="keyword">if</span> (writerIndex &gt; newCapacity) {</span><br><span class="line">                writerIndex(writerIndex = newCapacity);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// åªå¤åˆ¶ã€è¯»å–æ®µã€‘æ•°æ®åˆ°æ–°æ•°ç»„</span></span><br><span class="line">            System.arraycopy(oldArray, readerIndex, newArray, readerIndex, writerIndex - readerIndex);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// å› ä¸ºè¯»ç´¢å¼•è¶…è¿‡æ–°å®¹é‡ï¼Œæ‰€ä»¥å†™ç´¢å¼•è¶…è¿‡æ–°å®¹é‡</span></span><br><span class="line">            <span class="comment">// å¦‚æœè¯»å†™ç´¢å¼•éƒ½è¶…è¿‡æ–°å®¹é‡ï¼Œéœ€è¦é‡ç½®ä¸‹ï¼Œéƒ½è®¾ç½®ä¸ºæœ€å¤§å®¹é‡ã€‚å¦åˆ™å°±è¶Šç•Œäº†ã€‚</span></span><br><span class="line">            setIndex(newCapacity, newCapacity);</span><br><span class="line">            <span class="comment">// è¿™é‡Œè¦æ³¨æ„ä¸‹ï¼Œè€çš„æ•°æ®ï¼Œç›¸å½“äºä¸è¿›è¡Œå¤åˆ¶ï¼Œå› ä¸ºå·²ç»è¯»å–å®Œäº†ã€‚</span></span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// è®¾ç½®æ•°ç»„</span></span><br><span class="line">        setArray(newArray);</span><br><span class="line">        <span class="comment">// é‡Šæ”¾è€æ•°ç»„</span></span><br><span class="line">        freeArray(oldArray);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è™½ç„¶ä»£ç æ¯”è¾ƒé•¿ï¼Œå®é™…å¾ˆç®€å•ã€‚èƒ–å‹è‡ªå·±è€å¿ƒçœ‹ä¸‹æ³¨é‡Šè¿›è¡Œç†è§£ä¸‹å™¢ã€‚ğŸ˜ˆ å’Œ <a href="#">ã€Œ3.1.2 capacityã€</a> åŸºæœ¬ä¸€ç›´çš„ã€‚</li>
</ul>
<h3 id="3-2-3-deallocate"><a href="#3-2-3-deallocate" class="headerlink" title="3.2.3 deallocate"></a>3.2.3 deallocate</h3><p><code>#deallocate()</code> æ–¹æ³•ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ï¼Œè¿›è¡Œå†…å­˜å›æ”¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deallocate</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// é‡Šæ”¾è€æ•°ç»„</span></span><br><span class="line">    freeArray(array);</span><br><span class="line">    <span class="comment">// è®¾ç½®ä¸ºç©ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">    array = EmptyArrays.EMPTY_BYTES;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><code>#freeArray(byte[] array)</code> æ–¹æ³•ï¼Œé‡Šæ”¾æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">freeArray</span><span class="params">(<span class="keyword">byte</span>[] array)</span> </span>{</span><br><span class="line">    <span class="comment">// NOOP</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å­—èŠ‚æ•°ç»„ï¼Œæ— å¼•ç”¨åï¼Œè‡ªç„¶å°±ä¼šè¢« GC å›æ”¶ã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-2-4-å…¶å®ƒæ–¹æ³•"><a href="#3-2-4-å…¶å®ƒæ–¹æ³•" class="headerlink" title="3.2.4 å…¶å®ƒæ–¹æ³•"></a>3.2.4 å…¶å®ƒæ–¹æ³•</h3><p>å…¶å®ƒæ–¹æ³•ï¼Œå’Œ <a href="#">ã€Œ2.3 PooledHeapByteBufã€</a> åŸºæœ¬ä¸€è‡´ã€‚</p>
<h2 id="3-3-UnpooledUnsafeDirectByteBuf"><a href="#3-3-UnpooledUnsafeDirectByteBuf" class="headerlink" title="3.3 UnpooledUnsafeDirectByteBuf"></a>3.3 UnpooledUnsafeDirectByteBuf</h2><p><code>io.netty.buffer.UnpooledUnsafeDirectByteBuf</code> ï¼Œå®ç° AbstractReferenceCountedByteBuf æŠ½è±¡ç±»ï¼Œå¯¹åº” <code>ã€Œ2.4 PooledUnsafeDirectByteBufã€</code> çš„<strong>éæ± åŒ–</strong> ByteBuf å®ç°ç±»ã€‚</p>
<ul>
<li>æ„é€ æ–¹æ³•ã€<code>#capacity(...)</code> æ–¹æ³•ã€<code>#deallocate()</code> æ–¹æ³•ï¼Œå’Œ <a href="#">ã€Œ3.1  PooledDirectByteBufã€</a> åŸºæœ¬ä¸€è‡´ã€‚</li>
<li>å…¶å®ƒæ–¹æ³•ï¼Œå’Œ <a href="#">ã€Œ2.4 PooledUnsafeDirectByteBufã€</a> åŸºæœ¬ä¸€è‡´ã€‚</li>
</ul>
<p>å¦å¤–ï¼ŒUnpooledUnsafeDirectByteBuf æœ‰ä¸€ä¸ªå­ç±» UnpooledUnsafeNoCleanerDirectByteBuf ï¼Œç”¨äº <code>netty-microbench</code> æ¨¡å—ï¼Œè¿›è¡ŒåŸºå‡†æµ‹è¯•ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥è‡ªå·±çœ‹çœ‹ã€‚</p>
<h2 id="3-4-UnpooledUnsafeHeapByteBuf"><a href="#3-4-UnpooledUnsafeHeapByteBuf" class="headerlink" title="3.4 UnpooledUnsafeHeapByteBuf"></a>3.4 UnpooledUnsafeHeapByteBuf</h2><p><code>io.netty.buffer.UnpooledUnsafeHeapByteBuf</code> ï¼Œå®ç° AbstractReferenceCountedByteBuf æŠ½è±¡ç±»ï¼Œå¯¹åº” <code>ã€Œ2.5 PooledUnsafeHeapByteBufã€</code> çš„<strong>éæ± åŒ–</strong> ByteBuf å®ç°ç±»ã€‚</p>
<ul>
<li>æ„é€ æ–¹æ³•ã€<code>#capacity(...)</code> æ–¹æ³•ã€<code>#deallocate()</code> æ–¹æ³•ï¼Œå’Œ <a href="#">ã€Œ3.2  PooledHeapByteBufã€</a> åŸºæœ¬ä¸€è‡´ã€‚</li>
<li>å…¶å®ƒæ–¹æ³•ï¼Œå’Œ <a href="#">ã€Œ2.5 PooledUnsafeHeapByteBufã€</a> åŸºæœ¬ä¸€è‡´ã€‚</li>
</ul>
<h2 id="3-5-ThreadLocal-ByteBuf"><a href="#3-5-ThreadLocal-ByteBuf" class="headerlink" title="3.5 ThreadLocal ByteBuf"></a>3.5 ThreadLocal ByteBuf</h2><blockquote>
<p>è€è‰¿è‰¿ï¼šè¿™æ˜¯æœ¬æ–‡çš„æ‹“å±•å†…å®¹ã€‚</p>
</blockquote>
<p>è™½ç„¶ UnpooledByteBuf ä¸åŸºäº<strong>å¯¹è±¡æ± </strong>å®ç°ï¼Œä½†æ˜¯è€ƒè™‘åˆ° NIO Direct ByteBuffer ç”³è¯·çš„æˆæœ¬æ˜¯æ¯”è¾ƒé«˜çš„ï¼Œæ‰€ä»¥åŸºäº ThreadLocal + Recycler å®ç°é‡ç”¨ã€‚</p>
<p><code>ByteBufUtil#threadLocalDirectBuffer()</code> æ–¹æ³•ï¼Œåˆ›å»º ThreadLocal ByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> THREAD_LOCAL_BUFFER_SIZE;</span><br><span class="line"><span class="keyword">static</span> {</span><br><span class="line">    THREAD_LOCAL_BUFFER_SIZE = SystemPropertyUtil.getInt(<span class="string">"io.netty.threadLocalDirectBufferSize"</span>, <span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns a cached thread-local direct buffer, if available.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a cached thread-local direct buffer, if available.  {<span class="doctag">@code</span> null} otherwise.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteBuf <span class="title">threadLocalDirectBuffer</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (THREAD_LOCAL_BUFFER_SIZE &lt;= <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (PlatformDependent.hasUnsafe()) {</span><br><span class="line">        <span class="keyword">return</span> ThreadLocalUnsafeDirectByteBuf.newInstance();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> ThreadLocalDirectByteBuf.newInstance();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>THREAD_LOCAL_BUFFER_SIZE</code> <strong>é™æ€</strong>å±æ€§ï¼Œé€šè¿‡ <code>"io.netty.threadLocalDirectBufferSize"</code> é…ç½®ï¼Œé»˜è®¤ä¸º 0 ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®é™… <code>#threadLocalDirectBuffer()</code> æ–¹æ³•ï¼Œè¿”å› <code>null</code> ï¼Œä¸å¼€å¯ ThreadLocal ByteBuf çš„åŠŸèƒ½ã€‚</li>
<li>æ ¹æ®æ˜¯å¦æ”¯æŒ Unsafe æ“ä½œï¼Œåˆ›å»º ThreadLocalUnsafeDirectByteBuf æˆ– ThreadLocalDirectByteBuf å¯¹è±¡ã€‚</li>
</ul>
<h3 id="3-5-1-ThreadLocalUnsafeDirectByteBuf"><a href="#3-5-1-ThreadLocalUnsafeDirectByteBuf" class="headerlink" title="3.5.1 ThreadLocalUnsafeDirectByteBuf"></a>3.5.1 ThreadLocalUnsafeDirectByteBuf</h3><p>ThreadLocalUnsafeDirectByteBuf ï¼Œåœ¨ ByteBufUtil çš„<strong>å†…éƒ¨é™æ€ç±»</strong>ï¼Œç»§æ‰¿ UnpooledUnsafeDirectByteBuf ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalUnsafeDirectByteBuf</span> <span class="keyword">extends</span> <span class="title">UnpooledUnsafeDirectByteBuf</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Recycler å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Recycler&lt;ThreadLocalUnsafeDirectByteBuf&gt; RECYCLER =</span><br><span class="line">            <span class="keyword">new</span> Recycler&lt;ThreadLocalUnsafeDirectByteBuf&gt;() {</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> ThreadLocalUnsafeDirectByteBuf <span class="title">newObject</span><span class="params">(Handle&lt;ThreadLocalUnsafeDirectByteBuf&gt; handle)</span> </span>{</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> ThreadLocalUnsafeDirectByteBuf(handle);</span><br><span class="line">                }</span><br><span class="line">            };</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> ThreadLocalUnsafeDirectByteBuf <span class="title">newInstance</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// ä» RECYCLER ä¸­ï¼Œè·å¾— ThreadLocalUnsafeDirectByteBuf å¯¹è±¡</span></span><br><span class="line">        ThreadLocalUnsafeDirectByteBuf buf = RECYCLER.get();</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– ref ä¸º 1</span></span><br><span class="line">        buf.setRefCnt(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> buf;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Recycler å¤„ç†å™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Handle&lt;ThreadLocalUnsafeDirectByteBuf&gt; handle;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ThreadLocalUnsafeDirectByteBuf</span><span class="params">(Handle&lt;ThreadLocalUnsafeDirectByteBuf&gt; handle)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(UnpooledByteBufAllocator.DEFAULT, <span class="number">256</span>, Integer.MAX_VALUE);</span><br><span class="line">        <span class="keyword">this</span>.handle = handle;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deallocate</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (capacity() &gt; THREAD_LOCAL_BUFFER_SIZE) { <span class="comment">// &lt;1&gt;</span></span><br><span class="line">            <span class="comment">// é‡Šæ”¾</span></span><br><span class="line">            <span class="keyword">super</span>.deallocate();</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// æ¸…ç©º</span></span><br><span class="line">            clear();</span><br><span class="line">            <span class="comment">// å›æ”¶å¯¹è±¡</span></span><br><span class="line">            handle.recycle(<span class="keyword">this</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨ <code>&lt;1&gt;</code> å¤„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œåªæœ‰ ByteBuffer å®¹é‡å°äº <code>THREAD_LOCAL_BUFFER_SIZE</code> æ—¶ï¼Œæ‰ä¼šé‡ç”¨ ByteBuffer å¯¹è±¡ã€‚</li>
</ul>
<h3 id="3-5-2-ThreadLocalDirectByteBuf"><a href="#3-5-2-ThreadLocalDirectByteBuf" class="headerlink" title="3.5.2 ThreadLocalDirectByteBuf"></a>3.5.2 ThreadLocalDirectByteBuf</h3><p>ThreadLocalUnsafeDirectByteBuf ï¼Œåœ¨ ByteBufUtil çš„<strong>å†…éƒ¨é™æ€ç±»</strong>ï¼Œç»§æ‰¿ UnpooledDirectByteBuf ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalDirectByteBuf</span> <span class="keyword">extends</span> <span class="title">UnpooledDirectByteBuf</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Recycler å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Recycler&lt;ThreadLocalDirectByteBuf&gt; RECYCLER = <span class="keyword">new</span> Recycler&lt;ThreadLocalDirectByteBuf&gt;() {</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> ThreadLocalDirectByteBuf <span class="title">newObject</span><span class="params">(Handle&lt;ThreadLocalDirectByteBuf&gt; handle)</span> </span>{</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ThreadLocalDirectByteBuf(handle);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> ThreadLocalDirectByteBuf <span class="title">newInstance</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// ä» RECYCLER ä¸­ï¼Œè·å¾— ThreadLocalUnsafeDirectByteBuf å¯¹è±¡</span></span><br><span class="line">        ThreadLocalDirectByteBuf buf = RECYCLER.get();</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– ref ä¸º 1</span></span><br><span class="line">        buf.setRefCnt(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> buf;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Recycler å¤„ç†å™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Handle&lt;ThreadLocalDirectByteBuf&gt; handle;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ThreadLocalDirectByteBuf</span><span class="params">(Handle&lt;ThreadLocalDirectByteBuf&gt; handle)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>(UnpooledByteBufAllocator.DEFAULT, <span class="number">256</span>, Integer.MAX_VALUE);</span><br><span class="line">        <span class="keyword">this</span>.handle = handle;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">deallocate</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (capacity() &gt; THREAD_LOCAL_BUFFER_SIZE) {</span><br><span class="line">            <span class="comment">// é‡Šæ”¾</span></span><br><span class="line">            <span class="keyword">super</span>.deallocate();</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// æ¸…ç†</span></span><br><span class="line">            clear();</span><br><span class="line">            <span class="comment">// å›æ”¶</span></span><br><span class="line">            handle.recycle(<span class="keyword">this</span>);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-6-WrappedUnpooledUnsafeDirectByteBuf"><a href="#3-6-WrappedUnpooledUnsafeDirectByteBuf" class="headerlink" title="3.6 WrappedUnpooledUnsafeDirectByteBuf"></a>3.6 WrappedUnpooledUnsafeDirectByteBuf</h2><blockquote>
<p>è€è‰¿è‰¿ï¼šè¿™æ˜¯æœ¬æ–‡çš„æ‹“å±•å†…å®¹ã€‚</p>
</blockquote>
<p><code>io.netty.buffer.WrappedUnpooledUnsafeDirectByteBuf</code> ï¼Œç»§æ‰¿ UnpooledUnsafeDirectByteBuf ç±»ï¼ŒåŸºäº <code>memoryAddress</code> å†…å­˜åœ°å€ï¼Œåˆ›å»º Direct ByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WrappedUnpooledUnsafeDirectByteBuf</span> <span class="keyword">extends</span> <span class="title">UnpooledUnsafeDirectByteBuf</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŸºäº memoryAddress å†…å­˜åœ°å€ï¼Œåˆ›å»º Direct ByteBuf å¯¹è±¡</span></span><br><span class="line">    WrappedUnpooledUnsafeDirectByteBuf(ByteBufAllocator alloc, <span class="keyword">long</span> memoryAddress, <span class="keyword">int</span> size, <span class="keyword">boolean</span> doFree) {</span><br><span class="line">        <span class="keyword">super</span>(alloc, PlatformDependent.directBuffer(memoryAddress, size) <span class="comment">/** åˆ›å»º Direct ByteBuf å¯¹è±¡ **/</span>, size, doFree);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">freeDirect</span><span class="params">(ByteBuffer buffer)</span> </span>{</span><br><span class="line">        PlatformDependent.freeMemory(memoryAddress);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>FROM <a href="https://www.jianshu.com/p/b833254908f7" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNettyæºç åˆ†æï¼ˆä¸€ï¼‰ ByteBufã€‹</a></p>
<p>åˆ›å»ºä¸€ä¸ªæŒ‡å®šå†…å­˜åœ°å€çš„UnpooledUnsafeDirectByteBufï¼Œè¯¥å†…å­˜å—å¯èƒ½å·²è¢«å†™å…¥æ•°æ®ä»¥å‡å°‘ä¸€æ­¥æ‹·è´æ“ä½œã€‚</p>
</blockquote>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ¯æ¬¡è¿™ç§ N å¤šå®ç°ç±»çš„æºç è§£æï¼Œå†™åˆ° 60% çš„æ—¶å€™ï¼Œå°±ç‰¹åˆ«å¤´ç–¼ã€‚ä¸æ˜¯å› ä¸ºéš¾å†™ï¼Œæ˜¯å› ä¸ºåŸºæœ¬æ˜¯ç»„åˆæ’åˆ—ï¼Œä¸æ–­åœ¨å•°å—¦å•°å—¦å•°å—¦çš„æ„Ÿè§‰ã€‚</p>
<p>å—¯å—¯ï¼Œå¦‚æœæœ‰åœ°æ–¹å†™çš„é”™ä¹±ï¼Œçƒ¦è¯·æŒ‡å‡ºã€‚é»˜é»˜å† review å‡ éã€‚</p>
<hr>
<p>æ¨èé˜…è¯»æ–‡ç« ï¼š</p>
<ul>
<li>HryReal <a href="https://blog.csdn.net/qq_33394088/article/details/72763305" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠPooledByteBufæºç åˆ†æã€‹</a></li>
<li>æ±Ÿå—ç™½è¡£ <a href="http://calvin1978.blogcn.com/articles/directbytebuffer.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNettyä¹‹Javaå †å¤–å†…å­˜æ‰«ç›²è´´ã€‹</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/ByteBuf-1-2-ByteBuf-core-impl/" data-id="ck4pl3fp400e0fgcfxmedsoke" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>