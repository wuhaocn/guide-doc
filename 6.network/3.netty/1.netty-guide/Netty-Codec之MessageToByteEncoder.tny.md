<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” Codec ä¹‹ MessageToByteEncoder
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥åˆ†äº« MessageToByteEncoder éƒ¨åˆ†çš„å†…å®¹ã€‚</p>
<p>MessageToByteEncoder è´Ÿè´£å°†æ¶ˆæ¯<strong>ç¼–ç </strong>æˆå­—èŠ‚ã€‚æ ¸å¿ƒç±»å›¾å¦‚ä¸‹ï¼š</p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_12_18/01.png" title="æ ¸å¿ƒç±»å›¾" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_12_18/01.png" alt="æ ¸å¿ƒç±»å›¾"></a><span class="caption">æ ¸å¿ƒç±»å›¾</span></p>
<p>ByteToMessageDecoder æœ¬èº«æ˜¯ä¸ª<strong>æŠ½è±¡</strong>ç±»ï¼Œå…¶ä¸‹æœ‰å¤šä¸ªå­ç±»ï¼Œç¬”è€…ç®€å•æ•´ç†æˆä¸¤ç±»ï¼Œå¯èƒ½ä¸å…¨å“ˆï¼š</p>
<ul>
<li><strong>è“æ¡†</strong>éƒ¨åˆ†ï¼Œå°†æ¶ˆæ¯<strong>å‹ç¼©</strong>ï¼Œä¸»è¦æ¶‰åŠç›¸å…³å‹ç¼©ç®—æ³•ï¼Œä¾‹å¦‚ï¼šGZipã€BZip ç­‰ç­‰ã€‚<ul>
<li>å®ƒè¦æ±‚æ¶ˆæ¯ç±»å‹æ˜¯ ByteBuf ï¼Œå°†å·²ç»è½¬åŒ–å¥½çš„å­—èŠ‚æµï¼Œè¿›ä¸€æ­¥å‹ç¼©ã€‚</li>
</ul>
</li>
<li><strong>é»„æ¡†</strong>éƒ¨åˆ†ï¼Œå°†æ¶ˆæ¯ä½¿ç”¨<strong>æŒ‡å®šåºåˆ—åŒ–æ–¹å¼</strong>åºåˆ—åŒ–æˆå­—èŠ‚ã€‚ä¾‹å¦‚ï¼šJSONã€XML ç­‰ç­‰ã€‚<ul>
<li>å› ä¸º Netty æ²¡æœ‰å†…ç½®çš„ JSONã€XML ç­‰ç›¸å…³çš„ç±»åº“ï¼Œæ‰€ä»¥ä¸å¥½æä¾›ç±»ä¼¼ JSONEncoder æˆ– XMLEncoder ï¼Œæ‰€ä»¥å›¾ä¸­ç¬”è€…å°±ä½¿ç”¨ <code>netty-example</code> æä¾›çš„ NumberEncoder ã€‚</li>
</ul>
</li>
</ul>
<p>åœ¨ <a href="http://svip.iocoder.cn/Netty/Codec-1-1-ByteToMessageDecoder-core-impl">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Codec ä¹‹ ByteToMessageDecoderï¼ˆä¸€ï¼‰Cumulatorã€‹</a> ä¸­ï¼Œæˆ‘ä»¬æåˆ°<strong>ç²˜åŒ…æ‹†åŒ…</strong>çš„ç°è±¡ï¼Œæ‰€ä»¥åœ¨å®é™…ä½¿ç”¨ Netty ç¼–ç æ¶ˆæ¯æ—¶ï¼Œè¿˜éœ€è¦æœ‰ä¸ºäº†è§£å†³<strong>ç²˜åŒ…æ‹†åŒ…</strong>çš„ Encoder å®ç°ç±»ï¼Œä¾‹å¦‚ï¼šæ¢è¡Œã€å®šé•¿ç­‰ç­‰æ–¹å¼ã€‚å…³äºè¿™å—å†…å®¹ï¼Œèƒ–å‹å¯ä»¥çœ‹çœ‹ <a href="https://www.codetd.com/article/1539061" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnettyä½¿ç”¨MessageToByteEncoder è‡ªå®šä¹‰åè®®ã€‹</a> ã€‚</p>
<h1 id="2-MessageToByteEncoder"><a href="#2-MessageToByteEncoder" class="headerlink" title="2. MessageToByteEncoder"></a>2. MessageToByteEncoder</h1><p><code>io.netty.handler.codec.MessageToByteEncoder</code> ï¼Œç»§æ‰¿ ChannelOutboundHandlerAdapter ç±»ï¼Œè´Ÿè´£å°†æ¶ˆæ¯<strong>ç¼–ç </strong>æˆå­—èŠ‚ï¼Œæ”¯æŒ<strong>åŒ¹é…æŒ‡å®šç±»å‹</strong>çš„æ¶ˆæ¯ã€‚</p>
<h2 id="2-1-æ„é€ æ–¹æ³•"><a href="#2-1-æ„é€ æ–¹æ³•" class="headerlink" title="2.1 æ„é€ æ–¹æ³•"></a>2.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageToByteEncoder</span>&lt;<span class="title">I</span>&gt; <span class="keyword">extends</span> <span class="title">ChannelOutboundHandlerAdapter</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç±»å‹åŒ¹é…å™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TypeParameterMatcher matcher;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ˜¯å¦åå‘ä½¿ç”¨ Direct å†…å­˜</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> preferDirect;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">MessageToByteEncoder</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(<span class="keyword">true</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">MessageToByteEncoder</span><span class="params">(Class&lt;? extends I&gt; outboundMessageType)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(outboundMessageType, <span class="keyword">true</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">MessageToByteEncoder</span><span class="params">(<span class="keyword">boolean</span> preferDirect)</span> </span>{</span><br><span class="line">        <span class="comment">// &lt;1&gt; è·å¾— matcher</span></span><br><span class="line">        matcher = TypeParameterMatcher.find(<span class="keyword">this</span>, MessageToByteEncoder.class, <span class="string">"I"</span>);</span><br><span class="line">        <span class="keyword">this</span>.preferDirect = preferDirect;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">MessageToByteEncoder</span><span class="params">(Class&lt;? extends I&gt; outboundMessageType, <span class="keyword">boolean</span> preferDirect)</span> </span>{</span><br><span class="line">        <span class="comment">// &lt;2&gt; è·å¾— matcher</span></span><br><span class="line">        matcher = TypeParameterMatcher.get(outboundMessageType);</span><br><span class="line">        <span class="keyword">this</span>.preferDirect = preferDirect;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... çœç•¥å…¶ä»–æ— å…³ä»£ç </span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>matcher</code> å±æ€§ï¼Œæœ‰<strong>ä¸¤ç§</strong>æ–¹å¼èµ‹å€¼ã€‚<ul>
<li>ã€å¸¸ç”¨ã€‘<code>&lt;1&gt;</code> å¤„ï¼Œä½¿ç”¨ç±»çš„ <code>I</code> æ³›å‹å¯¹åº”çš„ TypeParameterMatcher ç±»å‹åŒ¹é…å™¨ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œä½¿ç”¨ <code>inboundMessageType</code> å‚æ•°å¯¹åº”çš„ TypeParameterMatcher ç±»å‹åŒ¹é…å™¨ã€‚</li>
<li>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸å¤ªéœ€è¦ç‰¹åˆ«è¯¦ç»†çš„äº†è§£ <code>io.netty.util.internal.TypeParameterMatcher</code> çš„ä»£ç å®ç°ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹å¯ä»¥è‡ªå·±çœ‹çœ‹ <a href="http://donald-draper.iteye.com/blog/2387772" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnetty ç®€å•Inboundé€šé“å¤„ç†å™¨ï¼ˆSimpleChannelInboundHandlerï¼‰ã€‹</a> çš„ <a href="#">ã€ŒTypeParameterMatcherã€</a> éƒ¨åˆ†ã€‚</li>
</ul>
</li>
<li><code>preferDirect</code> å±æ€§ï¼Œæ˜¯å¦åå‘ä½¿ç”¨ Direct å†…å­˜ã€‚é»˜è®¤ä¸º <code>true</code> ã€‚</li>
</ul>
<h2 id="2-2-acceptInboundMessage"><a href="#2-2-acceptInboundMessage" class="headerlink" title="2.2 acceptInboundMessage"></a>2.2 acceptInboundMessage</h2><p><code>#acceptInboundMessage(Object msg)</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ¶ˆæ¯æ˜¯å¦åŒ¹é…ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns {<span class="doctag">@code</span> true} if the given message should be handled. If {<span class="doctag">@code</span> false} it will be passed to the next</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> ChannelInboundHandler} in the {<span class="doctag">@link</span> ChannelPipeline}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">acceptInboundMessage</span><span class="params">(Object msg)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> matcher.match(msg);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ<code>matcher</code> çš„ç±»å‹æ˜¯ ReflectiveMatcher( å®ƒæ˜¯ TypeParameterMatcher çš„å†…éƒ¨ç±» )ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReflectiveMatcher</span> <span class="keyword">extends</span> <span class="title">TypeParameterMatcher</span> </span>{</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç±»å‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; type;</span><br><span class="line">    </span><br><span class="line">    ReflectiveMatcher(Class&lt;?&gt; type) {</span><br><span class="line">        <span class="keyword">this</span>.type = type;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">match</span><span class="params">(Object msg)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> type.isInstance(msg); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åŒ¹é…é€»è¾‘ï¼Œçœ‹ <code>&lt;1&gt;</code> å¤„ï¼Œä½¿ç”¨ <code>Class#isInstance(Object obj)</code> æ–¹æ³•ã€‚å¯¹äºè¿™ä¸ªæ–¹æ³•ï¼Œå¦‚æœæˆ‘ä»¬å®šä¹‰çš„ <code>I</code> æ³›å‹æ˜¯ä¸ªçˆ¶ç±»ï¼Œé‚£å¯ä»¥åŒ¹é…æ‰€æœ‰çš„å­ç±»ã€‚ä¾‹å¦‚ <code>I</code> è®¾ç½®ä¸º Object ç±»ï¼Œé‚£ä¹ˆæ‰€æœ‰æ¶ˆæ¯ï¼Œéƒ½å¯ä»¥è¢«åŒ¹é…åˆ—ã€‚</li>
</ul>
<h2 id="2-3-write"><a href="#2-3-write" class="headerlink" title="2.3 write"></a>2.3 write</h2><p><code>#write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</code> æ–¹æ³•ï¼ŒåŒ¹é…æŒ‡å®šçš„æ¶ˆæ¯ç±»å‹ï¼Œç¼–ç æ¶ˆæ¯æˆ ByteBuf å¯¹è±¡ï¼Œç»§ç»­å†™åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"> <span class="number">3</span>:     ByteBuf buf = <span class="keyword">null</span>;</span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">5</span>:         <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºåŒ¹é…çš„æ¶ˆæ¯</span></span><br><span class="line"> <span class="number">6</span>:         <span class="keyword">if</span> (acceptOutboundMessage(msg)) {</span><br><span class="line"> <span class="number">7</span>:             <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"> <span class="number">8</span>:             I cast = (I) msg;</span><br><span class="line"> <span class="number">9</span>:             <span class="comment">// ç”³è¯· buf</span></span><br><span class="line"><span class="number">10</span>:             buf = allocateBuffer(ctx, cast, preferDirect);</span><br><span class="line"><span class="number">11</span>:             <span class="comment">// ç¼–ç </span></span><br><span class="line"><span class="number">12</span>:             <span class="keyword">try</span> {</span><br><span class="line"><span class="number">13</span>:                 encode(ctx, cast, buf);</span><br><span class="line"><span class="number">14</span>:             } <span class="keyword">finally</span> {</span><br><span class="line"><span class="number">15</span>:                 <span class="comment">// é‡Šæ”¾ msg</span></span><br><span class="line"><span class="number">16</span>:                 ReferenceCountUtil.release(cast);</span><br><span class="line"><span class="number">17</span>:             }</span><br><span class="line"><span class="number">18</span>: </span><br><span class="line"><span class="number">19</span>:             <span class="comment">// buf å¯è¯»ï¼Œè¯´æ˜æœ‰ç¼–ç åˆ°æ•°æ®</span></span><br><span class="line"><span class="number">20</span>:             <span class="keyword">if</span> (buf.isReadable()) {</span><br><span class="line"><span class="number">21</span>:                 <span class="comment">// å†™å…¥ buf åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="number">22</span>:                 ctx.write(buf, promise);</span><br><span class="line"><span class="number">23</span>:             } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">24</span>:                 <span class="comment">// é‡Šæ”¾ buf</span></span><br><span class="line"><span class="number">25</span>:                 buf.release();</span><br><span class="line"><span class="number">26</span>:                 <span class="comment">// å†™å…¥ EMPTY_BUFFER åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸ºäº† promise çš„å›è°ƒ</span></span><br><span class="line"><span class="number">27</span>:                 ctx.write(Unpooled.EMPTY_BUFFER, promise);</span><br><span class="line"><span class="number">28</span>:             }</span><br><span class="line"><span class="number">29</span>: </span><br><span class="line"><span class="number">30</span>:             <span class="comment">// ç½®ç©º buf</span></span><br><span class="line"><span class="number">31</span>:             buf = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">32</span>:         } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">33</span>:             <span class="comment">// æäº¤ write äº‹ä»¶ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="number">34</span>:             ctx.write(msg, promise);</span><br><span class="line"><span class="number">35</span>:         }</span><br><span class="line"><span class="number">36</span>:     } <span class="keyword">catch</span> (EncoderException e) {</span><br><span class="line"><span class="number">37</span>:         <span class="keyword">throw</span> e;</span><br><span class="line"><span class="number">38</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br><span class="line"><span class="number">39</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> EncoderException(e);</span><br><span class="line"><span class="number">40</span>:     } <span class="keyword">finally</span> {</span><br><span class="line"><span class="number">41</span>:         <span class="comment">// é‡Šæ”¾ buf</span></span><br><span class="line"><span class="number">42</span>:         <span class="keyword">if</span> (buf != <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">43</span>:             buf.release();</span><br><span class="line"><span class="number">44</span>:         }</span><br><span class="line"><span class="number">45</span>:     }</span><br><span class="line"><span class="number">46</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 6 è¡Œï¼šè°ƒç”¨ <code>#acceptInboundMessage(Object msg)</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºåŒ¹é…çš„æ¶ˆæ¯ã€‚</li>
<li><p>â‘  ç¬¬ 6 è¡Œï¼š<strong>åŒ¹é…</strong>ã€‚</p>
<ul>
<li>ç¬¬ 8 è¡Œï¼šå¯¹è±¡ç±»å‹è½¬åŒ–ä¸º <code>I</code> ç±»å‹çš„æ¶ˆæ¯ã€‚</li>
<li><p>ç¬¬ 10 è¡Œï¼šè°ƒç”¨ <code>#allocateBuffer(ChannelHandlerContext ctx, I msg, boolean preferDirect)</code> æ–¹æ³•ï¼Œç”³è¯· <code>buf</code> ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Allocate a {<span class="doctag">@link</span> ByteBuf} which will be used as argument of {<span class="doctag">@link</span> #encode(ChannelHandlerContext, I, ByteBuf)}.</span></span><br><span class="line"><span class="comment"> * Sub-classes may override this method to return {<span class="doctag">@link</span> ByteBuf} with a perfect matching {<span class="doctag">@code</span> initialCapacity}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ByteBuf <span class="title">allocateBuffer</span><span class="params">(ChannelHandlerContext ctx, @SuppressWarnings(<span class="string">"unused"</span>)</span> I msg, <span class="keyword">boolean</span> preferDirect) <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (preferDirect) {</span><br><span class="line">        <span class="keyword">return</span> ctx.alloc().ioBuffer();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> ctx.alloc().heapBuffer();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>x</li>
</ul>
</li>
<li><p>ç¬¬ 13 è¡Œï¼šè°ƒç”¨ <code>#encode(ChannelHandlerContext ctx, I msg, ByteBuf out)</code> æ–¹æ³•ï¼Œç¼–ç ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Encode a message into a {<span class="doctag">@link</span> ByteBuf}. This method will be called for each written message that can be handled</span></span><br><span class="line"><span class="comment"> * by this encoder.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ctx           the {<span class="doctag">@link</span> ChannelHandlerContext} which this {<span class="doctag">@link</span> MessageToByteEncoder} belongs to</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> msg           the message to encode</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> out           the {<span class="doctag">@link</span> ByteBuf} into which the encoded message will be written</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception    is thrown if an error occurs</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, I msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å­ç±»å¯ä»¥å®ç°è¯¥æ–¹æ³•ï¼Œå®ç°è‡ªå®šä¹‰çš„ç¼–ç åŠŸèƒ½ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 16 è¡Œï¼šè°ƒç”¨ <code>ReferenceCountUtil#release(Object msg)</code> æ–¹æ³•ï¼Œé‡Šæ”¾ <code>msg</code> ã€‚</p>
</li>
<li>ç¬¬ 19 è‡³ 22 è¡Œï¼š<code>buf</code> å¯è¯»ï¼Œè¯´æ˜ç¼–ç æ¶ˆæ¯åˆ° <code>buf</code> ä¸­äº†ï¼Œæ‰€ä»¥å†™å…¥ <code>buf</code> åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ğŸ˜ˆ å› ä¸º <code>buf</code> éœ€è¦ç»§ç»­è¢«ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä½¿ç”¨ï¼Œæ‰€ä»¥ä¸è¿›è¡Œé‡Šæ”¾ã€‚</li>
<li>ç¬¬ 23 è‡³ 28 è¡Œï¼š<code>buf</code> ä¸å¯è¯»ï¼Œè¯´æ˜æ— æ³•ç¼–ç ï¼Œæ‰€ä»¥é‡Šæ”¾ <code>buf</code> ï¼Œå¹¶å†™å…¥ <code>EMPTY_BUFFER</code> åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸ºäº† promise çš„å›è°ƒã€‚</li>
<li>ç¬¬ 31 è¡Œï¼šç½®ç©º <code>buf</code> ä¸ºç©ºã€‚è¿™é‡Œæ˜¯ä¸ºäº†é˜²æ­¢ã€ç¬¬ 41 è‡³ 44 è¡Œã€‘çš„ä»£ç ï¼Œé‡Šæ”¾ <code>buf</code> ã€‚</li>
</ul>
</li>
<li>â‘¡ ç¬¬ 32 è¡Œï¼š<strong>ä¸åŒ¹é…</strong>ã€‚<ul>
<li>æäº¤ write äº‹ä»¶ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li>
</ul>
</li>
<li>ç¬¬ 36 è‡³ 39 è¡Œï¼šå‘ç”Ÿå¼‚å¸¸ï¼ŒæŠ›å‡º EncoderException å¼‚å¸¸ã€‚</li>
<li>ç¬¬ 40 è‡³ 45 è¡Œï¼šå¦‚æœä¸­é—´å‘ç”Ÿå¼‚å¸¸ï¼Œå¯¼è‡´ <code>buf</code> ä¸ä¸ºç©ºï¼Œæ‰€ä»¥æ­¤å¤„é‡Šæ”¾ <code>buf</code> ã€‚</li>
</ul>
<h1 id="3-NumberEncoder"><a href="#3-NumberEncoder" class="headerlink" title="3. NumberEncoder"></a>3. NumberEncoder</h1><p><code>io.netty.example.factorial.NumberEncoder</code> ï¼Œç»§æ‰¿ MessageToByteEncoder æŠ½è±¡ç±»ï¼ŒNumber ç±»å‹çš„æ¶ˆæ¯çš„ Encoder å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>NumberEncoder æ˜¯ <code>netty-example</code> æ¨¡å—æä¾›çš„ç¤ºä¾‹ç±»ï¼Œå®é™…ä½¿ç”¨æ—¶ï¼Œéœ€è¦åšè°ƒæ•´ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NumberEncoder</span> <span class="keyword">extends</span> <span class="title">MessageToByteEncoder</span>&lt;<span class="title">Number</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, Number msg, ByteBuf out)</span> </span>{</span><br><span class="line">        <span class="comment">// &lt;1&gt; è½¬åŒ–æˆ BigInteger å¯¹è±¡</span></span><br><span class="line">        <span class="comment">// Convert to a BigInteger first for easier implementation.</span></span><br><span class="line">        BigInteger v;</span><br><span class="line">        <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> BigInteger) {</span><br><span class="line">            v = (BigInteger) msg;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            v = <span class="keyword">new</span> BigInteger(String.valueOf(msg));</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &lt;2&gt; è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„</span></span><br><span class="line">        <span class="comment">// Convert the number into a byte array.</span></span><br><span class="line">        <span class="keyword">byte</span>[] data = v.toByteArray();</span><br><span class="line">        <span class="keyword">int</span> dataLength = data.length;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &lt;3&gt; Write a message.</span></span><br><span class="line">        out.writeByte((<span class="keyword">byte</span>) <span class="string">'F'</span>); <span class="comment">// magic number</span></span><br><span class="line">        out.writeInt(dataLength);  <span class="comment">// data length</span></span><br><span class="line">        out.writeBytes(data);      <span class="comment">// data</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè½¬åŒ–æ¶ˆæ¯ç±»å‹ä¸º BigInteger å¯¹è±¡ï¼Œæ–¹ä¾¿ç»Ÿä¸€å¤„ç†ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œè½¬åŒ–ä¸ºå­—èŠ‚æ•°ç»„ã€‚</li>
<li><code>&lt;3&gt;</code> å¤„<ul>
<li>é¦–ä½ï¼Œå†™å…¥ magic number ï¼Œæ–¹ä¾¿åŒºåˆ†<strong>ä¸åŒç±»å‹</strong>çš„æ¶ˆæ¯ã€‚ä¾‹å¦‚è¯´ï¼Œåé¢å¦‚æœæœ‰ Double ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ <code>D</code> ï¼›String ç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ <code>S</code> ã€‚</li>
<li>åä¸¤ä½ï¼Œå†™å…¥ data length + data ã€‚å¦‚æœæ²¡æœ‰ data length ï¼Œé‚£ä¹ˆæ•°ç»„å†…å®¹ï¼Œæ˜¯æ— æ³•è¯»å–çš„ã€‚</li>
</ul>
</li>
</ul>
<p>å®é™…ä¸€èˆ¬ä¸é‡‡ç”¨ NumberEncoder çš„æ–¹å¼ï¼Œå› ä¸º POJO ç±»å‹ä¸å¥½æ”¯æŒã€‚å…³äºè¿™ä¸€å—ï¼Œå¯ä»¥å‚çœ‹ä¸‹ï¼š</p>
<ul>
<li>Dubbo</li>
<li>Motan</li>
<li>Sofa-RPC</li>
</ul>
<p>å¯¹ Encoder å’Œ Codec çœŸæ­£å®æˆ˜ã€‚hoho</p>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>MessageToByteEncoder ç›¸æ¯” ByteToMessageDecoder æ¥è¯´ï¼Œç®€å•å¥½å¤šã€‚</p>
<p>æ¨èé˜…è¯»æ–‡ç« ï¼š</p>
<ul>
<li>Hypercube <a href="https://www.jianshu.com/p/7c439cc7b01c" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆå…«ï¼‰â€“CodecHandlerã€‹</a></li>
</ul>
<p>å¦å¤–ï¼Œå¯èƒ½å¾ˆå¤šèƒ–å‹ï¼Œçœ‹å®Œ Encoder å’Œ Decoder ï¼Œè¿˜æ˜¯ä¸€è„¸æ‡µé€¼ï¼Œä¸çŸ¥é“å®é™…å¦‚ä½•ä½¿ç”¨ã€‚å¯ä»¥åœ¨ç½‘ç»œä¸Šï¼Œå† Google ä¸€äº›èµ„æ–™ï¼Œä¸è¦æ–¹ï¼Œä¸è¦æ€•ã€‚</p>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/Codec-2-1-MessageToByteEncoder-core-impl/" data-id="ck4pl3fpb00ejfgcflqmv8t0y" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>