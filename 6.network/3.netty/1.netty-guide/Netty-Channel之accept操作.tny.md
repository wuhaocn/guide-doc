<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” Channelï¼ˆäºŒï¼‰ä¹‹ accept æ“ä½œ
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« Netty NIO æœåŠ¡ç«¯ NioServerSocketChannel æ¥å—( <strong>accept</strong> )å®¢æˆ·ç«¯è¿æ¥çš„è¿‡ç¨‹ã€‚ç®€å•æ¥è¯´ï¼š</p>
<ol>
<li>æœåŠ¡ç«¯ NioServerSocketChannel çš„ boss EventLoop çº¿ç¨‹è½®è¯¢æ˜¯å¦æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥æ¥å…¥ã€‚</li>
<li>å½“è½®è¯¢åˆ°æœ‰æ–°çš„è¿æ¥æ¥å…¥ï¼Œå°è£…è¿å…¥çš„å®¢æˆ·ç«¯çš„ SocketChannel ä¸º Netty NioSocketChannel å¯¹è±¡ã€‚</li>
<li>é€‰æ‹©ä¸€ä¸ªæœåŠ¡ç«¯ NioServerSocketChannel çš„ worker EventLoop ï¼Œå°†å®¢æˆ·ç«¯çš„ NioSocketChannel æ³¨å†Œåˆ°å…¶ä¸Šã€‚å¹¶ä¸”ï¼Œæ³¨å†Œå®¢æˆ·ç«¯çš„ NioSocketChannel çš„è¯»äº‹ä»¶ï¼Œå¼€å§‹è½®è¯¢è¯¥å®¢æˆ·ç«¯æ˜¯å¦æœ‰æ•°æ®å†™å…¥ã€‚</li>
</ol>
<p>ä¸‹é¢ï¼Œè®©æˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“çš„ä»£ç å®ç°ã€‚</p>
<h1 id="2-NioMessageUnsafe-read"><a href="#2-NioMessageUnsafe-read" class="headerlink" title="2. NioMessageUnsafe#read"></a>2. NioMessageUnsafe#read</h1><blockquote>
<p>è€è‰¿è‰¿ï¼šæœ‰ç‚¹ä¸çŸ¥é“æ€ä¹ˆå–æ ‡é¢˜å¥½ï¼Œç›´æ¥ç”¨æ–¹æ³•åå§ã€‚</p>
</blockquote>
<p>åœ¨ NioEventLoop çš„ <code>#processSelectedKey(SelectionKey k, AbstractNioChannel ch)</code> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è¿™æ ·ä¸€æ®µä»£ç ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// SelectionKey.OP_READ æˆ– SelectionKey.OP_ACCEPT å°±ç»ª</span></span><br><span class="line"><span class="comment">// readyOps == 0 æ˜¯å¯¹ JDK Bug çš„å¤„ç†ï¼Œé˜²æ­¢ç©ºçš„æ­»å¾ªç¯</span></span><br><span class="line"><span class="comment">// Also check for readOps of 0 to workaround possible JDK bug which may otherwise lead</span></span><br><span class="line"><span class="comment">// to a spin loop</span></span><br><span class="line"><span class="keyword">if</span> ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != <span class="number">0</span> || readyOps == <span class="number">0</span>) {</span><br><span class="line">    unsafe.read();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å½“ <code>(readyOps &amp; SelectionKey.OP_ACCEPT) != 0</code> æ—¶ï¼Œè¿™å°±æ˜¯æœåŠ¡ç«¯ NioServerSocketChannel çš„ boss EventLoop çº¿ç¨‹<strong>è½®è¯¢åˆ°</strong>æœ‰æ–°çš„å®¢æˆ·ç«¯è¿æ¥æ¥å…¥ã€‚</li>
<li>ç„¶åï¼Œè°ƒç”¨ <code>NioMessageUnsafe#read()</code> æ–¹æ³•ï¼Œâ€œè¯»å–â€( ğŸ˜ˆ è¿™ä¸ªæŠ½è±¡å¾ˆçµæ€§ )æ–°çš„å®¢æˆ·ç«¯è¿æ¥è¿å…¥ã€‚</li>
</ul>
<hr>
<p><code>NioMessageUnsafe#read()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NioMessageUnsafe</span> <span class="keyword">extends</span> <span class="title">AbstractNioUnsafe</span> </span>{</span><br><span class="line"> <span class="number">2</span>: </span><br><span class="line"> <span class="number">3</span>:     <span class="comment">/**</span></span><br><span class="line"><span class="comment"> 4:      * æ–°è¯»å–çš„å®¢æˆ·ç«¯è¿æ¥æ•°ç»„</span></span><br><span class="line"><span class="comment"> 5:      */</span></span><br><span class="line"> <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Object&gt; readBuf = <span class="keyword">new</span> ArrayList&lt;Object&gt;();</span><br><span class="line"> <span class="number">7</span>: </span><br><span class="line"> <span class="number">8</span>:     <span class="meta">@SuppressWarnings</span>(<span class="string">"Duplicates"</span>)</span><br><span class="line"> <span class="number">9</span>:     <span class="meta">@Override</span></span><br><span class="line"><span class="number">10</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="number">11</span>:         <span class="function"><span class="keyword">assert</span> <span class="title">eventLoop</span><span class="params">()</span>.<span class="title">inEventLoop</span><span class="params">()</span></span>;</span><br><span class="line"><span class="number">12</span>:         <span class="keyword">final</span> ChannelConfig config = config();</span><br><span class="line"><span class="number">13</span>:         <span class="keyword">final</span> ChannelPipeline pipeline = pipeline();</span><br><span class="line"><span class="number">14</span>:         <span class="comment">// è·å¾— RecvByteBufAllocator.Handle å¯¹è±¡</span></span><br><span class="line"><span class="number">15</span>:         <span class="keyword">final</span> RecvByteBufAllocator.Handle allocHandle = unsafe().recvBufAllocHandle();</span><br><span class="line"><span class="number">16</span>:         <span class="comment">// é‡ç½® RecvByteBufAllocator.Handle å¯¹è±¡</span></span><br><span class="line"><span class="number">17</span>:         allocHandle.reset(config);</span><br><span class="line"><span class="number">18</span>: </span><br><span class="line"><span class="number">19</span>:         <span class="keyword">boolean</span> closed = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">20</span>:         Throwable exception = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">21</span>:         <span class="keyword">try</span> {</span><br><span class="line"><span class="number">22</span>:             <span class="keyword">try</span> {</span><br><span class="line"><span class="number">23</span>:                 <span class="keyword">do</span> {</span><br><span class="line"><span class="number">24</span>:                     <span class="comment">// è¯»å–å®¢æˆ·ç«¯çš„è¿æ¥åˆ° readBuf ä¸­</span></span><br><span class="line"><span class="number">25</span>:                     <span class="keyword">int</span> localRead = doReadMessages(readBuf);</span><br><span class="line"><span class="number">26</span>:                     <span class="comment">// æ— å¯è¯»å–çš„å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œç»“æŸ</span></span><br><span class="line"><span class="number">27</span>:                     <span class="keyword">if</span> (localRead == <span class="number">0</span>) {</span><br><span class="line"><span class="number">28</span>:                         <span class="keyword">break</span>;</span><br><span class="line"><span class="number">29</span>:                     }</span><br><span class="line"><span class="number">30</span>:                     <span class="comment">// è¯»å–å‡ºé”™</span></span><br><span class="line"><span class="number">31</span>:                     <span class="keyword">if</span> (localRead &lt; <span class="number">0</span>) {</span><br><span class="line"><span class="number">32</span>:                         closed = <span class="keyword">true</span>; <span class="comment">// æ ‡è®°å…³é—­</span></span><br><span class="line"><span class="number">33</span>:                         <span class="keyword">break</span>;</span><br><span class="line"><span class="number">34</span>:                     }</span><br><span class="line"><span class="number">35</span>: </span><br><span class="line"><span class="number">36</span>:                     <span class="comment">// è¯»å–æ¶ˆæ¯æ•°é‡ + localRead</span></span><br><span class="line"><span class="number">37</span>:                     allocHandle.incMessagesRead(localRead);</span><br><span class="line"><span class="number">38</span>:                 } <span class="keyword">while</span> (allocHandle.continueReading()); <span class="comment">// å¾ªç¯åˆ¤æ–­æ˜¯å¦ç»§ç»­è¯»å–</span></span><br><span class="line"><span class="number">39</span>:             } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line"><span class="number">40</span>:                 <span class="comment">// è®°å½•å¼‚å¸¸</span></span><br><span class="line"><span class="number">41</span>:                 exception = t;</span><br><span class="line"><span class="number">42</span>:             }</span><br><span class="line"><span class="number">43</span>: </span><br><span class="line"><span class="number">44</span>:             <span class="comment">// å¾ªç¯ readBuf æ•°ç»„ï¼Œè§¦å‘ Channel read äº‹ä»¶åˆ° pipeline ä¸­ã€‚</span></span><br><span class="line"><span class="number">45</span>:             <span class="keyword">int</span> size = readBuf.size();</span><br><span class="line"><span class="number">46</span>:             <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i ++) {</span><br><span class="line"><span class="number">47</span>:                 <span class="comment">// TODO èŠ‹è‰¿</span></span><br><span class="line"><span class="number">48</span>:                 readPending = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">49</span>:                 <span class="comment">// åœ¨å†…éƒ¨ï¼Œä¼šé€šè¿‡ ServerBootstrapAcceptor ï¼Œå°†å®¢æˆ·ç«¯çš„ Netty NioSocketChannel æ³¨å†Œåˆ° EventLoop ä¸Š</span></span><br><span class="line"><span class="number">50</span>:                 pipeline.fireChannelRead(readBuf.get(i));</span><br><span class="line"><span class="number">51</span>:             }</span><br><span class="line"><span class="number">52</span>:             <span class="comment">// æ¸…ç©º readBuf æ•°ç»„</span></span><br><span class="line"><span class="number">53</span>:             readBuf.clear();</span><br><span class="line"><span class="number">54</span>:             <span class="comment">// è¯»å–å®Œæˆ</span></span><br><span class="line"><span class="number">55</span>:             allocHandle.readComplete();</span><br><span class="line"><span class="number">56</span>:             <span class="comment">// è§¦å‘ Channel readComplete äº‹ä»¶åˆ° pipeline ä¸­ã€‚</span></span><br><span class="line"><span class="number">57</span>:             pipeline.fireChannelReadComplete();</span><br><span class="line"><span class="number">58</span>: </span><br><span class="line"><span class="number">59</span>:             <span class="comment">// å‘ç”Ÿå¼‚å¸¸</span></span><br><span class="line"><span class="number">60</span>:             <span class="keyword">if</span> (exception != <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">61</span>:                 <span class="comment">// åˆ¤æ–­æ˜¯å¦è¦å…³é—­ TODO èŠ‹è‰¿</span></span><br><span class="line"><span class="number">62</span>:                 closed = closeOnReadError(exception);</span><br><span class="line"><span class="number">63</span>: </span><br><span class="line"><span class="number">64</span>:                 <span class="comment">// è§¦å‘ exceptionCaught äº‹ä»¶åˆ° pipeline ä¸­ã€‚</span></span><br><span class="line"><span class="number">65</span>:                 pipeline.fireExceptionCaught(exception);</span><br><span class="line"><span class="number">66</span>:             }</span><br><span class="line"><span class="number">67</span>: </span><br><span class="line"><span class="number">68</span>:             <span class="keyword">if</span> (closed) {</span><br><span class="line"><span class="number">69</span>:                 <span class="comment">// TODO èŠ‹è‰¿</span></span><br><span class="line"><span class="number">70</span>:                 inputShutdown = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">71</span>:                 <span class="comment">// TODO èŠ‹è‰¿</span></span><br><span class="line"><span class="number">72</span>:                 <span class="keyword">if</span> (isOpen()) {</span><br><span class="line"><span class="number">73</span>:                     close(voidPromise());</span><br><span class="line"><span class="number">74</span>:                 }</span><br><span class="line"><span class="number">75</span>:             }</span><br><span class="line"><span class="number">76</span>:         } <span class="keyword">finally</span> {</span><br><span class="line"><span class="number">77</span>:             <span class="comment">// Check if there is a readPending which was not processed yet.</span></span><br><span class="line"><span class="number">78</span>:             <span class="comment">// This could be for two reasons:</span></span><br><span class="line"><span class="number">79</span>:             <span class="comment">// * The user called Channel.read() or ChannelHandlerContext.read() in channelRead(...) method</span></span><br><span class="line"><span class="number">80</span>:             <span class="comment">// * The user called Channel.read() or ChannelHandlerContext.read() in channelReadComplete(...) method</span></span><br><span class="line"><span class="number">81</span>:             <span class="comment">//</span></span><br><span class="line"><span class="number">82</span>:             <span class="comment">// See https://github.com/netty/netty/issues/2254</span></span><br><span class="line"><span class="number">83</span>:             <span class="comment">// TODO èŠ‹è‰¿</span></span><br><span class="line"><span class="number">84</span>:             <span class="keyword">if</span> (!readPending &amp;&amp; !config.isAutoRead()) {</span><br><span class="line"><span class="number">85</span>:                 removeReadOp();</span><br><span class="line"><span class="number">86</span>:             }</span><br><span class="line"><span class="number">87</span>:         }</span><br><span class="line"><span class="number">88</span>:     }</span><br><span class="line"><span class="number">89</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ğŸ˜ˆ NioMessageUnsafe åªæœ‰ä¸€ä¸ª <code>#read()</code> æ–¹æ³•ï¼Œè€Œè¯¥æ–¹æ³•ï¼Œâ€œè¯»å–â€æ–°çš„å®¢æˆ·ç«¯è¿æ¥è¿å…¥ã€‚</li>
<li><p>ç¬¬ 15 è¡Œï¼šè°ƒç”¨ <code>Unsafe#recvBufAllocHandle()</code> æ–¹æ³•ï¼Œè·å¾— è·å¾— RecvByteBufAllocator.Handle å¯¹è±¡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿”å›çš„æ˜¯ AdaptiveRecvByteBufAllocator.HandleImpl å¯¹è±¡ã€‚å…³äºå®ƒçš„å†…å®¹ï¼Œæˆ‘ä»¬æ”¾åœ¨ ByteBuf ç›¸å…³çš„æ–‡ç« ï¼Œè¯¦ç»†è§£æã€‚</p>
<ul>
<li><p>ç¬¬ 17 è¡Œï¼šè°ƒç”¨ <code>DefaultMaxMessagesRecvByteBufAllocator.MaxMessageHandle#reset(ChannelConfig)</code> æ–¹æ³•ï¼Œé‡ç½® RecvByteBufAllocator.Handle å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">(ChannelConfig config)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.config = config; <span class="comment">// é‡ç½® ChannelConfig å¯¹è±¡</span></span><br><span class="line">    maxMessagePerRead = maxMessagesPerRead(); <span class="comment">// é‡ç½® maxMessagePerRead å±æ€§</span></span><br><span class="line">    totalMessages = totalBytesRead = <span class="number">0</span>; <span class="comment">// é‡ç½® totalMessages å’Œ totalBytesRead å±æ€§</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ³¨æ„ï¼ŒAdaptiveRecvByteBufAllocator.HandleImpl ç»§æ‰¿ DefaultMaxMessagesRecvByteBufAllocator.MaxMessageHandle æŠ½è±¡ç±»ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p>ç¬¬ 22 è‡³ 42 è¡Œï¼š<strong>while å¾ªç¯</strong> â€œè¯»å–â€æ–°çš„å®¢æˆ·ç«¯è¿æ¥è¿å…¥ã€‚</p>
<ul>
<li>ç¬¬ 25 è¡Œï¼š è°ƒç”¨ <code>NioServerSocketChannel#doReadMessages(List&lt;Object&gt; buf)</code> æ–¹æ³•ï¼Œè¯»å–å®¢æˆ·ç«¯çš„è¿æ¥åˆ° <code>readBuf</code> ä¸­ã€‚è¯¦ç»†è§£æï¼Œèƒ–å‹å…ˆè·³åˆ° <a href="#">ã€Œ3. AbstractNioMessageChannel#doReadMessagesã€</a> ä¸­ï¼Œçœ‹å®Œè®°å¾—å›åˆ°æ­¤å¤„ã€‚</li>
<li>ç¬¬ 25 è‡³ 29 è¡Œï¼šæ— å¯è¯»å–çš„å®¢æˆ·ç«¯çš„è¿æ¥ï¼Œç»“æŸå¾ªç¯ã€‚</li>
<li>ç¬¬ 30 è‡³ 34 è¡Œï¼šè¯»å–å‡ºé”™ï¼Œ<strong>æ ‡è®°å…³é—­æœåŠ¡ç«¯</strong>ï¼Œå¹¶ç»“æŸå¾ªç¯ã€‚ç›®å‰æˆ‘ä»¬çœ‹åˆ° <code>NioServerSocketChannel#doReadMessages(List&lt;Object&gt; buf)</code> æ–¹æ³•çš„å®ç°ï¼Œè¿”å›çš„ç»“æœåªä¼šå­˜åœ¨ 0 å’Œ 1 ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ä¼šå‡ºç°è¿™ç§æƒ…å†µã€‚ç¬”è€…åˆå»ç¿»äº†åˆ«çš„å®ç°ç±»ï¼Œä¾‹å¦‚ <code>NioDatagramChannel#doReadMessages(List&lt;Object&gt; buf)</code> æ–¹æ³•ï¼Œåœ¨å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä¼šè¿”å› -1 ã€‚</li>
<li><p>ç¬¬ 37 è¡Œï¼šè°ƒç”¨ <code>AdaptiveRecvByteBufAllocator.HandleImpl#incMessagesRead(int amt)</code> æ–¹æ³•ï¼Œè¯»å–æ¶ˆæ¯( å®¢æˆ·ç«¯ )æ•°é‡ + <code>localRead</code> ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">incMessagesRead</span><span class="params">(<span class="keyword">int</span> amt)</span> </span>{</span><br><span class="line">    totalMessages += amt;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¯¹äº AdaptiveRecvByteBufAllocator.HandleImpl æ¥è¯´ï¼Œè€ƒè™‘åˆ°<strong>æŠ½è±¡</strong>çš„éœ€è¦ï¼Œæ‰€ä»¥ç»Ÿä¸€ä½¿ç”¨â€œæ¶ˆæ¯â€çš„è¯´æ³•ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 38 è¡Œï¼šè°ƒç”¨ <code>AdaptiveRecvByteBufAllocator.HandleImpl#incMessagesRead(int amt)#continueReading()</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å¾ªç¯æ˜¯å¦ç»§ç»­ï¼Œè¯»å–( æ¥å— )æ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AdaptiveRecvByteBufAllocator.HandleImpl.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">continueReading</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> continueReading(defaultMaybeMoreSupplier);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// DefaultMaxMessagesRecvByteBufAllocator.MaxMessageHandle.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">continueReading</span><span class="params">(UncheckedBooleanSupplier maybeMoreDataSupplier)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> config.isAutoRead() &amp;&amp;</span><br><span class="line">           (!respectMaybeMoreData || maybeMoreDataSupplier.get()) &amp;&amp;</span><br><span class="line">           totalMessages &lt; maxMessagePerRead &amp;&amp;</span><br><span class="line">           totalBytesRead &gt; <span class="number">0</span>; <span class="comment">// &lt;1&gt;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å› ä¸º <code>&lt;1&gt;</code> å¤„ï¼Œæ­¤æ—¶ <code>totalBytesRead</code> ç­‰äº 0 ï¼Œæ‰€ä»¥ä¼šè¿”å› <strong>false</strong> ã€‚å› æ­¤ï¼Œå¾ªç¯ä¼šç»“æŸã€‚ä¹Ÿå› æ­¤ï¼Œå¯¹äº NioServerSocketChannel æ¥è¯´ï¼Œ<strong>æ¯æ¬¡åªæ¥å—ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯è¿æ¥</strong>ã€‚ğŸ˜ˆ å½“ç„¶ï¼Œå› ä¸ºæœåŠ¡ç«¯ NioServerSocketChannel å¯¹ <code>Selectionkey.OP_ACCEPT</code> äº‹ä»¶æ„Ÿå…´è¶£ï¼Œæ‰€ä»¥<strong>åç»­çš„æ–°çš„å®¢æˆ·ç«¯è¿æ¥è¿˜æ˜¯ä¼šè¢«æ¥å—çš„</strong>ã€‚</li>
</ul>
</li>
<li>ç¬¬ 39 è‡³ 42 è¡Œï¼šè¯»å–è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œè®°å½•è¯¥å¼‚å¸¸åˆ° <code>exception</code> ä¸­ï¼ŒåŒæ—¶ç»“æŸå¾ªç¯ã€‚</li>
</ul>
</li>
<li>ç¬¬ 44 è‡³ 51 è¡Œï¼šå¾ªç¯ <code>readBuf</code> æ•°ç»„ï¼Œè§¦å‘ Channel read äº‹ä»¶åˆ° pipeline ä¸­ã€‚<ul>
<li>ç¬¬ 48 è¡Œï¼šTODO èŠ‹è‰¿ ç»†èŠ‚</li>
<li>ç¬¬ 50 è¡Œï¼šè°ƒç”¨ <code>ChannelPipeline#fireChannelRead(Object msg)</code> æ–¹æ³•ï¼Œè§¦å‘ Channel read äº‹ä»¶åˆ° pipeline ä¸­ã€‚<ul>
<li><strong>æ³¨æ„</strong>ï¼Œä¼ å…¥çš„æ–¹æ³•å‚æ•°æ˜¯æ–°æ¥å—çš„å®¢æˆ·ç«¯ NioSocketChannel è¿æ¥ã€‚</li>
<li>åœ¨å†…éƒ¨ï¼Œä¼šé€šè¿‡ ServerBootstrapAcceptor ï¼Œå°†å®¢æˆ·ç«¯çš„ Netty NioSocketChannel æ³¨å†Œåˆ° EventLoop ä¸Šã€‚è¯¦ç»†è§£æï¼Œèƒ–å‹å…ˆè·³åˆ° <a href="#">ã€Œ4. ServerBootstrapAcceptorã€</a> ä¸­ï¼Œçœ‹å®Œè®°å¾—å›åˆ°æ­¤å¤„ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 53 è¡Œï¼šæ¸…ç©º <code>readBuf</code> æ•°ç»„ã€‚</li>
<li>ç¬¬ 55 è¡Œï¼šè°ƒç”¨ <code>RecvByteBufAllocator.Handle#readComplete()</code> æ–¹æ³•ï¼Œè¯»å–å®Œæˆã€‚æš‚æ— é‡è¦çš„é€»è¾‘ï¼Œä¸è¯¦ç»†è§£æã€‚</li>
<li><p>ç¬¬ 57 è¡Œï¼šè°ƒç”¨ <code>ChannelPipeline#fireChannelReadComplete()</code> æ–¹æ³•ï¼Œè§¦å‘ Channel readComplete äº‹ä»¶åˆ° pipeline ä¸­ã€‚</p>
<ul>
<li><em>å¦‚æœæœ‰éœ€è¦ï¼Œèƒ–å‹å¯ä»¥è‡ªå®šä¹‰å¤„ç†å™¨ï¼Œå¤„ç†è¯¥äº‹ä»¶ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸éœ€è¦</em>ã€‚</li>
<li><p>å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰ ChannelHandler è¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆä¼šè¢« pipeline ä¸­çš„å°¾èŠ‚ç‚¹  TailContext æ‰€å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// TailContext.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    onUnhandledInboundChannelReadComplete();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// DefaultChannelPipeline.java</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onUnhandledInboundChannelReadComplete</span><span class="params">()</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å…·ä½“çš„è°ƒç”¨æ˜¯<strong>ç©ºæ–¹æ³•</strong>ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 60 è‡³ 66 è¡Œï¼š<code>exception</code> éç©ºï¼Œè¯´æ˜åœ¨æ¥å—è¿æ¥è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ã€‚<ul>
<li>ç¬¬ 62 è¡Œï¼šTODO èŠ‹è‰¿ ç»†èŠ‚</li>
<li>ç¬¬ 65 è¡Œï¼š è°ƒç”¨ <code>ChannelPipeline#fireExceptionCaught(Throwable)</code> æ–¹æ³•ï¼Œè§¦å‘ exceptionCaught äº‹ä»¶åˆ° pipeline ä¸­ã€‚<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œä¼šä½¿ç”¨ ServerBootstrapAcceptor å¤„ç†è¯¥äº‹ä»¶ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ4.3 exceptionCaughtã€</a> ã€‚</li>
<li><em>å¦‚æœæœ‰éœ€è¦ï¼Œèƒ–å‹å¯ä»¥è‡ªå®šä¹‰å¤„ç†å™¨ï¼Œå¤„ç†è¯¥äº‹ä»¶ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸éœ€è¦</em>ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 68 è‡³ 75 è¡Œï¼šTODO èŠ‹è‰¿ ç»†èŠ‚</li>
<li>ç¬¬ 76 è‡³ 87 è¡Œï¼šTODO èŠ‹è‰¿ ç»†èŠ‚</li>
</ul>
<h1 id="3-AbstractNioMessageChannel-doReadMessages"><a href="#3-AbstractNioMessageChannel-doReadMessages" class="headerlink" title="3. AbstractNioMessageChannel#doReadMessages"></a>3. AbstractNioMessageChannel#doReadMessages</h1><p><code>doReadMessages(List&lt;Object&gt; buf)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè¯»å–å®¢æˆ·ç«¯çš„è¿æ¥åˆ°æ–¹æ³•å‚æ•° <code>buf</code> ä¸­ã€‚å®ƒæ˜¯ä¸€ä¸ª<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå®šä¹‰åœ¨ AbstractNioMessageChannel æŠ½è±¡ç±»ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Read messages into the given array and return the amount which was read.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">doReadMessages</span><span class="params">(List&lt;Object&gt; buf)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¿”å›å€¼ä¸ºè¯»å–åˆ°çš„æ•°é‡ã€‚</li>
</ul>
<p>NioServerSocketChannel å¯¹è¯¥æ–¹æ³•çš„å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">  <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">doReadMessages</span><span class="params">(List&lt;Object&gt; buf)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">  <span class="number">3</span>:     <span class="comment">// æ¥å—å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">  <span class="number">4</span>:     SocketChannel ch = SocketUtils.accept(javaChannel());</span><br><span class="line">  <span class="number">5</span>: </span><br><span class="line">  <span class="number">6</span>:     <span class="keyword">try</span> {</span><br><span class="line">  <span class="number">7</span>:         <span class="comment">// åˆ›å»º Netty NioSocketChannel å¯¹è±¡</span></span><br><span class="line">  <span class="number">8</span>:         <span class="keyword">if</span> (ch != <span class="keyword">null</span>) {</span><br><span class="line">  <span class="number">9</span>:             buf.add(<span class="keyword">new</span> NioSocketChannel(<span class="keyword">this</span>, ch));</span><br><span class="line"> <span class="number">10</span>:             <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"> <span class="number">11</span>:         }</span><br><span class="line"> <span class="number">12</span>:     } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line"> <span class="number">13</span>:         logger.warn(<span class="string">"Failed to create a new channel from an accepted socket."</span>, t);</span><br><span class="line"> <span class="number">14</span>:         <span class="comment">// å‘ç”Ÿå¼‚å¸¸ï¼Œå…³é—­å®¢æˆ·ç«¯çš„ SocketChannel è¿æ¥</span></span><br><span class="line"> <span class="number">15</span>:         <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">16</span>:             ch.close();</span><br><span class="line"> <span class="number">17</span>:         } <span class="keyword">catch</span> (Throwable t2) {</span><br><span class="line"> <span class="number">18</span>:             logger.warn(<span class="string">"Failed to close a socket."</span>, t2);</span><br><span class="line"> <span class="number">19</span>:         }</span><br><span class="line"> <span class="number">20</span>:     }</span><br><span class="line"> <span class="number">21</span>: </span><br><span class="line"> <span class="number">22</span>:     <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"> <span class="number">23</span>: }</span><br><span class="line"> </span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ServerSocketChannel <span class="title">javaChannel</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (ServerSocketChannel) <span class="keyword">super</span>.javaChannel();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ç¬¬ 4 è¡Œï¼šè°ƒç”¨ <code>SocketUtils#accept(ServerSocketChannel serverSocketChannel)</code> æ–¹æ³•ï¼Œæ¥å—å®¢æˆ·ç«¯è¿æ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SocketChannel <span class="title">accept</span><span class="params">(<span class="keyword">final</span> ServerSocketChannel serverSocketChannel)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">return</span> AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedExceptionAction&lt;SocketChannel&gt;() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> SocketChannel <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">                <span class="keyword">return</span> serverSocketChannel.accept(); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    } <span class="keyword">catch</span> (PrivilegedActionException e) {</span><br><span class="line">        <span class="keyword">throw</span> (IOException) e.getCause();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é‡ç‚¹æ˜¯çœ‹ <code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>ServerSocketChannel#accept()</code> æ–¹æ³•ï¼Œæ¥å—å®¢æˆ·ç«¯è¿æ¥ã€‚</li>
</ul>
</li>
<li>ç¬¬ 9 è¡Œï¼šåŸºäºå®¢æˆ·ç«¯çš„ NIO ServerSocket ï¼Œåˆ›å»º Netty NioSocketChannel å¯¹è±¡ã€‚æ•´ä¸ªè¿‡ç¨‹ï¼Œå°±æ˜¯ <a href="http://svip.iocoder.cn/Netty/bootstrap-2-client/">ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” å¯åŠ¨ï¼ˆäºŒï¼‰ä¹‹å®¢æˆ·ç«¯ã€‹</a> çš„ <a href="#">ã€Œ3.7.1 åˆ›å»º Channel å¯¹è±¡ã€</a> å°èŠ‚ã€‚<ul>
<li>ç¬¬ 10 è¡Œï¼šè¿”å› 1 ï¼Œè¡¨ç¤ºæˆåŠŸæ¥å—äº† 1 ä¸ªæ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‚</li>
</ul>
</li>
<li>ç¬¬ 12 è‡³ 20 è¡Œï¼šå‘ç”Ÿå¼‚å¸¸ï¼Œå…³é—­å®¢æˆ·ç«¯çš„ SocketChannel è¿æ¥ï¼Œå¹¶æ‰“å°<strong>å‘Šè­¦</strong>æ—¥å¿—ã€‚<ul>
<li>ç¬¬ 22 è¡Œï¼šè¿”å› 0 ï¼Œè¡¨ç¤ºæˆåŠŸæ¥å— 0 ä¸ªæ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‚</li>
</ul>
</li>
</ul>
<h1 id="4-ServerBootstrapAcceptor"><a href="#4-ServerBootstrapAcceptor" class="headerlink" title="4. ServerBootstrapAcceptor"></a>4. ServerBootstrapAcceptor</h1><p>ServerBootstrapAcceptor ï¼Œç»§æ‰¿ ChannelInboundHandlerAdapter ç±»ï¼ŒæœåŠ¡å™¨æ¥æ”¶å™¨( acceptor )ï¼Œè´Ÿè´£å°†æ¥å—çš„å®¢æˆ·ç«¯çš„ NioSocketChannel æ³¨å†Œåˆ° EventLoop ä¸­ã€‚</p>
<p>å¦å¤–ï¼Œä»ç»§æ‰¿çš„æ˜¯ ChannelInboundHandlerAdapter ç±»ï¼Œå¯ä»¥çœ‹å‡ºå®ƒæ˜¯ Inbound äº‹ä»¶å¤„ç†å™¨ã€‚</p>
<h2 id="4-1-æ„é€ æ–¹æ³•"><a href="#4-1-æ„é€ æ–¹æ³•" class="headerlink" title="4.1 æ„é€ æ–¹æ³•"></a>4.1 æ„é€ æ–¹æ³•</h2><p>åœ¨æœåŠ¡ç«¯çš„å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° ServerBootstrapAcceptor æ³¨å†Œåˆ°æœåŠ¡ç«¯çš„ NioServerSocketChannel çš„ pipeline çš„å°¾éƒ¨ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// è®°å½•å½“å‰çš„å±æ€§</span></span><br><span class="line"><span class="keyword">final</span> EventLoopGroup currentChildGroup = childGroup;</span><br><span class="line"><span class="keyword">final</span> ChannelHandler currentChildHandler = childHandler;</span><br><span class="line"><span class="keyword">final</span> Entry&lt;ChannelOption&lt;?&gt;, Object&gt;[] currentChildOptions;</span><br><span class="line"><span class="keyword">final</span> Entry&lt;AttributeKey&lt;?&gt;, Object&gt;[] currentChildAttrs;</span><br><span class="line"><span class="keyword">synchronized</span> (childOptions) {</span><br><span class="line">    currentChildOptions = childOptions.entrySet().toArray(newOptionArray(<span class="number">0</span>));</span><br><span class="line">}</span><br><span class="line"><span class="keyword">synchronized</span> (childAttrs) {</span><br><span class="line">    currentChildAttrs = childAttrs.entrySet().toArray(newAttrArray(<span class="number">0</span>));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ·»åŠ  ChannelInitializer å¯¹è±¡åˆ° pipeline ä¸­ï¼Œç”¨äºåç»­åˆå§‹åŒ– ChannelHandler åˆ° pipeline ä¸­ã€‚</span></span><br><span class="line">p.addLast(<span class="keyword">new</span> ChannelInitializer&lt;Channel&gt;() {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(<span class="keyword">final</span> Channel ch)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="keyword">final</span> ChannelPipeline pipeline = ch.pipeline();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ·»åŠ é…ç½®çš„ ChannelHandler åˆ° pipeline ä¸­ã€‚</span></span><br><span class="line">        ChannelHandler handler = config.handler();</span><br><span class="line">        <span class="keyword">if</span> (handler != <span class="keyword">null</span>) {</span><br><span class="line">            pipeline.addLast(handler);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ·»åŠ  ServerBootstrapAcceptor åˆ° pipeline ä¸­ã€‚</span></span><br><span class="line">        <span class="comment">// ä½¿ç”¨ EventLoop æ‰§è¡Œçš„åŸå› ï¼Œå‚è§ https://github.com/lightningMan/netty/commit/4638df20628a8987c8709f0f8e5f3679a914ce1a</span></span><br><span class="line">        ch.eventLoop().execute(<span class="keyword">new</span> Runnable() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">                pipeline.addLast(<span class="keyword">new</span> ServerBootstrapAcceptor(</span><br><span class="line">                        ch, currentChildGroup, currentChildHandler, currentChildOptions, currentChildAttrs)); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>å³ <code>&lt;1&gt;</code> å¤„ã€‚ä¹Ÿæ˜¯åœ¨æ­¤å¤„ï¼Œåˆ›å»ºäº† ServerBootstrapAcceptor å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> EventLoopGroup childGroup;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelHandler childHandler;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Entry&lt;ChannelOption&lt;?&gt;, Object&gt;[] childOptions;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Entry&lt;AttributeKey&lt;?&gt;, Object&gt;[] childAttrs;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªåŠ¨æ¢å¤æ¥å—å®¢æˆ·ç«¯è¿æ¥çš„ä»»åŠ¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable enableAutoReadTask;</span><br><span class="line"></span><br><span class="line">ServerBootstrapAcceptor(</span><br><span class="line">        <span class="keyword">final</span> Channel channel, EventLoopGroup childGroup, ChannelHandler childHandler,</span><br><span class="line">        Entry&lt;ChannelOption&lt;?&gt;, Object&gt;[] childOptions, Entry&lt;AttributeKey&lt;?&gt;, Object&gt;[] childAttrs) {</span><br><span class="line">    <span class="keyword">this</span>.childGroup = childGroup;</span><br><span class="line">    <span class="keyword">this</span>.childHandler = childHandler;</span><br><span class="line">    <span class="keyword">this</span>.childOptions = childOptions;</span><br><span class="line">    <span class="keyword">this</span>.childAttrs = childAttrs;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Task which is scheduled to re-enable auto-read.</span></span><br><span class="line">    <span class="comment">// It's important to create this Runnable before we try to submit it as otherwise the URLClassLoader may</span></span><br><span class="line">    <span class="comment">// not be able to load the class because of the file limit it already reached.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// See https://github.com/netty/netty/issues/1328</span></span><br><span class="line">    enableAutoReadTask = <span class="keyword">new</span> Runnable() { <span class="comment">// &lt;2&gt;</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">            channel.config().setAutoRead(<span class="keyword">true</span>);</span><br><span class="line">        }</span><br><span class="line">    };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>enableAutoReadTask</code> å±æ€§ï¼Œè‡ªåŠ¨æ¢å¤æ¥å—å®¢æˆ·ç«¯è¿æ¥çš„ä»»åŠ¡ï¼Œåœ¨ <code>&lt;2&gt;</code> å¤„åˆå§‹åŒ–ã€‚å…·ä½“çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬åœ¨ <a href="#">ã€Œ4.3 exceptionCaughtã€</a> ä¸­ï¼Œè¯¦ç»†è§£æã€‚</li>
</ul>
</li>
</ul>
<h2 id="4-2-channelRead"><a href="#4-2-channelRead" class="headerlink" title="4.2 channelRead"></a>4.2 channelRead</h2><p><code>#channelRead(ChannelHandlerContext ctx, Object msg)</code> æ–¹æ³•ï¼Œå°†æ¥å—çš„å®¢æˆ·ç«¯çš„ NioSocketChannel æ³¨å†Œåˆ° EventLoop ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> </span>{</span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// è€è‰¿è‰¿ï¼šå¦‚ä¸‹çš„æ³¨é‡Šï¼Œå…ˆæš‚æ—¶è®¤ä¸ºæ˜¯æ¥å—çš„å®¢æˆ·ç«¯çš„ NioSocketChannel</span></span><br><span class="line"> <span class="number">4</span>: </span><br><span class="line"> <span class="number">5</span>:     <span class="comment">// æ¥å—çš„å®¢æˆ·ç«¯çš„ NioSocketChannel å¯¹è±¡</span></span><br><span class="line"> <span class="number">6</span>:     <span class="keyword">final</span> Channel child = (Channel) msg;</span><br><span class="line"> <span class="number">7</span>:     <span class="comment">// æ·»åŠ  NioSocketChannel çš„å¤„ç†å™¨</span></span><br><span class="line"> <span class="number">8</span>:     child.pipeline().addLast(childHandler);</span><br><span class="line"> <span class="number">9</span>:     <span class="comment">// è®¾ç½® NioSocketChannel çš„é…ç½®é¡¹</span></span><br><span class="line"><span class="number">10</span>:     setChannelOptions(child, childOptions, logger);</span><br><span class="line"><span class="number">11</span>:     <span class="comment">// è®¾ç½® NioSocketChannel çš„å±æ€§</span></span><br><span class="line"><span class="number">12</span>:     <span class="keyword">for</span> (Entry&lt;AttributeKey&lt;?&gt;, Object&gt; e: childAttrs) {</span><br><span class="line"><span class="number">13</span>:         child.attr((AttributeKey&lt;Object&gt;) e.getKey()).set(e.getValue());</span><br><span class="line"><span class="number">14</span>:     }</span><br><span class="line"><span class="number">15</span>: </span><br><span class="line"><span class="number">16</span>:     <span class="keyword">try</span> {</span><br><span class="line"><span class="number">17</span>:         <span class="comment">// æ³¨å†Œå®¢æˆ·ç«¯çš„ NioSocketChannel åˆ° work EventLoop ä¸­ã€‚</span></span><br><span class="line"><span class="number">18</span>:         childGroup.register(child).addListener(<span class="keyword">new</span> ChannelFutureListener() {</span><br><span class="line"><span class="number">19</span>: </span><br><span class="line"><span class="number">20</span>:             <span class="meta">@Override</span></span><br><span class="line"><span class="number">21</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"><span class="number">22</span>:                 <span class="comment">// æ³¨å†Œå¤±è´¥ï¼Œå…³é—­å®¢æˆ·ç«¯çš„ NioSocketChannel</span></span><br><span class="line"><span class="number">23</span>:                 <span class="keyword">if</span> (!future.isSuccess()) {</span><br><span class="line"><span class="number">24</span>:                     forceClose(child, future.cause());</span><br><span class="line"><span class="number">25</span>:                 }</span><br><span class="line"><span class="number">26</span>:             }</span><br><span class="line"><span class="number">27</span>: </span><br><span class="line"><span class="number">28</span>:         });</span><br><span class="line"><span class="number">29</span>:     } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line"><span class="number">30</span>:         <span class="comment">// å‘ç”Ÿå¼‚å¸¸ï¼Œå¼ºåˆ¶å…³é—­å®¢æˆ·ç«¯çš„ NioSocketChannel</span></span><br><span class="line"><span class="number">31</span>:         forceClose(child, t);</span><br><span class="line"><span class="number">32</span>:     }</span><br><span class="line"><span class="number">33</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¸ºäº†æ–¹ä¾¿æè¿°ï¼Œæˆ‘ä»¬ç»Ÿä¸€è®¤ä¸ºæ¥å—çš„å®¢æˆ·ç«¯è¿æ¥ä¸º NioSocketChannel å¯¹è±¡ã€‚</li>
<li>ç¬¬ 6 è¡Œï¼šæ¥å—çš„å®¢æˆ·ç«¯çš„ NioSocketChannel å¯¹è±¡ã€‚<ul>
<li>ç¬¬ 8 è¡Œï¼šè°ƒç”¨ <code>ChannelPipeline#addLast(childHandler)</code> æ–¹æ³•ï¼Œå°†é…ç½®çš„å­ Channel çš„å¤„ç†å™¨ï¼Œæ·»åŠ åˆ° NioSocketChannel ä¸­ã€‚</li>
<li>ç¬¬ 10 è‡³ 14 è¡Œï¼šè®¾ç½® NioSocketChannel çš„é…ç½®é¡¹ã€å±æ€§ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 17 è‡³ 28 è¡Œï¼šè°ƒç”¨ <code>EventLoopGroup#register(Channel channel)</code> æ–¹æ³•ï¼Œå°†å®¢æˆ·ç«¯çš„ NioSocketChannel å¯¹è±¡ï¼Œä» worker EventLoopGroup ä¸­é€‰æ‹©ä¸€ä¸ª EventLoop ï¼Œæ³¨å†Œåˆ°å…¶ä¸Šã€‚</p>
<ul>
<li>åç»­çš„é€»è¾‘ï¼Œå°±å’Œ <a href="http://svip.iocoder.cn/Netty/bootstrap-1-server/">ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” å¯åŠ¨ï¼ˆä¸€ï¼‰ä¹‹æœåŠ¡ç«¯ã€‹</a> çš„æ³¨å†Œé€»è¾‘<strong>åŸºæœ¬ä¸€è‡´</strong>( è™½ç„¶è¯´ï¼Œæ–‡ç« å†™çš„æ˜¯ NioServerSocketChannel çš„æ³¨å†Œé€»è¾‘ )ã€‚</li>
<li>åœ¨æ³¨å†Œå®Œæˆä¹‹åï¼Œè¯¥ worker EventLoop å°±ä¼šå¼€å§‹è½®è¯¢è¯¥å®¢æˆ·ç«¯æ˜¯å¦æœ‰æ•°æ®å†™å…¥ã€‚</li>
<li><p>ç¬¬ 18 è‡³ 28 è¡Œï¼šæ·»åŠ ç›‘å¬å™¨ï¼Œå¦‚æœæ³¨å†Œå¤±è´¥ï¼Œåˆ™è°ƒç”¨ <code>#forceClose(Channel child, Throwable t)</code> æ–¹æ³•ï¼Œå¼ºåˆ¶å…³é—­å®¢æˆ·ç«¯çš„ NioSocketChannel è¿æ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">forceClose</span><span class="params">(Channel child, Throwable t)</span> </span>{</span><br><span class="line">    child.unsafe().closeForcibly();</span><br><span class="line">    logger.warn(<span class="string">"Failed to register an accepted channel: {}"</span>, child, t);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨è¯¥æ–¹æ³•å†…éƒ¨ï¼Œä¼šè°ƒç”¨ <code>Unsafe#closeForcibly()</code> æ–¹æ³•ï¼Œå¼ºåˆ¶å…³é—­å®¢æˆ·ç«¯çš„ NioSocketChannel ã€‚</li>
</ul>
</li>
<li>ç¬¬ 29 è‡³ 32 è¡Œï¼šå‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™è°ƒç”¨ <code>#forceClose(Channel child, Throwable t)</code> æ–¹æ³•ï¼Œå¼ºåˆ¶å…³é—­å®¢æˆ·ç«¯çš„ NioSocketChannel è¿æ¥ã€‚ </li>
</ul>
</li>
</ul>
<h2 id="4-3-exceptionCaught"><a href="#4-3-exceptionCaught" class="headerlink" title="4.3 exceptionCaught"></a>4.3 exceptionCaught</h2><p><code>#exceptionCaught(ChannelHandlerContext ctx, Throwable cause)</code> æ–¹æ³•ï¼Œå½“æ•è·åˆ°å¼‚å¸¸æ—¶ï¼Œ<strong>æš‚åœ 1 ç§’</strong>ï¼Œä¸å†æ¥å—æ–°çš„å®¢æˆ·ç«¯è¿æ¥ï¼›è€Œåï¼Œå†æ¢å¤æ¥å—æ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">final</span> ChannelConfig config = ctx.channel().config();</span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (config.isAutoRead()) {</span><br><span class="line"> <span class="number">5</span>:         <span class="comment">// å…³é—­æ¥å—æ–°çš„å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line"> <span class="number">6</span>:         <span class="comment">// stop accept new connections for 1 second to allow the channel to recover</span></span><br><span class="line"> <span class="number">7</span>:         <span class="comment">// See https://github.com/netty/netty/issues/1328</span></span><br><span class="line"> <span class="number">8</span>:         config.setAutoRead(<span class="keyword">false</span>);</span><br><span class="line"> <span class="number">9</span>:         <span class="comment">// å‘èµ· 1 ç§’çš„å»¶è¿Ÿä»»åŠ¡ï¼Œæ¢å¤é‡å¯å¼€å¯æ¥å—æ–°çš„å®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line"><span class="number">10</span>:         ctx.channel().eventLoop().schedule(enableAutoReadTask, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line"><span class="number">11</span>:     }</span><br><span class="line"><span class="number">12</span>: </span><br><span class="line"><span class="number">13</span>:     <span class="comment">// ç»§ç»­ä¼ æ’­ exceptionCaught ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="number">14</span>:     <span class="comment">// still let the exceptionCaught event flow through the pipeline to give the user</span></span><br><span class="line"><span class="number">15</span>:     <span class="comment">// a chance to do something with it</span></span><br><span class="line"><span class="number">16</span>:     ctx.fireExceptionCaught(cause);</span><br><span class="line"><span class="number">17</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ç¬¬ 8 è¡Œï¼šè°ƒç”¨ <code>ChannelConfig#setAutoRead(false)</code> æ–¹æ³•ï¼Œå…³é—­æ¥å—æ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// DefaultChannelConfig.java</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #autoRead} çš„åŸå­æ›´æ–°å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicIntegerFieldUpdater&lt;DefaultChannelConfig&gt; AUTOREAD_UPDATER = AtomicIntegerFieldUpdater.newUpdater(DefaultChannelConfig.class, <span class="string">"autoRead"</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦å¼€å¯è‡ªåŠ¨è¯»å–çš„å¼€å…³</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 1 - å¼€å¯</span></span><br><span class="line"><span class="comment"> * 0 - å…³é—­</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"FieldMayBeFinal"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> autoRead = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ChannelConfig <span class="title">setAutoRead</span><span class="params">(<span class="keyword">boolean</span> autoRead)</span> </span>{</span><br><span class="line">    <span class="comment">// åŸå­æ›´æ–°ï¼Œå¹¶ä¸”è·å¾—æ›´æ–°å‰çš„å€¼ &lt;1&gt;</span></span><br><span class="line">    <span class="keyword">boolean</span> oldAutoRead = AUTOREAD_UPDATER.getAndSet(<span class="keyword">this</span>, autoRead ? <span class="number">1</span> : <span class="number">0</span>) == <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// å‘èµ·è¯»å– &lt;2.1&gt;</span></span><br><span class="line">    <span class="keyword">if</span> (autoRead &amp;&amp; !oldAutoRead) {</span><br><span class="line">        channel.read();</span><br><span class="line">    <span class="comment">// å…³é—­è¯»å– &lt;2.2&gt;</span></span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (!autoRead &amp;&amp; oldAutoRead) {</span><br><span class="line">        autoReadCleared();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>autoRead</code> å­—æ®µï¼Œæ˜¯å¦å¼€å¯è‡ªåŠ¨è¯»å–çš„å¼€å…³ã€‚ğŸ˜ˆ ç¬”è€…åŸæœ¬ä»¥ä¸ºæ˜¯ä¸ª <code>boolean</code> ç±»å‹ï¼Œæ˜¯ä¸æ˜¯èƒ–å‹ä¹Ÿæ˜¯ã€‚å…¶ä¸­ï¼Œ1 è¡¨ç¤ºå¼€å¯ï¼Œ0 è¡¨ç¤ºå…³é—­ã€‚<ul>
<li><code>AUTOREAD_UPDATER</code> é™æ€å˜é‡ï¼Œå¯¹ <code>autoRead</code> å­—æ®µçš„åŸå­æ›´æ–°å™¨ã€‚</li>
</ul>
</li>
<li><code>&lt;1&gt;</code> å¤„ï¼Œä½¿ç”¨ <code>AUTOREAD_UPDATER</code> æ›´æ–° <code>autoRead</code> å­—æ®µï¼Œå¹¶è·å¾—æ›´æ–°å‰çš„å€¼ã€‚ä¸ºä»€ä¹ˆéœ€è¦è·å–æ›´æ–°å‰çš„å€¼å‘¢ï¼Ÿåœ¨åç»­çš„ <code>&lt;2.1&gt;</code> å’Œ <code>&lt;2.2&gt;</code> ä¸­ï¼Œå½“ <code>autoRead</code> æœ‰å˜åŒ–æ—¶å€™ï¼Œæ‰è¿›è¡Œåç»­çš„é€»è¾‘ã€‚</li>
<li>ğŸ˜ˆ ä¸‹é¢çš„é€»è¾‘ï¼Œæˆ‘ä»¬æŒ‰ç…§ <code>channel</code> çš„ç±»å‹ä¸º NioServerSocketChannel æ¥åˆ†äº«ã€‚</li>
<li><code>&lt;2.1&gt;</code> å¤„ï¼Œ<code>autoRead &amp;&amp; !oldAutoRead</code> è¿”å› <code>true</code> ï¼Œæ„å‘³ç€æ¢å¤é‡å¯å¼€å¯æ¥å—æ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‚æ‰€ä»¥è°ƒç”¨ <code>NioServerSocketChannel#read()</code> æ–¹æ³•ï¼Œåç»­çš„é€»è¾‘ï¼Œå°±æ˜¯ <a href="http://svip.iocoder.cn/Netty/bootstrap-1-server/">ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” å¯åŠ¨ï¼ˆä¸€ï¼‰ä¹‹æœåŠ¡ç«¯ã€‹</a> çš„ <a href="#">ã€Œ3.13.3 beginReadã€</a> çš„é€»è¾‘ã€‚</li>
<li><p><code>&lt;2.2&gt;</code> å¤„ï¼Œ<code>!autoRead &amp;&amp; oldAutoRead</code> è¿”å› <code>false</code> ï¼Œæ„å‘³ç€å…³é—­æ¥å—æ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‚æ‰€ä»¥è°ƒç”¨ <code>#autoReadCleared()</code> æ–¹æ³•ï¼Œç§»é™¤å¯¹ <code>SelectionKey.OP_ACCEPT</code> äº‹ä»¶çš„æ„Ÿå…´è¶£ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// NioServerSocketChannel.java</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">autoReadCleared</span><span class="params">()</span> </span>{</span><br><span class="line">    clearReadPending();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>åœ¨æ–¹æ³•å†…éƒ¨ï¼Œä¼šè°ƒç”¨ <code>#clearReadPending()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">clearReadPending</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (isRegistered()) {</span><br><span class="line">        EventLoop eventLoop = eventLoop();</span><br><span class="line">        <span class="keyword">if</span> (eventLoop.inEventLoop()) {</span><br><span class="line">            clearReadPending0();</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            eventLoop.execute(clearReadPendingRunnable);</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// Best effort if we are not registered yet clear readPending. This happens during channel initialization.</span></span><br><span class="line">        <span class="comment">// NB: We only set the boolean field instead of calling clearReadPending0(), because the SelectionKey is</span></span><br><span class="line">        <span class="comment">// not set yet so it would produce an assertion failure.</span></span><br><span class="line">        readPending = <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable clearReadPendingRunnable = <span class="keyword">new</span> Runnable() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">        clearReadPending0();</span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">clearReadPending0</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// TODO èŠ‹è‰¿</span></span><br><span class="line">    readPending = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// ç§»é™¤å¯¹â€œè¯»â€äº‹ä»¶çš„æ„Ÿå…´è¶£ã€‚</span></span><br><span class="line">    ((AbstractNioUnsafe) unsafe()).removeReadOp();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>æœ€ç»ˆçš„ç»“æœï¼Œæ˜¯åœ¨ EventLoop çš„çº¿ç¨‹ä¸­ï¼Œè°ƒç”¨ <code>AbstractNioUnsafe#clearReadPending0()</code> æ–¹æ³•ï¼Œç§»é™¤å¯¹â€œ<strong>è¯»</strong>â€äº‹ä»¶çš„æ„Ÿå…´è¶£( å¯¹äº NioServerSocketChannel çš„ â€œ<strong>è¯»</strong>â€œäº‹ä»¶å°±æ˜¯ <code>SelectionKey.OP_ACCEPT</code> )ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractNioUnsafe.java</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">removeReadOp</span><span class="params">()</span> </span>{</span><br><span class="line">    SelectionKey key = selectionKey();</span><br><span class="line">    <span class="comment">// å¿½ç•¥ï¼Œå¦‚æœ SelectionKey ä¸åˆæ³•ï¼Œä¾‹å¦‚å·²ç»å–æ¶ˆ</span></span><br><span class="line">    <span class="comment">// Check first if the key is still valid as it may be canceled as part of the deregistration</span></span><br><span class="line">    <span class="comment">// from the EventLoop</span></span><br><span class="line">    <span class="comment">// See https://github.com/netty/netty/issues/2104</span></span><br><span class="line">    <span class="keyword">if</span> (!key.isValid()) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// ç§»é™¤å¯¹â€œè¯»â€äº‹ä»¶çš„æ„Ÿå…´è¶£ã€‚</span></span><br><span class="line">    <span class="keyword">int</span> interestOps = key.interestOps();</span><br><span class="line">    <span class="keyword">if</span> ((interestOps &amp; readInterestOp) != <span class="number">0</span>) {</span><br><span class="line">        <span class="comment">// only remove readInterestOp if needed</span></span><br><span class="line">        key.interestOps(interestOps &amp; ~readInterestOp);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é€šè¿‡å–åæ±‚å¹¶ï¼Œåè°ƒç”¨ <code>SelectionKey#interestOps(interestOps)</code> æ–¹æ³•ï¼Œ<strong>ä»…</strong>ç§»é™¤å¯¹â€œè¯»â€äº‹ä»¶çš„æ„Ÿå…´è¶£ã€‚</li>
<li>ğŸ˜ˆ æ•´ä¸ªè¿‡ç¨‹çš„è°ƒç”¨é“¾ï¼Œæœ‰ä¸¢ä¸¢é•¿ï¼Œèƒ–å‹å¯ä»¥å›çœ‹ï¼Œæˆ–è€…å¤šå¤šè°ƒè¯•ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 10 è¡Œï¼šè°ƒç”¨ <code>EventLoop#schedule(Runnable command, long delay, TimeUnit unit)</code> æ–¹æ³•ï¼Œå‘èµ· 1 ç§’çš„å»¶è¿Ÿä»»åŠ¡ï¼Œæ¢å¤é‡å¯å¼€å¯æ¥å—æ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‚è¯¥å®šæ—¶ä»»åŠ¡ä¼šè°ƒç”¨ <code>ChannelConfig#setAutoRead(true)</code> æ–¹æ³•ï¼Œå³å¯¹åº” <code>&lt;2.1&gt;</code> æƒ…å†µã€‚</li>
<li>ç¬¬ 16 è¡Œï¼šè°ƒç”¨ <code>ChannelHandlerContext#fireExceptionCaught(cause)</code> æ–¹æ³•ï¼Œç»§ç»­ä¼ æ’­ exceptionCaught ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚å…·ä½“çš„åŸå› ï¼Œå¯çœ‹è‹±æ–‡æ³¨é‡Šã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ¨èé˜…è¯»æ–‡ç« ï¼š</p>
<ul>
<li>é—ªç”µä¾  <a href="https://www.jianshu.com/p/0242b1d4dd21" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnetty æºç åˆ†æä¹‹æ–°è¿æ¥æ¥å…¥å…¨è§£æã€‹</a></li>
<li>å å°ç‹¼ <a href="https://www.jianshu.com/p/ffc6fd82e32b" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty æºç åˆ†æä¹‹ accept è¿‡ç¨‹ã€‹</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/Channel-2-accept/" data-id="ck4pl3fp200dufgcfhtu1pwap" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>