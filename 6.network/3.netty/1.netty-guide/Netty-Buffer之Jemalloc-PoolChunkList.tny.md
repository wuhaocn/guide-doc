<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆå››ï¼‰PoolChunkList
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>åœ¨ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-2-Jemalloc-chunk">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆäºŒï¼‰PoolChunkã€‹</a> ï¼Œæˆ‘ä»¬çœ‹åˆ° PoolChunk æœ‰å¦‚ä¸‹ä¸‰ä¸ªå±æ€§ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰€å± PoolChunkList å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PoolChunkList&lt;T&gt; parent;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸Šä¸€ä¸ª Chunk å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PoolChunk&lt;T&gt; prev;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸‹ä¸€ä¸ª Chunk å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PoolChunk&lt;T&gt; next;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é€šè¿‡ <code>prev</code> å’Œ <code>next</code> ä¸¤ä¸ªå±æ€§ï¼Œå½¢æˆä¸€ä¸ª<strong>åŒå‘</strong> Chunk é“¾è¡¨ <code>parent</code>( PoolChunkList )ã€‚</li>
</ul>
<p>é‚£ä¹ˆä¸ºä»€ä¹ˆéœ€è¦æœ‰ PoolChunkList è¿™æ ·ä¸€ä¸ªé“¾è¡¨å‘¢ï¼Ÿç›´æ¥å¼€å§‹æ’¸ä»£ç ã€‚</p>
<h1 id="2-PoolChunkList"><a href="#2-PoolChunkList" class="headerlink" title="2. PoolChunkList"></a>2. PoolChunkList</h1><p><code>io.netty.buffer.PoolChunkList</code> ï¼Œå®ç° PoolChunkListMetric æ¥å£ï¼Œè´Ÿè´£ç®¡ç†å¤šä¸ª Chunk çš„ç”Ÿå‘½å‘¨æœŸï¼Œ<strong>åœ¨æ­¤åŸºç¡€ä¸Šå¯¹å†…å­˜åˆ†é…è¿›è¡Œè¿›ä¸€æ­¥çš„ä¼˜åŒ–</strong>ã€‚</p>
<h2 id="2-1-æ„é€ æ–¹æ³•"><a href="#2-1-æ„é€ æ–¹æ³•" class="headerlink" title="2.1 æ„é€ æ–¹æ³•"></a>2.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰€å± PoolArena å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolArena&lt;T&gt; arena;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸‹ä¸€ä¸ª PoolChunkList å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolChunkList&lt;T&gt; nextList;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Chunk æœ€å°å†…å­˜ä½¿ç”¨ç‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> minUsage;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Chunk æœ€å¤§å†…å­˜ä½¿ç”¨ç‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxUsage;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¯ä¸ª Chunk æœ€å¤§å¯åˆ†é…çš„å®¹é‡</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #calculateMaxCapacity(int, int) æ–¹æ³•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxCapacity;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * PoolChunk å¤´èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> PoolChunk&lt;T&gt; head;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‰ä¸€ä¸ª PoolChunkList å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// This is only update once when create the linked like list of PoolChunkList in PoolArena constructor.</span></span><br><span class="line"><span class="keyword">private</span> PoolChunkList&lt;T&gt; prevList;</span><br><span class="line"></span><br><span class="line"><span class="comment">// <span class="doctag">TODO:</span> Test if adding padding helps under contention</span></span><br><span class="line"><span class="comment">//private long pad0, pad1, pad2, pad3, pad4, pad5, pad6, pad7;</span></span><br><span class="line"></span><br><span class="line">PoolChunkList(PoolArena&lt;T&gt; arena, PoolChunkList&lt;T&gt; nextList, <span class="keyword">int</span> minUsage, <span class="keyword">int</span> maxUsage, <span class="keyword">int</span> chunkSize) {</span><br><span class="line">    <span class="keyword">assert</span> minUsage &lt;= maxUsage;</span><br><span class="line">    <span class="keyword">this</span>.arena = arena;</span><br><span class="line">    <span class="keyword">this</span>.nextList = nextList;</span><br><span class="line">    <span class="keyword">this</span>.minUsage = minUsage;</span><br><span class="line">    <span class="keyword">this</span>.maxUsage = maxUsage;</span><br><span class="line">    <span class="comment">// è®¡ç®— maxUsage å±æ€§</span></span><br><span class="line">    maxCapacity = calculateMaxCapacity(minUsage, chunkSize);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>arena</code> å±æ€§ï¼Œæ‰€å± PoolArena å¯¹è±¡ã€‚</li>
<li><p><code>prevList</code> + <code>nextList</code> å±æ€§ï¼Œä¸Šä¸€ä¸ªå’Œä¸‹ä¸€ä¸ª PoolChunkList å¯¹è±¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒPoolChunkList é™¤äº†<strong>è‡ªèº«</strong>æœ‰ä¸€æ¡åŒå‘é“¾è¡¨å¤–ï¼ŒPoolChunkList å’Œ PoolChunkList <strong>ä¹‹é—´</strong>ä¹Ÿå½¢æˆäº†ä¸€æ¡åŒå‘é“¾è¡¨ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<blockquote>
<p>FROM <a href="https://www.jianshu.com/p/a1debfe4ff02" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥æµ…å‡ºNettyå†…å­˜ç®¡ç† PoolChunkListã€‹</a></p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_09_10/01.png" title="åŒå‘é“¾è¡¨" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_09_10/01.png" alt="åŒå‘é“¾è¡¨"></a><span class="caption">åŒå‘é“¾è¡¨</span></p>
</blockquote>
</li>
<li><p><code>head</code> å±æ€§ï¼ŒPoolChunkList <strong>è‡ªèº«</strong>çš„åŒå‘é“¾è¡¨çš„<strong>å¤´èŠ‚ç‚¹</strong>ã€‚</p>
</li>
<li><code>minUsage</code> + <code>maxUsage</code> å±æ€§ï¼ŒPoolChunkList ç®¡ç†çš„ Chunk ä»¬çš„å†…å­˜ä½¿ç”¨ç‡ã€‚<ul>
<li>å½“ Chunk åˆ†é…çš„å†…å­˜ç‡è¶…è¿‡ <code>maxUsage</code> æ—¶ï¼Œä»å½“å‰ PoolChunkList èŠ‚ç‚¹ç§»é™¤ï¼Œæ·»åŠ åˆ°ä¸‹ä¸€ä¸ª PoolChunkList èŠ‚ç‚¹( <code>nextList</code> )ã€‚TODO è¯¦ç»†è§£æã€‚</li>
<li>å½“ Chunk åˆ†é…çš„å†…å­˜ç‡å°äº <code>minUsage</code> æ—¶ï¼Œä»å½“å‰ PoolChunkList èŠ‚ç‚¹ç§»é™¤ï¼Œæ·»åŠ åˆ°ä¸Šä¸€ä¸ª PoolChunkList èŠ‚ç‚¹( <code>prevList</code> )ã€‚TODO è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li><p><code>maxCapacity</code> å±æ€§ï¼Œæ¯ä¸ª Chunk æœ€å¤§å¯åˆ†é…çš„å®¹é‡ã€‚é€šè¿‡ <code>#calculateMaxCapacity(int minUsage, int chunkSize)</code> æ–¹æ³•ï¼Œæ¥è®¡ç®—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Calculates the maximum capacity of a buffer that will ever be possible to allocate out of the {<span class="doctag">@link</span> PoolChunk}s</span></span><br><span class="line"><span class="comment"> * that belong to the {<span class="doctag">@link</span> PoolChunkList} with the given {<span class="doctag">@code</span> minUsage} and {<span class="doctag">@code</span> maxUsage} settings.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">calculateMaxCapacity</span><span class="params">(<span class="keyword">int</span> minUsage, <span class="keyword">int</span> chunkSize)</span> </span>{</span><br><span class="line">    <span class="comment">// è®¡ç®— minUsage å€¼</span></span><br><span class="line">    minUsage = minUsage0(minUsage);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (minUsage == <span class="number">100</span>) {</span><br><span class="line">        <span class="comment">// If the minUsage is 100 we can not allocate anything out of this list.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Calculate the maximum amount of bytes that can be allocated from a PoolChunk in this PoolChunkList.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// As an example:</span></span><br><span class="line">    <span class="comment">// - If a PoolChunkList has minUsage == 25 we are allowed to allocate at most 75% of the chunkSize because</span></span><br><span class="line">    <span class="comment">//   this is the maximum amount available in any PoolChunk in this PoolChunkList.</span></span><br><span class="line">    <span class="keyword">return</span>  (<span class="keyword">int</span>) (chunkSize * (<span class="number">100L</span> - minUsage) / <span class="number">100L</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¿è¯æœ€å° &gt;= 1</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">minUsage0</span><span class="params">(<span class="keyword">int</span> value)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> max(<span class="number">1</span>, value);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¸ºä»€ä¹ˆä½¿ç”¨ <code>(int) (chunkSize * (100L - minUsage) / 100L)</code> æ¥è®¡ç®—å‘¢ï¼Ÿå› ä¸º Chunk è¿›å…¥å½“å‰ PoolChunkList èŠ‚ç‚¹ï¼Œæ„å‘³ç€ Chunk å†…å­˜å·²ç»åˆ†é…äº† <code>minUsage</code> æ¯”ç‡ï¼Œæ‰€ä»¥ Chunk å‰©ä½™çš„å®¹é‡æ˜¯ <code>chunkSize * (100L - minUsage) / 100L</code> ã€‚ğŸ˜ˆ æ˜¯ä¸æ˜¯è±ç„¶å¼€æœ—å™¢ï¼Ÿï¼</li>
</ul>
</li>
</ul>
<h2 id="2-2-allocate"><a href="#2-2-allocate" class="headerlink" title="2.2 allocate"></a>2.2 allocate</h2><blockquote>
<p>éšç€ Chunk ä¸­ Page çš„ä¸æ–­åˆ†é…å’Œé‡Šæ”¾ï¼Œä¼šå¯¼è‡´å¾ˆå¤šç¢ç‰‡å†…å­˜æ®µï¼Œå¤§å¤§å¢åŠ äº†ä¹‹ååˆ†é…ä¸€æ®µè¿ç»­å†…å­˜çš„å¤±è´¥ç‡ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œå¯ä»¥æŠŠå†…å­˜ä½¿ç”¨ç‡è¾ƒå¤§çš„ Chunk æ”¾åˆ°PoolChunkList é“¾è¡¨æ›´åé¢ã€‚</p>
</blockquote>
<p><code>#allocate(PooledByteBuf&lt;T&gt; buf, int reqCapacity, int normCapacity)</code> æ–¹æ³•ï¼Œç»™ PooledByteBuf å¯¹è±¡åˆ†é…å†…å­˜å—ï¼Œå¹¶è¿”å›æ˜¯å¦åˆ†é…å†…å­˜å—æˆåŠŸã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">boolean</span> <span class="title">allocate</span><span class="params">(PooledByteBuf&lt;T&gt; buf, <span class="keyword">int</span> reqCapacity, <span class="keyword">int</span> normCapacity)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// åŒå‘é“¾è¡¨ä¸­æ—  Chunk</span></span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// ç”³è¯·åˆ†é…çš„å†…å­˜è¶…è¿‡ ChunkList çš„æ¯ä¸ª Chunk æœ€å¤§å¯åˆ†é…çš„å®¹é‡</span></span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (head == <span class="keyword">null</span> || normCapacity &gt; maxCapacity) {</span><br><span class="line"> <span class="number">5</span>:         <span class="comment">// Either this PoolChunkList is empty or the requested capacity is larger then the capacity which can</span></span><br><span class="line"> <span class="number">6</span>:         <span class="comment">// be handled by the PoolChunks that are contained in this PoolChunkList.</span></span><br><span class="line"> <span class="number">7</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"> <span class="number">8</span>:     }</span><br><span class="line"> <span class="number">9</span>: </span><br><span class="line"><span class="number">10</span>:     <span class="comment">// éå†åŒå‘é“¾è¡¨ã€‚æ³¨æ„ï¼Œéå†çš„æ˜¯ ChunkList çš„å†…éƒ¨åŒå‘é“¾è¡¨ã€‚</span></span><br><span class="line"><span class="number">11</span>:     <span class="keyword">for</span> (PoolChunk&lt;T&gt; cur = head;;) {</span><br><span class="line"><span class="number">12</span>:         <span class="comment">// åˆ†é…å†…å­˜å—</span></span><br><span class="line"><span class="number">13</span>:         <span class="keyword">long</span> handle = cur.allocate(normCapacity);</span><br><span class="line"><span class="number">14</span>:         <span class="comment">// åˆ†é…å¤±è´¥</span></span><br><span class="line"><span class="number">15</span>:         <span class="keyword">if</span> (handle &lt; <span class="number">0</span>) {</span><br><span class="line"><span class="number">16</span>:             <span class="comment">// è¿›å…¥ä¸‹ä¸€èŠ‚ç‚¹</span></span><br><span class="line"><span class="number">17</span>:             cur = cur.next;</span><br><span class="line"><span class="number">18</span>:             <span class="comment">// è‹¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œè¿”å› false ï¼Œç»“æŸå¾ªç¯</span></span><br><span class="line"><span class="number">19</span>:             <span class="keyword">if</span> (cur == <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">20</span>:                 <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// åˆ†é…å¤±è´¥</span></span><br><span class="line"><span class="number">21</span>:             }</span><br><span class="line"><span class="number">22</span>:         <span class="comment">// åˆ†é…æˆåŠŸ</span></span><br><span class="line"><span class="number">23</span>:         } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">24</span>:             <span class="comment">// åˆå§‹åŒ–å†…å­˜å—åˆ° PooledByteBuf å¯¹è±¡ä¸­</span></span><br><span class="line"><span class="number">25</span>:             cur.initBuf(buf, handle, reqCapacity);</span><br><span class="line"><span class="number">26</span>:             <span class="comment">// è¶…è¿‡å½“å‰ ChunkList ç®¡ç†çš„ Chunk çš„å†…å­˜ä½¿ç”¨ç‡ä¸Šé™</span></span><br><span class="line"><span class="number">27</span>:             <span class="keyword">if</span> (cur.usage() &gt;= maxUsage) {</span><br><span class="line"><span class="number">28</span>:                 <span class="comment">// ä»å½“å‰ ChunkList èŠ‚ç‚¹ç§»é™¤</span></span><br><span class="line"><span class="number">29</span>:                 remove(cur);</span><br><span class="line"><span class="number">30</span>:                 <span class="comment">// æ·»åŠ åˆ°ä¸‹ä¸€ä¸ª ChunkList èŠ‚ç‚¹</span></span><br><span class="line"><span class="number">31</span>:                 nextList.add(cur); </span><br><span class="line"><span class="number">32</span>:             }</span><br><span class="line"><span class="number">33</span>:             <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// åˆ†é…æˆåŠŸ</span></span><br><span class="line"><span class="number">34</span>:         }</span><br><span class="line"><span class="number">35</span>:     }</span><br><span class="line"><span class="number">36</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 2 è‡³ 8 è¡Œï¼šåŒå‘é“¾è¡¨ä¸­æ—  Chunkï¼Œæˆ–è€…ç”³è¯·åˆ†é…çš„å†…å­˜è¶…è¿‡ ChunkList çš„æ¯ä¸ª Chunk æœ€å¤§å¯åˆ†é…çš„å®¹é‡ï¼Œè¿”å› <code>false</code> ï¼Œåˆ†é…å¤±è´¥ã€‚</li>
<li>ç¬¬ 11 è¡Œï¼šéå†åŒå‘é“¾è¡¨ã€‚<strong>æ³¨æ„ï¼Œéå†çš„æ˜¯ ChunkList çš„å†…éƒ¨åŒå‘é“¾è¡¨</strong>ã€‚</li>
<li>ç¬¬ 13 è¡Œï¼šè°ƒç”¨ <code>PoolChunk#allocate(normCapacity)</code> æ–¹æ³•ï¼Œåˆ†é…å†…å­˜å—ã€‚è¿™å—ï¼Œå¯ä»¥ç»“åˆ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-2-Jemalloc-chunk">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆäºŒï¼‰PoolChunkã€‹ã€Œ2.2 allocateã€</a> åœ¨å¤ä¹ ä¸‹ã€‚</li>
<li>ç¬¬ 15 è‡³ 17 è¡Œï¼šåˆ†é…å¤±è´¥ï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚<ul>
<li>ç¬¬ 18 è‡³ 21 è¡Œï¼šè‹¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œè¿”å› <code>false</code> ï¼Œåˆ†é…å¤±è´¥ã€‚</li>
</ul>
</li>
<li>ç¬¬ 22 è‡³ 25 è¡Œï¼šåˆ†é…æˆåŠŸï¼Œè°ƒç”¨ <code>PooledByteBuf##initBuf(PooledByteBuf&lt;T&gt; buf, long handle, int reqCapacity)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–åˆ†é…çš„å†…å­˜å—åˆ° PooledByteBuf ä¸­ã€‚è¿™å—ï¼Œå¯ä»¥ç»“åˆ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-2-Jemalloc-chunk">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆäºŒï¼‰PoolChunkã€‹ã€Œ2.5 initBufã€</a> åœ¨å¤ä¹ ä¸‹ã€‚<ul>
<li>ç¬¬ 26 è‡³ 32 è¡Œï¼šè¶…è¿‡å½“å‰ ChunkList ç®¡ç†çš„ Chunk çš„å†…å­˜ä½¿ç”¨ç‡ä¸Šé™ï¼Œä»å½“å‰ ChunkList èŠ‚ç‚¹ç§»é™¤ï¼Œå¹¶æ·»åŠ åˆ°â€œ<strong>ä¸‹</strong>â€ä¸€ä¸ª ChunkList èŠ‚ç‚¹ã€‚<ul>
<li>ç¬¬ 29 è¡Œï¼šè°ƒç”¨ <code>#remove(PoolChunk&lt;T&gt; cur)</code> æ–¹æ³•ï¼Œè§£æè§ <a href="#">ã€Œ2.4.2 removeã€</a> ã€‚</li>
<li>ç¬¬ 31 è¡Œï¼šè°ƒç”¨ <code>#remove(PoolChunk&lt;T&gt; cur)</code> æ–¹æ³•ï¼Œè§£æè§ <a href="#">ã€Œ2.4.1 addã€</a> ã€‚</li>
</ul>
</li>
<li>ç¬¬ 33 è¡Œï¼šè¿”å› <code>true</code> ï¼Œåˆ†é…æˆåŠŸã€‚</li>
</ul>
</li>
</ul>
<h2 id="2-3-free"><a href="#2-3-free" class="headerlink" title="2.3 free"></a>2.3 free</h2><p><code>#free(PoolChunk&lt;T&gt; chunk, long handle)</code> æ–¹æ³•ï¼Œé‡Šæ”¾ PoolChunk çš„æŒ‡å®šä½ç½®( <code>handle</code> )çš„å†…å­˜å—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">boolean</span> <span class="title">free</span><span class="params">(PoolChunk&lt;T&gt; chunk, <span class="keyword">long</span> handle)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// é‡Šæ”¾ PoolChunk çš„æŒ‡å®šä½ç½®( handle )çš„å†…å­˜å—</span></span><br><span class="line"> <span class="number">3</span>:     chunk.free(handle);</span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// å°äºå½“å‰ ChunkList ç®¡ç†çš„ Chunk çš„å†…å­˜ä½¿ç”¨ç‡ä¸‹é™</span></span><br><span class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (chunk.usage() &lt; minUsage) {</span><br><span class="line"> <span class="number">6</span>:         <span class="comment">// ä»å½“å‰ ChunkList èŠ‚ç‚¹ç§»é™¤</span></span><br><span class="line"> <span class="number">7</span>:         remove(chunk);</span><br><span class="line"> <span class="number">8</span>:         <span class="comment">// æ·»åŠ åˆ°ä¸Šä¸€ä¸ª ChunkList èŠ‚ç‚¹</span></span><br><span class="line"> <span class="number">9</span>:         <span class="comment">// Move the PoolChunk down the PoolChunkList linked-list.</span></span><br><span class="line"><span class="number">10</span>:         <span class="keyword">return</span> move0(chunk);</span><br><span class="line"><span class="number">11</span>:     }</span><br><span class="line"><span class="number">12</span>:     <span class="comment">// é‡Šæ”¾æˆåŠŸ</span></span><br><span class="line"><span class="number">13</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">14</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šè°ƒç”¨ <code>PoolChunk#free(long handle)</code> æ–¹æ³•ï¼Œé‡Šæ”¾æŒ‡å®šä½ç½®çš„å†…å­˜å—ã€‚è¿™å—ï¼Œå¯ä»¥ç»“åˆ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-2-Jemalloc-chunk">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆäºŒï¼‰PoolChunkã€‹ã€Œ2.3 freeã€</a> åœ¨å¤ä¹ ä¸‹ã€‚</li>
<li>ç¬¬ 5 è¡Œï¼šå°äºå½“å‰ ChunkList ç®¡ç†çš„ Chunk çš„å†…å­˜ä½¿ç”¨ç‡ä¸‹é™ï¼š<ul>
<li>ç¬¬ 7 è¡Œï¼šè°ƒç”¨ <code>#remove(PoolChunk&lt;T&gt; cur)</code> æ–¹æ³•ï¼Œä»å½“å‰ ChunkList èŠ‚ç‚¹ç§»é™¤ã€‚</li>
<li>ç¬¬ 10 è¡Œï¼šè°ƒç”¨ <code>#move(PoolChunk&lt;T&gt; chunk)</code> æ–¹æ³•ï¼Œ æ·»åŠ åˆ°â€œä¸Šâ€ä¸€ä¸ª ChunkList èŠ‚ç‚¹ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.4.3 moveã€</a> ã€‚</li>
</ul>
</li>
<li>ç¬¬ 13 è¡Œï¼šè¿”å› <code>true</code> ï¼Œé‡Šæ”¾æˆåŠŸã€‚</li>
</ul>
<h2 id="2-4-åŒå‘é“¾è¡¨æ“ä½œ"><a href="#2-4-åŒå‘é“¾è¡¨æ“ä½œ" class="headerlink" title="2.4 åŒå‘é“¾è¡¨æ“ä½œ"></a>2.4 åŒå‘é“¾è¡¨æ“ä½œ</h2><h3 id="2-4-1-add"><a href="#2-4-1-add" class="headerlink" title="2.4.1 add"></a>2.4.1 add</h3><p><code>#add(PoolChunk&lt;T&gt; chunk)</code> æ–¹æ³•ï¼Œå°† PoolChunk æ·»åŠ åˆ° ChunkList èŠ‚ç‚¹ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="number">1</span>: <span class="function"><span class="keyword">void</span> <span class="title">add</span><span class="params">(PoolChunk&lt;T&gt; chunk)</span> </span>{</span><br><span class="line"><span class="number">2</span>:     <span class="comment">// è¶…è¿‡å½“å‰ ChunkList ç®¡ç†çš„ Chunk çš„å†…å­˜ä½¿ç”¨ç‡ä¸Šé™ï¼Œç»§ç»­é€’å½’åˆ°ä¸‹ä¸€ä¸ª ChunkList èŠ‚ç‚¹è¿›è¡Œæ·»åŠ ã€‚</span></span><br><span class="line"><span class="number">3</span>:     <span class="keyword">if</span> (chunk.usage() &gt;= maxUsage) {</span><br><span class="line"><span class="number">4</span>:         nextList.add(chunk);</span><br><span class="line"><span class="number">5</span>:         <span class="keyword">return</span>;</span><br><span class="line"><span class="number">6</span>:     }</span><br><span class="line"><span class="number">7</span>:     <span class="comment">// æ‰§è¡ŒçœŸæ­£çš„æ·»åŠ </span></span><br><span class="line"><span class="number">8</span>:     add0(chunk);</span><br><span class="line"><span class="number">9</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 2 è‡³ 6 è¡Œï¼šè¶…è¿‡å½“å‰ ChunkList ç®¡ç†çš„ Chunk çš„å†…å­˜ä½¿ç”¨ç‡ä¸Šé™ï¼Œè°ƒç”¨ <code>nextList</code> çš„ <code>#add(PoolChunk&lt;T&gt; chunk)</code> æ–¹æ³•ï¼Œç»§ç»­é€’å½’åˆ°ä¸‹ä¸€ä¸ª ChunkList èŠ‚ç‚¹è¿›è¡Œæ·»åŠ ã€‚</li>
<li><p>ç¬¬ 8 è¡Œï¼šè°ƒç”¨ <code>#add0(PoolChunk&lt;T&gt; chunk)</code> æ–¹æ³•ï¼Œæ‰§è¡ŒçœŸæ­£çš„æ·»åŠ ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Adds the {<span class="doctag">@link</span> PoolChunk} to this {<span class="doctag">@link</span> PoolChunkList}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add0</span><span class="params">(PoolChunk&lt;T&gt; chunk)</span> </span>{</span><br><span class="line">    chunk.parent = <span class="keyword">this</span>;</span><br><span class="line">    <span class="comment">// &lt;1&gt; æ— å¤´èŠ‚ç‚¹ï¼Œè‡ªå·±æˆä¸ºå¤´èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (head == <span class="keyword">null</span>) {</span><br><span class="line">        head = chunk;</span><br><span class="line">        chunk.prev = <span class="keyword">null</span>;</span><br><span class="line">        chunk.next = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// &lt;2&gt; æœ‰å¤´èŠ‚ç‚¹ï¼Œè‡ªå·±æˆä¸ºå¤´èŠ‚ç‚¹ï¼ŒåŸå¤´èŠ‚ç‚¹æˆä¸ºè‡ªå·±çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        chunk.prev = <span class="keyword">null</span>;</span><br><span class="line">        chunk.next = head;</span><br><span class="line">        head.prev = chunk;</span><br><span class="line">        head = chunk;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œæ¯”è¾ƒå¥½ç†è§£ï¼Œèƒ–å‹è‡ªå·±çœ‹ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œå› ä¸º <code>chunk</code> <strong>æ–°</strong>è¿›å…¥ä¸‹ä¸€ä¸ª ChunkList èŠ‚ç‚¹ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå†…å­˜ä½¿ç”¨ç‡ç›¸å¯¹è¾ƒä½ï¼Œåˆ†é…å†…å­˜å—æˆåŠŸç‡ç›¸å¯¹è¾ƒé«˜ï¼Œæ‰€ä»¥å˜æˆæ–°çš„é¦–èŠ‚ç‚¹ã€‚</li>
</ul>
</li>
</ul>
<h3 id="2-4-2-remove"><a href="#2-4-2-remove" class="headerlink" title="2.4.2 remove"></a>2.4.2 remove</h3><p><code>#remove(PoolChunk&lt;T&gt; chunk)</code> æ–¹æ³•ï¼Œä»å½“å‰ ChunkList èŠ‚ç‚¹ç§»é™¤ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(PoolChunk&lt;T&gt; cur)</span> </span>{</span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹ä¸ºé¦–èŠ‚ç‚¹ï¼Œå°†ä¸‹ä¸€ä¸ªèŠ‚ç‚¹è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (cur == head) {</span><br><span class="line">        head = cur.next;</span><br><span class="line">        <span class="keyword">if</span> (head != <span class="keyword">null</span>) {</span><br><span class="line">            head.prev = <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹éé¦–èŠ‚ç‚¹ï¼Œå°†èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªèŠ‚ç‚¹æŒ‡å‘èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        PoolChunk&lt;T&gt; next = cur.next;</span><br><span class="line">        cur.prev.next = next;</span><br><span class="line">        <span class="keyword">if</span> (next != <span class="keyword">null</span>) {</span><br><span class="line">            next.prev = cur.prev;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±ç ”ç©¶ã€‚</li>
</ul>
<h3 id="2-4-3-move"><a href="#2-4-3-move" class="headerlink" title="2.4.3 move"></a>2.4.3 move</h3><p><code>#move(PoolChunk&lt;T&gt; chunk)</code> æ–¹æ³•ï¼Œ æ·»åŠ åˆ°â€œä¸Šâ€ä¸€ä¸ª ChunkList èŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Moves the {<span class="doctag">@link</span> PoolChunk} down the {<span class="doctag">@link</span> PoolChunkList} linked-list so it will end up in the right</span></span><br><span class="line"><span class="comment">    * {<span class="doctag">@link</span> PoolChunkList} that has the correct minUsage / maxUsage in respect to {<span class="doctag">@link</span> PoolChunk#usage()}.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">move</span><span class="params">(PoolChunk&lt;T&gt; chunk)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">assert</span> chunk.usage() &lt; maxUsage;</span><br><span class="line"> <span class="number">3</span>: </span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// å°äºå½“å‰ ChunkList ç®¡ç†çš„ Chunk çš„å†…å­˜ä½¿ç”¨ç‡ä¸‹é™ï¼Œç»§ç»­é€’å½’åˆ°ä¸Šä¸€ä¸ª ChunkList èŠ‚ç‚¹è¿›è¡Œæ·»åŠ ã€‚</span></span><br><span class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (chunk.usage() &lt; minUsage) {</span><br><span class="line"> <span class="number">6</span>:         <span class="comment">// Move the PoolChunk down the PoolChunkList linked-list.</span></span><br><span class="line"> <span class="number">7</span>:         <span class="keyword">return</span> move0(chunk);</span><br><span class="line"> <span class="number">8</span>:     }</span><br><span class="line"> <span class="number">9</span>: </span><br><span class="line"><span class="number">10</span>:     <span class="comment">// æ‰§è¡ŒçœŸæ­£çš„æ·»åŠ </span></span><br><span class="line"><span class="number">11</span>:     <span class="comment">// PoolChunk fits into this PoolChunkList, adding it here.</span></span><br><span class="line"><span class="number">12</span>:     add0(chunk);</span><br><span class="line"><span class="number">13</span>:     <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">14</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ç¬¬ 4 è‡³ 8 è¡Œï¼šå°äºå½“å‰ ChunkList ç®¡ç†çš„ Chunk çš„å†…å­˜ä½¿ç”¨ç‡ä¸‹é™ï¼Œè°ƒç”¨ <code>#move0(PoolChunk&lt;T&gt; chunk)</code> æ–¹æ³•ï¼Œç»§ç»­é€’å½’åˆ°ä¸Šä¸€ä¸ª ChunkList èŠ‚ç‚¹è¿›è¡Œæ·»åŠ ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">move</span><span class="params">(PoolChunk&lt;T&gt; chunk)</span> </span>{</span><br><span class="line">    <span class="keyword">assert</span> chunk.usage() &lt; maxUsage;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°äºå½“å‰ ChunkList ç®¡ç†çš„ Chunk çš„å†…å­˜ä½¿ç”¨ç‡ä¸‹é™ï¼Œç»§ç»­é€’å½’åˆ°ä¸Šä¸€ä¸ª ChunkList èŠ‚ç‚¹è¿›è¡Œæ·»åŠ ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (chunk.usage() &lt; minUsage) {</span><br><span class="line">        <span class="comment">// Move the PoolChunk down the PoolChunkList linked-list.</span></span><br><span class="line">        <span class="keyword">return</span> move0(chunk);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ‰§è¡ŒçœŸæ­£çš„æ·»åŠ </span></span><br><span class="line">    <span class="comment">// PoolChunk fits into this PoolChunkList, adding it here.</span></span><br><span class="line">    add0(chunk);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li>ç¬¬ 12 è¡Œï¼šè°ƒç”¨ <code>#add0(PoolChunk&lt;T&gt; chunk)</code> æ–¹æ³•ï¼Œæ‰§è¡ŒçœŸæ­£çš„æ·»åŠ ã€‚</li>
<li>ç¬¬ 13 è¡Œï¼šè¿”å› <code>true</code> ï¼Œç§»åŠ¨æˆåŠŸã€‚   </li>
</ul>
<h2 id="2-5-iterator"><a href="#2-5-iterator" class="headerlink" title="2.5 iterator"></a>2.5 iterator</h2><p><code>#iterator()</code> æ–¹æ³•ï¼Œåˆ›å»º Iterator å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Iterator&lt;PoolChunkMetric&gt; EMPTY_METRICS = Collections.&lt;PoolChunkMetric&gt;emptyList().iterator();</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Iterator&lt;PoolChunkMetric&gt; <span class="title">iterator</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">synchronized</span> (arena) {</span><br><span class="line">        <span class="comment">// ç©ºï¼Œè¿”å› EMPTY_METRICS</span></span><br><span class="line">        <span class="keyword">if</span> (head == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">return</span> EMPTY_METRICS;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// ç”Ÿæˆæ•°ç»„ï¼Œåç”Ÿæˆ Iterator</span></span><br><span class="line">        List&lt;PoolChunkMetric&gt; metrics = <span class="keyword">new</span> ArrayList&lt;PoolChunkMetric&gt;();</span><br><span class="line">        <span class="keyword">for</span> (PoolChunk&lt;T&gt; cur = head;;) {</span><br><span class="line">            metrics.add(cur);</span><br><span class="line">            cur = cur.next;</span><br><span class="line">            <span class="keyword">if</span> (cur == <span class="keyword">null</span>) {</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> metrics.iterator();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-6-destroy"><a href="#2-6-destroy" class="headerlink" title="2.6 destroy"></a>2.6 destroy</h2><p><code>#destroy()</code> æ–¹æ³•ï¼Œé”€æ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">(PoolArena&lt;T&gt; arena)</span> </span>{</span><br><span class="line">    <span class="comment">// å¾ªç¯ï¼Œé”€æ¯ ChunkList ç®¡ç†çš„æ‰€æœ‰ Chunk</span></span><br><span class="line">    PoolChunk&lt;T&gt; chunk = head;</span><br><span class="line">    <span class="keyword">while</span> (chunk != <span class="keyword">null</span>) {</span><br><span class="line">        arena.destroyChunk(chunk);</span><br><span class="line">        chunk = chunk.next;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// ç½®ç©º</span></span><br><span class="line">    head = <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-7-PoolChunkListMetric"><a href="#2-7-PoolChunkListMetric" class="headerlink" title="2.7 PoolChunkListMetric"></a>2.7 PoolChunkListMetric</h2><p><code>io.netty.buffer.PoolChunkListMetric</code> ï¼Œç»§æ‰¿ Iterable æ¥å£ï¼ŒPoolChunkList Metric æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PoolChunkListMetric</span> <span class="keyword">extends</span> <span class="title">Iterable</span>&lt;<span class="title">PoolChunkMetric</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the minimum usage of the chunk list before which chunks are promoted to the previous list.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">minUsage</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the maximum usage of the chunk list after which chunks are promoted to the next list.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">maxUsage</span><span class="params">()</span></span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p>PoolChunkList å¯¹ PoolChunkMetric æ¥å£çš„å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">minUsage</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> minUsage0(minUsage);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxUsage</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> min(maxUsage, <span class="number">100</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="3-PoolChunkList-åˆå§‹åŒ–"><a href="#3-PoolChunkList-åˆå§‹åŒ–" class="headerlink" title="3. PoolChunkList åˆå§‹åŒ–"></a>3. PoolChunkList åˆå§‹åŒ–</h1><p>åœ¨ PoolChunkArena ä¸­ï¼Œåˆå§‹åŒ– PoolChunkList ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// PoolChunkList ä¹‹é—´çš„åŒå‘é“¾è¡¨</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolChunkList&lt;T&gt; q050;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolChunkList&lt;T&gt; q025;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolChunkList&lt;T&gt; q000;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolChunkList&lt;T&gt; qInit;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolChunkList&lt;T&gt; q075;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolChunkList&lt;T&gt; q100;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * PoolChunkListMetric æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;PoolChunkListMetric&gt; chunkListMetrics;</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">protected</span> <span class="title">PoolArena</span><span class="params">(PooledByteBufAllocator parent, <span class="keyword">int</span> pageSize,</span></span></span><br><span class="line"><span class="function"><span class="params">  <span class="number">2</span>:       <span class="keyword">int</span> maxOrder, <span class="keyword">int</span> pageShifts, <span class="keyword">int</span> chunkSize, <span class="keyword">int</span> cacheAlignment)</span> </span>{</span><br><span class="line">  <span class="number">3</span>:       </span><br><span class="line">  <span class="number">4</span>:     <span class="comment">// ... çœç•¥å…¶å®ƒæ— å…³ä»£ç </span></span><br><span class="line">  <span class="number">5</span>:       </span><br><span class="line">  <span class="number">6</span>:     <span class="comment">// PoolChunkList ä¹‹é—´çš„åŒå‘é“¾è¡¨ï¼Œåˆå§‹åŒ–</span></span><br><span class="line">  <span class="number">7</span>: </span><br><span class="line">  <span class="number">8</span>:     q100 = <span class="keyword">new</span> PoolChunkList&lt;T&gt;(<span class="keyword">this</span>, <span class="keyword">null</span>, <span class="number">100</span>, Integer.MAX_VALUE, chunkSize);</span><br><span class="line">  <span class="number">9</span>:     q075 = <span class="keyword">new</span> PoolChunkList&lt;T&gt;(<span class="keyword">this</span>, q100, <span class="number">75</span>, <span class="number">100</span>, chunkSize);</span><br><span class="line"> <span class="number">10</span>:     q050 = <span class="keyword">new</span> PoolChunkList&lt;T&gt;(<span class="keyword">this</span>, q075, <span class="number">50</span>, <span class="number">100</span>, chunkSize);</span><br><span class="line"> <span class="number">11</span>:     q025 = <span class="keyword">new</span> PoolChunkList&lt;T&gt;(<span class="keyword">this</span>, q050, <span class="number">25</span>, <span class="number">75</span>, chunkSize);</span><br><span class="line"> <span class="number">12</span>:     q000 = <span class="keyword">new</span> PoolChunkList&lt;T&gt;(<span class="keyword">this</span>, q025, <span class="number">1</span>, <span class="number">50</span>, chunkSize);</span><br><span class="line"> <span class="number">13</span>:     qInit = <span class="keyword">new</span> PoolChunkList&lt;T&gt;(<span class="keyword">this</span>, q000, Integer.MIN_VALUE, <span class="number">25</span>, chunkSize);</span><br><span class="line"> <span class="number">14</span>:     </span><br><span class="line"> <span class="number">15</span>:     q100.prevList(q075);</span><br><span class="line"> <span class="number">16</span>:     q075.prevList(q050);</span><br><span class="line"> <span class="number">17</span>:     q050.prevList(q025);</span><br><span class="line"> <span class="number">18</span>:     q025.prevList(q000);</span><br><span class="line"> <span class="number">19</span>:     q000.prevList(<span class="keyword">null</span>); <span class="comment">// æ— å‰ç½®èŠ‚ç‚¹</span></span><br><span class="line"> <span class="number">20</span>:     qInit.prevList(qInit); <span class="comment">// å‰ç½®èŠ‚ç‚¹ä¸ºè‡ªå·±</span></span><br><span class="line"> <span class="number">21</span>:     </span><br><span class="line"> <span class="number">22</span>:     <span class="comment">// åˆ›å»º PoolChunkListMetric æ•°ç»„</span></span><br><span class="line"> <span class="number">23</span>:     List&lt;PoolChunkListMetric&gt; metrics = <span class="keyword">new</span> ArrayList&lt;PoolChunkListMetric&gt;(<span class="number">6</span>);</span><br><span class="line"> <span class="number">24</span>:     metrics.add(qInit);</span><br><span class="line"> <span class="number">25</span>:     metrics.add(q000);</span><br><span class="line"> <span class="number">26</span>:     metrics.add(q025);</span><br><span class="line"> <span class="number">27</span>:     metrics.add(q050);</span><br><span class="line"> <span class="number">28</span>:     metrics.add(q075);</span><br><span class="line"> <span class="number">29</span>:     metrics.add(q100);</span><br><span class="line"> <span class="number">30</span>:     chunkListMetrics = Collections.unmodifiableList(metrics);</span><br><span class="line"> <span class="number">31</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>PoolChunkList ä¹‹é—´çš„åŒå‘é“¾è¡¨æœ‰ <code>qInit</code>ã€<code>q000</code>ã€<code>q025</code>ã€<code>q050</code>ã€<code>q075</code>ã€<code>q100</code> æœ‰ 6 ä¸ªèŠ‚ç‚¹ï¼Œåœ¨ã€ç¬¬ 6 è‡³ 20 è¡Œã€‘çš„ä»£ç ï¼Œè¿›è¡Œ<strong>åˆå§‹åŒ–</strong>ã€‚é“¾è¡¨å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// æ­£å‘</span></span><br><span class="line">qInit -&gt; q000 -&gt; q025 -&gt; q050 -&gt; q075 -&gt; q100 -&gt; <span class="keyword">null</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é€†å‘</span></span><br><span class="line"><span class="keyword">null</span> &lt;- q000 &lt;- q025 &lt;- q050 &lt;- q075 &lt;- q100</span><br><span class="line">qInit &lt;- qInit</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ¯”è¾ƒç¥å¥‡çš„æ˜¯ï¼Œ<code>qInit</code> æŒ‡å‘è‡ªå·±ï¼Ÿï¼<code>qInit</code> ç”¨é€”æ˜¯ï¼Œæ–°åˆ›å»ºçš„ Chunk å†…å­˜å— <code>chunk_new</code>( è¿™åªæ˜¯ä¸ªä»£å·ï¼Œæ–¹ä¾¿æè¿° ) ï¼Œæ·»åŠ åˆ° <code>qInit</code> åï¼Œä¸ä¼šè¢«é‡Šæ”¾æ‰ã€‚<ul>
<li>ä¸ºä»€ä¹ˆä¸ä¼šè¢«é‡Šæ”¾æ‰ï¼Ÿ<code>qInit.minUsage = Integer.MIN_VALUE</code> ï¼Œæ‰€ä»¥åœ¨ <code>PoolChunkList#move(PoolChunk chunk)</code> æ–¹æ³•ä¸­ï¼Œ<code>chunk_new</code> çš„å†…å­˜ä½¿ç”¨ç‡æœ€å°å€¼ä¸º 0 ï¼Œæ‰€ä»¥è‚¯å®šä¸ä¼šè¢«é‡Šæ”¾ã€‚</li>
<li>é‚£å²‚ä¸æ˜¯ <code>chunk_new</code> æ— æ³•è¢«é‡Šæ”¾ï¼Ÿéšç€ <code>chunk_new</code> é€æ¸åˆ†é…å†…å­˜ï¼Œå†…å­˜ä½¿ç”¨ç‡åˆ°è¾¾ 25 ( <code>qInit.maxUsage</code> )åï¼Œä¼šç§»åŠ¨åˆ° <code>q000</code> ã€‚å†éšç€ <code>chunk_new</code> é€æ¸é‡Šæ”¾å†…å­˜ï¼Œå†…å­˜ä½¿ç”¨ç‡é™åˆ° 0 (<code>q000.minUsage</code>) åï¼Œå°±å¯ä»¥è¢«é‡Šæ”¾ã€‚</li>
</ul>
</li>
<li>å½“ç„¶ï¼Œå¦‚æœæ–°åˆ›å»ºçš„ Chunk å†…å­˜å— <code>chunk_new</code> <strong>ç¬¬ä¸€æ¬¡</strong>åˆ†é…çš„å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡ 25 ( <code>qInit.maxUsage</code> )ï¼Œä¸ä¼šè¿›å…¥ <code>qInit</code> ä¸­ï¼Œè€Œæ˜¯è¿›å…¥åé¢çš„ PoolChunkList èŠ‚ç‚¹ã€‚</li>
</ul>
</li>
<li><code>chunkListMetrics</code> å±æ€§ï¼ŒPoolChunkListMetric æ•°ç»„ã€‚åœ¨ã€ç¬¬ 22 è‡³ 30 è¡Œã€‘çš„ä»£ç ï¼Œè¿›è¡Œ<strong>åˆå§‹åŒ–</strong>ã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>PoolChunList ç›¸æ¯” PoolSubpage æ¥è¯´ï¼Œåˆåˆåˆæ›´åŠ ç®€å•å•¦ã€‚</p>
<p>è€è‰¿è‰¿æ•´ç†äº†ä¸‹ Arenaã€ChunkListã€Chunkã€Pageã€Subpage çš„â€œæ“çºµâ€å…³ç³»å¦‚ä¸‹å›¾ï¼š</p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_09_10/02.png" title="PoolSubpage" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_09_10/02.png" alt="PoolSubpage"></a><span class="caption">PoolSubpage</span></p>
<ul>
<li>å½“ç„¶ï¼Œè¿™ä¸æ˜¯ä¸€å¹…ä¸¥è°¨çš„å›¾ï¼Œä»…ä»…è¡¨è¾¾â€œæ“çºµâ€çš„å…³ç³»ã€‚</li>
</ul>
<p>å‚è€ƒå¦‚ä¸‹æ–‡ç« ï¼š</p>
<ul>
<li>Hypercube <a href="https://www.jianshu.com/p/2b8375df2d1a" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆåï¼‰â€“PoolChunkListã€‹</a></li>
<li>å å°ç‹¼ <a href="https://www.jianshu.com/p/4856bd30dd56" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥æµ…å‡ºNettyå†…å­˜ç®¡ç† PoolChunkListã€‹</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/ByteBuf-3-4-Jemalloc-chunkList/" data-id="ck4pl3fp600e6fgcf7qikzp5l" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>