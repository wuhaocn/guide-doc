<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç åˆ†æ â€”â€” å¯åŠ¨ï¼ˆäºŒï¼‰ä¹‹å®¢æˆ·ç«¯
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥åˆ†äº« Bootstrap åˆ†äº« Netty å®¢æˆ·ç«¯ã€‚å› ä¸ºæˆ‘ä»¬æ—¥å¸¸ä½¿ç”¨ Netty ä¸»è¦ä½¿ç”¨ NIO éƒ¨åˆ†ï¼Œæ‰€ä»¥æœ¬æ–‡ä¹Ÿåªåˆ†äº« Netty NIO å®¢æˆ·ç«¯ã€‚</p>
<h1 id="2-Bootstrap-ç¤ºä¾‹"><a href="#2-Bootstrap-ç¤ºä¾‹" class="headerlink" title="2. Bootstrap ç¤ºä¾‹"></a>2. Bootstrap ç¤ºä¾‹</h1><p>ä¸‹é¢ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸ª ServerBootstrap çš„ä½¿ç”¨ç¤ºä¾‹ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨ <a href="http://svip.iocoder.cn/Netty/build-debugging-environment/#5-2-EchoClient">ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” è°ƒè¯•ç¯å¢ƒæ­å»ºã€‹</a> æ­å»ºçš„ EchoClient ç¤ºä¾‹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">EchoClient</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> SSL = System.getProperty(<span class="string">"ssl"</span>) != <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> String HOST = System.getProperty(<span class="string">"host"</span>, <span class="string">"127.0.0.1"</span>);</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PORT = Integer.parseInt(System.getProperty(<span class="string">"port"</span>, <span class="string">"8007"</span>));</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIZE = Integer.parseInt(System.getProperty(<span class="string">"size"</span>, <span class="string">"256"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// Configure SSL.git</span></span><br><span class="line">        <span class="comment">// é…ç½® SSL</span></span><br><span class="line">        <span class="keyword">final</span> SslContext sslCtx;</span><br><span class="line">        <span class="keyword">if</span> (SSL) {</span><br><span class="line">            sslCtx = SslContextBuilder.forClient()</span><br><span class="line">                .trustManager(InsecureTrustManagerFactory.INSTANCE).build();</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            sslCtx = <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Configure the client.</span></span><br><span class="line">        <span class="comment">// åˆ›å»ºä¸€ä¸ª EventLoopGroup å¯¹è±¡</span></span><br><span class="line">        EventLoopGroup group = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// åˆ›å»º Bootstrap å¯¹è±¡</span></span><br><span class="line">            Bootstrap b = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">            b.group(group) <span class="comment">// è®¾ç½®ä½¿ç”¨çš„ EventLoopGroup</span></span><br><span class="line">             .channel(NioSocketChannel.class) <span class="comment">// è®¾ç½®è¦è¢«å®ä¾‹åŒ–çš„ä¸º NioSocketChannel ç±»</span></span><br><span class="line">             .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>) <span class="comment">// è®¾ç½® NioSocketChannel çš„å¯é€‰é¡¹</span></span><br><span class="line">             .handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() { <span class="comment">// è®¾ç½® NioSocketChannel çš„å¤„ç†å™¨</span></span><br><span class="line">                 <span class="meta">@Override</span></span><br><span class="line">                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">                     ChannelPipeline p = ch.pipeline();</span><br><span class="line">                     <span class="keyword">if</span> (sslCtx != <span class="keyword">null</span>) {</span><br><span class="line">                         p.addLast(sslCtx.newHandler(ch.alloc(), HOST, PORT));</span><br><span class="line">                     }</span><br><span class="line">                     <span class="comment">//p.addLast(new LoggingHandler(LogLevel.INFO));</span></span><br><span class="line">                     p.addLast(<span class="keyword">new</span> EchoClientHandler());</span><br><span class="line">                 }</span><br><span class="line">             });</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Start the client.</span></span><br><span class="line">            <span class="comment">// è¿æ¥æœåŠ¡å™¨ï¼Œå¹¶åŒæ­¥ç­‰å¾…æˆåŠŸï¼Œå³å¯åŠ¨å®¢æˆ·ç«¯</span></span><br><span class="line">            ChannelFuture f = b.connect(HOST, PORT).sync();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Wait until the connection is closed.</span></span><br><span class="line">            <span class="comment">// ç›‘å¬å®¢æˆ·ç«¯å…³é—­ï¼Œå¹¶é˜»å¡ç­‰å¾…</span></span><br><span class="line">            f.channel().closeFuture().sync();</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="comment">// Shut down the event loop to terminate all threads.</span></span><br><span class="line">            <span class="comment">// ä¼˜é›…å…³é—­ä¸€ä¸ª EventLoopGroup å¯¹è±¡</span></span><br><span class="line">            group.shutdownGracefully();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¤ºä¾‹æ¯”è¾ƒç®€å•ï¼Œå·²ç»æ·»åŠ ä¸­æ–‡æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚</li>
</ul>
<h1 id="3-Bootstrap"><a href="#3-Bootstrap" class="headerlink" title="3. Bootstrap"></a>3. Bootstrap</h1><p><code>io.netty.bootstrap.Bootstrap</code> ï¼Œå®ç° AbstractBootstrap æŠ½è±¡ç±»ï¼Œç”¨äº Client çš„å¯åŠ¨å™¨å®ç°ç±»ã€‚</p>
<h2 id="3-1-æ„é€ æ–¹æ³•"><a href="#3-1-æ„é€ æ–¹æ³•" class="headerlink" title="3.1 æ„é€ æ–¹æ³•"></a>3.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é»˜è®¤åœ°å€è§£æå™¨å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AddressResolverGroup&lt;?&gt; DEFAULT_RESOLVER = DefaultAddressResolverGroup.INSTANCE;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯åŠ¨ç±»é…ç½®å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BootstrapConfig config = <span class="keyword">new</span> BootstrapConfig(<span class="keyword">this</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åœ°å€è§£æå™¨å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> AddressResolverGroup&lt;SocketAddress&gt; resolver = (AddressResolverGroup&lt;SocketAddress&gt;) DEFAULT_RESOLVER;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿æ¥åœ°å€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> SocketAddress remoteAddress;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Bootstrap</span><span class="params">()</span> </span>{ }</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Bootstrap</span><span class="params">(Bootstrap bootstrap)</span> </span>{</span><br><span class="line">    <span class="keyword">super</span>(bootstrap);</span><br><span class="line">    resolver = bootstrap.resolver;</span><br><span class="line">    remoteAddress = bootstrap.remoteAddress;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>config</code> å±æ€§ï¼ŒBootstrapConfig å¯¹è±¡ï¼Œå¯åŠ¨ç±»é…ç½®å¯¹è±¡ã€‚</li>
<li><code>resolver</code> å±æ€§ï¼Œåœ°å€è§£æå™¨å¯¹è±¡ã€‚ç»å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½¿ç”¨ <code>DEFAULT_RESOLVER</code> å³å¯ã€‚</li>
<li><code>remoteAddress</code> å±æ€§ï¼Œè¿æ¥åœ°å€ã€‚</li>
</ul>
<h2 id="3-2-resolver"><a href="#3-2-resolver" class="headerlink" title="3.2 resolver"></a>3.2 resolver</h2><p><code>#resolver(AddressResolverGroup&lt;?&gt; resolver)</code> æ–¹æ³•ï¼Œè®¾ç½® <code>resolver</code> å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Bootstrap <span class="title">resolver</span><span class="params">(AddressResolverGroup&lt;?&gt; resolver)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.resolver = (AddressResolverGroup&lt;SocketAddress&gt;) (resolver == <span class="keyword">null</span> ? DEFAULT_RESOLVER : resolver);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-3-remoteAddress"><a href="#3-3-remoteAddress" class="headerlink" title="3.3 remoteAddress"></a>3.3 remoteAddress</h2><p><code>#remoteAddress(...)</code> æ–¹æ³•ï¼Œè®¾ç½® <code>remoteAddress</code> å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Bootstrap <span class="title">resolver</span><span class="params">(AddressResolverGroup&lt;?&gt; resolver)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.resolver = (AddressResolverGroup&lt;SocketAddress&gt;) (resolver == <span class="keyword">null</span> ? DEFAULT_RESOLVER : resolver);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Bootstrap <span class="title">remoteAddress</span><span class="params">(SocketAddress remoteAddress)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.remoteAddress = remoteAddress;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Bootstrap <span class="title">remoteAddress</span><span class="params">(String inetHost, <span class="keyword">int</span> inetPort)</span> </span>{</span><br><span class="line">    remoteAddress = InetSocketAddress.createUnresolved(inetHost, inetPort);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Bootstrap <span class="title">remoteAddress</span><span class="params">(InetAddress inetHost, <span class="keyword">int</span> inetPort)</span> </span>{</span><br><span class="line">    remoteAddress = <span class="keyword">new</span> InetSocketAddress(inetHost, inetPort);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-4-validate"><a href="#3-4-validate" class="headerlink" title="3.4 validate"></a>3.4 validate</h2><p><code>#validate()</code> æ–¹æ³•ï¼Œæ ¡éªŒé…ç½®æ˜¯å¦æ­£ç¡®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Bootstrap <span class="title">validate</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// çˆ¶ç±»æ ¡éªŒ</span></span><br><span class="line">    <span class="keyword">super</span>.validate();</span><br><span class="line">    <span class="comment">// handler éç©º</span></span><br><span class="line">    <span class="keyword">if</span> (config.handler() == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"handler not set"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨ <code>#connect(...)</code> æ–¹æ³•ä¸­ï¼Œè¿æ¥æœåŠ¡ç«¯æ—¶ï¼Œä¼šè°ƒç”¨è¯¥æ–¹æ³•è¿›è¡Œæ ¡éªŒã€‚</li>
</ul>
<h2 id="3-5-clone"><a href="#3-5-clone" class="headerlink" title="3.5 clone"></a>3.5 clone</h2><p><code>#clone(...)</code> æ–¹æ³•ï¼Œå…‹éš† Bootstrap å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Bootstrap <span class="title">clone</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Bootstrap(<span class="keyword">this</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Bootstrap <span class="title">clone</span><span class="params">(EventLoopGroup group)</span> </span>{</span><br><span class="line">    Bootstrap bs = <span class="keyword">new</span> Bootstrap(<span class="keyword">this</span>);</span><br><span class="line">    bs.group = group;</span><br><span class="line">    <span class="keyword">return</span> bs;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¸¤ä¸ªå…‹éš†æ–¹æ³•ï¼Œéƒ½æ˜¯è°ƒç”¨å‚æ•°ä¸º <code>bootstrap</code> ä¸º Bootstrap æ„é€ æ–¹æ³•ï¼Œå…‹éš†ä¸€ä¸ª Bootstrap å¯¹è±¡ã€‚å·®åˆ«åœ¨äºï¼Œä¸‹é¢çš„æ–¹æ³•ï¼Œå¤šäº†å¯¹ <code>group</code> å±æ€§çš„èµ‹å€¼ã€‚</li>
</ul>
<h2 id="3-6-connect"><a href="#3-6-connect" class="headerlink" title="3.6 connect"></a>3.6 connect</h2><p><code>#connect(...)</code> æ–¹æ³•ï¼Œè¿æ¥æœåŠ¡ç«¯ï¼Œå³å¯åŠ¨å®¢æˆ·ç«¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">connect</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// æ ¡éªŒå¿…è¦å‚æ•°</span></span><br><span class="line">    validate();</span><br><span class="line">    SocketAddress remoteAddress = <span class="keyword">this</span>.remoteAddress;</span><br><span class="line">    <span class="keyword">if</span> (remoteAddress == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"remoteAddress not set"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// è§£æè¿œç¨‹åœ°å€ï¼Œå¹¶è¿›è¡Œè¿æ¥</span></span><br><span class="line">    <span class="keyword">return</span> doResolveAndConnect(remoteAddress, config.localAddress());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">connect</span><span class="params">(String inetHost, <span class="keyword">int</span> inetPort)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> connect(InetSocketAddress.createUnresolved(inetHost, inetPort));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">connect</span><span class="params">(InetAddress inetHost, <span class="keyword">int</span> inetPort)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> connect(<span class="keyword">new</span> InetSocketAddress(inetHost, inetPort));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">connect</span><span class="params">(SocketAddress remoteAddress)</span> </span>{</span><br><span class="line">    <span class="comment">// æ ¡éªŒå¿…è¦å‚æ•°</span></span><br><span class="line">    validate();</span><br><span class="line">    <span class="keyword">if</span> (remoteAddress == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"remoteAddress"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// è§£æè¿œç¨‹åœ°å€ï¼Œå¹¶è¿›è¡Œè¿æ¥</span></span><br><span class="line">    <span class="keyword">return</span> doResolveAndConnect(remoteAddress, config.localAddress());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">connect</span><span class="params">(SocketAddress remoteAddress, SocketAddress localAddress)</span> </span>{</span><br><span class="line">    <span class="comment">// æ ¡éªŒå¿…è¦å‚æ•°</span></span><br><span class="line">    validate();</span><br><span class="line">    <span class="keyword">if</span> (remoteAddress == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"remoteAddress"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// è§£æè¿œç¨‹åœ°å€ï¼Œå¹¶è¿›è¡Œè¿æ¥</span></span><br><span class="line">    <span class="keyword">return</span> doResolveAndConnect(remoteAddress, localAddress);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¯¥æ–¹æ³•è¿”å›çš„æ˜¯ ChannelFuture å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯<strong>å¼‚æ­¥</strong>çš„è¿æ¥æœåŠ¡ç«¯ï¼Œå¯åŠ¨å®¢æˆ·ç«¯ã€‚å¦‚æœéœ€è¦<strong>åŒæ­¥</strong>ï¼Œåˆ™éœ€è¦è°ƒç”¨ <code>ChannelFuture#sync()</code> æ–¹æ³•ã€‚</li>
</ul>
<p><code>#connect(...)</code> æ–¹æ³•ï¼Œæ ¸å¿ƒæµç¨‹å¦‚ä¸‹å›¾ï¼š</p>
<p><code>#bind(...)</code> æ–¹æ³•ï¼Œæ ¸å¿ƒæµç¨‹å¦‚ä¸‹å›¾ï¼š</p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_04_05/01.png" title="æ ¸å¿ƒæµç¨‹" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_04_05/01.png" alt="æ ¸å¿ƒæµç¨‹"></a><span class="caption">æ ¸å¿ƒæµç¨‹</span></p>
<ul>
<li>ä¸»è¦æœ‰ 5 ä¸ªæ­¥éª¤ï¼Œä¸‹é¢æˆ‘ä»¬æ¥æ‹†è§£ä»£ç ï¼Œçœ‹çœ‹å’Œæˆ‘ä»¬åœ¨ <a href="http://svip.iocoder.cn/Netty/nio-5-demo/?self">ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” NIO åŸºç¡€ï¼ˆäº”ï¼‰ä¹‹ç¤ºä¾‹ã€‹</a> çš„ NioClient çš„ä»£ç ï¼Œæ˜¯<strong>æ€ä¹ˆå¯¹åº”</strong>çš„ã€‚</li>
<li>ç›¸æ¯” <code>#bind(...)</code> æ–¹æ³•çš„æµç¨‹ï¼Œä¸»è¦æ˜¯<strong>ç»¿è‰²</strong>çš„ 2 ä¸ªæ­¥éª¤ã€‚</li>
</ul>
<h3 id="3-6-1-doResolveAndConnect"><a href="#3-6-1-doResolveAndConnect" class="headerlink" title="3.6.1 doResolveAndConnect"></a>3.6.1 doResolveAndConnect</h3><p><code>#doResolveAndConnect(final SocketAddress remoteAddress, final SocketAddress localAddress)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> ChannelFuture <span class="title">doResolveAndConnect</span><span class="params">(<span class="keyword">final</span> SocketAddress remoteAddress, <span class="keyword">final</span> SocketAddress localAddress)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// åˆå§‹åŒ–å¹¶æ³¨å†Œä¸€ä¸ª Channel å¯¹è±¡ï¼Œå› ä¸ºæ³¨å†Œæ˜¯å¼‚æ­¥çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥è¿”å›ä¸€ä¸ª ChannelFuture å¯¹è±¡ã€‚</span></span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">final</span> ChannelFuture regFuture = initAndRegister();</span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">final</span> Channel channel = regFuture.channel();</span><br><span class="line"> <span class="number">5</span>: </span><br><span class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (regFuture.isDone()) {</span><br><span class="line"> <span class="number">7</span>:         <span class="comment">// è‹¥æ‰§è¡Œå¤±è´¥ï¼Œç›´æ¥è¿›è¡Œè¿”å›ã€‚</span></span><br><span class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (!regFuture.isSuccess()) {</span><br><span class="line"> <span class="number">9</span>:             <span class="keyword">return</span> regFuture;</span><br><span class="line"><span class="number">10</span>:         }</span><br><span class="line"><span class="number">11</span>:         <span class="comment">// è§£æè¿œç¨‹åœ°å€ï¼Œå¹¶è¿›è¡Œè¿æ¥</span></span><br><span class="line"><span class="number">12</span>:         <span class="keyword">return</span> doResolveAndConnect0(channel, remoteAddress, localAddress, channel.newPromise());</span><br><span class="line"><span class="number">13</span>:     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">14</span>:         <span class="comment">// Registration future is almost always fulfilled already, but just in case it's not.</span></span><br><span class="line"><span class="number">15</span>:         <span class="keyword">final</span> PendingRegistrationPromise promise = <span class="keyword">new</span> PendingRegistrationPromise(channel);</span><br><span class="line"><span class="number">16</span>:         regFuture.addListener(<span class="keyword">new</span> ChannelFutureListener() {</span><br><span class="line"><span class="number">17</span>: </span><br><span class="line"><span class="number">18</span>:             <span class="meta">@Override</span></span><br><span class="line"><span class="number">19</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"><span class="number">20</span>:                 <span class="comment">// Directly obtain the cause and do a null check so we only need one volatile read in case of a</span></span><br><span class="line"><span class="number">21</span>:                 <span class="comment">// failure.</span></span><br><span class="line"><span class="number">22</span>:                 Throwable cause = future.cause();</span><br><span class="line"><span class="number">23</span>:                 <span class="keyword">if</span> (cause != <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">24</span>:                     <span class="comment">// Registration on the EventLoop failed so fail the ChannelPromise directly to not cause an</span></span><br><span class="line"><span class="number">25</span>:                     <span class="comment">// IllegalStateException once we try to access the EventLoop of the Channel.</span></span><br><span class="line"><span class="number">26</span>:                     promise.setFailure(cause);</span><br><span class="line"><span class="number">27</span>:                 } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">28</span>:                     <span class="comment">// Registration was successful, so set the correct executor to use.</span></span><br><span class="line"><span class="number">29</span>:                     <span class="comment">// See https://github.com/netty/netty/issues/2586</span></span><br><span class="line"><span class="number">30</span>:                     promise.registered();</span><br><span class="line"><span class="number">31</span>: </span><br><span class="line"><span class="number">32</span>:                     <span class="comment">// è§£æè¿œç¨‹åœ°å€ï¼Œå¹¶è¿›è¡Œè¿æ¥</span></span><br><span class="line"><span class="number">33</span>:                     doResolveAndConnect0(channel, remoteAddress, localAddress, promise);</span><br><span class="line"><span class="number">34</span>:                 }</span><br><span class="line"><span class="number">35</span>:             }</span><br><span class="line"><span class="number">36</span>: </span><br><span class="line"><span class="number">37</span>:         });</span><br><span class="line"><span class="number">38</span>:         <span class="keyword">return</span> promise;</span><br><span class="line"><span class="number">39</span>:     }</span><br><span class="line"><span class="number">40</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šè°ƒç”¨ <code>#initAndRegister()</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–å¹¶æ³¨å†Œä¸€ä¸ª Channel å¯¹è±¡ã€‚å› ä¸ºæ³¨å†Œæ˜¯<strong>å¼‚æ­¥</strong>çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥è¿”å›ä¸€ä¸ª ChannelFuture å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ3.7 initAndRegisterã€</a> ã€‚<ul>
<li>ç¬¬ 6 è‡³ 10 è¡Œï¼šè‹¥æ‰§è¡Œå¤±è´¥ï¼Œç›´æ¥è¿›è¡Œè¿”å› <code>regFuture</code> å¯¹è±¡ã€‚ </li>
</ul>
</li>
<li>ç¬¬ 9 è‡³ 37 è¡Œï¼šå› ä¸ºæ³¨å†Œæ˜¯<strong>å¼‚æ­¥</strong>çš„è¿‡ç¨‹ï¼Œæœ‰å¯èƒ½å·²å®Œæˆï¼Œæœ‰å¯èƒ½æœªå®Œæˆã€‚æ‰€ä»¥å®ç°ä»£ç åˆ†æˆäº†ã€ç¬¬ 12 è¡Œã€‘å’Œã€ç¬¬ 13 è‡³ 37 è¡Œã€‘åˆ†åˆ«å¤„ç†å·²å®Œæˆå’Œæœªå®Œæˆçš„æƒ…å†µã€‚<ul>
<li><strong>æ ¸å¿ƒ</strong>åœ¨ã€ç¬¬ 12 è¡Œã€‘æˆ–è€…ã€ç¬¬ 33 è¡Œã€‘çš„ä»£ç ï¼Œè°ƒç”¨ <code>#doResolveAndConnect0(final Channel channel, SocketAddress remoteAddress, final SocketAddress localAddress, final ChannelPromise promise)</code> æ–¹æ³•ï¼Œè§£æè¿œç¨‹åœ°å€ï¼Œå¹¶è¿›è¡Œè¿æ¥ã€‚</li>
<li>å¦‚æœ<strong>å¼‚æ­¥</strong>æ³¨å†Œå¯¹åº”çš„ ChanelFuture æœªå®Œæˆï¼Œåˆ™è°ƒç”¨ <code>ChannelFuture#addListener(ChannelFutureListener)</code> æ–¹æ³•ï¼Œæ·»åŠ ç›‘å¬å™¨ï¼Œåœ¨<strong>æ³¨å†Œ</strong>å®Œæˆåï¼Œè¿›è¡Œå›è°ƒæ‰§è¡Œ <code>#doResolveAndConnect0(...)</code> æ–¹æ³•çš„é€»è¾‘ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ3.6.2 doResolveAndConnect0ã€</a> ã€‚</li>
<li>æ‰€ä»¥æ€»ç»“æ¥è¯´ï¼Œ<strong>resolve å’Œ connect çš„é€»è¾‘ï¼Œæ‰§è¡Œåœ¨ register çš„é€»è¾‘ä¹‹å</strong>ã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-6-2-doResolveAndConnect0"><a href="#3-6-2-doResolveAndConnect0" class="headerlink" title="3.6.2 doResolveAndConnect0"></a>3.6.2 doResolveAndConnect0</h3><blockquote>
<p>è€è‰¿è‰¿ï¼šæ­¤å°èŠ‚çš„å†…å®¹ï¼Œèƒ–å‹å…ˆçœ‹å®Œ <a href="#">ã€Œ3.7 initAndRegisterã€</a> çš„å†…å®¹åœ¨å›è¿‡å¤´æ¥çœ‹ã€‚å› ä¸º <code>#doResolveAndConnect0(...)</code> æ–¹æ³•çš„æ‰§è¡Œï¼Œåœ¨ <code>#initAndRegister()</code> æ–¹æ³•ä¹‹åã€‚</p>
</blockquote>
<p><code>#doResolveAndConnect0(...)</code> æ–¹æ³•ï¼Œè§£æè¿œç¨‹åœ°å€ï¼Œå¹¶è¿›è¡Œè¿æ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> ChannelFuture <span class="title">doResolveAndConnect0</span><span class="params">(<span class="keyword">final</span> Channel channel, SocketAddress remoteAddress,</span></span></span><br><span class="line"><span class="function"><span class="params"> <span class="number">2</span>:                                            <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> </span>{</span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">4</span>:         <span class="keyword">final</span> EventLoop eventLoop = channel.eventLoop();</span><br><span class="line"> <span class="number">5</span>:         <span class="keyword">final</span> AddressResolver&lt;SocketAddress&gt; resolver = <span class="keyword">this</span>.resolver.getResolver(eventLoop);</span><br><span class="line"> <span class="number">6</span>: </span><br><span class="line"> <span class="number">7</span>:         <span class="keyword">if</span> (!resolver.isSupported(remoteAddress) || resolver.isResolved(remoteAddress)) {</span><br><span class="line"> <span class="number">8</span>:             <span class="comment">// Resolver has no idea about what to do with the specified remote address or it's resolved already.</span></span><br><span class="line"> <span class="number">9</span>:             doConnect(remoteAddress, localAddress, promise);</span><br><span class="line"><span class="number">10</span>:             <span class="keyword">return</span> promise;</span><br><span class="line"><span class="number">11</span>:         }</span><br><span class="line"><span class="number">12</span>: </span><br><span class="line"><span class="number">13</span>:         <span class="comment">// è§£æè¿œç¨‹åœ°å€</span></span><br><span class="line"><span class="number">14</span>:         <span class="keyword">final</span> Future&lt;SocketAddress&gt; resolveFuture = resolver.resolve(remoteAddress);</span><br><span class="line"><span class="number">15</span>: </span><br><span class="line"><span class="number">16</span>:         <span class="keyword">if</span> (resolveFuture.isDone()) {</span><br><span class="line"><span class="number">17</span>:             <span class="comment">// è§£æè¿œç¨‹åœ°å€å¤±è´¥ï¼Œå…³é—­ Channel ï¼Œå¹¶å›è°ƒé€šçŸ¥ promise å¼‚å¸¸</span></span><br><span class="line"><span class="number">18</span>:             <span class="keyword">final</span> Throwable resolveFailureCause = resolveFuture.cause();</span><br><span class="line"><span class="number">19</span>:             <span class="keyword">if</span> (resolveFailureCause != <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">20</span>:                 <span class="comment">// Failed to resolve immediately</span></span><br><span class="line"><span class="number">21</span>:                 channel.close();</span><br><span class="line"><span class="number">22</span>:                 promise.setFailure(resolveFailureCause);</span><br><span class="line"><span class="number">23</span>:             } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">24</span>:                 <span class="comment">// Succeeded to resolve immediately; cached? (or did a blocking lookup)</span></span><br><span class="line"><span class="number">25</span>:                 <span class="comment">// è¿æ¥è¿œç¨‹åœ°å€</span></span><br><span class="line"><span class="number">26</span>:                 doConnect(resolveFuture.getNow(), localAddress, promise);</span><br><span class="line"><span class="number">27</span>:             }</span><br><span class="line"><span class="number">28</span>:             <span class="keyword">return</span> promise;</span><br><span class="line"><span class="number">29</span>:         }</span><br><span class="line"><span class="number">30</span>: </span><br><span class="line"><span class="number">31</span>:         <span class="comment">// Wait until the name resolution is finished.</span></span><br><span class="line"><span class="number">32</span>:         resolveFuture.addListener(<span class="keyword">new</span> FutureListener&lt;SocketAddress&gt;() {</span><br><span class="line"><span class="number">33</span>:             <span class="meta">@Override</span></span><br><span class="line"><span class="number">34</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(Future&lt;SocketAddress&gt; future)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"><span class="number">35</span>:                 <span class="comment">// è§£æè¿œç¨‹åœ°å€å¤±è´¥ï¼Œå…³é—­ Channel ï¼Œå¹¶å›è°ƒé€šçŸ¥ promise å¼‚å¸¸</span></span><br><span class="line"><span class="number">36</span>:                 <span class="keyword">if</span> (future.cause() != <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">37</span>:                     channel.close();</span><br><span class="line"><span class="number">38</span>:                     promise.setFailure(future.cause());</span><br><span class="line"><span class="number">39</span>:                 <span class="comment">// è§£æè¿œç¨‹åœ°å€æˆåŠŸï¼Œè¿æ¥è¿œç¨‹åœ°å€</span></span><br><span class="line"><span class="number">40</span>:                 } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">41</span>:                     doConnect(future.getNow(), localAddress, promise);</span><br><span class="line"><span class="number">42</span>:                 }</span><br><span class="line"><span class="number">43</span>:             }</span><br><span class="line"><span class="number">44</span>:         });</span><br><span class="line"><span class="number">45</span>:     } <span class="keyword">catch</span> (Throwable cause) {</span><br><span class="line"><span class="number">46</span>:         <span class="comment">// å‘ç”Ÿå¼‚å¸¸ï¼Œå¹¶å›è°ƒé€šçŸ¥ promise å¼‚å¸¸</span></span><br><span class="line"><span class="number">47</span>:         promise.tryFailure(cause);</span><br><span class="line"><span class="number">48</span>:     }</span><br><span class="line"><span class="number">49</span>:     <span class="keyword">return</span> promise;</span><br><span class="line"><span class="number">50</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è‡³ 14 è¡Œï¼šä½¿ç”¨ <code>resolver</code> è§£æè¿œç¨‹åœ°å€ã€‚å› ä¸ºè§£ææ˜¯<strong>å¼‚æ­¥</strong>çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥è¿”å›ä¸€ä¸ª Future å¯¹è±¡ã€‚<ul>
<li>è¯¦ç»†çš„è§£æè¿œç¨‹åœ°å€çš„ä»£ç ï¼Œè€ƒè™‘åˆ°æš‚æ—¶ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œæ‰€ä»¥æš‚æ—¶çœç•¥ã€‚ğŸ˜ˆ è€è‰¿è‰¿çŒœæµ‹èƒ–å‹åº”è¯¥ä¹Ÿæš‚æ—¶ä¸æ„Ÿå…´è¶£ï¼Œå“ˆå“ˆå“ˆã€‚</li>
</ul>
</li>
<li>ç¬¬ 16 è‡³ 44 è¡Œï¼šå› ä¸ºæ³¨å†Œæ˜¯<strong>å¼‚æ­¥</strong>çš„è¿‡ç¨‹ï¼Œæœ‰å¯èƒ½å·²å®Œæˆï¼Œæœ‰å¯èƒ½æœªå®Œæˆã€‚æ‰€ä»¥å®ç°ä»£ç åˆ†æˆäº†ã€ç¬¬ 16 è‡³ 29 è¡Œã€‘å’Œã€ç¬¬ 31 è‡³ 44 è¡Œã€‘åˆ†åˆ«å¤„ç†å·²å®Œæˆå’Œæœªå®Œæˆçš„æƒ…å†µã€‚<ul>
<li><strong>æ ¸å¿ƒ</strong>åœ¨ã€ç¬¬ 26 è¡Œã€‘æˆ–è€…ã€ç¬¬ 41 è¡Œã€‘çš„ä»£ç ï¼Œè°ƒç”¨ <code>#doConnect(...)</code> æ–¹æ³•ï¼Œè¿æ¥è¿œç¨‹åœ°å€ã€‚</li>
<li>å¦‚æœ<strong>å¼‚æ­¥</strong>è§£æå¯¹åº”çš„ Future æœªå®Œæˆï¼Œåˆ™è°ƒç”¨ <code>Future#addListener(FutureListener)</code> æ–¹æ³•ï¼Œæ·»åŠ ç›‘å¬å™¨ï¼Œåœ¨<strong>è§£æ</strong>å®Œæˆåï¼Œè¿›è¡Œå›è°ƒæ‰§è¡Œ <code>#doConnect(...)</code> æ–¹æ³•çš„é€»è¾‘ã€‚è¯¦ç»†è§£æï¼Œè§ è§ <a href="#">ã€Œ3.13.3 doConnectã€</a> ã€‚</li>
<li>æ‰€ä»¥æ€»ç»“æ¥è¯´ï¼Œ<strong>connect çš„é€»è¾‘ï¼Œæ‰§è¡Œåœ¨ resolve çš„é€»è¾‘ä¹‹å</strong>ã€‚ </li>
<li>è€è‰¿è‰¿ç›®å‰ä½¿ç”¨ <a href="#">ã€Œ2. Bootstrap ç¤ºä¾‹ã€</a> æµ‹è¯•ä¸‹æ¥ï¼Œç¬¦åˆã€ç¬¬ 16 è‡³ 30 è¡Œã€‘çš„æ¡ä»¶ï¼Œå³æ— éœ€èµ°<strong>å¼‚æ­¥</strong>çš„æµç¨‹ã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-6-3-doConnect"><a href="#3-6-3-doConnect" class="headerlink" title="3.6.3 doConnect"></a>3.6.3 doConnect</h3><p><code>#doConnect(...)</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Channel è¿æ¥è¿œç¨‹åœ°å€çš„é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">doConnect</span><span class="params">(<span class="keyword">final</span> SocketAddress remoteAddress, <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise connectPromise)</span> </span>{</span><br><span class="line"> <span class="number">2</span>: </span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// This method is invoked before channelRegistered() is triggered.  Give user handlers a chance to set up</span></span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// the pipeline in its channelRegistered() implementation.</span></span><br><span class="line"> <span class="number">5</span>:     <span class="keyword">final</span> Channel channel = connectPromise.channel();</span><br><span class="line"> <span class="number">6</span>:     channel.eventLoop().execute(<span class="keyword">new</span> Runnable() {</span><br><span class="line"> <span class="number">7</span>: </span><br><span class="line"> <span class="number">8</span>:         <span class="meta">@Override</span></span><br><span class="line"> <span class="number">9</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="number">10</span>:             <span class="keyword">if</span> (localAddress == <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">11</span>:                 channel.connect(remoteAddress, connectPromise);</span><br><span class="line"><span class="number">12</span>:             } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">13</span>:                 channel.connect(remoteAddress, localAddress, connectPromise);</span><br><span class="line"><span class="number">14</span>:             }</span><br><span class="line"><span class="number">15</span>:             connectPromise.addListener(ChannelFutureListener.CLOSE_ON_FAILURE);</span><br><span class="line"><span class="number">16</span>:         }</span><br><span class="line"><span class="number">17</span>: </span><br><span class="line"><span class="number">18</span>:     });</span><br><span class="line"><span class="number">19</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 6 è¡Œï¼šè°ƒç”¨ EventLoop æ‰§è¡Œ Channel è¿æ¥è¿œç¨‹åœ°å€çš„é€»è¾‘ã€‚ä½†æ˜¯ï¼Œå®é™…ä¸Šå½“å‰çº¿ç¨‹å·²ç»æ˜¯ EventLoop æ‰€åœ¨çš„çº¿ç¨‹äº†ï¼Œä¸ºä½•è¿˜è¦è¿™æ ·æ“ä½œå‘¢ï¼Ÿç­”æ¡ˆåœ¨ã€ç¬¬ 3 è‡³ 4 è¡Œã€‘çš„è‹±è¯­æ³¨é‡Šã€‚æ„Ÿå¹å¥ï¼ŒNetty è™½ç„¶ä»£ç é‡éå¸¸åºå¤§ä¸”å¤æ‚ï¼Œä½†æ˜¯è‹±æ–‡æ³¨é‡ŠçœŸçš„æ˜¯éå¸¸é½å…¨ï¼ŒåŒ…æ‹¬ Github çš„ issue å¯¹ä»£ç æäº¤çš„æè¿°ï¼Œä¹Ÿéå¸¸å¥å…¨ã€‚</li>
<li>ç¬¬ 10 è‡³ 14 è¡Œï¼šè°ƒç”¨ <code>Channel#connect(...)</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Channel è¿æ¥è¿œç¨‹åœ°å€çš„é€»è¾‘ã€‚åç»­çš„æ–¹æ³•æ ˆè°ƒç”¨å¦‚ä¸‹å›¾ï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_04_05/02.png" title="Channel connect æµç¨‹" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_04_05/02.png" alt="Channel connect æµç¨‹"></a><span class="caption">Channel connect æµç¨‹</span><ul>
<li>è¿˜æ˜¯è€æ ·å­ï¼Œæˆ‘ä»¬å…ˆçœç•¥æ‰ pipeline çš„å†…éƒ¨å®ç°ä»£ç ï¼Œä» <code>AbstractNioUnsafe#connect(final SocketAddress remoteAddress, final SocketAddress localAddress, final ChannelPromise promise)</code> æ–¹æ³•ï¼Œç»§ç»­å‘ä¸‹åˆ†äº«ã€‚</li>
</ul>
</li>
</ul>
<p><code>AbstractNioUnsafe#connect(final SocketAddress remoteAddress, final SocketAddress localAddress, final ChannelPromise promise)</code> æ–¹æ³•ï¼Œæ‰§è¡Œ Channel è¿æ¥è¿œç¨‹åœ°å€çš„é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(<span class="keyword">final</span> SocketAddress remoteAddress, <span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> </span>{</span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (!promise.setUncancellable() || !ensureOpen(promise)) {</span><br><span class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</span><br><span class="line"> <span class="number">5</span>:     }</span><br><span class="line"> <span class="number">6</span>: </span><br><span class="line"> <span class="number">7</span>:     <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">8</span>:         <span class="comment">// ç›®å‰æœ‰æ­£åœ¨è¿æ¥è¿œç¨‹åœ°å€çš„ ChannelPromise ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œç¦æ­¢åŒæ—¶å‘èµ·å¤šä¸ªè¿æ¥ã€‚</span></span><br><span class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (connectPromise != <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">10</span>:             <span class="comment">// Already a connect in process.</span></span><br><span class="line"><span class="number">11</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> ConnectionPendingException();</span><br><span class="line"><span class="number">12</span>:         }</span><br><span class="line"><span class="number">13</span>: </span><br><span class="line"><span class="number">14</span>:         <span class="comment">// è®°å½• Channel æ˜¯å¦æ¿€æ´»</span></span><br><span class="line"><span class="number">15</span>:         <span class="keyword">boolean</span> wasActive = isActive();</span><br><span class="line"><span class="number">16</span>: </span><br><span class="line"><span class="number">17</span>:         <span class="comment">// æ‰§è¡Œè¿æ¥è¿œç¨‹åœ°å€</span></span><br><span class="line"><span class="number">18</span>:         <span class="keyword">if</span> (doConnect(remoteAddress, localAddress)) {</span><br><span class="line"><span class="number">19</span>:             fulfillConnectPromise(promise, wasActive);</span><br><span class="line"><span class="number">20</span>:         } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">21</span>:             <span class="comment">// è®°å½• connectPromise</span></span><br><span class="line"><span class="number">22</span>:             connectPromise = promise;</span><br><span class="line"><span class="number">23</span>:             <span class="comment">// è®°å½• requestedRemoteAddress</span></span><br><span class="line"><span class="number">24</span>:             requestedRemoteAddress = remoteAddress;</span><br><span class="line"><span class="number">25</span>: </span><br><span class="line"><span class="number">26</span>:             <span class="comment">// ä½¿ç”¨ EventLoop å‘èµ·å®šæ—¶ä»»åŠ¡ï¼Œç›‘å¬è¿æ¥è¿œç¨‹åœ°å€è¶…æ—¶ã€‚è‹¥è¿æ¥è¶…æ—¶ï¼Œåˆ™å›è°ƒé€šçŸ¥ connectPromise è¶…æ—¶å¼‚å¸¸ã€‚</span></span><br><span class="line"><span class="number">27</span>:             <span class="comment">// Schedule connect timeout.</span></span><br><span class="line"><span class="number">28</span>:             <span class="keyword">int</span> connectTimeoutMillis = config().getConnectTimeoutMillis(); <span class="comment">// é»˜è®¤ 30 * 1000 æ¯«ç§’</span></span><br><span class="line"><span class="number">29</span>:             <span class="keyword">if</span> (connectTimeoutMillis &gt; <span class="number">0</span>) {</span><br><span class="line"><span class="number">30</span>:                 connectTimeoutFuture = eventLoop().schedule(<span class="keyword">new</span> Runnable() {</span><br><span class="line"><span class="number">31</span>:                     <span class="meta">@Override</span></span><br><span class="line"><span class="number">32</span>:                     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="number">33</span>:                         ChannelPromise connectPromise = AbstractNioChannel.<span class="keyword">this</span>.connectPromise;</span><br><span class="line"><span class="number">34</span>:                         ConnectTimeoutException cause = <span class="keyword">new</span> ConnectTimeoutException(<span class="string">"connection timed out: "</span> + remoteAddress);</span><br><span class="line"><span class="number">35</span>:                         <span class="keyword">if</span> (connectPromise != <span class="keyword">null</span> &amp;&amp; connectPromise.tryFailure(cause)) {</span><br><span class="line"><span class="number">36</span>:                             close(voidPromise());</span><br><span class="line"><span class="number">37</span>:                         }</span><br><span class="line"><span class="number">38</span>:                     }</span><br><span class="line"><span class="number">39</span>:                 }, connectTimeoutMillis, TimeUnit.MILLISECONDS);</span><br><span class="line"><span class="number">40</span>:             }</span><br><span class="line"><span class="number">41</span>: </span><br><span class="line"><span class="number">42</span>:             <span class="comment">// æ·»åŠ ç›‘å¬å™¨ï¼Œç›‘å¬è¿æ¥è¿œç¨‹åœ°å€å–æ¶ˆã€‚</span></span><br><span class="line"><span class="number">43</span>:             promise.addListener(<span class="keyword">new</span> ChannelFutureListener() {</span><br><span class="line"><span class="number">44</span>:                 <span class="meta">@Override</span></span><br><span class="line"><span class="number">45</span>:                 <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"><span class="number">46</span>:                     <span class="keyword">if</span> (future.isCancelled()) {</span><br><span class="line"><span class="number">47</span>:                         <span class="comment">// å–æ¶ˆå®šæ—¶ä»»åŠ¡</span></span><br><span class="line"><span class="number">48</span>:                         <span class="keyword">if</span> (connectTimeoutFuture != <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">49</span>:                             connectTimeoutFuture.cancel(<span class="keyword">false</span>);</span><br><span class="line"><span class="number">50</span>:                         }</span><br><span class="line"><span class="number">51</span>:                         <span class="comment">// ç½®ç©º connectPromise</span></span><br><span class="line"><span class="number">52</span>:                         connectPromise = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">53</span>:                         close(voidPromise());</span><br><span class="line"><span class="number">54</span>:                     }</span><br><span class="line"><span class="number">55</span>:                 }</span><br><span class="line"><span class="number">56</span>:             });</span><br><span class="line"><span class="number">57</span>:         }</span><br><span class="line"><span class="number">58</span>:     } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line"><span class="number">59</span>:         <span class="comment">// å›è°ƒé€šçŸ¥ promise å‘ç”Ÿå¼‚å¸¸</span></span><br><span class="line"><span class="number">60</span>:         promise.tryFailure(annotateConnectException(t, remoteAddress));</span><br><span class="line"><span class="number">61</span>:         closeIfClosed();</span><br><span class="line"><span class="number">62</span>:     }</span><br><span class="line"><span class="number">63</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ç¬¬ 8 è‡³ 12 è¡Œï¼šç›®å‰æœ‰æ­£åœ¨è¿æ¥è¿œç¨‹åœ°å€çš„ ChannelPromise ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œç¦æ­¢åŒæ—¶å‘èµ·å¤šä¸ªè¿æ¥ã€‚<code>connectPromise</code> å˜é‡ï¼Œå®šä¹‰åœ¨ AbstractNioChannel ç±»ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç›®å‰æ­£åœ¨è¿æ¥è¿œç¨‹åœ°å€çš„ ChannelPromise å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The future of the current connection attempt.  If not null, subsequent</span></span><br><span class="line"><span class="comment"> * connection attempts will fail.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ChannelPromise connectPromise;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ç¬¬ 15 è¡Œï¼šè°ƒç”¨ <code>#isActive()</code> æ–¹æ³•ï¼Œè·å¾— Channel æ˜¯å¦æ¿€æ´»ã€‚NioSocketChannel å¯¹è¯¥æ–¹æ³•çš„å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isActive</span><span class="params">()</span> </span>{</span><br><span class="line">    SocketChannel ch = javaChannel();</span><br><span class="line">    <span class="keyword">return</span> ch.isOpen() &amp;&amp; ch.isConnected();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åˆ¤æ–­ SocketChannel æ˜¯å¦å¤„äºæ‰“å¼€ï¼Œå¹¶ä¸”è¿æ¥çš„çŠ¶æ€ã€‚æ­¤æ—¶ï¼Œä¸€èˆ¬è¿”å›çš„æ˜¯ <code>false</code> ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 18 è¡Œï¼šè°ƒç”¨ <code>#doConnect(SocketAddress remoteAddress, SocketAddress localAddress)</code> æ–¹æ³•ï¼Œæ‰§è¡Œè¿æ¥è¿œç¨‹åœ°å€ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// NioSocketChannel.java</span></span><br><span class="line">  <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">doConnect</span><span class="params">(SocketAddress remoteAddress, SocketAddress localAddress)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">  <span class="number">3</span>:     <span class="comment">// ç»‘å®šæœ¬åœ°åœ°å€</span></span><br><span class="line">  <span class="number">4</span>:     <span class="keyword">if</span> (localAddress != <span class="keyword">null</span>) {</span><br><span class="line">  <span class="number">5</span>:         doBind0(localAddress);</span><br><span class="line">  <span class="number">6</span>:     }</span><br><span class="line">  <span class="number">7</span>: </span><br><span class="line">  <span class="number">8</span>:     <span class="keyword">boolean</span> success = <span class="keyword">false</span>; <span class="comment">// æ‰§è¡Œæ˜¯å¦æˆåŠŸ</span></span><br><span class="line">  <span class="number">9</span>:     <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">10</span>:         <span class="comment">// è¿æ¥è¿œç¨‹åœ°å€</span></span><br><span class="line"> <span class="number">11</span>:         <span class="keyword">boolean</span> connected = SocketUtils.connect(javaChannel(), remoteAddress);</span><br><span class="line"> <span class="number">12</span>:         <span class="comment">// è‹¥æœªè¿æ¥å®Œæˆï¼Œåˆ™å…³æ³¨è¿æ¥( OP_CONNECT )äº‹ä»¶ã€‚</span></span><br><span class="line"> <span class="number">13</span>:         <span class="keyword">if</span> (!connected) {</span><br><span class="line"> <span class="number">14</span>:             selectionKey().interestOps(SelectionKey.OP_CONNECT);</span><br><span class="line"> <span class="number">15</span>:         }</span><br><span class="line"> <span class="number">16</span>:         <span class="comment">// æ ‡è®°æ‰§è¡Œæ˜¯å¦æˆåŠŸ</span></span><br><span class="line"> <span class="number">17</span>:         success = <span class="keyword">true</span>;</span><br><span class="line"> <span class="number">18</span>:         <span class="comment">// è¿”å›æ˜¯å¦è¿æ¥å®Œæˆ</span></span><br><span class="line"> <span class="number">19</span>:         <span class="keyword">return</span> connected;</span><br><span class="line"> <span class="number">20</span>:     } <span class="keyword">finally</span> {</span><br><span class="line"> <span class="number">21</span>:         <span class="comment">// æ‰§è¡Œå¤±è´¥ï¼Œåˆ™å…³é—­ Channel</span></span><br><span class="line"> <span class="number">22</span>:         <span class="keyword">if</span> (!success) {</span><br><span class="line"> <span class="number">23</span>:             doClose();</span><br><span class="line"> <span class="number">24</span>:         }</span><br><span class="line"> <span class="number">25</span>:     }</span><br><span class="line"> <span class="number">26</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è‡³ 6 è¡Œï¼šè‹¥ <code>localAddress</code> éç©ºï¼Œåˆ™è°ƒç”¨ <code>#doBind0(SocketAddress)</code> æ–¹æ³•ï¼Œç»‘å®šæœ¬åœ°åœ°å€ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒNIO Client æ˜¯ä¸éœ€è¦ç»‘å®šæœ¬åœ°åœ°å€çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¼šéšæœºåˆ†é…ä¸€ä¸ªå¯ç”¨çš„æœ¬åœ°åœ°å€ï¼Œè¿›è¡Œç»‘å®šã€‚</li>
<li><p>ç¬¬ 11 è¡Œï¼šè°ƒç”¨ <code>SocketUtils#connect(SocketChannel socketChannel, SocketAddress remoteAddress)</code> æ–¹æ³•ï¼ŒJava åŸç”Ÿ NIO SocketChannel è¿æ¥ è¿œç¨‹åœ°å€ï¼Œå¹¶è¿”å›æ˜¯å¦è¿æ¥å®Œæˆ( æˆåŠŸ )ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">connect</span><span class="params">(<span class="keyword">final</span> SocketChannel socketChannel, <span class="keyword">final</span> SocketAddress remoteAddress)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">return</span> AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedExceptionAction&lt;Boolean&gt;() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Boolean <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">                <span class="keyword">return</span> socketChannel.connect(remoteAddress);</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    } <span class="keyword">catch</span> (PrivilegedActionException e) {</span><br><span class="line">        <span class="keyword">throw</span> (IOException) e.getCause();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>å¯èƒ½æœ‰èƒ–å‹æœ‰å’Œæˆ‘ä¸€æ ·çš„ç–‘é—®ï¼Œä¸ºä»€ä¹ˆå°† connect æ“ä½œåŒ…åœ¨ AccessController ä¸­å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸‹ SocketUtils ç±»çš„æ³¨é‡Šï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Provides socket operations with privileges enabled. This is necessary for applications that use the</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> SecurityManager} to restrict {<span class="doctag">@link</span> SocketPermission} to their application. By asserting that these</span></span><br><span class="line"><span class="comment"> * operations are privileged, the operations can proceed even if some code in the calling chain lacks the appropriate</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> SocketPermission}.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç”¨ä¸åˆ°ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥æš‚æ—¶ä¸ç”¨ç†è§£ã€‚</li>
<li>æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥ Google â€œAccessControllerâ€ å…³é”®å­—ï¼Œæˆ–è€…é˜…è¯» <a href="https://www.ibm.com/developerworks/cn/java/j-lo-javasecurity/index.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠJava å®‰å…¨æ¨¡å‹ä»‹ç»ã€‹</a> ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><p>ã€é‡è¦ã€‘ç¬¬ 12 è‡³ 15 è¡Œï¼šè‹¥è¿æ¥æœªå®Œæˆ( <code>connected == false</code> )æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè°ƒç”¨ <code>SelectionKey#interestOps(ops)</code> æ–¹æ³•ï¼Œæ·»åŠ è¿æ¥äº‹ä»¶( <code>SelectionKey.OP_CONNECT</code> )ä¸ºæ„Ÿå…´è¶£çš„äº‹ä»¶ã€‚ä¹Ÿå°±è¯´ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“è¿æ¥è¿œç¨‹åœ°å€æˆåŠŸæ—¶ï¼ŒChannel å¯¹åº”çš„ Selector å°†ä¼šè½®è¯¢åˆ°è¯¥äº‹ä»¶ï¼Œå¯ä»¥è¿›ä¸€æ­¥å¤„ç†ã€‚</p>
</li>
<li>ç¬¬ 20 è‡³ 25 è¡Œï¼šè‹¥æ‰§è¡Œå¤±è´¥( <code>success == false</code> )æ—¶ï¼Œè°ƒç”¨ <code>#doClose()</code> æ–¹æ³•ï¼Œå…³é—­ Channel ã€‚</li>
</ul>
</li>
<li>ç¬¬ 18 è‡³ 19 è¡Œï¼šç¬”è€…æµ‹è¯•ä¸‹æ¥ï¼Œ<code>#doConnect(SocketChannel socketChannel, SocketAddress remoteAddress)</code> æ–¹æ³•çš„ç»“æœä¸º <code>false</code> ï¼Œæ‰€ä»¥ä¸ä¼šæ‰§è¡Œã€ç¬¬ 19 è¡Œã€‘ä»£ç çš„ <code>#fulfillConnectPromise(ChannelPromise promise, boolean wasActive)</code> æ–¹æ³•ï¼Œè€Œæ˜¯æ‰§è¡Œã€ç¬¬ 20 è‡³ 57 è¡Œã€‘çš„ä»£ç é€»è¾‘ã€‚</li>
<li>ç¬¬ 22 è¡Œï¼šè®°å½• <code>connectPromise</code> ã€‚</li>
<li><p>ç¬¬ 24 è¡Œï¼šè®°å½• <code>requestedRemoteAddress</code> ã€‚<code>requestedRemoteAddress</code> å˜é‡ï¼Œåœ¨ AbstractNioChannel ç±»ä¸­å®šä¹‰ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ­£åœ¨è¿æ¥çš„è¿œç¨‹åœ°å€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> SocketAddress requestedRemoteAddress;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ç¬¬ 26 è‡³ 40 è¡Œï¼šè°ƒç”¨ <code>EventLoop#schedule(Runnable command, long delay, TimeUnit unit)</code> æ–¹æ³•ï¼Œå‘èµ·å®šæ—¶ä»»åŠ¡ <code>connectTimeoutFuture</code> ï¼Œç›‘å¬è¿æ¥è¿œç¨‹åœ°å€<strong>æ˜¯å¦è¶…æ—¶</strong>ã€‚è‹¥è¿æ¥è¶…æ—¶ï¼Œåˆ™å›è°ƒé€šçŸ¥ <code>connectPromise</code> è¶…æ—¶å¼‚å¸¸ã€‚<code>connectPromise</code> å˜é‡ï¼Œåœ¨ AbstractNioChannel ç±»ä¸­å®šä¹‰ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¿æ¥è¶…æ—¶ç›‘å¬ ScheduledFuture å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ScheduledFuture&lt;?&gt; connectTimeoutFuture;</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ç¬¬ 42 è‡³ 57 è¡Œï¼šè°ƒç”¨ <code>ChannelPromise#addListener(ChannelFutureListener)</code> æ–¹æ³•ï¼Œæ·»åŠ ç›‘å¬å™¨ï¼Œç›‘å¬è¿æ¥è¿œç¨‹åœ°å€<strong>æ˜¯å¦å–æ¶ˆ</strong>ã€‚è‹¥å–æ¶ˆï¼Œåˆ™å–æ¶ˆ <code>connectTimeoutFuture</code> ä»»åŠ¡ï¼Œå¹¶ç½®ç©º <code>connectPromise</code> ã€‚è¿™æ ·ï¼Œå®¢æˆ·ç«¯ Channel å¯ä»¥å‘èµ·ä¸‹ä¸€æ¬¡è¿æ¥ã€‚</p>
</li>
</ul>
<h3 id="3-6-4-finishConnect"><a href="#3-6-4-finishConnect" class="headerlink" title="3.6.4 finishConnect"></a>3.6.4 finishConnect</h3><p>çœ‹åˆ°æ­¤å¤„ï¼Œå¯èƒ½èƒ–å‹ä¼šæœ‰ç–‘é—®ï¼Œå®¢æˆ·ç«¯çš„è¿æ¥åœ¨å“ªé‡Œå®Œæˆå‘¢ï¼Ÿç­”æ¡ˆåœ¨ <code>AbstractNioUnsafe#finishConnect()</code> æ–¹æ³•ä¸­ã€‚è€Œè¯¥æ–¹æ³•é€šè¿‡ Selector è½®è¯¢åˆ° <code>SelectionKey.OP_CONNECT</code> äº‹ä»¶æ—¶ï¼Œè¿›è¡Œè§¦å‘ã€‚è°ƒç”¨æ ˆå¦‚ä¸‹å›¾ï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_04_05/03.png" title="finishConnect è°ƒç”¨æ ˆ" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_04_05/03.png" alt="finishConnect è°ƒç”¨æ ˆ"></a><span class="caption">finishConnect è°ƒç”¨æ ˆ</span></p>
<pre><code>* å“ˆå“ˆå“ˆï¼Œè¿˜æ˜¯è€æ ·å­ï¼Œæˆ‘ä»¬å…ˆçœç•¥æ‰ EventLoop çš„å†…éƒ¨å®ç°ä»£ç ï¼Œä» `AbstractNioUnsafe#finishConnect()` æ–¹æ³•ï¼Œç»§ç»­å‘ä¸‹åˆ†äº«ã€‚
</code></pre><p><code>AbstractNioUnsafe#finishConnect()</code> æ–¹æ³•ï¼Œå®Œæˆå®¢æˆ·ç«¯çš„è¿æ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">finishConnect</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// Note this method is invoked by the event loop only if the connection attempt was</span></span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// neither cancelled nor timed out.</span></span><br><span class="line"> <span class="number">5</span>:     <span class="comment">// åˆ¤æ–­æ˜¯å¦åœ¨ EventLoop çš„çº¿ç¨‹ä¸­ã€‚</span></span><br><span class="line"> <span class="number">6</span>:     <span class="function"><span class="keyword">assert</span> <span class="title">eventLoop</span><span class="params">()</span>.<span class="title">inEventLoop</span><span class="params">()</span></span>;</span><br><span class="line"> <span class="number">7</span>: </span><br><span class="line"> <span class="number">8</span>:     <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">9</span>:         <span class="comment">// è·å¾— Channel æ˜¯å¦æ¿€æ´»</span></span><br><span class="line"><span class="number">10</span>:         <span class="keyword">boolean</span> wasActive = isActive();</span><br><span class="line"><span class="number">11</span>:         <span class="comment">// æ‰§è¡Œå®Œæˆè¿æ¥</span></span><br><span class="line"><span class="number">12</span>:         doFinishConnect();</span><br><span class="line"><span class="number">13</span>:         <span class="comment">// é€šçŸ¥ connectPromise è¿æ¥å®Œæˆ</span></span><br><span class="line"><span class="number">14</span>:         fulfillConnectPromise(connectPromise, wasActive);</span><br><span class="line"><span class="number">15</span>:     } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line"><span class="number">16</span>:         <span class="comment">// é€šçŸ¥ connectPromise è¿æ¥å¼‚å¸¸</span></span><br><span class="line"><span class="number">17</span>:         fulfillConnectPromise(connectPromise, annotateConnectException(t, requestedRemoteAddress));</span><br><span class="line"><span class="number">18</span>:     } <span class="keyword">finally</span> {</span><br><span class="line"><span class="number">19</span>:         <span class="comment">// å–æ¶ˆ connectTimeoutFuture ä»»åŠ¡</span></span><br><span class="line"><span class="number">20</span>:         <span class="comment">// Check for null as the connectTimeoutFuture is only created if a connectTimeoutMillis &gt; 0 is used</span></span><br><span class="line"><span class="number">21</span>:         <span class="comment">// See https://github.com/netty/netty/issues/1770</span></span><br><span class="line"><span class="number">22</span>:         <span class="keyword">if</span> (connectTimeoutFuture != <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">23</span>:             connectTimeoutFuture.cancel(<span class="keyword">false</span>);</span><br><span class="line"><span class="number">24</span>:         }</span><br><span class="line"><span class="number">25</span>:         <span class="comment">// ç½®ç©º connectPromise</span></span><br><span class="line"><span class="number">26</span>:         connectPromise = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">27</span>:     }</span><br><span class="line"><span class="number">28</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 6 è¡Œï¼šåˆ¤æ–­æ˜¯å¦åœ¨ EventLoop çš„çº¿ç¨‹ä¸­ã€‚</li>
<li>ç¬¬ 10 è¡Œï¼šè°ƒç”¨ <code>#isActive()</code> æ–¹æ³•ï¼Œè·å¾— Channel æ˜¯å¦æ¿€æ´»ã€‚ç¬”è€…è°ƒè¯•æ—¶ï¼Œæ­¤æ—¶è¿”å› <code>false</code> ï¼Œå› ä¸ºè¿æ¥è¿˜æ²¡å®Œæˆã€‚</li>
<li>ç¬¬ 12 è¡Œï¼šè°ƒç”¨ <code>#doFinishConnect()</code> æ–¹æ³•ï¼Œæ‰§è¡Œå®Œæˆè¿æ¥çš„é€»è¾‘ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ3.6.4.1 doFinishConnectã€</a> ã€‚</li>
<li>ç¬¬ 14 è¡Œï¼šæ‰§è¡Œå®Œæˆè¿æ¥<strong>æˆåŠŸ</strong>ï¼Œè°ƒç”¨ <code>#fulfillConnectPromise(ChannelPromise promise, boolean wasActive)</code> æ–¹æ³•ï¼Œé€šçŸ¥ <code>connectPromise</code> è¿æ¥å®Œæˆã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ3.6.4.2 fulfillConnectPromise æˆåŠŸã€</a> ã€‚</li>
<li>ç¬¬ 15 è‡³ 17 è¡Œï¼šæ‰§è¡Œå®Œæˆè¿æ¥<strong>å¼‚å¸¸</strong>ï¼Œè°ƒç”¨ <code>#fulfillConnectPromise(ChannelPromise promise, Throwable cause)</code> æ–¹æ³•ï¼Œé€šçŸ¥ <code>connectPromise</code> è¿æ¥å¼‚å¸¸ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ3.6.4.3 fulfillConnectPromise å¼‚å¸¸ã€</a> ã€‚</li>
<li>ç¬¬ 18 è‡³ 27 è¡Œï¼šæ‰§è¡Œå®Œæˆè¿æ¥<strong>ç»“æŸ</strong>ï¼Œå–æ¶ˆ <code>connectTimeoutFuture</code> ä»»åŠ¡ï¼Œå¹¶ç½®ç©º <code>connectPromise</code> ã€‚</li>
</ul>
<h4 id="3-6-4-1-doFinishConnect"><a href="#3-6-4-1-doFinishConnect" class="headerlink" title="3.6.4.1 doFinishConnect"></a>3.6.4.1 doFinishConnect</h4><p><code>NioSocketChannel#doFinishConnect()</code> æ–¹æ³•ï¼Œæ‰§è¡Œå®Œæˆè¿æ¥çš„é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFinishConnect</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (!javaChannel().finishConnect()) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ã€é‡è¦ã€‘æ˜¯ä¸æ˜¯éå¸¸ç†Ÿæ‚‰çš„ï¼Œè°ƒç”¨ <code>SocketChannel#finishConnect()</code> æ–¹æ³•ï¼Œå®Œæˆè¿æ¥ã€‚ğŸ˜ˆ ç¾æ»‹æ»‹ã€‚</li>
</ul>
<h4 id="3-6-4-2-fulfillConnectPromise-æˆåŠŸ"><a href="#3-6-4-2-fulfillConnectPromise-æˆåŠŸ" class="headerlink" title="3.6.4.2 fulfillConnectPromise æˆåŠŸ"></a>3.6.4.2 fulfillConnectPromise æˆåŠŸ</h4><p><code>AbstractNioUnsafe#fulfillConnectPromise(ChannelPromise promise, Throwable cause)</code> æ–¹æ³•ï¼Œé€šçŸ¥ <code>connectPromise</code> è¿æ¥å®Œæˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fulfillConnectPromise</span><span class="params">(ChannelPromise promise, <span class="keyword">boolean</span> wasActive)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (promise == <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">3</span>:         <span class="comment">// Closed via cancellation and the promise has been notified already.</span></span><br><span class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</span><br><span class="line"> <span class="number">5</span>:     }</span><br><span class="line"> <span class="number">6</span>: </span><br><span class="line"> <span class="number">7</span>:     <span class="comment">// è·å¾— Channel æ˜¯å¦æ¿€æ´»</span></span><br><span class="line"> <span class="number">8</span>:     <span class="comment">// Get the state as trySuccess() may trigger an ChannelFutureListener that will close the Channel.</span></span><br><span class="line"> <span class="number">9</span>:     <span class="comment">// We still need to ensure we call fireChannelActive() in this case.</span></span><br><span class="line"><span class="number">10</span>:     <span class="keyword">boolean</span> active = isActive();</span><br><span class="line"><span class="number">11</span>: </span><br><span class="line"><span class="number">12</span>:     <span class="comment">// å›è°ƒé€šçŸ¥ promise æ‰§è¡ŒæˆåŠŸ</span></span><br><span class="line"><span class="number">13</span>:     <span class="comment">// trySuccess() will return false if a user cancelled the connection attempt.</span></span><br><span class="line"><span class="number">14</span>:     <span class="keyword">boolean</span> promiseSet = promise.trySuccess();</span><br><span class="line"><span class="number">15</span>: </span><br><span class="line"><span class="number">16</span>:     <span class="comment">// è‹¥ Channel æ˜¯æ–°æ¿€æ´»çš„ï¼Œè§¦å‘é€šçŸ¥ Channel å·²æ¿€æ´»çš„äº‹ä»¶ã€‚</span></span><br><span class="line"><span class="number">17</span>:     <span class="comment">// Regardless if the connection attempt was cancelled, channelActive() event should be triggered,</span></span><br><span class="line"><span class="number">18</span>:     <span class="comment">// because what happened is what happened.</span></span><br><span class="line"><span class="number">19</span>:     <span class="keyword">if</span> (!wasActive &amp;&amp; active) {</span><br><span class="line"><span class="number">20</span>:         pipeline().fireChannelActive();</span><br><span class="line"><span class="number">21</span>:     }</span><br><span class="line"><span class="number">22</span>: </span><br><span class="line"><span class="number">23</span>:     <span class="comment">// If a user cancelled the connection attempt, close the channel, which is followed by channelInactive().</span></span><br><span class="line"><span class="number">24</span>:     <span class="comment">// TODO èŠ‹è‰¿</span></span><br><span class="line"><span class="number">25</span>:     <span class="keyword">if</span> (!promiseSet) {</span><br><span class="line"><span class="number">26</span>:         close(voidPromise());</span><br><span class="line"><span class="number">27</span>:     }</span><br><span class="line"><span class="number">28</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 10 è¡Œï¼šè°ƒç”¨ <code>#isActive()</code> æ–¹æ³•ï¼Œè·å¾— Channel æ˜¯å¦æ¿€æ´»ã€‚ç¬”è€…è°ƒè¯•æ—¶ï¼Œæ­¤æ—¶è¿”å› <code>true</code> ï¼Œå› ä¸ºè¿æ¥å·²ç»å®Œæˆã€‚ </li>
<li><p>ç¬¬ 14 è¡Œï¼šå›è°ƒé€šçŸ¥ <code>promise</code> æ‰§è¡ŒæˆåŠŸã€‚æ­¤å¤„çš„é€šçŸ¥ï¼Œå¯¹åº”å›è°ƒçš„æ˜¯æˆ‘ä»¬æ·»åŠ åˆ° <code>#connect(...)</code> æ–¹æ³•è¿”å›çš„ ChannelFuture çš„ ChannelFutureListener çš„ç›‘å¬å™¨ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">ChannelFuture f = b.connect(HOST, PORT).addListener(<span class="keyword">new</span> ChannelFutureListener() { <span class="comment">// å›è°ƒçš„å°±æ˜¯æˆ‘ï¼ï¼ï¼</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        System.out.println(<span class="string">"è¿æ¥å®Œæˆ"</span>);</span><br><span class="line">    }</span><br><span class="line">}).sync();</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li>ç¬¬ 19 è¡Œï¼šå› ä¸º <code>wasActive == false</code> å¹¶ä¸” <code>active == true</code> ï¼Œå› æ­¤ï¼ŒChannel å¯ä»¥è®¤ä¸ºæ˜¯<strong>æ–°æ¿€æ´»</strong>çš„ï¼Œæ»¡è¶³ã€ç¬¬ 20 è¡Œã€‘ä»£ç çš„æ‰§è¡Œæ¡ä»¶ã€‚<ul>
<li>ç¬¬ 40 è¡Œï¼šè°ƒç”¨ <code>DefaultChannelPipeline#fireChannelActive()</code> æ–¹æ³•ï¼Œè§¦å‘ Channel æ¿€æ´»çš„äº‹ä»¶ã€‚ã€é‡è¦ã€‘åç»­çš„æµç¨‹ï¼Œå’Œ NioServerSocketChannel ä¸€æ ·ï¼Œä¹Ÿå°±è¯´ï¼Œä¼šè°ƒç”¨åˆ° <code>AbstractUnsafe#beginRead()</code> æ–¹æ³•ã€‚è¿™æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿå°†æˆ‘ä»¬åˆ›å»º NioSocketChannel æ—¶ï¼Œè®¾ç½®çš„ <code>readInterestOp = SelectionKey.OP_READ</code> æ·»åŠ ä¸ºæ„Ÿå…´è¶£çš„äº‹ä»¶ã€‚ä¹Ÿå°±è¯´ï¼Œå®¢æˆ·ç«¯å¯ä»¥è¯»å–æœåŠ¡ç«¯å‘é€æ¥çš„æ•°æ®ã€‚</li>
<li>å…³äº <code>AbstractUnsafe#beginRead()</code> æ–¹æ³•çš„è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/bootstrap-1-server/?self">ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” å¯åŠ¨ï¼ˆä¸€ï¼‰ä¹‹æœåŠ¡ç«¯ã€‹çš„ ã€Œ3.13.3 beginReadã€</a> éƒ¨åˆ†ã€‚</li>
</ul>
</li>
<li>ç¬¬ 23 è‡³ 27 è¡Œï¼šTODO èŠ‹è‰¿ 1004  fulfillConnectPromise promiseSet</li>
</ul>
<h4 id="3-6-4-3-fulfillConnectPromise-å¼‚å¸¸"><a href="#3-6-4-3-fulfillConnectPromise-å¼‚å¸¸" class="headerlink" title="3.6.4.3 fulfillConnectPromise å¼‚å¸¸"></a>3.6.4.3 fulfillConnectPromise å¼‚å¸¸</h4><p><code>#fulfillConnectPromise(ChannelPromise promise, Throwable cause)</code> æ–¹æ³•ï¼Œé€šçŸ¥ <code>connectPromise</code> è¿æ¥å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fulfillConnectPromise</span><span class="params">(ChannelPromise promise, Throwable cause)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (promise == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// Closed via cancellation and the promise has been notified already.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å›è°ƒé€šçŸ¥ promise å‘ç”Ÿå¼‚å¸¸</span></span><br><span class="line">    <span class="comment">// Use tryFailure() instead of setFailure() to avoid the race against cancel().</span></span><br><span class="line">    promise.tryFailure(cause);</span><br><span class="line">    <span class="comment">// å…³é—­</span></span><br><span class="line">    closeIfClosed();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ¯”è¾ƒç®€å•ï¼Œå·²ç»æ·»åŠ ä¸­æ–‡æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚</li>
</ul>
<h2 id="3-7-initAndRegister"><a href="#3-7-initAndRegister" class="headerlink" title="3.7 initAndRegister"></a>3.7 initAndRegister</h2><p>Bootstrap ç»§æ‰¿ AbstractBootstrap æŠ½è±¡ç±»ï¼Œæ‰€ä»¥ <code>#initAndRegister()</code> æ–¹æ³•çš„æµç¨‹ä¸Šæ˜¯ä¸€è‡´çš„ã€‚æ‰€ä»¥å’Œ ServerBootstrap çš„å·®åˆ«åœ¨äºï¼š</p>
<ol>
<li>åˆ›å»ºçš„ Channel å¯¹è±¡ä¸åŒã€‚</li>
<li>åˆå§‹åŒ– Channel é…ç½®çš„ä»£ç å®ç°ä¸åŒã€‚</li>
</ol>
<h3 id="3-7-1-åˆ›å»º-Channel-å¯¹è±¡"><a href="#3-7-1-åˆ›å»º-Channel-å¯¹è±¡" class="headerlink" title="3.7.1 åˆ›å»º Channel å¯¹è±¡"></a>3.7.1 åˆ›å»º Channel å¯¹è±¡</h3><p>è€ƒè™‘åˆ°æœ¬æ–‡çš„å†…å®¹ï¼Œæˆ‘ä»¬ä»¥ NioSocketChannel çš„åˆ›å»ºè¿‡ç¨‹ä½œä¸ºç¤ºä¾‹ã€‚åˆ›å»º NioSocketChannel å¯¹è±¡çš„æµç¨‹ï¼Œå’Œ NioServerSocketChannel åŸºæœ¬æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥æµç¨‹å›¾æˆ‘ä»¬å°±ä¸æä¾›äº†ï¼Œç›´æ¥å¼€å§‹æ’¸æºç ã€‚</p>
<h4 id="3-7-1-1-NioSocketChannel"><a href="#3-7-1-1-NioSocketChannel" class="headerlink" title="3.7.1.1 NioSocketChannel"></a>3.7.1.1 NioSocketChannel</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SelectorProvider DEFAULT_SELECTOR_PROVIDER = SelectorProvider.provider();</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SocketChannelConfig config;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NioSocketChannel</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>(DEFAULT_SELECTOR_PROVIDER);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NioSocketChannel</span><span class="params">(SelectorProvider provider)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>(newSocket(provider));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>DEFAULT_SELECTOR_PROVIDER</code> <strong>é™æ€</strong>å±æ€§ï¼Œé»˜è®¤çš„ SelectorProvider å®ç°ç±»ã€‚</li>
<li><code>config</code> å±æ€§ï¼ŒChannel å¯¹åº”çš„é…ç½®å¯¹è±¡ã€‚æ¯ç§ Channel å®ç°ç±»ï¼Œä¹Ÿä¼šå¯¹åº”ä¸€ä¸ª ChannelConfig å®ç°ç±»ã€‚ä¾‹å¦‚ï¼ŒNioSocketChannel ç±»ï¼Œå¯¹åº” SocketChannelConfig é…ç½®ç±»ã€‚</li>
<li><p>åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œè°ƒç”¨ <code>#newSocket(SelectorProvider provider)</code> æ–¹æ³•ï¼Œåˆ›å»º NIO çš„ ServerSocketChannel å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> SocketChannel <span class="title">newSocket</span><span class="params">(SelectorProvider provider)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *  Use the {<span class="doctag">@link</span> SelectorProvider} to open {<span class="doctag">@link</span> SocketChannel} and so remove condition in</span></span><br><span class="line"><span class="comment">         *  {<span class="doctag">@link</span> SelectorProvider#provider()} which is called by each SocketChannel.open() otherwise.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         *  See &lt;a href="https://github.com/netty/netty/issues/2308"&gt;#2308&lt;/a&gt;.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">return</span> provider.openSocketChannel();</span><br><span class="line">    } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ChannelException(<span class="string">"Failed to open a socket."</span>, e);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ğŸ˜ˆ æ˜¯ä¸æ˜¯å¾ˆç†Ÿæ‚‰è¿™æ ·çš„ä»£ç ï¼Œæ•ˆæœå’Œ <code>SocketChannel#open()</code> æ–¹æ³•åˆ›å»º SocketChannel å¯¹è±¡æ˜¯ä¸€è‡´ã€‚</li>
</ul>
</li>
<li><p><code>#NioSocketChannel(SocketChannel channel)</code> æ„é€ æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NioSocketChannel</span><span class="params">(SocketChannel socket)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>(<span class="keyword">null</span>, socket);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NioSocketChannel</span><span class="params">(Channel parent, SocketChannel socket)</span> </span>{</span><br><span class="line">    <span class="keyword">super</span>(parent, socket);</span><br><span class="line">    config = <span class="keyword">new</span> NioSocketChannelConfig(<span class="keyword">this</span>, socket.socket());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è°ƒç”¨çˆ¶ AbstractNioByteChannel çš„æ„é€ æ–¹æ³•ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ3.7.1.2 AbstractNioByteChannelã€</a> ã€‚</li>
<li>åˆå§‹åŒ– <code>config</code> å±æ€§ï¼Œåˆ›å»º NioSocketChannelConfig å¯¹è±¡ã€‚</li>
</ul>
</li>
</ul>
<h4 id="3-7-1-2-AbstractNioByteChannel"><a href="#3-7-1-2-AbstractNioByteChannel" class="headerlink" title="3.7.1.2 AbstractNioByteChannel"></a>3.7.1.2 AbstractNioByteChannel</h4><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">AbstractNioByteChannel</span><span class="params">(Channel parent, SelectableChannel ch)</span> </span>{</span><br><span class="line">    <span class="keyword">super</span>(parent, ch, SelectionKey.OP_READ);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è°ƒç”¨çˆ¶ AbstractNioChannel çš„æ„é€ æ–¹æ³•ã€‚åç»­çš„æ„é€ æ–¹æ³•ï¼Œå’Œ NioServerSocketChannel æ˜¯ä¸€è‡´çš„ã€‚<ul>
<li>æ³¨æ„ä¼ å…¥çš„ SelectionKey çš„å€¼ä¸º <code>OP_READ</code> ã€‚ </li>
</ul>
</li>
</ul>
<h3 id="3-7-2-åˆå§‹åŒ–-Channel-é…ç½®"><a href="#3-7-2-åˆå§‹åŒ–-Channel-é…ç½®" class="headerlink" title="3.7.2 åˆå§‹åŒ– Channel é…ç½®"></a>3.7.2 åˆå§‹åŒ– Channel é…ç½®</h3><p><code>#init(Channel channel)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Channel é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    ChannelPipeline p = channel.pipeline();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ·»åŠ å¤„ç†å™¨åˆ° pipeline ä¸­</span></span><br><span class="line">    p.addLast(config.handler());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– Channel çš„å¯é€‰é¡¹é›†åˆ</span></span><br><span class="line">    <span class="keyword">final</span> Map&lt;ChannelOption&lt;?&gt;, Object&gt; options = options0();</span><br><span class="line">    <span class="keyword">synchronized</span> (options) {</span><br><span class="line">        setChannelOptions(channel, options, logger);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– Channel çš„å±æ€§é›†åˆ</span></span><br><span class="line">    <span class="keyword">final</span> Map&lt;AttributeKey&lt;?&gt;, Object&gt; attrs = attrs0();</span><br><span class="line">    <span class="keyword">synchronized</span> (attrs) {</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;AttributeKey&lt;?&gt;, Object&gt; e: attrs.entrySet()) {</span><br><span class="line">            channel.attr((AttributeKey&lt;Object&gt;) e.getKey()).set(e.getValue());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ¯”è¾ƒç®€å•ï¼Œå·²ç»æ·»åŠ ä¸­æ–‡æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ’¸å®Œ Netty æœåŠ¡ç«¯å¯åŠ¨ä¹‹åï¼Œå†æ’¸ Netty å®¢æˆ·ç«¯å¯åŠ¨ä¹‹åï¼Œå‡ºå¥‡çš„é¡ºæ‰‹ã€‚ç¾æ»‹æ»‹ã€‚</p>
<p>å¦å¤–ï¼Œä¹Ÿæ¨èå¦‚ä¸‹å’Œ Netty å®¢æˆ·ç«¯å¯åŠ¨ç›¸å…³çš„æ–‡ç« ï¼Œä»¥åŠ æ·±ç†è§£ï¼š</p>
<ul>
<li>æ¨æ­¦å…µ <a href="https://my.oschina.net/ywbrj042/blog/868798" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty æºç åˆ†æç³»åˆ— â€”â€” Bootstrapã€‹</a></li>
<li>æ°¸é¡º <a href="https://segmentfault.com/a/1190000007282789" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty æºç åˆ†æä¹‹ ä¸€ æ­å¼€ Bootstrap ç¥ç§˜çš„çº¢ç›–å¤´ (å®¢æˆ·ç«¯)ã€‹</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/bootstrap-2-client/" data-id="ck4pl3fov00ddfgcf8dhfhujw" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>