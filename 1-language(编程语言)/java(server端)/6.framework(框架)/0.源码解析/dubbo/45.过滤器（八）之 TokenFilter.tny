<header class="article-header">
<h1 class="article-title">è¿‡æ»¤å™¨ï¼ˆå…«ï¼‰ä¹‹ TokenFilter</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡åˆ†äº« TokenFilter è¿‡æ»¤å™¨ï¼Œç”¨äºæœåŠ¡<strong>æä¾›è€…</strong>ä¸­ï¼Œæä¾›&nbsp;<strong>ä»¤ç‰ŒéªŒè¯</strong>&nbsp;çš„åŠŸèƒ½ã€‚åœ¨&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/token-authorization.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; ä»¤ç‰ŒéªŒè¯ã€‹</a>&nbsp;å®šä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>é€šè¿‡ä»¤ç‰ŒéªŒè¯åœ¨<strong>æ³¨å†Œä¸­å¿ƒ</strong>æ§åˆ¶æƒé™ï¼Œä»¥å†³å®šè¦ä¸è¦ä¸‹å‘ä»¤ç‰Œç»™æ¶ˆè´¹è€…ï¼Œå¯ä»¥é˜²æ­¢æ¶ˆè´¹è€…ç»•è¿‡æ³¨å†Œä¸­å¿ƒè®¿é—®æä¾›è€…ã€‚</p>
<p>å¦å¤–é€šè¿‡æ³¨å†Œä¸­å¿ƒå¯çµæ´»æ”¹å˜æˆæƒæ–¹å¼ï¼Œè€Œä¸éœ€ä¿®æ”¹æˆ–å‡çº§æä¾›è€…ã€‚</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_11_19/01.png" alt="è®¤è¯æµç¨‹" /></p>
</blockquote>
<ul>
<li>å®˜æ–¹æ–‡æ¡£å†™çš„å¾ˆå…¨ï¼Œèƒ–å‹è¯·ç‚¹å‡»é“¾æ¥çœ‹å®Œå“ˆã€‚</li>
</ul>
<p>So ï¼Œå¯èƒ½å’Œå¤§å¤šæ•°èƒ–å‹ï¼ˆåŒ…æ‹¬æˆ‘ï¼‰ï¼Œä¸€å¼€å§‹ç†è§£å’ŒæœŸæœ›çš„ä¸å¤ªä¸€æ · ğŸ™‚ ã€‚</p>
<h1 id="2-ã€æœåŠ¡æ¶ˆè´¹è€…ã€‘éšæœº-Token">2.ã€æœåŠ¡æ¶ˆè´¹è€…ã€‘éšæœº Token</h1>
<p>åœ¨ ServiceConfig çš„&nbsp;<code>#doExportUrlsFor1Protocol(protocolConfig, registryURLs)</code>&nbsp;æ–¹æ³•ä¸­ï¼Œéšæœºç”Ÿæˆ Token ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// token ï¼Œå‚è§ã€Šä»¤ç‰Œæ ¡éªŒã€‹http://dubbo.apache.org/zh-cn/docs/user/demos/token-authorization.html</span></span><br /><span class="line"><span class="keyword">if</span> (!ConfigUtils.isEmpty(token)) {</span><br /><span class="line">    <span class="keyword">if</span> (ConfigUtils.isDefault(token)) { <span class="comment">// true || default æ—¶ï¼ŒUUID éšæœºç”Ÿæˆ</span></span><br /><span class="line">        map.put(<span class="string">"token"</span>, UUID.randomUUID().toString());</span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        map.put(<span class="string">"token"</span>, token);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="3-ã€æœåŠ¡æ¶ˆè´¹è€…ã€‘æ¥æ”¶-Token">3.ã€æœåŠ¡æ¶ˆè´¹è€…ã€‘æ¥æ”¶ Token</h1>
<p>æœåŠ¡<strong>æ¶ˆè´¹è€…</strong>ï¼Œä»æ³¨å†Œä¸­å¿ƒï¼Œè·å–æœåŠ¡æä¾›è€…çš„&nbsp;<strong>URL</strong>&nbsp;ï¼Œä»è€Œè·å¾—è¯¥æœåŠ¡ç€çš„ Token ã€‚<br />æ‰€ä»¥ï¼Œå³ä½¿æœåŠ¡æä¾›è€…éšæœºç”Ÿæˆ Token ï¼Œæ¶ˆè´¹è€…ä¸€æ ·å¯ä»¥æ‹¿åˆ°ã€‚</p>
<h1 id="3-ã€æœåŠ¡æ¶ˆè´¹è€…ã€‘å‘é€-Token">3.ã€æœåŠ¡æ¶ˆè´¹è€…ã€‘å‘é€ Token</h1>
<p>RpcInvocation åœ¨åˆ›å»ºæ—¶ï¼Œ&ldquo;<strong>è‡ªåŠ¨</strong>&rdquo;å¸¦ä¸Š Token ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_11_19/02.png" alt="RpcInvocation" /></p>
<h1 id="4-ã€æœåŠ¡æä¾›è€…ã€‘è®¤è¯-Token">4.ã€æœåŠ¡æä¾›è€…ã€‘è®¤è¯ Token</h1>
<p><code>com.alibaba.dubbo.rpc.filter.TokenFilter</code>&nbsp;ï¼Œå®ç° Filter æ¥å£ï¼Œ<strong>ä»¤ç‰ŒéªŒè¯</strong>&nbsp;Filter å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Activate</span>(group = Constants.PROVIDER, value = Constants.TOKEN_KEY)</span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation inv)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="comment">// è·å¾—æœåŠ¡æä¾›è€…é…ç½®çš„ Token å€¼</span></span><br /><span class="line">        String token = invoker.getUrl().getParameter(Constants.TOKEN_KEY);</span><br /><span class="line">        <span class="keyword">if</span> (ConfigUtils.isNotEmpty(token)) {</span><br /><span class="line">            <span class="comment">// ä»éšå¼å‚æ•°ä¸­ï¼Œè·å¾— Token å€¼ã€‚</span></span><br /><span class="line">            Class&lt;?&gt; serviceType = invoker.getInterface();</span><br /><span class="line">            Map&lt;String, String&gt; attachments = inv.getAttachments();</span><br /><span class="line">            String remoteToken = attachments == <span class="keyword">null</span> ? <span class="keyword">null</span> : attachments.get(Constants.TOKEN_KEY);</span><br /><span class="line">            <span class="comment">// å¯¹æ¯”ï¼Œè‹¥ä¸ä¸€è‡´ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸</span></span><br /><span class="line">            <span class="keyword">if</span> (!token.equals(remoteToken)) {</span><br /><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Invalid token! Forbid invoke remote service "</span> + serviceType + <span class="string">" method "</span> + inv.getMethodName() + <span class="string">"() from consumer "</span> + RpcContext.getContext().getRemoteHost() + <span class="string">" to provider "</span> + RpcContext.getContext().getLocalHost());</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// æœåŠ¡è°ƒç”¨</span></span><br /><span class="line">        <span class="keyword">return</span> invoker.invoke(inv);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</div>