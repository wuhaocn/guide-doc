<header class="article-header">
<h1 class="article-title">é›†ç¾¤å®¹é”™ï¼ˆä¸‰ï¼‰ä¹‹ Directory å®ç°</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡æ¥&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-2-impl-cluster/?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆäºŒï¼‰ä¹‹ Cluster å®ç°ã€‹</a>&nbsp;ä¸€æ–‡ï¼Œåˆ†äº«&nbsp;<code>dubbo-cluster</code>&nbsp;æ¨¡å—ï¼Œ&nbsp;<code>directory</code>&nbsp;åŒ…ï¼Œ<strong>å„ç§ Directory å®ç°ç±»</strong>ã€‚</p>
<p>Directory ï¼Œä¸­æ–‡ç›´è¯‘ä¸º<strong>ç›®å½•</strong>ï¼Œä»£è¡¨äº†<strong>å¤šä¸ª</strong>&nbsp;Invoker ï¼Œå¯ä»¥æŠŠå®ƒçœ‹æˆ&nbsp;<code>List&lt;Invoker&gt;</code>&nbsp;ã€‚ä½†ä¸ List ä¸åŒçš„æ˜¯ï¼Œå®ƒçš„å€¼å¯èƒ½æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼Œæ¯”å¦‚æ³¨å†Œä¸­å¿ƒæ¨é€å˜æ›´ã€‚</p>
<p>Directory å­ç±»å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_04_10/01.png" alt="Directory å­ç±»" /></p>
<p>æˆ‘ä»¬çœ‹åˆ°æœ‰ä¸¤ä¸ªå®ç°ç±»ï¼š</p>
<ul>
<li>StaticDirectory ï¼Œ<strong>é™æ€</strong>&nbsp;Directory å®ç°ç±»ï¼Œä»å‘½åä¸Šçœ‹å‡ºå®ƒæ˜¯<strong>é™æ€</strong>çš„&nbsp;<code>List&lt;Invoker&gt;</code>&nbsp;ã€‚</li>
<li>RegistryDirectory ï¼ŒåŸºäº<strong>æ³¨å†Œä¸­å¿ƒ</strong>çš„<strong>åŠ¨æ€</strong>&nbsp;Directory å®ç°ç±»ï¼Œä»å‘½åä¸Šçœ‹å‡ºå®ƒæ˜¯<strong>åŠ¨æ€</strong>çš„ï¼Œä¼šæ ¹æ®æ³¨å†Œä¸­å¿ƒçš„æ¨é€å˜æ›´&nbsp;<code>List&lt;Invoker&gt;</code>&nbsp;ã€‚</li>
</ul>
<h1 id="2-Directory">2. Directory</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.Directory</code>&nbsp;ï¼Œç»§æ‰¿ Node æ¥å£ï¼ŒDirectory æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Directory</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">Node</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * get service type.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * è·å¾—æœåŠ¡ç±»å‹ï¼Œä¾‹å¦‚ï¼šcom.alibaba.dubbo.demo.DemoService</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> service type.</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function">Class&lt;T&gt; <span class="title">getInterface</span><span class="params">()</span></span>;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * list invokers.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * è·å¾—æ‰€æœ‰æœåŠ¡ Invoker é›†åˆ</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> invokers</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    List&lt;Invoker&lt;T&gt;&gt; list(Invocation invocation) <span class="keyword">throws</span> RpcException;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å®šä¹‰äº†<strong>ä¸¤ä¸ª</strong>æ¥å£æ–¹æ³•ï¼Œåˆ†åˆ«è¿”å›æœåŠ¡çš„<strong>ç±»å‹</strong>å’Œ&nbsp;<strong>Invoker é›†åˆ</strong>ã€‚</li>
<li>ä¸€ä¸ª Directory&nbsp;<strong>åªå¯¹åº”</strong>ä¸€ä¸ªæœåŠ¡ç±»å‹ã€‚</li>
</ul>
<h1 id="3-AbstractDirectory">3. AbstractDirectory</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.directory.AbstractDirectory</code>&nbsp;ï¼Œå®ç° Directory æ¥å£ï¼ŒDirectory æŠ½è±¡å®ç°ç±»ï¼Œå®ç°äº†å…¬ç”¨çš„<strong>è·¯ç”±è§„åˆ™( Router )</strong>çš„é€»è¾‘ã€‚</p>
<h2 id="3-1-æ„é€ æ–¹æ³•">3.1 æ„é€ æ–¹æ³•</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦å·²ç»é”€æ¯</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> destroyed = <span class="keyword">false</span>;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ³¨å†Œä¸­å¿ƒ URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ¶ˆè´¹è€… URL</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * è‹¥æœªæ˜¾ç¤ºè°ƒç”¨ {<span class="doctag">@link</span> #AbstractDirectory(URL, URL, List)} æ„é€ æ–¹æ³•ï¼ŒconsumerUrl ç­‰äº {<span class="doctag">@link</span> #url}</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> URL consumerUrl;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Router æ•°ç»„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> List&lt;Router&gt; routers;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractDirectory</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>(url, <span class="keyword">null</span>);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractDirectory</span><span class="params">(URL url, List&lt;Router&gt; routers)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>(url, url, routers);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractDirectory</span><span class="params">(URL url, URL consumerUrl, List&lt;Router&gt; routers)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (url == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"url == null"</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">this</span>.url = url;</span><br /><span class="line">    <span class="keyword">this</span>.consumerUrl = consumerUrl;</span><br /><span class="line">    <span class="comment">// è®¾ç½® Router æ•°ç»„</span></span><br /><span class="line">    setRouters(routers);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>consumerUrl</code>&nbsp;å­—æ®µï¼Œè®¤çœŸçœ‹ä¸‹æ³¨é‡Šå’Œæ„é€ æ–¹æ³•ã€‚</li>
<li>è°ƒç”¨&nbsp;<code>#setRouters(routers)</code>&nbsp;æ–¹æ³•ï¼Œåˆå§‹åŒ–å¹¶è®¾ç½® Router æ•°ç»„ã€‚</li>
</ul>
<h2 id="3-2-setRouters">3.2 setRouters</h2>
<p><code>#setRouters(routers)</code>&nbsp;æ–¹æ³•ï¼Œåˆå§‹åŒ–å¹¶è®¾ç½® Router æ•°ç»„ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-7-impl-router?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆä¸ƒï¼‰ä¹‹ Router å®ç°ã€‹</a>&nbsp;ä¸­ã€‚</p>
<h2 id="3-3-list">3.3 list</h2>
<p><code>#list(Invocation)</code>&nbsp;<strong>å®ç°</strong>æ–¹æ³•ï¼Œè·å¾—æ‰€æœ‰æœåŠ¡ Invoker é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">public</span> List&lt;Invoker&lt;T&gt;&gt; list(Invocation invocation) <span class="keyword">throws</span> RpcException {</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (destroyed) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Directory already destroyed .url: "</span> + getUrl());</span><br /><span class="line"> <span class="number">5</span>:     }</span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// è·å¾—æ‰€æœ‰ Invoker é›†åˆ</span></span><br /><span class="line"> <span class="number">7</span>:     List&lt;Invoker&lt;T&gt;&gt; invokers = doList(invocation);</span><br /><span class="line"> <span class="number">8</span>:     <span class="comment">// æ ¹æ®è·¯ç”±è§„åˆ™ï¼Œç­›é€‰ Invoker é›†åˆ</span></span><br /><span class="line"> <span class="number">9</span>:     List&lt;Router&gt; localRouters = <span class="keyword">this</span>.routers; <span class="comment">// local reference æœ¬åœ°å¼•ç”¨ï¼Œé¿å…å¹¶å‘é—®é¢˜</span></span><br /><span class="line"><span class="number">10</span>:     <span class="keyword">if</span> (localRouters != <span class="keyword">null</span> &amp;&amp; !localRouters.isEmpty()) {</span><br /><span class="line"><span class="number">11</span>:         <span class="keyword">for</span> (Router router : localRouters) {</span><br /><span class="line"><span class="number">12</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">13</span>:                 <span class="keyword">if</span> (router.getUrl() == <span class="keyword">null</span> || router.getUrl().getParameter(Constants.RUNTIME_KEY, <span class="keyword">false</span>)) {</span><br /><span class="line"><span class="number">14</span>:                     invokers = router.route(invokers, getConsumerUrl(), invocation);</span><br /><span class="line"><span class="number">15</span>:                 }</span><br /><span class="line"><span class="number">16</span>:             } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">17</span>:                 logger.error(<span class="string">"Failed to execute router: "</span> + getUrl() + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">18</span>:             }</span><br /><span class="line"><span class="number">19</span>:         }</span><br /><span class="line"><span class="number">20</span>:     }</span><br /><span class="line"><span class="number">21</span>:     <span class="keyword">return</span> invokers;</span><br /><span class="line"><span class="number">22</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ç¬¬ 7 è¡Œï¼šè°ƒç”¨&nbsp;<code>#doList(invocation)</code>&nbsp;<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè·å¾—æ‰€æœ‰ Invoker é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> List&lt;Invoker&lt;T&gt;&gt; doList(Invocation invocation) <span class="keyword">throws</span> RpcException;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 9 è‡³ 20 è¡Œï¼šæ ¹æ®<strong>è·¯ç”±è§„åˆ™( Router )</strong>ï¼Œè¿›ä¸€æ­¥ç­›é€‰åˆé€‚çš„ Invoker é›†åˆã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-7-impl-router/?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆä¸ƒï¼‰ä¹‹ Router å®ç°ã€‹</a>&nbsp;ã€‚</p>
</li>
</ul>
<h1 id="4-RegistryDirectory">4. RegistryDirectory</h1>
<p><code>com.alibaba.dubbo.registry.integration.RegistryDirectory</code>&nbsp;ï¼Œå®ç° NotifyListener æ¥å£ï¼Œå®ç° AbstractDirectory æŠ½è±¡ç±»ï¼ŒåŸºäº<strong>æ³¨å†Œä¸­å¿ƒ</strong>çš„ Directory å®ç°ç±»ã€‚</p>
<ol>
<li>RegistryDirectory åœ¨&nbsp;<code>dubbo-registry</code>&nbsp;æ¨¡å—ï¼Œ<code>integration</code>&nbsp;åŒ…ä¸‹ï¼Œæ˜¯ Dubbo æ³¨å†Œä¸­å¿ƒæ¨¡å—é›†æˆ Directory çš„å®ç°ç±»ã€‚</li>
<li>RegistryDirectory ä½œä¸ºä¸€ä¸ª NotifyListener ï¼Œ<strong>è®¢é˜…</strong>æ³¨å†Œä¸­å¿ƒ( Registry ) çš„æ•°æ®ï¼Œå®ç°å¯¹å˜æ›´çš„<strong>ç›‘å¬</strong>ã€‚</li>
</ol>
<h2 id="4-1-æ„é€ æ–¹æ³•">4.1 æ„é€ æ–¹æ³•</h2>
<blockquote>
<p>RegistryDirectory çš„å­—æ®µæœ‰&nbsp;<strong>17</strong>&nbsp;ä¸ªï¼Œæ¯”è¾ƒå¤šï¼Œæ‰€ä»¥èƒ–å‹è¯·è€å¿ƒã€‚</p>
</blockquote>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ========== Dubbo SPI Adaptive å¯¹è±¡ BEGIN ==========</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Cluster$Adaptive å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Cluster cluster = ExtensionLoader.getExtensionLoader(Cluster.class).getAdaptiveExtension();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * RouterFactory$Adaptive å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RouterFactory routerFactory = ExtensionLoader.getExtensionLoader(RouterFactory.class).getAdaptiveExtension();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ConfiguratorFactory$Adaptive å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConfiguratorFactory configuratorFactory = ExtensionLoader.getExtensionLoader(ConfiguratorFactory.class).getAdaptiveExtension();</span><br /><br /><span class="line"><span class="comment">// ========== æœåŠ¡æ¶ˆè´¹è€…ç›¸å…³ BEGIN ==========</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æœåŠ¡ç±»å‹ï¼Œä¾‹å¦‚ï¼šcom.alibaba.dubbo.demo.DemoService</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; serviceType; <span class="comment">// Initialization at construction time, assertion not null</span></span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Consumer URL çš„é…ç½®é¡¹ Map</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; queryMap; <span class="comment">// Initialization at construction time, assertion not null</span></span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æœåŠ¡æ–¹æ³•æ•°ç»„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String[] serviceMethods;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦å¼•ç”¨å¤šåˆ†ç»„</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * æœåŠ¡åˆ†ç»„ï¼šhttp://dubbo.apache.org/zh-cn/docs/user/demos/service-group.html</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> multiGroup;</span><br /><br /><span class="line"><span class="comment">// ========== æ³¨å†Œä¸­å¿ƒç›¸å…³ BEGIN ==========</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ³¨å†Œä¸­å¿ƒçš„ Protocol å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Protocol protocol; <span class="comment">// Initialization at the time of injection, the assertion is not null</span></span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ³¨å†Œä¸­å¿ƒ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Registry registry; <span class="comment">// Initialization at the time of injection, the assertion is not null</span></span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ³¨å†Œä¸­å¿ƒçš„æœåŠ¡ç±»ï¼Œç›®å‰æ˜¯ com.alibaba.dubbo.registry.RegistryService</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * é€šè¿‡ {<span class="doctag">@link</span> #url} çš„ {<span class="doctag">@link</span> URL#getServiceKey()} è·å¾—</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String serviceKey; <span class="comment">// Initialization at construction time, assertion not null</span></span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦ç¦æ­¢è®¿é—®ã€‚</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * æœ‰ä¸¤ç§æƒ…å†µä¼šå¯¼è‡´ï¼š</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * 1. æ²¡æœ‰æœåŠ¡æä¾›è€…</span></span><br /><span class="line"><span class="comment"> * 2. æœåŠ¡æä¾›è€…è¢«ç¦ç”¨</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> forbidden = <span class="keyword">false</span>;</span><br /><br /><span class="line"><span class="comment">// ========== é…ç½®è§„åˆ™ç›¸å…³ BEGIN ==========</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * åŸå§‹çš„ç›®å½• URL</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * ä¾‹å¦‚ï¼šzookeeper://127.0.0.1:2181/com.alibaba.dubbo.registry.RegistryService?application=demo-consumer&amp;callbacks=1000&amp;check=false&amp;client=netty4&amp;cluster=failback&amp;dubbo=2.0.0&amp;interface=com.alibaba.dubbo.demo.DemoService&amp;methods=sayHello,callbackParam,save,update,say03,delete,say04,demo,say01,bye,say02,saves&amp;payload=1000&amp;pid=63400&amp;qos.port=33333&amp;register.ip=192.168.16.23&amp;sayHello.async=true&amp;side=consumer&amp;timeout=10000&amp;timestamp=1527056491064</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> URL directoryUrl; <span class="comment">// Initialization at construction time, assertion not null, and always assign non null value</span></span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è¦†å†™çš„ç›®å½• URL ï¼Œç»“åˆé…ç½®è§„åˆ™</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> URL overrideDirectoryUrl; <span class="comment">// Initialization at construction time, assertion not null, and always assign non null value</span></span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é…ç½®è§„åˆ™æ•°ç»„</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * override rules</span></span><br /><span class="line"><span class="comment"> * Priority: override&gt;-D&gt;consumer&gt;provider</span></span><br /><span class="line"><span class="comment"> * Rule one: for a certain provider &lt;ip:port,timeout=100&gt;</span></span><br /><span class="line"><span class="comment"> * Rule two: for all providers &lt;* ,timeout=5000&gt;</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> List&lt;Configurator&gt; configurators; <span class="comment">// The initial value is null and the midway may be assigned to null, please use the local variable reference</span></span><br /><br /><span class="line"><span class="comment">// ========== æœåŠ¡æä¾›è€…ç›¸å…³ BEGIN ==========</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * [url]ä¸[æœåŠ¡æä¾›è€… Invoker é›†åˆ]çš„æ˜ å°„ç¼“å­˜</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="comment">// Map&lt;url, Invoker&gt; cache service url to invoker mapping.</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Map&lt;String, Invoker&lt;T&gt;&gt; urlInvokerMap; <span class="comment">// The initial value is null and the midway may be assigned to null, please use the local variable reference</span></span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * [æ–¹æ³•å]ä¸[æœåŠ¡æä¾›è€… Invoker é›†åˆ]çš„æ˜ å°„ç¼“å­˜</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="comment">// Map&lt;methodName, Invoker&gt; cache service method to invokers mapping.</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; methodInvokerMap; <span class="comment">// The initial value is null and the midway may be assigned to null, please use the local variable reference</span></span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * [æœåŠ¡æä¾›è€… Invoker é›†åˆ]ç¼“å­˜</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="comment">// Set&lt;invokerUrls&gt; cache invokeUrls to invokers mapping.</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Set&lt;URL&gt; cachedInvokerUrls; <span class="comment">// The initial value is null and the midway may be assigned to null, please use the local variable reference</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RegistryDirectory</span><span class="params">(Class&lt;T&gt; serviceType, URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">super</span>(url);</span><br /><span class="line">    <span class="keyword">if</span> (serviceType == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"service type is null."</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">if</span> (url.getServiceKey() == <span class="keyword">null</span> || url.getServiceKey().length() == <span class="number">0</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"registry serviceKey is null."</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">this</span>.serviceType = serviceType;</span><br /><span class="line">    <span class="keyword">this</span>.serviceKey = url.getServiceKey();</span><br /><span class="line">    <span class="comment">// è·å¾— queryMap</span></span><br /><span class="line">    <span class="keyword">this</span>.queryMap = StringUtils.parseQueryString(url.getParameterAndDecoded(Constants.REFER_KEY));</span><br /><span class="line">    <span class="comment">// è·å¾— overrideDirectoryUrl å’Œ directoryUrl</span></span><br /><span class="line">    <span class="keyword">this</span>.overrideDirectoryUrl = <span class="keyword">this</span>.directoryUrl = url.setPath(url.getServiceInterface()).clearParameters().addParameters(queryMap).removeParameter(Constants.MONITOR_KEY);</span><br /><span class="line">    <span class="comment">// åˆå§‹åŒ– multiGroup</span></span><br /><span class="line">    String group = directoryUrl.getParameter(Constants.GROUP_KEY, <span class="string">""</span>);</span><br /><span class="line">    <span class="keyword">this</span>.multiGroup = group != <span class="keyword">null</span> &amp;&amp; (<span class="string">"*"</span>.equals(group) || group.contains(<span class="string">","</span>));</span><br /><span class="line">    <span class="comment">// åˆå§‹åŒ– serviceMethods</span></span><br /><span class="line">    String methods = queryMap.get(Constants.METHODS_KEY);</span><br /><span class="line">    <span class="keyword">this</span>.serviceMethods = methods == <span class="keyword">null</span> ? <span class="keyword">null</span> : Constants.COMMA_SPLIT_PATTERN.split(methods);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>åˆ†æˆ<strong>äº”ç±»</strong>å˜é‡ã€‚èƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚</li>
<li>å¦‚æœä¸ç†è§£ï¼Œå¯ä»¥ç»“åˆä¸‹é¢çš„å…·ä½“æ–¹æ³•çš„ä½¿ç”¨ã€‚ğŸ™‚ å½“ç„¶ä¹Ÿå¯ä»¥ç»™æˆ‘ç•™è¨€ï¼Œå› ä¸ºç¡®å®å˜é‡æœ‰ç‚¹å¤šå’Œå¤æ‚ã€‚</li>
</ul>
<h2 id="4-2-subscribe">4.2 subscribe</h2>
<p><code>#subscribe(URL)</code>&nbsp;æ–¹æ³•ï¼Œå‘<strong>æ³¨å†Œä¸­å¿ƒ</strong>å‘èµ·è®¢é˜…ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="comment">// è®¾ç½®æ¶ˆè´¹è€… URL</span></span><br /><span class="line">    setConsumerUrl(url);</span><br /><span class="line">    <span class="comment">// å‘æ³¨å†Œä¸­å¿ƒï¼Œå‘èµ·è®¢é˜…</span></span><br /><span class="line">    registry.subscribe(url, <span class="keyword">this</span>);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è°ƒç”¨<strong>çˆ¶</strong>&nbsp;<code>#setConsumerUrl(url)</code>&nbsp;æ–¹æ³•ï¼Œè®¾ç½®&nbsp;<code>consumerUrl</code>&nbsp;æ¶ˆè´¹è€… URL ã€‚</li>
<li>è°ƒç”¨&nbsp;<code>Registry#subscribe(url, NotifyListener)</code>&nbsp;æ–¹æ³•ï¼Œå‘æ³¨å†Œä¸­å¿ƒï¼Œå‘èµ·è®¢é˜…ã€‚</li>
</ul>
<p>æœåŠ¡æ¶ˆè´¹è€…ï¼Œå†å¼•ç”¨æœåŠ¡æ—¶ï¼Œä¼šåˆ›å»º RegistryDirectory å¯¹è±¡ï¼Œå¹¶å‘èµ·<strong>1ï¼‰æœåŠ¡æä¾›è€… + 2ï¼‰è·¯ç”±è§„åˆ™ + 3ï¼‰é…ç½®è§„åˆ™</strong>çš„æ•°æ®è®¢é˜…ã€‚å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_04_10/02.png" alt="doRefer" /></p>
<ul>
<li>å¯¹åº”ä¸º&nbsp;<code>RegistryProtocol#doRefer(Cluster, Registry, Class&lt;T&gt; type, URL url)</code>&nbsp;æ–¹æ³•ã€‚</li>
</ul>
<h2 id="4-3-notify">4.3 notify</h2>
<p>åœ¨æ³¨å†Œä¸­å¿ƒ( Registry )å‘ç°æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šé€šçŸ¥å¯¹åº”çš„ NotifyListener ä»¬ã€‚å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_04_10/03.png" alt="notify" /></p>
<ul>
<li>å¯¹åº”ä¸º&nbsp;<code>AbstractRegistry#notify(URL url, NotifyListener, List&lt;URL&gt; urls)</code>&nbsp;æ–¹æ³•ã€‚</li>
<li>å› ä¸º RegistryDirectory ä½œä¸ºä¸€ä¸ª NotifyListener ï¼Œå‘æ³¨å†Œä¸­å¿ƒ( Registry )å‘èµ·äº†è®¢é˜…ï¼Œæ‰€ä»¥æ­¤æ—¶ä¼šè¢«é€šçŸ¥ã€‚<strong>æ³¨æ„ï¼Œæ˜¯æŒ‰ç…§åˆ†ç±»å¾ªç¯é€šçŸ¥çš„</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>ä¸€æ¬¡åªæœ‰ä¸€ç±» URL</strong>&nbsp;ã€‚</li>
</ul>
<p><code>#notify(List&lt;URL&gt; urls)</code>&nbsp;<strong>å®ç°</strong>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(List&lt;URL&gt; urls)</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// æ ¹æ® URL çš„åˆ†ç±»æˆ–åè®®ï¼Œåˆ†ç»„æˆä¸‰ä¸ªé›†åˆ ã€‚</span></span><br /><span class="line"> <span class="number">4</span>:     List&lt;URL&gt; invokerUrls = <span class="keyword">new</span> ArrayList&lt;URL&gt;(); <span class="comment">// æœåŠ¡æä¾›è€… URL é›†åˆ</span></span><br /><span class="line"> <span class="number">5</span>:     List&lt;URL&gt; routerUrls = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br /><span class="line"> <span class="number">6</span>:     List&lt;URL&gt; configuratorUrls = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">for</span> (URL url : urls) {</span><br /><span class="line"> <span class="number">8</span>:         String protocol = url.getProtocol();</span><br /><span class="line"> <span class="number">9</span>:         String category = url.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);</span><br /><span class="line"><span class="number">10</span>:         <span class="keyword">if</span> (Constants.ROUTERS_CATEGORY.equals(category) || Constants.ROUTE_PROTOCOL.equals(protocol)) {</span><br /><span class="line"><span class="number">11</span>:             routerUrls.add(url);</span><br /><span class="line"><span class="number">12</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (Constants.CONFIGURATORS_CATEGORY.equals(category) || Constants.OVERRIDE_PROTOCOL.equals(protocol)) {</span><br /><span class="line"><span class="number">13</span>:             configuratorUrls.add(url);</span><br /><span class="line"><span class="number">14</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (Constants.PROVIDERS_CATEGORY.equals(category)) {</span><br /><span class="line"><span class="number">15</span>:             invokerUrls.add(url);</span><br /><span class="line"><span class="number">16</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">17</span>:             logger.warn(<span class="string">"Unsupported category "</span> + category + <span class="string">" in notified url: "</span> + url + <span class="string">" from registry "</span> + getUrl().getAddress() + <span class="string">" to consumer "</span> + NetUtils.getLocalHost());</span><br /><span class="line"><span class="number">18</span>:         }</span><br /><span class="line"><span class="number">19</span>:     }</span><br /><span class="line"><span class="number">20</span>:     <span class="comment">// å¤„ç†é…ç½®è§„åˆ™ URL é›†åˆ</span></span><br /><span class="line"><span class="number">21</span>:     <span class="comment">// configurators</span></span><br /><span class="line"><span class="number">22</span>:     <span class="keyword">if</span> (!configuratorUrls.isEmpty()) {</span><br /><span class="line"><span class="number">23</span>:         <span class="keyword">this</span>.configurators = toConfigurators(configuratorUrls);</span><br /><span class="line"><span class="number">24</span>:     }</span><br /><span class="line"><span class="number">25</span>:     <span class="comment">// å¤„ç†è·¯ç”±è§„åˆ™ URL é›†åˆ</span></span><br /><span class="line"><span class="number">26</span>:     <span class="comment">// routers</span></span><br /><span class="line"><span class="number">27</span>:     <span class="keyword">if</span> (!routerUrls.isEmpty()) {</span><br /><span class="line"><span class="number">28</span>:         List&lt;Router&gt; routers = toRouters(routerUrls);</span><br /><span class="line"><span class="number">29</span>:         <span class="keyword">if</span> (routers != <span class="keyword">null</span>) { <span class="comment">// null - do nothing</span></span><br /><span class="line"><span class="number">30</span>:             setRouters(routers);</span><br /><span class="line"><span class="number">31</span>:         }</span><br /><span class="line"><span class="number">32</span>:     }</span><br /><span class="line"><span class="number">33</span>:     <span class="comment">// åˆå¹¶é…ç½®è§„åˆ™ï¼Œåˆ° `directoryUrl` ä¸­ï¼Œå½¢æˆ `overrideDirectoryUrl` å˜é‡ã€‚</span></span><br /><span class="line"><span class="number">34</span>:     List&lt;Configurator&gt; localConfigurators = <span class="keyword">this</span>.configurators; <span class="comment">// local reference</span></span><br /><span class="line"><span class="number">35</span>:     <span class="comment">// merge override parameters</span></span><br /><span class="line"><span class="number">36</span>:     <span class="keyword">this</span>.overrideDirectoryUrl = directoryUrl;</span><br /><span class="line"><span class="number">37</span>:     <span class="keyword">if</span> (localConfigurators != <span class="keyword">null</span> &amp;&amp; !localConfigurators.isEmpty()) {</span><br /><span class="line"><span class="number">38</span>:         <span class="keyword">for</span> (Configurator configurator : localConfigurators) {</span><br /><span class="line"><span class="number">39</span>:             <span class="keyword">this</span>.overrideDirectoryUrl = configurator.configure(overrideDirectoryUrl);</span><br /><span class="line"><span class="number">40</span>:         }</span><br /><span class="line"><span class="number">41</span>:     }</span><br /><span class="line"><span class="number">42</span>:     <span class="comment">// å¤„ç†æœåŠ¡æä¾›è€… URL é›†åˆ</span></span><br /><span class="line"><span class="number">43</span>:     refreshInvoker(invokerUrls);</span><br /><span class="line"><span class="number">44</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><strong>æ³¨æ„</strong>ï¼Œè¿™æ˜¯ä¸€ä¸ª<strong>åŒæ­¥</strong>çš„æ–¹æ³•ã€‚</li>
<li>ç¬¬ 3 è‡³ 19 è¡Œï¼šæ ¹æ® URL çš„<strong>åˆ†ç±»</strong>æˆ–åè®®ï¼Œåˆ†æˆç»„<strong>ä¸‰ä¸ª</strong>é›†åˆï¼š<strong>1ï¼‰æœåŠ¡æä¾›è€… + 2ï¼‰è·¯ç”±è§„åˆ™ + 3ï¼‰é…ç½®è§„åˆ™</strong>ã€‚</li>
<li>ç¬¬ 20 è‡³ 24 è¡Œï¼šéç©ºï¼Œè°ƒç”¨&nbsp;<code>#toConfigurators(configuratorUrls)</code>&nbsp;æ–¹æ³•ï¼Œå¤„ç†<strong>é…ç½®è§„åˆ™</strong>&nbsp;URL é›†åˆã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory/">ã€Œ4.3.1 toConfiguratorsã€</a>&nbsp;ã€‚</li>
<li>ç¬¬ 25 è‡³ 32 è¡Œï¼šéç©ºï¼Œè°ƒç”¨&nbsp;<code>#toRouters(routerUrls)</code>&nbsp;æ–¹æ³•ï¼Œå¤„ç†<strong>è·¯ç”±è§„åˆ™</strong>&nbsp;URL é›†åˆã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory/">ã€Œ4.3.2 toRoutersã€</a>&nbsp;ã€‚
<ul>
<li>è‹¥è½¬æ¢åˆ°&nbsp;<code>routers</code>&nbsp;éç©ºï¼Œè°ƒç”¨<strong>çˆ¶</strong>&nbsp;<code>#setRouters(routers)</code>&nbsp;æ–¹æ³•ï¼Œè®¾ç½®è·¯ç”±è§„åˆ™ã€‚</li>
</ul>
</li>
<li>ç¬¬ 33 è‡³ 41 è¡Œï¼šåˆå¹¶é…ç½®è§„åˆ™ï¼Œåˆ°&nbsp;<code>directoryUrl</code>&nbsp;ä¸­ï¼Œå½¢æˆ&nbsp;<code>overrideDirectoryUrl</code>&nbsp;å˜é‡ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-6-impl-configurator?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆå…­ï¼‰ä¹‹ Configurator å®ç°ã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory/">ã€Œ4.1.2 mergeUrlã€</a>&nbsp;ã€‚</li>
<li>ç¬¬ 43 è¡Œï¼šè°ƒç”¨&nbsp;<code>#refreshInvoker(invokerUrls)</code>&nbsp;æ–¹æ³•ï¼Œå¤„ç†<strong>æœåŠ¡æä¾›è€…</strong>&nbsp;URL é›†åˆã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory/">ã€Œ4.3.3 refreshInvokerã€</a>&nbsp;ã€‚</li>
</ul>
<h3 id="4-3-1-toConfigurators">4.3.1 toConfigurators</h3>
<p>è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-6-impl-configurator?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆå…­ï¼‰ä¹‹ Configurator å®ç°ã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory/">ã€Œ4.1.1 toConfiguratorsã€</a>&nbsp;ã€‚</p>
<h3 id="4-3-2-toRouters">4.3.2 toRouters</h3>
<p>è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-7-impl-router/?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆä¸ƒï¼‰ä¹‹ Router å®ç°ã€‹</a>&nbsp;ã€‚</p>
<h2 id="4-7-å†…éƒ¨ç±»">4.7 å†…éƒ¨ç±»</h2>
<h3 id="4-7-1-InvokerDelegate">4.7.1 InvokerDelegate</h3>
<p>InvokerDelegate ï¼Œå®ç°&nbsp;<code>com.alibaba.dubbo.rpc.protocol.InvokerWrapper</code>&nbsp;ç±»ï¼ŒInvoker ä»£ç†ç±»ï¼Œä¸»è¦ç”¨äºå­˜å‚¨<strong>æ³¨å†Œä¸­å¿ƒä¸‹å‘çš„ url åœ°å€</strong>(&nbsp;<code>providerUrl</code>&nbsp;)ï¼Œç”¨äºé‡æ–°é‡æ–° refer æ—¶èƒ½å¤Ÿæ ¹æ®&nbsp;<code>providerURL</code>queryMap overrideMap é‡æ–°ç»„è£…ã€‚ ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>è€è‰¿è‰¿ï¼šç›®å‰è²Œä¼¼æ²¡çœ‹åˆ°è¿™å—é€»è¾‘å™¢ ğŸ˜¯ğŸ˜¯ğŸ˜¯</p>
</blockquote>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerDelegate</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">InvokerWrapper</span>&lt;<span class="title">T</span>&gt; </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æœåŠ¡æä¾›è€… URL</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * æœªç»è¿‡é…ç½®åˆå¹¶</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> URL providerUrl;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerDelegate</span><span class="params">(Invoker&lt;T&gt; invoker, URL url, URL providerUrl)</span> </span>{</span><br /><span class="line">        <span class="keyword">super</span>(invoker, url);</span><br /><span class="line">        <span class="keyword">this</span>.providerUrl = providerUrl;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> URL <span class="title">getProviderUrl</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> providerUrl;</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="4-7-2-InvokerComparator">4.7.2 InvokerComparator</h3>
<p>InvokerComparator ï¼Œå®ç° Comparator æ¥å£ï¼ŒInvoker æ’åºå™¨å®ç°ç±»ï¼Œ<strong>æ ¹æ® URL å‡åº</strong>&nbsp;ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerComparator</span> <span class="keyword">implements</span> <span class="title">Comparator</span>&lt;<span class="title">Invoker</span>&lt;?&gt;&gt; </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * å•ä¾‹</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> InvokerComparator comparator = <span class="keyword">new</span> InvokerComparator();</span><br /><br /><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">InvokerComparator</span><span class="params">()</span> </span>{</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InvokerComparator <span class="title">getComparator</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> comparator;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Invoker&lt;?&gt; o1, Invoker&lt;?&gt; o2)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> o1.getUrl().toString().compareTo(o2.getUrl().toString());</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="4-3-3-refreshInvoker">4.3.3 refreshInvoker</h3>
<p><code>#refreshInvoker(List&lt;URL&gt; invokerUrls)</code>&nbsp;æ–¹æ³•ï¼Œå®˜æ–¹æ³¨é‡Šå…¶å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>æ ¹æ® invokerURL åˆ—è¡¨è½¬æ¢ä¸º invoker åˆ—è¡¨ã€‚è½¬æ¢è§„åˆ™å¦‚ä¸‹ï¼š</p>
<ol>
<li>å¦‚æœ url å·²ç»è¢«è½¬æ¢ä¸º invoker ï¼Œåˆ™ä¸åœ¨é‡æ–°å¼•ç”¨ï¼Œç›´æ¥ä»ç¼“å­˜ä¸­è·å–ï¼Œæ³¨æ„å¦‚æœ url ä¸­ä»»ä½•ä¸€ä¸ªå‚æ•°å˜æ›´ä¹Ÿä¼šé‡æ–°å¼•ç”¨</li>
<li>å¦‚æœä¼ å…¥çš„ invoker åˆ—è¡¨ä¸ä¸ºç©ºï¼Œåˆ™è¡¨ç¤ºæœ€æ–°çš„ invoker åˆ—è¡¨</li>
<li>å¦‚æœä¼ å…¥çš„ invokerUrl åˆ—è¡¨æ˜¯ç©ºï¼Œåˆ™è¡¨ç¤ºåªæ˜¯ä¸‹å‘çš„ override è§„åˆ™æˆ– route è§„åˆ™ï¼Œéœ€è¦é‡æ–°äº¤å‰å¯¹æ¯”ï¼Œå†³å®šæ˜¯å¦éœ€è¦é‡æ–°å¼•ç”¨ã€‚</li>
</ol>
</blockquote>
<ul>
<li>æ˜¯ä¸æ˜¯çœ‹èµ·æ¥æœ‰ç‚¹ç‚¹æ‡µé€¼ï¼Ÿæ·¡å®šï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç ã€‚</li>
</ul>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshInvoker</span><span class="params">(List&lt;URL&gt; invokerUrls)</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (invokerUrls != <span class="keyword">null</span> &amp;&amp; invokerUrls.size() == <span class="number">1</span> &amp;&amp; invokerUrls.get(<span class="number">0</span>) != <span class="keyword">null</span></span><br /><span class="line"> <span class="number">3</span>:             &amp;&amp; Constants.EMPTY_PROTOCOL.equals(invokerUrls.get(<span class="number">0</span>).getProtocol())) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="comment">// è®¾ç½®ç¦æ­¢è®¿é—®</span></span><br /><span class="line"> <span class="number">5</span>:         <span class="keyword">this</span>.forbidden = <span class="keyword">true</span>; <span class="comment">// Forbid to access</span></span><br /><span class="line"> <span class="number">6</span>:         <span class="comment">// methodInvokerMap ç½®ç©º</span></span><br /><span class="line"> <span class="number">7</span>:         <span class="keyword">this</span>.methodInvokerMap = <span class="keyword">null</span>; <span class="comment">// Set the method invoker map to null</span></span><br /><span class="line"> <span class="number">8</span>:         <span class="comment">// é”€æ¯æ‰€æœ‰ Invoker é›†åˆ</span></span><br /><span class="line"> <span class="number">9</span>:         destroyAllInvokers(); <span class="comment">// Close all invokers</span></span><br /><span class="line"><span class="number">10</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">11</span>:         <span class="comment">// è®¾ç½®å…è®¸è®¿é—®</span></span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">this</span>.forbidden = <span class="keyword">false</span>; <span class="comment">// Allow to access</span></span><br /><span class="line"><span class="number">13</span>:         <span class="comment">// å¼•ç”¨è€çš„ urlInvokerMap</span></span><br /><span class="line"><span class="number">14</span>:         Map&lt;String, Invoker&lt;T&gt;&gt; oldUrlInvokerMap = <span class="keyword">this</span>.urlInvokerMap; <span class="comment">// local reference</span></span><br /><span class="line"><span class="number">15</span>:         <span class="comment">// ä¼ å…¥çš„ invokerUrls ä¸ºç©ºï¼Œè¯´æ˜æ˜¯è·¯ç”±è§„åˆ™æˆ–é…ç½®è§„åˆ™å‘ç”Ÿæ”¹å˜ï¼Œæ­¤æ—¶ invokerUrls æ˜¯ç©ºçš„ï¼Œç›´æ¥ä½¿ç”¨ cachedInvokerUrls ã€‚</span></span><br /><span class="line"><span class="number">16</span>:         <span class="keyword">if</span> (invokerUrls.isEmpty() &amp;&amp; <span class="keyword">this</span>.cachedInvokerUrls != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">17</span>:             invokerUrls.addAll(<span class="keyword">this</span>.cachedInvokerUrls);</span><br /><span class="line"><span class="number">18</span>:         <span class="comment">// ä¼ å…¥çš„ invokerUrls éç©ºï¼Œæ›´æ–° cachedInvokerUrls ã€‚</span></span><br /><span class="line"><span class="number">19</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">20</span>:             <span class="keyword">this</span>.cachedInvokerUrls = <span class="keyword">new</span> HashSet&lt;URL&gt;();</span><br /><span class="line"><span class="number">21</span>:             <span class="keyword">this</span>.cachedInvokerUrls.addAll(invokerUrls); <span class="comment">//Cached invoker urls, convenient for comparison //ç¼“å­˜invokerUrlsåˆ—è¡¨ï¼Œä¾¿äºäº¤å‰å¯¹æ¯”</span></span><br /><span class="line"><span class="number">22</span>:         }</span><br /><span class="line"><span class="number">23</span>:         <span class="comment">// å¿½ç•¥ï¼Œè‹¥æ—  invokerUrls</span></span><br /><span class="line"><span class="number">24</span>:         <span class="keyword">if</span> (invokerUrls.isEmpty()) {</span><br /><span class="line"><span class="number">25</span>:             <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">26</span>:         }</span><br /><span class="line"><span class="number">27</span>:         <span class="comment">// å°†ä¼ å…¥çš„ invokerUrls ï¼Œè½¬æˆæ–°çš„ urlInvokerMap</span></span><br /><span class="line"><span class="number">28</span>:         Map&lt;String, Invoker&lt;T&gt;&gt; newUrlInvokerMap = toInvokers(invokerUrls);<span class="comment">// Translate url list to Invoker map</span></span><br /><span class="line"><span class="number">29</span>:         <span class="comment">// è½¬æ¢å‡ºæ–°çš„ methodInvokerMap</span></span><br /><span class="line"><span class="number">30</span>:         Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; newMethodInvokerMap = toMethodInvokers(newUrlInvokerMap); <span class="comment">// Change method name to map Invoker Map</span></span><br /><span class="line"><span class="number">31</span>:         <span class="comment">// state change</span></span><br /><span class="line"><span class="number">32</span>:         <span class="comment">// If the calculation is wrong, it is not processed. å¦‚æœè®¡ç®—é”™è¯¯ï¼Œåˆ™ä¸è¿›è¡Œå¤„ç†.</span></span><br /><span class="line"><span class="number">33</span>:         <span class="keyword">if</span> (newUrlInvokerMap == <span class="keyword">null</span> || newUrlInvokerMap.size() == <span class="number">0</span>) {</span><br /><span class="line"><span class="number">34</span>:             logger.error(<span class="keyword">new</span> IllegalStateException(<span class="string">"urls to invokers error .invokerUrls.size :"</span> + invokerUrls.size() + <span class="string">", invoker.size :0. urls :"</span> + invokerUrls.toString()));</span><br /><span class="line"><span class="number">35</span>:             <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">36</span>:         }</span><br /><span class="line"><span class="number">37</span>:         <span class="comment">// è‹¥æœåŠ¡å¼•ç”¨å¤š group ï¼Œåˆ™æŒ‰ç…§ method + group èšåˆ Invoker é›†åˆ</span></span><br /><span class="line"><span class="number">38</span>:         <span class="keyword">this</span>.methodInvokerMap = multiGroup ? toMergeMethodInvokerMap(newMethodInvokerMap) : newMethodInvokerMap;</span><br /><span class="line"><span class="number">39</span>:         <span class="keyword">this</span>.urlInvokerMap = newUrlInvokerMap;</span><br /><span class="line"><span class="number">40</span>:         <span class="comment">// é”€æ¯ä¸å†ä½¿ç”¨çš„ Invoker é›†åˆ</span></span><br /><span class="line"><span class="number">41</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">42</span>:             destroyUnusedInvokers(oldUrlInvokerMap, newUrlInvokerMap); <span class="comment">// Close the unused Invoker</span></span><br /><span class="line"><span class="number">43</span>:         } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line"><span class="number">44</span>:             logger.warn(<span class="string">"destroyUnusedInvokers error. "</span>, e);</span><br /><span class="line"><span class="number">45</span>:         }</span><br /><span class="line"><span class="number">46</span>:     }</span><br /><span class="line"><span class="number">47</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>========== ç¬¬ä¸€éƒ¨åˆ† ==========</li>
<li>ç¬¬ 2 è‡³ 3 è¡Œï¼šå½“&nbsp;<code>invokerUrls</code>&nbsp;é›†åˆå¤§å°ä¸º&nbsp;<strong>1</strong>&nbsp;ï¼Œå¹¶ä¸”åè®®ä¸º&nbsp;<code>empty://</code>&nbsp;ï¼Œè¯´æ˜æ‰€æœ‰æœåŠ¡æä¾›è€…éƒ½å·²ç»<strong>ä¸‹çº¿</strong>ã€‚è‹¥æ³¨å†Œä¸­å¿ƒä¸º Zookeeper ï¼Œå¯å‚è§&nbsp;<code>ZookeeperRegistry#toUrlsWithEmpty(URL consumer, String path, List&lt;String&gt; providers)</code>&nbsp;æ–¹æ³•ã€‚</li>
<li>ç¬¬ 5 è¡Œï¼šè®¾ç½®<strong>ç¦æ­¢</strong>è®¿é—®ï¼Œå› ä¸ºæ²¡æœ‰æœåŠ¡æä¾›è€…äº†ã€‚</li>
<li>ç¬¬ 7 è¡Œï¼š<code>methodInvokerMap</code>&nbsp;ç½®ç©ºã€‚</li>
<li>ç¬¬ 9 è¡Œï¼šè°ƒç”¨&nbsp;<code>#destroyAllInvokers()</code>&nbsp;æ–¹æ³•ï¼Œé”€æ¯æ‰€æœ‰æœåŠ¡æä¾›è€… Invoker é›†åˆã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory/">ã€Œ4.3.3.5 destroyAllInvokersã€</a>&nbsp;ã€‚</li>
<li>========== ç¬¬äºŒéƒ¨åˆ† ==========</li>
<li>ç¬¬ 12 è¡Œï¼šè®¾ç½®<strong>å…è®¸</strong>è®¿é—®ï¼Œå› ä¸ºæœ‰æœåŠ¡æä¾›è€…äº†ã€‚</li>
<li>ç¬¬ 15 è‡³ 17 è¡Œï¼šä¼ å…¥çš„&nbsp;<code>invokerUrls</code>&nbsp;ä¸ºç©ºï¼Œ<strong>è¯´æ˜æ˜¯è·¯ç”±è§„åˆ™æˆ–é…ç½®è§„åˆ™å‘ç”Ÿæ”¹å˜</strong>ï¼Œæ­¤æ—¶&nbsp;<code>invokerUrls</code>&nbsp;æ˜¯ç©ºçš„ï¼Œç›´æ¥ä½¿ç”¨&nbsp;<code>cachedInvokerUrls</code>&nbsp;ã€‚å¯¹åº”å®˜æ–¹æ³¨é‡Šã€ç¬¬ 3 ç‚¹ã€‘ï¼ˆéƒ¨åˆ†ï¼Œä¸åŒ…æ‹¬&ldquo;éœ€è¦é‡æ–°äº¤å‰å¯¹æ¯”ï¼Œå†³å®šæ˜¯å¦éœ€è¦é‡æ–°å¼•ç”¨&rdquo;ï¼‰ã€‚</li>
<li>ç¬¬ 18 è‡³ 22 è¡Œï¼šä¼ å…¥çš„&nbsp;<code>invokerUrls</code>&nbsp;éç©ºï¼Œæ›´æ–°&nbsp;<code>cachedInvokerUrls</code>&nbsp;ã€‚è€ƒè™‘åˆ°å¹¶å‘çš„é—®é¢˜ï¼Œæ›´æ–°çš„æ–¹å¼ä¸ºåˆ›å»º<strong>æ–°çš„</strong>&nbsp;HashSet ã€‚å¯¹åº”å®˜æ–¹æ³¨é‡Šã€ç¬¬ 2 ç‚¹ã€‘ã€‚
<ul>
<li>ä¸ºä»€ä¹ˆã€ç¬¬ 15 è‡³ 17 è¡Œã€‘<strong>ä¸éœ€è¦æ›´æ–°</strong>å‘¢ï¼Ÿå› ä¸º&nbsp;<code>invokerUrls</code>&nbsp;ä¸ºç©ºï¼Œç›´æ¥ä½¿ç”¨&nbsp;<code>cachedInvokerUrls</code>&nbsp;ï¼Œç›¸å½“äºè¿›è¡Œäº†&ldquo;æ›´æ–°&rdquo;ã€‚</li>
</ul>
</li>
<li>ç¬¬ 23 è‡³ 26 è¡Œï¼šå¿½ç•¥ï¼Œè‹¥æ— &nbsp;<code>invokerUrls</code>&nbsp;ã€‚å‡ºç°æƒ…å†µä¸ºï¼Œåˆå§‹æ˜¯æŒ‰ç…§&nbsp;<code>configurators =&gt; routers =&gt; providers</code>&nbsp;ï¼Œæ‰€ä»¥å‰ä¸¤ä¸ªä¼šå‡ºç°è¿™ä¸ªæƒ…å†µã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œèƒ–å‹å¯ä»¥è°ƒè¯•æ„Ÿå—ä¸‹ã€‚</li>
<li>ç¬¬ 28 è¡Œï¼šè°ƒç”¨&nbsp;<code>#toInvokers(List&lt;URL&gt; urls)</code>&nbsp;æ–¹æ³•ï¼Œå°†ä¼ å…¥çš„&nbsp;<code>invokerUrls</code>&nbsp;ï¼Œè½¬æ¢æˆ<strong>æ–°çš„</strong><code>urlInvokerMap</code>&nbsp;ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory/">ã€Œ4.3.3.1 toInvokersã€</a>&nbsp;ã€‚</li>
<li>ç¬¬ 30 è¡Œï¼šè°ƒç”¨&nbsp;<code>#toMethodInvokers(newUrlInvokerMap)</code>&nbsp;æ–¹æ³•ï¼Œå°†&nbsp;<code>urlInvokerMap</code>&nbsp;è½¬æˆä¸æ–¹æ³•çš„æ˜ å°„å…³ç³»ï¼Œå³<strong>æ–°çš„</strong>&nbsp;<code>methodInvokerMap</code>&nbsp;ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory/">ã€Œ4.3.3.2 toMethodInvokersã€</a>&nbsp;ã€‚</li>
<li>ç¬¬ 31 è‡³ 36 è¡Œï¼šå¦‚æœè®¡ç®—é”™è¯¯ï¼Œåˆ™ä¸è¿›è¡Œå¤„ç†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œæ˜¯é˜²å¾¡æ€§ç¼–ç¨‹ã€‚</li>
<li>ç¬¬ 38 è¡Œï¼šè‹¥æœåŠ¡å¼•ç”¨<strong>å¤š</strong>&nbsp;group ï¼Œåˆ™è°ƒç”¨&nbsp;<code>#toMergeMethodInvokerMap(newMethodInvokerMap)</code>&nbsp;æ–¹æ³•ï¼ŒæŒ‰ç…§&nbsp;<strong>method + group</strong>&nbsp;èšåˆ Invoker é›†åˆã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory/">ã€Œ4.3.3.3 toMethodInvokersã€</a>&nbsp;ã€‚</li>
<li>ç¬¬ 39 è¡Œï¼šèµ‹å€¼&nbsp;<code>urlInvokerMap</code>&nbsp;å±æ€§ã€‚</li>
<li>ç¬¬ 40 è‡³ 45 è¡Œï¼šè°ƒç”¨&nbsp;<code>#destroyUnusedInvokers(oldUrlInvokerMap, newUrlInvokerMap)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>é”€æ¯</strong>ä¸å†ä½¿ç”¨çš„ Invoker é›†åˆã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory/">ã€Œ4.3.3.4 toMethodInvokersã€</a>&nbsp;ã€‚</li>
</ul>
<h4 id="4-3-3-1-toInvokers">4.3.3.1 toInvokers</h4>
<p><code>#toInvokers(List&lt;URL&gt; urls)</code>&nbsp;æ–¹æ³•ï¼Œ</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">private</span> Map&lt;String, Invoker&lt;T&gt;&gt; toInvokers(List&lt;URL&gt; urls) {</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// æ–°çš„ `newUrlInvokerMap`</span></span><br /><span class="line"> <span class="number">3</span>:     Map&lt;String, Invoker&lt;T&gt;&gt; newUrlInvokerMap = <span class="keyword">new</span> HashMap&lt;String, Invoker&lt;T&gt;&gt;();</span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// è‹¥ä¸ºç©ºï¼Œç›´æ¥è¿”å›</span></span><br /><span class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (urls == <span class="keyword">null</span> || urls.isEmpty()) {</span><br /><span class="line"> <span class="number">6</span>:         <span class="keyword">return</span> newUrlInvokerMap;</span><br /><span class="line"> <span class="number">7</span>:     }</span><br /><span class="line"> <span class="number">8</span>:     <span class="comment">// å·²åˆå§‹åŒ–çš„æœåŠ¡å™¨æä¾› URL é›†åˆ</span></span><br /><span class="line"> <span class="number">9</span>:     Set&lt;String&gt; keys = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// è·å¾—å¼•ç”¨æœåŠ¡çš„åè®®</span></span><br /><span class="line"><span class="number">11</span>:     String queryProtocols = <span class="keyword">this</span>.queryMap.get(Constants.PROTOCOL_KEY);</span><br /><span class="line"><span class="number">12</span>:     <span class="comment">// å¾ªç¯æœåŠ¡æä¾›è€… URL é›†åˆï¼Œè½¬æˆ Invoker é›†åˆ</span></span><br /><span class="line"><span class="number">13</span>:     <span class="keyword">for</span> (URL providerUrl : urls) {</span><br /><span class="line"><span class="number">14</span>:         <span class="comment">// If protocol is configured at the reference side, only the matching protocol is selected</span></span><br /><span class="line"><span class="number">15</span>:         <span class="comment">// å¦‚æœ reference ç«¯é…ç½®äº† protocol ï¼Œåˆ™åªé€‰æ‹©åŒ¹é…çš„ protocol</span></span><br /><span class="line"><span class="number">16</span>:         <span class="keyword">if</span> (queryProtocols != <span class="keyword">null</span> &amp;&amp; queryProtocols.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">17</span>:             <span class="keyword">boolean</span> accept = <span class="keyword">false</span>;</span><br /><span class="line"><span class="number">18</span>:             String[] acceptProtocols = queryProtocols.split(<span class="string">","</span>); <span class="comment">// å¯é…ç½®å¤šä¸ªåè®®</span></span><br /><span class="line"><span class="number">19</span>:             <span class="keyword">for</span> (String acceptProtocol : acceptProtocols) {</span><br /><span class="line"><span class="number">20</span>:                 <span class="keyword">if</span> (providerUrl.getProtocol().equals(acceptProtocol)) {</span><br /><span class="line"><span class="number">21</span>:                     accept = <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">22</span>:                     <span class="keyword">break</span>;</span><br /><span class="line"><span class="number">23</span>:                 }</span><br /><span class="line"><span class="number">24</span>:             }</span><br /><span class="line"><span class="number">25</span>:             <span class="keyword">if</span> (!accept) {</span><br /><span class="line"><span class="number">26</span>:                 <span class="keyword">continue</span>;</span><br /><span class="line"><span class="number">27</span>:             }</span><br /><span class="line"><span class="number">28</span>:         }</span><br /><span class="line"><span class="number">29</span>:         <span class="comment">// å¿½ç•¥ï¼Œè‹¥ä¸º `empty://` åè®®</span></span><br /><span class="line"><span class="number">30</span>:         <span class="keyword">if</span> (Constants.EMPTY_PROTOCOL.equals(providerUrl.getProtocol())) {</span><br /><span class="line"><span class="number">31</span>:             <span class="keyword">continue</span>;</span><br /><span class="line"><span class="number">32</span>:         }</span><br /><span class="line"><span class="number">33</span>:         <span class="comment">// å¿½ç•¥ï¼Œè‹¥åº”ç”¨ç¨‹åºä¸æ”¯æŒè¯¥åè®®</span></span><br /><span class="line"><span class="number">34</span>:         <span class="keyword">if</span> (!ExtensionLoader.getExtensionLoader(Protocol.class).hasExtension(providerUrl.getProtocol())) {</span><br /><span class="line"><span class="number">35</span>:             logger.error(<span class="keyword">new</span> IllegalStateException(<span class="string">"Unsupported protocol "</span> + providerUrl.getProtocol() + <span class="string">" in notified url: "</span> + providerUrl + <span class="string">" from registry "</span> + getUrl().getAddress() + <span class="string">" to consumer "</span> + NetUtils.getLocalHost()</span><br /><span class="line"><span class="number">36</span>:                     + <span class="string">", supported protocol: "</span> + ExtensionLoader.getExtensionLoader(Protocol.class).getSupportedExtensions()));</span><br /><span class="line"><span class="number">37</span>:             <span class="keyword">continue</span>;</span><br /><span class="line"><span class="number">38</span>:         }</span><br /><span class="line"><span class="number">39</span>:         <span class="comment">// åˆå¹¶ URL å‚æ•°</span></span><br /><span class="line"><span class="number">40</span>:         URL url = mergeUrl(providerUrl);</span><br /><span class="line"><span class="number">41</span>:         <span class="comment">// å¿½ç•¥ï¼Œè‹¥å·²ç»åˆå§‹åŒ–</span></span><br /><span class="line"><span class="number">42</span>:         String key = url.toFullString(); <span class="comment">// The parameter urls are sorted</span></span><br /><span class="line"><span class="number">43</span>:         <span class="keyword">if</span> (keys.contains(key)) { <span class="comment">// Repeated url</span></span><br /><span class="line"><span class="number">44</span>:             <span class="keyword">continue</span>;</span><br /><span class="line"><span class="number">45</span>:         }</span><br /><span class="line"><span class="number">46</span>:         <span class="comment">// æ·»åŠ åˆ° `keys` ä¸­</span></span><br /><span class="line"><span class="number">47</span>:         keys.add(key);</span><br /><span class="line"><span class="number">48</span>:         <span class="comment">// Cache key is url that does not merge with consumer side parameters, regardless of how the consumer combines parameters, if the server url changes, then refer again</span></span><br /><span class="line"><span class="number">49</span>:         <span class="comment">// å¦‚æœæœåŠ¡ç«¯ URL å‘ç”Ÿå˜åŒ–ï¼Œåˆ™é‡æ–° refer å¼•ç”¨</span></span><br /><span class="line"><span class="number">50</span>:         Map&lt;String, Invoker&lt;T&gt;&gt; localUrlInvokerMap = <span class="keyword">this</span>.urlInvokerMap; <span class="comment">// local reference</span></span><br /><span class="line"><span class="number">51</span>:         Invoker&lt;T&gt; invoker = localUrlInvokerMap == <span class="keyword">null</span> ? <span class="keyword">null</span> : localUrlInvokerMap.get(key);</span><br /><span class="line"><span class="number">52</span>:         <span class="keyword">if</span> (invoker == <span class="keyword">null</span>) { <span class="comment">// Not in the cache, refer again æœªåœ¨ç¼“å­˜ä¸­ï¼Œé‡æ–°å¼•ç”¨</span></span><br /><span class="line"><span class="number">53</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">54</span>:                 <span class="comment">// åˆ¤æ–­æ˜¯å¦å¼€å¯</span></span><br /><span class="line"><span class="number">55</span>:                 <span class="keyword">boolean</span> enabled;</span><br /><span class="line"><span class="number">56</span>:                 <span class="keyword">if</span> (url.hasParameter(Constants.DISABLED_KEY)) {</span><br /><span class="line"><span class="number">57</span>:                     enabled = !url.getParameter(Constants.DISABLED_KEY, <span class="keyword">false</span>);</span><br /><span class="line"><span class="number">58</span>:                 } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">59</span>:                     enabled = url.getParameter(Constants.ENABLED_KEY, <span class="keyword">true</span>);</span><br /><span class="line"><span class="number">60</span>:                 }</span><br /><span class="line"><span class="number">61</span>:                 <span class="comment">// è‹¥å¼€å¯ï¼Œåˆ›å»º Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="number">62</span>:                 <span class="keyword">if</span> (enabled) {</span><br /><span class="line"><span class="number">63</span>:                     <span class="comment">// æ³¨æ„ï¼Œå¼•ç”¨æœåŠ¡</span></span><br /><span class="line"><span class="number">64</span>:                     invoker = <span class="keyword">new</span> InvokerDelegate&lt;T&gt;(protocol.refer(serviceType, url), url, providerUrl);</span><br /><span class="line"><span class="number">65</span>:                 }</span><br /><span class="line"><span class="number">66</span>:             } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">67</span>:                 logger.error(<span class="string">"Failed to refer invoker for interface:"</span> + serviceType + <span class="string">",url:("</span> + url + <span class="string">")"</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">68</span>:             }</span><br /><span class="line"><span class="number">69</span>:             <span class="comment">// æ·»åŠ åˆ° newUrlInvokerMap ä¸­</span></span><br /><span class="line"><span class="number">70</span>:             <span class="keyword">if</span> (invoker != <span class="keyword">null</span>) { <span class="comment">// Put new invoker in cache</span></span><br /><span class="line"><span class="number">71</span>:                 newUrlInvokerMap.put(key, invoker);</span><br /><span class="line"><span class="number">72</span>:             }</span><br /><span class="line"><span class="number">73</span>:         } <span class="keyword">else</span> { <span class="comment">// åœ¨ç¼“å­˜ä¸­ï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ Invoker å¯¹è±¡ï¼Œæ·»åŠ åˆ° newUrlInvokerMap ä¸­</span></span><br /><span class="line"><span class="number">74</span>:             newUrlInvokerMap.put(key, invoker);</span><br /><span class="line"><span class="number">75</span>:         }</span><br /><span class="line"><span class="number">76</span>:     }</span><br /><span class="line"><span class="number">77</span>:     <span class="comment">// æ¸…ç©º keys</span></span><br /><span class="line"><span class="number">78</span>:     keys.clear();</span><br /><span class="line"><span class="number">79</span>:     <span class="keyword">return</span> newUrlInvokerMap;</span><br /><span class="line"><span class="number">80</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼š<code>newUrlInvokerMap</code>&nbsp;å˜é‡ï¼Œæ–°çš„&nbsp;<code>urlInvokerMap</code>&nbsp;å­—æ®µï¼Œåé¢ä¼šèµ‹å€¼ç»™å®ƒã€‚</li>
<li>ç¬¬ 4 è‡³ 7 è¡Œï¼šè‹¥&nbsp;<code>urls</code>&nbsp;ä¸ºç©ºï¼Œç›´æ¥è¿”å›ï¼Œé˜²å¾¡æ€§ç¼–ç¨‹ã€‚</li>
<li>ç¬¬ 9 è¡Œï¼š<code>keys</code>&nbsp;å˜é‡ï¼Œ<strong>å·²åˆå§‹åŒ–</strong>çš„æœåŠ¡å™¨æä¾› URL é›†åˆï¼Œå³æœåŠ¡æä¾›è€… URL å·²ç»å¤„ç†ã€‚</li>
<li>ç¬¬ 11 è¡Œï¼šè·å¾—å¼•ç”¨æœåŠ¡çš„åè®®ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ä¼šè®¾ç½®&nbsp;<code>&lt;dubbo:reference protocol=""/&gt;</code>&nbsp;é…ç½®é¡¹ã€‚</li>
<li>ç¬¬ 13 è¡Œï¼š<strong>å¾ªç¯</strong>&nbsp;<code>urls</code>&nbsp;é›†åˆï¼Œè½¬æˆ Invoker é›†åˆã€‚</li>
<li>åè®®å¤„ç†ç›¸å…³
<ul>
<li>ç¬¬ 14 è‡³ 28 è¡Œï¼šå¦‚æœ reference ç«¯é…ç½®äº† protocol ï¼Œåˆ™<strong>åªé€‰æ‹©åŒ¹é…</strong>çš„ protocol ã€‚</li>
<li>ç¬¬ 29 è‡³ 32 è¡Œï¼š<strong>å¿½ç•¥</strong>ï¼Œè‹¥ä¸º&nbsp;<code>empty://</code>&nbsp;åè®®ã€‚</li>
<li>ç¬¬ 33 è‡³ 38 è¡Œï¼š<strong>å¿½ç•¥</strong>ï¼Œè‹¥åº”ç”¨ç¨‹åºä¸æ”¯æŒè¯¥åè®®ã€‚</li>
</ul>
</li>
<li>ç¬¬ 40 è¡Œï¼šè°ƒç”¨&nbsp;<code>#mergeUrl(providerUrl)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>åˆå¹¶</strong>&nbsp;URL å‚æ•°ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory/">ã€Œ4.3.3.1 mergeUrlã€</a>&nbsp;ã€‚</li>
<li>ç¬¬ 41 è‡³ 47 è¡Œï¼š<strong>å¿½ç•¥</strong>ï¼Œé€šè¿‡&nbsp;<code>keys</code>&nbsp;åˆ¤æ–­å·²ç»åˆå§‹åŒ–ã€‚
<ul>
<li>è‹¥æœªåˆå§‹åŒ–ï¼Œæ·»åŠ åˆ°&nbsp;<code>keys</code>&nbsp;ä¸­ã€‚</li>
</ul>
</li>
<li>ç¬¬ 48 è‡³ 75 è¡Œï¼š&ldquo;åˆ›å»º&rdquo;æœåŠ¡ Invoker å¯¹è±¡ã€‚
<ul>
<li>ç¬¬ 50 è‡³ 51 è¡Œï¼šè·å¾—&nbsp;<code>url</code>&nbsp;å¯¹åº”åœ¨&nbsp;<code>localUrlInvokerMap</code>&nbsp;ç¼“å­˜çš„ Invoker å¯¹è±¡ã€‚</li>
<li>ç¬¬ 52 è‡³ 72 è¡Œï¼šä¸åœ¨ç¼“å­˜ä¸­ï¼Œéœ€è¦é‡æ–° refer å¼•ç”¨ï¼Œåˆ›å»º Invoker å¯¹è±¡ã€‚
<ul>
<li>ç¬¬ 54 è‡³ 60 è¡Œï¼šé€šè¿‡é…ç½®é¡¹&nbsp;<code>enable</code>&nbsp;å’Œ&nbsp;<code>disable</code>&nbsp;åˆ¤æ–­ï¼ŒæœåŠ¡æ˜¯å¦å¼€å¯ã€‚</li>
<li>ç¬¬ 61 è‡³ 65 è¡Œï¼š è‹¥å¼€å¯ï¼Œåˆ›å»º Invoker å¯¹è±¡ã€‚
<ul>
<li>ã€é‡è¦ã€‘<strong>ç¬¬ 64 è¡Œï¼šè°ƒç”¨&nbsp;<code>Protocol$Adaptive#refer(serviceType, url)</code>&nbsp;æ–¹æ³•ï¼Œå¼•ç”¨æœåŠ¡ï¼Œåˆ›å»ºæœåŠ¡æä¾›è€… Invoker å¯¹è±¡</strong>ã€‚è¯¦ç»†è§£æï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory/">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; æœåŠ¡å¼•ç”¨ã€‹</a>&nbsp;å·²ç»æœ‰äº†ã€‚</li>
<li>ç¬¬ 64 è¡Œï¼šåˆ›å»º InvokerDelegate å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory/">ã€Œ4.7.1 InvokerDelegateã€</a>&nbsp;ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 73 è‡³ 75 è¡Œï¼šåœ¨ç¼“å­˜ä¸­ï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ Invoker å¯¹è±¡ï¼Œæ·»åŠ åˆ°&nbsp;<code>newUrlInvokerMap</code>&nbsp;ä¸­ã€‚</li>
</ul>
</li>
<li>ç¬¬ 78 è¡Œï¼šæ¸…ç©º&nbsp;<code>keys</code>&nbsp;ã€‚</li>
<li>ç¬¬ 79 è¡Œï¼šè¿”å›ç»“æœ&nbsp;<code>newUrlInvokerMap</code>&nbsp;ã€‚</li>
</ul>
<h5 id="4-3-3-1-1-mergeUrl">4.3.3.1.1 mergeUrl</h5>
<p><code>#mergeUrl(providerUrl)</code>&nbsp;æ–¹æ³•ï¼Œåˆå¹¶ URL å‚æ•°ï¼Œ<strong>ä¼˜å…ˆçº§</strong>ä¸ºé…ç½®è§„åˆ™ &gt; æœåŠ¡æ¶ˆè´¹è€…é…ç½® &gt; æœåŠ¡æä¾›è€…é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> URL <span class="title">mergeUrl</span><span class="params">(URL providerUrl)</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// åˆå¹¶æ¶ˆè´¹ç«¯å‚æ•°</span></span><br /><span class="line"> <span class="number">3</span>:     providerUrl = ClusterUtils.mergeUrl(providerUrl, queryMap); <span class="comment">// Merge the consumer side parameters</span></span><br /><span class="line"> <span class="number">4</span>: </span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// åˆå¹¶é…ç½®è§„åˆ™</span></span><br /><span class="line"> <span class="number">6</span>:     List&lt;Configurator&gt; localConfigurators = <span class="keyword">this</span>.configurators; <span class="comment">// local reference</span></span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (localConfigurators != <span class="keyword">null</span> &amp;&amp; !localConfigurators.isEmpty()) {</span><br /><span class="line"> <span class="number">8</span>:         <span class="keyword">for</span> (Configurator configurator : localConfigurators) {</span><br /><span class="line"> <span class="number">9</span>:             providerUrl = configurator.configure(providerUrl);</span><br /><span class="line"><span class="number">10</span>:         }</span><br /><span class="line"><span class="number">11</span>:     }</span><br /><span class="line"><span class="number">12</span>: </span><br /><span class="line"><span class="number">13</span>:     <span class="comment">// ä¸æ£€æŸ¥è¿æ¥æ˜¯å¦æˆåŠŸï¼Œæ€»æ˜¯åˆ›å»º Invoker ï¼</span></span><br /><span class="line"><span class="number">14</span>:     providerUrl = providerUrl.addParameter(Constants.CHECK_KEY, String.valueOf(<span class="keyword">false</span>)); <span class="comment">// Do not check whether the connection is successful or not, always create Invoker!</span></span><br /><span class="line"><span class="number">15</span>: </span><br /><span class="line"><span class="number">16</span>:     <span class="comment">// The combination of directoryUrl and override is at the end of notify, which can't be handled here</span></span><br /><span class="line"><span class="number">17</span>:     <span class="comment">// ä»…åˆå¹¶æä¾›è€…å‚æ•°ï¼Œå› ä¸º directoryUrl ä¸ override åˆå¹¶æ˜¯åœ¨ notify çš„æœ€åï¼Œè¿™é‡Œä¸èƒ½å¤Ÿå¤„ç†</span></span><br /><span class="line"><span class="number">18</span>:     <span class="keyword">this</span>.overrideDirectoryUrl = <span class="keyword">this</span>.overrideDirectoryUrl.addParametersIfAbsent(providerUrl.getParameters()); <span class="comment">// Merge the provider side parameters // åˆå¹¶æä¾›è€…å‚æ•°</span></span><br /><span class="line"><span class="number">19</span>: </span><br /><span class="line"><span class="number">20</span>:     <span class="comment">// ã€å¿½ç•¥ã€‘å› ä¸ºæ˜¯å¯¹ 1.0 ç‰ˆæœ¬çš„å…¼å®¹</span></span><br /><span class="line"><span class="number">21</span>:     <span class="keyword">if</span> ((providerUrl.getPath() == <span class="keyword">null</span> || providerUrl.getPath().length() == <span class="number">0</span>)</span><br /><span class="line"><span class="number">22</span>:             &amp;&amp; <span class="string">"dubbo"</span>.equals(providerUrl.getProtocol())) { <span class="comment">// Compatible version 1.0</span></span><br /><span class="line"><span class="number">23</span>:         <span class="comment">//fix by tony.chenl DUBBO-44</span></span><br /><span class="line"><span class="number">24</span>:         String path = directoryUrl.getParameter(Constants.INTERFACE_KEY);</span><br /><span class="line"><span class="number">25</span>:         <span class="keyword">if</span> (path != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">26</span>:             <span class="keyword">int</span> i = path.indexOf(<span class="string">'/'</span>);</span><br /><span class="line"><span class="number">27</span>:             <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) {</span><br /><span class="line"><span class="number">28</span>:                 path = path.substring(i + <span class="number">1</span>);</span><br /><span class="line"><span class="number">29</span>:             }</span><br /><span class="line"><span class="number">30</span>:             i = path.lastIndexOf(<span class="string">':'</span>);</span><br /><span class="line"><span class="number">31</span>:             <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) {</span><br /><span class="line"><span class="number">32</span>:                 path = path.substring(<span class="number">0</span>, i);</span><br /><span class="line"><span class="number">33</span>:             }</span><br /><span class="line"><span class="number">34</span>:             providerUrl = providerUrl.setPath(path);</span><br /><span class="line"><span class="number">35</span>:         }</span><br /><span class="line"><span class="number">36</span>:     }</span><br /><span class="line"><span class="number">37</span>: </span><br /><span class="line"><span class="number">38</span>:     <span class="comment">// è¿”å›æœåŠ¡æä¾›è€… URL</span></span><br /><span class="line"><span class="number">39</span>:     <span class="keyword">return</span> providerUrl;</span><br /><span class="line"><span class="number">40</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ã€<strong>é‡è¦</strong>ã€‘ç¬¬ 3 è¡Œï¼šè°ƒç”¨&nbsp;<code>ClusterUtils#mergeUrl(providerUrl, queryMap)</code>&nbsp;æ–¹æ³•ï¼Œåˆå¹¶æœåŠ¡æ¶ˆè´¹è€…é…ç½®åˆ°&nbsp;<code>providerUrl</code>&nbsp;ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory/">ã€Œ6. ClusterUtilsã€</a>&nbsp;ã€‚</li>
<li>ç¬¬ 5 è‡³ 11 è¡Œï¼šåˆå¹¶<strong>é…ç½®è§„åˆ™</strong>åˆ°&nbsp;<code>providerUrl</code>&nbsp;ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-6-impl-configurator/?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆå…­ï¼‰ä¹‹ Configurator å®ç°ã€‹</a></li>
<li>ç¬¬ 14 è¡Œï¼šè®¾ç½®&nbsp;<code>providerUrl</code>&nbsp;ä¸æ£€æŸ¥è¿æ¥æ˜¯å¦æˆåŠŸï¼Œæ€»æ˜¯åˆ›å»º Invoker ï¼</li>
<li>ç¬¬ 18 è¡Œï¼šä»…åˆå¹¶æä¾›è€…å‚æ•°ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-6-impl-configurator/?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆå…­ï¼‰ä¹‹ Configurator å®ç°ã€‹</a></li>
<li>ç¬¬ 20 è‡³ 36 è¡Œï¼šã€<strong>å¿½ç•¥</strong>ã€‘å› ä¸ºæ˜¯å¯¹ 1.0 ç‰ˆæœ¬çš„å…¼å®¹ã€‚</li>
</ul>
<h4 id="4-3-3-2-toMethodInvokers">4.3.3.2 toMethodInvokers</h4>
<p><code>#toMethodInvokers(Map&lt;String, Invoker&lt;T&gt;&gt; invokersMap)</code>&nbsp;æ–¹æ³•ï¼Œå°†&nbsp;<code>invokersMap</code>&nbsp;è½¬æˆ<strong>ä¸æ–¹æ³•</strong>çš„æ˜ å°„å…³ç³»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">private</span> Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; toMethodInvokers(Map&lt;String, Invoker&lt;T&gt;&gt; invokersMap) {</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// åˆ›å»ºæ–°çš„ `methodInvokerMap`</span></span><br /><span class="line"> <span class="number">3</span>:     Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; newMethodInvokerMap = <span class="keyword">new</span> HashMap&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt;();</span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// åˆ›å»º Invoker é›†åˆ</span></span><br /><span class="line"> <span class="number">5</span>:     List&lt;Invoker&lt;T&gt;&gt; invokersList = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;();</span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// According to the methods classification declared by the provider URL, the methods is compatible with the registry to execute the filtered methods</span></span><br /><span class="line"> <span class="number">7</span>:     <span class="comment">// æŒ‰æœåŠ¡æä¾›è€… URL æ‰€å£°æ˜çš„ methods åˆ†ç±»ï¼Œå…¼å®¹æ³¨å†Œä¸­å¿ƒæ‰§è¡Œè·¯ç”±è¿‡æ»¤æ‰çš„ methods</span></span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (invokersMap != <span class="keyword">null</span> &amp;&amp; invokersMap.size() &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">9</span>:         <span class="comment">// å¾ªç¯æ¯ä¸ªæœåŠ¡æä¾›è€… Invoker</span></span><br /><span class="line"><span class="number">10</span>:         <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokersMap.values()) {</span><br /><span class="line"><span class="number">11</span>:             String parameter = invoker.getUrl().getParameter(Constants.METHODS_KEY); <span class="comment">// methods</span></span><br /><span class="line"><span class="number">12</span>:             <span class="keyword">if</span> (parameter != <span class="keyword">null</span> &amp;&amp; parameter.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">13</span>:                 String[] methods = Constants.COMMA_SPLIT_PATTERN.split(parameter);</span><br /><span class="line"><span class="number">14</span>:                 <span class="keyword">if</span> (methods != <span class="keyword">null</span> &amp;&amp; methods.length &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">15</span>:                     <span class="comment">// å¾ªç¯æ¯ä¸ªæ–¹æ³•ï¼ŒæŒ‰ç…§æ–¹æ³•åä¸ºç»´åº¦ï¼Œèšåˆåˆ° `methodInvokerMap` ä¸­</span></span><br /><span class="line"><span class="number">16</span>:                     <span class="keyword">for</span> (String method : methods) {</span><br /><span class="line"><span class="number">17</span>:                         <span class="keyword">if</span> (method != <span class="keyword">null</span> &amp;&amp; method.length() &gt; <span class="number">0</span> &amp;&amp; !Constants.ANY_VALUE.equals(method)) { <span class="comment">// å½“æœåŠ¡æä¾›è€…çš„æ–¹æ³•ä¸º "*" ï¼Œä»£è¡¨æ³›åŒ–è°ƒç”¨</span></span><br /><span class="line"><span class="number">18</span>:                             List&lt;Invoker&lt;T&gt;&gt; methodInvokers = newMethodInvokerMap.get(method);</span><br /><span class="line"><span class="number">19</span>:                             <span class="keyword">if</span> (methodInvokers == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">20</span>:                                 methodInvokers = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;();</span><br /><span class="line"><span class="number">21</span>:                                 newMethodInvokerMap.put(method, methodInvokers);</span><br /><span class="line"><span class="number">22</span>:                             }</span><br /><span class="line"><span class="number">23</span>:                             methodInvokers.add(invoker);</span><br /><span class="line"><span class="number">24</span>:                         }</span><br /><span class="line"><span class="number">25</span>:                     }</span><br /><span class="line"><span class="number">26</span>:                 }</span><br /><span class="line"><span class="number">27</span>:             }</span><br /><span class="line"><span class="number">28</span>:             <span class="comment">// æ·»åŠ åˆ° `invokersList` ä¸­</span></span><br /><span class="line"><span class="number">29</span>:             invokersList.add(invoker);</span><br /><span class="line"><span class="number">30</span>:         }</span><br /><span class="line"><span class="number">31</span>:     }</span><br /><span class="line"><span class="number">32</span>:     <span class="comment">// è·¯ç”±å…¨ `invokersList` ï¼ŒåŒ¹é…åˆé€‚çš„ Invoker é›†åˆã€‚</span></span><br /><span class="line"><span class="number">33</span>:     List&lt;Invoker&lt;T&gt;&gt; newInvokersList = route(invokersList, <span class="keyword">null</span>);</span><br /><span class="line"><span class="number">34</span>:     <span class="comment">// æ·»åŠ  `newInvokersList` åˆ° `newMethodInvokerMap` ä¸­ï¼Œè¡¨ç¤ºè¯¥æœåŠ¡æä¾›è€…çš„å…¨é‡ Invoker é›†åˆ</span></span><br /><span class="line"><span class="number">35</span>:     newMethodInvokerMap.put(Constants.ANY_VALUE, newInvokersList);</span><br /><span class="line"><span class="number">36</span>:     <span class="comment">// å¾ªç¯ï¼ŒåŸºäºæ¯ä¸ªæ–¹æ³•è·¯ç”±ï¼ŒåŒ¹é…åˆé€‚çš„ Invoker é›†åˆ</span></span><br /><span class="line"><span class="number">37</span>:     <span class="keyword">if</span> (serviceMethods != <span class="keyword">null</span> &amp;&amp; serviceMethods.length &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">38</span>:         <span class="keyword">for</span> (String method : serviceMethods) {</span><br /><span class="line"><span class="number">39</span>:             List&lt;Invoker&lt;T&gt;&gt; methodInvokers = newMethodInvokerMap.get(method);</span><br /><span class="line"><span class="number">40</span>:             <span class="keyword">if</span> (methodInvokers == <span class="keyword">null</span> || methodInvokers.isEmpty()) {</span><br /><span class="line"><span class="number">41</span>:                 methodInvokers = newInvokersList;</span><br /><span class="line"><span class="number">42</span>:             }</span><br /><span class="line"><span class="number">43</span>:             newMethodInvokerMap.put(method, route(methodInvokers, method));</span><br /><span class="line"><span class="number">44</span>:         }</span><br /><span class="line"><span class="number">45</span>:     }</span><br /><span class="line"><span class="number">46</span>:     <span class="comment">// å¾ªç¯æ’åºæ¯ä¸ªæ–¹æ³•çš„ Invoker é›†åˆï¼Œå¹¶è®¾ç½®ä¸ºä¸å¯å˜</span></span><br /><span class="line"><span class="number">47</span>:     <span class="comment">// sort and unmodifiable</span></span><br /><span class="line"><span class="number">48</span>:     <span class="keyword">for</span> (String method : <span class="keyword">new</span> HashSet&lt;String&gt;(newMethodInvokerMap.keySet())) {</span><br /><span class="line"><span class="number">49</span>:         List&lt;Invoker&lt;T&gt;&gt; methodInvokers = newMethodInvokerMap.get(method);</span><br /><span class="line"><span class="number">50</span>:         Collections.sort(methodInvokers, InvokerComparator.getComparator());</span><br /><span class="line"><span class="number">51</span>:         newMethodInvokerMap.put(method, Collections.unmodifiableList(methodInvokers));</span><br /><span class="line"><span class="number">52</span>:     }</span><br /><span class="line"><span class="number">53</span>:     <span class="keyword">return</span> Collections.unmodifiableMap(newMethodInvokerMap);</span><br /><span class="line"><span class="number">54</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼š<code>newMethodInvokerMap</code>&nbsp;å˜é‡ï¼Œæ–°çš„&nbsp;<code>methodInvokerMap</code>&nbsp;å­—æ®µï¼Œåé¢ä¼šèµ‹å€¼ç»™å®ƒã€‚</li>
<li>ç¬¬ 5 è¡Œï¼šåˆ›å»º Invoker é›†åˆã€‚åœ¨ã€ç¬¬ 29 è¡Œã€‘ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå®é™…å°±æ˜¯&nbsp;<code>invokersMap</code>&nbsp;çš„å€¼çš„é›†åˆã€‚</li>
<li>ç¬¬ 8 è‡³ 31 è¡Œï¼šæŒ‰ç…§æ–¹æ³•åä¸º<strong>ç»´åº¦</strong>( KEY ) ï¼Œèšåˆ<strong>å¯¹åº”çš„ Invoker é›†åˆ</strong>åˆ°&nbsp;<code>newMethodInvokerMap</code>&nbsp;ä¸­ã€‚</li>
<li>ç¬¬ 33 è¡Œï¼šè·¯ç”±å…¨&nbsp;<code>invokersList</code>&nbsp;ï¼ŒåŒ¹é…åˆé€‚çš„ Invoker é›†åˆã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-7-impl-router/?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆä¸ƒï¼‰ä¹‹ Router å®ç°ã€‹</a>&nbsp;ã€‚</li>
<li>ç¬¬ 35 è¡Œï¼šæ·»åŠ &nbsp;<code>newInvokersList</code>&nbsp;åˆ°&nbsp;<code>newMethodInvokerMap</code>&nbsp;ä¸­ï¼Œè¡¨ç¤ºè¯¥æœåŠ¡æä¾›è€…çš„<strong>å…¨é‡</strong>&nbsp;Invoker é›†åˆã€‚</li>
<li>ç¬¬ 36 è‡³ 45 è¡Œï¼š<strong>å¾ªç¯</strong>ï¼ŒåŸºäºæ¯ä¸ªæ–¹æ³•è·¯ç”±ï¼ŒåŒ¹é…åˆé€‚çš„ Invoker é›†åˆã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-7-impl-router/?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆä¸ƒï¼‰ä¹‹ Router å®ç°ã€‹</a>&nbsp;ã€‚</li>
<li>ç¬¬ 46 è‡³ 53 è¡Œï¼šå¾ªç¯<strong>æ’åº</strong>æ¯ä¸ªæ–¹æ³•çš„ Invoker é›†åˆï¼Œå¹¶è®¾ç½®ä¸º<strong>ä¸å¯å˜</strong>ã€‚</li>
</ul>
<h4 id="4-3-3-3-toMergeMethodInvokerMap">4.3.3.3 toMergeMethodInvokerMap</h4>
<p><code>#toMergeMethodInvokerMap(Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; methodMap)</code>&nbsp;ï¼ŒæŒ‰ç…§&nbsp;<strong>method + group</strong>èšåˆ Invoker é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">private</span> Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; toMergeMethodInvokerMap(Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; methodMap) {</span><br /><span class="line"> <span class="number">2</span>:     Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; result = <span class="keyword">new</span> HashMap&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt;();</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// å¾ªç¯æ–¹æ³•ï¼ŒæŒ‰ç…§ method + group èšåˆ Invoker é›†åˆ</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">for</span> (Map.Entry&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; entry : methodMap.entrySet()) {</span><br /><span class="line"> <span class="number">5</span>:         String method = entry.getKey();</span><br /><span class="line"> <span class="number">6</span>:         List&lt;Invoker&lt;T&gt;&gt; invokers = entry.getValue();</span><br /><span class="line"> <span class="number">7</span>:         <span class="comment">// æŒ‰ç…§ Group èšåˆ Invoker é›†åˆçš„ç»“æœã€‚å…¶ä¸­ï¼ŒKEYï¼šgroup VALUEï¼šInvoker é›†åˆã€‚</span></span><br /><span class="line"> <span class="number">8</span>:         Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; groupMap = <span class="keyword">new</span> HashMap&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt;();</span><br /><span class="line"> <span class="number">9</span>:         <span class="comment">// å¾ªç¯ Invoker é›†åˆï¼ŒæŒ‰ç…§ group èšåˆ Invoker é›†åˆ</span></span><br /><span class="line"><span class="number">10</span>:         <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokers) {</span><br /><span class="line"><span class="number">11</span>:             String group = invoker.getUrl().getParameter(Constants.GROUP_KEY, <span class="string">""</span>);</span><br /><span class="line"><span class="number">12</span>:             List&lt;Invoker&lt;T&gt;&gt; groupInvokers = groupMap.get(group);</span><br /><span class="line"><span class="number">13</span>:             <span class="keyword">if</span> (groupInvokers == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">14</span>:                 groupInvokers = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;();</span><br /><span class="line"><span class="number">15</span>:                 groupMap.put(group, groupInvokers);</span><br /><span class="line"><span class="number">16</span>:             }</span><br /><span class="line"><span class="number">17</span>:             groupInvokers.add(invoker);</span><br /><span class="line"><span class="number">18</span>:         }</span><br /><span class="line"><span class="number">19</span>:         <span class="comment">// å¤§å°ä¸º 1ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ª</span></span><br /><span class="line"><span class="number">20</span>:         <span class="keyword">if</span> (groupMap.size() == <span class="number">1</span>) {</span><br /><span class="line"><span class="number">21</span>:             result.put(method, groupMap.values().iterator().next());</span><br /><span class="line"><span class="number">22</span>:         <span class="comment">// å¤§äº 1ï¼Œå°†æ¯ä¸ª Group çš„ Invoker é›†åˆï¼Œåˆ›å»ºæˆ Cluster Invoker å¯¹è±¡ã€‚</span></span><br /><span class="line"><span class="number">23</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (groupMap.size() &gt; <span class="number">1</span>) {</span><br /><span class="line"><span class="number">24</span>:             List&lt;Invoker&lt;T&gt;&gt; groupInvokers = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;();</span><br /><span class="line"><span class="number">25</span>:             <span class="keyword">for</span> (List&lt;Invoker&lt;T&gt;&gt; groupList : groupMap.values()) {</span><br /><span class="line"><span class="number">26</span>:                 groupInvokers.add(cluster.join(<span class="keyword">new</span> StaticDirectory&lt;T&gt;(groupList)));</span><br /><span class="line"><span class="number">27</span>:             }</span><br /><span class="line"><span class="number">28</span>:             result.put(method, groupInvokers);</span><br /><span class="line"><span class="number">29</span>:         <span class="comment">// å¤§å°ä¸º 0 ï¼Œä½¿ç”¨åŸæœ‰å€¼</span></span><br /><span class="line"><span class="number">30</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">31</span>:             result.put(method, invokers);</span><br /><span class="line"><span class="number">32</span>:         }</span><br /><span class="line"><span class="number">33</span>:     }</span><br /><span class="line"><span class="number">34</span>:     <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">35</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 2 è¡Œï¼š<code>result</code>&nbsp;å±æ€§ï¼Œ<strong>æ–°çš„</strong>&nbsp;<code>methodInvokerMap</code>&nbsp;å­—æ®µï¼Œåé¢ä¼šèµ‹å€¼ç»™å®ƒã€‚</li>
<li>ç¬¬ 3 ç»ˆ 33 è¡Œï¼š<strong>å¾ªç¯</strong>ï¼ŒæŒ‰ç…§&nbsp;<strong>method + group</strong>&nbsp;èšåˆ Invoker é›†åˆã€‚
<ul>
<li>ç¬¬ 8 è¡Œï¼š æŒ‰ç…§ Group èšåˆ Invoker é›†åˆçš„ç»“æœã€‚å…¶ä¸­ï¼Œ<strong>KEY</strong>ï¼šgroup ï¼Œ<strong>VALUE</strong>ï¼šInvoker é›†åˆã€‚</li>
<li>ç¬¬ 9 è‡³ 18 è¡Œï¼š<strong>å¾ªç¯</strong>&nbsp;Invoker é›†åˆï¼ŒæŒ‰ç…§&nbsp;<strong>group</strong>&nbsp;èšåˆ Invoker é›†åˆã€‚</li>
<li>========== ç»“æœ&nbsp;<code>groupMap</code>&nbsp;å¤„ç† ==========</li>
<li>ç¬¬ 19 è‡³ 21 è¡Œï¼šè‹¥æ•°é‡ä¸º 1 ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªã€‚</li>
<li>ç¬¬ 29 è‡³ 32 è¡Œï¼šè‹¥æ•°é‡ä¸º 0 ï¼Œä½¿ç”¨åŸæœ‰å€¼&nbsp;<code>invokers</code>&nbsp;ã€‚å®é™…ä¸Šï¼Œå’Œã€ç¬¬ 19 è‡³ 21 è¡Œã€‘<strong>ç­‰ä»·</strong>ã€‚</li>
<li>ç¬¬ 22 è‡³ 28 è¡Œï¼šè‹¥æ•°é‡<strong>å¤§äº</strong>&nbsp;1 ï¼Œå¾ªç¯<strong>æ¯ä¸ª</strong>&nbsp;Group çš„ Invoker é›†åˆï¼Œè°ƒç”¨&nbsp;<code>Cluster$Adaptive#join(Directory)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºå¯¹åº”çš„ Cluster Invoker å¯¹è±¡ã€‚
<ul>
<li>æˆ‘ä»¬å‘ç°ï¼Œæ­¤å¤„åˆ›å»º&nbsp;<strong>StaticDirectory</strong>&nbsp;å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory/">ã€Œ5. StaticDirectoryã€</a>&nbsp;ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>é‚£ä¹ˆï¼Œå¼•ç”¨å¤šä¸ªæœåŠ¡åˆ†ç»„æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿä¸ºä»€ä¹ˆè¦æŒ‰ç…§&nbsp;<strong>group</strong>&nbsp;è¿›è¡Œèšåˆï¼Œç›´æ¥è°ƒç”¨ä¸å¯ä»¥ä¹ˆï¼Ÿè®©æˆ‘ä»¬æ¥æ‰“å¼€&nbsp;<code>ProtocolRegistry#refer(Class&lt;T&gt; type, URL url)</code>&nbsp;æ–¹æ³•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_04_10/04.png" alt="refer" /></p>
<ul>
<li>å½“å¼•ç”¨å¤šä¸ªæœåŠ¡åˆ†ç»„æ—¶ï¼Œä¼š<strong>è‡ªåŠ¨</strong>ä½¿ç”¨åˆ°<strong>åˆ†ç»„èšåˆ</strong>çš„ç‰¹æ€§ã€‚é‚£ä¹ˆä¹‹å MergeableCluster ä¼šæ€ä¹ˆåšå‘¢ï¼Ÿè¯¦ç»†è§£æï¼Œè§åæ–‡ ğŸ˜ˆã€‚</li>
</ul>
<h4 id="4-3-3-4-destroyUnusedInvokers">4.3.3.4 destroyUnusedInvokers</h4>
<p><code>#destroyUnusedInvokers(oldUrlInvokerMap, newUrlInvokerMap)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>é”€æ¯</strong>ä¸å†ä½¿ç”¨çš„ Invoker é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">destroyUnusedInvokers</span><span class="params">(Map&lt;String, Invoker&lt;T&gt;&gt; oldUrlInvokerMap, Map&lt;String, Invoker&lt;T&gt;&gt; newUrlInvokerMap)</span> </span>{</span><br /><span class="line">    <span class="comment">// é˜²å¾¡æ€§ç¼–ç¨‹ï¼Œç›®å‰ä¸å­˜åœ¨è¿™ä¸ªæƒ…å†µ</span></span><br /><span class="line">    <span class="keyword">if</span> (newUrlInvokerMap == <span class="keyword">null</span> || newUrlInvokerMap.size() == <span class="number">0</span>) {</span><br /><span class="line">        <span class="comment">// é”€æ¯æ‰€æœ‰æœåŠ¡æä¾›è€… Invoker</span></span><br /><span class="line">        destroyAllInvokers();</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// check deleted invoker</span></span><br /><span class="line">    <span class="comment">// å¯¹æ¯”æ–°è€é›†åˆï¼Œè®¡ç®—éœ€è¦é”€æ¯çš„ Invoker é›†åˆ</span></span><br /><span class="line">    List&lt;String&gt; deleted = <span class="keyword">null</span>;</span><br /><span class="line">    <span class="keyword">if</span> (oldUrlInvokerMap != <span class="keyword">null</span>) {</span><br /><span class="line">        Collection&lt;Invoker&lt;T&gt;&gt; newInvokers = newUrlInvokerMap.values();</span><br /><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Invoker&lt;T&gt;&gt; entry : oldUrlInvokerMap.entrySet()) {</span><br /><span class="line">            <span class="comment">// è‹¥ä¸å­˜åœ¨ï¼Œæ·»åŠ åˆ° `deleted` ä¸­</span></span><br /><span class="line">            <span class="keyword">if</span> (!newInvokers.contains(entry.getValue())) {</span><br /><span class="line">                <span class="keyword">if</span> (deleted == <span class="keyword">null</span>) {</span><br /><span class="line">                    deleted = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br /><span class="line">                }</span><br /><span class="line">                deleted.add(entry.getKey());</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">// è‹¥æœ‰éœ€è¦é”€æ¯çš„ Invoker ï¼Œåˆ™è¿›è¡Œé”€æ¯</span></span><br /><span class="line">    <span class="keyword">if</span> (deleted != <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">for</span> (String url : deleted) {</span><br /><span class="line">            <span class="keyword">if</span> (url != <span class="keyword">null</span>) {</span><br /><span class="line">                <span class="comment">// ç§»é™¤å‡º `urlInvokerMap`</span></span><br /><span class="line">                Invoker&lt;T&gt; invoker = oldUrlInvokerMap.remove(url);</span><br /><span class="line">                <span class="keyword">if</span> (invoker != <span class="keyword">null</span>) {</span><br /><span class="line">                    <span class="keyword">try</span> {</span><br /><span class="line">                        <span class="comment">// é”€æ¯ Invoker</span></span><br /><span class="line">                        invoker.destroy();</span><br /><span class="line">                        <span class="keyword">if</span> (logger.isDebugEnabled()) {</span><br /><span class="line">                            logger.debug(<span class="string">"destroy invoker["</span> + invoker.getUrl() + <span class="string">"] success. "</span>);</span><br /><span class="line">                        }</span><br /><span class="line">                    } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line">                        logger.warn(<span class="string">"destroy invoker["</span> + invoker.getUrl() + <span class="string">"] failed. "</span> + e.getMessage(), e);</span><br /><span class="line">                    }</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h4 id="4-3-3-5-destroyAllInvokers">4.3.3.5 destroyAllInvokers</h4>
<p><code>#destroyAllInvokers()</code>&nbsp;æ–¹æ³•ï¼Œé”€æ¯æ‰€æœ‰æœåŠ¡æä¾›è€… Invoker ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">destroyAllInvokers</span><span class="params">()</span> </span>{</span><br /><span class="line">    Map&lt;String, Invoker&lt;T&gt;&gt; localUrlInvokerMap = <span class="keyword">this</span>.urlInvokerMap; <span class="comment">// local reference æœ¬åœ°å¼•ç”¨ï¼Œé¿å…å¹¶å‘é—®é¢˜</span></span><br /><span class="line">    <span class="keyword">if</span> (localUrlInvokerMap != <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="comment">// å¾ªç¯ urlInvokerMap ï¼Œé”€æ¯æ‰€æœ‰æœåŠ¡æä¾›è€… Invoker</span></span><br /><span class="line">        <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;(localUrlInvokerMap.values())) {</span><br /><span class="line">            <span class="keyword">try</span> {</span><br /><span class="line">                invoker.destroy();</span><br /><span class="line">            } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">                logger.warn(<span class="string">"Failed to destroy service "</span> + serviceKey + <span class="string">" to provider "</span> + invoker.getUrl(), t);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// urlInvokerMap æ¸…ç©º</span></span><br /><span class="line">        localUrlInvokerMap.clear();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// methodInvokerMap ç½®ç©º</span></span><br /><span class="line">    methodInvokerMap = <span class="keyword">null</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="4-4-doList">4.4 doList</h2>
<p><code>#doList(Invocation)</code>&nbsp;<strong>å®ç°</strong>æ–¹æ³•ï¼Œè·å¾—å¯¹åº”çš„ Invoker é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">public</span> List&lt;Invoker&lt;T&gt;&gt; doList(Invocation invocation) {</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (forbidden) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="comment">// 1. No service provider 2. Service providers are disabled</span></span><br /><span class="line"> <span class="number">5</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(RpcException.FORBIDDEN_EXCEPTION,</span><br /><span class="line"> <span class="number">6</span>:             <span class="string">"No provider available from registry "</span> + getUrl().getAddress() + <span class="string">" for service "</span> + getConsumerUrl().getServiceKey() + <span class="string">" on consumer "</span> +  NetUtils.getLocalHost()</span><br /><span class="line"> <span class="number">7</span>:                     + <span class="string">" use dubbo version "</span> + Version.getVersion() + <span class="string">", please check status of providers(disabled, not registered or in blacklist)."</span>);</span><br /><span class="line"> <span class="number">8</span>:     }</span><br /><span class="line"> <span class="number">9</span>:     List&lt;Invoker&lt;T&gt;&gt; invokers = <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">10</span>:     Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; localMethodInvokerMap = <span class="keyword">this</span>.methodInvokerMap; <span class="comment">// local reference</span></span><br /><span class="line"><span class="number">11</span>:     <span class="comment">// è·å¾— Invoker é›†åˆ</span></span><br /><span class="line"><span class="number">12</span>:     <span class="keyword">if</span> (localMethodInvokerMap != <span class="keyword">null</span> &amp;&amp; localMethodInvokerMap.size() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">13</span>:         <span class="comment">// è·å¾—æ–¹æ³•åã€æ–¹æ³•å‚æ•°</span></span><br /><span class="line"><span class="number">14</span>:         String methodName = RpcUtils.getMethodName(invocation);</span><br /><span class="line"><span class="number">15</span>:         Object[] args = RpcUtils.getArguments(invocation);</span><br /><span class="line"><span class="number">16</span>:         <span class="comment">// ã€ç¬¬ä¸€ã€‘å¯æ ¹æ®ç¬¬ä¸€ä¸ªå‚æ•°æšä¸¾è·¯ç”±</span></span><br /><span class="line"><span class="number">17</span>:         <span class="keyword">if</span> (args != <span class="keyword">null</span> &amp;&amp; args.length &gt; <span class="number">0</span> &amp;&amp; args[<span class="number">0</span>] != <span class="keyword">null</span></span><br /><span class="line"><span class="number">18</span>:                 &amp;&amp; (args[<span class="number">0</span>] <span class="keyword">instanceof</span> String || args[<span class="number">0</span>].getClass().isEnum())) {</span><br /><span class="line"><span class="number">19</span>: <span class="comment">//            invokers = localMethodInvokerMap.get(methodName + "." + args[0]); // The routing can be enumerated according to the first parameter</span></span><br /><span class="line"><span class="number">20</span>:             invokers = localMethodInvokerMap.get(methodName + args[<span class="number">0</span>]); <span class="comment">// The routing can be enumerated according to the first parameter</span></span><br /><span class="line"><span class="number">21</span>:         }</span><br /><span class="line"><span class="number">22</span>:         <span class="comment">// ã€ç¬¬äºŒã€‘æ ¹æ®æ–¹æ³•åè·å¾— Invoker é›†åˆ</span></span><br /><span class="line"><span class="number">23</span>:         <span class="keyword">if</span> (invokers == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">24</span>:             invokers = localMethodInvokerMap.get(methodName);</span><br /><span class="line"><span class="number">25</span>:         }</span><br /><span class="line"><span class="number">26</span>:         <span class="comment">// ã€ç¬¬ä¸‰ã€‘ä½¿ç”¨å…¨é‡ Invoker é›†åˆã€‚ä¾‹å¦‚ï¼Œ`#$echo(name)` ï¼Œå›å£°æ–¹æ³•</span></span><br /><span class="line"><span class="number">27</span>:         <span class="keyword">if</span> (invokers == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">28</span>:             invokers = localMethodInvokerMap.get(Constants.ANY_VALUE);</span><br /><span class="line"><span class="number">29</span>:         }</span><br /><span class="line"><span class="number">30</span>:         <span class="comment">// ã€ç¬¬å››ã€‘ä½¿ç”¨ `methodInvokerMap` ç¬¬ä¸€ä¸ª Invoker é›†åˆã€‚é˜²å¾¡æ€§ç¼–ç¨‹ã€‚</span></span><br /><span class="line"><span class="number">31</span>:         <span class="keyword">if</span> (invokers == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">32</span>:             Iterator&lt;List&lt;Invoker&lt;T&gt;&gt;&gt; iterator = localMethodInvokerMap.values().iterator();</span><br /><span class="line"><span class="number">33</span>:             <span class="keyword">if</span> (iterator.hasNext()) {</span><br /><span class="line"><span class="number">34</span>:                 invokers = iterator.next();</span><br /><span class="line"><span class="number">35</span>:             }</span><br /><span class="line"><span class="number">36</span>:         }</span><br /><span class="line"><span class="number">37</span>:     }</span><br /><span class="line"><span class="number">38</span>:     <span class="keyword">return</span> invokers == <span class="keyword">null</span> ? <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;(<span class="number">0</span>) : invokers;</span><br /><span class="line"><span class="number">39</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>é€šè¿‡å››ç§æ–¹å¼ï¼Œä»&nbsp;<code>methodInvokerMap</code>&nbsp;ä¸­ï¼Œè·å¾—å¯¹åº”çš„ Invoker é›†åˆã€‚</li>
<li>
<p>ç¬¬ä¸€ç§ï¼Œå¯æ ¹æ®<strong>ç¬¬ä¸€ä¸ªå‚æ•°</strong>æšä¸¾è·¯ç”±ã€‚è¿™æ˜¯ä¸ªéå¸¸å°ä¼—çš„åœºæ™¯ï¼Œèƒ–å‹ä¸å¿…ç†è§£ã€‚ä¾‹å­å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DemoService æ¥å£å®šä¹‰</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DemoService</span> </span>{</span><br /><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">hello</span><span class="params">(String name)</span></span>;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">hello01</span><span class="params">(String name)</span></span>;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">hello02</span><span class="params">(String name)</span></span>;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">// æ¶ˆè´¹è€…è°ƒç”¨</span></span><br /><span class="line">DemoService demoService = (DemoService) context.getBean(<span class="string">"demoService"</span>);</span><br /><span class="line">demoService.hello(<span class="string">"01"</span>);</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œè°ƒç”¨åˆ°çš„æœåŠ¡æä¾›è€…çš„&nbsp;<code>DemoServiceImpl#hello01(name)</code>&nbsp;æ–¹æ³•ã€‚</li>
<li>å¦‚æœä½¿ç”¨è¯¥<strong>ç‰¹æ€§</strong>ï¼Œæ³¨æ„é¿å…å‡ºç°<strong>æ— å…³</strong>çš„å‡ ä¸ªæ–¹æ³•ï¼Œä¾‹å¦‚&nbsp;<code>#hello(name)</code>&nbsp;å’Œ&nbsp;<code>#hello01(name)</code>&nbsp;æ˜¯æ¯«æ— å…³ç³»çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œè€Œæˆ‘çœŸçš„æƒ³è°ƒç”¨&nbsp;<code>#hello(name)</code>&nbsp;æ–¹æ³•ï¼Œç»“æœè°ƒç”¨åˆ°äº†&nbsp;<code>#hello01(name)</code>&nbsp;æ–¹æ³•ã€‚</li>
<li>
<p>å¦‚ä¸‹æ˜¯ Dubbo Commiter&nbsp;<strong>è¯£æ</strong>&nbsp;çš„è§£æƒ‘ï¼Œéå¸¸æ„Ÿè°¢ã€‚</p>
<blockquote>
<p>åŠ¨æ€çš„æ–¹æ³•åæœ¬èº«å°±æ˜¯æ¥å£ä¸­å·²ç»å®šä¹‰çš„</p>
<p>ä¸¾ä¸ªä¾‹å­å§å€Ÿå£å®šä¹‰äº† method, method1,method2ï¼Œ å¦‚æœæˆ‘å‘èµ·rpcè°ƒç”¨method(1, 2, 3), è¿™ä¸ªæ—¶å€™ä¼šå»æŸ¥æ‰¾æ–¹æ³•method1çš„invokersï¼Œ å¦‚æœæˆ‘è¿™ä¸ªæ—¶å€™å‘èµ·rpc method(2, 1, 3), è¿™ä¸ªæ—¶å€™ä¼šå»æŸ¥æ‰¾æ–¹æ³•method2çš„invokersï¼Œ ç„¶åè°ƒç”¨invokersçš„methodæ–¹æ³•</p>
</blockquote>
<ul>
<li>å¦å¤–ï¼Œç»è¿‡æ²Ÿé€šï¼Œã€ç¬¬ 19 è¡Œã€‘çš„&nbsp;<code>"."</code>&nbsp;æ˜¯ä¸ª BUG ï¼Œæ–¹æ³•é‡Œä¸èƒ½åŒ…å«è¯¥å­—ç¬¦ï¼Œå› æ­¤ï¼Œç¬”è€…æ”¹æˆäº†ã€ç¬¬ 20 è¡Œã€‘ï¼Œå»æ‰äº†&nbsp;<code>"."</code>&nbsp;è¿›è¡Œæµ‹è¯•ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ç¬¬äºŒç§ï¼Œæ ¹æ®<strong>æ–¹æ³•å</strong>è·å¾— Invoker é›†åˆã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œéƒ½èƒ½åŒ¹é…åˆ°ã€‚</p>
</li>
<li>ç¬¬ä¸‰ç§ï¼Œä½¿ç”¨å…¨é‡ Invoker é›†åˆã€‚ä¾‹å¦‚ï¼Œ<code>#$echo(name)</code>&nbsp;å›å£°æ–¹æ³•ã€‚</li>
<li>ç¬¬å››ç§ï¼Œä½¿ç”¨&nbsp;<code>methodInvokerMap</code>&nbsp;ç¬¬ä¸€ä¸ª Invoker é›†åˆã€‚é˜²å¾¡æ€§ç¼–ç¨‹ã€‚</li>
</ul>
<h2 id="4-5-isAvailable">4.5 isAvailable</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// è‹¥å·²é”€æ¯ï¼Œè¿”å›ä¸å¯ç”¨</span></span><br /><span class="line">    <span class="keyword">if</span> (isDestroyed()) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// ä»»æ„ä¸€ä¸ª Invoker å¯ç”¨ï¼Œåˆ™è¿”å›å¯ç”¨</span></span><br /><span class="line">    Map&lt;String, Invoker&lt;T&gt;&gt; localUrlInvokerMap = urlInvokerMap;</span><br /><span class="line">    <span class="keyword">if</span> (localUrlInvokerMap != <span class="keyword">null</span> &amp;&amp; localUrlInvokerMap.size() &gt; <span class="number">0</span>) {</span><br /><span class="line">        <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;(localUrlInvokerMap.values())) {</span><br /><span class="line">            <span class="keyword">if</span> (invoker.isAvailable()) {</span><br /><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="4-6-destroy">4.6 destroy</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (isDestroyed()) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// å–æ¶ˆè®¢é˜…</span></span><br /><span class="line">    <span class="comment">// unsubscribe.</span></span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="keyword">if</span> (getConsumerUrl() != <span class="keyword">null</span> &amp;&amp; registry != <span class="keyword">null</span> &amp;&amp; registry.isAvailable()) {</span><br /><span class="line">            registry.unsubscribe(getConsumerUrl(), <span class="keyword">this</span>);</span><br /><span class="line">        }</span><br /><span class="line">    } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">        logger.warn(<span class="string">"unexpeced error when unsubscribe service "</span> + serviceKey + <span class="string">"from registry"</span> + registry.getUrl(), t);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// æ ‡è®°å·²ç»é”€æ¯</span></span><br /><span class="line">    <span class="keyword">super</span>.destroy(); <span class="comment">// must be executed after unsubscribing</span></span><br /><span class="line">    <span class="comment">// é”€æ¯æ‰€æœ‰ Invoker </span></span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        destroyAllInvokers();</span><br /><span class="line">    } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">        logger.warn(<span class="string">"Failed to destroy service "</span> + serviceKey, t);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="5-StaticDirectory">5. StaticDirectory</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.directory.StaticDirectory</code>&nbsp;ï¼Œå®ç° AbstractDirectory æŠ½è±¡ç±»ï¼Œ<strong>é™æ€</strong>&nbsp;Directory å®ç°ç±»ã€‚é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°†ä¼ å…¥çš„&nbsp;<code>invokers</code>&nbsp;é›†åˆï¼Œå°è£…æˆé™æ€çš„ Directory å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticDirectory</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractDirectory</span>&lt;<span class="title">T</span>&gt; </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Invoker é›†åˆ</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Invoker&lt;T&gt;&gt; invokers;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StaticDirectory</span><span class="params">(List&lt;Invoker&lt;T&gt;&gt; invokers)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>(<span class="keyword">null</span>, invokers, <span class="keyword">null</span>);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StaticDirectory</span><span class="params">(List&lt;Invoker&lt;T&gt;&gt; invokers, List&lt;Router&gt; routers)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>(<span class="keyword">null</span>, invokers, routers);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StaticDirectory</span><span class="params">(URL url, List&lt;Invoker&lt;T&gt;&gt; invokers)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>(url, invokers, <span class="keyword">null</span>);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StaticDirectory</span><span class="params">(URL url, List&lt;Invoker&lt;T&gt;&gt; invokers, List&lt;Router&gt; routers)</span> </span>{</span><br /><span class="line">        <span class="comment">// é»˜è®¤ä½¿ç”¨ `url` å‚æ•°ã€‚å½“å®ƒä¸ºç©ºæ—¶ï¼Œä½¿ç”¨ `invokers[0].url` ã€‚</span></span><br /><span class="line">        <span class="keyword">super</span>(url == <span class="keyword">null</span> &amp;&amp; invokers != <span class="keyword">null</span> &amp;&amp; !invokers.isEmpty() ? invokers.get(<span class="number">0</span>).getUrl() : url, routers);</span><br /><span class="line">        <span class="keyword">if</span> (invokers == <span class="keyword">null</span> || invokers.isEmpty()) {</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"invokers == null"</span>);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">this</span>.invokers = invokers;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Class&lt;T&gt; <span class="title">getInterface</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> invokers.get(<span class="number">0</span>).getInterface();</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="comment">// è‹¥å·²ç»é”€æ¯ï¼Œåˆ™ä¸å¯ç”¨</span></span><br /><span class="line">        <span class="keyword">if</span> (isDestroyed()) {</span><br /><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// ä»»ä¸€ä¸€ä¸ª Invoker å¯ç”¨ï¼Œåˆ™ä¸ºå¯ç”¨</span></span><br /><span class="line">        <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokers) {</span><br /><span class="line">            <span class="keyword">if</span> (invoker.isAvailable()) {</span><br /><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="comment">// è‹¥å·²ç»é”€æ¯ï¼Œ è·³è¿‡</span></span><br /><span class="line">        <span class="keyword">if</span> (isDestroyed()) {</span><br /><span class="line">            <span class="keyword">return</span>;</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// é”€æ¯</span></span><br /><span class="line">        <span class="keyword">super</span>.destroy();</span><br /><span class="line">        <span class="comment">// é”€æ¯æ¯ä¸ª Invoker</span></span><br /><span class="line">        <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokers) {</span><br /><span class="line">            invoker.destroy();</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// æ¸…ç©º Invoker é›†åˆ</span></span><br /><span class="line">        invokers.clear();</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">protected</span> List&lt;Invoker&lt;T&gt;&gt; doList(Invocation invocation) <span class="keyword">throws</span> RpcException {</span><br /><span class="line">        <span class="keyword">return</span> invokers;</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹ã€‚</li>
</ul>
<hr />
<p>é™¤äº†åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory/">ã€Œ4.3.3.3 toMergeMethodInvokerMapã€</a>&nbsp;æ–¹æ³•ä¸­ï¼Œä½¿ç”¨åˆ°äº† StaticDirectory å¯¹è±¡ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹&nbsp;<code>ReferenceConfig#createProxy(Map&lt;String, String&gt; map)</code>&nbsp;çš„ä½¿ç”¨ï¼Œä»£ç å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_04_10/05.png" alt="createProxy" /></p>
<ul>
<li>
<p>ç¬¬ 522 è‡³ 527 è¡Œï¼šå½“&nbsp;<code>registryURL</code>&nbsp;éç©ºæ—¶ï¼Œæ„å‘³ç€<strong>æœ‰æ³¨å†Œä¸­å¿ƒ</strong>ï¼Œä½¿ç”¨&nbsp;<code>cluster=available</code>&nbsp;é›†ç¾¤æ–¹å¼ï¼Œå¹¶è°ƒç”¨&nbsp;<code>Cluster$Adaptive#join(StaticDirectory)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºå¯¹åº”çš„ Cluster Invoker å¯¹è±¡ã€‚è¿™æ„å‘³ç€ï¼ŒæœåŠ¡è°ƒç”¨æ—¶ï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯&nbsp;<code>cluster=available</code>&nbsp;ï¼Œ<strong>ä»…è°ƒç”¨ç¬¬ä¸€ä¸ªå¯ç”¨çš„ Invoker å¯¹è±¡</strong>ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥åšä¸€ä¸ª YY ï¼š</p>
<ul>
<li>ç›®å‰æˆ‘ä»¬æœ‰ A , B ä¸¤ä¸ªæœºæˆ¿ï¼Œåˆ†åˆ«å¯¹åº” zk01 é›†ç¾¤ï¼Œzk02 é›†ç¾¤ã€‚è¿™ä¸¤ä¸ª zk é›†ç¾¤<strong>ä¸äº’é€š</strong>&nbsp;ã€‚</li>
<li>A , B æœºæˆ¿ï¼Œåˆ†åˆ«éƒ¨ç½²äº†&nbsp;<strong>User æœåŠ¡æä¾›è€…</strong>ï¼Œä»…æ³¨å†Œåˆ°è‡ªå·±æœºæˆ¿çš„ zk é›†ç¾¤ã€‚</li>
<li>
<p>A , B æœºæˆ¿ï¼Œéƒ¨ç½²äº†å¯¹åº”çš„&nbsp;<strong>User æœåŠ¡æ¶ˆè´¹</strong>ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬å¸Œæœ›ä¼˜å…ˆè°ƒç”¨æœ¬æœºæˆ¿ã€‚å½“æœ¬æœºæˆ¿&nbsp;<strong>User æœåŠ¡æä¾›è€…</strong>å…¨æŒ‚çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨å¦å¤–ä¸€ä¸ªæœºæˆ¿ï¼Œè¯¥å¦‚ä½•é…ç½®å‘¢ï¼Ÿ</p>
<figure class="highlight xml">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">// A æœºæˆ¿</span><br /><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">interface</span>=<span class="string">"com.alibaba.dubbo.demo.UserService"</span> <span class="attr">registry</span>=<span class="string">"zk01,zk02"</span> /&gt;</span></span><br /><span class="line">// B æœºæˆ¿</span><br /><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">interface</span>=<span class="string">"com.alibaba.dubbo.demo.UserService"</span> <span class="attr">registry</span>=<span class="string">"zk02,zk01"</span> /&gt;</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å³åœ¨&nbsp;<code>"registry"</code>&nbsp;é…ç½®é¡¹ä¸­ï¼Œå°†è‡ªå·±çš„ zk é›†ç¾¤æ”¾åœ¨å‰é¢ã€‚</li>
<li>å½“ç„¶ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¾ˆå°‘ä¼šå‡ºç°ä¸€ä¸ªæœºæˆ¿æœåŠ¡æä¾›è€…å…¨æŒ‚ï¼Œzk é›†ç¾¤è¿˜å­˜æ´»ç€ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="6-ClusterUtils">6. ClusterUtils</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.support.ClusterUtils</code>&nbsp;ï¼ŒCluster å·¥å…·ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClusterUtils</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:</span><br /><span class="line"> <span class="number">3</span>:     <span class="function"><span class="keyword">private</span> <span class="title">ClusterUtils</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">4</span>:     }</span><br /><span class="line"> <span class="number">5</span>:</span><br /><span class="line"> <span class="number">6</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> URL <span class="title">mergeUrl</span><span class="params">(URL remoteUrl, Map&lt;String, String&gt; localMap)</span> </span>{</span><br /><span class="line"> <span class="number">7</span>:         <span class="comment">// åˆå¹¶é…ç½® Map ç»“æœ</span></span><br /><span class="line"> <span class="number">8</span>:         Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br /><span class="line"> <span class="number">9</span>:         <span class="comment">// è¿œç¨‹é…ç½® Map ç»“æœ</span></span><br /><span class="line"><span class="number">10</span>:         Map&lt;String, String&gt; remoteMap = remoteUrl.getParameters();</span><br /><span class="line"><span class="number">11</span>:</span><br /><span class="line"><span class="number">12</span>:         <span class="comment">// æ·»åŠ  `remoteMap` åˆ° `map` ä¸­ï¼Œå¹¶ç§»é™¤ä¸å¿…è¦çš„é…ç½®</span></span><br /><span class="line"><span class="number">13</span>:         <span class="keyword">if</span> (remoteMap != <span class="keyword">null</span> &amp;&amp; remoteMap.size() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">14</span>:             map.putAll(remoteMap);</span><br /><span class="line"><span class="number">15</span>:</span><br /><span class="line"><span class="number">16</span>:             <span class="comment">// Remove configurations from provider, some items should be affected by provider. çº¿ç¨‹æ± é…ç½®ä¸ä½¿ç”¨æä¾›è€…çš„</span></span><br /><span class="line"><span class="number">17</span>:             map.remove(Constants.THREAD_NAME_KEY);</span><br /><span class="line"><span class="number">18</span>:             map.remove(Constants.DEFAULT_KEY_PREFIX + Constants.THREAD_NAME_KEY);</span><br /><span class="line"><span class="number">19</span>:</span><br /><span class="line"><span class="number">20</span>:             map.remove(Constants.THREADPOOL_KEY);</span><br /><span class="line"><span class="number">21</span>:             map.remove(Constants.DEFAULT_KEY_PREFIX + Constants.THREADPOOL_KEY);</span><br /><span class="line"><span class="number">22</span>:</span><br /><span class="line"><span class="number">23</span>:             map.remove(Constants.CORE_THREADS_KEY);</span><br /><span class="line"><span class="number">24</span>:             map.remove(Constants.DEFAULT_KEY_PREFIX + Constants.CORE_THREADS_KEY);</span><br /><span class="line"><span class="number">25</span>:</span><br /><span class="line"><span class="number">26</span>:             map.remove(Constants.THREADS_KEY);</span><br /><span class="line"><span class="number">27</span>:             map.remove(Constants.DEFAULT_KEY_PREFIX + Constants.THREADS_KEY);</span><br /><span class="line"><span class="number">28</span>:</span><br /><span class="line"><span class="number">29</span>:             map.remove(Constants.QUEUES_KEY);</span><br /><span class="line"><span class="number">30</span>:             map.remove(Constants.DEFAULT_KEY_PREFIX + Constants.QUEUES_KEY);</span><br /><span class="line"><span class="number">31</span>:</span><br /><span class="line"><span class="number">32</span>:             map.remove(Constants.ALIVE_KEY);</span><br /><span class="line"><span class="number">33</span>:             map.remove(Constants.DEFAULT_KEY_PREFIX + Constants.ALIVE_KEY);</span><br /><span class="line"><span class="number">34</span>:</span><br /><span class="line"><span class="number">35</span>:             map.remove(Constants.TRANSPORTER_KEY);</span><br /><span class="line"><span class="number">36</span>:             map.remove(Constants.DEFAULT_KEY_PREFIX + Constants.TRANSPORTER_KEY);</span><br /><span class="line"><span class="number">37</span>:         }</span><br /><span class="line"><span class="number">38</span>:         <span class="comment">// æ·»åŠ  `localMap` åˆ° `map` ä¸­</span></span><br /><span class="line"><span class="number">39</span>:         <span class="keyword">if</span> (localMap != <span class="keyword">null</span> &amp;&amp; localMap.size() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">40</span>:             map.putAll(localMap);</span><br /><span class="line"><span class="number">41</span>:         }</span><br /><span class="line"><span class="number">42</span>:</span><br /><span class="line"><span class="number">43</span>:         <span class="comment">// æ·»åŠ æŒ‡å®šçš„ `remoteMap` çš„é…ç½®é¡¹åˆ° `map` ä¸­ï¼Œå› ä¸ºä¸Šé¢è¢« `localMap` è¦†ç›–äº†ã€‚</span></span><br /><span class="line"><span class="number">44</span>:         <span class="keyword">if</span> (remoteMap != <span class="keyword">null</span> &amp;&amp; remoteMap.size() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">45</span>:             <span class="comment">// Use version passed from provider side</span></span><br /><span class="line"><span class="number">46</span>:             String dubbo = remoteMap.get(Constants.DUBBO_VERSION_KEY);</span><br /><span class="line"><span class="number">47</span>:             <span class="keyword">if</span> (dubbo != <span class="keyword">null</span> &amp;&amp; dubbo.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">48</span>:                 map.put(Constants.DUBBO_VERSION_KEY, dubbo);</span><br /><span class="line"><span class="number">49</span>:             }</span><br /><span class="line"><span class="number">50</span>:             String version = remoteMap.get(Constants.VERSION_KEY);</span><br /><span class="line"><span class="number">51</span>:             <span class="keyword">if</span> (version != <span class="keyword">null</span> &amp;&amp; version.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">52</span>:                 map.put(Constants.VERSION_KEY, version);</span><br /><span class="line"><span class="number">53</span>:             }</span><br /><span class="line"><span class="number">54</span>:             String group = remoteMap.get(Constants.GROUP_KEY);</span><br /><span class="line"><span class="number">55</span>:             <span class="keyword">if</span> (group != <span class="keyword">null</span> &amp;&amp; group.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">56</span>:                 map.put(Constants.GROUP_KEY, group);</span><br /><span class="line"><span class="number">57</span>:             }</span><br /><span class="line"><span class="number">58</span>:             String methods = remoteMap.get(Constants.METHODS_KEY);</span><br /><span class="line"><span class="number">59</span>:             <span class="keyword">if</span> (methods != <span class="keyword">null</span> &amp;&amp; methods.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">60</span>:                 map.put(Constants.METHODS_KEY, methods);</span><br /><span class="line"><span class="number">61</span>:             }</span><br /><span class="line"><span class="number">62</span>:             <span class="comment">// Reserve timestamp of provider url. ä¿ç•™ provider çš„å¯åŠ¨ timestamp</span></span><br /><span class="line"><span class="number">63</span>:             String remoteTimestamp = remoteMap.get(Constants.TIMESTAMP_KEY);</span><br /><span class="line"><span class="number">64</span>:             <span class="keyword">if</span> (remoteTimestamp != <span class="keyword">null</span> &amp;&amp; remoteTimestamp.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">65</span>:                 map.put(Constants.REMOTE_TIMESTAMP_KEY, remoteMap.get(Constants.TIMESTAMP_KEY));</span><br /><span class="line"><span class="number">66</span>:             }</span><br /><span class="line"><span class="number">67</span>:             <span class="comment">// Combine filters and listeners on Provider and Consumer åˆå¹¶ filter å’Œ listener</span></span><br /><span class="line"><span class="number">68</span>:             String remoteFilter = remoteMap.get(Constants.REFERENCE_FILTER_KEY);</span><br /><span class="line"><span class="number">69</span>:             String localFilter = localMap.get(Constants.REFERENCE_FILTER_KEY);</span><br /><span class="line"><span class="number">70</span>:             <span class="keyword">if</span> (remoteFilter != <span class="keyword">null</span> &amp;&amp; remoteFilter.length() &gt; <span class="number">0</span></span><br /><span class="line"><span class="number">71</span>:                     &amp;&amp; localFilter != <span class="keyword">null</span> &amp;&amp; localFilter.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">72</span>:                 localMap.put(Constants.REFERENCE_FILTER_KEY, remoteFilter + <span class="string">","</span> + localFilter);</span><br /><span class="line"><span class="number">73</span>:             }</span><br /><span class="line"><span class="number">74</span>:             String remoteListener = remoteMap.get(Constants.INVOKER_LISTENER_KEY);</span><br /><span class="line"><span class="number">75</span>:             String localListener = localMap.get(Constants.INVOKER_LISTENER_KEY);</span><br /><span class="line"><span class="number">76</span>:             <span class="keyword">if</span> (remoteListener != <span class="keyword">null</span> &amp;&amp; remoteListener.length() &gt; <span class="number">0</span></span><br /><span class="line"><span class="number">77</span>:                     &amp;&amp; localListener != <span class="keyword">null</span> &amp;&amp; localListener.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">78</span>:                 localMap.put(Constants.INVOKER_LISTENER_KEY, remoteListener + <span class="string">","</span> + localListener);</span><br /><span class="line"><span class="number">79</span>:             }</span><br /><span class="line"><span class="number">80</span>:         }</span><br /><span class="line"><span class="number">81</span>:</span><br /><span class="line"><span class="number">82</span>:         <span class="comment">// æ¸…ç©ºåŸæœ‰é…ç½®ï¼Œä½¿ç”¨åˆå¹¶çš„é…ç½®è¦†ç›–</span></span><br /><span class="line"><span class="number">83</span>:         <span class="keyword">return</span> remoteUrl.clearParameters().addParameters(map);</span><br /><span class="line"><span class="number">84</span>:     }</span><br /><span class="line"><span class="number">85</span>:</span><br /><span class="line"><span class="number">86</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å°†&nbsp;<code>localMap</code>&nbsp;å’Œ&nbsp;<code>remoteUrl.parameters</code>&nbsp;<strong>åˆå¹¶</strong>æˆ&nbsp;<code>map</code>&nbsp;ï¼Œå¤§å¤šæ•°ä»¥<strong>å‰è€…</strong>ä¸ºä¸»ã€ç¬¬ 12 è‡³ 41 è¡Œã€‘ï¼Œéƒ¨åˆ†<strong>æŒ‡å®š</strong>ä»¥åè€…ä¸ºä¸»ã€ç¬¬ 43 è‡³ 80 è¡Œã€‘ã€‚</li>
<li>å°†åˆå¹¶çš„&nbsp;<code>map</code>&nbsp;çš„ç»“æœï¼Œ<strong>è¦†ç›–</strong>è®¾ç½®åˆ°&nbsp;<code>remoteUrl</code>&nbsp;ä¸­ã€‚</li>
</ul>
</div>