<header class="article-header">
<h1 class="article-title">é›†æˆ Spring Cloud</h1>
</header>
<div class="article-entry">
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥åˆ†äº«&nbsp;<a href="https://github.com/spring-cloud-incubator/spring-cloud-alibaba/tree/master/spring-cloud-alibaba-dubbo" target="_blank" rel="external nofollow noopener noreferrer">Spring Cloud Alibaba Dubbo</a>&nbsp;é¡¹ç›®çš„æºç è§£æï¼Œçœ‹çœ‹ Dubbo æ˜¯å¦‚ä½•é›†æˆåˆ° Spring Cloud ä¸­çš„ã€‚</p>
<blockquote>
<p>ğŸ˜ˆ Spring Cloud å’Œ Dubbo ä¸€ç›´ä¸æ˜¯ç«äº‰çš„å…³ç³»ï¼Œèƒ–å‹è¦å¥½å¥½ç†è§£å“Ÿã€‚</p>
</blockquote>
<p>ç›®å‰ Spring Cloud Alibaba Dubbo æš‚æ—¶æ²¡æœ‰æ–‡æ¡£ï¼Œä¸è¿‡ä¸ç”¨æ‹…å¿ƒï¼Œè‰¿è‰¿ä¼šå…ˆæ•™ä½ æ­å»ºä¸€ä¸ªç¤ºä¾‹ï¼ŒåŒæ—¶å®ƒä¹Ÿæ˜¯æˆ‘ä»¬åé¢ç”¨æ¥è°ƒè¯•çš„ç¤ºä¾‹ã€‚</p>
<h1 id="2-è°ƒè¯•ç¯å¢ƒæ­å»º">2. è°ƒè¯•ç¯å¢ƒæ­å»º</h1>
<p>åœ¨è¯»æºç ä¹‹å‰ï¼Œæˆ‘ä»¬å½“ç„¶æ˜¯å…ˆæŠŠè°ƒè¯•ç¯å¢ƒæ­å»ºèµ·æ¥ã€‚</p>
<h2 id="2-1-ä¾èµ–å·¥å…·">2.1 ä¾èµ–å·¥å…·</h2>
<ul>
<li>JDK ï¼š1.8+</li>
<li>Maven</li>
<li>IntelliJ IDEA</li>
</ul>
<h2 id="2-2-æºç æ‹‰å–">2.2 æºç æ‹‰å–</h2>
<p>ä»å®˜æ–¹ä»“åº“&nbsp;<a href="https://github.com/spring-cloud-incubator/spring-cloud-alibaba" target="_blank" rel="external nofollow noopener noreferrer">https://github.com/spring-cloud-incubator/spring-cloud-alibaba</a>&nbsp;<code>Fork</code>&nbsp;å‡ºå±äºè‡ªå·±çš„ä»“åº“ã€‚ä¸ºä»€ä¹ˆè¦&nbsp;<code>Fork</code>&nbsp;ï¼Ÿæ—¢ç„¶å¼€å§‹é˜…è¯»ã€è°ƒè¯•æºç ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå†™ä¸€äº›æ³¨é‡Šï¼Œæœ‰äº†è‡ªå·±çš„ä»“åº“ï¼Œå¯ä»¥è¿›è¡Œè‡ªç”±çš„æäº¤ã€‚ğŸ˜ˆ</p>
<p>ä½¿ç”¨ IntelliJ IDEA ä» Fork å‡ºæ¥çš„ä»“åº“æ‹‰å–ä»£ç ã€‚æ‹‰å–å®Œæˆåï¼ŒMaven ä¼šä¸‹è½½ä¾èµ–åŒ…ï¼Œå¯èƒ½ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œè€å¿ƒç­‰å¾…ä¸‹ã€‚</p>
<hr />
<p>è€ƒè™‘åˆ°æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç›´æ¥ä½¿ç”¨&nbsp;<code>spring-cloud-alibaba-dubbo</code>&nbsp;é¡¹ç›®æä¾›çš„ç¤ºä¾‹ï¼Œå°±åœ¨å®ƒçš„&nbsp;<code>test</code>&nbsp;æµ‹è¯•ç›®å½•ä¸‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_02_14/01.jpg" alt="ç¤ºä¾‹é¡¹ç›®" /></p>
<p>ğŸ˜ˆ å¦å¤–ï¼Œæœ¬æ–‡ä½¿ç”¨çš„&nbsp;<code>spring-cloud-alibaba</code>&nbsp;ç‰ˆæœ¬æ˜¯&nbsp;<code>0.2.2.BUILD-SNAPSHOT</code>&nbsp;ã€‚</p>
<h2 id="2-3-å¯åŠ¨-Nacos">2.3 å¯åŠ¨ Nacos</h2>
<p>å› ä¸ºåé¢æˆ‘ä»¬ä¼šä½¿ç”¨ Nacos ä½œä¸ºæ³¨å†Œä¸­å¿ƒå’Œé…ç½®ä¸­å¿ƒï¼Œæ‰€ä»¥éœ€è¦å¯åŠ¨å®ƒã€‚å…·ä½“çš„ï¼Œå‚è€ƒè‰¿è‰¿åœ¨&nbsp;<a href="http://www.iocoder.cn/Nacos/the-tutorial/" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠNacos å®ç°åŸç†ä¸æºç è§£æç³»ç»Ÿ &mdash;&mdash; ç²¾å“åˆé›†ã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€Œ2. å¿«é€Ÿå¼€å§‹ã€</a>&nbsp;å°èŠ‚ã€‚</p>
<h2 id="2-4-å¯åŠ¨ç¤ºä¾‹">2.4 å¯åŠ¨ç¤ºä¾‹</h2>
<p>å³é”® DubboSpringCloudBootstrap ç±»çš„&nbsp;<code>#main(String[] args)</code>&nbsp;æ–¹æ³•ï¼Œç›´æ¥è¿è¡Œå³å¯ã€‚ğŸ™‚ å¦‚æœä½ æ²¡æœ‰çœ‹åˆ°ä»»ä½•å¼‚å¸¸è¾“å‡ºï¼Œè¯´æ˜å°±å·²ç»æˆåŠŸäº†ã€‚</p>
<p>å¦å¤–ï¼Œè¿™ä¸ªç¤ºä¾‹ï¼Œå³åšäº†æœåŠ¡æ¶ˆè´¹è€…ï¼Œåˆåšäº†æœåŠ¡æä¾›è€…ã€‚</p>
<p>ä¸‹é¢ï¼Œè®©æˆ‘ä»¬è®©æˆ‘ä»¬é€æ­¥è§£é‡Šç¤ºä¾‹ä¸­çš„æ¯ä¸ªç±»å’Œé…ç½®æ–‡ä»¶ã€‚</p>
<h3 id="2-4-1-bootstrap-yaml">2.4.1 bootstrap.yaml</h3>
<figure class="highlight yaml">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="attr">spring:</span></span><br /><span class="line"><span class="attr">  application:</span></span><br /><span class="line"><span class="attr">    name:</span> <span class="string">spring-cloud-alibaba-dubbo</span></span><br /><span class="line"><span class="attr">  cloud:</span></span><br /><span class="line"><span class="attr">    nacos:</span></span><br /><span class="line"><span class="attr">      discovery:</span></span><br /><span class="line"><span class="attr">        server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br /><span class="line"><span class="attr">      config:</span></span><br /><span class="line"><span class="attr">        server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br /><br /><span class="line"><span class="attr">eureka:</span></span><br /><span class="line"><span class="attr">  client:</span></span><br /><span class="line"><span class="attr">    enabled:</span> <span class="literal">false</span></span><br /><br /><span class="line"><span class="meta">---</span></span><br /><span class="line"><span class="attr">spring:</span></span><br /><span class="line"><span class="attr">  profiles:</span> <span class="string">eureka</span></span><br /><span class="line"><span class="attr">  cloud:</span></span><br /><span class="line"><span class="attr">    nacos:</span></span><br /><span class="line"><span class="attr">      discovery:</span></span><br /><span class="line"><span class="attr">        enabled:</span> <span class="literal">false</span></span><br /><span class="line"><span class="attr">        register-enabled:</span> <span class="literal">false</span></span><br /><br /><span class="line"><span class="attr">eureka:</span></span><br /><span class="line"><span class="attr">  client:</span></span><br /><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br /><span class="line"><span class="attr">    service-url:</span></span><br /><span class="line"><span class="attr">      defaultZone:</span> <span class="attr">http://127.0.0.1:8761/eureka/</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>Eureka ç›¸å…³çš„é…ç½®ï¼Œå¯ä»¥æ— è§†ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ Nacos ä½œä¸ºæ³¨å†Œä¸­å¿ƒã€‚</li>
<li><code>spring.application.name</code>&nbsp;ï¼Œé…ç½®äº†åº”ç”¨åã€‚</li>
<li><code>spring.cloud.nacos.discovery.server-addr</code>&nbsp;ï¼Œé…ç½®äº† Nacos ä½œä¸ºæ³¨å†Œä¸­å¿ƒã€‚</li>
<li><code>spring.cloud.nacos.config.server-addr</code>&nbsp;ï¼Œé…ç½®äº† Nacos ä½œä¸ºé…ç½®ä¸­å¿ƒã€‚</li>
</ul>
<h3 id="2-4-2-application-yaml">2.4.2 application.yaml</h3>
<figure class="highlight yaml">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="attr">dubbo:</span></span><br /><span class="line"><span class="attr">  scan:</span></span><br /><span class="line"><span class="attr">    base-packages:</span> <span class="string">org.springframework.cloud.alibaba.dubbo.service</span> <span class="comment"># æ‰«ææŒ‡å®šåŒ…ï¼Œç”Ÿæˆå¯¹åº”çš„ @Service å’Œ @Reference Bean å¯¹è±¡</span></span><br /><span class="line"><span class="attr">  protocols:</span></span><br /><span class="line"><span class="attr">    dubbo:</span></span><br /><span class="line"><span class="attr">      name:</span> <span class="string">dubbo</span> <span class="comment"># Dubbo åè®®</span></span><br /><span class="line"><span class="attr">      port:</span> <span class="number">12345</span> <span class="comment"># Dubbo åè®®çš„ç«¯å£</span></span><br /><span class="line"><span class="attr">    rest:</span></span><br /><span class="line"><span class="attr">      name:</span> <span class="string">rest</span> <span class="comment"># REST åè®®</span></span><br /><span class="line"><span class="attr">      port:</span> <span class="number">9090</span> <span class="comment"># REST åè®®çš„ç«¯å£</span></span><br /><span class="line"><span class="attr">      server:</span> <span class="string">netty</span> <span class="comment"># ä½¿ç”¨ Netty ä½œä¸º HTTP Server</span></span><br /><span class="line"><span class="attr">  registry:</span></span><br /><span class="line"><span class="attr">    address:</span> <span class="attr">spring-cloud://nacos</span> <span class="comment"># Dubbo æ³¨å†Œä¸­å¿ƒ</span></span><br /><br /><span class="line"><span class="attr">feign:</span></span><br /><span class="line"><span class="attr">  hystrix:</span></span><br /><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span> <span class="comment"># å¼€å¯ Hystrix åŠŸèƒ½ï¼Œå¯ä»¥ç†”æ–­è½</span></span><br /><br /><span class="line"><span class="attr">server:</span></span><br /><span class="line"><span class="attr">  port:</span> <span class="number">8080</span> <span class="comment"># HTTP API ç«¯å£</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ¯ä¸ªé…ç½®ï¼Œçœ‹çœ‹å…¶åçš„é…ç½®æ–‡ä»¶ã€‚</li>
</ul>
<h3 id="2-4-3-EchoService">2.4.3 EchoService</h3>
<p><code>org.springframework.cloud.alibaba.dubbo.service.EchoService</code>&nbsp;ï¼ŒEchoService æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// EchoService.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">EchoService</span> </span>{</span><br /><br /><span class="line">    <span class="function">String <span class="title">echo</span><span class="params">(String message)</span></span>;</span><br /><br /><span class="line">    <span class="function">String <span class="title">plus</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç†Ÿæ‚‰ä¸èƒ½åœ¨ç†Ÿæ‚‰çš„ Dubbo Service æ¥å£çš„ä»£ç ~</li>
</ul>
<h3 id="2-4-4-DefaultEchoService">2.4.4 DefaultEchoService</h3>
<p><code>org.springframework.cloud.alibaba.dubbo.service.DefaultEchoService</code>&nbsp;ï¼Œå®ç° EchoService æ¥å£ï¼Œé»˜è®¤çš„ EchoService å®ç°è€…ï¼ŒæœåŠ¡æä¾›è€…ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DefaultEchoService.java</span></span><br /><br /><span class="line"><span class="meta">@Service</span>(version = <span class="string">"1.0.0"</span>, protocol = {<span class="string">"dubbo"</span>, <span class="string">"rest"</span>})</span><br /><span class="line"><span class="meta">@RestController</span></span><br /><span class="line"><span class="meta">@Path</span>(<span class="string">"/"</span>)</span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultEchoService</span> <span class="keyword">implements</span> <span class="title">EchoService</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/echo"</span></span><br /><span class="line"><span class="comment">//            consumes = MediaType.APPLICATION_JSON_VALUE,</span></span><br /><span class="line"><span class="comment">//            produces = MediaType.APPLICATION_JSON_UTF8_VALUE</span></span><br /><span class="line">    )</span><br /><span class="line">    <span class="meta">@Path</span>(<span class="string">"/echo"</span>)</span><br /><span class="line">    <span class="meta">@GET</span></span><br /><span class="line"><span class="comment">//    @Consumes("application/json")</span></span><br /><span class="line"><span class="comment">//    @Produces("application/json;charset=UTF-8")</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">(@RequestParam @QueryParam(<span class="string">"message"</span>)</span> String message) </span>{</span><br /><span class="line">        System.out.println(message);</span><br /><span class="line">        <span class="keyword">return</span> RpcContext.getContext().getUrl() + <span class="string">" [echo] : "</span> + message;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/plus"</span>)</span><br /><span class="line">    <span class="meta">@Path</span>(<span class="string">"/plus"</span>)</span><br /><span class="line">    <span class="meta">@POST</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">plus</span><span class="params">(@RequestParam @QueryParam(<span class="string">"a"</span>)</span> <span class="keyword">int</span> a, @RequestParam @<span class="title">QueryParam</span><span class="params">(<span class="string">"b"</span>)</span> <span class="keyword">int</span> b) </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>@Service(version = "1.0.0", protocol = {"dubbo", "rest"})</code>&nbsp;æ³¨è§£ï¼Œæä¾› Dubbo å’Œ Rest ä¸¤ç§åè®®çš„æœåŠ¡ã€‚</li>
</ul>
<h3 id="2-4-5-DubboSpringCloudBootstrap">2.4.5 DubboSpringCloudBootstrap</h3>
<p><code>org.springframework.cloud.alibaba.dubbo.bootstrap.DubboSpringCloudBootstrap</code>&nbsp;ï¼Œç¤ºä¾‹çš„ Spring Boot å¯åŠ¨å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboSpringCloudBootstrap.java</span></span><br /><br /><span class="line"><span class="meta">@EnableDiscoveryClient</span> <span class="comment">// å¼€å¯æ³¨å†Œå‘ç°</span></span><br /><span class="line"><span class="meta">@EnableAutoConfiguration</span> <span class="comment">// å¼€å¯è‡ªåŠ¨é…ç½®</span></span><br /><span class="line"><span class="meta">@EnableFeignClients</span> <span class="comment">// å¼€å¯ Feign Client</span></span><br /><span class="line"><span class="meta">@RestController</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboSpringCloudBootstrap</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Reference</span>(version = <span class="string">"1.0.0"</span>)</span><br /><span class="line">    <span class="keyword">private</span> EchoService echoService;</span><br /><br /><span class="line">    <span class="meta">@Autowired</span></span><br /><span class="line">    <span class="meta">@Lazy</span></span><br /><span class="line">    <span class="keyword">private</span> FeignEchoService feignEchoService;</span><br /><br /><span class="line">    <span class="meta">@Autowired</span></span><br /><span class="line">    <span class="meta">@Lazy</span></span><br /><span class="line">    <span class="keyword">private</span> DubboFeignEchoService dubboFeignEchoService;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>{</span><br /><span class="line">        <span class="keyword">new</span> SpringApplicationBuilder(DubboSpringCloudBootstrap.class)</span><br /><span class="line">                .run(args);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>@EnableDiscoveryClient</code>&nbsp;æ³¨è§£ï¼Œç”¨äºå¼€å¯æ³¨å†Œå‘ç° Client çš„åŠŸèƒ½ã€‚</li>
<li><code>@EnableAutoConfiguration</code>&nbsp;æ³¨è§£ï¼Œç”¨äºå¼€å¯è‡ªåŠ¨é…ç½®ã€‚</li>
<li><code>@EnableFeignClients</code>&nbsp;æ³¨è§£ï¼Œå¼€å¯ Feign Client ã€‚åœ¨&nbsp;<code>spring-cloud-alibaba-dubbo</code>&nbsp;é¡¹ç›®ä¸­ï¼Œä½¿ç”¨ Feign ä½œä¸ºæœåŠ¡æ¶ˆè´¹è€…ã€‚</li>
<li><code>@RestController</code>&nbsp;æ³¨è§£ï¼Œåç»­æˆ‘ä»¬ä¼šçœ‹åˆ°è¿™ä¸ªç±»ä¸­ä¼šæä¾›åŸºäº Spring MVC çš„ HTTP API æ¥å£ã€‚</li>
<li><code>echoService</code>&nbsp;å±æ€§ï¼Œä½¿ç”¨&nbsp;<code>@Reference(version = "1.0.0")</code>&nbsp;æ³¨è§£ï¼Œå¼•å…¥ Dubbo æœåŠ¡ã€‚è¿™ä¸ªæ–¹å¼ï¼Œå°±æ˜¯æˆ‘ä»¬åŸå…ˆåœ¨ Dubbo ä¸­å°±ä½¿ç”¨çš„ã€‚</li>
<li>
<p><code>feignEchoService</code>&nbsp;å±æ€§ï¼Œä½¿ç”¨æ ‡å‡†çš„ Feign Client ä½œä¸ºæœåŠ¡æ¶ˆè´¹è€…ï¼Œå®ƒä½¿ç”¨ RestTemplate è°ƒç”¨çš„æ˜¯ Dubbo æä¾›çš„ Rest æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboSpringCloudBootstrap.java</span></span><br /><br /><span class="line"><span class="meta">@FeignClient</span>(<span class="string">"spring-cloud-alibaba-dubbo"</span>)</span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FeignEchoService</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/echo"</span>)</span><br /><span class="line">    <span class="function">String <span class="title">echo</span><span class="params">(@RequestParam(<span class="string">"message"</span>)</span> String message)</span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>dubboFeignEchoService</code>&nbsp;å±æ€§ï¼Œä¹Ÿä½¿ç”¨æ ‡å‡†çš„ Feign Client ä½œä¸ºæœåŠ¡æ¶ˆè´¹è€…ï¼Œå®ƒè°ƒç”¨ Dubbo è°ƒç”¨çš„æ˜¯ Dubbo æä¾›çš„ Dubbo æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboSpringCloudBootstrap.java</span></span><br /><br /><span class="line"><span class="meta">@FeignClient</span>(<span class="string">"spring-cloud-alibaba-dubbo"</span>)</span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DubboFeignEchoService</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/echo"</span>)</span><br /><span class="line">    <span class="meta">@DubboTransported</span></span><br /><span class="line">    <span class="function">String <span class="title">echo</span><span class="params">(@RequestParam(<span class="string">"message"</span>)</span> String message)</span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç›¸æ¯”&nbsp;<code>echoService</code>&nbsp;å±æ€§ï¼Œå®ƒåœ¨æ–¹æ³•ä¸Šï¼Œå¢åŠ äº†&nbsp;<code>org.springframework.cloud.alibaba.dubbo.annotation.@DubboTransported</code>&nbsp;æ³¨è§£ã€‚</li>
<li>å¯èƒ½ä¼šæœ‰èƒ–å‹å¥½å¥‡ï¼Œå…·ä½“æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿæœ¬æ–‡æˆ‘ä»¬ä¸€èµ·æ¥æ­æ™“~</li>
</ul>
</li>
</ul>
<hr />
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboSpringCloudBootstrap.java</span></span><br /><br /><span class="line"><span class="meta">@Bean</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> ApplicationRunner <span class="title">applicationRunner</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> arguments -&gt; {</span><br /><span class="line">        <span class="comment">// Dubbo Service call</span></span><br /><span class="line">        System.out.println(echoService.echo(<span class="string">"mercyblitz"</span>));</span><br /><span class="line">        <span class="comment">// Spring Cloud Open Feign REST Call</span></span><br /><span class="line">        System.out.println(feignEchoService.echo(<span class="string">"mercyblitz"</span>));</span><br /><span class="line">        <span class="comment">// Spring Cloud Open Feign REST Call (Dubbo Transported)</span></span><br /><span class="line">        System.out.println(dubboFeignEchoService.echo(<span class="string">"mercyblitz"</span>));</span><br /><span class="line">    };</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å£°æ˜äº† ApplicationRunner Bean å¯¹è±¡ï¼Œåœ¨ Spring Boot å¯åŠ¨å®Œæˆï¼Œç›´æ¥å‘èµ·ç›¸åº”çš„è°ƒç”¨ã€‚å®ƒçš„ç›®çš„æ˜¯ï¼Œçœ‹çœ‹ä¸‰ç§è°ƒç”¨æ–¹å¼ï¼Œæ˜¯å¦éƒ½æ­£å¸¸ã€‚å¦‚æœæ²¡æœ‰æŠ¥é”™ï¼Œè¯´æ˜éƒ½æ˜¯ OK çš„ã€‚</li>
</ul>
<hr />
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboSpringCloudBootstrap.java</span></span><br /><br /><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/dubbo/call/echo"</span>)</span><br /><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">dubboEcho</span><span class="params">(@RequestParam(<span class="string">"message"</span>)</span> String message) </span>{</span><br /><span class="line">    <span class="keyword">return</span> echoService.echo(message);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/feign/call/echo"</span>)</span><br /><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">feignEcho</span><span class="params">(@RequestParam(<span class="string">"message"</span>)</span> String message) </span>{</span><br /><span class="line">    <span class="keyword">return</span> feignEchoService.echo(message);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/feign-dubbo/call/echo"</span>)</span><br /><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">feignDubboEcho</span><span class="params">(@RequestParam(<span class="string">"message"</span>)</span> String message) </span>{</span><br /><span class="line">    <span class="keyword">return</span> dubboFeignEchoService.echo(message);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å£°æ˜äº†ä¸‰ä¸ª Spring MVC HTTP API ï¼Œåˆ†åˆ«è°ƒç”¨ä¸‰ä¸ªä¸åŒçš„æœåŠ¡æ¶ˆè´¹è€…ã€‚</li>
<li>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ DubboSpringCloudBootstrap æœ‰&nbsp;<code>@RestController</code>&nbsp;æ³¨è§£ï¼Œä¸”é…ç½®æ–‡ä»¶ä¸­é…ç½®äº†&nbsp;<code>server.port=8080</code>&nbsp;ã€‚</li>
</ul>
<p>ğŸ˜ˆ è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæ•´çœ‹è¿‡äº† Spring Cloud Alibaba Dubbo çš„ç¤ºä¾‹ï¼Œå¯ä»¥æ„‰å¿«çš„å¼€å§‹è°ƒè¯•äº†ã€‚</p>
<h1 id="3-é¡¹ç›®ç»“æ„ä¸€è§ˆ">3. é¡¹ç›®ç»“æ„ä¸€è§ˆ</h1>
<p>æœ¬æ–‡ä¸»è¦åˆ†äº«&nbsp;<code>spring-cloud-alibaba-dubbo</code>&nbsp;çš„&nbsp;<strong>é¡¹ç›®ç»“æ„</strong>ã€‚<br />å¸Œæœ›é€šè¿‡æœ¬æ–‡èƒ½è®©èƒ–å‹å¯¹&nbsp;<code>spring-cloud-alibaba-dubbo</code>&nbsp;çš„æ•´ä½“é¡¹ç›®æœ‰ä¸ªç®€å•çš„äº†è§£ã€‚</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_02_14/02.jpg" alt="é¡¹ç›®ç»“æ„ä¸€è§ˆ" /></p>
<h2 id="3-1-ä»£ç ç»Ÿè®¡">3.1 ä»£ç ç»Ÿè®¡</h2>
<p>è¿™é‡Œå…ˆåˆ†äº«ä¸€ä¸ªå°æŠ€å·§ã€‚ç¬”è€…åœ¨å¼€å§‹æºç å­¦ä¹ æ—¶ï¼Œä¼šé¦–å…ˆäº†è§£é¡¹ç›®çš„ä»£ç é‡ã€‚</p>
<p><strong>ç¬¬ä¸€ç§æ–¹å¼</strong>ï¼Œä½¿ç”¨&nbsp;<a href="https://plugins.jetbrains.com/plugin/4509-statistic" target="_blank" rel="external nofollow noopener noreferrer">IDEA Statistic</a>&nbsp;æ’ä»¶ï¼Œç»Ÿè®¡æ•´ä½“ä»£ç é‡ã€‚</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_02_14/03.jpg" alt="Statistic ç»Ÿè®¡ä»£ç é‡" /></p>
<ul>
<li>æˆ‘ä»¬å¯ä»¥ç²—ç•¥çš„çœ‹åˆ°ï¼Œæ•´ä¸ª Spring Cloud Alibaba çš„ä»£ç é‡åœ¨ 16000 è¡Œã€‚è¿™å…¶ä¸­è¿˜åŒ…æ‹¬å•å…ƒæµ‹è¯•ï¼Œç¤ºä¾‹ç­‰ç­‰ä»£ç ã€‚</li>
<li>/(ã„’oã„’)/~~ æ˜¾ç„¶ï¼Œç›®å‰è¿™ä¸ªæ’ä»¶æ²¡åŠæ³•å¾ˆæ–¹ä¾¿çš„ç»Ÿè®¡å‡ºï¼Œæˆ‘ä»¬æƒ³è¦çœ‹åˆ°çš„&nbsp;<code>spring-cloud-alibaba-dubbo</code>&nbsp;çš„ä»£ç é‡ã€‚</li>
</ul>
<p><strong>ç¬¬äºŒç§æ–¹å¼</strong>ï¼Œä½¿ç”¨&nbsp;<a href="http://blog.csdn.net/yhhwatl/article/details/52623879" target="_blank" rel="external nofollow noopener noreferrer">Shell è„šæœ¬å‘½ä»¤é€ä¸ª Maven æ¨¡å—ç»Ÿè®¡</a>&nbsp;ã€‚</p>
<p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç¬”è€…ä½¿ç”¨&nbsp;<code>find . -name "*.java"|xargs cat|grep -v -e ^$ -e ^\s*\/\/.*$|wc -l</code>&nbsp;ã€‚è¿™ä¸ªå‘½ä»¤åªè¿‡æ»¤äº†<strong>éƒ¨åˆ†æ³¨é‡Š</strong>ï¼Œæ‰€ä»¥ç›¸æ¯”&nbsp;<a href="https://plugins.jetbrains.com/plugin/4509-statistic" target="_blank" rel="external nofollow noopener noreferrer">IDEA Statistic</a>&nbsp;ä¼š<strong>åå¤š</strong>ã€‚</p>
<p>å½“ç„¶ï¼Œè€ƒè™‘åˆ°å‡†ç¡®æ€§ï¼Œèƒ–å‹éœ€è¦æ‰‹åŠ¨&nbsp;<code>cd</code>&nbsp;åˆ°æ¯ä¸ª Maven é¡¹ç›®çš„&nbsp;<code>src/main/java</code>&nbsp;ç›®å½•ä¸‹ï¼Œä»¥è¾¾åˆ°æ’é™¤å•å…ƒæµ‹è¯•çš„ä»£ç é‡ã€‚</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_02_14/04.jpg" alt="Shell è„šæœ¬ç»Ÿè®¡ä»£ç é‡" /></p>
<p>ç»Ÿè®¡å®Œåï¼Œå‘ç°ä»£ç é‡æ˜¯ä¸å¤šçš„ã€‚</p>
<h2 id="3-2-annotation-åŒ…">3.2&nbsp;<code>annotation</code>&nbsp;åŒ…</h2>
<p><code>annotation</code>&nbsp;åŒ…ï¼Œ62 è¡Œä»£ç ï¼Œæä¾›&nbsp;<code>@EnableFeignClients</code>&nbsp;æ³¨è§£ã€‚</p>
<h2 id="3-3-autoconfigure-åŒ…">3.3&nbsp;<code>autoconfigure</code>&nbsp;åŒ…</h2>
<p><code>autoconfigure</code>&nbsp;åŒ…ï¼Œ172 è¡Œä»£ç ï¼Œæä¾› Spring Boot è‡ªåŠ¨é…ç½® Spring Cloud Alibaba Dubbo ã€‚</p>
<h2 id="3-4-context-åŒ…">3.4&nbsp;<code>context</code>&nbsp;åŒ…</h2>
<p><code>context</code>&nbsp;åŒ…ï¼Œ35 è¡Œä»£ç ï¼Œç›®å‰ä»…æœ‰ DubboServiceRegistrationApplicationContextInitializer ç±»ï¼Œå…ˆä¸è§£é‡Šå“ˆ~</p>
<h2 id="3-5-metadata-åŒ…">3.5&nbsp;<code>metadata</code>&nbsp;åŒ…</h2>
<p><code>metadata</code>&nbsp;åŒ…ï¼Œ904 è¡Œä»£ç ï¼Œå®ç°å°† Spring Cloud Alibaba Dubbo çš„æœåŠ¡çš„å…ƒæ•°æ®ï¼Œå­˜å‚¨åˆ°é…ç½®ä¸­å¿ƒã€‚è¿™æ ·ï¼Œåç»­ä½¿ç”¨&nbsp;<code>@DubboTransported</code>&nbsp;æ³¨è§£çš„ Dubbo è°ƒç”¨æ—¶ï¼Œå› ä¸ºä¼šä½¿ç”¨åˆ°&nbsp;<a href="http://dubbo.apache.org/zh-cn/blog/dubbo-generic-invoke.html" target="_blank" rel="external nofollow noopener noreferrer">Dubboçš„æ³›åŒ–è°ƒç”¨</a>&nbsp;ï¼Œæœ‰äº†æœåŠ¡çš„å…ƒæ•°æ®ï¼Œå°±å¯ä»¥æ„‰å¿«çš„è°ƒç”¨äº†ã€‚</p>
<h2 id="3-6-openfeign-åŒ…">3.6&nbsp;<code>openfeign</code>&nbsp;åŒ…</h2>
<p><code>openfeign</code>&nbsp;åŒ…ï¼Œ305 è¡Œä»£ç ï¼Œå®ç°å°† Dubbo é›†æˆåˆ° OpenFeign ä¸­ã€‚</p>
<h2 id="3-7-registry-åŒ…">3.7&nbsp;<code>registry</code>&nbsp;åŒ…</h2>
<p><code>registry</code>&nbsp;åŒ…ï¼Œ478 è¡Œä»£ç ï¼Œå®ç° Dubbo ä½¿ç”¨ Spring Cloud Service æ³¨å†Œä¸­å¿ƒä½“ç³»ã€‚å¯èƒ½è¿™ä¹ˆè¯´æœ‰ç‚¹æŠ½è±¡ï¼Œæˆ‘ä»¬å¯ä»¥å›è¿‡å¤´çœ‹çœ‹&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€Œ2.4.2 application.yamlã€</a>&nbsp;ä¸­çœ‹åˆ°ï¼Œæœ‰ä¸ªç¥å¥‡çš„&nbsp;<code>dubbo.protocols.registry.address=spring-cloud://nacos</code>&nbsp;é…ç½®ã€‚</p>
<p>emm~å“ˆå“ˆå“ˆï¼Œç­‰ä¼šçœ‹å…·ä½“ä»£ç ï¼Œä¼šæ›´åŠ æ˜ç™½ã€‚</p>
<h1 id="4-annotation-åŒ…">4.&nbsp;<code>annotation</code>&nbsp;åŒ…</h1>
<h2 id="4-1-DubboTransported">4.1 @DubboTransported</h2>
<p><code>org.springframework.cloud.alibaba.dubbo.annotation.@DubboTransported</code>&nbsp;æ³¨è§£ï¼Œè¡¨åè°ƒç”¨æ—¶ï¼Œä½¿ç”¨ Dubbo ä½œä¸ºåº•å±‚ RPC è°ƒç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboTransported.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * {<span class="doctag">@link</span> DubboTransported <span class="doctag">@DubboTransported</span>} annotation indicates that the traditional Spring Cloud Service-to-Service call is transported</span></span><br /><span class="line"><span class="comment"> * by Dubbo under the hood, there are two main scenarios:</span></span><br /><span class="line"><span class="comment"> * &lt;ol&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;li&gt;{<span class="doctag">@link</span> FeignClient <span class="doctag">@FeignClient</span>} annotated classes:</span></span><br /><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br /><span class="line"><span class="comment"> * If {<span class="doctag">@link</span> DubboTransported <span class="doctag">@DubboTransported</span>} annotated classes, the invocation of all methods of</span></span><br /><span class="line"><span class="comment"> * {<span class="doctag">@link</span> FeignClient <span class="doctag">@FeignClient</span>} annotated classes.</span></span><br /><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br /><span class="line"><span class="comment"> * If {<span class="doctag">@link</span> DubboTransported <span class="doctag">@DubboTransported</span>} annotated methods of {<span class="doctag">@link</span> FeignClient <span class="doctag">@FeignClient</span>} annotated classes.</span></span><br /><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;/li&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;li&gt;{<span class="doctag">@link</span> LoadBalanced <span class="doctag">@LoadBalanced</span>} {<span class="doctag">@link</span> RestTemplate} annotated field, method and parameters&lt;/li&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;/ol&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> FeignClient</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> LoadBalanced</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br /><span class="line"><span class="meta">@Target</span>(value = {ElementType.TYPE, ElementType.FIELD, ElementType.METHOD, ElementType.PARAMETER}) <span class="comment">// æ”¯æŒç±»ã€æ–¹æ³•</span></span><br /><span class="line"><span class="meta">@Documented</span></span><br /><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DubboTransported {</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * The protocol of Dubbo transport whose value could be used the placeholder "dubbo.transport.protocol"</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * ä½¿ç”¨çš„ Dubbo åè®®ï¼Œé»˜è®¤ä¸º "dubbo"</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> the default protocol is "dubbo"</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function">String <span class="title">protocol</span><span class="params">()</span> <span class="keyword">default</span> "$</span>{dubbo.transport.protocol:dubbo}<span class="string">";</span></span><br /><br /><span class="line"><span class="string">    /**</span></span><br /><span class="line"><span class="string">     * The cluster of Dubbo transport whose value could be used the placeholder "</span>dubbo.transport.cluster<span class="string">"</span></span><br /><span class="line"><span class="string">     *</span></span><br /><span class="line"><span class="string">     * ä½¿ç”¨çš„é›†ç¾¤å®¹é”™æ–¹å¼ï¼Œé»˜è®¤ä¸º "</span>failover<span class="string">"</span></span><br /><span class="line"><span class="string">     *</span></span><br /><span class="line"><span class="string">     * @return the default protocol is "</span>failover<span class="string">"</span></span><br /><span class="line"><span class="string">     */</span></span><br /><span class="line"><span class="string">    String cluster() default "</span>${dubbo.transport.cluster:failover}<span class="string">";</span></span><br /><br /><span class="line"><span class="string">}</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>protocol</code>&nbsp;å±æ€§ï¼Œä½¿ç”¨çš„ Dubbo åè®®ï¼Œé»˜è®¤ä¸º&nbsp;<code>"dubbo"</code>&nbsp;ã€‚</li>
<li><code>cluster</code>&nbsp;å±æ€§ï¼Œä½¿ç”¨ ä½¿ç”¨çš„é›†ç¾¤å®¹é”™æ–¹å¼ï¼Œé»˜è®¤ä¸º&nbsp;<code>"failover"</code>&nbsp;ã€‚</li>
<li>å¯æ ‡è®°åœ¨ç±»æˆ–è€…æ–¹æ³•ä¸Šã€‚</li>
</ul>
<h1 id="5-autoconfigure-åŒ…">5.&nbsp;<code>autoconfigure</code>&nbsp;åŒ…</h1>
<p>åœ¨&nbsp;<code>META-INF/spring.factories</code>&nbsp;æ–‡ä»¶ä¸­ï¼Œå£°æ˜äº†ä¸‰ä¸ªè‡ªåŠ¨é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br /><span class="line">  org.springframework.cloud.alibaba.dubbo.autoconfigure.DubboMetadataAutoConfiguration,\</span><br /><span class="line">  org.springframework.cloud.alibaba.dubbo.autoconfigure.DubboOpenFeignAutoConfiguration,\</span><br /><span class="line">  org.springframework.cloud.alibaba.dubbo.autoconfigure.DubboRestMetadataRegistrationAutoConfiguration</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä¸‹é¢ï¼Œæˆ‘ä»¬é€ä¸ªæ¥ç…ç…ã€‚</li>
</ul>
<h2 id="5-1-DubboMetadataAutoConfiguration">5.1 DubboMetadataAutoConfiguration</h2>
<p><code>org.springframework.cloud.alibaba.dubbo.autoconfigure.DubboMetadataAutoConfiguration</code>&nbsp;ï¼ŒDubbo å…ƒæ•°æ®ï¼ˆMetadataï¼‰ç›¸å…³ Bean çš„è‡ªåŠ¨é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboMetadataAutoConfiguration.java</span></span><br /><br /><span class="line"><span class="meta">@Configuration</span></span><br /><span class="line"><span class="meta">@Import</span>(DubboServiceMetadataRepository.class) <span class="comment">// åˆ›å»ºäº† DubboServiceMetadataRepository Bean å¯¹è±¡</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboMetadataAutoConfiguration</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Bean</span> <span class="comment">// åˆ›å»ºäº† NacosMetadataConfigService Bean å¯¹è±¡</span></span><br /><span class="line">    <span class="meta">@ConditionalOnBean</span>(NacosConfigProperties.class)</span><br /><span class="line">    <span class="function"><span class="keyword">public</span> MetadataConfigService <span class="title">metadataConfigService</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NacosMetadataConfigService();</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>é€šè¿‡&nbsp;<code>@Import(DubboServiceMetadataRepository.class)</code>&nbsp;ï¼Œåˆ›å»ºäº† DubboServiceMetadataRepository å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€Œ7.5 DubboServiceMetadataRepositoryã€</a>&nbsp;ã€‚</li>
<li><code>#metadataConfigService()</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºäº† NacosMetadataConfigService Bean å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€Œ7.4.1 NacosMetadataConfigServiceã€</a>&nbsp;ã€‚</li>
</ul>
<h2 id="5-2-DubboOpenFeignAutoConfiguration">5.2 DubboOpenFeignAutoConfiguration</h2>
<p><code>org.springframework.cloud.alibaba.dubbo.autoconfigure.DubboOpenFeignAutoConfiguration</code>&nbsp;ï¼ŒDubbo OpenFeign ç›¸å…³ Bean çš„è‡ªåŠ¨é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboOpenFeignAutoConfiguration.java</span></span><br /><br /><span class="line"><span class="meta">@ConditionalOnClass</span>(value = Feign.class) <span class="comment">// å­˜åœ¨ Feign ç±»çš„æ—¶å€™ï¼Œå³å­˜åœ¨ feign ä¾èµ–</span></span><br /><span class="line"><span class="meta">@AutoConfigureAfter</span>(FeignAutoConfiguration.class) <span class="comment">// åœ¨ FeignAutoConfiguration é…ç½®ç±»ä¹‹ååˆå§‹åŒ–</span></span><br /><span class="line"><span class="meta">@Configuration</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboOpenFeignAutoConfiguration</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Value</span>(<span class="string">"${spring.application.name}"</span>)</span><br /><span class="line">    <span class="keyword">private</span> String currentApplicationName;</span><br /><br /><span class="line">    <span class="meta">@Bean</span> <span class="comment">// åˆ›å»º DubboServiceBeanMetadataResolver å¯¹è±¡</span></span><br /><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> MetadataResolver <span class="title">metadataJsonResolver</span><span class="params">(ObjectProvider&lt;Contract&gt; contract)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DubboServiceBeanMetadataResolver(currentApplicationName, contract);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Bean</span> <span class="comment">// åˆ›å»º TargeterBeanPostProcessor å¯¹è±¡</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> TargeterBeanPostProcessor <span class="title">targeterBeanPostProcessor</span><span class="params">(Environment environment,</span></span></span><br /><span class="line"><span class="function"><span class="params">                                                               DubboServiceMetadataRepository dubboServiceMetadataRepository)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TargeterBeanPostProcessor(environment, dubboServiceMetadataRepository);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>#metadataJsonResolver(...)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º DubboServiceBeanMetadataResolver Bean å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€Œ7.2 MetadataResolverã€</a>&nbsp;ã€‚</li>
<li><code>#targeterBeanPostProcessor(...)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º TargeterBeanPostProcessor Bean å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€Œ8.1 TargeterBeanPostProcessorã€</a>&nbsp;ã€‚</li>
</ul>
<h2 id="5-3-DubboRestMetadataRegistrationAutoConfiguration">5.3 DubboRestMetadataRegistrationAutoConfiguration</h2>
<p><code>org.springframework.cloud.alibaba.dubbo.autoconfigure.DubboRestMetadataRegistrationAutoConfiguration</code>&nbsp;ï¼Œè‡ªåŠ¨é…ç½®ä¸¤ä¸ª Spring äº‹ä»¶ç›‘å¬å™¨ï¼Œå°† Dubbo Rest å…ƒæ•°æ®ï¼ˆMetadataï¼‰æ³¨å†Œåˆ°é…ç½®ä¸­å¿ƒã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboRestMetadataRegistrationAutoConfiguration.java</span></span><br /><br /><span class="line"><span class="meta">@ConditionalOnProperty</span>(value = <span class="string">"spring.cloud.service-registry.auto-registration.enabled"</span>, matchIfMissing = <span class="keyword">true</span>) <span class="comment">// è¦æ±‚æœ‰ "spring.cloud.service-registry.auto-registration.enabled=true" ï¼Œæˆ–è€…ä¸é…ç½®ã€‚</span></span><br /><span class="line"><span class="meta">@ConditionalOnBean</span>(value = { <span class="comment">// è¦æ±‚å­˜åœ¨ MetadataResolverã€MetadataConfigService Bean å¯¹è±¡</span></span><br /><span class="line">        MetadataResolver.class,</span><br /><span class="line">        MetadataConfigService.class</span><br /><span class="line">})</span><br /><span class="line"><span class="meta">@AutoConfigureAfter</span>(value = {DubboMetadataAutoConfiguration.class}) <span class="comment">// åœ¨ DubboMetadataAutoConfiguration é…ç½®ç±»ä¹‹ååˆå§‹åŒ–</span></span><br /><span class="line"><span class="meta">@Configuration</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboRestMetadataRegistrationAutoConfiguration</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * A Map to store REST metadata temporary, its' key is the special service name for a Dubbo service,</span></span><br /><span class="line"><span class="comment">     * the value is a JSON content of JAX-RS or Spring MVC REST metadata from the annotated methods.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * Dubbo Rest Service æ–¹æ³•çš„å…ƒæ•°æ®ï¼ˆMetadataï¼‰é›†åˆ</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;ServiceRestMetadata&gt; serviceRestMetadata = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br /><br /><span class="line">    <span class="meta">@Autowired</span> <span class="comment">// é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¥è‡ª DubboOpenFeignAutoConfiguration æ³¨å†Œçš„ DubboServiceBeanMetadataResolver Bean å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">private</span> MetadataResolver metadataResolver;</span><br /><br /><span class="line">    <span class="meta">@Autowired</span> <span class="comment">// é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¥è‡ª DubboMetadataAutoConfiguration æ³¨å†Œçš„ NacosMetadataConfigService Bean å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">private</span> MetadataConfigService metadataConfigService;</span><br /><br /><span class="line">    <span class="meta">@EventListener</span>(ServiceBeanExportedEvent.class)</span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordRestMetadata</span><span class="params">(ServiceBeanExportedEvent event)</span> <span class="keyword">throws</span> JsonProcessingException </span>{</span><br /><span class="line">        ServiceBean serviceBean = event.getServiceBean();</span><br /><span class="line">        serviceRestMetadata.addAll(metadataResolver.resolveServiceRestMetadata(serviceBean));</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Pre-handle Spring Cloud application service registered:</span></span><br /><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br /><span class="line"><span class="comment">     * Put &lt;code&gt;restMetadata&lt;/code&gt; with the JSON format into</span></span><br /><span class="line"><span class="comment">     * {<span class="doctag">@link</span> Registration#getMetadata() service instances' metadata}</span></span><br /><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> event {<span class="doctag">@link</span> InstancePreRegisteredEvent} instance</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="meta">@EventListener</span>(InstancePreRegisteredEvent.class)</span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerRestMetadata</span><span class="params">(InstancePreRegisteredEvent event)</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line">        Registration registration = event.getRegistration();</span><br /><span class="line">        metadataConfigService.publishServiceRestMetadata(registration.getServiceId(), serviceRestMetadata);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>serviceRestMetadata</code>&nbsp;å±æ€§ï¼ŒDubbo Rest Service æ–¹æ³•çš„å…ƒæ•°æ®ï¼ˆMetadataï¼‰é›†åˆã€‚</li>
<li><code>#recordRestMetadata(ServiceBeanExportedEvent)</code>&nbsp;æ–¹æ³•ï¼Œç›‘å¬ ServiceBeanExportedEvent äº‹ä»¶ã€‚
<ul>
<li>åœ¨æ¯ä¸ª Dubbo æœåŠ¡æš´éœ²åï¼Œä¼šå‘å¸ƒ ServiceBeanExportedEvent äº‹ä»¶ã€‚åœ¨&nbsp;<a href="http://www.iocoder.cn/Dubbo/good-collection/" target="_blank" rel="external nofollow noopener noreferrer">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æ³¨è§£é…ç½®ã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€Œ5.3.3 onApplicationEventã€</a>&nbsp;ä¸­ï¼Œæˆ‘ä»¬æœ‰è¿‡è¯¦ç»†è§£æã€‚</li>
<li>åœ¨æ¥æ”¶åˆ° ServiceBeanExportedEvent äº‹ä»¶ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨&nbsp;<code>MetadataResolver#resolveServiceRestMetadata(ServiceBean serviceBean)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—è¯¥ ServiceBean çš„ ServiceRestMetadata é›†åˆï¼Œæ·»åŠ åˆ°&nbsp;<code>serviceRestMetadata</code>&nbsp;ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€Œ7.5 DubboServiceBeanMetadataResolverã€</a>&nbsp;ã€‚</li>
</ul>
</li>
<li><code>#registerRestMetadata(InstancePreRegisteredEvent)</code>&nbsp;æ–¹æ³•ï¼Œç›‘å¬ InstancePreRegisteredEvent äº‹ä»¶ã€‚
<ul>
<li>InstancePreRegisteredEvent äº‹ä»¶ï¼Œåœ¨ Spring Cloud åº”ç”¨æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒä¹‹å‰ï¼Œä¼šè§¦å‘è¯¥äº‹ä»¶ã€‚è¯¦ç»†çš„ï¼Œå¯ä»¥çœ‹çœ‹&nbsp;<a href="https://www.jianshu.com/p/a8b255c9feae" target="_blank" rel="external nofollow noopener noreferrer">ã€Šspring-cloud-commons referenceã€‹</a>&nbsp;æ–‡ç« çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€Œ2.2.1 ServiceRegistry Auto-Registrationã€</a>&nbsp;å°èŠ‚ã€‚ç°åœ¨ï¼Œå¯ä»¥ä¸çœ‹~</li>
<li>åœ¨æ¥æ”¶åˆ° InstancePreRegisteredEvent äº‹ä»¶ï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨&nbsp;<code>MetadataConfigService#publishServiceRestMetadata(String serviceName, Set&lt;ServiceRestMetadata&gt; serviceRestMetadata)</code>&nbsp;æ–¹æ³•ï¼Œå°†æ¯ä¸ª Dubbo æœåŠ¡çš„ ServiceRestMetadata å…ƒæ•°æ®é›†åˆï¼Œå‘å¸ƒï¼ˆå­˜å‚¨ï¼‰åˆ°é…ç½®ä¸­å¿ƒã€‚</li>
</ul>
</li>
<li>è¿™æ ·ï¼Œåç»­çš„ Dubbo æ³›åŒ–è°ƒç”¨ï¼Œå°±æœ‰ Dubbo æœåŠ¡çš„å…ƒæ•°æ®å’§ã€‚</li>
</ul>
<blockquote>
<p>å› ä¸ºæœ¬å°èŠ‚è®²çš„éƒ½æ˜¯è‡ªåŠ¨é…ç½®ç±»ï¼Œèƒ–å‹å¯èƒ½ä¼šç•¥æœ‰æ‡µé€¼ã€‚ä¸è¦æ…Œï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹æ’¸ã€‚</p>
<p>å¯¹å’§ï¼Œæœ€å¥½ä¸€è¾¹è°ƒè¯•ï¼Œä¸€è¾¹çœ‹ã€‚</p>
</blockquote>
<h1 id="6-context-åŒ…">6.&nbsp;<code>context</code>&nbsp;åŒ…</h1>
<p>åœ¨&nbsp;<code>META-INF/spring.factories</code>&nbsp;æ–‡ä»¶ä¸­ï¼Œå£°æ˜äº†ä¸‰ä¸ªè‡ªåŠ¨é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">org.springframework.context.ApplicationContextInitializer=\</span><br /><span class="line">  org.springframework.cloud.alibaba.dubbo.context.DubboServiceRegistrationApplicationContextInitializer</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="6-1-DubboServiceRegistrationApplicationContextInitializer">6.1 DubboServiceRegistrationApplicationContextInitializer</h2>
<p><code>org.springframework.cloud.alibaba.dubbo.context.DubboServiceRegistrationApplicationContextInitializer</code>&nbsp;ï¼Œå®ç° ApplicationContextInitializer æ¥å£ï¼Œå°†&nbsp;<code>applicationContext</code>&nbsp;è®¾ç½®åˆ°&nbsp;<code>SpringCloudRegistryFactory.applicationContext</code>&nbsp;é™æ€å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringCloudRegistryFactory.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * The Dubbo services will be registered as the specified Spring cloud applications that will not be considered</span></span><br /><span class="line"><span class="comment"> * normal ones, but only are used to Dubbo's service discovery even if it is based on Spring Cloud Commons abstraction.</span></span><br /><span class="line"><span class="comment"> * However, current application will be registered by other DiscoveryClientAutoConfiguration.</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboServiceRegistrationApplicationContextInitializer</span> <span class="keyword">implements</span> <span class="title">ApplicationContextInitializer</span>&lt;<span class="title">ConfigurableApplicationContext</span>&gt; </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(ConfigurableApplicationContext applicationContext)</span> </span>{</span><br /><span class="line">        <span class="comment">// Set ApplicationContext into SpringCloudRegistryFactory before Dubbo Service Register</span></span><br /><span class="line">        SpringCloudRegistryFactory.setApplicationContext(applicationContext);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="7-metadata-åŒ…">7.&nbsp;<code>metadata</code>&nbsp;åŒ…</h1>
<p>åœ¨çœ‹å…·ä½“ä»£ç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆåœ¨ Nacos çš„é…ç½®ä¸­å¿ƒç•Œé¢ï¼Œçœ‹çœ‹ä»€ä¹ˆæ˜¯ Dubbo Metadata ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_02_14/05.jpg" alt="Dubbo Metadata" /></p>
<p>å¯èƒ½è¿™æ ·è¿˜æ˜¯ä¸å¤Ÿæ¸…ç†ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª Dubbo Service Metadata æ›´å…·ä½“çš„ç¤ºä¾‹ï¼Œå¦‚ä¸‹ JSON ä¸²ï¼š</p>
<figure class="highlight">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">{</span><br /><span class="line">  "name" : "providers:dubbo:org.springframework.cloud.alibaba.dubbo.service.EchoService:1.0.0", // dubbo åè®®</span><br /><span class="line">  "meta" : [ { // ä¸€ä¸ª Dubbo æ–¹æ³•</span><br /><span class="line">    "method" : { // æ–¹æ³•ä¿¡æ¯</span><br /><span class="line">      "name" : "echo",</span><br /><span class="line">      "returnType" : "java.lang.String",</span><br /><span class="line">      "params" : [ {</span><br /><span class="line">        "index" : 0,</span><br /><span class="line">        "name" : "message",</span><br /><span class="line">        "type" : "java.lang.String"</span><br /><span class="line">      } ]</span><br /><span class="line">    },</span><br /><span class="line">    "request" : { // è¯·æ±‚ä¿¡æ¯</span><br /><span class="line">      "method" : "GET",</span><br /><span class="line">      "url" : "/echo",</span><br /><span class="line">      "queries" : {</span><br /><span class="line">        "message" : [ "{message}" ]</span><br /><span class="line">      },</span><br /><span class="line">      "headers" : { }</span><br /><span class="line">    },</span><br /><span class="line">    "indexToName" : {</span><br /><span class="line">      "0" : [ "message" ]</span><br /><span class="line">    }</span><br /><span class="line">  }, { // ä¸€ä¸ª Dubbo æ–¹æ³•</span><br /><span class="line">    "method" : { // æ–¹æ³•ä¿¡æ¯</span><br /><span class="line">      "name" : "plus",</span><br /><span class="line">      "returnType" : "java.lang.String",</span><br /><span class="line">      "params" : [ {</span><br /><span class="line">        "index" : 0,</span><br /><span class="line">        "name" : "a",</span><br /><span class="line">        "type" : "int"</span><br /><span class="line">      }, {</span><br /><span class="line">        "index" : 1,</span><br /><span class="line">        "name" : "b",</span><br /><span class="line">        "type" : "int"</span><br /><span class="line">      } ]</span><br /><span class="line">    },</span><br /><span class="line">    "request" : { // è¯·æ±‚ä¿¡æ¯</span><br /><span class="line">      "method" : "POST",</span><br /><span class="line">      "url" : "/plus",</span><br /><span class="line">      "queries" : {</span><br /><span class="line">        "a" : [ "{a}" ],</span><br /><span class="line">        "b" : [ "{b}" ]</span><br /><span class="line">      },</span><br /><span class="line">      "headers" : { }</span><br /><span class="line">    },</span><br /><span class="line">    "indexToName" : {</span><br /><span class="line">      "0" : [ "a" ],</span><br /><span class="line">      "1" : [ "b" ]</span><br /><span class="line">    }</span><br /><span class="line">  } ]</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>*</p>
<h2 id="7-1-Metadata-ç±»">7.1 Metadata ç±»</h2>
<p>åœ¨&nbsp;<code>metadata</code>&nbsp;åŒ…çš„æ ¹ç›®å½•ï¼Œä¸€å…±æœ‰ 6 ä¸ª Metadata ç±»ã€‚å¦‚ä¸‹ï¼š</p>
<ul>
<li>ServiceRestMetadata</li>
<li>RestMethodMetadata</li>
<li>MethodMetadata</li>
<li>MethodParameterMetadata</li>
<li>RequestMetadata</li>
<li>DubboTransportedMethodMetadata</li>
</ul>
<h3 id="7-1-1-ServiceRestMetadata">7.1.1 ServiceRestMetadata</h3>
<p><code>org.springframework.cloud.alibaba.dubbo.metadata.ServiceRestMetadata</code>&nbsp;ï¼ŒService Rest Metadata ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ServiceRestMetadata.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceRestMetadata</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æœåŠ¡å</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> String name;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Rest æ–¹æ³•å…ƒæ•°æ®</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> Set&lt;RestMethodMetadata&gt; meta;</span><br /><br /><span class="line">    <span class="comment">// ... çœç•¥ setting/getting æ–¹æ³•</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="7-1-2-RestMethodMetadata">7.1.2 RestMethodMetadata</h3>
<p><code>org.springframework.cloud.alibaba.dubbo.metadata.RestMethodMetadata</code>&nbsp;ï¼ŒRest Method Metadata ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// RestMethodMetadata.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestMethodMetadata</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ–¹æ³•å…ƒæ•°æ®</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> MethodMetadata method;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * è¯·æ±‚å…ƒæ•°æ®</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> RequestMetadata request;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * TODO</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> Map&lt;Integer, Collection&lt;String&gt;&gt; indexToName;</span><br /><br /><span class="line">    <span class="comment">// ... çœç•¥ setting/getting æ–¹æ³•</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h4 id="7-1-2-1-MethodMetadata">7.1.2.1 MethodMetadata</h4>
<p><code>org.springframework.cloud.alibaba.dubbo.metadata.MethodMetadata</code>&nbsp;ï¼ŒMethod Metadata ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ServiceRestMetadata.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodMetadata</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ–¹æ³•å</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> String name;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * è¿”å›ç±»å‹</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> String returnType;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ–¹æ³•å‚æ•°å…ƒæ•°æ®çš„æ•°ç»„</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> List&lt;MethodParameterMetadata&gt; params;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ–¹æ³•</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="meta">@JsonIgnore</span> <span class="comment">// ä¸å­˜å‚¨åˆ°é…ç½®ä¸­å¿ƒ</span></span><br /><span class="line">    <span class="keyword">private</span> Method method;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MethodMetadata</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.params = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MethodMetadata</span><span class="params">(Method method)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.name = method.getName();</span><br /><span class="line">        <span class="comment">// è·å¾—è¿”å›ç±»å‹</span></span><br /><span class="line">        <span class="keyword">this</span>.returnType = ClassUtils.getName(method.getReturnType());</span><br /><span class="line">        <span class="comment">// åˆå§‹åŒ– params</span></span><br /><span class="line">        <span class="keyword">this</span>.params = initParameters(method);</span><br /><span class="line">        <span class="keyword">this</span>.method = method;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;MethodParameterMetadata&gt; <span class="title">initParameters</span><span class="params">(Method method)</span> </span>{</span><br /><span class="line">        <span class="comment">// è·å¾—å‚æ•°æ•°é‡</span></span><br /><span class="line">        <span class="keyword">int</span> parameterCount = method.getParameterCount();</span><br /><span class="line">        <span class="comment">// å¦‚æœå‚æ•°ä¸å­˜åœ¨ï¼Œåˆ™è¿”å›ç©ºæ•°ç»„</span></span><br /><span class="line">        <span class="keyword">if</span> (parameterCount &lt; <span class="number">1</span>) {</span><br /><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// åˆ›å»º MethodParameterMetadata æ•°ç»„</span></span><br /><span class="line">        List&lt;MethodParameterMetadata&gt; params = <span class="keyword">new</span> ArrayList&lt;&gt;(parameterCount);</span><br /><span class="line">        Parameter[] parameters = method.getParameters();</span><br /><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; parameterCount; i++) {</span><br /><span class="line">            <span class="comment">// è·å¾— Parameter å¯¹è±¡</span></span><br /><span class="line">            Parameter parameter = parameters[i];</span><br /><span class="line">            <span class="comment">// è½¬æ¢æˆ MethodParameterMetadata å¯¹è±¡</span></span><br /><span class="line">            MethodParameterMetadata param = toMethodParameterMetadata(i, parameter);</span><br /><span class="line">            <span class="comment">// æ·»åŠ åˆ° params ä¸­</span></span><br /><span class="line">            params.add(param);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span> params;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">private</span> MethodParameterMetadata <span class="title">toMethodParameterMetadata</span><span class="params">(<span class="keyword">int</span> index, Parameter parameter)</span> </span>{</span><br /><span class="line">        <span class="comment">// åˆ›å»º MethodParameterMetadata å¯¹è±¡</span></span><br /><span class="line">        MethodParameterMetadata metadata = <span class="keyword">new</span> MethodParameterMetadata();</span><br /><span class="line">        metadata.setIndex(index); <span class="comment">// æ–¹æ³•å‚æ•°çš„ä½ç½®</span></span><br /><span class="line">        metadata.setName(parameter.getName()); <span class="comment">// æ–¹æ³•å‚æ•°çš„åå­—</span></span><br /><span class="line">        metadata.setType(parameter.getType().getTypeName()); <span class="comment">// æ–¹æ³•å‚æ•°çš„ç±»å‹</span></span><br /><span class="line">        <span class="keyword">return</span> metadata;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">// ... çœç•¥ setting/getting æ–¹æ³•</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h5 id="7-1-2-1-1-MethodParameterMetadata">7.1.2.1.1 MethodParameterMetadata</h5>
<p><code>org.springframework.cloud.alibaba.dubbo.metadata.MethodParameterMetadata</code>&nbsp;ï¼ŒMethod Parameter Metadata ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// MethodParameterMetadata.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodParameterMetadata</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ–¹æ³•å‚æ•°çš„ä½ç½®</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ–¹æ³•å‚æ•°çš„åå­—</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> String name;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ–¹æ³•å‚æ•°çš„ç±»å‹</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> String type;</span><br /><br /><span class="line">    <span class="comment">// ... çœç•¥ setting/getting æ–¹æ³•</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h4 id="7-1-2-2-RequestMetadata">7.1.2.2 RequestMetadata</h4>
<p><code>org.springframework.cloud.alibaba.dubbo.metadata.RequestMetadata</code>&nbsp;ï¼ŒRequest Metadata ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// RequestMetadata.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestMetadata</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ–¹æ³•å</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> String method;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * URL è·¯å¾„</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> String url;</span><br /><br /><span class="line">    <span class="keyword">private</span> Map&lt;String, Collection&lt;String&gt;&gt; queries;</span><br /><br /><span class="line">    <span class="keyword">private</span> Map&lt;String, Collection&lt;String&gt;&gt; headers;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestMetadata</span><span class="params">()</span> </span>{</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">// å°† RequestTemplate å¯¹è±¡ï¼Œè½¬æ¢æˆ RequestMetadata å¯¹è±¡</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequestMetadata</span><span class="params">(RequestTemplate requestTemplate)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.method = requestTemplate.method();</span><br /><span class="line">        <span class="keyword">this</span>.url = requestTemplate.url();</span><br /><span class="line">        <span class="keyword">this</span>.queries = requestTemplate.queries();</span><br /><span class="line">        <span class="keyword">this</span>.headers = requestTemplate.headers();</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">// ... çœç•¥ setting/getting æ–¹æ³•</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h4 id="7-1-2-3-DubboTransportedMethodMetadata">7.1.2.3 DubboTransportedMethodMetadata</h4>
<p><code>org.springframework.cloud.alibaba.dubbo.metadata.DubboTransportedMethodMetadata</code>&nbsp;ï¼Œç»§æ‰¿ MethodMetadata ç±»ï¼Œ&nbsp;<code>@DubboTransported</code>&nbsp;æ³¨è§£å¯¹åº”çš„ MethodMetadata å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboTransportedMethodMetadata.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboTransportedMethodMetadata</span> <span class="keyword">extends</span> <span class="title">MethodMetadata</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Dubbo åè®®</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> String protocol;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Dubbo å®¹é”™ç­–ç•¥</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> String cluster;</span><br /><br /><span class="line">    <span class="comment">// ... çœç•¥ setting/getting æ–¹æ³•</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="7-2-MetadataResolver">7.2 MetadataResolver</h2>
<p><code>org.springframework.cloud.alibaba.dubbo.metadata.resolver.MetadataResolver</code>&nbsp;ï¼ŒMetadata Resolver å…ƒæ•°æ®è§£æå™¨æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// MetadataResolver.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * The REST metadata resolver</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MetadataResolver</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Resolve the {<span class="doctag">@link</span> ServiceRestMetadata} {<span class="doctag">@link</span> Set set} from {<span class="doctag">@link</span> ServiceBean}</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * è§£ææŒ‡å®š ServiceBean çš„ ServiceRestMetadata é›†åˆ</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceBean {<span class="doctag">@link</span> ServiceBean}</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null {<span class="doctag">@link</span> Set}</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function">Set&lt;ServiceRestMetadata&gt; <span class="title">resolveServiceRestMetadata</span><span class="params">(ServiceBean serviceBean)</span></span>;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Resolve {<span class="doctag">@link</span> RestMethodMetadata} {<span class="doctag">@link</span> Set set} from {<span class="doctag">@link</span> Class target type}</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * è§£ææŒ‡å®šç±»çš„ ServiceRestMetadata é›†åˆ</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> targetType {<span class="doctag">@link</span> Class target type}</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null {<span class="doctag">@link</span> Set}</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function">Set&lt;RestMethodMetadata&gt; <span class="title">resolveMethodRestMetadata</span><span class="params">(Class&lt;?&gt; targetType)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="7-2-1-DubboServiceBeanMetadataResolver">7.2.1 DubboServiceBeanMetadataResolver</h3>
<blockquote>
<p>DubboServiceBeanMetadataResolver Bean å¯¹è±¡ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€Œ5.2 DubboOpenFeignAutoConfigurationã€</a>&nbsp;ä¸­è¢«åˆ›å»ºã€‚</p>
</blockquote>
<p><code>org.springframework.cloud.alibaba.dubbo.metadata.resolver.DubboServiceBeanMetadataResolver</code>&nbsp;ï¼Œå®ç° MetadataResolverã€BeanClassLoaderAwareã€SmartInitializingSingleton æ¥å£ï¼ŒåŸºäº Dubbo ServiceBean çš„ MetadataResolver å®ç°ç±»ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboServiceBeanMetadataResolver.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * The metadata resolver for {<span class="doctag">@link</span> Feign} for {<span class="doctag">@link</span> ServiceBean Dubbo Service Bean} in the provider side.</span></span><br /><span class="line"><span class="comment"> */</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h4 id="7-2-1-1-æ„é€ æ–¹æ³•">7.2.1.1 æ„é€ æ–¹æ³•</h4>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboServiceBeanMetadataResolver.java</span></span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] CONTRACT_CLASS_NAMES = {</span><br /><span class="line">        <span class="string">"feign.jaxrs2.JAXRS2Contract"</span>,</span><br /><span class="line">        <span class="string">"org.springframework.cloud.openfeign.support.SpringMvcContract"</span>,</span><br /><span class="line">};</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å½“å‰åº”ç”¨å</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * ä¸è¿‡ï¼Œç›®å‰æš‚æ—¶å¹¶æœªç”¨è¯¥å‚æ•°</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String currentApplicationName;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å½“å‰ç±»åŠ è½½å™¨</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> ClassLoader classLoader;</span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ObjectProvider&lt;Contract&gt; contract;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Feign Contract æ•°ç»„</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * https://www.jianshu.com/p/6582f8319f72</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Collection&lt;Contract&gt; contracts;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DubboServiceBeanMetadataResolver</span><span class="params">(String currentApplicationName, ObjectProvider&lt;Contract&gt; contract)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.currentApplicationName = currentApplicationName;</span><br /><span class="line">    <span class="keyword">this</span>.contract = contract;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å…·ä½“çš„æ¯ä¸ªå±æ€§ï¼Œæˆ‘ä»¬ä¸‹é¢ä¸€ä¸ªä¸€ä¸ªæ¥çœ‹ã€‚</li>
</ul>
<h4 id="7-2-1-2-afterSingletonsInstantiated">7.2.1.2 afterSingletonsInstantiated</h4>
<p>å®ç°&nbsp;<code>#afterSingletonsInstantiated()</code>&nbsp;æ–¹æ³•ï¼Œåˆå§‹åŒ–&nbsp;<code>contracts</code>&nbsp;å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboServiceBeanMetadataResolver.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterSingletonsInstantiated</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; åˆ›å»º Feign Contract æ•°ç»„</span></span><br /><span class="line">    LinkedList&lt;Contract&gt; contracts = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br /><br /><span class="line">    <span class="comment">// Add injected Contract if available, for example SpringMvcContract Bean under Spring Cloud Open Feign</span></span><br /><span class="line">    <span class="comment">// &lt;2.1&gt; å¦‚æœ contract å­˜åœ¨ï¼Œåˆ™æ·»åŠ åˆ° contracts ä¸­</span></span><br /><span class="line">    contract.ifAvailable(contracts::add);</span><br /><br /><span class="line">    <span class="comment">// &lt;2.2&gt; éå† CONTRACT_CLASS_NAMES æ•°ç»„ï¼Œåˆ›å»ºå¯¹åº”çš„ Contract å¯¹è±¡ï¼Œæ·»åŠ åˆ° contracts ä¸­</span></span><br /><span class="line">    Stream.of(CONTRACT_CLASS_NAMES)</span><br /><span class="line">            .filter(<span class="keyword">this</span>::isClassPresent) <span class="comment">// filter the existed classes</span></span><br /><span class="line">            .map(<span class="keyword">this</span>::loadContractClass) <span class="comment">// load Contract Class</span></span><br /><span class="line">            .map(<span class="keyword">this</span>::createContract)    <span class="comment">// create instance by the specified class</span></span><br /><span class="line">            .forEach(contracts::add);     <span class="comment">// add the Contract instance into contracts</span></span><br /><br /><span class="line">    <span class="comment">// &lt;3&gt; èµ‹å€¼ç»™ contracts ä¸­</span></span><br /><span class="line">    <span class="keyword">this</span>.contracts = Collections.unmodifiableCollection(contracts);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œåˆ›å»º Feign Contract æ•°ç»„&nbsp;<code>contracts</code>&nbsp;ã€‚</li>
<li><code>&lt;2.1&gt;</code>&nbsp;å¤„ï¼Œå¦‚æœ&nbsp;<code>contract</code>&nbsp;å­˜åœ¨ï¼Œåˆ™æ·»åŠ åˆ°&nbsp;<code>contracts</code>&nbsp;ä¸­ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ<code>contract</code>&nbsp;ä¸å­˜åœ¨ï¼Œæ‰€ä»¥å¯ä»¥æš‚æ—¶æ— è§†ã€‚</li>
<li>
<p><code>&lt;2.2&gt;</code>&nbsp;å¤„ï¼Œéå†&nbsp;<code>CONTRACT_CLASS_NAMES</code>&nbsp;æ•°ç»„ï¼Œåˆ›å»ºå¯¹åº”çš„ Contract å¯¹è±¡ï¼Œæ·»åŠ åˆ°&nbsp;<code>contracts</code>&nbsp;ä¸­ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œéƒ½ä¼šå­˜åœ¨ã€‚æ¶‰åŠä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboServiceBeanMetadataResolver.java</span></span><br /><br /><span class="line"><span class="comment">// åˆ¤æ–­æŒ‡å®š className ç±»æ˜¯å¦å­˜åœ¨</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isClassPresent</span><span class="params">(String className)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> ClassUtils.isPresent(className, classLoader);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">// åŠ è½½ contractClassName å¯¹åº”çš„ Contract å®ç°ç±»</span></span><br /><span class="line"><span class="keyword">private</span> Class&lt;?&gt; loadContractClass(String contractClassName) {</span><br /><span class="line">    <span class="keyword">return</span> ClassUtils.resolveClassName(contractClassName, classLoader);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">// åˆ›å»º Contract å¯¹è±¡</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> Contract <span class="title">createContract</span><span class="params">(Class&lt;?&gt; contractClassName)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> (Contract) BeanUtils.instantiateClass(contractClassName);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œèµ‹å€¼ç»™&nbsp;<code>this.contracts</code>&nbsp;ä¸­ã€‚</p>
</li>
</ul>
<h4 id="7-2-1-3-resolveMethodRestMetadata">7.2.1.3 resolveMethodRestMetadata</h4>
<p>å®ç°&nbsp;<code>#resolveMethodRestMetadata(Class&lt;?&gt; targetType)</code>&nbsp;æ–¹æ³•ï¼Œè§£ææŒ‡å®šç±»çš„ ServiceRestMetadata é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboServiceBeanMetadataResolver.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;RestMethodMetadata&gt; <span class="title">resolveMethodRestMetadata</span><span class="params">(Class&lt;?&gt; targetType)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; è·å¾— Method é›†åˆ</span></span><br /><span class="line">    List&lt;Method&gt; feignContractMethods = selectFeignContractMethods(targetType);</span><br /><span class="line">    <span class="comment">// &lt;2&gt; è½¬æ¢æˆ RestMethodMetadata é›†åˆ</span></span><br /><span class="line">    <span class="keyword">return</span> contracts.stream() <span class="comment">// éå† contracts æ•°ç»„</span></span><br /><span class="line">            .map(contract -&gt; contract.parseAndValidatateMetadata(targetType)) <span class="comment">// &lt;2.1&gt; è¿”å›ç›®æ ‡ç±»å‹çš„ Feign MethodMetadata æ•°ç»„</span></span><br /><span class="line">            .flatMap(Collection::stream)</span><br /><span class="line">            .map(methodMetadata -&gt; resolveMethodRestMetadata(methodMetadata, targetType, feignContractMethods)) <span class="comment">// &lt;2.2&gt; å°† Feign MethodMetadata è½¬æ¢æˆ RestMethodMetadata å¯¹è±¡</span></span><br /><span class="line">            .collect(Collectors.toSet()); <span class="comment">// è½¬æ¢æˆ Set</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#selectFeignContractMethods(Class&lt;?&gt; targetType)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— Method é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboServiceBeanMetadataResolver.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Select feign contract methods</span></span><br /><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br /><span class="line"><span class="comment"> * extract some code from {<span class="doctag">@link</span> Contract.BaseContract#parseAndValidatateMetadata(java.lang.Class)}</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> targetType</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> non-null</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> List&lt;Method&gt; <span class="title">selectFeignContractMethods</span><span class="params">(Class&lt;?&gt; targetType)</span> </span>{</span><br /><span class="line">    List&lt;Method&gt; methods = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br /><span class="line">    <span class="comment">// éå†ç›®æ ‡çš„æ–¹æ³•</span></span><br /><span class="line">    <span class="keyword">for</span> (Method method : targetType.getMethods()) {</span><br /><span class="line">        <span class="comment">// å¿½ç•¥</span></span><br /><span class="line">        <span class="keyword">if</span> (method.getDeclaringClass() == Object.class || <span class="comment">// Object å£°æ˜çš„æ–¹æ³•ï¼Œä¾‹å¦‚è¯´ equals æ–¹æ³•</span></span><br /><span class="line">                (method.getModifiers() &amp; Modifier.STATIC) != <span class="number">0</span> || <span class="comment">// é™æ€æ–¹æ³•</span></span><br /><span class="line">                Util.isDefault(method)) { <span class="comment">// Feign é»˜è®¤æ–¹æ³•</span></span><br /><span class="line">            <span class="keyword">continue</span>;</span><br /><span class="line">        }</span><br /><span class="line">        methods.add(method);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> methods;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œè½¬æ¢æˆ RestMethodMetadata é›†åˆã€‚</p>
</li>
<li>
<p><code>&lt;2.1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>Contract#parseAndValidatateMetadata()</code>&nbsp;æ–¹æ³•ï¼Œè¿”å›ç›®æ ‡ç±»å‹çš„ Feign MethodMetadata æ•°ç»„ã€‚è¿™å—ä»£ç å±äº Feign çš„ï¼Œæˆ‘ä»¬å…ˆä¸ç»†è°ƒï¼Œçœ‹ä¸€ä¸ªç»“æœçš„ç¤ºä¾‹ã€‚å¦‚ä¸‹å›¾ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_02_14/06.jpg" alt="ç»“æœ" /></p>
<ul>
<li>
<p>è¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œå› ä¸º&nbsp;<code>CONTRACT_CLASS_NAMES</code>&nbsp;ä¸­ï¼Œå³æœ‰ JAXRS2Contract ç±»ï¼Œåˆæœ‰ SpringMvcContract ç±»ï¼Œæ‰€ä»¥è¦æ±‚æ·»åŠ  JSR311 çš„æ³¨è§£ï¼Œä¹Ÿè¦æ·»åŠ  Spring MVC çš„æ³¨è§£ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DefaultEchoService.java</span></span><br /><br /><span class="line"><span class="meta">@Service</span>(version = <span class="string">"1.0.0"</span>, protocol = {<span class="string">"dubbo"</span>, <span class="string">"rest"</span>})</span><br /><span class="line"><span class="meta">@RestController</span> <span class="comment">// Spring MVC æ³¨è§£</span></span><br /><span class="line"><span class="meta">@Path</span>(<span class="string">"/"</span>) <span class="comment">// JSR311 æ³¨è§£</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultEchoService</span> <span class="keyword">implements</span> <span class="title">EchoService</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/echo"</span></span><br /><span class="line"><span class="comment">//            consumes = MediaType.APPLICATION_JSON_VALUE,</span></span><br /><span class="line"><span class="comment">//            produces = MediaType.APPLICATION_JSON_UTF8_VALUE</span></span><br /><span class="line">    ) <span class="comment">// Spring MVC æ³¨è§£</span></span><br /><span class="line">    <span class="meta">@Path</span>(<span class="string">"/echo"</span>) <span class="comment">// JSR311 æ³¨è§£</span></span><br /><span class="line">    <span class="meta">@GET</span> <span class="comment">// JSR311 æ³¨è§£</span></span><br /><span class="line"><span class="comment">//    @Consumes("application/json")</span></span><br /><span class="line"><span class="comment">//    @Produces("application/json;charset=UTF-8")</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">(@RequestParam // Spring MVC æ³¨è§£</span></span></span><br /><span class="line"><span class="function"><span class="params">                       @QueryParam(<span class="string">"message"</span>)</span> String message) </span>{ <span class="comment">// JSR311 æ³¨è§£</span></span><br /><span class="line">        System.out.println(message);</span><br /><span class="line">        <span class="keyword">return</span> RpcContext.getContext().getUrl() + <span class="string">" [echo] : "</span> + message;</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä¸è¿‡è‰¿è‰¿æš‚æ—¶ä¸å¤ªç†è§£ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡ã€‚æœ‰çŸ¥é“çš„èƒ–å‹ï¼Œéº»çƒ¦æ•™è‚²ä¸‹ï¼Œå˜»å˜»~</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>&lt;2.2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#resolveMethodRestMetadata(MethodMetadata methodMetadata, Class&lt;?&gt; targetType, List&lt;Method&gt; feignContractMethods)</code>&nbsp;æ–¹æ³•ï¼Œå°† Feign MethodMetadata è½¬æ¢æˆ RestMethodMetadata å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboServiceBeanMetadataResolver.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">protected</span> RestMethodMetadata <span class="title">resolveMethodRestMetadata</span><span class="params">(MethodMetadata methodMetadata, // Feign MethodMetadata</span></span></span><br /><span class="line"><span class="function"><span class="params">                                                       Class&lt;?&gt; targetType,</span></span></span><br /><span class="line"><span class="function"><span class="params">                                                       List&lt;Method&gt; feignContractMethods)</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾— configKey ã€‚ä¾‹å¦‚è¯´ï¼šDefaultEchoService#echo(String)</span></span><br /><span class="line">    String configKey = methodMetadata.configKey();</span><br /><span class="line">    <span class="comment">// è·å¾—åŒ¹é…çš„ Method</span></span><br /><span class="line">    Method feignContractMethod = getMatchedFeignContractMethod(targetType, feignContractMethods, configKey);</span><br /><span class="line">    <span class="comment">// åˆ›å»º RestMethodMetadata å¯¹è±¡ï¼Œå¹¶è®¾ç½®å…¶å±æ€§</span></span><br /><span class="line">    RestMethodMetadata metadata = <span class="keyword">new</span> RestMethodMetadata();</span><br /><span class="line">    metadata.setRequest(<span class="keyword">new</span> RequestMetadata(methodMetadata.template()));</span><br /><span class="line">    metadata.setMethod(<span class="keyword">new</span> org.springframework.cloud.alibaba.dubbo.metadata.MethodMetadata(feignContractMethod));</span><br /><span class="line">    metadata.setIndexToName(methodMetadata.indexToName());</span><br /><span class="line">    <span class="keyword">return</span> metadata;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Method <span class="title">getMatchedFeignContractMethod</span><span class="params">(Class&lt;?&gt; targetType, List&lt;Method&gt; methods, String expectedConfigKey)</span> </span>{</span><br /><span class="line">    Method matchedMethod = <span class="keyword">null</span>;</span><br /><span class="line">    <span class="comment">// éå† Method é›†åˆ</span></span><br /><span class="line">    <span class="keyword">for</span> (Method method : methods) {</span><br /><span class="line">        <span class="comment">// è·å¾—è¯¥æ–¹æ³•çš„ configKey</span></span><br /><span class="line">        String configKey = Feign.configKey(targetType, method);</span><br /><span class="line">        <span class="comment">// å¦‚æœç›¸ç­‰ï¼Œåˆ™è¿›è¡Œè¿”å›ã€‚</span></span><br /><span class="line">        <span class="keyword">if</span> (expectedConfigKey.equals(configKey)) {</span><br /><span class="line">            matchedMethod = method;</span><br /><span class="line">            <span class="keyword">break</span>;</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> matchedMethod;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¯¹è±¡è½¬æ¢çš„ä»£ç ï¼Œç®€å•ç…ç…å³å¯æ˜ç™½ã€‚</li>
</ul>
</li>
</ul>
<h4 id="7-2-1-4-resolveServiceRestMetadata">7.2.1.4 resolveServiceRestMetadata</h4>
<p>å®ç°&nbsp;<code>#resolveServiceRestMetadata(ServiceBean serviceBean)</code>&nbsp;æ–¹æ³•ï¼Œè§£ææŒ‡å®š ServiceBean çš„ ServiceRestMetadata é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboServiceBeanMetadataResolver.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;ServiceRestMetadata&gt; <span class="title">resolveServiceRestMetadata</span><span class="params">(ServiceBean serviceBean)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1.1&gt; è·å¾—åº”ç”¨çš„ Bean å¯¹è±¡</span></span><br /><span class="line">    Object bean = serviceBean.getRef();</span><br /><span class="line">    <span class="comment">// &lt;1.2&gt; è·å¾— Bean ç±»å‹</span></span><br /><span class="line">    Class&lt;?&gt; beanType = bean.getClass();</span><br /><span class="line">    <span class="comment">// &lt;1.3&gt; è§£æ Bean ç±»å‹å¯¹åº”çš„ RestMethodMetadata é›†åˆ</span></span><br /><span class="line">    Set&lt;RestMethodMetadata&gt; methodRestMetadata = resolveMethodRestMetadata(beanType);</span><br /><br /><span class="line">    <span class="comment">// &lt;2.1&gt; åˆ›å»º ServiceRestMetadata æ•°ç»„</span></span><br /><span class="line">    Set&lt;ServiceRestMetadata&gt; serviceRestMetadata = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br /><span class="line">    <span class="comment">// &lt;2.2&gt; è·å¾— ServiceBean æš´éœ²çš„ URL é›†åˆ</span></span><br /><span class="line">    List&lt;URL&gt; urls = serviceBean.getExportedUrls();</span><br /><span class="line">    <span class="comment">// &lt;2.3&gt; éå† URL é›†åˆï¼Œå°† RestMethodMetadata é›†åˆï¼Œå°è£…æˆ ServiceRestMetadata å¯¹è±¡ï¼Œç„¶åæ·»åŠ åˆ° serviceRestMetadata ä¸­ï¼Œæœ€åè¿”å›ã€‚</span></span><br /><span class="line">    urls.stream()</span><br /><span class="line">            .map(SpringCloudRegistry::getServiceName)</span><br /><span class="line">            .forEach(serviceName -&gt; {</span><br /><span class="line">                ServiceRestMetadata metadata = <span class="keyword">new</span> ServiceRestMetadata();</span><br /><span class="line">                metadata.setName(serviceName);</span><br /><span class="line">                metadata.setMeta(methodRestMetadata);</span><br /><span class="line">                serviceRestMetadata.add(metadata);</span><br /><span class="line">            });</span><br /><span class="line">    <span class="keyword">return</span> serviceRestMetadata;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1.3&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#resolveMethodRestMetadata(Class&lt;?&gt; targetType)</code>&nbsp;æ–¹æ³•ï¼Œè§£æ Bean ç±»å‹å¯¹åº”çš„ RestMethodMetadata é›†åˆã€‚å³ï¼Œæˆ‘ä»¬åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€Œ7.2.1.3 resolveMethodRestMetadataã€</a>&nbsp;è§£æçš„æ–¹æ³•ã€‚</li>
<li><code>&lt;2.1&gt;</code>&nbsp;å¤„ï¼Œè·å¾— ServiceBean æš´éœ²çš„ URL é›†åˆã€‚ä¾‹å¦‚è¯´ï¼Œæœ¬æ–‡çš„ DefaultEchoService ç¤ºä¾‹ï¼Œå°±æš´éœ²äº†&nbsp;<code>dubbo://</code>å’Œ&nbsp;<code>rest://</code>&nbsp;ä¸¤ç§åè®®çš„ URL ã€‚</li>
<li><code>&lt;2.3&gt;</code>&nbsp;å¤„ï¼Œéå† URL é›†åˆï¼Œå°† RestMethodMetadata é›†åˆï¼Œå°è£…æˆ ServiceRestMetadata å¯¹è±¡ï¼Œç„¶åæ·»åŠ åˆ° serviceRestMetadata ä¸­ï¼Œæœ€åè¿”å›ã€‚æ­¤å¤„çš„&nbsp;<code>SpringCloudRegistry::getServiceName</code>&nbsp;ä»£ç æ®µï¼Œå°±æ˜¯è°ƒç”¨&nbsp;<code>SpringCloudRegistry#getServiceName(URL url)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— Dubbo æœåŠ¡åã€‚ä¾‹å¦‚è¯´ï¼š<code>providers:dubbo:org.springframework.cloud.alibaba.dubbo.service.EchoService:1.0.0</code>&nbsp;ã€‚</li>
</ul>
<p>è‡³æ­¤ï¼ŒDubbo Service å…ƒæ•°æ®çš„è§£æï¼Œå°±å·²ç»å®Œæˆäº†ã€‚åç»­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ä¸¤ä¸ªæ–¹é¢çš„å†…å®¹ï¼š</p>
<ul>
<li>1ã€å°†å…ƒæ•°æ®å­˜å‚¨åˆ°é…ç½®ä¸­å¿ƒã€‚è¿™æ ·ï¼ŒæœåŠ¡æ¶ˆè´¹è€…æ‰èƒ½å…±äº«åˆ°è¯¥éƒ¨åˆ†çš„æ•°æ®ã€‚</li>
<li>2ã€æœåŠ¡æ¶ˆè´¹è€…åŸºäº Dubbo Service å…ƒæ•°æ®ï¼Œå¯ä»¥ä½¿ç”¨ Dubbo å‘èµ·æ³›åŒ–è°ƒç”¨ã€‚</li>
</ul>
<p>å½“ç„¶ï¼Œå¦‚æœä¸ä½¿ç”¨ Dubbo å‘èµ·æ³›åŒ–è°ƒç”¨ï¼Œæ˜¯ä¸éœ€è¦è¿™éƒ¨åˆ† Dubbo Service å…ƒæ•°æ®çš„ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿèƒ–å‹å¥½å¥½æ€è€ƒä¸€æ³¢~</p>
<h2 id="7-3-DubboTransportedMethodMetadataResolver">7.3 DubboTransportedMethodMetadataResolver</h2>
<p><code>org.springframework.cloud.alibaba.dubbo.metadata.resolver.DubboTransportedMethodMetadataResolver</code>&nbsp;ï¼Œè§£æ&nbsp;<code>@DubboTransported</code>&nbsp;æ³¨è§£çš„ MethodMetadata æ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboTransportedMethodMetadataResolver.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;DubboTransportedMethodMetadata, RequestMetadata&gt; <span class="title">resolve</span><span class="params">(Class&lt;?&gt; targetType)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; è·å¾—æŒ‡å®šç±»çš„ DubboTransportedMethodMetadata é›†åˆ</span></span><br /><span class="line">    Set&lt;DubboTransportedMethodMetadata&gt; dubboTransportedMethodMetadataSet = resolveDubboTransportedMethodMetadataSet(targetType);</span><br /><span class="line">    <span class="comment">// &lt;2&gt; è·å¾—æŒ‡å®šç±»çš„ RequestMetadata æ˜ å°„ã€‚å…¶ä¸­ï¼ŒKEY ä¸º configKey</span></span><br /><span class="line">    Map&lt;String, RequestMetadata&gt; requestMetadataMap = resolveRequestMetadataMap(targetType);</span><br /><span class="line">    <span class="comment">// &lt;3&gt; è½¬æ¢æˆ DubboTransportedMethodMetadata å’Œ RequestMetadata çš„æ˜ å°„</span></span><br /><span class="line">    <span class="keyword">return</span> dubboTransportedMethodMetadataSet</span><br /><span class="line">            .stream()</span><br /><span class="line">            .collect(Collectors.toMap(methodMetadata -&gt; methodMetadata, methodMetadata -&gt;</span><br /><span class="line">                    requestMetadataMap.get(Feign.configKey(targetType, methodMetadata.getMethod()))</span><br /><span class="line">            ));</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#resolveDubboTransportedMethodMetadataSet(Class&lt;?&gt; targetType)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šç±»çš„ DubboTransportedMethodMetadata é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboTransportedMethodMetadataResolver.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">protected</span> Set&lt;DubboTransportedMethodMetadata&gt; <span class="title">resolveDubboTransportedMethodMetadataSet</span><span class="params">(Class&lt;?&gt; targetType)</span> </span>{</span><br /><span class="line">    <span class="comment">// The public methods of target interface</span></span><br /><span class="line">    Method[] methods = targetType.getMethods();</span><br /><span class="line">    <span class="comment">// åˆ›å»º DubboTransportedMethodMetadata æ•°ç»„</span></span><br /><span class="line">    Set&lt;DubboTransportedMethodMetadata&gt; methodMetadataSet = <span class="keyword">new</span> LinkedHashSet&lt;&gt;();</span><br /><span class="line">    <span class="comment">// éå†æ–¹æ³•</span></span><br /><span class="line">    <span class="keyword">for</span> (Method method : methods) {</span><br /><span class="line">        <span class="comment">// å¦‚æœæœ‰ @DubboTransported æ³¨è§£</span></span><br /><span class="line">        DubboTransported dubboTransported = resolveDubboTransported(method); <span class="comment">// â‘ </span></span><br /><span class="line">        <span class="comment">// å¦‚æœæœ‰ï¼Œåˆ™åˆ›å»ºæˆ  DubboTransportedMethodMetadata å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ° methodMetadataSet ä¸­</span></span><br /><span class="line">        <span class="keyword">if</span> (dubboTransported != <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="comment">// åˆ›å»º â‘¡</span></span><br /><span class="line">            DubboTransportedMethodMetadata methodMetadata = createDubboTransportedMethodMetadata(method, dubboTransported);</span><br /><span class="line">            <span class="comment">// æ·»åŠ </span></span><br /><span class="line">            methodMetadataSet.add(methodMetadata);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> methodMetadataSet;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">// â‘ </span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> DubboTransported <span class="title">resolveDubboTransported</span><span class="params">(Method method)</span> </span>{</span><br /><span class="line">    <span class="comment">// å…ˆä»æ–¹æ³•ä¸Šï¼Œè·å¾— @DubboTransported æ³¨è§£</span></span><br /><span class="line">    DubboTransported dubboTransported = AnnotationUtils.findAnnotation(method, DUBBO_TRANSPORTED_CLASS);</span><br /><span class="line">    <span class="comment">// å¦‚æœè·å¾—ä¸åˆ°ï¼Œåˆ™ä»ç±»ä¸Šï¼Œè·å¾— @DubboTransported æ³¨è§£</span></span><br /><span class="line">    <span class="keyword">if</span> (dubboTransported == <span class="keyword">null</span>) { <span class="comment">// Attempt to find @DubboTransported in the declaring class</span></span><br /><span class="line">        Class&lt;?&gt; declaringClass = method.getDeclaringClass();</span><br /><span class="line">        dubboTransported = AnnotationUtils.findAnnotation(declaringClass, DUBBO_TRANSPORTED_CLASS);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> dubboTransported;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">// â‘¡</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> DubboTransportedMethodMetadata <span class="title">createDubboTransportedMethodMetadata</span><span class="params">(Method method, DubboTransported dubboTransported)</span> </span>{</span><br /><span class="line">    <span class="comment">// åˆ›å»º DubboTransportedMethodMetadata å¯¹è±¡</span></span><br /><span class="line">    DubboTransportedMethodMetadata methodMetadata = <span class="keyword">new</span> DubboTransportedMethodMetadata(method);</span><br /><span class="line">   <span class="comment">// è§£æå±æ€§ï¼Œå¹¶è®¾ç½®åˆ° methodMetadata ä¸­</span></span><br /><span class="line">    String protocol = propertyResolver.resolvePlaceholders(dubboTransported.protocol());</span><br /><span class="line">    String cluster = propertyResolver.resolvePlaceholders(dubboTransported.cluster());</span><br /><span class="line">    methodMetadata.setProtocol(protocol);</span><br /><span class="line">    methodMetadata.setCluster(cluster);</span><br /><span class="line">    <span class="keyword">return</span> methodMetadata;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#resolveRequestMetadataMap(Class&lt;?&gt; targetType)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šç±»çš„ RequestMetadata æ˜ å°„ã€‚å…¶ä¸­ï¼ŒKEY ä¸º&nbsp;<code>configKey</code>&nbsp;ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboTransportedMethodMetadataResolver.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, RequestMetadata&gt; <span class="title">resolveRequestMetadataMap</span><span class="params">(Class&lt;?&gt; targetType)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> contract.parseAndValidatateMetadata(targetType) <span class="comment">// è·å¾—æŒ‡å®šç±»çš„ Feign MethodMetadata é›†åˆ</span></span><br /><span class="line">            .stream().collect(Collectors.toMap(feign.MethodMetadata::configKey, <span class="keyword">this</span>::requestMetadata)); <span class="comment">// åˆ›å»º RequestMetadata å¯¹è±¡</span></span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> RequestMetadata <span class="title">requestMetadata</span><span class="params">(feign.MethodMetadata methodMetadata)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RequestMetadata(methodMetadata.template());</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œè½¬æ¢æˆ DubboTransportedMethodMetadata å’Œ RequestMetadata çš„æ˜ å°„ã€‚</p>
</li>
</ul>
<p>åç»­ï¼Œè¿™ä¸ªç±»ä¼šè¢«&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€Œ8.1 TargeterInvocationHandlerã€</a>&nbsp;æ‰€è°ƒç”¨ ã€‚</p>
<h2 id="7-4-MetadataConfigService">7.4 MetadataConfigService</h2>
<blockquote>
<p>ç»™æœåŠ¡æä¾›è€…ä½¿ç”¨ã€‚</p>
</blockquote>
<p><code>org.springframework.cloud.alibaba.dubbo.metadata.service.MetadataConfigService</code>&nbsp;ï¼Œå…ƒæ•°æ®é…ç½®æœåŠ¡æ¥å£ï¼Œå³å¯ä»¥ä»é…ç½®ä¸­å¿ƒï¼Œè¯»å–å’Œå†™å…¥å…ƒæ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// MetadataConfigService.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MetadataConfigService</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * å‘å¸ƒæŒ‡å®šæœåŠ¡çš„ Rest å…ƒæ•°æ®</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceName æœåŠ¡å</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceRestMetadata ServiceRestMetadata é›†åˆ</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">publishServiceRestMetadata</span><span class="params">(String serviceName, Set&lt;ServiceRestMetadata&gt; serviceRestMetadata)</span></span>;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * è·å¾—æŒ‡å®šæœåŠ¡çš„ Rest å…ƒæ•°æ®</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceName æœåŠ¡å</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> ServiceRestMetadata é›†åˆ</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function">Set&lt;ServiceRestMetadata&gt; <span class="title">getServiceRestMetadata</span><span class="params">(String serviceName)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="7-4-1-NacosMetadataConfigService">7.4.1 NacosMetadataConfigService</h3>
<p><code>org.springframework.cloud.alibaba.dubbo.metadata.service.NacosMetadataConfigService</code>&nbsp;ï¼Œå®ç° MetadataConfigService æ¥å£ï¼ŒåŸºäº Nacos ä½œä¸ºé…ç½®ä¸­å¿ƒçš„å®ç°ç±»ã€‚</p>
<h4 id="7-4-1-1-æ„é€ æ–¹æ³•">7.4.1.1 æ„é€ æ–¹æ³•</h4>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// NacosMetadataConfigService.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ObjectMapper ï¼Œä½¿ç”¨ Jackson åºåˆ—åŒ–å’Œååºåˆ—åŒ–</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * NacosConfigProperties å¯¹è±¡ï¼Œç”¨äºè·å¾— {<span class="doctag">@link</span> #configService}</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="meta">@Autowired</span></span><br /><span class="line"><span class="keyword">private</span> NacosConfigProperties nacosConfigProperties;</span><br /><br /><span class="line"><span class="keyword">private</span> ConfigService configService;</span><br /><br /><span class="line"><span class="meta">@PostConstruct</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// åˆå§‹åŒ– configService å±æ€§</span></span><br /><span class="line">    <span class="keyword">this</span>.configService = nacosConfigProperties.configServiceInstance();</span><br /><span class="line">    <span class="comment">// å¼€å¯ JSON æ ¼å¼åŒ–</span></span><br /><span class="line">    <span class="keyword">this</span>.objectMapper.enable(SerializationFeature.INDENT_OUTPUT);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h4 id="7-4-1-2-publishServiceRestMetadata">7.4.1.2 publishServiceRestMetadata</h4>
<p>å®ç°&nbsp;<code>#publishServiceRestMetadata(String serviceName, Set&lt;ServiceRestMetadata&gt; serviceRestMetadata)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// NacosMetadataConfigService.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">publishServiceRestMetadata</span><span class="params">(String serviceName, Set&lt;ServiceRestMetadata&gt; serviceRestMetadata)</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾— Nacos dataId â‘ </span></span><br /><span class="line">    String dataId = getServiceRestMetadataDataId(serviceName);</span><br /><span class="line">    <span class="comment">// å°† ServiceRestMetadata é›†åˆåºåˆ—åŒ–æˆ json å­—ç¬¦ä¸² â‘¡</span></span><br /><span class="line">    String json = writeValueAsString(serviceRestMetadata);</span><br /><span class="line">    <span class="comment">// å†™å…¥åˆ° Nacos é…ç½®ä¸­å¿ƒ</span></span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        configService.publishConfig(dataId, DEFAULT_GROUP, json);</span><br /><span class="line">    } <span class="keyword">catch</span> (NacosException e) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br /><span class="line">    }</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Get the data Id of service rest metadata</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getServiceRestMetadataDataId</span><span class="params">(String serviceName)</span> </span>{ <span class="comment">// â‘ </span></span><br /><span class="line">    <span class="keyword">return</span> <span class="string">"metadata:rest:"</span> + serviceName + <span class="string">".json"</span>;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">writeValueAsString</span><span class="params">(Object object)</span> </span>{ <span class="comment">// â‘¡</span></span><br /><span class="line">    String content;</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        content = objectMapper.writeValueAsString(object);</span><br /><span class="line">    } <span class="keyword">catch</span> (JsonProcessingException e) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> content;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h4 id="7-4-1-3-getServiceRestMetadata">7.4.1.3 getServiceRestMetadata</h4>
<p>å®ç°&nbsp;<code>#getServiceRestMetadata(String serviceName)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// NacosMetadataConfigService.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> Set&lt;ServiceRestMetadata&gt; <span class="title">getServiceRestMetadata</span><span class="params">(String serviceName)</span> </span>{</span><br /><span class="line">    Set&lt;ServiceRestMetadata&gt; metadata;</span><br /><span class="line">    <span class="comment">// è·å¾— Nacos dataId</span></span><br /><span class="line">    String dataId = getServiceRestMetadataDataId(serviceName);</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="comment">// ä» Nacos é…ç½®ä¸­å¿ƒï¼Œè¯»å– json å­—ç¬¦ä¸²</span></span><br /><span class="line">        String json = configService.getConfig(dataId, DEFAULT_GROUP, <span class="number">1000</span> * <span class="number">3</span>);</span><br /><span class="line">        <span class="comment">// å°† json å­—ç¬¦ä¸²ï¼Œååºåˆ—åŒ–æˆ ServiceRestMetadata é›†åˆ</span></span><br /><span class="line">        metadata = objectMapper.readValue(json, TypeFactory.defaultInstance().constructCollectionType(LinkedHashSet.class, ServiceRestMetadata.class));</span><br /><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> metadata;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="7-5-DubboServiceMetadataRepository">7.5 DubboServiceMetadataRepository</h2>
<blockquote>
<p>ç»™æœåŠ¡æ¶ˆè´¹è€…ä½¿ç”¨ã€‚</p>
</blockquote>
<p><code>org.springframework.cloud.alibaba.dubbo.metadata.repository.DubboServiceMetadataRepository</code>&nbsp;ï¼ŒDubbo Service Metadata ä»“åº“ã€‚é€šè¿‡è¯¥ç±»ï¼ŒæœåŠ¡æ¶ˆè´¹è€…å°±å¯ä»¥è·å¾—æ¯ä¸ªå¯¹åº” Dubbo æœåŠ¡çš„ ReferenceBean å¯¹è±¡~</p>
<h3 id="7-5-1-æ„é€ æ–¹æ³•">7.5.1 æ„é€ æ–¹æ³•</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboServiceMetadataRepository.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * RequestMetadata å’Œ ReferenceBean çš„æ˜ å°„</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Key is application name</span></span><br /><span class="line"><span class="comment"> * Value is  Map&lt;RequestMetadata, ReferenceBean&lt;GenericService&gt;&gt;</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Map&lt;String, Map&lt;RequestMetadata, ReferenceBean&lt;GenericService&gt;&gt;&gt; referenceBeansRepository = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * RequestMetadata å’Œ MethodMetadata çš„æ˜ å°„</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Key is application name</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Map&lt;String, Map&lt;RequestMetadata, MethodMetadata&gt;&gt; methodMetadataRepository = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br /><br /><span class="line"><span class="meta">@Autowired</span></span><br /><span class="line"><span class="keyword">private</span> MetadataConfigService metadataConfigService;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>çœ‹çœ‹æ¯ä¸ªå±æ€§ä¸Šçš„æ³¨é‡Šå“Ÿã€‚</li>
<li>æœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œ<code>Key is application name</code>&nbsp;ï¼Œè¡¨ç¤ºé¦–ä¸ª KEY æ˜¯ Spring Cloudï¼ˆSpring Bootï¼‰åº”ç”¨åã€‚
<ul>
<li>ä½†æ˜¯ï¼Œä¸€ä¸ª Dubbo åº”ç”¨ä¸­ï¼Œå¯ä»¥æœ‰å¤šä¸ª Dubbo Service ï¼Œæ‰€ä»¥ï¼Œå°±æœ‰äº†ç¬¬äºŒä¸ª Map ï¼Œä¾‹å¦‚&nbsp;<code>Map&lt;RequestMetadata, ReferenceBean&lt;GenericService&gt;</code>&nbsp;ã€‚</li>
<li>å½“ç„¶ï¼Œæ­¤å¤„æ˜¯æŒ‰ç…§ RequestMetadata ä¸ºç»´åº¦ï¼Œå³æ¯ä¸ª Dubbo Service æ–¹æ³•å¯¹åº”çš„è¯·æ±‚ä¿¡æ¯ã€‚å› ä¸ºï¼Œæ¯ä¸ªè¯·æ±‚è·¯å¾„çš„ URL æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥è¿™ä¹ˆåšæ˜¯ OK çš„ã€‚ç›¸å½“äºè¯´ï¼ŒæŠŠæ¯ä¸ª Dubbo Service çš„æ–¹æ³•ï¼Œå¹³é“ºå¼€ã€‚</li>
</ul>
</li>
</ul>
<h3 id="7-5-2-updateMetadata">7.5.2 updateMetadata</h3>
<p><code>#updateMetadata(String serviceName)</code>&nbsp;æ–¹æ³•ï¼Œåˆå§‹åŒ–æŒ‡å®š&nbsp;<code>serviceName</code>&nbsp;çš„å…ƒæ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboServiceMetadataRepository.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateMetadata</span><span class="params">(String serviceName)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1.1&gt; è·å¾— serviceName å¯¹åº”çš„ RequestMetadata å’Œ ReferenceBean çš„æ˜ å°„</span></span><br /><span class="line">    Map&lt;RequestMetadata, ReferenceBean&lt;GenericService&gt;&gt; genericServicesMap = referenceBeansRepository.computeIfAbsent(serviceName, k -&gt; <span class="keyword">new</span> HashMap&lt;&gt;());</span><br /><span class="line">    <span class="comment">// &lt;1.2&gt; è·å¾— serviceName å¯¹åº”çš„ RequestMetadata å’Œ MethodMetadata çš„æ˜ å°„</span></span><br /><span class="line">    Map&lt;RequestMetadata, MethodMetadata&gt; methodMetadataMap = methodMetadataRepository.computeIfAbsent(serviceName, k -&gt; <span class="keyword">new</span> HashMap&lt;&gt;());</span><br /><span class="line">    <span class="comment">// &lt;1.3&gt; è·å¾— serviceName å¯¹åº”çš„  ServiceRestMetadata é›†åˆ</span></span><br /><span class="line">    Set&lt;ServiceRestMetadata&gt; serviceRestMetadataSet = metadataConfigService.getServiceRestMetadata(serviceName);</span><br /><br /><span class="line">    <span class="comment">// &lt;2&gt; éå† ServiceRestMetadata é›†åˆï¼Œåˆ›å»ºå¯¹åº”çš„ ReferenceBean ï¼Œè·å¾—å¯¹åº”çš„ MethodMetadata å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">for</span> (ServiceRestMetadata serviceRestMetadata : serviceRestMetadataSet) {</span><br /><span class="line">        <span class="comment">// &lt;2.1&gt; åˆ›å»ºå¯¹åº”çš„ ReferenceBean</span></span><br /><span class="line">        ReferenceBean&lt;GenericService&gt; referenceBean = adaptReferenceBean(serviceRestMetadata);</span><br /><span class="line">        <span class="comment">// &lt;2.2&gt; éå† RestMethodMetadata é›†åˆï¼Œæ·»åŠ åˆ° genericServicesMap å’Œ methodMetadataMap ä¸­ï¼Œè¿›è¡Œç¼“å­˜</span></span><br /><span class="line">        serviceRestMetadata.getMeta().forEach(restMethodMetadata -&gt; {</span><br /><span class="line">            RequestMetadata requestMetadata = restMethodMetadata.getRequest();</span><br /><span class="line">            genericServicesMap.put(requestMetadata, referenceBean);</span><br /><span class="line">            methodMetadataMap.put(requestMetadata, restMethodMetadata.getMethod());</span><br /><span class="line">        });</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1.3&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>MetadataConfigService#getServiceRestMetadata(String serviceName)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æŒ‡å®š&nbsp;<code>serviceName</code>&nbsp;çš„ ServiceRestMetadata é›†åˆã€‚æ­¤å¤„ï¼Œæˆ‘ä»¬å°±ä½¿ç”¨ä¸Šäº†&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€Œ7.4 MetadataConfigServiceã€</a>ã€‚</li>
<li>
<p><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œéå† ServiceRestMetadata é›†åˆï¼Œåˆ›å»ºå¯¹åº”çš„ ReferenceBean ï¼Œè·å¾—å¯¹åº”çš„ MethodMetadata å¯¹è±¡ã€‚</p>
<ul>
<li>
<p><code>&lt;2.1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#adaptReferenceBean(ServiceRestMetadata serviceRestMetadata)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º ReferenceBean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboServiceMetadataRepository.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> ReferenceBean&lt;GenericService&gt; <span class="title">adaptReferenceBean</span><span class="params">(ServiceRestMetadata serviceRestMetadata)</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾—ç›¸åº”çš„å±æ€§</span></span><br /><span class="line">    String dubboServiceName = serviceRestMetadata.getName();</span><br /><span class="line">    String[] segments = SpringCloudRegistry.getServiceSegments(dubboServiceName);</span><br /><span class="line">    String interfaceName = SpringCloudRegistry.getServiceInterface(segments);</span><br /><span class="line">    String version = SpringCloudRegistry.getServiceVersion(segments);</span><br /><span class="line">    String group = SpringCloudRegistry.getServiceGroup(segments);</span><br /><br /><span class="line">    <span class="comment">// åˆ›å»º ReferenceBean å¯¹è±¡ï¼Œå¹¶è®¾ç½®ç›¸å…³å±æ€§</span></span><br /><span class="line">    ReferenceBean&lt;GenericService&gt; referenceBean = <span class="keyword">new</span> ReferenceBean&lt;GenericService&gt;();</span><br /><span class="line">    referenceBean.setGeneric(<span class="keyword">true</span>);</span><br /><span class="line">    referenceBean.setInterface(interfaceName);</span><br /><span class="line">    referenceBean.setVersion(version);</span><br /><span class="line">    referenceBean.setGroup(group);</span><br /><span class="line">    <span class="keyword">return</span> referenceBean;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ³¨æ„å“¦ï¼Œæ­¤æ—¶åˆ›å»ºçš„ ReferenceBean æ˜¯ Dubbo çš„æ³›åŒ–å¼•ç”¨ã€‚</li>
</ul>
</li>
<li><code>&lt;2.2&gt;</code>&nbsp;å¤„ï¼Œéå† RestMethodMetadata é›†åˆï¼Œæ·»åŠ åˆ°&nbsp;<code>genericServicesMap</code>&nbsp;å’Œ&nbsp;<code>methodMetadataMap</code>ä¸­ï¼Œè¿›è¡Œç¼“å­˜ã€‚</li>
</ul>
</li>
</ul>
<h3 id="7-5-3-getReferenceBean">7.5.3 getReferenceBean</h3>
<p><code>#getReferenceBean(String serviceName, RequestMetadata requestMetadata)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šåº”ç”¨çš„æŒ‡å®š RequestMetadata å¯¹åº”çš„ ReferenceBean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> ReferenceBean&lt;GenericService&gt; <span class="title">getReferenceBean</span><span class="params">(String serviceName, RequestMetadata requestMetadata)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> getReferenceBeansMap(serviceName).get(requestMetadata);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="keyword">private</span> Map&lt;RequestMetadata, ReferenceBean&lt;GenericService&gt;&gt; getReferenceBeansMap(String serviceName) {</span><br /><span class="line">    <span class="keyword">return</span> referenceBeansRepository.getOrDefault(serviceName, Collections.emptyMap());</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="7-5-4-getMethodMetadata">7.5.4 getMethodMetadata</h3>
<p><code>#getMethodMetadata(String serviceName, RequestMetadata requestMetadata)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šåº”ç”¨çš„æŒ‡å®š RequestMetadata å¯¹åº”çš„ MethodMetadata å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboServiceMetadataRepository.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> MethodMetadata <span class="title">getMethodMetadata</span><span class="params">(String serviceName, RequestMetadata requestMetadata)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> getMethodMetadataMap(serviceName).get(requestMetadata);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Map&lt;RequestMetadata, MethodMetadata&gt; <span class="title">getMethodMetadataMap</span><span class="params">(String serviceName)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> methodMetadataRepository.getOrDefault(serviceName, Collections.emptyMap());</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="7-6-å°ç»“">7.6 å°ç»“</h2>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬çœ‹å®Œäº†&nbsp;<code>metadata</code>&nbsp;åŒ…ä¸‹çš„æ‰€æœ‰ä»£ç ã€‚å› ä¸ºæœ¬å°èŠ‚æ›´å¤šæ˜¯å…ƒæ•°æ®çš„è§£æã€å­˜å‚¨ã€è¯»å–ï¼Œä¸æ¶‰åŠåˆ°å…·ä½“çš„ä½¿ç”¨ï¼Œæ‰€ä»¥ä¼šç•¥å¾®æœ‰ç‚¹æ‡µé€¼ã€‚ä½†æ˜¯ï¼Œåˆ°ä¸‹ä¸€èŠ‚&nbsp;<code>openfeign</code>&nbsp;åï¼ŒFeign é€šè¿‡æ³›åŒ–è°ƒç”¨å¯¹åº”çš„ Dubbo æœåŠ¡ï¼Œå°±ä¼šä½¿ç”¨ä¸Šå…ƒæ•°æ®äº†ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠæ•´ä¸ªæµç¨‹æ‰“é€šã€‚</p>
<h1 id="8-openfeign-åŒ…">8.&nbsp;<code>openfeign</code>&nbsp;åŒ…</h1>
<p>æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬æ¥ç…ç…ï¼ŒDubbo æ˜¯å¦‚ä½•å’Œ Feign è¿›è¡Œé›†æˆçš„ã€‚</p>
<h2 id="8-1-TargeterBeanPostProcessor">8.1 TargeterBeanPostProcessor</h2>
<p><code>org.springframework.cloud.alibaba.dubbo.openfeign.TargeterBeanPostProcessor</code>&nbsp;ï¼Œå®ç° BeanPostProcessorã€BeanClassLoaderAware æ¥å£ï¼Œå¤„ç†ç±»å‹ä¸º openfeign Targeter çš„ Bean ï¼Œåˆ›å»ºå…¶åŠ¨æ€ä»£ç†ï¼Œä»è€Œèƒ½å¤Ÿå°† Dubbo é›†æˆåˆ° Openfeign ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// TargeterBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TargeterBeanPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span>, <span class="title">BeanClassLoaderAware</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TARGETER_CLASS_NAME = <span class="string">"org.springframework.cloud.openfeign.Targeter"</span>;</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Environment environment;</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DubboServiceMetadataRepository dubboServiceMetadataRepository;</span><br /><br /><span class="line">    <span class="keyword">private</span> ClassLoader classLoader;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TargeterBeanPostProcessor</span><span class="params">(Environment environment, DubboServiceMetadataRepository dubboServiceMetadataRepository)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.environment = environment;</span><br /><span class="line">        <span class="keyword">this</span>.dubboServiceMetadataRepository = dubboServiceMetadataRepository;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>{</span><br /><span class="line">        <span class="keyword">return</span> bean;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(<span class="keyword">final</span> Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>{</span><br /><span class="line">        <span class="comment">// &lt;1&gt; è·å¾— Bean çš„ç±»</span></span><br /><span class="line">        Class&lt;?&gt; beanClass = ClassUtils.getUserClass(bean.getClass());</span><br /><span class="line">        <span class="comment">// &lt;2&gt; è·å¾— openfeign Targeter æ¥å£</span></span><br /><span class="line">        Class&lt;?&gt; targetClass = ClassUtils.resolveClassName(TARGETER_CLASS_NAME, classLoader);</span><br /><span class="line">        <span class="comment">// &lt;3&gt; å¦‚æœå®ç° openfeign Targeter æ¥å£ï¼Œåˆ™åˆ›å»ºåŠ¨æ€ä»£ç†</span></span><br /><span class="line">        <span class="keyword">if</span> (targetClass.isAssignableFrom(beanClass)) {</span><br /><span class="line">            <span class="keyword">return</span> Proxy.newProxyInstance(classLoader, <span class="keyword">new</span> Class[]{targetClass},</span><br /><span class="line">                    <span class="keyword">new</span> TargeterInvocationHandler(bean, environment, dubboServiceMetadataRepository));</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span> bean;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanClassLoader</span><span class="params">(ClassLoader classLoader)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.classLoader = classLoader;</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>åœ¨åˆ†æå…·ä½“ä»£ç ä¹‹å‰ï¼Œèƒ–å‹å…ˆçœ‹ä¸‹&nbsp;<a href="https://cloud.tencent.com/developer/article/1378733" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠSpring Cloud Alibaba Sentinel æ•´åˆ Feign çš„è®¾è®¡å®ç°ã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€ŒFeign çš„æ‰§è¡Œè¿‡ç¨‹ã€</a>&nbsp;å°èŠ‚ã€‚å› ä¸ºè‰¿è‰¿çœ‹çš„æ—¶å€™ä¹Ÿä¸æ˜¯å¾ˆäº†è§£ Feign çš„å†…éƒ¨è¿è½¬æœºåˆ¶ï¼Œä¹Ÿæ˜¯å‚è€ƒè¿™ä¸ªå°èŠ‚è¯»æ‡‚è¿™éƒ¨åˆ†ä»£ç çš„ã€‚</li>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè·å¾— Bean çš„ç±»ã€‚æ ¹æ®ä¸Šé¢æ¨èçš„æ–‡ç« ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œæ­¤æ—¶è¿”å›çš„æ˜¯ HystrixTargeter æˆ– DefaultTargeter ç±»ã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œè·å¾— openfeign Targeter æ¥å£ã€‚</li>
<li><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œå¦‚æœå®ç° openfeign Targeter æ¥å£ï¼Œåˆ™åˆ›å»ºåŠ¨æ€ä»£ç†ã€‚å…¶ä¸­ï¼Œä¼ å…¥çš„å¤„ç†å™¨æ˜¯ TargeterInvocationHandler å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€Œ8.2 TargeterInvocationHandlerã€</a>&nbsp;ã€‚</li>
</ul>
<h2 id="8-2-TargeterInvocationHandler">8.2 TargeterInvocationHandler</h2>
<p><code>org.springframework.cloud.alibaba.dubbo.openfeign.TargeterInvocationHandler</code>&nbsp;ï¼Œä¼šæ‹¦æˆª Targeter çš„&nbsp;<code>#target(FeignClientFactoryBean factory, Builder feign, FeignContext context, HardCodedTarget&lt;T&gt; target)</code>&nbsp;æ–¹æ³•ï¼Œæ ¹æ®æ¡ä»¶ï¼Œåˆ›å»ºä¸åŒçš„ä»£ç†å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å¦‚æœä¸ç†è§£ Targeter çš„è¯ï¼Œè¯·å†çœ‹ä¸‹&nbsp;<a href="https://cloud.tencent.com/developer/article/1378733" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠSpring Cloud Alibaba Sentinel æ•´åˆ Feign çš„è®¾è®¡å®ç°ã€‹</a>çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€ŒFeign çš„æ‰§è¡Œè¿‡ç¨‹ã€</a>&nbsp;å°èŠ‚ã€‚</p>
</blockquote>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// TargeterInvocationHandler.java</span></span><br /><br /><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TargeterInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object bean;</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Environment environment;</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DubboServiceMetadataRepository dubboServiceMetadataRepository;</span><br /><br /><span class="line">    TargeterInvocationHandler(Object bean, Environment environment,</span><br /><span class="line">                              DubboServiceMetadataRepository dubboServiceMetadataRepository) {</span><br /><span class="line">        <span class="keyword">this</span>.bean = bean;</span><br /><span class="line">        <span class="keyword">this</span>.environment = environment;</span><br /><span class="line">        <span class="keyword">this</span>.dubboServiceMetadataRepository = dubboServiceMetadataRepository;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>{</span><br /><span class="line">        <span class="comment">/**</span></span><br /><span class="line"><span class="comment">         * args[0]: FeignClientFactoryBean factory</span></span><br /><span class="line"><span class="comment">         * args[1]: Feign.Builder feign</span></span><br /><span class="line"><span class="comment">         * args[2]: FeignContext context</span></span><br /><span class="line"><span class="comment">         * args[3]: Target.HardCodedTarget&lt;T&gt; target</span></span><br /><span class="line"><span class="comment">         */</span></span><br /><span class="line">        FeignContext feignContext = cast(args[<span class="number">2</span>]);</span><br /><span class="line">        Target.HardCodedTarget&lt;?&gt; target = cast(args[<span class="number">3</span>]);</span><br /><br /><span class="line">        <span class="comment">// &lt;1&gt; å…ˆè°ƒç”¨åŸæœ‰ target æ–¹æ³•ï¼Œè¿”å›é»˜è®¤çš„ä»£ç†å¯¹è±¡</span></span><br /><span class="line">        <span class="comment">// Execute Targeter#target method first</span></span><br /><span class="line">        method.setAccessible(<span class="keyword">true</span>);</span><br /><span class="line">        <span class="comment">// Get the default proxy object</span></span><br /><span class="line">        Object defaultProxy = method.invoke(bean, args);</span><br /><span class="line">        <span class="comment">// Create Dubbo Proxy if required</span></span><br /><span class="line">        <span class="comment">// å¦‚æœç¬¦åˆåˆ›å»º Dubbo ä»£ç†å¯¹è±¡ï¼Œåˆ™åˆ›å»º Dubbo ä»£ç†å¯¹è±¡ã€‚</span></span><br /><span class="line">        <span class="comment">// å¦åˆ™ï¼Œä½¿ç”¨é»˜è®¤çš„ defaultProxy ä»£ç†</span></span><br /><span class="line">        <span class="keyword">return</span> createDubboProxyIfRequired(feignContext, target, defaultProxy);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">// ... çœç•¥ä¸‹é¢è¦è®²è§£çš„æ–¹æ³•</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä¸ºäº†è®©èƒ–å‹æ›´åŠ å¥½ç†è§£ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨æ—¶çš„æˆªå›¾ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_02_14/07.jpg" alt="è°ƒç”¨å›¾" /></li>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œå…ˆè°ƒç”¨åŸæœ‰&nbsp;<code>target</code>&nbsp;æ–¹æ³•ï¼Œè¿”å›é»˜è®¤çš„ä»£ç†å¯¹è±¡ã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#createDubboProxyIfRequired(FeignContext feignContext, Target target, Object defaultProxy)</code>&nbsp;æ–¹æ³•ï¼Œå¦‚æœç¬¦åˆåˆ›å»º Dubbo ä»£ç†å¯¹è±¡ï¼Œåˆ™åˆ›å»º Dubbo ä»£ç†å¯¹è±¡ã€‚å¦åˆ™ï¼Œä½¿ç”¨é»˜è®¤çš„ defaultProxy ä»£ç†ã€‚é‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œæ¡ä»¶æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæœ‰&nbsp;<code>@DubboTransported</code>&nbsp;æ³¨è§£ï¼Œä¸”ä»é…ç½®ä¸­å¿ƒæ‹‰å–ä¸åˆ°æœåŠ¡æä¾›è€…çš„å…ƒæ•°æ®ã€‚ğŸ˜ˆ å› ä¸ºï¼Œæ²¡æœ‰æœåŠ¡æä¾›è€…çš„å…ƒæ•°æ®ï¼Œæˆ‘ä»¬ä¹Ÿæ— æ³•ä½¿ç”¨ Dubbo çš„æ³›åŒ–è°ƒç”¨å‘€ã€‚</li>
<li>so ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚</li>
</ul>
<h3 id="8-2-1-createDubboProxyIfRequired">8.2.1 createDubboProxyIfRequired</h3>
<p><code>#createDubboProxyIfRequiredcreateDubboProxyIfRequired(FeignContext feignContext, Target target, Object defaultProxy)</code>&nbsp;æ–¹æ³•ï¼Œæ ¹æ®æ¡ä»¶ï¼Œåˆ›å»ºå¯¹åº”çš„ä»£ç†å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// TargeterInvocationHandler.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">createDubboProxyIfRequired</span><span class="params">(FeignContext feignContext, Target target, Object defaultProxy)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; å°è¯•åˆ›å»º DubboInvocationHandler</span></span><br /><span class="line">    DubboInvocationHandler dubboInvocationHandler = createDubboInvocationHandler(feignContext, target, defaultProxy);</span><br /><span class="line">    <span class="comment">// &lt;2.1&gt; å¦‚æœæœªåˆ›å»ºæˆåŠŸï¼Œè¯´æ˜ä¸ç¬¦åˆæ¡ä»¶ï¼Œåˆ™è¿”å›é»˜è®¤çš„ defaultProxy ä»£ç†</span></span><br /><span class="line">    <span class="keyword">if</span> (dubboInvocationHandler == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">return</span> defaultProxy;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// &lt;2.2&gt; å¦‚æœåˆ›å»ºæˆåŠŸï¼Œè¯´æ˜ç¬¦åˆæ¡ä»¶ï¼Œåˆ™åˆ›å»ºä½¿ç”¨ dubboInvocationHandler çš„åŠ¨æ€ä»£ç†</span></span><br /><span class="line">    <span class="keyword">return</span> Proxy.newProxyInstance(target.type().getClassLoader(), <span class="keyword">new</span> Class&lt;?&gt;[]{target.type()}, dubboInvocationHandler);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#createDubboInvocationHandler(FeignContext feignContext, Target target, Object defaultFeignClientProxy)</code>&nbsp;æ–¹æ³•ï¼Œå°è¯•åˆ›å»º DubboInvocationHandlerã€‚</li>
<li><code>&lt;2.1&gt;</code>&nbsp;å¤„ï¼Œå¦‚æœæœªåˆ›å»ºæˆåŠŸï¼Œè¯´æ˜ä¸ç¬¦åˆæ¡ä»¶ï¼Œåˆ™è¿”å›é»˜è®¤çš„&nbsp;<code>defaultProxy</code>&nbsp;ä»£ç†ã€‚</li>
<li><code>&lt;2.2&gt;</code>&nbsp;å¤„ï¼Œå¦‚æœåˆ›å»ºæˆåŠŸï¼Œè¯´æ˜ç¬¦åˆæ¡ä»¶ï¼Œåˆ™åˆ›å»ºä½¿ç”¨&nbsp;<code>dubboInvocationHandler</code>&nbsp;çš„åŠ¨æ€ä»£ç†ã€‚</li>
</ul>
<h3 id="8-2-2-createDubboInvocationHandler">8.2.2 createDubboInvocationHandler</h3>
<p><code>#createDubboInvocationHandler(FeignContext feignContext, Target target, Object defaultFeignClientProxy)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º DubboInvocationHandler å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>æœªæ¥è¿™å—çš„é€»è¾‘ï¼Œä¼šè¢«æŠ½å–åˆ°&nbsp;<code>org.springframework.cloud.alibaba.dubbo.openfeign.DubboInvocationHandlerFactory</code>&nbsp;ç±»ä¸­ã€‚</p>
</blockquote>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// TargeterInvocationHandler.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> DubboInvocationHandler <span class="title">createDubboInvocationHandler</span><span class="params">(FeignContext feignContext, Target target, Object defaultFeignClientProxy)</span> </span>{</span><br /><span class="line">    <span class="comment">// Service name equals @FeignClient.name()</span></span><br /><span class="line">    String serviceName = target.name();</span><br /><span class="line">    Class&lt;?&gt; targetType = target.type();</span><br /><br /><span class="line">    <span class="comment">// Get Contract Bean from FeignContext</span></span><br /><span class="line">    <span class="comment">// &lt;1.1&gt; è·å¾— Feign Contract</span></span><br /><span class="line">    Contract contract = feignContext.getInstance(serviceName, Contract.class);</span><br /><span class="line">    <span class="comment">// &lt;1.2&gt; åˆ›å»º DubboTransportedMethodMetadataResolver å¯¹è±¡</span></span><br /><span class="line">    DubboTransportedMethodMetadataResolver resolver = <span class="keyword">new</span> DubboTransportedMethodMetadataResolver(environment, contract);</span><br /><span class="line">    <span class="comment">// &lt;1.3&gt; è§£ææŒ‡å®šç±»ï¼Œè·å¾—å…¶ DubboTransportedMethodMetadata å’Œ RequestMetadata çš„æ˜ å°„</span></span><br /><span class="line">    Map&lt;DubboTransportedMethodMetadata, RequestMetadata&gt; methodRequestMetadataMap = resolver.resolve(targetType);</span><br /><span class="line">    <span class="comment">// &lt;1.4&gt; å¦‚æœä¸ºç©ºï¼Œåˆ™è¿”å›ï¼Œè¯´æ˜ä¸ç¬¦åˆæ¡ä»¶</span></span><br /><span class="line">    <span class="keyword">if</span> (methodRequestMetadataMap.isEmpty()) { <span class="comment">// @DubboTransported method was not found</span></span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">// Update Metadata</span></span><br /><span class="line">    <span class="comment">// &lt;2&gt; åˆå§‹åŒ–æŒ‡å®š `serviceName` çš„å…ƒæ•°æ®ã€‚æ­¤å¤„ï¼Œä¼šä»é…ç½®ä¸­å¿ƒï¼Œè·å¾—å…ƒæ•°æ®</span></span><br /><span class="line">    dubboServiceMetadataRepository.updateMetadata(serviceName);</span><br /><br /><span class="line">    Map&lt;Method, org.springframework.cloud.alibaba.dubbo.metadata.MethodMetadata&gt; methodMetadataMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br /><span class="line">    Map&lt;Method, GenericService&gt; genericServicesMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br /><span class="line">    <span class="comment">// &lt;3&gt; éå† methodRequestMetadataMap é›†åˆï¼Œåˆå§‹åŒ–å…¶ GenericService</span></span><br /><span class="line">    methodRequestMetadataMap.forEach((dubboTransportedMethodMetadata, requestMetadata) -&gt; {</span><br /><span class="line">        <span class="comment">// &lt;3.1.1&gt; è·å¾— ReferenceBean å¯¹è±¡ï¼Œå¹¶åˆå§‹åŒ–å…¶å±æ€§</span></span><br /><span class="line">        ReferenceBean&lt;GenericService&gt; referenceBean = dubboServiceMetadataRepository.getReferenceBean(serviceName, requestMetadata);</span><br /><span class="line">        referenceBean.setProtocol(dubboTransportedMethodMetadata.getProtocol());</span><br /><span class="line">        referenceBean.setCluster(dubboTransportedMethodMetadata.getCluster());</span><br /><span class="line">        <span class="comment">// &lt;3.1.2&gt; æ·»åŠ åˆ° genericServicesMap ä¸­</span></span><br /><span class="line">        genericServicesMap.put(dubboTransportedMethodMetadata.getMethod(), referenceBean.get());</span><br /><span class="line">        <span class="comment">// &lt;3.2.1&gt; è·å¾— MethodMetadata å¯¹è±¡</span></span><br /><span class="line">        org.springframework.cloud.alibaba.dubbo.metadata.MethodMetadata methodMetadata = dubboServiceMetadataRepository.getMethodMetadata(serviceName, requestMetadata);</span><br /><span class="line">        <span class="comment">// &lt;3.2.2&gt; æ·»åŠ åˆ° methodMetadataMap ä¸­</span></span><br /><span class="line">        methodMetadataMap.put(dubboTransportedMethodMetadata.getMethod(), methodMetadata);</span><br /><span class="line">    });</span><br /><br /><span class="line">    <span class="comment">// &lt;4.1&gt; è·å¾—é»˜è®¤çš„ defaultFeignClientProxy ä¸­ï¼Œé»˜è®¤çš„ InvocationHandler å¯¹è±¡</span></span><br /><span class="line">    InvocationHandler defaultFeignClientInvocationHandler = Proxy.getInvocationHandler(defaultFeignClientProxy);</span><br /><span class="line">    <span class="comment">// &lt;4.2&gt; åˆ›å»º DubboInvocationHandler å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DubboInvocationHandler(genericServicesMap, methodMetadataMap, defaultFeignClientInvocationHandler);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1.1&gt;</code>&nbsp;å¤„ï¼Œè·å¾— Feign Contract ã€‚</li>
<li><code>&lt;1.2&gt;</code>&nbsp;å¤„ï¼Œåˆ›å»º DubboTransportedMethodMetadataResolver å¯¹è±¡ã€‚</li>
<li><code>&lt;1.3&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>DubboTransportedMethodMetadataResolver#resolve(Class&lt;?&gt; targetType)</code>&nbsp;è§£ææŒ‡å®šç±»ï¼Œè·å¾—å…¶ DubboTransportedMethodMetadata å’Œ RequestMetadata çš„æ˜ å°„ã€‚æ­¤å¤„ï¼Œæˆ‘ä»¬å°±æŠŠ&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€Œ7.3 DubboTransportedMethodMetadataã€</a>&nbsp;ç»™ä¸²èµ·æ¥äº†ã€‚</li>
<li><code>&lt;1.4&gt;</code>&nbsp;å¤„ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™è¿”å›ï¼Œè¯´æ˜ä¸ç¬¦åˆæ¡ä»¶ã€‚æ­¤å¤„ï¼Œæˆ‘ä»¬æ¥æŠ›ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœä¸€ä¸ªç±»é‡Œï¼Œå¤šä¸ªæ–¹æ³•ä¸­ï¼Œæœ‰éƒ¨åˆ†æ–¹æ³•æ²¡æœ‰&nbsp;<code>@DubboTransported</code>&nbsp;æ³¨è§£ï¼Œé‚£ä¹ˆä¼šä¸ä¼šåˆ›å»º DubboInvocationHandler å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚é‚£ä¹ˆæ­¤æ—¶ï¼Œå°±ä¼šæœ‰&nbsp;<code>@DubboTransported</code>&nbsp;æ³¨è§£çš„æ–¹æ³•ï¼Œä½¿ç”¨ Dubbo è¿›è¡Œè°ƒç”¨ï¼Œæ²¡æœ‰&nbsp;<code>@DubboTransported</code>&nbsp;æ³¨è§£çš„æ–¹æ³•ï¼Œè¿˜æ˜¯é€‰æ‹©åŸæœ‰ Feign æä¾›çš„æ–¹å¼ï¼ˆä¾‹å¦‚è¯´ RestTemplateï¼‰è¿›è¡Œè°ƒç”¨ã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>DubboServiceMetadataRepository#updateMetadata(String serviceName)</code>&nbsp;æ–¹æ³•ï¼Œåˆå§‹åŒ–æŒ‡å®š&nbsp;<code>serviceName</code>&nbsp;çš„å…ƒæ•°æ®ï¼ˆæ­¤æ—¶ï¼Œä¼šä»é…ç½®ä¸­å¿ƒï¼Œè·å¾—å…ƒæ•°æ®ï¼‰ã€‚æ­¤å¤„ï¼Œæˆ‘ä»¬å°±æŠŠ&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€Œ7.5 DubboServiceMetadataRepositoryã€</a>&nbsp;ç»™ä¸²èµ·æ¥äº†ã€‚</li>
<li><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œéå†&nbsp;<code>methodRequestMetadataMap</code>&nbsp;é›†åˆï¼Œåˆå§‹åŒ–å…¶ GenericService ã€‚
<ul>
<li><code>&lt;3.1.1&gt;</code>&nbsp;å¤„ï¼Œè·å¾— ReferenceBean å¯¹è±¡ï¼Œå¹¶åˆå§‹åŒ–å…¶å±æ€§ã€‚</li>
<li><code>&lt;3.1.2&gt;</code>&nbsp;å¤„ï¼Œæ·»åŠ åˆ°&nbsp;<code>genericServicesMap</code>&nbsp;ä¸­ã€‚</li>
<li><code>&lt;3.2.1&gt;</code>&nbsp;å¤„ï¼Œè·å¾— MethodMetadata å¯¹è±¡ã€‚</li>
<li><code>&lt;3.2.2&gt;</code>&nbsp;å¤„ï¼Œæ·»åŠ åˆ°&nbsp;<code>methodMetadataMap</code>&nbsp;ä¸­ã€‚</li>
</ul>
</li>
<li><code>&lt;4.1&gt;</code>&nbsp;å¤„ï¼Œè·å¾—é»˜è®¤çš„&nbsp;<code>defaultFeignClientProxy</code>&nbsp;ä¸­ï¼Œé»˜è®¤çš„ InvocationHandler å¯¹è±¡ã€‚ä¸ºä»€ä¹ˆéœ€è¦å®ƒå‘¢ï¼Ÿå› ä¸ºï¼Œä¸€ä¸ªç±»ä¸­ï¼Œå¯èƒ½æœ‰æ²¡æœ‰&nbsp;<code>@DubboTransported</code>&nbsp;æ³¨è§£çš„æ–¹æ³•ã€‚</li>
<li><code>&lt;4.2&gt;</code>&nbsp;å¤„ï¼Œåˆ›å»º DubboInvocationHandler å¯¹è±¡ã€‚</li>
</ul>
<h2 id="8-3-DubboInvocationHandler">8.3 DubboInvocationHandler</h2>
<p><code>org.springframework.cloud.alibaba.dubbo.openfeign.DubboInvocationHandler</code>&nbsp;ï¼Œå®ç° InvocationHandler æ¥å£ï¼ŒDubbo InvocationHandler å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboInvocationHandler.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, GenericService&gt; genericServicesMap;</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, MethodMetadata&gt; methodMetadata;</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InvocationHandler defaultInvocationHandler;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DubboInvocationHandler</span><span class="params">(Map&lt;Method, GenericService&gt; genericServicesMap,</span></span></span><br /><span class="line"><span class="function"><span class="params">                                  Map&lt;Method, MethodMetadata&gt; methodMetadata,</span></span></span><br /><span class="line"><span class="function"><span class="params">                                  InvocationHandler defaultInvocationHandler)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.genericServicesMap = genericServicesMap;</span><br /><span class="line">        <span class="keyword">this</span>.methodMetadata = methodMetadata;</span><br /><span class="line">        <span class="keyword">this</span>.defaultInvocationHandler = defaultInvocationHandler;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>{</span><br /><span class="line">        <span class="comment">// è·å¾— GenericService å¯¹è±¡</span></span><br /><span class="line">        GenericService genericService = genericServicesMap.get(method);</span><br /><span class="line">        <span class="comment">// è·å¾— MethodMetadata å¯¹è±¡</span></span><br /><span class="line">        MethodMetadata methodMetadata = <span class="keyword">this</span>.methodMetadata.get(method);</span><br /><br /><span class="line">        <span class="comment">// &lt;1&gt; æƒ…å†µä¸€ï¼Œå¦‚æœä»»ä¸€ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤çš„ defaultInvocationHandler</span></span><br /><span class="line">        <span class="keyword">if</span> (genericService == <span class="keyword">null</span> || methodMetadata == <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="keyword">return</span> defaultInvocationHandler.invoke(proxy, method, args);</span><br /><span class="line">        }</span><br /><br /><span class="line">        <span class="comment">// æƒ…å†µäºŒï¼Œæ‰§è¡Œæ³›åŒ–è°ƒç”¨</span></span><br /><span class="line">        String methodName = methodMetadata.getName(); <span class="comment">// æ–¹æ³•å</span></span><br /><span class="line">        String[] parameterTypes = methodMetadata</span><br /><span class="line">                .getParams()</span><br /><span class="line">                .stream()</span><br /><span class="line">                .map(MethodParameterMetadata::getType)</span><br /><span class="line">                .toArray(String[]::<span class="keyword">new</span>); <span class="comment">// å‚æ•°ç±»å‹</span></span><br /><span class="line">        <span class="keyword">return</span> genericService.$invoke(methodName, parameterTypes, args);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œå¦‚æœä»»ä¸€ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤çš„&nbsp;<code>defaultInvocationHandler</code>&nbsp;ï¼Œå³æ— &nbsp;<code>@DubboTransported</code>&nbsp;æ³¨è§£çš„æ–¹æ³•ã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œæ‰§è¡Œæ³›åŒ–è°ƒç”¨ï¼Œå³æœ‰&nbsp;<code>@DubboTransported</code>&nbsp;æ³¨è§£çš„æ–¹æ³•ã€‚</li>
</ul>
<h2 id="8-4-å°ç»“">8.4 å°ç»“</h2>
<p>è‡³æ­¤ï¼Œæ•´ä¸ªæœåŠ¡æ¶ˆè´¹è€…è°ƒç”¨çš„æµç¨‹ï¼Œæˆ‘ä»¬å·²ç»ä¸²è”èµ·æ¥äº†ã€‚å› ä¸ºæœ¬æ–‡æ˜¯æŒ‰ç…§&nbsp;<code>package</code>&nbsp;åŒ…åˆ†å±‚æ¥å†™ï¼Œæ‰€ä»¥è¿è´¯æ€§ä¼šç›¸å¯¹æ¯”è¾ƒå·®ã€‚å› æ­¤ï¼Œéœ€è¦èƒ–å‹è‡ªå·±åœ¨è°ƒè¯•ä¸€ä¸‹å“ˆã€‚</p>
<h1 id="9-registry-åŒ…">9.&nbsp;<code>registry</code>&nbsp;åŒ…</h1>
<p>æœ¬å°èŠ‚ï¼Œæˆ‘ä»¬æ¥ç…ç…ï¼ŒDubbo æ˜¯å¦‚ä½•å’Œ Spring Cloud æ³¨å†Œä¸­å¿ƒè¿›è¡Œé›†æˆçš„ã€‚</p>
<p>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">2.4.2 application.yaml</a>&nbsp;ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ³¨å†Œä¸­å¿ƒä½¿ç”¨çš„æ˜¯&nbsp;<code>dubbo.registry.address: spring-cloud://nacos</code>&nbsp;ã€‚</p>
<h2 id="9-1-Registration">9.1 Registration</h2>
<p><code>org.springframework.cloud.alibaba.dubbo.registry.DubboRegistration</code>&nbsp;ï¼Œå®ç° Spring Cloud Registration æ¥å£ï¼ŒDubbo Registration å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboRegistration.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * The {<span class="doctag">@link</span> Registration} of Dubbo uses an external of {<span class="doctag">@link</span> ServiceInstance} instance as the delegate.</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DubboRegistration</span> <span class="keyword">implements</span> <span class="title">Registration</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Spring Cloud ServiceInstance</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServiceInstance delegate;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DubboRegistration</span><span class="params">(ServiceInstance delegate)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.delegate = delegate;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getServiceId</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> delegate.getServiceId();</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHost</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> delegate.getHost();</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPort</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> delegate.getPort();</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSecure</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> delegate.isSecure();</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> URI <span class="title">getUri</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> delegate.getUri();</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getMetadata</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> delegate.getMetadata();</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getScheme</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> delegate.getScheme();</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="9-2-SpringCloudRegistryFactory">9.2 SpringCloudRegistryFactory</h2>
<p>åœ¨&nbsp;<code>com.alibaba.dubbo.registry.RegistryFactory</code>&nbsp;ä¸­ï¼Œå£°æ˜äº†ä¸€ä¸ª SpringCloudRegistryFactory æ‹“å±•ã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">spring-cloud=org.springframework.cloud.alibaba.dubbo.registry.SpringCloudRegistryFactory</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å‰ç¼€ä¸º&nbsp;<code>"spring-cloud"</code>&nbsp;ã€‚å³ï¼Œå’Œæˆ‘ä»¬é…ç½®çš„&nbsp;<code>dubbo.registry.address: spring-cloud://nacos</code>&nbsp;èƒ½å¤Ÿå¯¹åº”ä¸Šã€‚</li>
</ul>
<p><code>org.springframework.cloud.alibaba.dubbo.registry.SpringCloudRegistryFactory</code>&nbsp;ï¼Œå®ç° Dubbo RegistryFactory æ¥å£ï¼Œåˆ›å»ºå¯¹ SpringCloudRegistry æ³¨å†Œä¸­å¿ƒã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringCloudRegistryFactory.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringCloudRegistryFactory</span> <span class="keyword">implements</span> <span class="title">RegistryFactory</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext applicationContext;</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Registry <span class="title">getRegistry</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">        <span class="comment">// &lt;1&gt; è·å¾— ServiceRegistry å¯¹è±¡</span></span><br /><span class="line">        ServiceRegistry&lt;Registration&gt; serviceRegistry = applicationContext.getBean(ServiceRegistry.class);</span><br /><span class="line">        <span class="comment">// &lt;2&gt; è·å¾— DiscoveryClient å¯¹è±¡</span></span><br /><span class="line">        DiscoveryClient discoveryClient = applicationContext.getBean(DiscoveryClient.class);</span><br /><span class="line">        <span class="comment">// &lt;3&gt; åˆ›å»º SpringCloudRegistry å¯¹è±¡</span></span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SpringCloudRegistry(url, serviceRegistry, discoveryClient);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> </span>{</span><br /><span class="line">        SpringCloudRegistryFactory.applicationContext = applicationContext;</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè·å¾— ServiceRegistry å¯¹è±¡ã€‚æ­¤å¤„ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ Nacos ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œé‚£ä¹ˆè¿”å›çš„å°±æ˜¯&nbsp;<code>org.springframework.cloud.alibaba.nacos.registry.NacosServiceRegistry</code>&nbsp;å¯¹è±¡ã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œè·å¾— DiscoveryClient å¯¹è±¡ã€‚æ­¤å¤„ï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨ Nacos ä½œä¸ºæ³¨å†Œä¸­å¿ƒï¼Œé‚£ä¹ˆè¿”å›çš„ Composite DiscoveryClient å¯¹è±¡ï¼ŒåŒ…å«&nbsp;<code>org.springframework.cloud.alibaba.nacos.NacosDiscoveryClient</code>&nbsp;å¯¹è±¡ã€‚</li>
<li>ä¸Šè¿°ä¸¤ä¸ªå˜é‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_02_14/08.jpg" alt="å˜é‡" /></li>
<li><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œåˆ›å»º SpringCloudRegistry å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€Œ9.3 SpringCloudRegistryã€</a>&nbsp;ã€‚</li>
</ul>
<h2 id="9-3-SpringCloudRegistry">9.3 SpringCloudRegistry</h2>
<blockquote>
<p>æœ¬å°èŠ‚ï¼Œå»ºç«‹åœ¨èƒ–å‹çœ‹è¿‡&nbsp;<a href="http://www.iocoder.cn/Dubbo/good-collection/" target="_blank" rel="external nofollow noopener noreferrer">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹</a>&nbsp;æ–‡ç« ã€‚</p>
</blockquote>
<p><code>org.springframework.cloud.alibaba.dubbo.registry.SpringCloudRegistry</code>&nbsp;ï¼Œç»§æ‰¿ Dubbo FailbackRegistry æŠ½è±¡ç±»ï¼ŒåŸºäº Spring Cloud DiscoveryClientã€SpringCloudRegistry çš„ API ï¼Œå°è£…å‡º Spring Cloud Registry å®ç°ç±»ã€‚</p>
<h3 id="9-3-1-æ„é€ æ–¹æ³•">9.3.1 æ„é€ æ–¹æ³•</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringCloudRegistry.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ServiceRegistry å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ServiceRegistry&lt;Registration&gt; serviceRegistry;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * DiscoveryClient å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DiscoveryClient discoveryClient;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SpringCloudRegistry</span><span class="params">(URL url, ServiceRegistry&lt;Registration&gt; serviceRegistry,</span></span></span><br /><span class="line"><span class="function"><span class="params">                           DiscoveryClient discoveryClient)</span> </span>{</span><br /><span class="line">    <span class="keyword">super</span>(url);</span><br /><span class="line">    <span class="keyword">this</span>.serviceRegistry = serviceRegistry;</span><br /><span class="line">    <span class="keyword">this</span>.discoveryClient = discoveryClient;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="9-3-2-doRegister">9.3.2 doRegister</h3>
<p>å®ç°&nbsp;<code>#doRegister(URL ur)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œæ³¨å†Œã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringCloudRegistry.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegister</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; è·å¾— serviceName</span></span><br /><span class="line">    <span class="keyword">final</span> String serviceName = getServiceName(url);</span><br /><span class="line">    <span class="comment">// &lt;2&gt; åˆ›å»º Registration å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">final</span> Registration registration = createRegistration(serviceName, url);</span><br /><span class="line">    <span class="comment">// &lt;3&gt; æ³¨å†Œåˆ° serviceRegistry ä¸­</span></span><br /><span class="line">    serviceRegistry.register(registration);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè·å¾—&nbsp;<code>serviceName</code>&nbsp;ã€‚ä¾‹å¦‚ï¼š<code>providers:dubbo:org.springframework.cloud.alibaba.dubbo.service.EchoService:1.0.0</code>&nbsp;ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringCloudRegistry.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getServiceName</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾—åˆ†ç±»</span></span><br /><span class="line">    String category = url.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);</span><br /><span class="line">    <span class="comment">// è·å¾— ServiceName</span></span><br /><span class="line">    <span class="keyword">return</span> getServiceName(url, category);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendIfPresent</span><span class="params">(StringBuilder target, URL url, String parameterName)</span> </span>{</span><br /><span class="line">    String parameterValue = url.getParameter(parameterName);</span><br /><span class="line">    appendIfPresent(target, parameterValue);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SERVICE_NAME_SEPARATOR = <span class="string">":"</span>;</span><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendIfPresent</span><span class="params">(StringBuilder target, String parameterValue)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(parameterValue)) {</span><br /><span class="line">        target.append(SERVICE_NAME_SEPARATOR).append(parameterValue);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œåˆ›å»º DubboRegistration å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringCloudRegistry.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Registration <span class="title">createRegistration</span><span class="params">(String serviceName, URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> DubboRegistration(createServiceInstance(serviceName, url));</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> ServiceInstance <span class="title">createServiceInstance</span><span class="params">(String serviceName, URL url)</span> </span>{</span><br /><span class="line">    <span class="comment">// Append default category if absent</span></span><br /><span class="line">    <span class="comment">// è·å¾—å±æ€§</span></span><br /><span class="line">    String category = url.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);</span><br /><span class="line">    URL newURL = url.addParameter(Constants.CATEGORY_KEY, category);</span><br /><span class="line">    newURL = newURL.addParameter(Constants.PROTOCOL_KEY, url.getProtocol());</span><br /><span class="line">    String ip = NetUtils.getLocalHost(); <span class="comment">// IP</span></span><br /><span class="line">    <span class="keyword">int</span> port = newURL.getParameter(Constants.BIND_PORT_KEY, url.getPort()); <span class="comment">// ç«¯å£</span></span><br /><span class="line">    <span class="comment">// åˆ›å»º DefaultServiceInstance å¯¹è±¡</span></span><br /><span class="line">    DefaultServiceInstance serviceInstance = <span class="keyword">new</span> DefaultServiceInstance(serviceName, ip, port, <span class="keyword">false</span>);</span><br /><span class="line">    serviceInstance.getMetadata().putAll(<span class="keyword">new</span> LinkedHashMap&lt;&gt;(newURL.getParameters()));</span><br /><span class="line">    <span class="keyword">return</span> serviceInstance;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>ServiceRegistry#register(R registration)</code>&nbsp;æ–¹æ³•ï¼Œæ³¨å†Œåˆ°&nbsp;<code>serviceRegistry</code>&nbsp;ä¸­ã€‚è¿™æ ·ï¼ŒDubbo å°±æ³¨å†Œåˆ° Spring Cloud Registry ä¸­ã€‚</p>
</li>
</ul>
<h3 id="9-3-3-doUnregister">9.3.3 doUnregister</h3>
<p>å®ç°&nbsp;<code>#doUnregister(URL url)</code>&nbsp;æ–¹æ³•ï¼Œå–æ¶ˆæ³¨å†Œã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringCloudRegistry.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doUnregister</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾— serviceName</span></span><br /><span class="line">    <span class="keyword">final</span> String serviceName = getServiceName(url);</span><br /><span class="line">    <span class="comment">// åˆ›å»º Registration å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">final</span> Registration registration = createRegistration(serviceName, url);</span><br /><span class="line">    <span class="comment">// å–æ¶ˆæ³¨å†Œä» serviceRegistry ä¸­</span></span><br /><span class="line">    <span class="keyword">this</span>.serviceRegistry.deregister(registration);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="9-3-4-doSubscribe">9.3.4 doSubscribe</h3>
<p>å®ç°&nbsp;<code>#doSubscribe(URL url, NotifyListener listener)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œè®¢é˜…ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringCloudRegistry.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doSubscribe</span><span class="params">(URL url, NotifyListener listener)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; è·å¾— serviceName æ•°ç»„</span></span><br /><span class="line">    List&lt;String&gt; serviceNames = getServiceNames(url, listener);</span><br /><span class="line">    <span class="comment">// &lt;2&gt; æ‰§è¡Œè®¢é˜…</span></span><br /><span class="line">    doSubscribe(url, listener, serviceNames);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè·å¾— serviceName æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringCloudRegistry.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">getServiceNames</span><span class="params">(URL url, NotifyListener listener)</span> </span>{</span><br /><span class="line">    <span class="comment">// ç®¡ç†ç«¯ï¼Œæš‚æ—¶æ— è§†</span></span><br /><span class="line">    <span class="keyword">if</span> (isAdminProtocol(url)) {</span><br /><span class="line">        scheduleServiceNamesLookup(url, listener);</span><br /><span class="line">        <span class="keyword">return</span> getServiceNamesForOps(url);</span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        <span class="keyword">return</span> doGetServiceNames(url);</span><br /><span class="line">    }</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> List&lt;String&gt; <span class="title">doGetServiceNames</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾— category æ•°ç»„</span></span><br /><span class="line">    String[] categories = getCategories(url);</span><br /><span class="line">    <span class="comment">// åˆ›å»º serviceName æ•°ç»„ï¼Œå¹¶è¿›è¡Œè·å¾—</span></span><br /><span class="line">    List&lt;String&gt; serviceNames = <span class="keyword">new</span> ArrayList&lt;String&gt;(categories.length);</span><br /><span class="line">    <span class="keyword">for</span> (String category : categories) {</span><br /><span class="line">        <span class="keyword">final</span> String serviceName = getServiceName(url, category);</span><br /><span class="line">        serviceNames.add(serviceName);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> serviceNames;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#doSubscribe(final URL url, final NotifyListener listener, final List&lt;String&gt; serviceNames)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œè®¢é˜…ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringCloudRegistry.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSubscribe</span><span class="params">(<span class="keyword">final</span> URL url, <span class="keyword">final</span> NotifyListener listener, <span class="keyword">final</span> List&lt;String&gt; serviceNames)</span> </span>{</span><br /><span class="line">    <span class="keyword">for</span> (String serviceName : serviceNames) {</span><br /><span class="line">        <span class="comment">// &lt;2.1&gt; è·å¾— ServiceInstance æ•°ç»„</span></span><br /><span class="line">        List&lt;ServiceInstance&gt; serviceInstances = discoveryClient.getInstances(serviceName);</span><br /><span class="line">        <span class="comment">// &lt;2.2&gt; é€šçŸ¥è®¢é˜…è€…</span></span><br /><span class="line">        notifySubscriber(url, listener, serviceInstances);</span><br /><span class="line">        <span class="comment">// TODO Support Update notification event</span></span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>éå†&nbsp;<code>serviceNames</code>&nbsp;æ•°ç»„ï¼Œé€ä¸ªå¤„ç†ã€‚</li>
<li><code>&lt;2.1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>DiscoveryClient#getInstances(String serviceId)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— ServiceInstance æ•°ç»„ã€‚</li>
<li><code>&lt;2.2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#notifySubscriber(URL url, NotifyListener listener, List&lt;ServiceInstance&gt; serviceInstances)</code>&nbsp;æ–¹æ³•ï¼Œé€šçŸ¥è®¢é˜…è€…ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/spring-cloud-integration/">ã€ŒnotifySubscriberã€</a>&nbsp;ã€‚</li>
</ul>
</li>
</ul>
<h4 id="9-3-4-1-notifySubscriber">9.3.4.1 notifySubscriber</h4>
<p><code>#notifySubscriber(URL url, NotifyListener listener, List&lt;ServiceInstance&gt; serviceInstances)</code>&nbsp;æ–¹æ³•ï¼Œé€šçŸ¥è®¢é˜…è€…ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringCloudRegistry.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifySubscriber</span><span class="params">(URL url, NotifyListener listener, List&lt;ServiceInstance&gt; serviceInstances)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; è¿‡æ»¤æ‰éå¥åº·çš„ Dubbo æœåŠ¡</span></span><br /><span class="line">    List&lt;ServiceInstance&gt; healthyInstances = <span class="keyword">new</span> LinkedList&lt;ServiceInstance&gt;(serviceInstances);</span><br /><span class="line">    <span class="comment">// &lt;1&gt; Healthy Instances</span></span><br /><span class="line">    filterHealthyInstances(healthyInstances);</span><br /><span class="line">    <span class="comment">// &lt;2&gt; åˆ›å»º URL æ•°ç»„</span></span><br /><span class="line">    List&lt;URL&gt; urls = buildURLs(url, healthyInstances);</span><br /><span class="line">    <span class="comment">// &lt;3&gt; é€šçŸ¥è®¢é˜…è€…</span></span><br /><span class="line">    <span class="keyword">this</span>.notify(url, listener, urls);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#filterHealthyInstances(Collection&lt;ServiceInstance&gt; instances)</code>&nbsp;æ–¹æ³•ï¼Œè¿‡æ»¤æ‰éå¥åº·çš„ Dubbo æœåŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringCloudRegistry.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">filterHealthyInstances</span><span class="params">(Collection&lt;ServiceInstance&gt; instances)</span> </span>{</span><br /><span class="line">    filter(instances, <span class="keyword">new</span> Filter&lt;ServiceInstance&gt;() {</span><br /><span class="line">        <span class="meta">@Override</span></span><br /><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(ServiceInstance data)</span> </span>{</span><br /><span class="line">            <span class="comment">// TODO check the details of status</span></span><br /><span class="line"><span class="comment">//                return serviceRegistry.getStatus(new DubboRegistration(data)) != null;</span></span><br /><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br /><span class="line">        }</span><br /><span class="line">    });</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">filter</span><span class="params">(Collection&lt;T&gt; collection, Filter&lt;T&gt; filter)</span> </span>{</span><br /><span class="line">    <span class="comment">// remove if not accept</span></span><br /><span class="line">    collection.removeIf(data -&gt; !filter.accept(data));</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">interface</span> <span class="title">Filter</span>&lt;<span class="title">T</span>&gt; </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Tests whether or not the specified data should be accepted.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> data The data to be tested</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> &lt;code&gt;true&lt;/code&gt; if and only if &lt;code&gt;data&lt;/code&gt;</span></span><br /><span class="line"><span class="comment">     * should be accepted</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">accept</span><span class="params">(T data)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä»&nbsp;<code>TODO check the details of status</code>&nbsp;å¯ä»¥çœ‹å‡ºï¼Œç›®å‰æš‚æ—¶æœªå®ç°ã€‚åç»­ï¼Œå¯èƒ½ä¼šæ ¹æ®çŠ¶æ€è¿›è¡Œè¿‡æ»¤ã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#buildURLs(URL consumerURL, Collection&lt;ServiceInstance&gt; serviceInstances)</code>æ–¹æ³•ï¼Œå°† ServiceInstance æ•°ç»„ï¼Œè½¬æ¢æˆ URL æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringCloudRegistry.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> List&lt;URL&gt; <span class="title">buildURLs</span><span class="params">(URL consumerURL, Collection&lt;ServiceInstance&gt; serviceInstances)</span> </span>{</span><br /><span class="line">    <span class="comment">// serviceInstances ä¸ºç©ºï¼Œè¿”å›ç©ºæ•°ç»„</span></span><br /><span class="line">    <span class="keyword">if</span> (serviceInstances.isEmpty()) {</span><br /><span class="line">        <span class="keyword">return</span> Collections.emptyList();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// serviceInstances éç©ºï¼Œåˆ™é€ä¸ªæ„å»ºå¯¹åº”çš„ URL å¯¹è±¡ï¼Œæ·»åŠ åˆ° urls ä¸­è¿›è¡Œè¿”å›</span></span><br /><span class="line">    List&lt;URL&gt; urls = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br /><span class="line">    <span class="keyword">for</span> (ServiceInstance serviceInstance : serviceInstances) {</span><br /><span class="line">        <span class="comment">// æ„å»º URL å¯¹è±¡</span></span><br /><span class="line">        URL url = buildURL(serviceInstance);</span><br /><span class="line">        <span class="keyword">if</span> (UrlUtils.isMatch(consumerURL, url)) {</span><br /><span class="line">            urls.add(url);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> urls;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> URL <span class="title">buildURL</span><span class="params">(ServiceInstance serviceInstance)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> URL(serviceInstance.getMetadata().get(Constants.PROTOCOL_KEY),</span><br /><span class="line">            serviceInstance.getHost(),</span><br /><span class="line">            serviceInstance.getPort(),</span><br /><span class="line">            serviceInstance.getMetadata());</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨çˆ¶&nbsp;<code>#notify(URL url, NotifyListener listener, List&lt;URL&gt; urls)</code>&nbsp;æ–¹æ³•ï¼Œé€šçŸ¥è®¢é˜…è€…ã€‚</p>
</li>
</ul>
<h3 id="9-3-5-doUnsubscribe">9.3.5 doUnsubscribe</h3>
<p>å®ç°&nbsp;<code>#doUnsubscribe(URL url, NotifyListener listener)</code>&nbsp;æ–¹æ³•ï¼Œå–æ¶ˆè®¢é˜…ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// SpringCloudRegistry.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doUnsubscribe</span><span class="params">(URL url, NotifyListener listener)</span> </span>{</span><br /><span class="line">    <span class="comment">// å¿½ç•¥ç®¡ç†ç«¯</span></span><br /><span class="line">    <span class="keyword">if</span> (isAdminProtocol(url)) {</span><br /><span class="line">        shutdownServiceNamesLookup();</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</div>