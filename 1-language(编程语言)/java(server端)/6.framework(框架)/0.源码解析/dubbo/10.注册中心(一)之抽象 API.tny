<header class="article-header">
<h1 class="article-title">æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ API</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/registry-api/">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; é¡¹ç›®ç»“æ„ä¸€è§ˆã€‹ã€Œ3.5 dubbo-registryã€</a>&nbsp;ä¸­ï¼Œå¯¹&nbsp;<code>dubbo-registry</code>&nbsp;<strong>æ³¨å†Œä¸­å¿ƒ</strong>è¿™ä¸ªå¤§æ¨¡å—åšäº†å¤§ä½“çš„ä»‹ç»ã€‚é‚£ä¹ˆä»æœ¬æ–‡å¼€å§‹ï¼Œåˆ†äº«æ³¨å†Œä¸­å¿ƒçš„ä»£ç å®ç°ã€‚</p>
<p>æœ¬æ–‡åˆ†äº«&nbsp;<code>dubbo-registry-api</code>&nbsp;æ¨¡å—ï¼Œæ³¨å†Œä¸­å¿ƒçš„æŠ½è±¡ API ï¼Œç±»ç»“æ„å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_08_01/01.png" alt="ç±»å›¾" /></p>
<p>ğŸ˜ˆ æ•´ä½“æ¯”è¾ƒæ˜“æ‡‚ï¼Œç¬”è€…åœ¨è¿™é‡Œå…ˆä¸ä»‹ç»ï¼Œèƒ–å‹å¯ä»¥çœ‹å®Œæœ¬æ–‡ï¼Œå›è¿‡å¤´çœ‹çœ‹ï¼Œè‡ªå·±æ˜¯ä¸æ˜¯ç†è§£äº†ï¼Ÿï¼</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬æŒ‰ç…§ä»å·¦åˆ°å³çš„é¡ºåºï¼Œé€ä¸ªåˆ†äº«ã€‚</p>
<h1 id="2-RegistryFactory">2. RegistryFactory</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/7ece72959dd8c96e17fc240a2b22b40391265bcc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/RegistryFactory.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.registry.RegistryFactory</code></a>&nbsp;ï¼Œæ³¨å†Œä¸­å¿ƒå·¥å‚<strong>æ¥å£</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@SPI</span>(<span class="string">"dubbo"</span>)</span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RegistryFactory</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * è¿æ¥æ³¨å†Œä¸­å¿ƒ.</span></span><br /><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br /><span class="line"><span class="comment">     * è¿æ¥æ³¨å†Œä¸­å¿ƒéœ€å¤„ç†å¥‘çº¦ï¼š&lt;br&gt;</span></span><br /><span class="line"><span class="comment">     * 1. å½“è®¾ç½®check=falseæ—¶è¡¨ç¤ºä¸æ£€æŸ¥è¿æ¥ï¼Œå¦åˆ™åœ¨è¿æ¥ä¸ä¸Šæ—¶æŠ›å‡ºå¼‚å¸¸ã€‚&lt;br&gt;</span></span><br /><span class="line"><span class="comment">     * 2. æ”¯æŒURLä¸Šçš„username:passwordæƒé™è®¤è¯ã€‚&lt;br&gt;</span></span><br /><span class="line"><span class="comment">     * 3. æ”¯æŒbackup=10.20.153.10å¤‡é€‰æ³¨å†Œä¸­å¿ƒé›†ç¾¤åœ°å€ã€‚&lt;br&gt;</span></span><br /><span class="line"><span class="comment">     * 4. æ”¯æŒfile=registry.cacheæœ¬åœ°ç£ç›˜æ–‡ä»¶ç¼“å­˜ã€‚&lt;br&gt;</span></span><br /><span class="line"><span class="comment">     * 5. æ”¯æŒtimeout=1000è¯·æ±‚è¶…æ—¶è®¾ç½®ã€‚&lt;br&gt;</span></span><br /><span class="line"><span class="comment">     * 6. æ”¯æŒsession=60000ä¼šè¯è¶…æ—¶æˆ–è¿‡æœŸè®¾ç½®ã€‚&lt;br&gt;</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> url æ³¨å†Œä¸­å¿ƒåœ°å€ï¼Œä¸å…è®¸ä¸ºç©º</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ³¨å†Œä¸­å¿ƒå¼•ç”¨ï¼Œæ€»ä¸è¿”å›ç©º</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="meta">@Adaptive</span>({<span class="string">"protocol"</span>})</span><br /><span class="line">    <span class="function">Registry <span class="title">getRegistry</span><span class="params">(URL url)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>RegistryFactory æ˜¯ä¸€ä¸ª Dubbo SPI æ‹“å±•æ¥å£ã€‚</li>
<li><code>#getRegistry(url)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œä¸­å¿ƒ Registry å¯¹è±¡ã€‚
<ul>
<li>æ³¨æ„æ–¹æ³•ä¸Šæ³¨é‡Šçš„<strong>å¤„ç†å¥‘çº¦</strong>ã€‚</li>
<li><code>@Adaptive({"protocol"})</code>&nbsp;æ³¨è§£ï¼ŒDubbo SPI ä¼šè‡ªåŠ¨å®ç° RegistryFactory$Adaptive ç±»ï¼Œæ ¹æ®&nbsp;<code>url.protocol</code>&nbsp;è·å¾—å¯¹åº”çš„ RegistryFactory å®ç°ç±»ã€‚ä¾‹å¦‚ï¼Œ<code>url.protocol = zookeeper</code>&nbsp;æ—¶ï¼Œè·å¾— ZookeeperRegistryFactory å®ç°ç±»ã€‚</li>
</ul>
</li>
</ul>
<h2 id="2-1-AbstractRegistryFactory">2.1 AbstractRegistryFactory</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/7ece72959dd8c96e17fc240a2b22b40391265bcc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistryFactory.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.registry.support.AbstractRegistryFactory</code></a>&nbsp;ï¼Œå®ç° RegistryFactory æ¥å£ï¼ŒRegistryFactory æŠ½è±¡ç±»ï¼Œå®ç°äº† Registry çš„<strong>å®¹å™¨ç®¡ç†</strong>ã€‚</p>
<h3 id="2-1-1-å±æ€§">2.1.1 å±æ€§</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// The lock for the acquisition process of the registry</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ReentrantLock LOCK = <span class="keyword">new</span> ReentrantLock();</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Registry é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * keyï¼š{<span class="doctag">@link</span> URL#toServiceString()}</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="comment">// Registry Collection Map&lt;RegistryAddress, Registry&gt;</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, Registry&gt; REGISTRIES = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Registry&gt;();</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>REGISTRIES</code>&nbsp;é™æ€å±æ€§ï¼ŒRegistry é›†åˆã€‚</li>
<li><code>LOCK</code>&nbsp;é™æ€å±æ€§ï¼Œé”ï¼Œç”¨äº&nbsp;<code>#destroyAll()</code>&nbsp;å’Œ&nbsp;<code>#getRegistry(url)</code>&nbsp;æ–¹æ³•ï¼Œå¯¹&nbsp;<code>REGISTRIES</code>&nbsp;è®¿é—®çš„ç«äº‰ã€‚</li>
</ul>
<h3 id="2-1-2-createRegistry">2.1.2 createRegistry</h3>
<p><code>#createRegistry(url)</code>&nbsp;<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œåˆ›å»º Registry å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * åˆ›å»º Registry å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> url æ³¨å†Œä¸­å¿ƒåœ°å€</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> Registry å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Registry <span class="title">createRegistry</span><span class="params">(URL url)</span></span>;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>å­ç±»å®ç°è¯¥æ–¹æ³•ï¼Œåˆ›å»ºå…¶å¯¹åº”çš„ Registry å®ç°ç±»ã€‚ä¾‹å¦‚ï¼ŒZookeeperRegistryFactory çš„è¯¥æ–¹æ³•ï¼Œåˆ›å»º ZookeeperRegistry å¯¹è±¡ã€‚</p>
<h3 id="2-1-3-getRegistry">2.1.3 getRegistry</h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/d7c9cec324901c8285e602fdd3256cc9f5586357/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistryFactory.java#L96-L132" target="_blank" rel="external nofollow noopener noreferrer"><code>#getRegistry(url)</code></a>&nbsp;<strong>å®ç°</strong>æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œä¸­å¿ƒ Registry å¯¹è±¡ã€‚ä¼˜å…ˆä»ç¼“å­˜ä¸­è·å–ï¼Œå¦åˆ™è¿›è¡Œåˆ›å»ºã€‚</p>
<ul>
<li>ğŸ™‚ å®ç°æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ï¼Œæœ‰ä»£ç æ³¨é‡Šã€‚</li>
</ul>
<h3 id="2-1-4-destroyAll">2.1.4 destroyAll</h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/d7c9cec324901c8285e602fdd3256cc9f5586357/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistryFactory.java#L65-L94" target="_blank" rel="external nofollow noopener noreferrer"><code>#destroyAll()</code></a>&nbsp;æ–¹æ³•ï¼Œé”€æ¯æ‰€æœ‰ Registry å¯¹è±¡ã€‚</p>
<ul>
<li>ğŸ™‚ å®ç°æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ï¼Œæœ‰ä»£ç æ³¨é‡Šã€‚</li>
</ul>
<h1 id="3-RegistryService">3. RegistryService</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/f2458c11b045f85f654ed1719c75f9b0ba6397fe/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/RegistryService.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.registry.RegistryService</code></a>&nbsp;ï¼Œæ³¨å†Œä¸­å¿ƒæœåŠ¡<strong>æ¥å£</strong>ï¼Œå®šä¹‰äº†æ³¨å†Œã€è®¢é˜…ã€æŸ¥è¯¢<strong>ä¸‰ç§</strong>æ“ä½œæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p>
<ul>
<li><code>#register(url)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>æ³¨å†Œ</strong>æ•°æ®ï¼Œæ¯”å¦‚ï¼šæä¾›è€…åœ°å€ï¼Œæ¶ˆè´¹è€…åœ°å€ï¼Œè·¯ç”±è§„åˆ™ï¼Œè¦†ç›–è§„åˆ™ï¼Œç­‰æ•°æ®ã€‚
<ul>
<li><code>#unregister(url)</code>&nbsp;æ–¹æ³•ï¼Œå–æ¶ˆæ³¨å†Œã€‚</li>
</ul>
</li>
</ul>
<ul>
<li>
<p><code>#subscribe(url, NotifyListener)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>è®¢é˜…</strong>ç¬¦åˆæ¡ä»¶çš„å·²æ³¨å†Œæ•°æ®ï¼Œå½“æœ‰æ³¨å†Œæ•°æ®å˜æ›´æ—¶è‡ªåŠ¨æ¨é€ã€‚</p>
<ul>
<li><code>#unsubscribe(url, NotifyListener)</code>&nbsp;æ–¹æ³•ï¼Œå–æ¶ˆè®¢é˜…ã€‚</li>
<li>åœ¨&nbsp;<code>URL.parameters.category</code>&nbsp;å±æ€§ä¸Šï¼Œè¡¨ç¤ºè®¢é˜…çš„æ•°æ®åˆ†ç±»ã€‚ç›®å‰æœ‰å››ç§ç±»å‹ï¼š
<ul>
<li><code>consumers</code>&nbsp;ï¼ŒæœåŠ¡æ¶ˆè´¹è€…åˆ—è¡¨ã€‚</li>
<li><code>providers</code>&nbsp;ï¼ŒæœåŠ¡æä¾›è€…åˆ—è¡¨ã€‚</li>
<li><code>routers</code>&nbsp;ï¼Œ<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/routing-rule.html" target="_blank" rel="external nofollow noopener noreferrer">è·¯ç”±è§„åˆ™</a>åˆ—è¡¨ã€‚</li>
<li><code>configurations</code>&nbsp;ï¼Œ<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/config-rule.html" target="_blank" rel="external nofollow noopener noreferrer">é…ç½®è§„åˆ™</a>åˆ—è¡¨ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>#lookup(url)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>æŸ¥è¯¢</strong>ç¬¦åˆæ¡ä»¶çš„å·²æ³¨å†Œæ•°æ®ï¼Œä¸è®¢é˜…çš„æ¨æ¨¡å¼ç›¸å¯¹åº”ï¼Œè¿™é‡Œä¸ºæ‹‰æ¨¡å¼ï¼Œåªè¿”å›ä¸€æ¬¡ç»“æœã€‚</p>
</li>
</ul>
<p>psï¼šæ³¨æ„æ–¹æ³•ä¸Šæ³¨é‡Šçš„å¤„ç†å¥‘çº¦ã€‚</p>
<h2 id="3-1-Registry">3.1 Registry</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/f2458c11b045f85f654ed1719c75f9b0ba6397fe/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/Registry.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.registry.Registry</code></a>&nbsp;ï¼Œæ³¨å†Œä¸­å¿ƒ<strong>æ¥å£</strong>ã€‚Registry ç»§æ‰¿äº†ï¼š</p>
<ul>
<li>RegistryService æ¥å£ï¼Œæ‹¥æœ‰æ‹¥æœ‰æ³¨å†Œã€è®¢é˜…ã€æŸ¥è¯¢ä¸‰ç§æ“ä½œæ–¹æ³•ã€‚</li>
<li><a href="https://github.com/YunaiV/dubbo/blob/f2458c11b045f85f654ed1719c75f9b0ba6397fe/dubbo-common/src/main/java/com/alibaba/dubbo/common/Node.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.common.Node</code></a>&nbsp;æ¥å£ï¼Œæ‹¥æœ‰èŠ‚ç‚¹ç›¸å…³çš„æ–¹æ³•ã€‚</li>
</ul>
<h2 id="3-2-AbstractRegistry">3.2 AbstractRegistry</h2>
<p><a href="http://svip.iocoder.cn/Dubbo/registry-api/"><code>com.alibaba.dubbo.registry.support.AbstractRegistry</code></a>&nbsp;ï¼Œå®ç° Registry æ¥å£ï¼ŒRegistry æŠ½è±¡ç±»ï¼Œå®ç°äº†å¦‚ä¸‹æ–¹æ³•ï¼š</p>
<ul>
<li>é€šç”¨çš„æ³¨å†Œã€è®¢é˜…ã€æŸ¥è¯¢ã€é€šçŸ¥ç­‰æ–¹æ³•ã€‚</li>
<li>æŒä¹…åŒ–æ³¨å†Œæ•°æ®åˆ°æ–‡ä»¶ï¼Œä»¥ properties æ ¼å¼å­˜å‚¨ã€‚åº”ç”¨äºï¼Œé‡å¯æ—¶ï¼Œæ— æ³•ä»æ³¨å†Œä¸­å¿ƒåŠ è½½æœåŠ¡æä¾›è€…åˆ—è¡¨ç­‰ä¿¡æ¯æ—¶ï¼Œä»è¯¥æ–‡ä»¶ä¸­è¯»å–ã€‚</li>
</ul>
<h3 id="3-2-1-å±æ€§">3.2.1 å±æ€§</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">// URLåœ°å€åˆ†éš”ç¬¦ï¼Œç”¨äºæ–‡ä»¶ç¼“å­˜ä¸­ï¼ŒæœåŠ¡æä¾›è€…URLåˆ†éš”</span></span><br /><span class="line"> <span class="number">2</span>: <span class="comment">// URL address separator, used in file cache, service provider URL separation</span></span><br /><span class="line"> <span class="number">3</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">char</span> URL_SEPARATOR = <span class="string">' '</span>;</span><br /><span class="line"> <span class="number">4</span>: <span class="comment">// URLåœ°å€åˆ†éš”æ­£åˆ™è¡¨è¾¾å¼ï¼Œç”¨äºè§£ææ–‡ä»¶ç¼“å­˜ä¸­æœåŠ¡æä¾›è€…URLåˆ—è¡¨</span></span><br /><span class="line"> <span class="number">5</span>: <span class="comment">// URL address separated regular expression for parsing the service provider URL list in the file cache</span></span><br /><span class="line"> <span class="number">6</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String URL_SPLIT = <span class="string">"\\s+"</span>;</span><br /><span class="line"> <span class="number">7</span>: </span><br /><span class="line"> <span class="number">8</span>: <span class="comment">// Log output</span></span><br /><span class="line"> <span class="number">9</span>: <span class="keyword">protected</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(getClass());</span><br /><span class="line"><span class="number">10</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">11:  *  æœ¬åœ°ç£ç›˜ç¼“å­˜ã€‚</span></span><br /><span class="line"><span class="comment">12:  *</span></span><br /><span class="line"><span class="comment">13:  *  1. å…¶ä¸­ç‰¹æ®Šçš„ key å€¼ .registies è®°å½•æ³¨å†Œä¸­å¿ƒåˆ—è¡¨</span></span><br /><span class="line"><span class="comment">14:  *  2. å…¶å®ƒå‡ä¸º {<span class="doctag">@link</span> #notified} æœåŠ¡æä¾›è€…åˆ—è¡¨</span></span><br /><span class="line"><span class="comment">15:  */</span></span><br /><span class="line"><span class="number">16</span>: <span class="comment">// Local disk cache, where the special key value.registies records the list of registry centers, and the others are the list of notified service providers</span></span><br /><span class="line"><span class="number">17</span>: <span class="keyword">private</span> <span class="keyword">final</span> Properties properties = <span class="keyword">new</span> Properties();</span><br /><span class="line"><span class="number">18</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">19:  * æ³¨å†Œä¸­å¿ƒç¼“å­˜å†™å…¥æ‰§è¡Œå™¨ã€‚</span></span><br /><span class="line"><span class="comment">20:  *</span></span><br /><span class="line"><span class="comment">21:  * çº¿ç¨‹æ•°=1</span></span><br /><span class="line"><span class="comment">22:  */</span></span><br /><span class="line"><span class="number">23</span>: <span class="comment">// File cache timing writing</span></span><br /><span class="line"><span class="number">24</span>: <span class="keyword">private</span> <span class="keyword">final</span> ExecutorService registryCacheExecutor = Executors.newFixedThreadPool(<span class="number">1</span>, <span class="keyword">new</span> NamedThreadFactory(<span class="string">"DubboSaveRegistryCache"</span>, <span class="keyword">true</span>));</span><br /><span class="line"><span class="number">25</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">26:  * æ˜¯å¦åŒæ­¥ä¿å­˜æ–‡ä»¶</span></span><br /><span class="line"><span class="comment">27:  */</span></span><br /><span class="line"><span class="number">28</span>: <span class="comment">// Is it synchronized to save the file</span></span><br /><span class="line"><span class="number">29</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> syncSaveFile;</span><br /><span class="line"><span class="number">30</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">31:  * æ•°æ®ç‰ˆæœ¬å·</span></span><br /><span class="line"><span class="comment">32:  *</span></span><br /><span class="line"><span class="comment">33:  * {<span class="doctag">@link</span> #properties}</span></span><br /><span class="line"><span class="comment">34:  */</span></span><br /><span class="line"><span class="number">35</span>: <span class="keyword">private</span> <span class="keyword">final</span> AtomicLong lastCacheChanged = <span class="keyword">new</span> AtomicLong();</span><br /><span class="line"><span class="number">36</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">37:  * å·²æ³¨å†Œ URL é›†åˆã€‚</span></span><br /><span class="line"><span class="comment">38:  *</span></span><br /><span class="line"><span class="comment">39:  * æ³¨æ„ï¼Œæ³¨å†Œçš„ URL ä¸ä»…ä»…å¯ä»¥æ˜¯æœåŠ¡æä¾›è€…çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡æ¶ˆè´¹è€…çš„</span></span><br /><span class="line"><span class="comment">40:  */</span></span><br /><span class="line"><span class="number">41</span>: <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;URL&gt; registered = <span class="keyword">new</span> ConcurrentHashSet&lt;URL&gt;();</span><br /><span class="line"><span class="number">42</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">43:  * è®¢é˜… URL çš„ç›‘å¬å™¨é›†åˆ</span></span><br /><span class="line"><span class="comment">44:  *</span></span><br /><span class="line"><span class="comment">45:  * keyï¼šæ¶ˆè´¹è€…çš„ URL ï¼Œä¾‹å¦‚æ¶ˆè´¹è€…çš„ URL</span></span><br /><span class="line"><span class="comment">46:  */</span></span><br /><span class="line"><span class="number">47</span>: <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;URL, Set&lt;NotifyListener&gt;&gt; subscribed = <span class="keyword">new</span> ConcurrentHashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;();</span><br /><span class="line"><span class="number">48</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">49:  * è¢«é€šçŸ¥çš„ URL é›†åˆ</span></span><br /><span class="line"><span class="comment">50:  *</span></span><br /><span class="line"><span class="comment">51:  * key1ï¼šæ¶ˆè´¹è€…çš„ URL ï¼Œä¾‹å¦‚æ¶ˆè´¹è€…çš„ URL ï¼Œå’Œ {<span class="doctag">@link</span> #subscribed} çš„é”®ä¸€è‡´</span></span><br /><span class="line"><span class="comment">52:  * key2ï¼šåˆ†ç±»ï¼Œä¾‹å¦‚ï¼šprovidersã€consumersã€routesã€configuratorsã€‚ã€å®é™…æ—  consumers ï¼Œå› ä¸ºæ¶ˆè´¹è€…ä¸ä¼šå»è®¢é˜…å¦å¤–çš„æ¶ˆè´¹è€…çš„åˆ—è¡¨ã€‘</span></span><br /><span class="line"><span class="comment">53:  *            åœ¨ {<span class="doctag">@link</span> Constants} ä¸­ï¼Œä»¥ "_CATEGORY" ç»“å°¾</span></span><br /><span class="line"><span class="comment">54:  */</span></span><br /><span class="line"><span class="number">55</span>: <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;URL, Map&lt;String, List&lt;URL&gt;&gt;&gt; notified = <span class="keyword">new</span> ConcurrentHashMap&lt;URL, Map&lt;String, List&lt;URL&gt;&gt;&gt;();</span><br /><span class="line"><span class="number">56</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">57:  * æ³¨å†Œä¸­å¿ƒ URL</span></span><br /><span class="line"><span class="comment">58:  */</span></span><br /><span class="line"><span class="number">59</span>: <span class="keyword">private</span> URL registryUrl;</span><br /><span class="line"><span class="number">60</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">61:  * æœ¬åœ°ç£ç›˜ç¼“å­˜æ–‡ä»¶ï¼Œç¼“å­˜æ³¨å†Œä¸­å¿ƒçš„æ•°æ®</span></span><br /><span class="line"><span class="comment">62:  */</span></span><br /><span class="line"><span class="number">63</span>: <span class="comment">// Local disk cache file</span></span><br /><span class="line"><span class="number">64</span>: <span class="keyword">private</span> File file;</span><br /><span class="line"><span class="number">65</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">66:  * æ˜¯å¦é”€æ¯</span></span><br /><span class="line"><span class="comment">67:  */</span></span><br /><span class="line"><span class="number">68</span>: <span class="keyword">private</span> AtomicBoolean destroyed = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br /><span class="line"><span class="number">69</span>: </span><br /><span class="line"><span class="number">70</span>: <span class="function"><span class="keyword">public</span> <span class="title">AbstractRegistry</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line"><span class="number">71</span>:     setUrl(url);</span><br /><span class="line"><span class="number">72</span>:     <span class="comment">// Start file save timer</span></span><br /><span class="line"><span class="number">73</span>:     syncSaveFile = url.getParameter(Constants.REGISTRY_FILESAVE_SYNC_KEY, <span class="keyword">false</span>);</span><br /><span class="line"><span class="number">74</span>:     <span class="comment">// è·å¾— `file`</span></span><br /><span class="line"><span class="number">75</span>:     String filename = url.getParameter(Constants.FILE_KEY, System.getProperty(<span class="string">"user.home"</span>) + <span class="string">"/.dubbo/dubbo-registry-"</span> + url.getParameter(Constants.APPLICATION_KEY) + <span class="string">"-"</span> + url.getAddress() + <span class="string">".cache"</span>);</span><br /><span class="line"><span class="number">76</span>:     File file = <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">77</span>:     <span class="keyword">if</span> (ConfigUtils.isNotEmpty(filename)) {</span><br /><span class="line"><span class="number">78</span>:         file = <span class="keyword">new</span> File(filename);</span><br /><span class="line"><span class="number">79</span>:         <span class="keyword">if</span> (!file.exists() &amp;&amp; file.getParentFile() != <span class="keyword">null</span> &amp;&amp; !file.getParentFile().exists()) {</span><br /><span class="line"><span class="number">80</span>:             <span class="keyword">if</span> (!file.getParentFile().mkdirs()) {</span><br /><span class="line"><span class="number">81</span>:                 <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Invalid registry store file "</span> + file + <span class="string">", cause: Failed to create directory "</span> + file.getParentFile() + <span class="string">"!"</span>);</span><br /><span class="line"><span class="number">82</span>:             }</span><br /><span class="line"><span class="number">83</span>:         }</span><br /><span class="line"><span class="number">84</span>:     }</span><br /><span class="line"><span class="number">85</span>:     <span class="keyword">this</span>.file = file;</span><br /><span class="line"><span class="number">86</span>:     <span class="comment">// åŠ è½½æœ¬åœ°ç£ç›˜ç¼“å­˜æ–‡ä»¶åˆ°å†…å­˜ç¼“å­˜</span></span><br /><span class="line"><span class="number">87</span>:     loadProperties();</span><br /><span class="line"><span class="number">88</span>:     <span class="comment">// é€šçŸ¥ç›‘å¬å™¨ï¼ŒURL å˜åŒ–ç»“æœ</span></span><br /><span class="line"><span class="number">89</span>:     notify(url.getBackupUrls());</span><br /><span class="line"><span class="number">90</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>file</code>&nbsp;å±æ€§ï¼Œ<em>è§ä»£ç æ³¨é‡Š</em>ã€‚</li>
<li><code>properties</code>&nbsp;å±æ€§ï¼Œ<em>è§ä»£ç æ³¨é‡Š</em>ã€‚
<ul>
<li>æ•°æ®æµå‘
<ul>
<li>å¯åŠ¨æ—¶ï¼Œä»&nbsp;<code>file</code>&nbsp;è¯»å–æ•°æ®åˆ°&nbsp;<code>properties</code>&nbsp;ä¸­ã€‚</li>
<li>æ³¨å†Œä¸­å¿ƒæ•°æ®å‘ç”Ÿå˜æ›´æ—¶ï¼Œé€šçŸ¥åˆ° Registry åï¼Œä¿®æ”¹&nbsp;<code>properties</code>&nbsp;å¯¹åº”çš„å€¼ï¼Œå¹¶å†™å…¥&nbsp;<code>file</code>&nbsp;ã€‚</li>
</ul>
</li>
<li>æ•°æ®é”®å€¼
<ul>
<li>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé”®ä¸ºæœåŠ¡æ¶ˆè´¹è€…çš„ URL çš„æœåŠ¡é”®(&nbsp;<code>URL#serviceKey()</code>&nbsp;)ï¼Œå¯¹åº”çš„å€¼ä¸ºæœåŠ¡æä¾›è€…åˆ—è¡¨ã€<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/config-rule.html" target="_blank" rel="external nofollow noopener noreferrer">è·¯ç”±è§„åˆ™</a>åˆ—è¡¨ã€<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/routing-rule.html" target="_blank" rel="external nofollow noopener noreferrer">é…ç½®è§„åˆ™</a>åˆ—è¡¨ã€‚</li>
<li>ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œã€TODO 8019ã€‘.registies</li>
<li>å› ä¸ºå€¼ä¼šå­˜åœ¨ä¸ºåˆ—è¡¨çš„æƒ…å†µï¼Œä½¿ç”¨ç©ºæ ¼(&nbsp;<code>URL_SEPARATOR</code>&nbsp;) åˆ†éš”ã€‚</li>
</ul>
</li>
</ul>
</li>
<li><code>syncSaveFile</code>&nbsp;å±æ€§ï¼Œ<code>properties</code>&nbsp;å‘ç”Ÿå˜æ›´æ—¶å€™ï¼Œæ˜¯åŒæ­¥è¿˜æ˜¯å¼‚æ­¥å†™å…¥&nbsp;<code>file</code>&nbsp;ã€‚</li>
<li><code>registryCacheExecutor</code>&nbsp;å±æ€§ï¼Œ<em>è§ä»£ç æ³¨é‡Š</em>ã€‚</li>
<li><code>lastCacheChanged</code>&nbsp;å±æ€§ï¼Œ<em>è§ä»£ç æ³¨é‡Š</em>ã€‚
<ul>
<li>å› ä¸ºæ¯æ¬¡å†™å…¥&nbsp;<code>file</code>&nbsp;æ˜¯å…¨é‡ï¼Œè€Œä¸æ˜¯å¢é‡å†™å…¥ï¼Œé€šè¿‡ç‰ˆæœ¬å·ï¼Œé¿å…è€ç‰ˆæœ¬è¦†ç›–æ–°ç‰ˆæœ¬ã€‚</li>
</ul>
</li>
<li><code>registered</code>&nbsp;å±æ€§ï¼Œ<em>è§ä»£ç æ³¨é‡Š</em>ã€‚</li>
<li><code>subscribed</code>&nbsp;å±æ€§ï¼Œ<em>è§ä»£ç æ³¨é‡Š</em>ã€‚</li>
<li><code>notified</code>&nbsp;å±æ€§ï¼Œ<em>è§ä»£ç æ³¨é‡Š</em>ã€‚
<ul>
<li>ä»æ•°æ®ä¸Šï¼Œå’Œ&nbsp;<code>properties</code>&nbsp;æ¯”è¾ƒç›¸ä¼¼ã€‚ç¬”è€…è®¤ä¸ºæœ‰ä¸¤ç‚¹å·®å¼‚ï¼š1ï¼‰æ•°æ®æ ¼å¼ä¸Šï¼Œ<code>notified</code>&nbsp;æ ¹æ®<strong>åˆ†ç±»</strong>åšäº†èšåˆï¼›2ï¼‰ä¸ä»&nbsp;<code>file</code>&nbsp;ä¸­è¯»å–ï¼Œéƒ½æ˜¯ä»æ³¨å†Œä¸­å¿ƒè¯»å–çš„æ•°æ®ã€‚</li>
</ul>
</li>
<li><code>registryUrl</code>&nbsp;å±æ€§ï¼Œ<em>è§ä»£ç æ³¨é‡Š</em>ã€‚</li>
<li><code>destroyed</code>&nbsp;å±æ€§ï¼Œ<em>è§ä»£ç æ³¨é‡Š</em>ã€‚</li>
<li><strong>æ„é€ æ–¹æ³•</strong>ï¼Œ<em>è§ä»£ç æ³¨é‡Š</em>ã€‚
<ul>
<li>ç¬¬ 87 è¡Œï¼šè°ƒç”¨&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L265-L291" target="_blank" rel="external nofollow noopener noreferrer"><code>#loadProperties()</code></a>&nbsp;æ–¹æ³•ï¼ŒåŠ è½½æœ¬åœ°ç£ç›˜ç¼“å­˜æ–‡ä»¶åˆ°å†…å­˜ç¼“å­˜ã€‚
<ul>
<li>ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚</li>
</ul>
</li>
<li>ç¬¬ 89 è¡Œï¼š// ã€TODO 8020ã€‘ä¸ºä»€ä¹ˆæ„é€ æ–¹æ³•ï¼Œè¦é€šçŸ¥ï¼Œè¿ç›‘å¬å™¨éƒ½æ²¡æ³¨å†Œ</li>
</ul>
</li>
</ul>
<h3 id="3-2-2-register-amp-amp-unregister">3.2.2 register &amp;&amp; unregister</h3>
<ul>
<li><a href="https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L356-L366" target="_blank" rel="external nofollow noopener noreferrer"><code>#register(url)</code></a>
<ul>
<li>ä»å®ç°ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œå¹¶æœªå‘æ³¨å†Œä¸­å¿ƒå‘èµ·æ³¨å†Œï¼Œä»…ä»…æ˜¯æ·»åŠ åˆ°&nbsp;<code>registered</code>&nbsp;ä¸­ï¼Œè¿›è¡ŒçŠ¶æ€çš„ç»´æŠ¤ã€‚å®é™…ä¸Šï¼ŒçœŸæ­£çš„å®ç°åœ¨ FailbackRegistry ç±»ä¸­ã€‚</li>
</ul>
</li>
<li><a href="https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L368-L378" target="_blank" rel="external nofollow noopener noreferrer"><code>#unregister(url)</code></a>
<ul>
<li>å’Œ&nbsp;<code>#register(url)</code>&nbsp;çš„<strong>å¤„ç†æ–¹å¼</strong>ç›¸åŒã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-2-3-subscribe-amp-amp-unsubscribe">3.2.3 subscribe &amp;&amp; unsubscribe</h3>
<ul>
<li><a href="https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L380-L398" target="_blank" rel="external nofollow noopener noreferrer"><code>#subscribe(url, listener)</code></a>
<ul>
<li>å’Œ&nbsp;<code>#register(url)</code>&nbsp;çš„<strong>å¤„ç†æ–¹å¼</strong>ç›¸åŒã€‚</li>
</ul>
</li>
<li><a href="https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L400-L416" target="_blank" rel="external nofollow noopener noreferrer"><code>#unsubscribe(url, listener)</code></a>
<ul>
<li>å’Œ&nbsp;<code>#register(url)</code>&nbsp;çš„<strong>å¤„ç†æ–¹å¼</strong>ç›¸åŒã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-2-4-notify">3.2.4 notify</h3>
<p><a href="https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L477-L535" target="_blank" rel="external nofollow noopener noreferrer"><code>#notify(url, listener, urls)</code></a>&nbsp;æ–¹æ³•ï¼Œé€šçŸ¥ç›‘å¬å™¨ï¼ŒURL å˜åŒ–ç»“æœã€‚è¿™é‡Œæˆ‘ä»¬æœ‰ä¸¤ç‚¹è¦æ³¨æ„ä¸‹ï¼š</p>
<ul>
<li>ç¬¬ä¸€ï¼Œå‘æ³¨å†Œä¸­å¿ƒå‘èµ·è®¢é˜…åï¼Œä¼šè·å–åˆ°<strong>å…¨é‡</strong>æ•°æ®ï¼Œæ­¤æ—¶ä¼šè¢«è°ƒç”¨&nbsp;<code>#notify(...)</code>&nbsp;æ–¹æ³•ï¼Œå³ Registry è·å–åˆ°äº†å…¨é‡æ•°æ®ã€‚</li>
<li>ç¬¬äºŒï¼Œæ¯æ¬¡æ³¨å†Œä¸­å¿ƒå‘ç”Ÿå˜æ›´æ—¶ï¼Œä¼šè°ƒç”¨&nbsp;<code>#notify(...)</code>&nbsp;æ–¹æ³•ï¼Œè™½ç„¶å˜åŒ–æ˜¯<strong>å¢é‡</strong>ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨æ–¹ï¼Œå·²ç»è¿›è¡Œå¤„ç†ï¼Œä¼ å…¥çš„&nbsp;<code>urls</code>&nbsp;ä¾ç„¶æ˜¯<strong>å…¨é‡</strong>çš„ã€‚</li>
</ul>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * é€šçŸ¥ç›‘å¬å™¨ï¼ŒURL å˜åŒ–ç»“æœã€‚</span></span><br /><span class="line"><span class="comment"> 3:  *</span></span><br /><span class="line"><span class="comment"> 4:  * æ•°æ®æµå‘ `urls` =&gt; {<span class="doctag">@link</span> #notified} =&gt; {<span class="doctag">@link</span> #properties} =&gt; {<span class="doctag">@link</span> #file}</span></span><br /><span class="line"><span class="comment"> 5:  *</span></span><br /><span class="line"><span class="comment"> 6:  * <span class="doctag">@param</span> url æ¶ˆè´¹è€… URL</span></span><br /><span class="line"><span class="comment"> 7:  * <span class="doctag">@param</span> listener ç›‘å¬å™¨</span></span><br /><span class="line"><span class="comment"> 8:  * <span class="doctag">@param</span> urls é€šçŸ¥çš„ URL å˜åŒ–ç»“æœï¼ˆå…¨é‡æ•°æ®ï¼‰</span></span><br /><span class="line"><span class="comment"> 9:  */</span></span><br /><span class="line"><span class="number">10</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span>  <span class="title">notify</span><span class="params">(URL url, NotifyListener listener, List&lt;URL&gt; urls)</span> </span>{</span><br /><span class="line"><span class="number">11</span>:     <span class="keyword">if</span> (url == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"notify url == null"</span>);</span><br /><span class="line"><span class="number">13</span>:     }</span><br /><span class="line"><span class="number">14</span>:     <span class="keyword">if</span> (listener == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">15</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"notify listener == null"</span>);</span><br /><span class="line"><span class="number">16</span>:     }</span><br /><span class="line"><span class="number">17</span>:     <span class="keyword">if</span> ((urls == <span class="keyword">null</span> || urls.isEmpty())</span><br /><span class="line"><span class="number">18</span>:             &amp;&amp; !Constants.ANY_VALUE.equals(url.getServiceInterface())) {</span><br /><span class="line"><span class="number">19</span>:         logger.warn(<span class="string">"Ignore empty notify urls for subscribe url "</span> + url);</span><br /><span class="line"><span class="number">20</span>:         <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">21</span>:     }</span><br /><span class="line"><span class="number">22</span>:     <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"><span class="number">23</span>:         logger.info(<span class="string">"Notify urls for subscribe url "</span> + url + <span class="string">", urls: "</span> + urls);</span><br /><span class="line"><span class="number">24</span>:     }</span><br /><span class="line"><span class="number">25</span>:     <span class="comment">// å°† `urls` æŒ‰ç…§ `url.parameter.category` åˆ†ç±»ï¼Œæ·»åŠ åˆ°é›†åˆ</span></span><br /><span class="line"><span class="number">26</span>:     Map&lt;String, List&lt;URL&gt;&gt; result = <span class="keyword">new</span> HashMap&lt;String, List&lt;URL&gt;&gt;();</span><br /><span class="line"><span class="number">27</span>:     <span class="keyword">for</span> (URL u : urls) {</span><br /><span class="line"><span class="number">28</span>:         <span class="keyword">if</span> (UrlUtils.isMatch(url, u)) {</span><br /><span class="line"><span class="number">29</span>:             String category = u.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);</span><br /><span class="line"><span class="number">30</span>:             List&lt;URL&gt; categoryList = result.get(category);</span><br /><span class="line"><span class="number">31</span>:             <span class="keyword">if</span> (categoryList == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">32</span>:                 categoryList = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br /><span class="line"><span class="number">33</span>:                 result.put(category, categoryList);</span><br /><span class="line"><span class="number">34</span>:             }</span><br /><span class="line"><span class="number">35</span>:             categoryList.add(u);</span><br /><span class="line"><span class="number">36</span>:         }</span><br /><span class="line"><span class="number">37</span>:     }</span><br /><span class="line"><span class="number">38</span>:     <span class="keyword">if</span> (result.size() == <span class="number">0</span>) {</span><br /><span class="line"><span class="number">39</span>:         <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">40</span>:     }</span><br /><span class="line"><span class="number">41</span>:     <span class="comment">// è·å¾—æ¶ˆè´¹è€… URL å¯¹åº”çš„åœ¨ `notified` ä¸­ï¼Œé€šçŸ¥çš„ URL å˜åŒ–ç»“æœï¼ˆå…¨é‡æ•°æ®ï¼‰</span></span><br /><span class="line"><span class="number">42</span>:     Map&lt;String, List&lt;URL&gt;&gt; categoryNotified = notified.get(url);</span><br /><span class="line"><span class="number">43</span>:     <span class="keyword">if</span> (categoryNotified == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">44</span>:         notified.putIfAbsent(url, <span class="keyword">new</span> ConcurrentHashMap&lt;String, List&lt;URL&gt;&gt;());</span><br /><span class="line"><span class="number">45</span>:         categoryNotified = notified.get(url);</span><br /><span class="line"><span class="number">46</span>:     }</span><br /><span class="line"><span class="number">47</span>:     <span class="comment">// å¤„ç†é€šçŸ¥çš„ URL å˜åŒ–ç»“æœï¼ˆå…¨é‡æ•°æ®ï¼‰</span></span><br /><span class="line"><span class="number">48</span>:     <span class="keyword">for</span> (Map.Entry&lt;String, List&lt;URL&gt;&gt; entry : result.entrySet()) {</span><br /><span class="line"><span class="number">49</span>:         String category = entry.getKey();</span><br /><span class="line"><span class="number">50</span>:         List&lt;URL&gt; categoryList = entry.getValue();</span><br /><span class="line"><span class="number">51</span>:         <span class="comment">// è¦†ç›–åˆ° `notified`</span></span><br /><span class="line"><span class="number">52</span>:         <span class="comment">// å½“æŸä¸ªåˆ†ç±»çš„æ•°æ®ä¸ºç©ºæ—¶ï¼Œä¼šä¾ç„¶æœ‰ urls ã€‚å…¶ä¸­ `urls[0].protocol = empty` ï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå¤„ç†æ‰€æœ‰æœåŠ¡æä¾›è€…ä¸ºç©ºçš„æƒ…å†µã€‚</span></span><br /><span class="line"><span class="number">53</span>:         categoryNotified.put(category, categoryList);</span><br /><span class="line"><span class="number">54</span>:         <span class="comment">// ä¿å­˜åˆ°æ–‡ä»¶</span></span><br /><span class="line"><span class="number">55</span>:         saveProperties(url);</span><br /><span class="line"><span class="number">56</span>:         <span class="comment">// é€šçŸ¥ç›‘å¬å™¨</span></span><br /><span class="line"><span class="number">57</span>:         listener.notify(categoryList);</span><br /><span class="line"><span class="number">58</span>:     }</span><br /><span class="line"><span class="number">59</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 25 è‡³ 37 è¡Œï¼šå°†&nbsp;<code>urls</code>&nbsp;æŒ‰ç…§&nbsp;<code>url.parameter.category</code>&nbsp;åˆ†ç±»ï¼Œæ·»åŠ åˆ°é›†åˆ&nbsp;<code>result</code>&nbsp;ä¸­ã€‚
<ul>
<li>ç¬¬ 28 è¡Œï¼šTODO èŠ‹è‰¿</li>
<li>è¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œæ¯æ¬¡ä¼ å…¥çš„&nbsp;<code>urls</code>&nbsp;çš„&ldquo;<strong>å…¨é‡</strong>&rdquo;ï¼ŒæŒ‡çš„æ˜¯è‡³å°‘è¦æ˜¯<strong>ä¸€ä¸ªåˆ†ç±»</strong>çš„å…¨é‡ï¼Œè€Œä¸ä¸€å®šæ˜¯å…¨éƒ¨æ•°æ®ã€‚</li>
</ul>
</li>
<li>ç¬¬ 41 è‡³ 46 è¡Œï¼šè·å¾—æ¶ˆè´¹è€… URL å¯¹åº”çš„åœ¨&nbsp;<code>notified</code>&nbsp;ä¸­çš„æ•°æ®ã€‚</li>
<li>ç¬¬ 47 è‡³ 58 è¡Œï¼šæŒ‰ç…§<strong>åˆ†ç±»</strong>ï¼Œå¾ªç¯å¤„ç†é€šçŸ¥çš„ URL å˜åŒ–ç»“æœï¼ˆå…¨é‡æ•°æ®ï¼‰ã€‚
<ul>
<li>ç¬¬ 51 è‡³ 53 è¡Œï¼šå°†&nbsp;<code>result</code>&nbsp;è¦†ç›–åˆ°&nbsp;<code>notified</code>&nbsp;ä¸­ã€‚è¿™é‡Œåˆæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå½“æŸä¸ªåˆ†ç±»çš„æ•°æ®ä¸ºç©ºæ—¶ï¼Œä¼šä¾ç„¶æœ‰&nbsp;<code>urls</code>&nbsp;ã€‚å…¶ä¸­&nbsp;<code>urls[0].protocol = empty</code>&nbsp;ï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå¤„ç†<strong>æ‰€æœ‰æœåŠ¡æä¾›è€…ä¸ºç©º</strong>çš„æƒ…å†µã€‚</li>
<li>ç¬¬ 55 è¡Œï¼šè°ƒç”¨&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L539-L576" target="_blank" rel="external nofollow noopener noreferrer"><code>#saveProperties(url)</code></a>&nbsp;æ–¹æ³•ï¼Œä¿å­˜åˆ°æ–‡ä»¶ã€‚
<ul>
<li>ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚</li>
</ul>
</li>
<li>ç¬¬ 57 è¡Œï¼šè°ƒç”¨&nbsp;<code>NotifyListener#notify(urls)</code>&nbsp;æ–¹æ³•ï¼Œé€šçŸ¥ç›‘å¬å™¨å¤„ç†ã€‚ä¾‹å¦‚ï¼Œæœ‰æ–°çš„æœåŠ¡æä¾›è€…å¯åŠ¨æ—¶ï¼Œè¢«é€šçŸ¥ï¼Œåˆ›å»ºæ–°çš„ Invoker å¯¹è±¡ã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-2-5-recover">3.2.5 recover</h3>
<ul>
<li><a href="https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L418-L447" target="_blank" rel="external nofollow noopener noreferrer"><code>#recover()</code></a>
<ul>
<li>å’Œ&nbsp;<code>#register(url)</code>&nbsp;çš„<strong>å¤„ç†æ–¹å¼</strong>ç›¸åŒã€‚</li>
</ul>
</li>
</ul>
<p>åœ¨æ³¨å†Œä¸­å¿ƒæ–­å¼€ï¼Œé‡è¿æˆåŠŸï¼Œè°ƒç”¨&nbsp;<code>#recover()</code>&nbsp;æ–¹æ³•ï¼Œè¿›è¡Œæ¢å¤æ³¨å†Œå’Œè®¢é˜…ã€‚</p>
<h3 id="3-2-6-destroy">3.2.6 destroy</h3>
<ul>
<li><a href="https://github.com/YunaiV/dubbo/blob/06155d670fd1331fa1d2f41f7050338f9e9502c5/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java#L578-L622" target="_blank" rel="external nofollow noopener noreferrer"><code>#destroy()</code></a>
<ul>
<li>å’Œ&nbsp;<code>#register(url)</code>&nbsp;çš„<strong>å¤„ç†æ–¹å¼</strong>ç›¸åŒã€‚</li>
</ul>
</li>
</ul>
<p>åœ¨ JVM å…³é—­æ—¶ï¼Œè°ƒç”¨&nbsp;<code>#destroy()</code>&nbsp;æ–¹æ³•ï¼Œè¿›è¡Œå–æ¶ˆæ³¨å†Œå’Œè®¢é˜…ã€‚</p>
<h2 id="3-3-FailbackRegistry">3.3 FailbackRegistry</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/AbstractRegistry.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.registry.support.FailbackRegistry</code></a>&nbsp;ï¼Œå®ç° AbstractRegistry æŠ½è±¡ç±»ï¼Œæ”¯æŒå¤±è´¥é‡è¯•çš„ Registry æŠ½è±¡ç±»ã€‚</p>
<p>åœ¨ä¸Šæ–‡ä¸­çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒAbstractRegistry è¿›è¡Œçš„æ³¨å†Œã€è®¢é˜…ç­‰æ“ä½œï¼Œæ›´å¤šçš„æ˜¯ä¿®æ”¹çŠ¶æ€ï¼Œè€Œæ— å’Œæ³¨å†Œä¸­å¿ƒå®é™…çš„æ“ä½œã€‚FailbackRegistry åœ¨ AbstractRegistry çš„åŸºç¡€ä¸Šï¼Œå®ç°äº†å’Œæ³¨å†Œä¸­å¿ƒå®é™…çš„æ“ä½œï¼Œå¹¶ä¸”æ”¯æŒå¤±è´¥é‡è¯•çš„ç‰¹æ€§ã€‚</p>
<h3 id="3-3-1-å±æ€§">3.3.1 å±æ€§</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * å®šæ—¶ä»»åŠ¡æ‰§è¡Œå™¨</span></span><br /><span class="line"><span class="comment"> 3:  */</span></span><br /><span class="line"> <span class="number">4</span>: <span class="comment">// Scheduled executor service</span></span><br /><span class="line"> <span class="number">5</span>: <span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService retryExecutor = Executors.newScheduledThreadPool(<span class="number">1</span>, <span class="keyword">new</span> NamedThreadFactory(<span class="string">"DubboRegistryFailedRetryTimer"</span>, <span class="keyword">true</span>));</span><br /><span class="line"> <span class="number">6</span>: </span><br /><span class="line"> <span class="number">7</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 8:  * å¤±è´¥é‡è¯•å®šæ—¶å™¨ï¼Œå®šæ—¶æ£€æŸ¥æ˜¯å¦æœ‰è¯·æ±‚å¤±è´¥ï¼Œå¦‚æœ‰ï¼Œæ— é™æ¬¡é‡è¯•</span></span><br /><span class="line"><span class="comment"> 9:  */</span></span><br /><span class="line"><span class="number">10</span>: <span class="comment">// Timer for failure retry, regular check if there is a request for failure, and if there is, an unlimited retry</span></span><br /><span class="line"><span class="number">11</span>: <span class="keyword">private</span> <span class="keyword">final</span> ScheduledFuture&lt;?&gt; retryFuture;</span><br /><span class="line"><span class="number">12</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">13:  * å¤±è´¥å‘èµ·æ³¨å†Œå¤±è´¥çš„ URL é›†åˆ</span></span><br /><span class="line"><span class="comment">14:  */</span></span><br /><span class="line"><span class="number">15</span>: <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;URL&gt; failedRegistered = <span class="keyword">new</span> ConcurrentHashSet&lt;URL&gt;();</span><br /><span class="line"><span class="number">16</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">17:  * å¤±è´¥å–æ¶ˆæ³¨å†Œå¤±è´¥çš„ URL é›†åˆ</span></span><br /><span class="line"><span class="comment">18:  */</span></span><br /><span class="line"><span class="number">19</span>: <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;URL&gt; failedUnregistered = <span class="keyword">new</span> ConcurrentHashSet&lt;URL&gt;();</span><br /><span class="line"><span class="number">20</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">21:  * å¤±è´¥å‘èµ·è®¢é˜…å¤±è´¥çš„ç›‘å¬å™¨é›†åˆ</span></span><br /><span class="line"><span class="comment">22:  */</span></span><br /><span class="line"><span class="number">23</span>: <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;URL, Set&lt;NotifyListener&gt;&gt; failedSubscribed = <span class="keyword">new</span> ConcurrentHashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;();</span><br /><span class="line"><span class="number">24</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">25:  * å¤±è´¥å–æ¶ˆè®¢é˜…å¤±è´¥çš„ç›‘å¬å™¨é›†åˆ</span></span><br /><span class="line"><span class="comment">26:  */</span></span><br /><span class="line"><span class="number">27</span>: <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;URL, Set&lt;NotifyListener&gt;&gt; failedUnsubscribed = <span class="keyword">new</span> ConcurrentHashMap&lt;URL, Set&lt;NotifyListener&gt;&gt;();</span><br /><span class="line"><span class="number">28</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">29:  * å¤±è´¥é€šçŸ¥é€šçŸ¥çš„ URL é›†åˆ</span></span><br /><span class="line"><span class="comment">30:  */</span></span><br /><span class="line"><span class="number">31</span>: <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;URL, Map&lt;NotifyListener, List&lt;URL&gt;&gt;&gt; failedNotified = <span class="keyword">new</span> ConcurrentHashMap&lt;URL, Map&lt;NotifyListener, List&lt;URL&gt;&gt;&gt;();</span><br /><span class="line"><span class="number">32</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">33:  * æ˜¯å¦é”€æ¯</span></span><br /><span class="line"><span class="comment">34:  */</span></span><br /><span class="line"><span class="number">35</span>: <span class="keyword">private</span> AtomicBoolean destroyed = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br /><span class="line"><span class="number">36</span>: </span><br /><span class="line"><span class="number">37</span>: <span class="function"><span class="keyword">public</span> <span class="title">FailbackRegistry</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line"><span class="number">38</span>:     <span class="keyword">super</span>(url);</span><br /><span class="line"><span class="number">39</span>:     <span class="comment">// é‡è¯•é¢‘ç‡ï¼Œå•ä½ï¼šæ¯«ç§’</span></span><br /><span class="line"><span class="number">40</span>:     <span class="keyword">int</span> retryPeriod = url.getParameter(Constants.REGISTRY_RETRY_PERIOD_KEY, Constants.DEFAULT_REGISTRY_RETRY_PERIOD);</span><br /><span class="line"><span class="number">41</span>:     <span class="comment">// åˆ›å»ºå¤±è´¥é‡è¯•å®šæ—¶å™¨</span></span><br /><span class="line"><span class="number">42</span>:     <span class="keyword">this</span>.retryFuture = retryExecutor.scheduleWithFixedDelay(<span class="keyword">new</span> Runnable() {</span><br /><span class="line"><span class="number">43</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br /><span class="line"><span class="number">44</span>:             <span class="comment">// Check and connect to the registry</span></span><br /><span class="line"><span class="number">45</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">46</span>:                 retry();</span><br /><span class="line"><span class="number">47</span>:             } <span class="keyword">catch</span> (Throwable t) { <span class="comment">// Defensive fault tolerance</span></span><br /><span class="line"><span class="number">48</span>:                 logger.error(<span class="string">"Unexpected error occur at failed retry, cause: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">49</span>:             }</span><br /><span class="line"><span class="number">50</span>:         }</span><br /><span class="line"><span class="number">51</span>:     }, retryPeriod, retryPeriod, TimeUnit.MILLISECONDS);</span><br /><span class="line"><span class="number">52</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>retryExecutor</code>&nbsp;å±æ€§ï¼Œ<em>è§ä»£ç æ³¨é‡Š</em>ã€‚</li>
<li><code>retryFuture</code>&nbsp;å±æ€§ï¼Œ<em>è§ä»£ç æ³¨é‡Š</em>ã€‚
<ul>
<li>ç¬¬ 41 è‡³ 51 è¡Œï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­åˆ›å»ºè¯¥å®šæ—¶å™¨ï¼Œåœ¨å…¶&nbsp;<code>#run()</code>&nbsp;æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨&nbsp;<code>#retry()</code>&nbsp;æ–¹æ³•ï¼Œè¿›è¡Œé‡è¯•ã€‚</li>
</ul>
</li>
<li><code>failedXXX</code>&nbsp;å±æ€§ï¼Œ<em>è§ä»£ç æ³¨é‡Š</em>ã€‚
<ul>
<li>æ¯ç§æ“ä½œéƒ½æœ‰ä¸€ä¸ªè®°å½•å¤±è´¥çš„é›†åˆã€‚</li>
</ul>
</li>
<li><code>destroyed</code>&nbsp;å±æ€§ï¼Œ<em>è§ä»£ç æ³¨é‡Š</em>ã€‚</li>
</ul>
<h3 id="3-3-2-register-amp-amp-unregister">3.3.2 register &amp;&amp; unregister</h3>
<ul>
<li><a href="https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L162-L199" target="_blank" rel="external nofollow noopener noreferrer"><code>#register(url)</code></a></li>
<li><a href="https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L201-L238" target="_blank" rel="external nofollow noopener noreferrer"><code>#unregister(url)</code></a></li>
</ul>
<blockquote>
<p>ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚</p>
</blockquote>
<h3 id="3-3-3-subscribe-amp-amp-unsubscribe">3.3.3 subscribe &amp;&amp; unsubscribe</h3>
<ul>
<li><a href="https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L240-L282" target="_blank" rel="external nofollow noopener noreferrer"><code>#subscribe(url, listener)</code></a></li>
<li><a href="https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L284-L324" target="_blank" rel="external nofollow noopener noreferrer"><code>#unsubscribe(url, listener)</code></a></li>
</ul>
<blockquote>
<p>ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚</p>
</blockquote>
<h3 id="3-3-4-notify">3.3.4 notify</h3>
<ul>
<li><a href="https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L326-L352" target="_blank" rel="external nofollow noopener noreferrer"><code>#notify(url, listener, url)</code></a></li>
</ul>
<blockquote>
<p>ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚</p>
</blockquote>
<h3 id="3-3-5-recover">3.3.5 recover</h3>
<ul>
<li><a href="https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L354-L379" target="_blank" rel="external nofollow noopener noreferrer"><code>#recover()</code></a>&nbsp;æ–¹æ³•ï¼Œ<strong>å®Œå…¨è¦†ç›–çˆ¶ç±»æ–¹æ³•</strong>( å³ä¸åƒå‰é¢å‡ ä¸ªæ–¹æ³•ï¼Œä¼šè°ƒç”¨çˆ¶ç±»çš„æ–¹æ³• )ï¼Œå°†éœ€è¦æ³¨å†Œå’Œè®¢é˜…çš„ URL æ·»åŠ åˆ°&nbsp;<code>failedRegistered</code>&nbsp;<code>failedSubscribed</code>&nbsp;å±æ€§ä¸­ã€‚è¿™æ ·ï¼Œåœ¨&nbsp;<code>#retry()</code>&nbsp;æ–¹æ³•ä¸­ï¼Œä¼šé‡è¯•è¿›è¡Œè¿æ¥ã€‚</li>
</ul>
<blockquote>
<p>ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚</p>
</blockquote>
<h3 id="3-3-6-retry">3.3.6 retry</h3>
<ul>
<li><a href="https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L381-L528" target="_blank" rel="external nofollow noopener noreferrer"><code>#retry()</code></a>&nbsp;æ–¹æ³•ï¼Œéå†äº”ä¸ª&nbsp;<code>failedXXX</code>&nbsp;å±æ€§ï¼Œé‡è¯•å¯¹åº”çš„æ“ä½œã€‚</li>
</ul>
<blockquote>
<p>ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚</p>
</blockquote>
<h3 id="3-3-7-destroy">3.3.7 destroy</h3>
<ul>
<li><a href="https://github.com/YunaiV/dubbo/blob/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/FailbackRegistry.java#L530-L541" target="_blank" rel="external nofollow noopener noreferrer"><code>#destroy()</code></a>&nbsp;æ–¹æ³•ï¼Œå–æ¶ˆæ³¨å†Œå’Œè®¢é˜…ï¼Œå¹¶å…³é—­å®šæ—¶å™¨ã€‚</li>
</ul>
<blockquote>
<p>ä»£ç æ¯”è¾ƒæ˜“æ‡‚ï¼Œç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚</p>
</blockquote>
<h1 id="4-NotifyListener">4. NotifyListener</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/da5ebc2737d560dc0fe308793780695c6afc5fda/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/NotifyListener.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.registry.NotifyListener</code></a>&nbsp;ï¼Œé€šçŸ¥ç›‘å¬å™¨ã€‚å½“æ”¶åˆ°æœåŠ¡å˜æ›´é€šçŸ¥æ—¶è§¦å‘ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">NotifyListener</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * å½“æ”¶åˆ°æœåŠ¡å˜æ›´é€šçŸ¥æ—¶è§¦å‘ã€‚</span></span><br /><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br /><span class="line"><span class="comment">     * é€šçŸ¥éœ€å¤„ç†å¥‘çº¦ï¼š&lt;br&gt;</span></span><br /><span class="line"><span class="comment">     * 1. æ€»æ˜¯ä»¥æœåŠ¡æ¥å£å’Œæ•°æ®ç±»å‹ä¸ºç»´åº¦å…¨é‡é€šçŸ¥ï¼Œå³ä¸ä¼šé€šçŸ¥ä¸€ä¸ªæœåŠ¡çš„åŒç±»å‹çš„éƒ¨åˆ†æ•°æ®ï¼Œç”¨æˆ·ä¸éœ€è¦å¯¹æ¯”ä¸Šä¸€æ¬¡é€šçŸ¥ç»“æœã€‚&lt;br&gt;</span></span><br /><span class="line"><span class="comment">     * 2. è®¢é˜…æ—¶çš„ç¬¬ä¸€æ¬¡é€šçŸ¥ï¼Œå¿…é¡»æ˜¯ä¸€ä¸ªæœåŠ¡çš„æ‰€æœ‰ç±»å‹æ•°æ®çš„å…¨é‡é€šçŸ¥ã€‚&lt;br&gt;</span></span><br /><span class="line"><span class="comment">     * 3. ä¸­é€”å˜æ›´æ—¶ï¼Œå…è®¸ä¸åŒç±»å‹çš„æ•°æ®åˆ†å¼€é€šçŸ¥ï¼Œæ¯”å¦‚ï¼šproviders, consumers, routers, overridesï¼Œå…è®¸åªé€šçŸ¥å…¶ä¸­ä¸€ç§ç±»å‹ï¼Œä½†è¯¥ç±»å‹çš„æ•°æ®å¿…é¡»æ˜¯å…¨é‡çš„ï¼Œä¸æ˜¯å¢é‡çš„ã€‚&lt;br&gt;</span></span><br /><span class="line"><span class="comment">     * 4. å¦‚æœä¸€ç§ç±»å‹çš„æ•°æ®ä¸ºç©ºï¼Œéœ€é€šçŸ¥ä¸€ä¸ªemptyåè®®å¹¶å¸¦categoryå‚æ•°çš„æ ‡è¯†æ€§URLæ•°æ®ã€‚&lt;br&gt;</span></span><br /><span class="line"><span class="comment">     * 5. é€šçŸ¥è€…(å³æ³¨å†Œä¸­å¿ƒå®ç°)éœ€ä¿è¯é€šçŸ¥çš„é¡ºåºï¼Œæ¯”å¦‚ï¼šå•çº¿ç¨‹æ¨é€ï¼Œé˜Ÿåˆ—ä¸²è¡ŒåŒ–ï¼Œå¸¦ç‰ˆæœ¬å¯¹æ¯”ã€‚&lt;br&gt;</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> urls å·²æ³¨å†Œä¿¡æ¯åˆ—è¡¨ï¼Œæ€»ä¸ä¸ºç©ºï¼Œå«ä¹‰åŒ{<span class="doctag">@link</span> com.alibaba.dubbo.registry.RegistryService#lookup(URL)}çš„è¿”å›å€¼ã€‚</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">notify</span><span class="params">(List&lt;URL&gt; urls)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ³¨æ„çœ‹æ–¹æ³•ä¸Šçš„æ³¨é‡Šï¼Œç‰¹åˆ«æ˜¯<strong>å…¨é‡</strong>ã€<strong>åˆ†ç±»</strong>ã€<strong>ä¸ºç©º</strong>ã€<strong>é¡ºåº</strong>ã€‚</li>
</ul>
<p>NotifyListener çš„å­ç±»å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_08_01/02.png" alt="ç±»å›¾" /></p>
<h1 id="5-ProviderConsumerRegTable">5. ProviderConsumerRegTable</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.registry.support.ProviderConsumerRegTable</code></a>&nbsp;ï¼ŒæœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…æ³¨å†Œè¡¨ï¼Œå­˜å‚¨ JVM è¿›ç¨‹å†…<strong>è‡ªå·±</strong>çš„æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…çš„ Invoker ã€‚</p>
<p>è¯¥ä¿¡æ¯ç”¨äº&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/qos.html" target="_blank" rel="external nofollow noopener noreferrer">Dubbo QOS</a>&nbsp;ä½¿ç”¨ï¼Œä¾‹å¦‚å°† JVM è¿›ç¨‹ä¸­ï¼Œ<strong>è‡ªå·±</strong>çš„æœåŠ¡æä¾›è€…ä¸‹çº¿ï¼Œåˆæˆ–è€…æŸ¥è¯¢è‡ªå·±çš„æœåŠ¡æä¾›è€…å’Œæ¶ˆè´¹è€…åˆ—è¡¨ã€‚</p>
<ul>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/references/qos.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; åœ¨çº¿è¿ç»´å‘½ä»¤ - QOSã€‹</a></li>
<li>åç»­ä¼šæœ‰æ–‡ç« åˆ†äº« QOS ï¼Œæœ¬æ–‡ä¸å¤šå•°å—¦ã€‚</li>
</ul>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderConsumerRegTable</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æœåŠ¡æä¾›è€… Invoker é›†åˆ</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * keyï¼šæœåŠ¡æä¾›è€… URL æœåŠ¡é”®</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String, Set&lt;ProviderInvokerWrapper&gt;&gt; providerInvokers = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Set&lt;ProviderInvokerWrapper&gt;&gt;();</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æœåŠ¡æ¶ˆè´¹è€… Invoker é›†åˆ</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * keyï¼šæœåŠ¡æ¶ˆè´¹è€… URL æœåŠ¡é”®</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ConcurrentHashMap&lt;String, Set&lt;ConsumerInvokerWrapper&gt;&gt; consumerInvokers = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Set&lt;ConsumerInvokerWrapper&gt;&gt;();</span><br />    <br /><span class="line">    <span class="comment">// .... çœç•¥æ–¹æ³•</span></span><br />    <br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¦‚ä¸‹æ–¹æ³•ï¼Œå·²ç»æ·»åŠ ä»£ç æ³¨é‡Šï¼Œèƒ–å‹ç‚¹å‡»æŸ¥çœ‹ã€‚</li>
<li>æœåŠ¡æä¾›è€…
<ul>
<li><a href="https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java#L51-L70" target="_blank" rel="external nofollow noopener noreferrer"><code>#registerProvider(invoker, registryUrl, providerUrl)</code></a>&nbsp;é™æ€æ–¹æ³•ï¼Œæ³¨å†Œ Provider Invoker ã€‚</li>
<li><a href="https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java#L72-L84" target="_blank" rel="external nofollow noopener noreferrer"><code>#getProviderInvoker(serviceUniqueName)</code></a>&nbsp;é™æ€é™æ€ï¼Œè·å¾—æŒ‡å®šæœåŠ¡é”®çš„ Provider Invoker é›†åˆã€‚</li>
<li><a href="https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java#L86-L112" target="_blank" rel="external nofollow noopener noreferrer"><code>#getProviderWrapper(invoker)</code></a>&nbsp;é™æ€æ–¹æ³•ï¼Œè·å¾—æœåŠ¡æä¾›è€…å¯¹åº”çš„ Invoker Wrapper å¯¹è±¡ã€‚</li>
</ul>
</li>
<li>æœåŠ¡æ¶ˆè´¹è€…
<ul>
<li><a href="https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java#L114-L134" target="_blank" rel="external nofollow noopener noreferrer"><code>#registerConsumer(invoker, registryUrl, consumerUrl, registryDirectory)</code></a>&nbsp;é™æ€æ–¹æ³•ï¼Œæ³¨å†Œ Consumer Invoker ã€‚</li>
<li><a href="https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderConsumerRegTable.java#L136-L148" target="_blank" rel="external nofollow noopener noreferrer"><code>#getConsumerInvoker(serviceUniqueName)</code></a>&nbsp;é™æ€æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šæœåŠ¡é”®çš„ Consumer Invoker é›†åˆã€‚</li>
</ul>
</li>
</ul>
<h2 id="5-1-ProviderInvokerWrapper">5.1 ProviderInvokerWrapper</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ProviderInvokerWrapper.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.registry.support.ProviderInvokerWrapper</code></a>&nbsp;ï¼Œå®ç° Invoker æ¥å£ï¼ŒæœåŠ¡æä¾›è€… Invoker Wrapper ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Invoker&lt;T&gt; invoker;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * åŸå§‹ URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> URL originUrl;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ³¨å†Œä¸­å¿ƒ URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> URL registryUrl;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æœåŠ¡æä¾›è€… URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> URL providerUrl;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦æ³¨å†Œ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> isReg;</span><br />    <br /><span class="line"><span class="comment">// ... çœç•¥æ–¹æ³•</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç›¸æ¯”çº¯ç²¹çš„ Invoker å¯¹è±¡ï¼Œåˆå¤šäº†è¿ç»´å‘½ä»¤éœ€è¦çš„å±æ€§ã€‚ä¾‹å¦‚&nbsp;<code>isReg</code>&nbsp;<strong>çŠ¶æ€</strong>å±æ€§ï¼Œå¯ä»¥åœ¨ä½¿ç”¨<strong>ä¸‹çº¿æœåŠ¡å‘½ä»¤</strong>åï¼Œæ ‡è®°ä¸º&nbsp;<code>false</code>&nbsp;ã€‚æƒ³æå‰æ·±å…¥äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹ä¸‹&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-plugin/dubbo-qos/src/main/java/com/alibaba/dubbo/qos/command/impl/Online.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.qos.command.impl.Offline</code></a>&nbsp;å’Œ&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-plugin/dubbo-qos/src/main/java/com/alibaba/dubbo/qos/command/impl/Online.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.qos.command.impl.Online</code></a>&nbsp;ç±»ã€‚</li>
</ul>
<h2 id="5-2-ConsumerInvokerWrapper">5.2 ConsumerInvokerWrapper</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/support/ConsumerInvokerWrapper.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.registry.support.ConsumerInvokerWrapper</code></a>&nbsp;ï¼Œå®ç° Invoker æ¥å£ï¼ŒæœåŠ¡æ¶ˆè´¹è€… Invoker Wrapper ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Invoker&lt;T&gt; invoker;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * åŸå§‹ URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> URL originUrl;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ³¨å†Œä¸­å¿ƒ URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> URL registryUrl;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ¶ˆè´¹è€… URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> URL consumerUrl;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ³¨å†Œä¸­å¿ƒ Directory</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> RegistryDirectory registryDirectory;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç›¸æ¯”çº¯ç²¹çš„ Invoker å¯¹è±¡ï¼Œåˆå¤šäº†è¿ç»´å‘½ä»¤éœ€è¦çš„å±æ€§ã€‚ä¾‹å¦‚&nbsp;<code>registryDirectory</code>&nbsp;å±æ€§ï¼Œå¯ä»¥åœ¨ä½¿ç”¨<strong>åˆ—å‡ºæ¶ˆè´¹è€…å’Œæä¾›è€…å‘½ä»¤</strong>åï¼Œè¾“å‡ºå¯æ¶ˆè´¹è€…<strong>å¯è°ƒç”¨</strong>çš„æœåŠ¡æä¾›è€…æ•°é‡ ã€‚æƒ³æå‰æ·±å…¥äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹ä¸‹&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/703764e6e82a72ddca7401c9302781e69c453f8e/dubbo-plugin/dubbo-qos/src/main/java/com/alibaba/dubbo/qos/command/impl/Ls.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.qos.command.impl.Ls</code></a>&nbsp;ç±»ã€‚</li>
</ul>
<h1 id="5-integration">5. integration</h1>
<p>ä¸åŒäºä¸Šé¢æˆ‘ä»¬çœ‹åˆ°çš„ä»£ç ï¼Œ<a href="https://github.com/YunaiV/dubbo/tree/414a4799cef08f0b5263d838eeaf8d8f169f2cdc/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/integration" target="_blank" rel="external nofollow noopener noreferrer"><code>integration</code></a>&nbsp;åŒ…ä¸‹æ˜¯å¯¹å…¶ä»– Dubbo æ¨¡å—çš„é›†æˆï¼š</p>
<ul>
<li>RegistryProtocol ï¼Œå¯¹&nbsp;<code>dubbo-rpc-api</code>&nbsp;çš„ä¾èµ–é›†æˆã€‚</li>
<li>RegistryDirectory ï¼Œå¯¹&nbsp;<code>dubbo-cluster</code>&nbsp;çš„ä¾èµ–é›†æˆã€‚</li>
</ul>
<p>è€ƒè™‘åˆ°è¶…å‡ºäº†æœ¬æ–‡çš„èŒƒç•´ï¼Œåé¢æ¶‰åŠåˆ°æ—¶ï¼Œå•ç‹¬åˆ†äº«ã€‚</p>
</div>