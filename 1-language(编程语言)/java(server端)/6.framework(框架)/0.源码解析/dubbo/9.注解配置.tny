<header class="article-header">
<h1 class="article-title">æ³¨è§£é…ç½®</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.7.1-SNAPSHOT ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>åœ¨ Dubbo æä¾›çš„å‡ ç§æ–¹å¼ä¸­ï¼Œ<strong>æ³¨è§£é…ç½®</strong>æ…¢æ…¢å˜æˆå¤§å®¶æœ€å¸¸ç”¨çš„æ–¹å¼ã€‚</p>
<p>å¦‚æœèƒ–å‹ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥æŸ¥çœ‹å¦‚ä¸‹æ–‡æ¡£ï¼š</p>
<ul>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/configuration/annotation.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; æ³¨è§£é…ç½®ã€‹</a></li>
<li><a href="http://dubbo.apache.org/zh-cn/blog/dubbo-annotation.html" target="_blank" rel="external nofollow noopener noreferrer">ã€Šåœ¨ Dubbo ä¸­ä½¿ç”¨æ³¨è§£ã€‹</a></li>
<li><a href="https://dubbo.apache.org/zh-cn/blog/dubbo-annotation-driven.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo æ³¨è§£é©±åŠ¨ï¼ˆAnnotation-Drivenï¼‰ã€‹</a></li>
</ul>
<h1 id="2-ä½¿ç”¨ç¤ºä¾‹">2. ä½¿ç”¨ç¤ºä¾‹</h1>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹&nbsp;<code>dubbo-demo-annotation</code>&nbsp;é¡¹ç›®ä¸‹çš„&nbsp;<code>dubbo-demo-annotation-provider</code>&nbsp;å­é¡¹ç›®æä¾›çš„ Dubbo Provider ç¤ºä¾‹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// Application.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * In order to make sure multicast registry works, need to specify '-Djava.net.preferIPv4Stack=true' before</span></span><br /><span class="line"><span class="comment">     * launch the application</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line">        AnnotationConfigApplicationContext context = <span class="keyword">new</span> AnnotationConfigApplicationContext(ProviderConfiguration.class);</span><br /><span class="line">        context.start();</span><br /><span class="line">        System.in.read();</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Configuration</span></span><br /><span class="line">    <span class="meta">@EnableDubbo</span>(scanBasePackages = <span class="string">"org.apache.dubbo.demo.provider"</span>) <span class="comment">// &lt;1&gt;</span></span><br /><span class="line">    <span class="meta">@PropertySource</span>(<span class="string">"classpath:/spring/dubbo-provider.properties"</span>) <span class="comment">// &lt;2&gt;</span></span><br /><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderConfiguration</span> </span>{</span><br /><br /><span class="line">        <span class="meta">@Bean</span> <span class="comment">// &lt;3&gt;</span></span><br /><span class="line">        <span class="function"><span class="keyword">public</span> RegistryConfig <span class="title">registryConfig</span><span class="params">()</span> </span>{</span><br /><span class="line">            RegistryConfig registryConfig = <span class="keyword">new</span> RegistryConfig();</span><br /><span class="line">            registryConfig.setAddress(<span class="string">"multicast://224.5.6.7:1234"</span>);</span><br /><span class="line">            <span class="keyword">return</span> registryConfig;</span><br /><span class="line">        }</span><br /><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œä½¿ç”¨&nbsp;<code>@EnableDubbo</code>&nbsp;æ³¨è§£ï¼Œé…ç½®æ‰«æ&nbsp;<code>"org.apache.dubbo.demo.provider"</code>&nbsp;ç›®å½•ä¸‹çš„&nbsp;<code>@Service</code>&nbsp;å’Œ&nbsp;<code>@Reference</code>&nbsp;Bean å¯¹è±¡ã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œä½¿ç”¨&nbsp;<code>@PropertySource</code>&nbsp;æ³¨è§£ï¼Œå¯¼å…¥&nbsp;<code>"classpath:/spring/dubbo-provider.properties"</code>&nbsp;é…ç½®æ–‡ä»¶ã€‚</li>
<li><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œé€šè¿‡&nbsp;<code>@Bean</code>&nbsp;æ³¨è§£æ–¹æ³•ï¼Œåˆ›å»º RegistryConfig Bean å¯¹è±¡ï¼Œå³æ³¨å†Œä¸­å¿ƒã€‚</li>
<li>é€šè¿‡ä½¿ç”¨ Java Config + æ³¨è§£çš„æ–¹å¼ï¼Œç›¸æ¯” XML æ¥è¯´ï¼Œä¼šæ›´åŠ ç†Ÿæ‚‰ä¸€äº›~</li>
</ul>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥çœ‹çœ‹å…·ä½“çš„æºç è½ã€‚æœ¬æ–‡æ¶‰åŠçš„ç±»ï¼Œä¸»è¦å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_01_22/01.jpg" alt="ç±»" /></p>
<h1 id="3-EnableDubbo">3. @EnableDubbo</h1>
<p><code>org.apache.dubbo.config.spring.context.annotation.@EnableDubbo</code>&nbsp;æ³¨è§£ï¼Œæ˜¯&nbsp;<code>@EnableDubboConfig</code>&nbsp;å’Œ&nbsp;<code>@DubboComponentScan</code>&nbsp;çš„ç»„åˆæ³¨è§£ï¼Œä½¿ç”¨æ—¶æ›´åŠ ä¾¿åˆ©ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// EnableDubbo.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Enables Dubbo components as Spring Beans, equals</span></span><br /><span class="line"><span class="comment"> * {<span class="doctag">@link</span> DubboComponentScan} and {<span class="doctag">@link</span> EnableDubboConfig} combination.</span></span><br /><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br /><span class="line"><span class="comment"> * Note : {<span class="doctag">@link</span> EnableDubbo} must base on Spring Framework 4.2 and above</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> DubboComponentScan</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> EnableDubboConfig</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.8</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="meta">@Target</span>({ElementType.TYPE})</span><br /><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br /><span class="line"><span class="meta">@Inherited</span></span><br /><span class="line"><span class="meta">@Documented</span></span><br /><span class="line"><span class="meta">@EnableDubboConfig</span> <span class="comment">// å¼€å¯ Dubbo Config</span></span><br /><span class="line"><span class="meta">@DubboComponentScan</span> <span class="comment">// æ‰«æ Dubbo @Service å’Œ @Reference Bean</span></span><br /><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableDubbo {</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * é…ç½® <span class="doctag">@DubboComponentScan</span> æ³¨è§£ï¼Œæ‰«æçš„åŒ…</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * Base packages to scan for annotated <span class="doctag">@Service</span> classes.</span></span><br /><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br /><span class="line"><span class="comment">     * Use {<span class="doctag">@link</span> #scanBasePackageClasses()} for a type-safe alternative to String-based</span></span><br /><span class="line"><span class="comment">     * package names.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> the base packages to scan</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@see</span> DubboComponentScan#basePackages()</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="meta">@AliasFor</span>(annotation = DubboComponentScan.class, attribute = <span class="string">"basePackages"</span>)</span><br /><span class="line">    String[] scanBasePackages() <span class="keyword">default</span> {};</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * é…ç½® <span class="doctag">@DubboComponentScan</span> æ³¨è§£ï¼Œæ‰«æçš„ç±»</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * Type-safe alternative to {<span class="doctag">@link</span> #scanBasePackages()} for specifying the packages to</span></span><br /><span class="line"><span class="comment">     * scan for annotated <span class="doctag">@Service</span> classes. The package of each class specified will be</span></span><br /><span class="line"><span class="comment">     * scanned.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> classes from the base packages to scan</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@see</span> DubboComponentScan#basePackageClasses</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="meta">@AliasFor</span>(annotation = DubboComponentScan.class, attribute = <span class="string">"basePackageClasses"</span>)</span><br /><span class="line">    Class&lt;?&gt;[] scanBasePackageClasses() <span class="keyword">default</span> {};</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * é…ç½® <span class="doctag">@EnableDubboConfig</span> æ³¨è§£ï¼Œé…ç½®æ˜¯å¦ç»‘å®šåˆ°å¤šä¸ª Spring Bean ä¸Š</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * It indicates whether {<span class="doctag">@link</span> AbstractConfig} binding to multiple Spring Beans.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> the default value is &lt;code&gt;false&lt;/code&gt;</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@see</span> EnableDubboConfig#multiple()</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="meta">@AliasFor</span>(annotation = EnableDubboConfig.class, attribute = <span class="string">"multiple"</span>)</span><br /><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">multipleConfig</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ³¨æ„çœ‹ä¸‹å…·ä½“çš„æ³¨é‡Šã€‚</li>
</ul>
<blockquote>
<p>é€šè¿‡&nbsp;<code>@EnableDubbo</code>&nbsp;å¯ä»¥åœ¨æŒ‡å®šçš„åŒ…åä¸‹ï¼ˆé€šè¿‡&nbsp;<code>scanBasePackages</code>&nbsp;å±æ€§ï¼‰ï¼Œæˆ–è€…æŒ‡å®šçš„ç±»ä¸­ï¼ˆé€šè¿‡&nbsp;<code>scanBasePackageClasses</code>&nbsp;å±æ€§ï¼‰æ‰«æ Dubbo çš„æœåŠ¡æä¾›è€…ï¼ˆä»¥&nbsp;<code>@Service</code>&nbsp;æ³¨è§£ï¼‰ä»¥åŠ Dubbo çš„æœåŠ¡æ¶ˆè´¹è€…ï¼ˆä»¥&nbsp;<code>@Reference</code>&nbsp;æ³¨è§£ï¼‰ã€‚</p>
<p>æ‰«æåˆ° Dubbo çš„æœåŠ¡æä¾›æ–¹å’Œæ¶ˆè´¹è€…ä¹‹åï¼Œå¯¹å…¶åšç›¸åº”çš„ç»„è£…å¹¶åˆå§‹åŒ–ï¼Œå¹¶æœ€ç»ˆå®ŒæˆæœåŠ¡æš´éœ²æˆ–è€…å¼•ç”¨çš„å·¥ä½œã€‚</p>
</blockquote>
<h1 id="4-EnableDubboConfig">4. @EnableDubboConfig</h1>
<p><code>org.apache.dubbo.config.spring.context.annotation.@EnableDubboConfig</code>&nbsp;æ³¨è§£ï¼Œå¼€å¯ Dubbo é…ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// EnableDubboConfig.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * As  a convenient and multiple {<span class="doctag">@link</span> EnableDubboConfigBinding}</span></span><br /><span class="line"><span class="comment"> * in default behavior , is equal to single bean bindings with below convention prefixes of properties:</span></span><br /><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;li&gt;{<span class="doctag">@link</span> ApplicationConfig} binding to property : "dubbo.application"&lt;/li&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;li&gt;{<span class="doctag">@link</span> ModuleConfig} binding to property :  "dubbo.module"&lt;/li&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;li&gt;{<span class="doctag">@link</span> RegistryConfig} binding to property :  "dubbo.registry"&lt;/li&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;li&gt;{<span class="doctag">@link</span> ProtocolConfig} binding to property :  "dubbo.protocol"&lt;/li&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;li&gt;{<span class="doctag">@link</span> MonitorConfig} binding to property :  "dubbo.monitor"&lt;/li&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;li&gt;{<span class="doctag">@link</span> ProviderConfig} binding to property :  "dubbo.provider"&lt;/li&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;li&gt;{<span class="doctag">@link</span> ConsumerConfig} binding to property :  "dubbo.consumer"&lt;/li&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br /><span class="line"><span class="comment"> * In contrast, on multiple bean bindings that requires to set {<span class="doctag">@link</span> #multiple()} to be &lt;code&gt;true&lt;/code&gt; :</span></span><br /><span class="line"><span class="comment"> * &lt;ul&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;li&gt;{<span class="doctag">@link</span> ApplicationConfig} binding to property : "dubbo.applications"&lt;/li&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;li&gt;{<span class="doctag">@link</span> ModuleConfig} binding to property :  "dubbo.modules"&lt;/li&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;li&gt;{<span class="doctag">@link</span> RegistryConfig} binding to property :  "dubbo.registries"&lt;/li&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;li&gt;{<span class="doctag">@link</span> ProtocolConfig} binding to property :  "dubbo.protocols"&lt;/li&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;li&gt;{<span class="doctag">@link</span> MonitorConfig} binding to property :  "dubbo.monitors"&lt;/li&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;li&gt;{<span class="doctag">@link</span> ProviderConfig} binding to property :  "dubbo.providers"&lt;/li&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;li&gt;{<span class="doctag">@link</span> ConsumerConfig} binding to property :  "dubbo.consumers"&lt;/li&gt;</span></span><br /><span class="line"><span class="comment"> * &lt;/ul&gt;</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> EnableDubboConfigBinding</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> DubboConfigConfiguration</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> DubboConfigConfigurationSelector</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.8</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="meta">@Target</span>({ElementType.TYPE})</span><br /><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br /><span class="line"><span class="meta">@Inherited</span></span><br /><span class="line"><span class="meta">@Documented</span></span><br /><span class="line"><span class="meta">@Import</span>(DubboConfigConfigurationRegistrar.class)</span><br /><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableDubboConfig {</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * It indicates whether binding to multiple Spring Beans.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * é…ç½®æ˜¯å¦ç»‘å®šåˆ°å¤šä¸ª Spring Bean ä¸Š</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> the default value is &lt;code&gt;false&lt;/code&gt;</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@revised</span> 2.5.9</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">multiple</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å…³äº&nbsp;<code>multiple</code>&nbsp;å±æ€§ï¼Œå¯èƒ½ç¬¬ä¸€çœ¼ä¼šæœ‰ç‚¹æ‡µé€¼ï¼Œé‚£å’‹æ•´å‘¢ï¼Ÿ
<ul>
<li>ç¬¬ä¸€æ­¥ï¼Œå¯ä»¥çœ‹çœ‹&nbsp;<a href="https://segmentfault.com/a/1190000012661402#articleHeader4" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo æ–°ç¼–ç¨‹æ¨¡å‹ä¹‹å¤–éƒ¨åŒ–é…ç½® &mdash;&mdash;&nbsp;<code>@EnableDubboConfig</code>ã€‹</a>&nbsp;å¯¹&nbsp;<code>@EnableDubboConfig</code>&nbsp;æ³¨è§£çš„ä»‹ç»ã€‚</li>
<li>ç¬¬äºŒæ­¥ï¼Œæˆ‘ä»¬åœ¨æ¥ä¸‹æ¥ä¼šçœ‹å…·ä½“çš„æºç ï¼Œä¼šæ›´æ˜“æ‡‚ä¸€äº›ã€‚</li>
</ul>
</li>
<li><code>@Import(DubboConfigConfigurationRegistrar.class)</code>&nbsp;æ³¨è§£ï¼Œè¡¨æ˜ä½¿ç”¨ DubboConfigConfigurationRegistrar ç±»è¿›è¡Œå¯¼å…¥ã€‚è¯¦ç»†çš„ï¼Œæˆ‘ä»¬ç»§ç»­æ¥çœ‹&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-annotation/">ã€Œ4.1 DubboConfigConfigurationRegistrarã€</a>&nbsp;ã€‚</li>
</ul>
<h2 id="4-1-DubboConfigConfigurationRegistrar">4.1 DubboConfigConfigurationRegistrar</h2>
<p><code>org.apache.dubbo.config.spring.context.annotation.DubboConfigConfigurationRegistrar</code>&nbsp;ï¼Œå®ç° ImportBeanDefinitionRegistrar æ¥å£ï¼Œå¤„ç†&nbsp;<code>@EnableDubboConfig</code>&nbsp;æ³¨è§£ï¼Œæ³¨å†Œç›¸åº”çš„ DubboConfigConfiguration åˆ° Spring å®¹å™¨ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboConfigConfigurationRegistrar.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Dubbo {<span class="doctag">@link</span> AbstractConfig Config} {<span class="doctag">@link</span> ImportBeanDefinitionRegistrar register}, which order can be configured</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> EnableDubboConfig</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> DubboConfigConfiguration</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> Ordered</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.8</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConfigConfigurationRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>{</span><br /><span class="line">        <span class="comment">// è·å¾— @EnableDubboConfig æ³¨è§£çš„å±æ€§</span></span><br /><span class="line">        AnnotationAttributes attributes = AnnotationAttributes.fromMap(importingClassMetadata.getAnnotationAttributes(EnableDubboConfig.class.getName()));</span><br /><span class="line">        <span class="comment">// è·å¾— multiple å±æ€§</span></span><br /><span class="line">        <span class="keyword">boolean</span> multiple = attributes.getBoolean(<span class="string">"multiple"</span>);</span><br /><span class="line">        <span class="comment">// å¦‚æœä¸º true ï¼Œåˆ™æ³¨å†Œ DubboConfigConfiguration.Multiple Bean å¯¹è±¡</span></span><br /><span class="line">        <span class="keyword">if</span> (multiple) {</span><br /><span class="line">            AnnotatedBeanDefinitionRegistryUtils.registerBeans(registry, DubboConfigConfiguration.Multiple.class);</span><br /><span class="line">        <span class="comment">// å¦‚æœä¸º false ï¼Œåˆ™æ³¨å†Œ DubboConfigConfiguration.Single Bean å¯¹è±¡</span></span><br /><span class="line">        } <span class="keyword">else</span> {</span><br /><span class="line">            AnnotatedBeanDefinitionRegistryUtils.registerBeans(registry, DubboConfigConfiguration.Single.class);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">// AnnotatedBeanDefinitionRegistryUtils.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerBeans</span><span class="params">(BeanDefinitionRegistry registry, Class&lt;?&gt;... annotatedClasses)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (ObjectUtils.isEmpty(annotatedClasses)) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">boolean</span> debugEnabled = logger.isDebugEnabled();</span><br /><span class="line">    <span class="comment">// åˆ›å»º AnnotatedBeanDefinitionReader å¯¹è±¡</span></span><br /><span class="line">    AnnotatedBeanDefinitionReader reader = <span class="keyword">new</span> AnnotatedBeanDefinitionReader(registry);</span><br /><span class="line">    <span class="keyword">if</span> (debugEnabled) {</span><br /><span class="line">        logger.debug(registry.getClass().getSimpleName() + <span class="string">" will register annotated classes : "</span> + Arrays.asList(annotatedClasses) + <span class="string">" ."</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// æ³¨å†Œ</span></span><br /><span class="line">    reader.register(annotatedClasses);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ ¹æ®&nbsp;<code>@EnableDubboConfig</code>&nbsp;æ³¨è§£ä¸Šçš„&nbsp;<code>multiple</code>&nbsp;å±æ€§çš„ä¸åŒï¼Œåˆ›å»º DubboConfigConfiguration.Multiple æˆ– DubboConfigConfiguration.Single å¯¹è±¡ï¼Œæ³¨å†Œåˆ° Spring å®¹å™¨ä¸­ã€‚</li>
</ul>
<h2 id="4-2-DubboConfigConfiguration">4.2 DubboConfigConfiguration</h2>
<p><code>org.apache.dubbo.config.spring.beans.factory.annotation.DubboConfigConfiguration</code>&nbsp;ï¼ŒDubbo AbstractConfig é…ç½®ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboConfigConfiguration.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Dubbo {<span class="doctag">@link</span> AbstractConfig Config} {<span class="doctag">@link</span> Configuration}</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> Configuration</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> EnableDubboConfigBindings</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> EnableDubboConfigBinding</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> ApplicationConfig</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> ModuleConfig</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> RegistryConfig</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> ProtocolConfig</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> MonitorConfig</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> ProviderConfig</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> ConsumerConfig</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> org.apache.dubbo.config.ConfigCenterConfig</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.8</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConfigConfiguration</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Single Dubbo {<span class="doctag">@link</span> AbstractConfig Config} Bean Binding</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="meta">@EnableDubboConfigBindings</span>({</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.application"</span>, type = ApplicationConfig.class),</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.module"</span>, type = ModuleConfig.class),</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.registry"</span>, type = RegistryConfig.class),</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.protocol"</span>, type = ProtocolConfig.class),</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.monitor"</span>, type = MonitorConfig.class),</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.provider"</span>, type = ProviderConfig.class),</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.consumer"</span>, type = ConsumerConfig.class),</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.config-center"</span>, type = ConfigCenterBean.class),</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.metadata-report"</span>, type = MetadataReportConfig.class)</span><br /><span class="line">    })</span><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Single</span> </span>{</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Multiple Dubbo {<span class="doctag">@link</span> AbstractConfig Config} Bean Binding</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="meta">@EnableDubboConfigBindings</span>({</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.applications"</span>, type = ApplicationConfig.class, multiple = <span class="keyword">true</span>),</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.modules"</span>, type = ModuleConfig.class, multiple = <span class="keyword">true</span>),</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.registries"</span>, type = RegistryConfig.class, multiple = <span class="keyword">true</span>),</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.protocols"</span>, type = ProtocolConfig.class, multiple = <span class="keyword">true</span>),</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.monitors"</span>, type = MonitorConfig.class, multiple = <span class="keyword">true</span>),</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.providers"</span>, type = ProviderConfig.class, multiple = <span class="keyword">true</span>),</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.consumers"</span>, type = ConsumerConfig.class, multiple = <span class="keyword">true</span>),</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.config-centers"</span>, type = ConfigCenterBean.class, multiple = <span class="keyword">true</span>),</span><br /><span class="line">            <span class="meta">@EnableDubboConfigBinding</span>(prefix = <span class="string">"dubbo.metadata-reports"</span>, type = MetadataReportConfig.class, multiple = <span class="keyword">true</span>)</span><br /><span class="line">    })</span><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Multiple</span> </span>{</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä¹çœ¼ä¸€çœ‹ï¼Œå°±æ˜¯ Single å’Œ Multiple å†…éƒ¨ç±»ã€‚å…¶ä¸Šéƒ½æœ‰&nbsp;<code>@@EnableDubboConfigBindings</code>&nbsp;å’Œ&nbsp;<code>@EnableDubboConfigBinding</code>&nbsp;æ³¨è§£ã€‚
<ul>
<li>å‰è€… Single ï¼Œå…¶ä¸Šçš„æ³¨è§£ï¼Œ<code>prefix</code>&nbsp;éƒ½æ˜¯å•æ•°ã€‚</li>
<li>åè€… Multiple ï¼Œå…¶ä¸Šçš„æ³¨è§£ï¼Œ<code>prefix</code>&nbsp;éƒ½æ˜¯å¤æ•°ï¼Œä¸”æœ‰&nbsp;<code>multiple = true</code>&nbsp;ã€‚</li>
</ul>
</li>
<li>é‚£ä¹ˆä¼šæœ‰ä»€ä¹ˆæ•ˆæœå‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­å¾€&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-annotation/">ã€Œ4.3 @@EnableDubboConfigBindingsã€</a>&nbsp;å’Œ&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-annotation/">ã€Œ4.4 @@EnableDubboConfigBindingã€</a>&nbsp;çœ‹ã€‚</li>
</ul>
<h2 id="4-3-EnableDubboConfigBindings">4.3 @EnableDubboConfigBindings</h2>
<p><code>org.apache.dubbo.config.spring.context.annotation.@EnableDubboConfigBindings</code>&nbsp;æ³¨è§£ï¼Œæ˜¯&nbsp;<code>@EnableDubboConfigBinding</code>&nbsp;æ³¨è§£çš„æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// EnableDubboConfigBindings.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Multiple {<span class="doctag">@link</span> EnableDubboConfigBinding} {<span class="doctag">@link</span> Annotation}</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.8</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> EnableDubboConfigBinding</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="meta">@Target</span>({ElementType.TYPE})</span><br /><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br /><span class="line"><span class="meta">@Documented</span></span><br /><span class="line"><span class="meta">@Import</span>(DubboConfigBindingsRegistrar.class)</span><br /><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableDubboConfigBindings {</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * The value of {<span class="doctag">@link</span> EnableDubboConfigBindings}</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    EnableDubboConfigBinding[] value();</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>@Import(DubboConfigBindingsRegistrar.class)</code>&nbsp;æ³¨è§£ï¼Œè¡¨æ˜ä½¿ç”¨ DubboConfigBindingsRegistrar ç±»è¿›è¡Œå¯¼å…¥ã€‚è¯¦ç»†çš„ï¼Œæˆ‘ä»¬ç»§ç»­æ¥çœ‹&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-annotation/">ã€Œ4.3.1 DubboConfigBindingsRegistrarã€</a>&nbsp;ã€‚</li>
</ul>
<h3 id="4-3-1-DubboConfigBindingsRegistrar">4.3.1 DubboConfigBindingsRegistrar</h3>
<p><code>org.apache.dubbo.config.spring.context.annotation.DubboConfigBindingsRegistrar</code>&nbsp;ï¼Œå®ç° ImportBeanDefinitionRegistrarã€EnvironmentAware æ¥å£ï¼Œå¤„ç†&nbsp;<code>@EnableDubboConfigBindings</code>&nbsp;æ³¨è§£ï¼Œæ³¨å†Œç›¸åº”çš„ Dubbo AbstractConfig åˆ° Spring å®¹å™¨ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboConfigBindingsRegistrar.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * {<span class="doctag">@link</span> AbstractConfig Dubbo Config} binding Bean registrar for {<span class="doctag">@link</span> EnableDubboConfigBindings}</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> EnableDubboConfigBindings</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> DubboConfigBindingRegistrar</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.8</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboConfigBindingsRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span>, <span class="title">EnvironmentAware</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> ConfigurableEnvironment environment;</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>{</span><br /><span class="line">        <span class="comment">// &lt;1.1&gt; è·å¾— @EnableDubboConfigBindings æ³¨è§£</span></span><br /><span class="line">        AnnotationAttributes attributes = AnnotationAttributes.fromMap(importingClassMetadata.getAnnotationAttributes(EnableDubboConfigBindings.class.getName()));</span><br /><span class="line">        <span class="comment">// &lt;1.2&gt; è·å¾—å†…éƒ¨çš„ @EnableDubboConfigBinding æ³¨è§£çš„æ•°ç»„</span></span><br /><span class="line">        AnnotationAttributes[] annotationAttributes = attributes.getAnnotationArray(<span class="string">"value"</span>);</span><br /><span class="line">        <span class="comment">// &lt;2&gt; åˆ›å»º DubboConfigBindingRegistrar å¯¹è±¡ï¼Œå¹¶è®¾ç½® environment å±æ€§</span></span><br /><span class="line">        DubboConfigBindingRegistrar registrar = <span class="keyword">new</span> DubboConfigBindingRegistrar();</span><br /><span class="line">        registrar.setEnvironment(environment);</span><br /><span class="line">        <span class="comment">// &lt;3&gt; éå† annotationAttributes æ•°ç»„ï¼Œä½¿ç”¨ registrar è¿›è¡Œé€ä¸ª @EnableDubboConfigBinding æ³¨è§£çš„æ³¨å†Œå¯¹åº”çš„ Bean</span></span><br /><span class="line">        <span class="keyword">for</span> (AnnotationAttributes element : annotationAttributes) {</span><br /><span class="line">            registrar.registerBeanDefinitions(element, registry);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>{</span><br /><span class="line">        Assert.isInstanceOf(ConfigurableEnvironment.class, environment);</span><br /><span class="line">        <span class="keyword">this</span>.environment = (ConfigurableEnvironment) environment;</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1.1&gt;</code>ã€<code>&lt;1.2&gt;</code>&nbsp;å¤„ï¼Œè·å¾—&nbsp;<code>@EnableDubboConfigBindings</code>&nbsp;æ³¨è§£ï¼Œä»è€Œåé¢è·å¾—å†…éƒ¨çš„&nbsp;<code>@EnableDubboConfigBinding</code>&nbsp;æ³¨è§£çš„æ•°ç»„ã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œåˆ›å»º DubboConfigBindingRegistrar å¯¹è±¡ï¼Œå¹¶è®¾ç½®&nbsp;<code>environment</code>&nbsp;å±æ€§ã€‚</li>
<li><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œéå†&nbsp;<code>annotationAttributes</code>&nbsp;æ•°ç»„ï¼Œä½¿ç”¨&nbsp;<code>registrar</code>&nbsp;ï¼Œè°ƒç”¨&nbsp;<code>DubboConfigBindingRegistrar#registerBeanDefinitions(AnnotationAttributes attributes, BeanDefinitionRegistry registry)</code>&nbsp;æ–¹æ³•ï¼Œè¿›è¡Œé€ä¸ª&nbsp;<code>@EnableDubboConfigBinding</code>&nbsp;æ³¨è§£çš„æ³¨å†Œå¯¹åº”çš„ Bean ã€‚</li>
<li>åœ¨ä¸‹æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ° DubboConfigBindingRegistrar æœ¬æ¥å°±æ˜¯ç”¨æ¥å¤„ç†&nbsp;<code>EnableDubboConfigBinding</code>&nbsp;æ³¨è§£ã€‚</li>
</ul>
<h2 id="4-4-EnableDubboConfigBinding">4.4 @EnableDubboConfigBinding</h2>
<p><code>org.apache.dubbo.config.spring.context.annotation.@EnableDubboConfigBinding</code>&nbsp;æ³¨è§£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// EnableDubboConfigBinding.java</span></span><br /><br /><span class="line"><span class="meta">@Target</span>({ElementType.TYPE, ElementType.ANNOTATION_TYPE})</span><br /><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br /><span class="line"><span class="meta">@Documented</span></span><br /><span class="line"><span class="meta">@Repeatable</span>(EnableDubboConfigBindings.class)</span><br /><span class="line"><span class="meta">@Import</span>(DubboConfigBindingRegistrar.class)</span><br /><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableDubboConfigBinding {</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * The name prefix of the properties that are valid to bind to {<span class="doctag">@link</span> AbstractConfig Dubbo Config}.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * é…ç½®å‰ç¼€</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> the name prefix of the properties to bind</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function">String <span class="title">prefix</span><span class="params">()</span></span>;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * é…ç½®ç±»</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> The binding type of {<span class="doctag">@link</span> AbstractConfig Dubbo Config}.</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@see</span> AbstractConfig</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@see</span> ApplicationConfig</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@see</span> ModuleConfig</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@see</span> RegistryConfig</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    Class&lt;? extends AbstractConfig&gt; type();</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ˜¯å¦ multiple</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * It indicates whether {<span class="doctag">@link</span> #prefix()} binding to multiple Spring Beans.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> the default value is &lt;code&gt;false&lt;/code&gt;</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">multiple</span><span class="params">()</span> <span class="keyword">default</span> <span class="keyword">false</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ¯ä¸ªå±æ€§ï¼Œçœ‹å…¶ä¸Šçš„ä»£ç æ³¨é‡Šã€‚</li>
<li>
<ul>
<li><code>@Import(DubboConfigBindingRegistrar.class)</code>&nbsp;æ³¨è§£ï¼Œè¡¨æ˜ä½¿ç”¨ DubboConfigBindingRegistrar ç±»è¿›è¡Œå¯¼å…¥ã€‚è¯¦ç»†çš„ï¼Œæˆ‘ä»¬ç»§ç»­æ¥çœ‹&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-annotation/">ã€Œ4.4.1 DubboConfigBindingRegistrarã€</a>&nbsp;ã€‚</li>
</ul>
</li>
</ul>
<h3 id="4-4-1-DubboConfigBindingRegistrar">4.4.1 DubboConfigBindingRegistrar</h3>
<p><code>org.apache.dubbo.config.spring.context.annotation.DubboConfigBindingRegistrar</code>&nbsp;ï¼Œå®ç° ImportBeanDefinitionRegistrarã€EnvironmentAware æ¥å£ï¼Œå¤„ç†&nbsp;<code>@EnableDubboConfigBinding</code>&nbsp;æ³¨è§£ï¼Œæ³¨å†Œç›¸åº”çš„ Dubbo AbstractConfig åˆ° Spring å®¹å™¨ä¸­ã€‚</p>
<h4 id="4-4-1-1-registerBeanDefinitions">4.4.1.1 registerBeanDefinitions</h4>
<p>å®ç°&nbsp;<code>#registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</code>&nbsp;æ–¹æ³•ï¼Œå¤„ç†&nbsp;<code>@EnableDubboConfigBinding</code>&nbsp;æ³¨è§£ï¼Œæ³¨å†Œç›¸åº”çš„ Dubbo AbstractConfig åˆ° Spring å®¹å™¨ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboConfigBindingRegistrar.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; è·å¾— @EnableDubboConfigBinding æ³¨è§£</span></span><br /><span class="line">    AnnotationAttributes attributes = AnnotationAttributes.fromMap(importingClassMetadata.getAnnotationAttributes(EnableDubboConfigBinding.class.getName()));</span><br /><span class="line">    <span class="comment">// &lt;2&gt; æ³¨å†Œé…ç½®å¯¹åº”çš„ Bean Definition å¯¹è±¡</span></span><br /><span class="line">    registerBeanDefinitions(attributes, registry);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationAttributes attributes, BeanDefinitionRegistry registry)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;2.1&gt; è·å¾— prefix å±æ€§</span></span><br /><span class="line">    String prefix = environment.resolvePlaceholders(attributes.getString(<span class="string">"prefix"</span>)); <span class="comment">// å› ä¸ºï¼Œæœ‰å¯èƒ½æœ‰å ä½ç¬¦ï¼Œæ‰€ä»¥è¦è§£æã€‚</span></span><br /><span class="line">    <span class="comment">// &lt;2.2&gt; è·å¾— type å±æ€§ï¼Œå³ AbstractConfig çš„å®ç°ç±»</span></span><br /><span class="line">    Class&lt;? extends AbstractConfig&gt; configClass = attributes.getClass(<span class="string">"type"</span>);</span><br /><span class="line">    <span class="comment">// &lt;2.3&gt; è·å¾— multiple å±æ€§</span></span><br /><span class="line">    <span class="keyword">boolean</span> multiple = attributes.getBoolean(<span class="string">"multiple"</span>);</span><br /><span class="line">    <span class="comment">// &lt;2.4&gt; æ³¨å†Œ Dubbo Config Bean å¯¹è±¡</span></span><br /><span class="line">    registerDubboConfigBeans(prefix, configClass, multiple, registry);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè·å¾—&nbsp;<code>@EnableDubboConfigBinding</code>&nbsp;æ³¨è§£ã€‚</li>
<li><code>&lt;2&gt;</code>&nbsp;æ³¨å†Œé…ç½®å¯¹åº”çš„ Bean Definition å¯¹è±¡ã€‚ğŸ˜ˆ è¿™é‡Œæœ‰ä¸ªçŸ¥è¯†ç‚¹è¦è¡¥å……ä¸‹ï¼ŒSpring åœ¨åˆ›å»º Bean ä¹‹å‰ï¼Œä¼šå°† XML é…ç½®æˆ–è€…æ³¨è§£é…ç½®ï¼Œå…ˆè§£ææˆå¯¹åº”çš„ BeanDefinition å¯¹è±¡ï¼Œç„¶ååœ¨åˆ›å»º Bean å¯¹è±¡ã€‚
<ul>
<li><code>&lt;2.1&gt;</code>&nbsp;å¤„ï¼Œè·å¾—&nbsp;<code>prefix</code>&nbsp;å±æ€§ã€‚</li>
<li><code>&lt;2.2&gt;</code>&nbsp;å¤„ï¼Œè·å¾—&nbsp;<code>type</code>&nbsp;å±æ€§ï¼Œå³ AbstractConfig çš„å®ç°ç±»ã€‚</li>
<li><code>&lt;2.3&gt;</code>&nbsp;å¤„ï¼Œè·å¾—&nbsp;<code>multiple</code>&nbsp;å±æ€§ã€‚</li>
<li><code>&lt;2.4&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#registerDubboConfigBeans(String prefix, Class&lt;? extends AbstractConfig&gt; configClass, boolean multiple, BeanDefinitionRegistry registry)</code>&nbsp;æ–¹æ³•ï¼Œæ³¨å†Œ Dubbo Config Bean å¯¹è±¡ã€‚</li>
</ul>
</li>
</ul>
<h4 id="4-4-1-2-registerDubboConfigBeans">4.4.1.2 registerDubboConfigBeans</h4>
<p><code>#registerDubboConfigBeans(String prefix, Class&lt;? extends AbstractConfig&gt; configClass, boolean multiple, BeanDefinitionRegistry registry)</code>&nbsp;æ–¹æ³•ï¼Œæ³¨å†Œ Dubbo Config Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboConfigBindingRegistrar.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerDubboConfigBeans</span><span class="params">(String prefix, Class&lt;? extends AbstractConfig&gt; configClass, <span class="keyword">boolean</span> multiple,</span></span></span><br /><span class="line"><span class="function"><span class="params">                                      BeanDefinitionRegistry registry)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1.1&gt; è·å¾— prefix å¼€å¤´çš„é…ç½®å±æ€§</span></span><br /><span class="line">    Map&lt;String, Object&gt; properties = PropertySourcesUtils.getSubProperties(environment.getPropertySources(), prefix);</span><br /><span class="line">    <span class="comment">// &lt;1.2&gt; å¦‚æœé…ç½®å±æ€§ä¸ºç©ºï¼Œåˆ™æ— éœ€åˆ›å»º</span></span><br /><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(properties)) {</span><br /><span class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) {</span><br /><span class="line">            log.debug(<span class="string">"There is no property for binding to dubbo config class ["</span> + configClass.getName()</span><br /><span class="line">                    + <span class="string">"] within prefix ["</span> + prefix + <span class="string">"]"</span>);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// &lt;2&gt; è·å¾—é…ç½®å±æ€§å¯¹åº”çš„ Bean åå­—çš„é›†åˆ</span></span><br /><span class="line">    Set&lt;String&gt; beanNames = multiple ? resolveMultipleBeanNames(properties) :</span><br /><span class="line">            Collections.singleton(resolveSingleBeanName(properties, configClass, registry));</span><br /><span class="line">    <span class="comment">// &lt;3&gt; éå† beanNames æ•°ç»„ï¼Œé€ä¸ªæ³¨å†Œ</span></span><br /><span class="line">    <span class="keyword">for</span> (String beanName : beanNames) {</span><br /><span class="line">        <span class="comment">// &lt;3.1&gt; æ³¨æ³¨å†Œ Dubbo Config Bean å¯¹è±¡</span></span><br /><span class="line">        registerDubboConfigBean(beanName, configClass, registry);</span><br /><span class="line">        <span class="comment">// &lt;3.2&gt; æ³¨æ³¨å†Œ Dubbo Config å¯¹è±¡å¯¹åº”çš„ DubboConfigBindingBeanPostProcessor å¯¹è±¡</span></span><br /><span class="line">        registerDubboConfigBindingBeanPostProcessor(prefix, beanName, multiple, registry);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1.1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>PropertySourcesUtils#getSubProperties(Iterable&lt;PropertySource&lt;?&gt;&gt; propertySources, String prefix)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—&nbsp;<code>prefix</code>&nbsp;å¼€å¤´çš„é…ç½®å±æ€§ã€‚å› ä¸ºï¼Œåç»­ä¼šç”¨è¿™ä¸ªå±æ€§ï¼Œè®¾ç½®åˆ°åˆ›å»ºçš„ Bean å¯¹è±¡ä¸­ã€‚</li>
<li><code>&lt;1.2&gt;</code>&nbsp;å¤„ï¼Œå¦‚æœé…ç½®å±æ€§ä¸ºç©ºï¼Œåˆ™æ— éœ€åˆ›å»ºã€‚</li>
<li>
<p><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œæ ¹æ®&nbsp;<code>multiple</code>&nbsp;çš„å€¼ï¼Œè°ƒç”¨ä¸åŒçš„æ–¹æ³•ï¼Œè·å¾—é…ç½®å±æ€§å¯¹åº”çš„ Bean åå­—çš„é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboConfigBindingRegistrar.java</span></span><br /><br /><span class="line"><span class="comment">// ä¾‹å¦‚ï¼šdubbo.application.${beanName}.name=dubbo-demo-annotation-provider</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> Set&lt;String&gt; <span class="title">resolveMultipleBeanNames</span><span class="params">(Map&lt;String, Object&gt; properties)</span> </span>{</span><br /><span class="line">    Set&lt;String&gt; beanNames = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;();</span><br /><span class="line">    <span class="keyword">for</span> (String propertyName : properties.keySet()) {</span><br /><span class="line">        <span class="comment">// è·å–ä¸Šè¿°ç¤ºä¾‹çš„ ${beanName} å­—ç¬¦ä¸²</span></span><br /><span class="line">        <span class="keyword">int</span> index = propertyName.indexOf(<span class="string">"."</span>);</span><br /><span class="line">        <span class="keyword">if</span> (index &gt; <span class="number">0</span>) {</span><br /><span class="line">            String beanName = propertyName.substring(<span class="number">0</span>, index);</span><br /><span class="line">            beanNames.add(beanName);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> beanNames;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">// ä¾‹å¦‚ï¼šdubbo.application.name=dubbo-demo-annotation-provider</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">resolveSingleBeanName</span><span class="params">(Map&lt;String, Object&gt; properties, Class&lt;? extends AbstractConfig&gt; configClass,</span></span></span><br /><span class="line"><span class="function"><span class="params">                                     BeanDefinitionRegistry registry)</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾— Bean çš„åå­—</span></span><br /><span class="line">    String beanName = (String) properties.get(<span class="string">"id"</span>);</span><br /><span class="line">    <span class="comment">// å¦‚æœå®šä¹‰ï¼ŒåŸºäº Spring æä¾›çš„æœºåˆ¶ï¼Œç”Ÿæˆå¯¹åº”çš„ Bean çš„åå­—ã€‚ä¾‹å¦‚è¯´ï¼šorg.apache.dubbo.config.ApplicationConfig#0</span></span><br /><span class="line">    <span class="keyword">if</span> (!StringUtils.hasText(beanName)) {</span><br /><span class="line">        BeanDefinitionBuilder builder = BeanDefinitionBuilder.rootBeanDefinition(configClass);</span><br /><span class="line">        beanName = BeanDefinitionReaderUtils.generateBeanName(builder.getRawBeanDefinition(), registry);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> beanName;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œçœ‹çœ‹æˆ‘æä¾›çš„ç¤ºä¾‹ã€‚</li>
<li>
<p><code>#resolveMultipleBeanNames(Map&lt;String, Object&gt; properties)</code>&nbsp;æ–¹æ³•ï¼Œå¯èƒ½æ¯”è¾ƒéš¾ç†è§£ä¸€ç‚¹ã€‚èƒ–å‹å¯ä»¥å¢åŠ å¦‚ä¸‹åˆ°é…ç½®æ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight plain">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"># application.properties</span><br /><span class="line">dubbo.applications.x.name=biu</span><br /><span class="line">dubbo.applications.y.name=biubiubiu</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ­¤æ—¶ï¼Œä½ éœ€è¦æŒ‡å®š&nbsp;<code>@Service</code>&nbsp;Bean ä½¿ç”¨å“ªä¸ªåº”ç”¨ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œéå†&nbsp;<code>beanNames</code>&nbsp;æ•°ç»„ï¼Œé€ä¸ªæ³¨å†Œã€‚</p>
<ul>
<li>
<p><code>&lt;3.1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#registerDubboConfigBean(String beanName, Class&lt;? extends AbstractConfig&gt; configClass, BeanDefinitionRegistry registry)</code>&nbsp;æ–¹æ³•ï¼Œæ³¨å†Œ Dubbo Config Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboConfigBindingRegistrar.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerDubboConfigBean</span><span class="params">(String beanName, Class&lt;? extends AbstractConfig&gt; configClass,</span></span></span><br /><span class="line"><span class="function"><span class="params">                                     BeanDefinitionRegistry registry)</span> </span>{</span><br /><span class="line">    <span class="comment">// åˆ›å»º BeanDefinitionBuilder å¯¹è±¡</span></span><br /><span class="line">    BeanDefinitionBuilder builder = BeanDefinitionBuilder.rootBeanDefinition(configClass);</span><br /><span class="line">    <span class="comment">// è·å¾— AbstractBeanDefinition å¯¹è±¡</span></span><br /><span class="line">    AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();</span><br /><span class="line">    <span class="comment">// æ³¨å†Œåˆ° registry ä¸­</span></span><br /><span class="line">    registry.registerBeanDefinition(beanName, beanDefinition);</span><br /><span class="line">    <span class="keyword">if</span> (log.isInfoEnabled()) {</span><br /><span class="line">        log.info(<span class="string">"The dubbo config bean definition [name : "</span> + beanName + <span class="string">", class : "</span> + configClass.getName() + <span class="string">"] has been registered."</span>);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ­¤æ—¶ï¼Œä»…ä»…æ˜¯é€šè¿‡é…±ç´«çš„æ–¹å¼ï¼Œåˆ›å»ºäº†ä¸€ä¸ª Dubbo Config Bean å¯¹è±¡ï¼Œå¹¶æ²¡æœ‰å°†é…ç½®å±æ€§ï¼Œè®¾ç½®åˆ°è¯¥å¯¹è±¡ä¸­ã€‚ç­”æ¡ˆåœ¨&nbsp;<code>&lt;3.2&gt;</code>&nbsp;ä¸­ã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;3.2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#registerDubboConfigBindingBeanPostProcessor(String prefix, String beanName, boolean multiple, BeanDefinitionRegistry registry)</code>&nbsp;æ–¹æ³•ï¼Œæ³¨å†Œ Dubbo Config å¯¹è±¡å¯¹è±¡çš„ DubboConfigBindingBeanPostProcessor å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboConfigBindingRegistrar.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerDubboConfigBindingBeanPostProcessor</span><span class="params">(String prefix, String beanName, <span class="keyword">boolean</span> multiple,</span></span></span><br /><span class="line"><span class="function"><span class="params">                                                         BeanDefinitionRegistry registry)</span> </span>{</span><br /><span class="line">    <span class="comment">// åˆ›å»º BeanDefinitionBuilder å¯¹è±¡</span></span><br /><span class="line">    Class&lt;?&gt; processorClass = DubboConfigBindingBeanPostProcessor.class;</span><br /><span class="line">    BeanDefinitionBuilder builder = rootBeanDefinition(processorClass);</span><br /><span class="line">    <span class="comment">// æ·»åŠ æ„é€ æ–¹æ³•çš„å‚æ•°ä¸º actualPrefix å’Œ beanName ã€‚å³ï¼Œåˆ›å»º DubboConfigBindingBeanPostProcessor å¯¹è±¡ï¼Œéœ€è¦è¿™ä¸¤ä¸ªæ„é€ å‚æ•°</span></span><br /><span class="line">    String actualPrefix = multiple ? PropertySourcesUtils.normalizePrefix(prefix) + beanName : prefix;</span><br /><span class="line">    builder.addConstructorArgValue(actualPrefix).addConstructorArgValue(beanName);</span><br /><span class="line">    <span class="comment">// è·å¾— AbstractBeanDefinition å¯¹è±¡</span></span><br /><span class="line">    AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();</span><br /><span class="line">    <span class="comment">// è®¾ç½® role å±æ€§</span></span><br /><span class="line">    beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br /><span class="line">    <span class="comment">// æ³¨å†Œåˆ° registry ä¸­</span></span><br /><span class="line">    BeanDefinitionReaderUtils.registerWithGeneratedName(beanDefinition, registry);</span><br /><span class="line">    <span class="keyword">if</span> (log.isInfoEnabled()) {</span><br /><span class="line">        log.info(<span class="string">"The BeanPostProcessor bean definition ["</span> + processorClass.getName() + <span class="string">"] for dubbo config bean [name : "</span> + beanName + <span class="string">"] has been registered."</span>);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å› ä¸ºæ­¤æ—¶ Dubbo Config Bean å¯¹è±¡è¿˜æœªåˆ›å»ºï¼Œæ‰€ä»¥éœ€è¦ç­‰åç»­å®ƒçœŸçš„åˆ›å»ºä¹‹åï¼Œä½¿ç”¨ DubboConfigBindingBeanPostProcessor ç±»ï¼Œå®ç°å¯¹å¯¹è±¡ï¼ˆBean å¯¹è±¡ï¼‰çš„é…ç½®è¾“å…¥çš„è®¾ç½®ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å‘ç°ï¼Œéœ€è¦ç»§ç»­æŒ–æ˜ï¼Œè®©æˆ‘ä»¬ç»§ç»­æ¥çœ‹&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-annotation/">ã€ŒDubboConfigBindingBeanPostProcessorã€</a>&nbsp;ç±»ã€‚</p>
<h2 id="4-5-DubboConfigBindingBeanPostProcessor">4.5 DubboConfigBindingBeanPostProcessor</h2>
<p><code>org.apache.dubbo.config.spring.beans.factory.annotation.DubboConfigBindingBeanPostProcessor</code>&nbsp;ï¼Œå®ç° BeanPostProcessorã€ApplicationContextAwareã€InitializingBean æ¥å£ï¼Œå¤„ç† Dubbo AbstractConfig Bean çš„é…ç½®å±æ€§æ³¨å…¥ã€‚</p>
<h3 id="4-5-1-æ„é€ æ–¹æ³•">4.5.1 æ„é€ æ–¹æ³•</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboConfigBindingBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * The prefix of Configuration Properties</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * é…ç½®å±æ€§çš„å‰ç¼€</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String prefix;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Binding Bean Name</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Bean çš„åå­—</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String beanName;</span><br /><br /><span class="line"><span class="keyword">private</span> DubboConfigBinder dubboConfigBinder;</span><br /><br /><span class="line"><span class="keyword">private</span> ApplicationContext applicationContext;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦å¿½ç•¥ä½ç½®çš„å±æ€§</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> ignoreUnknownFields = <span class="keyword">true</span>;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦å¿½ç•¥ç±»å‹ä¸å¯¹çš„å±æ€§</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> ignoreInvalidFields = <span class="keyword">true</span>;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> prefix   the prefix of Configuration Properties</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> beanName the binding Bean Name</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DubboConfigBindingBeanPostProcessor</span><span class="params">(String prefix, String beanName)</span> </span>{</span><br /><span class="line">    Assert.notNull(prefix, <span class="string">"The prefix of Configuration Properties must not be null"</span>);</span><br /><span class="line">    Assert.notNull(beanName, <span class="string">"The name of bean must not be null"</span>);</span><br /><span class="line">    <span class="keyword">this</span>.prefix = prefix;</span><br /><span class="line">    <span class="keyword">this</span>.beanName = beanName;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ‰€ä»¥ï¼Œæˆ‘ä»¬åœ¨ä¸Šæ–‡ä¸­ä¼šçœ‹åˆ°ï¼Œåˆ›å»º DubboConfigBindingBeanPostProcessor Bean æ—¶ï¼Œä¼šæœ‰&nbsp;<code>builder.addConstructorArgValue(actualPrefix).addConstructorArgValue(beanName);</code>&nbsp;ä¸€æ®µçš„ä»£ç ã€‚</li>
</ul>
<h3 id="4-5-2-afterPropertiesSet">4.5.2 afterPropertiesSet</h3>
<p><code>#afterPropertiesSet()</code>&nbsp;æ–¹æ³•ï¼Œè®¾ç½®&nbsp;<code>dubboConfigBinder</code>&nbsp;å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboConfigBindingBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line">    <span class="comment">// è·å¾—ï¼ˆåˆ›å»ºï¼‰DubboConfigBinder å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">if</span> (dubboConfigBinder == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            dubboConfigBinder = applicationContext.getBean(DubboConfigBinder.class);</span><br /><span class="line">        } <span class="keyword">catch</span> (BeansException ignored) {</span><br /><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) {</span><br /><span class="line">                log.debug(<span class="string">"DubboConfigBinder Bean can't be found in ApplicationContext."</span>);</span><br /><span class="line">            }</span><br /><span class="line">            <span class="comment">// Use Default implementation</span></span><br /><span class="line">            dubboConfigBinder = createDubboConfigBinder(applicationContext.getEnvironment());</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è®¾ç½® ignoreUnknownFieldsã€ignoreInvalidFields å±æ€§</span></span><br /><span class="line">    dubboConfigBinder.setIgnoreUnknownFields(ignoreUnknownFields);</span><br /><span class="line">    dubboConfigBinder.setIgnoreInvalidFields(ignoreInvalidFields);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Create {<span class="doctag">@link</span> DubboConfigBinder} instance.</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> environment</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> {<span class="doctag">@link</span> DefaultDubboConfigBinder}</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> DubboConfigBinder <span class="title">createDubboConfigBinder</span><span class="params">(Environment environment)</span> </span>{</span><br /><span class="line">    <span class="comment">// åˆ›å»º DefaultDubboConfigBinder å¯¹è±¡</span></span><br /><span class="line">    DefaultDubboConfigBinder defaultDubboConfigBinder = <span class="keyword">new</span> DefaultDubboConfigBinder();</span><br /><span class="line">    <span class="comment">// è®¾ç½® environment å±æ€§</span></span><br /><span class="line">    defaultDubboConfigBinder.setEnvironment(environment);</span><br /><span class="line">    <span class="keyword">return</span> defaultDubboConfigBinder;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å…³äº DefaultDubboConfigBinder ç±»ï¼Œæˆ‘ä»¬åœ¨ä¸‹é¢çš„å°èŠ‚å…ˆæ¥ç…ç…ã€‚</li>
</ul>
<h4 id="4-5-2-1-DubboConfigBinder">4.5.2.1 DubboConfigBinder</h4>
<p><code>org.apache.dubbo.config.spring.context.properties.DubboConfigBinder</code>&nbsp;ï¼Œç»§æ‰¿ EnvironmentAware æ¥å£ï¼ŒDubbo Config Binder æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboConfigBinder.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * {<span class="doctag">@link</span> AbstractConfig DubboConfig} Binder</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> AbstractConfig</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> EnvironmentAware</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.11</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DubboConfigBinder</span> <span class="keyword">extends</span> <span class="title">EnvironmentAware</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Set whether to ignore unknown fields, that is, whether to ignore bind</span></span><br /><span class="line"><span class="comment">     * parameters that do not have corresponding fields in the target object.</span></span><br /><span class="line"><span class="comment">     * &lt;p&gt;Default is "true". Turn this off to enforce that all bind parameters</span></span><br /><span class="line"><span class="comment">     * must have a matching field in the target object.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@see</span> #bind</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setIgnoreUnknownFields</span><span class="params">(<span class="keyword">boolean</span> ignoreUnknownFields)</span></span>;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Set whether to ignore invalid fields, that is, whether to ignore bind</span></span><br /><span class="line"><span class="comment">     * parameters that have corresponding fields in the target object which are</span></span><br /><span class="line"><span class="comment">     * not accessible (for example because of null values in the nested path).</span></span><br /><span class="line"><span class="comment">     * &lt;p&gt;Default is "false".</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@see</span> #bind</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setIgnoreInvalidFields</span><span class="params">(<span class="keyword">boolean</span> ignoreInvalidFields)</span></span>;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Bind the properties to Dubbo Config Object under specified prefix.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> prefix</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> dubboConfig</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    &lt;C extends AbstractConfig&gt; <span class="function"><span class="keyword">void</span> <span class="title">bind</span><span class="params">(String prefix, C dubboConfig)</span></span>;</span><br />    <br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>åç»­çš„å®ç°ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°åŸºäº Spring DataBinder æ¥å®ç°ã€‚ä¸äº†è§£ DataBinder çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹&nbsp;<a href="https://my.oschina.net/u/2453016/blog/1512184" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠSpring éªŒè¯ã€æ•°æ®ç»‘å®šå’Œç±»å‹è½¬æ¢ã€‹</a>&nbsp;æ–‡ç« ã€‚</li>
</ul>
<h4 id="4-5-2-2-DubboConfigBinder">4.5.2.2 DubboConfigBinder</h4>
<p><code>org.apache.dubbo.config.spring.context.properties.AbstractDubboConfigBinder</code>&nbsp;ï¼Œå®ç° DubboConfigBinder æ¥å£ï¼ŒDubboConfigBinder çš„æŠ½è±¡åŸºç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// AbstractDubboConfigBinder.java</span></span><br /><br /><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDubboConfigBinder</span> <span class="keyword">implements</span> <span class="title">DubboConfigBinder</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * PropertySource æ•°ç»„ï¼ˆè¿­ä»£ï¼‰</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> Iterable&lt;PropertySource&lt;?&gt;&gt; propertySources;</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> ignoreUnknownFields = <span class="keyword">true</span>;</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> ignoreInvalidFields = <span class="keyword">false</span>;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Get multiple {<span class="doctag">@link</span> PropertySource propertySources}</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> multiple {<span class="doctag">@link</span> PropertySource propertySources}</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">protected</span> Iterable&lt;PropertySource&lt;?&gt;&gt; getPropertySources() {</span><br /><span class="line">        <span class="keyword">return</span> propertySources;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isIgnoreUnknownFields</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> ignoreUnknownFields;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIgnoreUnknownFields</span><span class="params">(<span class="keyword">boolean</span> ignoreUnknownFields)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.ignoreUnknownFields = ignoreUnknownFields;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isIgnoreInvalidFields</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> ignoreInvalidFields;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setIgnoreInvalidFields</span><span class="params">(<span class="keyword">boolean</span> ignoreInvalidFields)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.ignoreInvalidFields = ignoreInvalidFields;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setEnvironment</span><span class="params">(Environment environment)</span> </span>{</span><br /><span class="line">        <span class="keyword">if</span> (environment <span class="keyword">instanceof</span> ConfigurableEnvironment) {</span><br /><span class="line">            <span class="keyword">this</span>.propertySources = ((ConfigurableEnvironment) environment).getPropertySources();</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æä¾›é»˜è®¤çš„å±æ€§ã€‚</li>
</ul>
<h4 id="4-5-2-3-DefaultDubboConfigBinder">4.5.2.3 DefaultDubboConfigBinder</h4>
<p><code>org.apache.dubbo.config.spring.context.properties.DefaultDubboConfigBinder</code>&nbsp;ï¼Œç»§æ‰¿ AbstractDubboConfigBinder æŠ½è±¡ç±»ï¼Œä½¿ç”¨ Spring DataBinder ï¼Œå°†é…ç½®å±æ€§è®¾ç½®åˆ° Dubbo Config å¯¹è±¡ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DefaultDubboConfigBinder.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Default {<span class="doctag">@link</span> DubboConfigBinder} implementation based on Spring {<span class="doctag">@link</span> DataBinder}</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultDubboConfigBinder</span> <span class="keyword">extends</span> <span class="title">AbstractDubboConfigBinder</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="keyword">public</span> &lt;C extends AbstractConfig&gt; <span class="function"><span class="keyword">void</span> <span class="title">bind</span><span class="params">(String prefix, C dubboConfig)</span> </span>{</span><br /><span class="line">        <span class="comment">// å°† dubboConfig åŒ…è£…æˆ DataBinder å¯¹è±¡</span></span><br /><span class="line">        DataBinder dataBinder = <span class="keyword">new</span> DataBinder(dubboConfig);</span><br /><span class="line">        <span class="comment">// Set ignored*</span></span><br /><span class="line">        <span class="comment">// è®¾ç½®å“åº”çš„ ignored* å±æ€§</span></span><br /><span class="line">        dataBinder.setIgnoreInvalidFields(isIgnoreInvalidFields());</span><br /><span class="line">        dataBinder.setIgnoreUnknownFields(isIgnoreUnknownFields());</span><br /><span class="line">        <span class="comment">// Get properties under specified prefix from PropertySources</span></span><br /><span class="line">        <span class="comment">// è·å¾— prefix å¼€å¤´çš„é…ç½®å±æ€§</span></span><br /><span class="line">        Map&lt;String, Object&gt; properties = PropertySourcesUtils.getSubProperties(getPropertySources(), prefix);</span><br /><span class="line">        <span class="comment">// Convert Map to MutablePropertyValues</span></span><br /><span class="line">        <span class="comment">// åˆ›å»º MutablePropertyValues å¯¹è±¡</span></span><br /><span class="line">        MutablePropertyValues propertyValues = <span class="keyword">new</span> MutablePropertyValues(properties);</span><br /><span class="line">        <span class="comment">// Bind</span></span><br /><span class="line">        <span class="comment">// ç»‘å®šé…ç½®å±æ€§åˆ° dubboConfig ä¸­</span></span><br /><span class="line">        dataBinder.bind(propertyValues);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±ç…ä¸€çœ¼ä»£ç å³å¯ã€‚</li>
</ul>
<p>åœ¨&nbsp;<a href="http://www.iocoder.cn/Dubbo/spring-boot-integration/" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo æºç åˆ†æ &mdash;&mdash; é›†æˆ Spring Bootã€‹</a>&nbsp;ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦å¤–ä¸€ä¸ª AbstractDubboConfigBinder çš„å®ç°ç±» RelaxedDubboConfigBinder ï¼Œå®ƒæ˜¯åŸºäº Spring Boot&nbsp;<a href="https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/context/properties/bind/Binder.html" target="_blank" rel="external nofollow noopener noreferrer">Binder</a>&nbsp;è¿›è¡Œå®ç°ã€‚ğŸ˜ˆ å› ä¸ºè‰¿è‰¿æ²¡æœ‰æ·±å…¥äº†è§£è¿‡ Spring Boot Binder ç›¸å…³ï¼Œæ‰€ä»¥è¿˜è¯´ä¸å‡ºå’Œ Spring DataBinder çš„åŒºåˆ«åœ¨å“ªã€‚orz</p>
<h3 id="4-5-3-postProcessBeforeInitialization">4.5.3 postProcessBeforeInitialization</h3>
<p>å®ç°&nbsp;<code>#postProcessBeforeInitialization(Object bean, String beanName)</code>&nbsp;æ–¹æ³•ï¼Œè®¾ç½®é…ç½®å±æ€§åˆ° Dubbo Config ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboConfigBindingBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException </span>{</span><br /><span class="line">    <span class="comment">// åˆ¤æ–­å¿…é¡»æ˜¯ beanName ï¼Œå¹¶ä¸”æ˜¯ AbstractConfig ç±»å‹</span></span><br /><span class="line">    <span class="keyword">if</span> (beanName.equals(<span class="keyword">this</span>.beanName) &amp;&amp; bean <span class="keyword">instanceof</span> AbstractConfig) {</span><br /><span class="line">        AbstractConfig dubboConfig = (AbstractConfig) bean;</span><br /><span class="line">        <span class="comment">// è®¾ç½®å±æ€§åˆ° dubboConfig ä¸­</span></span><br /><span class="line">        dubboConfigBinder.bind(prefix, dubboConfig);</span><br /><span class="line">        <span class="keyword">if</span> (log.isInfoEnabled()) {</span><br /><span class="line">            log.info(<span class="string">"The properties of bean [name : "</span> + beanName + <span class="string">"] have been binding by prefix of "</span> + <span class="string">"configuration properties : "</span> + prefix);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> bean;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>è‡³æ­¤ï¼ŒDubbo Config å¯¹è±¡çš„åˆ›å»ºå’Œå±æ€§è®¾ç½®ï¼Œå·²ç»å®Œæˆã€‚å¦‚æœèƒ–å‹è¿˜æ˜¯æœ‰ç‚¹æ‡µé€¼ï¼Œå¯ä»¥è°ƒè¯•ä¸€æ¬¡ï¼Œæ²¡æœ‰ä»€ä¹ˆå¤æ‚é€»è¾‘å“Ÿã€‚</p>
<h1 id="5-DubboComponentScan">5. @DubboComponentScan</h1>
<p><code>org.apache.dubbo.config.spring.context.annotation.@DubboComponentScan</code>&nbsp;æ³¨è§£ï¼Œé…ç½®è¦æ‰«æ&nbsp;<code>@Service</code>&nbsp;å’Œ&nbsp;<code>@Reference</code>&nbsp;æ³¨è§£çš„åŒ…æˆ–è€…ç±»ä»¬ï¼Œä»è€Œåˆ›å»ºå¯¹åº”çš„ Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboComponentScan.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Dubbo Component Scan {<span class="doctag">@link</span> Annotation},scans the classpath for annotated components that will be auto-registered as</span></span><br /><span class="line"><span class="comment"> * Spring beans. Dubbo-provided {<span class="doctag">@link</span> Service} and {<span class="doctag">@link</span> Reference}.</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> Service</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> Reference</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.7</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br /><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br /><span class="line"><span class="meta">@Documented</span></span><br /><span class="line"><span class="meta">@Import</span>(DubboComponentScanRegistrar.class)</span><br /><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> DubboComponentScan {</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * å’Œ {<span class="doctag">@link</span> #basePackages()} ç­‰ä»·</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * Alias for the {<span class="doctag">@link</span> #basePackages()} attribute. Allows for more concise annotation</span></span><br /><span class="line"><span class="comment">     * declarations e.g.: {<span class="doctag">@code</span> <span class="doctag">@DubboComponentScan</span>("org.my.pkg")} instead of</span></span><br /><span class="line"><span class="comment">     * {<span class="doctag">@code</span> <span class="doctag">@DubboComponentScan</span>(basePackages="org.my.pkg")}.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> the base packages to scan</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    String[] value() <span class="keyword">default</span> {};</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * è¦æ‰«æçš„åŒ…çš„æ•°ç»„</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * Base packages to scan for annotated <span class="doctag">@Service</span> classes. {<span class="doctag">@link</span> #value()} is an</span></span><br /><span class="line"><span class="comment">     * alias for (and mutually exclusive with) this attribute.</span></span><br /><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br /><span class="line"><span class="comment">     * Use {<span class="doctag">@link</span> #basePackageClasses()} for a type-safe alternative to String-based</span></span><br /><span class="line"><span class="comment">     * package names.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> the base packages to scan</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    String[] basePackages() <span class="keyword">default</span> {};</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * è¦æ‰«æçš„ç±»çš„æ•°ç»„</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * Type-safe alternative to {<span class="doctag">@link</span> #basePackages()} for specifying the packages to</span></span><br /><span class="line"><span class="comment">     * scan for annotated <span class="doctag">@Service</span> classes. The package of each class specified will be</span></span><br /><span class="line"><span class="comment">     * scanned.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> classes from the base packages to scan</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    Class&lt;?&gt;[] basePackageClasses() <span class="keyword">default</span> {};</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>@Import(DubboComponentScanRegistrar.class)</code>&nbsp;æ³¨è§£ï¼Œè¡¨æ˜ä½¿ç”¨ DubboComponentScanRegistrar ç±»è¿›è¡Œå¯¼å…¥ã€‚è¯¦ç»†çš„ï¼Œæˆ‘ä»¬ç»§ç»­æ¥çœ‹&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-annotation/">ã€Œ5.1 DubboComponentScanRegistrarã€</a>&nbsp;ã€‚</li>
</ul>
<h2 id="5-1-DubboComponentScanRegistrar">5.1 DubboComponentScanRegistrar</h2>
<p><code>org.apache.dubbo.config.spring.context.annotation.DubboComponentScanRegistrar</code>&nbsp;ï¼Œå®ç° ImportBeanDefinitionRegistrar æ¥å£ï¼Œå¤„ç†&nbsp;<code>@DubboComponentScan</code>&nbsp;æ³¨è§£ï¼Œæ³¨å†Œç›¸åº”çš„ ServiceAnnotationBeanPostProcessor å’Œ ReferenceAnnotationBeanPostProcessor åˆ° Spring å®¹å™¨ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboComponentScanRegistrar.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; è·å¾—è¦æ‰«æçš„åŒ…</span></span><br /><span class="line">    Set&lt;String&gt; packagesToScan = getPackagesToScan(importingClassMetadata);</span><br /><span class="line">    <span class="comment">// &lt;2&gt; åˆ›å»º ServiceAnnotationBeanPostProcessor Bean å¯¹è±¡ï¼Œåç»­æ‰«æ `@Service` æ³¨è§£çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ Service Bean å¯¹è±¡</span></span><br /><span class="line">    registerServiceAnnotationBeanPostProcessor(packagesToScan, registry);</span><br /><span class="line">    <span class="comment">// &lt;3&gt; åˆ›å»º ReferenceAnnotationBeanPostProcessor Bean å¯¹è±¡ï¼Œåç»­æ‰«æ `@Reference` æ³¨è§£çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ Reference Bean å¯¹è±¡</span></span><br /><span class="line">    registerReferenceAnnotationBeanPostProcessor(registry);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">// ... çœç•¥ç¨åè°ƒç”¨çš„æ–¹æ³•ã€‚</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#getPackagesToScan(AnnotationMetadata metadata)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—è¦æ‰«æçš„åŒ…ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboComponentScanRegistrar.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Set&lt;String&gt; <span class="title">getPackagesToScan</span><span class="params">(AnnotationMetadata metadata)</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾— @DubboComponentScan æ³¨è§£</span></span><br /><span class="line">    AnnotationAttributes attributes = AnnotationAttributes.fromMap(metadata.getAnnotationAttributes(DubboComponentScan.class.getName()));</span><br /><span class="line">    <span class="comment">// è·å¾—å…¶ä¸Šçš„å±æ€§</span></span><br /><span class="line">    String[] basePackages = attributes.getStringArray(<span class="string">"basePackages"</span>);</span><br /><span class="line">    Class&lt;?&gt;[] basePackageClasses = attributes.getClassArray(<span class="string">"basePackageClasses"</span>);</span><br /><span class="line">    String[] value = attributes.getStringArray(<span class="string">"value"</span>);</span><br /><span class="line">    <span class="comment">// Appends value array attributes</span></span><br /><span class="line">    <span class="comment">// æƒ…å†µä¸€ï¼Œå°†å±æ€§æ·»åŠ åˆ° packagesToScan é›†åˆä¸­</span></span><br /><span class="line">    Set&lt;String&gt; packagesToScan = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;(Arrays.asList(value));</span><br /><span class="line">    packagesToScan.addAll(Arrays.asList(basePackages));</span><br /><span class="line">    <span class="keyword">for</span> (Class&lt;?&gt; basePackageClass : basePackageClasses) {</span><br /><span class="line">        packagesToScan.add(ClassUtils.getPackageName(basePackageClass));</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// æƒ…å†µäºŒï¼Œå¦‚æœ packagesToScan ä¸ºç©ºï¼Œåˆ™é»˜è®¤ä½¿ç”¨æ³¨è§£ç±»æ‰€åœ¨çš„åŒ…</span></span><br /><span class="line">    <span class="keyword">if</span> (packagesToScan.isEmpty()) {</span><br /><span class="line">        <span class="keyword">return</span> Collections.singleton(ClassUtils.getPackageName(metadata.getClassName()));</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> packagesToScan;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æœ‰ä¸¤ç§æƒ…å†µï¼Œèƒ–å‹çœ‹çš„æ—¶å€™ï¼Œè¦æ³¨æ„ä¸‹ã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#registerServiceAnnotationBeanPostProcessor(Set&lt;String&gt; packagesToScan, BeanDefinitionRegistry registry)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º ServiceAnnotationBeanPostProcessor Bean å¯¹è±¡ï¼Œåç»­æ‰«æ&nbsp;<code>@Service</code>&nbsp;æ³¨è§£çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ Service Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboComponentScanRegistrar.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerServiceAnnotationBeanPostProcessor</span><span class="params">(Set&lt;String&gt; packagesToScan, BeanDefinitionRegistry registry)</span> </span>{</span><br /><span class="line">    <span class="comment">// åˆ›å»º BeanDefinitionBuilder å¯¹è±¡</span></span><br /><span class="line">    BeanDefinitionBuilder builder = BeanDefinitionBuilder.rootBeanDefinition(ServiceAnnotationBeanPostProcessor.class);</span><br /><span class="line">    <span class="comment">// è®¾ç½®æ„é€ æ–¹æ³•å‚æ•°ä¸º packagesToScan ï¼Œå³ BeanDefinitionBuilder æ‰«æè¯¥åŒ…</span></span><br /><span class="line">    builder.addConstructorArgValue(packagesToScan);</span><br /><span class="line">    <span class="comment">// è®¾ç½® role å±æ€§</span></span><br /><span class="line">    builder.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br /><span class="line">    <span class="comment">// è·å¾— AbstractBeanDefinition å¯¹è±¡</span></span><br /><span class="line">    AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();</span><br /><span class="line">    <span class="comment">// æ³¨å†Œåˆ° registry ä¸­</span></span><br /><span class="line">    BeanDefinitionReaderUtils.registerWithGeneratedName(beanDefinition, registry);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å…³äº ServiceAnnotationBeanPostProcessor ç±»ï¼Œæˆ‘ä»¬åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-annotation/">ã€Œ5.2 ServiceAnnotationBeanPostProcessorã€</a>&nbsp;ä¸­ï¼Œè¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#registerReferenceAnnotationBeanPostProcessor(BeanDefinitionRegistry registry)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º ReferenceAnnotationBeanPostProcessor Bean å¯¹è±¡ï¼Œåç»­æ‰«æ&nbsp;<code>@Reference</code>&nbsp;æ³¨è§£çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ Reference Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// DubboComponentScanRegistrar.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerReferenceAnnotationBeanPostProcessor</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>{</span><br /><span class="line">    <span class="comment">// Register @Reference Annotation Bean Processor</span></span><br /><span class="line">    BeanRegistrar.registerInfrastructureBean(registry, ReferenceAnnotationBeanPostProcessor.BEAN_NAME, ReferenceAnnotationBeanPostProcessor.class);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">// BeanRegistrar.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">registerInfrastructureBean</span><span class="params">(BeanDefinitionRegistry beanDefinitionRegistry,</span></span></span><br /><span class="line"><span class="function"><span class="params">                                              String beanName, Class&lt;?&gt; beanType)</span> </span>{</span><br /><span class="line">    <span class="comment">// ä¸å­˜åœ¨ beanName å¯¹åº”çš„ BeanDefinition å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">if</span> (!beanDefinitionRegistry.containsBeanDefinition(beanName)) {</span><br /><span class="line">        <span class="comment">// åˆ›å»º RootBeanDefinition å¯¹è±¡</span></span><br /><span class="line">        RootBeanDefinition beanDefinition = <span class="keyword">new</span> RootBeanDefinition(beanType);</span><br /><span class="line">        <span class="comment">// è®¾ç½® role</span></span><br /><span class="line">        beanDefinition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);</span><br /><span class="line">        <span class="comment">// æ³¨å†Œåˆ° beanDefinitionRegistry ä¸­</span></span><br /><span class="line">        beanDefinitionRegistry.registerBeanDefinition(beanName, beanDefinition);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å…³äº ReferenceAnnotationBeanPostProcessor ç±»ï¼Œæˆ‘ä»¬åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-annotation/">ã€Œ5.3 ReferenceAnnotationBeanPostProcessorã€</a>ä¸­ï¼Œè¯¦ç»†è§£æã€‚</li>
</ul>
</li>
</ul>
<h2 id="5-2-ServiceAnnotationBeanPostProcessor">5.2 ServiceAnnotationBeanPostProcessor</h2>
<p><code>org.apache.dubbo.config.spring.beans.factory.annotation.ServiceAnnotationBeanPostProcessor</code>&nbsp;ï¼Œå®ç° BeanDefinitionRegistryPostProcessorã€EnvironmentAwareã€ResourceLoaderAwareã€BeanClassLoaderAware æ¥å£ï¼Œæ‰«æ&nbsp;<code>@Service</code>&nbsp;æ³¨è§£çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ Spring BeanDefinition å¯¹è±¡ï¼Œä»è€Œåˆ›å»º Dubbo Service Bean å¯¹è±¡ã€‚</p>
<h3 id="5-2-1-æ„é€ æ–¹æ³•">5.2.1 æ„é€ æ–¹æ³•</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ServiceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è¦æ‰«æçš„åŒ…çš„é›†åˆ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; packagesToScan;</span><br /><br /><span class="line"><span class="keyword">private</span> Environment environment;</span><br /><br /><span class="line"><span class="keyword">private</span> ResourceLoader resourceLoader;</span><br /><br /><span class="line"><span class="keyword">private</span> ClassLoader classLoader;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ServiceAnnotationBeanPostProcessor</span><span class="params">(String... packagesToScan)</span> </span>{ <span class="comment">// ä¸Šè¿°æ–‡ç« ä½¿ç”¨åˆ°çš„æ„é€ æ–¹æ³•</span></span><br /><span class="line">    <span class="keyword">this</span>(Arrays.asList(packagesToScan));</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ServiceAnnotationBeanPostProcessor</span><span class="params">(Collection&lt;String&gt; packagesToScan)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>(<span class="keyword">new</span> LinkedHashSet&lt;String&gt;(packagesToScan));</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ServiceAnnotationBeanPostProcessor</span><span class="params">(Set&lt;String&gt; packagesToScan)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.packagesToScan = packagesToScan;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="5-2-2-postProcessBeanDefinitionRegistry">5.2.2 postProcessBeanDefinitionRegistry</h3>
<p>å®ç°&nbsp;<code>#postProcessBeanDefinitionRegistry(BeanDefinitionRegistry registry)</code>&nbsp;æ–¹æ³•ï¼Œæ‰«æ&nbsp;<code>@Service</code>&nbsp;æ³¨è§£çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ Spring BeanDefinition å¯¹è±¡ï¼Œä»è€Œåˆ›å»º Dubbo Service Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ServiceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; è§£æ packagesToScan é›†åˆã€‚å› ä¸ºï¼Œå¯èƒ½å­˜åœ¨å ä½ç¬¦</span></span><br /><span class="line">    Set&lt;String&gt; resolvedPackagesToScan = resolvePackagesToScan(packagesToScan);</span><br /><span class="line">    <span class="comment">// &lt;2&gt; æ‰«æ packagesToScan åŒ…ï¼Œåˆ›å»ºå¯¹åº”çš„ Spring BeanDefinition å¯¹è±¡ï¼Œä»è€Œåˆ›å»º Dubbo Service Bean å¯¹è±¡ã€‚</span></span><br /><span class="line">    <span class="keyword">if</span> (!CollectionUtils.isEmpty(resolvedPackagesToScan)) {</span><br /><span class="line">        registerServiceBeans(resolvedPackagesToScan, registry);</span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        <span class="keyword">if</span> (logger.isWarnEnabled()) {</span><br /><span class="line">            logger.warn(<span class="string">"packagesToScan is empty , ServiceBean registry will be ignored!"</span>);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#resolvePackagesToScan(Set&lt;String&gt; packagesToScan)</code>&nbsp;æ–¹æ³•ï¼Œè§£æ&nbsp;<code>packagesToScan</code>&nbsp;é›†åˆã€‚å› ä¸ºï¼Œå¯èƒ½å­˜åœ¨å ä½ç¬¦ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ServiceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Set&lt;String&gt; <span class="title">resolvePackagesToScan</span><span class="params">(Set&lt;String&gt; packagesToScan)</span> </span>{</span><br /><span class="line">    Set&lt;String&gt; resolvedPackagesToScan = <span class="keyword">new</span> LinkedHashSet&lt;String&gt;(packagesToScan.size());</span><br /><span class="line">    <span class="comment">// éå† packagesToScan æ•°ç»„</span></span><br /><span class="line">    <span class="keyword">for</span> (String packageToScan : packagesToScan) {</span><br /><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(packageToScan)) {</span><br /><span class="line">            <span class="comment">// è§£æå¯èƒ½å­˜åœ¨çš„å ä½ç¬¦</span></span><br /><span class="line">            String resolvedPackageToScan = environment.resolvePlaceholders(packageToScan.trim());</span><br /><span class="line">            <span class="comment">// æ·»åŠ åˆ° resolvedPackagesToScan ä¸­</span></span><br /><span class="line">            resolvedPackagesToScan.add(resolvedPackageToScan);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> resolvedPackagesToScan;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#registerServiceBeans(Set&lt;String&gt; packagesToScan, BeanDefinitionRegistry registry)</code>&nbsp;æ–¹æ³•ï¼Œæ‰«æ&nbsp;<code>packagesToScan</code>&nbsp;åŒ…ï¼Œåˆ›å»ºå¯¹åº”çš„ Spring BeanDefinition å¯¹è±¡ï¼Œä»è€Œåˆ›å»º Dubbo Service Bean å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-annotation/">ã€Œ5.2.3 resolvePackagesToScanã€</a>&nbsp;ä¸­ã€‚</p>
</li>
</ul>
<h3 id="5-2-3-resolvePackagesToScan">5.2.3 resolvePackagesToScan</h3>
<p><code>#registerServiceBeans(Set&lt;String&gt; packagesToScan, BeanDefinitionRegistry registry)</code>&nbsp;æ–¹æ³•ï¼Œæ‰«æ&nbsp;<code>packagesToScan</code>&nbsp;åŒ…ï¼Œåˆ›å»ºå¯¹åº”çš„ Spring BeanDefinition å¯¹è±¡ï¼Œä»è€Œåˆ›å»º Dubbo Service Bean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ServiceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerServiceBeans</span><span class="params">(Set&lt;String&gt; packagesToScan, BeanDefinitionRegistry registry)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1.1&gt; åˆ›å»º DubboClassPathBeanDefinitionScanner å¯¹è±¡</span></span><br /><span class="line">    DubboClassPathBeanDefinitionScanner scanner = <span class="keyword">new</span> DubboClassPathBeanDefinitionScanner(registry, environment, resourceLoader);</span><br /><span class="line">    <span class="comment">// &lt;1.2&gt; è·å¾— BeanNameGenerator å¯¹è±¡ï¼Œå¹¶è®¾ç½® beanNameGenerator åˆ° scanner ä¸­</span></span><br /><span class="line">    BeanNameGenerator beanNameGenerator = resolveBeanNameGenerator(registry);</span><br /><span class="line">    scanner.setBeanNameGenerator(beanNameGenerator);</span><br /><span class="line">    <span class="comment">// &lt;1.3&gt; è®¾ç½®è¿‡æ»¤è·å¾—å¸¦æœ‰ @Service æ³¨è§£çš„ç±»</span></span><br /><span class="line">    scanner.addIncludeFilter(<span class="keyword">new</span> AnnotationTypeFilter(Service.class));</span><br /><br /><span class="line">    <span class="comment">// &lt;2&gt; éå† packagesToScan æ•°ç»„</span></span><br /><span class="line">    <span class="keyword">for</span> (String packageToScan : packagesToScan) {</span><br /><span class="line">        <span class="comment">// Registers @Service Bean first</span></span><br /><span class="line">        <span class="comment">// &lt;2.1&gt; æ‰§è¡Œæ‰«æ</span></span><br /><span class="line">        scanner.scan(packageToScan);</span><br /><span class="line">        <span class="comment">// Finds all BeanDefinitionHolders of @Service whether @ComponentScan scans or not.</span></span><br /><span class="line">        <span class="comment">// &lt;2.2&gt; åˆ›å»ºæ¯ä¸ªåœ¨ packageToScan æ‰«æåˆ°çš„ç±»ï¼Œå¯¹åº”çš„ BeanDefinitionHolder å¯¹è±¡ï¼Œè¿”å› BeanDefinitionHolder é›†åˆ</span></span><br /><span class="line">        Set&lt;BeanDefinitionHolder&gt; beanDefinitionHolders = findServiceBeanDefinitionHolders(scanner, packageToScan, registry, beanNameGenerator);</span><br /><span class="line">        <span class="comment">// &lt;2.3&gt; æ³¨å†Œåˆ° registry ä¸­</span></span><br /><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(beanDefinitionHolders)) {</span><br /><span class="line">            <span class="keyword">for</span> (BeanDefinitionHolder beanDefinitionHolder : beanDefinitionHolders) {</span><br /><span class="line">                registerServiceBean(beanDefinitionHolder, registry, scanner);</span><br /><span class="line">            }</span><br /><span class="line">            <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line">                logger.info(beanDefinitionHolders.size() + <span class="string">" annotated Dubbo's @Service Components { "</span> + beanDefinitionHolders + <span class="string">" } were scanned under package["</span> + packageToScan + <span class="string">"]"</span>);</span><br /><span class="line">            }</span><br /><span class="line">        } <span class="keyword">else</span> {</span><br /><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) {</span><br /><span class="line">                logger.warn(<span class="string">"No Spring Bean annotating Dubbo's @Service was found under package["</span> + packageToScan + <span class="string">"]"</span>);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>&lt;1.1&gt;</code>&nbsp;å¤„ï¼Œåˆ›å»º DubboClassPathBeanDefinitionScanner å¯¹è±¡ã€‚å®ƒæ˜¯ç”¨äºæ‰«ææŒ‡å®šåŒ…ä¸‹ç¬¦åˆæ¡ä»¶çš„ç±»ï¼Œç”¨äºå°†æ¯ä¸ªç¬¦åˆæ¡ä»¶çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ BeanDefinition å¯¹è±¡ï¼Œä»è€Œåˆ›å»º Bean ã€‚å…³äº DubboClassPathBeanDefinitionScanner ç±»ï¼Œèƒ–å‹ç‚¹å‡»&nbsp;<a href="https://github.com/apache/incubator-dubbo/blob/master/dubbo-config/dubbo-config-spring/src/main/java/org/apache/dubbo/config/spring/beans/factory/annotation/ServiceAnnotationBeanPostProcessor.java" target="_blank" rel="external nofollow noopener noreferrer">é“¾æ¥</a>&nbsp;ç…ä¸€çœ¼å³å¯ã€‚</li>
<li>
<p><code>&lt;1.2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#resolveBeanNameGenerator(BeanDefinitionRegistry registry)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— BeanNameGenerator å¯¹è±¡ï¼Œå¹¶è®¾ç½®&nbsp;<code>beanNameGenerator</code>&nbsp;åˆ°&nbsp;<code>scanner</code>&nbsp;ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ServiceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * It'd better to use BeanNameGenerator instance that should reference</span></span><br /><span class="line"><span class="comment"> * {<span class="doctag">@link</span> ConfigurationClassPostProcessor#componentScanBeanNameGenerator},</span></span><br /><span class="line"><span class="comment"> * thus it maybe a potential problem on bean name generation.</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> registry {<span class="doctag">@link</span> BeanDefinitionRegistry}</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> {<span class="doctag">@link</span> BeanNameGenerator} instance</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> SingletonBeanRegistry</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> AnnotationConfigUtils#CONFIGURATION_BEAN_NAME_GENERATOR</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> ConfigurationClassPostProcessor#processConfigBeanDefinitions</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.8</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"Duplicates"</span>)</span><br /><span class="line"><span class="function"><span class="keyword">private</span> BeanNameGenerator <span class="title">resolveBeanNameGenerator</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>{</span><br /><span class="line">    BeanNameGenerator beanNameGenerator = <span class="keyword">null</span>;</span><br /><span class="line">    <span class="comment">// å¦‚æœæ˜¯ SingletonBeanRegistry ç±»å‹ï¼Œä»ä¸­è·å¾—å¯¹åº”çš„ BeanNameGenerator Bean å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">if</span> (registry <span class="keyword">instanceof</span> SingletonBeanRegistry) {</span><br /><span class="line">        SingletonBeanRegistry singletonBeanRegistry = SingletonBeanRegistry.class.cast(registry);</span><br /><span class="line">        beanNameGenerator = (BeanNameGenerator) singletonBeanRegistry.getSingleton(AnnotationConfigUtils.CONFIGURATION_BEAN_NAME_GENERATOR);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º AnnotationBeanNameGenerator å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">if</span> (beanNameGenerator == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line">            logger.info(<span class="string">"BeanNameGenerator bean can't be found in BeanFactory with name ["</span> + CONFIGURATION_BEAN_NAME_GENERATOR + <span class="string">"]"</span>);</span><br /><span class="line">            logger.info(<span class="string">"BeanNameGenerator will be a instance of "</span> + AnnotationBeanNameGenerator.class.getName() + <span class="string">" , it maybe a potential problem on bean name generation."</span>);</span><br /><span class="line">        }</span><br /><span class="line">        beanNameGenerator = <span class="keyword">new</span> AnnotationBeanNameGenerator();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> beanNameGenerator;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>&lt;1.3&gt;</code>&nbsp;å¤„ï¼Œè®¾ç½®è¿‡æ»¤è·å¾—å¸¦æœ‰&nbsp;<code>@Service</code>&nbsp;æ³¨è§£çš„ç±»ã€‚å…³äº&nbsp;<code>@Service</code>&nbsp;æ³¨è§£çš„å…·ä½“çš„å±æ€§ï¼Œæœ¬æ–‡å°±ä¸è¿‡åˆ†ä»‹ç»ï¼Œèƒ–å‹è‡ªå·±ç…ç…ã€‚</p>
</li>
<li><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œéå†&nbsp;<code>packagesToScan</code>&nbsp;æ•°ç»„ã€‚
<ul>
<li><code>&lt;2.1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>DubboClassPathBeanDefinitionScanner#scan(String... basePackages)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œæ‰«æã€‚</li>
<li><code>&lt;2.2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#findServiceBeanDefinitionHolders(ClassPathBeanDefinitionScanner scanner, String packageToScan, BeanDefinitionRegistry registry, BeanNameGenerator beanNameGenerator)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºæ¯ä¸ªåœ¨&nbsp;<code>packageToScan</code>&nbsp;æ‰«æåˆ°çš„ç±»ï¼Œå¯¹åº”çš„ BeanDefinitionHolder å¯¹è±¡ï¼Œè¿”å› BeanDefinitionHolder é›†åˆã€‚è¯¦ç»†è§£æ ï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-annotation/">ã€Œ5.2.4 findServiceBeanDefinitionHoldersã€</a>&nbsp;ä¸­ã€‚</li>
<li><code>&lt;2.3&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#registerServiceBean(BeanDefinitionHolder beanDefinitionHolder, BeanDefinitionRegistry registry, DubboClassPathBeanDefinitionScanner scanner)</code>&nbsp;æ–¹æ³•ï¼Œæ³¨å†Œåˆ°&nbsp;<code>registry</code>&nbsp;ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-annotation/">ã€Œ5.2.5 registerServiceBeanã€</a>&nbsp;ä¸­ã€‚</li>
</ul>
</li>
</ul>
<h3 id="5-2-4-findServiceBeanDefinitionHolders">5.2.4 findServiceBeanDefinitionHolders</h3>
<p><code>#findServiceBeanDefinitionHolders(ClassPathBeanDefinitionScanner scanner, String packageToScan, BeanDefinitionRegistry registry, BeanNameGenerator beanNameGenerator)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºæ¯ä¸ªåœ¨&nbsp;<code>packageToScan</code>&nbsp;æ‰«æåˆ°çš„ç±»ï¼Œå¯¹åº”çš„ BeanDefinitionHolder å¯¹è±¡ï¼Œè¿”å› BeanDefinitionHolder é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ServiceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Finds a {<span class="doctag">@link</span> Set} of {<span class="doctag">@link</span> BeanDefinitionHolder BeanDefinitionHolders} whose bean type annotated</span></span><br /><span class="line"><span class="comment"> * {<span class="doctag">@link</span> Service} Annotation.</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> scanner       {<span class="doctag">@link</span> ClassPathBeanDefinitionScanner}</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> packageToScan pachage to scan</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> registry      {<span class="doctag">@link</span> BeanDefinitionRegistry}</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> non-null</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.5.8</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"Duplicates"</span>)</span><br /><span class="line"><span class="function"><span class="keyword">private</span> Set&lt;BeanDefinitionHolder&gt; <span class="title">findServiceBeanDefinitionHolders</span><span class="params">(</span></span></span><br /><span class="line"><span class="function"><span class="params">        ClassPathBeanDefinitionScanner scanner, String packageToScan, BeanDefinitionRegistry registry,</span></span></span><br /><span class="line"><span class="function"><span class="params">        BeanNameGenerator beanNameGenerator)</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾— packageToScan åŒ…ä¸‹ç¬¦åˆæ¡ä»¶çš„ BeanDefinition é›†åˆ</span></span><br /><span class="line">    Set&lt;BeanDefinition&gt; beanDefinitions = scanner.findCandidateComponents(packageToScan);</span><br /><br /><span class="line">    <span class="comment">// åˆ›å»º BeanDefinitionHolder é›†åˆ</span></span><br /><span class="line">    Set&lt;BeanDefinitionHolder&gt; beanDefinitionHolders = <span class="keyword">new</span> LinkedHashSet&lt;BeanDefinitionHolder&gt;(beanDefinitions.size());</span><br /><span class="line">    <span class="comment">// éå† beanDefinitions æ•°ç»„</span></span><br /><span class="line">    <span class="keyword">for</span> (BeanDefinition beanDefinition : beanDefinitions) {</span><br /><span class="line">        <span class="comment">// è·å¾— Bean çš„åå­—</span></span><br /><span class="line">        String beanName = beanNameGenerator.generateBeanName(beanDefinition, registry);</span><br /><span class="line">        <span class="comment">// åˆ›å»º BeanDefinitionHolder å¯¹è±¡</span></span><br /><span class="line">        BeanDefinitionHolder beanDefinitionHolder = <span class="keyword">new</span> BeanDefinitionHolder(beanDefinition, beanName);</span><br /><span class="line">        <span class="comment">// æ·»åŠ åˆ° beanDefinitions ä¸­</span></span><br /><span class="line">        beanDefinitionHolders.add(beanDefinitionHolder);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> beanDefinitionHolders;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="5-2-5-registerServiceBean">5.2.5 registerServiceBean</h3>
<p><code>#registerServiceBean(BeanDefinitionHolder beanDefinitionHolder, BeanDefinitionRegistry registry, DubboClassPathBeanDefinitionScanner scanner)</code>&nbsp;æ–¹æ³•ï¼Œæ³¨å†Œåˆ°&nbsp;<code>registry</code>&nbsp;ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ServiceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Registers {<span class="doctag">@link</span> ServiceBean} from new annotated {<span class="doctag">@link</span> Service} {<span class="doctag">@link</span> BeanDefinition}</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> beanDefinitionHolder</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> registry</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> scanner</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> ServiceBean</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> BeanDefinition</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"Duplicates"</span>)</span><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerServiceBean</span><span class="params">(BeanDefinitionHolder beanDefinitionHolder, BeanDefinitionRegistry registry,</span></span></span><br /><span class="line"><span class="function"><span class="params">                                 DubboClassPathBeanDefinitionScanner scanner)</span> </span>{</span><br /><span class="line">    <span class="comment">// &lt;1.1&gt; è§£æ Bean çš„ç±»</span></span><br /><span class="line">    Class&lt;?&gt; beanClass = resolveClass(beanDefinitionHolder);</span><br /><span class="line">    <span class="comment">// &lt;1.2&gt; è·å¾— @Service æ³¨è§£</span></span><br /><span class="line">    Service service = AnnotationUtils.findAnnotation(beanClass, Service.class);</span><br /><span class="line">    <span class="comment">// &lt;1.3&gt; è·å¾— Service æ¥å£</span></span><br /><span class="line">    Class&lt;?&gt; interfaceClass = resolveServiceInterfaceClass(beanClass, service);</span><br /><span class="line">    <span class="comment">// &lt;1.4&gt; è·å¾— Bean çš„åå­—</span></span><br /><span class="line">    String annotatedServiceBeanName = beanDefinitionHolder.getBeanName();</span><br /><span class="line">    <span class="comment">// &lt;1.5&gt; åˆ›å»º AbstractBeanDefinition å¯¹è±¡</span></span><br /><span class="line">    AbstractBeanDefinition serviceBeanDefinition = buildServiceBeanDefinition(service, interfaceClass, annotatedServiceBeanName);</span><br /><br /><span class="line">    <span class="comment">// ServiceBean Bean name</span></span><br /><span class="line">    <span class="comment">// &lt;2&gt; é‡æ–°ç”Ÿæˆ Bean çš„åå­—</span></span><br /><span class="line">    String beanName = generateServiceBeanName(service, interfaceClass, annotatedServiceBeanName);</span><br /><span class="line">    <span class="comment">// &lt;3&gt; æ ¡éªŒåœ¨ scanner ä¸­ï¼Œå·²ç»å­˜åœ¨ beanName ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œæ³¨å†Œã€‚</span></span><br /><span class="line">    <span class="keyword">if</span> (scanner.checkCandidate(beanName, serviceBeanDefinition)) { <span class="comment">// check duplicated candidate bean</span></span><br /><span class="line">        registry.registerBeanDefinition(beanName, serviceBeanDefinition);</span><br /><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line">            logger.info(<span class="string">"The BeanDefinition["</span> + serviceBeanDefinition + <span class="string">"] of ServiceBean has been registered with name : "</span> + beanName);</span><br /><span class="line">        }</span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        <span class="keyword">if</span> (logger.isWarnEnabled()) {</span><br /><span class="line">            logger.warn(<span class="string">"The Duplicated BeanDefinition["</span> + serviceBeanDefinition + <span class="string">"] of ServiceBean[ bean name : "</span> + beanName + <span class="string">"] was be found , Did @DubboComponentScan scan to same package in many times?"</span>);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>&lt;1.1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#resolveClass(BeanDefinitionHolder beanDefinitionHolder)</code>&nbsp;æ–¹æ³•ï¼Œè§£æè¿”å› Bean çš„ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ServiceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="keyword">private</span> Class&lt;?&gt; resolveClass(BeanDefinitionHolder beanDefinitionHolder) {</span><br /><span class="line">    BeanDefinition beanDefinition = beanDefinitionHolder.getBeanDefinition();</span><br /><span class="line">    <span class="keyword">return</span> resolveClass(beanDefinition);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="keyword">private</span> Class&lt;?&gt; resolveClass(BeanDefinition beanDefinition) {</span><br /><span class="line">    String beanClassName = beanDefinition.getBeanClassName();</span><br /><span class="line">    <span class="keyword">return</span> ClassUtils.resolveClassName(beanClassName, classLoader);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å› ä¸º BeanDefinition çš„&nbsp;<code>beanClassName</code>&nbsp;æ˜¯ String ç±»å‹ï¼Œæ‰€ä»¥å¾—è½¬æ¢æˆ Class ç±»å‹ã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;1.2&gt;</code>&nbsp;å¤„ï¼Œè·å¾—&nbsp;<code>@Service</code>&nbsp;æ³¨è§£ã€‚</p>
</li>
<li>
<p><code>&lt;1.3&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#resolveServiceInterfaceClass(Class&lt;?&gt; annotatedServiceBeanClass, Service service)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— Service æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ServiceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"Duplicates"</span>)</span><br /><span class="line"><span class="keyword">private</span> Class&lt;?&gt; resolveServiceInterfaceClass(Class&lt;?&gt; annotatedServiceBeanClass, Service service) {</span><br /><span class="line">    <span class="comment">// é¦–å…ˆï¼Œä»æ³¨è§£æœ¬èº«ä¸Šè·å¾—</span></span><br /><span class="line">    Class&lt;?&gt; interfaceClass = service.interfaceClass();</span><br /><span class="line">    <span class="keyword">if</span> (<span class="keyword">void</span>.class.equals(interfaceClass)) { <span class="comment">// ä¸€èˆ¬æ˜¯æ»¡è¶³çš„</span></span><br /><span class="line">        interfaceClass = <span class="keyword">null</span>;</span><br /><span class="line">        <span class="comment">// è·å¾— @Service æ³¨è§£çš„ interfaceName å±æ€§ã€‚</span></span><br /><span class="line">        String interfaceClassName = service.interfaceName();</span><br /><span class="line">        <span class="comment">// å¦‚æœå­˜åœ¨ï¼Œè·å¾—å…¶å¯¹åº”çš„ç±»</span></span><br /><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(interfaceClassName)) {</span><br /><span class="line">            <span class="keyword">if</span> (ClassUtils.isPresent(interfaceClassName, classLoader)) {</span><br /><span class="line">                interfaceClass = ClassUtils.resolveClassName(interfaceClassName, classLoader);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">// &lt;X&gt;ã€ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½¿ç”¨è¿™ä¸ªã€‘è·å¾—ä¸åˆ°ï¼Œåˆ™ä»è¢«æ³¨è§£çš„ç±»ä¸Šè·å¾—å…¶å®ç°çš„é¦–ä¸ªæ¥å£</span></span><br /><span class="line">    <span class="keyword">if</span> (interfaceClass == <span class="keyword">null</span>) {</span><br /><span class="line">        Class&lt;?&gt;[] allInterfaces = annotatedServiceBeanClass.getInterfaces();</span><br /><span class="line">        <span class="keyword">if</span> (allInterfaces.length &gt; <span class="number">0</span>) {</span><br /><span class="line">            interfaceClass = allInterfaces[<span class="number">0</span>];</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><br /><span class="line">    Assert.notNull(interfaceClass, <span class="string">"@Service interfaceClass() or interfaceName() or interface class must be present!"</span>);</span><br /><span class="line">    Assert.isTrue(interfaceClass.isInterface(), <span class="string">"The type that was annotated @Service is not an interface!"</span>);</span><br /><span class="line">    <span class="keyword">return</span> interfaceClass;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è™½ç„¶ä»£ç æ¯”è¾ƒé•¿ï¼Œä½†æ˜¯é‡ç‚¹çœ‹&nbsp;<code>&lt;X&gt;</code>&nbsp;å¤„ï¼Œä»è¢«æ³¨è§£çš„ç±»ä¸Šè·å¾—å…¶å®ç°çš„é¦–ä¸ªæ¥å£ã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;1.4&gt;</code>&nbsp;å¤„ï¼Œè·å¾— Bean çš„åå­—ã€‚</p>
</li>
<li>
<p><code>&lt;1.5&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#buildServiceBeanDefinition(Service service, Class&lt;?&gt; interfaceClass, String annotatedServiceBeanName)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º AbstractBeanDefinition å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ServiceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"Duplicates"</span>)</span><br /><span class="line"><span class="function"><span class="keyword">private</span> AbstractBeanDefinition <span class="title">buildServiceBeanDefinition</span><span class="params">(Service service, Class&lt;?&gt; interfaceClass, String annotatedServiceBeanName)</span> </span>{</span><br /><span class="line">    <span class="comment">// åˆ›å»º BeanDefinitionBuilder å¯¹è±¡</span></span><br /><span class="line">    BeanDefinitionBuilder builder = BeanDefinitionBuilder.rootBeanDefinition(ServiceBean.class);</span><br /><span class="line">    <span class="comment">// è·å¾— AbstractBeanDefinition å¯¹è±¡</span></span><br /><span class="line">    AbstractBeanDefinition beanDefinition = builder.getBeanDefinition();</span><br /><br /><span class="line">    <span class="comment">// è·å¾— MutablePropertyValues å±æ€§ã€‚åç»­ ï¼Œé€šè¿‡å‘å®ƒæ·»åŠ å±æ€§ï¼Œè®¾ç½®åˆ° BeanDefinition ä¸­ï¼Œå³ Service Bean ä¸­ã€‚</span></span><br /><span class="line">    MutablePropertyValues propertyValues = beanDefinition.getPropertyValues();</span><br /><br /><span class="line">    <span class="comment">// &lt;X&gt; åˆ›å»º AnnotationPropertyValuesAdapter å¯¹è±¡ï¼Œæ·»åŠ åˆ° propertyValues ä¸­ã€‚</span></span><br /><span class="line">    <span class="comment">// æ­¤å¤„ï¼Œæ˜¯å°†æ³¨è§£ä¸Šçš„å±æ€§ï¼Œè®¾ç½®åˆ° propertyValues ä¸­</span></span><br /><span class="line">    String[] ignoreAttributeNames = of(<span class="string">"provider"</span>, <span class="string">"monitor"</span>, <span class="string">"application"</span>, <span class="string">"module"</span>, <span class="string">"registry"</span>, <span class="string">"protocol"</span>, <span class="string">"interface"</span>, <span class="string">"interfaceName"</span>); <span class="comment">// å¿½ç•¥çš„å±æ€§ï¼Œä¸‹é¢è¿›è¡Œå•ç‹¬è®¾ç½®ã€‚</span></span><br /><span class="line">    propertyValues.addPropertyValues(<span class="keyword">new</span> AnnotationPropertyValuesAdapter(service, environment, ignoreAttributeNames));</span><br /><br /><span class="line">    <span class="comment">// References "ref" property to annotated-@Service Bean</span></span><br /><span class="line">    <span class="comment">// è®¾ç½® ref å±æ€§æŒ‡å‘çš„ Service Bean åå­—</span></span><br /><span class="line">    addPropertyReference(builder, <span class="string">"ref"</span>, annotatedServiceBeanName);</span><br /><span class="line">    <span class="comment">// Set interface è®¾ç½® Service æ¥å£ç±»å…¨ç±»å</span></span><br /><span class="line">    builder.addPropertyValue(<span class="string">"interface"</span>, interfaceClass.getName());</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Add {<span class="doctag">@link</span> org.apache.dubbo.config.ProviderConfig} Bean reference</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * æ·»åŠ  provider å±æ€§å¯¹åº”çš„ ProviderConfig Bean å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    String providerConfigBeanName = service.provider();</span><br /><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(providerConfigBeanName)) {</span><br /><span class="line">        addPropertyReference(builder, <span class="string">"provider"</span>, providerConfigBeanName);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Add {<span class="doctag">@link</span> org.apache.dubbo.config.MonitorConfig} Bean reference</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * æ·»åŠ  monitor å±æ€§å¯¹åº”çš„ MonitorConfig Bean å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    String monitorConfigBeanName = service.monitor();</span><br /><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(monitorConfigBeanName)) {</span><br /><span class="line">        addPropertyReference(builder, <span class="string">"monitor"</span>, monitorConfigBeanName);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Add {<span class="doctag">@link</span> org.apache.dubbo.config.ApplicationConfig} Bean reference</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * æ·»åŠ  application å±æ€§å¯¹åº”çš„ ApplicationConfig Bean å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    String applicationConfigBeanName = service.application();</span><br /><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(applicationConfigBeanName)) {</span><br /><span class="line">        addPropertyReference(builder, <span class="string">"application"</span>, applicationConfigBeanName);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Add {<span class="doctag">@link</span> org.apache.dubbo.config.ModuleConfig} Bean reference</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * æ·»åŠ  module å±æ€§å¯¹åº”çš„ ModuleConfig Bean å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    String moduleConfigBeanName = service.<span class="keyword">module</span>();</span><br /><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(moduleConfigBeanName)) {</span><br /><span class="line">        addPropertyReference(builder, <span class="string">"module"</span>, moduleConfigBeanName);</span><br /><span class="line">    }</span><br /><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Add {<span class="doctag">@link</span> org.apache.dubbo.config.RegistryConfig} Bean reference</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * æ·»åŠ  registries å±æ€§å¯¹åº”çš„ RegistryConfig Bean æ•°ç»„ï¼ˆä¸€ä¸ªæˆ–å¤šä¸ªï¼‰</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    String[] registryConfigBeanNames = service.registry();</span><br /><span class="line">    List&lt;RuntimeBeanReference&gt; registryRuntimeBeanReferences = toRuntimeBeanReferences(registryConfigBeanNames);</span><br /><span class="line">    <span class="keyword">if</span> (!registryRuntimeBeanReferences.isEmpty()) {</span><br /><span class="line">        builder.addPropertyValue(<span class="string">"registries"</span>, registryRuntimeBeanReferences);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Add {<span class="doctag">@link</span> org.apache.dubbo.config.ProtocolConfig} Bean reference</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * æ·»åŠ  protocols å±æ€§å¯¹åº”çš„ ProtocolConfig Bean æ•°ç»„ï¼ˆä¸€ä¸ªæˆ–å¤šä¸ªï¼‰</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    String[] protocolConfigBeanNames = service.protocol();</span><br /><span class="line">    List&lt;RuntimeBeanReference&gt; protocolRuntimeBeanReferences = toRuntimeBeanReferences(protocolConfigBeanNames);</span><br /><span class="line">    <span class="keyword">if</span> (!protocolRuntimeBeanReferences.isEmpty()) {</span><br /><span class="line">        builder.addPropertyValue(<span class="string">"protocols"</span>, protocolRuntimeBeanReferences);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="keyword">return</span> builder.getBeanDefinition();</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">// RuntimeBeanReference ï¼Œåœ¨è§£æåˆ°ä¾èµ–çš„Beançš„æ—¶ä¾¯ï¼Œè§£æå™¨ä¼šä¾æ®ä¾èµ–beançš„nameåˆ›å»ºä¸€ä¸ªRuntimeBeanReferenceå¯¹åƒï¼Œå°†è¿™ä¸ªå¯¹åƒæ”¾å…¥BeanDefinitionçš„MutablePropertyValuesä¸­ã€‚</span></span><br /><span class="line"><span class="comment">// æ­¤å¤„ï¼Œå’Œä¸Šé¢ä¸å¤ªä¸€æ ·çš„åŸå› ï¼Œå› ä¸ºæ˜¯å¤šä¸ª</span></span><br /><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"Duplicates"</span>)</span><br /><span class="line"><span class="function"><span class="keyword">private</span> ManagedList&lt;RuntimeBeanReference&gt; <span class="title">toRuntimeBeanReferences</span><span class="params">(String... beanNames)</span> </span>{</span><br /><span class="line">    ManagedList&lt;RuntimeBeanReference&gt; runtimeBeanReferences = <span class="keyword">new</span> ManagedList&lt;RuntimeBeanReference&gt;();</span><br /><span class="line">    <span class="keyword">if</span> (!ObjectUtils.isEmpty(beanNames)) {</span><br /><span class="line">        <span class="keyword">for</span> (String beanName : beanNames) {</span><br /><span class="line">            <span class="comment">// è§£æçœŸæ­£çš„ Bean åå­—ï¼Œå¦‚æœæœ‰å ä½ç¬¦çš„è¯</span></span><br /><span class="line">            String resolvedBeanName = environment.resolvePlaceholders(beanName);</span><br /><span class="line">            runtimeBeanReferences.add(<span class="keyword">new</span> RuntimeBeanReference(resolvedBeanName));</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> runtimeBeanReferences;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">// æ·»åŠ å±æ€§å€¼æ˜¯å¼•ç”¨ç±»å‹</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addPropertyReference</span><span class="params">(BeanDefinitionBuilder builder, String propertyName, String beanName)</span> </span>{</span><br /><span class="line">    String resolvedBeanName = environment.resolvePlaceholders(beanName);</span><br /><span class="line">    builder.addPropertyReference(propertyName, resolvedBeanName);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ¯”è¾ƒå†—é•¿ï¼Œé¡ºç€å¾€ä¸‹çœ‹å³å¯ã€‚</li>
<li><code>&lt;X&gt;</code>&nbsp;å¤„ï¼Œåˆ›å»º AnnotationPropertyValuesAdapter å¯¹è±¡ï¼Œæ·»åŠ åˆ°&nbsp;<code>propertyValues</code>&nbsp;ä¸­ã€‚æ­¤å¤„ï¼Œæ˜¯å°†æ³¨è§£ä¸Šçš„å±æ€§ï¼Œè®¾ç½®åˆ°&nbsp;<code>propertyValues</code>&nbsp;ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ³¨è§£ä¸Šçš„å±æ€§ï¼Œè‡ªç„¶çš„èƒ½å¤Ÿè®¾ç½®åˆ°åç»­åˆ›å»ºçš„ Service Bean çš„å¯¹è±¡ä¸­ã€‚
<ul>
<li>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœè¯´&nbsp;<code>@Service(version="1.0.0")</code>&nbsp;ï¼Œé‚£ä¹ˆè¿™ä¸ªç‰ˆæœ¬å·ï¼ˆ<code>version</code>ï¼‰ï¼Œå°±å¯ä»¥è®¾ç½®åˆ° Dubbo Service Bean ä¸­å»äº†ã€‚</li>
<li>å…³äº&nbsp;<code>org.apache.dubbo.config.spring.beans.factory.annotation.AnnotationPropertyValuesAdapter</code>&nbsp;ç±»ï¼Œå°±æ˜¯ä¸Šè¿°çš„ç”¨é€”ï¼Œæ¯”è¾ƒç®€å•ï¼Œèƒ–å‹ç‚¹å‡»&nbsp;<a href="https://github.com/apache/incubator-dubbo/blob/ff0ce37c46523e9d0dfa13748fca339e68edc027/dubbo-config/dubbo-config-spring/src/main/java/org/apache/dubbo/config/spring/beans/factory/annotation/AnnotationPropertyValuesAdapter.java" target="_blank" rel="external nofollow noopener noreferrer">é“¾æ¥</a>&nbsp;æŸ¥çœ‹å³å¯ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#generateServiceBeanName(Service service, Class&lt;?&gt; interfaceClass, String annotatedServiceBeanName)</code>&nbsp;æ–¹æ³•ï¼Œé‡æ–°ç”Ÿæˆ Bean çš„åå­—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ServiceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">generateServiceBeanName</span><span class="params">(Service service, Class&lt;?&gt; interfaceClass, String annotatedServiceBeanName)</span> </span>{</span><br /><span class="line">    ServiceBeanNameBuilder builder = ServiceBeanNameBuilder.create(service, interfaceClass, environment);</span><br /><span class="line">    <span class="keyword">return</span> builder.build();</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">// ServiceBeanNameBuilder.java</span></span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SEPARATOR = <span class="string">":"</span>;</span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String interfaceClassName;</span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Environment environment;</span><br /><span class="line"><span class="comment">// Optional</span></span><br /><span class="line"><span class="keyword">private</span> String version;</span><br /><span class="line"><span class="keyword">private</span> String group;</span><br /><br /><span class="line"><span class="comment">// ServiceBean:${interfaceClassName}:${version}:${group}</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">build</span><span class="params">()</span> </span>{</span><br /><span class="line">    StringBuilder beanNameBuilder = <span class="keyword">new</span> StringBuilder(<span class="string">"ServiceBean"</span>);</span><br /><span class="line">    <span class="comment">// Required</span></span><br /><span class="line">    append(beanNameBuilder, interfaceClassName);</span><br /><span class="line">    <span class="comment">// Optional</span></span><br /><span class="line">    append(beanNameBuilder, version);</span><br /><span class="line">    append(beanNameBuilder, group);</span><br /><span class="line">    <span class="comment">// Build</span></span><br /><span class="line">    String rawBeanName = beanNameBuilder.toString();</span><br /><span class="line">    <span class="comment">// Resolve placeholders</span></span><br /><span class="line">    <span class="keyword">return</span> environment.resolvePlaceholders(rawBeanName);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">append</span><span class="params">(StringBuilder builder, String value)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(value)) {</span><br /><span class="line">        builder.append(SEPARATOR).append(value);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç»“æœç¤ºä¾‹å¦‚ä¸‹ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_01_22/02.jpg" alt="&#96;beanName&#96;" /></li>
</ul>
</li>
<li>
<p><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œæ ¡éªŒåœ¨&nbsp;<code>scanner</code>&nbsp;ä¸­ï¼Œæ˜¯å¦å·²ç»å­˜åœ¨&nbsp;<code>beanName</code>&nbsp;ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œæ³¨å†Œã€‚</p>
</li>
</ul>
<p>ğŸ˜ˆ æ•´ä¸ªé€»è¾‘ï¼Œæœ‰ç‚¹é•¿é•¿æ»´ã€‚èƒ–å‹è¾›è‹¦ä¸Šä¸‹æ»‘åŠ¨ï¼Œåœ¨ç…ç…ã€‚</p>
<h2 id="5-3-ReferenceAnnotationBeanPostProcessor">5.3 ReferenceAnnotationBeanPostProcessor</h2>
<p><code>org.apache.dubbo.config.spring.beans.factory.annotation.ReferenceAnnotationBeanPostProcessor</code>&nbsp;ï¼Œç»§æ‰¿ AnnotationInjectedBeanPostProcessor æŠ½è±¡ç±»ï¼Œå®ç° ApplicationContextAwareã€ApplicationListener æ¥å£ï¼Œæ‰«æ&nbsp;<code>@Reference</code>&nbsp;æ³¨è§£çš„ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ Spring BeanDefinition å¯¹è±¡ï¼Œä»è€Œåˆ›å»º Dubbo Reference Bean å¯¹è±¡ã€‚</p>
<blockquote>
<p>è™½ç„¶&nbsp;<code>org.apache.dubbo.config.spring.beans.factory.annotation.AnnotationInjectedBeanPostProcessor</code>&nbsp;æ”¾åœ¨ Dubbo é¡¹ç›®ä¸­ï¼Œä½†æ˜¯æ˜¯ clone è‡ª&nbsp;<a href="https://github.com/alibaba/spring-context-support/blob/1.0.2/src/main/java/com/alibaba/spring/beans/factory/annotation/AnnotationInjectedBeanPostProcessor.java" target="_blank" rel="external nofollow noopener noreferrer">https://github.com/alibaba/spring-context-support/blob/1.0.2/src/main/java/com/alibaba/spring/beans/factory/annotation/AnnotationInjectedBeanPostProcessor.java</a>ç±»ã€‚æ‰€ä»¥å‘¢ï¼Œæˆ‘ä»¬å…ˆä¸æ·±ç©¶è¿™ä¸ªç±»ï¼Œåªè¦çŸ¥é“å¦‚ä¸‹ï¼š</p>
<ul>
<li>è‹±æ–‡ï¼šAbstract generic {@link BeanPostProcessor} implementation for customized annotation that annotated injected-object.</li>
<li>ä¸­æ–‡ï¼šBeanPostProcessor çš„æŠ½è±¡å®ç°ç±»ï¼Œç”¨äºæ”¯æŒä½¿ç”¨è‡ªå®šä¹‰æ³¨è§£ï¼Œæ³¨å…¥å¯¹è±¡çš„å±æ€§ã€‚</li>
</ul>
</blockquote>
<ul>
<li>æ­¤æ—¶ï¼ŒReferenceAnnotationBeanPostProcessor å®ç°çš„å°±æ˜¯ æ”¯æŒ&nbsp;<code>@Reference</code>&nbsp;æ³¨è§£çš„å±æ€§æ³¨å…¥ã€‚</li>
</ul>
<blockquote>
<p>ç›¸å¯¹æ¥è¯´ï¼Œæœ¬èŠ‚çš„ ReferenceAnnotationBeanPostProcessor ï¼Œä¼šæ¯”ä¸Šä¸€èŠ‚çš„ ServiceAnnotationBeanPostProcessor å¤æ‚è›®å¤š~ SO ï¼Œä¿æŒè€å¿ƒå“ˆã€‚</p>
</blockquote>
<h3 id="5-3-1-æ„é€ æ–¹æ³•">5.3.1 æ„é€ æ–¹æ³•</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ReferenceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * The bean name of {<span class="doctag">@link</span> ReferenceAnnotationBeanPostProcessor}</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEAN_NAME = <span class="string">"referenceAnnotationBeanPostProcessor"</span>;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Cache size</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CACHE_SIZE = Integer.getInteger(BEAN_NAME + <span class="string">".cache.size"</span>, <span class="number">32</span>);</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ReferenceBean ç¼“å­˜ Map</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * KEYï¼šReference Bean çš„åå­—</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, ReferenceBean&lt;?&gt;&gt; referenceBeanCache = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ReferenceBean&lt;?&gt;&gt;(CACHE_SIZE);</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ReferenceBeanInvocationHandler ç¼“å­˜ Map</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * KEYï¼šReference Bean çš„åå­—</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentHashMap&lt;String, ReferenceBeanInvocationHandler&gt; localReferenceBeanInvocationHandlerCache = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ReferenceBeanInvocationHandler&gt;(CACHE_SIZE);</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ä½¿ç”¨å±æ€§è¿›è¡Œæ³¨å…¥çš„ <span class="doctag">@Reference</span> Bean çš„ç¼“å­˜ Map</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä½¿ç”¨è¿™ä¸ª</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;InjectionMetadata.InjectedElement, ReferenceBean&lt;?&gt;&gt; injectedFieldReferenceBeanCache = <span class="keyword">new</span> ConcurrentHashMap&lt;InjectionMetadata.InjectedElement, ReferenceBean&lt;?&gt;&gt;(CACHE_SIZE);</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ä½¿ç”¨æ–¹æ³•è¿›è¡Œæ³¨å…¥çš„ <span class="doctag">@Reference</span> Bean çš„ç¼“å­˜ Map</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;InjectionMetadata.InjectedElement, ReferenceBean&lt;?&gt;&gt; injectedMethodReferenceBeanCache = <span class="keyword">new</span> ConcurrentHashMap&lt;InjectionMetadata.InjectedElement, ReferenceBean&lt;?&gt;&gt;(CACHE_SIZE);</span><br /><br /><span class="line"><span class="keyword">private</span> ApplicationContext applicationContext;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å…·ä½“çš„æ¯ä¸ªå˜é‡çš„æ—¶å€™ï¼Œç»“åˆä¸‹é¢æ¥çœ‹ã€‚</li>
</ul>
<h3 id="5-3-2-doGetInjectedBean">5.3.2 doGetInjectedBean</h3>
<p>å®ç°&nbsp;<code>#doGetInjectedBean(Reference reference, Object bean, String beanName, Class&lt;?&gt; injectedType, InjectionMetadata.InjectedElement injectedElement)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—è¦æ³¨å…¥çš„&nbsp;<code>@Reference</code>&nbsp;Bean ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ReferenceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">doGetInjectedBean</span><span class="params">(Reference reference, Object bean, String beanName, Class&lt;?&gt; injectedType,</span></span></span><br /><span class="line"><span class="function"><span class="params">                                   InjectionMetadata.InjectedElement injectedElement)</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line">    <span class="comment">// &lt;1&gt; è·å¾— Reference Bean çš„åå­—</span></span><br /><span class="line">    String referencedBeanName = buildReferencedBeanName(reference, injectedType);</span><br /><span class="line">    <span class="comment">// &lt;2&gt; åˆ›å»º ReferenceBean å¯¹è±¡</span></span><br /><span class="line">    ReferenceBean referenceBean = buildReferenceBeanIfAbsent(referencedBeanName, reference, injectedType, getClassLoader());</span><br /><span class="line">    <span class="comment">// &lt;3&gt; ç¼“å­˜åˆ° injectedFieldReferenceBeanCache or injectedMethodReferenceBeanCache ä¸­</span></span><br /><span class="line">    cacheInjectedReferenceBean(referenceBean, injectedElement);</span><br /><span class="line">    <span class="comment">// &lt;4&gt; åˆ›å»º Proxy ä»£ç†å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">return</span> buildProxy(referencedBeanName, referenceBean, injectedType);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>&lt;1&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#buildReferencedBeanName(Reference reference, Class&lt;?&gt; injectedType)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— Reference Bean çš„åå­—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ReferenceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">buildReferencedBeanName</span><span class="params">(Reference reference, Class&lt;?&gt; injectedType)</span> </span>{</span><br /><span class="line">    <span class="comment">// åˆ›å»º Service Bean çš„åå­—</span></span><br /><span class="line">    ServiceBeanNameBuilder builder = ServiceBeanNameBuilder.create(reference, injectedType, getEnvironment());</span><br /><span class="line">    <span class="keyword">return</span> getEnvironment().resolvePlaceholders(builder.build()); <span class="comment">// è¿™é‡Œï¼Œè²Œä¼¼é‡å¤è§£æå ä½ç¬¦äº†ã€‚ä¸è¿‡æ²¡å•¥å½±å“~</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å®é™…ä¸Šï¼Œä½¿ç”¨çš„å°±æ˜¯ ServiceBeanNameBuilder çš„é€»è¾‘ï¼Œå³å’Œ Dubbo Service Bean çš„åå­—ï¼Œæ˜¯ åŒä¸€å¥—ã€‚å½“ç„¶ï¼Œè¿™ä¸ªä¹Ÿéå¸¸åˆç†~</li>
</ul>
</li>
<li>
<p><code>&lt;2&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#buildReferenceBeanIfAbsent(String referencedBeanName, Reference reference, Class&lt;?&gt; referencedType, ClassLoader classLoader)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºï¼ˆè·å¾—ï¼‰ ReferenceBean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ReferenceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> ReferenceBean <span class="title">buildReferenceBeanIfAbsent</span><span class="params">(String referencedBeanName, Reference reference, Class&lt;?&gt; referencedType, ClassLoader classLoader)</span></span></span><br /><span class="line"><span class="function">        <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line">    <span class="comment">// é¦–å…ˆï¼Œä» referenceBeanCache ç¼“å­˜ä¸­ï¼Œè·å¾— referencedBeanName å¯¹åº”çš„ ReferenceBean å¯¹è±¡</span></span><br /><span class="line">    ReferenceBean&lt;?&gt; referenceBean = referenceBeanCache.get(referencedBeanName);</span><br /><span class="line">    <span class="comment">// ç„¶åï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œåˆ›å»ºã€‚ç„¶åï¼Œæ·»åŠ åˆ° referenceBeanCache ç¼“å­˜ä¸­ã€‚</span></span><br /><span class="line">    <span class="keyword">if</span> (referenceBean == <span class="keyword">null</span>) {</span><br /><span class="line">        ReferenceBeanBuilder beanBuilder = ReferenceBeanBuilder</span><br /><span class="line">                .create(reference, classLoader, applicationContext)</span><br /><span class="line">                .interfaceClass(referencedType);</span><br /><span class="line">        referenceBean = beanBuilder.build();</span><br /><span class="line">        referenceBeanCache.put(referencedBeanName, referenceBean);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> referenceBean;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å…¶ä¸­ï¼Œä¼šä½¿ç”¨ ReferenceBeanBuilder ç±»ï¼Œæ„å»º ReferenceBean å¯¹è±¡ã€‚å…³äºå®ƒï¼Œæˆ‘ä»¬ç¨ååœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-annotation/">ã€Œ5.3.4 ReferenceBeanBuilderã€</a>&nbsp;æ¥ç…ç…ã€‚å®é™…ä¸Šï¼Œå’Œä¸Šé¢ ServiceBean çš„æ„å»ºï¼Œä¹Ÿå·®ä¸äº†å¤ªå¤šã€‚</li>
</ul>
</li>
<li>
<p><code>&lt;3&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#cacheInjectedReferenceBean(String referencedBeanName, Reference reference, Class&lt;?&gt; referencedType, ClassLoader classLoader)</code>&nbsp;æ–¹æ³•ï¼Œç¼“å­˜åˆ°&nbsp;<code>injectedFieldReferenceBeanCache</code>&nbsp;or&nbsp;<code>injectedMethodReferenceBeanCache</code>&nbsp;ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ReferenceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">cacheInjectedReferenceBean</span><span class="params">(ReferenceBean referenceBean, InjectionMetadata.InjectedElement injectedElement)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (injectedElement.getMember() <span class="keyword">instanceof</span> Field) {</span><br /><span class="line">        injectedFieldReferenceBeanCache.put(injectedElement, referenceBean);</span><br /><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (injectedElement.getMember() <span class="keyword">instanceof</span> Method) {</span><br /><span class="line">        injectedMethodReferenceBeanCache.put(injectedElement, referenceBean);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>&lt;4&gt;</code>&nbsp;å¤„ï¼Œè°ƒç”¨&nbsp;<code>#buildProxy(String referencedBeanName, ReferenceBean referenceBean, Class&lt;?&gt; injectedType)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º Proxy ä»£ç†å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ReferenceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">buildProxy</span><span class="params">(String referencedBeanName, ReferenceBean referenceBean, Class&lt;?&gt; injectedType)</span> </span>{</span><br /><span class="line">    InvocationHandler handler = buildInvocationHandler(referencedBeanName, referenceBean);</span><br /><span class="line">    <span class="keyword">return</span> Proxy.newProxyInstance(getClassLoader(), <span class="keyword">new</span> Class[]{injectedType}, handler);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> InvocationHandler <span class="title">buildInvocationHandler</span><span class="params">(String referencedBeanName, ReferenceBean referenceBean)</span> </span>{</span><br /><span class="line">    <span class="comment">// é¦–å…ˆï¼Œä» localReferenceBeanInvocationHandlerCache ç¼“å­˜ä¸­ï¼Œè·å¾— ReferenceBeanInvocationHandler å¯¹è±¡</span></span><br /><span class="line">    ReferenceBeanInvocationHandler handler = localReferenceBeanInvocationHandlerCache.get(referencedBeanName);</span><br /><span class="line">    <span class="comment">// ç„¶åï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º ReferenceBeanInvocationHandler å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">if</span> (handler == <span class="keyword">null</span>) {</span><br /><span class="line">        handler = <span class="keyword">new</span> ReferenceBeanInvocationHandler(referenceBean);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">// &lt;X&gt; ä¹‹åï¼Œæ ¹æ®å¼•ç”¨çš„ Dubbo æœåŠ¡æ˜¯è¿œç¨‹çš„è¿˜æ˜¯æœ¬åœ°çš„ï¼Œåšä¸åŒçš„å¤„ç†ã€‚</span></span><br /><span class="line">    <span class="comment">// ã€æœ¬åœ°ã€‘åˆ¤æ–­å¦‚æœ applicationContext ä¸­å·²ç»åˆå§‹åŒ–ï¼Œè¯´æ˜æ˜¯æœ¬åœ°çš„ @Service Bean ï¼Œåˆ™æ·»åŠ åˆ° localReferenceBeanInvocationHandlerCache ç¼“å­˜ä¸­ã€‚</span></span><br /><span class="line">    <span class="comment">// ç­‰åˆ°æœ¬åœ°çš„ @Service Bean æš´éœ²åï¼Œå†è¿›è¡Œåˆå§‹åŒ–ã€‚</span></span><br /><span class="line">    <span class="keyword">if</span> (applicationContext.containsBean(referencedBeanName)) { <span class="comment">// Is local @Service Bean or not ?</span></span><br /><span class="line">        <span class="comment">// ReferenceBeanInvocationHandler's initialization has to wait for current local @Service Bean has been exported.</span></span><br /><span class="line">        localReferenceBeanInvocationHandlerCache.put(referencedBeanName, handler);</span><br /><span class="line">    <span class="comment">// ã€è¿œç¨‹ã€‘åˆ¤æ–­è‹¥æœ applicationContext ä¸­æœªåˆå§‹åŒ–ï¼Œè¯´æ˜æ˜¯è¿œç¨‹çš„ @Service Bean å¯¹è±¡ï¼Œåˆ™ç«‹å³è¿›è¡Œåˆå§‹åŒ–</span></span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        <span class="comment">// Remote Reference Bean should initialize immediately</span></span><br /><span class="line">        handler.init();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> handler;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ¯”è¾ƒå¤æ‚çš„æ˜¯ï¼Œ<code>&lt;X&gt;</code>&nbsp;å¤„ï¼Œæ ¹æ®å¼•ç”¨çš„ Dubbo æœåŠ¡æ˜¯è¿œç¨‹çš„è¿˜æ˜¯æœ¬åœ°çš„ï¼Œåšä¸åŒçš„å¤„ç†ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ
<ul>
<li>è¿œç¨‹çš„ Dubbo æœåŠ¡ï¼Œç†è®ºæ¥è¯´ï¼ˆä¸è€ƒè™‘å¯¹æ–¹æŒ‚æ‰çš„æƒ…å†µï¼‰ï¼Œæ˜¯å·²ç»å­˜åœ¨ï¼Œæ­¤æ—¶å¯ä»¥è¿›è¡ŒåŠ è½½å¼•ç”¨ã€‚</li>
<li>æœ¬åœ°çš„ Dubbo æœåŠ¡ï¼Œæ­¤æ—¶å¹¶æœªæš´éœ²ï¼Œåˆ™å…ˆæ·»åŠ åˆ°&nbsp;<code>localReferenceBeanInvocationHandlerCache</code>&nbsp;ä¸­è¿›è¡Œç¼“å­˜ã€‚ç­‰åç»­çš„ï¼Œé€šè¿‡ Spring äº‹ä»¶ç›‘å¬çš„åŠŸèƒ½ï¼Œè¿›è¡Œå®ç°ã€‚è¯¦ç»†çš„ï¼Œæˆ‘ä»¬åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-annotation/">ã€Œ5.3.3 onApplicationEventã€</a>ä¸­ä¼šçœ‹åˆ°ã€‚</li>
</ul>
</li>
<li>
<p>ReferenceBeanInvocationHandler ï¼Œæ˜¯ ReferenceAnnotationBeanPostProcessor çš„å†…éƒ¨é™æ€ç±»ï¼Œå®ç° Dubbo InvocationHandler æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ReferenceAnnotationBeanPostProcessor#ReferenceBeanInvocationHandler.java</span></span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ReferenceBeanInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * ReferenceBean å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReferenceBean referenceBean;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Bean å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> Object bean;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ReferenceBeanInvocationHandler</span><span class="params">(ReferenceBean referenceBean)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.referenceBean = referenceBean;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>{</span><br /><span class="line">        <span class="comment">// è°ƒç”¨ bean çš„å¯¹åº”çš„æ–¹æ³•</span></span><br /><span class="line">        <span class="keyword">return</span> method.invoke(bean, args);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">// é€šè¿‡åˆå§‹åŒ–æ–¹æ³•ï¼Œå¯ä»¥è·å¾— `ReferenceBean.ref`</span></span><br /><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.bean = referenceBean.get();</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>é‡å¿ƒåœ¨äº&nbsp;<code>#init()</code>&nbsp;æ–¹æ³•ï¼Œå¯ä»¥è°ƒç”¨&nbsp;<code>ReferenceBean#get()</code>&nbsp;æ–¹æ³•ï¼Œè¿›è¡Œå¼•ç”¨çš„ Bean çš„åˆå§‹åŒ–ï¼Œæœ€åè¿”å›å¼•ç”¨&nbsp;<code>ref</code>&nbsp;ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="5-3-3-onApplicationEvent">5.3.3 onApplicationEvent</h3>
<p>å®ç°&nbsp;<code>#onApplicationEvent(ApplicationEvent event)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ReferenceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ServiceBeanExportedEvent) {</span><br /><span class="line">        onServiceBeanExportEvent((ServiceBeanExportedEvent) event);</span><br /><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ContextRefreshedEvent) {</span><br /><span class="line">        onContextRefreshedEvent((ContextRefreshedEvent) event);</span><br /><span class="line">    }</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onServiceBeanExportEvent</span><span class="params">(ServiceBeanExportedEvent event)</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾— ServiceBean å¯¹è±¡</span></span><br /><span class="line">    ServiceBean serviceBean = event.getServiceBean();</span><br /><span class="line">    <span class="comment">// åˆå§‹åŒ–å¯¹åº”çš„ ReferenceBeanInvocationHandler</span></span><br /><span class="line">    initReferenceBeanInvocationHandler(serviceBean);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initReferenceBeanInvocationHandler</span><span class="params">(ServiceBean serviceBean)</span> </span>{</span><br /><span class="line">    String serviceBeanName = serviceBean.getBeanName();</span><br /><span class="line">    <span class="comment">// Remove ServiceBean when it's exported</span></span><br /><span class="line">    <span class="comment">// ä» localReferenceBeanInvocationHandlerCache ç¼“å­˜ä¸­ï¼Œç§»é™¤</span></span><br /><span class="line">    ReferenceBeanInvocationHandler handler = localReferenceBeanInvocationHandlerCache.remove(serviceBeanName);</span><br /><span class="line">    <span class="comment">// Initialize</span></span><br /><span class="line">    <span class="comment">// æ‰§è¡Œåˆå§‹åŒ–</span></span><br /><span class="line">    <span class="keyword">if</span> (handler != <span class="keyword">null</span>) {</span><br /><span class="line">        handler.init();</span><br /><span class="line">    }</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onContextRefreshedEvent</span><span class="params">(ContextRefreshedEvent event)</span> </span>{</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>é‡ç‚¹åœ¨äºå¤„ç† ServiceBeanExportedEvent äº‹ä»¶ã€‚å¤„ç†æ—¶ï¼Œå¦‚æœåˆ¤æ–­&nbsp;<code>localReferenceBeanInvocationHandlerCache</code>&nbsp;ä¸­å­˜åœ¨ ReferenceBeanInvocationHandler å¯¹è±¡ï¼Œè¯´æ˜æœ‰å®ƒæœªåˆå§‹åŒ–ã€‚åç»­ï¼Œè°ƒç”¨&nbsp;<code>ReferenceBeanInvocationHandler#init()</code>&nbsp;æ–¹æ³•ï¼Œä»è€Œå®Œæˆã€‚è¿™å—ï¼Œèƒ–å‹ç»“åˆ&nbsp;<a href="http://svip.iocoder.cn/Dubbo/configuration-annotation/">ã€Œ5.2.2 doGetInjectedBeanã€</a>&nbsp;ä¸€èµ·ï¼Œæ˜¯ä¸æ˜¯å°±æ˜ç™½äº†ã€‚</li>
<li>
<p>åœ¨ ServiceBean æš´éœ²æœåŠ¡å®Œæˆåï¼Œä¼šå‘å¸ƒ ServiceBeanExportedEvent äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ServiceBean.java</span></span><br /><br /><span class="line"><span class="keyword">private</span> ApplicationEventPublisher applicationEventPublisher;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.6.5</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">export</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// æš´éœ²æœåŠ¡</span></span><br /><span class="line">    <span class="keyword">super</span>.export();</span><br /><span class="line">    <span class="comment">// Publish ServiceBeanExportedEvent</span></span><br /><span class="line">    <span class="comment">// å‘å¸ƒäº‹ä»¶</span></span><br /><span class="line">    publishExportEvent();</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.6.5</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">publishExportEvent</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// åˆ›å»º ServiceBeanExportedEvent å¯¹è±¡</span></span><br /><span class="line">    ServiceBeanExportedEvent exportEvent = <span class="keyword">new</span> ServiceBeanExportedEvent(<span class="keyword">this</span>);</span><br /><span class="line">    <span class="comment">// å‘å¸ƒäº‹ä»¶</span></span><br /><span class="line">    applicationEventPublisher.publishEvent(exportEvent);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>org.apache.dubbo.config.spring.context.event.ServiceBeanExportedEvent</code>&nbsp;ï¼ŒService Bean æš´éœ²å®Œæˆäº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// BeanExportedEvent.java</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * A {<span class="doctag">@link</span> ApplicationEvent} after {<span class="doctag">@link</span> ServiceBean} {<span class="doctag">@link</span> ServiceBean#export() export} invocation</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> ApplicationEvent</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> ApplicationListener</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> ServiceBean</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2.6.5</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceBeanExportedEvent</span> <span class="keyword">extends</span> <span class="title">ApplicationEvent</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Create a new ApplicationEvent.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> serviceBean {<span class="doctag">@link</span> ServiceBean} bean</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ServiceBeanExportedEvent</span><span class="params">(ServiceBean serviceBean)</span> </span>{</span><br /><span class="line">        <span class="keyword">super</span>(serviceBean);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Get {<span class="doctag">@link</span> ServiceBean} instance</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> non-null</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> ServiceBean <span class="title">getServiceBean</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> (ServiceBean) <span class="keyword">super</span>.getSource();</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<h3 id="5-3-4-ReferenceBeanBuilder">5.3.4 ReferenceBeanBuilder</h3>
<p><code>org.apache.dubbo.config.spring.beans.factory.annotation.ReferenceBeanBuilder</code>&nbsp;ï¼Œç»§æ‰¿ AbstractAnnotationConfigBeanBuilder æŠ½è±¡ç±»ï¼ŒReferenceBean çš„æ„å»ºå™¨ã€‚</p>
<blockquote>
<p>è€ƒè™‘åˆ° ReferenceBeanBuilder ç±»ï¼Œå°±æ˜¯&nbsp;<code>#build()</code>&nbsp;æ–¹æ³•ï¼Œæˆ‘ä»¬å°±ç›´æ¥ç»“åˆ AbstractAnnotationConfigBeanBuilder æŠ½è±¡ç±»ï¼Œä¸€èµ·å†™äº†ã€‚</p>
</blockquote>
<h4 id="5-3-4-1-æ„é€ æ–¹æ³•">5.3.4.1 æ„é€ æ–¹æ³•</h4>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// AbstractAnnotationConfigBeanBuilder.java</span></span><br /><br /><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractAnnotationConfigBeanBuilder</span>&lt;<span class="title">A</span> <span class="keyword">extends</span> <span class="title">Annotation</span>, <span class="title">B</span> <span class="keyword">extends</span> <span class="title">AbstractInterfaceConfig</span>&gt; </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ³¨è§£</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> A annotation;</span><br />    <br /><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> ApplicationContext applicationContext;</span><br />    <br /><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> ClassLoader classLoader;</span><br />    <br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Bean å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">protected</span> Object bean;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ¥å£</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; interfaceClass;</span><br />    <br /><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">AbstractAnnotationConfigBeanBuilder</span><span class="params">(A annotation, ClassLoader classLoader,</span></span></span><br /><span class="line"><span class="function"><span class="params">                                                  ApplicationContext applicationContext)</span> </span>{</span><br /><span class="line">        Assert.notNull(annotation, <span class="string">"The Annotation must not be null!"</span>);</span><br /><span class="line">        Assert.notNull(classLoader, <span class="string">"The ClassLoader must not be null!"</span>);</span><br /><span class="line">        Assert.notNull(applicationContext, <span class="string">"The ApplicationContext must not be null!"</span>);</span><br /><span class="line">        <span class="keyword">this</span>.annotation = annotation;</span><br /><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br /><span class="line">        <span class="keyword">this</span>.classLoader = classLoader;</span><br /><span class="line">    }</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">// ReferenceBeanBuilder.java</span></span><br /><br /><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReferenceBeanBuilder</span> <span class="keyword">extends</span> <span class="title">AbstractAnnotationConfigBeanBuilder</span>&lt;<span class="title">Reference</span>, <span class="title">ReferenceBean</span>&gt; </span>{</span><br /><br /><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ReferenceBeanBuilder</span><span class="params">(Reference annotation, ClassLoader classLoader, ApplicationContext applicationContext)</span> </span>{</span><br /><span class="line">        <span class="keyword">super</span>(annotation, classLoader, applicationContext);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ReferenceBeanBuilder <span class="title">create</span><span class="params">(Reference annotation, ClassLoader classLoader, ApplicationContext applicationContext)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReferenceBeanBuilder(annotation, classLoader, applicationContext);</span><br /><span class="line">    }</span><br />    <br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å…¶ä¸­ï¼Œæ³›å‹&nbsp;<code>A</code>&nbsp;å¯¹åº”&nbsp;<code>@Reference</code>&nbsp;æ³¨è§£ï¼Œæ³›å‹&nbsp;<code>B</code>&nbsp;å¯¹åº” ReferenceBean ç±»ã€‚</li>
</ul>
<h4 id="5-3-4-2-build">5.3.4.2 build</h4>
<p><code>#build()</code>&nbsp;æ–¹æ³•ï¼Œæ„é€ æ³›å‹&nbsp;<code>B</code>&nbsp;å¯¹è±¡ã€‚æ­¤å¤„ï¼Œå°±æ˜¯æ„é€  ReferenceBean å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// AbstractAnnotationConfigBeanBuilder.java</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> B <span class="title">build</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line">    <span class="comment">// æ ¡éªŒä¾èµ–</span></span><br /><span class="line">    checkDependencies();</span><br /><span class="line">    <span class="comment">// æ‰§è¡Œæ„é€  Bean å¯¹è±¡</span></span><br /><span class="line">    B bean = doBuild();</span><br /><span class="line">    <span class="comment">// é…ç½® Bean å¯¹è±¡</span></span><br /><span class="line">    configureBean(bean);</span><br /><span class="line">    <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line">        logger.info(<span class="string">"The bean[type:"</span> + bean.getClass().getSimpleName() + <span class="string">"] has been built."</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> bean;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkDependencies</span><span class="params">()</span> </span>{</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Builds {<span class="doctag">@link</span> B Bean}</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> {<span class="doctag">@link</span> B Bean}</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> B <span class="title">doBuild</span><span class="params">()</span></span>;</span><br /><br /><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configureBean</span><span class="params">(B bean)</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line">    <span class="comment">// å‰ç½®é…ç½®</span></span><br /><span class="line">    preConfigureBean(annotation, bean);</span><br /><br /><span class="line">    <span class="comment">// é…ç½® RegistryConfig å±æ€§</span></span><br /><span class="line">    configureRegistryConfigs(bean);</span><br /><span class="line">    <span class="comment">// é…ç½® MonitorConfig å±æ€§</span></span><br /><span class="line">    configureMonitorConfig(bean);</span><br /><span class="line">    <span class="comment">// é…ç½® ApplicationConfig å±æ€§</span></span><br /><span class="line">    configureApplicationConfig(bean);</span><br /><span class="line">    <span class="comment">// é…ç½® ModuleConfig å±æ€§</span></span><br /><span class="line">    configureModuleConfig(bean);</span><br /><br /><span class="line">    <span class="comment">// åç½®é…ç½®</span></span><br /><span class="line">    postConfigureBean(annotation, bean);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">preConfigureBean</span><span class="params">(A annotation, B bean)</span> <span class="keyword">throws</span> Exception</span>; <span class="comment">// æŠ½è±¡æ–¹æ³•</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureRegistryConfigs</span><span class="params">(B bean)</span> </span>{</span><br /><span class="line">    String[] registryConfigBeanIds = resolveRegistryConfigBeanNames(annotation);</span><br /><span class="line">    List&lt;RegistryConfig&gt; registryConfigs = BeanFactoryUtils.getBeans(applicationContext, registryConfigBeanIds, RegistryConfig.class);</span><br /><span class="line">    bean.setRegistries(registryConfigs);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureMonitorConfig</span><span class="params">(B bean)</span> </span>{</span><br /><span class="line">    String monitorBeanName = resolveMonitorConfigBeanName(annotation);</span><br /><span class="line">    MonitorConfig monitorConfig = BeanFactoryUtils.getOptionalBean(applicationContext, monitorBeanName, MonitorConfig.class);</span><br /><span class="line">    bean.setMonitor(monitorConfig);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureApplicationConfig</span><span class="params">(B bean)</span> </span>{</span><br /><span class="line">    String applicationConfigBeanName = resolveApplicationConfigBeanName(annotation);</span><br /><span class="line">    ApplicationConfig applicationConfig = BeanFactoryUtils.getOptionalBean(applicationContext, applicationConfigBeanName, ApplicationConfig.class);</span><br /><span class="line">    bean.setApplication(applicationConfig);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureModuleConfig</span><span class="params">(B bean)</span> </span>{</span><br /><span class="line">    String moduleConfigBeanName = resolveModuleConfigBeanName(annotation);</span><br /><span class="line">    ModuleConfig moduleConfig = BeanFactoryUtils.getOptionalBean(applicationContext, moduleConfigBeanName, ModuleConfig.class);</span><br /><span class="line">    bean.setModule(moduleConfig);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">resolveModuleConfigBeanName</span><span class="params">(A annotation)</span></span>; <span class="comment">// æŠ½è±¡æ–¹æ³•</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">resolveApplicationConfigBeanName</span><span class="params">(A annotation)</span></span>; <span class="comment">// æŠ½è±¡æ–¹æ³•</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> String[] resolveRegistryConfigBeanNames(A annotation); <span class="comment">// æŠ½è±¡æ–¹æ³•</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title">resolveMonitorConfigBeanName</span><span class="params">(A annotation)</span></span>; <span class="comment">// æŠ½è±¡æ–¹æ³•</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">postConfigureBean</span><span class="params">(A annotation, B bean)</span> <span class="keyword">throws</span> Exception</span>; <span class="comment">// æŠ½è±¡æ–¹æ³•</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ReferenceBeanBuilder ä¸»è¦å¯¹ä¸Šé¢çš„æŠ½è±¡æ–¹æ³•ï¼Œè¿›è¡Œå…·ä½“å®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ReferenceBeanBuilder.java</span></span><br /><br /><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> String[] IGNORE_FIELD_NAMES = of(<span class="string">"application"</span>, <span class="string">"module"</span>, <span class="string">"consumer"</span>, <span class="string">"monitor"</span>, <span class="string">"registry"</span>)</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> ReferenceBean <span class="title">doBuild</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// åˆ›å»º ReferenceBean å¯¹è±¡</span></span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ReferenceBean&lt;&gt;();</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"Duplicates"</span>)</span><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">preConfigureBean</span><span class="params">(Reference reference, ReferenceBean referenceBean)</span> </span>{</span><br /><span class="line">    Assert.notNull(interfaceClass, <span class="string">"The interface class must set first!"</span>);</span><br /><br /><span class="line">    <span class="comment">// åˆ›å»º DataBinder å¯¹è±¡</span></span><br /><span class="line">    DataBinder dataBinder = <span class="keyword">new</span> DataBinder(referenceBean);</span><br /><span class="line">    <span class="comment">// Register CustomEditors for special fields</span></span><br /><span class="line">    <span class="comment">// æ³¨å†ŒæŒ‡å®šå±æ€§çš„è‡ªå®šä¹‰ Editor</span></span><br /><span class="line">    dataBinder.registerCustomEditor(String.class, <span class="string">"filter"</span>, <span class="keyword">new</span> StringTrimmerEditor(<span class="keyword">true</span>));</span><br /><span class="line">    dataBinder.registerCustomEditor(String.class, <span class="string">"listener"</span>, <span class="keyword">new</span> StringTrimmerEditor(<span class="keyword">true</span>));</span><br /><span class="line">    dataBinder.registerCustomEditor(Map.class, <span class="string">"parameters"</span>, <span class="keyword">new</span> PropertyEditorSupport() {</span><br /><span class="line">        <span class="meta">@Override</span></span><br /><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAsText</span><span class="params">(String text)</span> <span class="keyword">throws</span> java.lang.IllegalArgumentException </span>{</span><br /><span class="line">            <span class="comment">// Trim all whitespace</span></span><br /><span class="line">            String content = StringUtils.trimAllWhitespace(text);</span><br /><span class="line">            <span class="keyword">if</span> (!StringUtils.hasText(content)) { <span class="comment">// No content , ignore directly</span></span><br /><span class="line">                <span class="keyword">return</span>;</span><br /><span class="line">            }</span><br /><span class="line">            <span class="comment">// replace "=" to ","</span></span><br /><span class="line">            content = StringUtils.replace(content, <span class="string">"="</span>, <span class="string">","</span>);</span><br /><span class="line">            <span class="comment">// replace ":" to ","</span></span><br /><span class="line">            content = StringUtils.replace(content, <span class="string">":"</span>, <span class="string">","</span>);</span><br /><span class="line">            <span class="comment">// String[] to Map</span></span><br /><span class="line">            Map&lt;String, String&gt; parameters = CollectionUtils.toStringMap(commaDelimitedListToStringArray(content));</span><br /><span class="line">            setValue(parameters);</span><br /><span class="line">        }</span><br /><span class="line">    });</span><br /><br /><span class="line">    <span class="comment">// Bind annotation attributes</span></span><br /><span class="line">    <span class="comment">// å°†æ³¨è§£çš„å±æ€§ï¼Œè®¾ç½®åˆ° reference ä¸­</span></span><br /><span class="line">    dataBinder.bind(<span class="keyword">new</span> AnnotationPropertyValuesAdapter(reference, applicationContext.getEnvironment(), IGNORE_FIELD_NAMES));</span><br /><span class="line">}</span><br /><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">resolveModuleConfigBeanName</span><span class="params">(Reference annotation)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> annotation.<span class="keyword">module</span>();</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">resolveApplicationConfigBeanName</span><span class="params">(Reference annotation)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> annotation.application();</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="keyword">protected</span> String[] resolveRegistryConfigBeanNames(Reference annotation) {</span><br /><span class="line">    <span class="keyword">return</span> annotation.registry();</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">resolveMonitorConfigBeanName</span><span class="params">(Reference annotation)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> annotation.monitor();</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postConfigureBean</span><span class="params">(Reference annotation, ReferenceBean bean)</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line">    <span class="comment">// è®¾ç½® applicationContext</span></span><br /><span class="line">    bean.setApplicationContext(applicationContext);</span><br /><span class="line">    <span class="comment">// é…ç½® interfaceClass</span></span><br /><span class="line">    configureInterface(annotation, bean);</span><br /><span class="line">    <span class="comment">// é…ç½® ConsumerConfig</span></span><br /><span class="line">    configureConsumerConfig(annotation, bean);</span><br /><br /><span class="line">    <span class="comment">// æ‰§è¡Œ Bean åç½®å±æ€§åˆå§‹åŒ–</span></span><br /><span class="line">    bean.afterPropertiesSet();</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"Duplicates"</span>)</span><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureInterface</span><span class="params">(Reference reference, ReferenceBean referenceBean)</span> </span>{</span><br /><span class="line">    <span class="comment">// é¦–å…ˆï¼Œä» @Reference è·å¾— interfaceName å±æ€§ï¼Œä»è€Œè·å¾— interfaceClass ç±»</span></span><br /><span class="line">    Class&lt;?&gt; interfaceClass = reference.interfaceClass();</span><br /><span class="line">    <span class="keyword">if</span> (<span class="keyword">void</span>.class.equals(interfaceClass)) {</span><br /><span class="line">        interfaceClass = <span class="keyword">null</span>;</span><br /><span class="line">        String interfaceClassName = reference.interfaceName();</span><br /><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(interfaceClassName)) {</span><br /><span class="line">            <span class="keyword">if</span> (ClassUtils.isPresent(interfaceClassName, classLoader)) {</span><br /><span class="line">                interfaceClass = ClassUtils.resolveClassName(interfaceClassName, classLoader);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">// å¦‚æœè·å¾—ä¸åˆ°ï¼Œåˆ™ä½¿ç”¨ interfaceClass å³å¯</span></span><br /><span class="line">    <span class="keyword">if</span> (interfaceClass == <span class="keyword">null</span>) {</span><br /><span class="line">        interfaceClass = <span class="keyword">this</span>.interfaceClass;</span><br /><span class="line">    }</span><br /><br /><span class="line">    Assert.isTrue(interfaceClass.isInterface(), <span class="string">"The class of field or method that was annotated @Reference is not an interface!"</span>);</span><br /><span class="line">    referenceBean.setInterface(interfaceClass);</span><br /><span class="line">}</span><br /><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureConsumerConfig</span><span class="params">(Reference reference, ReferenceBean&lt;?&gt; referenceBean)</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾— ConsumerConfig å¯¹è±¡</span></span><br /><span class="line">    String consumerBeanName = reference.consumer();</span><br /><span class="line">    ConsumerConfig consumerConfig = getOptionalBean(applicationContext, consumerBeanName, ConsumerConfig.class);</span><br /><span class="line">    <span class="comment">// è®¾ç½®åˆ° referenceBean ä¸­</span></span><br /><span class="line">    referenceBean.setConsumer(consumerConfig);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>~</li>
</ul>
</li>
</ul>
<p>ğŸ˜ˆ å†™çš„ç›¸å¯¹ç®€ç•¥ã€‚èƒ–å‹æ³¨æ„çœ‹æ¯ä¸€ä¸ªçš„æ³¨é‡Šå“ˆ~</p>
<h3 id="5-3-5-destroy">5.3.5 destroy</h3>
<p>å®ç°&nbsp;<code>#destroy()</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œé”€æ¯é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ReferenceAnnotationBeanPostProcessor.java</span></span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line">    <span class="comment">// çˆ¶ç±»é”€æ¯</span></span><br /><span class="line">    <span class="keyword">super</span>.destroy();</span><br /><span class="line">    <span class="comment">// æ¸…ç©ºç¼“å­˜</span></span><br /><span class="line">    <span class="keyword">this</span>.referenceBeanCache.clear();</span><br /><span class="line">    <span class="keyword">this</span>.localReferenceBeanInvocationHandlerCache.clear();</span><br /><span class="line">    <span class="keyword">this</span>.injectedFieldReferenceBeanCache.clear();</span><br /><span class="line">    <span class="keyword">this</span>.injectedMethodReferenceBeanCache.clear();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</div>