<header class="article-header">
<h1 class="article-title">è¿‡æ»¤å™¨ï¼ˆäºŒï¼‰ä¹‹ ContextFilter</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡åˆ†äº« RpcContext ç›¸å…³è¿‡æ»¤å™¨ï¼ŒåŒ…æ‹¬ä¸¤ä¸ªï¼š</p>
<ul>
<li>ConsumerContextFilter ï¼šåœ¨æœåŠ¡<strong>æ¶ˆè´¹è€…</strong>ä¸­ä½¿ç”¨ï¼Œè´Ÿè´£<strong>å‘èµ·</strong>è°ƒç”¨æ—¶ï¼Œåˆå§‹åŒ– RpcContext ã€‚</li>
<li>ContextFilter ï¼šåœ¨æœåŠ¡<strong>æä¾›è€…</strong>ä¸­ä½¿ç”¨ï¼Œè´Ÿè´£<strong>è¢«</strong>è°ƒç”¨æ—¶ï¼Œåˆå§‹åŒ– RpcContext ã€‚</li>
</ul>
<h1 id="2-RpcContext">2. RpcContext</h1>
<p>RpcContextï¼Œä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚åœ¨&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/context.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‹</a>&nbsp;ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>ä¸Šä¸‹æ–‡ä¸­å­˜æ”¾çš„æ˜¯å½“å‰è°ƒç”¨è¿‡ç¨‹ä¸­æ‰€éœ€çš„ç¯å¢ƒä¿¡æ¯ã€‚æ‰€æœ‰é…ç½®ä¿¡æ¯éƒ½å°†è½¬æ¢ä¸º URL çš„å‚æ•°ï¼Œå‚è§&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/xml/introduction.html" target="_blank" rel="external nofollow noopener noreferrer">schema é…ç½®å‚è€ƒæ‰‹å†Œ</a>&nbsp;ä¸­çš„å¯¹åº”URLå‚æ•°ä¸€åˆ—ã€‚</p>
<p>RpcContext æ˜¯ä¸€ä¸ª ThreadLocal çš„ä¸´æ—¶çŠ¶æ€è®°å½•å™¨ï¼Œå½“æ¥æ”¶åˆ° RPC è¯·æ±‚ï¼Œæˆ–å‘èµ· RPC è¯·æ±‚æ—¶ï¼ŒRpcContext çš„çŠ¶æ€éƒ½ä¼šå˜åŒ–ã€‚æ¯”å¦‚ï¼šA è°ƒ Bï¼ŒB å†è°ƒ Cï¼Œåˆ™ B æœºå™¨ä¸Šï¼Œ</p>
<ul>
<li>åœ¨ B è°ƒ C ä¹‹å‰ï¼ŒRpcContext è®°å½•çš„æ˜¯ A è°ƒ B çš„ä¿¡æ¯ï¼Œ</li>
<li>åœ¨ B è°ƒ C ä¹‹åï¼ŒRpcContext è®°å½•çš„æ˜¯ B è°ƒ C çš„ä¿¡æ¯ã€‚</li>
</ul>
</blockquote>
<ul>
<li>RpcContext åœ¨è°ƒç”¨æ—¶çš„çŠ¶æ€å˜åŒ–ï¼Œæœ‰ç‚¹ç»•ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹å…·ä½“çš„ Filter å®ç°ï¼Œå°±ç›¸å¯¹å®¹æ˜“æ˜ç™½åˆ—ã€‚</li>
</ul>
<p><a href="http://svip.iocoder.cn/Dubbo/filter-context-filter/TODO"><code>com.alibaba.dubbo.rpc.RpcContext</code></a>&nbsp;ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * RpcContext çº¿ç¨‹å˜é‡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;RpcContext&gt; LOCAL = <span class="keyword">new</span> ThreadLocal&lt;RpcContext&gt;() {</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">protected</span> RpcContext <span class="title">initialValue</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RpcContext();</span><br /><span class="line">    }</span><br /><br /><span class="line">};</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * éšå¼å‚æ•°é›†åˆ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; attachments = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br /><span class="line"><span class="comment">// å®é™…æœªä½¿ç”¨</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; values = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å¼‚æ­¥è°ƒç”¨ Future</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Future&lt;?&gt; future;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å¯è°ƒç”¨æœåŠ¡çš„ URL å¯¹è±¡é›†åˆ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> List&lt;URL&gt; urls;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è°ƒç”¨æœåŠ¡çš„ URL å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> URL url;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ–¹æ³•å</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> String methodName;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å‚æ•°ç±»å‹æ•°ç»„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Class&lt;?&gt;[] parameterTypes;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å‚æ•°å€¼æ•°ç»„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Object[] arguments;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æœåŠ¡æ¶ˆè´¹è€…åœ°å€</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> InetSocketAddress localAddress;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æœåŠ¡æä¾›è€…åœ°å€</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> InetSocketAddress remoteAddress;</span><br /><br /><span class="line"><span class="meta">@Deprecated</span> <span class="comment">// DUBBO-325 åºŸå¼ƒçš„ï¼Œä½¿ç”¨ urls å±æ€§æ›¿ä»£</span></span><br /><span class="line"><span class="keyword">private</span> List&lt;Invoker&lt;?&gt;&gt; invokers;</span><br /><span class="line"><span class="meta">@Deprecated</span> <span class="comment">// DUBBO-325 åºŸå¼ƒçš„ï¼Œä½¿ç”¨ url å±æ€§æ›¿ä»£</span></span><br /><span class="line"><span class="keyword">private</span> Invoker&lt;?&gt; invoker;</span><br /><span class="line"><span class="meta">@Deprecated</span> <span class="comment">// DUBBO-325 åºŸå¼ƒçš„ï¼Œä½¿ç”¨ methodNameã€parameterTypesã€arguments å±æ€§æ›¿ä»£</span></span><br /><span class="line"><span class="keyword">private</span> Invocation invocation;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è¯·æ±‚</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * ä¾‹å¦‚ï¼Œåœ¨ RestProtocol</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Object request;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å“åº”</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * ä¾‹å¦‚ï¼Œåœ¨ RestProtocol</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Object response;</span><br /> <br /><span class="line"> <span class="comment">// ... çœç•¥ä¸€äº›</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>LOCAL</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼ŒRpcContext çº¿ç¨‹å˜é‡ã€‚åˆå§‹è·å¾—æ—¶ï¼Œè¿”å›æ–°çš„ RpcContext å¯¹è±¡ã€‚</li>
<li><code>attachments</code>&nbsp;å±æ€§ï¼Œéšå¼å‚æ•°é›†åˆã€‚
<ul>
<li>ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨ PRC è°ƒç”¨å‰ï¼Œå¯åœ¨ä¸šåŠ¡ä»£ç é‡Œæ·»åŠ ä¸€äº›æƒ³è¦ä¼ é€’ç»™æœåŠ¡çš„å‚æ•°åˆ°è¯¥å±æ€§</li>
<li>åˆä¾‹å¦‚ï¼Œåœ¨åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªæ—¶ï¼Œæ·»åŠ é“¾è·¯è¿½è¸ª<strong>ç¼–å·</strong>åˆ°è¯¥å±æ€§ç§ã€‚</li>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/demos/attachment.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; éšå¼å‚æ•°ã€‹</a></li>
</ul>
</li>
<li><code>future</code>&nbsp;å±æ€§ï¼Œå¼‚æ­¥è°ƒç”¨ Future å¯¹è±¡ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/rpc-dubbo-3-async/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡è°ƒç”¨ï¼ˆä¸‰ï¼‰ä¹‹è¿œç¨‹è°ƒç”¨ï¼ˆDubboï¼‰ã€3ã€‘å¼‚æ­¥è°ƒç”¨ã€‹</a>&nbsp;æœ‰è¯¦ç»†ä½¿ç”¨çš„ä»£ç åˆ†äº«ã€‚</li>
<li>ã€æ›¿ä»£&nbsp;<code>invokers</code>&nbsp;å±æ€§ã€‘
<ul>
<li><code>urls</code>&nbsp;å±æ€§ï¼Œ<strong>å¯è°ƒç”¨</strong>çš„æœåŠ¡çš„ URL å¯¹è±¡é›†åˆï¼Œåœ¨é›†ç¾¤å®¹é”™æ¨¡å—å®ç°ã€‚</li>
</ul>
</li>
<li>ã€æ›¿ä»£&nbsp;<code>invoker</code>&nbsp;å±æ€§ã€‘
<ul>
<li><code>url</code>&nbsp;å±æ€§ï¼Œ<strong>è°ƒç”¨</strong>çš„æœåŠ¡çš„ URL å¯¹è±¡ã€‚</li>
</ul>
</li>
<li>ã€æ›¿ä»£&nbsp;<code>invocation</code>&nbsp;å±æ€§ã€‘
<ul>
<li><code>methodName</code>&nbsp;å±æ€§ï¼Œ<strong>è°ƒç”¨</strong>çš„æ–¹æ³•åã€‚</li>
<li><code>parameterTypes</code>&nbsp;å±æ€§ï¼Œ<strong>è°ƒç”¨</strong>çš„å‚æ•°ç±»å‹æ•°ç»„ã€‚</li>
<li><code>arguments</code>&nbsp;å±æ€§ï¼Œ<strong>è°ƒç”¨</strong>çš„å‚æ•°å€¼æ•°ç»„ã€‚</li>
</ul>
</li>
<li>åœ°å€
<ul>
<li><code>localAddress</code>&nbsp;å±æ€§ï¼Œ æœåŠ¡æ¶ˆè´¹è€…åœ°å€ã€‚</li>
<li><code>remoteAddress</code>&nbsp;å±æ€§ï¼ŒæœåŠ¡æä¾›è€…åœ°å€ã€‚</li>
</ul>
</li>
<li><code>request</code>&nbsp;<code>response</code>&nbsp;å±æ€§ï¼Œè¯·æ±‚å’Œå“åº”ã€‚ä¾‹å¦‚ï¼Œåœ¨ RestProtocol ä¸­ä½¿ç”¨ï¼Œä»£è¡¨ HTTP Request å’Œ Response å¯¹è±¡ï¼Œåœ¨ RpcContextFilter ä¸­è®¾ç½®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_11_13/01.png" alt="RpcContextFilter" />
<ul>
<li>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°&nbsp;<code>request</code>&nbsp;<code>response</code>&nbsp;çš„ç±»å‹æ˜¯ Object ç±»ã€‚é€šè¿‡è¿™ç§å½¢å¼ï¼Œå¯ä»¥ä¸ä»…ä»…é€‚ç”¨äº HTTP çš„åœºæ™¯ã€‚</li>
</ul>
</li>
</ul>
<p>RpcContext ä¸­ï¼Œæœ‰å¾ˆå¤šæ–¹æ³•ï¼Œæ¯”è¾ƒæ˜“æ‡‚ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹å™¢ã€‚</p>
<h1 id="3-ConsumerContextFilter">3. ConsumerContextFilter</h1>
<p><code>com.alibaba.dubbo.rpc.filter.ConsumerContextFilter</code>&nbsp;ï¼Œå®ç° Filter æ¥å£ï¼Œ<strong>æœåŠ¡æ¶ˆè´¹è€…</strong>çš„ ContextFilter å®ç°ç±»ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Activate</span>(group = Constants.CONSUMER, order = -<span class="number">10000</span>)</span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumerContextFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>{</span><br /><span class="line"> <span class="number">3</span>: </span><br /><span class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">6</span>:         <span class="comment">// è®¾ç½® RpcContext å¯¹è±¡</span></span><br /><span class="line"> <span class="number">7</span>:         RpcContext.getContext()</span><br /><span class="line"> <span class="number">8</span>:                 .setInvoker(invoker)</span><br /><span class="line"> <span class="number">9</span>:                 .setInvocation(invocation)</span><br /><span class="line"><span class="number">10</span>:                 .setLocalAddress(NetUtils.getLocalHost(), <span class="number">0</span>) <span class="comment">// æœ¬åœ°åœ°å€</span></span><br /><span class="line"><span class="number">11</span>:                 .setRemoteAddress(invoker.getUrl().getHost(), invoker.getUrl().getPort()); <span class="comment">// è¿œç¨‹åœ°å€</span></span><br /><span class="line"><span class="number">12</span>:         <span class="comment">// è®¾ç½® RpcInvocation å¯¹è±¡çš„ `invoker` å±æ€§</span></span><br /><span class="line"><span class="number">13</span>:         <span class="keyword">if</span> (invocation <span class="keyword">instanceof</span> RpcInvocation) {</span><br /><span class="line"><span class="number">14</span>:             ((RpcInvocation) invocation).setInvoker(invoker);</span><br /><span class="line"><span class="number">15</span>:         }</span><br /><span class="line"><span class="number">16</span>:         <span class="comment">// æœåŠ¡è°ƒç”¨</span></span><br /><span class="line"><span class="number">17</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">18</span>:             <span class="keyword">return</span> invoker.invoke(invocation);</span><br /><span class="line"><span class="number">19</span>:         } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">20</span>:             <span class="comment">// æ¸…ç†éšå¼å‚æ•°é›†åˆ</span></span><br /><span class="line"><span class="number">21</span>:             RpcContext.getContext().clearAttachments();</span><br /><span class="line"><span class="number">22</span>:         }</span><br /><span class="line"><span class="number">23</span>:     }</span><br /><span class="line"><span class="number">24</span>: </span><br /><span class="line"><span class="number">25</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 6 è‡³ 11 è¡Œï¼šè®¾ç½® RpcContext å¯¹è±¡ã€‚</li>
<li>ç¬¬ 12 è‡³ 15 è¡Œï¼šè®¾ç½® RpcInvocation å¯¹è±¡çš„&nbsp;<code>invoker</code>&nbsp;å±æ€§ã€‚è¯¥å±æ€§ï¼Œç›®å‰ä½¿ç”¨åœ¨å¦‚ä¸‹å›¾çš„åœºæ™¯ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_11_13/02.png" alt="RpcInvocation" /></li>
<li>ç¬¬ 18 è¡Œï¼šè°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚</li>
<li>
<p>ç¬¬ 19 è‡³ 22 è¡Œï¼šè°ƒç”¨&nbsp;<code>RpcContext#clearAttachments()</code>&nbsp;æ–¹æ³•ï¼Œæ¸…ç†éšå¼å‚æ•°é›†åˆã€‚æ‰€ä»¥ï¼Œ<strong>æ¯æ¬¡</strong>ï¼ˆæ³¨æ„ï¼Œæ¯æ¬¡ï¼ï¼ï¼ï¼‰æœåŠ¡è°ƒç”¨å®Œæˆï¼ŒRpcContext è®¾ç½®çš„éšå¼å‚æ•°<strong>éƒ½ä¼šè¢«æ¸…ç†</strong>ï¼ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clearAttachments</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.attachments.clear();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<p>ğŸ˜ˆ çœ‹åˆ°æ­¤å¤„ï¼Œ<code>RpcContext.attachments</code>&nbsp;å±æ€§ï¼Œæ˜¯å¦‚ä½•ä¼ é€’ç»™è¢«è°ƒç”¨çš„æœåŠ¡çš„å‘¢ï¼Ÿç­”æ¡ˆåœ¨ä¸‹å›¾ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_11_13/03.png" alt="é€ä¼ " /></p>
<h1 id="4-ContextFilter">4. ContextFilter</h1>
<p><code>com.alibaba.dubbo.rpc.filter.ContextFilter</code>&nbsp;ï¼Œå®ç° Filter æ¥å£ï¼Œ<strong>æœåŠ¡æä¾›è€…</strong>çš„ ContextFilter å®ç°ç±»ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Activate</span>(group = Constants.PROVIDER, order = -<span class="number">10000</span>)</span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContextFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>{</span><br /><span class="line"> <span class="number">3</span>: </span><br /><span class="line"> <span class="number">4</span>:     <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">5</span>:     <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">6</span>:         <span class="comment">// åˆ›å»ºæ–°çš„ `attachments` é›†åˆï¼Œæ¸…ç†å…¬ç”¨çš„éšå¼å‚æ•°</span></span><br /><span class="line"> <span class="number">7</span>:         Map&lt;String, String&gt; attachments = invocation.getAttachments();</span><br /><span class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (attachments != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">9</span>:             attachments = <span class="keyword">new</span> HashMap&lt;String, String&gt;(attachments);</span><br /><span class="line"><span class="number">10</span>:             attachments.remove(Constants.PATH_KEY);</span><br /><span class="line"><span class="number">11</span>:             attachments.remove(Constants.GROUP_KEY);</span><br /><span class="line"><span class="number">12</span>:             attachments.remove(Constants.VERSION_KEY);</span><br /><span class="line"><span class="number">13</span>:             attachments.remove(Constants.DUBBO_VERSION_KEY);</span><br /><span class="line"><span class="number">14</span>:             attachments.remove(Constants.TOKEN_KEY);</span><br /><span class="line"><span class="number">15</span>:             attachments.remove(Constants.TIMEOUT_KEY);</span><br /><span class="line"><span class="number">16</span>:             attachments.remove(Constants.ASYNC_KEY); <span class="comment">// Remove async property to avoid being passed to the following invoke chain.</span></span><br /><span class="line"><span class="number">17</span>:                                                      <span class="comment">// æ¸…ç©ºæ¶ˆè´¹ç«¯çš„å¼‚æ­¥å‚æ•°</span></span><br /><span class="line"><span class="number">18</span>:         }</span><br /><span class="line"><span class="number">19</span>:         <span class="comment">// è®¾ç½® RpcContext å¯¹è±¡</span></span><br /><span class="line"><span class="number">20</span>:         RpcContext.getContext()</span><br /><span class="line"><span class="number">21</span>:                 .setInvoker(invoker)</span><br /><span class="line"><span class="number">22</span>:                 .setInvocation(invocation)</span><br /><span class="line"><span class="number">23</span>: <span class="comment">//                .setAttachments(attachments)  // merged from dubbox</span></span><br /><span class="line"><span class="number">24</span>:                 .setLocalAddress(invoker.getUrl().getHost(), invoker.getUrl().getPort());</span><br /><span class="line"><span class="number">25</span>:         <span class="comment">// mreged from dubbox</span></span><br /><span class="line"><span class="number">26</span>:         <span class="comment">// we may already added some attachments into RpcContext before this filter (e.g. in rest protocol)</span></span><br /><span class="line"><span class="number">27</span>:         <span class="comment">// åœ¨æ­¤è¿‡æ»¤å™¨(ä¾‹å¦‚reståè®®)ä¹‹å‰ï¼Œæˆ‘ä»¬å¯èƒ½å·²ç»åœ¨RpcContextä¸­æ·»åŠ äº†ä¸€äº›é™„ä»¶ã€‚</span></span><br /><span class="line"><span class="number">28</span>:         <span class="keyword">if</span> (attachments != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">29</span>:             <span class="keyword">if</span> (RpcContext.getContext().getAttachments() != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">30</span>:                 RpcContext.getContext().getAttachments().putAll(attachments);</span><br /><span class="line"><span class="number">31</span>:             } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">32</span>:                 RpcContext.getContext().setAttachments(attachments);</span><br /><span class="line"><span class="number">33</span>:             }</span><br /><span class="line"><span class="number">34</span>:         }</span><br /><span class="line"><span class="number">35</span>:         <span class="comment">// è®¾ç½® RpcInvocation å¯¹è±¡çš„ `invoker` å±æ€§</span></span><br /><span class="line"><span class="number">36</span>:         <span class="keyword">if</span> (invocation <span class="keyword">instanceof</span> RpcInvocation) {</span><br /><span class="line"><span class="number">37</span>:             ((RpcInvocation) invocation).setInvoker(invoker);</span><br /><span class="line"><span class="number">38</span>:         }</span><br /><span class="line"><span class="number">39</span>:         <span class="comment">// æœåŠ¡è°ƒç”¨</span></span><br /><span class="line"><span class="number">40</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">41</span>:             <span class="keyword">return</span> invoker.invoke(invocation);</span><br /><span class="line"><span class="number">42</span>:         } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">43</span>:             <span class="comment">// ç§»é™¤ä¸Šä¸‹æ–‡</span></span><br /><span class="line"><span class="number">44</span>:             RpcContext.removeContext();</span><br /><span class="line"><span class="number">45</span>:         }</span><br /><span class="line"><span class="number">46</span>:     }</span><br /><span class="line"><span class="number">47</span>: </span><br /><span class="line"><span class="number">48</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 6 è‡³ 18 è¡Œï¼šåˆ›å»ºæ–°çš„&nbsp;<code>attachments</code>&nbsp;é›†åˆï¼Œå› ä¸ºè¦æ¸…ç†<strong>å…¬ç”¨</strong>çš„éšå¼å‚æ•°ã€‚è¯¥<strong>å…¬ç”¨</strong>çš„éšå¼å‚æ•°ï¼Œè®¾ç½®çš„åœ°æ–¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_11_13/04.png" alt="RpcInvocation" /></li>
<li>ç¬¬ 19 è‡³ 24 è¡Œï¼šè®¾ç½® RpcContext å¯¹è±¡ã€‚</li>
<li>ç¬¬ 25 è‡³ 34 è¡Œï¼šåœ¨æ­¤è¿‡æ»¤å™¨( ä¾‹å¦‚ RestProtocol çš„ RpcContextFilter )ä¹‹å‰ï¼Œæˆ‘ä»¬å¯èƒ½å·²ç»åœ¨ RpcContext ä¸­æ·»åŠ äº†ä¸€äº›éšå¼å‚æ•°ã€‚</li>
<li>ç¬¬ 35 è‡³ 38 è¡Œï¼šè°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚</li>
<li>ç¬¬ 41 è¡Œï¼šè°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼ŒæœåŠ¡è°ƒç”¨ã€‚</li>
<li>
<p>ç¬¬ 42 è‡³ 45 è¡Œï¼šè°ƒç”¨&nbsp;<code>RpcContext#removeContext()</code>&nbsp;æ–¹æ³•ï¼Œç§»é™¤ä¸Šä¸‹æ–‡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeContext</span><span class="params">()</span> </span>{</span><br /><span class="line">    LOCAL.remove();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<h1 id="5-RpcContext-values">5. RpcContext.values</h1>
<p>æˆ‘ä»¬åœ¨å›è¿‡å¤´æ¥çœ‹&nbsp;<code>RpcContext.values</code>&nbsp;å±æ€§ã€‚ç›®å‰ Dubbo ä¸­ï¼Œ<strong>å¹¶æœªä½¿ç”¨å®ƒ</strong>ã€‚</p>
<p>ä»ä»£ç çœ‹ä¸‹æ¥ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›æœ‰<strong>å¤šæ¬¡</strong>&nbsp;Dubbo è°ƒç”¨ï¼Œå…±äº«å‚æ•°ï¼Œå¹¶ä¸”ä¸è¢« ConsumerContextFilter æ¸…ç†éšå¼å‚æ•°ï¼Œç¬”è€…è§‰å¾—å¯ä»¥ä½¿ç”¨è¯¥&nbsp;<code>values</code>&nbsp;å±æ€§ã€‚</p>
<p>å’Œ&nbsp;<code>value</code>&nbsp;å±æ€§ç›¸å…³çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">get</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> values;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> RpcContext <span class="title">set</span><span class="params">(String key, Object value)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>) {</span><br /><span class="line">        values.remove(key);</span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        values.put(key, value);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br /><span class="line">}   </span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> RpcContext <span class="title">remove</span><span class="params">(String key)</span> </span>{</span><br /><span class="line">    values.remove(key);</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br /><span class="line">} </span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(String key)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> values.get(key);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>å½“ç„¶ï¼Œå¦‚æœåŒæ—¶æˆ‘ä»¬å¸Œæœ›ä¸€äº›<strong>é€šç”¨</strong>çš„&nbsp;<code>values</code>&nbsp;ä¼ é€’ç»™è¢«è°ƒç”¨çš„æœåŠ¡ï¼Œå¯ä»¥å®ç°ä¸€ä¸ª Filter ï¼Œç®€åŒ–ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">RpcContext.getContext().setAttachment(<span class="string">"key1"</span>, RpcContext.getContext().get(<span class="string">"key2"</span>).toString());</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>æ©ï¼Œè¿˜æ˜¯å½“ç„¶ï¼Œåœ¨ä¸šåŠ¡ä»£ç é‡Œï¼Œä¹Ÿå¯ä»¥è¿™ä¹ˆè°ƒç”¨ã€‚ğŸ™‚</p>
</div>