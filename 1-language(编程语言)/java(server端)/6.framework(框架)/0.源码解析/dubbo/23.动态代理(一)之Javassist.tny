<header class="article-header">
<h1 class="article-title">åŠ¨æ€ä»£ç†ï¼ˆä¸€ï¼‰ä¹‹ Javassist</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡åˆ†äº« Dubbo&nbsp;<strong>åŠ¨æ€ä»£ç†</strong>çš„å®ç°ã€‚</p>
<p>åœ¨&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/xml/introduction.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; schema é…ç½®å‚è€ƒæ‰‹å†Œã€‹</a>&nbsp;ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°&nbsp;<code>&lt;dubbo:service /&gt;</code>&nbsp;å’Œ&nbsp;<code>&lt;dubbo:reference /&gt;</code>&nbsp;æ ‡ç­¾ä¸­ï¼Œå¯ä»¥é€šè¿‡&nbsp;<code>"proxy"</code>&nbsp;å±æ€§ï¼Œå¯ä»¥é…ç½®åŠ¨æ€ä»£ç†çš„ç”Ÿæˆæ–¹å¼ï¼š</p>
<blockquote>
<p>ç”ŸæˆåŠ¨æ€ä»£ç†æ–¹å¼ï¼Œå¯é€‰ï¼šjdk / javassist</p>
</blockquote>
<p>ä»è¯´æ˜ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒDubbo å®ç°äº†<strong>ä¸¤ç§</strong>æ–¹å¼ç”Ÿæˆä»£ç†ï¼š</p>
<ul>
<li>Javassit</li>
<li>JDK</li>
</ul>
<p>ğŸ™‚ æœ¬æ–‡åˆ†äº« Javassist å®ç°åŠ¨æ€ä»£ç†çš„æºç ï¼›æ¶‰åŠä»£ç å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>dubbo-common</code>&nbsp;æ¨¡å—çš„&nbsp;<code>bytecode</code>&nbsp;åŒ…ã€‚</li>
<li><code>dubbo-rpc-api</code>&nbsp;æ¨¡å—çš„&nbsp;<code>proxy</code>&nbsp;åŒ…ã€‚</li>
</ul>
<p>ä¸‹ä¸€ç¯‡æ–‡ç« åˆ†äº« JDK å®ç°åŠ¨æ€ä»£ç†çš„æºç ã€‚</p>
<h1 id="2-æ€§èƒ½">2. æ€§èƒ½</h1>
<p>åœ¨åˆ†äº«å…·ä½“å®ç°ä¹‹å‰ï¼Œå¯èƒ½æœ‰èƒ–å‹å¯¹æ€§èƒ½æ–¹é¢æ„Ÿå…´è¶£ï¼Œå¯ä»¥çœ‹çœ‹å¦‚ä¸‹çš„å†…å®¹ï¼š</p>
<ul>
<li><a href="http://javatar.iteye.com/blog/814426" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠåŠ¨æ€ä»£ç†æ–¹æ¡ˆæ€§èƒ½å¯¹æ¯”ã€‹</a></li>
<li>
<p>æ¥è‡ªè€å¾çš„æŸç¯‡æ–‡ç« </p>
<blockquote>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_09_13/01.png" alt="èœé€¼è€å¾" /></p>
</blockquote>
</li>
</ul>
<h1 id="3-æ•´ä½“æµç¨‹">3. æ•´ä½“æµç¨‹</h1>
<p>ğŸ˜ˆ çæ¯”æ¯”äº†è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬å¼€å§‹è¿›å…¥æ­£é¢˜äº†ã€‚ç›¸ä¿¡å¾ˆå¤šèƒ–å‹å¯¹<strong>åŠ¨æ€ä»£ç†</strong>çš„æ¦‚å¿µå·²ç»ç†è§£ï¼ˆå¦‚æœæš‚æ—¶ä¸ç†è§£ï¼Œè¯· Google ä¸‹ï¼‰ï¼Œé‚£ä¹ˆ Dubbo å¯¹å®ƒä»¬ä½¿ç”¨åœ¨å“ªå‘¢ï¼Ÿè§ä¸‹å›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_09_13/02.png" alt="èœé€¼è€ç‹" /></p>
<blockquote>
<p>æ—ç™½å›ï¼šæœ¬å›¾æš‚ä¸è€ƒè™‘é›†ç¾¤å®¹é”™ã€ç½‘ç»œè°ƒç”¨ã€åºåˆ—åŒ–ååºåˆ—ç­‰ã€‚</p>
</blockquote>
<ul>
<li>åœ¨ Dubbo ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨&nbsp;<strong>Service æ¥å£</strong>ï¼Œä½œä¸ºæœåŠ¡ API çš„å¥‘çº¦ã€‚</li>
<li>
<p>åœ¨ Consumer ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨ Service æ¥å£çš„æ–¹æ³•æ—¶ï¼Œå®é™…è°ƒç”¨çš„æ˜¯ Dubbo åŠ¨æ€ä»£ç†ã€‚ä¸‹é¢å…ˆä¸€èµ·æ¥çœ‹ä¸€ä¸ªç”Ÿæˆçš„&nbsp;<strong>proxy</strong>&nbsp;ä»£ç çš„ç¤ºä¾‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">package</span> com.alibaba.dubbo.common.bytecode;</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>: <span class="keyword">import</span> com.alibaba.dubbo.demo.DemoService;</span><br /><span class="line"> <span class="number">4</span>: <span class="keyword">import</span> com.alibaba.dubbo.rpc.service.EchoService;</span><br /><span class="line"> <span class="number">5</span>: <span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br /><span class="line"> <span class="number">6</span>: <span class="keyword">import</span> java.lang.reflect.Method;</span><br /><span class="line"> <span class="number">7</span>: </span><br /><span class="line"> <span class="number">8</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">proxy0</span></span></span><br /><span class="line"> 9:   implements ClassGenerator.DC, EchoService, DemoService</span><br /><span class="line"><span class="number">10</span>: {</span><br /><span class="line"><span class="number">11</span>:   <span class="keyword">public</span> <span class="keyword">static</span> Method[] methods;</span><br /><span class="line"><span class="number">12</span>:   <span class="keyword">private</span> InvocationHandler handler;</span><br /><span class="line"><span class="number">13</span>:   </span><br /><span class="line"><span class="number">14</span>:   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bye</span><span class="params">(Object paramObject)</span></span></span><br /><span class="line"><span class="function">15:   </span>{</span><br /><span class="line"><span class="number">16</span>:     Object[] arrayOfObject = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br /><span class="line"><span class="number">17</span>:     arrayOfObject[<span class="number">0</span>] = paramObject;</span><br /><span class="line"><span class="number">18</span>:     Object localObject = <span class="keyword">this</span>.handler.invoke(<span class="keyword">this</span>, methods[<span class="number">0</span>], arrayOfObject);</span><br /><span class="line"><span class="number">19</span>:   }</span><br /><span class="line"><span class="number">20</span>:   </span><br /><span class="line"><span class="number">21</span>:   <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String paramString)</span></span></span><br /><span class="line"><span class="function">22:   </span>{</span><br /><span class="line"><span class="number">23</span>:     Object[] arrayOfObject = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br /><span class="line"><span class="number">24</span>:     arrayOfObject[<span class="number">0</span>] = paramString;</span><br /><span class="line"><span class="number">25</span>:     Object localObject = <span class="keyword">this</span>.handler.invoke(<span class="keyword">this</span>, methods[<span class="number">1</span>], arrayOfObject);</span><br /><span class="line"><span class="number">26</span>:     <span class="keyword">return</span> (String)localObject;</span><br /><span class="line"><span class="number">27</span>:   }</span><br /><span class="line"><span class="number">28</span>:   </span><br /><span class="line"><span class="number">29</span>:   <span class="keyword">public</span> Object $echo(Object paramObject)</span><br /><span class="line"><span class="number">30</span>:   {</span><br /><span class="line"><span class="number">31</span>:     Object[] arrayOfObject = <span class="keyword">new</span> Object[<span class="number">1</span>];</span><br /><span class="line"><span class="number">32</span>:     arrayOfObject[<span class="number">0</span>] = paramObject;</span><br /><span class="line"><span class="number">33</span>:     Object localObject = <span class="keyword">this</span>.handler.invoke(<span class="keyword">this</span>, methods[<span class="number">2</span>], arrayOfObject);</span><br /><span class="line"><span class="number">34</span>:     <span class="keyword">return</span> (Object)localObject;</span><br /><span class="line"><span class="number">35</span>:   }</span><br /><span class="line"><span class="number">36</span>:   </span><br /><span class="line"><span class="number">37</span>:   <span class="function"><span class="keyword">public</span> <span class="title">proxy0</span><span class="params">()</span> </span>{}</span><br /><span class="line"><span class="number">38</span>:   </span><br /><span class="line"><span class="number">39</span>:   <span class="function"><span class="keyword">public</span> <span class="title">proxy0</span><span class="params">(InvocationHandler paramInvocationHandler)</span></span></span><br /><span class="line"><span class="function">40:   </span>{</span><br /><span class="line"><span class="number">41</span>:     <span class="keyword">this</span>.handler = paramInvocationHandler;</span><br /><span class="line"><span class="number">42</span>:   }</span><br /><span class="line"><span class="number">43</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è¯¥ç±»é€šè¿‡&nbsp;<code>dubbo-common</code>&nbsp;æ¨¡å—çš„&nbsp;<code>bytecode</code>&nbsp;æ¨¡å—çš„&nbsp;<strong>Proxy</strong>&nbsp;ç±»ï¼Œ<strong>è‡ªåŠ¨ç”Ÿæˆ</strong>ï¼Œä½¿ç”¨ Javassist æŠ€æœ¯ã€‚</li>
<li>ç”Ÿæˆçš„&nbsp;<strong>proxy</strong>&nbsp;ç±»ä¼š<strong>å®ç°</strong>æˆ‘ä»¬å®šä¹‰çš„ Service æ¥å£( ä¾‹å¦‚ï¼Œæ­¤å¤„æ˜¯ DemoService )ã€‚</li>
<li><code>#bye(Object)</code>&nbsp;å’Œ&nbsp;<code>#sayHello(Object)</code>&nbsp;æ–¹æ³•ï¼Œæ˜¯æˆ‘ä»¬å®šä¹‰åœ¨ DemoService çš„<strong>æ¥å£æ–¹æ³•</strong>ï¼Œåœ¨ç”Ÿæˆçš„&nbsp;<strong>proxy</strong>ç±»ä¸­ï¼Œå®ç°è¿™äº›å®šä¹‰åœ¨æ¥å£ä¸­çš„æ–¹æ³•ï¼Œæ”¶æ‹¢ç»Ÿä¸€è°ƒç”¨&nbsp;<code>java.lang.reflect.InvocationHandler#invoke(proxy, method, args)</code>&nbsp;æ–¹æ³•ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå¯ä»¥è°ƒç”¨åˆ°æœ€ç»ˆçš„&nbsp;<code>Invoker#invoke(Invocation)</code>&nbsp;æ–¹æ³•ï¼Œå®ç° RPC è°ƒç”¨ã€‚</li>
<li>æ³¨æ„ï¼Œæ­¤å¤„æˆ‘ä»¬ä¸€ç›´ç”¨çš„&nbsp;<strong>proxy</strong>&nbsp;ä¸€ç›´æ˜¯å°å†™çš„ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿè¯·è§ä¸‹æ–‡å¤§å†™çš„&nbsp;<strong>Proxy</strong>&nbsp;ç±»ã€‚</li>
</ul>
</li>
<li>
<p>åœ¨ Provider ä¸­ï¼ŒXXXProtocol ä¼šè·å¾—è¢«è°ƒç”¨çš„ Exporter å¯¹è±¡ï¼Œä»è€Œè·å¾—åˆ° Invoker å¯¹è±¡ã€‚ä½†æ˜¯å‘¢ï¼ŒInvoker å¯¹è±¡å®é™…å’Œ Service å®ç°å¯¹è±¡ï¼Œæ˜¯æ— æ³•ç›´æ¥è°ƒç”¨ï¼Œéœ€è¦æœ‰ä¸­é—´çš„ä¸€å±‚ Wrapper æ¥<strong>ä»£ç†åˆ†å‘</strong>åˆ° Service å¯¹åº”çš„æ–¹æ³•ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç”Ÿæˆçš„ Wrapper ä»£ç çš„ç¤ºä¾‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">  <span class="number">1</span>: <span class="keyword">package</span> com.alibaba.dubbo.common.bytecode;</span><br /><span class="line">  <span class="number">2</span>: </span><br /><span class="line">  <span class="number">3</span>: <span class="keyword">import</span> com.alibaba.dubbo.demo.provider.DemoDAO;</span><br /><span class="line">  <span class="number">4</span>: <span class="keyword">import</span> com.alibaba.dubbo.demo.provider.DemoServiceImpl;</span><br /><span class="line">  <span class="number">5</span>: <span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br /><span class="line">  <span class="number">6</span>: <span class="keyword">import</span> java.util.Map;</span><br /><span class="line">  <span class="number">7</span>: </span><br /><span class="line">  <span class="number">8</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Wrapper1</span></span></span><br /><span class="line">  9:   extends Wrapper</span><br /><span class="line"> <span class="number">10</span>:   implements ClassGenerator.DC</span><br /><span class="line"> <span class="number">11</span>: {</span><br /><span class="line"> <span class="number">12</span>:   <span class="keyword">public</span> <span class="keyword">static</span> String[] pns;</span><br /><span class="line"> <span class="number">13</span>:   <span class="keyword">public</span> <span class="keyword">static</span> Map pts;</span><br /><span class="line"> <span class="number">14</span>:   <span class="keyword">public</span> <span class="keyword">static</span> String[] mns;</span><br /><span class="line"> <span class="number">15</span>:   <span class="keyword">public</span> <span class="keyword">static</span> String[] dmns;</span><br /><span class="line"> <span class="number">16</span>:   <span class="keyword">public</span> <span class="keyword">static</span> Class[] mts0;</span><br /><span class="line"> <span class="number">17</span>:   <span class="keyword">public</span> <span class="keyword">static</span> Class[] mts1;</span><br /><span class="line"> <span class="number">18</span>:   <span class="keyword">public</span> <span class="keyword">static</span> Class[] mts2;</span><br /><span class="line"> <span class="number">19</span>:   </span><br /><span class="line"> <span class="number">20</span>:   <span class="keyword">public</span> String[] getPropertyNames()</span><br /><span class="line"> <span class="number">21</span>:   {</span><br /><span class="line"> <span class="number">22</span>:     <span class="keyword">return</span> pns;</span><br /><span class="line"> <span class="number">23</span>:   }</span><br /><span class="line"> <span class="number">24</span>:   </span><br /><span class="line"> <span class="number">25</span>:   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasProperty</span><span class="params">(String paramString)</span></span></span><br /><span class="line"><span class="function"> 26:   </span>{</span><br /><span class="line"> <span class="number">27</span>:     <span class="keyword">return</span> pts.containsKey(paramString);</span><br /><span class="line"> <span class="number">28</span>:   }</span><br /><span class="line"> <span class="number">29</span>:   </span><br /><span class="line"> <span class="number">30</span>:   <span class="function"><span class="keyword">public</span> Class <span class="title">getPropertyType</span><span class="params">(String paramString)</span></span></span><br /><span class="line"><span class="function"> 31:   </span>{</span><br /><span class="line"> <span class="number">32</span>:     <span class="keyword">return</span> (Class)pts.get(paramString);</span><br /><span class="line"> <span class="number">33</span>:   }</span><br /><span class="line"> <span class="number">34</span>:   </span><br /><span class="line"> <span class="number">35</span>:   <span class="keyword">public</span> String[] getMethodNames()</span><br /><span class="line"> <span class="number">36</span>:   {</span><br /><span class="line"> <span class="number">37</span>:     <span class="keyword">return</span> mns;</span><br /><span class="line"> <span class="number">38</span>:   }</span><br /><span class="line"> <span class="number">39</span>:   </span><br /><span class="line"> <span class="number">40</span>:   <span class="keyword">public</span> String[] getDeclaredMethodNames()</span><br /><span class="line"> <span class="number">41</span>:   {</span><br /><span class="line"> <span class="number">42</span>:     <span class="keyword">return</span> dmns;</span><br /><span class="line"> <span class="number">43</span>:   }</span><br /><span class="line"> <span class="number">44</span>:   </span><br /><span class="line"> <span class="number">45</span>:   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPropertyValue</span><span class="params">(Object paramObject1, String paramString, Object paramObject2)</span></span></span><br /><span class="line"><span class="function"> 46:   </span>{</span><br /><span class="line"> <span class="number">47</span>:     DemoServiceImpl w;</span><br /><span class="line"> <span class="number">48</span>:     <span class="keyword">try</span></span><br /><span class="line"> <span class="number">49</span>:     {</span><br /><span class="line"> <span class="number">50</span>:       w = (DemoServiceImpl)paramObject1;</span><br /><span class="line"> <span class="number">51</span>:     }</span><br /><span class="line"> <span class="number">52</span>:     <span class="keyword">catch</span> (Throwable localThrowable)</span><br /><span class="line"> <span class="number">53</span>:     {</span><br /><span class="line"> <span class="number">54</span>:       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(localThrowable);</span><br /><span class="line"> <span class="number">55</span>:     }</span><br /><span class="line"> <span class="number">56</span>:     <span class="keyword">if</span> (paramString.equals(<span class="string">"test01"</span>))</span><br /><span class="line"> <span class="number">57</span>:     {</span><br /><span class="line"> <span class="number">58</span>:       w.test01 = ((String)paramObject2);</span><br /><span class="line"> <span class="number">59</span>:       <span class="keyword">return</span>;</span><br /><span class="line"> <span class="number">60</span>:     }</span><br /><span class="line"> <span class="number">61</span>:     <span class="keyword">if</span> (paramString.equals(<span class="string">"demoDAO"</span>))</span><br /><span class="line"> <span class="number">62</span>:     {</span><br /><span class="line"> <span class="number">63</span>:       localDemoServiceImpl.setDemoDAO((DemoDAO)paramObject2);</span><br /><span class="line"> <span class="number">64</span>:       <span class="keyword">return</span>;</span><br /><span class="line"> <span class="number">65</span>:     }</span><br /><span class="line"> <span class="number">66</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchPropertyException(<span class="string">"Not found property \""</span> + paramString + <span class="string">"\" filed or setter method in class com.alibaba.dubbo.demo.provider.DemoServiceImpl."</span>);</span><br /><span class="line"> <span class="number">67</span>:   }</span><br /><span class="line"> <span class="number">68</span>:   </span><br /><span class="line"> <span class="number">69</span>:   <span class="function"><span class="keyword">public</span> Object <span class="title">getPropertyValue</span><span class="params">(Object paramObject, String paramString)</span></span></span><br /><span class="line"><span class="function"> 70:   </span>{</span><br /><span class="line"> <span class="number">71</span>:     DemoServiceImpl w;</span><br /><span class="line"> <span class="number">72</span>:     <span class="keyword">try</span></span><br /><span class="line"> <span class="number">73</span>:     {</span><br /><span class="line"> <span class="number">74</span>:       w = (DemoServiceImpl)paramObject;</span><br /><span class="line"> <span class="number">75</span>:     }</span><br /><span class="line"> <span class="number">76</span>:     <span class="keyword">catch</span> (Throwable localThrowable)</span><br /><span class="line"> <span class="number">77</span>:     {</span><br /><span class="line"> <span class="number">78</span>:       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(localThrowable);</span><br /><span class="line"> <span class="number">79</span>:     }</span><br /><span class="line"> <span class="number">80</span>:     <span class="keyword">if</span> (paramString.equals(<span class="string">"test01"</span>)) {</span><br /><span class="line"> <span class="number">81</span>:       <span class="keyword">return</span> localDemoServiceImpl.test01;</span><br /><span class="line"> <span class="number">82</span>:     }</span><br /><span class="line"> <span class="number">83</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchPropertyException(<span class="string">"Not found property \""</span> + paramString + <span class="string">"\" filed or setter method in class com.alibaba.dubbo.demo.provider.DemoServiceImpl."</span>);</span><br /><span class="line"> <span class="number">84</span>:   }</span><br /><span class="line"> <span class="number">85</span>:   </span><br /><span class="line"> <span class="number">86</span>:   <span class="function"><span class="keyword">public</span> Object <span class="title">invokeMethod</span><span class="params">(Object paramObject, String paramString, Class[] paramArrayOfClass, Object[] paramArrayOfObject)</span></span></span><br /><span class="line"><span class="function"> 87:     <span class="keyword">throws</span> InvocationTargetException</span></span><br /><span class="line"><span class="function"> 88:   </span>{</span><br /><span class="line"> <span class="number">89</span>:     DemoServiceImpl w;</span><br /><span class="line"> <span class="number">90</span>:     <span class="keyword">try</span></span><br /><span class="line"> <span class="number">91</span>:     {</span><br /><span class="line"> <span class="number">92</span>:       w = (DemoServiceImpl)paramObject;</span><br /><span class="line"> <span class="number">93</span>:     }</span><br /><span class="line"> <span class="number">94</span>:     <span class="keyword">catch</span> (Throwable localThrowable1)</span><br /><span class="line"> <span class="number">95</span>:     {</span><br /><span class="line"> <span class="number">96</span>:       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(localThrowable1);</span><br /><span class="line"> <span class="number">97</span>:     }</span><br /><span class="line"> <span class="number">98</span>:     <span class="keyword">try</span></span><br /><span class="line"> <span class="number">99</span>:     {</span><br /><span class="line"><span class="number">100</span>:       <span class="keyword">if</span> (<span class="string">"sayHello"</span>.equals(paramString) &amp;&amp; paramArrayOfClass.length == <span class="number">1</span>) {</span><br /><span class="line"><span class="number">101</span>:         <span class="keyword">return</span> w.sayHello((String)paramArrayOfObject[<span class="number">0</span>]);</span><br /><span class="line"><span class="number">102</span>:       }</span><br /><span class="line"><span class="number">103</span>:       <span class="keyword">if</span> (<span class="string">"bye"</span>.equals(paramString) &amp;&amp; paramArrayOfClass.length == <span class="number">1</span>)</span><br /><span class="line"><span class="number">104</span>:       {</span><br /><span class="line"><span class="number">105</span>:         w.bye((Object)paramArrayOfObject[<span class="number">0</span>]);</span><br /><span class="line"><span class="number">106</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">107</span>:       }</span><br /><span class="line"><span class="number">108</span>:       <span class="keyword">if</span> (<span class="string">"setDemoDAO"</span>.equals(paramString) &amp;&amp; paramArrayOfClass.length == <span class="number">1</span>)</span><br /><span class="line"><span class="number">109</span>:       {</span><br /><span class="line"><span class="number">110</span>:         w.setDemoDAO((DemoDAO)paramArrayOfObject[<span class="number">0</span>]);</span><br /><span class="line"><span class="number">111</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">112</span>:       }</span><br /><span class="line"><span class="number">113</span>:     }</span><br /><span class="line"><span class="number">114</span>:     <span class="keyword">catch</span> (Throwable localThrowable2)</span><br /><span class="line"><span class="number">115</span>:     {</span><br /><span class="line"><span class="number">116</span>:       <span class="keyword">throw</span> <span class="keyword">new</span> InvocationTargetException(localThrowable2);</span><br /><span class="line"><span class="number">117</span>:     }</span><br /><span class="line"><span class="number">118</span>:     <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodException(<span class="string">"Not found method \""</span> + paramString + <span class="string">"\" in class com.alibaba.dubbo.demo.provider.DemoServiceImpl."</span>);</span><br /><span class="line"><span class="number">119</span>:   }</span><br /><span class="line"><span class="number">120</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è¯¥ç±»é€šè¿‡&nbsp;<code>dubbo-common</code>&nbsp;æ¨¡å—çš„&nbsp;<code>bytecode</code>&nbsp;æ¨¡å—çš„ Wrapper ç±»ï¼Œ<strong>è‡ªåŠ¨ç”Ÿæˆ</strong>ï¼Œä½¿ç”¨ Javassist æŠ€æœ¯ã€‚</li>
<li>ä¸åŒäºç”Ÿæˆçš„&nbsp;<strong>proxy</strong>ç±»ï¼Œä¸å®ç° Service æ¥å£ç±»ï¼Œè€Œæ˜¯åœ¨&nbsp;<code>#invokeMethod(paramObject, paramString, paramArrayOfClass, paramArrayOfObject)</code>&nbsp;æ–¹æ³•ï¼Œæä¾›ç»™&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;ä¸­è°ƒç”¨ï¼Œç»Ÿä¸€åˆ†å‘è¯·æ±‚åˆ° Service å¯¹åº”çš„æ–¹æ³•ã€‚ä»èŒèƒ½ä¸Šæ¥çœ‹ï¼Œæœ‰ä¸€ç‚¹åƒç¡¬ç¼–ç çš„ Controller ã€‚</li>
<li>ä¸€ä¸ªç”Ÿæˆçš„&nbsp;<strong>Wrapper</strong>ç±»ï¼Œåªå¯¹åº”ä¸€ä¸ª Service ï¼Œä»ç¬¬ 75 è¡Œçš„ä»£ç ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹å‡ºã€‚</li>
</ul>
</li>
</ul>
<h1 id="4-ProxyFactory">4. ProxyFactory</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/6de0a069fcc870894e64ffd54a24e334b19dcb36/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/ProxyFactory.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.rpc.ProxyFactory</code></a>&nbsp;ï¼Œä»£ç†å·¥å‚æ¥å£ã€‚</p>
<p>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/implementation-intro/">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æ ¸å¿ƒæµç¨‹ä¸€è§ˆã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/proxy-javassist/">ã€Œ4.5 ProxyFactoryã€</a>ï¼Œå·²ç»åˆ†äº«ï¼Œèƒ–å‹ç‚¹å‡»æŸ¥çœ‹ã€‚</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_03_01/13.png" alt="ProxyFactory å­ç±»" /></p>
<h2 id="4-1-AbstractProxyFactory">4.1 AbstractProxyFactory</h2>
<p><code>com.alibaba.dubbo.rpc.proxy.AbstractProxyFactory</code>&nbsp;ï¼Œå®ç° ProxyFactory æ¥å£ï¼Œä»£ç†å·¥å‚æŠ½è±¡ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractProxyFactory</span> <span class="keyword">implements</span> <span class="title">ProxyFactory</span> </span>{</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">4</span>:         Class&lt;?&gt;[] interfaces = <span class="keyword">null</span>;</span><br /><span class="line"> <span class="number">5</span>:         <span class="comment">// TODO 8022 èŠ‹è‰¿</span></span><br /><span class="line"> <span class="number">6</span>:         String config = invoker.getUrl().getParameter(<span class="string">"interfaces"</span>);</span><br /><span class="line"> <span class="number">7</span>:         <span class="keyword">if</span> (config != <span class="keyword">null</span> &amp;&amp; config.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">8</span>:             String[] types = Constants.COMMA_SPLIT_PATTERN.split(config);</span><br /><span class="line"> <span class="number">9</span>:             <span class="keyword">if</span> (types != <span class="keyword">null</span> &amp;&amp; types.length &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">10</span>:                 interfaces = <span class="keyword">new</span> Class&lt;?&gt;[types.length + <span class="number">2</span>];</span><br /><span class="line"><span class="number">11</span>:                 interfaces[<span class="number">0</span>] = invoker.getInterface();</span><br /><span class="line"><span class="number">12</span>:                 interfaces[<span class="number">1</span>] = EchoService.class;</span><br /><span class="line"><span class="number">13</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; types.length; i++) {</span><br /><span class="line"><span class="number">14</span>:                     interfaces[i + <span class="number">1</span>] = ReflectUtils.forName(types[i]);</span><br /><span class="line"><span class="number">15</span>:                 }</span><br /><span class="line"><span class="number">16</span>:             }</span><br /><span class="line"><span class="number">17</span>:         }</span><br /><span class="line"><span class="number">18</span>:         <span class="comment">// å¢åŠ  EchoService æ¥å£ï¼Œç”¨äºå›ç”Ÿæµ‹è¯•ã€‚å‚è§æ–‡æ¡£ã€Šå›å£°æµ‹è¯•ã€‹http://dubbo.apache.org/zh-cn/docs/user/demos/echo-service.html</span></span><br /><span class="line"><span class="number">19</span>:         <span class="keyword">if</span> (interfaces == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">20</span>:             interfaces = <span class="keyword">new</span> Class&lt;?&gt;[]{invoker.getInterface(), EchoService.class};</span><br /><span class="line"><span class="number">21</span>:         }</span><br /><span class="line"><span class="number">22</span>:         <span class="keyword">return</span> getProxy(invoker, interfaces);</span><br /><span class="line"><span class="number">23</span>:     }</span><br /><span class="line"><span class="number">24</span>: </span><br /><span class="line"><span class="number">25</span>:     <span class="keyword">public</span> <span class="keyword">abstract</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker, Class&lt;?&gt;[] types)</span></span>;</span><br /><span class="line"><span class="number">26</span>: </span><br /><span class="line"><span class="number">27</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¯¥æŠ½è±¡ç±»ï¼Œä¸»è¦æ˜¯å®ç°äº†&nbsp;<code>#getProxy(invoker)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—éœ€è¦ç”Ÿæˆä»£ç†çš„æ¥å£ä»¬ã€‚</p>
<ul>
<li>ç¬¬ 5 è‡³ 17 è¡Œï¼š TODO 8022 èŠ‹è‰¿</li>
<li>
<p>ç¬¬ 18 è‡³ 21 è¡Œï¼šåœ¨åŸæœ‰ Invoker å¯¹åº”<strong>å…³è”</strong>çš„ Service æ¥å£ä¹‹ä¸Šï¼Œå¢åŠ  EchoService æ¥å£ã€‚</p>
<blockquote>
<p>FROM&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/echo-service.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; å›å£°æµ‹è¯•ã€‹</a></p>
<p>å›å£°æµ‹è¯•ç”¨äºæ£€æµ‹æœåŠ¡æ˜¯å¦å¯ç”¨ï¼Œå›å£°æµ‹è¯•æŒ‰ç…§æ­£å¸¸è¯·æ±‚æµç¨‹æ‰§è¡Œï¼Œèƒ½å¤Ÿæµ‹è¯•æ•´ä¸ªè°ƒç”¨æ˜¯å¦é€šç•…ï¼Œå¯ç”¨äºç›‘æ§ã€‚<br />æ‰€æœ‰æœåŠ¡è‡ªåŠ¨å®ç° EchoService æ¥å£ï¼Œåªéœ€å°†ä»»æ„æœåŠ¡å¼•ç”¨å¼ºåˆ¶è½¬å‹ä¸º EchoServiceï¼Œå³å¯ä½¿ç”¨ã€‚</p>
</blockquote>
</li>
<li>
<p>ç¬¬ 22 è¡Œï¼šè°ƒç”¨&nbsp;<code>#getProxy(invoker, types)</code>&nbsp;<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè·å¾— Proxy å¯¹è±¡ã€‚</p>
</li>
</ul>
</li>
</ul>
<h2 id="4-2-StubProxyFactoryWrapper">4.2 StubProxyFactoryWrapper</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/afb312f7dce997f5f90ba686345f4354e786534d/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/proxy/wrapper/StubProxyFactoryWrapper.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.rpc.proxy.wrapper.StubProxyFactoryWrapper</code></a>&nbsp;ï¼Œå®ç° ProxyFactory æ¥å£ï¼ŒStub ä»£ç†å·¥å‚ Wrapper å®ç°ç±»ï¼ŒåŸºäº Dubbo SPI Wrapper æœºåˆ¶åŠ è½½ã€‚</p>
<p>ğŸ™‚ è¯¥ç±»ï¼Œä¸åœ¨æœ¬æ–‡çš„èŒƒç•´å†…ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹å¯ä»¥å…ˆçœ‹ä¸‹&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/local-stub.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; æœ¬åœ°å­˜æ ¹ã€‹</a>&nbsp;ã€‚åç»­ï¼Œæˆ‘ä»¬å•ç‹¬å¼€æ–‡ç« åˆ†äº«ã€‚</p>
<h2 id="4-3-JavassistProxyFactory">4.3 JavassistProxyFactory</h2>
<p><code>com.alibaba.dubbo.rpc.proxy.javassist.JavassistProxyFactory</code>&nbsp;ï¼Œå®ç° AbstractProxyFactory æŠ½è±¡ç±»ï¼ŒåŸºäº Javassist ä»£ç†å·¥å‚å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavassistProxyFactory</span> <span class="keyword">extends</span> <span class="title">AbstractProxyFactory</span> </span>{</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>:     <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker, Class&lt;?&gt;[] interfaces)</span> </span>{</span><br /><span class="line"> <span class="number">5</span>:         <span class="keyword">return</span> (T) Proxy.getProxy(interfaces).newInstance(<span class="keyword">new</span> InvokerInvocationHandler(invoker));</span><br /><span class="line"> <span class="number">6</span>:     }</span><br /><span class="line"> <span class="number">7</span>: </span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">getInvoker</span><span class="params">(T proxy, Class&lt;T&gt; type, URL url)</span> </span>{</span><br /><span class="line"> <span class="number">9</span>:         <span class="comment">// TODO Wrapper cannot handle this scenario correctly: the classname contains '$'</span></span><br /><span class="line"><span class="number">10</span>:         <span class="comment">// TODO Wrapperç±»ä¸èƒ½æ­£ç¡®å¤„ç†å¸¦$çš„ç±»å</span></span><br /><span class="line"><span class="number">11</span>:         <span class="keyword">final</span> Wrapper wrapper = Wrapper.getWrapper(proxy.getClass().getName().indexOf(<span class="string">'$'</span>) &lt; <span class="number">0</span> ? proxy.getClass() : type);</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">return</span> <span class="keyword">new</span> AbstractProxyInvoker&lt;T&gt;(proxy, type, url) {</span><br /><span class="line"><span class="number">13</span>:             <span class="meta">@Override</span></span><br /><span class="line"><span class="number">14</span>:             <span class="function"><span class="keyword">protected</span> Object <span class="title">doInvoke</span><span class="params">(T proxy, String methodName,</span></span></span><br /><span class="line"><span class="function"><span class="params"><span class="number">15</span>:                                       Class&lt;?&gt;[] parameterTypes,</span></span></span><br /><span class="line"><span class="function"><span class="params"><span class="number">16</span>:                                       Object[] arguments)</span> <span class="keyword">throws</span> Throwable </span>{</span><br /><span class="line"><span class="number">17</span>:                 <span class="keyword">return</span> wrapper.invokeMethod(proxy, methodName, parameterTypes, arguments);</span><br /><span class="line"><span class="number">18</span>:             }</span><br /><span class="line"><span class="number">19</span>:         };</span><br /><span class="line"><span class="number">20</span>:     }</span><br /><span class="line"><span class="number">21</span>: </span><br /><span class="line"><span class="number">22</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>#getProxy(invoker, interfaces)</code>&nbsp;æ–¹æ³•
<ul>
<li>ç¬¬ 5 è¡Œï¼šè°ƒç”¨&nbsp;<code>Proxy#getProxy(interface)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—&nbsp;<strong>Proxy</strong>&nbsp;å¯¹è±¡ã€‚</li>
<li>ç¬¬ 5 è¡Œï¼šè°ƒç”¨&nbsp;<code>Proxy#newInstance(InvocationHandler)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—&nbsp;<strong>proxy</strong>&nbsp;å¯¹è±¡ã€‚å…¶ä¸­ä¼ å…¥çš„å‚æ•°æ˜¯ InvokerInvocationHandler ç±»ï¼Œé€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œè®© proxy å’ŒçœŸæ­£çš„é€»è¾‘ä»£ç è§£è€¦ã€‚
<ul>
<li>Proxy å’Œ proxy ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/proxy-javassist/">ã€Œ7.3 Proxyã€</a>&nbsp;ä¸­ï¼Œè¯¦ç»†è§£æã€‚</li>
<li>InvokerInvocationHandler ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/proxy-javassist/">ã€Œ5. InvokerInvocationHandlerã€</a>&nbsp;ä¸­ï¼Œè¯¦ç»†è§£æã€‚</li>
</ul>
</li>
</ul>
</li>
<li><code>#getInvoker(proxy, type, url)</code>&nbsp;æ–¹æ³•
<ul>
<li>ç¬¬ 11 è¡Œï¼šè°ƒç”¨&nbsp;<code>Wrapper#getWrapper(Class&lt;?&gt;)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—&nbsp;<strong>Wrapper</strong>&nbsp;å¯¹è±¡ã€‚
<ul>
<li>Wrapper ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/proxy-javassist/">ã€Œ7.4 Wrapperã€</a>&nbsp;ä¸­ï¼Œè¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>ç¬¬ 12 è‡³ 19 è¡Œï¼šåˆ›å»º AbstractProxyInvoker å¯¹è±¡ï¼Œå®ç°&nbsp;<code>#doInvoke(...)</code>&nbsp;æ–¹æ³•ã€‚åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œè°ƒç”¨&nbsp;<code>Wrapper#invokeMethod(...)</code>&nbsp;æ–¹æ³•ï¼Œä»è€Œè°ƒç”¨ Service çš„æ–¹æ³•ã€‚
<ul>
<li>AbstractProxyInvoker ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/proxy-javassist/">ã€Œ6. AbstractProxyInvokerã€</a>&nbsp;ä¸­ï¼Œè¯¦ç»†è§£æã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="5-InvokerInvocationHandler">5. InvokerInvocationHandler</h1>
<p><code>com.alibaba.dubbo.rpc.proxy.InvokerInvocationHandler</code>&nbsp;ï¼Œå®ç°&nbsp;<a href="https://docs.oracle.com/javase/7/docs/api/java/lang/reflect/InvocationHandler.html" target="_blank" rel="external nofollow noopener noreferrer"><code>java.lang.reflect.InvocationHandler</code></a>&nbsp;æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>{</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 4:      * Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> 5:      */</span></span><br /><span class="line"> <span class="number">6</span>:     <span class="keyword">private</span> <span class="keyword">final</span> Invoker&lt;?&gt; invoker;</span><br /><span class="line"> <span class="number">7</span>: </span><br /><span class="line"> <span class="number">8</span>:     <span class="function"><span class="keyword">public</span> <span class="title">InvokerInvocationHandler</span><span class="params">(Invoker&lt;?&gt; handler)</span> </span>{</span><br /><span class="line"> <span class="number">9</span>:         <span class="keyword">this</span>.invoker = handler;</span><br /><span class="line"><span class="number">10</span>:     }</span><br /><span class="line"><span class="number">11</span>: </span><br /><span class="line"><span class="number">12</span>:     <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>{</span><br /><span class="line"><span class="number">13</span>:         String methodName = method.getName();</span><br /><span class="line"><span class="number">14</span>:         Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</span><br /><span class="line"><span class="number">15</span>:         <span class="comment">// wait ç­‰æ–¹æ³•ï¼Œç›´æ¥åå°„è°ƒç”¨</span></span><br /><span class="line"><span class="number">16</span>:         <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) {</span><br /><span class="line"><span class="number">17</span>:             <span class="keyword">return</span> method.invoke(invoker, args);</span><br /><span class="line"><span class="number">18</span>:         }</span><br /><span class="line"><span class="number">19</span>:         <span class="comment">// åŸºç¡€æ–¹æ³•ï¼Œä¸ä½¿ç”¨ RPC è°ƒç”¨</span></span><br /><span class="line"><span class="number">20</span>:         <span class="keyword">if</span> (<span class="string">"toString"</span>.equals(methodName) &amp;&amp; parameterTypes.length == <span class="number">0</span>) {</span><br /><span class="line"><span class="number">21</span>:             <span class="keyword">return</span> invoker.toString();</span><br /><span class="line"><span class="number">22</span>:         }</span><br /><span class="line"><span class="number">23</span>:         <span class="keyword">if</span> (<span class="string">"hashCode"</span>.equals(methodName) &amp;&amp; parameterTypes.length == <span class="number">0</span>) {</span><br /><span class="line"><span class="number">24</span>:             <span class="keyword">return</span> invoker.hashCode();</span><br /><span class="line"><span class="number">25</span>:         }</span><br /><span class="line"><span class="number">26</span>:         <span class="keyword">if</span> (<span class="string">"equals"</span>.equals(methodName) &amp;&amp; parameterTypes.length == <span class="number">1</span>) {</span><br /><span class="line"><span class="number">27</span>:             <span class="keyword">return</span> invoker.equals(args[<span class="number">0</span>]);</span><br /><span class="line"><span class="number">28</span>:         }</span><br /><span class="line"><span class="number">29</span>:         <span class="comment">// RPC è°ƒç”¨</span></span><br /><span class="line"><span class="number">30</span>:         <span class="keyword">return</span> invoker.invoke(<span class="keyword">new</span> RpcInvocation(method, args)).recreate();</span><br /><span class="line"><span class="number">31</span>:     }</span><br /><span class="line"><span class="number">32</span>: </span><br /><span class="line"><span class="number">33</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>invoker</code>&nbsp;å±æ€§ï¼ŒInvoker å¯¹è±¡ï¼Œç”¨äºåœ¨&nbsp;<code>#invoke()</code>&nbsp;æ–¹æ³•è°ƒç”¨ã€‚</li>
<li>
<p><code>#invoke(proxy, method, args)</code>&nbsp;<strong>å®ç°</strong>æ–¹æ³•ï¼Œæ ¸å¿ƒé€»è¾‘æ˜¯è°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼Œè¿›è¡Œ RPC è°ƒç”¨ã€‚</p>
<ul>
<li>ç¬¬ 16 è‡³ 18 è¡Œï¼šå¤„ç†&nbsp;<code>#wait()</code>&nbsp;<code>#notify()</code>&nbsp;ç­‰æ–¹æ³•ï¼Œè¿›è¡Œåå°„è°ƒç”¨ã€‚</li>
<li>ç¬¬ 20 è‡³ 28 è¡Œï¼šå¤„ç†&nbsp;<code>#toString()</code>&nbsp;<code>#hashCode()</code>&nbsp;ç­‰æ–¹æ³•ï¼Œä½¿ç”¨ Invoker å¯¹è±¡çš„æ–¹æ³•ï¼Œä¸è¿›è¡Œ RPC è°ƒç”¨ã€‚</li>
<li>ç¬¬ 30 è¡Œï¼šè°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼Œ<strong>æ ¸å¿ƒé€»è¾‘</strong>ï¼Œè¿›è¡Œ RPC è°ƒç”¨ã€‚</li>
<li>
<p>ç¬¬ 30 è¡Œï¼šè°ƒç”¨&nbsp;<code>Result#recreate()</code>&nbsp;æ–¹æ³•ï¼Œå›æ”¾è°ƒç”¨ç»“æœã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// RpcResult.java</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">recreate</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>{</span><br /><span class="line">    <span class="comment">// æœ‰å¼‚å¸¸ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br /><span class="line">    <span class="keyword">if</span> (exception != <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> exception;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// æ— å¼‚å¸¸ï¼Œè¿”å›ç»“æœ</span></span><br /><span class="line">    <span class="keyword">return</span> result;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>x</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>ğŸ™‚ é€šè¿‡ InvokerInvocationHandler ï¼Œå¯ä»¥å®ç° Proxy å’ŒçœŸæ­£çš„é€»è¾‘è§£è€¦ã€‚</p>
<h1 id="6-AbstractProxyInvoker">6. AbstractProxyInvoker</h1>
<p><code>com.alibaba.dubbo.rpc.proxy.AbstractProxyInvoker</code>&nbsp;ï¼Œå®ç° Invoker æ¥å£ï¼Œ<strong>ä»£ç†</strong>&nbsp;Invoker å¯¹è±¡çš„æŠ½è±¡ç±»ã€‚</p>
<h2 id="6-1-å±æ€§">6.1 å±æ€§</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ä»£ç†çš„å¯¹è±¡ï¼Œä¸€èˆ¬æ˜¯ Service å®ç°å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> T proxy;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ¥å£ç±»å‹ï¼Œä¸€èˆ¬æ˜¯ Service æ¥å£</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Class&lt;T&gt; type;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * URL å¯¹è±¡ï¼Œä¸€èˆ¬æ˜¯æš´éœ²æœåŠ¡çš„ URL å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AbstractProxyInvoker</span><span class="params">(T proxy, Class&lt;T&gt; type, URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (proxy == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"proxy == null"</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">if</span> (type == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"interface == null"</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">if</span> (!type.isInstance(proxy)) { <span class="comment">//</span></span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(proxy.getClass().getName() + <span class="string">" not implement interface "</span> + type);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">this</span>.proxy = proxy;</span><br /><span class="line">    <span class="keyword">this</span>.type = type;</span><br /><span class="line">    <span class="keyword">this</span>.url = url;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>ğŸ™‚ èƒ–å‹ï¼Œè¯·çœ‹ä»£ç ä¸Šçš„æ³¨é‡Šã€‚</p>
<h2 id="6-2-invoke">6.2 invoke</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="number">1</span>: <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"><span class="number">2</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">3</span>:         <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(doInvoke(proxy, invocation.getMethodName(), invocation.getParameterTypes(), invocation.getArguments()));</span><br /><span class="line"><span class="number">4</span>:     } <span class="keyword">catch</span> (InvocationTargetException e) {</span><br /><span class="line"><span class="number">5</span>:         <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(e.getTargetException());</span><br /><span class="line"><span class="number">6</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">7</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Failed to invoke remote proxy method "</span> + invocation.getMethodName() + <span class="string">" to "</span> + getUrl() + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br /><span class="line"><span class="number">8</span>:     }</span><br /><span class="line"><span class="number">9</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ç¬¬ 3 è¡Œï¼šè°ƒç”¨&nbsp;<code>#doInvoke(..)</code>&nbsp;<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œæ‰§è¡Œè°ƒç”¨ï¼Œè¿”å›è°ƒç”¨ç»“æœã€‚<code>#doInvoke(...)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ‰§è¡Œè°ƒç”¨</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> proxy ä»£ç†çš„å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> methodName æ–¹æ³•å</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> parameterTypes æ–¹æ³•å‚æ•°ç±»å‹æ•°ç»„</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> arguments æ–¹æ³•å‚æ•°æ•°ç»„</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> è°ƒç”¨ç»“æœ</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Throwable å‘ç”Ÿå¼‚å¸¸</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Object <span class="title">doInvoke</span><span class="params">(T proxy, String methodName, Class&lt;?&gt;[] parameterTypes, Object[] arguments)</span> <span class="keyword">throws</span> Throwable</span>;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 3 è¡Œï¼šåˆ›å»º RpcResult å¯¹è±¡ï¼Œå°†ç»“æœåŒ…è£…è¿”å›ã€‚</p>
</li>
<li>ç¬¬ 5 è¡Œï¼šå‘ç”Ÿ InvocationTargetException å¼‚å¸¸ï¼Œåˆ›å»º RpcResult å¯¹è±¡åŒ…è£…ã€‚
<ul>
<li><a href="https://blog.csdn.net/zhangzeyuaaa/article/details/39611467" target="_blank" rel="external nofollow noopener noreferrer">ã€Š Javaåå°„å¼‚å¸¸å¤„ç†ä¹‹InvocationTargetExceptionã€‹</a></li>
</ul>
</li>
</ul>
<h1 id="7-bytecode">7. bytecode</h1>
<p>åœ¨&nbsp;<code>dubbo-common</code>&nbsp;æ¨¡å—çš„&nbsp;<code>bytecode</code>&nbsp;åŒ…ï¼ŒåŸºäº Javassit åº“ï¼Œ<strong>åŠ¨æ€ç¼–è¯‘</strong>ï¼Œå®ç°æä¾›äº†<strong>é€šç”¨çš„</strong>çš„åŠ¨æ€ä»£ç†å®ç°ã€‚æ‰€ä»¥æœ¬å°èŠ‚ï¼Œä»<strong>åŠ¨æ€ç¼–è¯‘</strong>çš„è§’åº¦ä¸Šæ¥çœ‹ï¼Œåœ¨å†…å®¹ä¸Šï¼Œå’Œ&nbsp;<a href="http://svip.iocoder.cn/Dubbo/compiler-javassist/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; åŠ¨æ€ç¼–è¯‘ï¼ˆä¸€ï¼‰ä¹‹ Javassistã€‹</a>&nbsp;æœ‰ä¸€å®šçš„ç›¸ä¼¼ã€‚</p>
<h2 id="7-1-ClassGenerator">7.1 ClassGenerator</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/b5a5adcd965393b374a4f58ecea90264251c3cdb/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/ClassGenerator.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.common.bytecode.ClassGenerator</code></a>&nbsp;ï¼Œç±»ç”Ÿæˆå™¨ï¼ŒåŸºäº&nbsp;<strong>Javassist</strong>&nbsp;å®ç°ã€‚</p>
<p>ç¬”è€…åœ¨&nbsp;<a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/?self" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠTCC-Transaction æºç åˆ†æ &mdash;&mdash; Dubbo æ”¯æŒã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/proxy-javassist/">ã€Œ2.1.3 TccProxy &amp; TccClassGeneratorã€</a>å·²ç»è¯¦ç»†åˆ†äº«ï¼ŒåŸºæœ¬ç±»ä¼¼ï¼Œèƒ–å‹ç…ç…å™¢ã€‚</p>
<h2 id="7-3-Proxy">7.3 Proxy</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/b5a5adcd965393b374a4f58ecea90264251c3cdb/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/Proxy.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.common.bytecode.Proxy</code></a>&nbsp;ï¼Œä»£ç†æŠ½è±¡ç±»ï¼Œç”¨äºåˆ›å»º Proxy å’Œ proxy å¯¹è±¡ã€‚</p>
<p>ç¬”è€…åœ¨&nbsp;<a href="http://www.iocoder.cn/TCC-Transaction/dubbo-support/?self" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠTCC-Transaction æºç åˆ†æ &mdash;&mdash; Dubbo æ”¯æŒã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/proxy-javassist/">ã€Œ2.1.3 TccProxy &amp; TccClassGeneratorã€</a>å·²ç»è¯¦ç»†åˆ†äº«ï¼ŒåŸºæœ¬ç±»ä¼¼ï¼Œèƒ–å‹ç…ç…å™¢ã€‚</p>
<hr />
<p>å¦‚ä¸‹æ˜¯ä¸€ä¸ªç”Ÿæˆçš„&nbsp;<strong>Proxy</strong>&nbsp;ä»£ç çš„ç¤ºä¾‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Proxy0</span> <span class="keyword">extends</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">ClassGenerator</span>.<span class="title">DC</span> </span>{</span><br />    <br /><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">newInstance</span><span class="params">(InvocationHandler paramInvocationHandler)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> proxy0(paramInvocationHandler);</span><br /><span class="line">    }</span><br />    <br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><strong>ç”Ÿæˆçš„Proxy</strong>&nbsp;å®ç° Proxy æŠ½è±¡ç±»ï¼Œæ˜¯åˆ›å»º&nbsp;<strong>ç”Ÿæˆçš„proxy</strong>&nbsp;çš„å·¥å‚ï¼ˆä¸€ä¸€å¯¹åº”ï¼‰ã€‚ä¾‹å¦‚ï¼ŒProxy0 åˆ›å»º proxy0 å¯¹è±¡ã€‚</li>
<li><code>#newInstance(InvocationHandler)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º&nbsp;<strong>ç”Ÿæˆçš„proxy</strong>&nbsp;çš„æ–¹æ³•ã€‚</li>
</ul>
<h2 id="7-4-Wrapper">7.4 Wrapper</h2>
<p><a href="http://svip.iocoder.cn/Dubbo/proxy-javassist/TODO"><code>com.alibaba.dubbo.common.bytecode.Wrapper</code></a>&nbsp;ï¼ŒWrapper æŠ½è±¡ç±»ï¼Œç”¨äº<strong>åˆ›å»ºæŸä¸ªå¯¹è±¡çš„æ–¹æ³•è°ƒç”¨</strong>çš„åŒ…è£…å™¨ï¼Œä»¥é¿å…<strong>åå°„</strong>è°ƒç”¨ï¼Œæé«˜æ€§èƒ½ã€‚å³ï¼š</p>
<figure class="highlight">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// åå°„</span></span><br /><span class="line">Method#invoke(Object instance, Object[] args)</span><br /><br /><span class="line"><span class="comment">// ä¼˜åŒ–æˆ===&gt;</span></span><br /><br /><span class="line"><span class="comment">// Wrapper</span></span><br /><span class="line">Wrapper#invokeMethod(Object instance, String mn, Class&lt;?&gt;[] types, Object[] args)</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä¸ºä»€ä¹ˆä¼šæé«˜æ€§èƒ½å‘¢ï¼Ÿçœ‹åˆ°ä¸Šæ–‡çš„ Wrapper ä»£ç†çš„ç¤ºä¾‹ï¼Œç›¸ä¿¡èƒ–å‹å·²ç»æ˜ç™½ã€‚</li>
</ul>
<h3 id="7-4-1-æŠ½è±¡æ–¹æ³•">7.4.1 æŠ½è±¡æ–¹æ³•</h3>
<p>åœ¨è‡ªåŠ¨ç”Ÿæˆ Wrapper ç±»æ—¶ï¼Œéœ€è¦å®ç°å¦‚ä¸‹<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> String[] getPropertyNames();</span><br /><span class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> Class&lt;?&gt; getPropertyType(String pn);</span><br /><br /><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasProperty</span><span class="params">(String name)</span></span>;</span><br /><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> Object <span class="title">getPropertyValue</span><span class="params">(Object instance, String pn)</span> <span class="keyword">throws</span> NoSuchPropertyException, IllegalArgumentException</span>;</span><br /><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPropertyValue</span><span class="params">(Object instance, String pn, Object pv)</span> <span class="keyword">throws</span> NoSuchPropertyException, IllegalArgumentException</span>;</span><br /><br /><span class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> String[] getMethodNames();</span><br /><span class="line"><span class="keyword">abstract</span> <span class="keyword">public</span> String[] getDeclaredMethodNames();</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * invoke method.</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * è°ƒç”¨æ–¹æ³•</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> instance instance.</span></span><br /><span class="line"><span class="comment"> *                 è¢«è°ƒç”¨çš„å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> mn       method name.</span></span><br /><span class="line"><span class="comment"> *                 æ–¹æ³•å</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> types å‚æ•°ç±»å‹æ•°ç»„</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> args     argument array.</span></span><br /><span class="line"><span class="comment"> *                 å‚æ•°æ•°ç»„</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> return value.</span></span><br /><span class="line"><span class="comment"> *                  è¿”å›å€¼</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">abstract</span> <span class="keyword">public</span> Object <span class="title">invokeMethod</span><span class="params">(Object instance, String mn, Class&lt;?&gt;[] types, Object[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException</span>;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="7-4-2-getWrapper">7.4.2 getWrapper</h3>
<p><code>#getWrapper(c)</code>&nbsp;æ–¹æ³•ï¼Œæ ¹æ®æŒ‡å®šç±»ï¼Œè·å¾— Wrapper å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Wrapper <span class="title">getWrapper</span><span class="params">(Class&lt;?&gt; c)</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// åˆ¤æ–­æ˜¯å¦ç»§æ‰¿ ClassGenerator.DC.class ï¼Œå¦‚æœæ˜¯ï¼Œæ‹¿åˆ°çˆ¶ç±»ï¼Œé¿å…é‡å¤åŒ…è£…</span></span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">while</span> (ClassGenerator.isDynamicClass(c)) <span class="comment">// can not wrapper on dynamic class.</span></span><br /><span class="line"> <span class="number">4</span>:         c = c.getSuperclass();</span><br /><span class="line"> <span class="number">5</span>: </span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// æŒ‡å®šç±»ä¸º Object.class</span></span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (c == Object.class)</span><br /><span class="line"> <span class="number">8</span>:         <span class="keyword">return</span> OBJECT_WRAPPER;</span><br /><span class="line"> <span class="number">9</span>: </span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// ä»ç¼“å­˜ä¸­è·å¾— Wrapper å¯¹è±¡</span></span><br /><span class="line"><span class="number">11</span>:     Wrapper ret = WRAPPER_MAP.get(c);</span><br /><span class="line"><span class="number">12</span>:     <span class="comment">// åˆ›å»º Wrapper å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°ç¼“å­˜</span></span><br /><span class="line"><span class="number">13</span>:     <span class="keyword">if</span> (ret == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">14</span>:         ret = makeWrapper(c);</span><br /><span class="line"><span class="number">15</span>:         WRAPPER_MAP.put(c, ret);</span><br /><span class="line"><span class="number">16</span>:     }</span><br /><span class="line"><span class="number">17</span>:     <span class="keyword">return</span> ret;</span><br /><span class="line"><span class="number">18</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è‡³ 4 è¡Œï¼šåˆ¤æ–­æ˜¯å¦å·²ç»ç»§æ‰¿äº†&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/91b4862d4aed0f984015b132c3cb426f9c3b0c76/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/ClassGenerator.java#L382-L386" target="_blank" rel="external nofollow noopener noreferrer">ClassGenerator.DC.class</a>&nbsp;ï¼Œå¦‚æœæ˜¯ï¼Œæ‹¿åˆ°çˆ¶ç±»ï¼Œé¿å…<strong>é‡å¤åŒ…è£…</strong>ã€‚</li>
<li>ç¬¬ 7 è‡³ 8 è¡Œï¼šè‹¥æŒ‡å®šç±»ä¸º Object.class ï¼Œè¿”å›&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/91b4862d4aed0f984015b132c3cb426f9c3b0c76/dubbo-common/src/main/java/com/alibaba/dubbo/common/bytecode/Wrapper.java#L43-L95" target="_blank" rel="external nofollow noopener noreferrer">OBJECT_WRAPPER</a>&nbsp;å¯¹è±¡ã€‚</li>
<li>
<p>ç¬¬ 11 è¡Œï¼šä»ç¼“å­˜&nbsp;<code>WRAPPER_MAP</code>&nbsp;ä¸­ï¼Œè·å¾— Wrapper å¯¹è±¡ã€‚<code>WRAPPER_MAP</code>&nbsp;ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Wrapper å¯¹è±¡ç¼“å­˜</span></span><br /><span class="line"><span class="comment"> * key ï¼šWrapper ç±»ã€‚</span></span><br /><span class="line"><span class="comment"> * value ï¼šProxy å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Wrapper&gt; WRAPPER_MAP = <span class="keyword">new</span> ConcurrentHashMap&lt;Class&lt;?&gt;, Wrapper&gt;(); <span class="comment">//class wrapper map</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 13 è‡³ 16 è¡Œï¼šè°ƒç”¨&nbsp;<code>#makeWrapper(Class&lt;?&gt;)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º Wrapper å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°ç¼“å­˜ã€‚</p>
</li>
</ul>
<h3 id="7-4-3-makeWrapper">7.4.3 makeWrapper</h3>
<p><code>#makeWrapper(Class&lt;?&gt;)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º Wrapper å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>æ—ç™½å›ï¼šå®ç°ä¸Šï¼Œå’Œ Proxy å·®ä¸è¿‡çš„ï¼Œåªç”Ÿæˆ<strong>ä¸€ä¸ª</strong>&nbsp;Wrapper ç±»ã€‚</p>
</blockquote>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Wrapper <span class="title">makeWrapper</span><span class="params">(Class&lt;?&gt; c)</span> </span>{</span><br /><span class="line">  <span class="number">2</span>:     <span class="comment">// éç§æœ‰ç±»</span></span><br /><span class="line">  <span class="number">3</span>:     <span class="keyword">if</span> (c.isPrimitive())</span><br /><span class="line">  <span class="number">4</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Can not create wrapper for primitive type: "</span> + c);</span><br /><span class="line">  <span class="number">5</span>: </span><br /><span class="line">  <span class="number">6</span>:     <span class="comment">// ç±»å</span></span><br /><span class="line">  <span class="number">7</span>:     String name = c.getName();</span><br /><span class="line">  <span class="number">8</span>:     <span class="comment">// ç±»åŠ è½½å™¨</span></span><br /><span class="line">  <span class="number">9</span>:     ClassLoader cl = ClassHelper.getClassLoader(c);</span><br /><span class="line"> <span class="number">10</span>: </span><br /><span class="line"> <span class="number">11</span>:     <span class="comment">// è®¾ç½®å±æ€§æ–¹æ³• `#setPropertyValue(o, n, v)` çš„å¼€å¤´çš„ä»£ç </span></span><br /><span class="line"> <span class="number">12</span>:     StringBuilder c1 = <span class="keyword">new</span> StringBuilder(<span class="string">"public void setPropertyValue(Object o, String n, Object v){ "</span>);</span><br /><span class="line"> <span class="number">13</span>:     <span class="comment">// è·å¾—å±æ€§æ–¹æ³• `#getPropertyValue(o, n)` çš„å¼€å¤´çš„ä»£ç </span></span><br /><span class="line"> <span class="number">14</span>:     StringBuilder c2 = <span class="keyword">new</span> StringBuilder(<span class="string">"public Object getPropertyValue(Object o, String n){ "</span>);</span><br /><span class="line"> <span class="number">15</span>:     <span class="comment">// è°ƒç”¨æ–¹æ³• `#invokeMethod(o, n, p, v)` çš„å¼€å¤´çš„ä»£ç </span></span><br /><span class="line"> <span class="number">16</span>:     StringBuilder c3 = <span class="keyword">new</span> StringBuilder(<span class="string">"public Object invokeMethod(Object o, String n, Class[] p, Object[] v) throws "</span> + InvocationTargetException.class.getName() + <span class="string">"{ "</span>);</span><br /><span class="line"> <span class="number">17</span>: </span><br /><span class="line"> <span class="number">18</span>:     <span class="comment">// æ·»åŠ æ¯ä¸ªæ–¹æ³•çš„ï¼Œè¢«è°ƒç”¨å¯¹è±¡çš„ç±»å‹è½¬æ¢çš„ä»£ç </span></span><br /><span class="line"> <span class="number">19</span>:     c1.append(name).append(<span class="string">" w; try{ w = (("</span>).append(name).append(<span class="string">")$1); }catch(Throwable e){ throw new IllegalArgumentException(e); }"</span>);</span><br /><span class="line"> <span class="number">20</span>:     c2.append(name).append(<span class="string">" w; try{ w = (("</span>).append(name).append(<span class="string">")$1); }catch(Throwable e){ throw new IllegalArgumentException(e); }"</span>);</span><br /><span class="line"> <span class="number">21</span>:     c3.append(name).append(<span class="string">" w; try{ w = (("</span>).append(name).append(<span class="string">")$1); }catch(Throwable e){ throw new IllegalArgumentException(e); }"</span>);</span><br /><span class="line"> <span class="number">22</span>: </span><br /><span class="line"> <span class="number">23</span>:     <span class="comment">// å±æ€§åä¸å±æ€§åçš„é›†åˆï¼Œç”¨äº `#hasProperty(...)` `#setPropertyValue(...)` `getPropertyValue(...)` æ–¹æ³•ã€‚</span></span><br /><span class="line"> <span class="number">24</span>:     Map&lt;String, Class&lt;?&gt;&gt; pts = <span class="keyword">new</span> HashMap&lt;String, Class&lt;?&gt;&gt;(); <span class="comment">// &lt;property name, property types&gt;</span></span><br /><span class="line"> <span class="number">25</span>:     <span class="comment">// æ–¹æ³•ç­¾åä¸æ–¹æ³•å¯¹è±¡çš„é›†åˆï¼Œç”¨äº `#invokeMethod(..)` æ–¹æ³•ã€‚</span></span><br /><span class="line"> <span class="number">26</span>:     Map&lt;String, Method&gt; ms = <span class="keyword">new</span> LinkedHashMap&lt;String, Method&gt;(); <span class="comment">// &lt;method desc, Method instance&gt;</span></span><br /><span class="line"> <span class="number">27</span>:     <span class="comment">// æ–¹æ³•åæ•°ç»„ç”¨äº `#getMethodNames()` æ–¹æ³•ã€‚</span></span><br /><span class="line"> <span class="number">28</span>:     List&lt;String&gt; mns = <span class="keyword">new</span> ArrayList&lt;String&gt;(); <span class="comment">// method names.</span></span><br /><span class="line"> <span class="number">29</span>:     <span class="comment">// å®šä¹‰çš„æ–¹æ³•åæ•°ç»„ï¼Œç”¨äº `#getDeclaredMethodNames()` æ–¹æ³•ã€‚</span></span><br /><span class="line"> <span class="number">30</span>:     List&lt;String&gt; dmns = <span class="keyword">new</span> ArrayList&lt;String&gt;(); <span class="comment">// declaring method names.</span></span><br /><span class="line"> <span class="number">31</span>: </span><br /><span class="line"> <span class="number">32</span>:     <span class="comment">// å¾ªç¯ public å±æ€§ï¼Œæ·»åŠ æ¯ä¸ªå±æ€§çš„è®¾ç½®å’Œè·å¾—åˆ†åˆ«åˆ° `#setPropertyValue(o, n, v)` å’Œ `#getPropertyValue(o, n)` çš„ä»£ç </span></span><br /><span class="line"> <span class="number">33</span>:     <span class="comment">// get all public field.</span></span><br /><span class="line"> <span class="number">34</span>:     <span class="keyword">for</span> (Field f : c.getFields()) {</span><br /><span class="line"> <span class="number">35</span>:         String fn = f.getName();</span><br /><span class="line"> <span class="number">36</span>:         Class&lt;?&gt; ft = f.getType();</span><br /><span class="line"> <span class="number">37</span>:         <span class="keyword">if</span> (Modifier.isStatic(f.getModifiers()) || Modifier.isTransient(f.getModifiers())) <span class="comment">// æ’é™¤ static å’Œ transient</span></span><br /><span class="line"> <span class="number">38</span>:             <span class="keyword">continue</span>;</span><br /><span class="line"> <span class="number">39</span>: </span><br /><span class="line"> <span class="number">40</span>:         c1.append(<span class="string">" if( $2.equals(\""</span>).append(fn).append(<span class="string">"\") ){ w."</span>).append(fn).append(<span class="string">"="</span>).append(arg(ft, <span class="string">"$3"</span>)).append(<span class="string">"; return; }"</span>);</span><br /><span class="line"> <span class="number">41</span>:         c2.append(<span class="string">" if( $2.equals(\""</span>).append(fn).append(<span class="string">"\") ){ return ($w)w."</span>).append(fn).append(<span class="string">"; }"</span>);</span><br /><span class="line"> <span class="number">42</span>:         <span class="comment">// æ·»åŠ åˆ° `pts` ä¸­</span></span><br /><span class="line"> <span class="number">43</span>:         pts.put(fn, ft);</span><br /><span class="line"> <span class="number">44</span>:     }</span><br /><span class="line"> <span class="number">45</span>: </span><br /><span class="line"> <span class="number">46</span>:     Method[] methods = c.getMethods();</span><br /><span class="line"> <span class="number">47</span>:     <span class="comment">// å¦‚æœæœ‰æ–¹æ³•ï¼Œæ·»åŠ  `#invokeMethod(o, n, p, v)` çš„ try çš„ä»£ç </span></span><br /><span class="line"> <span class="number">48</span>:     <span class="comment">// get all public method.</span></span><br /><span class="line"> <span class="number">49</span>:     <span class="keyword">boolean</span> hasMethod = hasMethods(methods);</span><br /><span class="line"> <span class="number">50</span>:     <span class="keyword">if</span> (hasMethod) {</span><br /><span class="line"> <span class="number">51</span>:         c3.append(<span class="string">" try{"</span>);</span><br /><span class="line"> <span class="number">52</span>:     }</span><br /><span class="line"> <span class="number">53</span>:     <span class="keyword">for</span> (Method m : methods) {</span><br /><span class="line"> <span class="number">54</span>:         <span class="comment">// è·³è¿‡æ¥è‡ª Object çš„å†…ç½®æ–¹æ³•</span></span><br /><span class="line"> <span class="number">55</span>:         <span class="keyword">if</span> (m.getDeclaringClass() == Object.class) <span class="comment">//ignore Object's method.</span></span><br /><span class="line"> <span class="number">56</span>:             <span class="keyword">continue</span>;</span><br /><span class="line"> <span class="number">57</span>: </span><br /><span class="line"> <span class="number">58</span>:         String mn = m.getName(); <span class="comment">// æ–¹æ³•å</span></span><br /><span class="line"> <span class="number">59</span>:         <span class="comment">// ä½¿ç”¨æ–¹æ³•å + æ–¹æ³•å‚æ•°é•¿åº¦æ¥åˆ¤æ–­</span></span><br /><span class="line"> <span class="number">60</span>:         c3.append(<span class="string">" if( \""</span>).append(mn).append(<span class="string">"\".equals( $2 ) "</span>);</span><br /><span class="line"> <span class="number">61</span>:         <span class="keyword">int</span> len = m.getParameterTypes().length;</span><br /><span class="line"> <span class="number">62</span>:         c3.append(<span class="string">" &amp;&amp; "</span>).append(<span class="string">" $3.length == "</span>).append(len);</span><br /><span class="line"> <span class="number">63</span>: </span><br /><span class="line"> <span class="number">64</span>:         <span class="comment">// è‹¥ç›¸åŒæ–¹æ³•åå­˜åœ¨å¤šä¸ªï¼Œå¢åŠ å‚æ•°ç±»å‹æ•°ç»„çš„æ¯”è¾ƒåˆ¤æ–­</span></span><br /><span class="line"> <span class="number">65</span>:         <span class="keyword">boolean</span> override = <span class="keyword">false</span>;</span><br /><span class="line"> <span class="number">66</span>:         <span class="keyword">for</span> (Method m2 : methods) {</span><br /><span class="line"> <span class="number">67</span>:             <span class="keyword">if</span> (m != m2 &amp;&amp; m.getName().equals(m2.getName())) {</span><br /><span class="line"> <span class="number">68</span>:                 override = <span class="keyword">true</span>;</span><br /><span class="line"> <span class="number">69</span>:                 <span class="keyword">break</span>;</span><br /><span class="line"> <span class="number">70</span>:             }</span><br /><span class="line"> <span class="number">71</span>:         }</span><br /><span class="line"> <span class="number">72</span>:         <span class="keyword">if</span> (override) {</span><br /><span class="line"> <span class="number">73</span>:             <span class="keyword">if</span> (len &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">74</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; len; l++) {</span><br /><span class="line"> <span class="number">75</span>:                     c3.append(<span class="string">" &amp;&amp; "</span>).append(<span class="string">" $3["</span>).append(l).append(<span class="string">"].getName().equals(\""</span>)</span><br /><span class="line"> <span class="number">76</span>:                             .append(m.getParameterTypes()[l].getName()).append(<span class="string">"\")"</span>);</span><br /><span class="line"> <span class="number">77</span>:                 }</span><br /><span class="line"> <span class="number">78</span>:             }</span><br /><span class="line"> <span class="number">79</span>:         }</span><br /><span class="line"> <span class="number">80</span>: </span><br /><span class="line"> <span class="number">81</span>:         c3.append(<span class="string">" ) { "</span>);</span><br /><span class="line"> <span class="number">82</span>: </span><br /><span class="line"> <span class="number">83</span>:         <span class="comment">// æ·»åŠ è°ƒç”¨å¯¹è±¡çš„å¯¹åº”æ–¹æ³•çš„ä»£ç </span></span><br /><span class="line"> <span class="number">84</span>:         <span class="keyword">if</span> (m.getReturnType() == Void.TYPE)</span><br /><span class="line"> <span class="number">85</span>:             c3.append(<span class="string">" w."</span>).append(mn).append(<span class="string">'('</span>).append(args(m.getParameterTypes(), <span class="string">"$4"</span>)).append(<span class="string">");"</span>).append(<span class="string">" return null;"</span>);</span><br /><span class="line"> <span class="number">86</span>:         <span class="keyword">else</span></span><br /><span class="line"> <span class="number">87</span>:             c3.append(<span class="string">" return ($w)w."</span>).append(mn).append(<span class="string">'('</span>).append(args(m.getParameterTypes(), <span class="string">"$4"</span>)).append(<span class="string">");"</span>);</span><br /><span class="line"> <span class="number">88</span>: </span><br /><span class="line"> <span class="number">89</span>:         c3.append(<span class="string">" }"</span>);</span><br /><span class="line"> <span class="number">90</span>: </span><br /><span class="line"> <span class="number">91</span>:         <span class="comment">// æ·»åŠ åˆ° `mns` ä¸­</span></span><br /><span class="line"> <span class="number">92</span>:         mns.add(mn);</span><br /><span class="line"> <span class="number">93</span>:         <span class="comment">// æ·»åŠ åˆ° `dmns` ä¸­</span></span><br /><span class="line"> <span class="number">94</span>:         <span class="keyword">if</span> (m.getDeclaringClass() == c)</span><br /><span class="line"> <span class="number">95</span>:             dmns.add(mn);</span><br /><span class="line"> <span class="number">96</span>:         <span class="comment">// æ·»åŠ åˆ° `ms` ä¸­</span></span><br /><span class="line"> <span class="number">97</span>:         ms.put(ReflectUtils.getDesc(m), m);</span><br /><span class="line"> <span class="number">98</span>:     }</span><br /><span class="line"> <span class="number">99</span>:     <span class="comment">// å¦‚æœæœ‰æ–¹æ³•ï¼Œæ·»åŠ  `#invokeMethod(o, n, p, v)` çš„ catch çš„ä»£ç </span></span><br /><span class="line"><span class="number">100</span>:     <span class="keyword">if</span> (hasMethod) {</span><br /><span class="line"><span class="number">101</span>:         c3.append(<span class="string">" } catch(Throwable e) { "</span>);</span><br /><span class="line"><span class="number">102</span>:         c3.append(<span class="string">"     throw new java.lang.reflect.InvocationTargetException(e); "</span>);</span><br /><span class="line"><span class="number">103</span>:         c3.append(<span class="string">" }"</span>);</span><br /><span class="line"><span class="number">104</span>:     }</span><br /><span class="line"><span class="number">105</span>:     <span class="comment">// æ·»åŠ  `#invokeMethod(o, n, p, v)` çš„æœªåŒ¹é…åˆ°æ–¹æ³•çš„ä»£ç </span></span><br /><span class="line"><span class="number">106</span>:     c3.append(<span class="string">" throw new "</span> + NoSuchMethodException.class.getName() + <span class="string">"(\"Not found method \\\"\"+$2+\"\\\" in class "</span> + c.getName() + <span class="string">".\"); }"</span>);</span><br /><span class="line"><span class="number">107</span>: </span><br /><span class="line"><span class="number">108</span>:     <span class="comment">// å¾ªç¯ setting/getting æ–¹æ³•ï¼Œæ·»åŠ æ¯ä¸ªå±æ€§çš„è®¾ç½®å’Œè·å¾—åˆ†åˆ«åˆ° `#setPropertyValue(o, n, v)` å’Œ `#getPropertyValue(o, n)` çš„ä»£ç </span></span><br /><span class="line"><span class="number">109</span>:     <span class="comment">// deal with get/set method.</span></span><br /><span class="line"><span class="number">110</span>:     Matcher matcher;</span><br /><span class="line"><span class="number">111</span>:     <span class="keyword">for</span> (Map.Entry&lt;String, Method&gt; entry : ms.entrySet()) {</span><br /><span class="line"><span class="number">112</span>:         String md = entry.getKey();</span><br /><span class="line"><span class="number">113</span>:         Method method = entry.getValue();</span><br /><span class="line"><span class="number">114</span>:         <span class="keyword">if</span> ((matcher = ReflectUtils.GETTER_METHOD_DESC_PATTERN.matcher(md)).matches()) {</span><br /><span class="line"><span class="number">115</span>:             String pn = propertyName(matcher.group(<span class="number">1</span>));</span><br /><span class="line"><span class="number">116</span>:             c2.append(<span class="string">" if( $2.equals(\""</span>).append(pn).append(<span class="string">"\") ){ return ($w)w."</span>).append(method.getName()).append(<span class="string">"(); }"</span>);</span><br /><span class="line"><span class="number">117</span>:             <span class="comment">// æ·»åŠ åˆ° `pts` ä¸­</span></span><br /><span class="line"><span class="number">118</span>:             pts.put(pn, method.getReturnType());</span><br /><span class="line"><span class="number">119</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> ((matcher = ReflectUtils.IS_HAS_CAN_METHOD_DESC_PATTERN.matcher(md)).matches()) {</span><br /><span class="line"><span class="number">120</span>:             String pn = propertyName(matcher.group(<span class="number">1</span>));</span><br /><span class="line"><span class="number">121</span>:             c2.append(<span class="string">" if( $2.equals(\""</span>).append(pn).append(<span class="string">"\") ){ return ($w)w."</span>).append(method.getName()).append(<span class="string">"(); }"</span>);</span><br /><span class="line"><span class="number">122</span>:             <span class="comment">// æ·»åŠ åˆ° `pts` ä¸­</span></span><br /><span class="line"><span class="number">123</span>:             pts.put(pn, method.getReturnType());</span><br /><span class="line"><span class="number">124</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> ((matcher = ReflectUtils.SETTER_METHOD_DESC_PATTERN.matcher(md)).matches()) { <span class="comment">// ä¸æ”¯æŒ public T setName(String name) { this.name = name; return this;} è¿™ç§è¿”å› this çš„å½¢å¼ã€‚</span></span><br /><span class="line"><span class="number">125</span>:             Class&lt;?&gt; pt = method.getParameterTypes()[<span class="number">0</span>];</span><br /><span class="line"><span class="number">126</span>:             String pn = propertyName(matcher.group(<span class="number">1</span>));</span><br /><span class="line"><span class="number">127</span>:             c1.append(<span class="string">" if( $2.equals(\""</span>).append(pn).append(<span class="string">"\") ){ w."</span>).append(method.getName()).append(<span class="string">"("</span>).append(arg(pt, <span class="string">"$3"</span>)).append(<span class="string">"); return; }"</span>);</span><br /><span class="line"><span class="number">128</span>:             <span class="comment">// æ·»åŠ åˆ° `pts` ä¸­</span></span><br /><span class="line"><span class="number">129</span>:             pts.put(pn, pt);</span><br /><span class="line"><span class="number">130</span>:         }</span><br /><span class="line"><span class="number">131</span>:     }</span><br /><span class="line"><span class="number">132</span>:     c1.append(<span class="string">" throw new "</span> + NoSuchPropertyException.class.getName() + <span class="string">"(\"Not found property \\\"\"+$2+\"\\\" filed or setter method in class "</span> + c.getName() + <span class="string">".\"); }"</span>);</span><br /><span class="line"><span class="number">133</span>:     c2.append(<span class="string">" throw new "</span> + NoSuchPropertyException.class.getName() + <span class="string">"(\"Not found property \\\"\"+$2+\"\\\" filed or setter method in class "</span> + c.getName() + <span class="string">".\"); }"</span>);</span><br /><span class="line"><span class="number">134</span>: </span><br /><span class="line"><span class="number">135</span>:     <span class="comment">// make class</span></span><br /><span class="line"><span class="number">136</span>:     <span class="keyword">long</span> id = WRAPPER_CLASS_COUNTER.getAndIncrement();</span><br /><span class="line"><span class="number">137</span>:     <span class="comment">// åˆ›å»º ClassGenerator å¯¹è±¡</span></span><br /><span class="line"><span class="number">138</span>:     ClassGenerator cc = ClassGenerator.newInstance(cl);</span><br /><span class="line"><span class="number">139</span>:     <span class="comment">// è®¾ç½®ç±»å</span></span><br /><span class="line"><span class="number">140</span>:     cc.setClassName((Modifier.isPublic(c.getModifiers()) ? Wrapper.class.getName() : c.getName() + <span class="string">"$sw"</span>) + id);</span><br /><span class="line"><span class="number">141</span>:     <span class="comment">// è®¾ç½®çˆ¶ç±»ä¸º Wrapper.class</span></span><br /><span class="line"><span class="number">142</span>:     cc.setSuperClass(Wrapper.class);</span><br /><span class="line"><span class="number">143</span>: </span><br /><span class="line"><span class="number">144</span>:     <span class="comment">// æ·»åŠ æ„é€ æ–¹æ³•ï¼Œå‚æ•° ç©º</span></span><br /><span class="line"><span class="number">145</span>:     cc.addDefaultConstructor();</span><br /><span class="line"><span class="number">146</span>:     <span class="comment">// æ·»åŠ é™æ€å±æ€§ `pns` çš„ä»£ç </span></span><br /><span class="line"><span class="number">147</span>:     cc.addField(<span class="string">"public static String[] pns;"</span>); <span class="comment">// property name array.</span></span><br /><span class="line"><span class="number">148</span>:     <span class="comment">// æ·»åŠ é™æ€å±æ€§ `pts` çš„ä»£ç </span></span><br /><span class="line"><span class="number">149</span>:     cc.addField(<span class="string">"public static "</span> + Map.class.getName() + <span class="string">" pts;"</span>); <span class="comment">// property type map.</span></span><br /><span class="line"><span class="number">150</span>:     <span class="comment">// æ·»åŠ é™æ€å±æ€§ `pts` çš„ä»£ç </span></span><br /><span class="line"><span class="number">151</span>:     cc.addField(<span class="string">"public static String[] mns;"</span>); <span class="comment">// all method name array.</span></span><br /><span class="line"><span class="number">152</span>:     <span class="comment">// æ·»åŠ é™æ€å±æ€§ `dmns` çš„ä»£ç </span></span><br /><span class="line"><span class="number">153</span>:     cc.addField(<span class="string">"public static String[] dmns;"</span>); <span class="comment">// declared method name array.</span></span><br /><span class="line"><span class="number">154</span>:     <span class="comment">// æ·»åŠ é™æ€å±æ€§ `mts` çš„ä»£ç ã€‚æ¯ä¸ªæ–¹æ³•çš„å‚æ•°æ•°ç»„ã€‚</span></span><br /><span class="line"><span class="number">155</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, len = ms.size(); i &lt; len; i++)</span><br /><span class="line"><span class="number">156</span>:         cc.addField(<span class="string">"public static Class[] mts"</span> + i + <span class="string">";"</span>);</span><br /><span class="line"><span class="number">157</span>: </span><br /><span class="line"><span class="number">158</span>:     <span class="comment">// ======= æ·»åŠ æŠ½è±¡æ–¹æ³•çš„å®ç°ï¼Œåˆ° `cc` ä¸­</span></span><br /><span class="line"><span class="number">159</span>:     <span class="comment">// æ·»åŠ  `#getPropertyNames()` çš„ä»£ç åˆ° `cc`</span></span><br /><span class="line"><span class="number">160</span>:     cc.addMethod(<span class="string">"public String[] getPropertyNames(){ return pns; }"</span>);</span><br /><span class="line"><span class="number">161</span>:     <span class="comment">// æ·»åŠ  `#hasProperty(n)` çš„ä»£ç åˆ° `cc`</span></span><br /><span class="line"><span class="number">162</span>:     cc.addMethod(<span class="string">"public boolean hasProperty(String n){ return pts.containsKey($1); }"</span>);</span><br /><span class="line"><span class="number">163</span>:     <span class="comment">// æ·»åŠ  `#getPropertyType(n)` çš„ä»£ç åˆ° `cc`</span></span><br /><span class="line"><span class="number">164</span>:     cc.addMethod(<span class="string">"public Class getPropertyType(String n){ return (Class)pts.get($1); }"</span>);</span><br /><span class="line"><span class="number">165</span>:     <span class="comment">// æ·»åŠ  `#getMethodNames()` çš„ä»£ç åˆ° `cc`</span></span><br /><span class="line"><span class="number">166</span>:     cc.addMethod(<span class="string">"public String[] getMethodNames(){ return mns; }"</span>);</span><br /><span class="line"><span class="number">167</span>:     <span class="comment">// æ·»åŠ  `#getDeclaredMethodNames()` çš„ä»£ç åˆ° `cc`</span></span><br /><span class="line"><span class="number">168</span>:     cc.addMethod(<span class="string">"public String[] getDeclaredMethodNames(){ return dmns; }"</span>);</span><br /><span class="line"><span class="number">169</span>:     <span class="comment">// æ·»åŠ  `#setPropertyValue(o, n, v)` çš„ä»£ç åˆ° `cc`</span></span><br /><span class="line"><span class="number">170</span>:     cc.addMethod(c1.toString());</span><br /><span class="line"><span class="number">171</span>:     <span class="comment">// æ·»åŠ  `#getPropertyValue(o, n)` çš„ä»£ç åˆ° `cc`</span></span><br /><span class="line"><span class="number">172</span>:     cc.addMethod(c2.toString());</span><br /><span class="line"><span class="number">173</span>:     <span class="comment">// æ·»åŠ  `#invokeMethod(o, n, p, v)` çš„ä»£ç åˆ° `cc`</span></span><br /><span class="line"><span class="number">174</span>:     cc.addMethod(c3.toString());</span><br /><span class="line"><span class="number">175</span>: </span><br /><span class="line"><span class="number">176</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">177</span>:         <span class="comment">// ç”Ÿæˆç±»</span></span><br /><span class="line"><span class="number">178</span>:         Class&lt;?&gt; wc = cc.toClass();</span><br /><span class="line"><span class="number">179</span>:         <span class="comment">// åå°„ï¼Œè®¾ç½®é™æ€å˜é‡çš„å€¼</span></span><br /><span class="line"><span class="number">180</span>:         <span class="comment">// setup static field.</span></span><br /><span class="line"><span class="number">181</span>:         wc.getField(<span class="string">"pts"</span>).set(<span class="keyword">null</span>, pts);</span><br /><span class="line"><span class="number">182</span>:         wc.getField(<span class="string">"pns"</span>).set(<span class="keyword">null</span>, pts.keySet().toArray(<span class="keyword">new</span> String[<span class="number">0</span>]));</span><br /><span class="line"><span class="number">183</span>:         wc.getField(<span class="string">"mns"</span>).set(<span class="keyword">null</span>, mns.toArray(<span class="keyword">new</span> String[<span class="number">0</span>]));</span><br /><span class="line"><span class="number">184</span>:         wc.getField(<span class="string">"dmns"</span>).set(<span class="keyword">null</span>, dmns.toArray(<span class="keyword">new</span> String[<span class="number">0</span>]));</span><br /><span class="line"><span class="number">185</span>:         <span class="keyword">int</span> ix = <span class="number">0</span>;</span><br /><span class="line"><span class="number">186</span>:         <span class="keyword">for</span> (Method m : ms.values())</span><br /><span class="line"><span class="number">187</span>:             wc.getField(<span class="string">"mts"</span> + ix++).set(<span class="keyword">null</span>, m.getParameterTypes());</span><br /><span class="line"><span class="number">188</span>:         <span class="comment">// åˆ›å»ºå¯¹è±¡</span></span><br /><span class="line"><span class="number">189</span>:         <span class="keyword">return</span> (Wrapper) wc.newInstance();</span><br /><span class="line"><span class="number">190</span>:     } <span class="keyword">catch</span> (RuntimeException e) {</span><br /><span class="line"><span class="number">191</span>:         <span class="keyword">throw</span> e;</span><br /><span class="line"><span class="number">192</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">193</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage(), e);</span><br /><span class="line"><span class="number">194</span>:     } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">195</span>:         <span class="comment">// é‡Šæ”¾èµ„æº</span></span><br /><span class="line"><span class="number">196</span>:         cc.release();</span><br /><span class="line"><span class="number">197</span>:         ms.clear();</span><br /><span class="line"><span class="number">198</span>:         mns.clear();</span><br /><span class="line"><span class="number">199</span>:         dmns.clear();</span><br /><span class="line"><span class="number">200</span>:     }</span><br /><span class="line"><span class="number">201</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ä¸Šæ–‡ç”Ÿæˆçš„ Wrapper1 çš„ä»£ç ï¼Œå¯¹åº”çš„ DempServiceImpl çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoServiceImpl</span> <span class="keyword">implements</span> <span class="title">DemoService</span> </span>{</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 4:      * æµ‹è¯•å±æ€§ï¼Œ{<span class="doctag">@link</span> com.alibaba.dubbo.common.bytecode.Wrapper}</span></span><br /><span class="line"><span class="comment"> 5:      */</span></span><br /><span class="line"> <span class="number">6</span>:     <span class="keyword">public</span> String test01;</span><br /><span class="line"> <span class="number">7</span>: </span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">private</span> DemoDAO demoDAO;</span><br /><span class="line"> <span class="number">9</span>: </span><br /><span class="line"><span class="number">10</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>{</span><br /><span class="line"><span class="number">11</span>:         System.out.println(<span class="string">"["</span> + <span class="keyword">new</span> SimpleDateFormat(<span class="string">"HH:mm:ss"</span>).format(<span class="keyword">new</span> Date()) + <span class="string">"] Hello "</span> + name + <span class="string">", request from consumer: "</span> + RpcContext.getContext().getRemoteAddress());</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">return</span> <span class="string">"Hello "</span> + name + <span class="string">", response form provider: "</span> + RpcContext.getContext().getLocalAddress();</span><br /><span class="line"><span class="number">13</span>:     }</span><br /><span class="line"><span class="number">14</span>: </span><br /><span class="line"><span class="number">15</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">16</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bye</span><span class="params">(Object o)</span> </span>{</span><br /><span class="line"><span class="number">17</span>:         System.out.println(JSON.toJSONString(o));</span><br /><span class="line"><span class="number">18</span>:         System.out.println(o.getClass());</span><br /><span class="line"><span class="number">19</span>:     }</span><br /><span class="line"><span class="number">20</span>: </span><br /><span class="line"><span class="number">21</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDemoDAO</span><span class="params">(DemoDAO demoDAO)</span> </span>{</span><br /><span class="line"><span class="number">22</span>:         <span class="keyword">this</span>.demoDAO = demoDAO;</span><br /><span class="line"><span class="number">23</span>:     }</span><br /><span class="line"><span class="number">24</span>: </span><br /><span class="line"><span class="number">25</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä¸‹é¢ï¼Œæˆ‘ä»¬çš„è§£æï¼Œä¼šç»“åˆè¿™ä¸ªç±»ä¸€èµ·è®²ã€‚</li>
</ul>
<ul>
<li>========== ç”Ÿæˆä»£ç  ==========</li>
</ul>
</li>
<li>ç¬¬ 11 è‡³ 16 è¡Œï¼šåˆ›å»ºæ–¹æ³•çš„<strong>å¼€å¤´</strong>çš„ä»£ç ï¼š
<ul>
<li><code>#setPropertyValue(o, n, v)</code>&nbsp;çš„ã€Wrapper1 ç¬¬ 45 è‡³ 46 è¡Œã€‘</li>
<li><code>#getPropertyValue(o, n)</code>&nbsp;çš„ã€Wrapper1 ç¬¬ 69 è‡³ 70 è¡Œã€‘</li>
<li><code>#invokeMethod(o, n, p, v)</code>&nbsp;çš„ã€Wrapper1 ç¬¬ 86 è‡³ 88 è¡Œã€‘</li>
</ul>
</li>
<li>ç¬¬ 19 è‡³ 21 è¡Œï¼šè®¾ç½®æ–¹æ³•çš„<strong>è¢«è°ƒç”¨å¯¹è±¡çš„ç±»å‹è½¬æ¢</strong>çš„ä»£ç ï¼š
<ul>
<li><code>#setPropertyValue(o, n, v)</code>&nbsp;çš„ã€Wrapper1 ç¬¬ 47 è‡³ 55 è¡Œã€‘
<ul>
<li><code>#getPropertyValue(o, n)</code>&nbsp;çš„ã€Wrapper1 ç¬¬ 71 è‡³ 79 è¡Œã€‘</li>
<li><code>#invokeMethod(o, n, p, v)</code>&nbsp;çš„ã€Wrapper1 ç¬¬ 89 è‡³ 97 è¡Œã€‘</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 23 è‡³ 30 è¡Œï¼šå£°æ˜&nbsp;<code>pts</code>&nbsp;<code>ms</code>&nbsp;<code>mn</code>&nbsp;<code>dmns</code>&nbsp;å˜é‡ã€‚ğŸ™‚ æ¯ä¸ªå˜é‡çš„ç”¨é€”ï¼Œå·²ç»æ·»åŠ åˆ°ä»£ç çš„æ³¨é‡Šä¸Šã€‚</li>
<li>ç¬¬ 32 è‡³ 44 è¡Œï¼šå¾ªç¯&nbsp;<strong>public</strong>&nbsp;å±æ€§ï¼Œæ·»åŠ æ¯ä¸ªå±æ€§çš„è®¾ç½®å’Œè·å¾—åˆ†åˆ«ä»£ç ï¼š
<ul>
<li>ã€DemoServiceImpl ç¬¬ 6 è¡Œã€‘</li>
<li><code>#setPropertyValue(o, n, v)</code>&nbsp;çš„ã€Wrapper1 ç¬¬ 56 è‡³ 60 è¡Œã€‘</li>
<li><code>#getPropertyValue(o, n)</code>&nbsp;çš„ã€Wrapper1 ç¬¬ 80 è‡³ 62 è¡Œã€‘</li>
</ul>
</li>
<li>ç¬¬ 46 è‡³ 106 è¡Œï¼šè®¾ç½®æ–¹æ³•&nbsp;<code>#invokeMethod(o, n, p, v)</code>&nbsp;çš„è°ƒç”¨ä»£ç ï¼š
<ul>
<li>ã€DemoServiceImpl ç¬¬ 10 è‡³ 23 è¡Œã€‘</li>
<li>ã€Wrapper1 ç¬¬ 98 è‡³ 119 è¡Œã€‘</li>
</ul>
</li>
<li>ç¬¬ 108 è‡³ 131 è¡Œï¼šå¾ªç¯&nbsp;<strong>setting / getting</strong>&nbsp;å±æ€§ï¼Œæ·»åŠ æ¯ä¸ªå±æ€§çš„è®¾ç½®å’Œè·å¾—åˆ†åˆ«ä»£ç ï¼š
<ul>
<li><code>#setPropertyValue(o, n, v)</code>
<ul>
<li>ã€DemoServiceImpl ç¬¬ 21 è‡³ 23 è¡Œã€‘ã€DemoServiceImpl ç¬¬ 8 è¡Œã€‘</li>
<li>ã€Wrapper1 ç¬¬ 61 è‡³ 62 è¡Œã€‘</li>
</ul>
</li>
<li>ğŸ™‚&nbsp;<code>#getPropertyValue(o, n)</code>&nbsp;æ²¡ä¸¾ä¾‹å­ï¼Œèƒ–å‹è‡ªå·±çœ‹ä»£ç è„‘è¡¥ã€‚</li>
</ul>
</li>
<li>========== ç”Ÿæˆç±» ==========</li>
<li>ç¬¬ 138 è¡Œï¼šåˆ›å»º ClassGenerator å¯¹è±¡ã€‚</li>
<li>ç¬¬ 140 è¡Œï¼šè®¾ç½®ç±»åã€‚</li>
<li>ç¬¬ 142 è¡Œï¼šè®¾ç½®çˆ¶ç±»ä¸º Wrapper.class</li>
<li>ç¬¬ 145 è¡Œï¼šæ·»åŠ æ„é€ æ–¹æ³•ï¼Œå‚æ•°ä¸ºç©º</li>
<li>ç¬¬ 146 è‡³ 156 è¡Œï¼šæ·»åŠ <strong>é™æ€å±æ€§</strong>&nbsp;<code>pns</code>&nbsp;<code>pts</code>&nbsp;<code>mns</code>&nbsp;<code>dmns</code>&nbsp;<code>mts</code>&nbsp;ã€‚</li>
<li>ç¬¬ 158 è‡³ 174 è¡Œï¼šæ·»åŠ <strong>æŠ½è±¡æ–¹æ³•</strong>çš„å®ç°ã€‚</li>
<li>ç¬¬ 178 è¡Œï¼šç”Ÿæˆç±»ã€‚</li>
<li>========== åˆ›å»ºå¯¹è±¡ ==========</li>
<li>ç¬¬ 179 è‡³ 187 è¡Œï¼šåå°„ï¼Œè®¾ç½®<strong>é™æ€å±æ€§</strong>çš„å€¼ã€‚</li>
<li>ç¬¬ 189 è¡Œï¼šåˆ›å»º Wrapper å¯¹è±¡ã€‚</li>
<li>========== é‡Šæ”¾ ==========</li>
<li>ç¬¬ 195 è‡³ 199 è¡Œï¼šé‡Šæ”¾èµ„æºã€‚</li>
</ul>
</div>