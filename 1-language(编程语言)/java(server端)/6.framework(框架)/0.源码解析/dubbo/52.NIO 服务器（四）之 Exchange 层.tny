<header class="article-header"><header class="article-header">
<h1 class="article-title">NIO æœåŠ¡å™¨ï¼ˆå››ï¼‰ä¹‹ Exchange å±‚</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡æ¥&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-api-telnet//?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ï¼ˆä¸‰ï¼‰ä¹‹ Telnet å±‚ã€‹</a>&nbsp;ä¸€æ–‡ï¼Œåˆ†äº«&nbsp;<code>dubbo-remoting-api</code>æ¨¡å—ï¼Œ&nbsp;<code>exchange</code>&nbsp;åŒ…ï¼Œ<strong>ä¿¡æ¯äº¤æ¢å±‚</strong>ã€‚</p>
<blockquote>
<p><strong>exchange</strong>&nbsp;ä¿¡æ¯äº¤æ¢å±‚ï¼šå°è£…è¯·æ±‚å“åº”æ¨¡å¼ï¼ŒåŒæ­¥è½¬å¼‚æ­¥ï¼Œä»¥ Request, Response ä¸ºä¸­å¿ƒï¼Œæ‰©å±•æ¥å£ä¸º Exchanger, ExchangeChannel, ExchangeClient, ExchangeServerã€‚</p>
</blockquote>
<p>åœ¨ä¸€æ¬¡ RPC è°ƒç”¨ï¼Œæ¯ä¸ª<strong>è¯·æ±‚</strong>( Request )ï¼Œæ˜¯å…³æ³¨å¯¹åº”çš„<strong>å“åº”</strong>( Response )ã€‚é‚£ä¹ˆ&nbsp;<strong>transport å±‚</strong>&nbsp;æä¾›çš„<strong>ç½‘ç»œä¼ è¾“</strong>&nbsp;åŠŸèƒ½ï¼Œæ˜¯æ— æ³•æ»¡è¶³ RPC çš„è¯‰æ±‚çš„ã€‚å› æ­¤ï¼Œ<strong>exchange å±‚</strong>ï¼Œåœ¨å…¶&nbsp;<strong>Message</strong>&nbsp;ä¹‹ä¸Šï¼Œæ„é€ äº†<strong>Request-Response</strong>&nbsp;çš„æ¨¡å‹ã€‚</p>
<p>å®ç°ä¸Šï¼Œä¹Ÿéå¸¸ç®€å•ï¼Œå°† Message åˆ†æˆ Request å’Œ Response ä¸¤ç§ç±»å‹ï¼Œå¹¶å¢åŠ <strong>ç¼–å·</strong>å±æ€§ï¼Œå°† Request å’Œ Response èƒ½å¤Ÿ<strong>ä¸€ä¸€æ˜ å°„</strong>ã€‚</p>
<p>å®é™…ä¸Šï¼ŒRPC è°ƒç”¨ï¼Œä¼šæœ‰æ›´å¤šç‰¹æ€§çš„éœ€æ±‚ï¼š1ï¼‰<strong>å¼‚æ­¥</strong>å¤„ç†è¿”å›ç»“æœï¼›2ï¼‰å†…ç½®äº‹ä»¶ï¼›3ï¼‰ç­‰ç­‰ã€‚å› æ­¤ï¼ŒRequest å’Œ Response ä¸Šä¼šæœ‰ç±»ä¼¼<strong>ç¼–å·</strong>çš„<strong>ç³»ç»Ÿå­—æ®µ</strong>ã€‚</p>
<p>ä¸€æ¡æ¶ˆæ¯ï¼Œæˆ‘ä»¬åˆ†æˆä¸¤æ®µï¼š</p>
<ul>
<li>åè®®å¤´( Header ) ï¼š ç³»ç»Ÿå­—æ®µï¼Œä¾‹å¦‚ç¼–å·ç­‰ã€‚</li>
<li>å†…å®¹( Body ) ï¼šå…·ä½“è¯·æ±‚çš„å‚æ•°å’Œå“åº”çš„ç»“æœç­‰ã€‚</li>
</ul>
<p>èƒ–å‹åœ¨çœ‹ä¸‹é¢è¿™å¼ å›¾ï¼Œæ˜¯å¦å°±äº²åˆ‡å¤šäº† ğŸ™‚ ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_12_10/01.png" alt="ç±»å›¾" /></p>
<p>æ‰€ä»¥ï¼Œ<code>exchange</code>&nbsp;åŒ…ï¼Œå¾ˆå¤šçš„ä»£ç ï¼Œæ˜¯åœ¨ Header çš„å¤„ç†ã€‚OK ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹è¿™ä¸ªåŒ…çš„<strong>ç±»å›¾</strong>ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_12_10/02.png" alt="ç±»å›¾" /></p>
<ul>
<li>ç™½è‰²éƒ¨åˆ†ï¼Œä¸ºé€šç”¨æ¥å£å’Œ&nbsp;<code>transport</code>&nbsp;åŒ…ä¸‹çš„ç±»ã€‚</li>
<li>è“è‰²éƒ¨åˆ†ï¼Œä¸º&nbsp;<code>exchange</code>&nbsp;åŒ…ä¸‹çš„ç±»ã€‚</li>
</ul>
<p>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-api-transport/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ï¼ˆäºŒï¼‰ä¹‹ Transport å±‚ã€‹</a>&nbsp;ä¸­ï¼Œæˆ‘ä»¬æåˆ°ï¼Œ<strong>è£…é¥°å™¨è®¾è®¡æ¨¡å¼</strong>ï¼Œæ˜¯&nbsp;<code>dubbo-remoting</code>&nbsp;é¡¹ç›®ï¼Œæœ€æ ¸å¿ƒçš„å®ç°æ–¹å¼ï¼Œæ‰€ä»¥ï¼Œ<code>exchange</code>&nbsp;å…¶å®æ˜¯åœ¨&nbsp;<code>transport</code>&nbsp;ä¸Šçš„<strong>è£…é¥°</strong>ï¼Œæä¾›ç»™&nbsp;<code>dubbo-rpc</code>&nbsp;é¡¹ç›®ä½¿ç”¨ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹å…·ä½“ä»£ç å®ç°ã€‚</p>
<h1 id="2-ExchangeChannel">2. ExchangeChannel</h1>
<p><code>com.alibaba.dubbo.remoting.exchange.ExchangeChannel</code>&nbsp;ï¼Œç»§æ‰¿ Channel æ¥å£ï¼Œ<strong>ä¿¡æ¯äº¤æ¢é€šé“</strong>æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// å‘é€è¯·æ±‚</span></span><br /><span class="line"><span class="function">ResponseFuture <span class="title">request</span><span class="params">(Object request)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br /><span class="line"><span class="function">ResponseFuture <span class="title">request</span><span class="params">(Object request, <span class="keyword">int</span> timeout)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br /><br /><span class="line"><span class="comment">// è·å¾—ä¿¡æ¯äº¤æ¢å¤„ç†å™¨</span></span><br /><span class="line"><span class="function">ExchangeHandler <span class="title">getExchangeHandler</span><span class="params">()</span></span>;</span><br /><br /><span class="line"><span class="comment">// ä¼˜é›…å…³é—­</span></span><br /><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> timeout)</span></span>;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="2-1-HeaderExchangeChannel">2.1 HeaderExchangeChannel</h2>
<p><code>com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeChannel</code>&nbsp;ï¼Œå®ç° ExchangeChannel æ¥å£ï¼ŒåŸºäº<strong>æ¶ˆæ¯å¤´éƒ¨( Header )</strong>çš„ä¿¡æ¯äº¤æ¢é€šé“å®ç°ç±»ã€‚</p>
<h3 id="2-1-1-æ„é€ æ–¹æ³•">2.1.1 æ„é€ æ–¹æ³•</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CHANNEL_KEY = HeaderExchangeChannel.class.getName() + <span class="string">".CHANNEL"</span>;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é€šé“</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Channel channel;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦å…³é—­</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> closed = <span class="keyword">false</span>;</span><br /><br /><span class="line">HeaderExchangeChannel(Channel channel) {</span><br /><span class="line">    <span class="keyword">if</span> (channel == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"channel == null"</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">this</span>.channel = channel;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>channel</code>&nbsp;å±æ€§ï¼Œé€šé“ã€‚HeaderExchangeChannel æ˜¯ä¼ å…¥&nbsp;<code>channel</code>&nbsp;å±æ€§çš„<strong>è£…é¥°å™¨</strong>ï¼Œæ¯ä¸ªå®ç°çš„æ–¹æ³•ï¼Œéƒ½ä¼šè°ƒç”¨&nbsp;<code>channel</code>&nbsp;ã€‚å¦‚ä¸‹æ˜¯è¯¥å±æ€§çš„ä¸€ä¸ªä¾‹å­ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_12_10/03.png" alt="&#96;channel&#96;" /></li>
<li>
<p><code>#getOrAddChannel(Channel)</code>&nbsp;<strong>é™æ€</strong>æ–¹æ³•ï¼Œåˆ›å»º HeaderExchangeChannel å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">static</span> HeaderExchangeChannel <span class="title">getOrAddChannel</span><span class="params">(Channel ch)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (ch == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">    }</span><br /><span class="line">    HeaderExchangeChannel ret = (HeaderExchangeChannel) ch.getAttribute(CHANNEL_KEY);</span><br /><span class="line">    <span class="keyword">if</span> (ret == <span class="keyword">null</span>) {</span><br /><span class="line">        ret = <span class="keyword">new</span> HeaderExchangeChannel(ch);</span><br /><span class="line">        <span class="keyword">if</span> (ch.isConnected()) { <span class="comment">// å·²è¿æ¥</span></span><br /><span class="line">            ch.setAttribute(CHANNEL_KEY, ret);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> ret;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä¼ å…¥çš„&nbsp;<code>ch</code>&nbsp;å±æ€§ï¼Œå®é™…å°±æ˜¯&nbsp;<code>HeaderExchangeChanel.channel</code>&nbsp;å±æ€§ã€‚</li>
<li>é€šè¿‡&nbsp;<code>ch.attribute</code>&nbsp;çš„&nbsp;<code>CHANNEL_KEY</code>&nbsp;é”®å€¼ï¼Œä¿è¯æœ‰ä¸”ä»…æœ‰ä¸º&nbsp;<code>ch</code>&nbsp;å±æ€§ï¼Œåˆ›å»ºå”¯ä¸€çš„ HeaderExchangeChannel å¯¹è±¡ã€‚</li>
<li>è¦æ±‚<strong>å·²è¿æ¥</strong>ã€‚</li>
</ul>
</li>
<li>
<p><code>#removeChannelIfDisconnected(ch)</code>&nbsp;<strong>é™æ€æ–¹æ³•</strong>ï¼Œç§»é™¤ HeaderExchangeChannel å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeChannelIfDisconnected</span><span class="params">(Channel ch)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (ch != <span class="keyword">null</span> &amp;&amp; !ch.isConnected()) { <span class="comment">// æœªè¿æ¥</span></span><br /><span class="line">        ch.removeAttribute(CHANNEL_KEY);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<h3 id="2-1-2-å‘é€è¯·æ±‚">2.1.2 å‘é€è¯·æ±‚</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> ResponseFuture <span class="title">request</span><span class="params">(Object request, <span class="keyword">int</span> timeout)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (closed) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(<span class="keyword">this</span>.getLocalAddress(), <span class="keyword">null</span>, <span class="string">"Failed to send request "</span> + request + <span class="string">", cause: The channel "</span> + <span class="keyword">this</span> + <span class="string">" is closed!"</span>);</span><br /><span class="line"> <span class="number">5</span>:     }</span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// create request. åˆ›å»ºè¯·æ±‚</span></span><br /><span class="line"> <span class="number">7</span>:     Request req = <span class="keyword">new</span> Request();</span><br /><span class="line"> <span class="number">8</span>:     req.setVersion(<span class="string">"2.0.0"</span>);</span><br /><span class="line"> <span class="number">9</span>:     req.setTwoWay(<span class="keyword">true</span>); <span class="comment">// éœ€è¦å“åº”</span></span><br /><span class="line"><span class="number">10</span>:     req.setData(request);</span><br /><span class="line"><span class="number">11</span>:     <span class="comment">// åˆ›å»º DefaultFuture å¯¹è±¡</span></span><br /><span class="line"><span class="number">12</span>:     DefaultFuture future = <span class="keyword">new</span> DefaultFuture(channel, req, timeout);</span><br /><span class="line"><span class="number">13</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">14</span>:         <span class="comment">// å‘é€è¯·æ±‚</span></span><br /><span class="line"><span class="number">15</span>:         channel.send(req);</span><br /><span class="line"><span class="number">16</span>:     } <span class="keyword">catch</span> (RemotingException e) { <span class="comment">// å‘ç”Ÿå¼‚å¸¸ï¼Œå–æ¶ˆ DefaultFuture</span></span><br /><span class="line"><span class="number">17</span>:         future.cancel();</span><br /><span class="line"><span class="number">18</span>:         <span class="keyword">throw</span> e;</span><br /><span class="line"><span class="number">19</span>:     }</span><br /><span class="line"><span class="number">20</span>:     <span class="comment">// è¿”å› DefaultFuture å¯¹è±¡</span></span><br /><span class="line"><span class="number">21</span>:     <span class="keyword">return</span> future;</span><br /><span class="line"><span class="number">22</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è‡³ 5 è¡Œï¼šè‹¥å·²ç»å…³é—­ï¼Œä¸å†å…è®¸å‘èµ·æ–°çš„è¯·æ±‚ã€‚</li>
<li>ç¬¬ 6 è‡³ 10 è¡Œï¼šåˆ›å»º Request å¯¹è±¡ã€‚å…¶ä¸­ï¼Œ<code>twoWay = true</code>&nbsp;éœ€è¦å“åº”ï¼›<code>data = request</code>&nbsp;å…·ä½“æ•°æ®ã€‚</li>
<li>ç¬¬ 12 è¡Œï¼šåˆ›å»º DefaultFuture å¯¹è±¡ã€‚</li>
<li>ç¬¬ 13 è‡³ 15 è¡Œï¼šè°ƒç”¨&nbsp;<code>Channel#send(req)</code>&nbsp;æ–¹æ³•ï¼Œå‘é€è¯·æ±‚ã€‚</li>
<li>ç¬¬ 16 è‡³ 19 è¡Œï¼šå‘ç”Ÿ RemotingException å¼‚å¸¸ï¼Œè°ƒç”¨&nbsp;<code>DefaultFuture#cancel()</code>&nbsp;æ–¹æ³•ï¼Œå–æ¶ˆã€‚</li>
<li>ç¬¬ 21 è¡Œï¼šè¿”å› DefaultFuture å¯¹è±¡ã€‚ä»ä»£ç çš„å½¢å¼ä¸Šæ¥è¯´ï¼Œæœ‰ç‚¹ç±»ä¼¼çº¿ç¨‹æ± æäº¤ä»»åŠ¡ï¼Œè¿”å› Future å¯¹è±¡ã€‚ğŸ™‚ çœ‹åˆ° DefaultFuture çš„å…·ä½“ä»£ç ï¼Œæˆ‘ä»¬å°±ä¼šæ›´åŠ ç†è§£äº†ã€‚</li>
</ul>
<h3 id="2-1-3-ä¼˜é›…å…³é—­">2.1.3 ä¼˜é›…å…³é—­</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> timeout)</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (closed) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="keyword">return</span>;</span><br /><span class="line"> <span class="number">5</span>:     }</span><br /><span class="line"> <span class="number">6</span>:     closed = <span class="keyword">true</span>;</span><br /><span class="line"> <span class="number">7</span>:     <span class="comment">// ç­‰å¾…è¯·æ±‚å®Œæˆ</span></span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (timeout &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">9</span>:         <span class="keyword">long</span> start = System.currentTimeMillis();</span><br /><span class="line"><span class="number">10</span>:         <span class="keyword">while</span> (DefaultFuture.hasFuture(channel) &amp;&amp; System.currentTimeMillis() - start &lt; timeout) {</span><br /><span class="line"><span class="number">11</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">12</span>:                 Thread.sleep(<span class="number">10</span>);</span><br /><span class="line"><span class="number">13</span>:             } <span class="keyword">catch</span> (InterruptedException e) {</span><br /><span class="line"><span class="number">14</span>:                 logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">15</span>:             }</span><br /><span class="line"><span class="number">16</span>:         }</span><br /><span class="line"><span class="number">17</span>:     }</span><br /><span class="line"><span class="number">18</span>:     <span class="comment">// å…³é—­é€šé“</span></span><br /><span class="line"><span class="number">19</span>:     close();</span><br /><span class="line"><span class="number">20</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è‡³ 6 è¡Œï¼šæ ‡è®°&nbsp;<code>closed = true</code>&nbsp;ï¼Œé¿å…å‘èµ·<strong>æ–°</strong>çš„è¯·æ±‚ã€‚</li>
<li>ç¬¬ 7 è‡³ 17 è¡Œï¼šè°ƒç”¨&nbsp;<code>DefaultFuture#hasFuture(channel)</code>&nbsp;æ–¹æ³•ï¼Œåˆ¤æ–­å·²å‘èµ·çš„å·²ç»æ˜¯å¦å·²ç»éƒ½å“åº”äº†ã€‚è‹¥å¦ï¼Œç­‰å¾…å®Œæˆæˆ–è¶…æ—¶ã€‚</li>
<li>ç¬¬ 19 è¡Œï¼šå…³é—­<strong>é€šé“</strong>ã€‚</li>
</ul>
<p><strong>å…¶å®ƒæ–¹æ³•</strong></p>
<p>å…¶å®ƒ<strong>å®ç°</strong>æ–¹æ³•ï¼Œä¸»è¦æ˜¯ç›´æ¥è°ƒç”¨&nbsp;<code>channel</code>&nbsp;çš„æ–¹æ³•ï¼Œç‚¹å‡»&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/2a0484941defceb9a600c7f7914ada335e3186af/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/support/header/HeaderExchangeChannel.java" target="_blank" rel="external nofollow noopener noreferrer">ä¼ é€é—¨</a>&nbsp;æŸ¥çœ‹ä»£ç ã€‚</p>
<h1 id="3-ExchangeClient">3. ExchangeClient</h1>
<p><code>com.alibaba.dubbo.remoting.exchange.ExchangeClient</code>&nbsp;ï¼Œå®ç° Client ï¼ŒExchangeChannel æ¥å£ï¼Œ<strong>ä¿¡æ¯äº¤æ¢å®¢æˆ·ç«¯</strong>æ¥å£ã€‚</p>
<p>æ— è‡ªå®šä¹‰æ–¹æ³•ã€‚</p>
<h2 id="3-1-HeaderExchangeClient">3.1 HeaderExchangeClient</h2>
<p><code>com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeClient</code>&nbsp;ï¼Œå®ç° ExchangeClient æ¥å£ï¼ŒåŸºäº<strong>æ¶ˆæ¯å¤´éƒ¨( Header )</strong>çš„ä¿¡æ¯äº¤æ¢å®¢æˆ·ç«¯å®ç°ç±»ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * å®šæ—¶å™¨çº¿ç¨‹æ± </span></span><br /><span class="line"><span class="comment"> 3:  */</span></span><br /><span class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ScheduledThreadPoolExecutor scheduled = <span class="keyword">new</span> ScheduledThreadPoolExecutor(<span class="number">2</span>, <span class="keyword">new</span> NamedThreadFactory(<span class="string">"dubbo-remoting-client-heartbeat"</span>, <span class="keyword">true</span>));</span><br /><span class="line"> <span class="number">5</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 6:  * å®¢æˆ·ç«¯</span></span><br /><span class="line"><span class="comment"> 7:  */</span></span><br /><span class="line"> <span class="number">8</span>: <span class="keyword">private</span> <span class="keyword">final</span> Client client;</span><br /><span class="line"> <span class="number">9</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">10:  * ä¿¡æ¯äº¤æ¢é€šé“</span></span><br /><span class="line"><span class="comment">11:  */</span></span><br /><span class="line"><span class="number">12</span>: <span class="keyword">private</span> <span class="keyword">final</span> ExchangeChannel channel;</span><br /><span class="line"><span class="number">13</span>: <span class="comment">// heartbeat timer</span></span><br /><span class="line"><span class="number">14</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">15:  * å¿ƒè·³å®šæ—¶å™¨</span></span><br /><span class="line"><span class="comment">16:  */</span></span><br /><span class="line"><span class="number">17</span>: <span class="keyword">private</span> ScheduledFuture&lt;?&gt; heartbeatTimer;</span><br /><span class="line"><span class="number">18</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">19:  * æ˜¯å¦å¿ƒè·³</span></span><br /><span class="line"><span class="comment">20:  */</span></span><br /><span class="line"><span class="number">21</span>: <span class="keyword">private</span> <span class="keyword">int</span> heartbeat;</span><br /><span class="line"><span class="number">22</span>: <span class="comment">// heartbeat timeout (ms), default value is 0 , won't execute a heartbeat.</span></span><br /><span class="line"><span class="number">23</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">24:  * å¿ƒè·³é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’</span></span><br /><span class="line"><span class="comment">25:  */</span></span><br /><span class="line"><span class="number">26</span>: <span class="keyword">private</span> <span class="keyword">int</span> heartbeatTimeout;</span><br /><span class="line"><span class="number">27</span>: </span><br /><span class="line"><span class="number">28</span>: <span class="function"><span class="keyword">public</span> <span class="title">HeaderExchangeClient</span><span class="params">(Client client, <span class="keyword">boolean</span> needHeartbeat)</span> </span>{</span><br /><span class="line"><span class="number">29</span>:     <span class="keyword">if</span> (client == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">30</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"client == null"</span>);</span><br /><span class="line"><span class="number">31</span>:     }</span><br /><span class="line"><span class="number">32</span>:     <span class="keyword">this</span>.client = client;</span><br /><span class="line"><span class="number">33</span>:     <span class="comment">// åˆ›å»º HeaderExchangeChannel å¯¹è±¡</span></span><br /><span class="line"><span class="number">34</span>:     <span class="keyword">this</span>.channel = <span class="keyword">new</span> HeaderExchangeChannel(client);</span><br /><span class="line"><span class="number">35</span>:     <span class="comment">// è¯»å–å¿ƒè·³ç›¸å…³é…ç½®</span></span><br /><span class="line"><span class="number">36</span>:     String dubbo = client.getUrl().getParameter(Constants.DUBBO_VERSION_KEY);</span><br /><span class="line"><span class="number">37</span>:     <span class="keyword">this</span>.heartbeat = client.getUrl().getParameter(Constants.HEARTBEAT_KEY, dubbo != <span class="keyword">null</span> &amp;&amp; dubbo.startsWith(<span class="string">"1.0."</span>) ? Constants.DEFAULT_HEARTBEAT : <span class="number">0</span>);</span><br /><span class="line"><span class="number">38</span>:     <span class="keyword">this</span>.heartbeatTimeout = client.getUrl().getParameter(Constants.HEARTBEAT_TIMEOUT_KEY, heartbeat * <span class="number">3</span>);</span><br /><span class="line"><span class="number">39</span>:     <span class="keyword">if</span> (heartbeatTimeout &lt; heartbeat * <span class="number">2</span>) { <span class="comment">// é¿å…é—´éš”å¤ªçŸ­</span></span><br /><span class="line"><span class="number">40</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"heartbeatTimeout &lt; heartbeatInterval * 2"</span>);</span><br /><span class="line"><span class="number">41</span>:     }</span><br /><span class="line"><span class="number">42</span>:     <span class="comment">// å‘èµ·å¿ƒè·³å®šæ—¶å™¨</span></span><br /><span class="line"><span class="number">43</span>:     <span class="keyword">if</span> (needHeartbeat) {</span><br /><span class="line"><span class="number">44</span>:         startHeatbeatTimer();</span><br /><span class="line"><span class="number">45</span>:     }</span><br /><span class="line"><span class="number">46</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>client</code>&nbsp;å±æ€§ï¼Œå®¢æˆ·ç«¯ã€‚å¦‚ä¸‹æ˜¯è¯¥å±æ€§çš„ä¸€ä¸ªä¾‹å­ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_12_10/04.png" alt="&#96;client&#96;" /></li>
<li>ç¬¬ 34 è¡Œï¼šä½¿ç”¨ä¼ å…¥çš„&nbsp;<code>client</code>&nbsp;å±æ€§ï¼Œåˆ›å»º HeaderExchangeChannel å¯¹è±¡ã€‚</li>
<li>
<p>ç¬¬ 35 è‡³ 41 è¡Œï¼šè¯»å–å¿ƒè·³ç›¸å…³é…ç½®ã€‚<strong>é»˜è®¤ï¼Œå¼€å¯å¿ƒè·³åŠŸèƒ½</strong>ã€‚ä¸ºä»€ä¹ˆéœ€è¦æœ‰å¿ƒè·³åŠŸèƒ½å‘¢ï¼Ÿ</p>
<blockquote>
<p>FROM&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-protocol.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; dubbo:protocolã€‹</a></p>
<p>å¿ƒè·³é—´éš”ï¼Œå¯¹äºé•¿è¿æ¥ï¼Œå½“ç‰©ç†å±‚æ–­å¼€æ—¶ï¼Œæ¯”å¦‚æ‹”ç½‘çº¿ï¼ŒTCPçš„FINæ¶ˆæ¯æ¥ä¸åŠå‘é€ï¼Œå¯¹æ–¹æ”¶ä¸åˆ°æ–­å¼€äº‹ä»¶ï¼Œæ­¤æ—¶éœ€è¦å¿ƒè·³æ¥å¸®åŠ©æ£€æŸ¥è¿æ¥æ˜¯å¦å·²æ–­å¼€</p>
</blockquote>
</li>
<li>
<p>ç¬¬ 42 è‡³ 45 è¡Œï¼šè°ƒç”¨&nbsp;<code>#startHeatbeatTimer()</code>&nbsp;æ–¹æ³•ï¼Œå‘èµ·å¿ƒè·³å®šæ—¶å™¨ã€‚</p>
</li>
</ul>
<p><strong>å‘èµ·å¿ƒè·³å®šæ—¶å™¨</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startHeatbeatTimer</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// åœæ­¢åŸæœ‰å®šæ—¶ä»»åŠ¡</span></span><br /><span class="line"> <span class="number">3</span>:     stopHeartbeatTimer();</span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// å‘èµ·æ–°çš„å®šæ—¶ä»»åŠ¡</span></span><br /><span class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (heartbeat &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">6</span>:         heartbeatTimer = scheduled.scheduleWithFixedDelay(</span><br /><span class="line"> <span class="number">7</span>:                 <span class="keyword">new</span> HeartBeatTask(<span class="keyword">new</span> HeartBeatTask.ChannelProvider() {</span><br /><span class="line"> <span class="number">8</span>:                     <span class="function"><span class="keyword">public</span> Collection&lt;Channel&gt; <span class="title">getChannels</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">9</span>:                         <span class="keyword">return</span> Collections.&lt;Channel&gt;singletonList(HeaderExchangeClient.<span class="keyword">this</span>);</span><br /><span class="line"><span class="number">10</span>:                     }</span><br /><span class="line"><span class="number">11</span>:                 }, heartbeat, heartbeatTimeout),</span><br /><span class="line"><span class="number">12</span>:                 heartbeat, heartbeat, TimeUnit.MILLISECONDS);</span><br /><span class="line"><span class="number">13</span>:     }</span><br /><span class="line"><span class="number">14</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šè°ƒç”¨&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/0f933100ad0ea81d3760d42169318904f91a45bb/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/support/header/HeaderExchangeClient.java#L176-L188" target="_blank" rel="external nofollow noopener noreferrer"><code>#stopHeartbeatTimer()</code></a>&nbsp;æ–¹æ³•ï¼Œåœæ­¢åŸæœ‰å®šæ—¶ä»»åŠ¡ã€‚</li>
<li>ç¬¬ 5 è‡³ 13 è¡Œï¼šå‘èµ·æ–°çš„å®šæ—¶ä»»åŠ¡ã€‚
<ul>
<li>ç¬¬ 7 è‡³ 11 è¡Œï¼šåˆ›å»ºå®šæ—¶ä»»åŠ¡ HeartBeatTask å¯¹è±¡ã€‚å…·ä½“å®ç°è§ä¸‹æ–‡ã€‚</li>
</ul>
</li>
</ul>
<p><strong>å…¶å®ƒæ–¹æ³•</strong></p>
<p>å…¶å®ƒ<strong>å®ç°</strong>æ–¹æ³•ï¼Œä¸»è¦æ˜¯ç›´æ¥è°ƒç”¨&nbsp;<code>channel</code>&nbsp;æˆ–&nbsp;<code>client</code>&nbsp;çš„æ–¹æ³•ï¼Œç‚¹å‡»&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/0f933100ad0ea81d3760d42169318904f91a45bb/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/support/header/HeaderExchangeClient.java" target="_blank" rel="external nofollow noopener noreferrer">ä¼ é€é—¨</a>&nbsp;æŸ¥çœ‹ä»£ç ã€‚</p>
<h1 id="4-ExchangeServer">4. ExchangeServer</h1>
<p><code>com.alibaba.dubbo.remoting.exchange.ExchangeServer</code>&nbsp;ï¼Œç»§æ‰¿ Server æ¥å£ï¼Œ<strong>ä¿¡æ¯äº¤æ¢æœåŠ¡å™¨</strong>æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// è·å¾—é€šé“æ•°ç»„</span></span><br /><span class="line"><span class="function">Collection&lt;ExchangeChannel&gt; <span class="title">getExchangeChannels</span><span class="params">()</span></span>;</span><br /><span class="line"><span class="function">ExchangeChannel <span class="title">getExchangeChannel</span><span class="params">(InetSocketAddress remoteAddress)</span></span>;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="4-1-HeaderExchangeServer">4.1 HeaderExchangeServer</h2>
<p><code>com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeServer</code>&nbsp;ï¼Œå®ç° ExchangeServer æ¥å£ï¼ŒåŸºäº<strong>æ¶ˆæ¯å¤´éƒ¨( Header )</strong>çš„ä¿¡æ¯äº¤æ¢æœåŠ¡å™¨å®ç°ç±»ã€‚</p>
<blockquote>
<p>ä»£ç å®ç°ä¸Šï¼Œå’Œ HeaderExchangeChannel + HeaderExchangeClient çš„ç»¼åˆã€‚</p>
</blockquote>
<h3 id="4-1-1-æ„é€ æ–¹æ³•">4.1.1 æ„é€ æ–¹æ³•</h3>
<blockquote>
<p>ä»£ç å®ç°ä¸Šï¼Œå’Œ HeaderExchangeClient çš„ç±»ä¼¼ã€‚</p>
</blockquote>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å®šæ—¶å™¨çº¿ç¨‹æ± </span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService scheduled = Executors.newScheduledThreadPool(<span class="number">1</span>, <span class="keyword">new</span> NamedThreadFactory(<span class="string">"dubbo-remoting-server-heartbeat"</span>, <span class="keyword">true</span>));</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æœåŠ¡å™¨</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Server server;</span><br /><span class="line"><span class="comment">// heartbeat timer</span></span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å¿ƒè·³å®šæ—¶å™¨</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> ScheduledFuture&lt;?&gt; heatbeatTimer;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦å¿ƒè·³</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="comment">// heartbeat timeout (ms), default value is 0 , won't execute a heartbeat.</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> heartbeat;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å¿ƒè·³é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> heartbeatTimeout;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦å…³é—­</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> AtomicBoolean closed = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HeaderExchangeServer</span><span class="params">(Server server)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (server == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"server == null"</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è¯»å–å¿ƒè·³ç›¸å…³é…ç½®</span></span><br /><span class="line">    <span class="keyword">this</span>.server = server;</span><br /><span class="line">    <span class="keyword">this</span>.heartbeat = server.getUrl().getParameter(Constants.HEARTBEAT_KEY, <span class="number">0</span>);</span><br /><span class="line">    <span class="keyword">this</span>.heartbeatTimeout = server.getUrl().getParameter(Constants.HEARTBEAT_TIMEOUT_KEY, heartbeat * <span class="number">3</span>);</span><br /><span class="line">    <span class="keyword">if</span> (heartbeatTimeout &lt; heartbeat * <span class="number">2</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"heartbeatTimeout &lt; heartbeatInterval * 2"</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// å‘èµ·å¿ƒè·³å®šæ—¶å™¨</span></span><br /><span class="line">    startHeatbeatTimer();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="4-1-2-å‘èµ·å¿ƒè·³å®šæ—¶å™¨">4.1.2 å‘èµ·å¿ƒè·³å®šæ—¶å™¨</h3>
<blockquote>
<p>ä»£ç å®ç°ä¸Šï¼Œå’Œ HeaderExchangeClient çš„ç±»ä¼¼ã€‚</p>
</blockquote>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startHeatbeatTimer</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// åœæ­¢åŸæœ‰å®šæ—¶ä»»åŠ¡</span></span><br /><span class="line">    stopHeartbeatTimer();</span><br /><span class="line">    <span class="comment">// å‘èµ·æ–°çš„å®šæ—¶ä»»åŠ¡</span></span><br /><span class="line">    <span class="keyword">if</span> (heartbeat &gt; <span class="number">0</span>) {</span><br /><span class="line">        heatbeatTimer = scheduled.scheduleWithFixedDelay(</span><br /><span class="line">                <span class="keyword">new</span> HeartBeatTask(<span class="keyword">new</span> HeartBeatTask.ChannelProvider() {</span><br /><span class="line">                    <span class="function"><span class="keyword">public</span> Collection&lt;Channel&gt; <span class="title">getChannels</span><span class="params">()</span> </span>{</span><br /><span class="line">                        <span class="keyword">return</span> Collections.unmodifiableCollection(HeaderExchangeServer.<span class="keyword">this</span>.getChannels());</span><br /><span class="line">                    }</span><br /><span class="line">                }, heartbeat, heartbeatTimeout),</span><br /><span class="line">                heartbeat, heartbeat, TimeUnit.MILLISECONDS);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å·®å¼‚ï¼ŒServer æŒæœ‰<strong>å¤šæ¡</strong>&nbsp;Client è¿æ¥çš„ Channel ï¼Œæ‰€ä»¥é€šè¿‡ ChannelProvider è¿”å›çš„æ˜¯<strong>å¤šæ¡</strong>ã€‚</li>
</ul>
<h3 id="4-1-3-é‡ç½®å±æ€§">4.1.3 é‡ç½®å±æ€§</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="comment">// é‡ç½®æœåŠ¡å™¨</span></span><br /><span class="line">    server.reset(url);</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="keyword">if</span> (url.hasParameter(Constants.HEARTBEAT_KEY)</span><br /><span class="line">                || url.hasParameter(Constants.HEARTBEAT_TIMEOUT_KEY)) {</span><br /><span class="line">            <span class="keyword">int</span> h = url.getParameter(Constants.HEARTBEAT_KEY, heartbeat);</span><br /><span class="line">            <span class="keyword">int</span> t = url.getParameter(Constants.HEARTBEAT_TIMEOUT_KEY, h * <span class="number">3</span>);</span><br /><span class="line">            <span class="keyword">if</span> (t &lt; h * <span class="number">2</span>) {</span><br /><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"heartbeatTimeout &lt; heartbeatInterval * 2"</span>);</span><br /><span class="line">            }</span><br /><span class="line">            <span class="comment">// é‡ç½®å®šæ—¶ä»»åŠ¡</span></span><br /><span class="line">            <span class="keyword">if</span> (h != heartbeat || t != heartbeatTimeout) {</span><br /><span class="line">                heartbeat = h;</span><br /><span class="line">                heartbeatTimeout = t;</span><br /><span class="line">                startHeatbeatTimer();</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">        logger.error(t.getMessage(), t);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="4-1-4-ä¼˜é›…å…³é—­">4.1.4 ä¼˜é›…å…³é—­</h3>
<blockquote>
<p>ä»£ç å®ç°ä¸Šï¼Œå’Œ HeaderExchangeChannel çš„ç±»ä¼¼ï¼Œä¸”å¤æ‚ä¸€äº›ã€‚</p>
</blockquote>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> timeout)</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// å…³é—­</span></span><br /><span class="line"> <span class="number">4</span>:     startClose();</span><br /><span class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (timeout &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">6</span>:         <span class="keyword">final</span> <span class="keyword">long</span> max = (<span class="keyword">long</span>) timeout;</span><br /><span class="line"> <span class="number">7</span>:         <span class="keyword">final</span> <span class="keyword">long</span> start = System.currentTimeMillis();</span><br /><span class="line"> <span class="number">8</span>:         <span class="comment">// å‘é€ READONLY äº‹ä»¶ç»™æ‰€æœ‰ Client ï¼Œè¡¨ç¤º Server ä¸å¯è¯»äº†ã€‚</span></span><br /><span class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (getUrl().getParameter(Constants.CHANNEL_SEND_READONLYEVENT_KEY, <span class="keyword">true</span>)) {</span><br /><span class="line"><span class="number">10</span>:             sendChannelReadOnlyEvent();</span><br /><span class="line"><span class="number">11</span>:         }</span><br /><span class="line"><span class="number">12</span>:         <span class="comment">// ç­‰å¾…è¯·æ±‚å®Œæˆ</span></span><br /><span class="line"><span class="number">13</span>:         <span class="keyword">while</span> (HeaderExchangeServer.<span class="keyword">this</span>.isRunning() &amp;&amp; System.currentTimeMillis() - start &lt; max) {</span><br /><span class="line"><span class="number">14</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">15</span>:                 Thread.sleep(<span class="number">10</span>);</span><br /><span class="line"><span class="number">16</span>:             } <span class="keyword">catch</span> (InterruptedException e) {</span><br /><span class="line"><span class="number">17</span>:                 logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">18</span>:             }</span><br /><span class="line"><span class="number">19</span>:         }</span><br /><span class="line"><span class="number">20</span>:     }</span><br /><span class="line"><span class="number">21</span>:     <span class="comment">// å…³é—­å¿ƒè·³å®šæ—¶å™¨</span></span><br /><span class="line"><span class="number">22</span>:     doClose();</span><br /><span class="line"><span class="number">23</span>:     <span class="comment">// å…³é—­æœåŠ¡å™¨</span></span><br /><span class="line"><span class="number">24</span>:     server.close(timeout);</span><br /><span class="line"><span class="number">25</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>Server å…³é—­çš„è¿‡ç¨‹ï¼Œåˆ†æˆ<strong>ä¸¤ä¸ªé˜¶æ®µ</strong>ï¼šæ­£åœ¨å…³é—­å’Œå·²ç»å…³é—­ã€‚</li>
<li>
<p>ç¬¬ 4 è¡Œï¼šè°ƒç”¨&nbsp;<code>#startClose()</code>&nbsp;æ–¹æ³•ï¼Œæ ‡è®°æ­£åœ¨å…³é—­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startClose</span><span class="params">()</span> </span>{</span><br /><span class="line">    server.startClose();</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">// AbstractPeer.java</span></span><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startClose</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (isClosed()) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    closing = <span class="keyword">true</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 8 è‡³ 11 è¡Œï¼šå‘é€&nbsp;<strong>READONLY</strong>&nbsp;äº‹ä»¶ç»™æ‰€æœ‰ Client ï¼Œè¡¨ç¤º Server ä¸å†æ¥æ”¶æ–°çš„æ¶ˆæ¯ï¼Œé¿å…ä¸æ–­æœ‰<strong>æ–°çš„æ¶ˆæ¯</strong>æ¥æ”¶åˆ°ã€‚æ‚å®ç°çš„å‘¢ï¼Ÿä»¥ DubboInvoker ä¸¾ä¾‹å­ï¼Œ<code>#isAvailable()</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (!<span class="keyword">super</span>.isAvailable())</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">    <span class="keyword">for</span> (ExchangeClient client : clients) {</span><br /><span class="line">        <span class="keyword">if</span> (client.isConnected() &amp;&amp; !client.hasAttribute(Constants.CHANNEL_ATTRIBUTE_READONLY_KEY)) { <span class="comment">// åªè¯»åˆ¤æ–­</span></span><br /><span class="line">            <span class="comment">//cannot write == not Available ?</span></span><br /><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å³ä½¿&nbsp;<code>client</code>&nbsp;å¤„äº<strong>è¿æ¥ä¸­</strong>ï¼Œä½†æ˜¯ Server å¤„äº<strong>æ­£åœ¨å…³é—­ä¸­</strong>ï¼Œä¹Ÿç®—<strong>ä¸å¯ç”¨</strong>ï¼Œä¸è¿›è¡Œå‘é€è¯·æ±‚( æ¶ˆæ¯ )ã€‚</li>
</ul>
</li>
<li>
<p><code>#sendChannelReadOnlyEvent()</code>&nbsp;æ–¹æ³•ï¼Œå¹¿æ’­å®¢æˆ·ç«¯ï¼ŒREADONLY_EVENT äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendChannelReadOnlyEvent</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// åˆ›å»º READONLY_EVENT è¯·æ±‚</span></span><br /><span class="line">    Request request = <span class="keyword">new</span> Request();</span><br /><span class="line">    request.setEvent(Request.READONLY_EVENT);</span><br /><span class="line">    request.setTwoWay(<span class="keyword">false</span>); <span class="comment">// æ— éœ€å“åº”</span></span><br /><span class="line">    request.setVersion(Version.getVersion());</span><br /><br /><span class="line">    <span class="comment">// å‘é€ç»™æ‰€æœ‰ Client</span></span><br /><span class="line">    Collection&lt;Channel&gt; channels = getChannels();</span><br /><span class="line">    <span class="keyword">for</span> (Channel channel : channels) {</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            <span class="keyword">if</span> (channel.isConnected())</span><br /><span class="line">                channel.send(request, getUrl().getParameter(Constants.CHANNEL_READONLYEVENT_SENT_KEY, <span class="keyword">true</span>));</span><br /><span class="line">        } <span class="keyword">catch</span> (RemotingException e) {</span><br /><span class="line">            logger.warn(<span class="string">"send connot write messge error."</span>, e);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 22 è¡Œï¼šè°ƒç”¨&nbsp;<code>#oClose()</code>&nbsp;æ–¹æ³•ï¼Œå…³é—­å¿ƒè·³å®šæ—¶å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doClose</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (!closed.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    stopHeartbeatTimer();</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        scheduled.shutdown();</span><br /><span class="line">    } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">        logger.warn(t.getMessage(), t);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 24 è¡Œï¼š<strong>çœŸæ­£</strong>å…³é—­æœåŠ¡å™¨ã€‚</p>
</li>
</ul>
<h2 id="4-2-ExchangeServerDelegate">4.2 ExchangeServerDelegate</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/support/ExchangeServerDelegate.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.exchange.support.ExchangeServerDelegate</code></a>&nbsp;ï¼Œå®ç° ExchangeServer æ¥å£ï¼Œä¿¡æ¯äº¤æ¢æœåŠ¡å™¨è£…é¥°è€…ã€‚åœ¨æ¯ä¸ªå®ç°çš„æ–¹æ³•é‡Œï¼Œç›´æ¥è°ƒç”¨è¢«è£…é¥°çš„&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/31b3f1e868ed2d62c97a26b5cd233a921ce2205a/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/support/ExchangeServerDelegate.java#L34" target="_blank" rel="external nofollow noopener noreferrer"><code>server</code></a>&nbsp;å±æ€§çš„æ–¹æ³•ã€‚</p>
<p>ç›®å‰&nbsp;<code>dubbo-remoting-p2p</code>&nbsp;æ¨¡å—ä¸­ï¼ŒExchangeServerPeer ä¼šç»§æ‰¿è¯¥ç±»ï¼Œåç»­å†çœ‹ã€‚</p>
<h1 id="5-è¯·æ±‚-å“åº”æ¨¡å‹">5. è¯·æ±‚/å“åº”æ¨¡å‹</h1>
<h2 id="5-1-Request">5.1 Request</h2>
<p><code>com.alibaba.dubbo.remoting.exchange.Request</code>&nbsp;ï¼Œè¯·æ±‚ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * äº‹ä»¶ - å¿ƒè·³</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String HEARTBEAT_EVENT = <span class="keyword">null</span>;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * äº‹ä»¶ - åªè¯»</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String READONLY_EVENT = <span class="string">"R"</span>;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è¯·æ±‚ç¼–å·è‡ªå¢åºåˆ—</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicLong INVOKE_ID = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è¯·æ±‚ç¼–å·</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> mId;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Dubbo ç‰ˆæœ¬</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> String mVersion;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦éœ€è¦å“åº”</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * true-éœ€è¦</span></span><br /><span class="line"><span class="comment"> * false-ä¸éœ€è¦</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mTwoWay = <span class="keyword">true</span>;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦æ˜¯äº‹ä»¶ã€‚ä¾‹å¦‚ï¼Œå¿ƒè·³äº‹ä»¶ã€‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mEvent = <span class="keyword">false</span>;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦å¼‚å¸¸çš„è¯·æ±‚ã€‚</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * åœ¨æ¶ˆæ¯è§£æçš„æ—¶å€™ï¼Œä¼šå‡ºç°ã€‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mBroken = <span class="keyword">false</span>;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ•°æ®</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Object mData;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å†…ç½®ä¸¤ç§äº‹ä»¶ï¼š
<ul>
<li><code>HEARTBEAT_EVENT</code>&nbsp;ï¼šå¿ƒè·³ã€‚å› ä¸ºå¿ƒè·³æ¯”è¾ƒå¸¸ç”¨ï¼Œæ‰€ä»¥åœ¨äº‹ä»¶ä¸Šæ—¶å€™äº†&nbsp;<code>null</code>&nbsp;ã€‚</li>
<li><code>READONLY_EVENT</code>&nbsp;ï¼šåªè¯»ã€‚ä¸Šæ–‡å·²ç»è§£é‡Šã€‚</li>
</ul>
</li>
<li>
<p><code>mId</code>&nbsp;å±æ€§ï¼šç¼–å·ã€‚ä½¿ç”¨&nbsp;<code>INVOKE_ID</code>&nbsp;å±æ€§ç”Ÿæˆï¼ŒJVM è¿›ç¨‹å†…å”¯ä¸€ã€‚ç”Ÿæˆä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">newId</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// getAndIncrement() When it grows to MAX_VALUE, it will grow to MIN_VALUE, and the negative can be used as ID</span></span><br /><span class="line">    <span class="keyword">return</span> INVOKE_ID.getAndIncrement();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>version</code>&nbsp;å±æ€§ï¼Œç‰ˆæœ¬å·ã€‚ç›®å‰ä½¿ç”¨ Dubbo å¤§ç‰ˆæœ¬ï¼Œ<code>"2.0.0"</code>&nbsp;ã€‚</p>
</li>
<li><code>mTwoWay</code>&nbsp;å±æ€§ï¼Œæ ‡è®°è¯·æ±‚æ˜¯å¦å“åº”( Response )ï¼Œé»˜è®¤<strong>éœ€è¦</strong>ã€‚</li>
<li><code>mBroken</code>&nbsp;å±æ€§ï¼Œæ˜¯å¦å¼‚å¸¸çš„è¯·æ±‚ã€‚åœ¨æ¶ˆæ¯è§£æçš„æ—¶å€™ï¼Œä¼šå‡ºç°ã€‚</li>
<li><code>mData</code>&nbsp;å±æ€§ï¼Œè¯·æ±‚å…·ä½“æ•°æ®ã€‚</li>
</ul>
<h2 id="5-2-Response">5.2 Response</h2>
<p><code>com.alibaba.dubbo.remoting.exchange.Response</code>&nbsp;ï¼Œå“åº”ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å“åº”ç¼–å·</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * ä¸€ä¸ª {<span class="doctag">@link</span> Request#mId} å’Œ {<span class="doctag">@link</span> Response#mId} ä¸€ä¸€å¯¹åº”ã€‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> mId = <span class="number">0</span>;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ç‰ˆæœ¬</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> String mVersion;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * çŠ¶æ€</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span> mStatus = OK;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ˜¯å¦äº‹ä»¶</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> mEvent = <span class="keyword">false</span>;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é”™è¯¯æ¶ˆæ¯</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> String mErrorMsg;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ç»“æœ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Object mResult;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>mId</code>&nbsp;å±æ€§ï¼Œå“åº”ç¼–å·ï¼Œå’Œè¯·æ±‚ç¼–å·ä¸€è‡´ã€‚</li>
<li><code>mStatus</code>&nbsp;å±æ€§ï¼ŒçŠ¶æ€ã€‚æœ‰å¤šç§çŠ¶æ€ï¼š[çŠ¶æ€ç ] (<a href="https://github.com/apache/incubator-dubbo/blob/9deadadea3b1342345fed77c87a3d24ea026d7e6/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/Response.java)%E3%80%82" target="_blank" rel="external nofollow noopener noreferrer">https://github.com/apache/incubator-dubbo/blob/9deadadea3b1342345fed77c87a3d24ea026d7e6/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/Response.java)ã€‚</a></li>
<li><code>mEvent</code>&nbsp;å±æ€§ï¼Œæ˜¯å¦äº‹ä»¶ã€‚å’Œ Request å†…ç½®äº†<strong>ä¸€æ ·</strong>çš„äº‹ä»¶ï¼Œä½†æ˜¯&nbsp;<code>READONLY_EVENT</code>&nbsp;å¹¶æœªä½¿ç”¨ã€‚å› ä¸ºç›®å‰ï¼Œåªè¯»äº‹ä»¶ï¼Œæ— éœ€å“åº”ã€‚</li>
<li><code>mErrorMsg</code>&nbsp;å±æ€§ï¼Œé”™è¯¯æ¶ˆæ¯ã€‚</li>
<li><code>mResult</code>&nbsp;å±æ€§ï¼Œç»“æœã€‚</li>
</ul>
<h2 id="5-3-ResponseFuture">5.3 ResponseFuture</h2>
<p><code>com.alibaba.dubbo.remoting.exchange.ResponseFuture</code>&nbsp;ï¼Œå“åº” Future&nbsp;<strong>æ¥å£</strong>ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// è·å¾—å€¼</span></span><br /><span class="line"><span class="function">Object <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> RemotingException</span>;</span><br /><span class="line"><span class="function">Object <span class="title">get</span><span class="params">(<span class="keyword">int</span> timeoutInMillis)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br /><br /><span class="line"><span class="comment">// è®¾ç½®å›è°ƒ</span></span><br /><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setCallback</span><span class="params">(ResponseCallback callback)</span></span>;</span><br /><br /><span class="line"><span class="comment">// æ˜¯å¦å®Œæˆ</span></span><br /><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isDone</span><span class="params">()</span></span>;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>å’Œ&nbsp;<a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/Future.html" target="_blank" rel="external nofollow noopener noreferrer"><code>java.util.concurrent.Future</code></a>&nbsp;å¾ˆç±»ä¼¼ã€‚</p>
<h3 id="5-3-1-ResponseCallback">5.3.1 ResponseCallback</h3>
<p><code>com.alibaba.dubbo.remoting.exchange.ResponseCallback</code>&nbsp;ï¼Œå“åº”å›è°ƒ<strong>æ¥å£</strong>ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// å¤„ç†æ‰§è¡Œå®Œæˆ</span></span><br /><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">done</span><span class="params">(Object response)</span></span>;</span><br /><br /><span class="line"><span class="comment">// å¤„ç†å‘ç”Ÿå¼‚å¸¸</span></span><br /><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">caught</span><span class="params">(Throwable exception)</span></span>;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>ResponseCallback åœ¨&nbsp;<code>com.alibaba.dubbo.rpc.protocol.dubbo.filter.FutureFilter</code>&nbsp;ä¸­æœ‰ä½¿ç”¨ï¼Œåé¢æˆ‘ä»¬ä¼šæœ‰æ–‡ç« æ¥åˆ†äº« FutureFilter ã€‚</p>
<h3 id="5-3-2-DefaultFuture">5.3.2 DefaultFuture</h3>
<p><code>com.alibaba.dubbo.remoting.exchange.support.DefaultFuture</code>&nbsp;ï¼Œå®ç° ResponseFuture æ¥å£ï¼Œ<strong>é»˜è®¤</strong>å“åº” Future å®ç°ç±»ã€‚åŒæ—¶ï¼Œå®ƒä¹Ÿæ˜¯æ‰€æœ‰ DefaultFuture çš„ç®¡ç†å®¹å™¨ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é€šé“é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * keyï¼šè¯·æ±‚ç¼–å·</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Long, Channel&gt; CHANNELS = <span class="keyword">new</span> ConcurrentHashMap&lt;Long, Channel&gt;();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Future é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * keyï¼šè¯·æ±‚ç¼–å·</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;Long, DefaultFuture&gt; FUTURES = <span class="keyword">new</span> ConcurrentHashMap&lt;Long, DefaultFuture&gt;();</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è¯·æ±‚ç¼–å·</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="comment">// invoke id.</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> id;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é€šé“</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Channel channel;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è¯·æ±‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Request request;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è¶…æ—¶</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> timeout;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * åˆ›å»ºå¼€å§‹æ—¶é—´</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> start = System.currentTimeMillis();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å‘é€è¯·æ±‚æ—¶é—´</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> sent;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å“åº”</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Response response;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å›è°ƒ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> ResponseCallback callback;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultFuture</span><span class="params">(Channel channel, Request request, <span class="keyword">int</span> timeout)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.channel = channel;</span><br /><span class="line">    <span class="keyword">this</span>.request = request;</span><br /><span class="line">    <span class="keyword">this</span>.id = request.getId();</span><br /><span class="line">    <span class="keyword">this</span>.timeout = timeout &gt; <span class="number">0</span> ? timeout : channel.getUrl().getPositiveParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);</span><br /><span class="line">    <span class="comment">// put into waiting map.</span></span><br /><span class="line">    FUTURES.put(id, <span class="keyword">this</span>);</span><br /><span class="line">    CHANNELS.put(id, channel);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>CHANNELS</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼Œé€šé“é›†åˆã€‚é€šè¿‡&nbsp;<code>#hasFuture(channel)</code>&nbsp;æ–¹æ³•ï¼Œåˆ¤æ–­é€šé“æ˜¯å¦æœ‰æœªç»“æŸçš„è¯·æ±‚ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">hasFuture</span><span class="params">(Channel channel)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> CHANNELS.containsValue(channel);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>FUTURES</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼ŒFuture é›†åˆã€‚</p>
</li>
<li>
<p><code>sent</code>&nbsp;å±æ€§ï¼Œå‘é€è¯·æ±‚æ—¶é—´ã€‚å› ä¸ºåœ¨ç›®å‰ Netty Mina ç­‰é€šä¿¡æ¡†æ¶ä¸­ï¼Œå‘é€è¯·æ±‚ä¸€èˆ¬æ˜¯å¼‚æ­¥çš„ï¼Œå› æ­¤åœ¨&nbsp;<code>ChannelHandler#sent(channel, message)</code>&nbsp;æ–¹æ³•ä¸­ï¼Œè°ƒç”¨&nbsp;<code>DefaultFuture#sent(channel, request)</code>&nbsp;<strong>é™æ€æ–¹æ³•</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sent</span><span class="params">(Channel channel, Request request)</span> </span>{</span><br /><span class="line">    DefaultFuture future = FUTURES.get(request.getId());</span><br /><span class="line">    <span class="keyword">if</span> (future != <span class="keyword">null</span>) {</span><br /><span class="line">        future.doSent();</span><br /><span class="line">    }</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doSent</span><span class="params">()</span> </span>{</span><br /><span class="line">    sent = System.currentTimeMillis();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>callback</code>&nbsp;å±æ€§ï¼Œå›è°ƒï¼Œé€‚ç”¨äºå¼‚æ­¥è¯·æ±‚ã€‚é€šè¿‡&nbsp;<code>#setCallback(callback)</code>&nbsp;æ–¹æ³•è®¾ç½®ã€‚</p>
</li>
</ul>
<p><strong>è·å¾—å€¼</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é”</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Lock lock = <span class="keyword">new</span> ReentrantLock();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å®Œæˆ Condition</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Condition done = lock.newCondition();</span><br /><br /><span class="line">  <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(<span class="keyword">int</span> timeout)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">  <span class="number">3</span>:     <span class="keyword">if</span> (timeout &lt;= <span class="number">0</span>) {</span><br /><span class="line">  <span class="number">4</span>:         timeout = Constants.DEFAULT_TIMEOUT;</span><br /><span class="line">  <span class="number">5</span>:     }</span><br /><span class="line">  <span class="number">6</span>:     <span class="comment">// è‹¥æœªå®Œæˆï¼Œç­‰å¾…</span></span><br /><span class="line">  <span class="number">7</span>:     <span class="keyword">if</span> (!isDone()) {</span><br /><span class="line">  <span class="number">8</span>:         <span class="keyword">long</span> start = System.currentTimeMillis();</span><br /><span class="line">  <span class="number">9</span>:         lock.lock();</span><br /><span class="line"> <span class="number">10</span>:         <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">11</span>:             <span class="comment">// ç­‰å¾…å®Œæˆæˆ–è¶…æ—¶</span></span><br /><span class="line"> <span class="number">12</span>:             <span class="keyword">while</span> (!isDone()) {</span><br /><span class="line"> <span class="number">13</span>:                 done.await(timeout, TimeUnit.MILLISECONDS);</span><br /><span class="line"> <span class="number">14</span>:                 <span class="keyword">if</span> (isDone() || System.currentTimeMillis() - start &gt; timeout) {</span><br /><span class="line"> <span class="number">15</span>:                     <span class="keyword">break</span>;</span><br /><span class="line"> <span class="number">16</span>:                 }</span><br /><span class="line"> <span class="number">17</span>:             }</span><br /><span class="line"> <span class="number">18</span>:         } <span class="keyword">catch</span> (InterruptedException e) {</span><br /><span class="line"> <span class="number">19</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br /><span class="line"> <span class="number">20</span>:         } <span class="keyword">finally</span> {</span><br /><span class="line"> <span class="number">21</span>:             lock.unlock();</span><br /><span class="line"> <span class="number">22</span>:         }</span><br /><span class="line"> <span class="number">23</span>:         <span class="comment">// æœªå®Œæˆï¼ŒæŠ›å‡ºè¶…æ—¶å¼‚å¸¸ TimeoutException</span></span><br /><span class="line"> <span class="number">24</span>:         <span class="keyword">if</span> (!isDone()) {</span><br /><span class="line"> <span class="number">25</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException(sent &gt; <span class="number">0</span>, channel, getTimeoutMessage(<span class="keyword">false</span>));</span><br /><span class="line"> <span class="number">26</span>:         }</span><br /><span class="line"> <span class="number">27</span>:     }</span><br /><span class="line"> <span class="number">28</span>:     <span class="comment">// è¿”å›å“åº”</span></span><br /><span class="line"> <span class="number">29</span>:     <span class="keyword">return</span> returnFromResponse();</span><br /><span class="line"> <span class="number">30</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 7 è¡Œï¼šè°ƒç”¨&nbsp;<code>#isDone()</code>&nbsp;æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å®Œæˆã€‚è‹¥æœªå®Œæˆï¼ŒåŸºäº Lock + Condition çš„æ–¹å¼ï¼Œå®ç°ç­‰å¾…ã€‚è€Œç­‰å¾…çš„å”¤é†’ï¼Œé€šè¿‡&nbsp;<code>ChannelHandler#received(channel, message)</code>&nbsp;æ–¹æ³•ï¼Œæ¥æ”¶åˆ°è¯·æ±‚æ—¶æ‰§è¡Œ&nbsp;<code>DefaultFuture#received(channel, response)</code>&nbsp;æ–¹æ³•ã€‚ğŸ™‚ ä¸‹æ–‡è¯¦ç»†è§£æã€‚
<ul>
<li><a href="https://blog.csdn.net/ghsau/article/details/7481142" target="_blank" rel="external nofollow noopener noreferrer">ã€Š Javaçº¿ç¨‹(ä¹)ï¼šCondition-çº¿ç¨‹é€šä¿¡æ›´é«˜æ•ˆçš„æ–¹å¼ã€‹</a></li>
<li><a href="http://www.importnew.com/9281.html" target="_blank" rel="external nofollow noopener noreferrer">ã€Šæ€ä¹ˆç†è§£Conditionã€‹</a></li>
<li>ç¬¬ 8 è¡Œï¼šè·å¾—å¼€å§‹æ—¶é—´ã€‚<strong>æ³¨æ„</strong>ï¼Œæ­¤å¤„ä½¿ç”¨çš„ä¸æ˜¯&nbsp;<code>start</code>&nbsp;å±æ€§ã€‚åé¢æˆ‘ä»¬ä¼šçœ‹åˆ°ï¼Œ<code>#get(...)</code>&nbsp;æ–¹æ³•ä¸­ï¼Œä½¿ç”¨çš„æ˜¯<strong>é‡æ–°</strong>è·å–å¼€å§‹æ—¶é—´ï¼›<strong>åå°æ‰«æè°ƒç”¨è¶…æ—¶ä»»åŠ¡</strong>ï¼Œä½¿ç”¨çš„æ˜¯&nbsp;<code>start</code>&nbsp;å±æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>#get(timeout)</code>&nbsp;æ–¹æ³•çš„&nbsp;<code>timeout</code>&nbsp;å‚æ•°ï¼ŒæŒ‡çš„æ˜¯ä»å½“å‰æ—¶åˆ»å¼€å§‹çš„<strong>ç­‰å¾…è¶…æ—¶</strong>æ—¶é—´ã€‚å½“ç„¶ï¼Œè¿™ä¸å½±å“æœ€ç»ˆçš„ç»“æœï¼Œæœ€ç»ˆ Response æ˜¯ä»€ä¹ˆï¼Œç”±æ˜¯&nbsp;<code>ChannelHandler#received(channel, message)</code>&nbsp;è¿˜æ˜¯<strong>åå°æ‰«æè°ƒç”¨è¶…æ—¶ä»»åŠ¡</strong>ï¼Œè°<strong>å…ˆè°ƒç”¨</strong><code>DefaultFuture#received(channel, response)</code>&nbsp;æ–¹æ³•å†³å®šã€‚ğŸ™‚ æœ‰ç‚¹ç»•ï¼Œèƒ–å‹ç»†çœ‹ä¸‹ã€‚</li>
<li>ç¬¬ 9 è¡Œï¼šè·å¾—é”ã€‚</li>
<li>ç¬¬ 11 è‡³ 17 è¡Œï¼šç­‰å¾…<strong>å®Œæˆ</strong>æˆ–<strong>è¶…æ—¶</strong>ã€‚</li>
<li>ç¬¬ 21 è¡Œï¼šé‡Šæ”¾é”ã€‚</li>
<li>ç¬¬ 24 è‡³ 26 è¡Œï¼šè‹¥æœªå®Œæˆï¼ŒæŠ›å‡ºè¶…æ—¶å¼‚å¸¸ TimeoutException ã€‚
<ul>
<li><code>TimeoutException.phase</code>&nbsp;çš„é˜¶æ®µï¼Œç”±&nbsp;<code>sent &gt; 0</code>&nbsp;æ¥å†³å®šï¼Œå³ Client æ˜¯å¦å‘é€ç»™ Server ã€‚</li>
<li><a href="https://github.com/apache/incubator-dubbo/blob/9deadadea3b1342345fed77c87a3d24ea026d7e6/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/support/DefaultFuture.java#L264-L275" target="_blank" rel="external nofollow noopener noreferrer"><code>#getTimeoutMessage(scan)</code></a>&nbsp;æ–¹æ³•ï¼Œè·å¾—è¶…æ—¶å¼‚å¸¸æç¤ºä¿¡æ¯ã€‚ğŸ™‚ èƒ–å‹è‡ªå·±çœ‹å“ˆã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ç¬¬ 29 è¡Œï¼šè°ƒç”¨&nbsp;<code>#returnFromResponse()</code>&nbsp;æ–¹æ³•ï¼Œè¿”å›å“åº”( Response )ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> Object <span class="title">returnFromResponse</span><span class="params">()</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    Response res = response;</span><br /><span class="line">    <span class="keyword">if</span> (res == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"response cannot be null"</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// æ­£å¸¸ï¼Œè¿”å›ç»“æœ</span></span><br /><span class="line">    <span class="keyword">if</span> (res.getStatus() == Response.OK) {</span><br /><span class="line">        <span class="keyword">return</span> res.getResult();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è¶…æ—¶ï¼ŒæŠ›å‡º TimeoutException å¼‚å¸¸</span></span><br /><span class="line">    <span class="keyword">if</span> (res.getStatus() == Response.CLIENT_TIMEOUT || res.getStatus() == Response.SERVER_TIMEOUT) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException(res.getStatus() == Response.SERVER_TIMEOUT, channel, res.getErrorMessage());</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// å…¶ä»–ï¼ŒæŠ›å‡º RemotingException å¼‚å¸¸</span></span><br /><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(channel, res.getErrorMessage());</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<p><strong>å“åº”ç»“æœ</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">received</span><span class="params">(Channel channel, Response response)</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">3</span>:         <span class="comment">// ç§»é™¤ FUTURES</span></span><br /><span class="line"> <span class="number">4</span>:         DefaultFuture future = FUTURES.remove(response.getId());</span><br /><span class="line"> <span class="number">5</span>:         <span class="comment">// æ¥æ”¶ç»“æœ</span></span><br /><span class="line"> <span class="number">6</span>:         <span class="keyword">if</span> (future != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">7</span>:             future.doReceived(response);</span><br /><span class="line"> <span class="number">8</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">9</span>:             logger.warn(<span class="string">"The timeout response finally returned at "</span></span><br /><span class="line"><span class="number">10</span>:                     + (<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss.SSS"</span>).format(<span class="keyword">new</span> Date()))</span><br /><span class="line"><span class="number">11</span>:                     + <span class="string">", response "</span> + response</span><br /><span class="line"><span class="number">12</span>:                     + (channel == <span class="keyword">null</span> ? <span class="string">""</span> : <span class="string">", channel: "</span> + channel.getLocalAddress()</span><br /><span class="line"><span class="number">13</span>:                     + <span class="string">" -&gt; "</span> + channel.getRemoteAddress()));</span><br /><span class="line"><span class="number">14</span>:         }</span><br /><span class="line"><span class="number">15</span>:     <span class="comment">// ç§»é™¤ CHANNELS</span></span><br /><span class="line"><span class="number">16</span>:     } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">17</span>:         CHANNELS.remove(response.getId());</span><br /><span class="line"><span class="number">18</span>:     }</span><br /><span class="line"><span class="number">19</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è¯¥æ–¹æ³•æœ‰ä¸¤å¤„è¢«è°ƒç”¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_12_10/05.png" alt="è°ƒç”¨" /></li>
<li>ç¬¬ 4 è¡Œï¼šç§»é™¤&nbsp;<code>FUTURES</code>&nbsp;ã€‚</li>
<li>
<p>ç¬¬ 6 è‡³ 7 è¡Œï¼šè°ƒç”¨&nbsp;<code>DefaultFuture#doReceived(response)</code>&nbsp;æ–¹æ³•ï¼Œå“åº”ç»“æœã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doReceived</span><span class="params">(Response res)</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// é”å®š</span></span><br /><span class="line"> <span class="number">3</span>:     lock.lock();</span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">5</span>:         <span class="comment">// è®¾ç½®ç»“æœ</span></span><br /><span class="line"> <span class="number">6</span>:         response = res;</span><br /><span class="line"> <span class="number">7</span>:         <span class="comment">// é€šçŸ¥ï¼Œå”¤é†’ç­‰å¾…</span></span><br /><span class="line"> <span class="number">8</span>:         <span class="keyword">if</span> (done != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">9</span>:             done.signal();</span><br /><span class="line"><span class="number">10</span>:         }</span><br /><span class="line"><span class="number">11</span>:     } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">12</span>:         <span class="comment">// é‡Šæ”¾é”å®š</span></span><br /><span class="line"><span class="number">13</span>:         lock.unlock();</span><br /><span class="line"><span class="number">14</span>:     }</span><br /><span class="line"><span class="number">15</span>:     <span class="comment">// è°ƒç”¨å›è°ƒ</span></span><br /><span class="line"><span class="number">16</span>:     <span class="keyword">if</span> (callback != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">17</span>:         invokeCallback(callback);</span><br /><span class="line"><span class="number">18</span>:     }</span><br /><span class="line"><span class="number">19</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šè·å¾—é”ã€‚</li>
<li>ç¬¬ 6 è¡Œï¼šè®¾ç½®å“åº”&nbsp;<code>response</code>&nbsp;ã€‚</li>
<li>ç¬¬ 8 è‡³ 10 è¡Œï¼šè°ƒç”¨&nbsp;<code>Condition#signal()</code>&nbsp;æ–¹æ³•ï¼Œé€šçŸ¥ï¼Œ<strong>å”¤é†’</strong>&nbsp;<code>DefaultFuture#get(..)</code>&nbsp;æ–¹æ³•çš„ç­‰å¾…ã€‚</li>
<li>ç¬¬ 13 è¡Œï¼šé‡Šæ”¾é”ã€‚</li>
<li>ç¬¬ 16 è‡³ 18 è¡Œï¼šè°ƒç”¨&nbsp;<code>#invokeCallback(callback)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œå›è°ƒæ–¹æ³•ã€‚</li>
</ul>
</li>
<li>
<p>ç¬¬ 8 è‡³ 14 è¡Œï¼šè¶…æ—¶æƒ…å†µï¼Œæ‰“å°<strong>å‘Šè­¦</strong>æ—¥å¿—ã€‚</p>
</li>
<li>ç¬¬ 15 è‡³ 18 è¡Œï¼šç§»é™¤&nbsp;<code>CHANNELS</code>&nbsp;ã€‚</li>
</ul>
<p><strong>è®¾ç½®å›è°ƒ</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCallback</span><span class="params">(ResponseCallback callback)</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// å·²å®Œæˆï¼Œè°ƒç”¨å›è°ƒ</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (isDone()) {</span><br /><span class="line"> <span class="number">5</span>:         invokeCallback(callback);</span><br /><span class="line"> <span class="number">6</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">7</span>:         <span class="keyword">boolean</span> isdone = <span class="keyword">false</span>;</span><br /><span class="line"> <span class="number">8</span>:         <span class="comment">// è·å¾—é”</span></span><br /><span class="line"> <span class="number">9</span>:         lock.lock();</span><br /><span class="line"><span class="number">10</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">11</span>:             <span class="comment">// æœªå®Œæˆï¼Œè®¾ç½®å›è°ƒ</span></span><br /><span class="line"><span class="number">12</span>:             <span class="keyword">if</span> (!isDone()) {</span><br /><span class="line"><span class="number">13</span>:                 <span class="keyword">this</span>.callback = callback;</span><br /><span class="line"><span class="number">14</span>:             } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">15</span>:                 isdone = <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">16</span>:             }</span><br /><span class="line"><span class="number">17</span>:         <span class="comment">// é‡Šæ”¾é”</span></span><br /><span class="line"><span class="number">18</span>:         } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">19</span>:             lock.unlock();</span><br /><span class="line"><span class="number">20</span>:         }</span><br /><span class="line"><span class="number">21</span>:         <span class="comment">// å·²å®Œæˆï¼Œè°ƒç”¨å›è°ƒ</span></span><br /><span class="line"><span class="number">22</span>:         <span class="keyword">if</span> (isdone) {</span><br /><span class="line"><span class="number">23</span>:             invokeCallback(callback);</span><br /><span class="line"><span class="number">24</span>:         }</span><br /><span class="line"><span class="number">25</span>:     }</span><br /><span class="line"><span class="number">26</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è‡³ 5 è¡Œï¼šè‹¥<strong>å·²å®Œæˆ</strong>ï¼Œè°ƒç”¨&nbsp;<code>#invokeCallback(callback)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œå›è°ƒæ–¹æ³•ã€‚</li>
<li>ç¬¬ 9 è¡Œï¼šè·å¾—é”ã€‚</li>
<li>ç¬¬ 12 è‡³ 13 è¡Œï¼šè‹¥<strong>æœªå®Œæˆ</strong>ï¼Œè®¾ç½®å›è°ƒ&nbsp;<code>callback</code>&nbsp;å±æ€§ï¼Œç­‰åœ¨&nbsp;<code>#doReceived(response)</code>&nbsp;æ–¹æ³•ä¸­<strong>å†å›è°ƒ</strong>ã€‚</li>
<li>ç¬¬ 14 è‡³ 16 è¡Œï¼šæ ‡è®°å·²å®Œæˆã€‚åœ¨ã€ç¬¬ 22 è‡³ 24 è¡Œã€‘ï¼Œè°ƒç”¨&nbsp;<code>#invokeCallback(callback)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡Œå›è°ƒæ–¹æ³•ã€‚</li>
<li>ç¬¬ 18 è‡³ 20 è¡Œï¼šé‡Šæ”¾é”ã€‚</li>
</ul>
<p><strong>è°ƒç”¨å›è°ƒ</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeCallback</span><span class="params">(ResponseCallback c)</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     ResponseCallback callbackCopy = c;</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (callbackCopy == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"callback cannot be null."</span>);</span><br /><span class="line"> <span class="number">5</span>:     }</span><br /><span class="line"> <span class="number">6</span>:     Response res = response;</span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (res == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">8</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"response cannot be null. url:"</span> + channel.getUrl());</span><br /><span class="line"> <span class="number">9</span>:     }</span><br /><span class="line"><span class="number">10</span>: </span><br /><span class="line"><span class="number">11</span>:     <span class="comment">// æ­£å¸¸ï¼Œå¤„ç†ç»“æœ</span></span><br /><span class="line"><span class="number">12</span>:     <span class="keyword">if</span> (res.getStatus() == Response.OK) {</span><br /><span class="line"><span class="number">13</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">14</span>:             callbackCopy.done(res.getResult());</span><br /><span class="line"><span class="number">15</span>:         } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line"><span class="number">16</span>:             logger.error(<span class="string">"callback invoke error .reasult:"</span> + res.getResult() + <span class="string">",url:"</span> + channel.getUrl(), e);</span><br /><span class="line"><span class="number">17</span>:         }</span><br /><span class="line"><span class="number">18</span>:     <span class="comment">// è¶…æ—¶ï¼Œå¤„ç† TimeoutException å¼‚å¸¸</span></span><br /><span class="line"><span class="number">19</span>:     } <span class="keyword">else</span> <span class="keyword">if</span> (res.getStatus() == Response.CLIENT_TIMEOUT || res.getStatus() == Response.SERVER_TIMEOUT) {</span><br /><span class="line"><span class="number">20</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">21</span>:             TimeoutException te = <span class="keyword">new</span> TimeoutException(res.getStatus() == Response.SERVER_TIMEOUT, channel, res.getErrorMessage());</span><br /><span class="line"><span class="number">22</span>:             callbackCopy.caught(te);</span><br /><span class="line"><span class="number">23</span>:         } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line"><span class="number">24</span>:             logger.error(<span class="string">"callback invoke error ,url:"</span> + channel.getUrl(), e);</span><br /><span class="line"><span class="number">25</span>:         }</span><br /><span class="line"><span class="number">26</span>:     <span class="comment">// å…¶ä»–ï¼Œå¤„ç† RemotingException å¼‚å¸¸</span></span><br /><span class="line"><span class="number">27</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">28</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">29</span>:             RuntimeException re = <span class="keyword">new</span> RuntimeException(res.getErrorMessage());</span><br /><span class="line"><span class="number">30</span>:             callbackCopy.caught(re);</span><br /><span class="line"><span class="number">31</span>:         } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line"><span class="number">32</span>:             logger.error(<span class="string">"callback invoke error ,url:"</span> + channel.getUrl(), e);</span><br /><span class="line"><span class="number">33</span>:         }</span><br /><span class="line"><span class="number">34</span>:     }</span><br /><span class="line"><span class="number">35</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å’Œ&nbsp;<code>#returnFromResponse()</code>&nbsp;æ–¹æ³•ï¼Œæƒ…å†µä¸€è‡´ã€‚</li>
<li>ç¬¬ 11 è‡³ 17 è¡Œï¼šæ­£å¸¸è¿”å›ï¼Œè°ƒç”¨&nbsp;<code>ResponseCallback#done(result)</code>&nbsp;æ–¹æ³•ï¼Œå¤„ç†ç»“æœã€‚</li>
<li>ç¬¬ 18 è‡³ 25 è¡Œï¼šè¶…æ—¶å¼‚å¸¸ï¼Œè°ƒç”¨&nbsp;<code>ResponseCallback#caught(e)</code>&nbsp;æ–¹æ³•ï¼Œå¤„ç† TimeoutException å¼‚å¸¸ã€‚</li>
<li>ç¬¬ 26 è‡³ 34 è¡Œï¼šå…¶ä»–å¼‚å¸¸ï¼Œè°ƒç”¨ ResponseCallback#caught(e)` æ–¹æ³•ï¼Œå¤„ç† RuntimeException å¼‚å¸¸ã€‚</li>
</ul>
<p><strong>åå°æ‰«æè°ƒç”¨è¶…æ—¶ä»»åŠ¡</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">static</span> {</span><br /><span class="line">    Thread th = <span class="keyword">new</span> Thread(<span class="keyword">new</span> RemotingInvocationTimeoutScan(), <span class="string">"DubboResponseTimeoutScanTimer"</span>);</span><br /><span class="line">    th.setDaemon(<span class="keyword">true</span>);</span><br /><span class="line">    th.start();</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">RemotingInvocationTimeoutScan</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>{</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) {</span><br /><span class="line">            <span class="keyword">try</span> {</span><br /><span class="line">                <span class="keyword">for</span> (DefaultFuture future : FUTURES.values()) {</span><br /><span class="line">                    <span class="comment">// å·²å®Œæˆï¼Œè·³è¿‡</span></span><br /><span class="line">                    <span class="keyword">if</span> (future == <span class="keyword">null</span> || future.isDone()) {</span><br /><span class="line">                        <span class="keyword">continue</span>;</span><br /><span class="line">                    }</span><br /><span class="line">                    <span class="comment">// è¶…æ—¶</span></span><br /><span class="line">                    <span class="keyword">if</span> (System.currentTimeMillis() - future.getStartTimestamp() &gt; future.getTimeout()) {</span><br /><span class="line">                        <span class="comment">// åˆ›å»ºè¶…æ—¶ Response</span></span><br /><span class="line">                        <span class="comment">// create exception response.</span></span><br /><span class="line">                        Response timeoutResponse = <span class="keyword">new</span> Response(future.getId());</span><br /><span class="line">                        <span class="comment">// set timeout status.</span></span><br /><span class="line">                        timeoutResponse.setStatus(future.isSent() ? Response.SERVER_TIMEOUT : Response.CLIENT_TIMEOUT);</span><br /><span class="line">                        timeoutResponse.setErrorMessage(future.getTimeoutMessage(<span class="keyword">true</span>));</span><br /><span class="line">                        <span class="comment">// å“åº”ç»“æœ</span></span><br /><span class="line">                        <span class="comment">// handle response.</span></span><br /><span class="line">                        DefaultFuture.received(future.getChannel(), timeoutResponse);</span><br /><span class="line">                    }</span><br /><span class="line">                }</span><br /><span class="line">                <span class="comment">// 30 ms</span></span><br /><span class="line">                Thread.sleep(<span class="number">30</span>);</span><br /><span class="line">            } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line">                logger.error(<span class="string">"Exception when scan the timeout invocation of remoting."</span>, e);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹ä»£ç å’Œæ³¨é‡Šå˜¿ã€‚</li>
</ul>
<hr />
<p>ä»£ç ç•¥å¤šï¼Œèƒ–å‹è‡ªå·±åœ¨æ¢³ç†æ¢³ç†ï¼Œä¹Ÿå¯ä»¥å¤šå¤šè°ƒè¯•ã€‚</p>
<h3 id="5-3-3-SimpleFuture">5.3.3 SimpleFuture</h3>
<p><a href="https://github.com/apache/incubator-dubbo/blob/9deadadea3b1342345fed77c87a3d24ea026d7e6/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/support/SimpleFuture.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.exchange.support.SimpleFuture</code></a>&nbsp;ï¼Œå®ç° ResponseFuture æ¥å£ï¼Œç®€å•çš„ Future å®ç°ã€‚</p>
<p>ç›®å‰æš‚æœªä½¿ç”¨ã€‚</p>
<h2 id="5-4-MultiMessage">5.4 MultiMessage</h2>
<p><code>com.alibaba.dubbo.remoting.exchange.support.MultiMessage</code>&nbsp;ï¼Œå®ç° Iterable æ¥å£ï¼Œå¤šæ¶ˆæ¯çš„å°è£…ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiMessage</span> <span class="keyword">implements</span> <span class="title">Iterable</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List messages = <span class="keyword">new</span> ArrayList();</span><br />    <br /><span class="line">    <span class="comment">// ... çœç•¥æ–¹æ³•</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="6-Handler">6. Handler</h1>
<p>åœ¨æ–‡åˆçš„ï¼Œæˆ‘ä»¬åœ¨ç±»å›¾å¯ä»¥çœ‹åˆ°ï¼Œæœ‰å¤šç§å¤„ç†å™¨ï¼Œç»Ÿä¸€åœ¨æœ¬å°èŠ‚åˆ†äº«ã€‚</p>
<h2 id="6-1-HeartbeatHandler">6.1 HeartbeatHandler</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/619cbe46350c8d0b97b84631c6518e4603a89aee/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/support/header/HeartbeatHandler.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.exchange.support.header.HeartbeatHandler</code></a>&nbsp;ï¼Œå®ç° AbstractChannelHandlerDelegate æŠ½è±¡ç±»ï¼Œ<strong>å¿ƒè·³å¤„ç†å™¨</strong>ï¼Œå¤„ç†å¿ƒè·³äº‹ä»¶ã€‚</p>
<blockquote>
<p>æ—ç™½å›ï¼Œæ³¨æ„ï¼Œå®ƒæ˜¯ä¸€ä¸ª AbstractChannelHandlerDelegate ï¼ï¼ï¼</p>
</blockquote>
<p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚</p>
<h3 id="6-1-1-HeartBeatTask">6.1.1 HeartBeatTask</h3>
<p><code>com.alibaba.dubbo.remoting.exchange.support.header.HeartBeatTask</code>&nbsp;ï¼Œå®ç° Runnable æ¥å£ï¼Œå¿ƒè·³ä»»åŠ¡ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> ChannelProvider channelProvider;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å¿ƒè·³é—´éš”ï¼Œå•ä½ï¼šæ¯«ç§’</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> heartbeat;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å¿ƒè·³è¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼šæ¯«ç§’</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> heartbeatTimeout;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>channelProvider</code>&nbsp;å±æ€§ï¼Œç”¨äºæŸ¥è¯¢è·å¾—éœ€è¦å¿ƒè·³çš„é€šé“æ•°ç»„ã€‚ChannelProvider æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">ChannelProvider</span> </span>{</span><br /><span class="line">    <span class="function">Collection&lt;Channel&gt; <span class="title">getChannels</span><span class="params">()</span></span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<p><strong>æ‰§è¡Œä»»åŠ¡</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">4</span>:         <span class="keyword">long</span> now = System.currentTimeMillis();</span><br /><span class="line"> <span class="number">5</span>:         <span class="keyword">for</span> (Channel channel : channelProvider.getChannels()) {</span><br /><span class="line"> <span class="number">6</span>:             <span class="keyword">if</span> (channel.isClosed()) {</span><br /><span class="line"> <span class="number">7</span>:                 <span class="keyword">continue</span>;</span><br /><span class="line"> <span class="number">8</span>:             }</span><br /><span class="line"> <span class="number">9</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">10</span>:                 Long lastRead = (Long) channel.getAttribute(HeaderExchangeHandler.KEY_READ_TIMESTAMP);</span><br /><span class="line"><span class="number">11</span>:                 Long lastWrite = (Long) channel.getAttribute(HeaderExchangeHandler.KEY_WRITE_TIMESTAMP);</span><br /><span class="line"><span class="number">12</span>:                 <span class="comment">// æœ€åè¯»å†™çš„æ—¶é—´ï¼Œä»»ä¸€è¶…è¿‡å¿ƒè·³é—´éš”ï¼Œå‘é€å¿ƒè·³</span></span><br /><span class="line"><span class="number">13</span>:                 <span class="keyword">if</span> ((lastRead != <span class="keyword">null</span> &amp;&amp; now - lastRead &gt; heartbeat)</span><br /><span class="line"><span class="number">14</span>:                         || (lastWrite != <span class="keyword">null</span> &amp;&amp; now - lastWrite &gt; heartbeat)) {</span><br /><span class="line"><span class="number">15</span>:                     Request req = <span class="keyword">new</span> Request();</span><br /><span class="line"><span class="number">16</span>:                     req.setVersion(<span class="string">"2.0.0"</span>);</span><br /><span class="line"><span class="number">17</span>:                     req.setTwoWay(<span class="keyword">true</span>); <span class="comment">// éœ€è¦å“åº”</span></span><br /><span class="line"><span class="number">18</span>:                     req.setEvent(Request.HEARTBEAT_EVENT);</span><br /><span class="line"><span class="number">19</span>:                     channel.send(req);</span><br /><span class="line"><span class="number">20</span>:                     <span class="keyword">if</span> (logger.isDebugEnabled()) {</span><br /><span class="line"><span class="number">21</span>:                         logger.debug(<span class="string">"Send heartbeat to remote channel "</span> + channel.getRemoteAddress()</span><br /><span class="line"><span class="number">22</span>:                                 + <span class="string">", cause: The channel has no data-transmission exceeds a heartbeat period: "</span> + heartbeat + <span class="string">"ms"</span>);</span><br /><span class="line"><span class="number">23</span>:                     }</span><br /><span class="line"><span class="number">24</span>:                 }</span><br /><span class="line"><span class="number">25</span>:                 <span class="comment">// æœ€åè¯»çš„æ—¶é—´ï¼Œè¶…è¿‡å¿ƒè·³è¶…æ—¶æ—¶é—´</span></span><br /><span class="line"><span class="number">26</span>:                 <span class="keyword">if</span> (lastRead != <span class="keyword">null</span> &amp;&amp; now - lastRead &gt; heartbeatTimeout) {</span><br /><span class="line"><span class="number">27</span>:                     logger.warn(<span class="string">"Close channel "</span> + channel</span><br /><span class="line"><span class="number">28</span>:                             + <span class="string">", because heartbeat read idle time out: "</span> + heartbeatTimeout + <span class="string">"ms"</span>);</span><br /><span class="line"><span class="number">29</span>:                     <span class="comment">// å®¢æˆ·ç«¯ä¾§ï¼Œé‡æ–°è¿æ¥æœåŠ¡ç«¯</span></span><br /><span class="line"><span class="number">30</span>:                     <span class="keyword">if</span> (channel <span class="keyword">instanceof</span> Client) {</span><br /><span class="line"><span class="number">31</span>:                         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">32</span>:                             ((Client) channel).reconnect();</span><br /><span class="line"><span class="number">33</span>:                         } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line"><span class="number">34</span>:                             <span class="comment">//do nothing</span></span><br /><span class="line"><span class="number">35</span>:                         }</span><br /><span class="line"><span class="number">36</span>:                     <span class="comment">// æœåŠ¡ç«¯ä¾§ï¼Œå…³é—­å®¢æˆ·ç«¯è¿æ¥</span></span><br /><span class="line"><span class="number">37</span>:                     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">38</span>:                         channel.close();</span><br /><span class="line"><span class="number">39</span>:                     }</span><br /><span class="line"><span class="number">40</span>:                 }</span><br /><span class="line"><span class="number">41</span>:             } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">42</span>:                 logger.warn(<span class="string">"Exception when heartbeat to remote channel "</span> + channel.getRemoteAddress(), t);</span><br /><span class="line"><span class="number">43</span>:             }</span><br /><span class="line"><span class="number">44</span>:         }</span><br /><span class="line"><span class="number">45</span>:     } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">46</span>:         logger.warn(<span class="string">"Unhandled exception when heartbeat, cause: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">47</span>:     }</span><br /><span class="line"><span class="number">48</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ã€ä»»åŠ¡ä¸€ã€‘ç¬¬ 13 è‡³ 24 è¡Œï¼šæœ€åè¯»æˆ–å†™çš„æ—¶é—´ï¼Œ<strong>ä»»ä¸€</strong>è¶…è¿‡å¿ƒè·³é—´éš”&nbsp;<code>heartbeat</code>&nbsp;ï¼Œ<strong>å‘é€å¿ƒè·³</strong>ã€‚</li>
<li>ã€ä»»åŠ¡äºŒã€‘ç¬¬ 25 è‡³ 40 è¡Œï¼šæœ€åè¯»çš„æ—¶é—´ï¼Œè¶…è¿‡å¿ƒè·³è¶…æ—¶æ—¶é—´&nbsp;<code>heartbeatTimeout</code>&nbsp;ï¼Œåˆ†æˆä¸¤ç§æƒ…å†µï¼š
<ul>
<li>ç¬¬ 29 è‡³ 35 è¡Œï¼š<strong>å®¢æˆ·ç«¯ä¾§</strong>ï¼Œé‡è¿è¿æ¥æœåŠ¡ç«¯ã€‚</li>
<li>ç¬¬ 36 è‡³ 39 è¡Œï¼š<strong>æœåŠ¡ç«¯ä¾§</strong>ï¼Œå…³é—­å®¢æˆ·ç«¯è¿æ¥ã€‚</li>
</ul>
</li>
</ul>
<h2 id="6-2-HeaderExchangeHandler">6.2 HeaderExchangeHandler</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/e24730a1dcfe8d5f1329377e80b1577724a85aac/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/support/header/HeaderExchangeHandler.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchangeHandler</code></a>ï¼Œå®ç° ChannelHandlerDelegate æ¥å£ï¼Œ<strong>åŸºäºæ¶ˆæ¯å¤´éƒ¨( Header )</strong>çš„ä¿¡æ¯äº¤æ¢å¤„ç†å™¨å®ç°ç±»ã€‚</p>
<blockquote>
<p>æ—ç™½å›ï¼Œæ³¨æ„ï¼Œå®ƒæ˜¯ä¸€ä¸ª ChannelHandlerDelegate ï¼ï¼ï¼</p>
</blockquote>
<p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ï¼Œæˆ‘ä»¬æŒ‘å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„æ¥è®²è®²ã€‚</p>
<p><strong>æ¥æ”¶æ¶ˆæ¯</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">received</span><span class="params">(Channel channel, Object message)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// è®¾ç½®æœ€åçš„è¯»æ—¶é—´</span></span><br /><span class="line"> <span class="number">4</span>:     channel.setAttribute(KEY_READ_TIMESTAMP, System.currentTimeMillis());</span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// åˆ›å»º ExchangeChannel å¯¹è±¡</span></span><br /><span class="line"> <span class="number">6</span>:     ExchangeChannel exchangeChannel = HeaderExchangeChannel.getOrAddChannel(channel);</span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">8</span>:         <span class="comment">// å¤„ç†è¯·æ±‚( Request )</span></span><br /><span class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (message <span class="keyword">instanceof</span> Request) {</span><br /><span class="line"><span class="number">10</span>:             <span class="comment">// handle request.</span></span><br /><span class="line"><span class="number">11</span>:             Request request = (Request) message;</span><br /><span class="line"><span class="number">12</span>:             <span class="comment">// å¤„ç†äº‹ä»¶è¯·æ±‚</span></span><br /><span class="line"><span class="number">13</span>:             <span class="keyword">if</span> (request.isEvent()) {</span><br /><span class="line"><span class="number">14</span>:                 handlerEvent(channel, request);</span><br /><span class="line"><span class="number">15</span>:             } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">16</span>:                 <span class="comment">// å¤„ç†æ™®é€šè¯·æ±‚</span></span><br /><span class="line"><span class="number">17</span>:                 <span class="keyword">if</span> (request.isTwoWay()) {</span><br /><span class="line"><span class="number">18</span>:                     Response response = handleRequest(exchangeChannel, request);</span><br /><span class="line"><span class="number">19</span>:                     channel.send(response);</span><br /><span class="line"><span class="number">20</span>:                 <span class="comment">// æäº¤ç»™è£…é¥°çš„ `handler`ï¼Œç»§ç»­å¤„ç†</span></span><br /><span class="line"><span class="number">21</span>:                 } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">22</span>:                     handler.received(exchangeChannel, request.getData());</span><br /><span class="line"><span class="number">23</span>:                 }</span><br /><span class="line"><span class="number">24</span>:             }</span><br /><span class="line"><span class="number">25</span>:         <span class="comment">// å¤„ç†å“åº”( Response )</span></span><br /><span class="line"><span class="number">26</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (message <span class="keyword">instanceof</span> Response) {</span><br /><span class="line"><span class="number">27</span>:             handleResponse(channel, (Response) message);</span><br /><span class="line"><span class="number">28</span>:         <span class="comment">// å¤„ç† String</span></span><br /><span class="line"><span class="number">29</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (message <span class="keyword">instanceof</span> String) {</span><br /><span class="line"><span class="number">30</span>:             <span class="comment">// å®¢æˆ·ç«¯ä¾§ï¼Œä¸æ”¯æŒ String</span></span><br /><span class="line"><span class="number">31</span>:             <span class="keyword">if</span> (isClientSide(channel)) {</span><br /><span class="line"><span class="number">32</span>:                 Exception e = <span class="keyword">new</span> Exception(<span class="string">"Dubbo client can not supported string message: "</span> + message + <span class="string">" in channel: "</span> + channel + <span class="string">", url: "</span> + channel.getUrl());</span><br /><span class="line"><span class="number">33</span>:                 logger.error(e.getMessage(), e);</span><br /><span class="line"><span class="number">34</span>:             <span class="comment">// æœåŠ¡ç«¯ä¾§ï¼Œç›®å‰æ˜¯ telnet å‘½ä»¤</span></span><br /><span class="line"><span class="number">35</span>:             } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">36</span>:                 String echo = handler.telnet(channel, (String) message);</span><br /><span class="line"><span class="number">37</span>:                 <span class="keyword">if</span> (echo != <span class="keyword">null</span> &amp;&amp; echo.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">38</span>:                     channel.send(echo);</span><br /><span class="line"><span class="number">39</span>:                 }</span><br /><span class="line"><span class="number">40</span>:             }</span><br /><span class="line"><span class="number">41</span>:             <span class="comment">// æäº¤ç»™è£…é¥°çš„ `handler`ï¼Œç»§ç»­å¤„ç†</span></span><br /><span class="line"><span class="number">42</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">43</span>:             handler.received(exchangeChannel, message);</span><br /><span class="line"><span class="number">44</span>:         }</span><br /><span class="line"><span class="number">45</span>:     } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">46</span>:         <span class="comment">// ç§»é™¤ ExchangeChannel å¯¹è±¡ï¼Œè‹¥å·²æ–­å¼€</span></span><br /><span class="line"><span class="number">47</span>:         HeaderExchangeChannel.removeChannelIfDisconnected(channel);</span><br /><span class="line"><span class="number">48</span>:     }</span><br /><span class="line"><span class="number">49</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 4 è¡Œï¼šè®¾ç½®æœ€åçš„<strong>è¯»æ—¶é—´</strong>ã€‚</li>
<li>ç¬¬ 6 è¡Œï¼šåˆ›å»º ExchangeChannel å¯¹è±¡ã€‚</li>
<li>ç¬¬ 8 è‡³ 24 è¡Œï¼šå¤„ç†è¯·æ±‚( Request)
<ul>
<li>ç¬¬ 13 è‡³ 14 è¡Œï¼šè°ƒç”¨&nbsp;<code>#handlerEvent(channel, request)</code>&nbsp;æ–¹æ³•ï¼Œå¤„ç†äº‹ä»¶è¯·æ±‚ã€‚</li>
<li>ç¬¬ 17 è‡³ 19 è¡Œï¼šè°ƒç”¨&nbsp;<code>#handleRequest(channel, request)</code>&nbsp;æ–¹æ³•ï¼Œå¤„ç†æ™®é€šè¯·æ±‚ï¼ˆéœ€è¦å“åº”ï¼‰ï¼Œå¹¶å°†å“åº”å†™å›è¯·æ±‚æ–¹ã€‚</li>
<li>ç¬¬ 21 è‡³ 23 è¡Œï¼šè°ƒç”¨&nbsp;<code>ChannelHandler#received(channel, message)</code>&nbsp;æ–¹æ³•ï¼Œå¤„ç†æ™®é€šè¯·æ±‚ï¼ˆæ— éœ€å“åº”ï¼‰ã€‚</li>
</ul>
</li>
<li>ç¬¬ 25 è‡³ 27 è¡Œï¼šè°ƒç”¨&nbsp;<code>#handleResponse(channel, message)</code>&nbsp;æ–¹æ³•ï¼Œå¤„ç†å“åº”ã€‚</li>
<li>ç¬¬ 29 è‡³ 41 è¡Œï¼šå¤„ç† String çš„æƒ…å†µ
<ul>
<li>ç¬¬ 30 è‡³ 33 è¡Œï¼šå®¢æˆ·ç«¯ä¾§ï¼Œä¸æ”¯æŒ String çš„æƒ…å†µã€‚</li>
<li>ç¬¬ 34 è‡³ 40 è¡Œï¼šæœåŠ¡ç«¯ä¾§ï¼Œç›®å‰ä»…æœ‰ telnet å‘½ä»¤çš„æƒ…å†µï¼Œè°ƒç”¨&nbsp;<code>TelnetHandler#telnet(channel, message)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— telnet å‘½ä»¤çš„ç»“æœï¼Œå¹¶å“åº”ç»™ telnet å®¢æˆ·ç«¯ã€‚åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-api-telnet/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ï¼ˆä¸‰ï¼‰ä¹‹ Telnet å±‚ã€‹</a>&nbsp;æœ‰è¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
</li>
<li>ç¬¬ 42 è‡³ 44 è¡Œï¼šå‰©ä½™çš„æƒ…å†µï¼Œè°ƒç”¨&nbsp;<code>ChannelHandler#received(channel, message)</code>&nbsp;æ–¹æ³•ï¼Œå¤„ç†ã€‚</li>
<li>ç¬¬ 45 è‡³ 48 è¡Œï¼šç§»é™¤ ExchangeChannel å¯¹è±¡ï¼Œè‹¥å·²æ–­å¼€ã€‚</li>
<li>
<p><code>#handlerEvent(channel, request)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">handlerEvent</span><span class="params">(Channel channel, Request req)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (req.getData() != <span class="keyword">null</span> &amp;&amp; req.getData().equals(Request.READONLY_EVENT)) {</span><br /><span class="line">        channel.setAttribute(Constants.CHANNEL_ATTRIBUTE_READONLY_KEY, Boolean.TRUE);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å®¢æˆ·ç«¯æ¥æ”¶åˆ° READONLY_EVENT äº‹ä»¶è¯·æ±‚ï¼Œè¿›è¡Œè®°å½•åˆ°é€šé“ã€‚åç»­ï¼Œä¸å†å‘è¯¥æœåŠ¡å™¨ï¼Œ<strong>å‘é€æ–°çš„è¯·æ±‚</strong>ã€‚</li>
</ul>
</li>
<li>
<p><code>#handleRequest(channel, request)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function">Response <span class="title">handleRequest</span><span class="params">(ExchangeChannel channel, Request req)</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     Response res = <span class="keyword">new</span> Response(req.getId(), req.getVersion());</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// è¯·æ±‚æ— æ³•è§£æï¼Œè¿”å› BAD_REQUEST å“åº”</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (req.isBroken()) {</span><br /><span class="line"> <span class="number">5</span>:         Object data = req.getData();</span><br /><span class="line"> <span class="number">6</span>:         String msg; <span class="comment">// è¯·æ±‚æ•°æ®ï¼Œè½¬æˆ msg</span></span><br /><span class="line"> <span class="number">7</span>:         <span class="keyword">if</span> (data == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">8</span>:             msg = <span class="keyword">null</span>;</span><br /><span class="line"> <span class="number">9</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (data <span class="keyword">instanceof</span> Throwable) {</span><br /><span class="line"><span class="number">10</span>:             msg = StringUtils.toString((Throwable) data);</span><br /><span class="line"><span class="number">11</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">12</span>:             msg = data.toString();</span><br /><span class="line"><span class="number">13</span>:         }</span><br /><span class="line"><span class="number">14</span>:         res.setErrorMessage(<span class="string">"Fail to decode request due to: "</span> + msg);</span><br /><span class="line"><span class="number">15</span>:         res.setStatus(Response.BAD_REQUEST);</span><br /><span class="line"><span class="number">16</span>:         <span class="keyword">return</span> res;</span><br /><span class="line"><span class="number">17</span>:     }</span><br /><span class="line"><span class="number">18</span>:     <span class="comment">// ä½¿ç”¨ ExchangeHandler å¤„ç†ï¼Œå¹¶è¿”å›å“åº”</span></span><br /><span class="line"><span class="number">19</span>:     <span class="comment">// find handler by message class.</span></span><br /><span class="line"><span class="number">20</span>:     Object msg = req.getData();</span><br /><span class="line"><span class="number">21</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">22</span>:         <span class="comment">// handle data.</span></span><br /><span class="line"><span class="number">23</span>:         Object result = handler.reply(channel, msg);</span><br /><span class="line"><span class="number">24</span>:         res.setStatus(Response.OK);</span><br /><span class="line"><span class="number">25</span>:         res.setResult(result);</span><br /><span class="line"><span class="number">26</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">27</span>:         res.setStatus(Response.SERVICE_ERROR);</span><br /><span class="line"><span class="number">28</span>:         res.setErrorMessage(StringUtils.toString(e));</span><br /><span class="line"><span class="number">29</span>:     }</span><br /><span class="line"><span class="number">30</span>:     <span class="keyword">return</span> res;</span><br /><span class="line"><span class="number">31</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è‡³ 17 è¡Œï¼šè¯·æ±‚<strong>æ— æ³•è§£æ</strong>ï¼Œè¿”å› BAD_REQUEST å“åº”ã€‚ä¸‹é¢ ExchangeCodec ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°å…·ä½“å‘ç”Ÿçš„ä»£ç ã€‚</li>
<li>ç¬¬ 18 è‡³ 30 è¡Œï¼šè°ƒç”¨&nbsp;<code>ExchangeHandler#reply(channel, message)</code>&nbsp;æ–¹æ³•ï¼Œè¿”å›ç»“æœï¼Œå¹¶è®¾ç½®åˆ°å“åº”( Response) æœ€ç»ˆè¿”å›ã€‚</li>
</ul>
</li>
<li>
<p><code>#handleResponse(channel, response)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">handleResponse</span><span class="params">(Channel channel, Response response)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (response != <span class="keyword">null</span> &amp;&amp; !response.isHeartbeat()) {</span><br /><span class="line">        DefaultFuture.received(channel, response);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>éå¿ƒè·³äº‹ä»¶å“åº”ï¼Œè°ƒç”¨&nbsp;<code>DefaultFuture#received(channel, response)</code>&nbsp;æ–¹æ³•ï¼Œå”¤é†’ç­‰å¾…è¯·æ±‚ç»“æœçš„çº¿ç¨‹ã€‚</li>
</ul>
</li>
</ul>
<p>ğŸ™‚ æ¯”è¾ƒç¹æ‚ï¼Œèƒ–å‹è€å¿ƒçš„çœ‹ä¸€çœ‹å“Ÿã€‚</p>
<p><strong>å‘ç”Ÿå¼‚å¸¸</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">caught</span><span class="params">(Channel channel, Throwable exception)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// å½“å‘ç”Ÿ ExecutionException å¼‚å¸¸ï¼Œè¿”å›å¼‚å¸¸å“åº”( Response )</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> ExecutionException) {</span><br /><span class="line"> <span class="number">5</span>:         ExecutionException e = (ExecutionException) exception;</span><br /><span class="line"> <span class="number">6</span>:         Object msg = e.getRequest();</span><br /><span class="line"> <span class="number">7</span>:         <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> Request) {</span><br /><span class="line"> <span class="number">8</span>:             Request req = (Request) msg;</span><br /><span class="line"> <span class="number">9</span>:             <span class="keyword">if</span> (req.isTwoWay() &amp;&amp; !req.isHeartbeat()) { <span class="comment">// éœ€è¦å“åº”ï¼Œå¹¶ä¸”éå¿ƒè·³æ—¶é—´</span></span><br /><span class="line"><span class="number">10</span>:                 Response res = <span class="keyword">new</span> Response(req.getId(), req.getVersion());</span><br /><span class="line"><span class="number">11</span>:                 res.setStatus(Response.SERVER_ERROR);</span><br /><span class="line"><span class="number">12</span>:                 res.setErrorMessage(StringUtils.toString(e));</span><br /><span class="line"><span class="number">13</span>:                 channel.send(res);</span><br /><span class="line"><span class="number">14</span>:                 <span class="keyword">return</span>;</span><br /><span class="line"><span class="number">15</span>:             }</span><br /><span class="line"><span class="number">16</span>:         }</span><br /><span class="line"><span class="number">17</span>:     }</span><br /><span class="line"><span class="number">18</span>:     <span class="comment">// åˆ›å»º ExchangeChannel å¯¹è±¡</span></span><br /><span class="line"><span class="number">19</span>:     ExchangeChannel exchangeChannel = HeaderExchangeChannel.getOrAddChannel(channel);</span><br /><span class="line"><span class="number">20</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">21</span>:         <span class="comment">// æäº¤ç»™è£…é¥°çš„ `handler`ï¼Œç»§ç»­å¤„ç†</span></span><br /><span class="line"><span class="number">22</span>:         handler.caught(exchangeChannel, exception);</span><br /><span class="line"><span class="number">23</span>:     } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">24</span>:         <span class="comment">// ç§»é™¤ ExchangeChannel å¯¹è±¡ï¼Œè‹¥å·²æ–­å¼€</span></span><br /><span class="line"><span class="number">25</span>:         HeaderExchangeChannel.removeChannelIfDisconnected(channel);</span><br /><span class="line"><span class="number">26</span>:     }</span><br /><span class="line"><span class="number">27</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ç¬¬ 3 è‡³ 17 è¡Œï¼šå½“å‘ç”Ÿ ExecutionException å¼‚å¸¸ï¼Œè¿”å›å¼‚å¸¸å“åº”( Response )ã€‚ç›®å‰ä¼šå‘ç”Ÿ ExecutionException çš„æƒ…å†µï¼Œå¹¶ä¸”ç¬¦åˆæäº¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_12_10/06.png" alt="ExecutionException" /></p>
</li>
<li>
<p>ç¬¬ 18 è‡³ 26 è¡Œï¼šè§æ³¨é‡Šã€‚</p>
</li>
</ul>
<h2 id="6-3-ExchangeHandler">6.3 ExchangeHandler</h2>
<p><code>com.alibaba.dubbo.remoting.exchange.ExchangeHandler</code>&nbsp;ï¼Œç»§æ‰¿ ChannelHandler å’Œ TelnetHandler æ¥å£ï¼Œä¿¡æ¯äº¤æ¢å¤„ç†å™¨<strong>æ¥å£</strong>ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// å›å¤è¯·æ±‚ç»“æœ</span></span><br /><span class="line"><span class="function">Object <span class="title">reply</span><span class="params">(ExchangeChannel channel, Object request)</span> <span class="keyword">throws</span> RemotingException</span>;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><strong>æ³¨æ„</strong>ï¼Œè¿”å›çš„æ˜¯<strong>è¯·æ±‚ç»“æœ</strong>ã€‚æ­£å¦‚æˆ‘ä»¬åœ¨ä¸Šæ–‡çœ‹åˆ°çš„ï¼Œå°†è¯·æ±‚ç»“æœï¼Œè®¾ç½®åˆ°&nbsp;<code>Response.mResult</code>&nbsp;å±æ€§ä¸­ã€‚</li>
</ul>
<p>ExchangeHandler æ˜¯ä¸€ä¸ªéå¸¸å…³é”®çš„æ¥å£ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Œç‚¹å‡»&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/619cbe46350c8d0b97b84631c6518e4603a89aee/dubbo-rpc/dubbo-rpc-default/src/main/java/com/alibaba/dubbo/rpc/protocol/dubbo/DubboProtocol.java#L82-L112" target="_blank" rel="external nofollow noopener noreferrer"><code>DubboProtocol. requestHandler</code></a>&nbsp;ï¼èƒ–å‹ï¼Œé¢†æ‚Ÿåˆ°äº†ä¹ˆï¼Ÿå¦‚æœæ²¡æœ‰ï¼Œæ·¡å®šï¼Œåé¢æˆ‘ä»¬ä¼šæœ‰æ–‡ç« åˆ†äº«ã€‚</p>
<h3 id="6-3-1-ExchangeHandlerAdapter">6.3.1 ExchangeHandlerAdapter</h3>
<p><code>com.alibaba.dubbo.remoting.exchange.support.ExchangeHandlerAdapter</code>&nbsp;ï¼Œå®ç° ExchangeHandler æ¥å£ï¼Œç»§æ‰¿ TelnetHandlerAdapter æŠ½è±¡ç±»ï¼Œä¿¡æ¯äº¤æ¢å¤„ç†å™¨é€‚é…å™¨<strong>æŠ½è±¡ç±»</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">reply</span><span class="params">(ExchangeChannel channel, Object msg)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>åœ¨ DubboProtocol ã€ThirftProtocol ä¸­ï¼Œéƒ½ä¼šåŸºäº ExchangeHandlerAdapter&nbsp;<strong>å®ç°è‡ªå·±çš„å¤„ç†å™¨</strong>ï¼Œå¤„ç†è¯·æ±‚ï¼Œè¿”å›ç»“æœã€‚</p>
<h2 id="6-4-Replier">6.4 Replier</h2>
<blockquote>
<p>å‹æƒ…æç¤ºï¼šè¿™ä¸ªå°èŠ‚ï¼Œèƒ–å‹å¯ä»¥é€‰æ‹©æ€§æ¥çœ‹ï¼Œç›®å‰ä»…ç”¨äº&nbsp;<code>dubbo-remoting-p2p</code>&nbsp;æ¨¡å—ä¸­ã€‚</p>
</blockquote>
<p>åœ¨ ExchangeHandler ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°çš„æ˜¯ï¼ŒRequest å¯¹åº”ç»Ÿä¸€çš„ ExchangeHandler å®ç°çš„å¯¹è±¡ã€‚ä½†æ˜¯åœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›å®ç°ï¼Œä¸åŒçš„æ•°æ®ç±»å‹ï¼Œå¯¹åº”ä¸åŒçš„å¤„ç†å™¨ã€‚Replier å°±æ˜¯æ¥å¤„ç†è¿™ç§æƒ…å†µçš„ã€‚ä¸€ä¸ªæ•°æ®ç±»å‹ï¼Œå¯¹åº”ä¸€ä¸ª Replier å¯¹è±¡ã€‚</p>
<p><code>com.alibaba.dubbo.remoting.exchange.support.Replier</code>&nbsp;ï¼Œå›å¤è€…æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Replier</span>&lt;<span class="title">T</span>&gt; </span>{</span><br /><br /><span class="line">    <span class="comment">// å›å¤è¯·æ±‚ç»“æœ</span></span><br /><span class="line">    <span class="function">Object <span class="title">reply</span><span class="params">(ExchangeChannel channel, T request)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å’Œ ExchangeHandler æœ€å¤§çš„ä¸åŒæ˜¯ï¼Œä½¿ç”¨çš„æ˜¯<strong>æ³›å‹ T</strong>ï¼Œè€Œä¸æ˜¯å›ºå®šçš„ Request ã€‚</li>
</ul>
<h3 id="6-4-1-ReplierDispatcher">6.4.1 ReplierDispatcher</h3>
<p><code>com.alibaba.dubbo.remoting.exchange.support.ReplierDispatcher</code>&nbsp;ï¼Œå®ç° Replier æ¥å£ï¼Œå›å¤è€…<strong>è°ƒåº¦å™¨</strong>å®ç°ç±»ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é»˜è®¤å›å¤è€…</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Replier&lt;?&gt; defaultReplier;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å›å¤è€…é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * keyï¼šç±»</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Class&lt;?&gt;, Replier&lt;?&gt;&gt; repliers = <span class="keyword">new</span> ConcurrentHashMap&lt;Class&lt;?&gt;, Replier&lt;?&gt;&gt;();</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReplierDispatcher</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>(<span class="keyword">null</span>, <span class="keyword">null</span>);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReplierDispatcher</span><span class="params">(Replier&lt;?&gt; defaultReplier)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>(defaultReplier, <span class="keyword">null</span>);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReplierDispatcher</span><span class="params">(Replier&lt;?&gt; defaultReplier, Map&lt;Class&lt;?&gt;, Replier&lt;?&gt;&gt; repliers)</span> </span>{</span><br /><span class="line">    <span class="comment">// ... çœç•¥</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>repliers</code>&nbsp;å±æ€§ï¼Œå›å¤è€…é›†åˆã€‚å¯é€šè¿‡&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/c63ec335b776a386a215fa3662b575ece7d32c5e/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/support/ReplierDispatcher.java#L49-L52" target="_blank" rel="external nofollow noopener noreferrer"><code>#addReplier(Class&lt;T&gt; type, Replier&lt;T&gt; replier)</code></a>&nbsp;æˆ–&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/c63ec335b776a386a215fa3662b575ece7d32c5e/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/support/ReplierDispatcher.java#L54-L57" target="_blank" rel="external nofollow noopener noreferrer"><code>#removeReplier(Class&lt;T&gt; type)</code></a>&nbsp;æ–¹æ³•ï¼Œæ·»åŠ æˆ–ç§»é™¤å›å¤è€…ã€‚</li>
</ul>
<p><strong>å›å¤è¯·æ±‚ç»“æœ</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="meta">@SuppressWarnings</span>({<span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span>})</span><br /><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">reply</span><span class="params">(ExchangeChannel channel, Object request)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    <span class="keyword">return</span> ((Replier) getReplier(request.getClass())).reply(channel, request);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è°ƒç”¨&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/c63ec335b776a386a215fa3662b575ece7d32c5e/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/support/ReplierDispatcher.java#L59-L69" target="_blank" rel="external nofollow noopener noreferrer"><code>#getReplier(Class&lt;?&gt; type)</code></a>&nbsp;æ–¹æ³•ï¼Œè·å¾—å›å¤è€…å¯¹è±¡ã€‚</li>
<li>è°ƒç”¨&nbsp;<code>Repiler#reply(channel, request)</code>&nbsp;æ–¹æ³•ï¼Œå›å¤è¯·æ±‚ç»“æœã€‚</li>
</ul>
<h3 id="6-4-2-ExchangeHandlerDispatcher">6.4.2 ExchangeHandlerDispatcher</h3>
<p><code>com.alibaba.dubbo.remoting.exchange.support.ExchangeHandlerDispatcher</code>&nbsp;ï¼Œå®ç° ExchangeHandler æ¥å£ï¼Œä¿¡æ¯äº¤æ¢å¤„ç†å™¨<strong>è°ƒåº¦å™¨</strong>å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å›å¤è€…è°ƒåº¦å™¨</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReplierDispatcher replierDispatcher;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é€šé“å¤„ç†å™¨é›†åˆ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelHandlerDispatcher handlerDispatcher;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Telnet å‘½ä»¤å¤„ç†å™¨</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> TelnetHandler telnetHandler;</span><br /><br /><span class="line"><span class="comment">// ... çœç•¥æ–¹æ³•</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>é€šè¿‡ ExchangeHandlerDispatcher ï¼Œå°† ReplierDispatcher + ChannelHandlerDispatcher + TelnetHandler ä¸‰è€…ç»“åˆåœ¨ä¸€èµ·ï¼Œå°†å¯¹åº”çš„äº‹ä»¶ï¼Œè°ƒåº¦åˆ°<strong>åˆé€‚çš„</strong>å¤„ç†å™¨ã€‚ä»¥&nbsp;<code>#reply(...)</code>&nbsp;<code>#received(...)</code>&nbsp;<code>#telnet(...)</code>&nbsp;æ–¹æ³•ï¼Œä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="meta">@SuppressWarnings</span>({<span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span>})</span><br /><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">reply</span><span class="params">(ExchangeChannel channel, Object request)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    <span class="keyword">return</span> replierDispatcher.reply(channel, request);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">received</span><span class="params">(Channel channel, Object message)</span> </span>{</span><br /><span class="line">    handlerDispatcher.received(channel, message);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">telnet</span><span class="params">(Channel channel, String message)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    <span class="keyword">return</span> telnetHandler.telnet(channel, message);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<h1 id="7-Exchanger">7. Exchanger</h1>
<p><code>com.alibaba.dubbo.remoting.exchange.Exchanger</code>&nbsp;ï¼Œ<strong>æ•°æ®äº¤æ¢è€…</strong>æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>Exchanger å’Œ Transporter ç±»ä¼¼ã€‚</p>
</blockquote>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@SPI</span>(HeaderExchanger.NAME)</span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Exchanger</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * bind.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * ç»‘å®šä¸€ä¸ªæœåŠ¡å™¨</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> url server url</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler æ•°æ®äº¤æ¢å¤„ç†å™¨</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> message server æœåŠ¡å™¨</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="meta">@Adaptive</span>({Constants.EXCHANGER_KEY})</span><br /><span class="line">    <span class="function">ExchangeServer <span class="title">bind</span><span class="params">(URL url, ExchangeHandler handler)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * connect.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * è¿æ¥ä¸€ä¸ªæœåŠ¡å™¨ï¼Œå³åˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> url server url æœåŠ¡å™¨åœ°å€</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler æ•°æ®äº¤æ¢å¤„ç†å™¨</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> message channel å®¢æˆ·ç«¯</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="meta">@Adaptive</span>({Constants.EXCHANGER_KEY})</span><br /><span class="line">    <span class="function">ExchangeClient <span class="title">connect</span><span class="params">(URL url, ExchangeHandler handler)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>@SPI(HeaderExchanger.NAME)</code>&nbsp;æ³¨è§£ï¼ŒDubbo SPI&nbsp;<strong>æ‹“å±•ç‚¹</strong>ï¼Œé»˜è®¤ä¸º&nbsp;<code>"header"</code>ï¼Œå³ HeaderExchanger ã€‚</li>
<li><code>@Adaptive({Constants.EXCHANGER_KEY})</code>&nbsp;æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Server å®ç°ï¼Œä½¿ç”¨&nbsp;<code>URL.exchanger</code>&nbsp;å±æ€§ã€‚</li>
<li><code>@Adaptive({Constants.EXCHANGER_KEY})</code>&nbsp;æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Client å®ç°ï¼Œä½¿ç”¨&nbsp;<code>URL.exchanger</code>&nbsp;å±æ€§ã€‚</li>
</ul>
<h2 id="7-1-HeaderExchanger">7.1 HeaderExchanger</h2>
<p><code>com.alibaba.dubbo.remoting.exchange.support.header.HeaderExchanger</code>&nbsp;ï¼Œå®ç° Exchanger æ¥å£ï¼ŒåŸºäºæ¶ˆæ¯å¤´éƒ¨( Header )çš„<strong>ä¿¡æ¯äº¤æ¢è€…</strong>å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeaderExchanger</span> <span class="keyword">implements</span> <span class="title">Exchanger</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">"header"</span>;</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> ExchangeClient <span class="title">connect</span><span class="params">(URL url, ExchangeHandler handler)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HeaderExchangeClient(Transporters.connect(url, <span class="keyword">new</span> DecodeHandler(<span class="keyword">new</span> HeaderExchangeHandler(handler))), <span class="keyword">true</span>);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> ExchangeServer <span class="title">bind</span><span class="params">(URL url, ExchangeHandler handler)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HeaderExchangeServer(Transporters.bind(url, <span class="keyword">new</span> DecodeHandler(<span class="keyword">new</span> HeaderExchangeHandler(handler))));</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä»¥&nbsp;<code>#connect(...)</code>&nbsp;æ–¹æ³•ä¸¾ä¾‹å­ã€‚
<ul>
<li>é€šè¿‡&nbsp;<code>Transporters#connect(url, handler)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºé€šä¿¡ Client ï¼Œå†…åµŒåˆ° HeaderExchangeClient ä¸­ã€‚</li>
<li>ä¼ å…¥çš„&nbsp;<code>handler</code>&nbsp;å¤„ç†å™¨ï¼Œå†…åµŒåˆ° HeaderExchangeHandler ï¼Œå†è¿›ä¸€æ­¥å†…åµŒåˆ° DecodeHandler ä¸­ã€‚æ‰€ä»¥ï¼Œå¤„ç†å™¨çš„é¡ºåºæ˜¯ï¼šDecodeHandler =&gt; HeaderExchangeHandler =&gt; ExchangeHandler(&nbsp;<code>handler</code>&nbsp;) ã€‚</li>
</ul>
</li>
</ul>
<h2 id="7-2-Exchangers">7.2 Exchangers</h2>
<blockquote>
<p>Exchangers å’Œ Transporters ç±»ä¼¼ã€‚</p>
</blockquote>
<p><a href="https://github.com/YunaiV/dubbo/blob/e24730a1dcfe8d5f1329377e80b1577724a85aac/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/Exchangers.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.Transporters</code></a>&nbsp;ï¼Œæ•°æ®äº¤æ¢è€…é—¨é¢ç±»ï¼Œå‚è§ Facade è®¾è®¡æ¨¡å¼ã€‚</p>
<p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹åˆ—ã€‚</p>
<h1 id="8-ExchangeCodec">8. ExchangeCodec</h1>
<p>èƒ–å‹ï¼Œæ‰“èµ·ç²¾ç¥ï¼ŒExchangeCodec éå¸¸é‡è¦ã€‚</p>
<p><code>com.alibaba.dubbo.remoting.exchange.codec.ExchangeCodec</code>&nbsp;ï¼Œç»§æ‰¿ TelnetCodec ç±»ï¼Œä¿¡æ¯äº¤æ¢ç¼–è§£ç å™¨ã€‚</p>
<p>åœ¨çœ‹å…·ä½“çš„ç¼–è§£ç æ–¹æ³•çš„ä»£ç æ—¶ï¼Œæˆ‘ä»¬æ¥å…ˆçœ‹ä¸€å¹…å›¾ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_12_10/07.png" alt="åè®®" /></p>
<ul>
<li>åŸºäº<strong>æ¶ˆæ¯é•¿åº¦</strong>çš„æ–¹å¼ï¼Œåšæ¯æ¡æ¶ˆæ¯çš„<strong>ç²˜åŒ…æ‹†åŒ…</strong>å¤„ç†ã€‚å’Œæˆ‘ä»¬åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-api-transport/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ï¼ˆäºŒï¼‰ä¹‹ Transport å±‚ã€‹</a>&nbsp;ä¸­ï¼Œçœ‹åˆ° Telnet åè®®ï¼ŒåŸºäº<strong>ç‰¹å®šå­—ç¬¦</strong>çš„æ–¹å¼ï¼Œåšæ¯æ¡å‘½ä»¤çš„<strong>ç²˜åŒ…æ‹†åŒ…</strong>å¤„ç†<strong>ä¸åŒ</strong>ã€‚</li>
<li>Header éƒ¨åˆ†ï¼Œåè®®å¤´ï¼Œé€šè¿‡ Codec ç¼–è§£ç ã€‚Bits ä½å¦‚ä¸‹ï¼š
<ul>
<li><code>[0, 15]</code>ï¼šMagic Number</li>
<li><code>[16, 20]</code>ï¼šSerialization ç¼–å·ã€‚</li>
<li><code>[21]</code>ï¼š<code>event</code>&nbsp;æ˜¯å¦ä¸ºäº‹ä»¶ã€‚</li>
<li><code>[22]</code>ï¼š<code>twoWay</code>&nbsp;æ˜¯å¦éœ€è¦å“åº”ã€‚</li>
<li><code>[23]</code>ï¼šæ˜¯è¯·æ±‚è¿˜æ˜¯å“åº”ã€‚</li>
<li><code>[24 - 31]</code>ï¼š<code>status</code>&nbsp;çŠ¶æ€ã€‚</li>
<li><code>[32 - 95]</code>ï¼š<code>id</code>&nbsp;ç¼–å·ï¼ŒLong å‹ã€‚</li>
<li><code>[96 - 127]</code>ï¼šBody çš„<strong>é•¿åº¦</strong>ã€‚é€šè¿‡è¯¥é•¿åº¦ï¼Œè¯»å– Body ã€‚</li>
</ul>
</li>
<li>Body éƒ¨åˆ†ï¼Œåè®®ä½“ï¼Œé€šè¿‡ Serialization åºåˆ—åŒ–/ååºåˆ—åŒ–ã€‚</li>
</ul>
<p><strong>å±æ€§</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// header length.</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> HEADER_LENGTH = <span class="number">16</span>;</span><br /><span class="line"><span class="comment">// magic header.</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">short</span> MAGIC = (<span class="keyword">short</span>) <span class="number">0xdabb</span>;</span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> MAGIC_HIGH = Bytes.short2bytes(MAGIC)[<span class="number">0</span>];</span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> MAGIC_LOW = Bytes.short2bytes(MAGIC)[<span class="number">1</span>];</span><br /><span class="line"><span class="comment">// message flag.</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> FLAG_REQUEST = (<span class="keyword">byte</span>) <span class="number">0x80</span>; <span class="comment">// 128</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> FLAG_TWOWAY = (<span class="keyword">byte</span>) <span class="number">0x40</span>; <span class="comment">// 64</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> FLAG_EVENT = (<span class="keyword">byte</span>) <span class="number">0x20</span>; <span class="comment">// 32</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SERIALIZATION_MASK = <span class="number">0x1f</span>; <span class="comment">// 31</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>HEADER_LENGTH</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼ŒHeader æ€»é•¿åº¦ï¼Œ16 Bytes = 128 Bits ã€‚</li>
<li>å…¶å®ƒ<strong>é™æ€</strong>å±æ€§ï¼Œèƒ–å‹å¯¹ç…§ä¸Šé¢çš„ Bits ä½ã€‚</li>
</ul>
<p><strong>ç¼–ç </strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(Channel channel, ChannelBuffer buffer, Object msg)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> Request) { <span class="comment">// è¯·æ±‚</span></span><br /><span class="line"> <span class="number">4</span>:         encodeRequest(channel, buffer, (Request) msg);</span><br /><span class="line"> <span class="number">5</span>:     } <span class="keyword">else</span> <span class="keyword">if</span> (msg <span class="keyword">instanceof</span> Response) { <span class="comment">// å“åº”</span></span><br /><span class="line"> <span class="number">6</span>:         encodeResponse(channel, buffer, (Response) msg);</span><br /><span class="line"> <span class="number">7</span>:     } <span class="keyword">else</span> { <span class="comment">// æäº¤ç»™çˆ¶ç±»( Telnet ) å¤„ç†ï¼Œç›®å‰æ˜¯ Telnet å‘½ä»¤çš„ç»“æœã€‚</span></span><br /><span class="line"> <span class="number">8</span>:         <span class="keyword">super</span>.encode(channel, buffer, msg);</span><br /><span class="line"> <span class="number">9</span>:     }</span><br /><span class="line"><span class="number">10</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è‡³ 4 è¡Œï¼šè°ƒç”¨&nbsp;<code>#encodeRequest(channel, buffer, request)</code>&nbsp;æ–¹æ³•ï¼Œç¼–ç è¯·æ±‚ã€‚</li>
<li>ç¬¬ 5 è‡³ 6 è¡Œï¼šè°ƒç”¨&nbsp;<code>#encodeResponse(channel, buffer, response)</code>&nbsp;æ–¹æ³•ï¼Œç¼–ç å“åº”ã€‚</li>
<li>ç¬¬ 7 è‡³ 9 è¡Œï¼šè°ƒç”¨&nbsp;<code>TelnetCodec#encode(channel, buffer, msg)</code>&nbsp;æ–¹æ³•ï¼Œç¼–ç  Telnet å‘½ä»¤çš„ç»“æœã€‚</li>
<li>
<p><code>#encodeRequest(channel, buffer, request)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encodeRequest</span><span class="params">(Channel channel, ChannelBuffer buffer, Request req)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line"> <span class="number">2</span>:     Serialization serialization = getSerialization(channel);</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// `[0, 15]`ï¼šMagic Number</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// header.</span></span><br /><span class="line"> <span class="number">5</span>:     <span class="keyword">byte</span>[] header = <span class="keyword">new</span> <span class="keyword">byte</span>[HEADER_LENGTH];</span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// set magic number.</span></span><br /><span class="line"> <span class="number">7</span>:     Bytes.short2bytes(MAGIC, header);</span><br /><span class="line"> <span class="number">8</span>: </span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// `[16, 20]`ï¼šSerialization ç¼–å· &amp;&amp; `[23]`ï¼šè¯·æ±‚ã€‚</span></span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// set request and serialization flag.</span></span><br /><span class="line"><span class="number">11</span>:     header[<span class="number">2</span>] = (<span class="keyword">byte</span>) (FLAG_REQUEST | serialization.getContentTypeId());</span><br /><span class="line"><span class="number">12</span>: </span><br /><span class="line"><span class="number">13</span>:     <span class="comment">// `[21]`ï¼š`event` æ˜¯å¦ä¸ºäº‹ä»¶ã€‚</span></span><br /><span class="line"><span class="number">14</span>:     <span class="keyword">if</span> (req.isTwoWay()) header[<span class="number">2</span>] |= FLAG_TWOWAY;</span><br /><span class="line"><span class="number">15</span>:     <span class="comment">// `[22]`ï¼š`twoWay` æ˜¯å¦éœ€è¦å“åº”ã€‚</span></span><br /><span class="line"><span class="number">16</span>:     <span class="keyword">if</span> (req.isEvent()) header[<span class="number">2</span>] |= FLAG_EVENT;</span><br /><span class="line"><span class="number">17</span>: </span><br /><span class="line"><span class="number">18</span>:     <span class="comment">// `[32 - 95]`ï¼š`id` ç¼–å·ï¼ŒLong å‹ã€‚</span></span><br /><span class="line"><span class="number">19</span>:     <span class="comment">// set request id.</span></span><br /><span class="line"><span class="number">20</span>:     Bytes.long2bytes(req.getId(), header, <span class="number">4</span>);</span><br /><span class="line"><span class="number">21</span>: </span><br /><span class="line"><span class="number">22</span>:     <span class="comment">// ç¼–ç  `Request.data` åˆ° Body ï¼Œå¹¶å†™å…¥åˆ° Buffer</span></span><br /><span class="line"><span class="number">23</span>:     <span class="comment">// encode request data.</span></span><br /><span class="line"><span class="number">24</span>:     <span class="keyword">int</span> savedWriteIndex = buffer.writerIndex();</span><br /><span class="line"><span class="number">25</span>:     buffer.writerIndex(savedWriteIndex + HEADER_LENGTH);</span><br /><span class="line"><span class="number">26</span>:     ChannelBufferOutputStream bos = <span class="keyword">new</span> ChannelBufferOutputStream(buffer);</span><br /><span class="line"><span class="number">27</span>:     ObjectOutput out = serialization.serialize(channel.getUrl(), bos); <span class="comment">// åºåˆ—åŒ– Output</span></span><br /><span class="line"><span class="number">28</span>:     <span class="keyword">if</span> (req.isEvent()) {</span><br /><span class="line"><span class="number">29</span>:         encodeEventData(channel, out, req.getData());</span><br /><span class="line"><span class="number">30</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">31</span>:         encodeRequestData(channel, out, req.getData());</span><br /><span class="line"><span class="number">32</span>:     }</span><br /><span class="line"><span class="number">33</span>:     <span class="comment">// é‡Šæ”¾èµ„æº</span></span><br /><span class="line"><span class="number">34</span>:     out.flushBuffer();</span><br /><span class="line"><span class="number">35</span>:     <span class="keyword">if</span> (out <span class="keyword">instanceof</span> Cleanable) {</span><br /><span class="line"><span class="number">36</span>:         ((Cleanable) out).cleanup();</span><br /><span class="line"><span class="number">37</span>:     }</span><br /><span class="line"><span class="number">38</span>:     bos.flush();</span><br /><span class="line"><span class="number">39</span>:     bos.close();</span><br /><span class="line"><span class="number">40</span>:     <span class="comment">// æ£€æŸ¥ Body é•¿åº¦ï¼Œæ˜¯å¦è¶…è¿‡æ¶ˆæ¯ä¸Šé™ã€‚</span></span><br /><span class="line"><span class="number">41</span>:     <span class="keyword">int</span> len = bos.writtenBytes();</span><br /><span class="line"><span class="number">42</span>:     checkPayload(channel, len);</span><br /><span class="line"><span class="number">43</span>:     <span class="comment">// `[96 - 127]`ï¼šBody çš„**é•¿åº¦**ã€‚</span></span><br /><span class="line"><span class="number">44</span>:     Bytes.int2bytes(len, header, <span class="number">12</span>);</span><br /><span class="line"><span class="number">45</span>: </span><br /><span class="line"><span class="number">46</span>:     <span class="comment">// å†™å…¥ Header åˆ° Buffer</span></span><br /><span class="line"><span class="number">47</span>:     <span class="comment">// write</span></span><br /><span class="line"><span class="number">48</span>:     buffer.writerIndex(savedWriteIndex);</span><br /><span class="line"><span class="number">49</span>:     buffer.writeBytes(header); <span class="comment">// write header.</span></span><br /><span class="line"><span class="number">50</span>:     buffer.writerIndex(savedWriteIndex + HEADER_LENGTH + len);</span><br /><span class="line"><span class="number">51</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>Header éƒ¨åˆ†ï¼Œå…ˆå†™å…¥&nbsp;<code>header</code>&nbsp;æ•°ç»„ï¼Œå†å†™å…¥ Buffer ä¸­ã€‚</li>
<li>
<p>Body éƒ¨åˆ†ï¼Œä½¿ç”¨ Serialization åºåˆ—åŒ–&nbsp;<code>Request.data</code>&nbsp;ï¼Œå†™å…¥åˆ° Buffer ä¸­ã€‚</p>
<ul>
<li>
<p><code>#encodeEventData(Channel channel, ObjectOutput out, Object data)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">encodeEventData</span><span class="params">(Channel channel, ObjectOutput out, Object data)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line">    encodeEventData(out, data);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">encodeEventData</span><span class="params">(ObjectOutput out, Object data)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line">    out.writeObject(data);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>x</li>
</ul>
</li>
<li>
<p><code>#encodeRequestData(Channel channel, ObjectOutput out, Object data)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encodeRequestData</span><span class="params">(Channel channel, ObjectOutput out, Object data)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line">    encodeRequestData(out, data);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encodeRequestData</span><span class="params">(ObjectOutput out, Object data)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line">    out.writeObject(data);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>#encodeEventData(...)</code>&nbsp;å’Œ&nbsp;<code>#encodeRequestData(...)</code>&nbsp;ä¸¤ä¸ªæ–¹æ³•æ˜¯ä¸€è‡´çš„ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 42 è¡Œï¼šä¼šè°ƒç”¨&nbsp;<code>#checkPayload(channel, len)</code>&nbsp;æ–¹æ³•ï¼Œæ ¡éªŒ Body å†…å®¹çš„é•¿åº¦ã€‚ç¬”è€…åœ¨è¿™å—çº ç»“äº†å¾ˆä¹…ï¼Œå¦‚æœè¿‡é•¿è€ŒæŠ›å‡º ExceedPayloadLimitException å¼‚å¸¸ï¼Œé‚£ä¹ˆ ChannelBuffer æ˜¯å¦é‡ç½®ä¸‹å†™å…¥ä½ç½®ã€‚åæ¥å‘ç°è‡ªå·±ç…ç¬”äº†ï¼Œæ¯æ¬¡ ChannelBuffer éƒ½æ˜¯æ–°åˆ›å»ºçš„ï¼Œæ‰€ä»¥æ— éœ€é‡ç½®ã€‚</li>
<li>ä¸ºä»€ä¹ˆ Buffer å…ˆå†™å…¥äº† Body ï¼Œå†å†™å…¥ Header å‘¢ï¼Ÿå› ä¸º Header ä¸­ï¼Œé‡Œé¢&nbsp;<code>[96 - 127]</code>&nbsp;çš„ Body é•¿åº¦ï¼Œéœ€è¦åºåˆ—åŒ–åæ‰å¾—åˆ°ã€‚</li>
</ul>
</li>
<li><a href="https://github.com/YunaiV/dubbo/blob/a89a569e608ee1282d1bce3fc2540860873629db/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/codec/ExchangeCodec.java#L292-L404" target="_blank" rel="external nofollow noopener noreferrer"><code>#encodeResponse(channel, buffer, response)</code></a>&nbsp;æ–¹æ³•ï¼Œå’Œ&nbsp;<code>#encodeRequest(chanel, buffer, request)</code>&nbsp;æ–¹æ³•ï¼ŒåŸºæœ¬ä¸€è‡´ï¼Œèƒ–å‹è‡ªå·±ç…ç…åˆ—ã€‚ä¸»è¦å·®å¼‚ç‚¹å¦‚ä¸‹ï¼š
<ul>
<li><code>[24 - 31]</code>ï¼š<code>status</code>&nbsp;çŠ¶æ€ã€‚è¿™æ˜¯ Request æ²¡æœ‰ï¼Œè€Œ Response æœ‰çš„éƒ¨åˆ†ã€‚</li>
<li>å½“å“åº”çš„å†…å®¹è¿‡é•¿è€ŒæŠ›å‡º ExceedPayloadLimitException å¼‚å¸¸ï¼Œæ ¹æ®æ¡ä»¶ï¼Œå‘é€ä¸€æ¡ Response (&nbsp;<code>status = BAD_RESPONSE</code>&nbsp;) ç»™è¯·æ±‚æ–¹ã€‚</li>
</ul>
</li>
</ul>
<p><strong>è§£ç </strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Object <span class="title">decode</span><span class="params">(Channel channel, ChannelBuffer buffer)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// è¯»å– Header æ•°ç»„</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">int</span> readable = buffer.readableBytes();</span><br /><span class="line"> <span class="number">5</span>:     <span class="keyword">byte</span>[] header = <span class="keyword">new</span> <span class="keyword">byte</span>[Math.min(readable, HEADER_LENGTH)];</span><br /><span class="line"> <span class="number">6</span>:     buffer.readBytes(header);</span><br /><span class="line"> <span class="number">7</span>:     <span class="comment">// è§£ç </span></span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">return</span> decode(channel, buffer, readable, header);</span><br /><span class="line"> <span class="number">9</span>: }</span><br /><span class="line"><span class="number">10</span>: </span><br /><span class="line"><span class="number">11</span>: <span class="meta">@Override</span></span><br /><span class="line"><span class="number">12</span>: <span class="function"><span class="keyword">protected</span> Object <span class="title">decode</span><span class="params">(Channel channel, ChannelBuffer buffer, <span class="keyword">int</span> readable, <span class="keyword">byte</span>[] header)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line"><span class="number">13</span>:     <span class="comment">// é Dubbo åè®®ï¼Œç›®å‰æ˜¯ Telnet å‘½ä»¤ã€‚</span></span><br /><span class="line"><span class="number">14</span>:     <span class="comment">// check magic number.</span></span><br /><span class="line"><span class="number">15</span>:     <span class="keyword">if</span> (readable &gt; <span class="number">0</span> &amp;&amp; header[<span class="number">0</span>] != MAGIC_HIGH || readable &gt; <span class="number">1</span> &amp;&amp; header[<span class="number">1</span>] != MAGIC_LOW) {</span><br /><span class="line"><span class="number">16</span>:         <span class="comment">// å°† buffer å®Œå…¨å¤åˆ¶åˆ° `header` æ•°ç»„ä¸­ã€‚å› ä¸ºï¼Œä¸Šé¢çš„ `#decode(channel, buffer)` æ–¹æ³•ï¼Œå¯èƒ½æœªè¯»å…¨</span></span><br /><span class="line"><span class="number">17</span>:         <span class="keyword">int</span> length = header.length;</span><br /><span class="line"><span class="number">18</span>:         <span class="keyword">if</span> (header.length &lt; readable) {</span><br /><span class="line"><span class="number">19</span>:             header = Bytes.copyOf(header, readable);</span><br /><span class="line"><span class="number">20</span>:             buffer.readBytes(header, length, readable - length);</span><br /><span class="line"><span class="number">21</span>:         }</span><br /><span class="line"><span class="number">22</span>:         <span class="comment">// ã€TODO 8026 ã€‘header[i] == MAGIC_HIGH &amp;&amp; header[i + 1] == MAGIC_LOW ï¼Ÿ</span></span><br /><span class="line"><span class="number">23</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; header.length - <span class="number">1</span>; i++) {</span><br /><span class="line"><span class="number">24</span>:             <span class="keyword">if</span> (header[i] == MAGIC_HIGH &amp;&amp; header[i + <span class="number">1</span>] == MAGIC_LOW) {</span><br /><span class="line"><span class="number">25</span>:                 buffer.readerIndex(buffer.readerIndex() - header.length + i);</span><br /><span class="line"><span class="number">26</span>:                 header = Bytes.copyOf(header, i);</span><br /><span class="line"><span class="number">27</span>:                 <span class="keyword">break</span>;</span><br /><span class="line"><span class="number">28</span>:             }</span><br /><span class="line"><span class="number">29</span>:         }</span><br /><span class="line"><span class="number">30</span>:         <span class="comment">// æäº¤ç»™çˆ¶ç±»( Telnet ) å¤„ç†ï¼Œç›®å‰æ˜¯ Telnet å‘½ä»¤ã€‚</span></span><br /><span class="line"><span class="number">31</span>:         <span class="keyword">return</span> <span class="keyword">super</span>.decode(channel, buffer, readable, header);</span><br /><span class="line"><span class="number">32</span>:     }</span><br /><span class="line"><span class="number">33</span>:     <span class="comment">// Header é•¿åº¦ä¸å¤Ÿï¼Œè¿”å›éœ€è¦æ›´å¤šçš„è¾“å…¥</span></span><br /><span class="line"><span class="number">34</span>:     <span class="comment">// check length.</span></span><br /><span class="line"><span class="number">35</span>:     <span class="keyword">if</span> (readable &lt; HEADER_LENGTH) {</span><br /><span class="line"><span class="number">36</span>:         <span class="keyword">return</span> DecodeResult.NEED_MORE_INPUT;</span><br /><span class="line"><span class="number">37</span>:     }</span><br /><span class="line"><span class="number">38</span>: </span><br /><span class="line"><span class="number">39</span>:     <span class="comment">// `[96 - 127]`ï¼šBody çš„**é•¿åº¦**ã€‚é€šè¿‡è¯¥é•¿åº¦ï¼Œè¯»å– Body ã€‚</span></span><br /><span class="line"><span class="number">40</span>:     <span class="comment">// get data length.</span></span><br /><span class="line"><span class="number">41</span>:     <span class="keyword">int</span> len = Bytes.bytes2int(header, <span class="number">12</span>);</span><br /><span class="line"><span class="number">42</span>:     checkPayload(channel, len);</span><br /><span class="line"><span class="number">43</span>: </span><br /><span class="line"><span class="number">44</span>:     <span class="comment">// æ€»é•¿åº¦ä¸å¤Ÿï¼Œè¿”å›éœ€è¦æ›´å¤šçš„è¾“å…¥</span></span><br /><span class="line"><span class="number">45</span>:     <span class="keyword">int</span> tt = len + HEADER_LENGTH;</span><br /><span class="line"><span class="number">46</span>:     <span class="keyword">if</span> (readable &lt; tt) {</span><br /><span class="line"><span class="number">47</span>:         <span class="keyword">return</span> DecodeResult.NEED_MORE_INPUT;</span><br /><span class="line"><span class="number">48</span>:     }</span><br /><span class="line"><span class="number">49</span>: </span><br /><span class="line"><span class="number">50</span>:     <span class="comment">// è§£æ Header + Body</span></span><br /><span class="line"><span class="number">51</span>:     <span class="comment">// limit input stream.</span></span><br /><span class="line"><span class="number">52</span>:     ChannelBufferInputStream is = <span class="keyword">new</span> ChannelBufferInputStream(buffer, len);</span><br /><span class="line"><span class="number">53</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">54</span>:         <span class="keyword">return</span> decodeBody(channel, is, header);</span><br /><span class="line"><span class="number">55</span>:     } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">56</span>:         <span class="comment">// skip æœªè¯»å®Œçš„æµï¼Œå¹¶æ‰“å°é”™è¯¯æ—¥å¿—</span></span><br /><span class="line"><span class="number">57</span>:         <span class="keyword">if</span> (is.available() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">58</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">59</span>:                 <span class="keyword">if</span> (logger.isWarnEnabled()) {</span><br /><span class="line"><span class="number">60</span>:                     logger.warn(<span class="string">"Skip input stream "</span> + is.available());</span><br /><span class="line"><span class="number">61</span>:                 }</span><br /><span class="line"><span class="number">62</span>:                 StreamUtils.skipUnusedStream(is);</span><br /><span class="line"><span class="number">63</span>:             } <span class="keyword">catch</span> (IOException e) {</span><br /><span class="line"><span class="number">64</span>:                 logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">65</span>:             }</span><br /><span class="line"><span class="number">66</span>:         }</span><br /><span class="line"><span class="number">67</span>:     }</span><br /><span class="line"><span class="number">68</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è‡³ 6 è¡Œï¼šè¯»å–&nbsp;<code>header</code>&nbsp;æ•°ç»„ã€‚<strong>æ³¨æ„</strong>ï¼Œè¿™é‡Œçš„&nbsp;<code>Math.min(readable, HEADER_LENGTH)</code>&nbsp;ï¼Œä¼˜å…ˆè€ƒè™‘è§£æ Dubbo åè®®ã€‚</li>
<li>ç¬¬ 8 è¡Œï¼šè°ƒç”¨&nbsp;<code>#decode(channel, buffer, readable, header)</code>&nbsp;æ–¹æ³•ï¼Œè§£ç ã€‚</li>
<li>========== åˆ†éš”çº¿ ==========</li>
<li>ç¬¬ 13 è‡³ 32 è¡Œï¼šé Dubbo åè®®ï¼Œç›®å‰æ˜¯ Telnet åè®®ã€‚
<ul>
<li>ç¬¬ 17 è‡³ 21 è¡Œï¼šå°† Buffer å®Œå…¨å¤åˆ¶åˆ°&nbsp;<code>header</code>&nbsp;æ•°ç»„ä¸­ã€‚å› ä¸ºï¼Œä¸Šé¢çš„&nbsp;<code>#decode(channel, buffer)</code>&nbsp;æ–¹æ³•ï¼Œå¯èƒ½æœªè¯»å…¨ã€‚å› ä¸ºï¼Œã€ç¬¬ 3 è‡³ 6 è¡Œã€‘ï¼Œæ˜¯ä»¥&nbsp;<strong>Dubbo åè®®</strong>&nbsp;ä¸ºä¼˜å…ˆè€ƒè™‘è§£ç çš„ã€‚</li>
<li>ç¬¬ 22 è‡³ 29 è¡Œï¼šã€TODO 8026 ã€‘header[i] == MAGIC_HIGH &amp;&amp; header[i + 1] == MAGIC_LOW ï¼Ÿæä¸æ‡‚ï¼Ÿ</li>
<li>ç¬¬ 31 è¡Œï¼šè°ƒç”¨&nbsp;<code>Telnet#decode(channel, buffer, readable, header)</code>&nbsp;æ–¹æ³•ï¼Œè§£ç  Telnet ã€‚åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-api-telnet/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ï¼ˆä¸‰ï¼‰ä¹‹ Telnet å±‚ã€‹</a>&nbsp;æœ‰è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>ç¬¬ 33 è‡³ 48 è¡Œï¼šåŸºäº<strong>æ¶ˆæ¯é•¿åº¦</strong>çš„æ–¹å¼ï¼Œæ‹†åŒ…ã€‚</li>
<li>ç¬¬ 50 è‡³ 54 è¡Œï¼šè°ƒç”¨&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/a89a569e608ee1282d1bce3fc2540860873629db/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/exchange/codec/ExchangeCodec.java#L148-L218" target="_blank" rel="external nofollow noopener noreferrer"><code>#decodeBody(channel, is, header)</code></a>&nbsp;æ–¹æ³•ï¼Œè§£æ Header + Body ï¼Œæ ¹æ®æƒ…å†µï¼Œè¿”å› Request æˆ– Reponse ã€‚ğŸ™‚ é€»è¾‘ä¸Šï¼Œæ˜¯&nbsp;<code>#encodeRequest(...)</code>&nbsp;å’Œ&nbsp;<code>#encodeResponse(...)</code>&nbsp;æ–¹æ³•çš„åå‘ï¼Œæ‰€ä»¥ï¼Œèƒ–å‹å°±è‡ªå·±çœ‹å•¦ã€‚</li>
<li>ç¬¬ 55 è‡³ 67 è¡Œï¼šskip&nbsp;<strong>æœªè¯»å®Œçš„æµ</strong>ï¼Œå¹¶æ‰“å°å‘Šè­¦æ—¥å¿—ã€‚</li>
</ul>
</div>
</header>
<div class="article-entry">&nbsp;</div>