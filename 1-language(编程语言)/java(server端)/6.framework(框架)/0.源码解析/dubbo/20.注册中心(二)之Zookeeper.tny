<header class="article-header">
<h1 class="article-title">æ³¨å†Œä¸­å¿ƒï¼ˆäºŒï¼‰ä¹‹ Zookeeper</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>å‰ç½®é˜…è¯»æ–‡ç« ï¼š</p>
<ul>
<li><a href="http://svip.iocoder.cn/Dubbo/remoting-zookeeper/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; Zookeeper å®¢æˆ·ç«¯ã€‹</a></li>
<li><a href="http://svip.iocoder.cn/Dubbo/registry-api/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹</a></li>
</ul>
<p>ğŸ˜ˆ åœ¨ã€Šæ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹ ä¸­ï¼Œæˆ‘ä»¬åˆ†äº«çš„é‚£æ˜¯<strong>ç›¸å½“æŠ½è±¡</strong>ã€‚å› æ­¤ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šåˆ†äº« Dubbo ä½¿ç”¨ Zookeeper ä½œä¸ºæ³¨å†Œä¸­å¿ƒçš„ä»£ç ï¼ŒåŒæ—¶ä¹Ÿä¼šåˆ†äº«æœåŠ¡æš´éœ²å’Œå¼•ç”¨æ—¶ï¼Œå¯¹æ³¨å†Œä¸­å¿ƒçš„ä½¿ç”¨ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/registry/zookeeper.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; zookeeper æ³¨å†Œä¸­å¿ƒã€‹</a>&nbsp;æ–‡æ¡£ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<blockquote>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_08_04/01.png" alt="æµç¨‹" /></p>
<p>æµç¨‹è¯´æ˜ï¼š</p>
<ul>
<li>
<p><strong>æœåŠ¡æä¾›è€…</strong>å¯åŠ¨æ—¶: å‘&nbsp;<code>/dubbo/com.foo.BarService/providers</code>&nbsp;ç›®å½•ä¸‹å†™å…¥è‡ªå·±çš„ URL åœ°å€</p>
</li>
<li>
<p><strong>æœåŠ¡æ¶ˆè´¹è€…</strong>å¯åŠ¨æ—¶: è®¢é˜…&nbsp;<code>/dubbo/com.foo.BarService/providers</code>&nbsp;ç›®å½•ä¸‹çš„æä¾›è€… URL åœ°å€ã€‚å¹¶å‘&nbsp;<code>/dubbo/com.foo.BarService/consumers</code>&nbsp;ç›®å½•ä¸‹å†™å…¥è‡ªå·±çš„ URL åœ°å€</p>
</li>
<li>
<p><strong>ç›‘æ§ä¸­å¿ƒ</strong>å¯åŠ¨æ—¶: è®¢é˜…&nbsp;<code>/dubbo/com.foo.BarService</code>&nbsp;ç›®å½•ä¸‹çš„æ‰€æœ‰æä¾›è€…å’Œæ¶ˆè´¹è€… URL åœ°å€ã€‚</p>
</li>
</ul>
</blockquote>
<ul>
<li>
<p>åœ¨å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Zookeeper çš„èŠ‚ç‚¹å±‚çº§ï¼Œè‡ªä¸Šè€Œä¸‹æ˜¯ï¼š</p>
<ul>
<li><strong>Root</strong>&nbsp;å±‚ï¼šæ ¹ç›®å½•ï¼Œå¯é€šè¿‡&nbsp;<code>&lt;dubbo:registry group="dubbo" /&gt;</code>&nbsp;çš„&nbsp;<code>"group"</code>&nbsp;è®¾ç½® Zookeeper çš„æ ¹èŠ‚ç‚¹ï¼Œç¼ºçœä½¿ç”¨&nbsp;<code>"dubbo"</code>&nbsp;ã€‚</li>
<li><strong>Service</strong>&nbsp;å±‚ï¼šæœåŠ¡æ¥å£å…¨åã€‚</li>
<li><strong>Type</strong>&nbsp;å±‚ï¼šåˆ†ç±»ã€‚ç›®å‰é™¤äº†æˆ‘ä»¬åœ¨å›¾ä¸­çœ‹åˆ°çš„&nbsp;<code>"providers"</code>( æœåŠ¡æä¾›è€…åˆ—è¡¨ )&nbsp;<code>"consumers"</code>( æœåŠ¡æ¶ˆè´¹è€…åˆ—è¡¨ ) å¤–ï¼Œè¿˜æœ‰&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/routing-rule.html" target="_blank" rel="external nofollow noopener noreferrer"><code>"routes"</code></a>( è·¯ç”±è§„åˆ™åˆ—è¡¨ ) å’Œ&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/config-rule.html" target="_blank" rel="external nofollow noopener noreferrer"><code>"configurations"</code></a>( é…ç½®è§„åˆ™åˆ—è¡¨ )ã€‚</li>
<li><strong>URL</strong>&nbsp;å±‚ï¼šURL ï¼Œæ ¹æ®ä¸åŒ Type ç›®å½•ï¼Œä¸‹é¢å¯ä»¥æ˜¯æœåŠ¡æä¾›è€… URL ã€æœåŠ¡æ¶ˆè´¹è€… URL ã€è·¯ç”±è§„åˆ™ URL ã€é…ç½®è§„åˆ™ URL ã€‚</li>
<li>å®é™…ä¸Š URL ä¸Šå¸¦æœ‰&nbsp;<code>"category"</code>&nbsp;å‚æ•°ï¼Œå·²ç»èƒ½åˆ¤æ–­æ¯ä¸ª URL çš„åˆ†ç±»ï¼Œä½†æ˜¯ Zookeeper æ˜¯åŸºäºèŠ‚ç‚¹ç›®å½•è®¢é˜…çš„ï¼Œæ‰€ä»¥å¢åŠ äº†&nbsp;<strong>Type</strong>&nbsp;å±‚ã€‚</li>
</ul>
</li>
<li>
<p>å®é™…ä¸Šï¼Œ<strong>æœåŠ¡æ¶ˆè´¹è€…</strong>å¯åŠ¨åï¼Œä¸ä»…ä»…è®¢é˜…äº†&nbsp;<code>"providers"</code>&nbsp;åˆ†ç±»ï¼Œä¹Ÿè®¢é˜…äº†&nbsp;<code>"routes"</code>&nbsp;<code>"configurations"</code>&nbsp;åˆ†ç±»ã€‚</p>
</li>
</ul>
<h1 id="2-ZookeeperRegistryFactory">2. ZookeeperRegistryFactory</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/66a1e1b0ef4b01175be148d27fdcf519f4f01b15/dubbo-registry/dubbo-registry-zookeeper/src/main/java/com/alibaba/dubbo/registry/zookeeper/ZookeeperRegistryFactory.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.registry.zookeeper.ZookeeperRegistryFactory</code></a>&nbsp;ï¼Œå®ç° AbstractRegistryFactory æŠ½è±¡ç±»ï¼ŒZookeeper Registry å·¥å‚ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ZookeeperRegistryFactory</span> <span class="keyword">extends</span> <span class="title">AbstractRegistryFactory</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Zookeeper å·¥å‚</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> ZookeeperTransporter zookeeperTransporter;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * è®¾ç½® Zookeeper å·¥å‚</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * è¯¥æ–¹æ³•ï¼Œé€šè¿‡ Dubbo SPI æ³¨å…¥</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> zookeeperTransporter Zookeeper å·¥å‚å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setZookeeperTransporter</span><span class="params">(ZookeeperTransporter zookeeperTransporter)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.zookeeperTransporter = zookeeperTransporter;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Registry <span class="title">createRegistry</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ZookeeperRegistry(url, zookeeperTransporter);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="3-ZookeeperRegistry">3. ZookeeperRegistry</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/66a1e1b0ef4b01175be148d27fdcf519f4f01b15/dubbo-registry/dubbo-registry-zookeeper/src/main/java/com/alibaba/dubbo/registry/zookeeper/ZookeeperRegistry.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.registry.zookeeper.ZookeeperRegistry</code></a>&nbsp;ï¼Œå®ç° FailbackRegistry æŠ½è±¡ç±»ï¼ŒZookeeper Registry ã€‚</p>
<h2 id="3-1-å±æ€§-æ„é€ æ–¹æ³•">3.1 å±æ€§ + æ„é€ æ–¹æ³•</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * é»˜è®¤ç«¯å£</span></span><br /><span class="line"><span class="comment"> 3:  */</span></span><br /><span class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> DEFAULT_ZOOKEEPER_PORT = <span class="number">2181</span>;</span><br /><span class="line"> <span class="number">5</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 6:  * é»˜è®¤ Zookeeper æ ¹èŠ‚ç‚¹</span></span><br /><span class="line"><span class="comment"> 7:  */</span></span><br /><span class="line"> <span class="number">8</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String DEFAULT_ROOT = <span class="string">"dubbo"</span>;</span><br /><span class="line"> <span class="number">9</span>: </span><br /><span class="line"><span class="number">10</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">11:  * Zookeeper æ ¹èŠ‚ç‚¹</span></span><br /><span class="line"><span class="comment">12:  */</span></span><br /><span class="line"><span class="number">13</span>: <span class="keyword">private</span> <span class="keyword">final</span> String root;</span><br /><span class="line"><span class="number">14</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">15:  * Service æ¥å£å…¨åé›†åˆ</span></span><br /><span class="line"><span class="comment">16:  */</span></span><br /><span class="line"><span class="number">17</span>: <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; anyServices = <span class="keyword">new</span> ConcurrentHashSet&lt;String&gt;();</span><br /><span class="line"><span class="number">18</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">19:  * ç›‘å¬å™¨é›†åˆ</span></span><br /><span class="line"><span class="comment">20:  */</span></span><br /><span class="line"><span class="number">21</span>: <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;URL, ConcurrentMap&lt;NotifyListener, ChildListener&gt;&gt; zkListeners = <span class="keyword">new</span> ConcurrentHashMap&lt;URL, ConcurrentMap&lt;NotifyListener, ChildListener&gt;&gt;();</span><br /><span class="line"><span class="number">22</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">23:  * Zookeeper å®¢æˆ·ç«¯</span></span><br /><span class="line"><span class="comment">24:  */</span></span><br /><span class="line"><span class="number">25</span>: <span class="keyword">private</span> <span class="keyword">final</span> ZookeeperClient zkClient;</span><br /><span class="line"><span class="number">26</span>: </span><br /><span class="line"><span class="number">27</span>: <span class="function"><span class="keyword">public</span> <span class="title">ZookeeperRegistry</span><span class="params">(URL url, ZookeeperTransporter zookeeperTransporter)</span> </span>{</span><br /><span class="line"><span class="number">28</span>:     <span class="keyword">super</span>(url);</span><br /><span class="line"><span class="number">29</span>:     <span class="keyword">if</span> (url.isAnyHost()) {</span><br /><span class="line"><span class="number">30</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"registry address == null"</span>);</span><br /><span class="line"><span class="number">31</span>:     }</span><br /><span class="line"><span class="number">32</span>:     <span class="comment">// è·å¾— Zookeeper æ ¹èŠ‚ç‚¹</span></span><br /><span class="line"><span class="number">33</span>:     String group = url.getParameter(Constants.GROUP_KEY, DEFAULT_ROOT); <span class="comment">// `url.parameters.group` å‚æ•°å€¼</span></span><br /><span class="line"><span class="number">34</span>:     <span class="keyword">if</span> (!group.startsWith(Constants.PATH_SEPARATOR)) {</span><br /><span class="line"><span class="number">35</span>:         group = Constants.PATH_SEPARATOR + group;</span><br /><span class="line"><span class="number">36</span>:     }</span><br /><span class="line"><span class="number">37</span>:     <span class="keyword">this</span>.root = group;</span><br /><span class="line"><span class="number">38</span>:     <span class="comment">// åˆ›å»º Zookeeper Client</span></span><br /><span class="line"><span class="number">39</span>:     zkClient = zookeeperTransporter.connect(url);</span><br /><span class="line"><span class="number">40</span>:     <span class="comment">// æ·»åŠ  StateListener å¯¹è±¡ã€‚è¯¥ç›‘å¬å™¨ï¼Œåœ¨é‡è¿æ—¶ï¼Œè°ƒç”¨æ¢å¤æ–¹æ³•ã€‚</span></span><br /><span class="line"><span class="number">41</span>:     zkClient.addStateListener(<span class="keyword">new</span> StateListener() {</span><br /><span class="line"><span class="number">42</span>:         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stateChanged</span><span class="params">(<span class="keyword">int</span> state)</span> </span>{</span><br /><span class="line"><span class="number">43</span>:             <span class="keyword">if</span> (state == RECONNECTED) {</span><br /><span class="line"><span class="number">44</span>:                 <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">45</span>:                     recover();</span><br /><span class="line"><span class="number">46</span>:                 } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line"><span class="number">47</span>:                     logger.error(e.getMessage(), e);</span><br /><span class="line"><span class="number">48</span>:                 }</span><br /><span class="line"><span class="number">49</span>:             }</span><br /><span class="line"><span class="number">50</span>:         }</span><br /><span class="line"><span class="number">51</span>:     });</span><br /><span class="line"><span class="number">52</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>root</code>&nbsp;å±æ€§ï¼ŒZookeeper æ ¹èŠ‚ç‚¹ï¼Œå³é¦–å›¾çš„&nbsp;<strong>Root</strong>&nbsp;å±‚ã€‚</li>
<li><code>anyServices</code>&nbsp;å±æ€§ï¼ŒService æ¥å£æ¥å£å…¨å<strong>é›†åˆ</strong>ã€‚è¯¥å±æ€§é€‚å¯ç”¨äºç›‘æ§ä¸­å¿ƒï¼Œè®¢é˜…<strong>æ•´ä¸ª</strong>&nbsp;<strong>Service</strong>&nbsp;å±‚ã€‚å› ä¸ºï¼ŒService å±‚æ˜¯<strong>åŠ¨æ€</strong>çš„ï¼Œå¯ä»¥æœ‰ä¸æ–­æœ‰æ–°çš„ Service æœåŠ¡å‘å¸ƒï¼ˆæ³¨æ„ï¼Œä¸æ˜¯æœåŠ¡å®ä¾‹ï¼‰ã€‚åœ¨&nbsp;<code>#doSubscribe(url, notifyListener)</code>&nbsp;æ–¹æ³•ä¸­ï¼Œä¼šæ›´å®¹æ˜“ç†è§£ã€‚</li>
<li><code>zkListeners</code>&nbsp;å±æ€§ï¼Œç›‘å¬å™¨é›†åˆï¼Œå»ºç«‹ NotifyListener å’Œ ChildListener çš„æ˜ å°„å…³ç³»ã€‚</li>
<li><code>zkClient</code>&nbsp;å±æ€§ï¼ŒZookeeper å®¢æˆ·ç«¯ã€‚</li>
<li><strong>æ„é€ æ–¹æ³•</strong>
<ul>
<li>ç¬¬ 28 è‡³ 31 è¡Œï¼šè®¾ç½®æ³¨å†Œä¸­å¿ƒçš„ URL ã€‚</li>
<li>ç¬¬ 32 è‡³ 37 è¡Œï¼šè®¾ç½®åœ¨ Zookeeper çš„æ ¹èŠ‚ç‚¹ï¼Œç¼ºçœä½¿ç”¨&nbsp;<code>DEFAULT_ROOT</code>&nbsp;ã€‚</li>
<li>ç¬¬ 39 è¡Œï¼šè°ƒç”¨&nbsp;<code>ZookeeperTransporter#connect(url)</code>&nbsp;æ–¹æ³•ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼Œæ ¹æ®&nbsp;<code>url</code>&nbsp;å‚æ•°ï¼ŒåŠ è½½å¯¹åº”çš„ ZookeeperTransporter å®ç°ç±»ï¼Œåˆ›å»ºå¯¹åº”çš„ ZookeeperClient å®ç°ç±»çš„å¯¹åº”ã€‚</li>
<li>ç¬¬ 41 è‡³ 51 è¡Œï¼šæ·»åŠ  StateListener å¯¹è±¡åˆ° ZookeeperClient å¯¹è±¡ä¸­ã€‚è¯¥ç›‘å¬å™¨ï¼Œåœ¨é‡è¿æ—¶ï¼Œåœ¨ç¬¬ 45 è¡Œçš„ä»£ç ï¼Œè°ƒç”¨&nbsp;<code>#recover()</code>&nbsp;æ–¹æ³•ï¼Œè¿›è¡Œæ¢å¤é€»è¾‘ï¼Œé‡æ–°å‘èµ·æ³¨å†Œå’Œè®¢é˜…ã€‚</li>
</ul>
</li>
</ul>
<h2 id="3-2-doRegister">3.2 doRegister</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"><span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRegister</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line"><span class="number">3</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">4</span>:         zkClient.create(toUrlPath(url), url.getParameter(Constants.DYNAMIC_KEY, <span class="keyword">true</span>));</span><br /><span class="line"><span class="number">5</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">6</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Failed to register "</span> + url + <span class="string">" to zookeeper "</span> + getUrl() + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br /><span class="line"><span class="number">7</span>:     }</span><br /><span class="line"><span class="number">8</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 4 è¡Œï¼šè°ƒç”¨&nbsp;<code>#toUrlPath(url)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— URL çš„è·¯å¾„ã€‚</li>
<li>ç¬¬ 4 è¡Œï¼š<code>url.parameters.dynamic</code>&nbsp;ï¼Œæ˜¯å¦åŠ¨æ€æ•°æ®ã€‚è‹¥ä¸º false ï¼Œè¯¥æ•°æ®ä¸º<strong>æŒä¹…æ•°æ®</strong>ï¼Œå½“æ³¨å†Œæ–¹é€€å‡ºæ—¶ï¼Œæ•°æ®ä¾ç„¶ä¿å­˜åœ¨æ³¨å†Œä¸­å¿ƒã€‚</li>
<li>ç¬¬ 4 è¡Œï¼šè°ƒç”¨&nbsp;<code>ZookeeperClient#create(url, ephemeral)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º URL èŠ‚ç‚¹ï¼Œå³æˆ‘ä»¬åœ¨é¦–å›¾çœ‹åˆ°çš„&nbsp;<strong>URL å±‚</strong>ã€‚</li>
</ul>
<h3 id="3-2-1-toUrlPath">3.2.1 toUrlPath</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·å¾— URL çš„è·¯å¾„</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Root + Service + Type + URL</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * è¢« {<span class="doctag">@link</span> #doRegister(URL)} å’Œ {<span class="doctag">@link</span> #doUnregister(URL)} è°ƒç”¨</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> url URL</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> è·¯å¾„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toUrlPath</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> toCategoryPath(url) + Constants.PATH_SEPARATOR + URL.encode(url.toFullString());</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="3-2-2-toCategoryPath">3.2.2 toCategoryPath</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·å¾—åˆ†ç±»è·¯å¾„</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Root + Service + Type</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> url URL</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> åˆ†ç±»è·¯å¾„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toCategoryPath</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> toServicePath(url) + Constants.PATH_SEPARATOR + url.getParameter(Constants.CATEGORY_KEY, Constants.DEFAULT_CATEGORY);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="3-2-3-toServicePath">3.2.3 toServicePath</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·å¾—æœåŠ¡è·¯å¾„</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Root + Type</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> url URL</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> æœåŠ¡è·¯å¾„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toServicePath</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    String name = url.getServiceInterface();</span><br /><span class="line">    <span class="keyword">if</span> (Constants.ANY_VALUE.equals(name)) {</span><br /><span class="line">        <span class="keyword">return</span> toRootPath();</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> toRootDir() + URL.encode(name);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="3-2-4-toRootDir">3.2.4 toRootDir</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·å¾—æ ¹ç›®å½•</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Root</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> è·¯å¾„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toRootDir</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (root.equals(Constants.PATH_SEPARATOR)) {</span><br /><span class="line">        <span class="keyword">return</span> root;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> root + Constants.PATH_SEPARATOR;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Root</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> æ ¹è·¯å¾„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">toRootPath</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> root;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="3-3-doUnregister">3.3 doUnregister</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doUnregister</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        zkClient.delete(toUrlPath(url));</span><br /><span class="line">    } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Failed to unregister "</span> + url + <span class="string">" to zookeeper "</span> + getUrl() + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="3-4-doSubscribe">3.4 doSubscribe</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doSubscribe</span><span class="params">(<span class="keyword">final</span> URL url, <span class="keyword">final</span> NotifyListener listener)</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">4</span>:         <span class="comment">// å¤„ç†æ‰€æœ‰ Service å±‚çš„å‘èµ·è®¢é˜…ï¼Œä¾‹å¦‚ç›‘æ§ä¸­å¿ƒçš„è®¢é˜…</span></span><br /><span class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (Constants.ANY_VALUE.equals(url.getServiceInterface())) {</span><br /><span class="line"> <span class="number">6</span>:             String root = toRootPath();</span><br /><span class="line"> <span class="number">7</span>:             <span class="comment">// è·å¾— url å¯¹åº”çš„ç›‘å¬å™¨é›†åˆ</span></span><br /><span class="line"> <span class="number">8</span>:             ConcurrentMap&lt;NotifyListener, ChildListener&gt; listeners = zkListeners.get(url);</span><br /><span class="line"> <span class="number">9</span>:             <span class="keyword">if</span> (listeners == <span class="keyword">null</span>) { <span class="comment">// ä¸å­˜åœ¨ï¼Œè¿›è¡Œåˆ›å»º</span></span><br /><span class="line"><span class="number">10</span>:                 zkListeners.putIfAbsent(url, <span class="keyword">new</span> ConcurrentHashMap&lt;NotifyListener, ChildListener&gt;());</span><br /><span class="line"><span class="number">11</span>:                 listeners = zkListeners.get(url);</span><br /><span class="line"><span class="number">12</span>:             }</span><br /><span class="line"><span class="number">13</span>:             <span class="comment">// è·å¾— ChildListener å¯¹è±¡</span></span><br /><span class="line"><span class="number">14</span>:             ChildListener zkListener = listeners.get(listener);</span><br /><span class="line"><span class="number">15</span>:             <span class="keyword">if</span> (zkListener == <span class="keyword">null</span>) { <span class="comment">// ä¸å­˜åœ¨ ChildListener å¯¹è±¡ï¼Œè¿›è¡Œåˆ›å»º ChildListener å¯¹è±¡</span></span><br /><span class="line"><span class="number">16</span>:                 listeners.putIfAbsent(listener, <span class="keyword">new</span> ChildListener() {</span><br /><span class="line"><span class="number">17</span>:                     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childChanged</span><span class="params">(String parentPath, List&lt;String&gt; currentChilds)</span> </span>{</span><br /><span class="line"><span class="number">18</span>:                         <span class="keyword">for</span> (String child : currentChilds) {</span><br /><span class="line"><span class="number">19</span>:                             child = URL.decode(child);</span><br /><span class="line"><span class="number">20</span>:                             <span class="comment">// æ–°å¢ Service æ¥å£å…¨åæ—¶ï¼ˆå³æ–°å¢æœåŠ¡ï¼‰ï¼Œå‘èµ·è¯¥ Service å±‚çš„è®¢é˜…</span></span><br /><span class="line"><span class="number">21</span>:                             <span class="keyword">if</span> (!anyServices.contains(child)) {</span><br /><span class="line"><span class="number">22</span>:                                 anyServices.add(child);</span><br /><span class="line"><span class="number">23</span>:                                 subscribe(url.setPath(child).addParameters(Constants.INTERFACE_KEY, child,</span><br /><span class="line"><span class="number">24</span>:                                         Constants.CHECK_KEY, String.valueOf(<span class="keyword">false</span>)), listener);</span><br /><span class="line"><span class="number">25</span>:                             }</span><br /><span class="line"><span class="number">26</span>:                         }</span><br /><span class="line"><span class="number">27</span>:                     }</span><br /><span class="line"><span class="number">28</span>:                 });</span><br /><span class="line"><span class="number">29</span>:                 zkListener = listeners.get(listener);</span><br /><span class="line"><span class="number">30</span>:             }</span><br /><span class="line"><span class="number">31</span>:             <span class="comment">// åˆ›å»º Service èŠ‚ç‚¹ã€‚è¯¥èŠ‚ç‚¹ä¸ºæŒä¹…èŠ‚ç‚¹ã€‚</span></span><br /><span class="line"><span class="number">32</span>:             zkClient.create(root, <span class="keyword">false</span>);</span><br /><span class="line"><span class="number">33</span>:             <span class="comment">// å‘ Zookeeper ï¼ŒService èŠ‚ç‚¹ï¼Œå‘èµ·è®¢é˜…</span></span><br /><span class="line"><span class="number">34</span>:             List&lt;String&gt; services = zkClient.addChildListener(root, zkListener);</span><br /><span class="line"><span class="number">35</span>:             <span class="comment">// é¦–æ¬¡å…¨é‡æ•°æ®è·å–å®Œæˆæ—¶ï¼Œå¾ªç¯ Service æ¥å£å…¨åæ•°ç»„ï¼Œå‘èµ·è¯¥ Service å±‚çš„è®¢é˜…</span></span><br /><span class="line"><span class="number">36</span>:             <span class="keyword">if</span> (services != <span class="keyword">null</span> &amp;&amp; !services.isEmpty()) {</span><br /><span class="line"><span class="number">37</span>:                 <span class="keyword">for</span> (String service : services) {</span><br /><span class="line"><span class="number">38</span>:                     service = URL.decode(service);</span><br /><span class="line"><span class="number">39</span>:                     anyServices.add(service);</span><br /><span class="line"><span class="number">40</span>:                     subscribe(url.setPath(service).addParameters(Constants.INTERFACE_KEY, service,</span><br /><span class="line"><span class="number">41</span>:                             Constants.CHECK_KEY, String.valueOf(<span class="keyword">false</span>)), listener);</span><br /><span class="line"><span class="number">42</span>:                 }</span><br /><span class="line"><span class="number">43</span>:             }</span><br /><span class="line"><span class="number">44</span>:         <span class="comment">// å¤„ç†æŒ‡å®š Service å±‚çš„å‘èµ·è®¢é˜…ï¼Œä¾‹å¦‚æœåŠ¡æ¶ˆè´¹è€…çš„è®¢é˜…</span></span><br /><span class="line"><span class="number">45</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">46</span>:             <span class="comment">// å­èŠ‚ç‚¹æ•°æ®æ•°ç»„</span></span><br /><span class="line"><span class="number">47</span>:             List&lt;URL&gt; urls = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br /><span class="line"><span class="number">48</span>:             <span class="comment">// å¾ªç¯åˆ†ç±»æ•°ç»„</span></span><br /><span class="line"><span class="number">49</span>:             <span class="keyword">for</span> (String path : toCategoriesPath(url)) {</span><br /><span class="line"><span class="number">50</span>:                 <span class="comment">// è·å¾— url å¯¹åº”çš„ç›‘å¬å™¨é›†åˆ</span></span><br /><span class="line"><span class="number">51</span>:                 ConcurrentMap&lt;NotifyListener, ChildListener&gt; listeners = zkListeners.get(url);</span><br /><span class="line"><span class="number">52</span>:                 <span class="keyword">if</span> (listeners == <span class="keyword">null</span>) { <span class="comment">// ä¸å­˜åœ¨ï¼Œè¿›è¡Œåˆ›å»º</span></span><br /><span class="line"><span class="number">53</span>:                     zkListeners.putIfAbsent(url, <span class="keyword">new</span> ConcurrentHashMap&lt;NotifyListener, ChildListener&gt;());</span><br /><span class="line"><span class="number">54</span>:                     listeners = zkListeners.get(url);</span><br /><span class="line"><span class="number">55</span>:                 }</span><br /><span class="line"><span class="number">56</span>:                 <span class="comment">// è·å¾— ChildListener å¯¹è±¡</span></span><br /><span class="line"><span class="number">57</span>:                 ChildListener zkListener = listeners.get(listener);</span><br /><span class="line"><span class="number">58</span>:                 <span class="keyword">if</span> (zkListener == <span class="keyword">null</span>) { <span class="comment">// ä¸å­˜åœ¨ ChildListener å¯¹è±¡ï¼Œè¿›è¡Œåˆ›å»º ChildListener å¯¹è±¡</span></span><br /><span class="line"><span class="number">59</span>:                     listeners.putIfAbsent(listener, <span class="keyword">new</span> ChildListener() {</span><br /><span class="line"><span class="number">60</span>:                         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childChanged</span><span class="params">(String parentPath, List&lt;String&gt; currentChilds)</span> </span>{</span><br /><span class="line"><span class="number">61</span>:                             <span class="comment">// å˜æ›´æ—¶ï¼Œè°ƒç”¨ `#notify(...)` æ–¹æ³•ï¼Œå›è°ƒ NotifyListener</span></span><br /><span class="line"><span class="number">62</span>:                             ZookeeperRegistry.<span class="keyword">this</span>.notify(url, listener, toUrlsWithEmpty(url, parentPath, currentChilds));</span><br /><span class="line"><span class="number">63</span>:                         }</span><br /><span class="line"><span class="number">64</span>:                     });</span><br /><span class="line"><span class="number">65</span>:                     zkListener = listeners.get(listener);</span><br /><span class="line"><span class="number">66</span>:                 }</span><br /><span class="line"><span class="number">67</span>:                 <span class="comment">// åˆ›å»º Type èŠ‚ç‚¹ã€‚è¯¥èŠ‚ç‚¹ä¸ºæŒä¹…èŠ‚ç‚¹ã€‚</span></span><br /><span class="line"><span class="number">68</span>:                 zkClient.create(path, <span class="keyword">false</span>);</span><br /><span class="line"><span class="number">69</span>:                 <span class="comment">// å‘ Zookeeper ï¼ŒPATH èŠ‚ç‚¹ï¼Œå‘èµ·è®¢é˜…</span></span><br /><span class="line"><span class="number">70</span>:                 List&lt;String&gt; children = zkClient.addChildListener(path, zkListener);</span><br /><span class="line"><span class="number">71</span>:                 <span class="comment">// æ·»åŠ åˆ° `urls` ä¸­</span></span><br /><span class="line"><span class="number">72</span>:                 <span class="keyword">if</span> (children != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">73</span>:                     urls.addAll(toUrlsWithEmpty(url, path, children));</span><br /><span class="line"><span class="number">74</span>:                 }</span><br /><span class="line"><span class="number">75</span>:             }</span><br /><span class="line"><span class="number">76</span>:             <span class="comment">// é¦–æ¬¡å…¨é‡æ•°æ®è·å–å®Œæˆæ—¶ï¼Œè°ƒç”¨ `#notify(...)` æ–¹æ³•ï¼Œå›è°ƒ NotifyListener</span></span><br /><span class="line"><span class="number">77</span>:             notify(url, listener, urls);</span><br /><span class="line"><span class="number">78</span>:         }</span><br /><span class="line"><span class="number">79</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">80</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Failed to subscribe "</span> + url + <span class="string">" to zookeeper "</span> + getUrl() + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br /><span class="line"><span class="number">81</span>:     }</span><br /><span class="line"><span class="number">82</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ•´ä¸ªæ–¹æ³•åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œåˆ†åˆ«ï¼š</li>
<li>============ ç¬¬äºŒéƒ¨åˆ†ã€ç¬¬ 44 è‡³ 78 è¡Œã€‘ ============</li>
<li>å¤„ç†<strong>æŒ‡å®š</strong>&nbsp;Service å±‚çš„å‘èµ·è®¢é˜…ï¼Œä¾‹å¦‚<strong>æœåŠ¡æ¶ˆè´¹è€…</strong>çš„è®¢é˜…ã€‚</li>
<li>ç¬¬ 47 è¡Œï¼šå­èŠ‚ç‚¹æ•°æ®æ•°ç»„ï¼Œå³&nbsp;<strong>Service å±‚</strong>ä¸‹çš„<strong>æ‰€æœ‰ URL</strong>&nbsp;ã€‚</li>
<li>ç¬¬ 49 è¡Œï¼šå¾ªç¯åˆ†ç±»æ•°ç»„ã€‚å…¶ä¸­ï¼Œè°ƒç”¨&nbsp;<code>#toCategoriesPath(url)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— åˆ†ç±»æ•°ç»„ã€‚</li>
<li>ç¬¬ 51 è‡³ 55 è¡Œï¼šè·å¾—è®¢é˜…çš„&nbsp;<code>url</code>&nbsp;å¯¹åº”çš„ç›‘å¬å™¨é›†åˆã€‚</li>
<li>ç¬¬ 56 è‡³ 66 è¡Œï¼šè·å¾—&nbsp;<code>listener</code>( NotifyListener ) å¯¹åº”çš„ ChildListener å¯¹è±¡ã€‚<strong>åœ¨ URL å±‚å‘ç”Ÿå˜æ›´æ—¶</strong>ï¼Œä¼šè°ƒç”¨&nbsp;<code>NotifyListener#notify(url, listener, currentChilds)</code>&nbsp;æ–¹æ³•ï¼Œå›è°ƒ NotifyListener çš„é€»è¾‘ã€‚é…±ç´«ï¼Œå¦‚æœ Service ä¸‹å¢åŠ <strong>æ–°çš„æœåŠ¡æä¾›è€…å®ä¾‹</strong>( æ–°çš„ URL )ï¼ŒæœåŠ¡æ¶ˆè´¹è€…å¯åˆ›å»ºæ–°çš„ Invoker å¯¹è±¡ï¼Œç”¨äºè°ƒç”¨è¯¥æœåŠ¡æä¾›è€…ã€‚</li>
<li>ç¬¬ 68 è¡Œï¼šåˆ›å»º&nbsp;<strong>Type</strong>&nbsp;èŠ‚ç‚¹ã€‚è¯¥èŠ‚ç‚¹ä¸º<strong>æŒä¹…</strong>èŠ‚ç‚¹ã€‚</li>
<li>ç¬¬ 70 è¡Œï¼šå‘ Zookeeper çš„&nbsp;<strong>Path</strong>&nbsp;èŠ‚ç‚¹ï¼Œå‘èµ·è®¢é˜…ã€‚</li>
<li>ç¬¬ 72 è‡³ 74 è¡Œï¼šæ·»åŠ åˆ°&nbsp;<code>urls</code>&nbsp;ä¸­ã€‚</li>
<li>ç¬¬ 77 è¡Œï¼š<strong>é¦–æ¬¡å…¨é‡æ•°æ®è·å–å®Œæˆæ—¶</strong>ï¼Œè°ƒç”¨&nbsp;<code>NotifyListener#notify(url, listener, currentChilds)</code>&nbsp;æ–¹æ³•ï¼Œå›è°ƒ NotifyListener çš„é€»è¾‘ã€‚é…±ç´«ï¼ŒæœåŠ¡æ¶ˆè´¹è€…å¯åˆ›å»ºæ‰€æœ‰çš„ Invoker å¯¹è±¡ï¼Œç”¨äºè°ƒç”¨æœåŠ¡æä¾›è€…ä»¬ã€‚</li>
<li>ğŸ™‚ å›çœ‹ã€ç¬¬ 77 è¡Œã€‘å’Œã€ç¬¬ 62 è¡Œã€‘ï¼Œå…¨é‡ + å¢é‡ï¼Œä»”ç»†ç†è§£ä¸‹ã€‚</li>
<li>============ ç¬¬ä¸€éƒ¨åˆ†ã€ç¬¬ 5 è‡³ 43 è¡Œã€‘ ============</li>
<li>å¤„ç†<strong>æ‰€æœ‰</strong>&nbsp;Service å±‚çš„å‘èµ·è®¢é˜…ï¼Œä¾‹å¦‚<strong>ç›‘æ§ä¸­å¿ƒ</strong>çš„è®¢é˜…</li>
<li>ç¬¬ 8 è‡³ 12 è¡Œï¼šè·å¾—è®¢é˜…çš„&nbsp;<code>url</code>&nbsp;å¯¹åº”çš„ç›‘å¬å™¨é›†åˆã€‚</li>
<li>ç¬¬ 13 è‡³ 30 è¡Œï¼šè·å¾—&nbsp;<code>listener</code>( NotifyListener ) å¯¹åº”çš„ ChildListener å¯¹è±¡ã€‚<strong>åœ¨ Service å±‚å‘ç”Ÿå˜æ›´æ—¶</strong>ï¼Œè‹¥æ˜¯æ–°å¢ Service æ¥å£å…¨åæ—¶ï¼ˆå³æ–°å¢æœåŠ¡ï¼‰ï¼Œè°ƒç”¨&nbsp;<code>#subscribe(url, listener)</code>&nbsp;æ–¹æ³•ï¼Œå‘èµ·è¯¥ Service å±‚çš„è®¢é˜…ï¼ˆã€ç¬¬ 45 è‡³ 78 è¡Œã€‘çš„é€»è¾‘ï¼‰ã€‚æ˜¯å¦æ˜¯æ–°å¢çš„æœåŠ¡ï¼Œé€šè¿‡&nbsp;<code>anyServices</code>&nbsp;å±æ€§æ¥åˆ¤æ–­ã€‚</li>
<li>ç¬¬ 32 è¡Œï¼šåˆ›å»º&nbsp;<strong>Service</strong>&nbsp;èŠ‚ç‚¹ã€‚è¯¥èŠ‚ç‚¹ä¸º<strong>æŒä¹…</strong>èŠ‚ç‚¹ã€‚</li>
<li>ç¬¬ 34 è¡Œï¼šå‘ Zookeeper çš„&nbsp;<strong>Service</strong>&nbsp;èŠ‚ç‚¹ï¼Œå‘èµ·è®¢é˜…ã€‚</li>
<li>ç¬¬ 36 è‡³ 43 è¡Œï¼š<strong>é¦–æ¬¡å…¨é‡æ•°æ®è·å–å®Œæˆæ—¶</strong>ï¼Œå¾ªç¯ Service æ¥å£å…¨åæ•°ç»„ï¼Œè°ƒç”¨&nbsp;<code>#subscribe(url, listener)</code>&nbsp;æ–¹æ³•ï¼Œå‘èµ·è¯¥ Service å±‚çš„è®¢é˜…ï¼ˆã€ç¬¬ 45 è‡³ 78 è¡Œã€‘çš„é€»è¾‘ï¼‰ã€‚</li>
</ul>
<blockquote>
<p>å‹æƒ…æç¤ºï¼šå¦‚æœè§‰å¾—æ¯”è¾ƒç»•ï¼Œæˆ–è€…ç¬”è€…è®²çš„ä¸æ¸…æ™°ï¼Œèƒ–å‹å¯ä»¥è¿›è¡Œè°ƒè¯•ç†è§£ã€‚</p>
</blockquote>
<h3 id="3-4-1-toCategoriesPath">3.4.1 toCategoriesPath</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·å¾—åˆ†ç±»è·¯å¾„æ•°ç»„</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * Root + Service + Type</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> url URL</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> åˆ†ç±»è·¯å¾„æ•°ç»„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> String[] toCategoriesPath(URL url) {</span><br /><span class="line">    <span class="comment">// è·å¾—åˆ†ç±»æ•°ç»„</span></span><br /><span class="line">    String[] categories;</span><br /><span class="line">    <span class="keyword">if</span> (Constants.ANY_VALUE.equals(url.getParameter(Constants.CATEGORY_KEY))) { <span class="comment">// * æ—¶ï¼Œ</span></span><br /><span class="line">        categories = <span class="keyword">new</span> String[]{Constants.PROVIDERS_CATEGORY, Constants.CONSUMERS_CATEGORY,</span><br /><span class="line">                Constants.ROUTERS_CATEGORY, Constants.CONFIGURATORS_CATEGORY};</span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        categories = url.getParameter(Constants.CATEGORY_KEY, <span class="keyword">new</span> String[]{Constants.DEFAULT_CATEGORY});</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è·å¾—åˆ†ç±»è·¯å¾„æ•°ç»„</span></span><br /><span class="line">    String[] paths = <span class="keyword">new</span> String[categories.length];</span><br /><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; categories.length; i++) {</span><br /><span class="line">        paths[i] = toServicePath(url) + Constants.PATH_SEPARATOR + categories[i];</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> paths;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="3-4-2-toUrlsWithEmpty">3.4.2 toUrlsWithEmpty</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·å¾— providers ä¸­ï¼Œå’Œ consumer åŒ¹é…çš„ URL æ•°ç»„</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * è‹¥ä¸å­˜åœ¨åŒ¹é…ï¼Œåˆ™åˆ›å»º `empty://` çš„ URLè¿”å›ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå¯ä»¥å¤„ç†ç±»ä¼¼æœåŠ¡æä¾›è€…ä¸ºç©ºçš„æƒ…å†µã€‚</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> consumer ç”¨äºåŒ¹é… URL</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> path è¢«åŒ¹é…çš„ URL çš„å­—ç¬¦ä¸²</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> providers åŒ¹é…çš„ URL æ•°ç»„</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> åŒ¹é…çš„ URL æ•°ç»„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> List&lt;URL&gt; <span class="title">toUrlsWithEmpty</span><span class="params">(URL consumer, String path, List&lt;String&gt; providers)</span> </span>{</span><br /><span class="line">    <span class="comment">// è·å¾— providers ä¸­ï¼Œå’Œ consumer åŒ¹é…çš„ URL æ•°ç»„</span></span><br /><span class="line">    List&lt;URL&gt; urls = toUrlsWithoutEmpty(consumer, providers);</span><br /><span class="line">    <span class="comment">// è‹¥ä¸å­˜åœ¨åŒ¹é…ï¼Œåˆ™åˆ›å»º `empty://` çš„ URLè¿”å›</span></span><br /><span class="line">    <span class="keyword">if</span> (urls == <span class="keyword">null</span> || urls.isEmpty()) {</span><br /><span class="line">        <span class="keyword">int</span> i = path.lastIndexOf(<span class="string">'/'</span>);</span><br /><span class="line">        String category = i &lt; <span class="number">0</span> ? path : path.substring(i + <span class="number">1</span>);</span><br /><span class="line">        URL empty = consumer.setProtocol(Constants.EMPTY_PROTOCOL).addParameter(Constants.CATEGORY_KEY, category);</span><br /><span class="line">        urls.add(empty);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> urls;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>#toUrlsWithoutEmpty()</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·å¾— providers ä¸­ï¼Œå’Œ consumer åŒ¹é…çš„ URL æ•°ç»„</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> consumer ç”¨äºåŒ¹é… URL</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> providers è¢«åŒ¹é…çš„ URL çš„å­—ç¬¦ä¸²</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> åŒ¹é…çš„ URL æ•°ç»„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> List&lt;URL&gt; <span class="title">toUrlsWithoutEmpty</span><span class="params">(URL consumer, List&lt;String&gt; providers)</span> </span>{</span><br /><span class="line">    List&lt;URL&gt; urls = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br /><span class="line">    <span class="keyword">if</span> (providers != <span class="keyword">null</span> &amp;&amp; !providers.isEmpty()) {</span><br /><span class="line">        <span class="keyword">for</span> (String provider : providers) {</span><br /><span class="line">            provider = URL.decode(provider);</span><br /><span class="line">            <span class="keyword">if</span> (provider.contains(<span class="string">"://"</span>)) { <span class="comment">// æ˜¯ url</span></span><br /><span class="line">                URL url = URL.valueOf(provider); <span class="comment">// å°†å­—ç¬¦ä¸²è½¬åŒ–æˆ URL</span></span><br /><span class="line">                <span class="keyword">if</span> (UrlUtils.isMatch(consumer, url)) { <span class="comment">// åŒ¹é…</span></span><br /><span class="line">                    urls.add(url);</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> urls;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<h2 id="3-5-doUnsubscribe">3.5 doUnsubscribe</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doUnsubscribe</span><span class="params">(URL url, NotifyListener listener)</span> </span>{</span><br /><span class="line">    ConcurrentMap&lt;NotifyListener, ChildListener&gt; listeners = zkListeners.get(url);</span><br /><span class="line">    <span class="keyword">if</span> (listeners != <span class="keyword">null</span>) {</span><br /><span class="line">        ChildListener zkListener = listeners.get(listener);</span><br /><span class="line">        <span class="keyword">if</span> (zkListener != <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="comment">// å‘ Zookeeper ï¼Œç§»é™¤è®¢é˜…</span></span><br /><span class="line">            zkClient.removeChildListener(toUrlPath(url), zkListener);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="3-6-lookup">3.6 lookup</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„å·²æ³¨å†Œæ•°æ®ï¼Œä¸è®¢é˜…çš„æ¨æ¨¡å¼ç›¸å¯¹åº”ï¼Œè¿™é‡Œä¸ºæ‹‰æ¨¡å¼ï¼Œåªè¿”å›ä¸€æ¬¡ç»“æœã€‚</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> url æŸ¥è¯¢æ¡ä»¶ï¼Œä¸å…è®¸ä¸ºç©ºï¼Œå¦‚ï¼šconsumer://10.20.153.10/com.alibaba.foo.BarService?version=1.0.0&amp;application=kylin</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> å·²æ³¨å†Œä¿¡æ¯åˆ—è¡¨ï¼Œå¯èƒ½ä¸ºç©ºï¼Œå«ä¹‰åŒ{<span class="doctag">@link</span> com.alibaba.dubbo.registry.NotifyListener#notify(List&lt;URL&gt;)}çš„å‚æ•°ã€‚</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@see</span> com.alibaba.dubbo.registry.NotifyListener#notify(List)</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> List&lt;URL&gt; <span class="title">lookup</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (url == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"lookup url == null"</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="comment">// å¾ªç¯åˆ†ç±»æ•°ç»„ï¼Œè·å¾—æ‰€æœ‰çš„ URL æ•°ç»„</span></span><br /><span class="line">        List&lt;String&gt; providers = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br /><span class="line">        <span class="keyword">for</span> (String path : toCategoriesPath(url)) {</span><br /><span class="line">            List&lt;String&gt; children = zkClient.getChildren(path);</span><br /><span class="line">            <span class="keyword">if</span> (children != <span class="keyword">null</span>) {</span><br /><span class="line">                providers.addAll(children);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// åŒ¹é…</span></span><br /><span class="line">        <span class="keyword">return</span> toUrlsWithoutEmpty(url, providers);</span><br /><span class="line">    } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Failed to lookup "</span> + url + <span class="string">" from zookeeper "</span> + getUrl() + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="3-7-isAvailable">3.7 isAvailable</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> zkClient.isConnected();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="3-8-destroy">3.8 destroy</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">super</span>.destroy();</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        zkClient.close();</span><br /><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line">        logger.warn(<span class="string">"Failed to close zookeeper client "</span> + getUrl() + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="4-è°ƒç”¨">4. è°ƒç”¨</h1>
<h2 id="4-1-æœåŠ¡æä¾›è€…">4.1 æœåŠ¡æä¾›è€…</h2>
<p>å›å¤´çœ‹&nbsp;<a href="http://svip.iocoder.cn/Dubbo/service-export-remote-dubbo/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡æš´éœ²ï¼ˆäºŒï¼‰ä¹‹è¿œç¨‹æš´éœ²ï¼ˆDubboï¼‰ã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/registry-zookeeper/">ã€Œ3.2.2 exportã€</a>&nbsp;å°èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š</p>
<ul>
<li>
<p>ç¬¬ 14 è¡Œï¼šè°ƒç”¨&nbsp;<code>#register(registryUrl, registedProviderUrl)</code>&nbsp;æ–¹æ³•ï¼Œå‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡æä¾›è€…ï¼ˆè‡ªå·±ï¼‰ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(URL registryUrl, URL registedProviderUrl)</span> </span>{</span><br /><span class="line">    Registry registry = registryFactory.getRegistry(registryUrl);</span><br /><span class="line">    registry.register(registedProviderUrl);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<h2 id="4-2-æœåŠ¡æ¶ˆè´¹è€…">4.2 æœåŠ¡æ¶ˆè´¹è€…</h2>
<p>å›å¤´çœ‹&nbsp;<a href="http://svip.iocoder.cn/Dubbo/reference-refer-dubbo/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡å¼•ç”¨ï¼ˆäºŒï¼‰ä¹‹è¿œç¨‹å¼•ç”¨ï¼ˆDubboï¼‰ã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/registry-zookeeper/">ã€Œ3.2.2 doRefer</a>&nbsp;å°èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š</p>
<ul>
<li>ç¬¬ 20 è‡³ 25 è¡Œï¼šè°ƒç”¨&nbsp;<code>RegistryService#register(url)</code>&nbsp;æ–¹æ³•ï¼Œå‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œ<strong>è‡ªå·±</strong>ï¼ˆæœåŠ¡æ¶ˆè´¹è€…ï¼‰ã€‚</li>
<li>ç¬¬ 35 è¡Œï¼šè°ƒç”¨&nbsp;<code>Directory#subscribe(url)</code>&nbsp;æ–¹æ³•ï¼Œå‘æ³¨å†Œä¸­å¿ƒè®¢é˜…æœåŠ¡æä¾›è€… + è·¯ç”±è§„åˆ™ + é…ç½®è§„åˆ™ã€‚
<ul>
<li>åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¼šå¾ªç¯è·å¾—åˆ°çš„æœåŠ¡ä½“ç”¨è¿™åˆ—è¡¨ï¼Œè°ƒç”¨&nbsp;<code>Protocol#refer(type, url)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºæ¯ä¸ªè°ƒç”¨æœåŠ¡çš„ Invoker å¯¹è±¡ã€‚</li>
</ul>
</li>
</ul>
</div>