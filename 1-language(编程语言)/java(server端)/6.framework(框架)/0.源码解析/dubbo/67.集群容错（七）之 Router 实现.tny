<header class="article-header">
<h1 class="article-title">é›†ç¾¤å®¹é”™ï¼ˆä¸ƒï¼‰ä¹‹ Router å®ç°</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡æ¥&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-6-impl-configurator/?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆå…­ï¼‰ä¹‹ Configurator å®ç°ã€‹</a>&nbsp;ä¸€æ–‡ï¼Œåˆ†äº«&nbsp;<code>dubbo-cluster</code>æ¨¡å—ï¼Œ&nbsp;<code>router</code>&nbsp;åŒ…ï¼Œå®ç° Dubbo çš„<strong>è·¯ç”±è§„åˆ™</strong>åŠŸèƒ½ã€‚</p>
<p>Router ç›¸å…³ç±»ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_04_30/02.png" alt="Router ç›¸å…³ç±»" /></p>
<blockquote>
<p>è€è‰¿è‰¿ï¼šæœ¬æ–‡å¯¹åº”&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/routing-rule.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; è·¯ç”±è§„åˆ™ã€‹</a>&nbsp;æ–‡æ¡£ã€‚å¦‚æœä¹‹å‰æ²¡äº†è§£è¿‡è¯¥åŠŸèƒ½çš„èƒ–å‹ï¼Œè¯·å…ˆé˜…è¯»äº†è§£ä¸‹å“ˆã€‚</p>
</blockquote>
<h1 id="2-RouterFactory">2. RouterFactory</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.RouterFactory</code>&nbsp;ï¼ŒRouter å·¥å‚<strong>æ¥å£</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@SPI</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RouterFactory</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Create router.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * åˆ›å»º Router å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> url</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> router</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="meta">@Adaptive</span>(<span class="string">"protocol"</span>)</span><br /><span class="line">    <span class="function">Router <span class="title">getRouter</span><span class="params">(URL url)</span></span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>@SPI</code>&nbsp;æ³¨è§£ï¼ŒDubbo SPI&nbsp;<strong>æ‹“å±•ç‚¹</strong>ï¼Œæ— é»˜è®¤å€¼ã€‚</li>
<li><code>@Adaptive("protocol")</code>&nbsp;æ³¨è§£ï¼ŒåŸºäº Dubbo SPI Adaptive æœºåˆ¶ï¼ŒåŠ è½½å¯¹åº”çš„ Router å®ç°ï¼Œä½¿ç”¨&nbsp;<code>URL.protocol</code>&nbsp;å±æ€§ã€‚</li>
<li><code>#getRouter(URL url)</code>&nbsp;æ¥å£æ–¹æ³•ï¼Œè·å¾— Router å¯¹è±¡ã€‚</li>
</ul>
<h2 id="2-1-ConditionRouterFactory">2.1 ConditionRouterFactory</h2>
<p><code>com.alibaba.dubbo.rpc.cluster.router.condition.ConditionRouterFactory</code>&nbsp;ï¼Œå®ç° RouterFactory æ¥å£ï¼Œ<strong>ConditionRouter</strong>&nbsp;å·¥å‚å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConditionRouterFactory</span> <span class="keyword">implements</span> <span class="title">RouterFactory</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">"condition"</span>;</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Router <span class="title">getRouter</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ConditionRouter(url);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¯¹åº” Router å®ç°ç±»ä¸º ConditionRouter ã€‚</li>
</ul>
<h2 id="2-2-ScriptRouterFactory">2.2 ScriptRouterFactory</h2>
<p><code>com.alibaba.dubbo.rpc.cluster.router.script.ScriptRouterFactory</code>&nbsp;ï¼Œå®ç° RouterFactory æ¥å£ï¼Œ<strong>ScriptRouter</strong>&nbsp;å·¥å‚å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScriptRouterFactory</span> <span class="keyword">implements</span> <span class="title">RouterFactory</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">"script"</span>;</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Router <span class="title">getRouter</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ScriptRouter(url);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¯¹åº” Router å®ç°ç±»ä¸º ScriptRouter ã€‚</li>
</ul>
<h2 id="2-3-FileRouterFactory">2.3 FileRouterFactory</h2>
<p><code>com.alibaba.dubbo.rpc.cluster.router.file.FileRouterFactory</code>&nbsp;ï¼Œå®ç° RouterFactory æ¥å£ï¼ŒåŸºäº<strong>æ–‡ä»¶</strong>è¯»å–è·¯ç”±è§„åˆ™ï¼Œåˆ›å»º<strong>å¯¹åº”çš„ Router å®ç°ç±»çš„å¯¹è±¡</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileRouterFactory</span> <span class="keyword">implements</span> <span class="title">RouterFactory</span> </span>{</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">"file"</span>;</span><br /><span class="line"> <span class="number">4</span>: </span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 6:      * RouterFactory$Adaptive å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> 7:      */</span></span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">private</span> RouterFactory routerFactory;</span><br /><span class="line"> <span class="number">9</span>: </span><br /><span class="line"><span class="number">10</span>:     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setRouterFactory</span><span class="params">(RouterFactory routerFactory)</span> </span>{</span><br /><span class="line"><span class="number">11</span>:         <span class="keyword">this</span>.routerFactory = routerFactory;</span><br /><span class="line"><span class="number">12</span>:     }</span><br /><span class="line"><span class="number">13</span>: </span><br /><span class="line"><span class="number">14</span>:     <span class="meta">@Override</span></span><br /><span class="line"><span class="number">15</span>:     <span class="function"><span class="keyword">public</span> Router <span class="title">getRouter</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line"><span class="number">16</span>:         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">17</span>:             <span class="comment">// Transform File URL into Script Route URL, and Load</span></span><br /><span class="line"><span class="number">18</span>:             <span class="comment">// file:///d:/path/to/route.js?router=script ==&gt; script:///d:/path/to/route.js?type=js&amp;rule=&lt;file-content&gt;</span></span><br /><span class="line"><span class="number">19</span>:             <span class="comment">// è·å¾— router é…ç½®é¡¹ï¼Œé»˜è®¤ä¸º script</span></span><br /><span class="line"><span class="number">20</span>:             String protocol = url.getParameter(Constants.ROUTER_KEY, ScriptRouterFactory.NAME); <span class="comment">// Replace original protocol (maybe 'file') with 'script'</span></span><br /><span class="line"><span class="number">21</span>:             <span class="comment">// ä½¿ç”¨æ–‡ä»¶åç¼€åšä¸ºç±»å‹</span></span><br /><span class="line"><span class="number">22</span>:             String type = <span class="keyword">null</span>; <span class="comment">// Use file suffix to config script type, e.g., js, groovy ...</span></span><br /><span class="line"><span class="number">23</span>:             String path = url.getPath();</span><br /><span class="line"><span class="number">24</span>:             <span class="keyword">if</span> (path != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">25</span>:                 <span class="keyword">int</span> i = path.lastIndexOf(<span class="string">'.'</span>);</span><br /><span class="line"><span class="number">26</span>:                 <span class="keyword">if</span> (i &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">27</span>:                     type = path.substring(i + <span class="number">1</span>);</span><br /><span class="line"><span class="number">28</span>:                 }</span><br /><span class="line"><span class="number">29</span>:             }</span><br /><span class="line"><span class="number">30</span>:             <span class="comment">// è¯»å–è§„åˆ™å†…å®¹</span></span><br /><span class="line"><span class="number">31</span>:             String rule = IOUtils.read(<span class="keyword">new</span> FileReader(<span class="keyword">new</span> File(url.getAbsolutePath())));</span><br /><span class="line"><span class="number">32</span>: </span><br /><span class="line"><span class="number">33</span>:             <span class="comment">// åˆ›å»ºè·¯ç”±è§„åˆ™ URL</span></span><br /><span class="line"><span class="number">34</span>:             <span class="keyword">boolean</span> runtime = url.getParameter(Constants.RUNTIME_KEY, <span class="keyword">false</span>);</span><br /><span class="line"><span class="number">35</span>:             URL script = url.setProtocol(protocol).addParameter(Constants.TYPE_KEY, type)</span><br /><span class="line"><span class="number">36</span>:                     .addParameter(Constants.RUNTIME_KEY, runtime)</span><br /><span class="line"><span class="number">37</span>:                     .addParameterAndEncoded(Constants.RULE_KEY, rule);</span><br /><span class="line"><span class="number">38</span>: </span><br /><span class="line"><span class="number">39</span>:             <span class="comment">// é€šè¿‡ Dubbo SPI Adaptive æœºåˆ¶ï¼Œè·å¾— Router å¯¹è±¡</span></span><br /><span class="line"><span class="number">40</span>:             <span class="keyword">return</span> routerFactory.getRouter(script);</span><br /><span class="line"><span class="number">41</span>:         } <span class="keyword">catch</span> (IOException e) {</span><br /><span class="line"><span class="number">42</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br /><span class="line"><span class="number">43</span>:         }</span><br /><span class="line"><span class="number">44</span>:     }</span><br /><span class="line"><span class="number">45</span>: </span><br /><span class="line"><span class="number">46</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 20 è¡Œï¼šè·å¾—&nbsp;<code>"router"</code>&nbsp;é…ç½®é¡¹ï¼Œé»˜è®¤ä¸º&nbsp;<code>"script"</code>&nbsp;ã€‚</li>
<li>ç¬¬ 21 è‡³ 29 è¡Œï¼šè·å¾—<strong>ç±»å‹</strong>ï¼ŒåŸºäºæ–‡ä»¶åç¼€ã€‚</li>
<li>ç¬¬ 31 è¡Œï¼šä»<strong>æ–‡ä»¶</strong>ä¸­ï¼Œè¯»å–<strong>è§„åˆ™å†…å®¹</strong>ã€‚</li>
<li>ç¬¬ 33 è‡³ 37 è¡Œï¼šåˆ›å»ºè·¯ç”±è§„åˆ™ URL å¯¹è±¡ã€‚</li>
<li>ç¬¬ 40 è¡Œï¼šé€šè¿‡ Dubbo SPI&nbsp;<strong>Adaptive</strong>&nbsp;æœºåˆ¶ï¼Œè·å¾—<strong>å¯¹åº”çš„ Router å¯¹è±¡</strong>ã€‚</li>
</ul>
<h1 id="3-Router">3. Router</h1>
<p><code>com.alibaba.dubbo.rpc.cluster.Router</code>&nbsp;ï¼Œå®ç° Comparable æ¥å£ï¼Œ<strong>è·¯ç”±è§„åˆ™</strong>æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Router</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;<span class="title">Router</span>&gt; </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * get the router url.</span></span><br /><span class="line"><span class="comment">     * &lt;p&gt;</span></span><br /><span class="line"><span class="comment">     * è·¯ç”±è§„åˆ™ URL</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> url</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function">URL <span class="title">getUrl</span><span class="params">()</span></span>;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * route.</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * è·¯ç”±ï¼Œç­›é€‰åŒ¹é…çš„ Invoker é›†åˆ</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> invokers   Invoker é›†åˆ</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> url        refer url</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> invocation</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> routed invokers è·¯ç”±åçš„ Invoker é›†åˆ</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@throws</span> RpcException</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    &lt;T&gt; List&lt;Invoker&lt;T&gt;&gt; route(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation) <span class="keyword">throws</span> RpcException;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><strong>ä¸€ä¸ª Router å¯¹è±¡ï¼Œå¯¹åº”ä¸€æ¡è·¯ç”±è§„åˆ™</strong>ã€‚</li>
<li>Configurator æœ‰<strong>ä¼˜å…ˆçº§</strong>çš„è¦æ±‚ï¼Œæ‰€ä»¥å®ç° Comparable æ¥å£ã€‚</li>
<li><code>#getUrl()</code>&nbsp;æ¥å£æ–¹æ³•ï¼Œè·å¾—è·¯ç”± URL ï¼Œé‡Œé¢å¸¦æœ‰è·¯ç”±è§„åˆ™ã€‚</li>
<li><code>#route(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation)</code>&nbsp;æ¥å£æ–¹æ³•ï¼Œè·¯ç”±ï¼Œç­›é€‰<strong>åŒ¹é…çš„</strong>Invoker é›†åˆã€‚</li>
</ul>
<h2 id="3-1-ConditionRouter">3.1 ConditionRouter</h2>
<p><code>com.alibaba.dubbo.rpc.cluster.router.condition.ConditionRouter</code>&nbsp;ï¼Œå®ç° Router æ¥å£ï¼Œ<strong>åŸºäºæ¡ä»¶è¡¨è¾¾å¼</strong>çš„ Router å®ç°ç±»ã€‚</p>
<blockquote>
<p>åŸºäºæ¡ä»¶è¡¨è¾¾å¼çš„è·¯ç”±è§„åˆ™ï¼Œå¦‚ï¼š<code>host = 10.20.153.10 =&gt; host = 10.20.153.11</code></p>
</blockquote>
<p><strong>æ³¨æ„</strong>ï¼Œèƒ–å‹ä¸€å®šè¦çœ‹äº†&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/routing-rule.html#%E6%9D%A1%E4%BB%B6%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; è·¯ç”±è§„åˆ™ã€‹</a>&nbsp;çš„&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-7-impl-router/">æ¡ä»¶è·¯ç”±è§„åˆ™</a>&nbsp;éƒ¨åˆ†ï¼Œä¸ç„¶ä¸‹é¢å½±å“ç†è§£ã€‚</p>
<h3 id="3-1-1-æ„é€ æ–¹æ³•">3.1.1 æ„é€ æ–¹æ³•</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * åˆ†ç»„æ­£åˆ™åŒ¹é…ï¼Œè¯¦ç»†è§ {<span class="doctag">@link</span> #parseRule(String)} æ–¹æ³•</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * å‰ [] ä¸ºåŒ¹é…ï¼Œåˆ†éš”ç¬¦</span></span><br /><span class="line"><span class="comment"> * å [] ä¸ºåŒ¹é…ï¼Œå†…å®¹</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Pattern ROUTE_PATTERN = Pattern.compile(<span class="string">"([&amp;!=,]*)\\s*([^&amp;!=,\\s]+)"</span>);</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·¯ç”±è§„åˆ™ URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·¯ç”±è§„åˆ™çš„ä¼˜å…ˆçº§ï¼Œç”¨äºæ’åºï¼Œä¼˜å…ˆçº§è¶Šå¤§è¶Šé å‰æ‰§è¡Œï¼Œå¯ä¸å¡«ï¼Œç¼ºçœä¸º 0 ã€‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> priority;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å½“è·¯ç”±ç»“æœä¸ºç©ºæ—¶ï¼Œæ˜¯å¦å¼ºåˆ¶æ‰§è¡Œï¼Œå¦‚æœä¸å¼ºåˆ¶æ‰§è¡Œï¼Œè·¯ç”±ç»“æœä¸ºç©ºçš„è·¯ç”±è§„åˆ™å°†è‡ªåŠ¨å¤±æ•ˆï¼Œå¯ä¸å¡«ï¼Œç¼ºçœä¸º false ã€‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> force;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ¶ˆè´¹è€…åŒ¹é…æ¡ä»¶é›†åˆï¼Œé€šè¿‡è§£æã€æ¡ä»¶è¡¨è¾¾å¼ rule çš„ `=&gt;` ä¹‹å‰åŠéƒ¨åˆ†ã€‘</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, MatchPair&gt; whenCondition;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æä¾›è€…åœ°å€åˆ—è¡¨çš„è¿‡æ»¤æ¡ä»¶ï¼Œé€šè¿‡è§£æã€æ¡ä»¶è¡¨è¾¾å¼ rule çš„ `=&gt;` ä¹‹ååŠéƒ¨åˆ†ã€‘</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, MatchPair&gt; thenCondition;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConditionRouter</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.url = url;</span><br /><span class="line">    <span class="keyword">this</span>.priority = url.getParameter(Constants.PRIORITY_KEY, <span class="number">0</span>);</span><br /><span class="line">    <span class="keyword">this</span>.force = url.getParameter(Constants.FORCE_KEY, <span class="keyword">false</span>);</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="comment">// æ‹†åˆ†æ¡ä»¶å˜å¤§æ—¶ä¸º when å’Œ then ä¸¤éƒ¨åˆ†</span></span><br /><span class="line">        String rule = url.getParameterAndDecoded(Constants.RULE_KEY);</span><br /><span class="line">        <span class="keyword">if</span> (rule == <span class="keyword">null</span> || rule.trim().length() == <span class="number">0</span>) {</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Illegal route rule!"</span>);</span><br /><span class="line">        }</span><br /><span class="line">        rule = rule.replace(<span class="string">"consumer."</span>, <span class="string">""</span>).replace(<span class="string">"provider."</span>, <span class="string">""</span>);</span><br /><span class="line">        <span class="keyword">int</span> i = rule.indexOf(<span class="string">"=&gt;"</span>);</span><br /><span class="line">        String whenRule = i &lt; <span class="number">0</span> ? <span class="keyword">null</span> : rule.substring(<span class="number">0</span>, i).trim();</span><br /><span class="line">        String thenRule = i &lt; <span class="number">0</span> ? rule.trim() : rule.substring(i + <span class="number">2</span>).trim();</span><br /><span class="line">        <span class="comment">// è§£æ `whenCondition`</span></span><br /><span class="line">        Map&lt;String, MatchPair&gt; when = StringUtils.isBlank(whenRule) || <span class="string">"true"</span>.equals(whenRule) ? <span class="keyword">new</span> HashMap&lt;String, MatchPair&gt;() : parseRule(whenRule);</span><br /><span class="line">        <span class="comment">// è§£æ `thenCondition`</span></span><br /><span class="line">        Map&lt;String, MatchPair&gt; then = StringUtils.isBlank(thenRule) || <span class="string">"false"</span>.equals(thenRule) ? <span class="keyword">null</span> : parseRule(thenRule);</span><br /><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> It should be determined on the business level whether the `When condition` can be empty or not.</span></span><br /><span class="line">        <span class="keyword">this</span>.whenCondition = when;</span><br /><span class="line">        <span class="keyword">this</span>.thenCondition = then;</span><br /><span class="line">    } <span class="keyword">catch</span> (ParseException e) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e.getMessage(), e);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ¯ä¸ªå­—æ®µçš„è§£é‡Šï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹æ³¨é‡Šã€‚</li>
<li>MatchPair ï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-7-impl-router/">ã€Œ3.1.2 MatchPairã€</a>&nbsp;ä¸­ã€‚</li>
<li><code>#parseRule()</code>&nbsp;æ–¹æ³•ï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-7-impl-router/">ã€Œ3.1.3 parseRuleã€</a>&nbsp;ä¸­ã€‚</li>
</ul>
<h3 id="3-1-2-MatchPair">3.1.2 MatchPair</h3>
<p>MatchPair ä¸º ConditionRouter çš„<strong>å†…éƒ¨é™æ€ç±»</strong>ï¼Œç”¨äºåŒ¹é…çš„å€¼<strong>ç»„</strong>ã€‚<strong>æ¯ä¸ª</strong>å±æ€§æ¡ä»¶ï¼Œä¾‹å¦‚&nbsp;<code>method</code>&nbsp;<code>host</code>ç­‰ï¼Œå¯¹åº”<strong>ä¸€ä¸ª</strong>&nbsp;MatchPair å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MatchPair</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * åŒ¹é…çš„å€¼é›†åˆ</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">final</span> Set&lt;String&gt; matches = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * ä¸åŒ¹é…çš„å€¼é›†åˆ</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">final</span> Set&lt;String&gt; mismatches = <span class="keyword">new</span> HashSet&lt;String&gt;();</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * åˆ¤æ–­ value æ˜¯å¦åŒ¹é… matches + mismatches</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> value å€¼</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> param URL</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@return</span> æ˜¯å¦åŒ¹é…</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isMatch</span><span class="params">(String value, URL param)</span> </span>{</span><br /><span class="line">        <span class="comment">// åªåŒ¹é… matches</span></span><br /><span class="line">        <span class="keyword">if</span> (!matches.isEmpty() &amp;&amp; mismatches.isEmpty()) {</span><br /><span class="line">            <span class="keyword">for</span> (String match : matches) {</span><br /><span class="line">                <span class="keyword">if</span> (UrlUtils.isMatchGlobPattern(match, value, param)) {</span><br /><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// å¦‚æœæ²¡åŒ¹é…ä¸Šï¼Œè®¤ä¸ºä¸º false ï¼Œå³ä¸åŒ¹é…</span></span><br /><span class="line">        }</span><br /><br /><span class="line">        <span class="comment">// åªåŒ¹é… mismatches</span></span><br /><span class="line">        <span class="keyword">if</span> (!mismatches.isEmpty() &amp;&amp; matches.isEmpty()) {</span><br /><span class="line">            <span class="keyword">for</span> (String mismatch : mismatches) {</span><br /><span class="line">                <span class="keyword">if</span> (UrlUtils.isMatchGlobPattern(mismatch, value, param)) {</span><br /><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// æ³¨æ„ï¼Œè¿™é‡Œå’Œä¸Šé¢ä¸åŒã€‚åŸå› ï¼Œä½ æ‡‚çš„ã€‚</span></span><br /><span class="line">        }</span><br /><br /><span class="line">        <span class="comment">// åŒ¹é… mismatches + matches</span></span><br /><span class="line">        <span class="keyword">if</span> (!matches.isEmpty()) {</span><br /><span class="line">            <span class="comment">//when both mismatches and matches contain the same value, then using mismatches first</span></span><br /><span class="line">            <span class="keyword">for</span> (String mismatch : mismatches) {</span><br /><span class="line">                <span class="keyword">if</span> (UrlUtils.isMatchGlobPattern(mismatch, value, param)) {</span><br /><span class="line">                    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">            <span class="keyword">for</span> (String match : matches) {</span><br /><span class="line">                <span class="keyword">if</span> (UrlUtils.isMatchGlobPattern(match, value, param)) {</span><br /><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// å¦‚æœæ²¡åŒ¹é…ä¸Šï¼Œè®¤ä¸ºä¸º false ï¼Œå³ä¸åŒ¹é…</span></span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>#isMatch(String value, URL param)</code>&nbsp;æ–¹æ³•ï¼Œåˆ¤æ–­&nbsp;<code>value</code>&nbsp;æ˜¯å¦<strong>åŒ¹é…</strong>&nbsp;<code>matches</code>&nbsp;å’Œ&nbsp;<code>mismatches</code>&nbsp;ã€‚</p>
<ul>
<li>é‚£ä¹ˆä¸ºä»€ä¹ˆä¼šæœ‰&nbsp;<code>param</code>&nbsp;å‚æ•°å‘¢ï¼Ÿå› ä¸ºè¦æ”¯æŒ&nbsp;<code>$</code>&nbsp;ä» URL ä¸­ï¼Œè¯»å–å‚æ•°ã€‚</li>
<li>
<p><code>#UrlUtils#isMatchGlobPattern(match, value, URL)</code>&nbsp;æ–¹æ³•ï¼Œæ”¯æŒ&nbsp;<code>*</code>&nbsp;é€šé…ï¼Œåˆ¤æ–­&nbsp;<code>match</code>&nbsp;å’Œ&nbsp;<code>value</code>&nbsp;æ˜¯å¦åŒ¹é…ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMatchGlobPattern</span><span class="params">(String pattern, String value, URL param)</span> </span>{</span><br /><span class="line">    <span class="comment">// ä»¥ç¾å…ƒç¬¦ `$` å¼€å¤´ï¼Œè¡¨ç¤ºå¼•ç”¨å‚æ•°</span></span><br /><span class="line">    <span class="keyword">if</span> (param != <span class="keyword">null</span> &amp;&amp; pattern.startsWith(<span class="string">"$"</span>)) {</span><br /><span class="line">        pattern = param.getRawParameter(pattern.substring(<span class="number">1</span>));</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// åŒ¹é…</span></span><br /><span class="line">    <span class="keyword">return</span> isMatchGlobPattern(pattern, value);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isMatchGlobPattern</span><span class="params">(String pattern, String value)</span> </span>{</span><br /><span class="line">    <span class="comment">// å…¨åŒ¹é…</span></span><br /><span class="line">    <span class="keyword">if</span> (<span class="string">"*"</span>.equals(pattern)) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// å…¨éƒ¨ä¸ºç©ºï¼ŒåŒ¹é…</span></span><br /><span class="line">    <span class="keyword">if</span> ((pattern == <span class="keyword">null</span> || pattern.length() == <span class="number">0</span>) &amp;&amp; (value == <span class="keyword">null</span> || value.length() == <span class="number">0</span>)) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// æœ‰ä¸€ä¸ªä¸ºç©ºï¼Œä¸åŒ¹é…</span></span><br /><span class="line">    <span class="keyword">if</span> ((pattern == <span class="keyword">null</span> || pattern.length() == <span class="number">0</span>) || (value == <span class="keyword">null</span> || value.length() == <span class="number">0</span>)) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">// æ”¯æŒ * çš„é€šé…</span></span><br /><span class="line">    <span class="keyword">int</span> i = pattern.lastIndexOf(<span class="string">'*'</span>);</span><br /><span class="line">    <span class="comment">// doesn't find "*"</span></span><br /><span class="line">    <span class="keyword">if</span> (i == -<span class="number">1</span>) {</span><br /><span class="line">        <span class="keyword">return</span> value.equals(pattern);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// "*" is at the end</span></span><br /><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (i == pattern.length() - <span class="number">1</span>) {</span><br /><span class="line">        <span class="keyword">return</span> value.startsWith(pattern.substring(<span class="number">0</span>, i));</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// "*" is at the beginning</span></span><br /><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (i == <span class="number">0</span>) {</span><br /><span class="line">        <span class="keyword">return</span> value.endsWith(pattern.substring(i + <span class="number">1</span>));</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// "*" is in the middle</span></span><br /><span class="line">    <span class="keyword">else</span> {</span><br /><span class="line">        String prefix = pattern.substring(<span class="number">0</span>, i);</span><br /><span class="line">        String suffix = pattern.substring(i + <span class="number">1</span>);</span><br /><span class="line">        <span class="keyword">return</span> value.startsWith(prefix) &amp;&amp; value.endsWith(suffix);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>x</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>ğŸ˜ˆ ä»£ç æ¯”è¾ƒç®€å•ï¼Œæ‰€ä»¥èƒ–å‹è‡ªå·±è¯»ä¸‹ã€‚</p>
<h3 id="3-1-3-parseRule">3.1.3 parseRule</h3>
<p><code>#parseRule(rule)</code>&nbsp;æ–¹æ³•ï¼Œè§£æè·¯ç”±é…ç½®å†…å®¹&nbsp;<code>"rule"</code>&nbsp;ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, MatchPair&gt; <span class="title">parseRule</span><span class="params">(String rule)</span> <span class="keyword">throws</span> ParseException </span>{</span><br /><span class="line"> <span class="number">2</span>: <span class="comment">//    System.out.println("rule: " + rule); // add by èŠ‹è‰¿ï¼Œæ–¹ä¾¿å¤§å®¶çœ‹</span></span><br /><span class="line"> <span class="number">3</span>:     Map&lt;String, MatchPair&gt; condition = <span class="keyword">new</span> HashMap&lt;String, MatchPair&gt;();</span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (StringUtils.isBlank(rule)) {</span><br /><span class="line"> <span class="number">5</span>:         <span class="keyword">return</span> condition;</span><br /><span class="line"> <span class="number">6</span>:     }</span><br /><span class="line"> <span class="number">7</span>:     <span class="comment">// Key-Value pair, stores both match and mismatch conditions</span></span><br /><span class="line"> <span class="number">8</span>:     MatchPair pair = <span class="keyword">null</span>;</span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// Multiple values</span></span><br /><span class="line"><span class="number">10</span>:     Set&lt;String&gt; values = <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">11</span>:     <span class="keyword">final</span> Matcher matcher = ROUTE_PATTERN.matcher(rule);</span><br /><span class="line"><span class="number">12</span>:     <span class="keyword">while</span> (matcher.find()) { <span class="comment">// Try to match one by one</span></span><br /><span class="line"><span class="number">13</span>:         String separator = matcher.group(<span class="number">1</span>);</span><br /><span class="line"><span class="number">14</span>:         String content = matcher.group(<span class="number">2</span>);</span><br /><span class="line"><span class="number">15</span>: <span class="comment">//        System.out.println(separator + "\t" + content); // add by èŠ‹è‰¿ï¼Œæ–¹ä¾¿å¤§å®¶çœ‹</span></span><br /><span class="line"><span class="number">16</span>:         <span class="comment">// Start part of the condition expression.</span></span><br /><span class="line"><span class="number">17</span>:         <span class="keyword">if</span> (separator == <span class="keyword">null</span> || separator.length() == <span class="number">0</span>) {</span><br /><span class="line"><span class="number">18</span>:             pair = <span class="keyword">new</span> MatchPair();</span><br /><span class="line"><span class="number">19</span>:             condition.put(content, pair);</span><br /><span class="line"><span class="number">20</span>:         }</span><br /><span class="line"><span class="number">21</span>:         <span class="comment">// The KV part of the condition expression</span></span><br /><span class="line"><span class="number">22</span>:         <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"&amp;"</span>.equals(separator)) {</span><br /><span class="line"><span class="number">23</span>:             <span class="keyword">if</span> (condition.get(content) == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">24</span>:                 pair = <span class="keyword">new</span> MatchPair();</span><br /><span class="line"><span class="number">25</span>:                 condition.put(content, pair);</span><br /><span class="line"><span class="number">26</span>:             } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">27</span>:                 pair = condition.get(content);</span><br /><span class="line"><span class="number">28</span>:             }</span><br /><span class="line"><span class="number">29</span>:         }</span><br /><span class="line"><span class="number">30</span>:         <span class="comment">// The Value in the KV part.</span></span><br /><span class="line"><span class="number">31</span>:         <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"="</span>.equals(separator)) {</span><br /><span class="line"><span class="number">32</span>:             <span class="keyword">if</span> (pair == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">33</span>:                 <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(<span class="string">"Illegal route rule \""</span> + rule + <span class="string">"\", The error char '"</span> + separator + <span class="string">"' at index "</span> + matcher.start() + <span class="string">" before \""</span> + content + <span class="string">"\"."</span>, matcher.start());</span><br /><span class="line"><span class="number">34</span>:             }</span><br /><span class="line"><span class="number">35</span>:             values = pair.matches;</span><br /><span class="line"><span class="number">36</span>:             values.add(content);</span><br /><span class="line"><span class="number">37</span>:         }</span><br /><span class="line"><span class="number">38</span>:         <span class="comment">// The Value in the KV part.</span></span><br /><span class="line"><span class="number">39</span>:         <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"!="</span>.equals(separator)) {</span><br /><span class="line"><span class="number">40</span>:             <span class="keyword">if</span> (pair == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">41</span>:                 <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(<span class="string">"Illegal route rule \""</span> + rule + <span class="string">"\", The error char '"</span> + separator + <span class="string">"' at index "</span> + matcher.start() + <span class="string">" before \""</span> + content + <span class="string">"\"."</span>, matcher.start());</span><br /><span class="line"><span class="number">42</span>:             }</span><br /><span class="line"><span class="number">43</span>:             values = pair.mismatches;</span><br /><span class="line"><span class="number">44</span>:             values.add(content);</span><br /><span class="line"><span class="number">45</span>:         }</span><br /><span class="line"><span class="number">46</span>:         <span class="comment">// The Value in the KV part, if Value have more than one items.</span></span><br /><span class="line"><span class="number">47</span>:         <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">","</span>.equals(separator)) { <span class="comment">// Should be seperateed by ','</span></span><br /><span class="line"><span class="number">48</span>:             <span class="keyword">if</span> (values == <span class="keyword">null</span> || values.isEmpty()) {</span><br /><span class="line"><span class="number">49</span>:                 <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(<span class="string">"Illegal route rule \""</span> + rule + <span class="string">"\", The error char '"</span> + separator + <span class="string">"' at index "</span> + matcher.start() + <span class="string">" before \""</span> + content + <span class="string">"\"."</span>, matcher.start());</span><br /><span class="line"><span class="number">50</span>:             }</span><br /><span class="line"><span class="number">51</span>:             values.add(content);</span><br /><span class="line"><span class="number">52</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">53</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> ParseException(<span class="string">"Illegal route rule \""</span> + rule + <span class="string">"\", The error char '"</span> + separator + <span class="string">"' at index "</span> + matcher.start() + <span class="string">" before \""</span> + content + <span class="string">"\"."</span>, matcher.start());</span><br /><span class="line"><span class="number">54</span>:         }</span><br /><span class="line"><span class="number">55</span>:     }</span><br /><span class="line"><span class="number">56</span>:     <span class="keyword">return</span> condition;</span><br /><span class="line"><span class="number">57</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ç¬¬ 11 è‡³ 14 è¡Œï¼šé€šè¿‡&nbsp;<code>ROUTE_PATTERN</code>&nbsp;æ­£åˆ™åŒ¹é…&nbsp;<code>rule</code>&nbsp;ï¼Œ<strong>å¾ªç¯</strong>å¤šæ¬¡ï¼Œç›´åˆ°ç»“æŸã€‚å¦‚ä¸‹æ˜¯ä¸¤ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight plain">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">rule: host = 192.168.3.17 &amp; method = say01</span><br /><span class="line">	host</span><br /><span class="line">=	192.168.3.17</span><br /><span class="line">&amp;	method</span><br /><span class="line">=	say01</span><br /><br /><span class="line">---------- åˆ†å‰²çº¿ ---------- </span><br /><br /><span class="line">rule: host = 192.168.3.17</span><br /><span class="line">	host</span><br /><span class="line">=	192.168.3.17</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 16 è‡³ 29 è¡Œï¼šå¤„ç†æ¡ä»¶<strong>å±æ€§</strong>çš„æƒ…å†µï¼Œä¾‹å¦‚ï¼š<code>host</code>&nbsp;å’Œ&nbsp;<code>&amp; method</code>&nbsp;ç­‰ç­‰ï¼Œæ­¤æ—¶ä¼šè·å¾—å¯¹åº”çš„ MatchPair å¯¹è±¡ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œåˆ›å»º MatchPair å¯¹è±¡ã€‚</p>
</li>
<li>ç¬¬ 30 è‡³ 45 è¡Œï¼šå¤„ç†æ¡ä»¶<strong>æ¡ä»¶å€¼</strong>çš„æƒ…å†µï¼Œä¾‹å¦‚ï¼š<code>= 192.168.3.17</code>&nbsp;å’Œ&nbsp;<code>!= say01</code>&nbsp;ç­‰ç­‰ï¼Œæ­¤æ—¶ä¼šæ·»åŠ åˆ° MatchPair çš„&nbsp;<code>matches</code>&nbsp;æˆ–&nbsp;<code>mismatches</code>&nbsp;ä¸­ã€‚
<ul>
<li>ç¬¬ 46 è‡³ 51 è¡Œï¼šå¤„ç†æ¡ä»¶<strong>æ¡ä»¶å€¼</strong>ä»¥é€—å·(&nbsp;<code>,</code>&nbsp;)åˆ†éš”å¤šä¸ªå€¼çš„æƒ…å†µï¼Œæ­¤æ—¶<strong>ä¹Ÿä¼š</strong>æ·»åŠ åˆ° MatchPair çš„&nbsp;<code>matches</code>&nbsp;æˆ–&nbsp;<code>mismatches</code>&nbsp;ä¸­ã€‚</li>
</ul>
</li>
<li>ç¬¬ 52 è‡³ 54 è¡Œï¼šéæ³•ï¼ŒæŠ›å‡º ParseException å¼‚å¸¸ã€‚</li>
</ul>
<h3 id="3-1-4-route">3.1.4 route</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">public</span> &lt;T&gt; List&lt;Invoker&lt;T&gt;&gt; route(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation) <span class="keyword">throws</span> RpcException {</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// ä¸ºç©ºï¼Œç›´æ¥è¿”å›ç©º Invoker é›†åˆ</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (invokers == <span class="keyword">null</span> || invokers.isEmpty()) {</span><br /><span class="line"> <span class="number">5</span>:         <span class="keyword">return</span> invokers;</span><br /><span class="line"> <span class="number">6</span>:     }</span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">8</span>:         <span class="comment">// ä¸åŒ¹é… `whenCondition` ï¼Œç›´æ¥è¿”å› `invokers` é›†åˆï¼Œå› ä¸ºä¸éœ€è¦èµ° `whenThen` çš„åŒ¹é…</span></span><br /><span class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (!matchWhen(url, invocation)) {</span><br /><span class="line"><span class="number">10</span>:             <span class="keyword">return</span> invokers;</span><br /><span class="line"><span class="number">11</span>:         }</span><br /><span class="line"><span class="number">12</span>:         List&lt;Invoker&lt;T&gt;&gt; result = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;();</span><br /><span class="line"><span class="number">13</span>:         <span class="comment">// `whenThen` ä¸ºç©ºï¼Œåˆ™è¿”å›ç©º Invoker é›†åˆ</span></span><br /><span class="line"><span class="number">14</span>:         <span class="keyword">if</span> (thenCondition == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">15</span>:             logger.warn(<span class="string">"The current consumer in the service blacklist. consumer: "</span> + NetUtils.getLocalHost() + <span class="string">", service: "</span> + url.getServiceKey());</span><br /><span class="line"><span class="number">16</span>:             <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">17</span>:         }</span><br /><span class="line"><span class="number">18</span>:         <span class="comment">// ä½¿ç”¨ `whenThen` ï¼ŒåŒ¹é… `invokers` é›†åˆã€‚è‹¥ç¬¦åˆï¼Œæ·»åŠ åˆ° `result` ä¸­</span></span><br /><span class="line"><span class="number">19</span>:         <span class="keyword">for</span> (Invoker&lt;T&gt; invoker : invokers) {</span><br /><span class="line"><span class="number">20</span>:             <span class="keyword">if</span> (matchThen(invoker.getUrl(), url)) {</span><br /><span class="line"><span class="number">21</span>:                 result.add(invoker);</span><br /><span class="line"><span class="number">22</span>:             }</span><br /><span class="line"><span class="number">23</span>:         }</span><br /><span class="line"><span class="number">24</span>:         <span class="comment">// è‹¥ `result` éç©ºï¼Œè¿”å›å®ƒ</span></span><br /><span class="line"><span class="number">25</span>:         <span class="keyword">if</span> (!result.isEmpty()) {</span><br /><span class="line"><span class="number">26</span>:             <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">27</span>:         <span class="comment">// å¦‚æœ `force=true` ï¼Œä»£è¡¨å¼ºåˆ¶æ‰§è¡Œï¼Œè¿”å›ç©º Invoker é›†åˆ</span></span><br /><span class="line"><span class="number">28</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (force) {</span><br /><span class="line"><span class="number">29</span>:             logger.warn(<span class="string">"The route result is empty and force execute. consumer: "</span> + NetUtils.getLocalHost() + <span class="string">", service: "</span> + url.getServiceKey() + <span class="string">", router: "</span> + url.getParameterAndDecoded(Constants.RULE_KEY));</span><br /><span class="line"><span class="number">30</span>:             <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">31</span>:         }</span><br /><span class="line"><span class="number">32</span>:     } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">33</span>:         logger.error(<span class="string">"Failed to execute condition router rule: "</span> + getUrl() + <span class="string">", invokers: "</span> + invokers + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">34</span>:     }</span><br /><span class="line"><span class="number">35</span>:     <span class="comment">// å¦‚æœ `force=false` ï¼Œä»£è¡¨ä¸å¼ºåˆ¶æ‰§è¡Œï¼Œè¿”å› `invokers` é›†åˆï¼Œå³å¿½ç•¥è·¯ç”±è§„åˆ™</span></span><br /><span class="line"><span class="number">36</span>:     <span class="keyword">return</span> invokers;</span><br /><span class="line"><span class="number">37</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è‡³ 6 è¡Œï¼šè‹¥&nbsp;<code>invokers</code>&nbsp;ä¸ºç©ºï¼Œç›´æ¥è¿”å›<strong>ç©º</strong>&nbsp;Invoker é›†åˆã€‚</li>
<li>
<p>ç¬¬ 8 è‡³ 11 è¡Œï¼šè°ƒç”¨&nbsp;<code>#matchWhen(url, invocation)</code>&nbsp;æ–¹æ³•ï¼Œä½¿ç”¨æœåŠ¡<strong>æ¶ˆè´¹è€…</strong>&nbsp;<code>url</code>&nbsp;åŒ¹é…&nbsp;<code>whenCondition</code>&nbsp;ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">matchWhen</span><span class="params">(URL url, Invocation invocation)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> whenCondition == <span class="keyword">null</span> || whenCondition.isEmpty() || matchCondition(whenCondition, url, <span class="keyword">null</span>, invocation);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¦‚æœåŒ¹é…æ¡ä»¶ä¸ºç©ºï¼Œè¡¨ç¤ºå¯¹æ‰€æœ‰æ¶ˆè´¹æ–¹åº”ç”¨ï¼Œå¦‚ï¼š<code>=&gt; host != 10.20.153.11</code>&nbsp;ã€‚</li>
<li>è‹¥<strong>ä¸åŒ¹é…</strong>ï¼Œåˆ™ç›´æ¥è¿”å›<strong>å…¨</strong>&nbsp;<code>invokers</code>&nbsp;é›†åˆï¼Œå› ä¸ºä¸éœ€è¦èµ°&nbsp;<code>whenThen</code>&nbsp;çš„åŒ¹é…ã€‚</li>
<li><code>#matchCondition(...)</code>&nbsp;æ–¹æ³•çš„è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-7-impl-router/">ã€Œ3.1.5 matchConditionã€</a>&nbsp;ã€‚</li>
</ul>
</li>
<li>ç¬¬ 13 è‡³ 17 è¡Œï¼šè‹¥&nbsp;<code>whenThen</code>&nbsp;ä¸ºç©ºï¼Œåˆ™è¿”å›<strong>ç©º</strong>&nbsp;Invoker é›†åˆã€‚</li>
<li>
<p>ç¬¬ 18 è‡³ 23 è¡Œï¼š<strong>å¾ªç¯</strong>è°ƒç”¨&nbsp;<code>#matchThen(url, invocation)</code>&nbsp;æ–¹æ³•ï¼Œä½¿ç”¨æœåŠ¡<strong>æä¾›è€…è€…</strong>&nbsp;<code>invokers</code>&nbsp;çš„ URL ï¼ŒåŒ¹é…&nbsp;<code>whenThen</code>&nbsp;é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">matchThen</span><span class="params">(URL url, URL param)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> !(thenCondition == <span class="keyword">null</span> || thenCondition.isEmpty()) &amp;&amp; matchCondition(thenCondition, url, param, <span class="keyword">null</span>);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¦‚æœè¿‡æ»¤æ¡ä»¶ä¸ºç©ºï¼Œè¡¨ç¤ºç¦æ­¢è®¿é—®ï¼Œå¦‚ï¼š<code>host = 10.20.153.10 =&gt;</code>&nbsp;ã€‚</li>
<li>è‹¥<strong>åŒ¹é…</strong>ï¼Œæ·»åŠ åˆ°&nbsp;<code>result</code>&nbsp;ä¸­ã€‚</li>
</ul>
</li>
<li>========== å¤„ç†&nbsp;<code>result</code>&nbsp;+&nbsp;<code>force</code>&nbsp;çš„<strong>ä¸‰ç§</strong>æƒ…å†µ ==========</li>
<li>ç¬¬ 24 è‡³ 26 è¡Œï¼šè‹¥&nbsp;<code>result</code>&nbsp;<strong>éç©º</strong>ï¼Œè¿”å›<strong>å®ƒ</strong>ã€‚</li>
<li>ç¬¬ 27 è‡³ 31 è¡Œï¼šè‹¥&nbsp;<code>result</code>&nbsp;<strong>ä¸ºç©º</strong>ï¼Œå¦‚æœ&nbsp;<code>force=true</code>&nbsp;ï¼Œä»£è¡¨å¼ºåˆ¶æ‰§è¡Œï¼Œè¿”å›<strong>ç©º</strong>&nbsp;Invoker é›†åˆã€‚</li>
<li>ç¬¬ 36 è¡Œï¼šè‹¥&nbsp;<code>result</code>&nbsp;<strong>ä¸ºç©º</strong>ï¼Œå¦‚æœ&nbsp;<code>force=false</code>&nbsp;ï¼Œä»£è¡¨<strong>ä¸</strong>å¼ºåˆ¶æ‰§è¡Œï¼Œè¿”å›<strong>å…¨</strong>&nbsp;<code>invokers</code>&nbsp;é›†åˆï¼Œå³<strong>å¿½ç•¥</strong>è·¯ç”±è§„åˆ™ã€‚</li>
</ul>
<p>ğŸ˜ˆ æƒ…å†µæ¯”è¾ƒå¤šï¼Œèƒ–å‹å¯ä»¥å›è¿‡å¤´åœ¨ç†ä¸€ç†ã€‚</p>
<h4 id="3-1-5-matchCondition">3.1.5 matchCondition</h4>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">matchCondition</span><span class="params">(Map&lt;String, MatchPair&gt; condition, URL url, URL param, Invocation invocation)</span> </span>{</span><br /><span class="line">    Map&lt;String, String&gt; sample = url.toMap();</span><br /><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>; <span class="comment">// æ˜¯å¦åŒ¹é…</span></span><br /><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, MatchPair&gt; matchPair : condition.entrySet()) {</span><br /><span class="line">        <span class="comment">// è·å¾—æ¡ä»¶å±æ€§</span></span><br /><span class="line">        String key = matchPair.getKey();</span><br /><span class="line">        String sampleValue;</span><br /><span class="line">        <span class="comment">// get real invoked method name from invocation</span></span><br /><span class="line">        <span class="keyword">if</span> (invocation != <span class="keyword">null</span> &amp;&amp; (Constants.METHOD_KEY.equals(key) || Constants.METHODS_KEY.equals(key))) {</span><br /><span class="line">            sampleValue = invocation.getMethodName();</span><br /><span class="line">        } <span class="keyword">else</span> {</span><br /><span class="line">            sampleValue = sample.get(key);</span><br /><span class="line">            <span class="keyword">if</span> (sampleValue == <span class="keyword">null</span>) {</span><br /><span class="line">                sampleValue = sample.get(Constants.DEFAULT_KEY_PREFIX + key);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// åŒ¹é…æ¡ä»¶å€¼</span></span><br /><span class="line">        <span class="keyword">if</span> (sampleValue != <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="keyword">if</span> (!matchPair.getValue().isMatch(sampleValue, param)) { <span class="comment">// è¿”å›ä¸åŒ¹é…</span></span><br /><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">            } <span class="keyword">else</span> {</span><br /><span class="line">                result = <span class="keyword">true</span>;</span><br /><span class="line">            }</span><br /><span class="line">        } <span class="keyword">else</span> {</span><br /><span class="line">            <span class="comment">// not pass the condition</span></span><br /><span class="line">            <span class="keyword">if</span> (!matchPair.getValue().matches.isEmpty()) { <span class="comment">// æ— æ¡ä»¶å€¼ï¼Œä½†æ˜¯æœ‰åŒ¹é…æ¡ä»¶ `matches` ï¼Œåˆ™è¿”å›ä¸åŒ¹é…ã€‚</span></span><br /><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">            } <span class="keyword">else</span> {</span><br /><span class="line">                result = <span class="keyword">true</span>;</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> result;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="3-1-5-compareTo">3.1.5 compareTo</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Router o)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (o == <span class="keyword">null</span> || o.getClass() != ConditionRouter.class) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br /><span class="line">    }</span><br /><span class="line">    ConditionRouter c = (ConditionRouter) o;</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.priority == c.priority ? url.toFullString().compareTo(c.url.toFullString()) : (<span class="keyword">this</span>.priority &gt; c.priority ? <span class="number">1</span> : -<span class="number">1</span>);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä¼˜å…ˆï¼ŒæŒ‰ç…§&nbsp;<code>"priority"</code>&nbsp;<strong>é™åº</strong>ã€‚</li>
<li>å…¶æ¬¡ï¼ŒæŒ‰ç…§&nbsp;<code>"url"</code>&nbsp;<strong>å‡åº</strong>ã€‚</li>
</ul>
<h2 id="3-2-ScriptRouter">3.2 ScriptRouter</h2>
<p><code>com.alibaba.dubbo.rpc.cluster.router.script.ScriptRouter</code>&nbsp;ï¼Œå®ç° Router æ¥å£ï¼ŒåŸºäº<strong>è„šæœ¬</strong>çš„ Router å®ç°ç±»ã€‚</p>
<blockquote>
<p>è„šæœ¬è·¯ç”±è§„åˆ™&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/routing-rule.html#fn_4" target="_blank" rel="external nofollow noopener noreferrer">4</a>&nbsp;æ”¯æŒ JDK è„šæœ¬å¼•æ“çš„æ‰€æœ‰è„šæœ¬ï¼Œæ¯”å¦‚ï¼šjavascript, jruby, groovy ç­‰ï¼Œé€šè¿‡&nbsp;<code>type=javascript</code>&nbsp;å‚æ•°è®¾ç½®è„šæœ¬ç±»å‹ï¼Œç¼ºçœä¸º javascriptã€‚</p>
</blockquote>
<blockquote>
<figure class="highlight plain">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">&gt; "script://0.0.0.0/com.foo.BarService?category=routers&amp;dynamic=false&amp;rule=" + URL.encode("function route(invokers) { ... } (invokers)")</span><br /><span class="line">&gt;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</blockquote>
<blockquote>
<p>åŸºäºè„šæœ¬å¼•æ“çš„è·¯ç”±è§„åˆ™ï¼Œå¦‚ï¼š</p>
<figure class="highlight plain">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">&gt; function route(invokers) {</span><br /><span class="line">&gt;     var result = new java.util.ArrayList(invokers.size());</span><br /><span class="line">&gt;     for (i = 0; i &lt; invokers.size(); i ++) {</span><br /><span class="line">&gt;         if ("10.20.153.10".equals(invokers.get(i).getUrl().getHost())) {</span><br /><span class="line">&gt;             result.add(invokers.get(i));</span><br /><span class="line">&gt;         }</span><br /><span class="line">&gt;     }</span><br /><span class="line">&gt;     return result;</span><br /><span class="line">&gt; } (invokers); // è¡¨ç¤ºç«‹å³æ‰§è¡Œæ–¹æ³•</span><br /><span class="line">&gt;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</blockquote>
<h3 id="3-2-1-æ„é€ æ–¹æ³•">3.2.1 æ„é€ æ–¹æ³•</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è„šæœ¬ç±»å‹ ä¸ ScriptEngine çš„æ˜ å°„ç¼“å­˜</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String, ScriptEngine&gt; engines = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ScriptEngine&gt;();</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·¯ç”±è§„åˆ™ URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScriptEngine engine;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·¯ç”±è§„åˆ™çš„ä¼˜å…ˆçº§ï¼Œç”¨äºæ’åºï¼Œä¼˜å…ˆçº§è¶Šå¤§è¶Šé å‰æ‰§è¡Œï¼Œå¯ä¸å¡«ï¼Œç¼ºçœä¸º 0 ã€‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> priority;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·¯ç”±è§„åˆ™å†…å®¹</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String rule;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·¯ç”±è§„åˆ™ URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ScriptRouter</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.url = url;</span><br /><span class="line">    String type = url.getParameter(Constants.TYPE_KEY);</span><br /><span class="line">    <span class="keyword">this</span>.priority = url.getParameter(Constants.PRIORITY_KEY, <span class="number">0</span>);</span><br /><span class="line">    String rule = url.getParameterAndDecoded(Constants.RULE_KEY);</span><br /><span class="line">    <span class="comment">// åˆå§‹åŒ– `engine`</span></span><br /><span class="line">    <span class="keyword">if</span> (type == <span class="keyword">null</span> || type.length() == <span class="number">0</span>) {</span><br /><span class="line">        type = Constants.DEFAULT_SCRIPT_TYPE_KEY;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">if</span> (rule == <span class="keyword">null</span> || rule.length() == <span class="number">0</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="keyword">new</span> IllegalStateException(<span class="string">"route rule can not be empty. rule:"</span> + rule));</span><br /><span class="line">    }</span><br /><span class="line">    ScriptEngine engine = engines.get(type);</span><br /><span class="line">    <span class="keyword">if</span> (engine == <span class="keyword">null</span>) { <span class="comment">// åœ¨ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œåˆ›å»º ScriptEngine å¯¹è±¡</span></span><br /><span class="line">        engine = <span class="keyword">new</span> ScriptEngineManager().getEngineByName(type);</span><br /><span class="line">        <span class="keyword">if</span> (engine == <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="keyword">new</span> IllegalStateException(<span class="string">"Unsupported route rule type: "</span> + type + <span class="string">", rule: "</span> + rule));</span><br /><span class="line">        }</span><br /><span class="line">        engines.put(type, engine);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">this</span>.engine = engine;</span><br /><span class="line">    <span class="keyword">this</span>.rule = rule;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h3 id="3-2-2-route">3.2.2 route</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="keyword">public</span> &lt;T&gt; List&lt;Invoker&lt;T&gt;&gt; route(List&lt;Invoker&lt;T&gt;&gt; invokers, URL url, Invocation invocation) <span class="keyword">throws</span> RpcException {</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="comment">// æ‰§è¡Œè„šæœ¬</span></span><br /><span class="line">        List&lt;Invoker&lt;T&gt;&gt; invokersCopy = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;(invokers);</span><br /><span class="line">        Compilable compilable = (Compilable) engine;</span><br /><span class="line">        Bindings bindings = engine.createBindings();</span><br /><span class="line">        bindings.put(<span class="string">"invokers"</span>, invokersCopy);</span><br /><span class="line">        bindings.put(<span class="string">"invocation"</span>, invocation);</span><br /><span class="line">        bindings.put(<span class="string">"context"</span>, RpcContext.getContext());</span><br /><span class="line">        CompiledScript function = compilable.compile(rule); <span class="comment">// ç¼–è¯‘</span></span><br /><span class="line">        Object obj = function.eval(bindings); <span class="comment">// æ‰§è¡Œ</span></span><br /><span class="line">        <span class="comment">// æ ¹æ®ç»“æœç±»å‹ï¼Œè½¬æ¢æˆ (List&lt;Invoker&lt;T&gt;&gt; ç±»å‹è¿”å›</span></span><br /><span class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Invoker[]) {</span><br /><span class="line">            invokersCopy = Arrays.asList((Invoker&lt;T&gt;[]) obj);</span><br /><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Object[]) {</span><br /><span class="line">            invokersCopy = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;();</span><br /><span class="line">            <span class="keyword">for</span> (Object inv : (Object[]) obj) {</span><br /><span class="line">                invokersCopy.add((Invoker&lt;T&gt;) inv);</span><br /><span class="line">            }</span><br /><span class="line">        } <span class="keyword">else</span> {</span><br /><span class="line">            invokersCopy = (List&lt;Invoker&lt;T&gt;&gt;) obj;</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span> invokersCopy;</span><br /><span class="line">    } <span class="keyword">catch</span> (ScriptException e) {</span><br /><span class="line">        <span class="comment">// å‘ç”Ÿå¼‚å¸¸ï¼Œå¿½ç•¥è·¯ç”±è§„åˆ™ï¼Œè¿”å›å…¨ `invokers` é›†åˆ</span></span><br /><span class="line">        logger.error(<span class="string">"route error , rule has been ignored. rule: "</span> + rule + <span class="string">", method:"</span> + invocation.getMethodName() + <span class="string">", url: "</span> + RpcContext.getContext().getUrl(), e);</span><br /><span class="line">        <span class="keyword">return</span> invokers;</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ğŸ™‚ æ¯”è¾ƒæ˜“æ‡‚ï¼Œèƒ–å‹è‡ªå·±çœ‹ä»£ç æ³¨é‡Šã€‚</li>
</ul>
<h3 id="3-2-3-compareTo">3.2.3 compareTo</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Router o)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (o == <span class="keyword">null</span> || o.getClass() != ScriptRouter.class) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br /><span class="line">    }</span><br /><span class="line">    ScriptRouter c = (ScriptRouter) o;</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.priority == c.priority ? rule.compareTo(c.rule) : (<span class="keyword">this</span>.priority &gt; c.priority ? <span class="number">1</span> : -<span class="number">1</span>);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä¼˜å…ˆï¼ŒæŒ‰ç…§&nbsp;<code>"priority"</code>&nbsp;<strong>é™åº</strong>ã€‚</li>
<li>å…¶æ¬¡ï¼ŒæŒ‰ç…§&nbsp;<code>"rule"</code>&nbsp;<strong>å‡åº</strong>ã€‚</li>
</ul>
<h2 id="3-3-MockInvokersSelector">3.3 MockInvokersSelector</h2>
<p>è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-8-impl-mock/?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆå…«ï¼‰ä¹‹ Mock å®ç°ã€‹</a>&nbsp;ã€‚</p>
<h1 id="4-é›†æˆ-Router-æ¨¡å—">4. é›†æˆ Router æ¨¡å—</h1>
<p>å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæœ‰<strong>äºŒä¸ªç±»</strong>ï¼Œè°ƒç”¨&nbsp;<code>Router#route(List&lt;Invoker&lt;T&gt;&gt;, URL, Invocation)</code>&nbsp;æ–¹æ³•ï¼Œé›†æˆ Router æ¨¡å—ã€‚</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2019_04_30/01.png" alt="é›†æˆ" /></p>
<h2 id="4-1-AbstractDirectory">4.1 AbstractDirectory</h2>
<h3 id="4-1-1-setRouters">4.1.1 setRouters</h3>
<p><code>#setRouters(List&lt;Router&gt; routers)</code>&nbsp;æ–¹æ³•ï¼Œè®¾ç½®è·¯ç”±è§„åˆ™ä»¬ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">setRouters</span><span class="params">(List&lt;Router&gt; routers)</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// copy list // å¤åˆ¶ routers ï¼Œå› ä¸ºä¸‹é¢è¦ä¿®æ”¹</span></span><br /><span class="line"> <span class="number">3</span>:     routers = routers == <span class="keyword">null</span> ? <span class="keyword">new</span> ArrayList&lt;Router&gt;() : <span class="keyword">new</span> ArrayList&lt;Router&gt;(routers);</span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// append url router</span></span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// æ‹¼æ¥ `url` ä¸­ï¼Œé…ç½®çš„è·¯ç”±è§„åˆ™</span></span><br /><span class="line"> <span class="number">6</span>:     String routerkey = url.getParameter(Constants.ROUTER_KEY);</span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (routerkey != <span class="keyword">null</span> &amp;&amp; routerkey.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">8</span>:         RouterFactory routerFactory = ExtensionLoader.getExtensionLoader(RouterFactory.class).getExtension(routerkey);</span><br /><span class="line"> <span class="number">9</span>:         routers.add(routerFactory.getRouter(url));</span><br /><span class="line"><span class="number">10</span>:     }</span><br /><span class="line"><span class="number">11</span>:     <span class="comment">// append mock invoker selector</span></span><br /><span class="line"><span class="number">12</span>:     routers.add(<span class="keyword">new</span> MockInvokersSelector());</span><br /><span class="line"><span class="number">13</span>:     <span class="comment">// æ’åº</span></span><br /><span class="line"><span class="number">14</span>:     Collections.sort(routers);</span><br /><span class="line"><span class="number">15</span>:     <span class="comment">// èµ‹å€¼ç»™å±æ€§</span></span><br /><span class="line"><span class="number">16</span>:     <span class="keyword">this</span>.routers = routers;</span><br /><span class="line"><span class="number">17</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šå¤åˆ¶é‡æ–°åˆ›å»º&nbsp;<code>routers</code>&nbsp;æ•°ç»„ï¼Œå› ä¸ºä¸‹é¢ä¼šè¿›è¡Œä¿®æ”¹ã€‚</li>
<li>
<p>ç¬¬ 5 è‡³ 10 è¡Œï¼šæ·»åŠ <code>url</code>&nbsp;ä¸­<strong>é…ç½®çš„è·¯ç”±è§„åˆ™</strong>åˆ°&nbsp;<code>routers</code>&nbsp;ä¸­ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight xml">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">id</span>=<span class="string">"zk01"</span> <span class="attr">address</span>=<span class="string">"zookeeper://127.0.0.1:2181"</span>&gt;</span></span><br /><span class="line">    <span class="tag">&lt;<span class="name">dubbo:parameter</span> <span class="attr">key</span>=<span class="string">"router"</span> <span class="attr">value</span>=<span class="string">"file"</span> /&gt;</span></span><br /><span class="line">    <span class="tag">&lt;<span class="name">dubbo:parameter</span> <span class="attr">key</span>=<span class="string">"rule"</span> <span class="attr">value</span>=<span class="string">"/Users/yunai/xxx.js"</span> /&gt;</span></span><br /><span class="line"><span class="tag">&lt;/<span class="name">dubbo:registry</span>&gt;</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å—é™äº XML å¯¹å­—ç¬¦çš„é™åˆ¶ï¼Œ<code>"condition"</code>&nbsp;æˆ–&nbsp;<code>"script"</code>&nbsp;ç±»å‹çš„è·¯ç”±é…ç½®ä¼šæ¯”è¾ƒéš¾è®¾ç½®ã€‚æ‰€ä»¥ç¬”è€…è®¤ä¸ºï¼Œå¦‚æœæ˜¯ä½¿ç”¨ XML é…ç½®è·¯ç”±è§„åˆ™ï¼Œ<code>"file"</code>&nbsp;ç±»å‹æ˜¯æ¯”è¾ƒåˆé€‚çš„æ–¹å¼ã€‚å½“ç„¶ï¼Œå¦‚æœä½¿ç”¨ Java API åˆæˆ–è€…æ³¨è§£çš„æ–¹å¼ï¼Œåº”è¯¥ä¸å­˜åœ¨è¿™æ ·çš„é—®é¢˜ã€‚</li>
</ul>
</li>
<li>ç¬¬ 12 è¡Œï¼šæ·»åŠ &nbsp;<strong>MockInvokersSelector</strong>&nbsp;åˆ°&nbsp;<code>routers</code>&nbsp;ä¸­ã€‚</li>
<li>ç¬¬ 14 è¡Œï¼šæ’åº&nbsp;<code>routers</code>&nbsp;ã€‚</li>
<li>ç¬¬ 16 è¡Œï¼š<strong>èµ‹å€¼å±æ€§</strong>ç»™ AbstractDirectory ã€‚</li>
</ul>
<h3 id="4-1-2-list">4.1.2 list</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="keyword">public</span> List&lt;Invoker&lt;T&gt;&gt; list(Invocation invocation) <span class="keyword">throws</span> RpcException {</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (destroyed) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Directory already destroyed .url: "</span> + getUrl());</span><br /><span class="line"> <span class="number">5</span>:     }</span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// è·å¾—æ‰€æœ‰ Invoker é›†åˆ</span></span><br /><span class="line"> <span class="number">7</span>:     List&lt;Invoker&lt;T&gt;&gt; invokers = doList(invocation);</span><br /><span class="line"> <span class="number">8</span>:     <span class="comment">// æ ¹æ®è·¯ç”±è§„åˆ™ï¼Œç­›é€‰ Invoker é›†åˆ</span></span><br /><span class="line"> <span class="number">9</span>:     List&lt;Router&gt; localRouters = <span class="keyword">this</span>.routers; <span class="comment">// local reference æœ¬åœ°å¼•ç”¨ï¼Œé¿å…å¹¶å‘é—®é¢˜</span></span><br /><span class="line"><span class="number">10</span>:     <span class="keyword">if</span> (localRouters != <span class="keyword">null</span> &amp;&amp; !localRouters.isEmpty()) {</span><br /><span class="line"><span class="number">11</span>:         <span class="keyword">for</span> (Router router : localRouters) {</span><br /><span class="line"><span class="number">12</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">13</span>:                 <span class="keyword">if</span> (router.getUrl() == <span class="keyword">null</span> || router.getUrl().getParameter(Constants.RUNTIME_KEY, <span class="keyword">false</span>)) {</span><br /><span class="line"><span class="number">14</span>:                     invokers = router.route(invokers, getConsumerUrl(), invocation);</span><br /><span class="line"><span class="number">15</span>:                 }</span><br /><span class="line"><span class="number">16</span>:             } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">17</span>:                 logger.error(<span class="string">"Failed to execute router: "</span> + getUrl() + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">18</span>:             }</span><br /><span class="line"><span class="number">19</span>:         }</span><br /><span class="line"><span class="number">20</span>:     }</span><br /><span class="line"><span class="number">21</span>:     <span class="keyword">return</span> invokers;</span><br /><span class="line"><span class="number">22</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 8 è‡³ 20 è¡Œï¼š<strong>å¾ªç¯</strong>ï¼Œè°ƒç”¨&nbsp;<code>Router#route(invokers, url, invocation)</code>&nbsp;æ–¹æ³•ï¼Œä¸æ–­è·¯ç”±ï¼Œç­›é€‰<strong>åŒ¹é…çš„</strong>Invoker é›†åˆã€‚
<ul>
<li>ç¬¬ 13 è¡Œï¼šåˆ¤æ–­&nbsp;<code>"runtime"</code>&nbsp;ä¸º&nbsp;<strong>true</strong>&nbsp;æ‰æ‰§è¡Œï¼šæ˜¯å¦åœ¨æ¯æ¬¡è°ƒç”¨æ—¶æ‰§è¡Œè·¯ç”±è§„åˆ™ï¼Œ<strong>å¦åˆ™åªåœ¨æä¾›è€…åœ°å€åˆ—è¡¨å˜æ›´æ—¶é¢„å…ˆæ‰§è¡Œå¹¶ç¼“å­˜ç»“æœ</strong>ï¼Œè°ƒç”¨æ—¶ç›´æ¥ä»ç¼“å­˜ä¸­è·å–è·¯ç”±ç»“æœã€‚å¦‚æœç”¨äº†å‚æ•°è·¯ç”±ï¼Œå¿…é¡»è®¾ä¸º&nbsp;<code>true</code>ï¼Œéœ€è¦æ³¨æ„è®¾ç½®ä¼šå½±å“è°ƒç”¨çš„æ€§èƒ½ï¼Œå¯ä¸å¡«ï¼Œç¼ºçœä¸º&nbsp;<code>flase</code>ã€‚</li>
</ul>
</li>
</ul>
<h2 id="4-2-RegistryDirectory">4.2 RegistryDirectory</h2>
<h3 id="4-2-1-notify">4.2.1 notify</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(List&lt;URL&gt; urls)</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// ã€çœç•¥æ— å…³ä»£ç ã€‘æ ¹æ® URL çš„åˆ†ç±»æˆ–åè®®ï¼Œåˆ†ç»„æˆä¸‰ä¸ªé›†åˆ ã€‚</span></span><br /><span class="line"> <span class="number">4</span>:     List&lt;URL&gt; invokerUrls = <span class="keyword">new</span> ArrayList&lt;URL&gt;(); <span class="comment">// æœåŠ¡æä¾›è€… URL é›†åˆ</span></span><br /><span class="line"> <span class="number">5</span>:     List&lt;URL&gt; routerUrls = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br /><span class="line"> <span class="number">6</span>:     List&lt;URL&gt; configuratorUrls = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br /><span class="line"> <span class="number">7</span>:     </span><br /><span class="line"> <span class="number">8</span>:     <span class="comment">//  ã€çœç•¥æ— å…³ä»£ç ã€‘å¤„ç†é…ç½®è§„åˆ™ URL é›†åˆ</span></span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// configurators</span></span><br /><span class="line"><span class="number">10</span>: </span><br /><span class="line"><span class="number">11</span>:     <span class="comment">// å¤„ç†è·¯ç”±è§„åˆ™ URL é›†åˆ</span></span><br /><span class="line"><span class="number">12</span>:     <span class="keyword">if</span> (!routerUrls.isEmpty()) {</span><br /><span class="line"><span class="number">13</span>:         List&lt;Router&gt; routers = toRouters(routerUrls);</span><br /><span class="line"><span class="number">14</span>:         <span class="keyword">if</span> (routers != <span class="keyword">null</span>) { <span class="comment">// null - do nothing</span></span><br /><span class="line"><span class="number">15</span>:             setRouters(routers);</span><br /><span class="line"><span class="number">16</span>:         }</span><br /><span class="line"><span class="number">17</span>:     }</span><br /><span class="line"><span class="number">18</span>:     </span><br /><span class="line"><span class="number">19</span>:     <span class="comment">//  ã€çœç•¥æ— å…³ä»£ç ã€‘åˆå¹¶é…ç½®è§„åˆ™ï¼Œåˆ° `directoryUrl` ä¸­ï¼Œå½¢æˆ `overrideDirectoryUrl` å˜é‡ã€‚</span></span><br /><span class="line"><span class="number">20</span>:     <span class="comment">//  ã€çœç•¥æ— å…³ä»£ç ã€‘å¤„ç†æœåŠ¡æä¾›è€… URL é›†åˆ</span></span><br /><span class="line"><span class="number">21</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 12 è¡Œï¼šè‹¥æ³¨å†Œä¸­å¿ƒé€šçŸ¥çš„&nbsp;<code>routerUrls</code>&nbsp;éç©ºï¼Œè¿›è¡Œå¤„ç†&nbsp;<code>routerUrls</code>&nbsp;é›†åˆã€‚</li>
<li>
<p>ç¬¬ 13 è¡Œï¼šè°ƒç”¨&nbsp;<code>#toRouters(routerUrls)</code>&nbsp;æ–¹æ³•ï¼Œå°†è·¯ç”±è§„åˆ™ URL é›†åˆï¼Œ<strong>è½¬æ¢</strong>æˆå¯¹åº”çš„ Router é›†åˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;Router&gt; <span class="title">toRouters</span><span class="params">(List&lt;URL&gt; urls)</span> </span>{</span><br /><span class="line">    List&lt;Router&gt; routers = <span class="keyword">new</span> ArrayList&lt;Router&gt;();</span><br /><span class="line">    <span class="keyword">if</span> (urls == <span class="keyword">null</span> || urls.isEmpty()) {</span><br /><span class="line">        <span class="keyword">return</span> routers;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">for</span> (URL url : urls) {</span><br /><span class="line">        <span class="comment">// å¿½ç•¥ï¼Œè‹¥æ˜¯ "empty://" ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ‰€æœ‰è·¯ç”±è§„åˆ™è¢«åˆ é™¤æ—¶ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€æ¡åè®®ä¸º "empty://" çš„è·¯ç”±è§„åˆ™ URL</span></span><br /><span class="line">        <span class="keyword">if</span> (Constants.EMPTY_PROTOCOL.equals(url.getProtocol())) {</span><br /><span class="line">            <span class="keyword">continue</span>;</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// è·å¾— "router"</span></span><br /><span class="line">        String routerType = url.getParameter(Constants.ROUTER_KEY);</span><br /><span class="line">        <span class="keyword">if</span> (routerType != <span class="keyword">null</span> &amp;&amp; routerType.length() &gt; <span class="number">0</span>) {</span><br /><span class="line">            url = url.setProtocol(routerType);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            <span class="comment">// åˆ›å»º Router å¯¹è±¡</span></span><br /><span class="line">            Router router = routerFactory.getRouter(url);</span><br /><span class="line">            <span class="comment">// æ·»åŠ åˆ°è¿”å›ç»“æœ</span></span><br /><span class="line">            <span class="keyword">if</span> (!routers.contains(router)) {</span><br /><span class="line">                routers.add(router);</span><br /><span class="line">            }</span><br /><span class="line">        } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">            logger.error(<span class="string">"convert router url to router error, url: "</span> + url, t);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> routers;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä»£ç æ˜“æ‡‚ï¼Œèƒ–å‹çœ‹ä¸‹æ³¨é‡Šç†è§£ã€‚</li>
</ul>
</li>
<li>
<p>ç¬¬ 14 è‡³ 16 è¡Œï¼š<code>routers</code>&nbsp;é›†åˆé&nbsp;<strong>null</strong>( å…è®¸é›†åˆå¤§å°ä¸º&nbsp;<strong>0</strong>&nbsp;)ï¼Œè°ƒç”¨&nbsp;<code>#setRouters(routers)</code>&nbsp;æ–¹æ³•ï¼Œè®¾ç½®è·¯ç”±è§„åˆ™é›†åˆï¼Œå³&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-7-impl-router/">ã€Œ4.1.1 setRoutersã€</a>&nbsp;ã€‚</p>
</li>
</ul>
<h3 id="4-2-2-toMethodInvokers">4.2.2 toMethodInvokers</h3>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">private</span> Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; toMethodInvokers(Map&lt;String, Invoker&lt;T&gt;&gt; invokersMap) {</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// åˆ›å»ºæ–°çš„ `methodInvokerMap`</span></span><br /><span class="line"> <span class="number">3</span>:     Map&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt; newMethodInvokerMap = <span class="keyword">new</span> HashMap&lt;String, List&lt;Invoker&lt;T&gt;&gt;&gt;();</span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// åˆ›å»º Invoker é›†åˆ</span></span><br /><span class="line"> <span class="number">5</span>:     List&lt;Invoker&lt;T&gt;&gt; invokersList = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;T&gt;&gt;();</span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">//  ã€çœç•¥æ— å…³ä»£ç ã€‘æŒ‰æœåŠ¡æä¾›è€… URL æ‰€å£°æ˜çš„ methods åˆ†ç±»ï¼Œå…¼å®¹æ³¨å†Œä¸­å¿ƒæ‰§è¡Œè·¯ç”±è¿‡æ»¤æ‰çš„ methods</span></span><br /><span class="line"> <span class="number">7</span>:     <span class="comment">// è·¯ç”±å…¨ `invokersList` ï¼ŒåŒ¹é…åˆé€‚çš„ Invoker é›†åˆ</span></span><br /><span class="line"> <span class="number">8</span>:     List&lt;Invoker&lt;T&gt;&gt; newInvokersList = route(invokersList, <span class="keyword">null</span>);</span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// æ·»åŠ  `newInvokersList` åˆ° `newMethodInvokerMap` ä¸­ï¼Œè¡¨ç¤ºè¯¥æœåŠ¡æä¾›è€…çš„å…¨é‡ Invoker é›†åˆ</span></span><br /><span class="line"><span class="number">10</span>:     newMethodInvokerMap.put(Constants.ANY_VALUE, newInvokersList);</span><br /><span class="line"><span class="number">11</span>:     <span class="comment">// å¾ªç¯ï¼ŒåŸºäºæ¯ä¸ªæ–¹æ³•è·¯ç”±ï¼ŒåŒ¹é…åˆé€‚çš„ Invoker é›†åˆ</span></span><br /><span class="line"><span class="number">12</span>:     <span class="keyword">if</span> (serviceMethods != <span class="keyword">null</span> &amp;&amp; serviceMethods.length &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">13</span>:         <span class="keyword">for</span> (String method : serviceMethods) {</span><br /><span class="line"><span class="number">14</span>:             List&lt;Invoker&lt;T&gt;&gt; methodInvokers = newMethodInvokerMap.get(method);</span><br /><span class="line"><span class="number">15</span>:             <span class="keyword">if</span> (methodInvokers == <span class="keyword">null</span> || methodInvokers.isEmpty()) {</span><br /><span class="line"><span class="number">16</span>:                 methodInvokers = newInvokersList;</span><br /><span class="line"><span class="number">17</span>:             }</span><br /><span class="line"><span class="number">18</span>:             newMethodInvokerMap.put(method, route(methodInvokers, method));</span><br /><span class="line"><span class="number">19</span>:         }</span><br /><span class="line"><span class="number">20</span>:     }</span><br /><span class="line"><span class="number">21</span>:     <span class="comment">// ã€çœç•¥æ— å…³ä»£ç ã€‘å¾ªç¯æ’åºæ¯ä¸ªæ–¹æ³•çš„ Invoker é›†åˆï¼Œå¹¶è®¾ç½®ä¸ºä¸å¯å˜</span></span><br /><span class="line"><span class="number">22</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ç¬¬ 8 è¡Œï¼šè°ƒç”¨&nbsp;<code>#route(invokers, method)</code>&nbsp;æ–¹æ³•ï¼Œè·¯ç”±<strong>å…¨</strong>&nbsp;<code>invokersList</code>&nbsp;ï¼ŒåŒ¹é…åˆé€‚çš„ Invoker é›†åˆ<strong>è¿›è¡Œç¼“å­˜</strong>ï¼Œè¿™å°±æ˜¯ä¸Šæ–‡æåˆ°çš„&ldquo;<em>åªåœ¨æä¾›è€…åœ°å€åˆ—è¡¨å˜æ›´æ—¶é¢„å…ˆæ‰§è¡Œå¹¶ç¼“å­˜ç»“æœ</em>&rdquo;ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> List&lt;Invoker&lt;T&gt;&gt; route(List&lt;Invoker&lt;T&gt;&gt; invokers, String method) {</span><br /><span class="line">    <span class="comment">// åˆ›å»º Invocation å¯¹è±¡</span></span><br /><span class="line">    Invocation invocation = <span class="keyword">new</span> RpcInvocation(method, <span class="keyword">new</span> Class&lt;?&gt;[<span class="number">0</span>], <span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br /><span class="line">    <span class="comment">// è·å¾— Router æ•°ç»„</span></span><br /><span class="line">    List&lt;Router&gt; routers = getRouters();</span><br /><span class="line">    <span class="comment">// æ ¹æ®è·¯ç”±è§„åˆ™ï¼Œç­›é€‰ Invoker é›†åˆ</span></span><br /><span class="line">    <span class="keyword">if</span> (routers != <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">for</span> (Router router : routers) {</span><br /><span class="line">            <span class="keyword">if</span> (router.getUrl() != <span class="keyword">null</span>) {</span><br /><span class="line">                invokers = router.route(invokers, getConsumerUrl(), invocation);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> invokers;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä¸»è¦æ˜¯è°ƒç”¨&nbsp;<code>Router#route(...)</code>&nbsp;æ–¹æ³•ï¼Œè·¯ç”±ã€‚</li>
</ul>
</li>
<li>
<p>ç¬¬ 11 è‡³ 20 è¡Œï¼š<strong>å¾ªç¯</strong>ï¼Œè°ƒç”¨&nbsp;<code>#route(invokers, method)</code>&nbsp;æ–¹æ³•ï¼Œè·¯ç”±<strong>æ¯ä¸ªæ–¹æ³•</strong>çš„&nbsp;<code>methodInvokers</code>&nbsp;ï¼ŒåŒ¹é…åˆé€‚çš„ Invoker é›†åˆ<strong>è¿›è¡Œç¼“å­˜</strong>ã€‚</p>
</li>
</ul>
</div>