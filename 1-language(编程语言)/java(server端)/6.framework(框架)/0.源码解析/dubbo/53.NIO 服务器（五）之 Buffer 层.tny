<header class="article-header">
<h1 class="article-title">NIO æœåŠ¡å™¨ï¼ˆäº”ï¼‰ä¹‹ Buffer å±‚</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡æ¥&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-api-exchange//?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ï¼ˆå››ï¼‰ä¹‹ Exchange å±‚ã€‹</a>&nbsp;ä¸€æ–‡ï¼Œåˆ†äº«&nbsp;<code>dubbo-remoting-api</code>&nbsp;æ¨¡å—ï¼Œ&nbsp;<code>buffer</code>&nbsp;åŒ…ï¼Œ<strong>Buffer å±‚</strong>ã€‚</p>
<p>Buffer åœ¨ NIO æ¡†æ¶ä¸­ï¼Œæ‰®æ¼”éå¸¸é‡è¦çš„è§’è‰²ï¼ŒåŸºæœ¬æ¯ä¸ªåº“éƒ½æä¾›äº†è‡ªå·±çš„ Buffer å®ç°ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li>Java NIO çš„&nbsp;<code>java.nio.ByteBuffer</code></li>
<li>Mina çš„&nbsp;<code>org.apache.mina.core.buffer.IoBuffer</code></li>
<li>Netty4 çš„&nbsp;<code>io.netty.buffer.ByteBuf</code></li>
</ul>
<p>åœ¨&nbsp;<code>dubbo-remoting-api</code>&nbsp;çš„&nbsp;<code>buffer</code>&nbsp;åŒ…ä¸­ï¼Œä¸€æ–¹é¢å®šä¹‰äº† ChannelBuffer å’Œ ChannelBufferFactory çš„æ¥å£ï¼ŒåŒæ—¶æä¾›äº†å¤šç§é»˜è®¤çš„å®ç°ã€‚æ•´ä½“ç±»å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_12_13/01.png" alt="ç±»å›¾" /></p>
<ul>
<li>å…¶ä¸­ï¼Œçº¢æ¡†éƒ¨åˆ†ï¼Œæ˜¯ Netty3 å’Œ Netty4 ï¼Œå®ç°çš„è‡ªå®šä¹‰çš„ ChannelBuffer å’Œ ChannelBufferFactory ç±»ã€‚</li>
</ul>
<h1 id="2-ChannelBuffer">2. ChannelBuffer</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/ChannelBuffer.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.buffer.ChannelBuffer</code></a>&nbsp;ï¼Œå®ç° Comparable æ¥å£ï¼Œ<strong>é€šé“ Buffer</strong>&nbsp;æ¥å£ã€‚</p>
<p>ChannelBuffer åœ¨æ¥å£æ–¹æ³•çš„å®šä¹‰ä¸Šï¼Œä¸»è¦å‚è€ƒäº† Netty çš„ ByteBuf è¿›è¡Œè®¾è®¡ï¼Œæ‰€ä»¥æ¥å£å’Œæ³¨é‡ŠåŸºæœ¬ä¸€è‡´ï¼Œæœ¬æ–‡å°±ä¸ä¸€ä¸ªä¸€ä¸ªç»†è®²è¿‡å»ï¼Œèƒ–å‹å¯ä»¥çœ‹ï¼š</p>
<ul>
<li>è‹±æ–‡ï¼š<a href="https://netty.io/4.1/api/io/netty/buffer/ByteBuf.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠNetty4.1 ByteBuf APIã€‹</a></li>
<li>ä¸­æ–‡ï¼š<a href="https://my.oschina.net/7001/blog/742236" target="_blank" rel="external nofollow noopener noreferrer">ã€Šæ·±å…¥ç ”ç©¶Nettyæ¡†æ¶ä¹‹ByteBufåŠŸèƒ½åŸç†åŠæºç åˆ†æã€‹</a></li>
</ul>
<p>ç‹¬æœ‰çš„æ¥å£æ–¹æ³•&nbsp;<code>#factory()</code>&nbsp;æ–¹æ³•ï¼Œç”¨äºé€»è¾‘ä¸­ï¼Œéœ€è¦åˆ›å»º ChannelBuffer çš„æƒ…å†µã€‚</p>
<ul>
<li>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Returns the factory which creates a {<span class="doctag">@link</span> ChannelBuffer} whose type and</span></span><br /><span class="line"><span class="comment"> * default {<span class="doctag">@link</span> java.nio.ByteOrder} are same with this buffer.</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function">ChannelBufferFactory <span class="title">factory</span><span class="params">()</span></span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>è°ƒç”¨æ–¹å¦‚ä¸‹ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_12_13/02.png" alt="è°ƒç”¨æ–¹" /></p>
</li>
</ul>
<h2 id="2-1-AbstractChannelBuffer">2.1 AbstractChannelBuffer</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/AbstractChannelBuffer.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.buffer.AbstractChannelBuffer</code></a>&nbsp;ï¼Œå®ç° ChannelBuffer æ¥å£ï¼Œé€šé“ Buffer&nbsp;<strong>æŠ½è±¡ç±»</strong>ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è¯»å–ä½ç½®</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> readerIndex;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å†™å…¥ä½ç½®</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> writerIndex;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ ‡è®°çš„è¯»å–ä½ç½®</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> markedReaderIndex;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æ ‡è®°çš„å†™å…¥ä½ç½®</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> markedWriterIndex;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<blockquote>
<p>FROM&nbsp;<a href="https://blog.csdn.net/zhxdick/article/details/51187362" target="_blank" rel="external nofollow noopener noreferrer">ã€Šnettyçš„ByteBufã€‹</a><br />writerIndex å’Œ readerIndex</p>
<ul>
<li>
<p>åˆå§‹çŠ¶æ€ï¼š<br /><img src="http://static2.iocoder.cn/images/Dubbo/2018_12_13/05.png" alt="" /></p>
</li>
<li>
<p>å½“å†™å…¥5ä¸ªå­—èŠ‚åï¼š<br /><img src="http://static2.iocoder.cn/images/Dubbo/2018_12_13/06.png" alt="" /></p>
</li>
</ul>
<p>è¿™æ—¶ï¼ŒwriterIndex ä¸º 5ï¼Œè¿™æ—¶å¦‚æœå¼€å§‹è¯»å–ï¼Œé‚£ä¹ˆè¿™ä¸ª writerIndex å¯ä»¥ä½œä¸ºä¸Šé¢ByteBuffer flip ä¹‹åçš„ limitã€‚</p>
<ul>
<li>å½“è¯»å–3ä¸ªå­—èŠ‚åï¼š<br /><img src="http://static2.iocoder.cn/images/Dubbo/2018_12_13/07.png" alt="" /></li>
</ul>
</blockquote>
<p><strong>å®ç°æ–¹æ³•</strong></p>
<p>åœ¨ AbstractChannelBuffer å®ç°çš„æ–¹æ³•ï¼Œéƒ½æ˜¯<strong>é‡è½½</strong>çš„æ–¹æ³•ï¼ŒçœŸæ­£<strong>å®è´¨</strong>çš„æ–¹æ³•ï¼Œéœ€è¦å­ç±»æ¥å®ç°ã€‚ä»¥&nbsp;<code>#getBytes(...)</code>&nbsp;æ–¹æ³•ï¼Œä¸¾ä¾‹å­ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getBytes</span><span class="params">(<span class="keyword">int</span> index, ChannelBuffer dst, <span class="keyword">int</span> length)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (length &gt; dst.writableBytes()) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException();</span><br /><span class="line">    }</span><br /><span class="line">    getBytes(index, dst, dst.writerIndex(), length);</span><br /><span class="line">    dst.writerIndex(dst.writerIndex() + length);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ–¹æ³•ä¸­è°ƒç”¨çš„&nbsp;<code>#getBytes(index, ds, dstIndex, length)</code>&nbsp;æ–¹æ³•ï¼Œå¹¶æœªå®ç°ã€‚ğŸ™‚&nbsp;<strong>ä¸ºå•¥å‘¢</strong>ï¼Ÿ<strong>å®è´¨</strong>çš„æ–¹æ³•ï¼Œæ¶‰åŠåˆ°å­—èŠ‚æ•°ç»„çš„<strong>å®ç°å½¢å¼</strong>ã€‚</li>
</ul>
<p>å¦‚ä¸‹æ˜¯æ‰€æœ‰<strong>æœªå®ç°</strong>çš„æ–¹æ³•ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_12_13/03.png" alt="æœªå®ç°æ–¹æ³•" /></p>
<h2 id="2-2-ByteBufferBackedChannelBuffer">2.2 ByteBufferBackedChannelBuffer</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/ByteBufferBackedChannelBuffer.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.buffer.ByteBufferBackedChannelBuffer</code></a>&nbsp;ï¼Œå®ç° AbstractChannelBuffer æŠ½è±¡ç±»ï¼ŒåŸºäº&nbsp;<strong>java.nio.ByteBuffer</strong>&nbsp;çš„ Buffer å®ç°ç±»ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * buffer</span></span><br /><span class="line"><span class="comment"> * java.nio.ByteBuffer</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ByteBuffer buffer;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å®¹é‡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> capacity;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ByteBufferBackedChannelBuffer</span><span class="params">(ByteBuffer buffer)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (buffer == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"buffer"</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// buffer</span></span><br /><span class="line">    <span class="keyword">this</span>.buffer = buffer.slice();</span><br /><span class="line">    <span class="comment">// å®¹é‡</span></span><br /><span class="line">    capacity = buffer.remaining();</span><br /><span class="line">    <span class="comment">// è®¾ç½® `writerIndex`</span></span><br /><span class="line">    writerIndex(capacity);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ByteBufferBackedChannelBuffer</span><span class="params">(ByteBufferBackedChannelBuffer buffer)</span> </span>{</span><br /><span class="line">    <span class="comment">// buffer</span></span><br /><span class="line">    <span class="keyword">this</span>.buffer = buffer.buffer;</span><br /><span class="line">    <span class="comment">// å®¹é‡</span></span><br /><span class="line">    capacity = buffer.capacity;</span><br /><span class="line">    <span class="comment">// è®¾ç½® `writerIndex` `readerIndex`</span></span><br /><span class="line">    setIndex(buffer.readerIndex(), buffer.writerIndex());</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p><strong>å·¥å‚</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> ChannelBufferFactory <span class="title">factory</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (buffer.isDirect()) {</span><br /><span class="line">        <span class="keyword">return</span> DirectChannelBufferFactory.getInstance();</span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        <span class="keyword">return</span> HeapChannelBufferFactory.getInstance();</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¯¹åº”çš„å·¥å‚æ˜¯ DirectChannelBufferFactory æˆ– HeapChannelBufferFactory ã€‚</li>
</ul>
<p><strong>å®ç°æ–¹æ³•</strong></p>
<p>èƒ–å‹ï¼Œè‡ªå·±æŸ¥çœ‹ã€‚</p>
<h2 id="2-3-HeapChannelBuffer">2.3 HeapChannelBuffer</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/HeapChannelBuffer.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.buffer.HeapChannelBuffer</code></a>&nbsp;ï¼Œå®ç° AbstractChannelBuffer æŠ½è±¡ç±»ï¼ŒåŸºäº<strong>å­—èŠ‚æ•°ç»„</strong>çš„ Buffer å®ç°ç±»ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * The underlying heap byte array that this buffer is wrapping.</span></span><br /><span class="line"><span class="comment"> * å­—èŠ‚æ•°ç»„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] array;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HeapChannelBuffer</span><span class="params">(<span class="keyword">int</span> length)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>(<span class="keyword">new</span> <span class="keyword">byte</span>[length], <span class="number">0</span>, <span class="number">0</span>);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HeapChannelBuffer</span><span class="params">(<span class="keyword">byte</span>[] array)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>(array, <span class="number">0</span>, array.length);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">HeapChannelBuffer</span><span class="params">(<span class="keyword">byte</span>[] array, <span class="keyword">int</span> readerIndex, <span class="keyword">int</span> writerIndex)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (array == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"array"</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">this</span>.array = array;</span><br /><span class="line">    setIndex(readerIndex, writerIndex);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p><strong>å·¥å‚</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> ChannelBufferFactory <span class="title">factory</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> HeapChannelBufferFactory.getInstance();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å¯¹åº”çš„å·¥å‚æ˜¯ HeapChannelBufferFactory ã€‚</li>
</ul>
<p><strong>å®ç°æ–¹æ³•</strong></p>
<p>èƒ–å‹ï¼Œè‡ªå·±æŸ¥çœ‹ã€‚</p>
<h2 id="2-4-DynamicChannelBuffer">2.4 DynamicChannelBuffer</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/DynamicChannelBuffer.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.buffer.DynamicChannelBuffer</code></a>&nbsp;ï¼Œå®ç° AbstractChannelBuffer æŠ½è±¡ç±»ï¼ŒåŸºäº<strong>åŠ¨æ€</strong>çš„ Buffer å®ç°ç±»ã€‚æˆ–è€…è¯´ï¼ŒåŸºäºä¼ å…¥çš„ ChannelBufferFactory çš„ Buffer å®ç°ç±»ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å·¥å‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelBufferFactory factory;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Buffer</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> ChannelBuffer buffer;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DynamicChannelBuffer</span><span class="params">(<span class="keyword">int</span> estimatedLength)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>(estimatedLength, HeapChannelBufferFactory.getInstance()); <span class="comment">// é»˜è®¤ HeapChannelBufferFactory</span></span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DynamicChannelBuffer</span><span class="params">(<span class="keyword">int</span> estimatedLength, ChannelBufferFactory factory)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (estimatedLength &lt; <span class="number">0</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"estimatedLength: "</span> + estimatedLength);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">if</span> (factory == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"factory"</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è®¾ç½® `factory`</span></span><br /><span class="line">    <span class="keyword">this</span>.factory = factory;</span><br /><span class="line">    <span class="comment">// åˆ›å»º `buffer`</span></span><br /><span class="line">    buffer = factory.getBuffer(estimatedLength);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p><strong>å·¥å‚</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> ChannelBufferFactory <span class="title">factory</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> factory;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p><strong>å®ç°æ–¹æ³•</strong></p>
<p>æ¯ä¸ªæ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨&nbsp;<code>buffer</code>&nbsp;å¯¹åº”çš„æ–¹æ³•ã€‚</p>
<h1 id="3-ChannelBuffers">3. ChannelBuffers</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/ChannelBuffers.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.buffer.ChannelBuffers</code></a>&nbsp;ï¼ŒBuffer&nbsp;<strong>å·¥å…·ç±»</strong>ï¼Œæä¾›åˆ›å»ºã€æ¯”è¾ƒ ChannelBuffer ç­‰å…¬ç”¨æ–¹æ³•ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_12_13/04.png" alt="ChannelBuffers" /></p>
<h1 id="4-ChannelBufferFactory">4. ChannelBufferFactory</h1>
<p><code>com.alibaba.dubbo.remoting.buffer.ChannelBufferFactory</code>&nbsp;ï¼Œ<strong>é€šé“ Buffer å·¥å‚</strong>æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function">ChannelBuffer <span class="title">getBuffer</span><span class="params">(<span class="keyword">int</span> capacity)</span></span>;</span><br /><span class="line"><span class="function">ChannelBuffer <span class="title">getBuffer</span><span class="params">(<span class="keyword">byte</span>[] array, <span class="keyword">int</span> offset, <span class="keyword">int</span> length)</span></span>;</span><br /><span class="line"><span class="function">ChannelBuffer <span class="title">getBuffer</span><span class="params">(ByteBuffer nioBuffer)</span></span>; <span class="comment">// java.nio.ByteBuffer</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="4-1-DirectChannelBufferFactory">4.1 DirectChannelBufferFactory</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/DirectChannelBufferFactory.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.buffer.DirectChannelBufferFactory</code></a>&nbsp;ï¼Œå®ç° ChannelBufferFactory æ¥å£ï¼Œåˆ›å»º DirectChannelBuffer çš„å·¥å‚ã€‚</p>
<p>å®ç°æ¯”è¾ƒç®€å•ï¼Œä»£ç å·²ç»åŠ æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚</p>
<h2 id="4-2-HeapChannelBufferFactory">4.2 HeapChannelBufferFactory</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/HeapChannelBufferFactory.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.buffer.HeapChannelBufferFactory</code></a>&nbsp;ï¼Œå®ç° ChannelBufferFactory æ¥å£ï¼Œåˆ›å»º HeapChannelBufferFactory çš„å·¥å‚ã€‚</p>
<p>å®ç°æ¯”è¾ƒç®€å•ï¼Œä»£ç å·²ç»åŠ æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚</p>
<h1 id="5-IO">5. IO</h1>
<p>å®é™… IO æ“ä½œï¼Œæ˜¯åŸºäº InputStream å’Œ OutputStream ï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨å‰æ–‡çœ‹åˆ°çš„ Serialization åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ... çœç•¥å…¶ä»–æ–¹æ³•</span></span><br /><span class="line"><span class="function">ObjectOutput <span class="title">serialize</span><span class="params">(URL url, OutputStream output)</span> <span class="keyword">throws</span> IOException</span>;</span><br /><br /><span class="line"><span class="function">ObjectInput <span class="title">deserialize</span><span class="params">(URL url, InputStream input)</span> <span class="keyword">throws</span> IOException</span>;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦å°† ChannelBuffer è¿›è¡Œè£…é¥°ã€‚</p>
<hr />
<p>å¦å¤–ï¼Œæˆ‘ä»¬åœ¨å›è¿‡å¤´æ¥çœ‹çœ‹ Codec å’Œ Codec2 æ¥å£ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// Codec.java</span></span><br /><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">encode</span><span class="params">(Channel channel, OutputStream output, Object message)</span> <span class="keyword">throws</span> IOException</span>;</span><br /><span class="line"><span class="comment">// Codec2.java</span></span><br /><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">encode</span><span class="params">(Channel channel, ChannelBuffer buffer, Object message)</span> <span class="keyword">throws</span> IOException</span>;</span><br /><br /><span class="line"><span class="comment">// Codec.java</span></span><br /><span class="line"><span class="function">Object <span class="title">decode</span><span class="params">(Channel channel, InputStream input)</span> <span class="keyword">throws</span> IOException</span>;</span><br /><span class="line"><span class="comment">// Codec2.java</span></span><br /><span class="line"><span class="function">Object <span class="title">decode</span><span class="params">(Channel channel, ChannelBuffer buffer)</span> <span class="keyword">throws</span> IOException</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>ä¸€ä¸ªå˜åŒ–ç‚¹ï¼Œå°±æ˜¯å°† OutputStream å’Œ InputStream ï¼Œæ›¿æ¢æˆäº† ChannelBuffer ï¼Œæ›´å¥½çš„ä»¥ ChannelBuffer ä¸ºæ ¸å¿ƒï¼Œä¸å…¶ä»–æ¡†æ¶æ•´åˆã€‚</p>
<h2 id="5-1-ChannelBufferInputStream">5.1 ChannelBufferInputStream</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/ChannelBufferInputStream.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.buffer.ChannelBufferInputStream</code></a>&nbsp;ï¼Œå®ç° InputStream æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChannelBufferInputStream</span> <span class="keyword">extends</span> <span class="title">InputStream</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChannelBuffer buffer;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * å¼€å§‹ä½ç½®</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> startIndex;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * ç»“æŸä½ç½®</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> endIndex;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChannelBufferInputStream</span><span class="params">(ChannelBuffer buffer)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>(buffer, buffer.readableBytes());</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChannelBufferInputStream</span><span class="params">(ChannelBuffer buffer, <span class="keyword">int</span> length)</span> </span>{</span><br /><span class="line">        <span class="keyword">if</span> (buffer == <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"buffer"</span>);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">if</span> (length &lt; <span class="number">0</span>) {</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"length: "</span> + length);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">if</span> (length &gt; buffer.readableBytes()) {</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException();</span><br /><span class="line">        }</span><br /><br /><span class="line">        <span class="keyword">this</span>.buffer = buffer;</span><br /><span class="line">        startIndex = buffer.readerIndex();</span><br /><span class="line">        endIndex = startIndex + length;</span><br /><span class="line">        buffer.markReaderIndex();</span><br /><span class="line">    }</span><br />    <br /><span class="line">    <span class="comment">// ... çœç•¥ä» buffer è¯»å–çš„æ–¹æ³•ï¼Œèƒ–å‹ï¼Œè‡ªå·±æŸ¥çœ‹ã€‚</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="5-2-ChannelBufferOutputStream">5.2 ChannelBufferOutputStream</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/ChannelBufferOutputStream.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.buffer.ChannelBufferOutputStream</code></a>&nbsp;ï¼Œå®ç° OutputStream æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChannelBufferOutputStream</span> <span class="keyword">extends</span> <span class="title">OutputStream</span> </span>{</span><br /><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChannelBuffer buffer;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * å¼€å§‹ä½ç½®</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> startIndex;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChannelBufferOutputStream</span><span class="params">(ChannelBuffer buffer)</span> </span>{</span><br /><span class="line">        <span class="keyword">if</span> (buffer == <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"buffer"</span>);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">this</span>.buffer = buffer;</span><br /><span class="line">        startIndex = buffer.writerIndex();</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">// ... çœç•¥å‘ buffer å†™å…¥çš„æ–¹æ³•ï¼Œèƒ–å‹ï¼Œè‡ªå·±æŸ¥çœ‹ã€‚</span></span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</div>