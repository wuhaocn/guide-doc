<header class="article-header">
<h1 class="article-title">åŠ¨æ€ä»£ç†ï¼ˆä¸‰ï¼‰ä¹‹æœ¬åœ°å­˜æ ¹ Stub</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡æ¥&nbsp;<a href="http://svip.iocoder.cn/Dubbo/proxy-jdk/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; åŠ¨æ€ä»£ç†ï¼ˆäºŒï¼‰ä¹‹ JDKã€‹</a>&nbsp;ä¸€æ–‡ï¼Œåˆ†äº«ä½¿ç”¨ Dubbo&nbsp;<strong>æœ¬åœ°å­˜æ ¹( Stub )</strong>çš„ç‰¹æ€§ã€‚ğŸ˜ å½“ç„¶ï¼Œä»æ ‡é¢˜æˆ‘ä»¬å°±å¯ä»¥çœ‹å‡ºï¼Œå®ç°çš„åŸç†æ˜¯åŸºäº<strong>åŠ¨æ€ä»£ç†</strong>çš„æœºåˆ¶ã€‚</p>
<p>åœ¨&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/local-stub.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; æœ¬åœ°å­˜æ ¹ã€‹</a>&nbsp;ä¸­ï¼Œå·²ç»éå¸¸è¯¦å°½çš„åˆ†äº«äº†<strong>æœ¬åœ°å­˜æ ¹</strong>çš„æ¦‚å¿µå’Œä½¿ç”¨ï¼Œæœ¬æ–‡å°±ä¸é‡å¤ä»‹ç»å•¦ã€‚ğŸ˜ˆ æ–‡æ¡£æœ‰ä¸€ç‚¹ç‚¹å°å°çš„é”™è¯¯ï¼Œåœ¨ Spring é…ç½®æ–‡ä»¶çš„é…ç½®æ–¹å¼åº”è¯¥æ˜¯å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">interface</span>=<span class="string">"com.alibaba.dubbo.demo.DemoService"</span> <span class="attr">stub</span>=<span class="string">"com.alibaba.dubbo.demo.consumer.DemoServiceStub"</span>&gt;</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ˜¯æœåŠ¡å¼•ç”¨&nbsp;<code>&lt;dubbo:reference /&gt;</code>&nbsp;ï¼Œè€Œä¸æ˜¯æœåŠ¡æš´éœ²&nbsp;<code>&lt;dubbo:service /&gt;</code></li>
</ul>
<h1 id="2-StubProxyFactoryWrapper">2. StubProxyFactoryWrapper</h1>
<p><a href="http://svip.iocoder.cn/Dubbo/proxy-local-stub/TODO"><code>com.alibaba.dubbo.rpc.proxy.wrapper.StubProxyFactoryWrapper</code></a>&nbsp;ï¼Œå®ç° ProxyFactory æ¥å£ï¼Œå­˜æ ¹ä»£ç†å·¥å‚<strong>åŒ…è£…å™¨</strong>å®ç°ç±»ã€‚</p>
<h2 id="2-1-æ„é€ æ–¹æ³•">2.1 æ„é€ æ–¹æ³•</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ProxyFactory$Adaptive å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ProxyFactory proxyFactory;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Protocol$Adaptive å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Protocol protocol;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StubProxyFactoryWrapper</span><span class="params">(ProxyFactory proxyFactory)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.proxyFactory = proxyFactory;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProtocol</span><span class="params">(Protocol protocol)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.protocol = protocol;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>proxyFactory</code>&nbsp;å±æ€§ï¼ŒProxyFactory$Adaptive å¯¹è±¡ã€‚StubProxyFactoryWrapper åŸºäº Dubbo SPI Wrapper æœºåˆ¶ï¼Œæ‰€ä»¥ä½¿ç”¨ ProxyFactory åˆ›å»ºä»£ç†çš„æµç¨‹ï¼Œå®é™…å˜æˆå¦‚ä¸‹ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_09_19/01.png" alt="æµç¨‹" /></li>
<li><code>protocol</code>&nbsp;å±æ€§ï¼ŒProtocol$Adaptive å¯¹è±¡ã€‚</li>
</ul>
<h2 id="2-2-getProxy">2.2 getProxy</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="meta">@SuppressWarnings</span>({<span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span>})</span><br /><span class="line"> <span class="number">3</span>: <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Invoker&lt;T&gt; invoker)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// è·å¾— Service Proxy å¯¹è±¡</span></span><br /><span class="line"> <span class="number">5</span>:     T proxy = proxyFactory.getProxy(invoker);</span><br /><span class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (GenericService.class != invoker.getInterface()) { <span class="comment">// éæ³›åŒ–å¼•ç”¨</span></span><br /><span class="line"> <span class="number">7</span>:         <span class="comment">// è·å¾— `stub` é…ç½®é¡¹</span></span><br /><span class="line"> <span class="number">8</span>:         String stub = invoker.getUrl().getParameter(Constants.STUB_KEY, invoker.getUrl().getParameter(Constants.LOCAL_KEY));</span><br /><span class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (ConfigUtils.isNotEmpty(stub)) {</span><br /><span class="line"><span class="number">10</span>:             Class&lt;?&gt; serviceType = invoker.getInterface();</span><br /><span class="line"><span class="number">11</span>:             <span class="comment">// `stub = true` çš„æƒ…å†µï¼Œä½¿ç”¨æ¥å£ + `Stub` å­—ç¬¦ä¸²ã€‚</span></span><br /><span class="line"><span class="number">12</span>:             <span class="keyword">if</span> (ConfigUtils.isDefault(stub)) {</span><br /><span class="line"><span class="number">13</span>:                 <span class="keyword">if</span> (invoker.getUrl().hasParameter(Constants.STUB_KEY)) {</span><br /><span class="line"><span class="number">14</span>:                     stub = serviceType.getName() + <span class="string">"Stub"</span>;</span><br /><span class="line"><span class="number">15</span>:                 } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">16</span>:                     stub = serviceType.getName() + <span class="string">"Local"</span>;</span><br /><span class="line"><span class="number">17</span>:                 }</span><br /><span class="line"><span class="number">18</span>:             }</span><br /><span class="line"><span class="number">19</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">20</span>:                 <span class="comment">// åŠ è½½ Stub ç±»</span></span><br /><span class="line"><span class="number">21</span>:                 Class&lt;?&gt; stubClass = ReflectUtils.forName(stub);</span><br /><span class="line"><span class="number">22</span>:                 <span class="keyword">if</span> (!serviceType.isAssignableFrom(stubClass)) {</span><br /><span class="line"><span class="number">23</span>:                     <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The stub implementation class "</span> + stubClass.getName() + <span class="string">" not implement interface "</span> + serviceType.getName());</span><br /><span class="line"><span class="number">24</span>:                 }</span><br /><span class="line"><span class="number">25</span>:                 <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">26</span>:                     <span class="comment">// åˆ›å»º Stub å¯¹è±¡ï¼Œä½¿ç”¨å¸¦ Service Proxy å¯¹è±¡çš„æ„é€ æ–¹æ³•</span></span><br /><span class="line"><span class="number">27</span>:                     Constructor&lt;?&gt; constructor = ReflectUtils.findConstructor(stubClass, serviceType);</span><br /><span class="line"><span class="number">28</span>:                     proxy = (T) constructor.newInstance(<span class="keyword">new</span> Object[]{proxy});</span><br /><span class="line"><span class="number">29</span>: </span><br /><span class="line"><span class="number">30</span>:                     <span class="comment">// ã€TODO 8033ã€‘å‚æ•°å›è°ƒ</span></span><br /><span class="line"><span class="number">31</span>:                     <span class="comment">//export stub service</span></span><br /><span class="line"><span class="number">32</span>:                     URL url = invoker.getUrl();</span><br /><span class="line"><span class="number">33</span>:                     <span class="keyword">if</span> (url.getParameter(Constants.STUB_EVENT_KEY, Constants.DEFAULT_STUB_EVENT)) {</span><br /><span class="line"><span class="number">34</span>:                         url = url.addParameter(Constants.STUB_EVENT_METHODS_KEY, StringUtils.join(Wrapper.getWrapper(proxy.getClass()).getDeclaredMethodNames(), <span class="string">","</span>));</span><br /><span class="line"><span class="number">35</span>:                         url = url.addParameter(Constants.IS_SERVER_KEY, Boolean.FALSE.toString());</span><br /><span class="line"><span class="number">36</span>:                         <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">37</span>:                             export(proxy, (Class) invoker.getInterface(), url);</span><br /><span class="line"><span class="number">38</span>:                         } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line"><span class="number">39</span>:                             LOGGER.error(<span class="string">"export a stub service error."</span>, e);</span><br /><span class="line"><span class="number">40</span>:                         }</span><br /><span class="line"><span class="number">41</span>:                     }</span><br /><span class="line"><span class="number">42</span>:                 } <span class="keyword">catch</span> (NoSuchMethodException e) {</span><br /><span class="line"><span class="number">43</span>:                     <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such constructor \"public "</span> + stubClass.getSimpleName() + <span class="string">"("</span> + serviceType.getName() + <span class="string">")\" in stub implementation class "</span> + stubClass.getName(), e);</span><br /><span class="line"><span class="number">44</span>:                 }</span><br /><span class="line"><span class="number">45</span>:             } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">46</span>:                 LOGGER.error(<span class="string">"Failed to create stub implementation class "</span> + stub + <span class="string">" in consumer "</span> + NetUtils.getLocalHost() + <span class="string">" use dubbo version "</span> + Version.getVersion() + <span class="string">", cause: "</span> + t.getMessage(), t);</span><br /><span class="line"><span class="number">47</span>:                 <span class="comment">// ignore</span></span><br /><span class="line"><span class="number">48</span>:             }</span><br /><span class="line"><span class="number">49</span>:         }</span><br /><span class="line"><span class="number">50</span>:     }</span><br /><span class="line"><span class="number">51</span>:     <span class="keyword">return</span> proxy;</span><br /><span class="line"><span class="number">52</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ã€<strong>ç¬¬ä¸€æ­¥</strong>ã€‘ç¬¬ 5 è¡Œï¼šè°ƒç”¨&nbsp;<code>proxyFactory#getProxy(invoker)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— Service Proxy å¯¹è±¡ã€‚è¿™ä¸ªè¿‡ç¨‹ï¼Œå°±æ˜¯æˆ‘ä»¬åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/proxy-local-stub/">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; åŠ¨æ€ä»£ç†ã€‹</a>&nbsp;å‰ä¸¤ç¯‡çœ‹åˆ°çš„å†…å®¹ã€‚</li>
<li>ç¬¬ 6 è¡Œï¼šè‹¥æ˜¯æ³›åŒ–å¼•ç”¨ï¼Œä¸æ”¯æŒä½¿ç”¨æœ¬åœ°å­˜æ ¹ã€‚</li>
<li>ç¬¬ 8 è‡³ 18 è¡Œï¼šè·å¾—&nbsp;<code>stub</code>&nbsp;é…ç½®é¡¹ã€‚<strong>æ³¨æ„</strong>ï¼Œ<code>local</code>&nbsp;é…ç½®é¡¹ï¼Œå’Œ&nbsp;<code>stub</code>&nbsp;é…ç½®é¡¹æ˜¯<strong>ç­‰ä»·</strong>çš„ï¼Œç›®å‰ä½¿ç”¨&nbsp;<code>stub</code>&nbsp;è€Œä¸ä½¿ç”¨&nbsp;<code>local</code>&nbsp;ã€‚</li>
<li>ç¬¬ 20 è‡³ 24 è¡Œï¼šè°ƒç”¨&nbsp;<code>ReflectUtils#forName(stub)</code>&nbsp;æ–¹æ³•ï¼ŒåŠ è½½ Stub ç±»ã€‚</li>
<li>ã€<strong>ç¬¬äºŒæ­¥</strong>ã€‘ç¬¬ 26 è‡³ 28 è¡Œï¼šåˆ›å»º Stub å¯¹è±¡ï¼Œ<strong>ä½¿ç”¨å¸¦ Service Proxy å¯¹è±¡ä½œä¸ºå‚æ•°çš„æ„é€ æ–¹æ³•</strong>ã€‚ä¾‹å¦‚ï¼Œ<code>public DemoServiceStub(DemoService demoService)</code>&nbsp;ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œæˆ‘ä»¬çš„ Stub å¯¹è±¡ï¼Œå°±å°† Proxy Service å¯¹è±¡ï¼Œ<strong>åŒ…è£…åœ¨å†…éƒ¨</strong>ï¼Œå¯ä»¥å®ç°å„ç§ OOXX å•¦ã€‚</li>
<li>ç¬¬ 30 è‡³ 41 è¡Œï¼šã€TODO 8033ã€‘å‚æ•°å›è°ƒã€‚å…ˆæ— è§†ã€‚</li>
<li>ç¬¬ 51 è¡Œï¼šè¿”å›æœ€ç»ˆçš„&nbsp;<code>proxy</code>&nbsp;ã€‚</li>
</ul>
<h2 id="2-3-getInvoker">2.3 getInvoker</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">getInvoker</span><span class="params">(T proxy, Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">    <span class="keyword">return</span> proxyFactory.getInvoker(proxy, type, url);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æœåŠ¡å®ç°çš„ Service ï¼Œä¸æ”¯æŒ Stub å­˜æ ¹ã€‚æ‰€ä»¥ï¼Œè™½ç„¶&nbsp;<code>&lt;dubbo:service /&gt;</code>&nbsp;æœ‰&nbsp;<code>stub</code>&nbsp;é…ç½®é¡¹ï¼Œä½†æ˜¯å®é™…æ˜¯æ²¡æœ‰æ•ˆæœçš„ã€‚</li>
</ul>
<h1 id="3-æ ¡éªŒ-Stub-é…ç½®">3. æ ¡éªŒ Stub é…ç½®</h1>
<p>åœ¨&nbsp;<code>#checkStubAndMock(interfaceClass)</code>&nbsp;æ–¹æ³•ä¸­ï¼Œæœ‰æ ¡éªŒ&nbsp;<code>stub</code>&nbsp;é…ç½®é¡¹çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// `local` é…ç½®é¡¹çš„æ ¡éªŒï¼Œå’Œ `stub` ä¸€æ ·ã€‚</span></span><br /><span class="line"><span class="keyword">if</span> (ConfigUtils.isNotEmpty(local)) {</span><br /><span class="line">    Class&lt;?&gt; localClass = ConfigUtils.isDefault(local) ? ReflectUtils.forName(interfaceClass.getName() + <span class="string">"Local"</span>) : ReflectUtils.forName(local);</span><br /><span class="line">    <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(localClass)) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The local implementation class "</span> + localClass.getName() + <span class="string">" not implement interface "</span> + interfaceClass.getName());</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        ReflectUtils.findConstructor(localClass, interfaceClass);</span><br /><span class="line">    } <span class="keyword">catch</span> (NoSuchMethodException e) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such constructor \"public "</span> + localClass.getSimpleName() + <span class="string">"("</span> + interfaceClass.getName() + <span class="string">")\" in local implementation class "</span> + localClass.getName());</span><br /><span class="line">    }</span><br /><span class="line">}</span><br /><span class="line"><span class="comment">// `stub` é…ç½®é¡¹çš„æ ¡éªŒ</span></span><br /><span class="line"><span class="keyword">if</span> (ConfigUtils.isNotEmpty(stub)) {</span><br /><span class="line">    <span class="comment">// `stub = true` çš„æƒ…å†µï¼Œä½¿ç”¨æ¥å£ + `Stub` å­—ç¬¦ä¸²ã€‚</span></span><br /><span class="line">    Class&lt;?&gt; localClass = ConfigUtils.isDefault(stub) ? ReflectUtils.forName(interfaceClass.getName() + <span class="string">"Stub"</span>) : ReflectUtils.forName(stub);</span><br /><span class="line">    <span class="comment">// Stub ç±»ï¼Œå¿…é¡»å®ç°æœåŠ¡æ¥å£</span></span><br /><span class="line">    <span class="keyword">if</span> (!interfaceClass.isAssignableFrom(localClass)) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The local implementation class "</span> + localClass.getName() + <span class="string">" not implement interface "</span> + interfaceClass.getName());</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// Stub ç±»ï¼Œå¿…é¡»å¸¦æœ‰æœåŠ¡æ¥å£çš„æ„é€ æ–¹æ³•</span></span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        ReflectUtils.findConstructor(localClass, interfaceClass);</span><br /><span class="line">    } <span class="keyword">catch</span> (NoSuchMethodException e) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such constructor \"public "</span> + localClass.getSimpleName() + <span class="string">"("</span> + interfaceClass.getName() + <span class="string">")\" in local implementation class "</span> + localClass.getName());</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</div>