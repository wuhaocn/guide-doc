<header class="article-header">
<h1 class="article-title">æœåŠ¡æš´éœ²ï¼ˆäºŒï¼‰ä¹‹è¿œç¨‹æš´éœ²ï¼ˆDubboï¼‰</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/service-export-local/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡æš´éœ²ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°æš´éœ²ï¼ˆInjvmï¼‰ã€‹</a>&nbsp;ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å·²ç»åˆ†äº«äº†<strong>æœ¬åœ°æš´éœ²æœåŠ¡</strong>ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æ¥åˆ†äº«<strong>è¿œç¨‹æš´éœ²æœåŠ¡</strong>ã€‚åœ¨ Dubbo ä¸­æä¾›å¤šç§åè®®( Protocol ) çš„å®ç°ï¼Œå¤§ä½“æµç¨‹ä¸€è‡´ï¼Œæœ¬æ–‡ä»¥&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/dubbo.html" target="_blank" rel="external nofollow noopener noreferrer">Dubbo Protocol</a>&nbsp;ä¸ºä¾‹å­ï¼Œè¿™ä¹Ÿæ˜¯ Dubbo çš„<strong>é»˜è®¤</strong>åè®®ã€‚</p>
<p>å¦‚æœä¸ç†Ÿæ‚‰è¯¥åè®®çš„åŒå­¦ï¼Œå¯ä»¥å…ˆçœ‹çœ‹&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/dubbo.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ä½¿ç”¨æŒ‡å— &mdash;&mdash; dubbo://ã€‹</a>&nbsp;ï¼Œç®€å•äº†è§£å³å¯ã€‚</p>
<blockquote>
<p><strong>ç‰¹æ€§</strong></p>
<p>ç¼ºçœåè®®ï¼Œä½¿ç”¨åŸºäº mina&nbsp;<code>1.1.7</code>&nbsp;å’Œ hessian&nbsp;<code>3.2.1</code>&nbsp;çš„ remoting äº¤äº’ã€‚</p>
<ul>
<li>è¿æ¥ä¸ªæ•°ï¼šå•è¿æ¥</li>
<li>è¿æ¥æ–¹å¼ï¼šé•¿è¿æ¥</li>
<li>ä¼ è¾“åè®®ï¼šTCP</li>
<li>ä¼ è¾“æ–¹å¼ï¼šNIO å¼‚æ­¥ä¼ è¾“</li>
<li>åºåˆ—åŒ–ï¼šHessian äºŒè¿›åˆ¶åºåˆ—åŒ–</li>
<li>é€‚ç”¨èŒƒå›´ï¼šä¼ å…¥ä¼ å‡ºå‚æ•°æ•°æ®åŒ…è¾ƒå°ï¼ˆå»ºè®®å°äº100Kï¼‰ï¼Œæ¶ˆè´¹è€…æ¯”æä¾›è€…ä¸ªæ•°å¤šï¼Œå•ä¸€æ¶ˆè´¹è€…æ— æ³•å‹æ»¡æä¾›è€…ï¼Œå°½é‡ä¸è¦ç”¨ dubbo åè®®ä¼ è¾“å¤§æ–‡ä»¶æˆ–è¶…å¤§å­—ç¬¦ä¸²ã€‚</li>
<li>é€‚ç”¨åœºæ™¯ï¼šå¸¸è§„è¿œç¨‹æœåŠ¡æ–¹æ³•è°ƒç”¨</li>
</ul>
</blockquote>
<p>ç›¸æ¯”<strong>æœ¬åœ°æš´éœ²</strong>ï¼Œ<strong>è¿œç¨‹æš´éœ²</strong>ä¼šå¤šåšå¦‚ä¸‹å‡ ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>å¯åŠ¨é€šä¿¡æœåŠ¡å™¨ï¼Œç»‘å®šæœåŠ¡ç«¯å£ï¼Œæä¾›è¿œç¨‹è°ƒç”¨ã€‚</li>
<li>å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡æä¾›è€…ï¼Œæä¾›æœåŠ¡æ¶ˆè´¹è€…ä»æ³¨å†Œä¸­å¿ƒå‘ç°æœåŠ¡ã€‚</li>
</ul>
<h1 id="2-è¿œç¨‹æš´éœ²">2. è¿œç¨‹æš´éœ²</h1>
<p>è¿œç¨‹æš´éœ²æœåŠ¡çš„é¡ºåºå›¾å¦‚ä¸‹ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_03_10/02.png" alt="è¿œç¨‹æš´éœ²é¡ºåºå›¾" /></p>
<p>åœ¨&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/c635dd1990a1803643194048f408db310f06175b/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L621-L648" target="_blank" rel="external nofollow noopener noreferrer"><code>#doExportUrlsFor1Protocol(protocolConfig, registryURLs)</code></a>&nbsp;æ–¹æ³•ä¸­ï¼Œæ¶‰åŠ<strong>è¿œç¨‹æš´éœ²æœåŠ¡</strong>çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">// æœåŠ¡è¿œç¨‹æš´éœ²</span></span><br /><span class="line"> <span class="number">2</span>: <span class="comment">// export to remote if the config is not local (export to local only when config is local)</span></span><br /><span class="line"> <span class="number">3</span>: <span class="keyword">if</span> (!Constants.SCOPE_LOCAL.toString().equalsIgnoreCase(scope)) {</span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"> <span class="number">5</span>:         logger.info(<span class="string">"Export dubbo service "</span> + interfaceClass.getName() + <span class="string">" to url "</span> + url);</span><br /><span class="line"> <span class="number">6</span>:     }</span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (registryURLs != <span class="keyword">null</span> &amp;&amp; !registryURLs.isEmpty()) {</span><br /><span class="line"> <span class="number">8</span>:         <span class="keyword">for</span> (URL registryURL : registryURLs) {</span><br /><span class="line"> <span class="number">9</span>:             <span class="comment">// "dynamic" ï¼šæœåŠ¡æ˜¯å¦åŠ¨æ€æ³¨å†Œï¼Œå¦‚æœè®¾ä¸ºfalseï¼Œæ³¨å†Œåå°†æ˜¾ç¤ºådisableçŠ¶æ€ï¼Œéœ€äººå·¥å¯ç”¨ï¼Œå¹¶ä¸”æœåŠ¡æä¾›è€…åœæ­¢æ—¶ï¼Œä¹Ÿä¸ä¼šè‡ªåŠ¨å–æ¶ˆå†Œï¼Œéœ€äººå·¥ç¦ç”¨ã€‚</span></span><br /><span class="line"><span class="number">10</span>:             url = url.addParameterIfAbsent(<span class="string">"dynamic"</span>, registryURL.getParameter(<span class="string">"dynamic"</span>));</span><br /><span class="line"><span class="number">11</span>:             <span class="comment">// è·å¾—ç›‘æ§ä¸­å¿ƒ URL</span></span><br /><span class="line"><span class="number">12</span>:             URL monitorUrl = loadMonitor(registryURL); <span class="comment">// TODO èŠ‹è‰¿ï¼Œç›‘æ§</span></span><br /><span class="line"><span class="number">13</span>:             <span class="keyword">if</span> (monitorUrl != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">14</span>:                 url = url.addParameterAndEncoded(Constants.MONITOR_KEY, monitorUrl.toFullString());</span><br /><span class="line"><span class="number">15</span>:             }</span><br /><span class="line"><span class="number">16</span>:             <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"><span class="number">17</span>:                 logger.info(<span class="string">"Register dubbo service "</span> + interfaceClass.getName() + <span class="string">" url "</span> + url + <span class="string">" to registry "</span> + registryURL);</span><br /><span class="line"><span class="number">18</span>:             }</span><br /><span class="line"><span class="number">19</span>:             <span class="comment">// ä½¿ç”¨ ProxyFactory åˆ›å»º Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="number">20</span>:             Invoker&lt;?&gt; invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, registryURL.addParameterAndEncoded(Constants.EXPORT_KEY, url.toFullString()));</span><br /><span class="line"><span class="number">21</span>: </span><br /><span class="line"><span class="number">22</span>:             <span class="comment">// åˆ›å»º DelegateProviderMetaDataInvoker å¯¹è±¡</span></span><br /><span class="line"><span class="number">23</span>:             DelegateProviderMetaDataInvoker wrapperInvoker = <span class="keyword">new</span> DelegateProviderMetaDataInvoker(invoker, <span class="keyword">this</span>);</span><br /><span class="line"><span class="number">24</span>: </span><br /><span class="line"><span class="number">25</span>:             <span class="comment">// ä½¿ç”¨ Protocol æš´éœ² Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="number">26</span>:             Exporter&lt;?&gt; exporter = protocol.export(wrapperInvoker);</span><br /><span class="line"><span class="number">27</span>:             <span class="comment">// æ·»åŠ åˆ° `exporters`</span></span><br /><span class="line"><span class="number">28</span>:             exporters.add(exporter);</span><br /><span class="line"><span class="number">29</span>:         }</span><br /><span class="line"><span class="number">30</span>:     } <span class="keyword">else</span> { <span class="comment">// ç”¨äºè¢«æœåŠ¡æ¶ˆè´¹è€…ç›´è¿æœåŠ¡æä¾›è€…ï¼Œå‚è§æ–‡æ¡£ http://dubbo.apache.org/zh-cn/docs/user/demos/explicit-target.html ã€‚ä¸»è¦ç”¨äºå¼€å‘æµ‹è¯•ç¯å¢ƒä½¿ç”¨ã€‚</span></span><br /><span class="line"><span class="number">31</span>:         <span class="comment">// ä½¿ç”¨ ProxyFactory åˆ›å»º Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="number">32</span>:         Invoker&lt;?&gt; invoker = proxyFactory.getInvoker(ref, (Class) interfaceClass, url);</span><br /><span class="line"><span class="number">33</span>: </span><br /><span class="line"><span class="number">34</span>:         <span class="comment">// åˆ›å»º DelegateProviderMetaDataInvoker å¯¹è±¡</span></span><br /><span class="line"><span class="number">35</span>:         DelegateProviderMetaDataInvoker wrapperInvoker = <span class="keyword">new</span> DelegateProviderMetaDataInvoker(invoker, <span class="keyword">this</span>);</span><br /><span class="line"><span class="number">36</span>: </span><br /><span class="line"><span class="number">37</span>:         <span class="comment">// ä½¿ç”¨ Protocol æš´éœ² Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="number">38</span>:         Exporter&lt;?&gt; exporter = protocol.export(wrapperInvoker);</span><br /><span class="line"><span class="number">39</span>:         <span class="comment">// æ·»åŠ åˆ° `exporters`</span></span><br /><span class="line"><span class="number">40</span>:         exporters.add(exporter);</span><br /><span class="line"><span class="number">41</span>:     }</span><br /><span class="line"><span class="number">42</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ç¬¬ 30 è‡³ 41 è¡Œï¼š<strong>å¤§ä½“å’Œã€ç¬¬ 7 è‡³ 29 è¡Œã€‘é€»è¾‘ç›¸åŒ</strong>ã€‚å·®åˆ«åœ¨äºï¼Œå½“é…ç½®æ³¨å†Œä¸­å¿ƒä¸º&nbsp;<code>"N/A"</code>&nbsp;æ—¶ï¼Œè¡¨ç¤ºå³ä½¿è¿œç¨‹æš´éœ²æœåŠ¡ï¼Œä¹Ÿä¸å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œã€‚è¿™ç§æ–¹å¼ç”¨äºè¢«æœåŠ¡æ¶ˆè´¹è€…ç›´è¿æœåŠ¡æä¾›è€…ï¼Œå‚è§&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/explicit-target.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; ç›´è¿æä¾›è€…ã€‹</a>&nbsp;æ–‡æ¡£ã€‚</p>
<blockquote>
<p>åœ¨<strong>å¼€å‘åŠæµ‹è¯•ç¯å¢ƒä¸‹</strong>ï¼Œç»å¸¸éœ€è¦ç»•è¿‡æ³¨å†Œä¸­å¿ƒï¼Œåªæµ‹è¯•æŒ‡å®šæœåŠ¡æä¾›è€…ï¼Œè¿™æ—¶å€™å¯èƒ½éœ€è¦ç‚¹å¯¹ç‚¹ç›´è¿ï¼Œç‚¹å¯¹ç‚¹ç›´è”æ–¹å¼ï¼Œå°†ä»¥æœåŠ¡æ¥å£ä¸ºå•ä½ï¼Œå¿½ç•¥æ³¨å†Œä¸­å¿ƒçš„æä¾›è€…åˆ—è¡¨ï¼ŒA æ¥å£é…ç½®ç‚¹å¯¹ç‚¹ï¼Œä¸å½±å“ B æ¥å£ä»æ³¨å†Œä¸­å¿ƒè·å–åˆ—è¡¨ã€‚</p>
</blockquote>
</li>
<li>
<p>ç¬¬ 8 è¡Œï¼šå¾ªç¯ç¥–å†Œä¸­å¿ƒ URL æ•°ç»„&nbsp;<code>registryURLs</code>&nbsp;ã€‚</p>
</li>
<li>ç¬¬ 10 è¡Œï¼š<code>"dynamic"</code>&nbsp;é…ç½®é¡¹ï¼ŒæœåŠ¡æ˜¯å¦åŠ¨æ€æ³¨å†Œã€‚å¦‚æœè®¾ä¸º&nbsp;<strong>false</strong>&nbsp;ï¼Œæ³¨å†Œåå°†æ˜¾ç¤ºå&nbsp;<strong>disable</strong>&nbsp;çŠ¶æ€ï¼Œéœ€äººå·¥å¯ç”¨ï¼Œå¹¶ä¸”æœåŠ¡æä¾›è€…åœæ­¢æ—¶ï¼Œä¹Ÿä¸ä¼šè‡ªåŠ¨å–æ¶ˆå†Œï¼Œéœ€äººå·¥ç¦ç”¨ã€‚</li>
<li>ç¬¬ 12 è¡Œï¼šè°ƒç”¨&nbsp;<code>#loadMonitor(registryURL)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—ç›‘æ§ä¸­å¿ƒ URL ã€‚
<ul>
<li>ğŸ™‚ åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/service-export-remote-dubbo/">ã€Œ2.1 loadMonitorã€</a>&nbsp;å°èŠ‚ï¼Œè¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>ç¬¬ 13 è‡³ 15 è¡Œï¼šè°ƒç”¨&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/c635dd1990a1803643194048f408db310f06175b/dubbo-common/src/main/java/com/alibaba/dubbo/common/URL.java#L891-L896" target="_blank" rel="external nofollow noopener noreferrer"><code>URL#addParameterAndEncoded(key, value)</code></a>&nbsp;æ–¹æ³•ï¼Œå°†ç›‘æ§ä¸­å¿ƒçš„ URL ä½œä¸º&nbsp;<code>"monitor"</code>&nbsp;å‚æ•°æ·»åŠ åˆ°æœåŠ¡æä¾›è€…çš„ URL ä¸­ï¼Œ<strong>å¹¶ä¸”éœ€è¦ç¼–ç </strong>ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼ŒæœåŠ¡æä¾›è€…çš„ URL ä¸­ï¼Œ<strong>åŒ…å«äº†ç›‘æ§ä¸­å¿ƒçš„é…ç½®</strong>ã€‚</li>
<li>ç¬¬ 20 è¡Œï¼šè°ƒç”¨&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/c635dd1990a1803643194048f408db310f06175b/dubbo-common/src/main/java/com/alibaba/dubbo/common/URL.java#L891-L896" target="_blank" rel="external nofollow noopener noreferrer"><code>URL#addParameterAndEncoded(key, value)</code></a>&nbsp;æ–¹æ³•ï¼Œå°†æœåŠ¡ä½“ç”¨è¿™çš„ URL ä½œä¸º&nbsp;<code>"export"</code>&nbsp;å‚æ•°æ·»åŠ åˆ°æ³¨å†Œä¸­å¿ƒçš„ URL ä¸­ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œæ³¨å†Œä¸­å¿ƒçš„ URL ä¸­ï¼Œ<strong>åŒ…å«äº†æœåŠ¡æä¾›è€…çš„é…ç½®</strong>ã€‚</li>
<li>ç¬¬ 20 è¡Œï¼šè°ƒç”¨&nbsp;<code>ProxyFactory#getInvoker(proxy, type, url)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º Invoker å¯¹è±¡ã€‚è¯¥ Invoker å¯¹è±¡ï¼Œæ‰§è¡Œ&nbsp;<code>#invoke(invocation)</code>&nbsp;æ–¹æ³•æ—¶ï¼Œå†…éƒ¨ä¼šè°ƒç”¨ Service å¯¹è±¡(&nbsp;<code>ref</code>&nbsp;)å¯¹åº”çš„è°ƒç”¨æ–¹æ³•ã€‚
<ul>
<li>ğŸ™‚ è¯¦ç»†çš„å®ç°ï¼Œåé¢å•ç‹¬å†™æ–‡ç« åˆ†äº«ã€‚</li>
<li>ğŸ˜ˆ ä¸ºä»€ä¹ˆä¼ é€’çš„æ˜¯<strong>æ³¨å†Œä¸­å¿ƒçš„ URL</strong>&nbsp;å‘¢ï¼Ÿä¸‹æ–‡ä¼šè¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>ç¬¬ 23 è¡Œï¼šåˆ›å»º&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/c635dd1990a1803643194048f408db310f06175b/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/invoker/DelegateProviderMetaDataInvoker.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.config.invoker.DelegateProviderMetaDataInvoker</code></a>&nbsp;å¯¹è±¡ã€‚è¯¥å¯¹è±¡åœ¨ Invoker å¯¹è±¡çš„åŸºç¡€ä¸Šï¼Œå¢åŠ äº†å½“å‰æœåŠ¡æä¾›è€… ServiceConfig å¯¹è±¡ã€‚</li>
<li>
<p>ç¬¬ 26 è¡Œï¼šè°ƒç”¨&nbsp;<code>Protocol#export(invoker)</code>&nbsp;æ–¹æ³•ï¼Œæš´éœ²æœåŠ¡ã€‚</p>
<ul>
<li>æ­¤å¤„ Dubbo SPI&nbsp;<strong>è‡ªé€‚åº”</strong>çš„ç‰¹æ€§çš„<strong>å¥½å¤„</strong>å°±å‡ºæ¥äº†ï¼Œå¯ä»¥<strong>è‡ªåŠ¨</strong>æ ¹æ® URL å‚æ•°ï¼Œè·å¾—å¯¹åº”çš„æ‹“å±•å®ç°ã€‚ä¾‹å¦‚ï¼Œ<code>invoker</code>ä¼ å…¥åï¼Œæ ¹æ®&nbsp;<code>invoker.url</code>&nbsp;è‡ªåŠ¨è·å¾—å¯¹åº” Protocol æ‹“å±•å®ç°ä¸º DubboProtocol ã€‚</li>
<li>
<p>å®é™…ä¸Šï¼ŒProtocol æœ‰ä¸¤ä¸ª Wrapper æ‹“å±•å®ç°ç±»ï¼š ProtocolFilterWrapperã€ProtocolListenerWrapper ã€‚æ‰€ä»¥ï¼Œ<code>#export(...)</code>&nbsp;æ–¹æ³•çš„è°ƒç”¨é¡ºåºæ˜¯ï¼š</p>
<ul>
<li><strong>Protocol$Adaptive =&gt; ProtocolFilterWrapper =&gt; ProtocolListenerWrapper =&gt; RegistryProtocol</strong></li>
<li>=&gt;</li>
<li><strong>Protocol$Adaptive =&gt; ProtocolFilterWrapper =&gt; ProtocolListenerWrapper =&gt; DubboProtocol</strong></li>
<li>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>è¿™ä¸€æ¡å¤§çš„è°ƒç”¨é“¾ï¼ŒåŒ…å«ä¸¤æ¡å°çš„è°ƒç”¨é“¾</strong>ã€‚åŸå› æ˜¯ï¼š
<ul>
<li>é¦–å…ˆï¼Œä¼ å…¥çš„æ˜¯æ³¨å†Œä¸­å¿ƒçš„ URL ï¼Œé€šè¿‡ Protocol$Adaptive è·å–åˆ°çš„æ˜¯ RegistryProtocol å¯¹è±¡ã€‚</li>
<li>å…¶æ¬¡ï¼ŒRegistryProtocol ä¼šåœ¨å…¶&nbsp;<code>#export(...)</code>&nbsp;æ–¹æ³•ä¸­ï¼Œä½¿ç”¨æœåŠ¡æä¾›è€…çš„ URL ( å³æ³¨å†Œä¸­å¿ƒçš„ URL çš„&nbsp;<code>export</code>&nbsp;å‚æ•°å€¼)ï¼Œå†æ¬¡è°ƒç”¨ Protocol$Adaptive è·å–åˆ°çš„æ˜¯ DubboProtocol å¯¹è±¡ï¼Œè¿›è¡ŒæœåŠ¡æš´éœ²ã€‚</li>
</ul>
</li>
<li>
<p><strong>ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„é¡ºåº</strong>ï¼Ÿé€šè¿‡è¿™æ ·çš„é¡ºåºï¼Œå¯ä»¥å®ç°ç±»ä¼¼&nbsp;<strong>AOP</strong>&nbsp;çš„æ•ˆæœï¼Œåœ¨æœ¬åœ°æœåŠ¡å™¨å¯åŠ¨å®Œæˆåï¼Œå†å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œã€‚ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">RegistryProtocol#export(...) {</span><br />    <br /><span class="line">    <span class="comment">// 1. å¯åŠ¨æœ¬åœ°æœåŠ¡å™¨</span></span><br /><span class="line">    DubboProtocol#export(...);</span><br />    <br /><span class="line">    <span class="comment">// 2. å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œã€‚ </span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸Šæ–‡æåˆ°çš„ &ldquo;ä¸ºä»€ä¹ˆä¼ é€’çš„æ˜¯<strong>æ³¨å†Œä¸­å¿ƒçš„ URL</strong>&nbsp;å‘¢ï¼Ÿ&rdquo; çš„åŸå› ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ğŸ™‚ å¦‚æœæ— æ³•ç†è§£ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/service-export-remote-dubbo/">ã€Œ3. Protocolã€</a>&nbsp;åœ¨è§£æä»£ç ï¼Œè¿›ä¸€æ­¥ç†é¡ºã€‚</li>
</ul>
</li>
<li>ç¬¬ 28 è¡Œï¼šæ·»åŠ åˆ°&nbsp;<code>exporters</code>&nbsp;é›†åˆä¸­ã€‚</li>
</ul>
<h2 id="2-1-loadMonitor">2.1 loadMonitor</h2>
<blockquote>
<p>å‹æƒ…æç¤ºï¼Œç›‘æ§ä¸­å¿ƒä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œç®€å•åˆ†äº«ä¸‹è¯¥æ–¹æ³•çš„é€»è¾‘ã€‚<br />å¯ç›´æ¥è·³è¿‡ã€‚</p>
</blockquote>
<p><code>#loadMonitor(registryURL)</code>&nbsp;æ–¹æ³•ï¼ŒåŠ è½½ç›‘æ§ä¸­å¿ƒ&nbsp;<code>com.alibaba.dubbo.common.URL</code>&nbsp;æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * åŠ è½½ç›‘æ§ä¸­å¿ƒ URL</span></span><br /><span class="line"><span class="comment"> 3:  *</span></span><br /><span class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> registryURL æ³¨å†Œä¸­å¿ƒ URL</span></span><br /><span class="line"><span class="comment"> 5:  * <span class="doctag">@return</span> ç›‘æ§ä¸­å¿ƒ URL</span></span><br /><span class="line"><span class="comment"> 6:  */</span></span><br /><span class="line"> <span class="number">7</span>: <span class="function"><span class="keyword">protected</span> URL <span class="title">loadMonitor</span><span class="params">(URL registryURL)</span> </span>{</span><br /><span class="line"> <span class="number">8</span>:     <span class="comment">// ä» å±æ€§é…ç½® ä¸­åŠ è½½é…ç½®åˆ° MonitorConfig å¯¹è±¡ã€‚</span></span><br /><span class="line"> <span class="number">9</span>:     <span class="keyword">if</span> (monitor == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">10</span>:         String monitorAddress = ConfigUtils.getProperty(<span class="string">"dubbo.monitor.address"</span>);</span><br /><span class="line"><span class="number">11</span>:         String monitorProtocol = ConfigUtils.getProperty(<span class="string">"dubbo.monitor.protocol"</span>);</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">if</span> ((monitorAddress == <span class="keyword">null</span> || monitorAddress.length() == <span class="number">0</span>) &amp;&amp; (monitorProtocol == <span class="keyword">null</span> || monitorProtocol.length() == <span class="number">0</span>)) {</span><br /><span class="line"><span class="number">13</span>:             <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">14</span>:         }</span><br /><span class="line"><span class="number">15</span>: </span><br /><span class="line"><span class="number">16</span>:         monitor = <span class="keyword">new</span> MonitorConfig();</span><br /><span class="line"><span class="number">17</span>:         <span class="keyword">if</span> (monitorAddress != <span class="keyword">null</span> &amp;&amp; monitorAddress.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">18</span>:             monitor.setAddress(monitorAddress);</span><br /><span class="line"><span class="number">19</span>:         }</span><br /><span class="line"><span class="number">20</span>:         <span class="keyword">if</span> (monitorProtocol != <span class="keyword">null</span> &amp;&amp; monitorProtocol.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">21</span>:             monitor.setProtocol(monitorProtocol);</span><br /><span class="line"><span class="number">22</span>:         }</span><br /><span class="line"><span class="number">23</span>:     }</span><br /><span class="line"><span class="number">24</span>:     appendProperties(monitor);</span><br /><span class="line"><span class="number">25</span>:     <span class="comment">// æ·»åŠ  `interface` `dubbo` `timestamp` `pid` åˆ° `map` é›†åˆä¸­</span></span><br /><span class="line"><span class="number">26</span>:     Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br /><span class="line"><span class="number">27</span>:     map.put(Constants.INTERFACE_KEY, MonitorService.class.getName());</span><br /><span class="line"><span class="number">28</span>:     map.put(<span class="string">"dubbo"</span>, Version.getVersion());</span><br /><span class="line"><span class="number">29</span>:     map.put(Constants.TIMESTAMP_KEY, String.valueOf(System.currentTimeMillis()));</span><br /><span class="line"><span class="number">30</span>:     <span class="keyword">if</span> (ConfigUtils.getPid() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">31</span>:         map.put(Constants.PID_KEY, String.valueOf(ConfigUtils.getPid()));</span><br /><span class="line"><span class="number">32</span>:     }</span><br /><span class="line"><span class="number">33</span>:     <span class="comment">// å°† MonitorConfig ï¼Œæ·»åŠ åˆ° `map` é›†åˆä¸­ã€‚</span></span><br /><span class="line"><span class="number">34</span>:     appendParameters(map, monitor);</span><br /><span class="line"><span class="number">35</span>:     <span class="comment">// è·å¾—åœ°å€</span></span><br /><span class="line"><span class="number">36</span>:     String address = monitor.getAddress();</span><br /><span class="line"><span class="number">37</span>:     String sysaddress = System.getProperty(<span class="string">"dubbo.monitor.address"</span>);</span><br /><span class="line"><span class="number">38</span>:     <span class="keyword">if</span> (sysaddress != <span class="keyword">null</span> &amp;&amp; sysaddress.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">39</span>:         address = sysaddress;</span><br /><span class="line"><span class="number">40</span>:     }</span><br /><span class="line"><span class="number">41</span>:     <span class="comment">// ç›´è¿ç›‘æ§ä¸­å¿ƒæœåŠ¡å™¨åœ°å€</span></span><br /><span class="line"><span class="number">42</span>:     <span class="keyword">if</span> (ConfigUtils.isNotEmpty(address)) {</span><br /><span class="line"><span class="number">43</span>:         <span class="comment">// è‹¥ä¸å­˜åœ¨ `protocol` å‚æ•°ï¼Œé»˜è®¤ "dubbo" æ·»åŠ åˆ° `map` é›†åˆä¸­ã€‚</span></span><br /><span class="line"><span class="number">44</span>:         <span class="keyword">if</span> (!map.containsKey(Constants.PROTOCOL_KEY)) {</span><br /><span class="line"><span class="number">45</span>:             <span class="keyword">if</span> (ExtensionLoader.getExtensionLoader(MonitorFactory.class).hasExtension(<span class="string">"logstat"</span>)) {</span><br /><span class="line"><span class="number">46</span>:                 map.put(Constants.PROTOCOL_KEY, <span class="string">"logstat"</span>);</span><br /><span class="line"><span class="number">47</span>:             } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">48</span>:                 map.put(Constants.PROTOCOL_KEY, <span class="string">"dubbo"</span>);</span><br /><span class="line"><span class="number">49</span>:             }</span><br /><span class="line"><span class="number">50</span>:         }</span><br /><span class="line"><span class="number">51</span>:         <span class="comment">// è§£æåœ°å€ï¼Œåˆ›å»º Dubbo URL å¯¹è±¡ã€‚</span></span><br /><span class="line"><span class="number">52</span>:         <span class="keyword">return</span> UrlUtils.parseURL(address, map);</span><br /><span class="line"><span class="number">53</span>:     <span class="comment">// ä»æ³¨å†Œä¸­å¿ƒå‘ç°ç›‘æ§ä¸­å¿ƒåœ°å€</span></span><br /><span class="line"><span class="number">54</span>:     } <span class="keyword">else</span> <span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(monitor.getProtocol()) &amp;&amp; registryURL != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">55</span>:         <span class="keyword">return</span> registryURL.setProtocol(<span class="string">"dubbo"</span>).addParameter(Constants.PROTOCOL_KEY, <span class="string">"registry"</span>).addParameterAndEncoded(Constants.REFER_KEY, StringUtils.toQueryString(map));</span><br /><span class="line"><span class="number">56</span>:     }</span><br /><span class="line"><span class="number">57</span>:     <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">58</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 8 è‡³ 24 è¡Œï¼šä»<strong>å±æ€§é…ç½®</strong>ä¸­ï¼ŒåŠ è½½é…ç½®åˆ° MonitorConfig å¯¹è±¡ã€‚</li>
<li>ç¬¬ 25 è‡³ 32 è¡Œï¼šæ·»åŠ &nbsp;<code>interface</code>&nbsp;<code>dubbo</code>&nbsp;<code>timestamp</code>&nbsp;<code>pid</code>&nbsp;åˆ°&nbsp;<code>map</code>&nbsp;é›†åˆä¸­ã€‚</li>
<li>ç¬¬ 34 è¡Œï¼šè°ƒç”¨&nbsp;<code>#appendParameters(map, config)</code>&nbsp;æ–¹æ³•ï¼Œå°† MonitorConfig ï¼Œæ·»åŠ åˆ°&nbsp;<code>map</code>&nbsp;é›†åˆä¸­ã€‚</li>
<li>ç¬¬ 35 è‡³ 40 è¡Œï¼šè·å¾—<strong>ç›‘æ§ä¸­å¿ƒ</strong>çš„åœ°å€ã€‚</li>
<li>ç¬¬ 42 è¡Œï¼šå½“&nbsp;<code>address</code>&nbsp;éç©ºæ—¶ï¼Œ<strong>ç›´è¿ç›‘æ§ä¸­å¿ƒæœåŠ¡å™¨åœ°å€çš„æƒ…å†µ</strong>ã€‚
<ul>
<li>ç¬¬ 43 è‡³ 50 è¡Œï¼šè‹¥ä¸å­˜åœ¨&nbsp;<code>protocol</code>&nbsp;å‚æ•°ï¼Œç¼ºçœé»˜è®¤ä¸º &ldquo;dubbo&rdquo; ï¼Œå¹¶æ·»åŠ åˆ°&nbsp;<code>map</code>&nbsp;é›†åˆä¸­ã€‚
<ul>
<li>ç¬¬ 44 è‡³ 55 è¡Œï¼š<strong>å¯ä»¥å¿½ç•¥</strong>ã€‚å› ä¸ºï¼Œ<code>logstat</code>&nbsp;è¿™ä¸ªæ‹“å±•å®ç°å·²ç»ä¸å­˜åœ¨ã€‚</li>
</ul>
</li>
<li>ç¬¬ 52 è¡Œï¼šè°ƒç”¨&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-common/src/main/java/com/alibaba/dubbo/common/utils/UrlUtils.java#L30-L145" target="_blank" rel="external nofollow noopener noreferrer"><code>UrlUtils#parseURL(address, map)</code></a>&nbsp;æ–¹æ³•ï¼Œè§£æ&nbsp;<code>address</code>&nbsp;ï¼Œåˆ›å»º Dubbo URL å¯¹è±¡ã€‚
<ul>
<li>ğŸ™‚ å·²ç»æ·»åŠ äº†ä»£ç æ³¨é‡Šï¼Œèƒ–å‹ç‚¹å‡»é“¾æ¥æŸ¥çœ‹ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 54 è‡³ 56 è¡Œï¼šå½“&nbsp;<code>protocol = registry</code>&nbsp;æ—¶ï¼Œå¹¶ä¸”æ³¨å†Œä¸­å¿ƒ URL éç©ºæ—¶ï¼Œ<strong>ä»æ³¨å†Œä¸­å¿ƒå‘ç°ç›‘æ§ä¸­å¿ƒåœ°å€</strong>ã€‚ä»¥&nbsp;<code>registryURL</code>&nbsp;ä¸ºåŸºç¡€ï¼Œåˆ›å»º URL ï¼š
<ul>
<li><code>protocol = dubbo</code></li>
<li><code>parameters.protocol = registry</code></li>
<li><code>parameters.refer = map</code></li>
</ul>
</li>
<li>ç¬¬ 57 è¡Œï¼š<strong>æ— æ³¨å†Œä¸­å¿ƒ</strong>ï¼Œè¿”å›ç©ºã€‚</li>
<li>ps ï¼šåç»­ä¼šæœ‰æ–‡ç« ï¼Œè¯¦ç»†åˆ†äº«ã€‚</li>
</ul>
<h1 id="3-Protocol">3. Protocol</h1>
<p>æœ¬æ–‡æ¶‰åŠçš„ Protocol ç±»å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_03_10/04.png" alt="Protocol ç±»å›¾" /></p>
<h2 id="3-1-ProtocolFilterWrapper">3.1 ProtocolFilterWrapper</h2>
<p>æ¥&nbsp;<a href="http://svip.iocoder.cn/Dubbo/service-export-local/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡æš´éœ²ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°æš´éœ²ï¼ˆInjvmï¼‰ã€‹ã€Œ 3.2 ProtocolFilterWrapperã€</a>å°èŠ‚ã€‚</p>
<p><code>#export(invoker)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="number">1</span>: <span class="keyword">public</span> &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(Invoker&lt;T&gt; invoker)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"><span class="number">2</span>:     <span class="comment">// æ³¨å†Œä¸­å¿ƒ</span></span><br /><span class="line"><span class="number">3</span>:     <span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(invoker.getUrl().getProtocol())) {</span><br /><span class="line"><span class="number">4</span>:         <span class="keyword">return</span> protocol.export(invoker);</span><br /><span class="line"><span class="number">5</span>:     }</span><br /><span class="line"><span class="number">6</span>:     <span class="comment">// å»ºç«‹å¸¦æœ‰ Filter è¿‡æ»¤é“¾çš„ Invoker ï¼Œå†æš´éœ²æœåŠ¡ã€‚</span></span><br /><span class="line"><span class="number">7</span>:     <span class="keyword">return</span> protocol.export(buildInvokerChain(invoker, Constants.SERVICE_FILTER_KEY, Constants.PROVIDER));</span><br /><span class="line"><span class="number">8</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 2 è‡³ 5 è¡Œï¼šå½“&nbsp;<code>invoker.url.protocl = registry</code>&nbsp;ï¼Œ<strong>æ³¨å†Œä¸­å¿ƒçš„ URL</strong>&nbsp;ï¼Œæ— éœ€åˆ›å»º Filter è¿‡æ»¤é“¾ã€‚</li>
<li>ç¬¬ 7 è¡Œï¼šè°ƒç”¨&nbsp;<code>#buildInvokerChain(invoker, key, group)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºå¸¦æœ‰ Filter è¿‡æ»¤é“¾çš„ Invoker å¯¹è±¡ã€‚</li>
<li>ç¬¬ 7 è¡Œï¼šè°ƒç”¨&nbsp;<code>protocol#export(invoker)</code>&nbsp;æ–¹æ³•ï¼Œç»§ç»­æš´éœ²æœåŠ¡ã€‚</li>
<li>åœ¨ RegistryProtocol ä¸­ï¼Œä¼šè°ƒç”¨&nbsp;<code>DubboProtocol#export(...)</code>&nbsp;æ–¹æ³•æ—¶ï¼Œä¼šèµ°ã€<strong>ç¬¬ 7 è¡Œ</strong>ã€‘çš„æµç¨‹ã€‚</li>
</ul>
<h2 id="3-2-RegistryProtocol">3.2 RegistryProtocol</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/integration/RegistryProtocol.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.registry.integration.RegistryProtocol</code></a>&nbsp;ï¼Œå®ç° Protocol æ¥å£ï¼Œæ³¨å†Œä¸­å¿ƒåè®®å®ç°ç±»ã€‚</p>
<h3 id="3-2-1-å±æ€§">3.2.1 å±æ€§</h3>
<p>å±æ€§ç›¸å…³ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å‹æƒ…æç¤ºï¼Œä»…åŒ…å«æœ¬æ–‡æ¶‰åŠçš„å±æ€§ã€‚</p>
</blockquote>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ... çœç•¥éƒ¨åˆ†å’Œæœ¬æ–‡æ— å…³çš„å±æ€§ã€‚</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å•ä¾‹ã€‚åœ¨ Dubbo SPI ä¸­ï¼Œè¢«åˆå§‹åŒ–ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€æ¬¡ã€‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> RegistryProtocol INSTANCE;</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ç»‘å®šå…³ç³»é›†åˆã€‚</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * keyï¼šæœåŠ¡ Dubbo URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="comment">// To solve the problem of RMI repeated exposure port conflicts, the services that have been exposed are no longer exposed.</span></span><br /><span class="line"><span class="comment">// ç”¨äºè§£å†³rmié‡å¤æš´éœ²ç«¯å£å†²çªçš„é—®é¢˜ï¼Œå·²ç»æš´éœ²è¿‡çš„æœåŠ¡ä¸å†é‡æ–°æš´éœ²</span></span><br /><span class="line"><span class="comment">// providerurl &lt;--&gt; exporter</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ExporterChangeableWrapper&lt;?&gt;&gt; bounds = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ExporterChangeableWrapper&lt;?&gt;&gt;();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Protocol è‡ªé€‚åº”æ‹“å±•å®ç°ç±»ï¼Œé€šè¿‡ Dubbo SPI è‡ªåŠ¨æ³¨å…¥ã€‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Protocol protocol;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * RegistryFactory è‡ªé€‚åº”æ‹“å±•å®ç°ç±»ï¼Œé€šè¿‡ Dubbo SPI è‡ªåŠ¨æ³¨å…¥ã€‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> RegistryFactory registryFactory;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RegistryProtocol</span><span class="params">()</span> </span>{</span><br /><span class="line">    INSTANCE = <span class="keyword">this</span>;</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> RegistryProtocol <span class="title">getRegistryProtocol</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (INSTANCE == <span class="keyword">null</span>) {</span><br /><span class="line">        ExtensionLoader.getExtensionLoader(Protocol.class).getExtension(Constants.REGISTRY_PROTOCOL); <span class="comment">// load</span></span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> INSTANCE;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>INSTANCE</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼Œå•ä¾‹ã€‚é€šè¿‡ Dubbo SPI åŠ è½½åˆ›å»ºï¼Œæœ‰ä¸”ä»…æœ‰ä¸€æ¬¡ã€‚
<ul>
<li><code>#getRegistryProtocol()</code>&nbsp;<strong>é™æ€</strong>æ–¹æ³•ï¼Œè·å¾—å•ä¾‹ã€‚</li>
</ul>
</li>
<li><code>bounds</code>&nbsp;å±æ€§ï¼Œç»‘å®šå…³ç³»é›†åˆã€‚å…¶ä¸­ï¼ŒKey ä¸º<strong>æœåŠ¡æä¾›è€… URL</strong>&nbsp;ã€‚</li>
<li><code>protocol</code>&nbsp;å±æ€§ï¼ŒProtocol è‡ªé€‚åº”æ‹“å±•å®ç°ç±»ï¼Œé€šè¿‡ Dubbo SPI è‡ªåŠ¨æ³¨å…¥ã€‚</li>
<li><code>registryFactory</code>&nbsp;å±æ€§ï¼Œè‡ªé€‚åº”æ‹“å±•å®ç°ç±»ï¼Œé€šè¿‡ Dubbo SPI è‡ªåŠ¨æ³¨å…¥ã€‚
<ul>
<li>ç”¨äºåˆ›å»ºæ³¨å†Œä¸­å¿ƒ Registry å¯¹è±¡ã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-2-2-export">3.2.2 export</h3>
<p>æœ¬æ–‡æ¶‰åŠçš„&nbsp;<code>#export(invoker)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">public</span> &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(<span class="keyword">final</span> Invoker&lt;T&gt; originInvoker)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// æš´éœ²æœåŠ¡</span></span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// export invoker</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">final</span> ExporterChangeableWrapper&lt;T&gt; exporter = doLocalExport(originInvoker);</span><br /><span class="line"> <span class="number">5</span>: </span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// è·å¾—æ³¨å†Œä¸­å¿ƒ URL</span></span><br /><span class="line"> <span class="number">7</span>:     URL registryUrl = getRegistryUrl(originInvoker);</span><br /><span class="line"> <span class="number">8</span>: </span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// è·å¾—æ³¨å†Œä¸­å¿ƒå¯¹è±¡</span></span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// registry provider</span></span><br /><span class="line"><span class="number">11</span>:     <span class="keyword">final</span> Registry registry = getRegistry(originInvoker);</span><br /><span class="line"><span class="number">12</span>: </span><br /><span class="line"><span class="number">13</span>:     <span class="comment">// è·å¾—æœåŠ¡æä¾›è€… URL</span></span><br /><span class="line"><span class="number">14</span>:     <span class="keyword">final</span> URL registedProviderUrl = getRegistedProviderUrl(originInvoker);</span><br /><span class="line"><span class="number">15</span>: </span><br /><span class="line"><span class="number">16</span>:     <span class="comment">//to judge to delay publish whether or not</span></span><br /><span class="line"><span class="number">17</span>:     <span class="keyword">boolean</span> register = registedProviderUrl.getParameter(<span class="string">"register"</span>, <span class="keyword">true</span>);</span><br /><span class="line"><span class="number">18</span>: </span><br /><span class="line"><span class="number">19</span>:     <span class="comment">// å‘æœ¬åœ°æ³¨å†Œè¡¨ï¼Œæ³¨å†ŒæœåŠ¡æä¾›è€…</span></span><br /><span class="line"><span class="number">20</span>:     ProviderConsumerRegTable.registerProvider(originInvoker, registryUrl, registedProviderUrl);</span><br /><span class="line"><span class="number">21</span>: </span><br /><span class="line"><span class="number">22</span>:     <span class="comment">// å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡æä¾›è€…ï¼ˆè‡ªå·±ï¼‰</span></span><br /><span class="line"><span class="number">23</span>:     <span class="keyword">if</span> (register) {</span><br /><span class="line"><span class="number">24</span>:         register(registryUrl, registedProviderUrl);</span><br /><span class="line"><span class="number">25</span>:         ProviderConsumerRegTable.getProviderWrapper(originInvoker).setReg(<span class="keyword">true</span>); <span class="comment">// æ ‡è®°å‘æœ¬åœ°æ³¨å†Œè¡¨çš„æ³¨å†ŒæœåŠ¡æä¾›è€…ï¼Œå·²ç»æ³¨å†Œ</span></span><br /><span class="line"><span class="number">26</span>:     } </span><br /><span class="line"><span class="number">27</span>: </span><br /><span class="line"><span class="number">28</span>:     <span class="comment">// ä½¿ç”¨ OverrideListener å¯¹è±¡ï¼Œè®¢é˜…é…ç½®è§„åˆ™</span></span><br /><span class="line"><span class="number">29</span>:     <span class="comment">// Subscribe the override data</span></span><br /><span class="line"><span class="number">30</span>:     <span class="comment">// FIXME When the provider subscribes, it will affect the scene : a certain JVM exposes the service and call the same service. Because the subscribed is cached key with the name of the service, it causes the subscription information to cover.</span></span><br /><span class="line"><span class="number">31</span>:     <span class="keyword">final</span> URL overrideSubscribeUrl = getSubscribedOverrideUrl(registedProviderUrl);</span><br /><span class="line"><span class="number">32</span>:     <span class="keyword">final</span> OverrideListener overrideSubscribeListener = <span class="keyword">new</span> OverrideListener(overrideSubscribeUrl, originInvoker);</span><br /><span class="line"><span class="number">33</span>:     overrideListeners.put(overrideSubscribeUrl, overrideSubscribeListener);</span><br /><span class="line"><span class="number">34</span>:     registry.subscribe(overrideSubscribeUrl, overrideSubscribeListener);</span><br /><span class="line"><span class="number">35</span>:     <span class="comment">//Ensure that a new exporter instance is returned every time export</span></span><br /><span class="line"><span class="number">36</span>:     <span class="keyword">return</span> <span class="keyword">new</span> DestroyableExporter&lt;T&gt;(exporter, originInvoker, overrideSubscribeUrl, registedProviderUrl);</span><br /><span class="line"><span class="number">37</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 4 è¡Œï¼šè°ƒç”¨&nbsp;<code>#doLocalExport(invoker)</code>&nbsp;æ–¹æ³•ï¼Œæš´éœ²æœåŠ¡ã€‚</li>
<li>
<p>ç¬¬ 7 è¡Œï¼šè°ƒç”¨&nbsp;<code>#getRegistryUrl(originInvoker)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æ³¨å†Œä¸­å¿ƒ URL ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * è·å¾—æ³¨å†Œä¸­å¿ƒ URL</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> originInvoker åŸå§‹ Invoker</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> URL <span class="title">getRegistryUrl</span><span class="params">(Invoker&lt;?&gt; originInvoker)</span> </span>{</span><br /><span class="line">    URL registryUrl = originInvoker.getUrl();</span><br /><span class="line">    <span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(registryUrl.getProtocol())) { <span class="comment">// protocol</span></span><br /><span class="line">        String protocol = registryUrl.getParameter(Constants.REGISTRY_KEY, Constants.DEFAULT_DIRECTORY);</span><br /><span class="line">        registryUrl = registryUrl.setProtocol(protocol).removeParameter(Constants.REGISTRY_KEY);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> registryUrl;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è¯¥è¿‡ç¨‹æ˜¯æˆ‘ä»¬åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/service-export-remote-dubbo/">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡æš´éœ²ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°æš´éœ²ï¼ˆInjvmï¼‰ã€‹ã€Œ2.1 loadRegistriesã€</a>&nbsp;çš„é‚£å¼ å›¾çš„åå‘æµç¨‹ï¼Œå³<strong>çº¢çº¿éƒ¨åˆ†</strong>&nbsp;ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_03_10/01.png" alt="getRegistryUrl" /></li>
</ul>
</li>
<li>ç¬¬ 11 è¡Œï¼šè·å¾—æ³¨å†Œä¸­å¿ƒå¯¹è±¡ã€‚</li>
<li>
<p>ç¬¬ 14 è¡Œï¼šè°ƒç”¨&nbsp;<code>#getRegistedProviderUrl(originInvoker)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æœåŠ¡æä¾›è€… URL ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> URL <span class="title">getRegistedProviderUrl</span><span class="params">(<span class="keyword">final</span> Invoker&lt;?&gt; originInvoker)</span> </span>{</span><br /><span class="line">    <span class="comment">// ä»æ³¨å†Œä¸­å¿ƒçš„ export å‚æ•°ä¸­ï¼Œè·å¾—æœåŠ¡æä¾›è€…çš„ URL</span></span><br /><span class="line">    URL providerUrl = getProviderUrl(originInvoker);</span><br /><span class="line">    <span class="comment">//The address you see at the registry</span></span><br /><span class="line">    <span class="keyword">return</span> providerUrl.removeParameters(getFilteredKeys(providerUrl)) <span class="comment">// ç§»é™¤ .hide ä¸ºå‰ç¼€çš„å‚æ•°</span></span><br /><span class="line">            .removeParameter(Constants.MONITOR_KEY) <span class="comment">// monitor</span></span><br /><span class="line">            .removeParameter(Constants.BIND_IP_KEY) <span class="comment">// bind.ip</span></span><br /><span class="line">            .removeParameter(Constants.BIND_PORT_KEY) <span class="comment">// bind.port</span></span><br /><span class="line">            .removeParameter(QOS_ENABLE) <span class="comment">// qos.enable</span></span><br /><span class="line">            .removeParameter(QOS_PORT) <span class="comment">// qos.port</span></span><br /><span class="line">            .removeParameter(ACCEPT_FOREIGN_IP); <span class="comment">// qos.accept.foreign.ip</span></span><br /><span class="line">}</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> URL <span class="title">getProviderUrl</span><span class="params">(<span class="keyword">final</span> Invoker&lt;?&gt; origininvoker)</span> </span>{</span><br /><span class="line">    String export = origininvoker.getUrl().getParameterAndDecoded(Constants.EXPORT_KEY); <span class="comment">// export</span></span><br /><span class="line">    <span class="keyword">if</span> (export == <span class="keyword">null</span> || export.length() == <span class="number">0</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"The registry export url is null! registry: "</span> + origininvoker.getUrl());</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> URL.valueOf(export);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String[] getFilteredKeys(URL url) {</span><br /><span class="line">    Map&lt;String, String&gt; params = url.getParameters();</span><br /><span class="line">    <span class="keyword">if</span> (params != <span class="keyword">null</span> &amp;&amp; !params.isEmpty()) {</span><br /><span class="line">        List&lt;String&gt; filteredKeys = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br /><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : params.entrySet()) {</span><br /><span class="line">            <span class="keyword">if</span> (entry != <span class="keyword">null</span> &amp;&amp; entry.getKey() != <span class="keyword">null</span> &amp;&amp; entry.getKey().startsWith(Constants.HIDE_KEY_PREFIX)) {</span><br /><span class="line">                filteredKeys.add(entry.getKey());</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">return</span> filteredKeys.toArray(<span class="keyword">new</span> String[filteredKeys.size()]);</span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String[]{};</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><strong>é‡ç‚¹</strong>ï¼Œä»æ³¨å†Œä¸­å¿ƒçš„ URL ä¸­è·å¾—&nbsp;<code>export</code>&nbsp;å‚æ•°å¯¹åº”çš„å€¼ï¼Œå³æœåŠ¡æä¾›è€…çš„ URL ã€‚</li>
<li>ç§»é™¤<strong>å¤šä½™</strong>çš„å‚æ•°ã€‚å› ä¸ºï¼Œè¿™äº›å‚æ•°æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒæ²¡æœ‰å®é™…çš„ç”¨é€”ã€‚</li>
</ul>
</li>
<li>ç¬¬ 17 è¡Œï¼šé…ç½®é¡¹&nbsp;<code>register</code>&nbsp;ï¼ŒæœåŠ¡æä¾›è€…æ˜¯å¦æ³¨å†Œåˆ°é…ç½®ä¸­å¿ƒã€‚</li>
<li>ç¬¬ 20 è¡Œï¼šè°ƒç”¨&nbsp;<code>ProviderConsumerRegTable#registerProvider(invoker, registryUrl)</code>&nbsp;æ–¹æ³•ï¼Œå‘æœ¬åœ°æ³¨å†Œè¡¨ï¼Œæ³¨å†ŒæœåŠ¡æä¾›è€…ã€‚
<ul>
<li>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/registry-api/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹ã€Œ5. ProviderConsumerRegTableã€&nbsp;</a>ï¼Œæœ‰è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>
<p>ç¬¬ 24 è¡Œï¼šè°ƒç”¨&nbsp;<code>#register(registryUrl, registedProviderUrl)</code>&nbsp;æ–¹æ³•ï¼Œå‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡æä¾›è€…ï¼ˆè‡ªå·±ï¼‰ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(URL registryUrl, URL registedProviderUrl)</span> </span>{</span><br /><span class="line">    Registry registry = registryFactory.getRegistry(registryUrl);</span><br /><span class="line">    registry.register(registedProviderUrl);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è°ƒç”¨&nbsp;<code>RegistryService#register(url)</code>&nbsp;æ–¹æ³•ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/registry-api/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹ã€Œ3. RegistryServiceã€&nbsp;</a>ï¼Œæœ‰è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>
<p>ç¬¬ 25 è¡Œï¼šæ ‡è®°å‘æœ¬åœ°æ³¨å†Œè¡¨çš„æ³¨å†ŒæœåŠ¡æä¾›è€…ï¼Œå·²ç»æ³¨å†Œã€‚</p>
<ul>
<li>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/registry-api/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹ã€Œ5. ProviderConsumerRegTableã€&nbsp;</a>ï¼Œæœ‰è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>
<p>ç¬¬ 28 è‡³ 34 è¡Œï¼šä½¿ç”¨ OverrideListener å¯¹è±¡ï¼Œè®¢é˜…é…ç½®è§„åˆ™ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-6-impl-configurator?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆå…­ï¼‰ä¹‹ Configurator å®ç°ã€‹</a>&nbsp;ä¸­ã€‚</p>
</li>
<li>ç¬¬ 36 è¡Œï¼šåˆ›å»º DestroyableExporter å¯¹è±¡ã€‚</li>
</ul>
<h3 id="3-2-3-doLocalExport">3.2.3 doLocalExport</h3>
<p><code>#doLocalExport()</code>&nbsp;æ–¹æ³•ï¼Œæš´éœ²æœåŠ¡ã€‚<strong>æ­¤å¤„çš„ Local æŒ‡çš„æ˜¯ï¼Œæœ¬åœ°å¯åŠ¨æœåŠ¡ï¼Œä½†æ˜¯ä¸åŒ…æ‹¬å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡çš„æ„æ€</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * æš´éœ²æœåŠ¡ã€‚</span></span><br /><span class="line"><span class="comment"> 3:  *</span></span><br /><span class="line"><span class="comment"> 4:  * æ­¤å¤„çš„ Local æŒ‡çš„æ˜¯ï¼Œæœ¬åœ°å¯åŠ¨æœåŠ¡ï¼Œä½†æ˜¯ä¸åŒ…æ‹¬å‘æ³¨å†Œä¸­å¿ƒæ³¨å†ŒæœåŠ¡çš„æ„æ€ã€‚</span></span><br /><span class="line"><span class="comment"> 5:  *</span></span><br /><span class="line"><span class="comment"> 6:  * <span class="doctag">@param</span> originInvoker åŸå§‹ Invoker</span></span><br /><span class="line"><span class="comment"> 7:  * <span class="doctag">@param</span> &lt;T&gt; æ³›å‹</span></span><br /><span class="line"><span class="comment"> 8:  * <span class="doctag">@return</span> Exporter å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> 9:  */</span></span><br /><span class="line"><span class="number">10</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line"><span class="number">11</span>: <span class="keyword">private</span> &lt;T&gt; <span class="function">ExporterChangeableWrapper&lt;T&gt; <span class="title">doLocalExport</span><span class="params">(<span class="keyword">final</span> Invoker&lt;T&gt; originInvoker)</span> </span>{</span><br /><span class="line"><span class="number">12</span>:     <span class="comment">// è·å¾—åœ¨ `bounds` ä¸­çš„ç¼“å­˜ Key</span></span><br /><span class="line"><span class="number">13</span>:     String key = getCacheKey(originInvoker);</span><br /><span class="line"><span class="number">14</span>:     <span class="comment">// ä» `bounds` è·å¾—ï¼Œæ˜¯ä¸æ˜¯å·²ç»æš´éœ²è¿‡æœåŠ¡</span></span><br /><span class="line"><span class="number">15</span>:     ExporterChangeableWrapper&lt;T&gt; exporter = (ExporterChangeableWrapper&lt;T&gt;) bounds.get(key);</span><br /><span class="line"><span class="number">16</span>:     <span class="keyword">if</span> (exporter == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">17</span>:         <span class="keyword">synchronized</span> (bounds) {</span><br /><span class="line"><span class="number">18</span>:             exporter = (ExporterChangeableWrapper&lt;T&gt;) bounds.get(key);</span><br /><span class="line"><span class="number">19</span>:             <span class="comment">// æœªæš´éœ²è¿‡ï¼Œè¿›è¡Œæš´éœ²æœåŠ¡</span></span><br /><span class="line"><span class="number">20</span>:             <span class="keyword">if</span> (exporter == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">21</span>:                 <span class="comment">// åˆ›å»º Invoker Delegate å¯¹è±¡</span></span><br /><span class="line"><span class="number">22</span>:                 <span class="keyword">final</span> Invoker&lt;?&gt; invokerDelegete = <span class="keyword">new</span> InvokerDelegete&lt;T&gt;(originInvoker, getProviderUrl(originInvoker));</span><br /><span class="line"><span class="number">23</span>:                 <span class="comment">// æš´éœ²æœåŠ¡ï¼Œåˆ›å»º Exporter å¯¹è±¡</span></span><br /><span class="line"><span class="number">24</span>:                 <span class="comment">// ä½¿ç”¨ åˆ›å»ºçš„Exporterå¯¹è±¡ + originInvoker ï¼Œåˆ›å»º ExporterChangeableWrapper å¯¹è±¡</span></span><br /><span class="line"><span class="number">25</span>:                 exporter = <span class="keyword">new</span> ExporterChangeableWrapper&lt;T&gt;((Exporter&lt;T&gt;) protocol.export(invokerDelegete), originInvoker);</span><br /><span class="line"><span class="number">26</span>:                 <span class="comment">// æ·»åŠ åˆ° `bounds`</span></span><br /><span class="line"><span class="number">27</span>:                 bounds.put(key, exporter);</span><br /><span class="line"><span class="number">28</span>:             }</span><br /><span class="line"><span class="number">29</span>:         }</span><br /><span class="line"><span class="number">30</span>:     }</span><br /><span class="line"><span class="number">31</span>:     <span class="keyword">return</span> exporter;</span><br /><span class="line"><span class="number">32</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ç¬¬ 13 è¡Œï¼šè°ƒç”¨&nbsp;<code>#getCacheKey(originInvoker)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—åœ¨&nbsp;<code>bounds</code>&nbsp;ä¸­çš„ç¼“å­˜ Key ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Get the key cached in bounds by invoker</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * è· å–invoker åœ¨ boundsä¸­ ç¼“å­˜çš„key</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@param</span> originInvoker åŸå§‹ Invoker</span></span><br /><span class="line"><span class="comment"> * <span class="doctag">@return</span> url å­—ç¬¦ä¸²</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">getCacheKey</span><span class="params">(<span class="keyword">final</span> Invoker&lt;?&gt; originInvoker)</span> </span>{</span><br /><span class="line">    URL providerUrl = getProviderUrl(originInvoker);</span><br /><span class="line">    <span class="keyword">return</span> providerUrl.removeParameters(<span class="string">"dynamic"</span>, <span class="string">"enabled"</span>).toFullString();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 14 è‡³ 18 è¡Œï¼šä»&nbsp;<code>bounds</code>&nbsp;ä¸­ï¼Œè·å¾—å·²ç»æš´éœ²è¿‡çš„ ExporterChangeableWrapper å¯¹è±¡ã€‚</p>
</li>
<li>ç¬¬ 20 è‡³ 28 è¡Œï¼šæœªæš´éœ²è¿‡ï¼Œè¿›è¡Œæš´éœ²æœåŠ¡ã€‚
<ul>
<li>ç¬¬ 22 è¡Œï¼šè°ƒç”¨&nbsp;<code>#getProviderUrl(originInvoker)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—æœåŠ¡æä¾›è€…çš„ URL ã€‚</li>
<li>ç¬¬ 22 è¡Œï¼šåˆ›å»º&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/integration/RegistryProtocol.java#L320-L339" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.registry.integration.RegistryProtocol.InvokerDelegete</code></a>å¯¹è±¡ã€‚
<ul>
<li>InvokerDelegete å®ç°&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/protocol/InvokerWrapper.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.rpc.protocol.InvokerWrapper</code></a>&nbsp;ç±»ï¼Œä¸»è¦å¢åŠ äº†&nbsp;<code>#getInvoker()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—çœŸå®çš„ï¼Œé InvokerDelegete çš„ Invoker å¯¹è±¡ã€‚å› ä¸ºï¼Œå¯èƒ½ä¼šå­˜åœ¨&nbsp;<code>InvokerDelegete.invoker</code>&nbsp;ä¹Ÿæ˜¯ InvokerDelegete ç±»å‹çš„æƒ…å†µã€‚</li>
</ul>
</li>
<li>ç¬¬ 25 è¡Œï¼šè°ƒç”¨&nbsp;<code>DubboProtocol#export(invoker)</code>&nbsp;æ–¹æ³•ï¼Œæš´éœ²æœåŠ¡ï¼Œè¿”å› Exporter å¯¹è±¡ã€‚
<ul>
<li>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/service-export-remote-dubbo/">ã€Œ4.3 DubboProtocolã€</a>&nbsp;ä¸­ï¼Œè¯¦ç»†åˆ†äº«ã€‚</li>
<li>ğŸ™‚ è‹¥æ­¤è‹¥æ˜¯<strong>å…¶ä»–</strong>åè®®ï¼Œè‹¥è°ƒç”¨å¯¹åº”åè®®çš„&nbsp;<code>XXXProtocol#export(invoker)</code>&nbsp;æ–¹æ³•ã€‚</li>
</ul>
</li>
<li>ç¬¬ 25 è¡Œï¼šä½¿ç”¨ã€åˆ›å»ºçš„ Exporter å¯¹è±¡ã€‘+ã€<code>originInvoker</code>ã€‘ï¼Œåˆ›å»º ExporterChangeableWrapper å¯¹è±¡ã€‚è¿™æ ·ï¼Œ<code>originInvoker</code>&nbsp;å°±å’Œ Exporter å¯¹è±¡ï¼Œå½¢æˆäº†<strong>ç»‘å®š</strong>çš„å…³ç³»ã€‚
<ul>
<li>ğŸ™‚ ExporterChangeableWrapper åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/service-export-remote-dubbo/">ã€Œ4.1 ExporterChangeableWrapperã€</a>&nbsp;çœ‹è¯¦ç»†ä»£ç ã€‚</li>
</ul>
</li>
<li>ç¬¬ 27 è¡Œï¼šæ·»åŠ åˆ°&nbsp;<code>bounds</code>&nbsp;ã€‚</li>
</ul>
</li>
</ul>
<h2 id="3-3-DubboProtocol">3.3 DubboProtocol</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-default/src/main/java/com/alibaba/dubbo/rpc/protocol/dubbo/DubboProtocol.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.rpc.protocol.dubbo.DubboProtocol</code></a>&nbsp;ï¼Œå®ç° AbstractProtocol æŠ½è±¡ç±»ï¼ŒDubbo åè®®å®ç°ç±»ã€‚</p>
<h3 id="3-3-1-å±æ€§">3.3.1 å±æ€§</h3>
<p>å±æ€§ç›¸å…³ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å‹æƒ…æç¤ºï¼Œä»…åŒ…å«æœ¬æ–‡æ¶‰åŠçš„å±æ€§ã€‚</p>
</blockquote>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ... çœç•¥éƒ¨åˆ†å’Œæœ¬æ–‡æ— å…³çš„å±æ€§ã€‚</span></span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é€šä¿¡æœåŠ¡å™¨é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * key: æœåŠ¡å™¨åœ°å€ã€‚æ ¼å¼ä¸ºï¼šhost:port</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ExchangeServer&gt; serverMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ExchangeServer&gt;(); <span class="comment">// &lt;host:port,Exchanger&gt;</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>serverMap</code>&nbsp;å±æ€§ï¼Œé€šä¿¡æœåŠ¡å™¨é›†åˆã€‚å…¶ä¸­ï¼ŒKey ä¸º<strong>æœåŠ¡å™¨åœ°å€</strong>ï¼Œæ ¼å¼ä¸º&nbsp;<code>host:port</code>ã€‚</li>
</ul>
<h3 id="3-3-2-export">3.3.2 export</h3>
<p>æœ¬æ–‡æ¶‰åŠçš„&nbsp;<code>#export(invoker)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">public</span> &lt;T&gt; <span class="function">Exporter&lt;T&gt; <span class="title">export</span><span class="params">(Invoker&lt;T&gt; invoker)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">2</span>:     URL url = invoker.getUrl();</span><br /><span class="line"> <span class="number">3</span>: </span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// åˆ›å»º DubboExporter å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ° `exporterMap` ã€‚</span></span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// export service.</span></span><br /><span class="line"> <span class="number">6</span>:     String key = serviceKey(url);</span><br /><span class="line"> <span class="number">7</span>:     DubboExporter&lt;T&gt; exporter = <span class="keyword">new</span> DubboExporter&lt;T&gt;(invoker, key, exporterMap);</span><br /><span class="line"> <span class="number">8</span>:     exporterMap.put(key, exporter);</span><br /><span class="line"> <span class="number">9</span>: </span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// TODO ã€8033 å‚æ•°å›è°ƒã€‘</span></span><br /><span class="line"><span class="number">11</span>:     <span class="comment">//export an stub service for dispatching event</span></span><br /><span class="line"><span class="number">12</span>:     Boolean isStubSupportEvent = url.getParameter(Constants.STUB_EVENT_KEY, Constants.DEFAULT_STUB_EVENT);</span><br /><span class="line"><span class="number">13</span>:     Boolean isCallbackservice = url.getParameter(Constants.IS_CALLBACK_SERVICE, <span class="keyword">false</span>);</span><br /><span class="line"><span class="number">14</span>:     <span class="keyword">if</span> (isStubSupportEvent &amp;&amp; !isCallbackservice) {</span><br /><span class="line"><span class="number">15</span>:         String stubServiceMethods = url.getParameter(Constants.STUB_EVENT_METHODS_KEY);</span><br /><span class="line"><span class="number">16</span>:         <span class="keyword">if</span> (stubServiceMethods == <span class="keyword">null</span> || stubServiceMethods.length() == <span class="number">0</span>) {</span><br /><span class="line"><span class="number">17</span>:             <span class="keyword">if</span> (logger.isWarnEnabled()) {</span><br /><span class="line"><span class="number">18</span>:                 logger.warn(<span class="keyword">new</span> IllegalStateException(<span class="string">"consumer ["</span> + url.getParameter(Constants.INTERFACE_KEY) +</span><br /><span class="line"><span class="number">19</span>:                         <span class="string">"], has set stubproxy support event ,but no stub methods founded."</span>));</span><br /><span class="line"><span class="number">20</span>:             }</span><br /><span class="line"><span class="number">21</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">22</span>:             stubServiceMethodsMap.put(url.getServiceKey(), stubServiceMethods);</span><br /><span class="line"><span class="number">23</span>:         }</span><br /><span class="line"><span class="number">24</span>:     }</span><br /><span class="line"><span class="number">25</span>: </span><br /><span class="line"><span class="number">26</span>:     <span class="comment">// å¯åŠ¨æœåŠ¡å™¨</span></span><br /><span class="line"><span class="number">27</span>:     openServer(url);</span><br /><span class="line"><span class="number">28</span>: </span><br /><span class="line"><span class="number">29</span>:     <span class="comment">// åˆå§‹åŒ–åºåˆ—åŒ–ä¼˜åŒ–å™¨</span></span><br /><span class="line"><span class="number">30</span>:     optimizeSerialization(url);</span><br /><span class="line"><span class="number">31</span>:     <span class="keyword">return</span> exporter;</span><br /><span class="line"><span class="number">32</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 6 è¡Œï¼šè°ƒç”¨&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/protocol/AbstractProtocol.java#L45-L47" target="_blank" rel="external nofollow noopener noreferrer"><code>#serviceKey(url)</code></a>&nbsp;æ–¹æ³•ï¼Œè·å¾—æœåŠ¡é”®ã€‚è¯¥æ–¹æ³•ä»çˆ¶ç±»ç»§æ‰¿è€Œæ¥ã€‚</li>
<li>ç¬¬ 7 è¡Œï¼šåˆ›å»º DubboExporter å¯¹è±¡ã€‚
<ul>
<li>ğŸ™‚ åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/service-export-remote-dubbo/">ã€Œ4.3 DubboExporterã€</a>&nbsp;è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>ç¬¬ 8 è¡Œï¼šæ·»åŠ åˆ°&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/protocol/AbstractProtocol.java#L40" target="_blank" rel="external nofollow noopener noreferrer"><code>exporterMap</code></a>&nbsp;ä¸­ã€‚è¯¥å±æ€§ä»çˆ¶ç±»ç»§æ‰¿è€Œæ¥ã€‚</li>
<li>ç¬¬ 10 è‡³ 24 è¡Œï¼šTODO ã€8033 å‚æ•°å›è°ƒã€‘</li>
<li>ç¬¬ 27 è¡Œï¼šè°ƒç”¨&nbsp;<code>#openServer(url)</code>&nbsp;æ–¹æ³•ï¼Œå¯åŠ¨æœåŠ¡å™¨ã€‚</li>
<li>ç¬¬ 30 è¡Œï¼šè°ƒç”¨&nbsp;<code>#optimizeSerialization(url)</code>&nbsp;æ–¹æ³•ï¼Œåˆå§‹åŒ–åºåˆ—åŒ–ä¼˜åŒ–å™¨ã€‚åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/serialize-1-all?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; åºåˆ—åŒ–ï¼ˆä¸€ï¼‰ä¹‹æ€»ä½“å®ç°ã€‹</a>&nbsp;ä¸­ï¼Œè¯¦ç»†è§£æã€‚</li>
</ul>
<h3 id="3-3-3-openServer">3.3.3 openServer</h3>
<blockquote>
<p>å‹æƒ…æç¤ºï¼šæœ¬å°èŠ‚çš„å†…å®¹ï¼Œèƒ–å‹å…ˆçœ‹è¿‡&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-api-interface/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ã€‹</a>&nbsp;æ‰€æœ‰çš„æ–‡ç« ã€‚</p>
</blockquote>
<p><code>#openServer(url)</code>&nbsp;æ–¹æ³•ï¼Œå¯åŠ¨é€šä¿¡æœåŠ¡å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é€šä¿¡å®¢æˆ·ç«¯é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * key: æœåŠ¡å™¨åœ°å€ã€‚æ ¼å¼ä¸ºï¼šhost:port</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ReferenceCountExchangeClient&gt; referenceClientMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ReferenceCountExchangeClient&gt;(); <span class="comment">// &lt;host:port,Exchanger&gt;</span></span><br /><br /><span class="line">  <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">  2:  * å¯åŠ¨æœåŠ¡å™¨</span></span><br /><span class="line"><span class="comment">  3:  *</span></span><br /><span class="line"><span class="comment">  4:  * <span class="doctag">@param</span> url URL</span></span><br /><span class="line"><span class="comment">  5:  */</span></span><br /><span class="line">  <span class="number">6</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">openServer</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">  <span class="number">7</span>:     <span class="comment">// find server.</span></span><br /><span class="line">  <span class="number">8</span>:     String key = url.getAddress();</span><br /><span class="line">  <span class="number">9</span>:     <span class="comment">//client can export a service which's only for server to invoke</span></span><br /><span class="line"> <span class="number">10</span>:     <span class="keyword">boolean</span> isServer = url.getParameter(Constants.IS_SERVER_KEY, <span class="keyword">true</span>); <span class="comment">// isserver</span></span><br /><span class="line"> <span class="number">11</span>:     <span class="keyword">if</span> (isServer) {</span><br /><span class="line"> <span class="number">12</span>:         ExchangeServer server = serverMap.get(key);</span><br /><span class="line"> <span class="number">13</span>:         <span class="keyword">if</span> (server == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">14</span>:             serverMap.put(key, createServer(url));</span><br /><span class="line"> <span class="number">15</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">16</span>:             <span class="comment">// server supports reset, use together with override</span></span><br /><span class="line"> <span class="number">17</span>:             server.reset(url);</span><br /><span class="line"> <span class="number">18</span>:         }</span><br /><span class="line"> <span class="number">19</span>:     }</span><br /><span class="line"> <span class="number">20</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 8 è¡Œï¼šè·å¾—æœåŠ¡å™¨åœ°å€ã€‚</li>
<li>ç¬¬ 10 è¡Œï¼šé…ç½®é¡¹&nbsp;<code>isserver</code>&nbsp;ï¼Œå¯ä»¥æš´éœ²ä¸€ä¸ªä»…å½“å‰ JVM å¯è°ƒç”¨çš„æœåŠ¡ã€‚ç›®å‰è¯¥é…ç½®é¡¹å·²ç»ä¸å­˜åœ¨ã€‚</li>
<li>ç¬¬ 12 è¡Œï¼šä»&nbsp;<code>serverMap</code>&nbsp;è·å¾—å¯¹åº”æœåŠ¡å™¨åœ°å€å·²å­˜åœ¨çš„é€šä¿¡æœåŠ¡å™¨ã€‚å³ï¼Œ<strong>ä¸é‡å¤åˆ›å»º</strong>ã€‚</li>
<li>ç¬¬ 13 è‡³ 14 è¡Œï¼šé€šä¿¡æœåŠ¡å™¨ä¸å­˜åœ¨ï¼Œè°ƒç”¨&nbsp;<code>#createServer(url)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºæœåŠ¡å™¨ã€‚</li>
<li>ç¬¬ 15 è‡³ 18 è¡Œï¼šé€šä¿¡æœåŠ¡å™¨å·²å­˜åœ¨ï¼Œè°ƒç”¨&nbsp;<code>Server#reset(url)</code>&nbsp;æ–¹æ³•ï¼Œé‡ç½®æœåŠ¡å™¨çš„å±æ€§ã€‚
<ul>
<li>ä¸ºä»€ä¹ˆ<strong>ä¼šå­˜åœ¨</strong>å‘¢ï¼Ÿå› ä¸ºé”®æ˜¯&nbsp;<code>host:port</code>&nbsp;ï¼Œé‚£ä¹ˆä¾‹å¦‚ï¼Œå¤šä¸ª Service å…±ç”¨åŒä¸€ä¸ª Protocol ï¼ŒæœåŠ¡å™¨æ˜¯åŒä¸€ä¸ªå¯¹è±¡ã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-3-4-createServer">3.3.4 createServer</h3>
<p><code>#createServer(url)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºå¹¶å¯åŠ¨é€šä¿¡æœåŠ¡å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> ExchangeServer <span class="title">createServer</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// é»˜è®¤å¼€å¯ server å…³é—­æ—¶å‘é€ READ_ONLY äº‹ä»¶</span></span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// send readonly event when server closes, it's enabled by default</span></span><br /><span class="line"> <span class="number">4</span>:     url = url.addParameterIfAbsent(Constants.CHANNEL_READONLYEVENT_SENT_KEY, Boolean.TRUE.toString());</span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// é»˜è®¤å¼€å¯ heartbeat</span></span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// enable heartbeat by default</span></span><br /><span class="line"> <span class="number">7</span>:     url = url.addParameterIfAbsent(Constants.HEARTBEAT_KEY, String.valueOf(Constants.DEFAULT_HEARTBEAT));</span><br /><span class="line"> <span class="number">8</span>: </span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// æ ¡éªŒ Server çš„ Dubbo SPI æ‹“å±•æ˜¯å¦å­˜åœ¨</span></span><br /><span class="line"><span class="number">10</span>:     String str = url.getParameter(Constants.SERVER_KEY, Constants.DEFAULT_REMOTING_SERVER);</span><br /><span class="line"><span class="number">11</span>:     <span class="keyword">if</span> (str != <span class="keyword">null</span> &amp;&amp; str.length() &gt; <span class="number">0</span> &amp;&amp; !ExtensionLoader.getExtensionLoader(Transporter.class).hasExtension(str)) {</span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Unsupported server type: "</span> + str + <span class="string">", url: "</span> + url);</span><br /><span class="line"><span class="number">13</span>:     }</span><br /><span class="line"><span class="number">14</span>: </span><br /><span class="line"><span class="number">15</span>:     <span class="comment">// è®¾ç½®ç¼–è§£ç å™¨ä¸º `"Dubbo"` </span></span><br /><span class="line"><span class="number">16</span>:     url = url.addParameter(Constants.CODEC_KEY, DubboCodec.NAME);</span><br /><span class="line"><span class="number">17</span>: </span><br /><span class="line"><span class="number">18</span>:     <span class="comment">// å¯åŠ¨æœåŠ¡å™¨</span></span><br /><span class="line"><span class="number">19</span>:     ExchangeServer server;</span><br /><span class="line"><span class="number">20</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">21</span>:         server = Exchangers.bind(url, requestHandler);</span><br /><span class="line"><span class="number">22</span>:     } <span class="keyword">catch</span> (RemotingException e) {</span><br /><span class="line"><span class="number">23</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Fail to start server(url: "</span> + url + <span class="string">") "</span> + e.getMessage(), e);</span><br /><span class="line"><span class="number">24</span>:     }</span><br /><span class="line"><span class="number">25</span>: </span><br /><span class="line"><span class="number">26</span>:     <span class="comment">// æ ¡éªŒ Client çš„ Dubbo SPI æ‹“å±•æ˜¯å¦å­˜åœ¨</span></span><br /><span class="line"><span class="number">27</span>:     str = url.getParameter(Constants.CLIENT_KEY);</span><br /><span class="line"><span class="number">28</span>:     <span class="keyword">if</span> (str != <span class="keyword">null</span> &amp;&amp; str.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">29</span>:         Set&lt;String&gt; supportedTypes = ExtensionLoader.getExtensionLoader(Transporter.class).getSupportedExtensions();</span><br /><span class="line"><span class="number">30</span>:         <span class="keyword">if</span> (!supportedTypes.contains(str)) {</span><br /><span class="line"><span class="number">31</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Unsupported client type: "</span> + str);</span><br /><span class="line"><span class="number">32</span>:         }</span><br /><span class="line"><span class="number">33</span>:     }</span><br /><span class="line"><span class="number">34</span>:     <span class="keyword">return</span> server;</span><br /><span class="line"><span class="number">35</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 4 è¡Œï¼šé»˜è®¤å¼€å¯ Server å…³é—­æ—¶ï¼Œå‘é€&nbsp;<strong>READ_ONLY</strong>&nbsp;äº‹ä»¶ã€‚</li>
<li>ç¬¬ 7 è¡Œï¼šé»˜è®¤å¼€å¯<strong>å¿ƒè·³</strong>åŠŸèƒ½ã€‚</li>
<li>ç¬¬ 9 è‡³ 13 è¡Œï¼šæ ¡éªŒé…ç½®çš„ Server çš„ Dubbo SPI æ‹“å±•æ˜¯å¦å­˜åœ¨ã€‚è‹¥ä¸å­˜åœ¨ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚</li>
<li>ç¬¬ 16 è¡Œï¼šè®¾ç½®ç¼–è§£ç å™¨ä¸º&nbsp;<code>"Dubbo"</code>&nbsp;åè®®ï¼Œå³ DubboCountCodec ã€‚</li>
<li>
<p>ç¬¬ 18 è‡³ 24 è¡Œï¼šè°ƒç”¨&nbsp;<code>Exchangers#bind(url, handler)</code>&nbsp;æ–¹æ³•ï¼Œå¯åŠ¨æœåŠ¡å™¨ã€‚å…·ä½“&nbsp;<code>requestHanlder</code>&nbsp;å±æ€§å€¼çš„å®ç°ï¼Œæˆ‘ä»¬æ”¾åœ¨ Dubbo åè®®ä¸‹çš„ RPC çš„æ–‡ç« é‡Œåˆ†äº«ã€‚<code>requestHanlder</code>&nbsp;å±æ€§çš„ç®€åŒ–ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> ExchangeHandler requestHandler = <span class="keyword">new</span> ExchangeHandlerAdapter() {</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">reply</span><span class="params">(ExchangeChannel channel, Object message)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">        <span class="comment">// .... çœç•¥å…·ä½“å®ç°ä»£ç </span></span><br /><span class="line">        <span class="keyword">return</span> invoker.invoke(inv);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 26 è‡³ 33 è¡Œï¼šæ ¡éªŒé…ç½®çš„ Client çš„ Dubbo SPI æ‹“å±•æ˜¯å¦å­˜åœ¨ã€‚è‹¥ä¸å­˜åœ¨ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæœªé…ç½®ï¼Œæ‰€ä»¥ä¸ä¼šæ ¡éªŒã€‚</p>
</li>
<li>ç¬¬ 34 è¡Œï¼šè¿”å›é€šä¿¡æœåŠ¡å™¨ã€‚</li>
</ul>
<h1 id="4-Exporter">4. Exporter</h1>
<p>æœ¬æ–‡æ¶‰åŠçš„ Exporter ç±»å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_03_10/03.png" alt="Exporter ç±»å›¾" /></p>
<h2 id="4-1-ExporterChangeableWrapper">4.1 ExporterChangeableWrapper</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/integration/RegistryProtocol.java#L422-L454" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.registry.integration.RegistryProtocol.ExporterChangeableWrapper</code></a>&nbsp;ï¼Œå®ç° Exporter æ¥å£ï¼ŒExporter å¯å˜çš„åŒ…è£…å™¨ã€‚</p>
<ul>
<li>å»ºç«‹ã€è¿”å›çš„ Exporterã€‘ä¸ã€Protocol export å‡ºçš„ Exporterã€‘çš„å¯¹åº”å…³ç³»ã€‚</li>
<li>åœ¨ override æ—¶å¯ä»¥è¿›è¡Œå…³ç³»ä¿®æ”¹ã€‚</li>
</ul>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ExporterChangeableWrapper</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Exporter</span>&lt;<span class="title">T</span>&gt; </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * åŸ Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Invoker&lt;T&gt; originInvoker;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æš´éœ²çš„ Exporter å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> Exporter&lt;T&gt; exporter;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExporterChangeableWrapper</span><span class="params">(Exporter&lt;T&gt; exporter, Invoker&lt;T&gt; originInvoker)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.exporter = exporter;</span><br /><span class="line">        <span class="keyword">this</span>.originInvoker = originInvoker;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> Invoker&lt;T&gt; <span class="title">getOriginInvoker</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> originInvoker;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> Invoker&lt;T&gt; <span class="title">getInvoker</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> exporter.getInvoker();</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExporter</span><span class="params">(Exporter&lt;T&gt; exporter)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.exporter = exporter;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unexport</span><span class="params">()</span> </span>{</span><br /><span class="line">        String key = getCacheKey(<span class="keyword">this</span>.originInvoker);</span><br /><span class="line">        <span class="comment">// ç§»é™¤å‡º `bounds`</span></span><br /><span class="line">        bounds.remove(key);</span><br /><span class="line">        <span class="comment">// å–æ¶ˆæš´éœ²</span></span><br /><span class="line">        exporter.unexport();</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="4-2-DestroyableExporter">4.2 DestroyableExporter</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-registry/dubbo-registry-api/src/main/java/com/alibaba/dubbo/registry/integration/RegistryProtocol.java#L456-L506" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.registry.integration.RegistryProtocol.DestroyableExporter</code></a>&nbsp;ï¼Œå®ç° Exporter æ¥å£ï¼Œ<strong>å¯é”€æ¯</strong>çš„ Exporter å®ç°ç±»ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ExporterChangeableWrapper</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Exporter</span>&lt;<span class="title">T</span>&gt; </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * åŸ Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Invoker&lt;T&gt; originInvoker;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æš´éœ²çš„ Exporter å¯¹è±¡</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> Exporter&lt;T&gt; exporter;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExporterChangeableWrapper</span><span class="params">(Exporter&lt;T&gt; exporter, Invoker&lt;T&gt; originInvoker)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.exporter = exporter;</span><br /><span class="line">        <span class="keyword">this</span>.originInvoker = originInvoker;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> Invoker&lt;T&gt; <span class="title">getOriginInvoker</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> originInvoker;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Invoker&lt;T&gt; <span class="title">getInvoker</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> exporter.getInvoker();</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="comment">// å¯ä»¥é‡æ–°è®¾ç½® Exporter å¯¹è±¡</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExporter</span><span class="params">(Exporter&lt;T&gt; exporter)</span> </span>{</span><br /><span class="line">        <span class="keyword">this</span>.exporter = exporter;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unexport</span><span class="params">()</span> </span>{</span><br /><span class="line">        String key = getCacheKey(<span class="keyword">this</span>.originInvoker);</span><br /><span class="line">        <span class="comment">// ç§»é™¤å‡º `bounds`</span></span><br /><span class="line">        bounds.remove(key);</span><br /><span class="line">        <span class="comment">// å–æ¶ˆæš´éœ²</span></span><br /><span class="line">        exporter.unexport();</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>Exporter&nbsp;<strong>ä»£ç†</strong>ï¼Œå»ºç«‹<strong>åŸå§‹çš„</strong>&nbsp;Invoker ä¸&nbsp;<code>Protocol#export(Invoker&lt;T&gt; invoker)</code>&nbsp;æ–¹æ³•è¿”å›çš„ Exporter çš„<strong>å¯¹åº”å…³ç³»</strong>ã€‚</li>
<li>åœ¨é…ç½®è§„åˆ™å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå¯è°ƒç”¨&nbsp;<code>#setExporter(Exporter&lt;T&gt;)</code>&nbsp;æ–¹æ³•ï¼Œä¿®æ”¹<strong>å¯¹åº”å…³ç³»</strong>ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-6-impl-configurator/?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆå…­ï¼‰ä¹‹ Configurator å®ç°ã€‹</a>&nbsp;ã€‚</li>
</ul>
<h2 id="4-3-DubboExporter">4.3 DubboExporter</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-default/src/main/java/com/alibaba/dubbo/rpc/protocol/dubbo/DubboExporter.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.rpc.protocol.dubbo.DubboExporter</code></a>&nbsp;ï¼Œå®ç° AbstractExporter æŠ½è±¡ç±»ï¼ŒDubbo Exporter å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboExporter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractExporter</span>&lt;<span class="title">T</span>&gt; </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æœåŠ¡é”®</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String key;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Exporter é›†åˆ</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * key: æœåŠ¡é”®</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * è¯¥å€¼å®é™…å°±æ˜¯ {<span class="doctag">@link</span> com.alibaba.dubbo.rpc.protocol.AbstractProtocol#exporterMap}</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Exporter&lt;?&gt;&gt; exporterMap;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DubboExporter</span><span class="params">(Invoker&lt;T&gt; invoker, String key, Map&lt;String, Exporter&lt;?&gt;&gt; exporterMap)</span> </span>{</span><br /><span class="line">        <span class="keyword">super</span>(invoker);</span><br /><span class="line">        <span class="keyword">this</span>.key = key;</span><br /><span class="line">        <span class="keyword">this</span>.exporterMap = exporterMap;</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unexport</span><span class="params">()</span> </span>{</span><br /><span class="line">        <span class="comment">// å–æ¶ˆæš´éœ²</span></span><br /><span class="line">        <span class="keyword">super</span>.unexport();</span><br /><span class="line">        <span class="comment">// ç§»é™¤</span></span><br /><span class="line">        exporterMap.remove(key);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>key</code>&nbsp;å±æ€§ï¼ŒæœåŠ¡é”®ã€‚</li>
<li><code>#exporterMap</code>&nbsp;å±æ€§ï¼ŒExporter é›†åˆã€‚åœ¨ä¸Šæ–‡&nbsp;<code>DubboProtocol#export(invoker)</code>&nbsp;æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œè¯¥å±æ€§å°±æ˜¯&nbsp;<code>AbstractProtocol.exporterMap</code>&nbsp;å±æ€§ã€‚
<ul>
<li><strong>æ„é€ æ–¹æ³•</strong>ï¼Œ<strong>å‘èµ·</strong>æš´éœ²ï¼Œå°†è‡ªå·±æ·»åŠ åˆ°&nbsp;<code>exporterMap</code>&nbsp;ä¸­ã€‚</li>
<li><code>#unexport()</code>&nbsp;æ–¹æ³•ï¼Œ<strong>å–æ¶ˆ</strong>æš´éœ²ï¼Œå°†è‡ªå·±ç§»é™¤å‡º&nbsp;<code>exporterMap</code>&nbsp;ä¸­ã€‚</li>
</ul>
</li>
</ul>
</div>