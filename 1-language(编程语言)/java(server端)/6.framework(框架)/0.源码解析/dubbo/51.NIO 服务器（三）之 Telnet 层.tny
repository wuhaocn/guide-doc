<header class="article-header">
<h1 class="article-title">NIO æœåŠ¡å™¨ï¼ˆä¸‰ï¼‰ä¹‹ Telnet å±‚</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>æœ¬æ–‡æ¥&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-api-transport//?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ï¼ˆäºŒï¼‰ä¹‹æŠ½è±¡ APIã€‹</a>&nbsp;ä¸€æ–‡ï¼Œåˆ†äº«&nbsp;<code>dubbo-remoting-api</code>æ¨¡å—ï¼Œ&nbsp;<code>telnet</code>&nbsp;åŒ…ï¼Œ<strong>Telnet å‘½ä»¤</strong>ã€‚</p>
<p>åœ¨&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/telnet.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; Telnet å‘½ä»¤å‚è€ƒæ‰‹å†Œã€‹</a>&nbsp;ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒDubbo æ”¯æŒé€šè¿‡ telnet å‘½ä»¤ï¼Œç”¨æ¥æœåŠ¡æ²»ç†ã€‚å…¶ä¸­ï¼Œ<code>clear</code>&nbsp;<code>exit</code>&nbsp;<code>help</code>&nbsp;<code>log</code>&nbsp;<code>status</code>&nbsp;<strong>é€šç”¨æŒ‡ä»¤</strong>ï¼Œé€šè¿‡&nbsp;<code>telnet</code>&nbsp;åŒ…å®ç°ã€‚è€Œå…¶å®ƒå‡ ä¸ªæŒ‡ä»¤ï¼Œéœ€è¦ä¸åŒåè®®( Protocol )è‡ªå·±å®ç°ã€‚ç›®å‰ï¼Œ<strong>ä»…æœ‰</strong>&nbsp;Dubbo Protocol å®ç°äº†è‡ªå®šä¹‰æŒ‡ä»¤ã€‚</p>
<p>æœ¬æ–‡æ¶‰åŠ<strong>ç±»å›¾</strong>å¦‚ä¸‹ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_12_07/01.png" alt="ç±»å›¾" /></p>
<p>ä»<strong>ç”¨é€”</strong>ä¸Šï¼Œä¸Šè¿°ç±»å¯ä»¥åˆ†æˆä¸‰ç§ï¼š</p>
<ul>
<li>TelnetCodec ï¼šè´Ÿè´£ç¼–è§£ç  Telnet å‘½ä»¤ä¸ç»“æœã€‚</li>
<li>TelnetHandlerAdapter ï¼šè´Ÿè´£æ¥æ”¶æ¥è‡ª HeaderExchangeHandler çš„ telnet å‘½ä»¤ï¼Œåˆ†å‘ç»™å¯¹åº”çš„ TelnetHandler å®ç°ç±»ï¼Œè¿›è¡Œå¤„ç†ï¼Œ<strong>è¿”å›å‘½ä»¤ç»“æœ</strong>ã€‚
<ul>
<li>ğŸ™‚ ä¸ºä»€ä¹ˆæ¥è‡ª HeaderExchangeHandler ï¼Œæˆ‘ä»¬åç»­æ–‡ç« åˆ†äº«ã€‚</li>
</ul>
</li>
<li>XXXTelnetHandler ï¼šå¤„ç†å¯¹åº”çš„ telnet å‘½ä»¤ï¼Œè¿”å›ç»“æœã€‚</li>
</ul>
<p><strong>æµç¨‹</strong>å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_12_07/02.png" alt="æµç¨‹" /></p>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“çš„ä»£ç å®ç°ã€‚</p>
<h1 id="2-TelnetCodec">2. TelnetCodec</h1>
<blockquote>
<p>è‰¿è‰¿å¯¹ telnet server ä¸ç†Ÿæ‚‰ï¼Œå¦‚æœæœ‰é”™è¯¯ï¼Œè¿˜è¯·åŒ…æ¶µã€‚ğŸ™‚ æœ¬æ–‡ä¸»è¦èµ·åˆ°æŠ›ç –çš„ä½œç”¨ã€‚</p>
</blockquote>
<p><a href="http://svip.iocoder.cn/Dubbo/remoting-api-telnet/TODO"><code>com.alibaba.dubbo.remoting.telnet.codec.TelnetCodec</code></a>&nbsp;ï¼Œå®ç° TransportCodec ç±»ï¼ŒTelnet å‘½ä»¤ç¼–è§£ç å™¨ã€‚</p>
<p><strong>è§£ç </strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">  <span class="number">1</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br /><span class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> Object <span class="title">decode</span><span class="params">(Channel channel, ChannelBuffer buffer, <span class="keyword">int</span> readable, <span class="keyword">byte</span>[] message)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line">  <span class="number">3</span>:     <span class="comment">// ã€TODO 8025ã€‘ä¸ºå•¥ client ä¾§ï¼Œç›´æ¥è¿”å›</span></span><br /><span class="line">  <span class="number">4</span>:     <span class="keyword">if</span> (isClientSide(channel)) {</span><br /><span class="line">  <span class="number">5</span>:         <span class="keyword">return</span> toString(message, getCharset(channel));</span><br /><span class="line">  <span class="number">6</span>:     }</span><br /><span class="line">  <span class="number">7</span>:     <span class="comment">// æ£€æŸ¥é•¿åº¦</span></span><br /><span class="line">  <span class="number">8</span>:     checkPayload(channel, readable);</span><br /><span class="line">  <span class="number">9</span>:     <span class="keyword">if</span> (message == <span class="keyword">null</span> || message.length == <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">10</span>:         <span class="keyword">return</span> DecodeResult.NEED_MORE_INPUT;</span><br /><span class="line"> <span class="number">11</span>:     }</span><br /><span class="line"> <span class="number">12</span>: </span><br /><span class="line"> <span class="number">13</span>:     <span class="comment">// å¤„ç†é€€æ ¼çš„æƒ…å†µã€‚</span></span><br /><span class="line"> <span class="number">14</span>:     <span class="keyword">if</span> (message[message.length - <span class="number">1</span>] == <span class="string">'\b'</span>) { <span class="comment">// Windows backspace echo</span></span><br /><span class="line"> <span class="number">15</span>:         <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">16</span>:             <span class="comment">// 32=ç©ºæ ¼ 8=é€€æ ¼</span></span><br /><span class="line"> <span class="number">17</span>:             <span class="keyword">boolean</span> doublechar = message.length &gt;= <span class="number">3</span> &amp;&amp; message[message.length - <span class="number">3</span>] &lt; <span class="number">0</span>; <span class="comment">// double byte char</span></span><br /><span class="line"> <span class="number">18</span>:             channel.send(<span class="keyword">new</span> String(doublechar ? <span class="keyword">new</span> <span class="keyword">byte</span>[]{<span class="number">32</span>, <span class="number">32</span>, <span class="number">8</span>, <span class="number">8</span>} : <span class="keyword">new</span> <span class="keyword">byte</span>[]{<span class="number">32</span>, <span class="number">8</span>}, getCharset(channel).name()));</span><br /><span class="line"> <span class="number">19</span>:         } <span class="keyword">catch</span> (RemotingException e) {</span><br /><span class="line"> <span class="number">20</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> IOException(StringUtils.toString(e));</span><br /><span class="line"> <span class="number">21</span>:         }</span><br /><span class="line"> <span class="number">22</span>:         <span class="keyword">return</span> DecodeResult.NEED_MORE_INPUT;</span><br /><span class="line"> <span class="number">23</span>:     }</span><br /><span class="line"> <span class="number">24</span>: </span><br /><span class="line"> <span class="number">25</span>:     <span class="comment">// å…³é—­æŒ‡ä»¤</span></span><br /><span class="line"> <span class="number">26</span>:     <span class="keyword">for</span> (Object command : EXIT) {</span><br /><span class="line"> <span class="number">27</span>:         <span class="keyword">if</span> (isEquals(message, (<span class="keyword">byte</span>[]) command)) {</span><br /><span class="line"> <span class="number">28</span>:             <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"> <span class="number">29</span>:                 logger.info(<span class="keyword">new</span> Exception(<span class="string">"Close channel "</span> + channel + <span class="string">" on exit command: "</span> + Arrays.toString((<span class="keyword">byte</span>[]) command)));</span><br /><span class="line"> <span class="number">30</span>:             }</span><br /><span class="line"> <span class="number">31</span>:             channel.close(); <span class="comment">// å…³é—­é€šé“</span></span><br /><span class="line"> <span class="number">32</span>:             <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line"> <span class="number">33</span>:         }</span><br /><span class="line"> <span class="number">34</span>:     }</span><br /><span class="line"> <span class="number">35</span>: </span><br /><span class="line"> <span class="number">36</span>:     <span class="comment">// ä½¿ç”¨å†å²çš„å‘½ä»¤</span></span><br /><span class="line"> <span class="number">37</span>:     <span class="keyword">boolean</span> up = endsWith(message, UP);</span><br /><span class="line"> <span class="number">38</span>:     <span class="keyword">boolean</span> down = endsWith(message, DOWN);</span><br /><span class="line"> <span class="number">39</span>:     <span class="keyword">if</span> (up || down) {</span><br /><span class="line"> <span class="number">40</span>:         LinkedList&lt;String&gt; history = (LinkedList&lt;String&gt;) channel.getAttribute(HISTORY_LIST_KEY);</span><br /><span class="line"> <span class="number">41</span>:         <span class="keyword">if</span> (history == <span class="keyword">null</span> || history.isEmpty()) {</span><br /><span class="line"> <span class="number">42</span>:             <span class="keyword">return</span> DecodeResult.NEED_MORE_INPUT;</span><br /><span class="line"> <span class="number">43</span>:         }</span><br /><span class="line"> <span class="number">44</span>:         <span class="comment">// è·å¾—å†å²å‘½ä»¤æ•°ç»„çš„ä½ç½®</span></span><br /><span class="line"> <span class="number">45</span>:         Integer index = (Integer) channel.getAttribute(HISTORY_INDEX_KEY);</span><br /><span class="line"> <span class="number">46</span>:         Integer old = index;</span><br /><span class="line"> <span class="number">47</span>:         <span class="keyword">if</span> (index == <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">48</span>:             index = history.size() - <span class="number">1</span>;</span><br /><span class="line"> <span class="number">49</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">50</span>:             <span class="keyword">if</span> (up) { <span class="comment">// å‘ä¸Š</span></span><br /><span class="line"> <span class="number">51</span>:                 index = index - <span class="number">1</span>;</span><br /><span class="line"> <span class="number">52</span>:                 <span class="keyword">if</span> (index &lt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">53</span>:                     index = history.size() - <span class="number">1</span>;</span><br /><span class="line"> <span class="number">54</span>:                 }</span><br /><span class="line"> <span class="number">55</span>:             } <span class="keyword">else</span> { <span class="comment">// å‘ä¸‹</span></span><br /><span class="line"> <span class="number">56</span>:                 index = index + <span class="number">1</span>;</span><br /><span class="line"> <span class="number">57</span>:                 <span class="keyword">if</span> (index &gt; history.size() - <span class="number">1</span>) {</span><br /><span class="line"> <span class="number">58</span>:                     index = <span class="number">0</span>;</span><br /><span class="line"> <span class="number">59</span>:                 }</span><br /><span class="line"> <span class="number">60</span>:             }</span><br /><span class="line"> <span class="number">61</span>:         }</span><br /><span class="line"> <span class="number">62</span>:         <span class="comment">// è·å¾—å†å²å‘½ä»¤ï¼Œå¹¶å‘é€ç»™å®¢æˆ·ç«¯</span></span><br /><span class="line"> <span class="number">63</span>:         <span class="keyword">if</span> (old == <span class="keyword">null</span> || !old.equals(index)) {</span><br /><span class="line"> <span class="number">64</span>:             <span class="comment">// è®¾ç½®å½“å‰ä½ç½®</span></span><br /><span class="line"> <span class="number">65</span>:             channel.setAttribute(HISTORY_INDEX_KEY, index);</span><br /><span class="line"> <span class="number">66</span>:             <span class="comment">// è·å¾—å†å²å‘½ä»¤</span></span><br /><span class="line"> <span class="number">67</span>:             String value = history.get(index);</span><br /><span class="line"> <span class="number">68</span>:             <span class="comment">// æ‹¼æ¥é€€æ ¼ï¼Œä»¥æ¸…é™¤å®¢æˆ·ç«¯åŸæœ‰å‘½ä»¤</span></span><br /><span class="line"> <span class="number">69</span>:             <span class="keyword">if</span> (old != <span class="keyword">null</span> &amp;&amp; old &gt;= <span class="number">0</span> &amp;&amp; old &lt; history.size()) {</span><br /><span class="line"> <span class="number">70</span>:                 String ov = history.get(old);</span><br /><span class="line"> <span class="number">71</span>:                 StringBuilder buf = <span class="keyword">new</span> StringBuilder();</span><br /><span class="line"> <span class="number">72</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ov.length(); i++) {</span><br /><span class="line"> <span class="number">73</span>:                     buf.append(<span class="string">"\b"</span>); <span class="comment">// é€€æ ¼</span></span><br /><span class="line"> <span class="number">74</span>:                 }</span><br /><span class="line"> <span class="number">75</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ov.length(); i++) {</span><br /><span class="line"> <span class="number">76</span>:                     buf.append(<span class="string">" "</span>);</span><br /><span class="line"> <span class="number">77</span>:                 }</span><br /><span class="line"> <span class="number">78</span>:                 <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; ov.length(); i++) {</span><br /><span class="line"> <span class="number">79</span>:                     buf.append(<span class="string">"\b"</span>); <span class="comment">// é€€æ ¼</span></span><br /><span class="line"> <span class="number">80</span>:                 }</span><br /><span class="line"> <span class="number">81</span>:                 value = buf.toString() + value;</span><br /><span class="line"> <span class="number">82</span>:             }</span><br /><span class="line"> <span class="number">83</span>:             <span class="comment">// å‘é€å‘½ä»¤</span></span><br /><span class="line"> <span class="number">84</span>:             <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">85</span>:                 channel.send(value);</span><br /><span class="line"> <span class="number">86</span>:             } <span class="keyword">catch</span> (RemotingException e) {</span><br /><span class="line"> <span class="number">87</span>:                 <span class="keyword">throw</span> <span class="keyword">new</span> IOException(StringUtils.toString(e));</span><br /><span class="line"> <span class="number">88</span>:             }</span><br /><span class="line"> <span class="number">89</span>:         }</span><br /><span class="line"> <span class="number">90</span>:         <span class="comment">// è¿”å›ï¼Œéœ€è¦æ›´å¤šæŒ‡ä»¤</span></span><br /><span class="line"> <span class="number">91</span>:         <span class="keyword">return</span> DecodeResult.NEED_MORE_INPUT;</span><br /><span class="line"> <span class="number">92</span>:     }</span><br /><span class="line"> <span class="number">93</span>: </span><br /><span class="line"> <span class="number">94</span>:     <span class="comment">// å…³é—­æŒ‡ä»¤</span></span><br /><span class="line"> <span class="number">95</span>:     <span class="keyword">for</span> (Object command : EXIT) {</span><br /><span class="line"> <span class="number">96</span>:         <span class="keyword">if</span> (isEquals(message, (<span class="keyword">byte</span>[]) command)) {</span><br /><span class="line"> <span class="number">97</span>:             <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"> <span class="number">98</span>:                 logger.info(<span class="keyword">new</span> Exception(<span class="string">"Close channel "</span> + channel + <span class="string">" on exit command "</span> + command));</span><br /><span class="line"> <span class="number">99</span>:             }</span><br /><span class="line"><span class="number">100</span>:             channel.close();</span><br /><span class="line"><span class="number">101</span>:             <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">102</span>:         }</span><br /><span class="line"><span class="number">103</span>:     }</span><br /><span class="line"><span class="number">104</span>:     <span class="comment">// æŸ¥æ‰¾æ˜¯å¦å›è½¦ç»“å°¾ã€‚è‹¥ä¸æ˜¯ï¼Œè¯´æ˜ä¸€æ¡ telnet æŒ‡ä»¤æ²¡ç»“æŸã€‚</span></span><br /><span class="line"><span class="number">105</span>:     <span class="keyword">byte</span>[] enter = <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">106</span>:     <span class="keyword">for</span> (Object command : ENTER) {</span><br /><span class="line"><span class="number">107</span>:         <span class="keyword">if</span> (endsWith(message, (<span class="keyword">byte</span>[]) command)) {</span><br /><span class="line"><span class="number">108</span>:             enter = (<span class="keyword">byte</span>[]) command;</span><br /><span class="line"><span class="number">109</span>:             <span class="keyword">break</span>;</span><br /><span class="line"><span class="number">110</span>:         }</span><br /><span class="line"><span class="number">111</span>:     }</span><br /><span class="line"><span class="number">112</span>:     <span class="keyword">if</span> (enter == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">113</span>:         <span class="keyword">return</span> DecodeResult.NEED_MORE_INPUT;</span><br /><span class="line"><span class="number">114</span>:     }</span><br /><span class="line"><span class="number">115</span>:     <span class="comment">// ç§»é™¤å†å²å‘½ä»¤æ•°ç»„çš„ä½ç½®</span></span><br /><span class="line"><span class="number">116</span>:     LinkedList&lt;String&gt; history = (LinkedList&lt;String&gt;) channel.getAttribute(HISTORY_LIST_KEY);</span><br /><span class="line"><span class="number">117</span>:     Integer index = (Integer) channel.getAttribute(HISTORY_INDEX_KEY);</span><br /><span class="line"><span class="number">118</span>:     channel.removeAttribute(HISTORY_INDEX_KEY);</span><br /><span class="line"><span class="number">119</span>:     <span class="comment">// å°†å†å²å‘½ä»¤æ‹¼æ¥</span></span><br /><span class="line"><span class="number">120</span>:     <span class="keyword">if</span> (history != <span class="keyword">null</span> &amp;&amp; !history.isEmpty() &amp;&amp; index != <span class="keyword">null</span> &amp;&amp; index &gt;= <span class="number">0</span> &amp;&amp; index &lt; history.size()) {</span><br /><span class="line"><span class="number">121</span>:         String value = history.get(index);</span><br /><span class="line"><span class="number">122</span>:         <span class="keyword">if</span> (value != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">123</span>:             <span class="keyword">byte</span>[] b1 = value.getBytes();</span><br /><span class="line"><span class="number">124</span>:             <span class="keyword">byte</span>[] b2 = <span class="keyword">new</span> <span class="keyword">byte</span>[b1.length + message.length];</span><br /><span class="line"><span class="number">125</span>:             System.arraycopy(b1, <span class="number">0</span>, b2, <span class="number">0</span>, b1.length);</span><br /><span class="line"><span class="number">126</span>:             System.arraycopy(message, <span class="number">0</span>, b2, b1.length, message.length);</span><br /><span class="line"><span class="number">127</span>:             message = b2;</span><br /><span class="line"><span class="number">128</span>:         }</span><br /><span class="line"><span class="number">129</span>:     }</span><br /><span class="line"><span class="number">130</span>:     <span class="comment">// å°†å‘½ä»¤å­—èŠ‚æ•°ç»„ï¼Œè½¬æˆå…·ä½“çš„ä¸€æ¡å‘½ä»¤</span></span><br /><span class="line"><span class="number">131</span>:     String result = toString(message, getCharset(channel));</span><br /><span class="line"><span class="number">132</span>:     <span class="comment">// æ·»åŠ åˆ°å†å²</span></span><br /><span class="line"><span class="number">133</span>:     <span class="keyword">if</span> (result.trim().length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">134</span>:         <span class="keyword">if</span> (history == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">135</span>:             history = <span class="keyword">new</span> LinkedList&lt;String&gt;();</span><br /><span class="line"><span class="number">136</span>:             channel.setAttribute(HISTORY_LIST_KEY, history);</span><br /><span class="line"><span class="number">137</span>:         }</span><br /><span class="line"><span class="number">138</span>:         <span class="keyword">if</span> (history.isEmpty()) {</span><br /><span class="line"><span class="number">139</span>:             history.addLast(result);</span><br /><span class="line"><span class="number">140</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (!result.equals(history.getLast())) {</span><br /><span class="line"><span class="number">141</span>:             <span class="comment">// æ·»åŠ å½“å‰å‘½ä»¤åˆ°å†å²å°¾éƒ¨</span></span><br /><span class="line"><span class="number">142</span>:             history.remove(result);</span><br /><span class="line"><span class="number">143</span>:             history.addLast(result);</span><br /><span class="line"><span class="number">144</span>:             <span class="comment">// è¶…è¿‡ä¸Šé™ï¼Œç§»é™¤å†å²çš„å¤´éƒ¨</span></span><br /><span class="line"><span class="number">145</span>:             <span class="keyword">if</span> (history.size() &gt; <span class="number">10</span>) {</span><br /><span class="line"><span class="number">146</span>:                 history.removeFirst();</span><br /><span class="line"><span class="number">147</span>:             }</span><br /><span class="line"><span class="number">148</span>:         }</span><br /><span class="line"><span class="number">149</span>:     }</span><br /><span class="line"><span class="number">150</span>:     <span class="keyword">return</span> result;</span><br /><span class="line"><span class="number">151</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬”è€…åœ¨æµ‹è¯•ä»£ç ï¼Œä½¿ç”¨äº†ä¸¤ç§æ”¯æŒ telnet è¿æ¥çš„å·¥å…·ï¼Œä»è¡¨ç°ä¸Šå­˜åœ¨å·®å¼‚ï¼š
<ul>
<li>ä½¿ç”¨&nbsp;<code>brew install telnet</code>&nbsp;å·¥å…·ï¼šæ¯æ¬¡è¾“å…¥å®Œå‘½ä»¤ï¼Œæ•²å®Œå›è½¦ï¼ŒDubbo Server æ‰æ”¶åˆ°è¯·æ±‚ã€‚</li>
<li>ä½¿ç”¨ ShellCraft å·¥å…·ï¼šæ¯æ¬¡è¾“å…¥<strong>ä»»ä½•ä¸€ä¸ª</strong>å­—æ¯ï¼ŒDubbo Server éƒ½ä¼šæ”¶åˆ°è¯·æ±‚ã€‚</li>
<li>ğŸ™‚ æ¨èä¸¤ç§å·¥å…·éƒ½å°è¯•ä¸‹ã€‚</li>
</ul>
</li>
<li>ç¬¬ 3 è‡³ 6 è¡Œï¼šã€TODO 8025ã€‘ä¸ºå•¥ client ä¾§ï¼Œç›´æ¥è¿”å›</li>
<li>ç¬¬ 7 è‡³ 11 è¡Œï¼šè°ƒç”¨&nbsp;<code>#checkPayload(channel, readable)</code>&nbsp;æ–¹æ³•ï¼Œæ£€æŸ¥é•¿åº¦ã€‚</li>
<li>
<p>ç¬¬ 14 è‡³ 23 è¡Œï¼šå¤„ç†<strong>é€€æ ¼</strong>çš„æƒ…å†µã€‚ä¾‹å¦‚åœ¨ ShellCraft å·¥å…·çš„æƒ…å†µä¸‹ï¼Œè¾“é”™ä¸€ä¸ªå­—æ¯æ—¶ï¼Œä½¿ç”¨é€€æ ¼é”®ï¼Œéœ€è¦å‘ Client å‘é€ 32( ç©ºæ ¼ ) + 8( é€€æ ¼ )ã€‚</p>
<blockquote>
<p>FROM&nbsp;<a href="http://blog.51cto.com/wchrt/1627262" target="_blank" rel="external nofollow noopener noreferrer">ã€Štelnetç¼–ç¨‹ å®¢æˆ·ç«¯ æœåŠ¡å™¨ã€‹</a></p>
<p>å†™æœåŠ¡å™¨è¦è‡ªå·±å¤„ç†å¾ˆå¤šæƒ…å†µï¼Œæ¯”å¦‚è¯´æˆ‘è¦åˆ é™¤ä¸€ä¸ªå­—ç¬¦ã€‚BSé€€æ ¼ï¼Œä½†æ˜¯ä¸èƒ½åˆ é™¤ï¼Œä¹Ÿæ²¡æœ‰ç›¸åº”çš„åˆ é™¤ASCIIã€‚è¿™é‡Œå¯ä»¥è¿™æ ·å¤„ç†ï¼šå…ˆå‘å®¢æˆ·ç«¯å‘é€é€€æ ¼ï¼Œå†å‘é€ç©ºæ ¼ï¼ˆè¦†ç›–è¦åˆ é™¤çš„å­—ç¬¦ï¼‰ï¼Œå†å‘é€é€€æ ¼ã€‚è¿™æ ·å°±å®ç°äº†åˆ é™¤ä¸€ä¸ªä½ç½®çš„å­—ç¬¦ã€‚</p>
</blockquote>
</li>
<li>
<p>ç¬¬ 25 è‡³ 34 è¡Œï¼šè°ƒç”¨&nbsp;<code>#isEquals(message, command)</code>&nbsp;æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦ä½¿ç”¨é€€å‡ºå‘½ä»¤ã€‚è‹¥æ˜¯ï¼Œå…³é—­è¿æ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;?&gt; EXIT = Arrays.asList(<span class="keyword">new</span> Object[]{<span class="keyword">new</span> <span class="keyword">byte</span>[]{<span class="number">3</span>} <span class="comment">/* Windows Ctrl+C */</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[]{-<span class="number">1</span>, -<span class="number">12</span>, -<span class="number">1</span>, -<span class="number">3</span>, <span class="number">6</span>} <span class="comment">/* Linux Ctrl+C */</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[]{-<span class="number">1</span>, -<span class="number">19</span>, -<span class="number">1</span>, -<span class="number">3</span>, <span class="number">6</span>} <span class="comment">/* Linux Pause */</span>});</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isEquals</span><span class="params">(<span class="keyword">byte</span>[] message, <span class="keyword">byte</span>[] command)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line">    <span class="keyword">return</span> message.length == command.length &amp;&amp; endsWith(message, command);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 36 è‡³ 92 è¡Œï¼šé€šè¿‡<strong>å‘ä¸Š</strong>æˆ–<strong>å‘ä¸‹</strong>é”®ï¼Œä» Dubbo Server è·å¾—å†å²çš„å‘½ä»¤ã€‚å› ä¸ºå¯ä»¥å¤šæ¬¡å‘ä¸Šæˆ–å‘ä¸‹ï¼Œæ‰€ä»¥ Server éœ€è¦è®°å½•ä½ç½®( Index )ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å†å²å‘½ä»¤åˆ—è¡¨</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HISTORY_LIST_KEY = <span class="string">"telnet.history.list"</span>;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å†å²å‘½ä»¤ä½ç½®ï¼ˆç”¨æˆ·å‘ä¸Šæˆ–å‘ä¸‹ï¼‰</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HISTORY_INDEX_KEY = <span class="string">"telnet.history.index"</span>;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å‘ä¸Š</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] UP = <span class="keyword">new</span> <span class="keyword">byte</span>[]{<span class="number">27</span>, <span class="number">91</span>, <span class="number">65</span>};</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å‘ä¸‹</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] DOWN = <span class="keyword">new</span> <span class="keyword">byte</span>[]{<span class="number">27</span>, <span class="number">91</span>, <span class="number">66</span>};</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ğŸ™‚ ä»£ç æ¯”è¾ƒå¤æ‚ï¼Œæœ‰å¤šç§è¾¹ç•Œåœºæ™¯ï¼Œèƒ–å‹è®¤çœŸè¯»ä¸‹ä»£ç æ³¨é‡Šï¼Œå¹¶è‡ªå·±è°ƒè¯•ä¸‹ã€‚</li>
</ul>
</li>
<li>
<p>ç¬¬ 95 è‡³ 103 è¡Œï¼šå…³é—­æŒ‡ä»¤ã€‚<strong>å†å²å‘½ä»¤çš„æƒ…å†µä¸‹</strong>ã€‚</p>
</li>
<li>
<p>ç¬¬ 104 è‡³ 114 è¡Œï¼šè°ƒç”¨&nbsp;<code>#endsWith(message, command)</code>&nbsp;æ–¹æ³•ï¼ŒæŸ¥æ‰¾æ˜¯å¦<strong>å›è½¦</strong>ç»“å°¾ã€‚è‹¥ä¸æ˜¯ï¼Œè¯´æ˜ä¸€æ¡ telnet å‘½ä»¤è¿˜æ²¡ç»“æŸã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> List&lt;?&gt; ENTER = Arrays.asList(<span class="keyword">new</span> Object[]{<span class="keyword">new</span> <span class="keyword">byte</span>[]{<span class="string">'\r'</span>, <span class="string">'\n'</span>} <span class="comment">/* Windows Enter */</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[]{<span class="string">'\n'</span>} <span class="comment">/* Linux Enter */</span>});</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">endsWith</span><span class="params">(<span class="keyword">byte</span>[] message, <span class="keyword">byte</span>[] command)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line">    <span class="keyword">if</span> (message.length &lt; command.length) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">int</span> offset = message.length - command.length;</span><br /><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = command.length - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {</span><br /><span class="line">        <span class="keyword">if</span> (message[offset + i] != command[i]) {</span><br /><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 115 è‡³ 118 è¡Œï¼šç§»é™¤å†å²å‘½ä»¤æ•°ç»„çš„ä½ç½®ã€‚</p>
</li>
<li>ç¬¬ 119 è‡³ 129 è¡Œï¼šå°†å†å²å‘½ä»¤æ‹¼æ¥åˆ°å½“å‰å‘½ä»¤<strong>å‰é¢</strong>ã€‚æ­¤å¤„ä¼šå­˜åœ¨ä¸€ä¸ª Bug ï¼Œå¤ç°æµç¨‹å¦‚ä¸‹ï¼š
<ul>
<li>1ã€è¾“å…¥&nbsp;<code>ls</code>&nbsp;å›è½¦</li>
<li>2ã€è¾“å…¥&nbsp;<code>pwd</code>&nbsp;ï¼Œå‘ä¸Šï¼Œå›è½¦ã€‚æ­¤å¤„ Dubbo Server è§£æçš„æœ€ç»ˆç»“æœä¸º&nbsp;<code>lspwd</code>&nbsp;ã€‚ç†è®ºæ¥è¯´ï¼Œåº”è¯¥æ˜¯&nbsp;<code>ls</code>&nbsp;ã€‚</li>
</ul>
</li>
<li>
<p>ç¬¬ 131 è¡Œï¼šå°†å‘½ä»¤å­—èŠ‚æ•°ç»„ï¼Œè½¬æˆå…·ä½“çš„ä¸€æ¡å‘½ä»¤ã€‚</p>
<ul>
<li>è°ƒç”¨&nbsp;<a href="https://github.com/apache/incubator-dubbo/blob/bb8884e04433677d6abc6f05c6ad9d39e3dcf236/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/telnet/codec/TelnetCodec.java#L55-L85" target="_blank" rel="external nofollow noopener noreferrer"><code>#getCharset(channel)</code></a>&nbsp;æ–¹æ³•ï¼Œè·å¾—é€šé“çš„å­—ç¬¦é›†ã€‚ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹ç‚¹å‡»æŸ¥çœ‹ã€‚</li>
<li>
<p>è°ƒç”¨&nbsp;<code>#toString(message, charset)</code>&nbsp;æ–¹æ³•ï¼Œå°†å‘½ä»¤å­—èŠ‚æ•°ç»„ï¼Œè½¬æˆå…·ä½“çš„ä¸€æ¡å‘½ä»¤ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">toString</span><span class="params">(<span class="keyword">byte</span>[] message, Charset charset)</span> <span class="keyword">throws</span> UnsupportedEncodingException </span>{</span><br /><span class="line">            <span class="keyword">byte</span>[] copy = <span class="keyword">new</span> <span class="keyword">byte</span>[message.length];</span><br /><span class="line">            <span class="keyword">int</span> index = <span class="number">0</span>;</span><br /><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; message.length; i++) {</span><br /><span class="line">                <span class="keyword">byte</span> b = message[i];</span><br /><span class="line">                <span class="comment">// é€€æ ¼ï¼Œå°¾éƒ¨å‡å°</span></span><br /><span class="line">                <span class="keyword">if</span> (b == <span class="string">'\b'</span>) { <span class="comment">// backspace</span></span><br /><span class="line">                    <span class="keyword">if</span> (index &gt; <span class="number">0</span>) {</span><br /><span class="line">                        index--;</span><br /><span class="line">                    }</span><br /><span class="line">                    <span class="keyword">if</span> (i &gt; <span class="number">2</span> &amp;&amp; message[i - <span class="number">2</span>] &lt; <span class="number">0</span>) { <span class="comment">// double byte char</span></span><br /><span class="line">                        <span class="keyword">if</span> (index &gt; <span class="number">0</span>) {</span><br /><span class="line">                            index--;</span><br /><span class="line">                        }</span><br /><span class="line">                    }</span><br /><span class="line">                <span class="comment">// æ¢ç (æº¢å‡º)</span></span><br /><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (b == <span class="number">27</span>) { <span class="comment">// escape</span></span><br /><span class="line">                    <span class="keyword">if</span> (i &lt; message.length - <span class="number">4</span> &amp;&amp; message[i + <span class="number">4</span>] == <span class="number">126</span>) {</span><br /><span class="line">                        i = i + <span class="number">4</span>;</span><br /><span class="line">                    } <span class="keyword">else</span> <span class="keyword">if</span> (i &lt; message.length - <span class="number">3</span> &amp;&amp; message[i + <span class="number">3</span>] == <span class="number">126</span>) {</span><br /><span class="line">                        i = i + <span class="number">3</span>;</span><br /><span class="line">                    } <span class="keyword">else</span> <span class="keyword">if</span> (i &lt; message.length - <span class="number">2</span>) {</span><br /><span class="line">                        i = i + <span class="number">2</span>;</span><br /><span class="line">                    }</span><br /><span class="line">                <span class="comment">// æ¡æ‰‹</span></span><br /><span class="line">                } <span class="keyword">else</span> <span class="keyword">if</span> (b == -<span class="number">1</span> &amp;&amp; i &lt; message.length - <span class="number">2</span></span><br /><span class="line">                        &amp;&amp; (message[i + <span class="number">1</span>] == -<span class="number">3</span> || message[i + <span class="number">1</span>] == -<span class="number">5</span>)) { <span class="comment">// handshake</span></span><br /><span class="line">                    i = i + <span class="number">2</span>;</span><br /><span class="line">                } <span class="keyword">else</span> {</span><br /><span class="line">                    copy[index++] = message[i];</span><br /><span class="line">                }</span><br /><span class="line">            }</span><br /><span class="line">            <span class="keyword">if</span> (index == <span class="number">0</span>) {</span><br /><span class="line">                <span class="keyword">return</span> <span class="string">""</span>;</span><br /><span class="line">            }</span><br /><span class="line">            <span class="comment">// åˆ›å»ºå­—ç¬¦ä¸²</span></span><br /><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(copy, <span class="number">0</span>, index, charset.name()).trim();</span><br /><span class="line">        }</span><br /><span class="line">        ``` </span><br /><span class="line">        * x   </span><br /><br /><span class="line">ğŸ˜ˆ å»ºè®®å¤šè°ƒè¯•ï¼Œè¿™æ ·ä¼šæ›´å¥½ç†è§£ã€‚</span><br /><br /><span class="line">å¦‚ä¸‹æ˜¯ TelnetCodec çš„è¢«**è°ƒç”¨æ ˆ**ï¼š![è°ƒç”¨æ ˆ](http:<span class="comment">//static2.iocoder.cn/images/Dubbo/2018_12_07/03.png)</span></span><br /><br /><span class="line">**ç¼–ç **</span><br /><br /><span class="line">```Java</span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(Channel channel, ChannelBuffer buffer, Object message)</span> <span class="keyword">throws</span> IOException </span>{</span><br /><span class="line">    <span class="comment">// telnet å‘½ä»¤ç»“æœ</span></span><br /><span class="line">    <span class="keyword">if</span> (message <span class="keyword">instanceof</span> String) {</span><br /><span class="line">        <span class="keyword">if</span> (isClientSide(channel)) { <span class="comment">// ã€TODO 8025ã€‘ä¸ºå•¥ client ä¾§ï¼Œéœ€è¦å¤šåŠ  \r\n</span></span><br /><span class="line">            message = message + <span class="string">"\r\n"</span>;</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// å†™å…¥</span></span><br /><span class="line">        <span class="keyword">byte</span>[] msgData = ((String) message).getBytes(getCharset(channel).name());</span><br /><span class="line">        buffer.writeBytes(msgData);</span><br /><span class="line">    <span class="comment">// é telnet å‘½ä»¤ç»“æœã€‚ç›®å‰ä¸ä¼šå‡ºç°</span></span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        <span class="keyword">super</span>.encode(channel, buffer, message);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
</li>
</ul>
<h1 id="3-TelnetHandler">3. TelnetHandler</h1>
<p><code>com.alibaba.dubbo.remoting.telnet.TelnetHandler</code>&nbsp;ï¼Œtelnet å‘½ä»¤å¤„ç†å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@SPI</span></span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TelnetHandler</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * telnet.</span></span><br /><span class="line"><span class="comment">     * å¤„ç† telnet å‘½ä»¤</span></span><br /><span class="line"><span class="comment">     *</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel é€šé“</span></span><br /><span class="line"><span class="comment">     * <span class="doctag">@param</span> message telnet å‘½ä»¤</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function">String <span class="title">telnet</span><span class="params">(Channel channel, String message)</span> <span class="keyword">throws</span> RemotingException</span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>@SPI</code>&nbsp;æ³¨è§£ï¼ŒDubbo SPI&nbsp;<strong>æ‹“å±•ç‚¹</strong>ã€‚</li>
<li><strong>æ¯ç§</strong>&nbsp;telnet å‘½ä»¤ï¼Œå¯¹åº”ä¸€ä¸ª TelnetHandler å®ç°ç±»ã€‚</li>
</ul>
<h1 id="4-TelnetHandlerAdapter">4. TelnetHandlerAdapter</h1>
<p><code>com.alibaba.dubbo.remoting.telnet.support.TelnetHandlerAdapter</code>&nbsp;ï¼Œå®ç° TelnetHandler æ¥å£ï¼Œç»§æ‰¿ ChannelHandlerAdapter ç±»ï¼Œtelnet å¤„ç†å™¨<strong>é€‚é…å™¨</strong>ï¼Œè´Ÿè´£æ¥æ”¶æ¥è‡ª HeaderExchangeHandler çš„ telnet å‘½ä»¤ï¼Œåˆ†å‘ç»™å¯¹åº”çš„ TelnetHandler å®ç°ç±»ï¼Œè¿›è¡Œå¤„ç†ï¼Œ<strong>è¿”å›å‘½ä»¤ç»“æœ</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TelnetHandlerAdapter</span> <span class="keyword">extends</span> <span class="title">ChannelHandlerAdapter</span> <span class="keyword">implements</span> <span class="title">TelnetHandler</span> </span>{</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">private</span> <span class="keyword">final</span> ExtensionLoader&lt;TelnetHandler&gt; extensionLoader = ExtensionLoader.getExtensionLoader(TelnetHandler.class);</span><br /><span class="line"> <span class="number">4</span>: </span><br /><span class="line"> <span class="number">5</span>:     <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">6</span>:     <span class="function"><span class="keyword">public</span> String <span class="title">telnet</span><span class="params">(Channel channel, String message)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line"> <span class="number">7</span>:         <span class="comment">// å¤„ç† telnet æç¤ºé”®</span></span><br /><span class="line"> <span class="number">8</span>:         String prompt = channel.getUrl().getParameterAndDecoded(Constants.PROMPT_KEY, Constants.DEFAULT_PROMPT);</span><br /><span class="line"> <span class="number">9</span>:         <span class="keyword">boolean</span> noprompt = message.contains(<span class="string">"--no-prompt"</span>);</span><br /><span class="line"><span class="number">10</span>:         message = message.replace(<span class="string">"--no-prompt"</span>, <span class="string">""</span>);</span><br /><span class="line"><span class="number">11</span>:         <span class="comment">// æ‹†å‡º telnet å‘½ä»¤å’Œå‚æ•°</span></span><br /><span class="line"><span class="number">12</span>:         StringBuilder buf = <span class="keyword">new</span> StringBuilder();</span><br /><span class="line"><span class="number">13</span>:         message = message.trim();</span><br /><span class="line"><span class="number">14</span>:         String command; <span class="comment">// å‘½ä»¤</span></span><br /><span class="line"><span class="number">15</span>:         <span class="keyword">if</span> (message.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">16</span>:             <span class="keyword">int</span> i = message.indexOf(<span class="string">' '</span>);</span><br /><span class="line"><span class="number">17</span>:             <span class="keyword">if</span> (i &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">18</span>:                 command = message.substring(<span class="number">0</span>, i).trim(); <span class="comment">// å‘½ä»¤</span></span><br /><span class="line"><span class="number">19</span>:                 message = message.substring(i + <span class="number">1</span>).trim(); <span class="comment">// å‚æ•°</span></span><br /><span class="line"><span class="number">20</span>:             } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">21</span>:                 command = message; <span class="comment">// å‘½ä»¤</span></span><br /><span class="line"><span class="number">22</span>:                 message = <span class="string">""</span>; <span class="comment">// å‚æ•°</span></span><br /><span class="line"><span class="number">23</span>:             }</span><br /><span class="line"><span class="number">24</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">25</span>:             command = <span class="string">""</span>; <span class="comment">// å‘½ä»¤</span></span><br /><span class="line"><span class="number">26</span>:         }</span><br /><span class="line"><span class="number">27</span>:         <span class="keyword">if</span> (command.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">28</span>:             <span class="comment">// æŸ¥æ‰¾åˆ°å¯¹åº”çš„ TelnetHandler å¯¹è±¡ï¼Œæ‰§è¡Œå‘½ä»¤</span></span><br /><span class="line"><span class="number">29</span>:             <span class="keyword">if</span> (extensionLoader.hasExtension(command)) {</span><br /><span class="line"><span class="number">30</span>:                 <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">31</span>:                     String result = extensionLoader.getExtension(command).telnet(channel, message);</span><br /><span class="line"><span class="number">32</span>:                     <span class="keyword">if</span> (result == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">33</span>:                         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">34</span>:                     }</span><br /><span class="line"><span class="number">35</span>:                     buf.append(result);</span><br /><span class="line"><span class="number">36</span>:                 } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line"><span class="number">37</span>:                     buf.append(t.getMessage());</span><br /><span class="line"><span class="number">38</span>:                 }</span><br /><span class="line"><span class="number">39</span>:             <span class="comment">// æŸ¥æ‰¾ä¸åˆ°å¯¹åº”çš„ TelnetHandler å¯¹è±¡ï¼Œè¿”å›æŠ¥é”™ã€‚</span></span><br /><span class="line"><span class="number">40</span>:             } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">41</span>:                 buf.append(<span class="string">"Unsupported command: "</span>);</span><br /><span class="line"><span class="number">42</span>:                 buf.append(command);</span><br /><span class="line"><span class="number">43</span>:             }</span><br /><span class="line"><span class="number">44</span>:         }</span><br /><span class="line"><span class="number">45</span>:         <span class="comment">// æ·»åŠ  telnet æç¤ºè¯­</span></span><br /><span class="line"><span class="number">46</span>:         <span class="keyword">if</span> (buf.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">47</span>:             buf.append(<span class="string">"\r\n"</span>);</span><br /><span class="line"><span class="number">48</span>:         }</span><br /><span class="line"><span class="number">49</span>:         <span class="keyword">if</span> (prompt != <span class="keyword">null</span> &amp;&amp; prompt.length() &gt; <span class="number">0</span> &amp;&amp; !noprompt) {</span><br /><span class="line"><span class="number">50</span>:             buf.append(prompt);</span><br /><span class="line"><span class="number">51</span>:         }</span><br /><span class="line"><span class="number">52</span>:         <span class="comment">// è¿”å›</span></span><br /><span class="line"><span class="number">53</span>:         <span class="keyword">return</span> buf.toString();</span><br /><span class="line"><span class="number">54</span>:     }</span><br /><span class="line"><span class="number">55</span>: </span><br /><span class="line"><span class="number">56</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 8 è‡³ 10 è¡Œï¼šå¤„ç† telnet æç¤ºè¯­ï¼Œé»˜è®¤ä¸º&nbsp;<code>"dubbo"</code>&nbsp;ï¼Œå¯é€šè¿‡&nbsp;<code>&lt;dubbo:application prompt="" /&gt;</code>&nbsp;é…ç½®ã€‚æç¤ºè¯­çš„æ•ˆæœï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºçº¢æ¡†éƒ¨åˆ†ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_12_07/04.png" alt="æç¤ºè¯­" /></li>
<li>ç¬¬ 11 è‡³ 26 è¡Œï¼šæ‹†é™¤ telnet å‘½ä»¤å’Œå‚æ•°<strong>ä¸¤</strong>éƒ¨åˆ†ã€‚</li>
<li>ç¬¬ 28 è‡³ 38 è¡Œï¼šæŸ¥æ‰¾åˆ°å¯¹åº”çš„ TelnetHandler å¯¹è±¡ï¼Œæ‰§è¡Œå‘½ä»¤ï¼Œè¿”å›ç»“æœã€‚</li>
<li>ç¬¬ 39 è‡³ 43 è¡Œï¼šæŸ¥æ‰¾ä¸åˆ°å¯¹åº”çš„ TelnetHandler å¯¹è±¡ï¼Œè¿”å›<strong>æŠ¥é”™æç¤º</strong>ã€‚</li>
<li>ç¬¬ 45 è‡³ 53 è¡Œï¼šæ·»åŠ  telnet æç¤ºè¯­ï¼Œå¹¶æœ€ç»ˆè¿”å›ã€‚</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸‹ HeaderExchangeHandler å¯¹ TelnetHandlerAdapter çš„è°ƒç”¨ï¼Œç®€åŒ–ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ExchangeHandler handler;</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">received</span><span class="params">(Channel channel, Object message)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    <span class="comment">// ... çœç•¥ä»£ç </span></span><br /><span class="line">    <span class="keyword">if</span> (message <span class="keyword">instanceof</span> String) {</span><br /><span class="line">        <span class="keyword">if</span> (isClientSide(channel)) {</span><br /><span class="line">            Exception e = <span class="keyword">new</span> Exception(<span class="string">"Dubbo client can not supported string message: "</span> + message + <span class="string">" in channel: "</span> + channel + <span class="string">", url: "</span> + channel.getUrl());</span><br /><span class="line">            logger.error(e.getMessage(), e);</span><br /><span class="line">        } <span class="keyword">else</span> {</span><br /><span class="line">            String echo = handler.telnet(channel, (String) message);</span><br /><span class="line">            <span class="keyword">if</span> (echo != <span class="keyword">null</span> &amp;&amp; echo.length() &gt; <span class="number">0</span>) {</span><br /><span class="line">                channel.send(echo);</span><br /><span class="line">            }</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br />    <br /><span class="line">    <span class="comment">// ... çœç•¥ä»£ç </span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¼šè°ƒç”¨&nbsp;<code>handler</code>&nbsp;çš„&nbsp;<code>#telnet(channel, message)</code>&nbsp;æ–¹æ³•ï¼Œå¤„ç† telnet å‘½ä»¤ï¼Œå¹¶å°†æ‰§è¡Œå‘½ä»¤çš„ç»“æœï¼Œå‘é€ç»™å®¢æˆ·ç«¯ã€‚</li>
<li>ğŸ™‚ å¯èƒ½èƒ–å‹ä¼šæ‡µé€¼ï¼Œ<code>handler</code>&nbsp;ä¸æ˜¯ ExchangeHandler ç±»å‹ä¹ˆï¼Ÿåœ¨åé¢çš„æ–‡ç« ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ° ExchangeHandler å®ç° TelnetHandler æ¥å£ã€‚</li>
</ul>
<p>è¿™æ ·å°±å®Œäº†ä¹ˆï¼Ÿä¸ä¸ä¸ã€‚ä¸ºä»€ä¹ˆ TelnetHandlerAdapter ä¼šç»§æ‰¿ ChannelHandlerAdapter ç±»å‘¢ï¼Ÿå› ä¸ºåæ–‡ä¼šçœ‹åˆ°çš„ ExchangeHandlerAdapter ï¼Œå®ç°äº† TelnetHandlerAdapter ç±»ï¼Œè€Œ Java ä¸æ”¯æŒå¤šç»§æ‰¿ï¼Œæ‰€ä»¥ä½¿ç”¨ TelnetHandlerAdapter ç»§æ‰¿ ChannelHandlerAdapter ç±»ã€‚å¤šå°‘æœ‰äº›æ— å¥ˆï¼Ÿè¿™æ˜¯è‰¿è‰¿çš„ç†è§£ï¼Œä¹Ÿä¸ä¸€å®šæ­£ç¡®ï¼Œæ¬¢è¿ä¸€èµ·æ¢è®¨ã€‚</p>
<h1 id="5-TelnetHandler-å‘½ä»¤å®ç°">5. TelnetHandler å‘½ä»¤å®ç°</h1>
<p>åœ¨&nbsp;<code>command</code>&nbsp;åŒ…ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¤šç§ TelnetHandler å‘½ä»¤çš„å®ç°ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_12_07/05.png" alt="command" /></p>
<ul>
<li>ClearTelnetHandler</li>
<li>ExitTelnetHandler</li>
<li>HelpTelnetHandler</li>
<li>LogTelnetHandler</li>
<li>StatusTelnetHandler</li>
</ul>
<p>ğŸ˜ˆ å…·ä½“æ¯ä¸ªç±»çš„å®ç°ï¼Œæœ¬æ–‡å°±çœç•¥ï¼Œèƒ–å‹å¯¹å“ªä¸ªæ„Ÿå…´è¶£ï¼Œå¯ä»¥è‡ªå·±ç…ç…ã€‚</p>
<p>åœ¨æ¯ä¸ªå®ç°ç±»ä¸Šï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°æ·»åŠ æœ‰&nbsp;<code>@Help</code>&nbsp;æ³¨è§£ï¼Œç”¨äºæ¯ä¸ª telnet æŒ‡ä»¤çš„å¸®åŠ©æ–‡æ¡£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Documented</span></span><br /><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br /><span class="line"><span class="meta">@Target</span>({ElementType.TYPE})</span><br /><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Help {</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * å‚æ•°è¯´æ˜</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function">String <span class="title">parameter</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * ç®€è¦æç¤º</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function">String <span class="title">summary</span><span class="params">()</span></span>;</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * è¯¦ç»†æç¤º</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="function">String <span class="title">detail</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</div>