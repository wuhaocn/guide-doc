<header class="article-header">
<h1 class="article-title">&nbsp;æœåŠ¡è°ƒç”¨ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°è°ƒç”¨ï¼ˆInjvmï¼‰</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>ä»è¿™ç¯‡æ–‡ç« å¼€å§‹ï¼Œæˆ‘ä»¬å¼€å§‹åˆ†äº«<strong>æœåŠ¡è°ƒç”¨</strong>çš„å®ç°ã€‚åœ¨å‰é¢ï¼Œè‰¿è‰¿å·²ç»å†™äº†æœåŠ¡ï¼š</p>
<ul>
<li>æœ¬åœ°æš´éœ²ã€è¿œç¨‹æš´éœ²</li>
<li>æœ¬åœ°å¼•ç”¨ã€è¿œç¨‹å¼•ç”¨</li>
</ul>
<p>é‚£ä¹ˆåœ¨æœåŠ¡è°ƒç”¨ï¼Œå¿…ç„¶ä¹Ÿæ˜¯åˆ†ï¼š</p>
<ul>
<li>æœ¬åœ°è°ƒç”¨</li>
<li>è¿œç¨‹è°ƒç”¨</li>
</ul>
<p>æœ¬æ–‡åˆ†äº«<strong>æœ¬åœ°è°ƒç”¨</strong>ï¼Œåœ¨&nbsp;<code>dubbo-rpc-injvm</code>&nbsp;æ¨¡å—å®ç°ã€‚</p>
<p>ç›¸æ¯”è¿œç¨‹è°ƒç”¨ï¼Œå®ç°ä¸Šä¼šç®€å•å¾ˆå¤šï¼šå› ä¸ºè°ƒç”¨çš„æœåŠ¡ï¼Œå°±åœ¨æœ¬åœ°è¿›ç¨‹å†…ï¼Œä¸”ä¸å­˜åœ¨å¤šä¸ªï¼Œæ‰€ä»¥ä¸éœ€è¦<strong>é›†ç¾¤å®¹é”™</strong>å’Œ<strong>ç½‘ç»œé€šä¿¡</strong>ç›¸å…³çš„åŠŸèƒ½ã€‚</p>
<h1 id="2-è°ƒè¯•ç¯å¢ƒ">2. è°ƒè¯•ç¯å¢ƒ</h1>
<blockquote>
<p>å‹æƒ…æç¤ºï¼šç¬”è€…å»ºè®®èƒ–å‹å…ˆå°è¯•è‡ªå·±æ­å»ºæœ¬åœ°è°ƒç”¨çš„è°ƒè¯•ç¯å¢ƒï¼Œå¦‚æœç¢°åˆ°é—®é¢˜åœ¨çœ‹æœ¬å°èŠ‚ã€‚</p>
</blockquote>
<p>åŸºäº&nbsp;<code>dubbo-demo-consumer</code>&nbsp;æ”¹é€ ï¼š</p>
<p>1ã€å°†&nbsp;<code>dubbo-demo-provider</code>&nbsp;æ¨¡å—çš„&nbsp;<code>com.alibaba.dubbo.demo.provider.DemoServiceImpl</code>&nbsp;ç±»ï¼Œå¤åˆ¶åˆ°&nbsp;<code>dubbo-demo-consumer</code>&nbsp;æ¨¡å—çš„&nbsp;<code>com.alibaba.dubbo.demo.consumer</code>&nbsp;åŒ…ä¸‹ã€‚</p>
<p>2ã€åœ¨&nbsp;<code>resources/META-INF/spring</code>&nbsp;ç›®å½•ä¸‹ï¼Œæ–°å»º&nbsp;<code>dubbo-demo-injvm.xml</code>&nbsp;æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight xml">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br /><span class="line"><span class="tag">       <span class="attr">xmlns:dubbo</span>=<span class="string">"http://code.alibabatech.com/schema/dubbo"</span></span></span><br /><span class="line"><span class="tag">       <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span><br /><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd</span></span></span><br /><span class="line"><span class="tag"><span class="string">       http://code.alibabatech.com/schema/dubbo http://code.alibabatech.com/schema/dubbo/dubbo.xsd"</span>&gt;</span></span><br /><br /><span class="line">    <span class="tag">&lt;<span class="name">dubbo:application</span> <span class="attr">name</span>=<span class="string">"demo-injvm"</span>/&gt;</span></span><br /><br /><span class="line">    <span class="tag">&lt;<span class="name">dubbo:registry</span> <span class="attr">address</span>=<span class="string">"N/A"</span>/&gt;</span></span><br /><br /><span class="line">    <span class="tag">&lt;<span class="name">dubbo:reference</span> <span class="attr">id</span>=<span class="string">"demoService"</span> <span class="attr">interface</span>=<span class="string">"com.alibaba.dubbo.demo.DemoService"</span> <span class="attr">protocol</span>=<span class="string">"injvm"</span> <span class="attr">scope</span>=<span class="string">"local"</span> /&gt;</span></span><br /><br /><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"demoServiceImpl"</span> <span class="attr">class</span>=<span class="string">"com.alibaba.dubbo.demo.consumer.DemoServiceImpl"</span>/&gt;</span></span><br /><span class="line">    <span class="tag">&lt;<span class="name">dubbo:service</span> <span class="attr">interface</span>=<span class="string">"com.alibaba.dubbo.demo.DemoService"</span> <span class="attr">ref</span>=<span class="string">"demoServiceImpl"</span> <span class="attr">protocol</span>=<span class="string">"injvm"</span> <span class="attr">scope</span>=<span class="string">"local"</span> /&gt;</span></span><br /><br /><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>3ã€ä¿®æ”¹&nbsp;<code>com.alibaba.dubbo.demo.consumer.Consumer</code>&nbsp;ç±»ï¼ŒåŠ è½½çš„ Spring é…ç½®æ–‡ä»¶ä¸º&nbsp;<code>dubbo-demo-injvm.xml</code>&nbsp;ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">ClassPathXmlApplicationContext context = <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="keyword">new</span> String[]{<span class="string">"META-INF/spring/dubbo-demo-injvm.xml"</span>});</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p>4ã€å¯åŠ¨ Consumer ï¼Œå³å¯å¼€å§‹è°ƒè¯•ã€‚</p>
<hr />
<p><a href="https://github.com/YunaiV/dubbo/tree/f14e4e4fffaede31cbece589e0f543ec6669b2ae/dubbo-demo/dubbo-demo-consumer" target="_blank" rel="external nofollow noopener noreferrer"><code>dubbo-demo-consumer</code></a>&nbsp;ï¼Œæ˜¯ç¬”è€…æ”¹å®Œï¼Œå¯è¿è¡Œçš„ä¸€ä¸ªå¿«ç…§ç‰ˆæœ¬ã€‚</p>
<h1 id="3-é¡ºåºå›¾">3. é¡ºåºå›¾</h1>
<ul>
<li>æ¶ˆè´¹è€…è°ƒç”¨æœåŠ¡çš„é¡ºåºå›¾ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_10_01/01.png" alt="æ¶ˆè´¹è€…è°ƒç”¨æœåŠ¡çš„é¡ºåºå›¾" /></li>
<li>æä¾›è€…æä¾›æœåŠ¡çš„é¡ºåºå›¾ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_10_01/02.png" alt="æä¾›è€…æä¾›æœåŠ¡çš„é¡ºåºå›¾" /></li>
</ul>
<p>ğŸ™‚ æµç¨‹ä¸Šè¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œç¬”è€…å°±ä¸å“”å“”äº†ã€‚å¦‚æœèƒ–å‹ä¸å¤ªç†è§£ï¼Œå¯ä»¥å›çœ‹ä¹‹å‰çš„æ–‡ç« ï¼Œå†å¤šå¤šè°ƒè¯•ç†è§£ï¼Œæˆ–è€…çŸ¥è¯†æ˜Ÿçƒå‘å¸–ä¸€èµ·è®¨è®ºã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹æ¯ä¸ªæ­¥éª¤çš„å®ç°ä»£ç ã€‚</p>
<h1 id="4-æ¶ˆè´¹è€…è°ƒç”¨æœåŠ¡">4. æ¶ˆè´¹è€…è°ƒç”¨æœåŠ¡</h1>
<h2 id="4-1-Proxy">4.1 Proxy</h2>
<blockquote>
<p>æç¤ºï¼šå¯¹åº”å›¾ä¸­ [1] [2] [3]</p>
</blockquote>
<p>è§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/proxy-javassist/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; åŠ¨æ€ä»£ç†ï¼ˆä¸€ï¼‰ä¹‹ Javassistã€‹</a>&nbsp;æ–‡ç« ã€‚</p>
<h2 id="4-2-ProtocolFilterWrapper">4.2 ProtocolFilterWrapper</h2>
<blockquote>
<p>æç¤ºï¼šå¯¹åº”å›¾ä¸­ [5]</p>
</blockquote>
<p>ProtocolFilterWrapper çš„å¸¦æœ‰è¿‡æ»¤é“¾çš„ Invoker ï¼Œæ•´ä¸ªè°ƒç”¨è¿‡ç¨‹å’Œ J2EE FilterChain æ˜¯ä¸€è‡´çš„ï¼Œå…·ä½“æ¯ä¸ª Dubbo Filter çš„å®ç°ï¼Œæˆ‘ä»¬å¦å¼€æ–‡ç« ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = filters.size() - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) {</span><br /><span class="line">    <span class="keyword">final</span> Filter filter = filters.get(i);</span><br /><span class="line">    <span class="keyword">final</span> Invoker&lt;T&gt; next = last;</span><br /><span class="line">    last = <span class="keyword">new</span> Invoker&lt;T&gt;() {</span><br /><br /><span class="line">        <span class="function"><span class="keyword">public</span> Class&lt;T&gt; <span class="title">getInterface</span><span class="params">()</span> </span>{</span><br /><span class="line">            <span class="keyword">return</span> invoker.getInterface();</span><br /><span class="line">        }</span><br /><br /><span class="line">        <span class="function"><span class="keyword">public</span> URL <span class="title">getUrl</span><span class="params">()</span> </span>{</span><br /><span class="line">            <span class="keyword">return</span> invoker.getUrl();</span><br /><span class="line">        }</span><br /><br /><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAvailable</span><span class="params">()</span> </span>{</span><br /><span class="line">            <span class="keyword">return</span> invoker.isAvailable();</span><br /><span class="line">        }</span><br /><br /><span class="line">        <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">            <span class="keyword">return</span> filter.invoke(next, invocation);</span><br /><span class="line">        }</span><br /><br /><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br /><span class="line">            invoker.destroy();</span><br /><span class="line">        }</span><br /><br /><span class="line">        <span class="meta">@Override</span></span><br /><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>{</span><br /><span class="line">            <span class="keyword">return</span> invoker.toString();</span><br /><span class="line">        }</span><br /><span class="line">    };</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p><code>#invoke(invocation)</code>&nbsp;æ–¹æ³•ä¸­ï¼Œè°ƒç”¨&nbsp;<code>Filter#(invoker, invocation)</code>&nbsp;æ–¹æ³•ï¼Œä¸æ–­æ‰§è¡Œè¿‡æ»¤é€»è¾‘ã€‚è€Œåœ¨ Filter ä¸­ï¼Œåˆä¸æ–­è°ƒç”¨&nbsp;<code>Invoker#invoker(invocation)</code>&nbsp;æ–¹æ³•ï¼Œæœ€ç»ˆæœ€åä¸€ä¸ª Filter ï¼Œä¼šè°ƒç”¨&nbsp;<code>InjvmInvoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼Œç»§ç»­æ‰§è¡Œé€»è¾‘ã€‚</p>
<blockquote>
<p>å‹æƒ…æç¤ºï¼ŒInjvmInvoker åªæ˜¯æ­¤å¤„çš„ä¾‹å­ï¼Œä¸åŒçš„åè®®ï¼Œä¼šè°ƒç”¨ä¸åŒçš„ Invoker å®ç°ç±»ï¼Œä¾‹å¦‚ Dubbo åè®®ï¼Œè°ƒç”¨çš„æ˜¯ DubboInvoker ã€‚</p>
</blockquote>
<p>å¦å¤–ï¼ŒFilter è°ƒç”¨ Invoker çš„ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">        <span class="keyword">return</span> invoker.invoke(invocation); <span class="comment">// è°ƒç”¨</span></span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="4-3-ListenerInvokerWrapper">4.3 ListenerInvokerWrapper</h2>
<blockquote>
<p>æç¤ºï¼šå¯¹åº”å›¾ä¸­ [6]</p>
</blockquote>
<p>ListenerInvokerWrapper ç±»ï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº† InvokerListener çš„è§¦å‘ï¼Œç›®å‰è¯¥ç›‘å¬å™¨åªæœ‰&nbsp;<code>#referred(invoker)</code>&nbsp;<code>#destroyed(invoker)</code>&nbsp;ä¸¤ä¸ªæ¥å£æ–¹æ³•ï¼Œå¹¶æœªå¯¹&nbsp;<code>#invoke(invocation)</code>&nbsp;çš„è¿‡ç¨‹ï¼Œå®ç°ç›‘å¬ã€‚å› æ­¤ï¼ŒListenerInvokerWrapper çš„&nbsp;<code>#invoke(invocation)</code>&nbsp;çš„å®ç°åŸºæœ¬ç­‰äºé›¶ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">    <span class="keyword">return</span> invoker.invoke(invocation);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="4-4-AbstractInvoker">4.4 AbstractInvoker</h2>
<blockquote>
<p>æç¤ºï¼šå¯¹åº”å›¾ä¸­ [7]</p>
</blockquote>
<p>AbstractInvoker ï¼Œåœ¨&nbsp;<code>#invoke(invocation)</code>&nbsp;æ–¹æ³•ä¸­ï¼Œå®ç°äº†<strong>å…¬ç”¨é€»è¾‘</strong>ï¼ŒåŒæ—¶<strong>æŠ½è±¡</strong>äº†&nbsp;<code>#doInvoke(invocation)</code>&nbsp;æ–¹æ³•ï¼Œå­ç±»å®ç°è‡ªå®šä¹‰é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invocation inv)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (destroyed.get()) {</span><br /><span class="line"> <span class="number">3</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Rpc invoker for service "</span> + <span class="keyword">this</span> + <span class="string">" on consumer "</span> + NetUtils.getLocalHost()</span><br /><span class="line"> <span class="number">4</span>:                 + <span class="string">" use dubbo version "</span> + Version.getVersion()</span><br /><span class="line"> <span class="number">5</span>:                 + <span class="string">" is DESTROYED, can not be invoked any more!"</span>);</span><br /><span class="line"> <span class="number">6</span>:     }</span><br /><span class="line"> <span class="number">7</span>:     RpcInvocation invocation = (RpcInvocation) inv;</span><br /><span class="line"> <span class="number">8</span>:     <span class="comment">// è®¾ç½® `invoker` å±æ€§</span></span><br /><span class="line"> <span class="number">9</span>:     invocation.setInvoker(<span class="keyword">this</span>);</span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// æ·»åŠ å…¬ç”¨çš„éšå¼ä¼ å‚ï¼Œä¾‹å¦‚ï¼Œ`path` `interface` ç­‰ç­‰ï¼Œè¯¦è§ RpcInvocation ç±»ã€‚</span></span><br /><span class="line"><span class="number">11</span>:     <span class="keyword">if</span> (attachment != <span class="keyword">null</span> &amp;&amp; attachment.size() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">12</span>:         invocation.addAttachmentsIfAbsent(attachment);</span><br /><span class="line"><span class="number">13</span>:     }</span><br /><span class="line"><span class="number">14</span>:     <span class="comment">// æ·»åŠ è‡ªå®šä¹‰çš„éšå£«ä¼ å‚</span></span><br /><span class="line"><span class="number">15</span>:     Map&lt;String, String&gt; context = RpcContext.getContext().getAttachments();</span><br /><span class="line"><span class="number">16</span>:     <span class="keyword">if</span> (context != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">17</span>:         invocation.addAttachmentsIfAbsent(context);</span><br /><span class="line"><span class="number">18</span>:     }</span><br /><span class="line"><span class="number">19</span>:     <span class="comment">// è®¾ç½® `async=true` ï¼Œè‹¥ä¸ºå¼‚æ­¥æ–¹æ³•</span></span><br /><span class="line"><span class="number">20</span>:     <span class="keyword">if</span> (getUrl().getMethodParameter(invocation.getMethodName(), Constants.ASYNC_KEY, <span class="keyword">false</span>)) {</span><br /><span class="line"><span class="number">21</span>:         invocation.setAttachment(Constants.ASYNC_KEY, Boolean.TRUE.toString());</span><br /><span class="line"><span class="number">22</span>:     }</span><br /><span class="line"><span class="number">23</span>:     RpcUtils.attachInvocationIdIfAsync(getUrl(), invocation);</span><br /><span class="line"><span class="number">24</span>:</span><br /><span class="line"><span class="number">25</span>:     <span class="comment">// æ‰§è¡Œè°ƒç”¨</span></span><br /><span class="line"><span class="number">26</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">27</span>:         <span class="keyword">return</span> doInvoke(invocation);</span><br /><span class="line"><span class="number">28</span>:     <span class="comment">// TODO ã€8023 biz exceptionã€‘</span></span><br /><span class="line"><span class="number">29</span>:     } <span class="keyword">catch</span> (InvocationTargetException e) { <span class="comment">// biz exception</span></span><br /><span class="line"><span class="number">30</span>:         Throwable te = e.getTargetException();</span><br /><span class="line"><span class="number">31</span>:         <span class="keyword">if</span> (te == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">32</span>:             <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(e);</span><br /><span class="line"><span class="number">33</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">34</span>:             <span class="keyword">if</span> (te <span class="keyword">instanceof</span> RpcException) {</span><br /><span class="line"><span class="number">35</span>:                 ((RpcException) te).setCode(RpcException.BIZ_EXCEPTION);</span><br /><span class="line"><span class="number">36</span>:             }</span><br /><span class="line"><span class="number">37</span>:             <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(te);</span><br /><span class="line"><span class="number">38</span>:         }</span><br /><span class="line"><span class="number">39</span>:     } <span class="keyword">catch</span> (RpcException e) {</span><br /><span class="line"><span class="number">40</span>:         <span class="keyword">if</span> (e.isBiz()) {</span><br /><span class="line"><span class="number">41</span>:             <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(e);</span><br /><span class="line"><span class="number">42</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">43</span>:             <span class="keyword">throw</span> e;</span><br /><span class="line"><span class="number">44</span>:         }</span><br /><span class="line"><span class="number">45</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">46</span>:         <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(e);</span><br /><span class="line"><span class="number">47</span>:     }</span><br /><span class="line"><span class="number">48</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p>ç¬¬ 7 è‡³ 23 è¡Œï¼šè®¾ç½®&nbsp;<code>invocation</code>&nbsp;çš„å±æ€§ã€‚</p>
<ul>
<li>ç¬¬ 9 è¡Œï¼šè®¾ç½®&nbsp;<code>invoker</code>&nbsp;å±æ€§ä¸ºè‡ªå·±ã€‚åœ¨ä¸Šé¢ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ° Invoker æ˜¯å±‚å±‚åµŒå¥—ï¼Œåªè¦åˆ°äº†è¿™é‡Œæ‰æ˜¯çœŸæ­£çš„ Invoker å¯¹è±¡ã€‚</li>
<li>ç¬¬ 10 è‡³ 13 è¡Œï¼šæ·»åŠ <strong>å…¬ç”¨çš„</strong>çš„éšå¼ä¼ å‚ã€‚ä¾‹å¦‚ï¼Œ<code>path</code>&nbsp;<code>interface</code>&nbsp;ç­‰ç­‰ã€‚æ‰€æœ‰è§&nbsp;<a href="https://github.com/apache/incubator-dubbo/blob/master/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/RpcInvocation.java#L50-L76" target="_blank" rel="external nofollow noopener noreferrer">RpcInvocation</a>&nbsp;æ„é€ æ–¹æ³•ã€‚ä»&nbsp;<code>Invocation#addAttachmentsIfAbsent(context)</code>&nbsp;æ–¹æ³•ï¼Œä¸å­˜åœ¨æ‰æ·»åŠ ï¼Œå› æ­¤ä¸šåŠ¡ä¸Šéšå¼ä¼ å‚çš„ KEY ä¸èƒ½å†²çªåˆ°è¿™å‡ ä¸ªã€‚</li>
<li>
<p>ç¬¬ 14 è‡³ 18 è¡Œï¼šæ·»åŠ <strong>è‡ªå®šä¹‰çš„</strong>éšå¼ä¼ å‚ï¼Œä»&nbsp;<code>RpcContext.attachments</code>&nbsp;ä¸­ã€‚ä½¿ç”¨ RpcContext éšå¼ä¼ å‚éœ€è¦æ³¨æ„ï¼š</p>
<blockquote>
<p>æ³¨æ„ï¼šRpcContext æ˜¯ä¸€ä¸ªä¸´æ—¶çŠ¶æ€è®°å½•å™¨ï¼Œå½“æ¥æ”¶åˆ° RPC è¯·æ±‚ï¼Œæˆ–å‘èµ· RPC è¯·æ±‚æ—¶ï¼ŒRpcContext çš„çŠ¶æ€éƒ½ä¼šå˜åŒ–ã€‚<br />æ¯”å¦‚ï¼šA è°ƒ Bï¼ŒB å†è°ƒ Cï¼Œåˆ™ B æœºå™¨ä¸Šï¼Œåœ¨ B è°ƒ C ä¹‹å‰ï¼ŒRpcContext è®°å½•çš„æ˜¯ A è°ƒ B çš„ä¿¡æ¯ï¼Œåœ¨ B è°ƒ C ä¹‹åï¼ŒRpcContext è®°å½•çš„æ˜¯ B è°ƒ C çš„ä¿¡æ¯ã€‚</p>
</blockquote>
</li>
<li>
<p>ç¬¬ 19 è‡³ 23 è¡Œï¼šå¼‚æ­¥æ–¹æ³•ï¼Œç›¸å…³çš„å¤„ç†ï¼Œåé¢æ–‡ç« åˆ†äº«ã€‚</p>
</li>
</ul>
</li>
<li>
<p>ç¬¬ 27 è¡Œï¼šè°ƒç”¨&nbsp;<code>#doInvoke(invocation)</code>&nbsp;<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå®ç°ä¸åŒåè®®è‡ªå®šä¹‰çš„è°ƒç”¨å®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> Result <span class="title">doInvoke</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable</span>;</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p>ç¬¬ 28 è‡³ 47 è¡Œï¼š// TODO ã€8023 biz exceptionã€‘</p>
</li>
</ul>
<p>çœ‹å®Œè¿™ä¸ªæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œä¸€æ¬¡ Dubbo RPC ï¼Œæ¶‰åŠåˆ°æŠ½è±¡æ¨¡å‹å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_10_01/03.png" alt="RPC" /></p>
<h2 id="4-5-InjvmInvoker">4.5 InjvmInvoker</h2>
<blockquote>
<p>æç¤ºï¼šå¯¹åº”å›¾ä¸­ [8]</p>
</blockquote>
<p><code>#doInvoke(invocation)</code>&nbsp;å®ç°æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Exporter é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * key: æœåŠ¡é”®</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * è¯¥å€¼å®é™…å°±æ˜¯ {<span class="doctag">@link</span> com.alibaba.dubbo.rpc.protocol.AbstractProtocol#exporterMap}</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Exporter&lt;?&gt;&gt; exporterMap;</span><br /><br /><span class="line">  <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> Result <span class="title">doInvoke</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> Throwable </span>{</span><br /><span class="line">  <span class="number">3</span>:     <span class="comment">// è·å¾— Exporter å¯¹è±¡</span></span><br /><span class="line">  <span class="number">4</span>:     Exporter&lt;?&gt; exporter = InjvmProtocol.getExporter(exporterMap, getUrl());</span><br /><span class="line">  <span class="number">5</span>:     <span class="keyword">if</span> (exporter == <span class="keyword">null</span>) {</span><br /><span class="line">  <span class="number">6</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Service ["</span> + key + <span class="string">"] not found."</span>);</span><br /><span class="line">  <span class="number">7</span>:     }</span><br /><span class="line">  <span class="number">8</span>:     <span class="comment">// è®¾ç½®æœåŠ¡æä¾›è€…åœ°å€ä¸ºæœ¬åœ°</span></span><br /><span class="line">  <span class="number">9</span>:     RpcContext.getContext().setRemoteAddress(NetUtils.LOCALHOST, <span class="number">0</span>);</span><br /><span class="line"> <span class="number">10</span>:     <span class="comment">// è°ƒç”¨</span></span><br /><span class="line"> <span class="number">11</span>:     <span class="keyword">return</span> exporter.getInvoker().invoke(invocation);</span><br /><span class="line"> <span class="number">12</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è‡³ 7 è¡Œï¼šè°ƒç”¨&nbsp;<code>InjvmProtocol#getExporter(exporterMap, url)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—å¯¹åº”çš„ Exporter å¯¹è±¡ã€‚åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/service-export-local/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡æš´éœ²ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°æš´éœ²ï¼ˆInjvmï¼‰ã€‹</a>&nbsp;ä¸­ï¼Œæˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼Œ<code>exporterMap</code>&nbsp;å±æ€§ï¼Œå°±æ˜¯ä» InjvmProtocol çš„&nbsp;<code>exporterMap</code>&nbsp;å±æ€§ã€‚
<ul>
<li>åœ¨è¿œç¨‹è°ƒç”¨ä¸­ï¼Œé€‰æ‹©æœåŠ¡æä¾›è€…çš„é€»è¾‘ä¼šæ›´åŠ å¤æ‚ï¼Œåç»­æ–‡ç« è§ã€‚</li>
</ul>
</li>
<li>ç¬¬ 9 è¡Œï¼šè®¾ç½®æœåŠ¡æä¾›è€…åœ°å€ä¸ºæœ¬åœ°ã€‚</li>
<li>ç¬¬ 11 è¡Œï¼šè·å¾—åˆ° Exporter å¯¹è±¡ï¼Œé‡Œé¢å°±æœ‰<strong>æœåŠ¡æä¾›è€…çš„ Invoker å¯¹è±¡</strong>ã€‚è°ƒç”¨&nbsp;<code>Invoker#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼Œè°ƒç”¨æœåŠ¡ã€‚</li>
</ul>
<h1 id="5-æä¾›è€…æä¾›æœåŠ¡">5. æä¾›è€…æä¾›æœåŠ¡</h1>
<h2 id="5-1-InjvmInvoker">5.1 InjvmInvoker</h2>
<blockquote>
<p>æç¤ºï¼šå¯¹åº”å›¾ä¸­ [1] [2]</p>
</blockquote>
<p>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/rpc-injvm/">ã€Œ4.5 InjvmInvokerã€</a>&nbsp;å·²ç»åˆ†äº«ã€‚</p>
<h2 id="5-2-ProtocolFilterWrapper">5.2 ProtocolFilterWrapper</h2>
<blockquote>
<p>æç¤ºï¼šå¯¹åº”å›¾ä¸­ [3] [4]</p>
</blockquote>
<p>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/rpc-injvm/">ã€Œ4.2 ProtocolFilterWrapperã€</a>&nbsp;åŸºæœ¬ä¸€è‡´ï¼Œå·®å¼‚ç‚¹åœ¨æœåŠ¡æ¶ˆè´¹è€…å’Œæä¾›è€…çš„è¿‡æ»¤å™¨æ˜¯<strong>ä¸åŒ</strong>çš„ã€‚</p>
<h2 id="5-3-DelegateProviderMetaDataInvoker">5.3 DelegateProviderMetaDataInvoker</h2>
<blockquote>
<p>æç¤ºï¼šå¯¹åº”å›¾ä¸­ [5]</p>
</blockquote>
<p>DelegateProviderMetaDataInvoker ï¼Œå¸¦æœ‰æœåŠ¡æä¾›è€…é…ç½® ServiceConfig çš„ Invoker å¯¹è±¡ã€‚ä»ç›®å‰ä»£ç ä¸Šæ¥çœ‹ï¼ŒServiceConfig æš‚æ—¶æ²¡ç”¨åˆ°ã€‚</p>
<p><code>#invoke(invocation)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Invoker&lt;T&gt; invoker;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æœåŠ¡æä¾›è€…é…ç½®</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> ServiceConfig metadata;</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">    <span class="keyword">return</span> invoker.invoke(invocation);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="5-4-Wrapper">5.4 Wrapper</h2>
<blockquote>
<p>æç¤ºï¼šå¯¹åº”å›¾ä¸­ [6] [7] [8] [9]</p>
</blockquote>
<p>è§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/proxy-javassist/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; åŠ¨æ€ä»£ç†ï¼ˆä¸€ï¼‰ä¹‹ Javassistã€‹</a>&nbsp;æ–‡ç« ã€‚</p>
</div>