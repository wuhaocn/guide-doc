<header class="article-header">
<h1 class="article-title">æœåŠ¡å¼•ç”¨ï¼ˆäºŒï¼‰ä¹‹è¿œç¨‹å¼•ç”¨ï¼ˆDubboï¼‰</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/reference-refer-local/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡å¼•ç”¨ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°å¼•ç”¨ï¼ˆInjvmï¼‰ã€‹</a>&nbsp;ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬å·²ç»åˆ†äº«äº†<strong>æœ¬åœ°å¼•ç”¨æœåŠ¡</strong>ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬æ¥åˆ†äº«<strong>è¿œç¨‹å¼•ç”¨æœåŠ¡</strong>ã€‚åœ¨ Dubbo ä¸­æä¾›å¤šç§åè®®( Protocol ) çš„å®ç°ï¼Œå¤§ä½“æµç¨‹ä¸€è‡´ï¼Œæœ¬æ–‡ä»¥&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/dubbo.html" target="_blank" rel="external nofollow noopener noreferrer">Dubbo Protocol</a>&nbsp;ä¸ºä¾‹å­ï¼Œè¿™ä¹Ÿæ˜¯ Dubbo çš„<strong>é»˜è®¤</strong>åè®®ã€‚</p>
<p>å¦‚æœä¸ç†Ÿæ‚‰è¯¥åè®®çš„åŒå­¦ï¼Œå¯ä»¥å…ˆçœ‹çœ‹&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/references/protocol/dubbo.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ä½¿ç”¨æŒ‡å— &mdash;&mdash; dubbo://ã€‹</a>&nbsp;ï¼Œç®€å•äº†è§£å³å¯ã€‚</p>
<blockquote>
<p><strong>ç‰¹æ€§</strong></p>
<p>ç¼ºçœåè®®ï¼Œä½¿ç”¨åŸºäº mina&nbsp;<code>1.1.7</code>&nbsp;å’Œ hessian&nbsp;<code>3.2.1</code>&nbsp;çš„ remoting äº¤äº’ã€‚</p>
<ul>
<li>è¿æ¥ä¸ªæ•°ï¼šå•è¿æ¥</li>
<li>è¿æ¥æ–¹å¼ï¼šé•¿è¿æ¥</li>
<li>ä¼ è¾“åè®®ï¼šTCP</li>
<li>ä¼ è¾“æ–¹å¼ï¼šNIO å¼‚æ­¥ä¼ è¾“</li>
<li>åºåˆ—åŒ–ï¼šHessian äºŒè¿›åˆ¶åºåˆ—åŒ–</li>
<li>é€‚ç”¨èŒƒå›´ï¼šä¼ å…¥ä¼ å‡ºå‚æ•°æ•°æ®åŒ…è¾ƒå°ï¼ˆå»ºè®®å°äº100Kï¼‰ï¼Œæ¶ˆè´¹è€…æ¯”æä¾›è€…ä¸ªæ•°å¤šï¼Œå•ä¸€æ¶ˆè´¹è€…æ— æ³•å‹æ»¡æä¾›è€…ï¼Œå°½é‡ä¸è¦ç”¨ dubbo åè®®ä¼ è¾“å¤§æ–‡ä»¶æˆ–è¶…å¤§å­—ç¬¦ä¸²ã€‚</li>
<li>é€‚ç”¨åœºæ™¯ï¼šå¸¸è§„è¿œç¨‹æœåŠ¡æ–¹æ³•è°ƒç”¨</li>
</ul>
</blockquote>
<p>ç›¸æ¯”<strong>æœ¬åœ°å¼•ç”¨</strong>ï¼Œ<strong>è¿œç¨‹å¼•ç”¨</strong>ä¼šå¤šåšå¦‚ä¸‹å‡ ä»¶äº‹æƒ…ï¼š</p>
<ul>
<li>å‘æ³¨å†Œä¸­å¿ƒ<strong>è®¢é˜…</strong>ï¼Œä»è€Œ<strong>å‘ç°</strong>æœåŠ¡æä¾›è€…åˆ—è¡¨ã€‚</li>
<li>å¯åŠ¨é€šä¿¡å®¢æˆ·ç«¯ï¼Œé€šè¿‡å®ƒè¿›è¡Œ<strong>è¿œç¨‹è°ƒç”¨</strong>ã€‚</li>
</ul>
<h1 id="2-è¿œç¨‹å¼•ç”¨">2. è¿œç¨‹å¼•ç”¨</h1>
<p>è¿œç¨‹æš´éœ²æœåŠ¡çš„é¡ºåºå›¾å¦‚ä¸‹ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_05_04/02.png" alt="è¿œç¨‹å¼•ç”¨é¡ºåºå›¾" /></p>
<p>åœ¨&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/c635dd1990a1803643194048f408db310f06175b/dubbo-config/dubbo-config-api/src/main/java/com/alibaba/dubbo/config/ServiceConfig.java#L621-L648" target="_blank" rel="external nofollow noopener noreferrer"><code>#createProxy(map)</code></a>&nbsp;æ–¹æ³•ä¸­ï¼Œæ¶‰åŠ<strong>è¿œç¨‹å¼•ç”¨æœåŠ¡</strong>çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * æœåŠ¡å¼•ç”¨ URL æ•°ç»„</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;URL&gt; urls = <span class="keyword">new</span> ArrayList&lt;URL&gt;();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * ç›´è¿æœåŠ¡åœ°å€</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * 1. å¯ä»¥æ˜¯æ³¨å†Œä¸­å¿ƒï¼Œä¹Ÿå¯ä»¥æ˜¯æœåŠ¡æä¾›è€…</span></span><br /><span class="line"><span class="comment"> * 2. å¯é…ç½®å¤šä¸ªï¼Œä½¿ç”¨ ; åˆ†éš”</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="comment">// url for peer-to-peer invocation</span></span><br /><span class="line"><span class="keyword">private</span> String url;</span><br /><br /><span class="line">  <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">  2:  * åˆ›å»º Service ä»£ç†å¯¹è±¡</span></span><br /><span class="line"><span class="comment">  3:  *</span></span><br /><span class="line"><span class="comment">  4:  * <span class="doctag">@param</span> map é›†åˆ</span></span><br /><span class="line"><span class="comment">  5:  * <span class="doctag">@return</span> ä»£ç†å¯¹è±¡</span></span><br /><span class="line"><span class="comment">  6:  */</span></span><br /><span class="line">  <span class="number">7</span>: <span class="meta">@SuppressWarnings</span>({<span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span>, <span class="string">"deprecation"</span>})</span><br /><span class="line">  <span class="number">8</span>: <span class="function"><span class="keyword">private</span> T <span class="title">createProxy</span><span class="params">(Map&lt;String, String&gt; map)</span> </span>{</span><br /><span class="line">  <span class="number">9</span>:     URL tmpUrl = <span class="keyword">new</span> URL(<span class="string">"temp"</span>, <span class="string">"localhost"</span>, <span class="number">0</span>, map);</span><br /><span class="line"> <span class="number">10</span>:     <span class="comment">// ã€çœç•¥ä»£ç ã€‘æ˜¯å¦æœ¬åœ°å¼•ç”¨</span></span><br /><span class="line"> <span class="number">11</span>:     <span class="keyword">final</span> <span class="keyword">boolean</span> isJvmRefer;</span><br /><span class="line"> <span class="number">12</span>: </span><br /><span class="line"> <span class="number">13</span>:     <span class="comment">// ã€çœç•¥ä»£ç ã€‘æœ¬åœ°å¼•ç”¨</span></span><br /><span class="line"> <span class="number">14</span>:     <span class="keyword">if</span> (isJvmRefer) {</span><br /><span class="line"> <span class="number">15</span>:     <span class="comment">// æ­£å¸¸æµç¨‹ï¼Œä¸€èˆ¬ä¸ºè¿œç¨‹å¼•ç”¨</span></span><br /><span class="line"> <span class="number">16</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">17</span>:         <span class="comment">// å®šä¹‰ç›´è¿åœ°å€ï¼Œå¯ä»¥æ˜¯æœåŠ¡æä¾›è€…çš„åœ°å€ï¼Œä¹Ÿå¯ä»¥æ˜¯æ³¨å†Œä¸­å¿ƒçš„åœ°å€</span></span><br /><span class="line"> <span class="number">18</span>:         <span class="keyword">if</span> (url != <span class="keyword">null</span> &amp;&amp; url.length() &gt; <span class="number">0</span>) { <span class="comment">// user specified URL, could be peer-to-peer address, or register center's address.</span></span><br /><span class="line"> <span class="number">19</span>:             <span class="comment">// æ‹†åˆ†åœ°å€æˆæ•°ç»„ï¼Œä½¿ç”¨ ";" åˆ†éš”ã€‚</span></span><br /><span class="line"> <span class="number">20</span>:             String[] us = Constants.SEMICOLON_SPLIT_PATTERN.split(url);</span><br /><span class="line"> <span class="number">21</span>:             <span class="comment">// å¾ªç¯æ•°ç»„ï¼Œæ·»åŠ åˆ° `url` ä¸­ã€‚</span></span><br /><span class="line"> <span class="number">22</span>:             <span class="keyword">if</span> (us != <span class="keyword">null</span> &amp;&amp; us.length &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">23</span>:                 <span class="keyword">for</span> (String u : us) {</span><br /><span class="line"> <span class="number">24</span>:                     <span class="comment">// åˆ›å»º URL å¯¹è±¡</span></span><br /><span class="line"> <span class="number">25</span>:                     URL url = URL.valueOf(u);</span><br /><span class="line"> <span class="number">26</span>:                     <span class="comment">// è®¾ç½®é»˜è®¤è·¯å¾„</span></span><br /><span class="line"> <span class="number">27</span>:                     <span class="keyword">if</span> (url.getPath() == <span class="keyword">null</span> || url.getPath().length() == <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">28</span>:                         url = url.setPath(interfaceName);</span><br /><span class="line"> <span class="number">29</span>:                     }</span><br /><span class="line"> <span class="number">30</span>:                     <span class="comment">// æ³¨å†Œä¸­å¿ƒçš„åœ°å€ï¼Œå¸¦ä¸ŠæœåŠ¡å¼•ç”¨çš„é…ç½®å‚æ•°</span></span><br /><span class="line"> <span class="number">31</span>:                     <span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) {</span><br /><span class="line"> <span class="number">32</span>:                         urls.add(url.addParameterAndEncoded(Constants.REFER_KEY, StringUtils.toQueryString(map)));</span><br /><span class="line"> <span class="number">33</span>:                     <span class="comment">// æœåŠ¡æä¾›è€…çš„åœ°å€</span></span><br /><span class="line"> <span class="number">34</span>:                     } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">35</span>:                         urls.add(ClusterUtils.mergeUrl(url, map));</span><br /><span class="line"> <span class="number">36</span>:                     }</span><br /><span class="line"> <span class="number">37</span>:                 }</span><br /><span class="line"> <span class="number">38</span>:             }</span><br /><span class="line"> <span class="number">39</span>:         <span class="comment">// æ³¨å†Œä¸­å¿ƒ</span></span><br /><span class="line"> <span class="number">40</span>:         } <span class="keyword">else</span> { <span class="comment">// assemble URL from register center's configuration</span></span><br /><span class="line"> <span class="number">41</span>:             <span class="comment">// åŠ è½½æ³¨å†Œä¸­å¿ƒ URL æ•°ç»„</span></span><br /><span class="line"> <span class="number">42</span>:             List&lt;URL&gt; us = loadRegistries(<span class="keyword">false</span>);</span><br /><span class="line"> <span class="number">43</span>:             <span class="comment">// å¾ªç¯æ•°ç»„ï¼Œæ·»åŠ åˆ° `url` ä¸­ã€‚</span></span><br /><span class="line"> <span class="number">44</span>:             <span class="keyword">if</span> (us != <span class="keyword">null</span> &amp;&amp; !us.isEmpty()) {</span><br /><span class="line"> <span class="number">45</span>:                 <span class="keyword">for</span> (URL u : us) {</span><br /><span class="line"> <span class="number">46</span>:                     <span class="comment">// åŠ è½½ç›‘æ§ä¸­å¿ƒ URL</span></span><br /><span class="line"> <span class="number">47</span>:                     URL monitorUrl = loadMonitor(u);</span><br /><span class="line"> <span class="number">48</span>:                     <span class="comment">// æœåŠ¡å¼•ç”¨é…ç½®å¯¹è±¡ `map`ï¼Œå¸¦ä¸Šç›‘æ§ä¸­å¿ƒçš„ URL</span></span><br /><span class="line"> <span class="number">49</span>:                     <span class="keyword">if</span> (monitorUrl != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">50</span>:                         map.put(Constants.MONITOR_KEY, URL.encode(monitorUrl.toFullString()));</span><br /><span class="line"> <span class="number">51</span>:                     }</span><br /><span class="line"> <span class="number">52</span>:                     <span class="comment">// æ³¨å†Œä¸­å¿ƒçš„åœ°å€ï¼Œå¸¦ä¸ŠæœåŠ¡å¼•ç”¨çš„é…ç½®å‚æ•°</span></span><br /><span class="line"> <span class="number">53</span>:                     urls.add(u.addParameterAndEncoded(Constants.REFER_KEY, StringUtils.toQueryString(map))); <span class="comment">// æ³¨å†Œä¸­å¿ƒï¼Œå¸¦ä¸ŠæœåŠ¡å¼•ç”¨çš„é…ç½®å‚æ•°</span></span><br /><span class="line"> <span class="number">54</span>:                 }</span><br /><span class="line"> <span class="number">55</span>:             }</span><br /><span class="line"> <span class="number">56</span>:             <span class="keyword">if</span> (urls == <span class="keyword">null</span> || urls.isEmpty()) {</span><br /><span class="line"> <span class="number">57</span>:                 <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"No such any registry to reference "</span> + interfaceName + <span class="string">" on the consumer "</span> + NetUtils.getLocalHost() + <span class="string">" use dubbo version "</span> + Version.getVersion() + <span class="string">", please config &lt;dubbo:registry address=\"...\" /&gt; to your spring config."</span>);</span><br /><span class="line"> <span class="number">58</span>:             }</span><br /><span class="line"> <span class="number">59</span>:         }</span><br /><span class="line"> <span class="number">60</span>: </span><br /><span class="line"> <span class="number">61</span>:         <span class="comment">// å• `urls` æ—¶ï¼Œå¼•ç”¨æœåŠ¡ï¼Œè¿”å› Invoker å¯¹è±¡</span></span><br /><span class="line"> <span class="number">62</span>:         <span class="keyword">if</span> (urls.size() == <span class="number">1</span>) {</span><br /><span class="line"> <span class="number">63</span>:             <span class="comment">// å¼•ç”¨æœåŠ¡</span></span><br /><span class="line"> <span class="number">64</span>:             invoker = refprotocol.refer(interfaceClass, urls.get(<span class="number">0</span>));</span><br /><span class="line"> <span class="number">65</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">66</span>:             <span class="comment">// å¾ªç¯ `urls` ï¼Œå¼•ç”¨æœåŠ¡ï¼Œè¿”å› Invoker å¯¹è±¡</span></span><br /><span class="line"> <span class="number">67</span>:             List&lt;Invoker&lt;?&gt;&gt; invokers = <span class="keyword">new</span> ArrayList&lt;Invoker&lt;?&gt;&gt;();</span><br /><span class="line"> <span class="number">68</span>:             URL registryURL = <span class="keyword">null</span>;</span><br /><span class="line"> <span class="number">69</span>:             <span class="keyword">for</span> (URL url : urls) {</span><br /><span class="line"> <span class="number">70</span>:                 <span class="comment">// å¼•ç”¨æœåŠ¡</span></span><br /><span class="line"> <span class="number">71</span>:                 invokers.add(refprotocol.refer(interfaceClass, url));</span><br /><span class="line"> <span class="number">72</span>:                 <span class="comment">// ä½¿ç”¨æœ€åä¸€ä¸ªæ³¨å†Œä¸­å¿ƒçš„ URL</span></span><br /><span class="line"> <span class="number">73</span>:                 <span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) {</span><br /><span class="line"> <span class="number">74</span>:                     registryURL = url; <span class="comment">// use last registry url</span></span><br /><span class="line"> <span class="number">75</span>:                 }</span><br /><span class="line"> <span class="number">76</span>:             }</span><br /><span class="line"> <span class="number">77</span>:             <span class="comment">// æœ‰æ³¨å†Œä¸­å¿ƒ</span></span><br /><span class="line"> <span class="number">78</span>:             <span class="keyword">if</span> (registryURL != <span class="keyword">null</span>) { <span class="comment">// registry url is available</span></span><br /><span class="line"> <span class="number">79</span>:                 <span class="comment">// å¯¹æœ‰æ³¨å†Œä¸­å¿ƒçš„ Cluster åªç”¨ AvailableCluster</span></span><br /><span class="line"> <span class="number">80</span>:                 <span class="comment">// use AvailableCluster only when register's cluster is available</span></span><br /><span class="line"> <span class="number">81</span>:                 URL u = registryURL.addParameter(Constants.CLUSTER_KEY, AvailableCluster.NAME);</span><br /><span class="line"> <span class="number">83</span>:                 invoker = cluster.join(<span class="keyword">new</span> StaticDirectory(u, invokers));</span><br /><span class="line"> <span class="number">84</span>:             <span class="comment">// æ— æ³¨å†Œä¸­å¿ƒ</span></span><br /><span class="line"> <span class="number">85</span>:             } <span class="keyword">else</span> { <span class="comment">// not a registry url</span></span><br /><span class="line"> <span class="number">87</span>:                 invoker = cluster.join(<span class="keyword">new</span> StaticDirectory(invokers));</span><br /><span class="line"> <span class="number">88</span>:             }</span><br /><span class="line"> <span class="number">89</span>:         }</span><br /><span class="line"> <span class="number">90</span>:     }</span><br /><span class="line"> <span class="number">91</span>: </span><br /><span class="line"> <span class="number">92</span>:     <span class="comment">// ã€çœç•¥ä»£ç ã€‘å¯åŠ¨æ—¶æ£€æŸ¥</span></span><br /><span class="line"> <span class="number">93</span>: </span><br /><span class="line"> <span class="number">94</span>:     <span class="comment">// åˆ›å»º Service ä»£ç†å¯¹è±¡</span></span><br /><span class="line"> <span class="number">95</span>:     <span class="comment">// create service proxy</span></span><br /><span class="line"> <span class="number">96</span>:     <span class="keyword">return</span> (T) proxyFactory.getProxy(invoker);</span><br /><span class="line"> <span class="number">97</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 11 è¡Œï¼šçœç•¥<strong>æ˜¯å¦æœ¬åœ°å¼•ç”¨</strong>çš„ä»£ç ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/reference-refer-local/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡å¼•ç”¨ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°å¼•ç”¨ï¼ˆInjvmï¼‰ã€‹</a>&nbsp;å·²ç»æœ‰åˆ†äº«ã€‚</li>
<li>ç¬¬ 13 è‡³ 15 è¡Œï¼šçœç•¥<strong>æœ¬åœ°å¼•ç”¨</strong>çš„ä»£ç ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/reference-refer-local/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡å¼•ç”¨ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°å¼•ç”¨ï¼ˆInjvmï¼‰ã€‹</a>&nbsp;å·²ç»æœ‰åˆ†äº«ã€‚</li>
<li>ç¬¬ 16 è‡³ 90 è¡Œï¼šæ­£å¸¸æµç¨‹ï¼Œä¸€èˆ¬ä¸ºè¿œç¨‹å¼•ç”¨ã€‚</li>
<li>ç¬¬ 18 è‡³ 38 è¡Œï¼š<code>url</code>&nbsp;é…ç½®é¡¹ï¼Œ<strong>å®šä¹‰ç›´è¿åœ°å€</strong>ï¼Œå¯ä»¥æ˜¯æœåŠ¡æä¾›è€…çš„åœ°å€ï¼Œä¹Ÿå¯ä»¥æ˜¯æ³¨å†Œä¸­å¿ƒçš„åœ°å€ã€‚
<ul>
<li>ç¬¬ 20 è¡Œï¼šæ‹†åˆ†åœ°å€æˆæ•°ç»„ï¼Œä½¿ç”¨ &ldquo;;&rdquo; åˆ†éš”ã€‚</li>
<li>ç¬¬ 22 è‡³ 23 è¡Œï¼šå¾ªç¯æ•°ç»„&nbsp;<code>us</code>&nbsp;ï¼Œåˆ›å»º URL å¯¹è±¡åï¼Œæ·»åŠ åˆ°&nbsp;<code>urls</code>&nbsp;ä¸­ã€‚</li>
<li>ç¬¬ 25 è¡Œï¼šåˆ›å»º URL å¯¹è±¡ã€‚</li>
<li>ç¬¬ 26 è‡³ 29 è¡Œï¼šè·¯å¾„å±æ€§&nbsp;<code>url.path</code>&nbsp;æœªè®¾ç½®æ—¶ï¼Œç¼ºçœä½¿ç”¨æ¥å£å…¨å&nbsp;<code>interfaceName</code>&nbsp;ã€‚</li>
<li>ç¬¬ 30 è‡³ 32 è¡Œï¼šè‹¥&nbsp;<code>url.protocol = registry</code>&nbsp;æ—¶ï¼Œ<strong>æ³¨å†Œä¸­å¿ƒçš„åœ°å€</strong>ï¼Œåœ¨å‚æ•°&nbsp;<code>url.parameters.refer</code>ä¸Šï¼Œè®¾ç½®ä¸ŠæœåŠ¡å¼•ç”¨çš„é…ç½®å‚æ•°é›†åˆ&nbsp;<code>map</code>&nbsp;ã€‚</li>
<li>ç¬¬ 33 è‡³ 36 è¡Œï¼š<strong>æœåŠ¡æä¾›è€…çš„åœ°å€</strong>ã€‚
<ul>
<li>ä»é€»è¾‘ä¸Šç±»ä¼¼ã€ç¬¬ 53 è¡Œã€‘çš„ä»£ç ã€‚</li>
<li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸å»ºè®®è¿™æ ·åœ¨&nbsp;<code>url</code>&nbsp;é…ç½®æ³¨å†Œä¸­å¿ƒï¼Œè€Œæ˜¯åœ¨&nbsp;<code>registry</code>&nbsp;é…ç½®ã€‚å¦‚æœè¦é…ç½®ï¼Œæ ¼å¼ä¸º&nbsp;<code>registry://host:port?registry=</code>&nbsp;ï¼Œä¾‹å¦‚&nbsp;<code>registry://127.0.0.1?registry=zookeeper</code>&nbsp;ã€‚</li>
<li>TODO ClusterUtils.mergeUrl</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 39 è‡³ 59 è¡Œï¼š<code>protocol</code>&nbsp;é…ç½®é¡¹ï¼Œ<strong>æ³¨å†Œä¸­å¿ƒ</strong>ã€‚
<ul>
<li>ç¬¬ 42 è¡Œï¼šè°ƒç”¨&nbsp;<code>#loadRegistries(provider)</code>&nbsp;æ–¹æ³•ï¼ŒåŠ è½½æ³¨å†Œä¸­å¿ƒçš„ com.alibaba.dubbo.common.URL` æ•°ç»„ã€‚
<ul>
<li>ğŸ™‚ åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/service-export-local/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡æš´éœ²ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°æš´éœ²ï¼ˆInjvmï¼‰ã€‹ã€Œ2.1 loadRegistriesã€</a>&nbsp;è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>ç¬¬ 43 è‡³ 58 è¡Œï¼šå¾ªç¯æ•°ç»„&nbsp;<code>us</code>&nbsp;ï¼Œåˆ›å»º URL å¯¹è±¡åï¼Œæ·»åŠ åˆ°&nbsp;<code>urls</code>&nbsp;ä¸­ã€‚
<ul>
<li>ç¬¬ 47 è¡Œï¼šè°ƒç”¨&nbsp;<code>#loadMonitor(registryURL)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—ç›‘æ§ä¸­å¿ƒ URL ã€‚
<ul>
<li>ğŸ™‚ åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/reference-refer-dubbo/">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡æš´éœ²ï¼ˆäºŒï¼‰ä¹‹è¿œç¨‹æš´éœ²ï¼ˆDubboï¼‰ã€‹ã€Œ2.1 loadRegistriesã€</a>&nbsp;å°èŠ‚ï¼Œè¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>ç¬¬ 49 è‡³ 51 è¡Œï¼šæœåŠ¡å¼•ç”¨é…ç½®å¯¹è±¡&nbsp;<code>map</code>ï¼Œå¸¦ä¸Šç›‘æ§ä¸­å¿ƒçš„ URL ã€‚å…·ä½“ç”¨é€”ï¼Œæˆ‘ä»¬åœ¨åé¢åˆ†äº«ç›‘æ§ä¸­å¿ƒä¼šçœ‹åˆ°ã€‚</li>
<li>ç¬¬ 53 è¡Œï¼šè°ƒç”¨&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/c635dd1990a1803643194048f408db310f06175b/dubbo-common/src/main/java/com/alibaba/dubbo/common/URL.java#L891-L896" target="_blank" rel="external nofollow noopener noreferrer"><code>URL#addParameterAndEncoded(key, value)</code></a>&nbsp;æ–¹æ³•ï¼Œå°†æœåŠ¡å¼•ç”¨é…ç½®å¯¹è±¡å‚æ•°é›†åˆ&nbsp;<code>map</code>&nbsp;ï¼Œä½œä¸º&nbsp;<code>"refer"</code>&nbsp;å‚æ•°æ·»åŠ åˆ°æ³¨å†Œä¸­å¿ƒçš„ URL ä¸­ï¼Œ<strong>å¹¶ä¸”éœ€è¦ç¼–ç </strong>ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œæ³¨å†Œä¸­å¿ƒçš„ URL ä¸­ï¼Œ<strong>åŒ…å«äº†æœåŠ¡å¼•ç”¨çš„é…ç½®</strong>ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ç¬¬ 61 è‡³ 64 è¡Œï¼šå•&nbsp;<code>urls</code>&nbsp;æ—¶ï¼Œ<strong>ç›´æ¥è°ƒç”¨</strong>&nbsp;<code>Protocol#refer(type, url)</code>&nbsp;æ–¹æ³•ï¼Œå¼•ç”¨æœåŠ¡ï¼Œè¿”å› Invoker å¯¹è±¡ã€‚</p>
<ul>
<li>æ­¤å¤„ Dubbo SPI&nbsp;<strong>è‡ªé€‚åº”</strong>çš„ç‰¹æ€§çš„<strong>å¥½å¤„</strong>å°±å‡ºæ¥äº†ï¼Œå¯ä»¥<strong>è‡ªåŠ¨</strong>æ ¹æ® URL å‚æ•°ï¼Œè·å¾—å¯¹åº”çš„æ‹“å±•å®ç°ã€‚ä¾‹å¦‚ï¼Œ<code>invoker</code>ä¼ å…¥åï¼Œæ ¹æ®&nbsp;<code>invoker.url</code>&nbsp;è‡ªåŠ¨è·å¾—å¯¹åº” Protocol æ‹“å±•å®ç°ä¸º DubboProtocol ã€‚</li>
<li>
<p>å®é™…ä¸Šï¼ŒProtocol æœ‰ä¸¤ä¸ª Wrapper æ‹“å±•å®ç°ç±»ï¼š ProtocolFilterWrapperã€ProtocolListenerWrapper ã€‚æ‰€ä»¥ï¼Œ<code>#export(...)</code>&nbsp;æ–¹æ³•çš„è°ƒç”¨é¡ºåºæ˜¯ï¼š</p>
<ul>
<li><strong>Protocol$Adaptive =&gt; ProtocolFilterWrapper =&gt; ProtocolListenerWrapper =&gt; RegistryProtocol</strong></li>
<li>=&gt;</li>
<li><strong>Protocol$Adaptive =&gt; ProtocolFilterWrapper =&gt; ProtocolListenerWrapper =&gt; DubboProtocol</strong></li>
<li>ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>è¿™ä¸€æ¡å¤§çš„è°ƒç”¨é“¾ï¼ŒåŒ…å«ä¸¤æ¡å°çš„è°ƒç”¨é“¾</strong>ã€‚åŸå› æ˜¯ï¼š
<ul>
<li>é¦–å…ˆï¼Œä¼ å…¥çš„æ˜¯æ³¨å†Œä¸­å¿ƒçš„ URL ï¼Œé€šè¿‡ Protocol$Adaptive è·å–åˆ°çš„æ˜¯ RegistryProtocol å¯¹è±¡ã€‚</li>
<li>å…¶æ¬¡ï¼ŒRegistryProtocol ä¼šåœ¨å…¶&nbsp;<code>#refer(...)</code>&nbsp;æ–¹æ³•ä¸­ï¼Œä½¿ç”¨æœåŠ¡æä¾›è€…çš„ URL ( å³æ³¨å†Œä¸­å¿ƒçš„ URL çš„&nbsp;<code>refer</code>&nbsp;å‚æ•°å€¼)ï¼Œå†æ¬¡è°ƒç”¨ Protocol$Adaptive è·å–åˆ°çš„æ˜¯ DubboProtocol å¯¹è±¡ï¼Œè¿›è¡ŒæœåŠ¡æš´éœ²ã€‚</li>
</ul>
</li>
<li>
<p><strong>ä¸ºä»€ä¹ˆæ˜¯è¿™æ ·çš„é¡ºåº</strong>ï¼Ÿé€šè¿‡è¿™æ ·çš„é¡ºåºï¼Œå¯ä»¥å®ç°ç±»ä¼¼&nbsp;<strong>AOP</strong>&nbsp;çš„æ•ˆæœï¼Œåœ¨è·å–æœåŠ¡æä¾›è€…åˆ—è¡¨åï¼Œå†åˆ›å»ºè¿æ¥æœåŠ¡æä¾›è€…çš„å®¢æˆ·ç«¯ã€‚ä¼ªä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line">RegistryProtocol#refer(...) {</span><br />    <br /><span class="line">    <span class="comment">// 1. è·å–æœåŠ¡æä¾›è€…åˆ—è¡¨ ã€å¹¶ä¸”è®¢é˜…ã€‘</span></span><br />    <br /><span class="line">    <span class="comment">// 2. åˆ›å»ºè°ƒç”¨è¿æ¥æœåŠ¡æä¾›è€…çš„å®¢æˆ·ç«¯ </span></span><br /><span class="line">    DubboProtocol#refer(...);</span><br />    <br /><span class="line">    <span class="comment">// psï¼šå®é™…è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œè¿˜æœ‰åˆ«çš„ä»£ç ï¼Œè¯¦ç»†è§ä¸‹æ–‡ã€‚</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>x</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ç¬¬ 65 è‡³ 89 è¡Œï¼šå¤š&nbsp;<code>urls</code>&nbsp;æ—¶ï¼Œ<strong>å¾ªç¯è°ƒç”¨</strong>&nbsp;<code>Protocol#refer(type, url)</code>&nbsp;æ–¹æ³•ï¼Œå¼•ç”¨æœåŠ¡ï¼Œè¿”å› Invoker å¯¹è±¡ã€‚æ­¤æ—¶ï¼Œä¼šæœ‰å¤šä¸ª Invoker å¯¹è±¡ï¼Œéœ€è¦è¿›è¡Œåˆå¹¶ã€‚</p>
<ul>
<li>ä»€ä¹ˆæ—¶å€™ä¼šå‡ºç°å¤šä¸ª&nbsp;<code>urls</code>&nbsp;å‘¢ï¼Ÿä¾‹å¦‚ï¼š<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/multi-registry.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; å¤šæ³¨å†Œä¸­å¿ƒæ³¨å†Œã€‹</a>&nbsp;ã€‚</li>
<li>ç¬¬ 66 è‡³ 76 è¡Œï¼šå¾ªç¯&nbsp;<code>urls</code>&nbsp;ï¼Œå¼•ç”¨æœåŠ¡ã€‚
<ul>
<li>ç¬¬ 71 è¡Œï¼šè°ƒç”¨&nbsp;<code>Protocol#refer(type, url)</code>&nbsp;æ–¹æ³•ï¼Œå¼•ç”¨æœåŠ¡ï¼Œè¿”å› Invoker å¯¹è±¡ã€‚ç„¶åï¼Œæ·»åŠ åˆ°&nbsp;<code>invokers</code>&nbsp;ä¸­ã€‚</li>
<li>ç¬¬ 72 ä¼š 75 è¡Œï¼šä½¿ç”¨æœ€åä¸€ä¸ªæ³¨å†Œä¸­å¿ƒçš„ URL ï¼Œèµ‹å€¼åˆ°&nbsp;<code>registryURL</code>&nbsp;ã€‚</li>
</ul>
</li>
<li>ç¬¬ 77 è‡³ 88 è¡Œï¼šè¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-3-impl-directory/?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆä¸‰ï¼‰ä¹‹ Directory å®ç°ã€‹</a>&nbsp;ã€‚</li>
</ul>
</li>
<li>ç¬¬ 92 è¡Œï¼šçœç•¥<strong>å¯åŠ¨æ—¶æ£€æŸ¥</strong>çš„ä»£ç ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/reference-refer-local/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡å¼•ç”¨ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°å¼•ç”¨ï¼ˆInjvmï¼‰ã€‹</a>&nbsp;å·²ç»æœ‰åˆ†äº«ã€‚</li>
<li>ç¬¬ 96 è¡Œï¼šçœç•¥<strong>åˆ›å»º Service ä»£ç†å¯¹è±¡</strong>çš„ä»£ç ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/reference-refer-local/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡å¼•ç”¨ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°å¼•ç”¨ï¼ˆInjvmï¼‰ã€‹</a>&nbsp;å·²ç»æœ‰åˆ†äº«ã€‚</li>
</ul>
<h1 id="3-Protocol">3. Protocol</h1>
<p><strong>æœåŠ¡å¼•ç”¨ä¸æš´éœ²çš„ Protocol å¾ˆå¤šç±»ä¼¼ç‚¹</strong>ï¼Œæœ¬æ–‡å°±ä¸é‡å¤å™è¿°äº†ã€‚</p>
<p>å»ºè®®ä¸ç†Ÿæ‚‰çš„èƒ–å‹ï¼Œè¯·ç‚¹å‡»&nbsp;<a href="http://svip.iocoder.cn/Dubbo/service-export-local/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡æš´éœ²ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°æš´éœ²ï¼ˆInjvmï¼‰ã€‹ã€Œ3. Protocolã€</a>&nbsp;æŸ¥çœ‹ã€‚</p>
<p>æœ¬æ–‡æ¶‰åŠçš„ Protocol ç±»å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_05_04/03.png" alt="Protocol ç±»å›¾" /></p>
<h2 id="3-1-ProtocolFilterWrapper">3.1 ProtocolFilterWrapper</h2>
<p>æ¥&nbsp;<a href="http://svip.iocoder.cn/Dubbo/service-reference-local/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡å¼•ç”¨ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°å¼•ç”¨ï¼ˆInjvmï¼‰ã€‹ã€Œ 3.1 ProtocolFilterWrapperã€</a>å°èŠ‚ã€‚</p>
<p>æœ¬æ–‡æ¶‰åŠçš„&nbsp;<code>#refer(type, url)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="number">1</span>: <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line"><span class="number">2</span>:     <span class="comment">// æ³¨å†Œä¸­å¿ƒ</span></span><br /><span class="line"><span class="number">3</span>:     <span class="keyword">if</span> (Constants.REGISTRY_PROTOCOL.equals(url.getProtocol())) {</span><br /><span class="line"><span class="number">4</span>:         <span class="keyword">return</span> protocol.refer(type, url);</span><br /><span class="line"><span class="number">5</span>:     }</span><br /><span class="line"><span class="number">6</span>:     <span class="comment">// å¼•ç”¨æœåŠ¡ï¼Œè¿”å› Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="number">7</span>:     <span class="comment">// ç»™æ”¹ Invoker å¯¹è±¡ï¼ŒåŒ…è£…æˆå¸¦æœ‰ Filter è¿‡æ»¤é“¾çš„ Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="number">8</span>:     <span class="keyword">return</span> buildInvokerChain(protocol.refer(type, url), Constants.REFERENCE_FILTER_KEY, Constants.CONSUMER);</span><br /><span class="line"><span class="number">9</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 2 è‡³ 5 è¡Œï¼šå½“&nbsp;<code>invoker.url.protocl = registry</code>&nbsp;ï¼Œ<strong>æ³¨å†Œä¸­å¿ƒçš„ URL</strong>&nbsp;ï¼Œæ— éœ€åˆ›å»º Filter è¿‡æ»¤é“¾ã€‚</li>
<li>ç¬¬ 8 è¡Œï¼šè°ƒç”¨&nbsp;<code>protocol#refer(type, url)</code>&nbsp;æ–¹æ³•ï¼Œç»§ç»­å¼•ç”¨æœåŠ¡ï¼Œæœ€ç»ˆè¿”å› Invoker ã€‚</li>
<li>ç¬¬ 8 è¡Œï¼šåœ¨å¼•ç”¨æœåŠ¡å®Œæˆåï¼Œè°ƒç”¨&nbsp;<code>#buildInvokerChain(invoker, key, group)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºå¸¦æœ‰ Filter è¿‡æ»¤é“¾çš„ Invoker å¯¹è±¡ã€‚</li>
</ul>
<h2 id="3-2-RegistryProtocol">3.2 RegistryProtocol</h2>
<h3 id="3-2-1-refer">3.2.1 refer</h3>
<p>æœ¬æ–‡æ¶‰åŠçš„&nbsp;<code>#refer(type, url)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Cluster è‡ªé€‚åº”æ‹“å±•å®ç°ç±»å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Cluster cluster;</span><br /><br /><span class="line">  <span class="number">1</span>: <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; type, URL url)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">  <span class="number">2</span>:     <span class="comment">// è·å¾—çœŸå®çš„æ³¨å†Œä¸­å¿ƒçš„ URL</span></span><br /><span class="line">  <span class="number">3</span>:     url = url.setProtocol(url.getParameter(Constants.REGISTRY_KEY, Constants.DEFAULT_REGISTRY)).removeParameter(Constants.REGISTRY_KEY);</span><br /><span class="line">  <span class="number">4</span>:     <span class="comment">// è·å¾—æ³¨å†Œä¸­å¿ƒ</span></span><br /><span class="line">  <span class="number">5</span>:     Registry registry = registryFactory.getRegistry(url);</span><br /><span class="line">  <span class="number">6</span>:     <span class="comment">// TODO èŠ‹è‰¿</span></span><br /><span class="line">  <span class="number">7</span>:     <span class="keyword">if</span> (RegistryService.class.equals(type)) {</span><br /><span class="line">  <span class="number">8</span>:         <span class="keyword">return</span> proxyFactory.getInvoker((T) registry, type, url);</span><br /><span class="line">  <span class="number">9</span>:     }</span><br /><span class="line"> <span class="number">10</span>: </span><br /><span class="line"> <span class="number">11</span>:     <span class="comment">// è·å¾—æœåŠ¡å¼•ç”¨é…ç½®å‚æ•°é›†åˆ</span></span><br /><span class="line"> <span class="number">12</span>:     <span class="comment">// group="a,b" or group="*"</span></span><br /><span class="line"> <span class="number">13</span>:     Map&lt;String, String&gt; qs = StringUtils.parseQueryString(url.getParameterAndDecoded(Constants.REFER_KEY));</span><br /><span class="line"> <span class="number">14</span>:     String group = qs.get(Constants.GROUP_KEY);</span><br /><span class="line"> <span class="number">15</span>:     <span class="comment">// åˆ†ç»„èšåˆï¼Œå‚è§æ–‡æ¡£ http://dubbo.apache.org/zh-cn/docs/user/demos/group-merger.html</span></span><br /><span class="line"> <span class="number">16</span>:     <span class="keyword">if</span> (group != <span class="keyword">null</span> &amp;&amp; group.length() &gt; <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">17</span>:         <span class="keyword">if</span> ((Constants.COMMA_SPLIT_PATTERN.split(group)).length &gt; <span class="number">1</span></span><br /><span class="line"> <span class="number">18</span>:                 || <span class="string">"*"</span>.equals(group)) {</span><br /><span class="line"> <span class="number">19</span>:             <span class="comment">// æ‰§è¡ŒæœåŠ¡å¼•ç”¨</span></span><br /><span class="line"> <span class="number">20</span>:             <span class="keyword">return</span> doRefer(getMergeableCluster(), registry, type, url);</span><br /><span class="line"> <span class="number">21</span>:         }</span><br /><span class="line"> <span class="number">22</span>:     }</span><br /><span class="line"> <span class="number">23</span>:     <span class="comment">// æ‰§è¡ŒæœåŠ¡å¼•ç”¨</span></span><br /><span class="line"> <span class="number">24</span>:     <span class="keyword">return</span> doRefer(cluster, registry, type, url);</span><br /><span class="line"> <span class="number">25</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šè·å¾—<strong>çœŸå®</strong>çš„æ³¨å†Œä¸­å¿ƒçš„ URL ã€‚è¯¥è¿‡ç¨‹æ˜¯æˆ‘ä»¬åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/reference-refer-dubbo/">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æœåŠ¡æš´éœ²ï¼ˆä¸€ï¼‰ä¹‹æœ¬åœ°æš´éœ²ï¼ˆInjvmï¼‰ã€‹ã€Œ2.1 loadRegistriesã€</a>&nbsp;çš„é‚£å¼ å›¾çš„åå‘æµç¨‹ï¼Œå³<strong>çº¢çº¿éƒ¨åˆ†</strong>&nbsp;ï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_03_10/01.png" alt="getRegistryUrl" /></li>
<li>ç¬¬ 5 è¡Œï¼šè·å¾—æ³¨å†Œä¸­å¿ƒ Registry å¯¹è±¡ã€‚</li>
<li>ç¬¬ 7è‡³ 9 è¡Œï¼šã€TODO 8018ã€‘RegistryService.class</li>
<li>ç¬¬ 13 è¡Œï¼šè·å¾—æœåŠ¡å¼•ç”¨é…ç½®å‚æ•°é›†åˆ&nbsp;<code>qs</code>&nbsp;ã€‚</li>
<li>ç¬¬ 16 è‡³ 22 è¡Œï¼šåˆ†ç»„èšåˆï¼Œå‚è§&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/group-merger.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; åˆ†ç»„èšåˆã€‹</a>&nbsp;æ–‡æ¡£ã€‚</li>
<li>
<p>ç¬¬ 24 è¡Œï¼šè°ƒç”¨&nbsp;<code>#doRefer(cluster, registry, type, url)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡ŒæœåŠ¡å¼•ç”¨ã€‚ä¸åŒäºã€ç¬¬ 20 è¡Œã€‘çš„ä»£ç ï¼Œåè€…è°ƒç”¨&nbsp;<code>#getMergeableCluster()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—<strong>å¯åˆå¹¶çš„</strong>&nbsp;Cluster å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> Cluster <span class="title">getMergeableCluster</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> ExtensionLoader.getExtensionLoader(Cluster.class).getExtension(<span class="string">"mergeable"</span>);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
</ul>
<h3 id="3-2-2-doRefer">3.2.2 doRefer</h3>
<p><code>#doRefer(cluster, registry, type, url)</code>&nbsp;æ–¹æ³•ï¼Œæ‰§è¡ŒæœåŠ¡å¼•ç”¨çš„é€»è¾‘ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * æ‰§è¡ŒæœåŠ¡å¼•ç”¨ï¼Œè¿”å› Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> 3:  *</span></span><br /><span class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> cluster Cluster å¯¹è±¡</span></span><br /><span class="line"><span class="comment"> 5:  * <span class="doctag">@param</span> registry æ³¨å†Œä¸­å¿ƒå¯¹è±¡</span></span><br /><span class="line"><span class="comment"> 6:  * <span class="doctag">@param</span> type æœåŠ¡æ¥å£ç±»å‹</span></span><br /><span class="line"><span class="comment"> 7:  * <span class="doctag">@param</span> url æ³¨å†Œä¸­å¿ƒ URL</span></span><br /><span class="line"><span class="comment"> 8:  * <span class="doctag">@param</span> &lt;T&gt; æ³›å‹</span></span><br /><span class="line"><span class="comment"> 9:  * <span class="doctag">@return</span> Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="comment">10:  */</span></span><br /><span class="line"><span class="number">11</span>: <span class="keyword">private</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">doRefer</span><span class="params">(Cluster cluster, Registry registry, Class&lt;T&gt; type, URL url)</span> </span>{</span><br /><span class="line"><span class="number">12</span>:     <span class="comment">// åˆ›å»º RegistryDirectory å¯¹è±¡ï¼Œå¹¶è®¾ç½®æ³¨å†Œä¸­å¿ƒ</span></span><br /><span class="line"><span class="number">13</span>:     RegistryDirectory&lt;T&gt; directory = <span class="keyword">new</span> RegistryDirectory&lt;T&gt;(type, url);</span><br /><span class="line"><span class="number">14</span>:     directory.setRegistry(registry);</span><br /><span class="line"><span class="number">15</span>:     directory.setProtocol(protocol);</span><br /><span class="line"><span class="number">16</span>:     <span class="comment">// åˆ›å»ºè®¢é˜… URL</span></span><br /><span class="line"><span class="number">17</span>:     <span class="comment">// all attributes of REFER_KEY</span></span><br /><span class="line"><span class="number">18</span>:     Map&lt;String, String&gt; parameters = <span class="keyword">new</span> HashMap&lt;String, String&gt;(directory.getUrl().getParameters()); <span class="comment">// æœåŠ¡å¼•ç”¨é…ç½®é›†åˆ</span></span><br /><span class="line"><span class="number">19</span>:     URL subscribeUrl = <span class="keyword">new</span> URL(Constants.CONSUMER_PROTOCOL, parameters.remove(Constants.REGISTER_IP_KEY), <span class="number">0</span>, type.getName(), parameters);</span><br /><span class="line"><span class="number">20</span>:     <span class="comment">// å‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œè‡ªå·±ï¼ˆæœåŠ¡æ¶ˆè´¹è€…ï¼‰</span></span><br /><span class="line"><span class="number">21</span>:     <span class="keyword">if</span> (!Constants.ANY_VALUE.equals(url.getServiceInterface())</span><br /><span class="line"><span class="number">22</span>:             &amp;&amp; url.getParameter(Constants.REGISTER_KEY, <span class="keyword">true</span>)) {</span><br /><span class="line"><span class="number">23</span>:         registry.register(subscribeUrl.addParameters(Constants.CATEGORY_KEY, Constants.CONSUMERS_CATEGORY,</span><br /><span class="line"><span class="number">24</span>:                 Constants.CHECK_KEY, String.valueOf(<span class="keyword">false</span>)));</span><br /><span class="line"><span class="number">25</span>:     }</span><br /><span class="line"><span class="number">26</span>:     <span class="comment">// å‘æ³¨å†Œä¸­å¿ƒè®¢é˜…æœåŠ¡æä¾›è€…</span></span><br /><span class="line"><span class="number">27</span>:     directory.subscribe(subscribeUrl.addParameter(Constants.CATEGORY_KEY,</span><br /><span class="line"><span class="number">28</span>:             Constants.PROVIDERS_CATEGORY</span><br /><span class="line"><span class="number">29</span>:                     + <span class="string">","</span> + Constants.CONFIGURATORS_CATEGORY</span><br /><span class="line"><span class="number">30</span>:                     + <span class="string">","</span> + Constants.ROUTERS_CATEGORY));</span><br /><span class="line"><span class="number">31</span>: </span><br /><span class="line"><span class="number">32</span>:     <span class="comment">// åˆ›å»º Invoker å¯¹è±¡</span></span><br /><span class="line"><span class="number">33</span>:     Invoker invoker = cluster.join(directory);</span><br /><span class="line"><span class="number">34</span>:     <span class="comment">// å‘æœ¬åœ°æ³¨å†Œè¡¨ï¼Œæ³¨å†Œæ¶ˆè´¹è€…</span></span><br /><span class="line"><span class="number">35</span>:     ProviderConsumerRegTable.registerConsuemr(invoker, url, subscribeUrl, directory);</span><br /><span class="line"><span class="number">36</span>:     <span class="keyword">return</span> invoker;</span><br /><span class="line"><span class="number">37</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 12 è‡³ 15 è¡Œï¼Œåˆ›å»º RegistryDirectory å¯¹è±¡ï¼Œå¹¶è®¾ç½®æ³¨å†Œä¸­å¿ƒåˆ°å®ƒçš„å±æ€§ã€‚</li>
<li>ç¬¬ 18 è¡Œï¼šè·å¾—æœåŠ¡å¼•ç”¨é…ç½®é›†åˆ&nbsp;<code>parameters</code>&nbsp;ã€‚<strong>æ³¨æ„</strong>ï¼Œ<code>url</code>&nbsp;ä¼ å…¥ RegistryDirectory åï¼Œç»è¿‡å¤„ç†å¹¶é‡æ–°åˆ›å»ºï¼Œæ‰€ä»¥&nbsp;<code>url != directory.url</code>&nbsp;ï¼Œæ‰€ä»¥è·å¾—çš„æ˜¯æœåŠ¡å¼•ç”¨é…ç½®é›†åˆã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<img src="http://static2.iocoder.cn/images/Dubbo/2018_05_04/01.png" alt="parameters" /></li>
<li>ç¬¬ 19 è¡Œï¼šåˆ›å»ºè®¢é˜… URL å¯¹è±¡ã€‚</li>
<li>ç¬¬ 20 è‡³ 25 è¡Œï¼šè°ƒç”¨&nbsp;<code>RegistryService#register(url)</code>&nbsp;æ–¹æ³•ï¼Œå‘æ³¨å†Œä¸­å¿ƒæ³¨å†Œ<strong>è‡ªå·±</strong>ï¼ˆæœåŠ¡æ¶ˆè´¹è€…ï¼‰ã€‚
<ul>
<li>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/registry-api/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹ã€Œ3. RegistryServiceã€&nbsp;</a>ï¼Œæœ‰è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>ç¬¬ 26 ç»ˆ 30 è¡Œï¼šè°ƒç”¨&nbsp;<code>Directory#subscribe(url)</code>&nbsp;æ–¹æ³•ï¼Œå‘æ³¨å†Œä¸­å¿ƒè®¢é˜…æœåŠ¡æä¾›è€… + è·¯ç”±è§„åˆ™ + é…ç½®è§„åˆ™ã€‚
<ul>
<li>åœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¼šå¾ªç¯è·å¾—åˆ°çš„æœåŠ¡ä½“ç”¨è¿™åˆ—è¡¨ï¼Œè°ƒç”¨&nbsp;<code>Protocol#refer(type, url)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºæ¯ä¸ªè°ƒç”¨æœåŠ¡çš„ Invoker å¯¹è±¡ã€‚</li>
</ul>
</li>
<li>ç¬¬ 33 è¡Œï¼šåˆ›å»º Invoker å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§&nbsp;<a href="http://svip.iocoder.cn/Dubbo/cluster-1-api-interface/?self">ã€Šç²¾å°½ Dubbo æºç è§£æ &mdash;&mdash; é›†ç¾¤å®¹é”™ï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹</a>&nbsp;ã€‚</li>
<li>ç¬¬ 35 è¡Œï¼šè°ƒç”¨&nbsp;<code>ProviderConsumerRegTable#registerConsuemr(invoker, url, subscribeUrl, directory)</code>&nbsp;æ–¹æ³•ï¼Œå‘æœ¬åœ°æ³¨å†Œè¡¨ï¼Œæ³¨å†Œæ¶ˆè´¹è€…ã€‚
<ul>
<li>åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/registry-api/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; æ³¨å†Œä¸­å¿ƒï¼ˆä¸€ï¼‰ä¹‹æŠ½è±¡ APIã€‹ã€Œ5. ProviderConsumerRegTableã€&nbsp;</a>ï¼Œæœ‰è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li>ç¬¬ 36 è¡Œï¼šè¿”å› Invoker å¯¹è±¡ã€‚</li>
</ul>
<h2 id="3-3-DubboProtocol">3.3 DubboProtocol</h2>
<h3 id="3-3-1-refer">3.3.1 refer</h3>
<p>æœ¬æ–‡æ¶‰åŠçš„&nbsp;<code>#refer(type, url)</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// AbstractProtocol.java çˆ¶ç±»</span></span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Invoker é›†åˆ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="comment">//TODO SOFEREFENCE</span></span><br /><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Set&lt;Invoker&lt;?&gt;&gt; invokers = <span class="keyword">new</span> ConcurrentHashSet&lt;Invoker&lt;?&gt;&gt;();</span><br /><br /><span class="line"><span class="comment">// DubboProtocol.java</span></span><br /><br /><span class="line">  <span class="number">1</span>: <span class="keyword">public</span> &lt;T&gt; <span class="function">Invoker&lt;T&gt; <span class="title">refer</span><span class="params">(Class&lt;T&gt; serviceType, URL url)</span> <span class="keyword">throws</span> RpcException </span>{</span><br /><span class="line">  <span class="number">2</span>:     <span class="comment">// åˆå§‹åŒ–åºåˆ—åŒ–ä¼˜åŒ–å™¨</span></span><br /><span class="line">  <span class="number">3</span>:     optimizeSerialization(url);</span><br /><span class="line">  <span class="number">4</span>:     <span class="comment">// è·å¾—è¿œç¨‹é€šä¿¡å®¢æˆ·ç«¯æ•°ç»„</span></span><br /><span class="line">  <span class="number">5</span>:     <span class="comment">// åˆ›å»º DubboInvoker å¯¹è±¡</span></span><br /><span class="line">  <span class="number">6</span>:     <span class="comment">// create rpc invoker.</span></span><br /><span class="line">  <span class="number">7</span>:     DubboInvoker&lt;T&gt; invoker = <span class="keyword">new</span> DubboInvoker&lt;T&gt;(serviceType, url, getClients(url), invokers);</span><br /><span class="line">  <span class="number">8</span>:     <span class="comment">// æ·»åŠ åˆ° `invokers`</span></span><br /><span class="line">  <span class="number">9</span>:     invokers.add(invoker);</span><br /><span class="line"> <span class="number">10</span>:     <span class="keyword">return</span> invoker;</span><br /><span class="line"> <span class="number">11</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>invokers</code>&nbsp;å±æ€§ï¼ŒInvoker é›†åˆã€‚</li>
<li>ç¬¬ 3 è¡Œï¼šè°ƒç”¨&nbsp;<code>#optimizeSerialization(url)</code>&nbsp;æ–¹æ³•ï¼Œåˆå§‹åŒ–åºåˆ—åŒ–ä¼˜åŒ–å™¨ã€‚åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/serialize-1-all?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; åºåˆ—åŒ–ï¼ˆä¸€ï¼‰ä¹‹æ€»ä½“å®ç°ã€‹</a>&nbsp;ä¸­ï¼Œè¯¦ç»†è§£æã€‚</li>
<li>ç¬¬ 7 è¡Œï¼šè°ƒç”¨&nbsp;<code>#getClients(url)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»ºè¿œç¨‹é€šä¿¡å®¢æˆ·ç«¯æ•°ç»„ã€‚</li>
<li>ç¬¬ 7 è¡Œï¼šåˆ›å»º DubboInvoker å¯¹è±¡ã€‚</li>
<li>ç¬¬ 9 è¡Œï¼šæ·»åŠ åˆ°&nbsp;<code>invokers</code>&nbsp;ã€‚</li>
<li>ç¬¬ 10 è¡Œï¼šè¿”å› Invoker å¯¹è±¡ã€‚</li>
</ul>
<h3 id="3-3-2-getClients">3.3.2 getClients</h3>
<blockquote>
<p>å‹æƒ…æç¤ºï¼Œæ¶‰åŠ Client çš„å†…å®¹ï¼Œèƒ–å‹å…ˆçœ‹è¿‡&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-api-interface/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ã€‹</a>&nbsp;æ‰€æœ‰çš„æ–‡ç« ã€‚</p>
</blockquote>
<p><code>#getClients(url)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—è¿æ¥æœåŠ¡æä¾›è€…çš„è¿œç¨‹é€šä¿¡å®¢æˆ·ç«¯æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * è·å¾—è¿æ¥æœåŠ¡æä¾›è€…çš„è¿œç¨‹é€šä¿¡å®¢æˆ·ç«¯æ•°ç»„</span></span><br /><span class="line"><span class="comment"> 3:  *</span></span><br /><span class="line"><span class="comment"> 4:  * <span class="doctag">@param</span> url æœåŠ¡æä¾›è€… URL</span></span><br /><span class="line"><span class="comment"> 5:  * <span class="doctag">@return</span> è¿œç¨‹é€šä¿¡å®¢æˆ·ç«¯</span></span><br /><span class="line"><span class="comment"> 6:  */</span></span><br /><span class="line"> <span class="number">7</span>: <span class="keyword">private</span> ExchangeClient[] getClients(URL url) {</span><br /><span class="line"> <span class="number">8</span>:     <span class="comment">// æ˜¯å¦å…±äº«è¿æ¥</span></span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// whether to share connection</span></span><br /><span class="line"><span class="number">10</span>:     <span class="keyword">boolean</span> service_share_connect = <span class="keyword">false</span>;</span><br /><span class="line"><span class="number">11</span>:     <span class="keyword">int</span> connections = url.getParameter(Constants.CONNECTIONS_KEY, <span class="number">0</span>);</span><br /><span class="line"><span class="number">12</span>:     <span class="comment">// if not configured, connection is shared, otherwise, one connection for one service</span></span><br /><span class="line"><span class="number">13</span>:     <span class="keyword">if</span> (connections == <span class="number">0</span>) { <span class="comment">// æœªé…ç½®æ—¶ï¼Œé»˜è®¤å…±äº«</span></span><br /><span class="line"><span class="number">14</span>:         service_share_connect = <span class="keyword">true</span>;</span><br /><span class="line"><span class="number">15</span>:         connections = <span class="number">1</span>;</span><br /><span class="line"><span class="number">16</span>:     }</span><br /><span class="line"><span class="number">17</span>: </span><br /><span class="line"><span class="number">18</span>:     <span class="comment">// åˆ›å»ºè¿æ¥æœåŠ¡æä¾›è€…çš„ ExchangeClient å¯¹è±¡æ•°ç»„</span></span><br /><span class="line"><span class="number">19</span>:     ExchangeClient[] clients = <span class="keyword">new</span> ExchangeClient[connections];</span><br /><span class="line"><span class="number">20</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; clients.length; i++) {</span><br /><span class="line"><span class="number">21</span>:         <span class="keyword">if</span> (service_share_connect) { <span class="comment">// å…±äº«</span></span><br /><span class="line"><span class="number">22</span>:             clients[i] = getSharedClient(url);</span><br /><span class="line"><span class="number">23</span>:         } <span class="keyword">else</span> { <span class="comment">// ä¸å…±äº«</span></span><br /><span class="line"><span class="number">24</span>:             clients[i] = initClient(url);</span><br /><span class="line"><span class="number">25</span>:         }</span><br /><span class="line"><span class="number">26</span>:     }</span><br /><span class="line"><span class="number">27</span>:     <span class="keyword">return</span> clients;</span><br /><span class="line"><span class="number">28</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 8 è‡³ 16 è¡Œï¼šæ˜¯å¦å…±äº«è¿æ¥ã€‚</li>
<li>ç¬¬ 18 è‡³ 26 è¡Œï¼šåˆ›å»ºè¿æ¥æœåŠ¡æä¾›è€…çš„ ExchangeClient å¯¹è±¡æ•°ç»„ã€‚
<ul>
<li><strong>æ³¨æ„</strong>ï¼Œè‹¥å¼€å¯å…±äº«è¿æ¥ï¼ŒåŸºäº URL ä¸ºç»´åº¦å…±äº«ã€‚</li>
<li>ç¬¬ 21 è‡³ 22 è¡Œï¼šå…±äº«è¿æ¥ï¼Œè°ƒç”¨&nbsp;<code>#getSharedClient(url)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾— ExchangeClient å¯¹è±¡ã€‚</li>
<li>ç¬¬ 23 è‡³ 25 è¡Œï¼šä¸å…±äº«è¿æ¥ï¼Œè°ƒç”¨&nbsp;<code>#initClient(url)</code>&nbsp;æ–¹æ³•ï¼Œç›´æ¥åˆ›å»º ExchangeClient å¯¹è±¡ã€‚</li>
</ul>
</li>
<li><code>connections</code>&nbsp;é…ç½®é¡¹ã€‚
<ul>
<li>é»˜è®¤ 0 ã€‚å³ï¼Œå¯¹åŒä¸€ä¸ªè¿œç¨‹æœåŠ¡å™¨ï¼Œ<strong>å…±ç”¨</strong>åŒä¸€ä¸ªè¿æ¥ã€‚</li>
<li>å¤§äº 0 ã€‚å³ï¼Œæ¯ä¸ªæœåŠ¡å¼•ç”¨ï¼Œ<strong>ç‹¬ç«‹</strong>æ¯ä¸€ä¸ªè¿æ¥ã€‚</li>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/demos/config-connections.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; è¿æ¥æ§åˆ¶ã€‹</a></li>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/references/xml/dubbo-reference.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; dubbo:referenceã€‹</a></li>
</ul>
</li>
</ul>
<h3 id="3-3-3-getSharedClient">3.3.3 getSharedClient</h3>
<p><code>#getClients(url)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—è¿æ¥æœåŠ¡æä¾›è€…çš„è¿œç¨‹é€šä¿¡å®¢æˆ·ç«¯æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é€šä¿¡å®¢æˆ·ç«¯é›†åˆ</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * key: æœåŠ¡å™¨åœ°å€ã€‚æ ¼å¼ä¸ºï¼šhost:port</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, ReferenceCountExchangeClient&gt; referenceClientMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ReferenceCountExchangeClient&gt;(); <span class="comment">// &lt;host:port,Exchanger&gt;</span></span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * TODO 8030 ï¼Œè¿™ä¸ªæ˜¯ä»€ä¹ˆç”¨é€”å•Šã€‚</span></span><br /><span class="line"><span class="comment"> *</span></span><br /><span class="line"><span class="comment"> * key: æœåŠ¡å™¨åœ°å€ã€‚æ ¼å¼ä¸ºï¼šhost:port ã€‚å’Œ {<span class="doctag">@link</span> #referenceClientMap} Key ï¼Œæ˜¯ä¸€è‡´çš„ã€‚</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, LazyConnectExchangeClient&gt; ghostClientMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, LazyConnectExchangeClient&gt;();</span><br /><br /><span class="line">  <span class="number">1</span>: <span class="function"><span class="keyword">private</span> ExchangeClient <span class="title">getSharedClient</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line">  <span class="number">2</span>:     <span class="comment">// ä»é›†åˆä¸­ï¼ŒæŸ¥æ‰¾ ReferenceCountExchangeClient å¯¹è±¡</span></span><br /><span class="line">  <span class="number">3</span>:     String key = url.getAddress();</span><br /><span class="line">  <span class="number">4</span>:     ReferenceCountExchangeClient client = referenceClientMap.get(key);</span><br /><span class="line">  <span class="number">5</span>:     <span class="keyword">if</span> (client != <span class="keyword">null</span>) {</span><br /><span class="line">  <span class="number">6</span>:         <span class="comment">// è‹¥æœªå…³é—­ï¼Œå¢åŠ æŒ‡å‘è¯¥ Client çš„æ•°é‡ï¼Œå¹¶è¿”å›å®ƒ</span></span><br /><span class="line">  <span class="number">7</span>:         <span class="keyword">if</span> (!client.isClosed()) {</span><br /><span class="line">  <span class="number">8</span>:             client.incrementAndGetCount();</span><br /><span class="line">  <span class="number">9</span>:             <span class="keyword">return</span> client;</span><br /><span class="line"> <span class="number">10</span>:         <span class="comment">// è‹¥å·²å…³é—­ï¼Œç§»é™¤</span></span><br /><span class="line"> <span class="number">11</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">12</span>:             referenceClientMap.remove(key);</span><br /><span class="line"> <span class="number">13</span>:         }</span><br /><span class="line"> <span class="number">14</span>:     }</span><br /><span class="line"> <span class="number">15</span>:     <span class="comment">// åŒæ­¥ï¼Œåˆ›å»º ExchangeClient å¯¹è±¡ã€‚</span></span><br /><span class="line"> <span class="number">16</span>:     <span class="keyword">synchronized</span> (key.intern()) {</span><br /><span class="line"> <span class="number">17</span>:         <span class="comment">// åˆ›å»º ExchangeClient å¯¹è±¡</span></span><br /><span class="line"> <span class="number">18</span>:         ExchangeClient exchangeClient = initClient(url);</span><br /><span class="line"> <span class="number">19</span>:         <span class="comment">// å°† `exchangeClient` åŒ…è£…ï¼Œåˆ›å»º ReferenceCountExchangeClient å¯¹è±¡</span></span><br /><span class="line"> <span class="number">20</span>:         client = <span class="keyword">new</span> ReferenceCountExchangeClient(exchangeClient, ghostClientMap);</span><br /><span class="line"> <span class="number">21</span>:         <span class="comment">// æ·»åŠ åˆ°é›†åˆ</span></span><br /><span class="line"> <span class="number">22</span>:         referenceClientMap.put(key, client);</span><br /><span class="line"> <span class="number">23</span>:         <span class="comment">// æ·»åŠ åˆ° `ghostClientMap`</span></span><br /><span class="line"> <span class="number">24</span>:         ghostClientMap.remove(key);</span><br /><span class="line"> <span class="number">25</span>:         <span class="keyword">return</span> client;</span><br /><span class="line"> <span class="number">26</span>:     }</span><br /><span class="line"> <span class="number">27</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>referenceClientMap</code>&nbsp;å±æ€§ï¼Œé€šä¿¡å®¢æˆ·ç«¯é›†åˆã€‚åœ¨æˆ‘ä»¬åˆ›å»ºå¥½ Client å¯¹è±¡ï¼Œ&ldquo;<strong>è¿æ¥</strong>&rdquo;æœåŠ¡å™¨åï¼Œä¼šæ·»åŠ åˆ°è¿™ä¸ªé›†åˆä¸­ï¼Œç”¨äºåç»­çš„ Client çš„<strong>å…±äº«</strong>ã€‚
<ul>
<li>ReferenceCountExchangeClient ï¼Œé¡¾åæ€ä¹‰ï¼Œå¸¦æœ‰æŒ‡å‘æ•°é‡è®¡æ•°çš„ Client å°è£…ã€‚</li>
<li>&ldquo;<strong>è¿æ¥</strong>&rdquo; ï¼Œæ‰“å¼•å·çš„åŸå› ï¼Œå› ä¸ºæœ‰ LazyConnectExchangeClient ï¼Œè¿˜æ˜¯é¡¾åæ€ä¹‰ï¼Œå»¶è¿Ÿè¿æ¥çš„ Client å°è£…ã€‚</li>
<li>ğŸ™‚ ReferenceCountExchangeClient å’Œ LazyConnectExchangeClient çš„å…·ä½“å®ç°ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/reference-refer-dubbo/">ã€Œ5. Clientã€</a>&nbsp;è¯¦ç»†è§£æã€‚</li>
</ul>
</li>
<li><code>ghostClientMap</code>&nbsp;å±æ€§ï¼Œå¹½çµå®¢æˆ·ç«¯é›†åˆã€‚TODO 8030 ï¼Œè¿™ä¸ªæ˜¯ä»€ä¹ˆç”¨é€”å•Šã€‚
<ul>
<li>ã€æ·»åŠ ã€‘æ¯æ¬¡ ReferenceCountExchangeClient&nbsp;<strong>å½»åº•</strong>å…³é—­( æŒ‡å‘å½’é›¶ ) ï¼Œå…¶å†…éƒ¨çš„&nbsp;<code>client</code>&nbsp;ä¼šæ›¿æ¢æˆ<strong>é‡æ–°åˆ›å»º</strong>çš„ LazyConnectExchangeClient å¯¹è±¡ï¼Œæ­¤æ—¶å«è¿™ä¸ªå¯¹è±¡ä¸º<strong>å¹½çµå®¢æˆ·ç«¯</strong>ï¼Œæ·»åŠ åˆ°&nbsp;<code>ghostClientMap</code>&nbsp;ä¸­ã€‚</li>
<li>ã€ç§»é™¤ã€‘å½“å¹½çµå®¢æˆ·ç«¯ï¼Œå¯¹åº”çš„ URL çš„æœåŠ¡å™¨è¢«é‡æ–°è¿æ¥ä¸Šåï¼Œä¼šè¢«ç§»é™¤ã€‚</li>
<li><strong>æ³¨æ„</strong>ï¼Œåœ¨å¹½çµå®¢æˆ·ç«¯<strong>è¢«ç§»é™¤ä¹‹å‰</strong>ï¼Œ<code>referenceClientMap</code>&nbsp;ä¸­ï¼Œä¾ç„¶ä¿ç•™ç€å¯¹åº”çš„ URL çš„ ReferenceCountExchangeClient å¯¹è±¡ã€‚æ‰€ä»¥ï¼Œ<code>ghostClientMap</code>&nbsp;ç›¸å½“äºæ ‡è®°&nbsp;<code>referenceClientMap</code>&nbsp;ä¸­ï¼Œå“ªäº› LazyConnectExchangeClient å¯¹è±¡ï¼Œæ˜¯<strong>å¹½çµ</strong>çŠ¶æ€ã€‚ğŸ‘»</li>
</ul>
</li>
<li>ç¬¬ 2 è‡³ 4 è¡Œï¼šä»é›†åˆ&nbsp;<code>referenceClientMap</code>&nbsp;ä¸­ï¼ŒæŸ¥æ‰¾ ReferenceCountExchangeClient å¯¹è±¡ã€‚</li>
<li>ç¬¬ 5 è‡³ 14 è¡Œï¼šæŸ¥æ‰¾åˆ°å®¢æˆ·ç«¯ã€‚
<ul>
<li>ç¬¬ 6 è‡³ 9 è¡Œï¼šè‹¥<strong>æœªå…³é—­</strong>ï¼Œè°ƒç”¨&nbsp;<code>ReferenceCountExchangeClient#incrementAndGetCount()</code>&nbsp;æ–¹æ³•ï¼Œå¢åŠ æŒ‡å‘è¯¥å®¢æˆ·ç«¯çš„æ•°é‡ï¼Œå¹¶è¿”å›ã€‚</li>
<li>ç¬¬ 11 è‡³ 13 è¡Œï¼šè‹¥<strong>å·²å…³é—­</strong>ï¼Œé€‚ç”¨äº<strong>å¹½çµ</strong>çŠ¶æ€çš„ ReferenceCountExchangeClient å¯¹è±¡ï¼Œä»&nbsp;<code>referenceClientMap</code>&nbsp;ä¸­ç§»é™¤ï¼Œå‡†å¤‡ä¸‹é¢çš„ä»£ç ï¼Œåˆ›å»º<strong>æ–°çš„</strong>&nbsp;ReferenceCountExchangeClient å¯¹è±¡ã€‚</li>
</ul>
</li>
<li>ç¬¬ 15 è‡³ 26 è¡Œï¼š<strong>åŒæ­¥</strong>(&nbsp;<code>synchronized</code>&nbsp;) ï¼Œåˆ›å»ºæ–°çš„ ReferenceCountExchangeClient å¯¹è±¡ã€‚
<ul>
<li>ç¬¬ 18 è¡Œï¼šè°ƒç”¨&nbsp;<code>#initClient(url)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º ExchangeClient å¯¹è±¡ã€‚</li>
<li>ç¬¬ 20 è¡Œï¼šå°† ExchangeClient å¯¹è±¡ï¼Œå°è£…åˆ›å»ºæˆ ReferenceCountExchangeClient ç‹¬äº«ã€‚</li>
<li>ç¬¬ 22 è¡Œï¼šæ·»åŠ åˆ°é›†åˆ&nbsp;<code>referenceClientMap</code>&nbsp;ã€‚</li>
<li>ç¬¬ 24 è¡Œï¼šç§»é™¤å‡ºé›†åˆ&nbsp;<code>ghostClientMap</code>&nbsp;ï¼Œå› ä¸ºä¸å†æ˜¯<strong>å¹½çµ</strong>çŠ¶æ€å•¦ã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-3-4-initClient">3.3.4 initClient</h3>
<p><code>#initClient(url)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º ExchangeClient å¯¹è±¡ï¼Œ&rdquo;è¿æ¥&rdquo;æœåŠ¡å™¨ã€‚</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> ExchangeClient <span class="title">initClient</span><span class="params">(URL url)</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// æ ¡éªŒ Client çš„ Dubbo SPI æ‹“å±•æ˜¯å¦å­˜åœ¨</span></span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// client type setting.</span></span><br /><span class="line"> <span class="number">4</span>:     String str = url.getParameter(Constants.CLIENT_KEY, url.getParameter(Constants.SERVER_KEY, Constants.DEFAULT_REMOTING_CLIENT));</span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// BIO is not allowed since it has severe performance issue.</span></span><br /><span class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (str != <span class="keyword">null</span> &amp;&amp; str.length() &gt; <span class="number">0</span> &amp;&amp; !ExtensionLoader.getExtensionLoader(Transporter.class).hasExtension(str)) {</span><br /><span class="line"> <span class="number">7</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Unsupported client type: "</span> + str + <span class="string">","</span> +</span><br /><span class="line"> <span class="number">8</span>:                 <span class="string">" supported client type is "</span> + StringUtils.join(ExtensionLoader.getExtensionLoader(Transporter.class).getSupportedExtensions(), <span class="string">" "</span>));</span><br /><span class="line"> <span class="number">9</span>:     }</span><br /><span class="line"><span class="number">10</span>: </span><br /><span class="line"><span class="number">11</span>:     <span class="comment">// è®¾ç½®ç¼–è§£ç å™¨ä¸º Dubbo ï¼Œå³ DubboCountCodec</span></span><br /><span class="line"><span class="number">12</span>:     url = url.addParameter(Constants.CODEC_KEY, DubboCodec.NAME);</span><br /><span class="line"><span class="number">13</span>: </span><br /><span class="line"><span class="number">14</span>:     <span class="comment">// é»˜è®¤å¼€å¯ heartbeat</span></span><br /><span class="line"><span class="number">15</span>:     <span class="comment">// enable heartbeat by default</span></span><br /><span class="line"><span class="number">16</span>:     url = url.addParameterIfAbsent(Constants.HEARTBEAT_KEY, String.valueOf(Constants.DEFAULT_HEARTBEAT));</span><br /><span class="line"><span class="number">17</span>: </span><br /><span class="line"><span class="number">18</span>:     <span class="comment">// è¿æ¥æœåŠ¡å™¨ï¼Œåˆ›å»ºå®¢æˆ·ç«¯</span></span><br /><span class="line"><span class="number">19</span>:     ExchangeClient client;</span><br /><span class="line"><span class="number">20</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">21</span>:         <span class="comment">// æ‡’è¿æ¥ï¼Œåˆ›å»º LazyConnectExchangeClient å¯¹è±¡</span></span><br /><span class="line"><span class="number">22</span>:         <span class="comment">// connection should be lazy</span></span><br /><span class="line"><span class="number">23</span>:         <span class="keyword">if</span> (url.getParameter(Constants.LAZY_CONNECT_KEY, <span class="keyword">false</span>)) {</span><br /><span class="line"><span class="number">24</span>:             client = <span class="keyword">new</span> LazyConnectExchangeClient(url, requestHandler);</span><br /><span class="line"><span class="number">25</span>:         <span class="comment">// ç›´æ¥è¿æ¥ï¼Œåˆ›å»º HeaderExchangeClient å¯¹è±¡</span></span><br /><span class="line"><span class="number">26</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">27</span>:             client = Exchangers.connect(url, requestHandler);</span><br /><span class="line"><span class="number">28</span>:         }</span><br /><span class="line"><span class="number">29</span>:     } <span class="keyword">catch</span> (RemotingException e) {</span><br /><span class="line"><span class="number">30</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RpcException(<span class="string">"Fail to create remoting client for service("</span> + url + <span class="string">"): "</span> + e.getMessage(), e);</span><br /><span class="line"><span class="number">31</span>:     }</span><br /><span class="line"><span class="number">32</span>:     <span class="keyword">return</span> client;</span><br /><span class="line"><span class="number">33</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 2 è‡³ 9 è¡Œï¼šæ ¡éªŒé…ç½®çš„ Client çš„ Dubbo SPI æ‹“å±•æ˜¯å¦å­˜åœ¨ã€‚è‹¥ä¸å­˜åœ¨ï¼ŒæŠ›å‡º RpcException å¼‚å¸¸ã€‚</li>
<li>ç¬¬ 12 è¡Œï¼šè®¾ç½®ç¼–è§£ç å™¨ä¸º&nbsp;<code>"Dubbo"</code>&nbsp;åè®®ï¼Œå³ DubboCountCodec ã€‚</li>
<li>ç¬¬ 16 è¡Œï¼šé»˜è®¤å¼€å¯<strong>å¿ƒè·³</strong>åŠŸèƒ½ã€‚</li>
<li>ç¬¬ 19 è‡³ 31 è¡Œï¼šè¿æ¥æœåŠ¡å™¨ï¼Œåˆ›å»ºå®¢æˆ·ç«¯ã€‚
<ul>
<li>ç¬¬ 21 è‡³ 24 è¡Œï¼š<strong>æ‡’åŠ è½½</strong>ï¼Œåˆ›å»º LazyConnectExchangeClient å¯¹è±¡ã€‚</li>
<li>ç¬¬ 25 è‡³ 28 è¡Œï¼š<strong>ç›´æ¥è¿æ¥</strong>ï¼Œåˆ›å»º HeaderExchangeClient å¯¹è±¡ã€‚</li>
</ul>
</li>
</ul>
<h1 id="4-Invoker">4. Invoker</h1>
<p>æœ¬æ–‡æ¶‰åŠçš„ Invoker ç±»å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_05_04/04.png" alt="Invoker ç±»å›¾" /></p>
<h2 id="4-1-DubboInvoker">4.1 DubboInvoker</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/8de6d56d06965a38712c46a0220f4e59213db72f/dubbo-rpc/dubbo-rpc-default/src/main/java/com/alibaba/dubbo/rpc/protocol/dubbo/DubboInvoker.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.rpc.protocol.dubbo.DubboInvoker</code></a>&nbsp;ï¼Œå®ç° AbstractExporter æŠ½è±¡ç±»ï¼ŒDubbo Invoker å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * è¿œç¨‹é€šä¿¡å®¢æˆ·ç«¯æ•°ç»„</span></span><br /><span class="line"><span class="comment"> 3:  */</span></span><br /><span class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> ExchangeClient[] clients;</span><br /><span class="line"> <span class="number">5</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 6:  * ä½¿ç”¨çš„ {<span class="doctag">@link</span> #clients} çš„ä½ç½®</span></span><br /><span class="line"><span class="comment"> 7:  */</span></span><br /><span class="line"> <span class="number">8</span>: <span class="keyword">private</span> <span class="keyword">final</span> AtomicPositiveInteger index = <span class="keyword">new</span> AtomicPositiveInteger();</span><br /><span class="line"> <span class="number">9</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">10:  * ç‰ˆæœ¬</span></span><br /><span class="line"><span class="comment">11:  */</span></span><br /><span class="line"><span class="number">12</span>: <span class="keyword">private</span> <span class="keyword">final</span> String version;</span><br /><span class="line"><span class="number">13</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">14:  * é”€æ¯é”</span></span><br /><span class="line"><span class="comment">15:  *</span></span><br /><span class="line"><span class="comment">16:  * åœ¨ {<span class="doctag">@link</span> #destroy()} ä¸­ä½¿ç”¨</span></span><br /><span class="line"><span class="comment">17:  */</span></span><br /><span class="line"><span class="number">18</span>: <span class="keyword">private</span> <span class="keyword">final</span> ReentrantLock destroyLock = <span class="keyword">new</span> ReentrantLock();</span><br /><span class="line"><span class="number">19</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">20:  * Invoker é›†åˆï¼Œä» {<span class="doctag">@link</span> DubboProtocol#invokers} è·å–</span></span><br /><span class="line"><span class="comment">21:  */</span></span><br /><span class="line"><span class="number">22</span>: <span class="keyword">private</span> <span class="keyword">final</span> Set&lt;Invoker&lt;?&gt;&gt; invokers;</span><br /><span class="line"><span class="number">23</span>: </span><br /><span class="line"><span class="number">24</span>: <span class="function"><span class="keyword">public</span> <span class="title">DubboInvoker</span><span class="params">(Class&lt;T&gt; serviceType, URL url, ExchangeClient[] clients)</span> </span>{</span><br /><span class="line"><span class="number">25</span>:     <span class="keyword">this</span>(serviceType, url, clients, <span class="keyword">null</span>);</span><br /><span class="line"><span class="number">26</span>: }</span><br /><span class="line"><span class="number">27</span>: </span><br /><span class="line"><span class="number">28</span>: <span class="function"><span class="keyword">public</span> <span class="title">DubboInvoker</span><span class="params">(Class&lt;T&gt; serviceType, URL url, ExchangeClient[] clients, Set&lt;Invoker&lt;?&gt;&gt; invokers)</span> </span>{</span><br /><span class="line"><span class="number">29</span>:     <span class="keyword">super</span>(serviceType, url, <span class="keyword">new</span> String[]{Constants.INTERFACE_KEY, Constants.GROUP_KEY, Constants.TOKEN_KEY, Constants.TIMEOUT_KEY});</span><br /><span class="line"><span class="number">30</span>:     <span class="keyword">this</span>.clients = clients;</span><br /><span class="line"><span class="number">31</span>:     <span class="comment">// get version.</span></span><br /><span class="line"><span class="number">32</span>:     <span class="keyword">this</span>.version = url.getParameter(Constants.VERSION_KEY, <span class="string">"0.0.0"</span>);</span><br /><span class="line"><span class="number">33</span>:     <span class="keyword">this</span>.invokers = invokers;</span><br /><span class="line"><span class="number">34</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>èƒ–å‹ï¼Œè¯·çœ‹å±æ€§ä¸Šçš„ä»£ç æ³¨é‡Šã€‚</li>
<li>ç¬¬ 29 è¡Œï¼šè°ƒç”¨çˆ¶ç±»æ„é€ æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¸­ï¼Œä¼šå°†&nbsp;<code>interface</code>&nbsp;<code>group</code>&nbsp;<code>version</code>&nbsp;<code>token</code>&nbsp;<code>timeout</code>&nbsp;æ·»åŠ åˆ°å…¬ç”¨çš„éšå¼ä¼ å‚&nbsp;<code>AbstractInvoker.attachment</code>&nbsp;å±æ€§ã€‚
<ul>
<li>ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è¯·è‡ªå·±é˜…è¯»ã€‚</li>
</ul>
</li>
</ul>
<h1 id="5-Client">5. Client</h1>
<blockquote>
<p>å‹æƒ…æç¤ºï¼Œæ¶‰åŠ Client çš„å†…å®¹ï¼Œèƒ–å‹å…ˆçœ‹è¿‡&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-api-interface/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ã€‹</a>&nbsp;æ‰€æœ‰çš„æ–‡ç« ã€‚</p>
</blockquote>
<h2 id="5-1-ReferenceCountExchangeClient">5.1 ReferenceCountExchangeClient</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-rpc/dubbo-rpc-default/src/main/java/com/alibaba/dubbo/rpc/protocol/dubbo/ReferenceCountExchangeClient.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.rpc.protocol.dubbo.ReferenceCountExchangeClient</code></a>&nbsp;ï¼Œå®ç° ExchangeClient æ¥å£ï¼Œ<strong>æ”¯æŒæŒ‡å‘è®¡æ•°</strong>çš„ä¿¡æ¯äº¤æ¢å®¢æˆ·ç«¯å®ç°ç±»ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 2:  * URL</span></span><br /><span class="line"><span class="comment"> 3:  */</span></span><br /><span class="line"> <span class="number">4</span>: <span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br /><span class="line"> <span class="number">5</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 6:  * æŒ‡å‘æ•°é‡</span></span><br /><span class="line"><span class="comment"> 7:  */</span></span><br /><span class="line"> <span class="number">8</span>: <span class="keyword">private</span> <span class="keyword">final</span> AtomicInteger refenceCount = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br /><span class="line"> <span class="number">9</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">10:  * å¹½çµå®¢æˆ·ç«¯é›†åˆ</span></span><br /><span class="line"><span class="comment">11:  */</span></span><br /><span class="line"><span class="number">12</span>: <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;String, LazyConnectExchangeClient&gt; ghostClientMap;</span><br /><span class="line"><span class="number">13</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">14:  * å®¢æˆ·ç«¯</span></span><br /><span class="line"><span class="comment">15:  */</span></span><br /><span class="line"><span class="number">16</span>: <span class="keyword">private</span> ExchangeClient client;</span><br /><span class="line"><span class="number">17</span>: </span><br /><span class="line"><span class="number">18</span>: <span class="function"><span class="keyword">public</span> <span class="title">ReferenceCountExchangeClient</span><span class="params">(ExchangeClient client, ConcurrentMap&lt;String, LazyConnectExchangeClient&gt; ghostClientMap)</span> </span>{</span><br /><span class="line"><span class="number">19</span>:     <span class="keyword">this</span>.client = client;</span><br /><span class="line"><span class="number">20</span>:     <span class="comment">// æŒ‡å‘åŠ ä¸€</span></span><br /><span class="line"><span class="number">21</span>:     refenceCount.incrementAndGet();</span><br /><span class="line"><span class="number">22</span>:     <span class="keyword">this</span>.url = client.getUrl();</span><br /><span class="line"><span class="number">23</span>:     <span class="keyword">if</span> (ghostClientMap == <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">24</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"ghostClientMap can not be null, url: "</span> + url);</span><br /><span class="line"><span class="number">25</span>:     }</span><br /><span class="line"><span class="number">26</span>:     <span class="keyword">this</span>.ghostClientMap = ghostClientMap;</span><br /><span class="line"><span class="number">27</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>refenceCount</code>&nbsp;å±æ€§ï¼ŒæŒ‡å‘è®¡æ•°ã€‚
<ul>
<li>ã€åˆå§‹ã€‘æ„é€ æ–¹æ³•ï¼Œã€ç¬¬ 21 è¡Œã€‘ï¼Œè®¡æ•°åŠ ä¸€ã€‚</li>
<li>ã€å¼•ç”¨ã€‘æ¯æ¬¡å¼•ç”¨ï¼Œè®¡æ•°åŠ ä¸€ã€‚</li>
</ul>
</li>
<li><code>ghostClientMap</code>&nbsp;å±æ€§ï¼Œå¹½çµå®¢æˆ·ç«¯é›†åˆï¼Œå’Œ&nbsp;<code>Protocol.ghostClientMap</code>&nbsp;å‚æ•°ï¼Œä¸€è‡´ã€‚</li>
<li><code>client</code>&nbsp;å±æ€§ï¼Œå®¢æˆ·ç«¯ã€‚
<ul>
<li>ã€åˆ›å»ºã€‘æ„é€ æ–¹æ³•ï¼Œä¼ å…¥&nbsp;<code>client</code>&nbsp;å±æ€§ï¼ŒæŒ‡å‘å®ƒã€‚</li>
<li>ã€å…³é—­ã€‘å…³é—­æ–¹æ³•ï¼Œåˆ›å»º LazyConnectExchangeClient å¯¹è±¡ï¼ŒæŒ‡å‘è¯¥å¹½çµå®¢æˆ·ç«¯ã€‚</li>
</ul>
</li>
</ul>
<p><strong>è£…é¥°å™¨æ¨¡å¼</strong></p>
<p>åŸºäº<strong>è£…é¥°å™¨æ¨¡å¼</strong>ï¼Œæ‰€ä»¥ï¼Œæ¯ä¸ªå®ç°æ–¹æ³•ï¼Œéƒ½æ˜¯è°ƒç”¨&nbsp;<code>client</code>&nbsp;çš„å¯¹åº”çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(Object message)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    client.send(message);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p><strong>è®¡æ•°</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incrementAndGetCount</span><span class="params">()</span> </span>{</span><br /><span class="line">    refenceCount.incrementAndGet();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p><strong>å…³é—­</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> timeout)</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (refenceCount.decrementAndGet() &lt;= <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">4</span>:         <span class="comment">// å…³é—­ `client`</span></span><br /><span class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (timeout == <span class="number">0</span>) {</span><br /><span class="line"> <span class="number">6</span>:             client.close();</span><br /><span class="line"> <span class="number">7</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"> <span class="number">8</span>:             client.close(timeout);</span><br /><span class="line"> <span class="number">9</span>:         }</span><br /><span class="line"><span class="number">10</span>:         <span class="comment">// æ›¿æ¢ `client` ä¸º LazyConnectExchangeClient å¯¹è±¡ã€‚</span></span><br /><span class="line"><span class="number">11</span>:         client = replaceWithLazyClient();</span><br /><span class="line"><span class="number">12</span>:     }</span><br /><span class="line"><span class="number">13</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šè®¡æ•°<strong>å‡ä¸€</strong>ã€‚è‹¥æ— æŒ‡å‘ï¼Œè¿›è¡ŒçœŸæ­£çš„å…³é—­ã€‚</li>
<li>ç¬¬ 4 è‡³ 9 è¡Œï¼šè°ƒç”¨&nbsp;<code>client</code>&nbsp;çš„å…³é—­æ–¹æ³•ï¼Œè¿›è¡Œå…³é—­ã€‚</li>
<li>
<p>ç¬¬ 11 è¡Œï¼šè°ƒç”¨&nbsp;<code>#replaceWithLazyClient()</code>&nbsp;æ–¹æ³•ï¼Œæ›¿æ¢&nbsp;<code>client</code>&nbsp;ä¸º LazyConnectExchangeClient å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> LazyConnectExchangeClient <span class="title">replaceWithLazyClient</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">2</span>:     <span class="comment">// this is a defensive operation to avoid client is closed by accident, the initial state of the client is false</span></span><br /><span class="line"> <span class="number">3</span>:     URL lazyUrl = url.addParameter(Constants.LAZY_CONNECT_INITIAL_STATE_KEY, Boolean.FALSE)</span><br /><span class="line"> <span class="number">4</span>:             .addParameter(Constants.RECONNECT_KEY, Boolean.FALSE) <span class="comment">// ä¸é‡è¿</span></span><br /><span class="line"> <span class="number">5</span>:             .addParameter(Constants.SEND_RECONNECT_KEY, Boolean.TRUE.toString())</span><br /><span class="line"> <span class="number">6</span>:             .addParameter(<span class="string">"warning"</span>, Boolean.TRUE.toString())</span><br /><span class="line"> <span class="number">7</span>:             .addParameter(LazyConnectExchangeClient.REQUEST_WITH_WARNING_KEY, <span class="keyword">true</span>)</span><br /><span class="line"> <span class="number">8</span>:             .addParameter(<span class="string">"_client_memo"</span>, <span class="string">"referencecounthandler.replacewithlazyclient"</span>); <span class="comment">// å¤‡æ³¨</span></span><br /><span class="line"> <span class="number">9</span>: </span><br /><span class="line"><span class="number">10</span>:     <span class="comment">// åˆ›å»º LazyConnectExchangeClient å¯¹è±¡ï¼Œè‹¥ä¸å­˜åœ¨ã€‚</span></span><br /><span class="line"><span class="number">11</span>:     String key = url.getAddress();</span><br /><span class="line"><span class="number">12</span>:     <span class="comment">// in worst case there's only one ghost connection.</span></span><br /><span class="line"><span class="number">13</span>:     LazyConnectExchangeClient gclient = ghostClientMap.get(key);</span><br /><span class="line"><span class="number">14</span>:     <span class="keyword">if</span> (gclient == <span class="keyword">null</span> || gclient.isClosed()) {</span><br /><span class="line"><span class="number">15</span>:         gclient = <span class="keyword">new</span> LazyConnectExchangeClient(lazyUrl, client.getExchangeHandler());</span><br /><span class="line"><span class="number">16</span>:         ghostClientMap.put(key, gclient);</span><br /><span class="line"><span class="number">17</span>:     }</span><br /><span class="line"><span class="number">18</span>:     <span class="keyword">return</span> gclient;</span><br /><span class="line"><span class="number">19</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è‡³ 8 è¡Œï¼šåŸºäº&nbsp;<code>url</code>&nbsp;ï¼Œåˆ›å»º LazyConnectExchangeClient çš„ URL é“¾æ¥ã€‚è®¾ç½®çš„ä¸€äº›å‚æ•°ï¼Œç»“åˆ&nbsp;<a href="http://svip.iocoder.cn/Dubbo/reference-refer-dubbo/">ã€Œ5.2 LazyConnectExchangeClientã€</a>&nbsp;ä¸€èµ·çœ‹ã€‚</li>
<li>ç¬¬ 10 è‡³ 17 è¡Œï¼šåˆ›å»º LazyConnectExchangeClient å¯¹è±¡ï¼Œè‹¥ä¸å­˜åœ¨ã€‚</li>
</ul>
</li>
</ul>
<h2 id="5-2-LazyConnectExchangeClient">5.2 LazyConnectExchangeClient</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-rpc/dubbo-rpc-default/src/main/java/com/alibaba/dubbo/rpc/protocol/dubbo/LazyConnectExchangeClient.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.rpc.protocol.dubbo.LazyConnectExchangeClient</code></a>&nbsp;ï¼Œå®ç° ExchangeClient æ¥å£ï¼Œ<strong>æ”¯æŒæ‡’è¿æ¥æœåŠ¡å™¨</strong>çš„ä¿¡æ¯äº¤æ¢å®¢æˆ·ç«¯å®ç°ç±»ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="keyword">static</span> <span class="keyword">final</span> String REQUEST_WITH_WARNING_KEY = <span class="string">"lazyclient_request_with_warning"</span>;</span><br /><span class="line"> <span class="number">2</span>: </span><br /><span class="line"> <span class="number">3</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 4:  * URL</span></span><br /><span class="line"><span class="comment"> 5:  */</span></span><br /><span class="line"> <span class="number">6</span>: <span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br /><span class="line"> <span class="number">7</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment"> 8:  * é€šé“å¤„ç†å™¨</span></span><br /><span class="line"><span class="comment"> 9:  */</span></span><br /><span class="line"><span class="number">10</span>: <span class="keyword">private</span> <span class="keyword">final</span> ExchangeHandler requestHandler;</span><br /><span class="line"><span class="number">11</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">12:  * è¿æ¥é”</span></span><br /><span class="line"><span class="comment">13:  */</span></span><br /><span class="line"><span class="number">14</span>: <span class="keyword">private</span> <span class="keyword">final</span> Lock connectLock = <span class="keyword">new</span> ReentrantLock();</span><br /><span class="line"><span class="number">15</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">16:  * lazy connect å¦‚æœæ²¡æœ‰åˆå§‹åŒ–æ—¶çš„è¿æ¥çŠ¶æ€</span></span><br /><span class="line"><span class="comment">17:  */</span></span><br /><span class="line"><span class="number">18</span>: <span class="comment">// lazy connect, initial state for connection</span></span><br /><span class="line"><span class="number">19</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> initialState;</span><br /><span class="line"><span class="number">20</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">21:  * é€šä¿¡å®¢æˆ·ç«¯</span></span><br /><span class="line"><span class="comment">22:  */</span></span><br /><span class="line"><span class="number">23</span>: <span class="keyword">private</span> <span class="keyword">volatile</span> ExchangeClient client;</span><br /><span class="line"><span class="number">24</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">25:  * è¯·æ±‚æ—¶ï¼Œæ˜¯å¦æ£€æŸ¥å‘Šè­¦</span></span><br /><span class="line"><span class="comment">26:  */</span></span><br /><span class="line"><span class="number">27</span>: <span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> requestWithWarning;</span><br /><span class="line"><span class="number">28</span>: <span class="comment">/**</span></span><br /><span class="line"><span class="comment">29:  * è­¦å‘Šè®¡æ•°å™¨ã€‚æ¯è¶…è¿‡ä¸€å®šæ¬¡æ•°ï¼Œæ‰“å°å‘Šè­¦æ—¥å¿—ã€‚å‚è§ {<span class="doctag">@link</span> #warning(Object)}</span></span><br /><span class="line"><span class="comment">30:  */</span></span><br /><span class="line"><span class="number">31</span>: <span class="keyword">private</span> AtomicLong warningcount = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</span><br /><span class="line"><span class="number">32</span>: </span><br /><span class="line"><span class="number">33</span>: <span class="function"><span class="keyword">public</span> <span class="title">LazyConnectExchangeClient</span><span class="params">(URL url, ExchangeHandler requestHandler)</span> </span>{</span><br /><span class="line"><span class="number">34</span>:     <span class="comment">// lazy connect, need set send.reconnect = true, to avoid channel bad status.</span></span><br /><span class="line"><span class="number">35</span>:     <span class="keyword">this</span>.url = url.addParameter(Constants.SEND_RECONNECT_KEY, Boolean.TRUE.toString());</span><br /><span class="line"><span class="number">36</span>:     <span class="keyword">this</span>.requestHandler = requestHandler;</span><br /><span class="line"><span class="number">37</span>:     <span class="keyword">this</span>.initialState = url.getParameter(Constants.LAZY_CONNECT_INITIAL_STATE_KEY, Constants.DEFAULT_LAZY_CONNECT_INITIAL_STATE);</span><br /><span class="line"><span class="number">38</span>:     <span class="keyword">this</span>.requestWithWarning = url.getParameter(REQUEST_WITH_WARNING_KEY, <span class="keyword">false</span>);</span><br /><span class="line"><span class="number">39</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>initialState</code>&nbsp;å±æ€§ï¼Œå¦‚æœæ²¡æœ‰åˆå§‹åŒ–å®¢æˆ·ç«¯æ—¶çš„é“¾æ¥çŠ¶æ€ã€‚æœ‰ç‚¹ç»•ï¼Œçœ‹&nbsp;<code>#isConnected()</code>&nbsp;æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isConnected</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (client == <span class="keyword">null</span>) { <span class="comment">// å®¢æˆ·ç«¯æœªåˆå§‹åŒ–</span></span><br /><span class="line">        <span class="keyword">return</span> initialState;</span><br /><span class="line">    } <span class="keyword">else</span> {</span><br /><span class="line">        <span class="keyword">return</span> client.isConnected();</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° ReferenceCountExchangeClient å…³é—­åˆ›å»ºçš„ LazyConnectExchangeClient å¯¹è±¡çš„&nbsp;<code>initialState = false</code>&nbsp;ï¼Œæœªè¿æ¥ã€‚</li>
<li><strong>é»˜è®¤å€¼</strong>ï¼Œ<code>DEFAULT_LAZY_CONNECT_INITIAL_STATE = true</code>&nbsp;ã€‚</li>
</ul>
</li>
<li>
<p><code>requestWithWarning</code>&nbsp;å±æ€§ï¼Œè¯·æ±‚æ—¶ï¼Œæ˜¯å¦æ£€æŸ¥å‘Šè­¦ã€‚</p>
<ul>
<li>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° ReferenceCountExchangeClient å…³é—­åˆ›å»ºçš„ LazyConnectExchangeClient å¯¹è±¡çš„&nbsp;<code>initialState = false</code>&nbsp;ï¼Œæœªè¿æ¥ã€‚</li>
<li><strong>é»˜è®¤å€¼</strong>ï¼Œ<code>false</code>&nbsp;ã€‚</li>
</ul>
</li>
<li>
<p><code>warningcount</code>&nbsp;å±æ€§ï¼Œè­¦å‘Šè®¡æ•°å™¨ã€‚æ¯è¶…è¿‡ä¸€å®šæ¬¡æ•°ï¼Œæ‰“å°å‘Šè­¦æ—¥å¿—ã€‚æ¯æ¬¡å‘é€è¯·æ±‚æ—¶ï¼Œä¼šè°ƒç”¨&nbsp;<code>#warning(request)</code>&nbsp;æ–¹æ³•ï¼Œæ ¹æ®æƒ…å†µï¼Œæ‰“å°å‘Šè­¦æ—¥å¿—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">warning</span><span class="params">(Object request)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (requestWithWarning) { <span class="comment">// å¼€å¯</span></span><br /><span class="line">        <span class="keyword">if</span> (warningcount.get() % <span class="number">5000</span> == <span class="number">0</span>) { <span class="comment">// 5000 æ¬¡</span></span><br /><span class="line">            logger.warn(<span class="keyword">new</span> IllegalStateException(<span class="string">"safe guard client , should not be called ,must have a bug."</span>));</span><br /><span class="line">        }</span><br /><span class="line">        warningcount.incrementAndGet(); <span class="comment">// å¢åŠ è®¡æ•°</span></span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç†è®ºæ¥è¯´ï¼Œä¸ä¼šè¢«è°ƒç”¨ã€‚å¦‚æœè¢«è°ƒç”¨ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸€ä¸ª BUG å’¯ã€‚</li>
</ul>
</li>
</ul>
<p><strong>è£…é¥°å™¨æ¨¡å¼</strong></p>
<p>åŸºäº<strong>è£…é¥°å™¨æ¨¡å¼</strong>ï¼Œæ‰€ä»¥ï¼Œæ¯ä¸ªå®ç°æ–¹æ³•ï¼Œéƒ½æ˜¯è°ƒç”¨&nbsp;<code>client</code>&nbsp;çš„å¯¹åº”çš„æ–¹æ³•ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(<span class="keyword">int</span> timeout)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (client != <span class="keyword">null</span>)</span><br /><span class="line">        client.close(timeout);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p><strong>åˆå§‹åŒ–å®¢æˆ·ç«¯</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initClient</span><span class="params">()</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    <span class="comment">// å·²åˆå§‹åŒ–ï¼Œè·³è¿‡</span></span><br /><span class="line">    <span class="keyword">if</span> (client != <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">return</span>;</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line">        logger.info(<span class="string">"Lazy connect to "</span> + url);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// è·å¾—é”</span></span><br /><span class="line">    connectLock.lock();</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="comment">// å·²åˆå§‹åŒ–ï¼Œè·³è¿‡</span></span><br /><span class="line">        <span class="keyword">if</span> (client != <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="keyword">return</span>;</span><br /><span class="line">        }</span><br /><span class="line">        <span class="comment">// åˆ›å»º Client ï¼Œè¿æ¥æœåŠ¡å™¨</span></span><br /><span class="line">        <span class="keyword">this</span>.client = Exchangers.connect(url, requestHandler);</span><br /><span class="line">    } <span class="keyword">finally</span> {</span><br /><span class="line">        <span class="comment">// é‡Šæ”¾é”</span></span><br /><span class="line">        connectLock.unlock();</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å‘é€æ¶ˆæ¯/è¯·æ±‚å‰ï¼Œéƒ½ä¼šè°ƒç”¨è¯¥æ–¹æ³•ï¼Œä¿è¯å®¢æˆ·ç«¯å·²ç»åˆå§‹åŒ–ã€‚ä»£ç å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(Object message, <span class="keyword">boolean</span> sent)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    initClient();</span><br /><span class="line">    client.send(message, sent);</span><br /><span class="line">}</span><br /><br /><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> ResponseFuture <span class="title">request</span><span class="params">(Object request, <span class="keyword">int</span> timeout)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    warning(request);</span><br /><span class="line">    initClient();</span><br /><span class="line">    <span class="keyword">return</span> client.request(request, timeout);</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</div>