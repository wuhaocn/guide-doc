<header class="article-header">
<h1 class="article-title">NIO æœåŠ¡å™¨ï¼ˆå…­ï¼‰ä¹‹ Netty4 å®ç°</h1>
</header>
<div class="article-entry">
<blockquote>
<p>æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚</p>
</blockquote>
<h1 id="1-æ¦‚è¿°">1. æ¦‚è¿°</h1>
<p>åœ¨å‰é¢çš„æ–‡ç« ï¼Œæˆ‘ä»¬å·²ç»äº†è§£äº†&nbsp;<code>dubbo-remoting-api</code>&nbsp;å¦‚ä½•å®ç° NIO æœåŠ¡å™¨çš„æŠ½è±¡ API å±‚ã€‚é‚£ä¹ˆæœ¬æ–‡æ¥çœ‹çœ‹ï¼Œ<code>dubbo-remoting-netty4</code>&nbsp;ï¼Œå¦‚ä½•å°† Netty4 æ¥å…¥å®ç°ã€‚</p>
<p>æ¶‰åŠå¦‚ä¸‹ç±»ï¼š</p>
<p><img src="http://static2.iocoder.cn/images/Dubbo/2018_12_16/01.png" alt="ç±»å›¾" /></p>
<blockquote>
<p>å‹æƒ…æç¤ºï¼šåœ¨å½“å‰ç‰ˆæœ¬ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Netty3 ï¼Œå¦‚æœæƒ³é…ç½®æˆ Netty4 ï¼Œè¯·å‚è€ƒæ–‡æ¡£ï¼š<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/netty4.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; Netty4ã€‹</a></p>
</blockquote>
<h1 id="2-NettyTransporter">2. NettyTransporter</h1>
<p><code>com.alibaba.dubbo.remoting.transport.netty4.NettyTransporter</code>&nbsp;ï¼Œå®ç° Transporter æ¥å£ï¼ŒåŸºäº&nbsp;<strong>Netty4</strong>&nbsp;çš„ç½‘ç»œä¼ è¾“å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyTransporter</span> <span class="keyword">implements</span> <span class="title">Transporter</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ‹“å±•å</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">"netty4"</span>;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> Server <span class="title">bind</span><span class="params">(URL url, ChannelHandler listener)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NettyServer(url, listener);</span><br /><span class="line">    }</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> Client <span class="title">connect</span><span class="params">(URL url, ChannelHandler listener)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NettyClient(url, listener);</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>NAME</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼Œæ‹“å±•åã€‚</li>
<li>NettyTransporter åŸºäº Dubbo SPI æœºåˆ¶åŠ è½½ã€‚</li>
<li>åˆ›å»º NettyServer å’Œ NettyClient å¯¹è±¡ã€‚</li>
</ul>
<h1 id="3-NettyChannel">3. NettyChannel</h1>
<p><code>io.netty.channel.ChannelFuture.NettyChannel</code>&nbsp;ï¼Œå®ç° AbstractChannel æŠ½è±¡ç±»ï¼Œ<strong>å°è£… Netty Channel</strong>&nbsp;çš„é€šé“å®ç°ç±»ã€‚</p>
<blockquote>
<p>NettyChannel å’Œ HeaderExchangeChannel å¾ˆç±»ä¼¼ã€‚</p>
</blockquote>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é€šé“é›†åˆ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;io.netty.channel.Channel, NettyChannel&gt; channelMap = <span class="keyword">new</span> ConcurrentHashMap&lt;Channel, NettyChannel&gt;();</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é€šé“</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> io.netty.channel.Channel channel;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * å±æ€§é›†åˆ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; attributes = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Object&gt;();</span><br /><br /><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">NettyChannel</span><span class="params">(io.netty.channel.Channel channel, URL url, ChannelHandler handler)</span> </span>{</span><br /><span class="line">    <span class="keyword">super</span>(url, handler);</span><br /><span class="line">    <span class="keyword">if</span> (channel == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"netty channel == null;"</span>);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">this</span>.channel = channel;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>channel</code>&nbsp;å±æ€§ï¼Œé€šé“ã€‚NettyChannel æ˜¯ä¼ å…¥&nbsp;<code>channel</code>&nbsp;å±æ€§çš„<strong>è£…é¥°å™¨</strong>ï¼Œæ¯ä¸ªå®ç°çš„æ–¹æ³•ï¼Œéƒ½ä¼šè°ƒç”¨&nbsp;<code>channel</code>&nbsp;ã€‚</li>
<li><code>attributes</code>&nbsp;å±æ€§ï¼Œå±æ€§é›†åˆã€‚<strong>æ³¨æ„</strong>ï¼Œ<code>setAttribute(...)</code>&nbsp;ç­‰æ–¹æ³•ï¼Œä½¿ç”¨çš„æ˜¯è¯¥å±æ€§ï¼Œè€Œä¸æ˜¯&nbsp;<code>io.netty.channel.Channel</code>&nbsp;çš„ã€‚</li>
<li>
<p><code>channelMap</code>&nbsp;<strong>é™æ€</strong>å±æ€§ï¼Œé€šé“é›†åˆã€‚åœ¨å®é™… Netty Handler é‡Œï¼ˆä¾‹å¦‚ä¸‹é¢æˆ‘ä»¬ä¼šçœ‹åˆ°çš„ NettyServerHandler å’Œ NettyClientHandlerï¼‰ï¼Œæ¯ä¸ªæ–¹æ³•å‚æ•°é‡Œï¼Œä¼ é€’çš„æ˜¯&nbsp;<code>io.netty.channel.Channel</code>&nbsp;å¯¹è±¡ã€‚é€šè¿‡&nbsp;<code>NettyChannel.channelMap</code>&nbsp;ä¸­ï¼Œè·å¾—å¯¹åº”çš„ NettyChannel å¯¹è±¡ã€‚</p>
<ul>
<li>
<p><code>#getOrAddChannel(ch, url, handler)</code>&nbsp;<strong>é™æ€</strong>æ–¹æ³•ï¼Œåˆ›å»º NettyChannel å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">static</span> NettyChannel <span class="title">getOrAddChannel</span><span class="params">(io.netty.channel.Channel ch, URL url, ChannelHandler handler)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (ch == <span class="keyword">null</span>) {</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">    }</span><br /><span class="line">    NettyChannel ret = channelMap.get(ch);</span><br /><span class="line">    <span class="keyword">if</span> (ret == <span class="keyword">null</span>) {</span><br /><span class="line">        NettyChannel nettyChannel = <span class="keyword">new</span> NettyChannel(ch, url, handler);</span><br /><span class="line">        <span class="keyword">if</span> (ch.isActive()) { <span class="comment">// è¿æ¥ä¸­</span></span><br /><span class="line">            ret = channelMap.putIfAbsent(ch, nettyChannel); <span class="comment">// æ·»åŠ åˆ° channelMap</span></span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">if</span> (ret == <span class="keyword">null</span>) {</span><br /><span class="line">            ret = nettyChannel;</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> ret;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>x</li>
</ul>
</li>
<li>
<p><code>#removeChannelIfDisconnected(ch)</code>&nbsp;<strong>é™æ€</strong>æ–¹æ³•ï¼Œç§»é™¤ NettyChannel å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">removeChannelIfDisconnected</span><span class="params">(io.netty.channel.Channel ch)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (ch != <span class="keyword">null</span> &amp;&amp; !ch.isActive()) { <span class="comment">// æœªè¿æ¥</span></span><br /><span class="line">        channelMap.remove(ch); <span class="comment">// ç§»é™¤å‡ºchannelMap</span></span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>x</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>å‘é€æ¶ˆæ¯</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">send</span><span class="params">(Object message, <span class="keyword">boolean</span> sent)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// æ£€æŸ¥è¿æ¥çŠ¶æ€</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">super</span>.send(message, sent);</span><br /><span class="line"> <span class="number">5</span>: </span><br /><span class="line"> <span class="number">6</span>:     <span class="keyword">boolean</span> success = <span class="keyword">true</span>; <span class="comment">// å¦‚æœæ²¡æœ‰ç­‰å¾…å‘é€æˆåŠŸï¼Œé»˜è®¤æˆåŠŸã€‚</span></span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">int</span> timeout = <span class="number">0</span>;</span><br /><span class="line"> <span class="number">8</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">9</span>:         <span class="comment">// å‘é€æ¶ˆæ¯</span></span><br /><span class="line"><span class="number">10</span>:         ChannelFuture future = channel.writeAndFlush(message);</span><br /><span class="line"><span class="number">11</span>:         <span class="comment">// ç­‰å¾…å‘é€æˆåŠŸ</span></span><br /><span class="line"><span class="number">12</span>:         <span class="keyword">if</span> (sent) {</span><br /><span class="line"><span class="number">13</span>:             timeout = getUrl().getPositiveParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT);</span><br /><span class="line"><span class="number">14</span>:             success = future.await(timeout);</span><br /><span class="line"><span class="number">15</span>:         }</span><br /><span class="line"><span class="number">16</span>:         <span class="comment">// è‹¥å‘ç”Ÿå¼‚å¸¸ï¼ŒæŠ›å‡º</span></span><br /><span class="line"><span class="number">17</span>:         Throwable cause = future.cause();</span><br /><span class="line"><span class="number">18</span>:         <span class="keyword">if</span> (cause != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">19</span>:             <span class="keyword">throw</span> cause;</span><br /><span class="line"><span class="number">20</span>:         }</span><br /><span class="line"><span class="number">21</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">22</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(<span class="keyword">this</span>, <span class="string">"Failed to send message "</span> + message + <span class="string">" to "</span> + getRemoteAddress() + <span class="string">", cause: "</span> + e.getMessage(), e);</span><br /><span class="line"><span class="number">23</span>:     }</span><br /><span class="line"><span class="number">24</span>: </span><br /><span class="line"><span class="number">25</span>:     <span class="comment">// å‘é€å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br /><span class="line"><span class="number">26</span>:     <span class="keyword">if</span> (!success) {</span><br /><span class="line"><span class="number">27</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(<span class="keyword">this</span>, <span class="string">"Failed to send message "</span> + message + <span class="string">" to "</span> + getRemoteAddress()</span><br /><span class="line"><span class="number">28</span>:                 + <span class="string">"in timeout("</span> + timeout + <span class="string">"ms) limit"</span>);</span><br /><span class="line"><span class="number">29</span>:     }</span><br /><span class="line"><span class="number">30</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 4 è¡Œï¼šè°ƒç”¨&nbsp;<code>#send(message, sent)</code>&nbsp;æ–¹æ³•ï¼Œæ£€æŸ¥è¿æ¥çŠ¶æ€ã€‚</li>
<li>ç¬¬ 6 è¡Œï¼š<code>success</code>&nbsp;ï¼Œæ˜¯å¦æ‰§è¡ŒæˆåŠŸã€‚è‹¥ä¸éœ€è¦ç­‰å¾…å‘é€æˆåŠŸ(&nbsp;<code>sent = false</code>&nbsp;) ï¼Œé»˜è®¤æˆåŠŸã€‚</li>
<li>ç¬¬ 10 è¡Œï¼šè°ƒç”¨<strong>çœŸæ­£çš„</strong>&nbsp;<code>io.netty.channel.Channel#writeAndFlush(message)</code>&nbsp;æ–¹æ³•ï¼Œå‘é€æ¶ˆæ¯ã€‚</li>
<li>ç¬¬ 11 è‡³ 15 è¡Œï¼šè‹¥éœ€è¦ç­‰å¾…å‘é€æˆåŠŸ(&nbsp;<code>sent = true</code>&nbsp;)ï¼Œç­‰å¾…ç›´åˆ°æˆåŠŸæˆ–è¶…æ—¶ã€‚</li>
<li>ç¬¬ 16 è‡³ 20 è¡Œï¼šè‹¥å‘ç”Ÿå¼‚å¸¸ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</li>
<li>ç¬¬ 26 è‡³ 29 è¡Œï¼šè‹¥å‘é€å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</li>
</ul>
<p><strong>å…³é—­é€šé“</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"Duplicates"</span>)</span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="comment">// æ ‡è®°å…³é—­</span></span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="keyword">super</span>.close();</span><br /><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line">        logger.warn(e.getMessage(), e);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// ç§»é™¤è¿æ¥</span></span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        removeChannelIfDisconnected(channel);</span><br /><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line">        logger.warn(e.getMessage(), e);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// æ¸…ç©ºå±æ€§ attributes</span></span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        attributes.clear();</span><br /><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line">        logger.warn(e.getMessage(), e);</span><br /><span class="line">    }</span><br /><span class="line">    <span class="comment">// å…³é—­çœŸæ­£çš„é€šé“ channel</span></span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line">            logger.info(<span class="string">"Close netty channel "</span> + channel);</span><br /><span class="line">        }</span><br /><span class="line">        channel.close();</span><br /><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br /><span class="line">        logger.warn(e.getMessage(), e);</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><strong>æ³¨æ„</strong>ï¼Œæœ€åä¸€æ­¥æ‰å…³é—­çœŸæ­£çš„é€šé“ï¼Œé¿å…ä¸­é—´çŠ¶æ€ã€‚</li>
</ul>
<p><strong>å…¶å®ƒæ–¹æ³•</strong></p>
<p>å…¶å®ƒå®ç°æ–¹æ³•ï¼Œæ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±ç…ç…ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isConnected</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> !isClosed() &amp;&amp; channel.isActive();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h1 id="4-Server">4. Server</h1>
<h2 id="4-1-NettyServer">4.1 NettyServer</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyServer.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty4.NettyServer</code></a>&nbsp;ï¼Œå®ç° Server æ¥å£ï¼Œç»§æ‰¿ AbstractServer æŠ½è±¡ç±»ï¼ŒNetty æœåŠ¡å™¨å®ç°ç±»ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * é€šé“é›†åˆ</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> Map&lt;String, Channel&gt; channels; <span class="comment">// &lt;ip:port, channel&gt;</span></span><br /><br /><span class="line"><span class="keyword">private</span> ServerBootstrap bootstrap;</span><br /><br /><span class="line"><span class="keyword">private</span> io.netty.channel.Channel channel;</span><br /><br /><span class="line"><span class="keyword">private</span> EventLoopGroup bossGroup;</span><br /><span class="line"><span class="keyword">private</span> EventLoopGroup workerGroup;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NettyServer</span><span class="params">(URL url, ChannelHandler handler)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    <span class="keyword">super</span>(url, ChannelHandlers.wrap(handler, ExecutorUtil.setThreadName(url, SERVER_THREAD_POOL_NAME) <span class="comment">/* è®¾ç½®çº¿ç¨‹ååˆ° URL ä¸Š */</span>));</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><code>channels</code>&nbsp;å±æ€§ï¼Œè¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é€šé“é›†åˆã€‚ç¬”è€…åœ¨çœ‹ NettyChannel æ—¶ï¼Œåœ¨æœ‰&nbsp;<code>NettyChannel.channels</code>ï¼Œé‚£ä¹ˆæ­¤å¤„çš„&nbsp;<code>channels</code>&nbsp;ä¸æ˜¯é‡å¤äº†ä¹ˆï¼Ÿç­”æ¡ˆåœ¨&nbsp;<code>#getChannel(remoteAddress)</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—<strong>æŒ‡å®šåœ°å€</strong>çš„ Channel å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> Channel <span class="title">getChannel</span><span class="params">(InetSocketAddress remoteAddress)</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> channels.get(NetUtils.toAddressString(remoteAddress));</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
</li>
<li>
<p><code>bootstrap</code>&nbsp;<code>channel</code>&nbsp;<code>bossGroup</code>&nbsp;<code>workerGroup</code>&nbsp;å±æ€§ï¼ŒğŸ˜ˆ ä¸ç†Ÿæ‚‰è¿™å‡ ä¸ªçš„èƒ–å‹ï¼Œè¯· Google ä¸€ä¸‹ Netty å…¥é—¨å™¶ã€‚</p>
</li>
<li><code>ChannelHandlers.wrap(handler, ExecutorUtil.setThreadName(url, SERVER_THREAD_POOL_NAME)</code>ä»£ç æ®µï¼ŒåŒ…è£… ChannelHandler ï¼Œå®ç° Dubbo çº¿ç¨‹æ¨¡å‹çš„åŠŸèƒ½ã€‚
<ul>
<li><a href="http://svip.iocoder.cn/Dubbo/remoting-api-transport/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ï¼ˆäºŒï¼‰ä¹‹ Transport å±‚ã€‹ã€Œ8. Dispacherã€</a>&nbsp;æœ‰è¯¦ç»†è§£æã€‚</li>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/demos/thread-model.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; çº¿ç¨‹æ¨¡å‹ã€‹</a></li>
</ul>
</li>
</ul>
<p><strong>å¯åŠ¨æœåŠ¡å™¨</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doOpen</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// è®¾ç½®æ—¥å¿—å·¥å‚</span></span><br /><span class="line"> <span class="number">4</span>:     NettyHelper.setNettyLoggerFactory();</span><br /><span class="line"> <span class="number">5</span>: </span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// å®ä¾‹åŒ– ServerBootstrap</span></span><br /><span class="line"> <span class="number">7</span>:     bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br /><span class="line"> <span class="number">8</span>: </span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// åˆ›å»ºçº¿ç¨‹ç»„</span></span><br /><span class="line"><span class="number">10</span>:     bossGroup = <span class="keyword">new</span> NioEventLoopGroup(<span class="number">1</span>, <span class="keyword">new</span> DefaultThreadFactory(<span class="string">"NettyServerBoss"</span>, <span class="keyword">true</span>));</span><br /><span class="line"><span class="number">11</span>:     workerGroup = <span class="keyword">new</span> NioEventLoopGroup(getUrl().getPositiveParameter(Constants.IO_THREADS_KEY, Constants.DEFAULT_IO_THREADS),</span><br /><span class="line"><span class="number">12</span>:             <span class="keyword">new</span> DefaultThreadFactory(<span class="string">"NettyServerWorker"</span>, <span class="keyword">true</span>));</span><br /><span class="line"><span class="number">13</span>: </span><br /><span class="line"><span class="number">14</span>:     <span class="comment">// åˆ›å»º NettyServerHandler å¯¹è±¡</span></span><br /><span class="line"><span class="number">15</span>:     <span class="keyword">final</span> NettyServerHandler nettyServerHandler = <span class="keyword">new</span> NettyServerHandler(getUrl(), <span class="keyword">this</span>);</span><br /><span class="line"><span class="number">16</span>:     <span class="comment">// è®¾ç½® `channels` å±æ€§</span></span><br /><span class="line"><span class="number">17</span>:     channels = nettyServerHandler.getChannels();</span><br /><span class="line"><span class="number">18</span>: </span><br /><span class="line"><span class="number">19</span>:     bootstrap</span><br /><span class="line"><span class="number">20</span>:             <span class="comment">// è®¾ç½®å®ƒçš„çº¿ç¨‹ç»„</span></span><br /><span class="line"><span class="number">21</span>:             .group(bossGroup, workerGroup)</span><br /><span class="line"><span class="number">22</span>:             <span class="comment">// è®¾ç½® Channelç±»å‹</span></span><br /><span class="line"><span class="number">23</span>:             .channel(NioServerSocketChannel.class) <span class="comment">// Server</span></span><br /><span class="line"><span class="number">24</span>:             <span class="comment">// è®¾ç½®å¯é€‰é¡¹</span></span><br /><span class="line"><span class="number">25</span>:             .childOption(ChannelOption.TCP_NODELAY, Boolean.TRUE)</span><br /><span class="line"><span class="number">26</span>:             .childOption(ChannelOption.SO_REUSEADDR, Boolean.TRUE)</span><br /><span class="line"><span class="number">27</span>:             .childOption(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT)</span><br /><span class="line"><span class="number">28</span>:             <span class="comment">// è®¾ç½®è´£ä»»é“¾è·¯</span></span><br /><span class="line"><span class="number">29</span>:             .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;NioSocketChannel&gt;() {</span><br /><span class="line"><span class="number">30</span>:                 <span class="meta">@Override</span></span><br /><span class="line"><span class="number">31</span>:                 <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(NioSocketChannel ch)</span> </span>{</span><br /><span class="line"><span class="number">32</span>:                     <span class="comment">// åˆ›å»º NettyCodecAdapter å¯¹è±¡</span></span><br /><span class="line"><span class="number">33</span>:                     NettyCodecAdapter adapter = <span class="keyword">new</span> NettyCodecAdapter(getCodec(), getUrl(), NettyServer.<span class="keyword">this</span>);</span><br /><span class="line"><span class="number">34</span>:                     ch.pipeline()<span class="comment">//.addLast("logging",new LoggingHandler(LogLevel.INFO))//for debug</span></span><br /><span class="line"><span class="number">35</span>:                             .addLast(<span class="string">"decoder"</span>, adapter.getDecoder()) <span class="comment">// è§£ç </span></span><br /><span class="line"><span class="number">36</span>:                             .addLast(<span class="string">"encoder"</span>, adapter.getEncoder())  <span class="comment">// è§£ç </span></span><br /><span class="line"><span class="number">37</span>:                             .addLast(<span class="string">"handler"</span>, nettyServerHandler); <span class="comment">// å¤„ç†å™¨</span></span><br /><span class="line"><span class="number">38</span>:                 }</span><br /><span class="line"><span class="number">39</span>:             });</span><br /><span class="line"><span class="number">40</span>: </span><br /><span class="line"><span class="number">41</span>:     <span class="comment">// æœåŠ¡å™¨ç»‘å®šç«¯å£ç›‘å¬</span></span><br /><span class="line"><span class="number">42</span>:     <span class="comment">// bind</span></span><br /><span class="line"><span class="number">43</span>:     ChannelFuture channelFuture = bootstrap.bind(getBindAddress());</span><br /><span class="line"><span class="number">44</span>:     channelFuture.syncUninterruptibly();</span><br /><span class="line"><span class="number">45</span>:     channel = channelFuture.channel();</span><br /><span class="line"><span class="number">46</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å‚è€ƒï¼š<a href="https://tinyzzh.github.io/netty/2014/08/12/Netty4.x_6.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠNetty4.xä¸­æ–‡æ•™ç¨‹ç³»åˆ—(å…­) ä»å¤´å¼€å§‹Bootstrapã€‹</a></li>
<li>ç¬¬ 4 è¡Œï¼šè®¾ç½® Netty çš„æ—¥å¿—å·¥å‚ï¼Œåœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-impl-netty4/">ã€Œ7. æ—¥å¿—å¤„ç†ã€</a>&nbsp;è¯¦ç»†è§£æã€‚</li>
<li>ç¬¬ 7 è¡Œï¼šå®ä¾‹åŒ– ServerBootstrap å¯¹è±¡ã€‚</li>
<li>ç¬¬ 9 è‡³ 12 è¡Œï¼šåˆ›å»º&nbsp;<code>bossGroup</code>&nbsp;<code>workerGroup</code>&nbsp;çº¿ç¨‹ç»„ã€‚</li>
<li>ç¬¬ 15 è¡Œï¼šåˆ›å»º NettyServerHandler å¯¹è±¡ã€‚</li>
<li>ç¬¬ 17 è¡Œï¼šè®¾ç½®&nbsp;<code>channels</code>&nbsp;å±æ€§ï¼ŒæŒ‡å‘&nbsp;<code>NettyServerHandler.channels</code>&nbsp;å±æ€§ã€‚</li>
<li>ç¬¬ 21 è¡Œï¼šè®¾ç½®çº¿ç¨‹ç»„ã€‚</li>
<li>ç¬¬ 23 è¡Œï¼šè®¾ç½® Channel ç±»å‹ä¸º NioServerSocketChannel ã€‚</li>
<li>ç¬¬ 24 è‡³ 27 è¡Œï¼šè®¾ç½®å¯é€‰é¡¹ã€‚
<ul>
<li><code>PooledByteBufAllocator.DEFAULT</code>&nbsp;ï¼Œå¯¹è±¡æ± ï¼Œé‡ç”¨ç¼“å†²åŒºã€‚å‚è§&nbsp;<a href="http://huangdongrong.github.io/2016/05/24/netty-jvm/" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠNetty è°ƒä¼˜ã€‹</a>&nbsp;ã€‚</li>
</ul>
</li>
<li>ç¬¬ 29 è‡³ 39 è¡Œï¼šè®¾ç½®è´£ä»»é“¾ã€‚
<ul>
<li>ç¬¬ 33 è¡Œï¼šåˆ›å»º NettyCodecAdapter å¯¹è±¡ã€‚NettyCodecAdapter åœ¨&nbsp;<a href="http://svip.iocoder.cn/Dubbo/remoting-impl-netty4/">ã€Œ6. 2 NettyCodecAdapterã€</a>&nbsp;è¯¦ç»†è§£æã€‚</li>
<li>ç¬¬ 35 è¡Œï¼šè°ƒç”¨&nbsp;<code>NettyCodecAdapter#getDecoder()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—è§£ç å™¨ï¼Œå¹¶è®¾ç½®ã€‚</li>
<li>ç¬¬ 37 è¡Œï¼šè°ƒç”¨&nbsp;<code>NettyCodecAdapter#getEncoder()</code>&nbsp;æ–¹æ³•ï¼Œè·å¾—ç¼–ç å™¨ï¼Œå¹¶è®¾ç½®ã€‚</li>
<li>ç¬¬ 37 è¡Œï¼šè®¾ç½®å¤„ç†å™¨&nbsp;<code>handler</code>&nbsp;ã€‚</li>
</ul>
</li>
<li>ç¬¬ 41 è‡³ 45 è¡Œï¼šæœåŠ¡å™¨ç»‘å®šç«¯å£ç›‘å¬ï¼Œ<strong>æ­£å¼å¯åŠ¨</strong>å•¦ã€‚</li>
</ul>
<p><strong>è·å¾—æ‰€æœ‰é€šé“</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> Collection&lt;Channel&gt; <span class="title">getChannels</span><span class="params">()</span> </span>{</span><br /><span class="line">    Collection&lt;Channel&gt; chs = <span class="keyword">new</span> HashSet&lt;Channel&gt;();</span><br /><span class="line">    <span class="keyword">for</span> (Channel channel : <span class="keyword">this</span>.channels.values()) {</span><br /><span class="line">        <span class="keyword">if</span> (channel.isConnected()) { <span class="comment">// å·²è¿æ¥ï¼Œè¿”å›</span></span><br /><span class="line">            chs.add(channel);</span><br /><span class="line">        } <span class="keyword">else</span> { <span class="comment">// æœªè¿æ¥ï¼Œç§»é™¤</span></span><br /><span class="line">            channels.remove(NetUtils.toAddressString(channel.getRemoteAddress()));</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">    <span class="keyword">return</span> chs;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p><strong>å…³é—­æœåŠ¡å™¨</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doClose</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// å…³é—­æœåŠ¡å™¨é€šé“</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (channel != <span class="keyword">null</span>) {</span><br /><span class="line"> <span class="number">6</span>:             <span class="comment">// unbind.</span></span><br /><span class="line"> <span class="number">7</span>:             channel.close();</span><br /><span class="line"> <span class="number">8</span>:         }</span><br /><span class="line"> <span class="number">9</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">10</span>:         logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">11</span>:     }</span><br /><span class="line"><span class="number">12</span>:     <span class="comment">// å…³é—­è¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é€šé“</span></span><br /><span class="line"><span class="number">13</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">14</span>:         Collection&lt;com.alibaba.dubbo.remoting.Channel&gt; channels = getChannels();</span><br /><span class="line"><span class="number">15</span>:         <span class="keyword">if</span> (channels != <span class="keyword">null</span> &amp;&amp; channels.size() &gt; <span class="number">0</span>) {</span><br /><span class="line"><span class="number">16</span>:             <span class="keyword">for</span> (com.alibaba.dubbo.remoting.Channel channel : channels) {</span><br /><span class="line"><span class="number">17</span>:                 <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">18</span>:                     channel.close();</span><br /><span class="line"><span class="number">19</span>:                 } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">20</span>:                     logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">21</span>:                 }</span><br /><span class="line"><span class="number">22</span>:             }</span><br /><span class="line"><span class="number">23</span>:         }</span><br /><span class="line"><span class="number">24</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">25</span>:         logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">26</span>:     }</span><br /><span class="line"><span class="number">27</span>:     <span class="comment">// ä¼˜é›…å…³é—­å·¥ä½œç»„</span></span><br /><span class="line"><span class="number">28</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">29</span>:         <span class="keyword">if</span> (bootstrap != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">30</span>:             bossGroup.shutdownGracefully();</span><br /><span class="line"><span class="number">31</span>:             workerGroup.shutdownGracefully();</span><br /><span class="line"><span class="number">32</span>:         }</span><br /><span class="line"><span class="number">33</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">34</span>:         logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">35</span>:     }</span><br /><span class="line"><span class="number">36</span>:     <span class="comment">// æ¸…ç©ºè¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é€šé“</span></span><br /><span class="line"><span class="number">37</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">38</span>:         <span class="keyword">if</span> (channels != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">39</span>:             channels.clear();</span><br /><span class="line"><span class="number">40</span>:         }</span><br /><span class="line"><span class="number">41</span>:     } <span class="keyword">catch</span> (Throwable e) {</span><br /><span class="line"><span class="number">42</span>:         logger.warn(e.getMessage(), e);</span><br /><span class="line"><span class="number">43</span>:     }</span><br /><span class="line"><span class="number">44</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 3 è‡³ 11 è¡Œï¼šå…³é—­æœåŠ¡å™¨é€šé“(&nbsp;<code>io.netty.channel.Channel</code>&nbsp;)ã€‚</li>
<li>ç¬¬ 12 è‡³ 26 è¡Œï¼šå…³é—­è¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é€šé“(&nbsp;<code>com.alibaba.dubbo.remoting.Channel</code>&nbsp;) ã€‚</li>
<li>ç¬¬ 27 è‡³ 35 è¡Œï¼šä¼˜é›…å…³é—­å·¥ä½œç»„ã€‚</li>
<li>ç¬¬ 36 è‡³ 43 è¡Œï¼šæ¸…ç©ºè¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é€šé“ã€‚</li>
</ul>
<h2 id="4-2-NettyServerHandler">4.2 NettyServerHandler</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyServerHandler.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty4.NettyServerHandler</code></a>&nbsp;ï¼Œå®ç°&nbsp;<code>io.netty.channel.ChannelDuplexHandler</code>&nbsp;ç±»ï¼ŒNettyServer çš„å¤„ç†å™¨ã€‚</p>
<blockquote>
<p>NettyServerHandler å’Œ HeaderExchangeHandler ç±»ä¼¼ã€‚</p>
</blockquote>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@io</span>.netty.channel.ChannelHandler.Sharable</span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyServerHandler</span> <span class="keyword">extends</span> <span class="title">ChannelDuplexHandler</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Dubbo Channel é›†åˆ</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Channel&gt; channels = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Channel&gt;(); <span class="comment">// &lt;ip:port, channel&gt;</span></span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * URL</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Dubbo ChannelHandler</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChannelHandler handler;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NettyServerHandler</span><span class="params">(URL url, ChannelHandler handler)</span> </span>{</span><br /><span class="line">        <span class="keyword">if</span> (url == <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"url == null"</span>);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">if</span> (handler == <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"handler == null"</span>);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">this</span>.url = url;</span><br /><span class="line">        <span class="keyword">this</span>.handler = handler;</span><br /><span class="line">    }</span><br />    <br /><span class="line">    <span class="comment">// ... çœç•¥å®ç°æ–¹æ³•</span></span><br />    <br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>
<p><a href="mailto:%60@io.netty.channel.ChannelHandler.Sharable" target="_blank" rel="external nofollow noopener noreferrer">`@io.netty.channel.ChannelHandler.Sharable</a>` æ³¨è§£ï¼š</p>
<blockquote>
<p>FROM&nbsp;<a href="https://www.zhihu.com/question/50198921" target="_blank" rel="external nofollow noopener noreferrer">ã€Šnetty4ä¸­æ³¨è§£Sharableçš„ä½¿ç”¨åœºæ™¯ï¼Ÿã€‹</a></p>
<p>Sharable æ³¨è§£ä¸»è¦æ˜¯ç”¨æ¥æ ‡ç¤ºä¸€ä¸ª ChannelHandler å¯ä»¥è¢«å®‰å…¨åœ°å…±äº«ï¼Œå³å¯ä»¥åœ¨å¤šä¸ªChannel çš„ ChannelPipeline ä¸­ä½¿ç”¨åŒä¸€ä¸ªChannelHandler ï¼Œè€Œä¸å¿…æ¯ä¸€ä¸ªChannelPipeline éƒ½é‡æ–° new ä¸€ä¸ªæ–°çš„ ChannelHandler ã€‚</p>
</blockquote>
</li>
<li>
<p><code>channels</code>&nbsp;å±æ€§ï¼Œè¿æ¥åˆ°æœåŠ¡å™¨çš„ Dubbo Channel é›†åˆã€‚</p>
</li>
<li><code>handler</code>&nbsp;å±æ€§ï¼ŒDubbo ChannelHandlerã€‚NettyServerHandler å¯¹æ¯ä¸ªäº‹ä»¶çš„å¤„ç†ï¼Œä¼šè°ƒç”¨&nbsp;<code>handler</code>&nbsp;å¯¹åº”çš„æ–¹æ³•ã€‚</li>
</ul>
<p><strong>å®ç°æ–¹æ³•</strong></p>
<p>æ¯ä¸ªå®ç°çš„æ–¹æ³•ï¼Œå¤„ç†éƒ½æ¯”è¾ƒç±»ä¼¼ï¼Œä¸€èˆ¬æ˜¯æäº¤ç»™&nbsp;<code>handler</code>&nbsp;åšç›¸åº”çš„å¤„ç†ã€‚è‰¿è‰¿å·²ç»æ·»åŠ äº†ä»£ç æ³¨é‡Šï¼Œèƒ–å‹å¯ä»¥è‡ªå·±çœ‹çœ‹ã€‚ä¸‹é¢ä»¥&nbsp;<code>#channelActive(ChannelHandlerContext)</code>&nbsp;æ–¹æ³•ä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// äº¤ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å¤„ç†</span></span><br /><span class="line"> <span class="number">4</span>:     <span class="comment">// èŠ‹è‰¿ï¼šå®é™…æ­¤å¤„ä¸è¦è°ƒç”¨ä¹Ÿæ²¡å…³ç³»ï¼Œå› ä¸º NettyServerHandler æ²¡ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</span></span><br /><span class="line"> <span class="number">5</span>:     ctx.fireChannelActive();</span><br /><span class="line"> <span class="number">6</span>: </span><br /><span class="line"> <span class="number">7</span>:     <span class="comment">// åˆ›å»º NettyChannel å¯¹è±¡</span></span><br /><span class="line"> <span class="number">8</span>:     NettyChannel channel = NettyChannel.getOrAddChannel(ctx.channel(), url, handler);</span><br /><span class="line"> <span class="number">9</span>:     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">10</span>:         <span class="comment">// æ·»åŠ åˆ° `channels` ä¸­</span></span><br /><span class="line"><span class="number">11</span>:         <span class="keyword">if</span> (channel != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">12</span>:             channels.put(NetUtils.toAddressString((InetSocketAddress) ctx.channel().remoteAddress()), channel);</span><br /><span class="line"><span class="number">13</span>:         }</span><br /><span class="line"><span class="number">14</span>:         <span class="comment">// æäº¤ç»™ `handler` å¤„ç†å™¨ã€‚</span></span><br /><span class="line"><span class="number">15</span>:         handler.connected(channel);</span><br /><span class="line"><span class="number">16</span>:     } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">17</span>:         <span class="comment">// ç§»é™¤ NettyChannel å¯¹è±¡ï¼Œè‹¥å·²æ–­å¼€</span></span><br /><span class="line"><span class="number">18</span>:         NettyChannel.removeChannelIfDisconnected(ctx.channel());</span><br /><span class="line"><span class="number">19</span>:     }</span><br /><span class="line"><span class="number">20</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><a href="https://www.jianshu.com/p/88ffafa23221" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠNetty æ¡†æ¶æ€»ç»“ã€ŒChannelHandler åŠ EventLoopã€ã€‹</a></li>
<li>ç¬¬ 5 è¡Œï¼šè°ƒç”¨&nbsp;<code>ChannelHandlerContext#fireChannelActive()</code>&nbsp;æ–¹æ³•ï¼Œäº¤ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å¤„ç†ã€‚å®é™…ä¸Šï¼Œ<strong>æ­¤å¤„ä¸è¦è°ƒç”¨ä¹Ÿæ²¡å…³ç³»</strong>ï¼Œå› ä¸º NettyServerHandler æ²¡ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li>
<li>ç¬¬ 8 è¡Œï¼šè°ƒç”¨&nbsp;<code>NettyChannel#getOrAddChannel(channel, url, handler)</code>&nbsp;æ–¹æ³•ï¼Œåˆ›å»º NettyChannel å¯¹è±¡ã€‚</li>
<li>ç¬¬ 10 è‡³ 13 è¡Œï¼šæ·»åŠ åˆ°&nbsp;<code>channels</code>&nbsp;ä¸­ã€‚</li>
<li>ç¬¬ 15 è¡Œï¼šè°ƒç”¨&nbsp;<code>ChannelHandler#connected(channel)</code>&nbsp;æ–¹æ³•ï¼Œå¤„ç†è¿æ¥äº‹ä»¶ã€‚</li>
<li>ç¬¬ 16 è‡³ 19 è¡Œï¼šè°ƒç”¨&nbsp;<code>NettyChannel#removeChannelIfDisconnected(channel)</code>&nbsp;æ–¹æ³•ï¼Œç§»é™¤ NettyChannel å¯¹è±¡ï¼Œè‹¥<strong>å·²æ–­å¼€</strong>ã€‚</li>
</ul>
<h1 id="5-Client">5. Client</h1>
<h2 id="5-1-NettyClient">5.1 NettyClient</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyClient.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty4.NettyClient</code></a>&nbsp;ï¼Œç»§æ‰¿ AbstractNettyClient æŠ½è±¡ç±»ï¼ŒNetty å®¢æˆ·ç«¯å®ç°ç±»ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">// ã€TODO 8027ã€‘ä¸ºå•¥å…¬ç”¨</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> NioEventLoopGroup nioEventLoopGroup = <span class="keyword">new</span> NioEventLoopGroup(Constants.DEFAULT_IO_THREADS, <span class="keyword">new</span> DefaultThreadFactory(<span class="string">"NettyClientWorker"</span>, <span class="keyword">true</span>));</span><br /><br /><span class="line"><span class="keyword">private</span> Bootstrap bootstrap;</span><br /><br /><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> io.netty.channel.Channel channel; <span class="comment">// volatile, please copy reference to use</span></span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NettyClient</span><span class="params">(<span class="keyword">final</span> URL url, <span class="keyword">final</span> ChannelHandler handler)</span> <span class="keyword">throws</span> RemotingException </span>{</span><br /><span class="line">    <span class="keyword">super</span>(url, wrapChannelHandler(url, handler));</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>nioEventLoopGroup</code>&nbsp;å±æ€§ï¼Œã€TODO 8027ã€‘ä¸ºå•¥å…¬ç”¨</li>
<li><code>channel</code>&nbsp;å±æ€§ï¼Œé€šé“ï¼Œæœ‰&nbsp;<strong>volatile</strong>&nbsp;ä¿®é¥°ç¬¦ã€‚å› ä¸ºå®¢æˆ·ç«¯å¯èƒ½ä¼šæ–­å¼€é‡è¿ï¼Œéœ€è¦ä¿è¯<strong>å¤šçº¿ç¨‹</strong>çš„å¯è§æ€§ã€‚</li>
<li><code>#wrapChannelHandler(url, handler)</code>&nbsp;ä»£ç æ®µï¼ŒåŒ…è£… ChannelHandler ï¼Œå®ç° Dubbo çº¿ç¨‹æ¨¡å‹çš„åŠŸèƒ½ã€‚
<ul>
<li><a href="http://svip.iocoder.cn/Dubbo/remoting-api-transport/?self">ã€Šç²¾å°½ Dubbo æºç åˆ†æ &mdash;&mdash; NIO æœåŠ¡å™¨ï¼ˆäºŒï¼‰ä¹‹ Transport å±‚ã€‹ã€Œ8. Dispacherã€</a>&nbsp;æœ‰è¯¦ç»†è§£æã€‚</li>
<li><a href="http://dubbo.apache.org/zh-cn/docs/user/demos/thread-model.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; çº¿ç¨‹æ¨¡å‹ã€‹</a></li>
</ul>
</li>
</ul>
<p><strong>å¯åŠ¨å®¢æˆ·ç«¯</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doOpen</span><span class="params">()</span> </span>{</span><br /><span class="line"> <span class="number">3</span>:     <span class="comment">// è®¾ç½®æ—¥å¿—å·¥å‚</span></span><br /><span class="line"> <span class="number">4</span>:     NettyHelper.setNettyLoggerFactory();</span><br /><span class="line"> <span class="number">5</span>: </span><br /><span class="line"> <span class="number">6</span>:     <span class="comment">// åˆ›å»º NettyClientHandler å¯¹è±¡</span></span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">final</span> NettyClientHandler nettyClientHandler = <span class="keyword">new</span> NettyClientHandler(getUrl(), <span class="keyword">this</span>);</span><br /><span class="line"> <span class="number">8</span>: </span><br /><span class="line"> <span class="number">9</span>:     <span class="comment">// å®ä¾‹åŒ– ServerBootstrap</span></span><br /><span class="line"><span class="number">10</span>:     bootstrap = <span class="keyword">new</span> Bootstrap();</span><br /><span class="line"><span class="number">11</span>:     bootstrap</span><br /><span class="line"><span class="number">12</span>:             <span class="comment">// è®¾ç½®å®ƒçš„çº¿ç¨‹ç»„</span></span><br /><span class="line"><span class="number">13</span>:             .group(nioEventLoopGroup)</span><br /><span class="line"><span class="number">14</span>:             <span class="comment">// è®¾ç½®å¯é€‰é¡¹</span></span><br /><span class="line"><span class="number">15</span>:             .option(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>)</span><br /><span class="line"><span class="number">16</span>:             .option(ChannelOption.TCP_NODELAY, <span class="keyword">true</span>)</span><br /><span class="line"><span class="number">17</span>:             .option(ChannelOption.ALLOCATOR, PooledByteBufAllocator.DEFAULT)</span><br /><span class="line"><span class="number">18</span>:             <span class="comment">//.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, getTimeout())</span></span><br /><span class="line"><span class="number">19</span>:             <span class="comment">// è®¾ç½® Channelç±»å‹</span></span><br /><span class="line"><span class="number">20</span>:             .channel(NioSocketChannel.class);</span><br /><span class="line"><span class="number">21</span>: </span><br /><span class="line"><span class="number">22</span>:     <span class="comment">// è®¾ç½®è¿æ¥è¶…æ—¶æ—¶é—´</span></span><br /><span class="line"><span class="number">23</span>:     <span class="keyword">if</span> (getTimeout() &lt; <span class="number">3000</span>) {</span><br /><span class="line"><span class="number">24</span>:         bootstrap.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, <span class="number">3000</span>);</span><br /><span class="line"><span class="number">25</span>:     } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">26</span>:         bootstrap.option(ChannelOption.CONNECT_TIMEOUT_MILLIS, getTimeout());</span><br /><span class="line"><span class="number">27</span>:     }</span><br /><span class="line"><span class="number">28</span>: </span><br /><span class="line"><span class="number">29</span>:     <span class="comment">// è®¾ç½®è´£ä»»é“¾è·¯</span></span><br /><span class="line"><span class="number">30</span>:     bootstrap.handler(<span class="keyword">new</span> ChannelInitializer() {</span><br /><span class="line"><span class="number">31</span>:         <span class="meta">@Override</span></span><br /><span class="line"><span class="number">32</span>:         <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(Channel ch)</span> </span>{</span><br /><span class="line"><span class="number">33</span>:             <span class="comment">// åˆ›å»º NettyCodecAdapter å¯¹è±¡</span></span><br /><span class="line"><span class="number">34</span>:             NettyCodecAdapter adapter = <span class="keyword">new</span> NettyCodecAdapter(getCodec(), getUrl(), NettyClient.<span class="keyword">this</span>);</span><br /><span class="line"><span class="number">35</span>:             ch.pipeline()<span class="comment">//.addLast("logging",new LoggingHandler(LogLevel.INFO))//for debug</span></span><br /><span class="line"><span class="number">36</span>:                     .addLast(<span class="string">"decoder"</span>, adapter.getDecoder()) <span class="comment">// è§£ç </span></span><br /><span class="line"><span class="number">37</span>:                     .addLast(<span class="string">"encoder"</span>, adapter.getEncoder()) <span class="comment">// è§£ç </span></span><br /><span class="line"><span class="number">38</span>:                     .addLast(<span class="string">"handler"</span>, nettyClientHandler); <span class="comment">// å¤„ç†å™¨</span></span><br /><span class="line"><span class="number">39</span>:         }</span><br /><span class="line"><span class="number">40</span>:     });</span><br /><span class="line"><span class="number">41</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>å’Œ&nbsp;<code>NettyClient#doOpen()</code>&nbsp;æ–¹æ³•ç±»ä¼¼ã€‚æˆ‘ä»¬ä»…ä»…è¯´ä¸€äº›å·®å¼‚ç‚¹ã€‚</li>
<li>ç¬¬ 7 è¡Œï¼šåˆ›å»º NettyClientHandler å¯¹è±¡ã€‚</li>
<li>ç¬¬ 13 è¡Œï¼šè®¾ç½®çº¿ç¨‹ç»„ï¼Œæ²¡æœ‰&nbsp;<code>bossGroup</code>&nbsp;ã€‚</li>
<li>ç¬¬ 20 è¡Œï¼šè®¾ç½® Channel ç±»å‹ä¸º NioSocketChannel ã€‚</li>
<li>ç¬¬ 22 è‡³ 27 è¡Œï¼šè®¾ç½®è¿æ¥è¶…æ—¶æ—¶é—´ã€‚</li>
</ul>
<p><strong>è¿æ¥æœåŠ¡å™¨</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br /><span class="line"> <span class="number">2</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"Duplicates"</span>)</span><br /><span class="line"> <span class="number">3</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doConnect</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>{</span><br /><span class="line"> <span class="number">4</span>:     <span class="keyword">long</span> start = System.currentTimeMillis();</span><br /><span class="line"> <span class="number">5</span>:     <span class="comment">// è¿æ¥æœåŠ¡å™¨</span></span><br /><span class="line"> <span class="number">6</span>:     ChannelFuture future = bootstrap.connect(getConnectAddress());</span><br /><span class="line"> <span class="number">7</span>:     <span class="keyword">try</span> {</span><br /><span class="line"> <span class="number">8</span>:         <span class="comment">// ç­‰å¾…è¿æ¥æˆåŠŸæˆ–è€…è¶…æ—¶</span></span><br /><span class="line"> <span class="number">9</span>:         <span class="keyword">boolean</span> ret = future.awaitUninterruptibly(<span class="number">3000</span>, TimeUnit.MILLISECONDS);</span><br /><span class="line"><span class="number">10</span>:         <span class="comment">// è¿æ¥æˆåŠŸ</span></span><br /><span class="line"><span class="number">11</span>:         <span class="keyword">if</span> (ret &amp;&amp; future.isSuccess()) {</span><br /><span class="line"><span class="number">12</span>:             Channel newChannel = future.channel();</span><br /><span class="line"><span class="number">13</span>:             <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">14</span>:                 <span class="comment">// å…³é—­è€çš„è¿æ¥</span></span><br /><span class="line"><span class="number">15</span>:                 <span class="comment">// Close old channel</span></span><br /><span class="line"><span class="number">16</span>:                 Channel oldChannel = NettyClient.<span class="keyword">this</span>.channel; <span class="comment">// copy reference</span></span><br /><span class="line"><span class="number">17</span>:                 <span class="keyword">if</span> (oldChannel != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">18</span>:                     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">19</span>:                         <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"><span class="number">20</span>:                             logger.info(<span class="string">"Close old netty channel "</span> + oldChannel + <span class="string">" on create new netty channel "</span> + newChannel);</span><br /><span class="line"><span class="number">21</span>:                         }</span><br /><span class="line"><span class="number">22</span>:                         oldChannel.close();</span><br /><span class="line"><span class="number">23</span>:                     } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">24</span>:                         NettyChannel.removeChannelIfDisconnected(oldChannel);</span><br /><span class="line"><span class="number">25</span>:                     }</span><br /><span class="line"><span class="number">26</span>:                 }</span><br /><span class="line"><span class="number">27</span>:             } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">28</span>:                 <span class="comment">// è‹¥ NettyClient è¢«å…³é—­ï¼Œå…³é—­è¿æ¥</span></span><br /><span class="line"><span class="number">29</span>:                 <span class="keyword">if</span> (NettyClient.<span class="keyword">this</span>.isClosed()) {</span><br /><span class="line"><span class="number">30</span>:                     <span class="keyword">try</span> {</span><br /><span class="line"><span class="number">31</span>:                         <span class="keyword">if</span> (logger.isInfoEnabled()) {</span><br /><span class="line"><span class="number">32</span>:                             logger.info(<span class="string">"Close new netty channel "</span> + newChannel + <span class="string">", because the client closed."</span>);</span><br /><span class="line"><span class="number">33</span>:                         }</span><br /><span class="line"><span class="number">34</span>:                         newChannel.close();</span><br /><span class="line"><span class="number">35</span>:                     } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">36</span>:                         NettyClient.<span class="keyword">this</span>.channel = <span class="keyword">null</span>;</span><br /><span class="line"><span class="number">37</span>:                         NettyChannel.removeChannelIfDisconnected(newChannel);</span><br /><span class="line"><span class="number">38</span>:                     }</span><br /><span class="line"><span class="number">39</span>:                 <span class="comment">// è®¾ç½®æ–°è¿æ¥</span></span><br /><span class="line"><span class="number">40</span>:                 } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">41</span>:                     NettyClient.<span class="keyword">this</span>.channel = newChannel;</span><br /><span class="line"><span class="number">42</span>:                 }</span><br /><span class="line"><span class="number">43</span>:             }</span><br /><span class="line"><span class="number">44</span>:         <span class="comment">// å‘ç”Ÿå¼‚å¸¸ï¼ŒæŠ›å‡º RemotingException å¼‚å¸¸</span></span><br /><span class="line"><span class="number">45</span>:         } <span class="keyword">else</span> <span class="keyword">if</span> (future.cause() != <span class="keyword">null</span>) {</span><br /><span class="line"><span class="number">46</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(<span class="keyword">this</span>, <span class="string">"client(url: "</span> + getUrl() + <span class="string">") failed to connect to server "</span></span><br /><span class="line"><span class="number">47</span>:                     + getRemoteAddress() + <span class="string">", error message is:"</span> + future.cause().getMessage(), future.cause());</span><br /><span class="line"><span class="number">48</span>:         <span class="comment">// æ— ç»“æœï¼ˆè¿æ¥è¶…æ—¶ï¼‰ï¼ŒæŠ›å‡º RemotingException å¼‚å¸¸</span></span><br /><span class="line"><span class="number">49</span>:         } <span class="keyword">else</span> {</span><br /><span class="line"><span class="number">50</span>:             <span class="keyword">throw</span> <span class="keyword">new</span> RemotingException(<span class="keyword">this</span>, <span class="string">"client(url: "</span> + getUrl() + <span class="string">") failed to connect to server "</span></span><br /><span class="line"><span class="number">51</span>:                     + getRemoteAddress() + <span class="string">" client-side timeout "</span></span><br /><span class="line"><span class="number">52</span>:                     + getConnectTimeout() + <span class="string">"ms (elapsed: "</span> + (System.currentTimeMillis() - start) + <span class="string">"ms) from netty client "</span></span><br /><span class="line"><span class="number">53</span>:                     + NetUtils.getLocalHost() + <span class="string">" using dubbo version "</span> + Version.getVersion());</span><br /><span class="line"><span class="number">54</span>:         }</span><br /><span class="line"><span class="number">55</span>:     } <span class="keyword">finally</span> {</span><br /><span class="line"><span class="number">56</span>:         <span class="keyword">if</span> (!isConnected()) {</span><br /><span class="line"><span class="number">57</span>:             <span class="comment">//future.cancel(true);</span></span><br /><span class="line"><span class="number">58</span>:         }</span><br /><span class="line"><span class="number">59</span>:     }</span><br /><span class="line"><span class="number">60</span>: }</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ç¬¬ 6 è¡Œï¼šè°ƒç”¨&nbsp;<code>Bootstrap#connect(remoteAddress)</code>&nbsp;æ–¹æ³•ï¼Œè¿æ¥æœåŠ¡å™¨ã€‚</li>
<li>ç¬¬ 9 è¡Œï¼šè°ƒç”¨&nbsp;<code>ChannelFuture#awaitUninterruptibly(3000, TimeUnit)</code>&nbsp;æ–¹æ³•ï¼Œç­‰å¾…è¿æ¥æˆåŠŸæˆ–è¶…æ—¶ã€‚è¿™é‡Œä¼ å…¥&nbsp;<code>3000</code>&nbsp;è²Œä¼¼ä¸å¤ªæ­£ç¡®ï¼Œåº”è¯¥ä¼ å…¥&nbsp;<code>ChannelOption.CONNECT_TIMEOUT_MILLIS</code>&nbsp;çš„å®é™…å€¼ã€‚</li>
<li>ç¬¬ 10 è‡³ 43 è¡Œï¼šè¿æ¥æˆåŠŸã€‚
<ul>
<li>ç¬¬ 14 è‡³ 26 è¡Œï¼šè‹¥å­˜åœ¨<strong>è€çš„</strong>è¿æ¥ï¼Œè°ƒç”¨&nbsp;<code>Channel#close()</code>&nbsp;æ–¹æ³•ï¼Œè¿›è¡Œå…³é—­ã€‚</li>
<li>ç¬¬ 29 è‡³ 38 è¡Œï¼šè‹¥ NettyClient è¢«å…³é—­ï¼Œè°ƒç”¨&nbsp;<code>Channel#close()</code>&nbsp;æ–¹æ³•ï¼Œå…³é—­<strong>æ–°çš„è¿æ¥</strong>ã€‚</li>
<li>ç¬¬ 39 è‡³ 42 è¡Œï¼šè®¾ç½®<strong>æ–°çš„è¿æ¥</strong>åˆ°&nbsp;<code>channel</code>ã€‚</li>
</ul>
</li>
<li>ç¬¬ 44 è‡³ 47 è¡Œï¼šå‘ç”Ÿå¼‚å¸¸ï¼ŒæŠ›å‡º&nbsp;<strong>Server</strong>&nbsp;RemotingException å¼‚å¸¸ã€‚</li>
<li>ç¬¬ 48 è‡³ 54 è¡Œï¼šæ— ç»“æœï¼ˆè¿æ¥è¶…æ—¶ï¼‰ï¼ŒæŠ›å‡º&nbsp;<strong>Client</strong>&nbsp;RemotingException å¼‚å¸¸ã€‚</li>
<li>ç¬¬ 55 è‡³ 59 è¡Œï¼š// ã€TODO 8028ã€‘ä¸ºä»€ä¹ˆä¸å–æ¶ˆ future TODO å¯èƒ½ï¼Œå’Œ 3000 æœ‰å…³ç³»ã€‚&lt; 3000 å¼ºåˆ¶ 3000 ã€‚ä»¥åŠç­‰å¾… 3000</li>
</ul>
<p><strong>æ–­å¼€è¿æ¥</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doDisConnect</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">try</span> {</span><br /><span class="line">        NettyChannel.removeChannelIfDisconnected(channel);</span><br /><span class="line">    } <span class="keyword">catch</span> (Throwable t) {</span><br /><span class="line">        logger.warn(t.getMessage());</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p><strong>å…³é—­è¿æ¥</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doClose</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>{</span><br /><span class="line">    <span class="comment">//can't shutdown nioEventLoopGroup</span></span><br /><span class="line">    <span class="comment">//nioEventLoopGroup.shutdownGracefully();</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="5-2-NettyClientHandler">5.2 NettyClientHandler</h2>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyClientHandler.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty4.NettyClientHandler</code></a>&nbsp;ï¼Œå®ç°&nbsp;<code>io.netty.channel.ChannelDuplexHandler</code>&nbsp;ç±»ï¼ŒNettyClient çš„å¤„ç†å™¨ã€‚</p>
<blockquote>
<p>NettyServerHandler å’Œ HeaderExchangeHandler ç±»ä¼¼ã€‚</p>
</blockquote>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@io</span>.netty.channel.ChannelHandler.Sharable</span><br /><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyClientHandler</span> <span class="keyword">extends</span> <span class="title">ChannelDuplexHandler</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Dubbo URL</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * Dubbo ChannelHandler</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChannelHandler handler;</span><br /><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NettyClientHandler</span><span class="params">(URL url, ChannelHandler handler)</span> </span>{</span><br /><span class="line">        <span class="keyword">if</span> (url == <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"url == null"</span>);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">if</span> (handler == <span class="keyword">null</span>) {</span><br /><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"handler == null"</span>);</span><br /><span class="line">        }</span><br /><span class="line">        <span class="keyword">this</span>.url = url;</span><br /><span class="line">        <span class="keyword">this</span>.handler = handler;</span><br /><span class="line">    }</span><br />    <br /><span class="line">    <span class="comment">// ... çœç•¥å®ç°æ–¹æ³•</span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<p><strong>å®ç°æ–¹æ³•</strong></p>
<p>NettyClientHandler çš„<strong>å¤„ç†æ–¹å¼</strong>ï¼Œå’Œ NettyServerHandler å¤§ä½“ä¸€è‡´ï¼Œä½†æ˜¯ä¹Ÿå­˜åœ¨<strong>ä¸€å®šçš„å·®å¼‚</strong>ï¼Œä»¥&nbsp;<code>#channelActive(ChannelHandlerContext)</code>&nbsp;æ–¹æ³•ä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> </span>{</span><br /><span class="line">    ctx.fireChannelActive();</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>ä¸åŒäº NettyServerHandler çš„è¯¥æ–¹æ³•ï¼Œä¼šæäº¤ç»™&nbsp;<code>handler</code>&nbsp;ç»§ç»­å¤„ç†ã€‚å› ä¸ºï¼Œå®¢æˆ·ç«¯ä¸ä¼šè¢«è¿æ¥ï¼Œæ— éœ€åšè¿å…¥ Channel çš„ç®¡ç†ã€‚</li>
</ul>
<p>ğŸ™‚ å…¶ä»–æ–¹æ³•ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚</p>
<h1 id="6-NettyBackedChannelBuffer">6. NettyBackedChannelBuffer</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyBackedChannelBuffer.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty4.NettyBackedChannelBuffer</code></a>&nbsp;ï¼Œå®ç° ChannelBuffer æ¥å£ï¼ŒåŸºäº&nbsp;<strong>Netty ByteBuf</strong>&nbsp;çš„ ChannelBuffer å®ç°ç±»ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> ByteBuf buffer;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NettyBackedChannelBuffer</span><span class="params">(ByteBuf buffer)</span> </span>{</span><br /><span class="line">    Assert.notNull(buffer, <span class="string">"buffer == null"</span>);</span><br /><span class="line">    <span class="keyword">this</span>.buffer = buffer;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><a href="https://waylau.gitbooks.io/essential-netty-in-action/CORE%20FUNCTIONS/ByteBuf%20-%20The%20byte%20data%20container.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠByteBuf - å­—èŠ‚æ•°æ®çš„å®¹å™¨ã€‹</a></li>
</ul>
<p><strong>å·¥å‚</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="comment">//has nothing use</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> ChannelBufferFactory <span class="title">factory</span><span class="params">()</span> </span>{</span><br /><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æ— ä½¿ç”¨å·¥å‚çš„åœ°æ–¹ã€‚</li>
<li>å¦å¤–ï¼ŒByteBuf é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¹é‡ä¸º Integer.MAX_VALUE ã€‚</li>
</ul>
<p><strong>å®ç°æ–¹æ³•</strong></p>
<p>æ¯ä¸ªæ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ ByteBuf å¯¹åº”çš„æ–¹æ³•ã€‚ğŸ™‚ ChannelBuffer æ˜¯ä»¥ ByteBuf ä¸º<strong>åŸå‹</strong>ï¼Œè®¾è®¡çš„æ¥å£ API ã€‚</p>
<h1 id="7-NettyCodecAdapter">7. NettyCodecAdapter</h1>
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/NettyCodecAdapter.java" target="_blank" rel="external nofollow noopener noreferrer"><code>com.alibaba.dubbo.remoting.transport.netty4.NettyCodecAdapter</code></a>&nbsp;ï¼ŒNetty ç¼–è§£ç <strong>é€‚é…å™¨</strong>ï¼Œå°†&nbsp;<strong>Dubbo ç¼–è§£ç å™¨</strong>&nbsp;é€‚é…æˆ Netty4 çš„ç¼–ç å™¨å’Œè§£ç å™¨ã€‚</p>
<p><strong>æ„é€ æ–¹æ³•</strong></p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Netty ç¼–ç å™¨</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelHandler encoder = <span class="keyword">new</span> InternalEncoder();</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Netty è§£ç å™¨</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelHandler decoder = <span class="keyword">new</span> InternalDecoder();</span><br /><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Dubbo ç¼–è§£ç å™¨</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Codec2 codec;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Dubbo URL</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> URL url;</span><br /><span class="line"><span class="comment">/**</span></span><br /><span class="line"><span class="comment"> * Dubbo ChannelHandler</span></span><br /><span class="line"><span class="comment"> */</span></span><br /><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> com.alibaba.dubbo.remoting.ChannelHandler handler;</span><br /><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NettyCodecAdapter</span><span class="params">(Codec2 codec, URL url, com.alibaba.dubbo.remoting.ChannelHandler handler)</span> </span>{</span><br /><span class="line">    <span class="keyword">this</span>.codec = codec;</span><br /><span class="line">    <span class="keyword">this</span>.url = url;</span><br /><span class="line">    <span class="keyword">this</span>.handler = handler;</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<h2 id="7-1-InternalEncoder">7.1 InternalEncoder</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalEncoder</span> <span class="keyword">extends</span> <span class="title">MessageToByteEncoder</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, Object msg, ByteBuf out)</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line">        <span class="comment">// åˆ›å»º NettyBackedChannelBuffer å¯¹è±¡</span></span><br /><span class="line">        com.alibaba.dubbo.remoting.buffer.ChannelBuffer buffer = <span class="keyword">new</span> NettyBackedChannelBuffer(out);</span><br /><span class="line">        <span class="comment">// è·å¾— NettyChannel å¯¹è±¡</span></span><br /><span class="line">        Channel ch = ctx.channel();</span><br /><span class="line">        NettyChannel channel = NettyChannel.getOrAddChannel(ch, url, handler);</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            <span class="comment">// ç¼–ç </span></span><br /><span class="line">            codec.encode(channel, buffer, msg);</span><br /><span class="line">        } <span class="keyword">finally</span> {</span><br /><span class="line">            <span class="comment">// ç§»é™¤ NettyChannel å¯¹è±¡ï¼Œè‹¥æ–­å¼€è¿æ¥</span></span><br /><span class="line">            NettyChannel.removeChannelIfDisconnected(ch);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>io.netty.handler.codec.MessageToByteEncoder</code>&nbsp;ï¼ŒNetty4 ç¼–ç å™¨<strong>æŠ½è±¡ç±»</strong>ã€‚</li>
<li>ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚</li>
</ul>
<h2 id="7-2-InternalDecoder">7.2 InternalDecoder</h2>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">InternalDecoder</span> <span class="keyword">extends</span> <span class="title">ByteToMessageDecoder</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf input, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br /><span class="line">        <span class="comment">// åˆ›å»º NettyBackedChannelBuffer å¯¹è±¡</span></span><br /><span class="line">        ChannelBuffer message = <span class="keyword">new</span> NettyBackedChannelBuffer(input);</span><br /><span class="line">        <span class="comment">// è·å¾— NettyChannel å¯¹è±¡</span></span><br /><span class="line">        NettyChannel channel = NettyChannel.getOrAddChannel(ctx.channel(), url, handler);</span><br /><span class="line">        <span class="comment">// å¾ªç¯è§£æï¼Œç›´åˆ°ç»“æŸ</span></span><br /><span class="line">        Object msg;</span><br /><span class="line">        <span class="keyword">int</span> saveReaderIndex;</span><br /><span class="line">        <span class="keyword">try</span> {</span><br /><span class="line">            <span class="comment">// decode object.</span></span><br /><span class="line">            <span class="keyword">do</span> {</span><br /><span class="line">                <span class="comment">// è®°å½•å½“å‰è¯»è¿›åº¦</span></span><br /><span class="line">                saveReaderIndex = message.readerIndex();</span><br /><span class="line">                <span class="comment">// è§£ç </span></span><br /><span class="line">                <span class="keyword">try</span> {</span><br /><span class="line">                    msg = codec.decode(channel, message);</span><br /><span class="line">                } <span class="keyword">catch</span> (IOException e) {</span><br /><span class="line">                    <span class="keyword">throw</span> e;</span><br /><span class="line">                }</span><br /><span class="line">                <span class="comment">// éœ€è¦æ›´å¤šè¾“å…¥ï¼Œå³æ¶ˆæ¯ä¸å®Œæ•´ï¼Œæ ‡è®°å›åŸæœ‰è¯»è¿›åº¦ï¼Œå¹¶ç»“æŸ</span></span><br /><span class="line">                <span class="keyword">if</span> (msg == Codec2.DecodeResult.NEED_MORE_INPUT) {</span><br /><span class="line">                    message.readerIndex(saveReaderIndex);</span><br /><span class="line">                    <span class="keyword">break</span>;</span><br /><span class="line">                <span class="comment">// è§£ç åˆ°æ¶ˆæ¯ï¼Œæ·»åŠ åˆ° `out`</span></span><br /><span class="line">                } <span class="keyword">else</span> {</span><br /><span class="line">                    <span class="comment">//is it possible to go here ? èŠ‹è‰¿ï¼šä¸å¯èƒ½ï¼Œå“ˆå“ˆå“ˆ</span></span><br /><span class="line">                    <span class="keyword">if</span> (saveReaderIndex == message.readerIndex()) {</span><br /><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Decode without read data."</span>);</span><br /><span class="line">                    }</span><br /><span class="line">                    <span class="keyword">if</span> (msg != <span class="keyword">null</span>) {</span><br /><span class="line">                        out.add(msg);</span><br /><span class="line">                    }</span><br /><span class="line">                }</span><br /><span class="line">            } <span class="keyword">while</span> (message.readable());</span><br /><span class="line">        } <span class="keyword">finally</span> {</span><br /><span class="line">            <span class="comment">// ç§»é™¤ NettyChannel å¯¹è±¡ï¼Œè‹¥æ–­å¼€è¿æ¥</span></span><br /><span class="line">            NettyChannel.removeChannelIfDisconnected(ctx.channel());</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li><code>io.netty.handler.codec.ByteToMessageDecoder</code>&nbsp;ï¼ŒNetty4 è§£ç å™¨<strong>æŠ½è±¡ç±»</strong>ã€‚</li>
<li>ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚</li>
</ul>
<h1 id="8-æ—¥å¿—å·¥å‚">8. æ—¥å¿—å·¥å‚</h1>
<p>åœ¨&nbsp;<a href="http://dubbo.apache.org/zh-cn/docs/user/demos/logger-strategy.html" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠDubbo ç”¨æˆ·æŒ‡å— &mdash;&mdash; æ—¥å¿—é€‚é…ã€‹</a>&nbsp;æ–‡æ¡£ï¼Œæåˆ°ï¼š</p>
<blockquote>
<p>è‡ª&nbsp;<code>2.2.1</code>&nbsp;å¼€å§‹ï¼Œdubbo å¼€å§‹å†…ç½® log4jã€slf4jã€jclã€jdk è¿™äº›æ—¥å¿—æ¡†æ¶çš„é€‚é…ã€‚</p>
</blockquote>
<p>åœ¨&nbsp;<a href="https://www.kancloud.cn/ssj234/netty-source/433218" target="_blank" rel="external nofollow noopener noreferrer">ã€ŠNettyæºç ç¬”è®° &mdash;&mdash; Nettyæ—¥å¿—å¤„ç†ã€‹</a>&nbsp;æ–‡æ¡£ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Netty æ”¯æŒå®ç°è‡ªå®šä¹‰çš„<strong>æ—¥å¿—å·¥å‚</strong>ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ¥å…¥ Dubbo çš„<strong>æ—¥å¿—é€‚é…</strong>ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“çš„ä»£ç å®ç°ã€‚</p>
<p>è°ƒç”¨&nbsp;<code>NettyHelper#setNettyLoggerFactory()</code>&nbsp;æ–¹æ³•ï¼Œè®¾ç½®æ—¥å¿—å·¥å‚ï¼ŒåŸºäº Dubbo Logger ç»„ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setNettyLoggerFactory</span><span class="params">()</span> </span>{</span><br /><span class="line">    InternalLoggerFactory factory = InternalLoggerFactory.getDefaultFactory();</span><br /><span class="line">    <span class="keyword">if</span> (factory == <span class="keyword">null</span> || !(factory <span class="keyword">instanceof</span> DubboLoggerFactory)) {</span><br /><span class="line">        InternalLoggerFactory.setDefaultFactory(<span class="keyword">new</span> DubboLoggerFactory());</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>è®¾ç½® Netty æ—¥å¿—å·¥å‚ä¸º DubboLoggerFactory ã€‚</li>
</ul>
<hr />
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/logging/NettyHelper.java#L27-L32" target="_blank" rel="external nofollow noopener noreferrer">DubboLoggerFactory</a>&nbsp;ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboLoggerFactory</span> <span class="keyword">extends</span> <span class="title">InternalLoggerFactory</span> </span>{</span><br /><br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> InternalLogger <span class="title">newInstance</span><span class="params">(String name)</span> </span>{</span><br /><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DubboLogger(LoggerFactory.getLogger(name));</span><br /><span class="line">    }</span><br /><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>åˆ›å»º DubboLogger å¯¹è±¡ï¼Œå¹¶ä¼ å…¥&nbsp;<code>name</code>&nbsp;å¯¹åº”çš„ Dubbo&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-common/src/main/java/com/alibaba/dubbo/common/logger/Logger.java" target="_blank" rel="external nofollow noopener noreferrer">Logger</a>&nbsp;å¯¹è±¡ï¼Œè€Œ Dubbo Logger çš„å¯¹è±¡ï¼ŒåŸºäº Dubbo SPI æœºåˆ¶åŠ è½½ã€‚</li>
</ul>
<hr />
<p><a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/logging/NettyHelper.java#L42-L236" target="_blank" rel="external nofollow noopener noreferrer">DubboLogger</a>&nbsp;ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DubboLogger</span> <span class="keyword">extends</span> <span class="title">AbstractInternalLogger</span> </span>{</span><br /><br /><span class="line">    <span class="comment">/**</span></span><br /><span class="line"><span class="comment">     * æ—¥å¿—ç»„ä»¶</span></span><br /><span class="line"><span class="comment">     */</span></span><br /><span class="line">    <span class="keyword">private</span> com.alibaba.dubbo.common.logger.Logger logger;</span><br /><br /><span class="line">    DubboLogger(Logger logger) {</span><br /><span class="line">        <span class="keyword">super</span>(logger.getClass().getName());</span><br /><span class="line">        <span class="keyword">this</span>.logger = logger;</span><br /><span class="line">    }</span><br />    <br /><span class="line">    <span class="meta">@Override</span></span><br /><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">(String msg)</span> </span>{</span><br /><span class="line">        <span class="keyword">if</span> (isInfoEnabled()) {</span><br /><span class="line">            logger.info(msg);</span><br /><span class="line">        }</span><br /><span class="line">    }</span><br />    <br /><span class="line">    <span class="comment">// ... çœç•¥ç±»ä¼¼ä»£ç </span></span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>åœ¨å®ç°çš„æ¯ä¸ªæ–¹æ³•ä¸­ï¼Œç›´æ¥è°ƒç”¨&nbsp;<code>logger</code>&nbsp;å¯¹åº”çš„æ–¹æ³•ã€‚</li>
<li>
<p>åœ¨ç±»ä¼¼&nbsp;<code>#info(String format, Object... arguments)</code>&nbsp;æ–¹æ³•ä¸­ï¼Œéœ€è¦å¯¹æ—¥å¿—å†…å®¹è¿›è¡Œæ ¼å¼åŒ–ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java">
<table>
<tbody>
<tr>
<td class="code">
<pre><span class="line"><span class="meta">@Override</span></span><br /><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">info</span><span class="params">(String format, Object... arguments)</span> </span>{</span><br /><span class="line">    <span class="keyword">if</span> (isInfoEnabled()) {</span><br /><span class="line">        FormattingTuple ft = MessageFormatter.arrayFormat(format, arguments);</span><br /><span class="line">        logger.info(ft.getMessage(), ft.getThrowable());</span><br /><span class="line">    }</span><br /><span class="line">}</span></pre>
</td>
</tr>
</tbody>
</table>
</figure>
<ul>
<li>æˆ‘ä»¬çœ‹åˆ°éœ€è¦&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/logging/MessageFormatter.java" target="_blank" rel="external nofollow noopener noreferrer">FormattingTuple</a>&nbsp;å’Œ&nbsp;<a href="https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty4/src/main/java/com/alibaba/dubbo/remoting/transport/netty4/logging/MessageFormatter.java" target="_blank" rel="external nofollow noopener noreferrer">MessageFormatter</a>&nbsp;è¿™ä¸¤ä¸ªç±»ï¼Œç”¨äºæ ¼å¼åŒ–ã€‚å®é™…ä¸Šï¼Œè¿™ä¸¤ä¸ªç±»æ˜¯ç›´æ¥ä» Netty4 ä¸­æ‹·è´å‡ºæ¥çš„ä¸¤ä¸ªç±»ï¼Œå› ä¸ºå®ƒä»¬æ˜¯&nbsp;<code>package</code>&nbsp;ä¿®é¥°çš„ç±»ï¼Œåœ¨ DubboLogger ä¸­ï¼Œæ— æ³•è®¿é—®åˆ°å®ƒä»¬ï¼Œæ‰€ä»¥è¿›è¡Œå¤åˆ¶è§£å†³ã€‚</li>
</ul>
</li>
</ul>
</div>