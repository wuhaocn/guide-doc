# æœåŠ¡è°ƒç”¨ï¼ˆäº”ï¼‰ä¹‹è¿œç¨‹è°ƒç”¨ï¼ˆWebServiceï¼‰

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡ï¼Œæˆ‘ä»¬åˆ†äº«

webservice://
åè®®çš„è¿œç¨‹è°ƒç”¨ï¼Œä¸»è¦åˆ†æˆ**ä¸‰ä¸ªéƒ¨åˆ†**ï¼š

* æœåŠ¡æš´éœ²
* æœåŠ¡å¼•ç”¨
* æœåŠ¡è°ƒç”¨

å¯¹åº”é¡¹ç›®ä¸º

dubbo-rpc-webservice
ã€‚

å¯¹åº”æ–‡æ¡£ä¸º [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” webservice://ã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/protocol/webservice.html) ã€‚å®šä¹‰å¦‚ä¸‹ï¼š
åŸºäº WebService çš„è¿œç¨‹è°ƒç”¨åè®®ï¼ŒåŸºäº [Apache CXF](http://cxf.apache.org/) çš„ frontend-simple å’Œ transports-http å®ç°ã€‚
 
å¯ä»¥å’ŒåŸç”Ÿ WebService æœåŠ¡äº’æ“ä½œï¼Œå³ï¼š

* æä¾›è€…ç”¨ Dubbo çš„ WebService åè®®æš´éœ²æœåŠ¡ï¼Œæ¶ˆè´¹è€…ç›´æ¥ç”¨æ ‡å‡† WebService æ¥å£è°ƒç”¨ï¼Œ
* æˆ–è€…æä¾›æ–¹ç”¨æ ‡å‡† WebService æš´éœ²æœåŠ¡ï¼Œæ¶ˆè´¹æ–¹ç”¨ Dubbo çš„ WebService åè®®è°ƒç”¨ã€‚

æœ¬æ–‡æ¶‰åŠç±»å›¾ï¼ˆçº¢åœˆéƒ¨åˆ†ï¼‰å¦‚ä¸‹ï¼š

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_10_16/01.png)
æ—ç™½å›ï¼šæ•´ä½“å®ç°å’Œ

dubbo-rpc-http
ä¸€è‡´ï¼Œæ‰€ä»¥å†…å®¹ä¸Šå’Œ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” æœåŠ¡è°ƒç”¨ï¼ˆä¸‰ï¼‰ä¹‹è¿œç¨‹è°ƒç”¨ï¼ˆHTTPï¼‰ã€‹](http://svip.iocoder.cn/Dubbo/rpc-http/?self) å·®ä¸å¤šã€‚

# 2. WebServiceProtocol

[
com.alibaba.dubbo.rpc.protocol.webservice.WebServiceProtocol
](https://github.com/YunaiV/dubbo/blob/master/dubbo-rpc/dubbo-rpc-webservice/src/main/java/com/alibaba/dubbo/rpc/protocol/webservice/WebServiceProtocol.java) ï¼Œå®ç° AbstractProxyProtocol æŠ½è±¡ç±»ï¼Œ

webservice://
åè®®å®ç°ç±»ã€‚

## 2.1 æ„é€ æ–¹æ³•

```
//*/*
/* é»˜è®¤æœåŠ¡å™¨ç«¯å£
/*/
public static final int DEFAULT_PORT = 80;
//*/*
/* Http æœåŠ¡å™¨é›†åˆ
/*
/* keyï¼šip:port
/*/
private final Map<String, HttpServer> serverMap = new ConcurrentHashMap<String, HttpServer>();
//*/*
/* ã€Šæˆ‘çœ¼ä¸­çš„CXFä¹‹Busã€‹http://jnn.iteye.com/blog/94746
/* ã€ŠCXF BUSã€‹https://blog.csdn.net/chen_fly2011/article/details/56664908
/*/
private final ExtensionManagerBus bus = new ExtensionManagerBus();
//*/*
/*
/*/
private final HTTPTransportFactory transportFactory = new HTTPTransportFactory();
//*/*
/* HttpBinder$Adaptive å¯¹è±¡
/*/
private HttpBinder httpBinder;
public WebServiceProtocol(){
super(Fault.class);
bus.setExtension(new ServletDestinationFactory(), HttpDestinationFactory.class);
}
public void setHttpBinder(HttpBinder httpBinder){
this.httpBinder = httpBinder;
}
```

* serverMap
å±æ€§ï¼ŒHttpServer é›†åˆã€‚é”®ä¸º

ip:port
ï¼Œé€šè¿‡

/#getAddr(url)
æ–¹æ³•ï¼Œè®¡ç®—ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
// AbstractProxyProtocol.java
protected String getAddr(URL url){
String bindIp = url.getParameter(Constants.BIND_IP_KEY, url.getHost());
if (url.getParameter(Constants.ANYHOST_KEY, false)) {
bindIp = Constants.ANYHOST_VALUE;
}
return NetUtils.getIpByHost(bindIp) + ":" + url.getParameter(Constants.BIND_PORT_KEY, url.getPort());
}
```
* skeletonMap
å±æ€§ï¼Œ

com.caucho.hessian.server.HessianSkeleton
é›†åˆã€‚è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸º

HttpServer => DispatcherServlet => WebServiceHandler => ServletController
ã€‚
* httpBinder
å±æ€§ï¼ŒHttpBinder$Adaptive å¯¹è±¡ï¼Œé€šè¿‡

/#setHttpBinder(httpBinder)
æ–¹æ³•ï¼ŒDubbo SPI è°ƒç”¨è®¾ç½®ã€‚
* rpcExceptions = Fault.class
ã€‚
* bus
å’Œ

transportFactory
å±æ€§ï¼Œå¯ä»¥å‚çœ‹å¦‚ä¸‹æ–‡ç« ï¼š

* [ã€Šæˆ‘çœ¼ä¸­çš„CXFä¹‹Busã€‹](http://jnn.iteye.com/blog/94746)
* [ã€ŠCXF BUSã€‹](https://blog.csdn.net/chen_fly2011/article/details/56664908)
* ğŸ™‚ è‰¿è‰¿å¯¹ Apache CXF äº†è§£ä¸å¤šï¼Œæ‰€ä»¥æœ¬æ–‡æ›´å¤šæ¢³ç†å¥½æ•´ä½“è„‰ç»œã€‚

## 2.2 doExport

```
1: @Override
2: protected <T> Runnable doExport(T impl, Class<T> type, URL url) throws RpcException{
3: // è·å¾—æœåŠ¡å™¨åœ°å€
4: String addr = getAddr(url);
5: // è·å¾— HttpServer å¯¹è±¡ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè¿›è¡Œåˆ›å»ºã€‚
6: HttpServer httpServer = serverMap.get(addr);
7: if (httpServer == null) {
8: httpServer = httpBinder.bind(url, new WebServiceHandler()); // WebServiceHandler
9: serverMap.put(addr, httpServer);
10: }
11: // åˆ›å»º ServerFactoryBean å¯¹è±¡
12: final ServerFactoryBean serverFactoryBean = new ServerFactoryBean();
13: serverFactoryBean.setAddress(url.getAbsolutePath());
14: serverFactoryBean.setServiceClass(type);
15: serverFactoryBean.setServiceBean(impl);
16: serverFactoryBean.setBus(bus);
17: serverFactoryBean.setDestinationFactory(transportFactory);
18: serverFactoryBean.create();
19: // è¿”å›å–æ¶ˆæš´éœ²çš„å›è°ƒ Runnable
20: return new Runnable() {
21: public void run(){
22: serverFactoryBean.destroy();
23: }
24: };
25: }
```

* åŸºäº

dubbo-remoting-http
é¡¹ç›®ï¼Œä½œä¸º**é€šä¿¡æœåŠ¡å™¨**ã€‚
* ç¬¬ 4 è¡Œï¼šè°ƒç”¨

/#getAddr(url)
æ–¹æ³•ï¼Œè·å¾—æœåŠ¡å™¨åœ°å€ã€‚
* ç¬¬ 5 è‡³ 10 è¡Œï¼šä»

serverMap
ä¸­ï¼Œè·å¾— HttpServer å¯¹è±¡ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè°ƒç”¨

HttpBinder/#bind(url, handler)
æ–¹æ³•ï¼Œåˆ›å»º HttpServer å¯¹è±¡ã€‚æ­¤å¤„ä½¿ç”¨çš„ WebServiceHandler ï¼Œä¸‹æ–‡è¯¦ç»†è§£æã€‚
* ç¬¬ 11 è‡³ 18 è¡Œï¼šåˆ›å»º ServerFactoryBean å¯¹è±¡ã€‚
* ç¬¬ 19 è‡³ 24 è¡Œï¼šè¿”å›å–æ¶ˆæš´éœ²çš„å›è°ƒ Runnable å¯¹è±¡ã€‚

### 2.2.1 WebServiceHandler

```
private class WebServiceHandler implements HttpHandler{
private volatile ServletController servletController;
@Override
public void handle(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException{
// åˆ›å»º ServletController å¯¹è±¡ï¼Œè®¾ç½®ä½¿ç”¨ DispatcherServlet ã€‚
if (servletController == null) {
HttpServlet httpServlet = DispatcherServlet.getInstance();
if (httpServlet == null) {
response.sendError(500, "No such DispatcherServlet instance.");
return;
}
synchronized (this) {
if (servletController == null) {
servletController = new ServletController(transportFactory.getRegistry(), httpServlet.getServletConfig(), httpServlet);
}
}
}
// è®¾ç½®è°ƒç”¨æ–¹åœ°å€
RpcContext.getContext().setRemoteAddress(request.getRemoteAddr(), request.getRemotePort());
// æ‰§è¡Œè°ƒç”¨
servletController.invoke(request, response);
}
}
```

## 2.3 doRefer

```
1: @Override
2: @SuppressWarnings("unchecked")
3: protected <T> T doRefer(final Class<T> serviceType, final URL url) throws RpcException{
4: // åˆ›å»º ClientProxyFactoryBean å¯¹è±¡
5: ClientProxyFactoryBean proxyFactoryBean = new ClientProxyFactoryBean();
6: proxyFactoryBean.setAddress(url.setProtocol("http").toIdentityString());
7: proxyFactoryBean.setServiceClass(serviceType);
8: proxyFactoryBean.setBus(bus);
9: // åˆ›å»º Service Proxy å¯¹è±¡
10: T ref = (T) proxyFactoryBean.create();
11: // è®¾ç½®è¶…æ—¶ç›¸å…³å±æ€§
12: Client proxy = ClientProxy.getClient(ref);
13: HTTPConduit conduit = (HTTPConduit) proxy.getConduit();
14: HTTPClientPolicy policy = new HTTPClientPolicy();
15: policy.setConnectionTimeout(url.getParameter(Constants.CONNECT_TIMEOUT_KEY, Constants.DEFAULT_CONNECT_TIMEOUT));
16: policy.setReceiveTimeout(url.getParameter(Constants.TIMEOUT_KEY, Constants.DEFAULT_TIMEOUT));
17: conduit.setClient(policy);
18: return ref;
19: }
```

* ç¬¬ 4 è‡³ 8 è¡Œï¼šåˆ›å»º ClientProxyFactoryBean å¯¹è±¡ã€‚
* ç¬¬ 10 è¡Œï¼šåˆ›å»º Service Proxy å¯¹è±¡ã€‚
* ç¬¬ 11 è‡³ 17 è¡Œï¼šè®¾ç½®**è¶…æ—¶ç›¸å…³**å±æ€§ã€‚

### 2.3.1 getErrorCode

```
@Override
protected int getErrorCode(Throwable e){
if (e instanceof Fault) {
e = e.getCause();
}
if (e instanceof SocketTimeoutException) {
return RpcException.TIMEOUT_EXCEPTION;
} else if (e instanceof IOException) {
return RpcException.NETWORK_EXCEPTION;
}
return super.getErrorCode(e);
}
```

* å°†å¼‚å¸¸ï¼Œç¿»è¯‘æˆ Dubbo å¼‚å¸¸ç ã€‚