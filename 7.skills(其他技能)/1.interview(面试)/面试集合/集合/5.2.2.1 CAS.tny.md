<div class="article">
        <h1 class="title">æ·±å…¥æµ…å‡ºCAS</h1>

<!-- ä½œè€…åŒºåŸŸ -->
<div class="author">
  <a class="avatar" href="/u/90ab66c248e6">
    <img src="//upload.jianshu.io/users/upload_avatars/2184951/e504c85fb1dc.jpg?imageMogr2/auto-orient/strip|imageView2/1/w/96/h/96" alt="96">
</a>          <div class="info">
            <span class="name"><a href="/u/90ab66c248e6">å å°ç‹¼</a></span>
              <img class="badge-icon" data-toggle="tooltip" title="" src="//upload.jianshu.io/user_badge/11f8cfa8-ec9f-4f82-be92-d6a39f61b5c1" alt="11f8cfa8 ec9f 4f82 be92 d6a39f61b5c1" data-original-title="ç¨‹åºå‘˜ä¼˜ç§€ä½œè€…">
            <!-- å…³æ³¨ç”¨æˆ·æŒ‰é’® -->
            <a class="btn btn-success follow"><i class="iconfont ic-follow"></i><span>å…³æ³¨</span></a>
            <!-- æ–‡ç« æ•°æ®ä¿¡æ¯ -->
            <div class="meta">
              <!-- ç®€ä¹¦é’» -->
                <span class="jsd-meta">
                  <i class="iconfont ic-paid1"></i> 4.3
                </span>
              <!-- å¦‚æœæ–‡ç« æ›´æ–°æ—¶é—´å¤§äºå‘å¸ƒæ—¶é—´ï¼Œé‚£ä¹ˆä½¿ç”¨ tooltip æ˜¾ç¤ºæ›´æ–°æ—¶é—´ -->
                <span class="publish-time" data-toggle="tooltip" data-placement="bottom" title="" data-original-title="æœ€åç¼–è¾‘äº 2017.12.31 21:06">2016.07.12 13:42*</span>
              <span class="wordage">å­—æ•° 1637</span>
            <span class="views-count">é˜…è¯» 46285</span><span class="comments-count">è¯„è®º 102</span><span class="likes-count">å–œæ¬¢ 266</span><span class="rewards-count ">èµèµ 2</span></div>
          </div>
          <!-- å¦‚æœæ˜¯å½“å‰ä½œè€…ï¼ŒåŠ å…¥ç¼–è¾‘æŒ‰é’® -->
        </div>


<!-- æ–‡ç« å†…å®¹ -->
<div data-note-content="" class="show-content">
  <div class="show-content-free">
    <blockquote>
<p><a href="https://www.jianshu.com/users/90ab66c248e6/latest_articles" target="_blank">å å°ç‹¼</a> è½¬è½½è¯·æ³¨æ˜åŸåˆ›å‡ºå¤„ï¼Œè°¢è°¢ï¼</p>
</blockquote>
<h3>å‰è¨€</h3>
<p>CASï¼ˆCompare and Swapï¼‰ï¼Œå³æ¯”è¾ƒå¹¶æ›¿æ¢ï¼Œå®ç°å¹¶å‘ç®—æ³•æ—¶å¸¸ç”¨åˆ°çš„ä¸€ç§æŠ€æœ¯ï¼ŒDoug leaå¤§ç¥åœ¨javaåŒæ­¥å™¨ä¸­å¤§é‡ä½¿ç”¨äº†CASæŠ€æœ¯ï¼Œé¬¼æ–§ç¥å·¥çš„å®ç°äº†å¤šçº¿ç¨‹æ‰§è¡Œçš„å®‰å…¨æ€§ã€‚</p>
<p>CASçš„æ€æƒ³å¾ˆç®€å•ï¼šä¸‰ä¸ªå‚æ•°ï¼Œä¸€ä¸ªå½“å‰å†…å­˜å€¼Vã€æ—§çš„é¢„æœŸå€¼Aã€å³å°†æ›´æ–°çš„å€¼Bï¼Œå½“ä¸”ä»…å½“é¢„æœŸå€¼Aå’Œå†…å­˜å€¼Vç›¸åŒæ—¶ï¼Œå°†å†…å­˜å€¼ä¿®æ”¹ä¸ºBå¹¶è¿”å›trueï¼Œå¦åˆ™ä»€ä¹ˆéƒ½ä¸åšï¼Œå¹¶è¿”å›falseã€‚</p>
<h3>é—®é¢˜</h3>
<p>ä¸€ä¸ª<code>n++</code>çš„é—®é¢˜ã€‚</p>
<pre class="hljs cpp"><code class="cpp"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Case</span> {</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> n;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">()</span> </span>{
        n++;
    }
}
</code></pre>
<p>é€šè¿‡<code>javap -verbose Case</code>çœ‹çœ‹addæ–¹æ³•çš„å­—èŠ‚ç æŒ‡ä»¤</p>
<pre class="hljs cpp"><code class="cpp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">()</span></span>;
    flags: ACC_PUBLIC
    Code:
      <span class="hljs-built_in">stack</span>=<span class="hljs-number">3</span>, locals=<span class="hljs-number">1</span>, args_size=<span class="hljs-number">1</span>
         <span class="hljs-number">0</span>: aload_0       
         <span class="hljs-number">1</span>: dup           
         <span class="hljs-number">2</span>: getfield      #<span class="hljs-number">2</span>                  <span class="hljs-comment">// Field n:I</span>
         <span class="hljs-number">5</span>: iconst_1      
         <span class="hljs-number">6</span>: iadd          
         <span class="hljs-number">7</span>: putfield      #<span class="hljs-number">2</span>                  <span class="hljs-comment">// Field n:I</span>
        <span class="hljs-number">10</span>: <span class="hljs-keyword">return</span>        
</code></pre>
<p><code>n++</code>è¢«æ‹†åˆ†æˆäº†å‡ ä¸ªæŒ‡ä»¤ï¼š</p>
<ol>
<li>æ‰§è¡Œ<code>getfield</code>æ‹¿åˆ°åŸå§‹nï¼›</li>
<li>æ‰§è¡Œ<code>iadd</code>è¿›è¡ŒåŠ 1æ“ä½œï¼›</li>
<li>æ‰§è¡Œ<code>putfield</code>å†™æŠŠç´¯åŠ åçš„å€¼å†™å›nï¼›</li>
</ol>
<p>é€šè¿‡volatileä¿®é¥°çš„å˜é‡å¯ä»¥ä¿è¯çº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§ï¼Œä½†å¹¶ä¸èƒ½ä¿è¯è¿™3ä¸ªæŒ‡ä»¤çš„åŸå­æ‰§è¡Œï¼Œåœ¨å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œä¸‹ï¼Œæ— æ³•åšåˆ°çº¿ç¨‹å®‰å…¨ï¼Œå¾—åˆ°æ­£ç¡®çš„ç»“æœï¼Œé‚£ä¹ˆåº”è¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿ</p>
<h3>å¦‚ä½•è§£å†³</h3>
<p>åœ¨<code>add</code>æ–¹æ³•åŠ ä¸Šsynchronizedä¿®é¥°è§£å†³ã€‚</p>
<pre class="hljs java"><code class="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Case</span> </span>{

<span class="hljs-keyword">public</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> n;

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title">add</span><span class="hljs-params">()</span> </span>{
    n++;
}
}
</code></pre>
<p>è¿™ä¸ªæ–¹æ¡ˆå½“ç„¶å¯è¡Œï¼Œä½†æ˜¯æ€§èƒ½ä¸Šå·®äº†ç‚¹ï¼Œè¿˜æœ‰å…¶å®ƒæ–¹æ¡ˆä¹ˆï¼Ÿ</p>
<p>å†æ¥çœ‹ä¸€æ®µä»£ç </p>
<pre class="hljs java"><code class="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> a = <span class="hljs-number">1</span>;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">compareAndSwapInt</span><span class="hljs-params">(<span class="hljs-keyword">int</span> b)</span> </span>{
    <span class="hljs-keyword">if</span> (a == <span class="hljs-number">1</span>) {
        a = b;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
}
</code></pre>
<p>å¦‚æœè¿™æ®µä»£ç åœ¨å¹¶å‘ä¸‹æ‰§è¡Œï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>
<p>å‡è®¾çº¿ç¨‹1å’Œçº¿ç¨‹2éƒ½è¿‡äº†<code>a==1</code>çš„æ£€æµ‹ï¼Œéƒ½å‡†å¤‡æ‰§è¡Œå¯¹aè¿›è¡Œèµ‹å€¼ï¼Œç»“æœå°±æ˜¯ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹äº†å˜é‡aï¼Œæ˜¾ç„¶è¿™ç§ç»“æœæ˜¯æ— æ³•ç¬¦åˆé¢„æœŸçš„ï¼Œæ— æ³•ç¡®å®šaçš„æœ€ç»ˆå€¼ã€‚</p>
<p>è§£å†³æ–¹æ³•ä¹ŸåŒæ ·æš´åŠ›ï¼Œåœ¨compareAndSwapIntæ–¹æ³•åŠ é”åŒæ­¥ï¼Œå˜æˆä¸€ä¸ªåŸå­æ“ä½œï¼ŒåŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰èƒ½ä¿®æ”¹å˜é‡aã€‚</p>
<p>é™¤äº†ä½æ€§èƒ½çš„åŠ é”æ–¹æ¡ˆï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨JDKè‡ªå¸¦çš„CASæ–¹æ¡ˆï¼Œåœ¨CASä¸­ï¼Œæ¯”è¾ƒå’Œæ›¿æ¢æ˜¯ä¸€ç»„åŸå­æ“ä½œï¼Œä¸ä¼šè¢«å¤–éƒ¨æ‰“æ–­ï¼Œä¸”åœ¨æ€§èƒ½ä¸Šæ›´å æœ‰ä¼˜åŠ¿ã€‚</p>
<p>ä¸‹é¢ä»¥<code>AtomicInteger</code>çš„å®ç°ä¸ºä¾‹ï¼Œåˆ†æä¸€ä¸‹CASæ˜¯å¦‚ä½•å®ç°çš„ã€‚</p>
<pre class="hljs java"><code class="java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AtomicInteger</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Number</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">java</span>.<span class="hljs-title">io</span>.<span class="hljs-title">Serializable</span> </span>{
    <span class="hljs-comment">// setup to use Unsafe.compareAndSwapInt for updates</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Unsafe unsafe = Unsafe.getUnsafe();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">long</span> valueOffset;

<span class="hljs-keyword">static</span> {
<span class="hljs-keyword">try</span> {
    valueOffset = unsafe.objectFieldOffset
        (AtomicInteger.class.getDeclaredField(<span class="hljs-string">"value"</span>));
} <span class="hljs-keyword">catch</span> (Exception ex) { <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(ex); }
}

<span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> <span class="hljs-keyword">int</span> value;
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">get</span><span class="hljs-params">()</span> </span>{<span class="hljs-keyword">return</span> value;}
}
</code></pre>
<ol>
<li>Unsafeï¼Œæ˜¯CASçš„æ ¸å¿ƒç±»ï¼Œç”±äºJavaæ–¹æ³•æ— æ³•ç›´æ¥è®¿é—®åº•å±‚ç³»ç»Ÿï¼Œéœ€è¦é€šè¿‡æœ¬åœ°ï¼ˆnativeï¼‰æ–¹æ³•æ¥è®¿é—®ï¼ŒUnsafeç›¸å½“äºä¸€ä¸ªåé—¨ï¼ŒåŸºäºè¯¥ç±»å¯ä»¥ç›´æ¥æ“ä½œç‰¹å®šå†…å­˜çš„æ•°æ®ã€‚</li>
<li>å˜é‡valueOffsetï¼Œè¡¨ç¤ºè¯¥å˜é‡å€¼åœ¨å†…å­˜ä¸­çš„åç§»åœ°å€ï¼Œå› ä¸ºUnsafeå°±æ˜¯æ ¹æ®å†…å­˜åç§»åœ°å€è·å–æ•°æ®çš„ã€‚</li>
<li>å˜é‡valueç”¨volatileä¿®é¥°ï¼Œä¿è¯äº†å¤šçº¿ç¨‹ä¹‹é—´çš„å†…å­˜å¯è§æ€§ã€‚</li>
</ol>
<p>çœ‹çœ‹<code>AtomicInteger</code>å¦‚ä½•å®ç°å¹¶å‘ä¸‹çš„ç´¯åŠ æ“ä½œï¼š</p>
<pre class="hljs java"><code class="java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getAndAdd</span><span class="hljs-params">(<span class="hljs-keyword">int</span> delta)</span> </span>{    
    <span class="hljs-keyword">return</span> unsafe.getAndAddInt(<span class="hljs-keyword">this</span>, valueOffset, delta);
}

<span class="hljs-comment">//unsafe.getAndAddInt</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">getAndAddInt</span><span class="hljs-params">(Object var1, <span class="hljs-keyword">long</span> var2, <span class="hljs-keyword">int</span> var4)</span> </span>{
    <span class="hljs-keyword">int</span> var5;
    <span class="hljs-keyword">do</span> {
        var5 = <span class="hljs-keyword">this</span>.getIntVolatile(var1, var2);
    } <span class="hljs-keyword">while</span>(!<span class="hljs-keyword">this</span>.compareAndSwapInt(var1, var2, var5, var5 + var4));
    <span class="hljs-keyword">return</span> var5;
}
</code></pre>
<p>å‡è®¾çº¿ç¨‹Aå’Œçº¿ç¨‹BåŒæ—¶æ‰§è¡ŒgetAndAddæ“ä½œï¼ˆåˆ†åˆ«è·‘åœ¨ä¸åŒCPUä¸Šï¼‰ï¼š</p>
<ol>
<li>AtomicIntegeré‡Œé¢çš„valueåŸå§‹å€¼ä¸º3ï¼Œå³ä¸»å†…å­˜ä¸­AtomicIntegerçš„valueä¸º3ï¼Œæ ¹æ®Javaå†…å­˜æ¨¡å‹ï¼Œçº¿ç¨‹Aå’Œçº¿ç¨‹Bå„è‡ªæŒæœ‰ä¸€ä»½valueçš„å‰¯æœ¬ï¼Œå€¼ä¸º3ã€‚</li>
<li>çº¿ç¨‹Aé€šè¿‡<code>getIntVolatile(var1, var2)</code>æ‹¿åˆ°valueå€¼3ï¼Œè¿™æ—¶çº¿ç¨‹Aè¢«æŒ‚èµ·ã€‚</li>
<li>çº¿ç¨‹Bä¹Ÿé€šè¿‡<code>getIntVolatile(var1, var2)</code>æ–¹æ³•è·å–åˆ°valueå€¼3ï¼Œè¿æ°”å¥½ï¼Œçº¿ç¨‹Bæ²¡æœ‰è¢«æŒ‚èµ·ï¼Œå¹¶æ‰§è¡Œ<code>compareAndSwapInt</code>æ–¹æ³•æ¯”è¾ƒå†…å­˜å€¼ä¹Ÿä¸º3ï¼ŒæˆåŠŸä¿®æ”¹å†…å­˜å€¼ä¸º2ã€‚</li>
<li>è¿™æ—¶çº¿ç¨‹Aæ¢å¤ï¼Œæ‰§è¡Œ<code>compareAndSwapInt</code>æ–¹æ³•æ¯”è¾ƒï¼Œå‘ç°è‡ªå·±æ‰‹é‡Œçš„å€¼(3)å’Œå†…å­˜çš„å€¼(2)ä¸ä¸€è‡´ï¼Œè¯´æ˜è¯¥å€¼å·²ç»è¢«å…¶å®ƒçº¿ç¨‹æå‰ä¿®æ”¹è¿‡äº†ï¼Œé‚£åªèƒ½é‡æ–°æ¥ä¸€éäº†ã€‚</li>
<li>é‡æ–°è·å–valueå€¼ï¼Œå› ä¸ºå˜é‡valueè¢«volatileä¿®é¥°ï¼Œæ‰€ä»¥å…¶å®ƒçº¿ç¨‹å¯¹å®ƒçš„ä¿®æ”¹ï¼Œçº¿ç¨‹Aæ€»æ˜¯èƒ½å¤Ÿçœ‹åˆ°ï¼Œçº¿ç¨‹Aç»§ç»­æ‰§è¡Œ<code>compareAndSwapInt</code>è¿›è¡Œæ¯”è¾ƒæ›¿æ¢ï¼Œç›´åˆ°æˆåŠŸã€‚</li>
</ol>
<p>æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œåˆ©ç”¨CASä¿è¯äº†å¯¹äºvalueçš„ä¿®æ”¹çš„å¹¶å‘å®‰å…¨ï¼Œç»§ç»­æ·±å…¥çœ‹çœ‹Unsafeç±»ä¸­çš„compareAndSwapIntæ–¹æ³•å®ç°ã€‚</p>
<pre class="hljs java"><code class="java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">compareAndSwapInt</span><span class="hljs-params">(Object paramObject, <span class="hljs-keyword">long</span> paramLong, <span class="hljs-keyword">int</span> paramInt1, <span class="hljs-keyword">int</span> paramInt2)</span></span>;
</code></pre>
<p>Unsafeç±»ä¸­çš„compareAndSwapIntï¼Œæ˜¯ä¸€ä¸ªæœ¬åœ°æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„å®ç°ä½äº<code>unsafe.cpp</code>ä¸­</p>
<pre class="hljs php"><code class="php">UNSAFE_ENTRY(jboolean, Unsafe_CompareAndSwapInt(JNIEnv *env, jobject unsafe, jobject obj, jlong offset, jint e, jint x))
  UnsafeWrapper(<span class="hljs-string">"Unsafe_CompareAndSwapInt"</span>);
  oop p = JNIHandles::resolve(obj);
  jint* addr = (jint *) index_oop_from_field_offset_long(p, offset);
  <span class="hljs-keyword">return</span> (jint)(Atomic::cmpxchg(x, addr, e)) == e;
UNSAFE_END
</code></pre>
<ol>
<li>å…ˆæƒ³åŠæ³•æ‹¿åˆ°å˜é‡valueåœ¨å†…å­˜ä¸­çš„åœ°å€ã€‚</li>
<li>é€šè¿‡<code>Atomic::cmpxchg</code>å®ç°æ¯”è¾ƒæ›¿æ¢ï¼Œå…¶ä¸­å‚æ•°xæ˜¯å³å°†æ›´æ–°çš„å€¼ï¼Œå‚æ•°eæ˜¯åŸå†…å­˜çš„å€¼ã€‚</li>
</ol>
<p>å¦‚æœæ˜¯Linuxçš„x86ï¼Œ<code>Atomic::cmpxchg</code>æ–¹æ³•çš„å®ç°å¦‚ä¸‹ï¼š</p>
<pre class="hljs objectivec"><code class="objectivec"><span class="hljs-keyword">inline</span> jint Atomic::cmpxchg (jint exchange_value, <span class="hljs-keyword">volatile</span> jint* dest, jint compare_value) {
  <span class="hljs-keyword">int</span> mp = os::is_MP();
  __asm__ <span class="hljs-keyword">volatile</span> (LOCK_IF_MP(%<span class="hljs-number">4</span>) <span class="hljs-string">"cmpxchgl %1,(%3)"</span>
                    : <span class="hljs-string">"=a"</span> (exchange_value)
                    : <span class="hljs-string">"r"</span> (exchange_value), <span class="hljs-string">"a"</span> (compare_value), <span class="hljs-string">"r"</span> (dest), <span class="hljs-string">"r"</span> (mp)
                    : <span class="hljs-string">"cc"</span>, <span class="hljs-string">"memory"</span>);
  <span class="hljs-keyword">return</span> exchange_value;
}
</code></pre>
<p>çœ‹åˆ°è¿™æ±‡ç¼–ï¼Œå†…å¿ƒå´©æºƒ ğŸ˜–</p>
<p><code>__asm__</code>è¡¨ç¤ºæ±‡ç¼–çš„å¼€å§‹<br>
<code>volatile</code>è¡¨ç¤ºç¦æ­¢ç¼–è¯‘å™¨ä¼˜åŒ–<br>
<code>LOCK_IF_MP</code>æ˜¯ä¸ªå†…è”å‡½æ•°</p>
<pre class="hljs cpp"><code class="cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOCK_IF_MP(mp) <span class="hljs-meta-string">"cmp $0, "</span> #mp <span class="hljs-meta-string">"; je 1f; lock; 1: "</span></span>
</code></pre>
<p>Windowçš„x86å®ç°å¦‚ä¸‹ï¼š</p>
<pre class="hljs objectivec"><code class="objectivec"><span class="hljs-keyword">inline</span> jint Atomic::cmpxchg (jint exchange_value, <span class="hljs-keyword">volatile</span> jint* dest, jint compare_value) {
    <span class="hljs-keyword">int</span> mp = os::isMP(); <span class="hljs-comment">//åˆ¤æ–­æ˜¯å¦æ˜¯å¤šå¤„ç†å™¨</span>
    _<span class="hljs-keyword">asm</span> {
        mov edx, dest
        mov ecx, exchange_value
        mov eax, compare_value
        LOCK_IF_MP(mp)
        cmpxchg dword ptr [edx], ecx
    }
}

<span class="hljs-comment">// Adding a lock prefix to an instruction on MP machine</span>
<span class="hljs-comment">// VC++ doesn't like the lock prefix to be on a single line</span>
<span class="hljs-comment">// so we can't insert a label after the lock prefix.</span>
<span class="hljs-comment">// By emitting a lock prefix, we can define a label after it.</span>
<span class="hljs-meta">#define LOCK_IF_MP(mp) __asm cmp mp, 0  \</span>
                       __<span class="hljs-keyword">asm</span> je L0      \
                       __<span class="hljs-keyword">asm</span> _emit <span class="hljs-number">0xF0</span> \
                       __<span class="hljs-keyword">asm</span> L0:
</code></pre>
<p><code>LOCK_IF_MP</code>æ ¹æ®å½“å‰ç³»ç»Ÿæ˜¯å¦ä¸ºå¤šæ ¸å¤„ç†å™¨å†³å®šæ˜¯å¦ä¸ºcmpxchgæŒ‡ä»¤æ·»åŠ lockå‰ç¼€ã€‚</p>
<ol>
<li>å¦‚æœæ˜¯å¤šå¤„ç†å™¨ï¼Œä¸ºcmpxchgæŒ‡ä»¤æ·»åŠ lockå‰ç¼€ã€‚</li>
<li>åä¹‹ï¼Œå°±çœç•¥lockå‰ç¼€ã€‚ï¼ˆå•å¤„ç†å™¨ä¼šä¸éœ€è¦lockå‰ç¼€æä¾›çš„å†…å­˜å±éšœæ•ˆæœï¼‰</li>
</ol>
<p>intelæ‰‹å†Œå¯¹lockå‰ç¼€çš„è¯´æ˜å¦‚ä¸‹ï¼š</p>
<ol>
<li>ç¡®ä¿åç»­æŒ‡ä»¤æ‰§è¡Œçš„åŸå­æ€§ã€‚<br>
åœ¨PentiumåŠä¹‹å‰çš„å¤„ç†å™¨ä¸­ï¼Œå¸¦æœ‰lockå‰ç¼€çš„æŒ‡ä»¤åœ¨æ‰§è¡ŒæœŸé—´ä¼šé”ä½æ€»çº¿ï¼Œä½¿å¾—å…¶å®ƒå¤„ç†å™¨æš‚æ—¶æ— æ³•é€šè¿‡æ€»çº¿è®¿é—®å†…å­˜ï¼Œå¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªå¼€é”€å¾ˆå¤§ã€‚åœ¨æ–°çš„å¤„ç†å™¨ä¸­ï¼ŒIntelä½¿ç”¨ç¼“å­˜é”å®šæ¥ä¿è¯æŒ‡ä»¤æ‰§è¡Œçš„åŸå­æ€§ï¼Œç¼“å­˜é”å®šå°†å¤§å¤§é™ä½lockå‰ç¼€æŒ‡ä»¤çš„æ‰§è¡Œå¼€é”€ã€‚</li>
<li>ç¦æ­¢è¯¥æŒ‡ä»¤ä¸å‰é¢å’Œåé¢çš„è¯»å†™æŒ‡ä»¤é‡æ’åºã€‚</li>
<li>æŠŠå†™ç¼“å†²åŒºçš„æ‰€æœ‰æ•°æ®åˆ·æ–°åˆ°å†…å­˜ä¸­ã€‚</li>
</ol>
<p>ä¸Šé¢çš„ç¬¬2ç‚¹å’Œç¬¬3ç‚¹æ‰€å…·æœ‰çš„å†…å­˜å±éšœæ•ˆæœï¼Œä¿è¯äº†CASåŒæ—¶å…·æœ‰volatileè¯»å’Œvolatileå†™çš„å†…å­˜è¯­ä¹‰ã€‚</p>
<h3>CASç¼ºç‚¹</h3>
<p>CASå­˜åœ¨ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„é—®é¢˜ï¼Œå³ABAé—®é¢˜ã€‚</p>
<p>é—®é¢˜ï¼šå¦‚æœå˜é‡Våˆæ¬¡è¯»å–çš„æ—¶å€™æ˜¯Aï¼Œå¹¶ä¸”åœ¨å‡†å¤‡èµ‹å€¼çš„æ—¶å€™æ£€æŸ¥åˆ°å®ƒä»ç„¶æ˜¯Aï¼Œé‚£èƒ½è¯´æ˜å®ƒçš„å€¼æ²¡æœ‰è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡äº†å—ï¼Ÿ</p>
<p>å¦‚æœåœ¨è¿™æ®µæœŸé—´æ›¾ç»è¢«æ”¹æˆBï¼Œç„¶ååˆæ”¹å›Aï¼Œé‚£CASæ“ä½œå°±ä¼šè¯¯è®¤ä¸ºå®ƒä»æ¥æ²¡æœ‰è¢«ä¿®æ”¹è¿‡ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œjavaå¹¶å‘åŒ…ä¸­æä¾›äº†ä¸€ä¸ªå¸¦æœ‰æ ‡è®°çš„åŸå­å¼•ç”¨ç±»<code>AtomicStampedReference</code>ï¼Œå®ƒå¯ä»¥é€šè¿‡æ§åˆ¶å˜é‡å€¼çš„ç‰ˆæœ¬æ¥ä¿è¯CASçš„æ­£ç¡®æ€§ã€‚</p>
<div class="image-package">
<div class="image-container" style="max-width: 700px; max-height: 400px; background-color: transparent;">
<div class="image-container-fill" style="padding-bottom: 57.25%;"></div>
<div class="image-view" data-width="1296" data-height="742"><img data-original-src="//upload-images.jianshu.io/upload_images/2184951-27faefbde89822bf.png" data-original-width="1296" data-original-height="742" data-original-format="image/png" data-original-filesize="340601" style="cursor: zoom-in;" class="" src="//upload-images.jianshu.io/upload_images/2184951-27faefbde89822bf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp"></div>
</div>
<div class="image-caption"></div>
</div>

</div>
</div>
</div>