# NIO æœåŠ¡å™¨ï¼ˆä¸ƒï¼‰ä¹‹ Netty3 å®ç°

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡æ¥ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” NIO æœåŠ¡å™¨ï¼ˆå…­ï¼‰ä¹‹ Netty4 å®ç°ã€‹](http://svip.iocoder.cn/Dubbo/remoting-impl-netty4/?self) ä¸€æ–‡ï¼Œåˆ†äº«åœ¨

dubbo-remoting-netty
ä¸­ï¼ŒNetty3 å¦‚ä½•æ¥å…¥å®ç°ã€‚

å› ä¸º Netty3 çš„æ¥å…¥ä»£ç ï¼Œå’Œ Netty4 åŸºæœ¬æ˜¯ä¸€è‡´ï¼Œä¸»è¦æ˜¯ä¸€äº› Netty ä¸åŒç‰ˆæœ¬çš„ API å·®å¼‚ï¼Œæ‰€ä»¥æœ¬æ–‡ï¼Œä¼šç›¸å¯¹ç®€ä»‹ï¼Œåªé‡ç‚¹åˆ†äº«ä¸€äº›å·®å¼‚çš„åœ°æ–¹ã€‚

æ¶‰åŠå¦‚ä¸‹ç±»ï¼š

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_12_19/01.png)
å‹æƒ…æç¤ºï¼šåœ¨å½“å‰ç‰ˆæœ¬ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œä½¿ç”¨ Netty3 ï¼Œå¦‚æœæƒ³é…ç½®æˆ Netty4 ï¼Œè¯·å‚è€ƒæ–‡æ¡£ï¼š[ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” Netty4ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/netty4.html)

# 2. NettyTransporter

[
com.alibaba.dubbo.remoting.transport.netty.NettyTransporter
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyTransporter.java) ï¼Œå’Œ

dubbo-remoting-netty4
ä¸€è‡´ï¼Œçœç•¥ã€‚

# 3. NettyChannel

[
com.alibaba.dubbo.remoting.transport.netty.NettyChannel
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyChannel.java) ï¼Œå’Œ

dubbo-remoting-netty4
ä¸€è‡´ï¼Œçœç•¥ã€‚

# 4. NettyHandler

[
com.alibaba.dubbo.remoting.transport.netty.NettyHandler
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyHandler.java) ï¼Œå®ç°

io.netty.channel.ChannelDuplexHandler
ç±»ï¼ŒNettyServer å’Œ NettyClient çš„å¤„ç†å™¨ï¼Œ**ç»Ÿä¸€ä½¿ç”¨**ã€‚è¿™ä¸€ç‚¹ï¼Œä¸åŒäº

dubbo-remoting-netty4
ï¼ŒæœåŠ¡ç«¯å’ŒæœåŠ¡å™¨ä½¿ç”¨ä¸åŒçš„ä¸¤ä¸ªå¤„ç†å™¨ã€‚ç›¸æ¯”æ¥è¯´ï¼Œ

dubbo-remoting-netty4
æ§åˆ¶æ›´ç²¾ç»†ï¼Œå½±å“ä¸å¤§ã€‚

å½“ç„¶ä¹Ÿæœ‰ä¸€ä¸ªåŸå› ï¼ŒDubbo ChannelHandler åŸºäº **Netty3 çš„ SimpleChannelHandler** ä¸ºè®¾è®¡åŸå‹ã€‚å› æ­¤ï¼Œåœ¨

dubbo-remoting-netty4
ä¸­ï¼Œéœ€è¦å°† DubboHandler çš„æ–¹æ³•ï¼Œé€‚é…åˆ° **Netty4 çš„ ChannelDuplexHandler** çš„æ–¹æ³•ã€‚
NettyHandler å’Œ HeaderExchangeHandler ç±»ä¼¼ã€‚

**æ„é€ æ–¹æ³•**

```
@Sharable
public class NettyHandler extends SimpleChannelHandler{
//*/*
/* Dubbo Channel é›†åˆ
/*/
private final Map<String, Channel> channels = new ConcurrentHashMap<String, Channel>(); // <ip:port, channel>
//*/*
/* URL
/*/
private final URL url;
//*/*
/* Dubbo ChannelHandler
/*/
private final ChannelHandler handler;
public NettyHandler(URL url, ChannelHandler handler){
if (url == null) {
throw new IllegalArgumentException("url == null");
}
if (handler == null) {
throw new IllegalArgumentException("handler == null");
}
this.url = url;
this.handler = handler;
}
// ... çœç•¥å®ç°æ–¹æ³•
}
```

**å®ç°æ–¹æ³•**

æ¯ä¸ªå®ç°çš„æ–¹æ³•ï¼Œè°ƒç”¨

handler
å¯¹åº”çš„æ–¹æ³•ã€‚ä»¥

/#channelActive(ChannelHandlerContext)
æ–¹æ³•ä¸¾ä¾‹å­ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
@Override
public void channelConnected(ChannelHandlerContext ctx, ChannelStateEvent e) throws Exception{
// åˆ›å»º NettyChannel å¯¹è±¡
NettyChannel channel = NettyChannel.getOrAddChannel(ctx.getChannel(), url, handler);
try {
// æ·»åŠ åˆ° `channels` ä¸­
if (channel != null) {
channels.put(NetUtils.toAddressString((InetSocketAddress) ctx.getChannel().getRemoteAddress()), channel);
}
// æäº¤ç»™ `handler` å¤„ç†å™¨ã€‚
handler.connected(channel);
} finally {
// ç§»é™¤ NettyChannel å¯¹è±¡ï¼Œè‹¥å·²æ–­å¼€
NettyChannel.removeChannelIfDisconnected(ctx.getChannel());
}
}
```

ğŸ™‚ å…¶ä»–æ–¹æ³•ï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚

# 5. NettyServer

[
com.alibaba.dubbo.remoting.transport.netty.NettyServer
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyServer.java) ï¼Œå®ç° Server æ¥å£ï¼Œç»§æ‰¿ AbstractServer æŠ½è±¡ç±»ï¼ŒNetty æœåŠ¡å™¨å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**
```
//*/*
/* é€šé“é›†åˆ
/*/
private Map<String, Channel> channels; // <ip:port, channel>
private ServerBootstrap bootstrap;
private org.jboss.netty.channel.Channel channel;
public NettyServer(URL url, ChannelHandler handler) throws RemotingException{
super(url, ChannelHandlers.wrap(handler, ExecutorUtil.setThreadName(url, SERVER_THREAD_POOL_NAME)));
}
```

* å’Œ

dubbo-remoting-netty4
åŸºæœ¬ä¸€è‡´ã€‚

**å¯åŠ¨æœåŠ¡å™¨**
```
1: @Override
2: protected void doOpen(){
3: // è®¾ç½®æ—¥å¿—å·¥å‚
4: NettyHelper.setNettyLoggerFactory();
5:
6: // åˆ›å»ºçº¿ç¨‹æ± 
7: ExecutorService boss = Executors.newCachedThreadPool(new NamedThreadFactory("NettyServerBoss", true));
8: ExecutorService worker = Executors.newCachedThreadPool(new NamedThreadFactory("NettyServerWorker", true));
9:
10: // åˆ›å»º ChannelFactory å¯¹è±¡
11: ChannelFactory channelFactory = new NioServerSocketChannelFactory(boss, worker, getUrl().getPositiveParameter(Constants.IO_THREADS_KEY, Constants.DEFAULT_IO_THREADS));
12: // å®ä¾‹åŒ– ServerBootstrap
13: bootstrap = new ServerBootstrap(channelFactory);
14:
15: // åˆ›å»º NettyHandler å¯¹è±¡
16: final NettyHandler nettyHandler = new NettyHandler(getUrl(), this);
17: // è®¾ç½® `channels` å±æ€§
18: channels = nettyHandler.getChannels();
19: // https://issues.jboss.org/browse/NETTY-365
20: // https://issues.jboss.org/browse/NETTY-379
21: // final Timer timer = new HashedWheelTimer(new NamedThreadFactory("NettyIdleTimer", true));
22: bootstrap.setPipelineFactory(new ChannelPipelineFactory() {
23: @Override
24: public ChannelPipeline getPipeline(){
25: // åˆ›å»º NettyCodecAdapter å¯¹è±¡
26: NettyCodecAdapter adapter = new NettyCodecAdapter(getCodec(), getUrl(), NettyServer.this);
27: ChannelPipeline pipeline = Channels.pipeline();
28: //*int idleTimeout = getIdleTimeout();
29: if (idleTimeout > 10000) {
30: pipeline.addLast("timer", new IdleStateHandler(timer, idleTimeout / 1000, 0, 0));
31: }/*/
32: pipeline.addLast("decoder", adapter.getDecoder()); // è§£ç 
33: pipeline.addLast("encoder", adapter.getEncoder()); // è§£ç 
34: pipeline.addLast("handler", nettyHandler); // å¤„ç†å™¨
35: return pipeline;
36: }
37: });
38: // æœåŠ¡å™¨ç»‘å®šç«¯å£ç›‘å¬
39: // bind
40: channel = bootstrap.bind(getBindAddress());
41: }
```

* å’Œ

dubbo-remoting-netty4
åŸºæœ¬ä¸€è‡´ï¼Œä¸‹é¢åªè¯´ä¸€äº›å·®å¼‚çš„åœ°æ–¹ã€‚
* ç¬¬ 6 è‡³ 8 è¡Œï¼šåˆ›å»ºçº¿ç¨‹æ± ï¼Œä¸åŒäº

dubbo-remoting-netty4
ä¸­ï¼Œåˆ›å»ºçº¿ç¨‹ç»„ NioEventLoopGroup ã€‚
* ç¬¬ 11 è¡Œï¼šåŸºäº

boss

worker
ï¼Œåˆ›å»º ChannelFactory å¯¹è±¡ã€‚
* **å¹¶æœªè®¾ç½®** ServerBootstrap çš„å¯é€‰é¡¹ã€‚

**å…³é—­æœåŠ¡å™¨**
```
1: @Override
2: protected void doClose(){
3: // å…³é—­æœåŠ¡å™¨é€šé“
4: try {
5: if (channel != null) {
6: // unbind.
7: channel.close();
8: }
9: } catch (Throwable e) {
10: logger.warn(e.getMessage(), e);
11: }
12: // å…³é—­è¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é€šé“
13: try {
14: Collection<com.alibaba.dubbo.remoting.Channel> channels = getChannels();
15: if (channels != null && !channels.isEmpty()) {
16: for (com.alibaba.dubbo.remoting.Channel channel : channels) {
17: try {
18: channel.close();
19: } catch (Throwable e) {
20: logger.warn(e.getMessage(), e);
21: }
22: }
23: }
24: } catch (Throwable e) {
25: logger.warn(e.getMessage(), e);
26: }
27: // ä¼˜é›…å…³é—­ ServerBootstrap
28: try {
29: if (bootstrap != null) {
30: // release external resource.
31: bootstrap.releaseExternalResources();
32: }
33: } catch (Throwable e) {
34: logger.warn(e.getMessage(), e);
35: }
36: // æ¸…ç©ºè¿æ¥åˆ°æœåŠ¡å™¨çš„å®¢æˆ·ç«¯é€šé“
37: try {
38: if (channels != null) {
39: channels.clear();
40: }
41: } catch (Throwable e) {
42: logger.warn(e.getMessage(), e);
43: }
44: }
```

* å’Œ

dubbo-remoting-netty4
åŸºæœ¬ä¸€è‡´ï¼Œä¸‹é¢åªè¯´ä¸€äº›å·®å¼‚çš„åœ°æ–¹ã€‚
* ç¬¬ 27 è‡³ 35 è¡Œï¼šè°ƒç”¨

Bootstrap/#releaseExternalResources()
æ–¹æ³•ï¼Œé‡Šæ”¾ ServerBootstrap ç›¸å…³çš„èµ„æºã€‚

# 6. NettyClient

[
com.alibaba.dubbo.remoting.transport.netty.NettyClient
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyClient.java) ï¼Œç»§æ‰¿ AbstractNettyClient æŠ½è±¡ç±»ï¼ŒNetty å®¢æˆ·ç«¯å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**
```
// ChannelFactory's closure has a DirectMemory leak, using static to avoid
// https://issues.jboss.org/browse/NETTY-424
private static final ChannelFactory channelFactory = new NioClientSocketChannelFactory(Executors.newCachedThreadPool(new NamedThreadFactory("NettyClientBoss", true)),
Executors.newCachedThreadPool(new NamedThreadFactory("NettyClientWorker", true)),
Constants.DEFAULT_IO_THREADS);
private ClientBootstrap bootstrap;
private volatile org.jboss.netty.channel.Channel channel; // volatile, please copy reference to use
public NettyClient(final URL url, final ChannelHandler handler) throws RemotingException{
super(url, wrapChannelHandler(url, handler));
}
```

* channelFactory
å±æ€§ï¼Œã€TODO 8027ã€‘ä¸ºå•¥å…¬ç”¨

**å¯åŠ¨å®¢æˆ·ç«¯**
```
1: @Override
2: protected void doOpen(){
3: // è®¾ç½®æ—¥å¿—å·¥å‚
4: NettyHelper.setNettyLoggerFactory();
5:
6: // å®ä¾‹åŒ– ServerBootstrap
7: bootstrap = new ClientBootstrap(channelFactory);
8: // è®¾ç½®å¯é€‰é¡¹
9: // config
10: // @see org.jboss.netty.channel.socket.SocketChannelConfig
11: bootstrap.setOption("keepAlive", true);
12: bootstrap.setOption("tcpNoDelay", true);
13: bootstrap.setOption("connectTimeoutMillis", getTimeout());
14:
15: // åˆ›å»º NettyHandler å¯¹è±¡
16: final NettyHandler nettyHandler = new NettyHandler(getUrl(), this);
17:
18: // è®¾ç½®è´£ä»»é“¾è·¯
19: bootstrap.setPipelineFactory(new ChannelPipelineFactory() {
20: public ChannelPipeline getPipeline(){
21: // åˆ›å»º NettyCodecAdapter å¯¹è±¡
22: NettyCodecAdapter adapter = new NettyCodecAdapter(getCodec(), getUrl(), NettyClient.this);
23: ChannelPipeline pipeline = Channels.pipeline();
24: pipeline.addLast("decoder", adapter.getDecoder()); // è§£ç 
25: pipeline.addLast("encoder", adapter.getEncoder()); // ç¼–ç 
26: pipeline.addLast("handler", nettyHandler); // å¤„ç†å™¨
27: return pipeline;
28: }
29: });
30: }
```

* å’Œ

dubbo-remoting-netty4
åŸºæœ¬ä¸€è‡´ã€‚

**è¿æ¥æœåŠ¡å™¨**
```
1: @Override
2: protected void doConnect() throws Throwable{
3: long start = System.currentTimeMillis();
4: // è¿æ¥æœåŠ¡å™¨
5: ChannelFuture future = bootstrap.connect(getConnectAddress());
6: try {
7: // ç­‰å¾…è¿æ¥æˆåŠŸæˆ–è€…è¶…æ—¶
8: boolean ret = future.awaitUninterruptibly(getConnectTimeout(), TimeUnit.MILLISECONDS);
9: // è¿æ¥æˆåŠŸ
10: if (ret && future.isSuccess()) {
11: Channel newChannel = future.getChannel();
12: newChannel.setInterestOps(Channel.OP_READ_WRITE);
13: try {
14: // å…³é—­è€çš„è¿æ¥
15: // Close old channel
16: Channel oldChannel = NettyClient.this.channel; // copy reference
17: if (oldChannel != null) {
18: try {
19: if (logger.isInfoEnabled()) {
20: logger.info("Close old netty channel " + oldChannel + " on create new netty channel " + newChannel);
21: }
22: oldChannel.close();
23: } finally {
24: NettyChannel.removeChannelIfDisconnected(oldChannel);
25: }
26: }
27: } finally {
28: // è‹¥ NettyClient è¢«å…³é—­ï¼Œå…³é—­è¿æ¥
29: if (NettyClient.this.isClosed()) {
30: try {
31: if (logger.isInfoEnabled()) {
32: logger.info("Close new netty channel " + newChannel + ", because the client closed.");
33: }
34: newChannel.close();
35: } finally {
36: NettyClient.this.channel = null;
37: NettyChannel.removeChannelIfDisconnected(newChannel);
38: }
39: // è®¾ç½®æ–°è¿æ¥
40: } else {
41: NettyClient.this.channel = newChannel;
42: }
43: }
44: // å‘ç”Ÿå¼‚å¸¸ï¼ŒæŠ›å‡º RemotingException å¼‚å¸¸
45: } else if (future.getCause() != null) {
46: throw new RemotingException(this, "client(url: " + getUrl() + ") failed to connect to server "
47: + getRemoteAddress() + ", error message is:" + future.getCause().getMessage(), future.getCause());
48: // æ— ç»“æœï¼ˆè¿æ¥è¶…æ—¶ï¼‰ï¼ŒæŠ›å‡º RemotingException å¼‚å¸¸
49: } else {
50: throw new RemotingException(this, "client(url: " + getUrl() + ") failed to connect to server "
51: + getRemoteAddress() + " client-side timeout "
52: + getConnectTimeout() + "ms (elapsed: " + (System.currentTimeMillis() - start) + "ms) from netty client "
53: + NetUtils.getLocalHost() + " using dubbo version " + Version.getVersion());
54: }
55: } finally {
56: // æœªè¿æ¥ï¼Œå–æ¶ˆä»»åŠ¡
57: if (!isConnected()) {
58: future.cancel();
59: }
60: }
61: }
```

* å’Œ

dubbo-remoting-netty4
åŸºæœ¬ä¸€è‡´ï¼Œä¸‹é¢åªè¯´ä¸€äº›å·®å¼‚çš„åœ°æ–¹ã€‚
* ç¬¬ 9 è¡Œï¼šè°ƒç”¨

ChannelFuture/#awaitUninterruptibly(timeout, TimeUnit)
æ–¹æ³•ï¼Œç­‰å¾…è¿æ¥æˆåŠŸæˆ–è¶…æ—¶ã€‚è¿™é‡Œä¼ å…¥çš„ä¸æ˜¯

3000
ã€‚
* ç¬¬ 55 è‡³ 60 è¡Œï¼šæœ€ç»ˆç»“æœä¸ºæœªè¿æ¥ï¼Œè°ƒç”¨

ChannelFuture/#cancel(true)
æ–¹æ³•ï¼Œå–æ¶ˆä»»åŠ¡ã€‚

**å…³é—­è¿æ¥**
```
@Override
protected void doClose() throws Throwable{
//*try {
bootstrap.releaseExternalResources();
} catch (Throwable t) {
logger.warn(t.getMessage());
}/*/
}
```

* å› ä¸º

channelFactory
æ˜¯**é™æ€**å±æ€§ï¼Œè¢«å¤šä¸ª NettyClient å…±ç”¨ã€‚

# 7. Buffer

## 7.1 NettyBackedChannelBuffer

[
com.alibaba.dubbo.remoting.transport.netty.NettyBackedChannelBuffer
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyBackedChannelBuffer.java) ï¼Œå®ç° ChannelBuffer æ¥å£ï¼ŒåŸºäº **Netty3 ChannelBuffer** çš„ ChannelBuffer å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**
```
private org.jboss.netty.buffer.ChannelBuffer buffer;
public NettyBackedChannelBuffer(org.jboss.netty.buffer.ChannelBuffer buffer){
Assert.notNull(buffer, "buffer == null");
this.buffer = buffer;
}
```

**å·¥å‚**

```
@Override
public ChannelBufferFactory factory(){
return NettyBackedChannelBufferFactory.getInstance();
}
```

* å¯¹åº”çš„å·¥å‚æ˜¯ NettyBackedChannelBufferFactory

**å®ç°æ–¹æ³•**

æ¯ä¸ªæ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ Netty3 ChannelBuffer å¯¹åº”çš„æ–¹æ³•ã€‚

## 7.2 NettyBackedChannelBufferFactory

[
com.alibaba.dubbo.remoting.transport.netty.NettyBackedChannelBufferFactory
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyBackedChannelBufferFactory.java) ï¼Œå®ç° ChannelBufferFactory æ¥å£ï¼Œåˆ›å»º NettyBackedChannelBuffer çš„å·¥å‚ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
@Override
public ChannelBuffer getBuffer(int capacity){
return new NettyBackedChannelBuffer(ChannelBuffers.dynamicBuffer(capacity)); // ChannelBuffers ä¸º `org.jboss.netty.buffer` åŒ…ä¸‹
}
@Override
public ChannelBuffer getBuffer(byte[] array, int offset, int length){
// åˆ›å»º Netty3 ChannelBuffer å¯¹è±¡
org.jboss.netty.buffer.ChannelBuffer buffer = ChannelBuffers.dynamicBuffer(length); // ChannelBuffers ä¸º `org.jboss.netty.buffer` åŒ…ä¸‹
// å†™å…¥æ•°æ®
buffer.writeBytes(array, offset, length);
// åˆ›å»º NettyBackedChannelBuffer å¯¹è±¡
return new NettyBackedChannelBuffer(buffer);
}
@Override
public ChannelBuffer getBuffer(ByteBuffer nioBuffer){
return new NettyBackedChannelBuffer(ChannelBuffers.wrappedBuffer(nioBuffer)); // ChannelBuffers ä¸º `org.jboss.netty.buffer` åŒ…ä¸‹
}
```

* **æ³¨æ„**ï¼Œæ­¤å¤„çš„ ChannelBuffers æ˜¯

org.jboss.netty.buffer
åŒ…ä¸‹çš„ã€‚

# 8. NettyCodecAdapter

[
com.alibaba.dubbo.remoting.transport.netty.NettyCodecAdapter
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyCodecAdapter.java) ï¼ŒNetty ç¼–è§£ç **é€‚é…å™¨**ï¼Œå°† **Dubbo ç¼–è§£ç å™¨** é€‚é…æˆ Netty3 çš„ç¼–ç å™¨å’Œè§£ç å™¨ã€‚

**æ„é€ æ–¹æ³•**
```
//*/*
/* Netty ç¼–ç å™¨
/*/
private final ChannelHandler encoder = new InternalEncoder();
//*/*
/* Netty è§£ç å™¨
/*/
private final ChannelHandler decoder = new InternalDecoder();
//*/*
/* Dubbo ç¼–è§£ç å™¨
/*/
private final Codec2 codec;
//*/*
/* Dubbo URL
/*/
private final URL url;
//*/*
/* ç½‘ç»œè¯»å†™ç¼“å†²åŒºå¤§å°
/*/
private final int bufferSize;
//*/*
/* Dubbo ChannelHandler
/*/
private final com.alibaba.dubbo.remoting.ChannelHandler handler;
public NettyCodecAdapter(Codec2 codec, URL url, com.alibaba.dubbo.remoting.ChannelHandler handler){
this.codec = codec;
this.url = url;
this.handler = handler;
// è®¾ç½® `bufferSize`
int b = url.getPositiveParameter(Constants.BUFFER_KEY, Constants.DEFAULT_BUFFER_SIZE);
this.bufferSize = b >= Constants.MIN_BUFFER_SIZE && b <= Constants.MAX_BUFFER_SIZE ? b : Constants.DEFAULT_BUFFER_SIZE;
}
```

* bufferSize
å±æ€§ï¼Œç½‘ç»œè¯»å†™ç¼“å†²åŒºå¤§å°ï¼Œé»˜è®¤ 8K ã€‚è¿™æ˜¯

dubbo-remoting-netty4
çš„ NettyCodecAdapter æ‰€**ä¸éœ€è¦**çš„ã€‚ç”¨äºä¸‹é¢ [ã€Œ8.2 InternalDecoderã€](http://svip.iocoder.cn/Dubbo/remoting-impl-netty3/) ï¼Œæ¶ˆæ¯è§£ç æ—¶ä½¿ç”¨ã€‚

## 8.1 InternalEncoder

```
@Sharable
private class InternalEncoder extends OneToOneEncoder{
@Override
protected Object encode(ChannelHandlerContext ctx, Channel ch, Object msg) throws Exception{
// åˆ›å»º HeapChannelBuffer å¯¹è±¡
com.alibaba.dubbo.remoting.buffer.ChannelBuffer buffer = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.dynamicBuffer(1024);
// è·å¾— NettyChannel å¯¹è±¡
NettyChannel channel = NettyChannel.getOrAddChannel(ch, url, handler);
try {
// ç¼–ç 
codec.encode(channel, buffer, msg);
} finally {
// ç§»é™¤ NettyChannel å¯¹è±¡ï¼Œè‹¥æ–­å¼€è¿æ¥
NettyChannel.removeChannelIfDisconnected(ch);
}
// è¿”å› Netty ChannelBuffer å¯¹è±¡
return ChannelBuffers.wrappedBuffer(buffer.toByteBuffer());
}
}
```

* org.jboss.netty.handler.codec.oneone.OneToOneEncoder
ï¼ŒNetty3 ç¼–ç å™¨**æŠ½è±¡ç±»**ã€‚
* ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚

## 8.2 InternalDecoder

```
1: private class InternalDecoder extends SimpleChannelUpstreamHandler{
2:
3: //*/*
4: /* æœªè¯»å®Œçš„æ¶ˆæ¯ Buffer
5: /*/
6: private com.alibaba.dubbo.remoting.buffer.ChannelBuffer buffer = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.EMPTY_BUFFER;
7:
8: @Override
9: public void messageReceived(ChannelHandlerContext ctx, MessageEvent event) throws Exception{
10: // è·³è¿‡é ChannelBuffer
11: Object o = event.getMessage();
12: if (!(o instanceof ChannelBuffer)) {
13: ctx.sendUpstream(event);
14: return;
15: }
16:
17: // æ— å¯è¯»ï¼Œè·³è¿‡
18: ChannelBuffer input = (ChannelBuffer) o;
19: int readable = input.readableBytes();
20: if (readable <= 0) {
21: return;
22: }
23:
24: // åˆå¹¶ `buffer` + `input` æˆ `message`
25: com.alibaba.dubbo.remoting.buffer.ChannelBuffer message;
26: if (buffer.readable()) { // æœ‰æœªè¯»å®Œçš„ï¼Œéœ€è¦æ‹¼æ¥
27: if (buffer instanceof DynamicChannelBuffer) {
28: buffer.writeBytes(input.toByteBuffer());
29: message = buffer;
30: } else { // Netty3 ChannelBuffer ï¼Œè½¬æˆ DynamicChannelBuffer ã€‚
31: int size = buffer.readableBytes() + input.readableBytes();
32: message = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.dynamicBuffer(size > bufferSize ? size : bufferSize);
33: message.writeBytes(buffer, buffer.readableBytes());
34: message.writeBytes(input.toByteBuffer());
35: }
36: } else { // æ— æœªè¯»å®Œçš„ï¼Œç›´æ¥åˆ›å»º
37: message = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.wrappedBuffer(input.toByteBuffer());
38: }
39:
40: // è·å¾— NettyChannel å¯¹è±¡
41: NettyChannel channel = NettyChannel.getOrAddChannel(ctx.getChannel(), url, handler);
42: // å¾ªç¯è§£æï¼Œç›´åˆ°ç»“æŸ
43: Object msg;
44: int saveReaderIndex;
45: try {
46: // decode object.
47: do {
48: saveReaderIndex = message.readerIndex();
49: try {
50: msg = codec.decode(channel, message);
51: } catch (IOException e) {
52: buffer = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.EMPTY_BUFFER;
53: throw e;
54: }
55: if (msg == Codec2.DecodeResult.NEED_MORE_INPUT) {
56: message.readerIndex(saveReaderIndex);
57: break;
58: // è§£ç åˆ°æ¶ˆæ¯ï¼Œè§¦å‘ä¸€æ¡æ¶ˆæ¯
59: } else {
60: //is it possible to go here ? èŠ‹è‰¿ï¼šä¸å¯èƒ½ï¼Œå“ˆå“ˆå“ˆ
61: if (saveReaderIndex == message.readerIndex()) {
62: buffer = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.EMPTY_BUFFER;
63: throw new IOException("Decode without read data.");
64: }
65: if (msg != null) {
66: Channels.fireMessageReceived(ctx, msg, event.getRemoteAddress());
67: }
68: }
69: } while (message.readable());
70: } finally {
71: // æœ‰å‰©ä½™å¯è¯»çš„ï¼Œå‹ç¼©å¹¶ç¼“å­˜
72: if (message.readable()) {
73: message.discardReadBytes();
74: buffer = message;
75: // æ— å‰©ä½™çš„ï¼Œè®¾ç½®ç©º Buffer
76: } else {
77: buffer = com.alibaba.dubbo.remoting.buffer.ChannelBuffers.EMPTY_BUFFER;
78: }
79: // ç§»é™¤ NettyChannel å¯¹è±¡ï¼Œè‹¥æ–­å¼€è¿æ¥
80: NettyChannel.removeChannelIfDisconnected(ctx.getChannel());
81: }
82: }
83:
84: @Override
85: public void exceptionCaught(ChannelHandlerContext ctx, ExceptionEvent e){
86: ctx.sendUpstream(e);
87: }
88: }
```

* ç»§æ‰¿

org.jboss.netty.channel.SimpleChannelUpstreamHandler
ç±»ã€‚
* buffer
å±æ€§ï¼Œæœªè¯»å®Œçš„æ¶ˆæ¯ Buffer ã€‚åœ¨

/#messageReceived(ctx, event)
æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åœ¨åšæ‹†åŒ…ç²˜åŒ…çš„å¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½æ”¶åˆ°æ•°æ®æ˜¯ä¸å®Œæ•´çš„ã€‚ä¾‹å¦‚ï¼Œä¸è¶³ä»¥è§£ææˆä¸€æ¡ Dubbo Request ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å°±éœ€è¦å°†æ”¶åˆ°çš„ï¼Œç¼“å­˜åˆ°

buffer
ä¸­ã€‚
* ç¬¬ 10 è‡³ 15 è¡Œï¼šè·³è¿‡é ChannelBuffer ã€‚
* ç¬¬ 17 è‡³ 22 è¡Œï¼šè·³è¿‡æ— å¯è¯»çš„ã€‚
* ç¬¬ 24 è‡³ 38 è¡Œï¼šåˆå¹¶

buffer
+

input
æˆ

message
ã€‚æœ‰**ä¸¤ç±»ä¸‰ç§**æƒ…å†µï¼Œèƒ–å‹çœ‹ä¸‹æ³¨é‡Šã€‚
* ç¬¬ 41 è¡Œï¼šè·å¾— NettyChannel å¯¹è±¡ã€‚
* ç¬¬ 42 è‡³ 69 è¡Œï¼šå¾ªç¯è§£æï¼Œç›´åˆ°ç»“æŸã€‚æ­¤å¤„ï¼Œå’Œ

dubbo-remoting-netty4
çš„è§£ç æµç¨‹ï¼Œå°±æ˜¯ä¸€è‡´çš„äº†ã€‚
* ç¬¬ 71 è‡³ 75 è¡Œï¼šæœ‰å‰©ä½™çš„éƒ¨åˆ†ï¼Œå‹ç¼©å¹¶ç¼“å­˜åˆ°

buffer
ä¸­ã€‚
* ç¬¬ 75 è‡³ 78 è¡Œï¼šå®Œå…¨è¯»å®Œï¼Œè®¾ç½®

buffer
ä¸ºç©º(

EMPTY_BUFFER
)ã€‚
* ç¬¬ 80 è¡Œï¼šç§»é™¤ NettyChannel å¯¹è±¡ï¼Œè‹¥æ–­å¼€è¿æ¥ã€‚

# 9. æ—¥å¿—å·¥å‚

å’Œ

netty-remoting-netty4
çš„**æ—¥å¿—å·¥å‚**ï¼ŒåŸºæœ¬ä¸€è‡´ã€‚å·®å¼‚ç‚¹æ˜¯ [DubboLogger](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-netty/src/main/java/com/alibaba/dubbo/remoting/transport/netty/NettyHelper.java#L43-L103) ï¼Œæ— éœ€å®ç°ç±»ä¼¼

/#log(format, arguments)
ç­‰éœ€è¦æ ¼å¼åŒ–çš„æ–¹æ³•ã€‚å› æ­¤ï¼Œæ— éœ€å¤åˆ¶ FormattingTuple ã€MessageFormatter ç±»ã€‚