# æºç åˆ†æ â€”â€” æ‹“å±•æœºåˆ¶ SPI

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚
 
ğŸ™‚ğŸ™‚ğŸ™‚å…³æ³¨**å¾®ä¿¡å…¬ä¼—å·ï¼šã€èŠ‹é“æºç ã€‘**æœ‰ç¦åˆ©ï¼š

1. RocketMQ / MyCAT / Sharding-JDBC **æ‰€æœ‰**æºç åˆ†ææ–‡ç« åˆ—è¡¨
1. RocketMQ / MyCAT / Sharding-JDBC **ä¸­æ–‡æ³¨é‡Šæºç  GitHub åœ°å€**
1. æ‚¨å¯¹äºæºç çš„ç–‘é—®æ¯æ¡ç•™è¨€**éƒ½**å°†å¾—åˆ°**è®¤çœŸ**å›å¤ã€‚**ç”šè‡³ä¸çŸ¥é“å¦‚ä½•è¯»æºç ä¹Ÿå¯ä»¥è¯·æ•™å™¢**ã€‚
1. **æ–°çš„**æºç è§£ææ–‡ç« **å®æ—¶**æ”¶åˆ°é€šçŸ¥ã€‚**æ¯å‘¨æ›´æ–°ä¸€ç¯‡å·¦å³**ã€‚
1. **è®¤çœŸçš„**æºç äº¤æµå¾®ä¿¡ç¾¤ã€‚

# 1. æ¦‚è¿°

è‰¿è‰¿çš„å‹æƒ…æç¤ºï¼š

è¿™æ˜¯ä¸€ç¯‡ç›¸å¯¹é•¿çš„æ–‡ç« ã€‚

èƒ–å‹å¯ä»¥å¸¦ç€è¿™æ ·çš„æ€ç»´æ¥ç†è§£ Dubbo SPI ï¼Œå®ƒæä¾›äº† Spring IOCã€AOP çš„åŠŸèƒ½ã€‚ğŸ˜ˆ

æœ¬æ–‡ä¸»è¦åˆ†äº« **Dubbo çš„æ‹“å±•æœºåˆ¶ SPI**ã€‚

æƒ³è¦ç†è§£ Dubbo ï¼Œç†è§£ Dubbo SPI æ˜¯éå¸¸å¿…é¡»çš„ã€‚åœ¨ Dubbo ä¸­ï¼Œæä¾›äº†å¤§é‡çš„**æ‹“å±•ç‚¹**ï¼ŒåŸºäº Dubbo SPI æœºåˆ¶åŠ è½½ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![Dubbo æ‹“å±•ç‚¹](http://static2.iocoder.cn/images/Dubbo/2018_03_04/01.png)

# 2. æ”¹è¿›

åœ¨çœ‹å…·ä½“çš„ Dubbo SPI å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç†è§£ Dubbo SPI äº§ç”Ÿçš„èƒŒæ™¯ï¼š
FROM [ã€ŠDubbo å¼€å‘æŒ‡å— â€”â€” æ‹“å±•ç‚¹åŠ è½½ã€‹](http://dubbo.apache.org/zh-cn/docs/dev/SPI.html)

Dubbo çš„æ‰©å±•ç‚¹åŠ è½½ä» JDK æ ‡å‡†çš„ SPI (Service Provider Interface) æ‰©å±•ç‚¹å‘ç°æœºåˆ¶åŠ å¼ºè€Œæ¥ã€‚

Dubbo æ”¹è¿›äº† JDK æ ‡å‡†çš„ SPI çš„ä»¥ä¸‹é—®é¢˜ï¼š

1. JDK æ ‡å‡†çš„ SPI ä¼šä¸€æ¬¡æ€§å®ä¾‹åŒ–æ‰©å±•ç‚¹æ‰€æœ‰å®ç°ï¼Œå¦‚æœæœ‰æ‰©å±•å®ç°åˆå§‹åŒ–å¾ˆè€—æ—¶ï¼Œä½†å¦‚æœæ²¡ç”¨ä¸Šä¹ŸåŠ è½½ï¼Œä¼šå¾ˆæµªè´¹èµ„æºã€‚
1. å¦‚æœæ‰©å±•ç‚¹åŠ è½½å¤±è´¥ï¼Œè¿æ‰©å±•ç‚¹çš„åç§°éƒ½æ‹¿ä¸åˆ°äº†ã€‚æ¯”å¦‚ï¼šJDK æ ‡å‡†çš„ ScriptEngineï¼Œé€šè¿‡ getName() è·å–è„šæœ¬ç±»å‹çš„åç§°ï¼Œä½†å¦‚æœ RubyScriptEngine å› ä¸ºæ‰€ä¾èµ–çš„ jruby.jar ä¸å­˜åœ¨ï¼Œå¯¼è‡´ RubyScriptEngine ç±»åŠ è½½å¤±è´¥ï¼Œè¿™ä¸ªå¤±è´¥åŸå› è¢«åƒæ‰äº†ï¼Œå’Œ ruby å¯¹åº”ä¸èµ·æ¥ï¼Œå½“ç”¨æˆ·æ‰§è¡Œ ruby è„šæœ¬æ—¶ï¼Œä¼šæŠ¥ä¸æ”¯æŒ rubyï¼Œè€Œä¸æ˜¯çœŸæ­£å¤±è´¥çš„åŸå› ã€‚
1. å¢åŠ äº†å¯¹æ‰©å±•ç‚¹ IoC å’Œ AOP çš„æ”¯æŒï¼Œä¸€ä¸ªæ‰©å±•ç‚¹å¯ä»¥ç›´æ¥ setter æ³¨å…¥å…¶å®ƒæ‰©å±•ç‚¹ã€‚

* Dubbo è‡ªå·±å®ç°äº†ä¸€å¥— SPI æœºåˆ¶ï¼Œè€Œä¸æ˜¯ä½¿ç”¨ Java æ ‡å‡†çš„ SPI ã€‚
* ç¬¬ä¸€ç‚¹é—®é¢˜ï¼ŒDubbo æœ‰å¾ˆå¤šçš„æ‹“å±•ç‚¹ï¼Œä¾‹å¦‚ Protocolã€Filter ç­‰ç­‰ã€‚å¹¶ä¸”æ¯ä¸ªæ‹“å±•ç‚¹æœ‰å¤šç§çš„å®ç°ï¼Œä¾‹å¦‚ Protocol æœ‰ DubboProtocolã€InjvmProtocolã€RestProtocol ç­‰ç­‰ã€‚é‚£ä¹ˆä½¿ç”¨ JDK SPI æœºåˆ¶ï¼Œä¼šåˆå§‹åŒ–æ— ç”¨çš„æ‹“å±•ç‚¹åŠå…¶å®ç°ï¼Œé€ æˆä¸å¿…è¦çš„è€—æ—¶ä¸èµ„æºæµªè´¹ã€‚

* å¦‚æœæ— æ³•ç†è§£çš„èƒ–å‹ï¼Œè·Ÿç€ [ã€ŠJava SPI(Service Provider Interface)ç®€ä»‹ã€‹](http://blog.csdn.net/top_code/article/details/51934459) æ–‡ç« ï¼Œ**å†™å¤šä¸ªæ‹“å±•å®ç°**ï¼Œå°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚ğŸ™‚ è¿™å°±æ˜¯æ¦‚å¿µå‘€ã€‚
* ç¬¬äºŒç‚¹é—®é¢˜ï¼Œã€TODO 8009ã€‘ScriptEngine æ²¡çœ‹æ˜ç™½ï¼Œä¸å½±å“æœ¬æ–‡ç†è§£ã€‚
* ç¬¬ä¸‰ç‚¹é—®é¢˜ï¼Œä¸¥æ ¼æ¥è¯´ï¼Œè¿™ä¸ç®—é—®é¢˜ï¼Œ**è€Œæ˜¯å¢åŠ äº†åŠŸèƒ½ç‰¹æ€§**ï¼Œåœ¨ä¸‹æ–‡æˆ‘ä»¬ä¼šçœ‹åˆ°ã€‚

# 3. ä»£ç ç»“æ„

Dubbo SPI åœ¨

dubbo-common
çš„ [
extension
](https://github.com/YunaiV/dubbo/tree/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension) åŒ…å®ç°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![ä»£ç ç»“æ„](http://static2.iocoder.cn/images/Dubbo/2018_03_04/02.png)

# 4. ExtensionLoader

[
com.alibaba.dubbo.common.extension.ExtensionLoader
](http://svip.iocoder.cn/Dubbo/spi/ExtensionLoader) ï¼Œæ‹“å±•åŠ è½½å™¨ã€‚è¿™æ˜¯ Dubbo SPI çš„**æ ¸å¿ƒ**ã€‚

## 4.1 å±æ€§

```
1: private static final String SERVICES_DIRECTORY = "META-INF/services/";
2:
3: private static final String DUBBO_DIRECTORY = "META-INF/dubbo/";
4:
5: private static final String DUBBO_INTERNAL_DIRECTORY = DUBBO_DIRECTORY + "internal/";
6:
7: private static final Pattern NAME_SEPARATOR = Pattern.compile("\\s/*[,]+\\s/*");
8:
9: // ============================== é™æ€å±æ€§ ==============================
10:
11: //*/*
12: /* æ‹“å±•åŠ è½½å™¨é›†åˆ
13: /*
14: /* keyï¼šæ‹“å±•æ¥å£
15: /*/
16: private static final ConcurrentMap<Class<?>, ExtensionLoader<?>> EXTENSION_LOADERS = new ConcurrentHashMap<Class<?>, ExtensionLoader<?>>();
17: //*/*
18: /* æ‹“å±•å®ç°ç±»é›†åˆ
19: /*
20: /* keyï¼šæ‹“å±•å®ç°ç±»
21: /* valueï¼šæ‹“å±•å¯¹è±¡ã€‚
22: /*
23: /* ä¾‹å¦‚ï¼Œkey ä¸º Class<AccessLogFilter>
24: /* value ä¸º AccessLogFilter å¯¹è±¡
25: /*/
26: private static final ConcurrentMap<Class<?>, Object> EXTENSION_INSTANCES = new ConcurrentHashMap<Class<?>, Object>();
27:
28: // ============================== å¯¹è±¡å±æ€§ ==============================
29:
30: //*/*
31: /* æ‹“å±•æ¥å£ã€‚
32: /* ä¾‹å¦‚ï¼ŒProtocol
33: /*/
34: private final Class<?> type;
35: //*/*
36: /* å¯¹è±¡å·¥å‚
37: /*
38: /* ç”¨äºè°ƒç”¨ {@link /#injectExtension(Object)} æ–¹æ³•ï¼Œå‘æ‹“å±•å¯¹è±¡æ³¨å…¥ä¾èµ–å±æ€§ã€‚
39: /*
40: /* ä¾‹å¦‚ï¼ŒStubProxyFactoryWrapper ä¸­æœ‰ `Protocol protocol` å±æ€§ã€‚
41: /*/
42: private final ExtensionFactory objectFactory;
43: //*/*
44: /* ç¼“å­˜çš„æ‹“å±•åä¸æ‹“å±•ç±»çš„æ˜ å°„ã€‚
45: /*
46: /* å’Œ {@link /#cachedClasses} çš„ KV å¯¹è°ƒã€‚
47: /*
48: /* é€šè¿‡ {@link /#loadExtensionClasses} åŠ è½½
49: /*/
50: private final ConcurrentMap<Class<?>, String> cachedNames = new ConcurrentHashMap<Class<?>, String>();
51: //*/*
52: /* ç¼“å­˜çš„æ‹“å±•å®ç°ç±»é›†åˆã€‚
53: /*
54: /* ä¸åŒ…å«å¦‚ä¸‹ä¸¤ç§ç±»å‹ï¼š
55: /* 1. è‡ªé€‚åº”æ‹“å±•å®ç°ç±»ã€‚ä¾‹å¦‚ AdaptiveExtensionFactory
56: /* 2. å¸¦å”¯ä¸€å‚æ•°ä¸ºæ‹“å±•æ¥å£çš„æ„é€ æ–¹æ³•çš„å®ç°ç±»ï¼Œæˆ–è€…è¯´æ‹“å±• Wrapper å®ç°ç±»ã€‚ä¾‹å¦‚ï¼ŒProtocolFilterWrapper ã€‚
57: /* æ‹“å±• Wrapper å®ç°ç±»ï¼Œä¼šæ·»åŠ åˆ° {@link /#cachedWrapperClasses} ä¸­
58: /*
59: /* é€šè¿‡ {@link /#loadExtensionClasses} åŠ è½½
60: /*/
61: private final Holder<Map<String, Class<?>>> cachedClasses = new Holder<Map<String, Class<?>>>();
62:
63: //*/*
64: /* æ‹“å±•åä¸ @Activate çš„æ˜ å°„
65: /*
66: /* ä¾‹å¦‚ï¼ŒAccessLogFilterã€‚
67: /*
68: /* ç”¨äº {@link /#getActivateExtension(URL, String)}
69: /*/
70: private final Map<String, Activate> cachedActivates = new ConcurrentHashMap<String, Activate>();
71: //*/*
72: /* ç¼“å­˜çš„æ‹“å±•å¯¹è±¡é›†åˆ
73: /*
74: /* keyï¼šæ‹“å±•å
75: /* valueï¼šæ‹“å±•å¯¹è±¡
76: /*
77: /* ä¾‹å¦‚ï¼ŒProtocol æ‹“å±•
78: /* keyï¼šdubbo valueï¼šDubboProtocol
79: /* keyï¼šinjvm valueï¼šInjvmProtocol
80: /*
81: /* é€šè¿‡ {@link /#loadExtensionClasses} åŠ è½½
82: /*/
83: private final ConcurrentMap<String, Holder<Object>> cachedInstances = new ConcurrentHashMap<String, Holder<Object>>();
84: //*/*
85: /* ç¼“å­˜çš„è‡ªé€‚åº”( Adaptive )æ‹“å±•å¯¹è±¡
86: /*/
87: private final Holder<Object> cachedAdaptiveInstance = new Holder<Object>();
88: //*/*
89: /* ç¼“å­˜çš„è‡ªé€‚åº”æ‹“å±•å¯¹è±¡çš„ç±»
90: /*
91: /* {@link /#getAdaptiveExtensionClass()}
92: /*/
93: private volatile Class<?> cachedAdaptiveClass = null;
94: //*/*
95: /* ç¼“å­˜çš„é»˜è®¤æ‹“å±•å
96: /*
97: /* é€šè¿‡ {@link SPI} æ³¨è§£è·å¾—
98: /*/
99: private String cachedDefaultName;
100: //*/*
101: /* åˆ›å»º {@link /#cachedAdaptiveInstance} æ—¶å‘ç”Ÿçš„å¼‚å¸¸ã€‚
102: /*
103: /* å‘ç”Ÿå¼‚å¸¸åï¼Œä¸å†åˆ›å»ºï¼Œå‚è§ {@link /#createAdaptiveExtension()}
104: /*/
105: private volatile Throwable createAdaptiveInstanceError;
106:
107: //*/*
108: /* æ‹“å±• Wrapper å®ç°ç±»é›†åˆ
109: /*
110: /* å¸¦å”¯ä¸€å‚æ•°ä¸ºæ‹“å±•æ¥å£çš„æ„é€ æ–¹æ³•çš„å®ç°ç±»
111: /*
112: /* é€šè¿‡ {@link /#loadExtensionClasses} åŠ è½½
113: /*/
114: private Set<Class<?>> cachedWrapperClasses;
115:
116: //*/*
117: /* æ‹“å±•å ä¸ åŠ è½½å¯¹åº”æ‹“å±•ç±»å‘ç”Ÿçš„å¼‚å¸¸ çš„ æ˜ å°„
118: /*
119: /* keyï¼šæ‹“å±•å
120: /* valueï¼šå¼‚å¸¸
121: /*
122: /* åœ¨ {@link /#loadFile(Map, String)} æ—¶ï¼Œè®°å½•
123: /*/
124: private Map<String, IllegalStateException> exceptions = new ConcurrentHashMap<String, IllegalStateException>();
```

* ç¬¬ 1 è‡³ 5 è¡Œï¼šåœ¨

META-INF/dubbo/internal/
å’Œ

META-INF/dubbo/
ç›®å½•ä¸‹ï¼Œæ”¾ç½® **æ¥å£å…¨é™å®šå** é…ç½®æ–‡ä»¶ï¼Œ**æ¯è¡Œ**å†…å®¹ä¸ºï¼š**æ‹“å±•å=æ‹“å±•å®ç°ç±»å…¨é™å®šå**ã€‚

* META-INF/dubbo/internal/
ç›®å½•ä¸‹ï¼Œä»åå­—ä¸Šå¯ä»¥çœ‹å‡ºï¼Œç”¨äº Dubbo **å†…éƒ¨**æä¾›çš„æ‹“å±•å®ç°ã€‚ä¸‹å›¾æ˜¯ä¸€ä¸ªä¾‹å­ï¼š![META-INF/dubbo/internal/ ä¾‹å­](http://static2.iocoder.cn/images/Dubbo/2018_03_04/03.png)
* META-INF/dubbo/
ç›®å½•ä¸‹ï¼Œç”¨äºç”¨æˆ·**è‡ªå®šä¹‰**çš„æ‹“å±•å®ç°ã€‚
* META-INF/service/
ç›®å½•ä¸‹ï¼ŒJava SPI çš„é…ç½®ç›®å½•ã€‚åœ¨ [ã€Œ4.2 åŠ è½½æ‹“å±•é…ç½®ã€](http://svip.iocoder.cn/Dubbo/spi/) ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ° Dubbo SPI å¯¹ Java SPI åšäº†**å…¼å®¹**ã€‚
* ç¬¬ 7 è¡Œï¼š

NAME_SEPARATOR
ï¼Œæ‹“å±•ååˆ†éš”ç¬¦ï¼Œä½¿ç”¨**é€—å·**ã€‚
* **ç¬¬ 9 è‡³ 124 è¡Œ**ï¼Œæˆ‘ä»¬å°†å±æ€§åˆ†æˆäº†ä¸¤ç±»ï¼š1ï¼‰é™æ€å±æ€§ï¼›2ï¼‰å¯¹è±¡å±æ€§ã€‚è¿™æ˜¯ä¸ºå•¥å‘¢ï¼Ÿ

* ã€é™æ€å±æ€§ã€‘ä¸€æ–¹é¢ï¼ŒExtensionLoader æ˜¯ ExtensionLoader çš„**ç®¡ç†å®¹å™¨**ã€‚ä¸€ä¸ªæ‹“å±•( æ‹“å±•æ¥å£ )å¯¹åº”ä¸€ä¸ª ExtensionLoader å¯¹è±¡ã€‚ä¾‹å¦‚ï¼ŒProtocol å’Œ Filter **åˆ†åˆ«**å¯¹åº”ä¸€ä¸ª ExtensionLoader å¯¹è±¡ã€‚
* ã€å¯¹è±¡å±æ€§ã€‘å¦ä¸€æ–¹é¢ï¼Œä¸€ä¸ªæ‹“å±•é€šè¿‡å…¶ ExtensionLoader å¯¹è±¡ï¼ŒåŠ è½½å®ƒçš„**æ‹“å±•å®ç°ä»¬**ã€‚æˆ‘ä»¬ä¼šå‘ç°å¤šä¸ªå±æ€§éƒ½æ˜¯ â€œ**cached**â€œ å¼€å¤´ã€‚ExtensionLoader è€ƒè™‘åˆ°æ€§èƒ½å’Œèµ„æºçš„ä¼˜åŒ–ï¼Œè¯»å–æ‹“å±•é…ç½®åï¼Œä¼šé¦–å…ˆè¿›è¡Œ**ç¼“å­˜**ã€‚ç­‰åˆ° Dubbo ä»£ç **çœŸæ­£**ç”¨åˆ°å¯¹åº”çš„æ‹“å±•å®ç°æ—¶ï¼Œè¿›è¡Œæ‹“å±•å®ç°çš„å¯¹è±¡çš„åˆå§‹åŒ–ã€‚å¹¶ä¸”ï¼Œåˆå§‹åŒ–å®Œæˆåï¼Œä¹Ÿä¼šè¿›è¡Œ**ç¼“å­˜**ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š

* ç¼“å­˜åŠ è½½çš„æ‹“å±•é…ç½®
* ç¼“å­˜åˆ›å»ºçš„æ‹“å±•å®ç°å¯¹è±¡
* ğŸ™‚ èƒ–å‹å…ˆçœ‹ä¸‹å±æ€§çš„ä»£ç æ³¨é‡Šï¼Œæœ‰ä¸€ä¸ªæ•´ä½“çš„å°è±¡ã€‚ä¸‹é¢æˆ‘ä»¬åœ¨è¯»å®ç°ä»£ç æ—¶ï¼Œä¼šè¿›ä¸€æ­¥è§£æè¯´æ˜ã€‚

è€ƒè™‘åˆ°èƒ–å‹èƒ½æ›´å¥½çš„ç†è§£ä¸‹é¢çš„ä»£ç å®ç°ï¼Œæ¨èå…ˆé˜…è¯»ä¸‹ [ã€ŠDubbo å¼€å‘æŒ‡å— â€”â€” æ‰©å±•ç‚¹åŠ è½½ã€‹](http://dubbo.apache.org/zh-cn/docs/dev/SPI.html) æ–‡æ¡£ï¼Œå»ºç«‹ä¸‹å¯¹ ExtensionLoader ç‰¹ç‚¹çš„åˆæ­¥ç†è§£ï¼š

* æ‰©å±•ç‚¹è‡ªåŠ¨åŒ…è£…

* åœ¨ [ã€Œ4.4.2 createExtensionã€](http://svip.iocoder.cn/Dubbo/spi/) è¯¦ç»†è§£æã€‚
* æ‰©å±•ç‚¹è‡ªåŠ¨è£…é…

* åœ¨ [ã€Œ4.4.3 injectExtensionã€](http://svip.iocoder.cn/Dubbo/spi/) è¯¦ç»†è§£æã€‚
* æ‰©å±•ç‚¹è‡ªé€‚åº”

* åœ¨ [ã€Œ4.5 è·å¾—è‡ªé€‚åº”çš„æ‹“å±•å¯¹è±¡ã€](http://svip.iocoder.cn/Dubbo/spi/) è¯¦ç»†è§£æã€‚
* æ‰©å±•ç‚¹è‡ªåŠ¨æ¿€æ´»

* åœ¨ [ã€Œ4.6 è·å¾—æ¿€æ´»çš„æ‹“å±•å¯¹è±¡æ•°ç»„ã€](http://svip.iocoder.cn/Dubbo/spi/) è¯¦ç»†è§£æã€‚

## 4.2 è·å¾—æ‹“å±•é…ç½®

### 4.2.1 getExtensionClasses

/#getExtensionClasses()
æ–¹æ³•ï¼Œè·å¾—æ‹“å±•å®ç°ç±»æ•°ç»„ã€‚
```
private final Holder<Map<String, Class<?>>> cachedClasses = new Holder<Map<String, Class<?>>>();
private volatile Class<?> cachedAdaptiveClass = null;
private Set<Class<?>> cachedWrapperClasses;
1: //*/*
2: /* è·å¾—æ‹“å±•å®ç°ç±»æ•°ç»„
3: /*
4: /* @return æ‹“å±•å®ç°ç±»æ•°ç»„
5: /*/
6: private Map<String, Class<?>> getExtensionClasses() {
7: // ä»ç¼“å­˜ä¸­ï¼Œè·å¾—æ‹“å±•å®ç°ç±»æ•°ç»„
8: Map<String, Class<?>> classes = cachedClasses.get();
9: if (classes == null) {
10: synchronized (cachedClasses) {
11: classes = cachedClasses.get();
12: if (classes == null) {
13: // ä»é…ç½®æ–‡ä»¶ä¸­ï¼ŒåŠ è½½æ‹“å±•å®ç°ç±»æ•°ç»„
14: classes = loadExtensionClasses();
15: // è®¾ç½®åˆ°ç¼“å­˜ä¸­
16: cachedClasses.set(classes);
17: }
18: }
19: }
20: return classes;
21: }
```

* cachedClasses
å±æ€§ï¼Œç¼“å­˜çš„æ‹“å±•å®ç°ç±»é›†åˆã€‚å®ƒä¸åŒ…å«å¦‚ä¸‹ä¸¤ç§ç±»å‹çš„æ‹“å±•å®ç°ï¼š

* **è‡ªé€‚åº”**æ‹“å±•å®ç°ç±»ã€‚ä¾‹å¦‚ AdaptiveExtensionFactory ã€‚

* æ‹“å±• Adaptive å®ç°ç±»ï¼Œä¼šæ·»åŠ åˆ°

cachedAdaptiveClass
å±æ€§ä¸­ã€‚
* å¸¦**å”¯ä¸€å‚æ•°ä¸ºæ‹“å±•æ¥å£**çš„æ„é€ æ–¹æ³•çš„å®ç°ç±»ï¼Œæˆ–è€…è¯´æ‹“å±• Wrapper å®ç°ç±»ã€‚ä¾‹å¦‚ï¼ŒProtocolFilterWrapper ã€‚

* æ‹“å±• Wrapper å®ç°ç±»ï¼Œä¼šæ·»åŠ åˆ°

cachedWrapperClasses
å±æ€§ä¸­ã€‚
* æ€»ç»“æ¥è¯´ï¼Œ

cachedClasses
+

cachedAdaptiveClass
+

cachedWrapperClasses
æ‰æ˜¯**å®Œæ•´**ç¼“å­˜çš„æ‹“å±•å®ç°ç±»çš„é…ç½®ã€‚
* ç¬¬ 7 è‡³ 11 è¡Œï¼šä»ç¼“å­˜ä¸­ï¼Œè·å¾—æ‹“å±•å®ç°ç±»æ•°ç»„ã€‚
* ç¬¬ 12 è‡³ 14 è¡Œï¼šå½“ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œè°ƒç”¨

/#loadExtensionClasses()
æ–¹æ³•ï¼Œä»é…ç½®æ–‡ä»¶ä¸­ï¼ŒåŠ è½½æ‹“å±•å®ç°ç±»æ•°ç»„ã€‚
* ç¬¬ 16 è¡Œï¼šè®¾ç½®åŠ è½½çš„å®ç°ç±»æ•°ç»„ï¼Œåˆ°ç¼“å­˜ä¸­ã€‚

### 4.2.2 loadExtensionClasses

/#loadExtensionClasses()
æ–¹æ³•ï¼Œä»**å¤šä¸ª**é…ç½®æ–‡ä»¶ä¸­ï¼ŒåŠ è½½æ‹“å±•å®ç°ç±»æ•°ç»„ã€‚
```
1: //*/*
2: /* åŠ è½½æ‹“å±•å®ç°ç±»æ•°ç»„
3: /*
4: /* æ— éœ€å£°æ˜ synchronized ï¼Œå› ä¸ºå”¯ä¸€è°ƒç”¨è¯¥æ–¹æ³•çš„ {@link /#getExtensionClasses()} å·²ç»å£°æ˜ã€‚
5: /* // synchronized in getExtensionClasses
6: /*
7: /* @return æ‹“å±•å®ç°ç±»æ•°ç»„
8: /*/
9: private Map<String, Class<?>> loadExtensionClasses() {
10: // é€šè¿‡ @SPI æ³¨è§£ï¼Œè·å¾—é»˜è®¤çš„æ‹“å±•å®ç°ç±»å
11: final SPI defaultAnnotation = type.getAnnotation(SPI.class);
12: if (defaultAnnotation != null) {
13: String value = defaultAnnotation.value();
14: if ((value = value.trim()).length() > 0) {
15: String[] names = NAME_SEPARATOR.split(value);
16: if (names.length > 1) {
17: throw new IllegalStateException("more than 1 default extension name on extension " + type.getName()
18: + ": " + Arrays.toString(names));
19: }
20: if (names.length == 1) cachedDefaultName = names[0];
21: }
22: }
23:
24: // ä»é…ç½®æ–‡ä»¶ä¸­ï¼ŒåŠ è½½æ‹“å±•å®ç°ç±»æ•°ç»„
25: Map<String, Class<?>> extensionClasses = new HashMap<String, Class<?>>();
26: loadFile(extensionClasses, DUBBO_INTERNAL_DIRECTORY);
27: loadFile(extensionClasses, DUBBO_DIRECTORY);
28: loadFile(extensionClasses, SERVICES_DIRECTORY);
29: return extensionClasses;
30: }
```

* ç¬¬ 10 è‡³ 22 è¡Œï¼šé€šè¿‡

@SPI
æ³¨è§£ï¼Œè·å¾—æ‹“å±•æ¥å£å¯¹åº”çš„**é»˜è®¤çš„**æ‹“å±•å®ç°ç±»åã€‚åœ¨ [ã€Œ5. @SPIã€](http://svip.iocoder.cn/Dubbo/spi/) è¯¦ç»†è§£æã€‚
* ç¬¬ 25 è‡³ 29 è¡Œï¼šè°ƒç”¨

/#loadFile(extensionClasses, dir)
æ–¹æ³•ï¼Œä»é…ç½®æ–‡ä»¶ä¸­ï¼ŒåŠ è½½æ‹“å±•å®ç°ç±»æ•°ç»„ã€‚**æ³¨æ„**ï¼Œæ­¤å¤„é…ç½®æ–‡ä»¶çš„åŠ è½½é¡ºåºã€‚

### 4.2.3 loadFile

/#loadFile(extensionClasses, dir)
æ–¹æ³•ï¼Œä»**ä¸€ä¸ª**é…ç½®æ–‡ä»¶ä¸­ï¼ŒåŠ è½½æ‹“å±•å®ç°ç±»æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* ç¼“å­˜çš„è‡ªé€‚åº”æ‹“å±•å¯¹è±¡çš„ç±»
/*
/* {@link /#getAdaptiveExtensionClass()}
/*/
private volatile Class<?> cachedAdaptiveClass = null;
//*/*
/* æ‹“å±• Wrapper å®ç°ç±»é›†åˆ
/*
/* å¸¦å”¯ä¸€å‚æ•°ä¸ºæ‹“å±•æ¥å£çš„æ„é€ æ–¹æ³•çš„å®ç°ç±»
/*
/* é€šè¿‡ {@link /#loadExtensionClasses} åŠ è½½
/*/
private Set<Class<?>> cachedWrapperClasses;
//*/*
/* æ‹“å±•åä¸ @Activate çš„æ˜ å°„
/*
/* ä¾‹å¦‚ï¼ŒAccessLogFilterã€‚
/*
/* ç”¨äº {@link /#getActivateExtension(URL, String)}
/*/
private final Map<String, Activate> cachedActivates = new ConcurrentHashMap<String, Activate>();
//*/*
/* ç¼“å­˜çš„æ‹“å±•åä¸æ‹“å±•ç±»çš„æ˜ å°„ã€‚
/*
/* å’Œ {@link /#cachedClasses} çš„ KV å¯¹è°ƒã€‚
/*
/* é€šè¿‡ {@link /#loadExtensionClasses} åŠ è½½
/*/
private final ConcurrentMap<Class<?>, String> cachedNames = new ConcurrentHashMap<Class<?>, String>();
//*/*
/* æ‹“å±•å ä¸ åŠ è½½å¯¹åº”æ‹“å±•ç±»å‘ç”Ÿçš„å¼‚å¸¸ çš„ æ˜ å°„
/*
/* keyï¼šæ‹“å±•å
/* valueï¼šå¼‚å¸¸
/*
/* åœ¨ {@link /#loadFile(Map, String)} æ—¶ï¼Œè®°å½•
/*/
private Map<String, IllegalStateException> exceptions = new ConcurrentHashMap<String, IllegalStateException>();
1: //*/*
2: /* ä»ä¸€ä¸ªé…ç½®æ–‡ä»¶ä¸­ï¼ŒåŠ è½½æ‹“å±•å®ç°ç±»æ•°ç»„ã€‚
3: /*
4: /* @param extensionClasses æ‹“å±•ç±»åæ•°ç»„
5: /* @param dir æ–‡ä»¶å
6: /*/
7: private void loadFile(Map<String, Class<?>> extensionClasses, String dir){
8: // å®Œæ•´çš„æ–‡ä»¶å
9: String fileName = dir + type.getName();
10: try {
11: Enumeration<java.net.URL> urls;
12: // è·å¾—æ–‡ä»¶åå¯¹åº”çš„æ‰€æœ‰æ–‡ä»¶æ•°ç»„
13: ClassLoader classLoader = findClassLoader();
14: if (classLoader != null) {
15: urls = classLoader.getResources(fileName);
16: } else {
17: urls = ClassLoader.getSystemResources(fileName);
18: }
19: // éå†æ–‡ä»¶æ•°ç»„
20: if (urls != null) {
21: while (urls.hasMoreElements()) {
22: java.net.URL url = urls.nextElement();
23: try {
24: BufferedReader reader = new BufferedReader(new InputStreamReader(url.openStream(), "utf-8"));
25: try {
26: String line;
27: while ((line = reader.readLine()) != null) {
28: // è·³è¿‡å½“å‰è¢«æ³¨é‡Šæ‰çš„æƒ…å†µï¼Œä¾‹å¦‚ /#spring=xxxxxxxxx
29: final int ci = line.indexOf('/#');
30: if (ci >= 0) line = line.substring(0, ci);
31: line = line.trim();
32: if (line.length() > 0) {
33: try {
34: // æ‹†åˆ†ï¼Œkey=value çš„é…ç½®æ ¼å¼
35: String name = null;
36: int i = line.indexOf('=');
37: if (i > 0) {
38: name = line.substring(0, i).trim();
39: line = line.substring(i + 1).trim();
40: }
41: if (line.length() > 0) {
42: // åˆ¤æ–­æ‹“å±•å®ç°ï¼Œæ˜¯å¦å®ç°æ‹“å±•æ¥å£
43: Class<?> clazz = Class.forName(line, true, classLoader);
44: if (!type.isAssignableFrom(clazz)) {
45: throw new IllegalStateException("Error when load extension class(interface: " +
46: type + ", class line: " + clazz.getName() + "), class "
47: + clazz.getName() + "is not subtype of interface.");
48: }
49: // ç¼“å­˜è‡ªé€‚åº”æ‹“å±•å¯¹è±¡çš„ç±»åˆ° `cachedAdaptiveClass`
50: if (clazz.isAnnotationPresent(Adaptive.class)) {
51: if (cachedAdaptiveClass == null) {
52: cachedAdaptiveClass = clazz;
53: } else if (!cachedAdaptiveClass.equals(clazz)) {
54: throw new IllegalStateException("More than 1 adaptive class found: "
55: + cachedAdaptiveClass.getClass().getName()
56: + ", " + clazz.getClass().getName());
57: }
58: } else {
59: // ç¼“å­˜æ‹“å±• Wrapper å®ç°ç±»åˆ° `cachedWrapperClasses`
60: try {
61: clazz.getConstructor(type);
62: Set<Class<?>> wrappers = cachedWrapperClasses;
63: if (wrappers == null) {
64: cachedWrapperClasses = new ConcurrentHashSet<Class<?>>();
65: wrappers = cachedWrapperClasses;
66: }
67: wrappers.add(clazz);
68: // ç¼“å­˜æ‹“å±•å®ç°ç±»åˆ° `extensionClasses`
69: } catch (NoSuchMethodException e) {
70: clazz.getConstructor();
71: // æœªé…ç½®æ‹“å±•åï¼Œè‡ªåŠ¨ç”Ÿæˆã€‚ä¾‹å¦‚ï¼ŒDemoFilter ä¸º demo ã€‚ä¸»è¦ç”¨äºå…¼å®¹ Java SPI çš„é…ç½®ã€‚
72: if (name == null || name.length() == 0) {
73: name = findAnnotationName(clazz);
74: if (name == null || name.length() == 0) {
75: if (clazz.getSimpleName().length() > type.getSimpleName().length()
76: && clazz.getSimpleName().endsWith(type.getSimpleName())) {
77: name = clazz.getSimpleName().substring(0, clazz.getSimpleName().length() - type.getSimpleName().length()).toLowerCase();
78: } else {
79: throw new IllegalStateException("No such extension name for the class " + clazz.getName() + " in the config " + url);
80: }
81: }
82: }
83: // è·å¾—æ‹“å±•åï¼Œå¯ä»¥æ˜¯æ•°ç»„ï¼Œæœ‰å¤šä¸ªæ‹“å±•åã€‚
84: String[] names = NAME_SEPARATOR.split(name);
85: if (names != null && names.length > 0) {
86: // ç¼“å­˜ @Activate åˆ° `cachedActivates` ã€‚
87: Activate activate = clazz.getAnnotation(Activate.class);
88: if (activate != null) {
89: cachedActivates.put(names[0], activate);
90: }
91: for (String n : names) {
92: // ç¼“å­˜åˆ° `cachedNames`
93: if (!cachedNames.containsKey(clazz)) {
94: cachedNames.put(clazz, n);
95: }
96: // ç¼“å­˜æ‹“å±•å®ç°ç±»åˆ° `extensionClasses`
97: Class<?> c = extensionClasses.get(n);
98: if (c == null) {
99: extensionClasses.put(n, clazz);
100: } else if (c != clazz) {
101: throw new IllegalStateException("Duplicate extension " + type.getName() + " name " + n + " on " + c.getName() + " and " + clazz.getName());
102: }
103: }
104: }
105: }
106: }
107: }
108: } catch (Throwable t) {
109: // å‘ç”Ÿå¼‚å¸¸ï¼Œè®°å½•åˆ°å¼‚å¸¸é›†åˆ
110: IllegalStateException e = new IllegalStateException("Failed to load extension class(interface: " + type + ", class line: " + line + ") in " + url + ", cause: " + t.getMessage(), t);
111: exceptions.put(line, e);
112: }
113: }
114: } // end of while read lines
115: } finally {
116: reader.close();
117: }
118: } catch (Throwable t) {
119: logger.error("Exception when load extension class(interface: " +
120: type + ", class file: " + url + ") in " + url, t);
121: }
122: } // end of while urls
123: }
124: } catch (Throwable t) {
125: logger.error("Exception when load extension class(interface: " +
126: type + ", description file: " + fileName + ").", t);
127: }
128: }
```

* ç¬¬ 9 è¡Œï¼šè·å¾—å®Œæ•´çš„æ–‡ä»¶å( ç›¸å¯¹è·¯å¾„ )ã€‚ä¾‹å¦‚ï¼š

"META-INF/dubbo/internal/com.alibaba.dubbo.common.extension.ExtensionFactory"
ã€‚
* ç¬¬ 12 è‡³ 18 è¡Œï¼šè·å¾—æ–‡ä»¶åå¯¹åº”çš„æ‰€æœ‰æ–‡ä»¶ URL æ•°ç»„ã€‚ä¾‹å¦‚ï¼š![ExtensionFactory çš„é…ç½®æ–‡ä»¶](http://static2.iocoder.cn/images/Dubbo/2018_03_04/04.png)
* ç¬¬ 21 è‡³ 24 è¡Œï¼šé€ä¸ª**æ–‡ä»¶** URL éå†ã€‚
* ç¬¬ 27 è¡Œï¼šé€**è¡Œ**éå†ã€‚
* ç¬¬ 29 è‡³ 32 è¡Œï¼šè·³è¿‡å½“å‰è¢«

"/#"
æ³¨é‡Šæ‰çš„æƒ…å†µï¼Œä¾‹å¦‚

/#spring=xxxxxxxxx
ã€‚
* ç¬¬ 34 è‡³ 40 è¡Œï¼šæŒ‰ç…§

key=value
çš„é…ç½®æ‹†åˆ†ã€‚å…¶ä¸­

name
ä¸ºæ‹“å±•åï¼Œ

line
ä¸ºæ‹“å±•å®ç°ç±»åã€‚**æ³¨æ„**ï¼Œä¸Šæ–‡æˆ‘ä»¬æåˆ°è¿‡ Dubbo SPI ä¼šå…¼å®¹ Java SPI çš„é…ç½®æ ¼å¼ï¼Œé‚£ä¹ˆæŒ‰ç…§æ­¤å¤„çš„è§£ææ–¹å¼ï¼Œ

name
ä¼šä¸ºç©ºã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæ‹“å±•åä¼šè‡ªåŠ¨ç”Ÿæˆï¼Œè¯¦ç»†è§ç¬¬ 71 è‡³ 82 è¡Œçš„ä»£ç ã€‚
* ç¬¬ 42 è‡³ 48 è¡Œï¼šåˆ¤æ–­æ‹“å±•å®ç°ç±»ï¼Œéœ€è¦å®ç°æ‹“å±•æ¥å£ã€‚
* ç¬¬ 50 è‡³ 57 è¡Œï¼šç¼“å­˜è‡ªé€‚åº”æ‹“å±•å¯¹è±¡çš„ç±»åˆ°

cachedAdaptiveClass
å±æ€§ã€‚åœ¨ [ã€Œ6. @Adaptiveã€](http://svip.iocoder.cn/Dubbo/spi/) è¯¦ç»†è§£æã€‚
* ç¬¬ 59 è‡³ 67 è¡Œï¼šç¼“å­˜æ‹“å±• Wrapper å®ç°ç±»åˆ°

cachedWrapperClasses
å±æ€§ã€‚

* ç¬¬ 61 è¡Œï¼šè°ƒç”¨

Class/#getConstructor(Class<?>... parameterTypes)
æ–¹æ³•ï¼Œé€šè¿‡**åå°„**çš„æ–¹å¼ï¼Œå‚æ•°ä¸ºæ‹“å±•æ¥å£ï¼Œåˆ¤æ–­å½“å‰é…ç½®çš„æ‹“å±•å®ç°ç±»ä¸º**æ‹“å±• Wrapper å®ç°ç±»**ã€‚è‹¥æˆåŠŸï¼ˆæœªæŠ›å‡ºå¼‚å¸¸ï¼‰ï¼Œåˆ™ä»£è¡¨ç¬¦åˆæ¡ä»¶ã€‚ä¾‹å¦‚ï¼Œ[ProtocolFilterWrapper(Protocol protocol)](https://github.com/alibaba/dubbo/blob/master/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/protocol/ProtocolFilterWrapper.java#L39-L44) è¿™ä¸ªæ„é€ æ–¹æ³•ã€‚
* ç¬¬ 69 è‡³ 105 è¡Œï¼šè‹¥è·å¾—æ„é€ æ–¹æ³•å¤±è´¥ï¼Œåˆ™ä»£è¡¨æ˜¯æ™®é€šçš„æ‹“å±•å®ç°ç±»ï¼Œç¼“å­˜åˆ°

extensionClasses
**å˜é‡**ä¸­ã€‚

* ç¬¬ 70 è¡Œï¼šè°ƒç”¨

Class/#getConstructor(Class<?>... parameterTypes)
æ–¹æ³•ï¼Œè·å¾—å‚æ•°ä¸ºç©ºçš„æ„é€ æ–¹æ³•ã€‚
* ç¬¬ 72 è‡³ 82 è¡Œï¼šæœªé…ç½®æ‹“å±•åï¼Œè‡ªåŠ¨ç”Ÿæˆã€‚**é€‚ç”¨äº Java SPI çš„é…ç½®æ–¹å¼**ã€‚ä¾‹å¦‚ï¼Œxxx.yyy.DemoFilter ç”Ÿæˆçš„æ‹“å±•åä¸º

demo
ã€‚

* ç¬¬ 73 è¡Œï¼šé€šè¿‡

@Extension
æ³¨è§£çš„æ–¹å¼è®¾ç½®æ‹“å±•åçš„æ–¹å¼å·²ç»**åºŸå¼ƒ**ï¼Œèƒ–å‹å¯ä»¥æ— è§†è¯¥æ–¹æ³•ã€‚
* ç¬¬ 84 è¡Œï¼šè·å¾—æ‹“å±•åã€‚ä½¿ç”¨é€—å·è¿›è¡Œåˆ†å‰²ï¼Œå³å¤šä¸ªæ‹“å±•åå¯ä»¥å¯¹åº”åŒä¸€ä¸ªæ‹“å±•å®ç°ç±»ã€‚
* ç¬¬ 86 è‡³ 90 è¡Œï¼šç¼“å­˜

@Activate
åˆ°

cachedActivates
ã€‚åœ¨ [ã€Œ7. @Activateã€](http://svip.iocoder.cn/Dubbo/spi/) è¯¦ç»†è§£æã€‚
* ç¬¬ 93 è‡³ 95 è¡Œï¼šç¼“å­˜åˆ°

cachedNames
å±æ€§ã€‚
* ç¬¬ 96 è‡³ 102 è¡Œï¼šç¼“å­˜æ‹“å±•å®ç°ç±»åˆ°

extensionClasses
å˜é‡ã€‚**æ³¨æ„**ï¼Œç›¸åŒæ‹“å±•åï¼Œä¸èƒ½å¯¹åº”å¤šä¸ªä¸åŒçš„æ‹“å±•å®ç°ã€‚
* ç¬¬ 108 è‡³ 112 è¡Œï¼šè‹¥å‘ç”Ÿå¼‚å¸¸ï¼Œè®°å½•åˆ°å¼‚å¸¸é›†åˆ

exceptions
å±æ€§ã€‚

### 4.2.4 å…¶ä»–æ–¹æ³•

å¦‚ä¸‹æ–¹æ³•ï¼Œå’Œè¯¥æµç¨‹æ— å…³ï¼Œèƒ–å‹å¯è‡ªè¡ŒæŸ¥çœ‹ã€‚

* [
/#getExtensionClass(name)
](https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L537-L546)
* [
/#findException(name)
](https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L459-L482)
* [
/#getExtensionName(extensionInstance)
](https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L129-L131)
* [
/#getExtensionName(extensionClass)
](https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L133-L135)
* [
/#getSupportedExtensions()
](https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L277-L286)
* [
/#getDefaultExtensionName()
](https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L344-L350)
* [
/#hasExtension(name)
](https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L337)

## 4.3 è·å¾—æ‹“å±•åŠ è½½å™¨

åœ¨ Dubbo çš„ä»£ç é‡Œï¼Œå¸¸å¸¸èƒ½çœ‹åˆ°å¦‚ä¸‹çš„ä»£ç ï¼š
```
ExtensionLoader.getExtensionLoader(Protocol.class).getExtension(name)
```

### 4.3.1 getExtensionLoader

/#getExtensionLoader(type)
**é™æ€**æ–¹æ³•ï¼Œæ ¹æ®æ‹“å±•ç‚¹çš„æ¥å£ï¼Œè·å¾—æ‹“å±•åŠ è½½å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* æ‹“å±•åŠ è½½å™¨é›†åˆ
/*
/* keyï¼šæ‹“å±•æ¥å£
/*/
// ã€é™æ€å±æ€§ã€‘
private static final ConcurrentMap<Class<?>, ExtensionLoader<?>> EXTENSION_LOADERS = new ConcurrentHashMap<Class<?>, ExtensionLoader<?>>();
1: //*/*
2: /* æ ¹æ®æ‹“å±•ç‚¹çš„æ¥å£ï¼Œè·å¾—æ‹“å±•åŠ è½½å™¨
3: /*
4: /* @param type æ¥å£
5: /* @param <T> æ³›å‹
6: /* @return åŠ è½½å™¨
7: /*/
8: @SuppressWarnings("unchecked")
9: public static <T> ExtensionLoader<T> getExtensionLoader(Class<T> type){
10: if (type == null)
11: throw new IllegalArgumentException("Extension type == null");
12: // å¿…é¡»æ˜¯æ¥å£
13: if (!type.isInterface()) {
14: throw new IllegalArgumentException("Extension type(" + type + ") is not interface!");
15: }
16: // å¿…é¡»åŒ…å« @SPI æ³¨è§£
17: if (!withExtensionAnnotation(type)) {
18: throw new IllegalArgumentException("Extension type(" + type +
19: ") is not extension, because WITHOUT @" + SPI.class.getSimpleName() + " Annotation!");
20: }
21:
22: // è·å¾—æ¥å£å¯¹åº”çš„æ‹“å±•ç‚¹åŠ è½½å™¨
23: ExtensionLoader<T> loader = (ExtensionLoader<T>) EXTENSION_LOADERS.get(type);
24: if (loader == null) {
25: EXTENSION_LOADERS.putIfAbsent(type, new ExtensionLoader<T>(type));
26: loader = (ExtensionLoader<T>) EXTENSION_LOADERS.get(type);
27: }
28: }
```

* ç¬¬ 12 è‡³ 15 è¡Œï¼šå¿…é¡»æ˜¯æ¥å£ã€‚
* ç¬¬ 16 è‡³ 20 è¡Œï¼šè°ƒç”¨ [
/#withExtensionAnnotation()
](https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L101-L103) æ–¹æ³•ï¼Œæ ¡éªŒå¿…é¡»ä½¿ç”¨

@SPI
æ³¨è§£æ ‡è®°ã€‚
* ç¬¬ 22 è‡³ 27 è¡Œï¼šä»

EXTENSION_LOADERS
**é™æ€**ä¸­è·å–æ‹“å±•æ¥å£å¯¹åº”çš„ ExtensionLoader å¯¹è±¡ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º ExtensionLoader å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°

EXTENSION_LOADERS
ã€‚

### 4.3.2 æ„é€ æ–¹æ³•

æ„é€ æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* æ‹“å±•æ¥å£ã€‚
/* ä¾‹å¦‚ï¼ŒProtocol
/*/
private final Class<?> type;
//*/*
/* å¯¹è±¡å·¥å‚
/*
/* ç”¨äºè°ƒç”¨ {@link /#injectExtension(Object)} æ–¹æ³•ï¼Œå‘æ‹“å±•å¯¹è±¡æ³¨å…¥ä¾èµ–å±æ€§ã€‚
/*
/* ä¾‹å¦‚ï¼ŒStubProxyFactoryWrapper ä¸­æœ‰ `Protocol protocol` å±æ€§ã€‚
/*/
private final ExtensionFactory objectFactory;
1: private ExtensionLoader(Class<?> type){
2: this.type = type;
3: objectFactory = (type == ExtensionFactory.class ? null : ExtensionLoader.getExtensionLoader(ExtensionFactory.class).getAdaptiveExtension());
4: }
```

* objectFactory
å±æ€§ï¼Œå¯¹è±¡å·¥å‚ï¼Œ**åŠŸèƒ½ä¸Šå’Œ Spring IOC ä¸€è‡´**ã€‚

* ç”¨äºè°ƒç”¨ [
/#injectExtension(instance)
](https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L510-L535) æ–¹æ³•æ—¶ï¼Œå‘åˆ›å»ºçš„æ‹“å±•æ³¨å…¥å…¶ä¾èµ–çš„å±æ€§ã€‚ä¾‹å¦‚ï¼Œ[
CacheFilter.cacheFactory
](https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-filter/dubbo-filter-cache/src/main/java/com/alibaba/dubbo/cache/filter/CacheFilter.java#L38) å±æ€§ã€‚
* ç¬¬ 3 è¡Œï¼šå½“æ‹“å±•æ¥å£é ExtensionFactory æ—¶( å¦‚æœä¸åŠ è¿™ä¸ªåˆ¤æ–­ï¼Œä¼šæ˜¯ä¸€ä¸ªæ­»å¾ªç¯ )ï¼Œè°ƒç”¨

ExtensionLoader/#getAdaptiveExtension()
æ–¹æ³•ï¼Œè·å¾— ExtensionFactory æ‹“å±•æ¥å£çš„**è‡ªé€‚åº”**æ‹“å±•å®ç°å¯¹è±¡ã€‚**ä¸ºä»€ä¹ˆå‘¢**ï¼Ÿåœ¨ [ã€Œ8. ExtensionFactoryã€](http://svip.iocoder.cn/Dubbo/spi/) è¯¦ç»†è§£æã€‚

## 4.4 è·å¾—æŒ‡å®šæ‹“å±•å¯¹è±¡

åœ¨ Dubbo çš„ä»£ç é‡Œï¼Œå¸¸å¸¸èƒ½çœ‹åˆ°å¦‚ä¸‹çš„ä»£ç ï¼š
```
ExtensionLoader.getExtensionLoader(Protocol.class).getExtension(name)
```

### 4.4.1 getExtension

/#getExtension()
æ–¹æ³•ï¼Œè¿”å›æŒ‡å®šåå­—çš„æ‰©å±•å¯¹è±¡ã€‚å¦‚æœæŒ‡å®šåå­—çš„æ‰©å±•ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å¼‚å¸¸ IllegalStateException ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* ç¼“å­˜çš„æ‹“å±•å¯¹è±¡é›†åˆ
/*
/* keyï¼šæ‹“å±•å
/* valueï¼šæ‹“å±•å¯¹è±¡
/*
/* ä¾‹å¦‚ï¼ŒProtocol æ‹“å±•
/* keyï¼šdubbo valueï¼šDubboProtocol
/* keyï¼šinjvm valueï¼šInjvmProtocol
/*
/* é€šè¿‡ {@link /#loadExtensionClasses} åŠ è½½
/*/
private final ConcurrentMap<String, Holder<Object>> cachedInstances = new ConcurrentHashMap<String, Holder<Object>>();
1: //*/*
2: /* Find the extension with the given name. If the specified name is not found, then {@link IllegalStateException}
3: /* will be thrown.
4: /*/
5: //*/*
6: /* è¿”å›æŒ‡å®šåå­—çš„æ‰©å±•å¯¹è±¡ã€‚å¦‚æœæŒ‡å®šåå­—çš„æ‰©å±•ä¸å­˜åœ¨ï¼Œåˆ™æŠ›å¼‚å¸¸ {@link IllegalStateException}.
7: /*
8: /* @param name æ‹“å±•å
9: /* @return æ‹“å±•å¯¹è±¡
10: /*/
11: @SuppressWarnings("unchecked")
12: public T getExtension(String name){
13: if (name == null || name.length() == 0)
14: throw new IllegalArgumentException("Extension name == null");
15: // æŸ¥æ‰¾ é»˜è®¤çš„ æ‹“å±•å¯¹è±¡
16: if ("true".equals(name)) {
17: return getDefaultExtension();
18: }
19: // ä» ç¼“å­˜ä¸­ è·å¾—å¯¹åº”çš„æ‹“å±•å¯¹è±¡
20: Holder<Object> holder = cachedInstances.get(name);
21: if (holder == null) {
22: cachedInstances.putIfAbsent(name, new Holder<Object>());
23: holder = cachedInstances.get(name);
24: }
25: Object instance = holder.get();
26: if (instance == null) {
27: synchronized (holder) {
28: instance = holder.get();
29: // ä» ç¼“å­˜ä¸­ æœªè·å–åˆ°ï¼Œè¿›è¡Œåˆ›å»ºç¼“å­˜å¯¹è±¡ã€‚
30: if (instance == null) {
31: instance = createExtension(name);
32: // è®¾ç½®åˆ›å»ºå¯¹è±¡åˆ°ç¼“å­˜ä¸­
33: holder.set(instance);
34: }
35: }
36: }
37: return (T) instance;
38: }
```

* ç¬¬ 15 è‡³ 18 è¡Œï¼šè°ƒç”¨

/#getDefaultExtension()
æ–¹æ³•ï¼ŒæŸ¥è¯¢**é»˜è®¤çš„**æ‹“å±•å¯¹è±¡ã€‚åœ¨è¯¥æ–¹æ³•çš„å®ç°ä»£ç ä¸­ï¼Œç®€åŒ–ä»£ç ä¸º

getExtension(cachedDefaultName);
ã€‚
* ç¬¬ 19 è‡³ 28 è¡Œï¼šä»ç¼“å­˜ä¸­ï¼Œè·å¾—æ‹“å±•å¯¹è±¡ã€‚
* ç¬¬ 29 è‡³ 31 è¡Œï¼šå½“ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œè°ƒç”¨

/#createExtension(name)
æ–¹æ³•ï¼Œåˆ›å»ºæ‹“å±•å¯¹è±¡ã€‚
* ç¬¬ 33 è¡Œï¼šæ·»åŠ åˆ›å»ºçš„æ‹“å±•å¯¹è±¡ï¼Œåˆ°ç¼“å­˜ä¸­ã€‚

### 4.4.2 createExtension

/#createExtension(name)
æ–¹æ³•ï¼Œåˆ›å»ºæ‹“å±•åçš„æ‹“å±•å¯¹è±¡ï¼Œå¹¶ç¼“å­˜ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* æ‹“å±•å®ç°ç±»é›†åˆ
/*
/* keyï¼šæ‹“å±•å®ç°ç±»
/* valueï¼šæ‹“å±•å¯¹è±¡ã€‚
/*
/* ä¾‹å¦‚ï¼Œkey ä¸º Class<AccessLogFilter>
/* value ä¸º AccessLogFilter å¯¹è±¡
/*/
private static final ConcurrentMap<Class<?>, Object> EXTENSION_INSTANCES = new ConcurrentHashMap<Class<?>, Object>();
1: //*/*
2: /* åˆ›å»ºæ‹“å±•åçš„æ‹“å±•å¯¹è±¡ï¼Œå¹¶ç¼“å­˜ã€‚
3: /*
4: /* @param name æ‹“å±•å
5: /* @return æ‹“å±•å¯¹è±¡
6: /*/
7: @SuppressWarnings("unchecked")
8: private T createExtension(String name){
9: // è·å¾—æ‹“å±•åå¯¹åº”çš„æ‹“å±•å®ç°ç±»
10: Class<?> clazz = getExtensionClasses().get(name);
11: if (clazz == null) {
12: throw findException(name); // æŠ›å‡ºå¼‚å¸¸
13: }
14: try {
15: // ä»ç¼“å­˜ä¸­ï¼Œè·å¾—æ‹“å±•å¯¹è±¡ã€‚
16: T instance = (T) EXTENSION_INSTANCES.get(clazz);
17: if (instance == null) {
18: // å½“ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œåˆ›å»ºæ‹“å±•å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°ç¼“å­˜ä¸­ã€‚
19: EXTENSION_INSTANCES.putIfAbsent(clazz, clazz.newInstance());
20: instance = (T) EXTENSION_INSTANCES.get(clazz);
21: }
22: // æ³¨å…¥ä¾èµ–çš„å±æ€§
23: injectExtension(instance);
24: // åˆ›å»º Wrapper æ‹“å±•å¯¹è±¡
25: Set<Class<?>> wrapperClasses = cachedWrapperClasses;
26: if (wrapperClasses != null && !wrapperClasses.isEmpty()) {
27: for (Class<?> wrapperClass : wrapperClasses) {
28: instance = injectExtension((T) wrapperClass.getConstructor(type).newInstance(instance));
29: }
30: }
31: return instance;
32: } catch (Throwable t) {
33: throw new IllegalStateException("Extension instance(name: " + name + ", class: " +
34: type + ") could not be instantiated: " + t.getMessage(), t);
35: }
36: }
```

* ç¬¬ 9 è‡³ 13 è¡Œï¼šè·å¾—æ‹“å±•åå¯¹åº”çš„æ‹“å±•å®ç°ç±»ã€‚è‹¥ä¸å­˜åœ¨ï¼Œè°ƒç”¨

/#findException(name)
æ–¹æ³•ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚
* ç¬¬ 16 è¡Œï¼šä»ç¼“å­˜

EXTENSION_INSTANCES
**é™æ€**å±æ€§ä¸­ï¼Œè·å¾—æ‹“å±•å¯¹è±¡ã€‚
* ç¬¬ 17 è‡³ 21 è¡Œï¼šå½“ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œåˆ›å»ºæ‹“å±•å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°

EXTENSION_INSTANCES
ä¸­ã€‚å› ä¸º

/#getExtension(name)
æ–¹æ³•ä¸­å·²ç»åŠ 

synchronized
ä¿®é¥°ï¼Œæ‰€ä»¥æ­¤å¤„ä¸ç”¨åŒæ­¥ã€‚
* ç¬¬ 23 è¡Œï¼šè°ƒç”¨

/#injectExtension(instance)
æ–¹æ³•ï¼Œå‘åˆ›å»ºçš„æ‹“å±•æ³¨å…¥å…¶ä¾èµ–çš„å±æ€§ã€‚
* ç¬¬ 24 è‡³ 30 è¡Œï¼šåˆ›å»º Wrapper æ‹“å±•å¯¹è±¡ï¼Œå°†

instance
**åŒ…è£…åœ¨å…¶ä¸­**ã€‚åœ¨ [ã€ŠDubbo å¼€å‘æŒ‡å— â€”â€” æ‰©å±•ç‚¹åŠ è½½ã€‹](http://dubbo.apache.org/zh-cn/docs/dev/SPI.html) æ–‡ç« ä¸­ï¼Œå¦‚æ­¤ä»‹ç» Wrapper ç±»ï¼š
Wrapper ç±»åŒæ ·å®ç°äº†æ‰©å±•ç‚¹æ¥å£ï¼Œä½†æ˜¯ Wrapper ä¸æ˜¯æ‰©å±•ç‚¹çš„çœŸæ­£å®ç°ã€‚å®ƒçš„ç”¨é€”ä¸»è¦æ˜¯ç”¨äºä» ExtensionLoader è¿”å›æ‰©å±•ç‚¹æ—¶ï¼ŒåŒ…è£…åœ¨çœŸæ­£çš„æ‰©å±•ç‚¹å®ç°å¤–ã€‚å³ä» ExtensionLoader ä¸­è¿”å›çš„å®é™…ä¸Šæ˜¯ Wrapper ç±»çš„å®ä¾‹ï¼ŒWrapper æŒæœ‰äº†å®é™…çš„æ‰©å±•ç‚¹å®ç°ç±»ã€‚

æ‰©å±•ç‚¹çš„ Wrapper ç±»å¯ä»¥æœ‰å¤šä¸ªï¼Œä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦æ–°å¢ã€‚

é€šè¿‡ Wrapper ç±»å¯ä»¥æŠŠæ‰€æœ‰æ‰©å±•ç‚¹å…¬å…±é€»è¾‘ç§»è‡³ Wrapper ä¸­ã€‚æ–°åŠ çš„ Wrapper åœ¨æ‰€æœ‰çš„æ‰©å±•ç‚¹ä¸Šæ·»åŠ äº†é€»è¾‘ï¼Œæœ‰äº›ç±»ä¼¼ AOPï¼Œå³ Wrapper ä»£ç†äº†æ‰©å±•ç‚¹ã€‚

* ä¾‹å¦‚ï¼š[ListenerExporterWrapper](https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/listener/ListenerExporterWrapper.java)ã€[ProtocolFilterWrapper](https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-rpc/dubbo-rpc-api/src/main/java/com/alibaba/dubbo/rpc/protocol/ProtocolFilterWrapper.java) ã€‚

### 4.4.3 injectExtension

/#injectExtension(instance)
æ–¹æ³•ï¼Œæ³¨å…¥ä¾èµ–çš„å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: //*/*
2: /* æ³¨å…¥ä¾èµ–çš„å±æ€§
3: /*
4: /* @param instance æ‹“å±•å¯¹è±¡
5: /* @return æ‹“å±•å¯¹è±¡
6: /*/
7: private T injectExtension(T instance){
8: try {
9: if (objectFactory != null) {
10: for (Method method : instance.getClass().getMethods()) {
11: if (method.getName().startsWith("set")
12: && method.getParameterTypes().length == 1
13: && Modifier.isPublic(method.getModifiers())) { // setting && public æ–¹æ³•
14: // è·å¾—å±æ€§çš„ç±»å‹
15: Class<?> pt = method.getParameterTypes()[0];
16: try {
17: // è·å¾—å±æ€§
18: String property = method.getName().length() > 3 ? method.getName().substring(3, 4).toLowerCase() + method.getName().substring(4) : "";
19: // è·å¾—å±æ€§å€¼
20: Object object = objectFactory.getExtension(pt, property);
21: // è®¾ç½®å±æ€§å€¼
22: if (object != null) {
23: method.invoke(instance, object);
24: }
25: } catch (Exception e) {
26: logger.error("fail to inject via method " + method.getName()
27: + " of interface " + type.getName() + ": " + e.getMessage(), e);
28: }
29: }
30: }
31: }
32: } catch (Exception e) {
33: logger.error(e.getMessage(), e);
34: }
35: return instance;
36: }
```

* ç¬¬ 9 è¡Œï¼šå¿…é¡»æœ‰

objectFactory
å±æ€§ï¼Œå³ ExtensionFactory çš„æ‹“å±•å¯¹è±¡ï¼Œä¸éœ€è¦æ³¨å…¥ä¾èµ–çš„å±æ€§ã€‚
* ç¬¬ 10 è‡³ 13 è¡Œï¼šåå°„è·å¾—æ‰€æœ‰çš„æ–¹æ³•ï¼Œä»…ä»…å¤„ç†

public setting
æ–¹æ³•ã€‚
* ç¬¬ 15 è¡Œï¼šè·å¾—å±æ€§çš„ç±»å‹ã€‚
* ç¬¬ 18 è¡Œï¼šè·å¾—å±æ€§åã€‚
* ç¬¬ 20 è¡Œï¼šè·å¾—**å±æ€§å€¼**ã€‚**æ³¨æ„**ï¼Œæ­¤å¤„è™½ç„¶è°ƒç”¨çš„æ˜¯

ExtensionFactory/#getExtension(type, name)
æ–¹æ³•ï¼Œå®é™…è·å–çš„ä¸ä»…ä»…æ˜¯æ‹“å±•å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ Spring Bean å¯¹è±¡ã€‚ç­”æ¡ˆåœ¨ [ã€Œ8. ExtensionFactoryã€](http://svip.iocoder.cn/Dubbo/spi/) æ­æ™“ã€‚
* ç¬¬ 21 è‡³ 24 è¡Œï¼šè®¾ç½®å±æ€§å€¼ã€‚

### 4.4.4 å…¶ä»–æ–¹æ³•

å¦‚ä¸‹æ–¹æ³•ï¼Œå’Œè¯¥æµç¨‹æ— å…³ï¼Œèƒ–å‹å¯è‡ªè¡ŒæŸ¥çœ‹ã€‚

* [
/#getLoadedExtension(name)
](https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L257-L275)
* [
/#getLoadedExtensions()
](https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L277-L286)

## 4.5 è·å¾—è‡ªé€‚åº”çš„æ‹“å±•å¯¹è±¡

åœ¨ Dubbo çš„ä»£ç é‡Œï¼Œå¸¸å¸¸èƒ½çœ‹åˆ°å¦‚ä¸‹çš„ä»£ç ï¼š
```
ExtensionLoader.getExtensionLoader(Protocol.class).getAdaptiveExtension()
```  
å‹æƒ…æç¤ºï¼Œèƒ–å‹å…ˆçœ‹ä¸‹ [ã€Œ6. Adaptiveã€](http://svip.iocoder.cn/Dubbo/spi/) çš„å†…å®¹ï¼Œåœ¨å›åˆ°æ­¤å¤„ã€‚

### 4.5.1 getAdaptiveExtension

/#getAdaptiveExtension()
æ–¹æ³•ï¼Œè·å¾—è‡ªé€‚åº”æ‹“å±•å¯¹è±¡ã€‚
```
//*/*
/* ç¼“å­˜çš„è‡ªé€‚åº”( Adaptive )æ‹“å±•å¯¹è±¡
/*/
private final Holder<Object> cachedAdaptiveInstance = new Holder<Object>();
//*/*
/* åˆ›å»º {@link /#cachedAdaptiveInstance} æ—¶å‘ç”Ÿçš„å¼‚å¸¸ã€‚
/*
/* å‘ç”Ÿå¼‚å¸¸åï¼Œä¸å†åˆ›å»ºï¼Œå‚è§ {@link /#createAdaptiveExtension()}
/*/
private volatile Throwable createAdaptiveInstanceError;
1: //*/*
2: /* è·å¾—è‡ªé€‚åº”æ‹“å±•å¯¹è±¡
3: /*
4: /* @return æ‹“å±•å¯¹è±¡
5: /*/
6: @SuppressWarnings("unchecked")
7: public T getAdaptiveExtension(){
8: // ä»ç¼“å­˜ä¸­ï¼Œè·å¾—è‡ªé€‚åº”æ‹“å±•å¯¹è±¡
9: Object instance = cachedAdaptiveInstance.get();
10: if (instance == null) {
11: // è‹¥ä¹‹å‰æœªåˆ›å»ºæŠ¥é”™ï¼Œ
12: if (createAdaptiveInstanceError == null) {
13: synchronized (cachedAdaptiveInstance) {
14: instance = cachedAdaptiveInstance.get();
15: if (instance == null) {
16: try {
17: // åˆ›å»ºè‡ªé€‚åº”æ‹“å±•å¯¹è±¡
18: instance = createAdaptiveExtension();
19: // è®¾ç½®åˆ°ç¼“å­˜
20: cachedAdaptiveInstance.set(instance);
21: } catch (Throwable t) {
22: // è®°å½•å¼‚å¸¸
23: createAdaptiveInstanceError = t;
24: throw new IllegalStateException("fail to create adaptive instance: " + t.toString(), t);
25: }
26: }
27: }
28: // è‹¥ä¹‹å‰åˆ›å»ºæŠ¥é”™ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ IllegalStateException
29: } else {
30: throw new IllegalStateException("fail to create adaptive instance: " + createAdaptiveInstanceError.toString(), createAdaptiveInstanceError);
31: }
32: }
33: return (T) instance;
34: }
```

* ç¬¬ 9 è¡Œï¼šä»ç¼“å­˜

cachedAdaptiveInstance
å±æ€§ä¸­ï¼Œè·å¾—è‡ªé€‚åº”æ‹“å±•å¯¹è±¡ã€‚
* ç¬¬ 28 è‡³ 30 è¡Œï¼šè‹¥ä¹‹å‰åˆ›å»ºæŠ¥é”™ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ IllegalStateException ã€‚
* ç¬¬ 14 è‡³ 20 è¡Œï¼šå½“ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œè°ƒç”¨

/#createAdaptiveExtension()
æ–¹æ³•ï¼Œåˆ›å»ºè‡ªé€‚åº”æ‹“å±•å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ°

cachedAdaptiveInstance
ä¸­ã€‚
* ç¬¬ 22 è‡³ 24 è¡Œï¼šè‹¥åˆ›å»ºå‘ç”Ÿå¼‚å¸¸ï¼Œè®°å½•å¼‚å¸¸åˆ°

createAdaptiveInstanceError
ï¼Œå¹¶æŠ›å‡ºå¼‚å¸¸ IllegalStateException ã€‚

### 4.5.2 createAdaptiveExtension

/#createAdaptiveExtension()
æ–¹æ³•ï¼Œåˆ›å»ºè‡ªé€‚åº”æ‹“å±•å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* åˆ›å»ºè‡ªé€‚åº”æ‹“å±•å¯¹è±¡
/*
/* @return æ‹“å±•å¯¹è±¡
/*/
@SuppressWarnings("unchecked")
private T createAdaptiveExtension(){
try {
return injectExtension((T) getAdaptiveExtensionClass().newInstance());
} catch (Exception e) {
throw new IllegalStateException("Can not create adaptive extension " + type + ", cause: " + e.getMessage(), e);
}
}
```

* è°ƒç”¨

/#getAdaptiveExtensionClass()
æ–¹æ³•ï¼Œè·å¾—è‡ªé€‚åº”æ‹“å±•ç±»ã€‚
* è°ƒç”¨

Class/#newInstance()
æ–¹æ³•ï¼Œåˆ›å»ºè‡ªé€‚åº”æ‹“å±•å¯¹è±¡ã€‚
* è°ƒç”¨

/#injectExtension(instance)
æ–¹æ³•ï¼Œå‘åˆ›å»ºçš„è‡ªé€‚åº”æ‹“å±•å¯¹è±¡ï¼Œæ³¨å…¥ä¾èµ–çš„å±æ€§ã€‚

### 4.5.3 getAdaptiveExtensionClass

/#getAdaptiveExtensionClass()
æ–¹æ³•ï¼Œè·å¾—è‡ªé€‚åº”æ‹“å±•ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: //*/*
2: /* @return è‡ªé€‚åº”æ‹“å±•ç±»
3: /*/
4: private Class<?> getAdaptiveExtensionClass() {
5: getExtensionClasses();
6: if (cachedAdaptiveClass != null) {
7: return cachedAdaptiveClass;
8: }
9: return cachedAdaptiveClass = createAdaptiveExtensionClass();
10: }
```

* ã€

@Adaptive
çš„ç¬¬ä¸€ç§ã€‘ç¬¬ 6 è‡³ 8 è¡Œï¼šè‹¥

cachedAdaptiveClass
å·²å­˜åœ¨ï¼Œç›´æ¥è¿”å›ã€‚çš„ç¬¬ä¸€ç§æƒ…å†µã€‚
* ã€

@Adaptive
çš„ç¬¬äºŒç§ã€‘ç¬¬ 9 è¡Œï¼šè°ƒç”¨

/#createAdaptiveExtensionClass()
æ–¹æ³•ï¼Œ**è‡ªåŠ¨ç”Ÿæˆ**è‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°ï¼Œå¹¶**ç¼–è¯‘**åè¿”å›è¯¥ç±»ã€‚

### 4.5.4 createAdaptiveExtensionClassCode

/#createAdaptiveExtensionClassCode()
æ–¹æ³•ï¼Œè‡ªåŠ¨ç”Ÿæˆè‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°ï¼Œå¹¶ç¼–è¯‘åè¿”å›è¯¥ç±»ã€‚
```
1: //*/*
2: /* è‡ªåŠ¨ç”Ÿæˆè‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°ï¼Œå¹¶ç¼–è¯‘åè¿”å›è¯¥ç±»ã€‚
3: /*
4: /* @return ç±»
5: /*/
6: private Class<?> createAdaptiveExtensionClass() {
7: // è‡ªåŠ¨ç”Ÿæˆè‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°çš„å­—ç¬¦ä¸²
8: String code = createAdaptiveExtensionClassCode();
9: // ç¼–è¯‘ä»£ç ï¼Œå¹¶è¿”å›è¯¥ç±»
10: ClassLoader classLoader = findClassLoader();
11: com.alibaba.dubbo.common.compiler.Compiler compiler = ExtensionLoader.getExtensionLoader(com.alibaba.dubbo.common.compiler.Compiler.class).getAdaptiveExtension();
12: return compiler.compile(code, classLoader);
13: }
```

* ç¬¬ 8 è¡Œï¼šè°ƒç”¨ [
/#createAdaptiveExtensionClassCode
](https://github.com/YunaiV/dubbo/blob/4a877ee283af70c3f6a19c3b8b8e6918696540e6/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L1012-L1253) æ–¹æ³•ï¼Œè‡ªåŠ¨ç”Ÿæˆè‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°çš„å­—ç¬¦ä¸²ã€‚

* ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œå·²ç»æ·»åŠ è¯¦ç»†æ³¨é‡Šï¼Œèƒ–å‹ç‚¹å‡»æŸ¥çœ‹ã€‚
* å¦‚ä¸‹æ˜¯ ProxyFactory çš„è‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°çš„å­—ç¬¦ä¸²ç”Ÿæˆ**ä¾‹å­** ![è‡ªé€‚åº”æ‹“å±•çš„ä»£ç å®ç°çš„å­—ç¬¦ä¸²ç”Ÿæˆä¾‹å­](http://static2.iocoder.cn/images/Dubbo/2018_03_04/05.png)
* ç¬¬ 9 è‡³ 12 è¡Œï¼šä½¿ç”¨ Dubbo SPI åŠ è½½ Compier æ‹“å±•æ¥å£å¯¹åº”çš„æ‹“å±•å®ç°å¯¹è±¡ï¼Œåè°ƒç”¨

Compiler/#compile(code, classLoader)
æ–¹æ³•ï¼Œè¿›è¡Œç¼–è¯‘ã€‚ğŸ™‚ å› ä¸ºä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ï¼Œåç»­å¦å¼€æ–‡ç« åˆ†äº«ã€‚

## 4.6 è·å¾—æ¿€æ´»çš„æ‹“å±•å¯¹è±¡æ•°ç»„

åœ¨ Dubbo çš„ä»£ç é‡Œï¼Œçœ‹åˆ°ä½¿ç”¨ä»£ç å¦‚ä¸‹ï¼š
```
List<Filter> filters = ExtensionLoader.getExtensionLoader(Filter.class).getActivateExtension(invoker.getUrl(), key, group);
```

### 4.6.1 getExtensionLoader

/#getExtensionLoader(url, key, group)
æ–¹æ³•ï¼Œè·å¾—ç¬¦åˆè‡ªåŠ¨æ¿€æ´»æ¡ä»¶çš„æ‹“å±•å¯¹è±¡æ•°ç»„ã€‚
```
1: //*/*
2: /* This is equivalent to {@code getActivateExtension(url, url.getParameter(key).split(","), null)}
3: /*
4: /* è·å¾—ç¬¦åˆè‡ªåŠ¨æ¿€æ´»æ¡ä»¶çš„æ‹“å±•å¯¹è±¡æ•°ç»„
5: /*
6: /* @param url url
7: /* @param key url parameter key which used to get extension point names
8: /* Dubbo URL å‚æ•°å
9: /* @param group group
10: /* è¿‡æ»¤åˆ†ç»„å
11: /* @return extension list which are activated.
12: /* @see /#getActivateExtension(com.alibaba.dubbo.common.URL, String[], String)
13: /*/
14: public List<T> getActivateExtension(URL url, String key, String group){
15: // ä» Dubbo URL è·å¾—å‚æ•°å€¼
16: String value = url.getParameter(key);
17: // è·å¾—ç¬¦åˆè‡ªåŠ¨æ¿€æ´»æ¡ä»¶çš„æ‹“å±•å¯¹è±¡æ•°ç»„
18: return getActivateExtension(url, value == null || value.length() == 0 ? null : Constants.COMMA_SPLIT_PATTERN.split(value), group);
19: }
20:
21: //*/*
22: /* Get activate extensions.
23: /*
24: /* è·å¾—ç¬¦åˆè‡ªåŠ¨æ¿€æ´»æ¡ä»¶çš„æ‹“å±•å¯¹è±¡æ•°ç»„
25: /*
26: /* @param url url
27: /* @param values extension point names
28: /* @param group group
29: /* @return extension list which are activated
30: /* @see com.alibaba.dubbo.common.extension.Activate
31: /*/
32: public List<T> getActivateExtension(URL url, String[] values, String group){
33: List<T> exts = new ArrayList<T>();
34: List<String> names = values == null ? new ArrayList<String>(0) : Arrays.asList(values);
35: // å¤„ç†è‡ªåŠ¨æ¿€æ´»çš„æ‹“å±•å¯¹è±¡ä»¬
36: // åˆ¤æ–­ä¸å­˜åœ¨é…ç½® `"-name"` ã€‚ä¾‹å¦‚ï¼Œ<dubbo:service filter="-default" /> ï¼Œä»£è¡¨ç§»é™¤æ‰€æœ‰é»˜è®¤è¿‡æ»¤å™¨ã€‚
37: if (!names.contains(Constants.REMOVE_VALUE_PREFIX + Constants.DEFAULT_KEY)) {
38: // è·å¾—æ‹“å±•å®ç°ç±»æ•°ç»„
39: getExtensionClasses();
40: // å¾ªç¯
41: for (Map.Entry<String, Activate> entry : cachedActivates.entrySet()) {
42: String name = entry.getKey();
43: Activate activate = entry.getValue();
44: if (isMatchGroup(group, activate.group())) { // åŒ¹é…åˆ†ç»„
45: // è·å¾—æ‹“å±•å¯¹è±¡
46: T ext = getExtension(name);
47: if (!names.contains(name) // ä¸åŒ…å«åœ¨è‡ªå®šä¹‰é…ç½®é‡Œã€‚å¦‚æœåŒ…å«ï¼Œä¼šåœ¨ä¸‹é¢çš„ä»£ç å¤„ç†ã€‚
48: && !names.contains(Constants.REMOVE_VALUE_PREFIX + name) // åˆ¤æ–­æ˜¯å¦é…ç½®ç§»é™¤ã€‚ä¾‹å¦‚ <dubbo:service filter="-monitor" />ï¼Œåˆ™ MonitorFilter ä¼šè¢«ç§»é™¤
49: && isActive(activate, url)) { // åˆ¤æ–­æ˜¯å¦æ¿€æ´»
50: exts.add(ext);
51: }
52: }
53: }
54: // æ’åº
55: Collections.sort(exts, ActivateComparator.COMPARATOR);
56: }
57: // å¤„ç†è‡ªå®šä¹‰é…ç½®çš„æ‹“å±•å¯¹è±¡ä»¬ã€‚ä¾‹å¦‚åœ¨ <dubbo:service filter="demo" /> ï¼Œä»£è¡¨éœ€è¦åŠ å…¥ DemoFilter ï¼ˆè¿™ä¸ªæ˜¯ç¬”è€…è‡ªå®šä¹‰çš„ï¼‰ã€‚
58: List<T> usrs = new ArrayList<T>();
59: for (int i = 0; i < names.size(); i++) {
60: String name = names.get(i);
61: if (!name.startsWith(Constants.REMOVE_VALUE_PREFIX) && !names.contains(Constants.REMOVE_VALUE_PREFIX + name)) { // åˆ¤æ–­éç§»é™¤çš„
62: // å°†é…ç½®çš„è‡ªå®šä¹‰åœ¨è‡ªåŠ¨æ¿€æ´»çš„æ‹“å±•å¯¹è±¡ä»¬å‰é¢ã€‚ä¾‹å¦‚ï¼Œ<dubbo:service filter="demo,default,demo2" /> ï¼Œåˆ™ DemoFilter å°±ä¼šæ”¾åœ¨é»˜è®¤çš„è¿‡æ»¤å™¨å‰é¢ã€‚
63: if (Constants.DEFAULT_KEY.equals(name)) {
64: if (!usrs.isEmpty()) {
65: exts.addAll(0, usrs);
66: usrs.clear();
67: }
68: } else {
69: // è·å¾—æ‹“å±•å¯¹è±¡
70: T ext = getExtension(name);
71: usrs.add(ext);
72: }
73: }
74: }
75: // æ·»åŠ åˆ°ç»“æœé›†
76: if (!usrs.isEmpty()) {
77: exts.addAll(usrs);
78: }
79: return exts;
80: }
```

* ç¬¬ 16 è¡Œï¼šä» Dubbo URL è·å¾—å‚æ•°å€¼ã€‚ä¾‹å¦‚è¯´ï¼Œè‹¥ XML é…ç½® Service

<dubbo:service filter="demo, demo2" />
ï¼Œå¹¶ä¸”åœ¨è·å¾— Filter è‡ªåŠ¨æ¿€æ´»æ‹“å±•æ—¶ï¼Œæ­¤å¤„å°±èƒ½è§£æåˆ°

value=demo,demo2
ã€‚å¦å¤–ï¼Œ

value
å¯ä»¥æ ¹æ®**é€—å·**æ‹†åˆ†ã€‚
* ç¬¬ 18 è¡Œï¼šè°ƒç”¨

/#getActivateExtension(url, values, group)
æ–¹æ³•ï¼Œè·å¾—ç¬¦åˆè‡ªåŠ¨æ¿€æ´»æ¡ä»¶çš„æ‹“å±•å¯¹è±¡æ•°ç»„ã€‚
* ç¬¬ 35 è‡³ 56 è¡Œï¼šå¤„ç†è‡ªåŠ¨æ¿€æ´»çš„æ‹“å±•å¯¹è±¡ä»¬ã€‚

* [
/#isMatchGroup(group, groups)
](https://github.com/YunaiV/dubbo/blob/4a877ee283af70c3f6a19c3b8b8e6918696540e6/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L357-L378) æ–¹æ³•ï¼ŒåŒ¹é…åˆ†ç»„ã€‚
* [
/#isActive(Activate, url)
](https://github.com/YunaiV/dubbo/blob/4a877ee283af70c3f6a19c3b8b8e6918696540e6/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/ExtensionLoader.java#L380-L403) æ–¹æ³•ï¼Œæ˜¯å¦æ¿€æ´»ï¼Œé€šè¿‡ Dubbo URL ä¸­æ˜¯å¦å­˜åœ¨å‚æ•°åä¸º [`@Activate.value](mailto:%60@Activate.value)` ï¼Œå¹¶ä¸”å‚æ•°å€¼éç©ºã€‚
* ç¬¬ 57 è‡³ 74 è¡Œï¼šå¤„ç†è‡ªå®šä¹‰é…ç½®çš„æ‹“å±•å¯¹è±¡ä»¬ã€‚
* ç¬¬ 75 è‡³ 78 è¡Œï¼šå°†

usrs
åˆå¹¶åˆ°

exts
**å°¾éƒ¨**ã€‚
* ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹ç›´æ¥çœ‹æ³¨é‡Šã€‚

### 4.6.2 ActivateComparator

[
com.alibaba.dubbo.common.extension.support.ActivateComparator
](https://github.com/YunaiV/dubbo/blob/4a877ee283af70c3f6a19c3b8b8e6918696540e6/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/support/ActivateComparator.java) ï¼Œè‡ªåŠ¨æ¿€æ´»æ‹“å±•å¯¹è±¡æ’åºå™¨ã€‚

* ğŸ™‚ ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹ç›´æ¥çœ‹æ³¨é‡Šã€‚

# 5. @SPI

[
com.alibaba.dubbo.common.extension.@SPI
](https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/SPI.java) ï¼Œæ‰©å±•ç‚¹æ¥å£çš„æ ‡è¯†ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE})
public @interface SPI {
//*/*
/* default extension name
/*/
String value() default "";
}
```

* value
ï¼Œé»˜è®¤æ‹“å±•å®ç°ç±»çš„åå­—ã€‚ä¾‹å¦‚ï¼ŒProtocol æ‹“å±•æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
@SPI("dubbo")
public interface Protocol{
// ... çœç•¥ä»£ç 
}
```

* å…¶ä¸­

"dubbo"
æŒ‡çš„æ˜¯ DubboProtocol ï¼ŒProtocol é»˜è®¤çš„æ‹“å±•å®ç°ç±»ã€‚

# 6. @Adaptive

[
com.alibaba.dubbo.common.extension.@Adaptive
](https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/Adaptive.java) ï¼Œè‡ªé€‚åº”æ‹“å±•ä¿¡æ¯çš„æ ‡è®°ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE, ElementType.METHOD})
public @interface Adaptive {
//*/*
/* Decide which target extension to be injected. The name of the target extension is decided by the parameter passed
/* in the URL, and the parameter names are given by this method.
/* <p>
/* If the specified parameters are not found from {@link URL}, then the default extension will be used for
/* dependency injection (specified in its interface's {@link SPI}).
/* <p>
/* For examples, given <code>String[] {"key1", "key2"}</code>:
/* <ol>
/* <li>find parameter 'key1' in URL, use its value as the extension's name</li>
/* <li>try 'key2' for extension's name if 'key1' is not found (or its value is empty) in URL</li>
/* <li>use default extension if 'key2' doesn't appear either</li>
/* <li>otherwise, throw {@link IllegalStateException}</li>
/* </ol>
/* If default extension's name is not give on interface's {@link SPI}, then a name is generated from interface's
/* class name with the rule: divide classname from capital char into several parts, and separate the parts with
/* dot '.', for example: for {@code com.alibaba.dubbo.xxx.YyyInvokerWrapper}, its default name is
/* <code>String[] {"yyy.invoker.wrapper"}</code>. This name will be used to search for parameter from URL.
/*
/* @return parameter key names in URL
/*/
//*/*
/* ä» {@link URL }çš„ Key åï¼Œå¯¹åº”çš„ Value ä½œä¸ºè¦ Adapt æˆçš„ Extension åã€‚
/* <p>
/* å¦‚æœ {@link URL} è¿™äº› Key éƒ½æ²¡æœ‰ Value ï¼Œä½¿ç”¨ ç¼ºçœçš„æ‰©å±•ï¼ˆåœ¨æ¥å£çš„{@link SPI}ä¸­è®¾å®šçš„å€¼ï¼‰ã€‚<br>
/* æ¯”å¦‚ï¼Œ<code>String[] {"key1", "key2"}</code>ï¼Œè¡¨ç¤º
/* <ol>
/* <li>å…ˆåœ¨URLä¸Šæ‰¾key1çš„Valueä½œä¸ºè¦Adaptæˆçš„Extensionåï¼›
/* <li>key1æ²¡æœ‰Valueï¼Œåˆ™ä½¿ç”¨key2çš„Valueä½œä¸ºè¦Adaptæˆçš„Extensionåã€‚
/* <li>key2æ²¡æœ‰Valueï¼Œä½¿ç”¨ç¼ºçœçš„æ‰©å±•ã€‚
/* <li>å¦‚æœæ²¡æœ‰è®¾å®šç¼ºçœæ‰©å±•ï¼Œåˆ™æ–¹æ³•è°ƒç”¨ä¼šæŠ›å‡º{@link IllegalStateException}ã€‚
/* </ol>
/* <p>
/* å¦‚æœä¸è®¾ç½®åˆ™ç¼ºçœä½¿ç”¨Extensionæ¥å£ç±»åçš„ç‚¹åˆ†éš”å°å†™å­—ä¸²ã€‚<br>
/* å³å¯¹äºExtensionæ¥å£ {@code com.alibaba.dubbo.xxx.YyyInvokerWrapper} çš„ç¼ºçœå€¼ä¸º <code>String[] {"yyy.invoker.wrapper"}</code>
/*
/* @see SPI/#value()
/*/
String[] value() default {};
}
```

@Adaptive
æ³¨è§£ï¼Œå¯æ·»åŠ **ç±»**æˆ–**æ–¹æ³•**ä¸Šï¼Œåˆ†åˆ«ä»£è¡¨äº†ä¸¤ç§ä¸åŒçš„ä½¿ç”¨æ–¹å¼ã€‚

å‹æƒ…æç¤ºï¼šä¸€ä¸ªæ‹“å±•æ¥å£ï¼Œæœ‰ä¸”ä»…æœ‰ä¸€ä¸ª Adaptive æ‹“å±•å®ç°ç±»ã€‚

* ç¬¬ä¸€ç§ï¼Œæ ‡è®°åœ¨**ç±»**ä¸Šï¼Œä»£è¡¨**æ‰‹åŠ¨å®ç°**å®ƒæ˜¯ä¸€ä¸ªæ‹“å±•æ¥å£çš„ Adaptive æ‹“å±•å®ç°ç±»ã€‚ç›®å‰ Dubbo é¡¹ç›®é‡Œï¼Œåªæœ‰ ExtensionFactory æ‹“å±•çš„å®ç°ç±» AdaptiveExtensionFactory æœ‰è¿™ä¹ˆç”¨ã€‚è¯¦ç»†è§£æè§ [ã€Œ8.1 AdaptiveExtensionFactoryã€](http://svip.iocoder.cn/Dubbo/spi/)ã€‚
* ç¬¬äºŒç§ï¼Œæ ‡è®°åœ¨æ‹“å±•æ¥å£çš„**æ–¹æ³•**ä¸Šï¼Œä»£è¡¨**è‡ªåŠ¨ç”Ÿæˆä»£ç å®ç°**è¯¥æ¥å£çš„ Adaptive æ‹“å±•å®ç°ç±»ã€‚

* value
ï¼Œä» Dubbo URL è·å–å‚æ•°ä¸­ï¼Œä½¿ç”¨é”®å( Key )ï¼Œè·å–é”®å€¼ã€‚è¯¥å€¼ä¸º**çœŸæ­£çš„**æ‹“å±•åã€‚

* è‡ªé€‚åº”æ‹“å±•å®ç°ç±»ï¼Œä¼šè·å–æ‹“å±•åå¯¹åº”çš„**çœŸæ­£**çš„æ‹“å±•å¯¹è±¡ã€‚é€šè¿‡è¯¥å¯¹è±¡ï¼Œæ‰§è¡ŒçœŸæ­£çš„é€»è¾‘ã€‚
* å¯ä»¥è®¾ç½®**å¤šä¸ª**é”®å( Key )ï¼Œé¡ºåºè·å–ç›´åˆ°**æœ‰å€¼**ã€‚è‹¥æœ€ç»ˆè·å–ä¸åˆ°ï¼Œä½¿ç”¨**é»˜è®¤æ‹“å±•å**ã€‚
* åœ¨ [ã€Œ4.5.4 createAdaptiveExtensionClassCodeã€](http://svip.iocoder.cn/Dubbo/spi/) è¯¦ç»†è§£æã€‚

# 7. @Activate

[
com.alibaba.dubbo.common.extension.@Activate
](https://github.com/YunaiV/dubbo/blob/6b8e51ac55880a0f10a34f297d0869fcdbb42369/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/Activate.java) ï¼Œè‡ªåŠ¨æ¿€æ´»æ¡ä»¶çš„æ ‡è®°ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE, ElementType.METHOD})
public @interface Activate {
//*/*
/* Activate the current extension when one of the groups matches. The group passed into
/* {@link ExtensionLoader/#getActivateExtension(URL, String, String)} will be used for matching.
/*
/* @return group names to match
/* @see ExtensionLoader/#getActivateExtension(URL, String, String)
/*/
//*/*
/* Groupè¿‡æ»¤æ¡ä»¶ã€‚
/* <br />
/* åŒ…å«{@link ExtensionLoader/#getActivateExtension}çš„groupå‚æ•°ç»™çš„å€¼ï¼Œåˆ™è¿”å›æ‰©å±•ã€‚
/* <br />
/* å¦‚æ²¡æœ‰Groupè®¾ç½®ï¼Œåˆ™ä¸è¿‡æ»¤ã€‚
/*/
String[] group() default {};
//*/*
/* Activate the current extension when the specified keys appear in the URL's parameters.
/* <p>
/* For example, given <code>@Activate("cache, validation")</code>, the current extension will be return only when
/* there's either <code>cache</code> or <code>validation</code> key appeared in the URL's parameters.
/* </p>
/*
/* @return URL parameter keys
/* @see ExtensionLoader/#getActivateExtension(URL, String)
/* @see ExtensionLoader/#getActivateExtension(URL, String, String)
/*/
//*/*
/* Keyè¿‡æ»¤æ¡ä»¶ã€‚åŒ…å«{@link ExtensionLoader/#getActivateExtension}çš„URLçš„å‚æ•°Keyä¸­æœ‰ï¼Œåˆ™è¿”å›æ‰©å±•ã€‚
/* <p/>
/* ç¤ºä¾‹ï¼š<br/>
/* æ³¨è§£çš„å€¼ <code>@Activate("cache,validatioin")</code>ï¼Œ
/* åˆ™{@link ExtensionLoader/#getActivateExtension}çš„URLçš„å‚æ•°æœ‰<code>cache</code>Keyï¼Œæˆ–æ˜¯<code>validatioin</code>åˆ™è¿”å›æ‰©å±•ã€‚
/* <br/>
/* å¦‚æ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä¸è¿‡æ»¤ã€‚
/*/
String[] value() default {};
//*/*
/* Relative ordering info, optional
/*
/* @return extension list which should be put before the current one
/*/
//*/*
/* æ’åºä¿¡æ¯ï¼Œå¯ä»¥ä¸æä¾›ã€‚
/*/
String[] before() default {};
//*/*
/* Relative ordering info, optional
/*
/* @return extension list which should be put after the current one
/*/
//*/*
/* æ’åºä¿¡æ¯ï¼Œå¯ä»¥ä¸æä¾›ã€‚
/*/
String[] after() default {};
//*/*
/* Absolute ordering info, optional
/*
/* @return absolute ordering info
/*/
//*/*
/* æ’åºä¿¡æ¯ï¼Œå¯ä»¥ä¸æä¾›ã€‚
/*/
int order() default 0;
}
```

* å¯¹äºå¯ä»¥è¢«æ¡†æ¶ä¸­è‡ªåŠ¨æ¿€æ´»åŠ è½½æ‰©å±•ï¼Œ

@Activate
ç”¨äºé…ç½®æ‰©å±•è¢«è‡ªåŠ¨æ¿€æ´»åŠ è½½æ¡ä»¶ã€‚æ¯”å¦‚ï¼ŒFilter æ‰©å±•ï¼Œæœ‰å¤šä¸ªå®ç°ï¼Œä½¿ç”¨

@Activate
çš„æ‰©å±•å¯ä»¥æ ¹æ®**æ¡ä»¶**è¢«è‡ªåŠ¨åŠ è½½ã€‚

* è¿™å—çš„ä¾‹å­ï¼Œå¯ä»¥çœ‹ä¸‹ [ã€ŠDubbo å¼€å‘æŒ‡å— â€”â€” æ‰©å±•ç‚¹åŠ è½½ã€‹ã€Œæ‰©å±•ç‚¹è‡ªåŠ¨æ¿€æ´»ã€](http://svip.iocoder.cn/Dubbo/spi/) æ–‡æ¡£æä¾›çš„ã€‚
* ğŸ™‚ åˆ†æˆè¿‡æ»¤æ¡ä»¶å’Œæ’åºä¿¡æ¯**ä¸¤ç±»å±æ€§**ï¼Œèƒ–å‹çœ‹ä¸‹ä»£ç é‡Œçš„æ³¨é‡Šã€‚
* åœ¨ [ã€Œ4.6 è·å¾—æ¿€æ´»çš„æ‹“å±•å¯¹è±¡æ•°ç»„ã€](http://svip.iocoder.cn/Dubbo/spi/) è¯¦ç»†è§£æã€‚

# 8. ExtensionFactory

[
com.alibaba.dubbo.common.extension.ExtensionFactory
](http://svip.iocoder.cn/Dubbo/spi/) ï¼Œæ‹“å±•å·¥å‚æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* ExtensionFactory
/*
/* æ‹“å±•å·¥å‚æ¥å£
/*/
@SPI
public interface ExtensionFactory{
//*/*
/* Get extension.
/*
/* è·å¾—æ‹“å±•å¯¹è±¡
/*
/* @param type object type. æ‹“å±•æ¥å£
/* @param name object name. æ‹“å±•å
/* @return object instance. æ‹“å±•å¯¹è±¡
/*/
<T> T getExtension(Class<T> type, String name);
}
```

* ExtensionFactory è‡ªèº«ä¹Ÿæ˜¯æ‹“å±•æ¥å£ï¼ŒåŸºäº Dubbo SPI åŠ è½½å…·ä½“æ‹“å±•å®ç°ç±»ã€‚
* /#getExtension(type, name)
æ–¹æ³•ï¼Œåœ¨ [ã€Œ4.4.3 injectExtensionã€](http://svip.iocoder.cn/Dubbo/spi/) ä¸­ï¼Œè·å¾—æ‹“å±•å¯¹è±¡ï¼Œå‘åˆ›å»ºçš„æ‹“å±•å¯¹è±¡**æ³¨å…¥ä¾èµ–å±æ€§**ã€‚åœ¨å®é™…ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸ä»…ä»…è·å¾—çš„æ˜¯æ‹“å±•å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ Spring ä¸­çš„ Bean å¯¹è±¡ã€‚
* ExtensionFactory å­ç±»ç±»å›¾å¦‚ä¸‹ï¼š![ExtensionFactory ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_03_04/06.png)

## 8.1 AdaptiveExtensionFactory

[
com.alibaba.dubbo.common.extension.factory.AdaptiveExtensionFactory
](https://github.com/YunaiV/dubbo/blob/4a877ee283af70c3f6a19c3b8b8e6918696540e6/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/factory/AdaptiveExtensionFactory.java) ï¼Œè‡ªé€‚åº” ExtensionFactory æ‹“å±•å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: @Adaptive
2: public class AdaptiveExtensionFactory implements ExtensionFactory{
3:
4: //*/*
5: /* ExtensionFactory æ‹“å±•å¯¹è±¡é›†åˆ
6: /*/
7: private final List<ExtensionFactory> factories;
8:
9: public AdaptiveExtensionFactory(){
10: // ä½¿ç”¨ ExtensionLoader åŠ è½½æ‹“å±•å¯¹è±¡å®ç°ç±»ã€‚
11: ExtensionLoader<ExtensionFactory> loader = ExtensionLoader.getExtensionLoader(ExtensionFactory.class);
12: List<ExtensionFactory> list = new ArrayList<ExtensionFactory>();
13: for (String name : loader.getSupportedExtensions()) {
14: list.add(loader.getExtension(name));
15: }
16: factories = Collections.unmodifiableList(list);
17: }
18:
19: public <T> T getExtension(Class<T> type, String name){
20: // éå†å·¥å‚æ•°ç»„ï¼Œç›´åˆ°è·å¾—åˆ°å±æ€§
21: for (ExtensionFactory factory : factories) {
22: T extension = factory.getExtension(type, name);
23: if (extension != null) {
24: return extension;
25: }
26: }
27: return null;
28: }
29:
30: }
```

* @Adaptive
æ³¨è§£ï¼Œä¸º ExtensionFactory çš„**è‡ªé€‚åº”**æ‹“å±•å®ç°ç±»ã€‚
* **æ„é€ **æ–¹æ³•ï¼Œä½¿ç”¨ ExtensionLoader åŠ è½½ ExtensionFactory æ‹“å±•å¯¹è±¡çš„å®ç°ç±»ã€‚è‹¥èƒ–å‹æ²¡è‡ªå·±å®ç° ExtensionFactory çš„æƒ…å†µä¸‹ï¼Œ

factories
ä¸º SpiExtensionFactory å’Œ SpringExtensionFactory ã€‚
* /#getExtension(type, name)
æ–¹æ³•ï¼Œéå†

factories
ï¼Œè°ƒç”¨å…¶

/#getExtension(type, name)
æ–¹æ³•ï¼Œç›´åˆ°è·å¾—åˆ°å±æ€§å€¼ã€‚

## 8.2 SpiExtensionFactory

[
com.alibaba.dubbo.common.extension.factory.SpiExtensionFactory
](https://github.com/YunaiV/dubbo/blob/4a877ee283af70c3f6a19c3b8b8e6918696540e6/dubbo-common/src/main/java/com/alibaba/dubbo/common/extension/factory/SpiExtensionFactory.java) ï¼ŒSPI ExtensionFactory æ‹“å±•å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public class SpiExtensionFactory implements ExtensionFactory{
//*/*
/* è·å¾—æ‹“å±•å¯¹è±¡
/*
/* @param type object type. æ‹“å±•æ¥å£
/* @param name object name. æ‹“å±•å
/* @param <T> æ³›å‹
/* @return æ‹“å±•å¯¹è±¡
/*/
public <T> T getExtension(Class<T> type, String name){
if (type.isInterface() && type.isAnnotationPresent(SPI.class)) { // æ ¡éªŒæ˜¯ @SPI
// åŠ è½½æ‹“å±•æ¥å£å¯¹åº”çš„ ExtensionLoader å¯¹è±¡
ExtensionLoader<T> loader = ExtensionLoader.getExtensionLoader(type);
// åŠ è½½æ‹“å±•å¯¹è±¡
if (!loader.getSupportedExtensions().isEmpty()) {
return loader.getAdaptiveExtension();
}
}
return null;
}
}
```

## 8.3 SpringExtensionFactory

[
com.alibaba.dubbo.config.spring.extension.SpringExtensionFactory
](http://svip.iocoder.cn/Dubbo/spi/SpringExtensionFactory) ï¼ŒSpring ExtensionFactory æ‹“å±•å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public class SpringExtensionFactory implements ExtensionFactory{
//*/*
/* Spring Context é›†åˆ
/*/
private static final Set<ApplicationContext> contexts = new ConcurrentHashSet<ApplicationContext>();
public static void addApplicationContext(ApplicationContext context){
contexts.add(context);
}
public static void removeApplicationContext(ApplicationContext context){
contexts.remove(context);
}
@Override
@SuppressWarnings("unchecked")
public <T> T getExtension(Class<T> type, String name){
for (ApplicationContext context : contexts) {
if (context.containsBean(name)) {
// è·å¾—å±æ€§
Object bean = context.getBean(name);
// åˆ¤æ–­ç±»å‹
if (type.isInstance(bean)) {
return (T) bean;
}
}
}
return null;
}
}
```

* /#getExtension(type, name)
æ–¹æ³•ï¼Œéå†

contexts
ï¼Œè°ƒç”¨å…¶

ApplicationContext/#getBean(name)
æ–¹æ³•ï¼Œè·å¾— Bean å¯¹è±¡ï¼Œç›´åˆ°æˆåŠŸå¹¶ä¸”å€¼ç±»å‹æ­£ç¡®ã€‚

### 8.3.1 ä¾‹å­

DemoFilter æ˜¯ç¬”è€…å®ç°çš„ Filter æ‹“å±•å®ç°ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
public class DemoFilter implements Filter{
private DemoDAO demoDAO;
@Override
public Result invoke(Invoker<?> invoker, Invocation invocation) throws RpcException{
return invoker.invoke(invocation);
}
public DemoFilter setDemoDAO(DemoDAO demoDAO){
this.demoDAO = demoDAO;
return this;
}
}
```

* DemoDAO ï¼Œç¬”è€…åœ¨ Spring ä¸­å£°æ˜å¯¹åº”çš„ Bean å¯¹è±¡ã€‚
```
<bean id="demoDAO" class="com.alibaba.dubbo.demo.provider.DemoDAO" />
```
* åœ¨ [ã€Œ4.4.3 injectExtensionã€](http://svip.iocoder.cn/Dubbo/spi/) ä¸­ï¼Œä¼šè°ƒç”¨

/#setDemoDAO(demo)
æ–¹æ³•ï¼Œå°† DemoFilter ä¾èµ–çš„å±æ€§

demoDAO
æ³¨å…¥ã€‚