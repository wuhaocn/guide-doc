## zookeeper选举机制描述

### 一、zookeeper集群
配置多个实例共同构成一个集群对外提供服务以达到水平扩展的目的，每个服务器上的数据是相同的，每一个服务器均可以对外提供读和写的服务，
这点和redis是相同的，即对客户端来讲每个服务器都是平等的。

这篇主要分析leader的选择机制，zookeeper提供了三种方式：
* FastLeaderElection （最新默认）
* LeaderElection  
* AuthFastLeaderElection
默认的算法是FastLeaderElection，所以这篇主要分析它的选举机制。

### 二、选举流程简述
#### 1.模拟启动
目前有5台服务器，每台服务器均没有数据，它们的编号分别是1,2,3,4,5,按编号依次启动，它们的选择举过程如下：
* 服务器1启动，给自己投票，然后发投票信息，由于其它机器还没有启动所以它收不到反馈信息，服务器1的状态一直属于Looking(选举状态)。
* 服务器2启动，给自己投票，同时与之前启动的服务器1交换结果，由于服务器2的编号大所以服务器2胜出，但此时投票数没有大于半数，所以两个服务器的状态依然是LOOKING。
* 服务器3启动，给自己投票，同时与之前启动的服务器1,2交换信息，由于服务器3的编号最大所以服务器3胜出，此时投票数正好大于半数，所以服务器3成为领导者，服务器1,2成为小弟。
* 服务器4启动，给自己投票，同时与之前启动的服务器1,2,3交换信息，尽管服务器4的编号大，但之前服务器3已经胜出，所以服务器4只能成为小弟。
* 服务器5启动，后面的逻辑同服务器4成为小弟。

#### 2. 初始化选举
* 每个Server发出一个投票： 
由于是初始情况，Server1和Server2都会将自己作为Leader服务器来进行投票，每次投票会包含所推举的服务器的myid和ZXID，使用(myid, ZXID)来表示，
此时Server1的投票为(1, 0)，Server2的投票为(2, 0)，然后各自将这个投票发给集群中其他机器。
* 接收来自各个服务器的投票： 集群的每个服务器收到投票后，首先判断该投票的有效性，如检查是否是本轮投票、是否来自LOOKING状态的服务器。
* 处理投票 针对每一个投票，服务器都需要将别人的投票和自己的投票进行PK，PK规则如下：
* 优先检查ZXID。
    ZXID比较大的服务器优先作为Leader。
* 如果ZXID相同，那么就比较myid。myid较大的服务器作为Leader服务器。
    对于Server1而言，它的投票是(1, 0)，接收Server2的投票为(2, 0)，首先会比较两者的ZXID，均为0，再比较myid，此时Server2的myid最大，
    于是更新自己的投票为(2, 0)，然后重新投票，对于Server2而言，其无须更新自己的投票，只是再次向集群中所有机器发出上一次投票信息即可。
* 统计投票：
    每次投票后，服务器都会统计投票信息，判断是否已经有过半机器接受到相同的投票信息，对于Server1、Server2而言，
    都统计出集群中已经有两台机器接受了(2, 0)的投票信息，此时便认为已经选出了Leader。
* 改变服务器状态： 
    一旦确定了Leader，每个服务器就会更新自己的状态，如果是Follower，那么就变更为FOLLOWING，如果是Leader，就变更为LEADING。

#### 3. 崩溃恢复
* 变更状态。
    Leader挂后，余下的非Observer服务器都会讲自己的服务器状态变更为LOOKING，然后开始进入Leader选举过程。
* 每个Server会发出一个投票。
    在运行期间，每个服务器上的ZXID可能不同，此时假定Server1的ZXID为123，Server3的ZXID为122；在第一轮投票中，Server1和Server3都会投自己，
    产生投票(1, 123)，(3, 122)，然后各自将投票发送给集群中所有机器。
* 接收来自各个服务器的投票。
    与启动时过程相同。
* 处理投票。
    与启动时过程相同，此时，Server1将会成为Leader。
* 统计投票。
    与启动时过程相同。
* 改变服务器的状态。
    与启动时过程相同。

### 三、选择机制中的概念
* 1、Serverid：服务器ID
比如有三台服务器，编号分别是1,2,3。编号越大在选择算法中的权重越大。

* 2、Zxid：数据ID
服务器中存放的最大数据ID.值越大说明数据越新，在选举算法中数据越新权重越大。

* 3、Epoch：逻辑时钟
或者叫投票的次数，同一轮投票过程中的逻辑时钟值是相同的。每投完一次票这个数据就会增加，然后与接收到的其它服务器返回的投票信息中的数值相比，根据不同的值做出不同的判断。

* 4、Server状态：选举状态
    * LOOKING，竞选状态。
    * FOLLOWING，随从状态，同步leader状态，参与投票。
    * OBSERVING，观察状态,同步leader状态，不参与投票。
    * LEADING，领导者状态。

### 四、选举消息内容
在投票完成后，需要将投票信息发送给集群中的所有服务器，它包含如下内容。

* 服务器ID
* 数据ID
* 逻辑时钟
* 选举状态

### 五、选举流程图
 因为每个服务器都是独立的，在启动时均从初始状态开始参与选举，下面是简易流程图。
![](https://images2015.cnblogs.com/blog/17071/201702/17071-20170220211539679-433574967.jpg)

### 六、选举状态图
描述Leader选择过程中的状态变化，这是假设全部实例中均没有数据，假设服务器启动顺序分别为：A,B,C。
![](https://images2015.cnblogs.com/blog/17071/201702/17071-20170220211554960-1891469553.jpg)
### 七、判断是否已经胜出
默认是采用投票数大于半数则胜出的逻辑。

### 八、选举流程详述
* 自增选举轮次。
    Zookeeper规定所有有效的投票都必须在同一轮次中，在开始新一轮投票时，会首先对logicalclock进行自增操作。
* 初始化选票。
    在开始进行新一轮投票之前，每个服务器都会初始化自身的选票，并且在初始化阶段，每台服务器都会将自己推举为Leader。
* 发送初始化选票。
    完成选票的初始化后，服务器就会发起第一次投票。Zookeeper会将刚刚初始化好的选票放入sendqueue中，由发送器WorkerSender负责发送出去。
* 接收外部投票。
    每台服务器会不断地从recvqueue队列中获取外部选票。如果服务器发现无法获取到任何外部投票，
    那么就会立即确认自己是否和集群中其他服务器保持着有效的连接，如果没有连接，则马上建立连接，如果已经建立了连接，则再次发送自己当前的内部投票。
* 判断选举轮次。在发送完初始化选票之后，接着开始处理外部投票。在处理外部投票时，会根据选举轮次来进行不同的处理。
    * 外部投票的选举轮次大于内部投票。若服务器自身的选举轮次落后于该外部投票对应服务器的选举轮次，那么就会立即更新自己的选举轮次(logicalclock)，
      并且清空所有已经收到的投票，然后使用初始化的投票来进行PK以确定是否变更内部投票。最终再将内部投票发送出去。
    * 外部投票的选举轮次小于内部投票。若服务器接收的外选票的选举轮次落后于自身的选举轮次，那么Zookeeper就会直接忽略该外部投票，
      不做任何处理，并返回步骤4。
    * 外部投票的选举轮次等于内部投票。此时可以开始进行选票PK。
* 选票PK。在进行选票PK时，符合任意一个条件就需要变更投票。
    * 若外部投票中推举的Leader服务器的选举轮次大于内部投票，那么需要变更投票。
    * 若选举轮次一致，那么就对比两者的ZXID，若外部投票的ZXID大，那么需要变更投票。
    * 若两者的ZXID一致，那么就对比两者的SID，若外部投票的SID大，那么就需要变更投票。
* 变更投票。
   经过PK后，若确定了外部投票优于内部投票，那么就变更投票，即使用外部投票的选票信息来覆盖内部投票，变更完成后，再次将这个变更后的内部投票发送出去。

* 选票归档。
    无论是否变更了投票，都会将刚刚收到的那份外部投票放入选票集合recvset中进行归档。
    recvset用于记录当前服务器在本轮次的Leader选举中收到的所有外部投票（按照服务队的SID区别，如{(1, vote1), (2, vote2)...}）。

* 统计投票。完成选票归档后，
    就可以开始统计投票，统计投票是为了统计集群中是否已经有过半的服务器认可了当前的内部投票，
    如果确定已经有过半服务器认可了该投票，则终止投票。否则重新选举。

* 更新服务器状态。
    若已经确定可以终止投票，那么就开始更新服务器状态，服务器首选判断当前被过半服务器认可的投票所对应的Leader服务器是否是自己，
    若是自己，则将自己的服务器状态更新为LEADING，若不是，则根据具体情况来确定自己是FOLLOWING或是OBSERVING。

经过以上10个步骤就是FastLeaderElection的核心，选举过程可能会经过几轮循环，直到有Leader选举产生。


### 九、源码分析
[Zookeeper之Leader选举之FastLeaderElection](Zookeeper之Leader选举之FastLeaderElection.md)

### 十、参考
https://www.cnblogs.com/shuaiandjun/p/9383655.html
https://www.jianshu.com/p/2268bebd4e3a
http://rdc.hundsun.com/portal/article/957.mhtml