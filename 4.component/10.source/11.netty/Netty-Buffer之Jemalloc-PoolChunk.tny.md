<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆäºŒï¼‰PoolChunk
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><blockquote>
<p>è€è‰¿è‰¿ï¼šå¦‚ä¸‹é˜é‡Šçš„å†…å®¹ï¼Œå‚è€ƒ Hypercube <a href="https://www.jianshu.com/p/15304cd63175" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆåï¼‰â€“JEMallocåˆ†é…ç®—æ³•ã€‹</a> ã€‚</p>
</blockquote>
<p>ä¸ºäº†æé«˜å†…å­˜<strong>åˆ†é…æ•ˆç‡</strong>å¹¶å‡å°‘<strong>å†…å­˜ç¢ç‰‡</strong>ï¼ŒJemalloc ç®—æ³•å°†æ¯ä¸ª Arena åˆ‡åˆ†æˆå¤šä¸ª<strong>å°å—</strong> Chunk ã€‚ä½†æ˜¯å®é™…ä¸Šï¼Œæ¯ä¸ª Chunk ä¾ç„¶æ˜¯<strong>ç›¸å½“å¤§</strong>çš„å†…å­˜å—ã€‚å› ä¸ºåœ¨ Jemalloc å»ºè®®ä¸º 4MB ï¼ŒNetty é»˜è®¤ä½¿ç”¨ä¸º 16MB ã€‚</p>
<p>ä¸ºäº†è¿›ä¸€æ­¥æä¾›æé«˜å†…å­˜<strong>åˆ†é…æ•ˆç‡</strong>å¹¶å‡å°‘<strong>å†…å­˜ç¢ç‰‡</strong>ï¼ŒJemalloc ç®—æ³•å°†æ¯ä¸ª Chunk åˆ‡åˆ†æˆå¤šä¸ª<strong>å°å—</strong> Page ã€‚ä¸€ä¸ªå…¸å‹çš„åˆ‡åˆ†æ˜¯å°† Chunk åˆ‡åˆ†ä¸º 2048 å— Page ï¼ŒNetty ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå› æ­¤ Page çš„å¤§å°ä¸ºï¼š<code>16MB / 2048 = 8KB</code> ã€‚</p>
<p>ä¸€ä¸ªå¥½çš„å†…å­˜åˆ†é…ç®—æ³•ï¼Œåº”ä½¿å¾—å·²åˆ†é…å†…å­˜å—å°½å¯èƒ½ä¿æŒè¿ç»­ï¼Œè¿™å°†å¤§å¤§å‡å°‘å†…éƒ¨ç¢ç‰‡ï¼Œç”±æ­¤ Jemalloc ä½¿ç”¨<a href="#">ä¼™ä¼´åˆ†é…ç®—æ³•</a>å°½å¯èƒ½æé«˜è¿ç»­æ€§ã€‚<strong>ä¼™ä¼´åˆ†é…ç®—æ³•</strong>çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å¯èƒ½å¾ˆå¤šèƒ–å‹ä¸äº†è§£ã€ä¼™ä¼´åˆ†é…ç®—æ³•ã€‘ï¼Œæ„Ÿå…´è¶£çš„è¯ï¼Œå¯ä»¥çœ‹çœ‹ <a href="https://coolshell.cn/articles/10427.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šä¼™ä¼´åˆ†é…å™¨çš„ä¸€ä¸ªæç®€å®ç°ã€‹</a> äº†è§£äº†è§£ã€‚</p>
<p>å½“ç„¶ï¼ŒNetty PoolChunk ä¹Ÿæ˜¯åŸºäºã€ä¼™ä¼´åˆ†é…ç®—æ³•ã€‘å®ç°ã€‚</p>
</blockquote>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_09_04/01.png" title="æ»¡äºŒå‰æ ‘" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_09_04/01.png" alt="æ»¡äºŒå‰æ ‘"></a><span class="caption">æ»¡äºŒå‰æ ‘</span></p>
<p>å›¾ä¸­<strong>æœ€åº•å±‚</strong>è¡¨ç¤ºä¸€ä¸ªè¢«åˆ‡åˆ†ä¸º 2048 ä¸ª Page çš„ Chunk å—ã€‚è‡ªåº•å‘ä¸Šï¼Œæ¯ä¸€å±‚èŠ‚ç‚¹ä½œä¸ºä¸Šä¸€å±‚çš„å­èŠ‚ç‚¹æ„é€ å‡ºä¸€æ£µ<a href="https://baike.baidu.com/item/%E6%BB%A1%E4%BA%8C%E5%8F%89%E6%A0%91" rel="external nofollow noopener noreferrer" target="_blank">æ»¡äºŒå‰æ ‘</a>ï¼Œç„¶åæŒ‰å±‚åˆ†é…æ»¡è¶³è¦æ±‚çš„å†…å­˜å—ã€‚ä»¥å¾…åˆ†é…åºåˆ— 8KBã€16KBã€8KB ä¸ºä¾‹åˆ†æåˆ†é…è¿‡ç¨‹( å‡è®¾æ¯ä¸ª Page å¤§å° 8KB )ï¼š</p>
<ol>
<li>8KB â€”â€” éœ€è¦ä¸€ä¸ª Page ï¼Œç¬¬ 11 å±‚æ»¡è¶³è¦æ±‚ï¼Œæ•…åˆ†é… <em>2048</em> èŠ‚ç‚¹å³ <strong>Page0</strong> ã€‚</li>
<li>16KB â€”â€” éœ€è¦ä¸¤ä¸ªPage ï¼Œæ•…éœ€è¦åœ¨ç¬¬ 10 å±‚è¿›è¡Œåˆ†é…ï¼Œè€Œ <em>1024</em> çš„å­èŠ‚ç‚¹ <em>2048</em> å·²åˆ†é…ï¼Œä»å·¦åˆ°å³æ‰¾åˆ°æ»¡è¶³è¦æ±‚çš„ <em>1025</em> èŠ‚ç‚¹ï¼Œæ•…åˆ†é…èŠ‚ç‚¹ <em>1025</em> å³<strong>Page2</strong> å’Œ <strong>Page3</strong> ã€‚</li>
<li>8KB â€”â€” éœ€è¦ä¸€ä¸ª Page ï¼Œç¬¬ 11 å±‚æ»¡è¶³è¦æ±‚ï¼Œä½†æ˜¯ <em>2048</em> å·²åˆ†é…ï¼Œä»å·¦åˆ°å³æ‰¾åˆ° <em>2049</em> èŠ‚ç‚¹å³ <strong>Page1</strong> è¿›è¡Œåˆ†é…ã€‚</li>
</ol>
<p>æ€»ç»“æ¥è¯´ï¼š</p>
<ul>
<li>åˆ†é…ç»“æŸåï¼Œå·²åˆ†é…è¿ç»­çš„ <strong>Page0 - Page3</strong> ã€‚è¿™æ ·çš„è¿ç»­å†…å­˜å—ï¼Œå¤§å¤§å‡å°‘å†…éƒ¨ç¢ç‰‡å¹¶æé«˜<strong>å†…å­˜ä½¿ç”¨ç‡</strong>ã€‚</li>
<li>é€šè¿‡ä½¿ç”¨<strong>æ»¡äºŒå‰æ ‘</strong>è¿™æ ·çš„æ ‘ç»“æ„ï¼Œæå‡æ£€ç´¢åˆ°å¯ç”¨ Page çš„é€Ÿåº¦ï¼Œä»è€Œæé«˜å†…å­˜<strong>åˆ†é…æ•ˆç‡</strong>ã€‚</li>
</ul>
<h1 id="2-PoolChunk"><a href="#2-PoolChunk" class="headerlink" title="2. PoolChunk"></a>2. PoolChunk</h1><p><code>io.netty.buffer.PoolChunk</code> ï¼Œå®ç° PoolChunkMetric æ¥å£ï¼ŒNetty å¯¹ Jemalloc Chunk çš„å®ç°ç±»ã€‚</p>
<h2 id="2-1-æ„é€ æ–¹æ³•"><a href="#2-1-æ„é€ æ–¹æ³•" class="headerlink" title="2.1 æ„é€ æ–¹æ³•"></a>2.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰€å± Arena å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> PoolArena&lt;T&gt; arena;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å†…å­˜ç©ºé—´ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> PooledByteBuf#memory</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> T memory;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦éæ± åŒ–</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #PoolChunk(PoolArena, Object, int, int) éæ± åŒ–ã€‚å½“ç”³è¯·çš„å†…å­˜å¤§å°ä¸º Huge ç±»å‹æ—¶ï¼Œåˆ›å»ºä¸€æ•´å— Chunk ï¼Œå¹¶ä¸”ä¸æ‹†åˆ†æˆè‹¥å¹² Page</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #PoolChunk(PoolArena, Object, int, int, int, int, int) æ± åŒ–</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">boolean</span> unpooled;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TODO èŠ‹è‰¿</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ†é…ä¿¡æ¯æ»¡äºŒå‰æ ‘</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * index ä¸ºèŠ‚ç‚¹ç¼–å·</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] memoryMap;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é«˜åº¦ä¿¡æ¯æ»¡äºŒå‰æ ‘</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * index ä¸ºèŠ‚ç‚¹ç¼–å·</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] depthMap;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * PoolSubpage æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> PoolSubpage&lt;T&gt;[] subpages;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ¤æ–­åˆ†é…è¯·æ±‚å†…å­˜æ˜¯å¦ä¸º Tiny/Small ï¼Œå³åˆ†é… Subpage å†…å­˜å—ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Used to determine if the requested capacity is equal to or greater than pageSize.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> subpageOverflowMask;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Page å¤§å°ï¼Œé»˜è®¤ 8KB = 8192B</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> pageSize;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä» 1 å¼€å§‹å·¦ç§»åˆ° {<span class="doctag">@link</span> #pageSize} çš„ä½æ•°ã€‚é»˜è®¤ 13 ï¼Œ1 &lt;&lt; 13 = 8192 ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å…·ä½“ç”¨é€”ï¼Œè§ {<span class="doctag">@link</span> #allocateRun(int)} æ–¹æ³•ï¼Œè®¡ç®—æŒ‡å®šå®¹é‡æ‰€åœ¨æ»¡äºŒå‰æ ‘çš„å±‚çº§ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> pageShifts;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ»¡äºŒå‰æ ‘çš„é«˜åº¦ã€‚é»˜è®¤ä¸º 11 ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxOrder;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Chunk å†…å­˜å—å ç”¨å¤§å°ã€‚é»˜è®¤ä¸º 16M = 16 * 1024  ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> chunkSize;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * log2 {<span class="doctag">@link</span> #chunkSize} çš„ç»“æœã€‚é»˜è®¤ä¸º log2( 16M ) = 24 ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> log2ChunkSize;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯åˆ†é… {<span class="doctag">@link</span> #subpages} çš„æ•°é‡ï¼Œå³æ•°ç»„å¤§å°ã€‚é»˜è®¤ä¸º 1 &lt;&lt; maxOrder = 1 &lt;&lt; 11 = 2048 ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxSubpageAllocs;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ ‡è®°èŠ‚ç‚¹ä¸å¯ç”¨ã€‚é»˜è®¤ä¸º maxOrder + 1 = 12 ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Used to mark memory as unusable</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span> unusable;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‰©ä½™å¯ç”¨å­—èŠ‚æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> freeBytes;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰€å± PoolChunkList å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PoolChunkList&lt;T&gt; parent;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸Šä¸€ä¸ª Chunk å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PoolChunk&lt;T&gt; prev;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸‹ä¸€ä¸ª Chunk å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PoolChunk&lt;T&gt; next;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„é€ æ–¹æ³•ä¸€ï¼š</span></span><br><span class="line">  <span class="number">1</span>: PoolChunk(PoolArena&lt;T&gt; arena, T memory, <span class="keyword">int</span> pageSize, <span class="keyword">int</span> maxOrder, <span class="keyword">int</span> pageShifts, <span class="keyword">int</span> chunkSize, <span class="keyword">int</span> offset) {</span><br><span class="line">  <span class="number">2</span>:     <span class="comment">// æ± åŒ–</span></span><br><span class="line">  <span class="number">3</span>:     unpooled = <span class="keyword">false</span>;</span><br><span class="line">  <span class="number">4</span>:     <span class="keyword">this</span>.arena = arena;</span><br><span class="line">  <span class="number">5</span>:     <span class="keyword">this</span>.memory = memory;</span><br><span class="line">  <span class="number">6</span>:     <span class="keyword">this</span>.pageSize = pageSize;</span><br><span class="line">  <span class="number">7</span>:     <span class="keyword">this</span>.pageShifts = pageShifts;</span><br><span class="line">  <span class="number">8</span>:     <span class="keyword">this</span>.maxOrder = maxOrder;</span><br><span class="line">  <span class="number">9</span>:     <span class="keyword">this</span>.chunkSize = chunkSize;</span><br><span class="line"> <span class="number">10</span>:     <span class="keyword">this</span>.offset = offset;</span><br><span class="line"> <span class="number">11</span>:     unusable = (<span class="keyword">byte</span>) (maxOrder + <span class="number">1</span>);</span><br><span class="line"> <span class="number">12</span>:     log2ChunkSize = log2(chunkSize);</span><br><span class="line"> <span class="number">13</span>:     subpageOverflowMask = ~(pageSize - <span class="number">1</span>);</span><br><span class="line"> <span class="number">14</span>:     freeBytes = chunkSize;</span><br><span class="line"> <span class="number">15</span>: </span><br><span class="line"> <span class="number">16</span>:     <span class="keyword">assert</span> maxOrder &lt; <span class="number">30</span> : <span class="string">"maxOrder should be &lt; 30, but is: "</span> + maxOrder;</span><br><span class="line"> <span class="number">17</span>:     maxSubpageAllocs = <span class="number">1</span> &lt;&lt; maxOrder;</span><br><span class="line"> <span class="number">18</span>: </span><br><span class="line"> <span class="number">19</span>:     <span class="comment">// åˆå§‹åŒ– memoryMap å’Œ depthMap</span></span><br><span class="line"> <span class="number">20</span>:     <span class="comment">// Generate the memory map.</span></span><br><span class="line"> <span class="number">21</span>:     memoryMap = <span class="keyword">new</span> <span class="keyword">byte</span>[maxSubpageAllocs &lt;&lt; <span class="number">1</span>];</span><br><span class="line"> <span class="number">22</span>:     depthMap = <span class="keyword">new</span> <span class="keyword">byte</span>[memoryMap.length];</span><br><span class="line"> <span class="number">23</span>:     <span class="keyword">int</span> memoryMapIndex = <span class="number">1</span>;</span><br><span class="line"> <span class="number">24</span>:     <span class="keyword">for</span> (<span class="keyword">int</span> d = <span class="number">0</span>; d &lt;= maxOrder; ++ d) { <span class="comment">// move down the tree one level at a time</span></span><br><span class="line"> <span class="number">25</span>:         <span class="keyword">int</span> depth = <span class="number">1</span> &lt;&lt; d;</span><br><span class="line"> <span class="number">26</span>:         <span class="keyword">for</span> (<span class="keyword">int</span> p = <span class="number">0</span>; p &lt; depth; ++ p) {</span><br><span class="line"> <span class="number">27</span>:             <span class="comment">// in each level traverse left to right and set value to the depth of subtree</span></span><br><span class="line"> <span class="number">28</span>:             memoryMap[memoryMapIndex] = (<span class="keyword">byte</span>) d;</span><br><span class="line"> <span class="number">29</span>:             depthMap[memoryMapIndex] = (<span class="keyword">byte</span>) d;</span><br><span class="line"> <span class="number">30</span>:             memoryMapIndex ++;</span><br><span class="line"> <span class="number">31</span>:         }</span><br><span class="line"> <span class="number">32</span>:     }</span><br><span class="line"> <span class="number">33</span>: </span><br><span class="line"> <span class="number">34</span>:     <span class="comment">// åˆå§‹åŒ– subpages</span></span><br><span class="line"> <span class="number">35</span>:     subpages = newSubpageArray(maxSubpageAllocs);</span><br><span class="line"> <span class="number">36</span>: }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„é€ æ–¹æ³•äºŒï¼š </span></span><br><span class="line"> <span class="number">38</span>: <span class="comment">/** Creates a special chunk that is not pooled. */</span></span><br><span class="line"> <span class="number">39</span>: PoolChunk(PoolArena&lt;T&gt; arena, T memory, <span class="keyword">int</span> size, <span class="keyword">int</span> offset) {</span><br><span class="line"> <span class="number">40</span>:     <span class="comment">// éæ± åŒ–</span></span><br><span class="line"> <span class="number">41</span>:     unpooled = <span class="keyword">true</span>;</span><br><span class="line"> <span class="number">42</span>:     <span class="keyword">this</span>.arena = arena;</span><br><span class="line"> <span class="number">43</span>:     <span class="keyword">this</span>.memory = memory;</span><br><span class="line"> <span class="number">44</span>:     <span class="keyword">this</span>.offset = offset;</span><br><span class="line"> <span class="number">45</span>:     memoryMap = <span class="keyword">null</span>;</span><br><span class="line"> <span class="number">46</span>:     depthMap = <span class="keyword">null</span>;</span><br><span class="line"> <span class="number">47</span>:     subpages = <span class="keyword">null</span>;</span><br><span class="line"> <span class="number">48</span>:     subpageOverflowMask = <span class="number">0</span>;</span><br><span class="line"> <span class="number">49</span>:     pageSize = <span class="number">0</span>;</span><br><span class="line"> <span class="number">50</span>:     pageShifts = <span class="number">0</span>;</span><br><span class="line"> <span class="number">51</span>:     maxOrder = <span class="number">0</span>;</span><br><span class="line"> <span class="number">52</span>:     unusable = (<span class="keyword">byte</span>) (maxOrder + <span class="number">1</span>);</span><br><span class="line"> <span class="number">53</span>:     chunkSize = size;</span><br><span class="line"> <span class="number">54</span>:     log2ChunkSize = log2(chunkSize);</span><br><span class="line"> <span class="number">55</span>:     maxSubpageAllocs = <span class="number">0</span>;</span><br><span class="line"> <span class="number">56</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>arena</code> å±æ€§ï¼Œæ‰€å± Arena å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-5-Jemalloc-Arena">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆäº”ï¼‰PoolArenaã€‹</a> ã€‚ <ul>
<li><code>memory</code> å±æ€§ï¼Œå†…å­˜ç©ºé—´ã€‚å³<strong>ç”¨äº</strong> <code>PooledByteBuf.memory</code> å±æ€§ï¼Œæœ‰ Direct ByteBuffer å’Œ <code>byte[]</code> å­—èŠ‚æ•°ç»„ã€‚</li>
<li><code>unpooled</code> å±æ€§ï¼Œæ˜¯å¦éæ± åŒ–ã€‚<ul>
<li><code>unpooled = false</code> ï¼Œæ± åŒ–ï¼Œå¯¹åº”æ„é€ æ–¹æ³•<strong>ä¸€</strong>ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹äº åˆ†é… 16M <strong>ä»¥å†…</strong>çš„å†…å­˜ç©ºé—´æ—¶ï¼ŒNetty ä¼šåˆ†é…ä¸€ä¸ª Normal ç±»å‹çš„ Chunk å—ã€‚å¹¶ä¸”ï¼Œè¯¥ Chunk å—åœ¨ä½¿ç”¨å®Œåï¼Œè¿›è¡Œæ± åŒ–ç¼“å­˜ï¼Œé‡å¤ä½¿ç”¨ã€‚</li>
<li><code>unpooled = true</code> ï¼Œéæ± åŒ–ï¼Œå¯¹åº”æ„é€ æ–¹æ³•<strong>äºŒ</strong>ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå¯¹äºåˆ†é… 16M <strong>ä»¥ä¸Š</strong>çš„å†…å­˜ç©ºé—´æ—¶ï¼ŒNetty ä¼šåˆ†é…ä¸€ä¸ª Huge ç±»å‹çš„<strong>ç‰¹æ®Š</strong>çš„ Chunk å—ã€‚å¹¶ä¸”ï¼Œç”±äº Huge ç±»å‹çš„ Chunk å ç”¨å†…å­˜ç©ºé—´è¾ƒå¤§ï¼Œæ¯”è¾ƒç‰¹æ®Šï¼Œæ‰€ä»¥è¯¥ Chunk å—åœ¨ä½¿ç”¨å®Œåï¼Œç«‹å³é‡Šæ”¾ï¼Œä¸è¿›è¡Œé‡å¤ä½¿ç”¨ã€‚</li>
<li>ç¬”è€…å¯¹ Netty å¯¹ Jemalloc ä¸åŒç±»å‹çš„å†…å­˜å—çš„æ•´ç†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_09_04/02.png" title="å†…å­˜å—åˆ†ç±»" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_09_04/02.png" alt="å†…å­˜å—åˆ†ç±»"></a><span class="caption">å†…å­˜å—åˆ†ç±»</span></li>
</ul>
</li>
</ul>
</li>
<li><p>Jemalloc åŸºäºã€ä¼™ä¼´åˆ†é…ç®—æ³•ã€‘åˆ†é… Chunk ä¸­çš„ Page èŠ‚ç‚¹ã€‚Netty å®ç°çš„ä¼™ä¼´åˆ†é…ç®—æ³•ä¸­ï¼Œæ„é€ äº†<strong>ä¸¤é¢—</strong>æ»¡äºŒå‰æ ‘ã€‚å› ä¸ºæ»¡äºŒå‰æ ‘éå¸¸é€‚åˆæ•°ç»„å­˜å‚¨ï¼ŒNetty ä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚æ•°ç»„ <code>memoryMap</code> å’Œ <code>depthMap</code> æ¥åˆ†åˆ«è¡¨ç¤º<strong>åˆ†é…ä¿¡æ¯</strong>æ»¡äºŒå‰æ ‘ã€<strong>é«˜åº¦ä¿¡æ¯</strong>æ»¡äºŒå‰æ ‘ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_09_04/03.png" title="æ»¡äºŒå‰æ ‘" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_09_04/03.png" alt="æ»¡äºŒå‰æ ‘"></a><span class="caption">æ»¡äºŒå‰æ ‘</span></p>
<ul>
<li><code>maxOrder</code> å±æ€§ï¼Œæ»¡äºŒå‰æ ‘çš„é«˜åº¦ã€‚é»˜è®¤ä¸º 11 ã€‚æ³¨æ„ï¼Œå±‚é«˜æ˜¯ä» 0 å¼€å§‹ã€‚</li>
<li><code>maxSubpageAllocs</code> å±æ€§ï¼Œå¯åˆ†é…çš„ Page çš„æ•°é‡ã€‚é»˜è®¤ä¸º 2048 ï¼Œåœ¨ã€ç¬¬ 17 è¡Œã€‘çš„ä»£ç è¿›è¡Œåˆå§‹åŒ–ã€‚åœ¨ç¬¬ 11 å±‚ï¼Œå¯ä»¥çœ‹åˆ° Page0 - Page2047 è¿™ 2048 ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿä¹Ÿç¬¦åˆ <code>1 &lt;&lt; maxOrder = 11 &lt;&lt; 11 = 2048</code> çš„è®¡ç®—ã€‚</li>
<li><p>åœ¨ã€ç¬¬ 19 è‡³ 32 è¡Œã€‘çš„ä»£ç ï¼Œ<code>memoryMap</code> å’Œ <code>depthMap</code> è¿›è¡Œæ»¡äºŒå‰æ ‘çš„åˆå§‹åŒ–ã€‚</p>
<ul>
<li>æ•°ç»„å¤§å°ä¸º <code>maxSubpageAllocs &lt;&lt; 1 = 2048 &lt;&lt; 1 = 4096</code> ã€‚</li>
<li>æ•°ç»„ä¸‹æ ‡ä¸º<strong>å·¦å›¾</strong>å¯¹åº”çš„èŠ‚ç‚¹ç¼–å·ã€‚åœ¨ã€ç¬¬ 23 è¡Œã€‘çš„ä»£ç ï¼Œä» <code>memoryMapIndex = 1</code> ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæ»¡äºŒå‰æ ‘çš„èŠ‚ç‚¹ç¼–å·æ˜¯<strong>ä» 1 å¼€å§‹</strong>ã€‚çœç•¥ 0 æ˜¯å› ä¸ºè¿™æ ·æ›´å®¹æ˜“è®¡ç®—çˆ¶å­å…³ç³»ï¼šå­èŠ‚ç‚¹åŠ å€ï¼Œçˆ¶èŠ‚ç‚¹å‡åŠï¼Œä¾‹å¦‚ï¼š512 çš„å­èŠ‚ç‚¹ä¸º 1024( <code>512 * 2</code> )å’Œ 1025( <code>512 * 2 + 1</code> )ã€‚</li>
<li><p>åˆå§‹æ—¶ï¼Œ<code>memoryMap</code> å’Œ <code>depthMap</code> ç›¸ç­‰ï¼Œå€¼ä¸º<strong>èŠ‚ç‚¹é«˜åº¦</strong>ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">memoryMap[<span class="number">1024</span>] = depthMap[<span class="number">1024</span>] = <span class="number">10</span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¯¹åº”<strong>å³å›¾</strong>ã€‚</li>
</ul>
</li>
<li>åˆ†é…èŠ‚ç‚¹æ—¶ï¼Œ<code>depthMap</code> çš„å€¼ä¿æŒ<strong>ä¸å˜</strong>( å› ä¸ºï¼ŒèŠ‚ç‚¹çš„é«˜åº¦æ²¡å‘ç”Ÿå˜åŒ– )ï¼Œ<code>memoryMap</code> çš„å€¼å‘ç”Ÿ<strong>å˜åŒ–</strong>( å› ä¸ºï¼ŒèŠ‚ç‚¹çš„åˆ†é…ä¿¡æ¯å‘ç”Ÿå˜åŒ– )ã€‚å½“ä¸€ä¸ªèŠ‚ç‚¹è¢«åˆ†é…åï¼Œè¯¥èŠ‚ç‚¹çš„å€¼è®¾ä¸º <code>unusable</code>( æ ‡è®°èŠ‚ç‚¹ä¸å¯ç”¨ã€‚é»˜è®¤ä¸º <code>maxOrder + 1 = 12</code> ) ã€‚<strong>å¹¶ä¸”ï¼Œä¼šæ›´æ–°ç¥–å…ˆèŠ‚ç‚¹çš„å€¼ä¸ºå…¶å­èŠ‚ç‚¹è¾ƒå°çš„å€¼</strong>( å› ä¸ºï¼Œç¥–å…ˆèŠ‚ç‚¹å…±ç”¨è¯¥èŠ‚ç‚¹çš„ Page å†…å­˜ï¼›åŒæ—¶ï¼Œä¸€ä¸ªçˆ¶èŠ‚ç‚¹æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œä¸€ä¸ªèŠ‚ç‚¹ä¸å¯ç”¨åï¼Œå¦ä¸€ä¸ªå­èŠ‚ç‚¹å¯èƒ½å¯ç”¨ï¼Œæ‰€ä»¥æ›´æ–°ä¸ºå…¶å­èŠ‚ç‚¹<strong>è¾ƒå°</strong>çš„å€¼ã€‚ )ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¸‹å›¾è¡¨ç¤ºéšç€èŠ‚ç‚¹ 4 åˆ†é…è€Œæ›´æ–°ç¥–å…ˆèŠ‚ç‚¹çš„è¿‡ç¨‹ï¼Œå…¶ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªæ•°å­—è¡¨ç¤º<strong>èŠ‚ç‚¹ç¼–å·</strong>ï¼Œç¬¬äºŒä¸ªæ•°å­—è¡¨ç¤º<strong>èŠ‚ç‚¹é«˜åº¦</strong>ï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_09_04/04.png" title="ä¾‹å­" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_09_04/04.png" alt="ä¾‹å­"></a><span class="caption">ä¾‹å­</span><ul>
<li>èŠ‚ç‚¹ 4 è¢«<strong>å®Œå…¨</strong>åˆ†é…ï¼Œå°†é«˜åº¦å€¼è®¾ç½®ä¸º 12 è¡¨ç¤ºä¸å¯ç”¨ã€‚</li>
<li>èŠ‚ç‚¹ 4 çš„çˆ¶èŠ‚ç‚¹ 2ï¼Œå°†é«˜åº¦å€¼æ›´æ–°ä¸ºä¸¤ä¸ªå­èŠ‚ç‚¹çš„è¾ƒå°å€¼ã€‚å…¶ä»–ç¥–å…ˆèŠ‚ç‚¹äº¦ç„¶ï¼Œç›´åˆ°é«˜åº¦å€¼æ›´æ–°è‡³æ ¹èŠ‚ç‚¹ã€‚</li>
</ul>
</li>
<li><code>memoryMap</code> æ•°ç»„çš„å€¼ï¼Œæ€»ç»“ä¸º 3 ç§æƒ…å†µï¼š<ul>
<li>1ã€<code>memoryMap[id] = depthMap[id]</code> ï¼Œè¯¥èŠ‚ç‚¹æ²¡æœ‰è¢«åˆ†é…ã€‚ </li>
<li>2ã€<code>æœ€å¤§é«˜åº¦ &gt;= memoryMap[id] &gt; depthMap[id]</code> ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªå­èŠ‚ç‚¹è¢«åˆ†é…ï¼Œä¸èƒ½å†åˆ†é…è¯¥é«˜åº¦æ»¡è¶³çš„å†…å­˜ï¼Œä½†å¯ä»¥æ ¹æ®å®é™…åˆ†é…è¾ƒå°ä¸€äº›çš„å†…å­˜ã€‚æ¯”å¦‚ï¼Œä¸Šå›¾ä¸­çˆ¶èŠ‚ç‚¹ 2 åˆ†é…äº†å­èŠ‚ç‚¹ 4ï¼Œå€¼ä» 1 æ›´æ–°ä¸º 2ï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹ä¸èƒ½å†åˆ†é… 8MB çš„åªèƒ½æœ€å¤§åˆ†é… 4MB å†…å­˜ï¼Œå³åªå‰©ä¸‹èŠ‚ç‚¹ 5 å¯ç”¨ã€‚</li>
<li>3ã€<code>memoryMap[id] = æœ€å¤§é«˜åº¦ + 1</code> ï¼Œè¯¥èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹å·²è¢«<strong>å®Œå…¨</strong>åˆ†é…ï¼Œæ²¡æœ‰å‰©ä½™ç©ºé—´ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Chunk ç›¸å…³å­—æ®µ</p>
<ul>
<li><code>chunkSize</code> å±æ€§ï¼ŒChunk å†…å­˜å—å ç”¨å¤§å°ã€‚é»˜è®¤ä¸º <code>16M = 16 * 1024KB</code>  ã€‚</li>
<li><p><code>log2ChunkSize</code> å±æ€§ï¼Œ<code>log2(chunkSize)</code> çš„ç»“æœã€‚é»˜è®¤ä¸º <code>log2( 16M ) = 24</code> ã€‚ ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INTEGER_SIZE_MINUS_ONE = Integer.SIZE - <span class="number">1</span>; <span class="comment">// 32 - 1 = 31</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">log2</span><span class="params">(<span class="keyword">int</span> val)</span> </span>{</span><br><span class="line">    <span class="comment">// compute the (0-based, with lsb = 0) position of highest set bit i.e, log2</span></span><br><span class="line">    <span class="keyword">return</span> INTEGER_SIZE_MINUS_ONE - Integer.numberOfLeadingZeros(val);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>x</li>
</ul>
</li>
<li><code>freeBytes</code> å±æ€§ï¼Œå‰©ä½™å¯ç”¨å­—èŠ‚æ•°ã€‚</li>
</ul>
</li>
<li>Page ç›¸å…³å­—æ®µ<ul>
<li><code>pageSize</code> å±æ€§ï¼Œæ¯ä¸ª Page çš„å¤§å°ã€‚é»˜è®¤ä¸º <code>8KB = 8192B</code> ã€‚</li>
<li><code>pageShifts</code> å±æ€§ï¼Œä» 1 å¼€å§‹å·¦ç§»åˆ° <code>pageSize</code> çš„ä½æ•°ã€‚é»˜è®¤ 13 ï¼Œ<code>1 &lt;&lt; 13 = 8192</code> ã€‚å…·ä½“ç”¨äºè®¡ç®—æŒ‡å®šå®¹é‡æ‰€åœ¨æ»¡äºŒå‰æ ‘çš„å±‚çº§ï¼Œè¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.2.1 allocateRunã€</a> ã€‚</li>
</ul>
</li>
<li><p>SubPage ç›¸å…³å­—æ®µ</p>
<ul>
<li>è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-3-Jemalloc-subpage">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆä¸‰ï¼‰PoolSubpageã€‹</a> ã€‚</li>
<li><p><code>subpages</code> å±æ€§ï¼ŒPoolSubpage æ•°ç»„ã€‚æ¯ä¸ªèŠ‚ç‚¹å¯¹åº”ä¸€ä¸ª PoolSubpage å¯¹è±¡ã€‚å› ä¸ºå®é™…ä¸Šï¼Œæ¯ä¸ª Page è¿˜æ˜¯<strong>æ¯”è¾ƒå¤§</strong>çš„å†…å­˜å—ï¼Œå¯ä»¥è¿›ä¸€æ­¥åˆ‡åˆ†æˆå°å— SubPage ã€‚åœ¨ã€ç¬¬ 35 è¡Œã€‘çš„ä»£ç ï¼Œè°ƒç”¨ <code>#newSubpageArray(int size)</code> æ–¹æ³•ï¼Œè¿›è¡Œåˆå§‹åŒ–ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> PoolSubpage&lt;T&gt;[] newSubpageArray(<span class="keyword">int</span> size) {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PoolSubpage[size];</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ•°ç»„å¤§å°ä¸º <code>maxSubpageAllocs = 2048</code> ã€‚</li>
</ul>
</li>
<li><p><code>subpageOverflowMask</code> å±æ€§ï¼Œåˆ¤æ–­åˆ†é…è¯·æ±‚å†…å­˜æ˜¯å¦ä¸º <strong>Tiny/Small</strong> ï¼Œå³åˆ†é… Subpage å†…å­˜å—ã€‚é»˜è®¤ï¼Œ-8192 ã€‚åœ¨ã€13 è¡Œã€‘çš„ä»£ç è¿›è¡Œåˆå§‹åŒ–ã€‚å¯¹äº -8192 çš„äºŒè¿›åˆ¶ï¼Œé™¤äº†é¦– bits ä¸º 1 ï¼Œå…¶å®ƒéƒ½ä¸º 0 ã€‚è¿™æ ·ï¼Œå¯¹äºå°äº 8K å­—èŠ‚çš„ç”³è¯·ï¼Œæ±‚ <code>subpageOverflowMask &amp; length</code> éƒ½ç­‰äº 0 ï¼›å¯¹äºå¤§äº 8K å­—èŠ‚çš„ç”³è¯·ï¼Œæ±‚ <code>subpageOverflowMask &amp; length</code> éƒ½<strong>ä¸</strong>ç­‰äº 0 ã€‚ç›¸å½“äºè¯´ï¼Œåšäº† <code>if ( length &lt; pageSize )</code> çš„è®¡ç®—ä¼˜åŒ–ã€‚</p>
</li>
</ul>
</li>
<li>ChunkList ç›¸å…³å­—æ®µ<ul>
<li>è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-4-Jemalloc-chunkList">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆå››ï¼‰PoolChunkListã€‹</a> ã€‚</li>
<li><code>parent</code> å±æ€§ï¼Œæ‰€å± PoolChunkList å¯¹è±¡ã€‚</li>
<li><code>prev</code> å±æ€§ï¼Œä¸Šä¸€ä¸ª Chunk å¯¹è±¡ã€‚</li>
<li><code>next</code> å±æ€§ï¼Œä¸‹ä¸€ä¸ª Chunk å¯¹è±¡ã€‚</li>
</ul>
</li>
</ul>
<p>å†…å®¹æ¯”è¾ƒâ€œåšå®â€( ğŸ˜ˆ å­—æ¯”è¾ƒå¤š )ï¼Œå»ºè®®èƒ–å‹å†è¯»ä¸€éï¼Œå†çœ‹ä¸‹é¢çš„ä»£ç å…·ä½“å®ç°ã€‚</p>
<h2 id="2-2-allocate"><a href="#2-2-allocate" class="headerlink" title="2.2 allocate"></a>2.2 allocate</h2><p><code>#allocate(int normCapacity)</code> æ–¹æ³•ï¼Œåˆ†é…å†…å­˜ç©ºé—´ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="number">1</span>: <span class="function"><span class="keyword">long</span> <span class="title">allocate</span><span class="params">(<span class="keyword">int</span> normCapacity)</span> </span>{</span><br><span class="line"><span class="number">2</span>:     <span class="comment">// å¤§äºç­‰äº Page å¤§å°ï¼Œåˆ†é… Page å†…å­˜å—</span></span><br><span class="line"><span class="number">3</span>:     <span class="keyword">if</span> ((normCapacity &amp; subpageOverflowMask) != <span class="number">0</span>) { <span class="comment">// &gt;= pageSize</span></span><br><span class="line"><span class="number">4</span>:         <span class="keyword">return</span> allocateRun(normCapacity);</span><br><span class="line"><span class="number">5</span>:     <span class="comment">// å°äº Page å¤§å°ï¼Œåˆ†é… Subpage å†…å­˜å—</span></span><br><span class="line"><span class="number">6</span>:     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">7</span>:         <span class="keyword">return</span> allocateSubpage(normCapacity);</span><br><span class="line"><span class="number">8</span>:     }</span><br><span class="line"><span class="number">9</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 2 è‡³ 4 è¡Œï¼šå½“ç”³è¯·çš„ <code>normCapacity</code> å¤§äºç­‰äº Page å¤§å°æ—¶ï¼Œè°ƒç”¨ <code>#allocateRun(int normCapacity)</code> æ–¹æ³•ï¼Œåˆ†é… Page å†…å­˜å—ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.2.1 allocateRunã€</a> ä¸­ã€‚</li>
<li>ç¬¬ 5 è‡³ 8 è¡Œï¼šè°ƒç”¨ <code>#allocateSubpage(int normCapacity)</code> æ–¹æ³•ï¼Œåˆ†é… Subpage å†…å­˜å—ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.2.1 allocateSubpageã€</a> ä¸­ã€‚</li>
</ul>
<h3 id="2-2-1-allocateRun"><a href="#2-2-1-allocateRun" class="headerlink" title="2.2.1 allocateRun"></a>2.2.1 allocateRun</h3><p><code>#allocateRun(int normCapacity)</code> æ–¹æ³•ï¼Œåˆ†é… Page å†…å­˜å—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Allocate a run of pages (&gt;=1)</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> normCapacity normalized capacity</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> index in memoryMap</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">allocateRun</span><span class="params">(<span class="keyword">int</span> normCapacity)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// è·å¾—å±‚çº§</span></span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">int</span> d = maxOrder - (log2(normCapacity) - pageShifts);</span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// è·å¾—èŠ‚ç‚¹</span></span><br><span class="line"> <span class="number">5</span>:     <span class="keyword">int</span> id = allocateNode(d);</span><br><span class="line"> <span class="number">6</span>:     <span class="comment">// æœªè·å¾—åˆ°èŠ‚ç‚¹ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (id &lt; <span class="number">0</span>) {</span><br><span class="line"> <span class="number">8</span>:         <span class="keyword">return</span> id;</span><br><span class="line"> <span class="number">9</span>:     }</span><br><span class="line"><span class="number">10</span>:     <span class="comment">// å‡å°‘å‰©ä½™å¯ç”¨å­—èŠ‚æ•°</span></span><br><span class="line"><span class="number">11</span>:     freeBytes -= runLength(id);</span><br><span class="line"><span class="number">12</span>:     <span class="keyword">return</span> id;</span><br><span class="line"><span class="number">13</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šè·å¾—å±‚çº§ã€‚</li>
<li>ç¬¬ 5 è¡Œï¼šè°ƒç”¨ <code>#allocateNode(int normCapacity)</code> æ–¹æ³•ï¼Œåˆ†é…èŠ‚ç‚¹ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.2.3 allocateNodeã€</a> ä¸­ã€‚<ul>
<li>ç¬¬ 7 è‡³ 9 è¡Œï¼šæœªè·å¾—åˆ°èŠ‚ç‚¹ï¼Œç›´æ¥è¿”å›ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 11 è¡Œï¼šè°ƒç”¨ <code>#runLength(int id)</code> æ–¹æ³•ï¼Œè®¡ç®—ä½¿ç”¨èŠ‚ç‚¹çš„å­—èŠ‚æ•°ï¼Œå¹¶å‡å°‘å‰©ä½™å¯ç”¨å­—èŠ‚æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">runLength</span><span class="params">(<span class="keyword">int</span> id)</span> </span>{</span><br><span class="line">    <span class="comment">// represents the size in #bytes supported by node 'id' in the tree</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> &lt;&lt; log2ChunkSize - depth(id);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">byte</span> <span class="title">depth</span><span class="params">(<span class="keyword">int</span> id)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> depthMap[id];</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h3 id="2-2-2-allocateSubpage"><a href="#2-2-2-allocateSubpage" class="headerlink" title="2.2.2 allocateSubpage"></a>2.2.2 allocateSubpage</h3><blockquote>
<p>è€è‰¿è‰¿ï¼šæœ¬å°èŠ‚ï¼Œèƒ–å‹å…ˆçœ‹å®Œ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-3-Jemalloc-subpage">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆä¸‰ï¼‰PoolSubpageã€‹</a> ã€‚</p>
</blockquote>
<p><code>#allocateSubpage(int normCapacity)</code> æ–¹æ³•ï¼Œåˆ†é… Subpage å†…å­˜å—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Create/ initialize a new PoolSubpage of normCapacity</span></span><br><span class="line"><span class="comment">    * Any PoolSubpage created/ initialized here is added to subpage pool in the PoolArena that owns this PoolChunk</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> normCapacity normalized capacity</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> index in memoryMap</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">allocateSubpage</span><span class="params">(<span class="keyword">int</span> normCapacity)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// è·å¾—å¯¹åº”å†…å­˜è§„æ ¼çš„ Subpage åŒå‘é“¾è¡¨çš„ head èŠ‚ç‚¹</span></span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// Obtain the head of the PoolSubPage pool that is owned by the PoolArena and synchronize on it.</span></span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// This is need as we may add it back and so alter the linked-list structure.</span></span><br><span class="line"> <span class="number">5</span>:     PoolSubpage&lt;T&gt; head = arena.findSubpagePoolHead(normCapacity);</span><br><span class="line"> <span class="number">6</span>:     <span class="comment">// åŠ é”ï¼Œåˆ†é…è¿‡ç¨‹ä¼šä¿®æ”¹åŒå‘é“¾è¡¨çš„ç»“æ„ï¼Œä¼šå­˜åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µã€‚</span></span><br><span class="line"> <span class="number">7</span>:     <span class="keyword">synchronized</span> (head) {</span><br><span class="line"> <span class="number">8</span>:         <span class="comment">// è·å¾—æœ€åº•å±‚çš„ä¸€ä¸ªèŠ‚ç‚¹ã€‚Subpage åªèƒ½ä½¿ç”¨äºŒå‰æ ‘çš„æœ€åº•å±‚çš„èŠ‚ç‚¹ã€‚</span></span><br><span class="line"> <span class="number">9</span>:         <span class="keyword">int</span> d = maxOrder; <span class="comment">// subpages are only be allocated from pages i.e., leaves</span></span><br><span class="line"><span class="number">10</span>:         <span class="keyword">int</span> id = allocateNode(d);</span><br><span class="line"><span class="number">11</span>:         <span class="comment">// è·å–å¤±è´¥ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line"><span class="number">12</span>:         <span class="keyword">if</span> (id &lt; <span class="number">0</span>) {</span><br><span class="line"><span class="number">13</span>:             <span class="keyword">return</span> id;</span><br><span class="line"><span class="number">14</span>:         }</span><br><span class="line"><span class="number">15</span>: </span><br><span class="line"><span class="number">16</span>:         <span class="keyword">final</span> PoolSubpage&lt;T&gt;[] subpages = <span class="keyword">this</span>.subpages;</span><br><span class="line"><span class="number">17</span>:         <span class="keyword">final</span> <span class="keyword">int</span> pageSize = <span class="keyword">this</span>.pageSize;</span><br><span class="line"><span class="number">18</span>: </span><br><span class="line"><span class="number">19</span>:         <span class="comment">// å‡å°‘å‰©ä½™å¯ç”¨å­—èŠ‚æ•°</span></span><br><span class="line"><span class="number">20</span>:         freeBytes -= pageSize;</span><br><span class="line"><span class="number">21</span>: </span><br><span class="line"><span class="number">22</span>:         <span class="comment">// è·å¾—èŠ‚ç‚¹å¯¹åº”çš„ subpages æ•°ç»„çš„ç¼–å·</span></span><br><span class="line"><span class="number">23</span>:         <span class="keyword">int</span> subpageIdx = subpageIdx(id);</span><br><span class="line"><span class="number">24</span>:         <span class="comment">// è·å¾—èŠ‚ç‚¹å¯¹åº”çš„ subpages æ•°ç»„çš„ PoolSubpage å¯¹è±¡</span></span><br><span class="line"><span class="number">25</span>:         PoolSubpage&lt;T&gt; subpage = subpages[subpageIdx];</span><br><span class="line"><span class="number">26</span>:         <span class="comment">// åˆå§‹åŒ– PoolSubpage å¯¹è±¡</span></span><br><span class="line"><span class="number">27</span>:         <span class="keyword">if</span> (subpage == <span class="keyword">null</span>) { <span class="comment">// ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œåˆ›å»º PoolSubpage å¯¹è±¡</span></span><br><span class="line"><span class="number">28</span>:             subpage = <span class="keyword">new</span> PoolSubpage&lt;T&gt;(head, <span class="keyword">this</span>, id, runOffset(id), pageSize, normCapacity);</span><br><span class="line"><span class="number">29</span>:             subpages[subpageIdx] = subpage;</span><br><span class="line"><span class="number">30</span>:         } <span class="keyword">else</span> { <span class="comment">// å­˜åœ¨ï¼Œåˆ™é‡æ–°åˆå§‹åŒ– PoolSubpage å¯¹è±¡</span></span><br><span class="line"><span class="number">31</span>:             subpage.init(head, normCapacity);</span><br><span class="line"><span class="number">32</span>:         }</span><br><span class="line"><span class="number">33</span>:         <span class="comment">// åˆ†é… PoolSubpage å†…å­˜å—</span></span><br><span class="line"><span class="number">34</span>:         <span class="keyword">return</span> subpage.allocate();</span><br><span class="line"><span class="number">35</span>:     }</span><br><span class="line"><span class="number">36</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 5 è¡Œï¼šè°ƒç”¨ <code>PoolArena#findSubpagePoolHead(int normCapacity)</code> æ–¹æ³•ï¼Œè·å¾—å¯¹åº”å†…å­˜è§„æ ¼çš„ Subpage åŒå‘é“¾è¡¨çš„ <code>head</code> èŠ‚ç‚¹ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-5-Jemalloc-Arena">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆäº”ï¼‰PoolArenaã€‹</a> ã€‚</li>
<li>ç¬¬ 7 è¡Œï¼š<code>synchronized</code> åŠ é”ï¼Œåˆ†é…è¿‡ç¨‹ä¼šä¿®æ”¹åŒå‘é“¾è¡¨çš„ç»“æ„ï¼Œä¼šå­˜åœ¨<strong>å¤šçº¿ç¨‹</strong>çš„æƒ…å†µã€‚</li>
<li>ç¬¬ 8 è‡³ 10 è¡Œï¼šè°ƒç”¨ <code>#allocateNode(int d)</code> æ–¹æ³•ï¼Œè·å¾—æœ€åº•å±‚çš„ä¸€ä¸ªèŠ‚ç‚¹ã€‚<strong>Subpage åªèƒ½ä½¿ç”¨äºŒå‰æ ‘çš„æœ€åº•å±‚çš„èŠ‚ç‚¹</strong>ã€‚<ul>
<li>ç¬¬ 11 è‡³ 14 è¡Œï¼šè·å–å¤±è´¥ï¼Œç›´æ¥è¿”å›ã€‚</li>
<li>ç¬¬ 20 è¡Œï¼šå‡å°‘å‰©ä½™å¯ç”¨å­—èŠ‚æ•°ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 23 è‡³ 34 è¡Œï¼šåˆ†é… PoolSubpage å†…å­˜å—ã€‚</p>
<ul>
<li><p>ç¬¬ 23 è¡Œï¼šè°ƒç”¨ <code>#subpageIdx(int id)</code> æ–¹æ³•ï¼Œè·å¾—èŠ‚ç‚¹å¯¹åº”çš„ <code>subpages</code> æ•°ç»„çš„ç¼–å·ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">subpageIdx</span><span class="params">(<span class="keyword">int</span> memoryMapIdx)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> memoryMapIdx ^ maxSubpageAllocs; <span class="comment">// remove highest set bit, to get offset</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å»æ‰æœ€é«˜ä½( bit )ã€‚ä¾‹å¦‚èŠ‚ç‚¹ 2048 è®¡ç®—åçš„ç»“æœä¸º 0 ã€‚</li>
</ul>
</li>
<li>ç¬¬ 25 è¡Œï¼šè·å¾—èŠ‚ç‚¹å¯¹åº”çš„ <code>subpages</code> æ•°ç»„çš„ PoolSubpage å¯¹è±¡ã€‚</li>
<li>ç¬¬ 26 è‡³ 32 è¡Œï¼šåˆå§‹åŒ– PoolSubpage å¯¹è±¡ã€‚</li>
<li>ç¬¬ 34 è¡Œï¼šè°ƒç”¨ <code>PoolSubpage#allocate()</code> æ–¹æ³•ï¼Œåˆ†é… PoolSubpage å†…å­˜å—ã€‚</li>
</ul>
</li>
</ul>
<h3 id="2-2-3-allocateNode"><a href="#2-2-3-allocateNode" class="headerlink" title="2.2.3 allocateNode"></a>2.2.3 allocateNode</h3><p><code>#allocateNode(int normCapacity)</code> æ–¹æ³•ï¼Œåˆ†é…èŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Algorithm to allocate an index in memoryMap when we query for a free node</span></span><br><span class="line"><span class="comment">    * at depth d</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> d depth</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span> index in memoryMap</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">allocateNode</span><span class="params">(<span class="keyword">int</span> d)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">int</span> id = <span class="number">1</span>;</span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">int</span> initial = - (<span class="number">1</span> &lt;&lt; d); <span class="comment">// has last d bits = 0 and rest all = 1</span></span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// è·å¾—æ ¹èŠ‚ç‚¹çš„æŒ‡å€¼ã€‚</span></span><br><span class="line"> <span class="number">5</span>:     <span class="comment">// å¦‚æœæ ¹èŠ‚ç‚¹çš„å€¼ï¼Œå¤§äº d ï¼Œè¯´æ˜ï¼Œç¬¬ d å±‚æ²¡æœ‰ç¬¦åˆçš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´ [0, d-1] å±‚ä¹Ÿæ²¡æœ‰ç¬¦åˆçš„èŠ‚ç‚¹ã€‚å³ï¼Œå½“å‰ Chunk æ²¡æœ‰ç¬¦åˆçš„èŠ‚ç‚¹ã€‚</span></span><br><span class="line"> <span class="number">6</span>:     <span class="keyword">byte</span> val = value(id);</span><br><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (val &gt; d) { <span class="comment">// unusable</span></span><br><span class="line"> <span class="number">8</span>:         <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line"> <span class="number">9</span>:     }</span><br><span class="line"><span class="number">10</span>:     <span class="comment">// è·å¾—ç¬¬ d å±‚ï¼ŒåŒ¹é…çš„èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="number">11</span>:     <span class="comment">// id &amp; initial æ¥ä¿è¯ï¼Œé«˜åº¦å°äº d ä¼šç»§ç»­å¾ªç¯</span></span><br><span class="line"><span class="number">12</span>:     <span class="keyword">while</span> (val &lt; d || (id &amp; initial) == <span class="number">0</span>) { <span class="comment">// id &amp; initial == 1 &lt;&lt; d for all ids at depth d, for &lt; d it is 0</span></span><br><span class="line"><span class="number">13</span>:         <span class="comment">// è¿›å…¥ä¸‹ä¸€å±‚</span></span><br><span class="line"><span class="number">14</span>:         <span class="comment">// è·å¾—å·¦èŠ‚ç‚¹çš„ç¼–å·</span></span><br><span class="line"><span class="number">15</span>:         id &lt;&lt;= <span class="number">1</span>;</span><br><span class="line"><span class="number">16</span>:         <span class="comment">// è·å¾—å·¦èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line"><span class="number">17</span>:         val = value(id);</span><br><span class="line"><span class="number">18</span>:         <span class="comment">// å¦‚æœå€¼å¤§äº d ï¼Œè¯´æ˜ï¼Œä»¥å·¦èŠ‚ç‚¹ä½œä¸ºæ ¹èŠ‚ç‚¹å½¢æˆè™šæ‹Ÿçš„è™šæ‹Ÿæ»¡äºŒå‰æ ‘ï¼Œæ²¡æœ‰ç¬¦åˆçš„èŠ‚ç‚¹ã€‚</span></span><br><span class="line"><span class="number">19</span>:         <span class="keyword">if</span> (val &gt; d) {</span><br><span class="line"><span class="number">20</span>:             <span class="comment">// è·å¾—å³èŠ‚ç‚¹çš„ç¼–å·</span></span><br><span class="line"><span class="number">21</span>:             id ^= <span class="number">1</span>;</span><br><span class="line"><span class="number">22</span>:             <span class="comment">// è·å¾—å³èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line"><span class="number">23</span>:             val = value(id);</span><br><span class="line"><span class="number">24</span>:         }</span><br><span class="line"><span class="number">25</span>:     }</span><br><span class="line"><span class="number">26</span>: </span><br><span class="line"><span class="number">27</span>:     <span class="comment">// æ ¡éªŒè·å¾—çš„èŠ‚ç‚¹å€¼åˆç†</span></span><br><span class="line"><span class="number">28</span>:     <span class="keyword">byte</span> value = value(id);</span><br><span class="line"><span class="number">29</span>:     <span class="keyword">assert</span> value == d &amp;&amp; (id &amp; initial) == <span class="number">1</span> &lt;&lt; d : String.format(<span class="string">"val = %d, id &amp; initial = %d, d = %d"</span>,</span><br><span class="line"><span class="number">30</span>:             value, id &amp; initial, d);</span><br><span class="line"><span class="number">31</span>: </span><br><span class="line"><span class="number">32</span>:     <span class="comment">// æ›´æ–°è·å¾—çš„èŠ‚ç‚¹ä¸å¯ç”¨</span></span><br><span class="line"><span class="number">33</span>:     setValue(id, unusable); <span class="comment">// mark as unusable</span></span><br><span class="line"><span class="number">34</span>:     <span class="comment">// æ›´æ–°è·å¾—çš„èŠ‚ç‚¹çš„ç¥–å…ˆéƒ½ä¸å¯ç”¨</span></span><br><span class="line"><span class="number">35</span>:     updateParentsAlloc(id);</span><br><span class="line"><span class="number">36</span>: </span><br><span class="line"><span class="number">37</span>:     <span class="comment">// è¿”å›èŠ‚ç‚¹ç¼–å·</span></span><br><span class="line"><span class="number">38</span>:     <span class="keyword">return</span> id;</span><br><span class="line"><span class="number">39</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šé€šè¿‡ <code>- (1 &lt;&lt; d)</code> è®¡ç®—ï¼Œè·å¾— <code>initial</code> ã€‚ç”¨äºã€ç¬¬ 12 è¡Œã€‘çš„ä»£ç ï¼Œ<code>id &amp; initial</code> ï¼Œæ¥ä¿è¯ï¼Œé«˜åº¦å°äº <code>d</code> ä¼šç»§ç»­<strong>å¾ªç¯</strong>ã€‚</li>
<li><p>ç¬¬ 6 è¡Œï¼šè·å¾—æ ¹èŠ‚ç‚¹( <code>id = 1</code> )çš„æŒ‡å€¼ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">byte</span> <span class="title">value</span><span class="params">(<span class="keyword">int</span> id)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> memoryMap[id];</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 7 è‡³ 9 è¡Œï¼šå¦‚æœæ ¹èŠ‚ç‚¹çš„å€¼ï¼Œå¤§äº <code>d</code> ï¼Œè¯´æ˜ï¼Œç¬¬ <code>d</code> å±‚æ²¡æœ‰ç¬¦åˆçš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>[1, d-1]</code> å±‚ä¹Ÿæ²¡æœ‰ç¬¦åˆçš„èŠ‚ç‚¹ã€‚å³ï¼Œå½“å‰ Chunk æ²¡æœ‰ç¬¦åˆçš„èŠ‚ç‚¹ã€‚</li>
</ul>
</li>
<li>ç¬¬ 10 è‡³ 25 è¡Œï¼šè·å¾—ç¬¬ <code>d</code> å±‚ï¼ŒåŒ¹é…çš„èŠ‚ç‚¹ã€‚å› ä¸º <code>val &lt; d</code> éš¾ä»¥ä¿è¯æ˜¯ç¬¬ <code>d</code> å±‚ï¼Œ<code>[0, d-1]</code> å±‚ä¹Ÿå¯ä»¥æ»¡è¶³ <code>val &lt; d</code> ï¼Œæ‰€ä»¥æ‰æœ‰ <code>id &amp; initial</code> æ¥ä¿è¯ï¼Œé«˜åº¦å°äº <code>d</code> ä¼šç»§ç»­å¾ªç¯ã€‚<ul>
<li>â† ç¬¬ 15 è¡Œï¼š<code>&lt;&lt; 1</code> æ“ä½œï¼Œè¿›å…¥ä¸‹ä¸€å±‚ã€‚è·å¾—<strong>å·¦èŠ‚ç‚¹</strong>çš„ç¼–å·ã€‚</li>
<li>â† ç¬¬ 17 è¡Œï¼šè·å¾—å·¦èŠ‚ç‚¹çš„å€¼ã€‚</li>
<li>â†’ ç¬¬ 19 è¡Œï¼šå¦‚æœå€¼å¤§äº <code>d</code> ï¼Œè¯´æ˜ï¼Œä»¥å·¦èŠ‚ç‚¹ä½œä¸ºæ ¹èŠ‚ç‚¹å½¢æˆè™šæ‹Ÿçš„è™šæ‹Ÿæ»¡äºŒå‰æ ‘ï¼Œæ²¡æœ‰ç¬¦åˆçš„èŠ‚ç‚¹ã€‚æ­¤æ—¶ï¼Œéœ€è¦è·³åˆ°<strong>å³èŠ‚ç‚¹</strong>ã€‚</li>
<li>â†’ ç¬¬ 21 è¡Œï¼š<code>^ 1</code> æ“ä½œï¼Œè·å¾—<strong>å³èŠ‚ç‚¹</strong>çš„ç¼–å·ã€‚</li>
<li>â†’ ç¬¬ 23 è¡Œï¼šè·å¾—å³èŠ‚ç‚¹çš„å€¼ã€‚</li>
<li>ã€ç¬¬ 17 è¡Œã€‘æˆ–è€…ã€ç¬¬ 23 è¡Œã€‘çš„ä»£ç ï¼Œä¼šé€šè¿‡ã€ç¬¬ 12 è¡Œã€‘çš„ä»£ç ï¼Œç»“æŸå¾ªç¯ã€‚ä¹Ÿå°±è¯´ï¼Œè·å¾—ç¬¬ <code>d</code> å±‚ï¼ŒåŒ¹é…çš„èŠ‚ç‚¹ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 33 è¡Œï¼šè°ƒç”¨ <code>#setValue(int id, byte val)</code> æ–¹æ³•ï¼Œè®¾ç½®è·å¾—çš„èŠ‚ç‚¹çš„å€¼ä¸º <code>unusable</code> ï¼Œè¡¨ç¤ºä¸å¯ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setValue</span><span class="params">(<span class="keyword">int</span> id, <span class="keyword">byte</span> val)</span> </span>{</span><br><span class="line">    memoryMap[id] = val;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ç¬¬ 35 è¡Œï¼šè°ƒç”¨ <code>#updateParentsAlloc(int id)</code> æ–¹æ³•ï¼Œæ›´æ–°è·å¾—çš„èŠ‚ç‚¹çš„ç¥–å…ˆéƒ½ä¸å¯ç”¨ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.4.1 updateParentsAllocã€</a> ã€‚</p>
</li>
<li>ç¬¬ 38 è¡Œï¼šè¿”å›èŠ‚ç‚¹ç¼–å·ã€‚</li>
</ul>
<h2 id="2-3-free"><a href="#2-3-free" class="headerlink" title="2.3 free"></a>2.3 free</h2><blockquote>
<p>è€è‰¿è‰¿ï¼šæœ¬å°èŠ‚ï¼Œèƒ–å‹å…ˆçœ‹å®Œ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-3-Jemalloc-subpage">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆä¸‰ï¼‰PoolSubpageã€‹</a> ã€‚</p>
</blockquote>
<p><code>#free(long handle)</code> æ–¹æ³•ï¼Œé‡Šæ”¾æŒ‡å®šä½ç½®çš„å†…å­˜å—ã€‚æ ¹æ®æƒ…å†µï¼Œå†…å­˜å—å¯èƒ½æ˜¯ SubPage ï¼Œä¹Ÿå¯èƒ½æ˜¯ Page ï¼Œä¹Ÿå¯èƒ½æ˜¯é‡Šæ”¾ SubPage å¹¶ä¸”é‡Šæ”¾å¯¹åº”çš„ Page ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Free a subpage or a run of pages</span></span><br><span class="line"><span class="comment">    * When a subpage is freed from PoolSubpage, it might be added back to subpage pool of the owning PoolArena</span></span><br><span class="line"><span class="comment">    * If the subpage pool in PoolArena has at least one other PoolSubpage of given elemSize, we can</span></span><br><span class="line"><span class="comment">    * completely free the owning Page so it is available for subsequent allocations</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> handle handle to free</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">long</span> handle)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// è·å¾— memoryMap æ•°ç»„çš„ç¼–å·( ä¸‹æ ‡ )</span></span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">int</span> memoryMapIdx = memoryMapIdx(handle);</span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// è·å¾— bitmap æ•°ç»„çš„ç¼–å·( ä¸‹æ ‡ )ã€‚æ³¨æ„ï¼Œæ­¤æ—¶è·å¾—çš„è¿˜ä¸æ˜¯çœŸæ­£çš„ bitmapIdx å€¼ï¼Œéœ€è¦ç»è¿‡ `bitmapIdx &amp; 0x3FFFFFFF` è¿ç®—ã€‚</span></span><br><span class="line"> <span class="number">5</span>:     <span class="keyword">int</span> bitmapIdx = bitmapIdx(handle);</span><br><span class="line"> <span class="number">6</span>: </span><br><span class="line"> <span class="number">7</span>:     <span class="comment">// é‡Šæ”¾ Subpage begin ~</span></span><br><span class="line"> <span class="number">8</span>: </span><br><span class="line"> <span class="number">9</span>:     <span class="keyword">if</span> (bitmapIdx != <span class="number">0</span>) { <span class="comment">// free a subpage bitmapIdx éç©ºï¼Œè¯´æ˜é‡Šæ”¾çš„æ˜¯ Subpage</span></span><br><span class="line"><span class="number">10</span>:         <span class="comment">// è·å¾— PoolSubpage å¯¹è±¡</span></span><br><span class="line"><span class="number">11</span>:         PoolSubpage&lt;T&gt; subpage = subpages[subpageIdx(memoryMapIdx)];</span><br><span class="line"><span class="number">12</span>:         <span class="keyword">assert</span> subpage != <span class="keyword">null</span> &amp;&amp; subpage.doNotDestroy;</span><br><span class="line"><span class="number">13</span>: </span><br><span class="line"><span class="number">14</span>:         <span class="comment">// è·å¾—å¯¹åº”å†…å­˜è§„æ ¼çš„ Subpage åŒå‘é“¾è¡¨çš„ head èŠ‚ç‚¹</span></span><br><span class="line"><span class="number">15</span>:         <span class="comment">// Obtain the head of the PoolSubPage pool that is owned by the PoolArena and synchronize on it.</span></span><br><span class="line"><span class="number">16</span>:         <span class="comment">// This is need as we may add it back and so alter the linked-list structure.</span></span><br><span class="line"><span class="number">17</span>:         PoolSubpage&lt;T&gt; head = arena.findSubpagePoolHead(subpage.elemSize);</span><br><span class="line"><span class="number">18</span>:         <span class="comment">// åŠ é”ï¼Œåˆ†é…è¿‡ç¨‹ä¼šä¿®æ”¹åŒå‘é“¾è¡¨çš„ç»“æ„ï¼Œä¼šå­˜åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µã€‚</span></span><br><span class="line"><span class="number">19</span>:         <span class="keyword">synchronized</span> (head) {</span><br><span class="line"><span class="number">20</span>:             <span class="comment">// é‡Šæ”¾ Subpage ã€‚</span></span><br><span class="line"><span class="number">21</span>:             <span class="keyword">if</span> (subpage.free(head, bitmapIdx &amp; <span class="number">0x3FFFFFFF</span>)) {</span><br><span class="line"><span class="number">22</span>:                 <span class="keyword">return</span>;</span><br><span class="line"><span class="number">23</span>:             }</span><br><span class="line"><span class="number">24</span>:             <span class="comment">// â†‘â†‘â†‘ è¿”å› false ï¼Œè¯´æ˜ Page ä¸­æ— åˆ‡åˆ†æ­£åœ¨ä½¿ç”¨çš„ Subpage å†…å­˜å—ï¼Œæ‰€ä»¥å¯ä»¥ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œé‡Šæ”¾ Page</span></span><br><span class="line"><span class="number">25</span>:         }</span><br><span class="line"><span class="number">26</span>:     }</span><br><span class="line"><span class="number">27</span>: </span><br><span class="line"><span class="number">28</span>:     <span class="comment">// é‡Šæ”¾ Page begin ~</span></span><br><span class="line"><span class="number">29</span>: </span><br><span class="line"><span class="number">30</span>:     <span class="comment">// å¢åŠ å‰©ä½™å¯ç”¨å­—èŠ‚æ•°</span></span><br><span class="line"><span class="number">31</span>:     freeBytes += runLength(memoryMapIdx);</span><br><span class="line"><span class="number">32</span>:     <span class="comment">// è®¾ç½® Page å¯¹åº”çš„èŠ‚ç‚¹å¯ç”¨</span></span><br><span class="line"><span class="number">33</span>:     setValue(memoryMapIdx, depth(memoryMapIdx));</span><br><span class="line"><span class="number">34</span>:     <span class="comment">// æ›´æ–° Page å¯¹åº”çš„èŠ‚ç‚¹çš„ç¥–å…ˆå¯ç”¨</span></span><br><span class="line"><span class="number">35</span>:     updateParentsFree(memoryMapIdx);</span><br><span class="line"><span class="number">36</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ç¬¬ 3 è¡Œï¼šè°ƒç”¨ <code>#memoryMapIdx(handle)</code> æ–¹æ³•ï¼Œè·å¾— <code>memoryMap</code> æ•°ç»„çš„ç¼–å·( ä¸‹æ ‡ )ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">memoryMapIdx</span><span class="params">(<span class="keyword">long</span> handle)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>) handle;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ç¬¬ 5 è¡Œï¼šè°ƒç”¨ <code>#bitmapIdx(handle)</code> æ–¹æ³•ï¼Œè·å¾— <code>bitmap</code> æ•°ç»„çš„ç¼–å·( ä¸‹æ ‡ )ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">bitmapIdx</span><span class="params">(<span class="keyword">long</span> handle)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">int</span>) (handle &gt;&gt;&gt; Integer.SIZE);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ³¨æ„ï¼Œæ­¤æ—¶è·å¾—çš„è¿˜ä¸æ˜¯çœŸæ­£çš„ bitmapIdx å€¼ï¼Œéœ€è¦ç»è¿‡ <code>bitmapIdx &amp; 0x3FFFFFFF</code> è¿ç®—ï¼Œå³ã€ç¬¬ 21 è¡Œã€‘çš„ä»£ç ã€‚</li>
</ul>
</li>
<li>ç¬¬ 9 è‡³ 26 è¡Œï¼šé‡Šæ”¾ Subpage å†…å­˜å—ã€‚<ul>
<li>ç¬¬ 9 è¡Œï¼šé€šè¿‡ <code>bitmapIdx !=0</code> åˆ¤æ–­ï¼Œè¯´æ˜é‡Šæ”¾çš„æ˜¯ Subpage å†…å­˜å—ã€‚</li>
<li>ç¬¬ 11 è¡Œï¼šè·å¾— PoolSubpage å¯¹è±¡ã€‚</li>
<li>ç¬¬ 17 è¡Œï¼šè°ƒç”¨ <code>PoolArena#findSubpagePoolHead(int normCapacity)</code> æ–¹æ³•ï¼Œè·å¾—å¯¹åº”å†…å­˜è§„æ ¼çš„ Subpage åŒå‘é“¾è¡¨çš„ <code>head</code> èŠ‚ç‚¹ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-5-Jemalloc-Arena">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆäº”ï¼‰PoolArenaã€‹</a> ã€‚</li>
<li>ç¬¬ 19 è¡Œï¼š<code>synchronized</code> åŠ é”ï¼Œåˆ†é…è¿‡ç¨‹ä¼šä¿®æ”¹åŒå‘é“¾è¡¨çš„ç»“æ„ï¼Œä¼šå­˜åœ¨å¤šçº¿ç¨‹çš„æƒ…å†µã€‚</li>
<li>ç¬¬ 21 è¡Œï¼šè°ƒç”¨ <code>SubPage#free(PoolSubpage&lt;T&gt; head, int bitmapIdx)</code> æ–¹æ³•ï¼Œé‡Šæ”¾ Subpage å†…å­˜å—ã€‚<ul>
<li>å¦‚æœè¿”å› <code>false</code> ï¼Œè¯´æ˜ Page ä¸­<strong>æ— åˆ‡åˆ†æ­£åœ¨ä½¿ç”¨</strong>çš„ Subpage å†…å­˜å—ï¼Œæ‰€ä»¥å¯ä»¥ç»§ç»­å‘ä¸‹æ‰§è¡Œï¼Œé‡Šæ”¾ Page å†…å­˜å—ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 30 è‡³ 35 è¡Œï¼šé‡Šæ”¾ Page å†…å­˜å—ã€‚<ul>
<li>ç¬¬ 31 è¡Œï¼šå¢åŠ å‰©ä½™å¯ç”¨å­—èŠ‚æ•°ã€‚</li>
<li>ç¬¬ 33 è¡Œï¼šè°ƒç”¨ <code>#setValue(int id, byte val)</code> æ–¹æ³•ï¼Œè®¾ç½® Page å¯¹åº”çš„èŠ‚ç‚¹<strong>å¯ç”¨</strong>ã€‚</li>
<li>ç¬¬ 35 è¡Œï¼šè°ƒç”¨ <code>#updateParentsAlloc(int id)</code> æ–¹æ³•ï¼Œæ›´æ–°è·å¾—çš„èŠ‚ç‚¹çš„ç¥–å…ˆ<strong>å¯ç”¨</strong>ã€‚</li>
</ul>
</li>
</ul>
<h2 id="2-4-updateParents"><a href="#2-4-updateParents" class="headerlink" title="2.4 updateParents"></a>2.4 updateParents</h2><h3 id="2-4-1-updateParentsAlloc"><a href="#2-4-1-updateParentsAlloc" class="headerlink" title="2.4.1 updateParentsAlloc"></a>2.4.1 updateParentsAlloc</h3><p><code>#updateParentsAlloc(int id)</code> æ–¹æ³•ï¼Œæ›´æ–°è·å¾—çš„èŠ‚ç‚¹çš„ç¥–å…ˆéƒ½ä¸å¯ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Update method used by allocate</span></span><br><span class="line"><span class="comment">    * This is triggered only when a successor is allocated and all its predecessors</span></span><br><span class="line"><span class="comment">    * need to update their state</span></span><br><span class="line"><span class="comment">    * The minimal depth at which subtree rooted at id has some free space</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id id</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateParentsAlloc</span><span class="params">(<span class="keyword">int</span> id)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">while</span> (id &gt; <span class="number">1</span>) {</span><br><span class="line"> <span class="number">3</span>:         <span class="comment">// è·å¾—çˆ¶èŠ‚ç‚¹çš„ç¼–å·</span></span><br><span class="line"> <span class="number">4</span>:         <span class="keyword">int</span> parentId = id &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line"> <span class="number">5</span>:         <span class="comment">// è·å¾—å­èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line"> <span class="number">6</span>:         <span class="keyword">byte</span> val1 = value(id);</span><br><span class="line"> <span class="number">7</span>:         <span class="comment">// è·å¾—å¦å¤–ä¸€ä¸ªå­èŠ‚ç‚¹çš„</span></span><br><span class="line"> <span class="number">8</span>:         <span class="keyword">byte</span> val2 = value(id ^ <span class="number">1</span>);</span><br><span class="line"> <span class="number">9</span>:         <span class="comment">// è·å¾—å­èŠ‚ç‚¹è¾ƒå°å€¼ï¼Œå¹¶è®¾ç½®åˆ°çˆ¶èŠ‚ç‚¹</span></span><br><span class="line"><span class="number">10</span>:         <span class="keyword">byte</span> val = val1 &lt; val2 ? val1 : val2;</span><br><span class="line"><span class="number">11</span>:         setValue(parentId, val);</span><br><span class="line"><span class="number">12</span>:         <span class="comment">// è·³åˆ°çˆ¶èŠ‚ç‚¹</span></span><br><span class="line"><span class="number">13</span>:         id = parentId;</span><br><span class="line"><span class="number">14</span>:     }</span><br><span class="line"><span class="number">15</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ğŸ˜ˆ æ³¨æ„ï¼Œè°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼ŒèŠ‚ç‚¹ <code>id</code> å·²ç»æ›´æ–°ä¸º<strong>ä¸å¯ç”¨</strong>ã€‚</li>
<li>ç¬¬ 2 è¡Œï¼šå¾ªç¯ï¼Œç›´åˆ°<strong>æ ¹</strong>èŠ‚ç‚¹ã€‚</li>
<li>ç¬¬ 4 è¡Œï¼š<code>&gt;&gt;&gt; 1</code> æ“ä½œï¼Œè·å¾—çˆ¶èŠ‚ç‚¹çš„ç¼–å·ã€‚</li>
<li>ç¬¬ 5 è‡³ 11 è¡Œï¼šè·å¾—å­èŠ‚ç‚¹è¾ƒå°å€¼ï¼Œå¹¶è°ƒç”¨ <code>#setValue(int id, int value)</code> æ–¹æ³•ï¼Œè®¾ç½®åˆ°çˆ¶èŠ‚ç‚¹ã€‚</li>
<li>ç¬¬ 13 è¡Œï¼šè·³åˆ°çˆ¶èŠ‚ç‚¹ã€‚</li>
</ul>
<h3 id="2-4-2-updateParentsFree"><a href="#2-4-2-updateParentsFree" class="headerlink" title="2.4.2 updateParentsFree"></a>2.4.2 updateParentsFree</h3><p><code>#updateParentsAlloc(int id)</code> æ–¹æ³•ï¼Œæ›´æ–°è·å¾—çš„èŠ‚ç‚¹çš„ç¥–å…ˆå¯ç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Update method used by free</span></span><br><span class="line"><span class="comment">    * This needs to handle the special case when both children are completely free</span></span><br><span class="line"><span class="comment">    * in which case parent be directly allocated on request of size = child-size * 2</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> id id</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateParentsFree</span><span class="params">(<span class="keyword">int</span> id)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// è·å¾—å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹çš„å±‚çº§</span></span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">int</span> logChild = depth(id) + <span class="number">1</span>;</span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">while</span> (id &gt; <span class="number">1</span>) {</span><br><span class="line"> <span class="number">5</span>:         <span class="comment">// è·å¾—çˆ¶èŠ‚ç‚¹çš„ç¼–å·</span></span><br><span class="line"> <span class="number">6</span>:         <span class="keyword">int</span> parentId = id &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line"> <span class="number">7</span>:         <span class="comment">// è·å¾—å­èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line"> <span class="number">8</span>:         <span class="keyword">byte</span> val1 = value(id);</span><br><span class="line"> <span class="number">9</span>:         <span class="comment">// è·å¾—å¦å¤–ä¸€ä¸ªå­èŠ‚ç‚¹çš„å€¼</span></span><br><span class="line"><span class="number">10</span>:         <span class="keyword">byte</span> val2 = value(id ^ <span class="number">1</span>);</span><br><span class="line"><span class="number">11</span>:         <span class="comment">// è·å¾—å½“å‰èŠ‚ç‚¹çš„å±‚çº§</span></span><br><span class="line"><span class="number">12</span>:         logChild -= <span class="number">1</span>; <span class="comment">// in first iteration equals log, subsequently reduce 1 from logChild as we traverse up</span></span><br><span class="line"><span class="number">13</span>: </span><br><span class="line"><span class="number">14</span>:         <span class="comment">// ä¸¤ä¸ªå­èŠ‚ç‚¹éƒ½å¯ç”¨ï¼Œåˆ™ç›´æ¥è®¾ç½®çˆ¶èŠ‚ç‚¹çš„å±‚çº§</span></span><br><span class="line"><span class="number">15</span>:         <span class="keyword">if</span> (val1 == logChild &amp;&amp; val2 == logChild) {</span><br><span class="line"><span class="number">16</span>:             setValue(parentId, (<span class="keyword">byte</span>) (logChild - <span class="number">1</span>));</span><br><span class="line"><span class="number">17</span>:         <span class="comment">// ä¸¤ä¸ªå­èŠ‚ç‚¹ä»»ä¸€ä¸å¯ç”¨ï¼Œåˆ™å–å­èŠ‚ç‚¹è¾ƒå°å€¼ï¼Œå¹¶è®¾ç½®åˆ°çˆ¶èŠ‚ç‚¹</span></span><br><span class="line"><span class="number">18</span>:         } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">19</span>:             <span class="keyword">byte</span> val = val1 &lt; val2 ? val1 : val2;</span><br><span class="line"><span class="number">20</span>:             setValue(parentId, val);</span><br><span class="line"><span class="number">21</span>:         }</span><br><span class="line"><span class="number">22</span>: </span><br><span class="line"><span class="number">23</span>:         <span class="comment">// è·³åˆ°çˆ¶èŠ‚ç‚¹</span></span><br><span class="line"><span class="number">24</span>:         id = parentId;</span><br><span class="line"><span class="number">25</span>:     }</span><br><span class="line"><span class="number">26</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ğŸ˜ˆ æ³¨æ„ï¼Œè°ƒç”¨æ­¤æ–¹æ³•æ—¶ï¼ŒèŠ‚ç‚¹ <code>id</code> å·²ç»æ›´æ–°ä¸ºå¯ç”¨ã€‚</li>
<li>ç¬¬ 3 è¡Œï¼šè·å¾—å½“å‰èŠ‚ç‚¹çš„å­èŠ‚ç‚¹çš„å±‚çº§ã€‚</li>
<li>ç¬¬ 4 è¡Œï¼šå¾ªç¯ï¼Œç›´åˆ°<strong>æ ¹</strong>èŠ‚ç‚¹ã€‚</li>
<li>ç¬¬ 6 è¡Œï¼š<code>&gt;&gt;&gt; 1</code> æ“ä½œï¼Œè·å¾—<strong>çˆ¶</strong>èŠ‚ç‚¹çš„ç¼–å·ã€‚</li>
<li>ç¬¬ 7 è‡³ 10 è¡Œï¼šè·å¾—ä¸¤ä¸ª<strong>å­</strong>èŠ‚ç‚¹çš„å€¼ã€‚</li>
<li>ç¬¬ 12 è¡Œï¼šè·å¾—å½“å‰èŠ‚ç‚¹çš„å±‚çº§ã€‚</li>
<li>ç¬¬ 14 è‡³ 16 è¡Œï¼šä¸¤ä¸ªå­èŠ‚ç‚¹éƒ½å¯ç”¨ï¼Œåˆ™è°ƒç”¨ <code>#setValue(id, value)</code> æ–¹æ³•ï¼Œç›´æ¥è®¾ç½®çˆ¶èŠ‚ç‚¹çš„å±‚çº§( æ³¨æ„ï¼Œæ˜¯ <code>logChild - 1</code> )ã€‚</li>
<li>ç¬¬ 17 è‡³ 21 è¡Œï¼šä¸¤ä¸ªå­èŠ‚ç‚¹ä»»ä¸€ä¸å¯ç”¨ï¼Œåˆ™<code>#setValue(id, value)</code> æ–¹æ³•ï¼Œå–å­èŠ‚ç‚¹è¾ƒå°å€¼ï¼Œå¹¶è®¾ç½®åˆ°çˆ¶èŠ‚ç‚¹ã€‚</li>
<li>ç¬¬ 24 è¡Œï¼šè·³åˆ°çˆ¶èŠ‚ç‚¹ã€‚</li>
</ul>
<h2 id="2-5-initBuf"><a href="#2-5-initBuf" class="headerlink" title="2.5 initBuf"></a>2.5 initBuf</h2><p><code>#initBuf(PooledByteBuf&lt;T&gt; buf, long handle, int reqCapacity)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ–åˆ†é…çš„å†…å­˜å—åˆ° PooledByteBuf ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">void</span> <span class="title">initBuf</span><span class="params">(PooledByteBuf&lt;T&gt; buf, <span class="keyword">long</span> handle, <span class="keyword">int</span> reqCapacity)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// è·å¾— memoryMap æ•°ç»„çš„ç¼–å·( ä¸‹æ ‡ )</span></span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">int</span> memoryMapIdx = memoryMapIdx(handle);</span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// è·å¾— bitmap æ•°ç»„çš„ç¼–å·( ä¸‹æ ‡ )ã€‚æ³¨æ„ï¼Œæ­¤æ—¶è·å¾—çš„è¿˜ä¸æ˜¯çœŸæ­£çš„ bitmapIdx å€¼ï¼Œéœ€è¦ç»è¿‡ `bitmapIdx &amp; 0x3FFFFFFF` è¿ç®—ã€‚</span></span><br><span class="line"> <span class="number">5</span>:     <span class="keyword">int</span> bitmapIdx = bitmapIdx(handle);</span><br><span class="line"> <span class="number">6</span>:     <span class="comment">// å†…å­˜å—ä¸º Page</span></span><br><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (bitmapIdx == <span class="number">0</span>) {</span><br><span class="line"> <span class="number">8</span>:         <span class="keyword">byte</span> val = value(memoryMapIdx);</span><br><span class="line"> <span class="number">9</span>:         <span class="keyword">assert</span> val == unusable : String.valueOf(val);</span><br><span class="line"><span class="number">10</span>:         <span class="comment">// åˆå§‹åŒ– Page å†…å­˜å—åˆ° PooledByteBuf ä¸­</span></span><br><span class="line"><span class="number">11</span>:         buf.init(<span class="keyword">this</span>, handle, runOffset(memoryMapIdx) + offset, reqCapacity, runLength(memoryMapIdx), arena.parent.threadCache());</span><br><span class="line"><span class="number">12</span>:     <span class="comment">// å†…å­˜å—ä¸º SubPage</span></span><br><span class="line"><span class="number">13</span>:     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">14</span>:         <span class="comment">// åˆå§‹åŒ– SubPage å†…å­˜å—åˆ° PooledByteBuf ä¸­</span></span><br><span class="line"><span class="number">15</span>:         initBufWithSubpage(buf, handle, bitmapIdx, reqCapacity);</span><br><span class="line"><span class="number">16</span>:     }</span><br><span class="line"><span class="number">17</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šè°ƒç”¨ <code>#memoryMapIdx(handle)</code> æ–¹æ³•ï¼Œè·å¾— <code>memoryMap</code> æ•°ç»„çš„ç¼–å·( ä¸‹æ ‡ )ã€‚</li>
<li>ç¬¬ 5 è¡Œï¼šè°ƒç”¨ <code>#bitmapIdx(handle)</code> æ–¹æ³•ï¼Œè·å¾— <code>bitmap</code> æ•°ç»„çš„ç¼–å·( ä¸‹æ ‡ )ã€‚</li>
<li><p>ç¬¬ 6 è‡³ 11 è¡Œï¼šé€šè¿‡ <code>bitmapIdx == 0</code> åˆ¤æ–­å‡ºï¼Œå†…å­˜å—æ˜¯ Page ã€‚æ‰€ä»¥ï¼Œè°ƒç”¨ <code>PooledByteBuf#init(PoolChunk&lt;T&gt; chunk, long handle, int offset, int length, int maxLength, PoolThreadCache cache)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– Page å†…å­˜å—åˆ° PooledByteBuf ä¸­ã€‚å…¶ä¸­ï¼Œ<code>runOffset(memoryMapIdx) + offset</code> ä»£ç å—ï¼Œè®¡ç®— Page å†…å­˜å—åœ¨ <code>memory</code> ä¸­çš„å¼€å§‹ä½ç½®ã€‚<code>runOffset(int id)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">runOffset</span><span class="params">(<span class="keyword">int</span> id)</span> </span>{</span><br><span class="line">    <span class="comment">// represents the 0-based offset in #bytes from start of the byte-array chunk</span></span><br><span class="line">    <span class="keyword">int</span> shift = id ^ <span class="number">1</span> &lt;&lt; depth(id);</span><br><span class="line">    <span class="keyword">return</span> shift * runLength(id);</span><br><span class="line">}</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">runLength</span><span class="params">(<span class="keyword">int</span> id)</span> </span>{</span><br><span class="line">    <span class="comment">// represents the size in #bytes supported by node 'id' in the tree</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> &lt;&lt; log2ChunkSize - depth(id);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ç¬¬12 è‡³ 16 è¡Œï¼šé€šè¿‡ <code>bitmapIdx != 0</code> åˆ¤æ–­å‡ºï¼Œå†…å­˜å—æ˜¯ SubPage ã€‚æ‰€ä»¥ï¼Œè°ƒç”¨ <code>#initBufWithSubpage(PooledByteBuf&lt;T&gt; buf, long handle, int reqCapacity)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– SubPage å†…å­˜å—åˆ° PooledByteBuf ä¸­ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.5.1 initBufWithSubpageã€</a> ã€‚</p>
</li>
</ul>
<h3 id="2-5-1-initBufWithSubpage"><a href="#2-5-1-initBufWithSubpage" class="headerlink" title="2.5.1 initBufWithSubpage"></a>2.5.1 initBufWithSubpage</h3><p><code>#initBufWithSubpage(PooledByteBuf&lt;T&gt; buf, long handle, int reqCapacity)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– SubPage å†…å­˜å—åˆ° PooledByteBuf ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">initBufWithSubpage</span><span class="params">(PooledByteBuf&lt;T&gt; buf, <span class="keyword">long</span> handle, <span class="keyword">int</span> reqCapacity)</span> </span>{</span><br><span class="line">       initBufWithSubpage(buf, handle, bitmapIdx(handle), reqCapacity);</span><br><span class="line">   }</span><br><span class="line"></span><br><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initBufWithSubpage</span><span class="params">(PooledByteBuf&lt;T&gt; buf, <span class="keyword">long</span> handle, <span class="keyword">int</span> bitmapIdx, <span class="keyword">int</span> reqCapacity)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">assert</span> bitmapIdx != <span class="number">0</span>;</span><br><span class="line"> <span class="number">3</span>: </span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// è·å¾— memoryMap æ•°ç»„çš„ç¼–å·( ä¸‹æ ‡ )</span></span><br><span class="line"> <span class="number">5</span>:     <span class="keyword">int</span> memoryMapIdx = memoryMapIdx(handle);</span><br><span class="line"> <span class="number">6</span>:     <span class="comment">// è·å¾— SubPage å¯¹è±¡</span></span><br><span class="line"> <span class="number">7</span>:     PoolSubpage&lt;T&gt; subpage = subpages[subpageIdx(memoryMapIdx)];</span><br><span class="line"> <span class="number">8</span>:     <span class="keyword">assert</span> subpage.doNotDestroy;</span><br><span class="line"> <span class="number">9</span>:     <span class="keyword">assert</span> reqCapacity &lt;= subpage.elemSize;</span><br><span class="line"><span class="number">10</span>: </span><br><span class="line"><span class="number">11</span>:     <span class="comment">// åˆå§‹åŒ– SubPage å†…å­˜å—åˆ° PooledByteBuf ä¸­</span></span><br><span class="line"><span class="number">12</span>:     buf.init(</span><br><span class="line"><span class="number">13</span>:         <span class="keyword">this</span>, handle,</span><br><span class="line"><span class="number">14</span>:         runOffset(memoryMapIdx) + (bitmapIdx &amp; <span class="number">0x3FFFFFFF</span>) * subpage.elemSize + offset,</span><br><span class="line"><span class="number">15</span>:             reqCapacity, subpage.elemSize, arena.parent.threadCache());</span><br><span class="line"><span class="number">16</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è‡³ 7 è¡Œï¼šè·å¾— SubPage å¯¹è±¡ã€‚</li>
<li>ç¬¬ 11 è‡³äº 15 è¡Œï¼šè°ƒç”¨ <code>PooledByteBuf#init(PoolChunk&lt;T&gt; chunk, long handle, int offset, int length, int maxLength, PoolThreadCache cache)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– SubPage å†…å­˜å—åˆ° PooledByteBuf ä¸­ã€‚å…¶ä¸­ï¼Œ<code>runOffset(memoryMapIdx) + (bitmapIdx &amp; 0x3FFFFFFF) * subpage.elemSize + offset</code> ä»£ç å—ï¼Œè®¡ç®— SubPage å†…å­˜å—åœ¨ <code>memory</code> ä¸­çš„å¼€å§‹ä½ç½®ã€‚</li>
</ul>
<h2 id="2-6-destroy"><a href="#2-6-destroy" class="headerlink" title="2.6 destroy"></a>2.6 destroy</h2><p><code>#destroy()</code> æ–¹æ³•ï¼Œä» Arena ä¸­é”€æ¯å½“å‰ Chunk ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br><span class="line">    arena.destroyChunk(<span class="keyword">this</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-5-Jemalloc-Arena">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆäº”ï¼‰PoolArenaã€‹</a> ã€‚</li>
</ul>
<h2 id="2-7-PoolChunkMetric"><a href="#2-7-PoolChunkMetric" class="headerlink" title="2.7 PoolChunkMetric"></a>2.7 PoolChunkMetric</h2><p><code>io.netty.buffer.PoolChunkMetric</code> ï¼ŒPoolChunk Metric æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PoolChunkMetric</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the percentage of the current usage of the chunk.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">usage</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the size of the chunk in bytes, this is the maximum of bytes that can be served out of the chunk.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">chunkSize</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return the number of free bytes in the chunk.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">freeBytes</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p>PoolChunk å¯¹ PoolChunkMetric æ¥å£çš„å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">usage</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> freeBytes;</span><br><span class="line">    <span class="keyword">synchronized</span> (arena) {</span><br><span class="line">        freeBytes = <span class="keyword">this</span>.freeBytes;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> usage(freeBytes);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">usage</span><span class="params">(<span class="keyword">int</span> freeBytes)</span> </span>{</span><br><span class="line">    <span class="comment">// å…¨éƒ¨ä½¿ç”¨ï¼Œ100%</span></span><br><span class="line">    <span class="keyword">if</span> (freeBytes == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">100</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éƒ¨åˆ†ä½¿ç”¨ï¼Œæœ€é«˜ 99%</span></span><br><span class="line">    <span class="keyword">int</span> freePercentage = (<span class="keyword">int</span>) (freeBytes * <span class="number">100L</span> / chunkSize);</span><br><span class="line">    <span class="keyword">if</span> (freePercentage == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">99</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">100</span> - freePercentage;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">chunkSize</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> chunkSize;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">freeBytes</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">synchronized</span> (arena) {</span><br><span class="line">        <span class="keyword">return</span> freeBytes;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><code>synchronized</code> çš„åŸå› æ˜¯ï¼Œä¿è¯ <code>freeBytes</code> å¯¹å…¶å®ƒçº¿ç¨‹çš„å¯è§æ€§ã€‚å¯¹åº” Github æäº¤ä¸º <a href="https://github.com/netty/netty/commit/a7fe6c01539d3ad92d7cd94a25daff9e10851088" rel="external nofollow noopener noreferrer" target="_blank">a7fe6c01539d3ad92d7cd94a25daff9e10851088</a> ã€‚</p>
<blockquote>
<p><strong>Motivation</strong>:</p>
<p>As we may access the metrics exposed of PooledByteBufAllocator from another thread then the allocations happen we need to ensure we synchronize on the PoolArena to ensure correct visibility.</p>
<p><strong>Modifications</strong>:</p>
<p>Synchronize on the PoolArena to ensure correct visibility.</p>
<p><strong>Result</strong>:</p>
<p>Fix multi-thread issues on the metrics</p>
</blockquote>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>è€è‰¿è‰¿æœ‰ç‚¹äºŒï¼Œåœ¨ <code>#allocateNode(int normCapacity)</code> æ–¹æ³•å¡äº†å¾ˆä¹…ã€‚å› ä¸ºæ²¡çœ‹åˆ° <code>memoryMap</code> å’Œ <code>depthMap</code> æ•°ç»„ï¼Œä¸‹æ ‡æ˜¯ä» 1 å¼€å§‹çš„ï¼ï¼ï¼æˆ‘æ¨é‚£ã€‚</p>
<p>å‚è€ƒå¦‚ä¸‹æ–‡ç« ï¼š</p>
<ul>
<li>å å°ç‹¼ <a href="https://www.jianshu.com/p/c4bd37a3555b" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥æµ…å‡ºNettyå†…å­˜ç®¡ç† PoolChunkã€‹</a></li>
<li>Hypercube <a href="https://www.jianshu.com/p/70181af2972a" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆåï¼‰â€“PoolChunkã€‹</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/ByteBuf-3-2-Jemalloc-chunk/" data-id="ck4pl3fp700e7fgcfqrbzod6p" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>