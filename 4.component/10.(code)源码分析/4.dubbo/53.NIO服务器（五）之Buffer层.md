# NIO æœåŠ¡å™¨ï¼ˆäº”ï¼‰ä¹‹ Buffer å±‚

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚

# 1. æ¦‚è¿°

æœ¬æ–‡æ¥ [ã€Šç²¾å°½ Dubbo æºç åˆ†æ â€”â€” NIO æœåŠ¡å™¨ï¼ˆå››ï¼‰ä¹‹ Exchange å±‚ã€‹](http://svip.iocoder.cn/Dubbo/remoting-api-exchange//?self) ä¸€æ–‡ï¼Œåˆ†äº«

dubbo-remoting-api
æ¨¡å—ï¼Œ

buffer
åŒ…ï¼Œ**Buffer å±‚**ã€‚

Buffer åœ¨ NIO æ¡†æ¶ä¸­ï¼Œæ‰®æ¼”éå¸¸é‡è¦çš„è§’è‰²ï¼ŒåŸºæœ¬æ¯ä¸ªåº“éƒ½æä¾›äº†è‡ªå·±çš„ Buffer å®ç°ï¼Œä¾‹å¦‚ï¼š

* Java NIO çš„

java.nio.ByteBuffer
* Mina çš„

org.apache.mina.core.buffer.IoBuffer
* Netty4 çš„

io.netty.buffer.ByteBuf

åœ¨

dubbo-remoting-api
çš„

buffer
åŒ…ä¸­ï¼Œä¸€æ–¹é¢å®šä¹‰äº† ChannelBuffer å’Œ ChannelBufferFactory çš„æ¥å£ï¼ŒåŒæ—¶æä¾›äº†å¤šç§é»˜è®¤çš„å®ç°ã€‚æ•´ä½“ç±»å›¾å¦‚ä¸‹ï¼š

![ç±»å›¾](http://static2.iocoder.cn/images/Dubbo/2018_12_13/01.png)

* å…¶ä¸­ï¼Œçº¢æ¡†éƒ¨åˆ†ï¼Œæ˜¯ Netty3 å’Œ Netty4 ï¼Œå®ç°çš„è‡ªå®šä¹‰çš„ ChannelBuffer å’Œ ChannelBufferFactory ç±»ã€‚

# 2. ChannelBuffer

[
com.alibaba.dubbo.remoting.buffer.ChannelBuffer
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/ChannelBuffer.java) ï¼Œå®ç° Comparable æ¥å£ï¼Œ**é€šé“ Buffer** æ¥å£ã€‚

ChannelBuffer åœ¨æ¥å£æ–¹æ³•çš„å®šä¹‰ä¸Šï¼Œä¸»è¦å‚è€ƒäº† Netty çš„ ByteBuf è¿›è¡Œè®¾è®¡ï¼Œæ‰€ä»¥æ¥å£å’Œæ³¨é‡ŠåŸºæœ¬ä¸€è‡´ï¼Œæœ¬æ–‡å°±ä¸ä¸€ä¸ªä¸€ä¸ªç»†è®²è¿‡å»ï¼Œèƒ–å‹å¯ä»¥çœ‹ï¼š

* è‹±æ–‡ï¼š[ã€ŠNetty4.1 ByteBuf APIã€‹](https://netty.io/4.1/api/io/netty/buffer/ByteBuf.html)
* ä¸­æ–‡ï¼š[ã€Šæ·±å…¥ç ”ç©¶Nettyæ¡†æ¶ä¹‹ByteBufåŠŸèƒ½åŸç†åŠæºç åˆ†æã€‹](https://my.oschina.net/7001/blog/742236)

ç‹¬æœ‰çš„æ¥å£æ–¹æ³•

/#factory()
æ–¹æ³•ï¼Œç”¨äºé€»è¾‘ä¸­ï¼Œéœ€è¦åˆ›å»º ChannelBuffer çš„æƒ…å†µã€‚

* ä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* Returns the factory which creates a {@link ChannelBuffer} whose type and
/* default {@link java.nio.ByteOrder} are same with this buffer.
/*/
ChannelBufferFactory factory()
```
* è°ƒç”¨æ–¹å¦‚ä¸‹ï¼š![è°ƒç”¨æ–¹](http://static2.iocoder.cn/images/Dubbo/2018_12_13/02.png)

## 2.1 AbstractChannelBuffer

[
com.alibaba.dubbo.remoting.buffer.AbstractChannelBuffer
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/AbstractChannelBuffer.java) ï¼Œå®ç° ChannelBuffer æ¥å£ï¼Œé€šé“ Buffer **æŠ½è±¡ç±»**ã€‚

**æ„é€ æ–¹æ³•**
```
//*/*
/* è¯»å–ä½ç½®
/*/
private int readerIndex;
//*/*
/* å†™å…¥ä½ç½®
/*/
private int writerIndex;
//*/*
/* æ ‡è®°çš„è¯»å–ä½ç½®
/*/
private int markedReaderIndex;
//*/*
/* æ ‡è®°çš„å†™å…¥ä½ç½®
/*/
private int markedWriterIndex;
```  
FROM [ã€Šnettyçš„ByteBufã€‹](https://blog.csdn.net/zhxdick/article/details/51187362)
writerIndex å’Œ readerIndex

* åˆå§‹çŠ¶æ€ï¼š
![](http://static2.iocoder.cn/images/Dubbo/2018_12_13/05.png)
* å½“å†™å…¥5ä¸ªå­—èŠ‚åï¼š
![](http://static2.iocoder.cn/images/Dubbo/2018_12_13/06.png)

è¿™æ—¶ï¼ŒwriterIndex ä¸º 5ï¼Œè¿™æ—¶å¦‚æœå¼€å§‹è¯»å–ï¼Œé‚£ä¹ˆè¿™ä¸ª writerIndex å¯ä»¥ä½œä¸ºä¸Šé¢ByteBuffer flip ä¹‹åçš„ limitã€‚

* å½“è¯»å–3ä¸ªå­—èŠ‚åï¼š
![](http://static2.iocoder.cn/images/Dubbo/2018_12_13/07.png)

**å®ç°æ–¹æ³•**

åœ¨ AbstractChannelBuffer å®ç°çš„æ–¹æ³•ï¼Œéƒ½æ˜¯**é‡è½½**çš„æ–¹æ³•ï¼ŒçœŸæ­£**å®è´¨**çš„æ–¹æ³•ï¼Œéœ€è¦å­ç±»æ¥å®ç°ã€‚ä»¥

/#getBytes(...)
æ–¹æ³•ï¼Œä¸¾ä¾‹å­ï¼š
```
@Override
public void getBytes(int index, ChannelBuffer dst, int length){
if (length > dst.writableBytes()) {
throw new IndexOutOfBoundsException();
}
getBytes(index, dst, dst.writerIndex(), length);
dst.writerIndex(dst.writerIndex() + length);
}
```

* æ–¹æ³•ä¸­è°ƒç”¨çš„

/#getBytes(index, ds, dstIndex, length)
æ–¹æ³•ï¼Œå¹¶æœªå®ç°ã€‚ğŸ™‚ **ä¸ºå•¥å‘¢**ï¼Ÿ**å®è´¨**çš„æ–¹æ³•ï¼Œæ¶‰åŠåˆ°å­—èŠ‚æ•°ç»„çš„**å®ç°å½¢å¼**ã€‚

å¦‚ä¸‹æ˜¯æ‰€æœ‰**æœªå®ç°**çš„æ–¹æ³•ï¼š![æœªå®ç°æ–¹æ³•](http://static2.iocoder.cn/images/Dubbo/2018_12_13/03.png)

## 2.2 ByteBufferBackedChannelBuffer

[
com.alibaba.dubbo.remoting.buffer.ByteBufferBackedChannelBuffer
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/ByteBufferBackedChannelBuffer.java) ï¼Œå®ç° AbstractChannelBuffer æŠ½è±¡ç±»ï¼ŒåŸºäº **java.nio.ByteBuffer** çš„ Buffer å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**
```
//*/*
/* buffer
/* java.nio.ByteBuffer
/*/
private final ByteBuffer buffer;
//*/*
/* å®¹é‡
/*/
private final int capacity;
public ByteBufferBackedChannelBuffer(ByteBuffer buffer){
if (buffer == null) {
throw new NullPointerException("buffer");
}
// buffer
this.buffer = buffer.slice();
// å®¹é‡
capacity = buffer.remaining();
// è®¾ç½® `writerIndex`
writerIndex(capacity);
}
public ByteBufferBackedChannelBuffer(ByteBufferBackedChannelBuffer buffer){
// buffer
this.buffer = buffer.buffer;
// å®¹é‡
capacity = buffer.capacity;
// è®¾ç½® `writerIndex` `readerIndex`
setIndex(buffer.readerIndex(), buffer.writerIndex());
}
```

**å·¥å‚**

```
@Override
public ChannelBufferFactory factory(){
if (buffer.isDirect()) {
return DirectChannelBufferFactory.getInstance();
} else {
return HeapChannelBufferFactory.getInstance();
}
}
```

* å¯¹åº”çš„å·¥å‚æ˜¯ DirectChannelBufferFactory æˆ– HeapChannelBufferFactory ã€‚

**å®ç°æ–¹æ³•**

èƒ–å‹ï¼Œè‡ªå·±æŸ¥çœ‹ã€‚

## 2.3 HeapChannelBuffer

[
com.alibaba.dubbo.remoting.buffer.HeapChannelBuffer
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/HeapChannelBuffer.java) ï¼Œå®ç° AbstractChannelBuffer æŠ½è±¡ç±»ï¼ŒåŸºäº**å­—èŠ‚æ•°ç»„**çš„ Buffer å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**
```
//*/*
/* The underlying heap byte array that this buffer is wrapping.
/* å­—èŠ‚æ•°ç»„
/*/
protected final byte[] array;
public HeapChannelBuffer(int length){
this(new byte[length], 0, 0);
}
public HeapChannelBuffer(byte[] array){
this(array, 0, array.length);
}
protected HeapChannelBuffer(byte[] array, int readerIndex, int writerIndex){
if (array == null) {
throw new NullPointerException("array");
}
this.array = array;
setIndex(readerIndex, writerIndex);
}
```

**å·¥å‚**

```
@Override
public ChannelBufferFactory factory(){
return HeapChannelBufferFactory.getInstance();
}
```

* å¯¹åº”çš„å·¥å‚æ˜¯ HeapChannelBufferFactory ã€‚

**å®ç°æ–¹æ³•**

èƒ–å‹ï¼Œè‡ªå·±æŸ¥çœ‹ã€‚

## 2.4 DynamicChannelBuffer

[
com.alibaba.dubbo.remoting.buffer.DynamicChannelBuffer
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/DynamicChannelBuffer.java) ï¼Œå®ç° AbstractChannelBuffer æŠ½è±¡ç±»ï¼ŒåŸºäº**åŠ¨æ€**çš„ Buffer å®ç°ç±»ã€‚æˆ–è€…è¯´ï¼ŒåŸºäºä¼ å…¥çš„ ChannelBufferFactory çš„ Buffer å®ç°ç±»ã€‚

**æ„é€ æ–¹æ³•**
```
//*/*
/* å·¥å‚
/*/
private final ChannelBufferFactory factory;
//*/*
/* Buffer
/*/
private ChannelBuffer buffer;
public DynamicChannelBuffer(int estimatedLength){
this(estimatedLength, HeapChannelBufferFactory.getInstance()); // é»˜è®¤ HeapChannelBufferFactory
}
public DynamicChannelBuffer(int estimatedLength, ChannelBufferFactory factory){
if (estimatedLength < 0) {
throw new IllegalArgumentException("estimatedLength: " + estimatedLength);
}
if (factory == null) {
throw new NullPointerException("factory");
}
// è®¾ç½® `factory`
this.factory = factory;
// åˆ›å»º `buffer`
buffer = factory.getBuffer(estimatedLength);
}
```

**å·¥å‚**

```
@Override
public ChannelBufferFactory factory(){
return factory;
}
```

**å®ç°æ–¹æ³•**

æ¯ä¸ªæ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨

buffer
å¯¹åº”çš„æ–¹æ³•ã€‚

# 3. ChannelBuffers

[
com.alibaba.dubbo.remoting.buffer.ChannelBuffers
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/ChannelBuffers.java) ï¼ŒBuffer **å·¥å…·ç±»**ï¼Œæä¾›åˆ›å»ºã€æ¯”è¾ƒ ChannelBuffer ç­‰å…¬ç”¨æ–¹æ³•ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š![ChannelBuffers](http://static2.iocoder.cn/images/Dubbo/2018_12_13/04.png)

# 4. ChannelBufferFactory

com.alibaba.dubbo.remoting.buffer.ChannelBufferFactory
ï¼Œ**é€šé“ Buffer å·¥å‚**æ¥å£ã€‚æ–¹æ³•å¦‚ä¸‹ï¼š
```
ChannelBuffer getBuffer(int capacity);
ChannelBuffer getBuffer(byte[] array, int offset, int length);
ChannelBuffer getBuffer(ByteBuffer nioBuffer); // java.nio.ByteBuffer
```

## 4.1 DirectChannelBufferFactory

[
com.alibaba.dubbo.remoting.buffer.DirectChannelBufferFactory
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/DirectChannelBufferFactory.java) ï¼Œå®ç° ChannelBufferFactory æ¥å£ï¼Œåˆ›å»º DirectChannelBuffer çš„å·¥å‚ã€‚

å®ç°æ¯”è¾ƒç®€å•ï¼Œä»£ç å·²ç»åŠ æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚

## 4.2 HeapChannelBufferFactory

[
com.alibaba.dubbo.remoting.buffer.HeapChannelBufferFactory
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/HeapChannelBufferFactory.java) ï¼Œå®ç° ChannelBufferFactory æ¥å£ï¼Œåˆ›å»º HeapChannelBufferFactory çš„å·¥å‚ã€‚

å®ç°æ¯”è¾ƒç®€å•ï¼Œä»£ç å·²ç»åŠ æ³¨é‡Šï¼Œèƒ–å‹è‡ªå·±æŸ¥çœ‹ã€‚

# 5. IO

å®é™… IO æ“ä½œï¼Œæ˜¯åŸºäº InputStream å’Œ OutputStream ï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨å‰æ–‡çœ‹åˆ°çš„ Serialization åºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š
```
// ... çœç•¥å…¶ä»–æ–¹æ³•
ObjectOutput serialize(URL url, OutputStream output) throws IOException;
ObjectInput deserialize(URL url, InputStream input) throws IOException;
```

æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦å°† ChannelBuffer è¿›è¡Œè£…é¥°ã€‚

å¦å¤–ï¼Œæˆ‘ä»¬åœ¨å›è¿‡å¤´æ¥çœ‹çœ‹ Codec å’Œ Codec2 æ¥å£ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š
```
// Codec.java
void encode(Channel channel, OutputStream output, Object message) throws IOException;
// Codec2.java
void encode(Channel channel, ChannelBuffer buffer, Object message) throws IOException;
// Codec.java
Object decode(Channel channel, InputStream input) throws IOException;
// Codec2.java
Object decode(Channel channel, ChannelBuffer buffer) throws IOException
```

ä¸€ä¸ªå˜åŒ–ç‚¹ï¼Œå°±æ˜¯å°† OutputStream å’Œ InputStream ï¼Œæ›¿æ¢æˆäº† ChannelBuffer ï¼Œæ›´å¥½çš„ä»¥ ChannelBuffer ä¸ºæ ¸å¿ƒï¼Œä¸å…¶ä»–æ¡†æ¶æ•´åˆã€‚

## 5.1 ChannelBufferInputStream

[
com.alibaba.dubbo.remoting.buffer.ChannelBufferInputStream
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/ChannelBufferInputStream.java) ï¼Œå®ç° InputStream æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
public class ChannelBufferInputStream extends InputStream{
private final ChannelBuffer buffer;
//*/*
/* å¼€å§‹ä½ç½®
/*/
private final int startIndex;
//*/*
/* ç»“æŸä½ç½®
/*/
private final int endIndex;
public ChannelBufferInputStream(ChannelBuffer buffer){
this(buffer, buffer.readableBytes());
}
public ChannelBufferInputStream(ChannelBuffer buffer, int length){
if (buffer == null) {
throw new NullPointerException("buffer");
}
if (length < 0) {
throw new IllegalArgumentException("length: " + length);
}
if (length > buffer.readableBytes()) {
throw new IndexOutOfBoundsException();
}
this.buffer = buffer;
startIndex = buffer.readerIndex();
endIndex = startIndex + length;
buffer.markReaderIndex();
}
// ... çœç•¥ä» buffer è¯»å–çš„æ–¹æ³•ï¼Œèƒ–å‹ï¼Œè‡ªå·±æŸ¥çœ‹ã€‚
}
```

## 5.2 ChannelBufferOutputStream

[
com.alibaba.dubbo.remoting.buffer.ChannelBufferOutputStream
](https://github.com/YunaiV/dubbo/blob/master/dubbo-remoting/dubbo-remoting-api/src/main/java/com/alibaba/dubbo/remoting/buffer/ChannelBufferOutputStream.java) ï¼Œå®ç° OutputStream æ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
public class ChannelBufferOutputStream extends OutputStream{
private final ChannelBuffer buffer;
//*/*
/* å¼€å§‹ä½ç½®
/*/
private final int startIndex;
public ChannelBufferOutputStream(ChannelBuffer buffer){
if (buffer == null) {
throw new NullPointerException("buffer");
}
this.buffer = buffer;
startIndex = buffer.writerIndex();
}
// ... çœç•¥å‘ buffer å†™å…¥çš„æ–¹æ³•ï¼Œèƒ–å‹ï¼Œè‡ªå·±æŸ¥çœ‹ã€‚
}
```