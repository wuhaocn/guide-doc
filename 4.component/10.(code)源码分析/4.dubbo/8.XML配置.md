# XML é…ç½®

æœ¬æ–‡åŸºäº Dubbo 2.6.1 ç‰ˆæœ¬ï¼Œæœ›çŸ¥æ‚‰ã€‚
 
å‹æƒ…æç¤ºï¼Œã€**é…ç½®**ã€‘è¿™å—çš„å†…å®¹ï¼Œä¼šç›¸å¯¹æ¯”è¾ƒæ¯ç‡¥ã€‚æ‰€ä»¥ï¼Œå¦‚æœçœ‹åˆ°ä¸€äº›å¾ˆéš¾æ‡‚çš„åœ°æ–¹ï¼Œå»ºè®®å…ˆè·³è¿‡ã€‚

å¯¹äº Dubbo ï¼Œé‡ç‚¹æ˜¯è¦å»ç†è§£ï¼Œå¤šåè®®ã€RPCã€å®¹é”™ç­‰ç­‰æ¨¡å—ï¼Œè€Œä¸æ˜¯ã€**é…ç½®**ã€‘ã€‚

ğŸ˜ˆ ä¼°è®¡å¥½å¤šèƒ–å‹è¢«ã€**é…ç½®**ã€‘è¿™ç« åŠé€€äº†æŠŠï¼Ÿï¼Ÿï¼Ÿ

# 1. æ¦‚è¿°

åœ¨ Dubbo æä¾›çš„å‡ ç§æ–¹å¼ä¸­ï¼Œ**XML é…ç½®**è‚¯å®šæ˜¯å¤§å®¶æœ€ç†Ÿæ‚‰çš„æ–¹å¼ã€‚

å¦‚æœèƒ–å‹ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥æŸ¥çœ‹å¦‚ä¸‹æ–‡æ¡£ï¼š

* [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” XML é…ç½®ã€‹](http://dubbo.apache.org/zh-cn/docs/user/configuration/xml.html)
* [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” schema é…ç½®å‚è€ƒæ‰‹å†Œã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/xml/introduction.html)

XML é…ç½®ï¼Œè‡ªå®šä¹‰

<dubbo: />
æ ‡ç­¾ï¼ŒåŸºäº **Spring XML** è¿›è¡Œè§£æã€‚å¦‚æœä¸äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥æŸ¥çœ‹å¦‚ä¸‹æ–‡æ¡£ï¼š

* [ã€ŠSpring æºç é˜…è¯» â€”â€” XML æ–‡ä»¶é»˜è®¤æ ‡ç­¾çš„è§£æã€‹](https://gavinzhang1.gitbooks.io/spring/content/xmlwen_jian_mo_ren_biao_qian_de_jie_xi.html)
* [ã€ŠSpring æºç é˜…è¯» â€”â€” XML è‡ªå®šä¹‰æ ‡ç­¾çš„è§£æã€‹](https://gavinzhang1.gitbooks.io/spring/content/xmlzi_ding_yi_biao_qian_de_jie_xi.html)

# 2. å®šä¹‰

## 2.1 sprng.schemas

Dubbo åœ¨

dubbo-spring-config
çš„ [
META-INF/spring.schemas
](https://github.com/YunaiV/dubbo/blob/05dd4fe091e37d08e01d4e243e3fc24dbfdc61ff/dubbo-config/dubbo-config-spring/src/main/resources/META-INF/spring.schemas) å®šä¹‰å¦‚ä¸‹ï¼š
```
http\://code.alibabatech.com/schema/dubbo/dubbo.xsd=META-INF/dubbo.xsd
```

* xmlns
ä¸º

http://code.alibabatech.com/schema/dubbo
* xsd
ä¸º

META-INF/dubbo.xsd

## 2.2 dubbo.xsd

[
dubbo.xsd
](https://github.com/YunaiV/dubbo/blob/05dd4fe091e37d08e01d4e243e3fc24dbfdc61ff/dubbo-config/dubbo-config-spring/src/main/resources/META-INF/dubbo.xsd) å®šä¹‰å¦‚ä¸‹ï¼š

![dubbo.xsd](http://static2.iocoder.cn/images/Dubbo/2018_01_19/01.png)

* <xsd:element name="" />
ï¼Œå®šä¹‰äº†**å…ƒç´ çš„åç§°**ã€‚ä¾‹å¦‚ï¼Œ

<xsd:element name="application" />
å¯¹åº”

<dubbo:application />
ã€‚
* <xsd:element type="" />
ï¼Œå®šä¹‰äº†**å†…å»ºæ•°æ®ç±»å‹çš„åç§°**ã€‚ä¾‹å¦‚ï¼Œ

<xsd:element type="applicationType" />
å¯¹åº”

<xsd:complexType name="applicationType" />
ã€‚
* <xsd:complexType name="">
ï¼Œå®šä¹‰äº†**å¤æ‚ç±»å‹**ã€‚ä¾‹å¦‚

<xsd:complexType name="applicationType" />
å¦‚ä¸‹ï¼š

![applicationType](http://static2.iocoder.cn/images/Dubbo/2018_01_19/02.png)

## 2.3 spring.handlers

[
spring.handlers
](https://github.com/YunaiV/dubbo/blob/05dd4fe091e37d08e01d4e243e3fc24dbfdc61ff/dubbo-config/dubbo-config-spring/src/main/resources/META-INF/spring.handlers) å®šä¹‰å¦‚ä¸‹ï¼š
```
http\://code.alibabatech.com/schema/dubbo=com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandler
```

* å®šä¹‰äº† Dubbo çš„ XML Namespace çš„å¤„ç†å™¨ DubboNamespaceHandler ã€‚

## 2.4 DubboNamespaceHandler

[
com.alibaba.dubbo.config.spring.schema.DubboNamespaceHandler
](https://github.com/YunaiV/dubbo/blob/025ac8b49c7608b0a76ea7bd8c2de6c72138b5ef/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboNamespaceHandler.java) ï¼Œå®ç°

org.springframework.beans.factory.xml.NamespaceHandlerSupport
**æŠ½è±¡ç±»**ï¼ŒDubbo çš„ XML Namespace çš„å¤„ç†å™¨ã€‚

åœ¨ [
/#init()
](https://github.com/YunaiV/dubbo/blob/6cd9a5b53ca8f86de7eac4e978c1f2d13c439845/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboNamespaceHandler.java#L36-L49) æ–¹æ³•ï¼Œå®šä¹‰äº†æ¯ä¸ª

<xsd:element />
å¯¹åº”çš„

org.springframework.beans.factory.xml.BeanDefinitionParser
ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
@Override
public void init(){
registerBeanDefinitionParser("application", new DubboBeanDefinitionParser(ApplicationConfig.class, true));
registerBeanDefinitionParser("module", new DubboBeanDefinitionParser(ModuleConfig.class, true));
registerBeanDefinitionParser("registry", new DubboBeanDefinitionParser(RegistryConfig.class, true));
registerBeanDefinitionParser("monitor", new DubboBeanDefinitionParser(MonitorConfig.class, true));
registerBeanDefinitionParser("provider", new DubboBeanDefinitionParser(ProviderConfig.class, true));
registerBeanDefinitionParser("consumer", new DubboBeanDefinitionParser(ConsumerConfig.class, true));
registerBeanDefinitionParser("protocol", new DubboBeanDefinitionParser(ProtocolConfig.class, true));
registerBeanDefinitionParser("service", new DubboBeanDefinitionParser(ServiceBean.class, true));
registerBeanDefinitionParser("reference", new DubboBeanDefinitionParser(ReferenceBean.class, false));
registerBeanDefinitionParser("annotation", new AnnotationBeanDefinitionParser()); // åºŸå¼ƒ
}
```

* ç»†å¿ƒçš„èƒ–å‹ï¼Œä¼šçœ‹åˆ°

service
æ ‡ç­¾ä½¿ç”¨çš„æ˜¯ ServiceBean ï¼Œè€Œä¸æ˜¯ ServiceConfig ï¼Œ

reference
è¡¨ç¤ºç”¨çš„æ˜¯ ReferenceBean ï¼Œå› ä¸ºæ— è®ºæ˜¯ ServiceConfig è¿˜æ˜¯ ReferenceBean ï¼Œåœ¨è§£æå®Œå…·ä½“é…ç½®åï¼Œéœ€è¦è°ƒç”¨å®ƒä»¬å¯¹åº”çš„æ–¹æ³•è¿›è¡Œ**åˆå§‹åŒ–**ã€‚ğŸ™‚ è€ƒè™‘åˆ°ç¯‡å¹…ï¼Œæˆ‘ä»¬åœ¨åç»­æ–‡ç« åˆ†äº«ã€‚è¿™ç¯‡æˆ‘ä»¬é‡ç‚¹æ”¾åœ¨**è§£æ**ã€‚

# 3. è§£æ

[
com.alibaba.dubbo.config.spring.schema.DubboBeanDefinitionParser
](http://svip.iocoder.cn/Dubbo/configuration-xml/DubboBeanDefinitionParser) ï¼Œå®ç°

org.springframework.beans.factory.xml.BeanDefinitionParser
**æ¥å£**ï¼ŒDubbo Bean å®šä¹‰è§£æå™¨ã€‚

## 3.1 æ„é€ æ–¹æ³•

[æ„é€ æ–¹æ³•](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L62-L74) ï¼Œä»£ç å¦‚ä¸‹ï¼š
```
//*/*
/* Bean å¯¹è±¡çš„ç±»
/*/
private final Class<?> beanClass;
//*/*
/* æ˜¯å¦éœ€è¦ Bean çš„ `id` å±æ€§
/*/
private final boolean required;
public DubboBeanDefinitionParser(Class<?> beanClass, boolean required){
this.beanClass = beanClass;
this.required = required;
}
```

* beanClass
ï¼ŒBean å¯¹è±¡çš„**ç±»**ã€‚
* required
ï¼Œæ˜¯å¦éœ€è¦åœ¨ Bean å¯¹è±¡çš„ç¼–å·(

id
) ä¸å­˜åœ¨æ—¶ï¼Œ**è‡ªåŠ¨ç”Ÿæˆç¼–å·**ã€‚æ— éœ€è¢«å…¶ä»–åº”ç”¨å¼•ç”¨çš„é…ç½®å¯¹è±¡ï¼Œæ— éœ€è‡ªåŠ¨ç”Ÿæˆç¼–å·ã€‚ä¾‹å¦‚æœ‰

<dubbo:reference />
ã€‚

## 3.2 è§£ææ–¹æ³•ã€ä¸»æµç¨‹ã€‘

[
/#parse(Element, ParserContext)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L516-L518) æ–¹æ³•ï¼Œè§£æ XML å…ƒç´ ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
public BeanDefinition parse(Element element, ParserContext parserContext){
return parse(element, parserContext, beanClass, required);
}
```

* è°ƒç”¨ [
/#parse(Element, ParserContext, beanClass, required)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L76-L292) æ–¹æ³•ï¼Œ**çœŸæ­£**è§£æ XML å…ƒç´ ã€‚è¯¥æ–¹æ³•ååˆ†å†—é•¿ï¼Œè¿‘ 200+ è¡Œã€‚å¦å¤–ç®—ä¸Šå†…éƒ¨ä¼šè°ƒç”¨å…¶ä»–æ–¹æ³•ï¼Œæ•´ä½“ 500+ è¡Œå·¦å³ã€‚ğŸ™‚ ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥å°†æ–¹æ³•åˆ‡æ¢ç†è§£ã€‚
å‹æƒ…æç¤ºï¼šå»ºè®®èƒ–å‹ï¼Œèƒ½å¤Ÿè¾¹çœ‹è¾¹è°ƒè¯•ã€‚

### 3.2.1 åˆ›å»º RootBeanDefinition

[
/#parse(Element, ParserContext, beanClass, required)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L76-L292) çš„ç¬¬ 78 è‡³ 80 è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š
```
RootBeanDefinition beanDefinition = new RootBeanDefinition();
beanDefinition.setBeanClass(beanClass);
beanDefinition.setLazyInit(false);
```

* é»˜è®¤

lazyInit = false
ã€‚
FROM [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” XML é…ç½®ã€‹](http://dubbo.apache.org/zh-cn/docs/user/configuration/xml.html)
å¼•ç”¨ç¼ºçœæ˜¯å»¶è¿Ÿåˆå§‹åŒ–çš„ï¼Œåªæœ‰å¼•ç”¨è¢«æ³¨å…¥åˆ°å…¶å®ƒ Beanï¼Œæˆ–è¢« getBean() è·å–ï¼Œæ‰ä¼šåˆå§‹åŒ–ã€‚å¦‚æœéœ€è¦é¥¥é¥¿åŠ è½½ï¼Œå³æ²¡æœ‰äººå¼•ç”¨ä¹Ÿç«‹å³ç”ŸæˆåŠ¨æ€ä»£ç†ï¼Œå¯ä»¥é…ç½®ï¼š

<dubbo:reference ... init="true" />

### 3.2.2 å¤„ç† Bean çš„ç¼–å·

[
/#parse(Element, ParserContext, beanClass, required)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L81-L111) çš„ç¬¬ 81 è‡³ 111 è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š
```
81: // è§£æé…ç½®å¯¹è±¡çš„ id ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œç”Ÿæˆã€‚
82: String id = element.getAttribute("id");
83: if ((id == null || id.length() == 0) && required) {
84: // ç”Ÿæˆ id ã€‚ä¸åŒçš„é…ç½®å¯¹è±¡ï¼Œä¼šå­˜åœ¨ä¸åŒã€‚
85: String generatedBeanName = element.getAttribute("name");
86: if (generatedBeanName == null || generatedBeanName.length() == 0) {
87: if (ProtocolConfig.class.equals(beanClass)) {
88: generatedBeanName = "dubbo";
89: } else {
90: generatedBeanName = element.getAttribute("interface");
91: }
92: }
93: if (generatedBeanName == null || generatedBeanName.length() == 0) {
94: generatedBeanName = beanClass.getName();
95: }
96: id = generatedBeanName;
97: // è‹¥ id å·²å­˜åœ¨ï¼Œé€šè¿‡è‡ªå¢åºåˆ—ï¼Œè§£å†³é‡å¤ã€‚
98: int counter = 2;
99: while (parserContext.getRegistry().containsBeanDefinition(id)) {
100: id = generatedBeanName + (counter++);
101: }
102: }
103: if (id != null && id.length() > 0) {
104: if (parserContext.getRegistry().containsBeanDefinition(id)) {
105: throw new IllegalStateException("Duplicate spring bean id " + id);
106: }
107: // æ·»åŠ åˆ° Spring çš„æ³¨å†Œè¡¨
108: parserContext.getRegistry().registerBeanDefinition(id, beanDefinition);
109: // è®¾ç½® Bean çš„ `id` å±æ€§å€¼
110: beanDefinition.getPropertyValues().addPropertyValue("id", id);
111: }
```

* ç¬¬ 82 è‡³ 102 è¡Œï¼šè§£æ Bean çš„

id
ã€‚è‹¥ä¸å­˜åœ¨ï¼Œåˆ™è‡ªåŠ¨è¿›è¡Œç”Ÿæˆã€‚

* ç¬¬ 85 è‡³ 96 è¡Œï¼šç”Ÿæˆ

id
ã€‚è§„åˆ™ä¸º

name
> ç‰¹æ®Šè§„åˆ™ >

className
ã€‚
* ç¬¬ 97 è‡³ 101 è¡Œï¼šè‹¥

id
åœ¨ Spring æ³¨å†Œè¡¨å·²ç»å­˜åœ¨ï¼Œé€šè¿‡æ·»åŠ **è‡ªå¢åºåˆ—**ä½œä¸ºåç¼€ï¼Œé¿å…å†²çªã€‚
* ç¬¬ 108 è¡Œï¼šæ·»åŠ  Bean åˆ° Spring æ³¨å†Œè¡¨ã€‚
* ç¬¬ 110 è¡Œï¼šè®¾ç½® Bean çš„

id
ã€‚

### 3.2.3 å¤„ç†

<dubbo:protocol/>
ç‰¹æ®Šæƒ…å†µ

[
/#parse(Element, ParserContext, beanClass, required)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L113-L128) çš„ç¬¬ 113 è‡³ 128 è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š
```
113: // å¤„ç† `<dubbo:protocol` /> çš„ç‰¹æ®Šæƒ…å†µ
114: if (ProtocolConfig.class.equals(beanClass)) {
115: // éœ€è¦æ»¡è¶³ç¬¬ 220 è‡³ 233 è¡Œã€‚
116: // ä¾‹å¦‚ï¼šã€é¡ºåºè¦è¿™æ ·ã€‘
117: // <dubbo:service interface="com.alibaba.dubbo.demo.DemoService" protocol="dubbo" ref="demoService"/>
118: // <dubbo:protocol id="dubbo" name="dubbo" port="20880"/>
119: for (String name : parserContext.getRegistry().getBeanDefinitionNames()) {
120: BeanDefinition definition = parserContext.getRegistry().getBeanDefinition(name);
121: PropertyValue property = definition.getPropertyValues().getPropertyValue("protocol");
122: if (property != null) {
123: Object value = property.getValue();
124: if (value instanceof ProtocolConfig && id.equals(((ProtocolConfig) value).getName())) {
125: definition.getPropertyValues().addPropertyValue("protocol", new RuntimeBeanReference(id));
126: }
127: }
128: }
```

åœ¨ [ã€Œ3.2.7 å¾ªç¯ Bean å¯¹è±¡çš„ setting æ–¹æ³•ï¼Œå°†å±æ€§èµ‹å€¼åˆ° Bean å¯¹è±¡ã€](http://svip.iocoder.cn/Dubbo/configuration-xml/) ç»Ÿä¸€è§£æã€‚

### 3.2.4 å¤„ç†

<dubbo:service />
çš„

class
å±æ€§

[
/#parse(Element, ParserContext, beanClass, required)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L129-L142) çš„ç¬¬ 129 è‡³ 142 è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š
```
113: // å¤„ç† `<dubbo:service />` çš„å±æ€§ `class`
114: } else if (ServiceBean.class.equals(beanClass)) {
115: // å¤„ç† `class` å±æ€§ã€‚ä¾‹å¦‚ <dubbo:service id="sa" interface="com.alibaba.dubbo.demo.DemoService" class="com.alibaba.dubbo.demo.provider.DemoServiceImpl" >
116: String className = element.getAttribute("class");
117: if (className != null && className.length() > 0) {
118: // åˆ›å»º Service çš„ RootBeanDefinition å¯¹è±¡ã€‚ç›¸å½“äºå†…åµŒäº† <bean class="com.alibaba.dubbo.demo.provider.DemoServiceImpl" />
119: RootBeanDefinition classDefinition = new RootBeanDefinition();
120: classDefinition.setBeanClass(ReflectUtils.forName(className));
121: classDefinition.setLazyInit(false);
122: // è§£æ Service Bean å¯¹è±¡çš„å±æ€§
123: parseProperties(element.getChildNodes(), classDefinition);
124: // è®¾ç½® `<dubbo:service ref="" />` å±æ€§
125: beanDefinition.getPropertyValues().addPropertyValue("ref", new BeanDefinitionHolder(classDefinition, id + "Impl"));
126: }
```

* å¤„ç†

<dubbo:service class="" />
åœºæ™¯ä¸‹çš„å¤„ç†ï¼Œ**å¤§å¤šæ•°**æƒ…å†µä¸‹æˆ‘ä»¬ä¸è¿™ä¹ˆä½¿ç”¨ï¼ŒåŒ…æ‹¬å®˜æ–¹æ–‡æ¡£ä¹Ÿæ²¡æä¾›è¿™ç§æ–¹å¼çš„è¯´æ˜ã€‚å½“é…ç½®

class
å±æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»º Service Bean å¯¹è±¡ï¼Œè€Œæ— éœ€å†é…ç½®

ref
å±æ€§ï¼ŒæŒ‡å‘ Service Bean å¯¹è±¡ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š
```
<bean id="demoDAO" class="com.alibaba.dubbo.demo.provider.DemoDAO" />
<dubbo:service id="sa" interface="com.alibaba.dubbo.demo.DemoService" class="com.alibaba.dubbo.demo.provider.DemoServiceImpl">
<property name="demoDAO" ref="demoDAO" />
</dubbo:service>
```

* é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå¯ä»¥ä½¿ç”¨

<property />
æ ‡ç­¾ï¼Œè®¾ç½® Service Bean çš„å±æ€§ã€‚
* ç¬¬ 118 è‡³ 121 è¡Œï¼šåˆ›å»º Service çš„ Bean å¯¹è±¡ã€‚
* ç¬¬ 123 è¡Œï¼šè°ƒç”¨ [
/#parseProperties(NodeList, RootBeanDefinition)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L368-L399) æ–¹æ³•ï¼Œè§£æ Service Bean å¯¹è±¡çš„å±æ€§ä»¬ã€‚è¯¦ç»†è§£æè§ [ã€Œ3.3.1 parsePropertiesã€](http://svip.iocoder.cn/Dubbo/configuration-xml/) æ–¹æ³•ã€‚

### 3.2.5 è§£æ

<dubbo:provider />
çš„å†…åµŒå­å…ƒç´ 

<dubbo:service />

[
/#parse(Element, ParserContext, beanClass, required)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L143-L145) çš„ç¬¬ 143 è‡³ 145 è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š
```
// è§£æ `<dubbo:provider />` çš„å†…åµŒå­å…ƒç´  `<dubbo:service />`
} else if (ProviderConfig.class.equals(beanClass)) {
parseNested(element, parserContext, ServiceBean.class, true, "service", "provider", id, beanDefinition);
```

* è°ƒç”¨ [
/#parseNested(...)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L326-L366) æ–¹æ³•ï¼Œè§£æå†…åµŒçš„æŒ‡å‘çš„å­ XML å…ƒç´ ã€‚è¯¦ç»†è§£æè§ [ã€Œ3.3.2 parseNestedã€](http://svip.iocoder.cn/Dubbo/configuration-xml/) æ–¹æ³•ã€‚

### 3.2.6 è§£æ

<dubbo:consumer />
çš„å†…åµŒå­å…ƒç´ 

<dubbo:reference />

[
/#parse(Element, ParserContext, beanClass, required)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L146-L149) çš„ç¬¬ 146 è‡³ 149 è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š
```
// è§£æ `<dubbo:consumer />` çš„å†…åµŒå­å…ƒç´  `<dubbo:reference />`
} else if (ConsumerConfig.class.equals(beanClass)) {
parseNested(element, parserContext, ReferenceBean.class, false, "reference", "consumer", id, beanDefinition);
}
```

* è°ƒç”¨ [
/#parseNested(...)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L326-L366) æ–¹æ³•ï¼Œè§£æå†…åµŒçš„æŒ‡å‘çš„å­ XML å…ƒç´ ã€‚

### 3.2.7 å¾ªç¯ Bean å¯¹è±¡çš„ setting æ–¹æ³•ï¼Œå°†å±æ€§èµ‹å€¼åˆ° Bean å¯¹è±¡

[
/#parse(Element, ParserContext, beanClass, required)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L150-L273) çš„ç¬¬ 150 è‡³ 273 è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š
```
150: Set<String> props = new HashSet<String>(); // å·²è§£æçš„å±æ€§é›†åˆ
151: ManagedMap parameters = null; //
152: // å¾ªç¯ Bean å¯¹è±¡çš„ setting æ–¹æ³•ï¼Œå°†å±æ€§æ·»åŠ åˆ° Bean å¯¹è±¡çš„å±æ€§èµ‹å€¼
153: for (Method setter : beanClass.getMethods()) {
154: String name = setter.getName();
155: if (name.length() > 3 && name.startsWith("set")
156: && Modifier.isPublic(setter.getModifiers())
157: && setter.getParameterTypes().length == 1) { // setting && public && å”¯ä¸€å‚æ•°
158: Class<?> type = setter.getParameterTypes()[0];
159: // æ·»åŠ  `props`
160: String property = StringUtils.camelToSplitName(name.substring(3, 4).toLowerCase() + name.substring(4), "-");
161: props.add(property);
162: // getting && public && å±æ€§å€¼ç±»å‹ç»Ÿä¸€
163: Method getter = null;
164: try {
165: getter = beanClass.getMethod("get" + name.substring(3), new Class<?>[0]);
166: } catch (NoSuchMethodException e) {
167: try {
168: getter = beanClass.getMethod("is" + name.substring(3), new Class<?>[0]);
169: } catch (NoSuchMethodException e2) {
170: }
171: }
172: if (getter == null
173: || !Modifier.isPublic(getter.getModifiers())
174: || !type.equals(getter.getReturnType())) {
175: continue;
176: }
177: // è§£æ `<dubbo:parameters />`
178: if ("parameters".equals(property)) {
179: parameters = parseParameters(element.getChildNodes(), beanDefinition);
180: // è§£æ `<dubbo:method />`
181: } else if ("methods".equals(property)) {
182: parseMethods(id, element.getChildNodes(), beanDefinition, parserContext);
183: // è§£æ `<dubbo:argument />`
184: } else if ("arguments".equals(property)) {
185: parseArguments(id, element.getChildNodes(), beanDefinition, parserContext);
186: } else {
187: String value = element.getAttribute(property);
188: if (value != null) {
189: value = value.trim();
190: if (value.length() > 0) {
191: // ä¸æƒ³æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒçš„æƒ…å†µï¼Œå³ `registry=N/A` ã€‚
192: if ("registry".equals(property) && RegistryConfig.NO_AVAILABLE.equalsIgnoreCase(value)) {
193: RegistryConfig registryConfig = new RegistryConfig();
194: registryConfig.setAddress(RegistryConfig.NO_AVAILABLE);
195: beanDefinition.getPropertyValues().addPropertyValue(property, registryConfig);
196: // å¤šæ³¨å†Œä¸­å¿ƒçš„æƒ…å†µ
197: } else if ("registry".equals(property) && value.indexOf(',') != -1) {
198: parseMultiRef("registries", value, beanDefinition, parserContext);
199: // å¤šæœåŠ¡æä¾›è€…çš„æƒ…å†µ
200: } else if ("provider".equals(property) && value.indexOf(',') != -1) {
201: parseMultiRef("providers", value, beanDefinition, parserContext);
202: // å¤šåè®®çš„æƒ…å†µ
203: } else if ("protocol".equals(property) && value.indexOf(',') != -1) {
204: parseMultiRef("protocols", value, beanDefinition, parserContext);
205: } else {
206: Object reference;
207: // å¤„ç†å±æ€§ç±»å‹ä¸ºåŸºæœ¬å±æ€§çš„æƒ…å†µ
208: if (isPrimitive(type)) {
209: // å…¼å®¹æ€§å¤„ç†
210: if ("async".equals(property) && "false".equals(value)
211: || "timeout".equals(property) && "0".equals(value)
212: || "delay".equals(property) && "0".equals(value)
213: || "version".equals(property) && "0.0.0".equals(value)
214: || "stat".equals(property) && "-1".equals(value)
215: || "reliable".equals(property) && "false".equals(value)) {
216: // backward compatibility for the default value in old version's xsd
217: value = null;
218: }
219: reference = value;
220: // å¤„ç†åœ¨ `<dubbo:provider />` æˆ–è€… `<dubbo:service />` ä¸Šå®šä¹‰äº† `protocol` å±æ€§çš„ å…¼å®¹æ€§ã€‚
221: } else if ("protocol".equals(property)
222: && ExtensionLoader.getExtensionLoader(Protocol.class).hasExtension(value) // å­˜åœ¨è¯¥æ³¨å†Œåè®®çš„å®ç°
223: && (!parserContext.getRegistry().containsBeanDefinition(value) // Spring æ³¨å†Œè¡¨ä¸­ä¸å­˜åœ¨è¯¥ `<dubbo:provider />` çš„å®šä¹‰
224: || !ProtocolConfig.class.getName().equals(parserContext.getRegistry().getBeanDefinition(value).getBeanClassName())) // Spring æ³¨å†Œè¡¨ä¸­å­˜åœ¨è¯¥ç¼–å·ï¼Œä½†æ˜¯ç±»å‹ä¸ä¸º ProtocolConfig ã€‚
225: ) {
226: // ç›®å‰ï¼Œ`<dubbo:provider protocol="" />` æ¨èç‹¬ç«‹æˆ `<dubbo:protocol />`
227: if ("dubbo:provider".equals(element.getTagName())) {
228: logger.warn("Recommended replace <dubbo:provider protocol=\"" + value + "\" ... /> to <dubbo:protocol name=\"" + value + "\" ... />");
229: }
230: // backward compatibility
231: ProtocolConfig protocol = new ProtocolConfig();
232: protocol.setName(value);
233: reference = protocol;
234: // å¤„ç† `onreturn` å±æ€§
235: } else if ("onreturn".equals(property)) {
236: // æŒ‰ç…§ `.` æ‹†åˆ†
237: int index = value.lastIndexOf(".");
238: String returnRef = value.substring(0, index);
239: String returnMethod = value.substring(index + 1);
240: // åˆ›å»º RuntimeBeanReference ï¼ŒæŒ‡å‘å›è°ƒçš„å¯¹è±¡
241: reference = new RuntimeBeanReference(returnRef);
242: // è®¾ç½® `onreturnMethod` åˆ° BeanDefinition çš„å±æ€§å€¼
243: beanDefinition.getPropertyValues().addPropertyValue("onreturnMethod", returnMethod);
244: // å¤„ç† `onthrow` å±æ€§
245: } else if ("onthrow".equals(property)) {
246: // æŒ‰ç…§ `.` æ‹†åˆ†
247: int index = value.lastIndexOf(".");
248: String throwRef = value.substring(0, index);
249: String throwMethod = value.substring(index + 1);
250: // åˆ›å»º RuntimeBeanReference ï¼ŒæŒ‡å‘å›è°ƒçš„å¯¹è±¡
251: reference = new RuntimeBeanReference(throwRef);
252: // è®¾ç½® `onthrowMethod` åˆ° BeanDefinition çš„å±æ€§å€¼
253: beanDefinition.getPropertyValues().addPropertyValue("onthrowMethod", throwMethod);
254: // é€šç”¨è§£æ
255: } else {
256: // æŒ‡å‘çš„ Service çš„ Bean å¯¹è±¡ï¼Œå¿…é¡»æ˜¯å•ä¾‹
257: if ("ref".equals(property) && parserContext.getRegistry().containsBeanDefinition(value)) {
258: BeanDefinition refBean = parserContext.getRegistry().getBeanDefinition(value);
259: if (!refBean.isSingleton()) {
260: throw new IllegalStateException("The exported service ref " + value + " must be singleton! Please set the " + value + " bean scope to singleton, eg: <bean id=\"" + value + "\" scope=\"singleton\" ...>");
261: }
262: }
263: // åˆ›å»º RuntimeBeanReference ï¼ŒæŒ‡å‘ Service çš„ Bean å¯¹è±¡
264: reference = new RuntimeBeanReference(value);
265: }
266: // è®¾ç½® BeanDefinition çš„å±æ€§å€¼
267: beanDefinition.getPropertyValues().addPropertyValue(property, reference);
268: }
269: }
270: }
271: }
272: }
273: }
```

* ç¬¬ 150 è¡Œï¼šå·²è§£æçš„å±æ€§é›†åˆ

props
ã€‚è¯¥å±æ€§åœ¨ [ã€Œ3.2.8 å°† XML å…ƒç´ æœªéå†åˆ°çš„å±æ€§ï¼Œæ·»åŠ åˆ°

parameters
é›†åˆä¸­ã€](http://svip.iocoder.cn/Dubbo/configuration-xml/) ä¼šä½¿ç”¨åˆ°ã€‚
* ç¬¬ 151 è¡Œï¼šè§£æçš„å‚æ•°é›†åˆ

parameters
ã€‚
* ç¬¬ 153 è¡Œï¼šå¾ªç¯ Bean å¯¹è±¡çš„ setting æ–¹æ³•ï¼Œå°†å±æ€§æ·»åŠ åˆ° Bean å¯¹è±¡çš„å±æ€§èµ‹å€¼ã€‚
* ç¬¬ 154 è‡³ 157 è¡Œï¼šåˆ¤æ–­æ–¹æ³•ç¬¦åˆ setting &&

public
&& å”¯ä¸€å‚æ•°çš„æ¡ä»¶ã€‚
* ç¬¬ 159 è‡³ 161 è¡Œï¼šæ·»åŠ **å±æ€§å**åˆ°

props
ã€‚
* ç¬¬ 162 è‡³ 176 è¡Œï¼šåˆ¤æ–­æ–¹æ³•ç¬¦åˆ getting &&

public
&& è¿”å›ç±»å‹ä¸ setting å‚æ•°ç±»å‹**ä¸€è‡´**çš„æ¡ä»¶ã€‚
* ç¬¬ 177 è‡³ 179 è¡Œï¼šè°ƒç”¨ [
/#parseParameters(id, nodeList, beanDefinition, parserContext)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L436-L476) æ–¹æ³•ï¼Œè§£æ

<dubbo:argument />
æ ‡ç­¾ã€‚è¯¦ç»†è§£æè§ [ã€Œ3.3.6 parseParametersã€](http://svip.iocoder.cn/Dubbo/configuration-xml/) æ–¹æ³•ã€‚
* ç¬¬ 180 è‡³ 182 è¡Œï¼šè°ƒç”¨ [
/#parseMethods(id, nodeList, beanDefinition, parserContext)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L436-L476) æ–¹æ³•ï¼Œè§£æ

<dubbo:method />
æ ‡ç­¾ã€‚è¯¦ç»†è§£æè§ [ã€Œ3.3.4 parseMethodsã€](http://svip.iocoder.cn/Dubbo/configuration-xml/) æ–¹æ³•ã€‚
* ç¬¬ 183 è‡³ 185 è¡Œï¼šè°ƒç”¨ [
/#parseArguments(id, nodeList, beanDefinition, parserContext)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L436-L476) æ–¹æ³•ï¼Œè§£æ

<dubbo:argument />
æ ‡ç­¾ã€‚è¯¦ç»†è§£æè§ [ã€Œ3.3.5 parseArgumentsã€](http://svip.iocoder.cn/Dubbo/configuration-xml/) æ–¹æ³•ã€‚
* ç¬¬ 191 è‡³ 195 è¡Œï¼šå¤„ç†

"registry"
å±æ€§ï¼Œä¸æƒ³æ³¨å†Œåˆ°æ³¨å†Œä¸­å¿ƒçš„æƒ…å†µï¼Œå³

registry=N/A
ã€‚
* ç¬¬ 196 è‡³ 204 è¡Œï¼šè°ƒç”¨ [
/#parseMultiRef(property, beanDefinition, parserContext)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L301-L324) æ–¹æ³•ï¼Œå¤„ç†å¤šæ³¨å†Œä¸­å¿ƒã€å¤šæœåŠ¡æä¾›è€…ã€å¤šåè®®çš„æƒ…å†µä¸‹ã€‚è¯¦ç»†è§£æè§ [ã€Œ3.3. parseMultiRefã€](http://svip.iocoder.cn/Dubbo/configuration-xml/) æ–¹æ³•ã€‚
* ç¬¬ 207 è‡³ 219 è¡Œï¼šå¤„ç†å±æ€§ç±»å‹ä¸º**åŸºç¡€å±æ€§**( [
/#isPrimitive(Class<?>)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L294-L299) )çš„æƒ…å†µã€‚
* ç¬¬ 220 è‡³ 233 è¡Œï¼šè¿™å—æ¯”è¾ƒ**å¤æ‚**ã€‚

"protocol"
å±æ€§ï¼Œåœ¨å¤šä¸ªæ ‡ç­¾ä¸­ä¼šä½¿ç”¨ï¼Œä¾‹å¦‚

<dubbo:service />
æˆ–è€…

<dubbo:provider />
ç­‰ç­‰ã€‚æ ¹æ® [ã€ŠDubbo æ–‡æ¡£ â€”â€” schema é…ç½®å‚è€ƒæ‰‹å†Œã€‹](http://dubbo.apache.org/zh-cn/docs/user/references/xml/introduction.html) çš„è¯´æ˜ï¼Œ

"protocol"
ä»£è¡¨çš„æ˜¯æŒ‡å‘çš„

<dubbo:protocol />
çš„ç¼–å·(

id
)ã€‚

* ã€æ­¤å¤„æ˜¯çŒœæµ‹ã€‘ä½†æ˜¯ï¼Œæ—©æœŸçš„ç‰ˆæœ¬ï¼Œ

"protocol"
å±æ€§ï¼Œä»£è¡¨çš„æ˜¯**åè®®å**ã€‚è¿™å°±éº»çƒ¦äº†ï¼Œå’Œç°æœ‰çš„é€»è¾‘æœ‰å†²çªå•Šï¼
* é‚£æ€ä¹ˆè§£å†³å‘¢ï¼Ÿä¼˜å…ˆä»¥æŒ‡å‘çš„

<dubbo:protocol />
çš„**ç¼–å·**(

id
) ä¸ºå‡†å¤‡ï¼Œå¦åˆ™è®¤ä¸ºæ˜¯**åè®®å**ã€‚
* é‚£å®é™…åœ¨è§£æ Bean å¯¹è±¡æ—¶ï¼Œå¸¦æœ‰

"protocol"
å±æ€§çš„æ ‡ç­¾ï¼Œæ— æ³•ä¿è¯ä¸€å®šåœ¨

<dubbo:protocol />
**ä¹‹å**è§£æã€‚é‚£å’‹æ•´å‘¢ï¼Ÿ

* å¦‚æœå¸¦æœ‰

"protocol"
å±æ€§çš„æ ‡ç­¾**å…ˆ**è§£æï¼Œå…ˆã€ç¬¬ 221 è‡³ 223 è¡Œã€‘**ç›´æ¥**åˆ›å»º ProtocolConfig å¯¹è±¡å¹¶è®¾ç½®åˆ°

"protocol"
å±æ€§ï¼Œå†ã€ç¬¬ 119 è‡³ 127 è¡Œã€‘åœ¨

<dubbo:protocol />
è§£æåï¼Œè¿›è¡Œ**è¦†ç›–**ã€‚è¿™æ ·ï¼Œå¦‚æœä¸å­˜åœ¨

<dubbo:protocol />
çš„æƒ…å†µï¼Œæœ€å¤šä¸è¿›è¡Œè¦†ç›–å‘¢ã€‚
* å¦‚æœå¸¦æœ‰

"protocol"
å±æ€§çš„æ ‡ç­¾**å**è§£æï¼Œæ— éœ€èµ°ä¸Šè¿°æµç¨‹ï¼Œèµ°ã€ç¬¬ 257 è‡³ 264 è¡Œã€‘å³å¯ã€‚
* ğŸ™‚ å¦‚æœè¿™æ®µæ— æ³•ç†è§£ï¼Œå¯ä»¥ç»™æˆ‘ç•™è¨€ï¼Œæœ‰ç‚¹ç»•ã€‚
* ç¬¬ 234 è‡³ 243 è¡Œ **||** ç¬¬ 244 è‡³ 253 è¡Œï¼šå¤„ç†

"onreturn"
å’Œ

"onthrow"
å±æ€§ã€‚è¯¥å±æ€§ç”¨äº [ã€ŠDubbo ç”¨æˆ·æŒ‡å— â€”â€” äº‹ä»¶é€šçŸ¥ã€‹](http://dubbo.apache.org/zh-cn/docs/user/demos/events-notify.html) åŠŸèƒ½ã€‚
* ç¬¬ 254 è‡³ 264 è¡Œï¼šå‰©ä½™æƒ…å†µï¼Œé€šç”¨è§£æï¼Œåˆ›å»º RuntimeBeanReference å¯¹è±¡ã€‚ä¾‹å¦‚ï¼Œ

<dubbo:service />
çš„

"ref"
å±æ€§ã€‚
* ç¬¬ 267 è¡Œï¼šè®¾ç½® Bean çš„å±æ€§å€¼ã€‚**è¯¥å±æ€§å€¼æ¥è‡ªç¬¬ 206 è‡³ 265 è¡Œä»£ç çš„é€»è¾‘**ã€‚

### 3.2.8 å°† XML å…ƒç´ æœªéå†åˆ°çš„å±æ€§ï¼Œæ·»åŠ åˆ°

parameters
é›†åˆä¸­

[
/#parse(Element, ParserContext, beanClass, required)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L274-L290) çš„ç¬¬ 274 è‡³ 290 è¡Œï¼Œä»£ç å¦‚ä¸‹ï¼š
```
274: // å°† XML å…ƒç´ ï¼Œæœªåœ¨ä¸Šé¢éå†åˆ°çš„å±æ€§ï¼Œæ·»åŠ åˆ° `parameters` é›†åˆä¸­ã€‚ç›®å‰æµ‹è¯•ä¸‹æ¥ï¼Œä¸å­˜åœ¨è¿™æ ·çš„æƒ…å†µã€‚
275: NamedNodeMap attributes = element.getAttributes();
276: int len = attributes.getLength();
277: for (int i = 0; i < len; i++) {
278: Node node = attributes.item(i);
279: String name = node.getLocalName();
280: if (!props.contains(name)) {
281: if (parameters == null) {
282: parameters = new ManagedMap();
283: }
284: String value = node.getNodeValue();
285: parameters.put(name, new TypedStringValue(value, String.class));
286: }
287: }
288: if (parameters != null) {
289: beanDefinition.getPropertyValues().addPropertyValue("parameters", parameters);
290: }
```

* ç¬¬ 275 è‡³ 287 è¡Œï¼šå°† XML å…ƒç´ ï¼Œ**æœªåœ¨ä¸Šé¢éå†åˆ°çš„å±æ€§**ï¼Œæ·»åŠ åˆ°

parameters
é›†åˆä¸­ã€‚ç›®å‰æµ‹è¯•ä¸‹æ¥ï¼Œä¸å­˜åœ¨è¿™æ ·çš„æƒ…å†µã€‚
* ç¬¬ 288 è‡³ 290 è¡Œï¼šè®¾ç½® Bean çš„

parameters
ã€‚

## 3.3 è§£ææ–¹æ³•ã€è¾…æµç¨‹ã€‘

### 3.3.1 parseProperties

[
/#parseProperties(NodeList, RootBeanDefinition)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L368-L399) æ–¹æ³•ï¼Œè§£æ Service Bean å¯¹è±¡çš„å±æ€§ä»¬ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: //*/*
2: /* è§£æ <dubbo:service class="" /> æƒ…å†µä¸‹ï¼Œå†…æ¶µçš„ `<property />` çš„èµ‹å€¼ã€‚
3: /*
4: /* @param nodeList å­å…ƒç´ æ•°ç»„
5: /* @param beanDefinition Bean å®šä¹‰å¯¹è±¡
6: /*/
7: private static void parseProperties(NodeList nodeList, RootBeanDefinition beanDefinition){
8: if (nodeList != null && nodeList.getLength() > 0) {
9: for (int i = 0; i < nodeList.getLength(); i++) {
10: Node node = nodeList.item(i);
11: if (node instanceof Element) {
12: if ("property".equals(node.getNodeName())
13: || "property".equals(node.getLocalName())) {
14: String name = ((Element) node).getAttribute("name");
15: if (name != null && name.length() > 0) {
16: String value = ((Element) node).getAttribute("value");
17: String ref = ((Element) node).getAttribute("ref");
18: // value
19: if (value != null && value.length() > 0) {
20: beanDefinition.getPropertyValues().addPropertyValue(name, value);
21: // ref
22: } else if (ref != null && ref.length() > 0) {
23: beanDefinition.getPropertyValues().addPropertyValue(name, new RuntimeBeanReference(ref));
24: } else {
25: throw new UnsupportedOperationException("Unsupported <property name=\"" + name + "\"> sub tag, Only supported <property name=\"" + name + "\" ref=\"...\" /> or <property name=\"" + name + "\" value=\"...\" />");
26: }
27: }
28: }
29: }
30: }
31: }
32: }
```

* ç¬¬ 11 è‡³ 13 è¡Œï¼š**åª**è§£æ

<property />
æ ‡ç­¾ã€‚
* ç¬¬ 18 è‡³ 20 è¡Œï¼šä¼˜å…ˆä½¿ç”¨

"value"
å±æ€§ã€‚
* ç¬¬ 21 è‡³ 23 è¡Œï¼šå…¶æ¬¡ä½¿ç”¨

"ref"
å±æ€§ã€‚
* ç¬¬ 24 è‡³ 27 è¡Œï¼šå±æ€§è¡¥å…¨ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚

### 3.3.2 parseNested

[
/#parseNested(...)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L326-L366) æ–¹æ³•ï¼Œè§£æå†…åµŒçš„æŒ‡å‘çš„å­ XML å…ƒç´ ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: //*/*
2: /* è§£æå†…åµŒçš„æŒ‡å‘çš„å­ XML å…ƒç´ 
3: /*
4: /* @param element çˆ¶ XML å…ƒç´ 
5: /* @param parserContext Spring è§£æä¸Šä¸‹æ–‡
6: /* @param beanClass å†…åµŒè§£æå­å…ƒç´ çš„ Bean çš„ç±»
7: /* @param required æ˜¯å¦éœ€è¦ Bean çš„ `id` å±æ€§
8: /* @param tag æ ‡ç­¾
9: /* @param property çˆ¶ Bean å¯¹è±¡åœ¨å­å…ƒç´ ä¸­çš„å±æ€§å
10: /* @param ref æŒ‡å‘
11: /* @param beanDefinition çˆ¶ Bean å®šä¹‰å¯¹è±¡
12: /*/
13: private static void parseNested(Element element, ParserContext parserContext, Class<?> beanClass, boolean required, String tag,
14: String property, String ref, BeanDefinition beanDefinition){
15: NodeList nodeList = element.getChildNodes();
16: if (nodeList != null && nodeList.getLength() > 0) {
17: boolean first = true;
18: for (int i = 0; i < nodeList.getLength(); i++) {
19: Node node = nodeList.item(i);
20: if (node instanceof Element) {
21: if (tag.equals(node.getNodeName())
22: || tag.equals(node.getLocalName())) { // è¿™ä¸‰è¡Œï¼Œåˆ¤æ–­æ˜¯å¦ä¸ºæŒ‡å®šè¦è§£æçš„å­å…ƒç´ 
23: // ã€TODO 8008ã€‘ èŠ‹è‰¿ï¼Œdefault æ˜¯å¹²é”¤å­çš„
24: if (first) {
25: first = false;
26: String isDefault = element.getAttribute("default");
27: if (isDefault == null || isDefault.length() == 0) {
28: beanDefinition.getPropertyValues().addPropertyValue("default", "false");
29: }
30: }
31: // è§£æå­å…ƒç´ ï¼Œåˆ›å»º BeanDefinition å¯¹è±¡
32: BeanDefinition subDefinition = parse((Element) node, parserContext, beanClass, required);
33: // è®¾ç½®å­ BeanDefinition ï¼ŒæŒ‡å‘çˆ¶ BeanDefinition ã€‚
34: if (subDefinition != null && ref != null && ref.length() > 0) {
35: subDefinition.getPropertyValues().addPropertyValue(property, new RuntimeBeanReference(ref));
36: }
37: }
38: }
39: }
40: }
41: }
```

* ç¬¬ 20 è‡³ 22 è¡Œï¼š**åª**è§£æ**æŒ‡å®šæ ‡ç­¾**ã€‚ç›®å‰æœ‰**å†…åµŒ**çš„

<dubbo:service />
å’Œ

<dubbo:reference />
æ ‡ç­¾ã€‚
* ç¬¬ 32 è¡Œï¼šè§£ææŒ‡å®šæ ‡ç­¾ï¼Œåˆ›å»ºå­ Bean å¯¹è±¡ã€‚
* ç¬¬ 33 è‡³ 36 è¡Œï¼šè®¾ç½®åˆ›å»ºçš„**å­** Bean å¯¹è±¡ï¼ŒæŒ‡å‘**çˆ¶** Bean å¯¹è±¡ã€‚

### 3.3.3 parseMultiRef

[
/#parseMultiRef(property, beanDefinition, parserContext)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L301-L324) æ–¹æ³•ï¼Œè§£æå¤šæŒ‡å‘çš„æƒ…å†µï¼Œä¾‹å¦‚å¤šæ³¨å†Œä¸­å¿ƒï¼Œå¤šåè®®ç­‰ç­‰ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: //*/*
2: /* è§£æå¤šæŒ‡å‘çš„æƒ…å†µï¼Œä¾‹å¦‚å¤šæ³¨å†Œä¸­å¿ƒï¼Œå¤šåè®®ç­‰ç­‰ã€‚
3: /*
4: /* @param property å±æ€§
5: /* @param value å€¼
6: /* @param beanDefinition Bean å®šä¹‰å¯¹è±¡
7: /* @param parserContext Spring è§£æä¸Šä¸‹æ–‡
8: /*/
9: @SuppressWarnings("unchecked")
10: private static void parseMultiRef(String property, String value, RootBeanDefinition beanDefinition,
11: ParserContext parserContext){
12: String[] values = value.split("\\s/*[,]+\\s/*");
13: ManagedList list = null;
14: for (int i = 0; i < values.length; i++) {
15: String v = values[i];
16: if (v != null && v.length() > 0) {
17: if (list == null) {
18: list = new ManagedList();
19: }
20: list.add(new RuntimeBeanReference(v));
21: }
22: }
23: beanDefinition.getPropertyValues().addPropertyValue(property, list);
24: }
```

* ç¬¬ 12 è‡³ 22 è¡Œï¼šä»¥

.
æ‹†åˆ†**å€¼**å­—ç¬¦ä¸²ï¼Œåˆ›å»º RuntimeBeanReference æ•°ç»„ã€‚
* ç¬¬ 23 è¡Œï¼šè®¾ç½® Bean å¯¹è±¡çš„æŒ‡å®šå±æ€§å€¼ã€‚

### 3.3.4 parseMethods

[
/#parseMethods(id, nodeList, beanDefinition, parserContext)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L436-L476) æ–¹æ³•ï¼Œè§£æ

<dubbo:method />
æ ‡ç­¾ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: //*/*
2: /* è§£æ `<dubbo:method />`
3: /*
4: /* @param id Bean çš„ `id` å±æ€§ã€‚
5: /* @param nodeList å­å…ƒç´ èŠ‚ç‚¹æ•°ç»„
6: /* @param beanDefinition Bean å®šä¹‰å¯¹è±¡
7: /* @param parserContext è§£æä¸Šä¸‹æ–‡
8: /*/
9: @SuppressWarnings("unchecked")
10: private static void parseMethods(String id, NodeList nodeList, RootBeanDefinition beanDefinition,
11: ParserContext parserContext){
12: if (nodeList != null && nodeList.getLength() > 0) {
13: ManagedList methods = null; // è§£æçš„æ–¹æ³•æ•°ç»„
14: for (int i = 0; i < nodeList.getLength(); i++) {
15: Node node = nodeList.item(i);
16: if (node instanceof Element) {
17: Element element = (Element) node;
18: if ("method".equals(node.getNodeName())
19: || "method".equals(node.getLocalName())) { // è¿™ä¸‰è¡Œï¼Œåˆ¤æ–­å€¼è§£æ `<dubbo:method />`
20: // æ–¹æ³•åä¸èƒ½ä¸ºç©º
21: String methodName = element.getAttribute("name");
22: if (methodName == null || methodName.length() == 0) {
23: throw new IllegalStateException("<dubbo:method> name attribute == null");
24: }
25: if (methods == null) {
26: methods = new ManagedList();
27: }
28: // è§£æ `<dubbo:method />`ï¼Œåˆ›å»º BeanDefinition å¯¹è±¡
29: BeanDefinition methodBeanDefinition = parse(((Element) node), parserContext, MethodConfig.class, false);
30: // æ·»åŠ åˆ° `methods` ä¸­
31: String name = id + "." + methodName;
32: BeanDefinitionHolder methodBeanDefinitionHolder = new BeanDefinitionHolder(methodBeanDefinition, name);
33: methods.add(methodBeanDefinitionHolder);
34: }
35: }
36: }
37: if (methods != null) {
38: beanDefinition.getPropertyValues().addPropertyValue("methods", methods);
39: }
40: }
41: }
```

* ç¬¬ 13 è¡Œï¼šè§£æçš„æ–¹æ³•æ•°ç»„

methods
ã€‚
* ç¬¬ 16 è‡³ 19 è¡Œï¼š**åª**è§£æ

<dubbo:method>
æ ‡ç­¾ã€‚
* ç¬¬ 29 è¡Œï¼šè°ƒç”¨ [
/#parse(Element, ParserContext)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L516-L518) æ–¹æ³•ï¼Œ**ä¸»æµç¨‹**ï¼Œè§£æ

<dubbo:method>
æ ‡ç­¾ï¼Œåˆ›å»ºå­ Bean å¯¹è±¡ã€‚
* ç¬¬ 33 è‡³ 36 è¡Œï¼šè®¾ç½®åˆ›å»ºçš„**å­** Bean å¯¹è±¡ï¼ŒæŒ‡å‘**çˆ¶** Bean å¯¹è±¡ã€‚
* ç¬¬ 30 è‡³ 33 è¡Œï¼šæ·»åŠ å­ Bean å¯¹è±¡åˆ°

methods
ä¸­ã€‚
* ç¬¬ 37 è‡³ 39 è¡Œï¼šè®¾ç½® Bean çš„

methods
ã€‚

### 3.3.5 parseArguments

[
/#parseArguments(id, nodeList, beanDefinition, parserContext)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L436-L476) æ–¹æ³•ï¼Œè§£æ

<dubbo:argument />
æ ‡ç­¾ã€‚

å’Œ [ã€Œ3.3.4 parseMethodsã€](http://svip.iocoder.cn/Dubbo/configuration-xml/) åŸºæœ¬ä¸€è‡´ï¼ŒğŸ™‚ èƒ–å‹ç‚¹å‡»æ–¹æ³•ï¼Œç›´æ¥æŸ¥çœ‹ä»£ç ã€‚

### 3.3.6 parseParameters

[
/#parseParameters(id, nodeList, beanDefinition, parserContext)
](https://github.com/YunaiV/dubbo/blob/55227e1897030c42342c65b2fce8e1705844a531/dubbo-config/dubbo-config-spring/src/main/java/com/alibaba/dubbo/config/spring/schema/DubboBeanDefinitionParser.java#L401-L434) æ–¹æ³•ï¼Œè§£æ

<dubbo:argument />
æ ‡ç­¾ã€‚ä»£ç å¦‚ä¸‹ï¼š
```
1: //*/*
2: /* è§£æ `<dubbo:parameter />`
3: /*
4: /* @param nodeList å­å…ƒç´ èŠ‚ç‚¹æ•°ç»„
5: /* @param beanDefinition Bean å®šä¹‰å¯¹è±¡
6: /* @return å‚æ•°é›†åˆ
7: /*/
8: @SuppressWarnings("unchecked")
9: private static ManagedMap parseParameters(NodeList nodeList, RootBeanDefinition beanDefinition){
10: if (nodeList != null && nodeList.getLength() > 0) {
11: ManagedMap parameters = null;
12: for (int i = 0; i < nodeList.getLength(); i++) {
13: Node node = nodeList.item(i);
14: if (node instanceof Element) {
15: if ("parameter".equals(node.getNodeName())
16: || "parameter".equals(node.getLocalName())) { // è¿™ä¸‰è¡Œï¼Œåªè§£æå­å…ƒç´ ä¸­çš„ `<dubbo:parameter />`
17: if (parameters == null) {
18: parameters = new ManagedMap();
19: }
20: // æ·»åŠ åˆ°å‚æ•°é›†åˆ
21: String key = ((Element) node).getAttribute("key");
22: String value = ((Element) node).getAttribute("value");
23: boolean hide = "true".equals(((Element) node).getAttribute("hide")); // ã€TODO 8007ã€‘ <dubbo:parameter hide=â€œâ€ /> çš„ç”¨é€”
24: if (hide) {
25: key = Constants.HIDE_KEY_PREFIX + key;
26: }
27: parameters.put(key, new TypedStringValue(value, String.class));
28: }
29: }
30: }
31: return parameters;
32: }
33: return null;
34: }
```

* ç¬¬ 13 è¡Œï¼šè§£æçš„å‚æ•°é›†åˆ

parameters
ã€‚
* ç¬¬ 20 è‡³ 27 è¡Œï¼šæ·»åŠ 

"key"

"value"
åˆ°

parameters
ã€‚