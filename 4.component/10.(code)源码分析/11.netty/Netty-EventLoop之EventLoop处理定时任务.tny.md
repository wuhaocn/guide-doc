<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆä¸ƒï¼‰ä¹‹ EventLoop å¤„ç†å®šæ—¶ä»»åŠ¡
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡æ¥ <a href="http://svip.iocoder.cn/Netty/EventLoop-6-EventLoop-handle-normal-task">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆå…­ï¼‰ä¹‹ EventLoop å¤„ç†æ™®é€šä»»åŠ¡ã€‹</a> ï¼Œåˆ†äº«ã€å¤„ç†<strong>å®šæ—¶ä»»åŠ¡</strong>ã€‘çš„éƒ¨åˆ†ã€‚</p>
<p>å› ä¸º AbstractScheduledEventExecutor åœ¨ <a href="ç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆä¸‰ï¼‰ä¹‹ EventLoop åˆå§‹åŒ–">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆä¸‰ï¼‰ä¹‹ EventLoop åˆå§‹åŒ–ã€‹</a> å¹¶æœªåˆ†äº«ï¼Œå¹¶ä¸”å®ƒæ˜¯æœ¬æ–‡çš„<strong>å¤„ç†å®šæ—¶ä»»åŠ¡çš„å‰ç½®</strong>ï¼Œæ‰€ä»¥æœ¬æ–‡å…ˆå†™è¿™éƒ¨åˆ†å†…å®¹ã€‚</p>
<h1 id="2-ScheduledFutureTask"><a href="#2-ScheduledFutureTask" class="headerlink" title="2. ScheduledFutureTask"></a>2. ScheduledFutureTask</h1><p><code>io.netty.util.concurrent.ScheduledFutureTask</code> ï¼Œå®ç° ScheduledFutureã€PriorityQueueNode æ¥å£ï¼Œç»§æ‰¿ PromiseTask æŠ½è±¡ç±»ï¼ŒNetty å®šæ—¶ä»»åŠ¡ã€‚</p>
<blockquote>
<p>è€è‰¿è‰¿ï¼šä¹Ÿæœ‰æ–‡ç« å–œæ¬¢æŠŠâ€œå®šæ—¶ä»»åŠ¡â€å«ä½œâ€œè°ƒåº¦ä»»åŠ¡â€ï¼Œæ„æ€æ˜¯ç›¸åŒçš„ï¼Œæœ¬æ–‡ç»Ÿä¸€ä½¿ç”¨â€œå®šæ—¶ä»»åŠ¡â€ã€‚</p>
</blockquote>
<h2 id="2-1-é™æ€å±æ€§"><a href="#2-1-é™æ€å±æ€§" class="headerlink" title="2.1 é™æ€å±æ€§"></a>2.1 é™æ€å±æ€§</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡åºå·ç”Ÿæˆå™¨ï¼Œé€šè¿‡ AtomicLong å®ç°é€’å¢å‘å·</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicLong nextTaskId = <span class="keyword">new</span> AtomicLong();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®šæ—¶ä»»åŠ¡æ—¶é—´èµ·ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> START_TIME = System.nanoTime();</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>nextTaskId</code> é™æ€å±æ€§ï¼Œä»»åŠ¡åºå·ç”Ÿæˆå™¨ï¼Œé€šè¿‡ AtomicLong å®ç°<strong>é€’å¢</strong>å‘å·ã€‚</li>
<li><p><code>START_TIME</code> é™æ€å±æ€§ï¼Œå®šæ—¶ä»»åŠ¡æ—¶é—´<strong>èµ·ç‚¹</strong>ã€‚åœ¨ ScheduledFutureTask ä¸­ï¼Œå®šæ—¶ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ï¼Œéƒ½æ˜¯åŸºäº <code>START_TIME</code> åš<strong>ç›¸å¯¹</strong>æ—¶é—´ã€‚ğŸ˜ˆ è‡³äºä¸ºä»€ä¹ˆä½¿ç”¨ç›¸å¯¹æ—¶é—´ï¼Ÿç¬”è€…æš‚æ—¶æ²¡æœ‰ææ¸…æ¥šã€‚</p>
<ul>
<li>ç¬”è€…ä¹Ÿæœç´¢äº†ä¸‹å’Œ <code>System.nanoTime()</code> ç›¸å…³çš„å†…å®¹ï¼Œå”¯ä¸€èƒ½çœ‹çš„æ˜¯ <a href="http://hold-on.iteye.com/blog/1943436" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠSystem.nanoTime() çš„éšæ‚£ã€‹</a> ï¼Œä½†æ˜¯åº”è¯¥ä¸æ˜¯è¿™ä¸ªåŸå› ã€‚ </li>
<li><p>å’Œæˆ‘çš„å¤§è¡¨å¼Ÿæ™®æ¶äº¤æµäº†ä¸€æ³¢ï¼Œä»–çš„ç†è§£æ˜¯ï¼š</p>
<blockquote>
<p>å› ä¸ºæ˜¯å®šæ—¶è°ƒåº¦ï¼Œæˆ‘æ”¹äº†ç³»ç»Ÿæ—¶é—´ä¹Ÿæ²¡å…³ç³»<br>å­˜çš„æ˜¯è·ç¦»ä¸‹æ¬¡è°ƒåº¦è¿˜è¦å¤šé•¿æ—¶é—´<br>ä¸å—ç³»ç»Ÿæ—¶é—´å½±å“<br>æœ€å¤§çš„å¥½å¤„</p>
</blockquote>
<ul>
<li>å“å“Ÿï¼Œç‰›é€¼å¦‚æˆ‘å¤§è¡¨å¼Ÿå•Šï¼ï¼ï¼</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="2-2-nanoTime"><a href="#2-2-nanoTime" class="headerlink" title="2.2 nanoTime"></a>2.2 nanoTime</h2><p><code>#nanoTime()</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œè·å¾—å½“å‰æ—¶é—´ï¼Œè¿™ä¸ªæ˜¯ç›¸å¯¹ <code>START_TIME</code> æ¥ç®—çš„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">nanoTime</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> System.nanoTime() - START_TIME;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¿™æ˜¯ä¸ªé‡è¦çš„æ–¹æ³•ï¼Œåç»­å¾ˆå¤šæ–¹æ³•éƒ½ä¼šè°ƒç”¨åˆ°å®ƒã€‚</li>
</ul>
<h2 id="2-3-deadlineNanos"><a href="#2-3-deadlineNanos" class="headerlink" title="2.3 deadlineNanos"></a>2.3 deadlineNanos</h2><p><code>#deadlineNanos(long delay)</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œè·å¾—ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ç›¸å¯¹ <code>START_TIME</code> æ¥ç®—çš„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> delay å»¶è¿Ÿæ—¶é•¿ï¼Œå•ä½ï¼šçº³ç§’</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> è·å¾—ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼Œä¹Ÿæ˜¯ç›¸å¯¹ {<span class="doctag">@link</span> #START_TIME} æ¥ç®—çš„ã€‚</span></span><br><span class="line"><span class="comment"> *          å®é™…ä¸Šï¼Œè¿”å›çš„ç»“æœï¼Œä¼šç”¨äº {<span class="doctag">@link</span> #deadlineNanos} å­—æ®µ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">deadlineNanos</span><span class="params">(<span class="keyword">long</span> delay)</span> </span>{</span><br><span class="line">    <span class="keyword">long</span> deadlineNanos = nanoTime() + delay;</span><br><span class="line">    <span class="comment">// Guard against overflow é˜²å¾¡æ€§ç¼–ç¨‹</span></span><br><span class="line">    <span class="keyword">return</span> deadlineNanos &lt; <span class="number">0</span> ? Long.MAX_VALUE : deadlineNanos;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-4-æ„é€ æ–¹æ³•"><a href="#2-4-æ„é€ æ–¹æ³•" class="headerlink" title="2.4 æ„é€ æ–¹æ³•"></a>2.4 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡ç¼–å·</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> id = nextTaskId.getAndIncrement();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼Œå³åˆ°äº†è¯¥æ—¶é—´ï¼Œè¯¥ä»»åŠ¡å°±ä¼šè¢«æ‰§è¡Œ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> deadlineNanos;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä»»åŠ¡æ‰§è¡Œå‘¨æœŸ</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * =0 - åªæ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line"><span class="comment"> * &gt;0 - æŒ‰ç…§è®¡åˆ’æ‰§è¡Œæ—¶é—´è®¡ç®—</span></span><br><span class="line"><span class="comment"> * &lt;0 - æŒ‰ç…§å®é™…æ‰§è¡Œæ—¶é—´è®¡ç®—</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æ¨èé˜…è¯»æ–‡ç«  https://blog.csdn.net/gtuu0123/article/details/6040159</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* 0 - no repeat, &gt;0 - repeat at fixed rate, &lt;0 - repeat with fixed delay */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> periodNanos;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é˜Ÿåˆ—ç¼–å·</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> queueIndex = INDEX_NOT_IN_QUEUE;</span><br><span class="line"></span><br><span class="line">ScheduledFutureTask(</span><br><span class="line">        AbstractScheduledEventExecutor executor,</span><br><span class="line">        Runnable runnable, V result, <span class="keyword">long</span> nanoTime) {</span><br><span class="line">    <span class="keyword">this</span>(executor, toCallable(runnable, result), nanoTime);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">ScheduledFutureTask(</span><br><span class="line">        AbstractScheduledEventExecutor executor,</span><br><span class="line">        Callable&lt;V&gt; callable, <span class="keyword">long</span> nanoTime, <span class="keyword">long</span> period) {</span><br><span class="line">    <span class="keyword">super</span>(executor, callable);</span><br><span class="line">    <span class="keyword">if</span> (period == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"period: 0 (expected: != 0)"</span>);</span><br><span class="line">    }</span><br><span class="line">    deadlineNanos = nanoTime;</span><br><span class="line">    periodNanos = period;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">ScheduledFutureTask(</span><br><span class="line">        AbstractScheduledEventExecutor executor,</span><br><span class="line">        Callable&lt;V&gt; callable, <span class="keyword">long</span> nanoTime) {</span><br><span class="line">    <span class="keyword">super</span>(executor, callable);</span><br><span class="line">    deadlineNanos = nanoTime;</span><br><span class="line">    periodNanos = <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ¯ä¸ªå­—æ®µæ¯”è¾ƒç®€å•ï¼Œèƒ–å‹çœ‹ä¸Šé¢çš„æ³¨é‡Šã€‚</li>
</ul>
<h2 id="2-5-delayNanos"><a href="#2-5-delayNanos" class="headerlink" title="2.5 delayNanos"></a>2.5 delayNanos</h2><p><code>#delayNanos(...)</code> æ–¹æ³•ï¼Œè·å¾—è·ç¦»æŒ‡å®šæ—¶é—´ï¼Œè¿˜è¦å¤šä¹…å¯æ‰§è¡Œã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> è·ç¦»å½“å‰æ—¶é—´ï¼Œè¿˜è¦å¤šä¹…å¯æ‰§è¡Œã€‚è‹¥ä¸ºè´Ÿæ•°ï¼Œç›´æ¥è¿”å› 0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">delayNanos</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> Math.max(<span class="number">0</span>, deadlineNanos() - nanoTime());</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> currentTimeNanos æŒ‡å®šæ—¶é—´</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> è·ç¦»æŒ‡å®šæ—¶é—´ï¼Œè¿˜è¦å¤šä¹…å¯æ‰§è¡Œã€‚è‹¥ä¸ºè´Ÿæ•°ï¼Œç›´æ¥è¿”å› 0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">delayNanos</span><span class="params">(<span class="keyword">long</span> currentTimeNanos)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> Math.max(<span class="number">0</span>, deadlineNanos() - (currentTimeNanos - START_TIME));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getDelay</span><span class="params">(TimeUnit unit)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> unit.convert(delayNanos(), TimeUnit.NANOSECONDS);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-6-run"><a href="#2-6-run" class="headerlink" title="2.6 run"></a>2.6 run</h2><p><code>#run()</code> æ–¹æ³•ï¼Œæ‰§è¡Œå®šæ—¶ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">3</span>:     <span class="function"><span class="keyword">assert</span> <span class="title">executor</span><span class="params">()</span>.<span class="title">inEventLoop</span><span class="params">()</span></span>;</span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (periodNanos == <span class="number">0</span>) {</span><br><span class="line"> <span class="number">6</span>:             <span class="comment">// è®¾ç½®ä»»åŠ¡ä¸å¯å–æ¶ˆ</span></span><br><span class="line"> <span class="number">7</span>:             <span class="keyword">if</span> (setUncancellableInternal()) {</span><br><span class="line"> <span class="number">8</span>:                 <span class="comment">// æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"> <span class="number">9</span>:                 V result = task.call();</span><br><span class="line"><span class="number">10</span>:                 <span class="comment">// é€šçŸ¥ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ</span></span><br><span class="line"><span class="number">11</span>:                 setSuccessInternal(result);</span><br><span class="line"><span class="number">12</span>:             }</span><br><span class="line"><span class="number">13</span>:         } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">14</span>:             <span class="comment">// åˆ¤æ–­ä»»åŠ¡å¹¶æœªå–æ¶ˆ</span></span><br><span class="line"><span class="number">15</span>:             <span class="comment">// check if is done as it may was cancelled</span></span><br><span class="line"><span class="number">16</span>:             <span class="keyword">if</span> (!isCancelled()) {</span><br><span class="line"><span class="number">17</span>:                 <span class="comment">// æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line"><span class="number">18</span>:                 task.call();</span><br><span class="line"><span class="number">19</span>:                 <span class="keyword">if</span> (!executor().isShutdown()) {</span><br><span class="line"><span class="number">20</span>:                     <span class="comment">// è®¡ç®—ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´</span></span><br><span class="line"><span class="number">21</span>:                     <span class="keyword">long</span> p = periodNanos;</span><br><span class="line"><span class="number">22</span>:                     <span class="keyword">if</span> (p &gt; <span class="number">0</span>) {</span><br><span class="line"><span class="number">23</span>:                         deadlineNanos += p;</span><br><span class="line"><span class="number">24</span>:                     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">25</span>:                         deadlineNanos = nanoTime() - p;</span><br><span class="line"><span class="number">26</span>:                     }</span><br><span class="line"><span class="number">27</span>:                     <span class="comment">// åˆ¤æ–­ä»»åŠ¡å¹¶æœªå–æ¶ˆ</span></span><br><span class="line"><span class="number">28</span>:                     <span class="keyword">if</span> (!isCancelled()) {</span><br><span class="line"><span class="number">29</span>:                         <span class="comment">// é‡æ–°æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰å¾…ä¸‹æ¬¡å®šæ—¶æ‰§è¡Œ</span></span><br><span class="line"><span class="number">30</span>:                         <span class="comment">// scheduledTaskQueue can never be null as we lazy init it before submit the task!</span></span><br><span class="line"><span class="number">31</span>:                         Queue&lt;ScheduledFutureTask&lt;?&gt;&gt; scheduledTaskQueue =</span><br><span class="line"><span class="number">32</span>:                                 ((AbstractScheduledEventExecutor) executor()).scheduledTaskQueue;</span><br><span class="line"><span class="number">33</span>:                         <span class="keyword">assert</span> scheduledTaskQueue != <span class="keyword">null</span>;</span><br><span class="line"><span class="number">34</span>:                         scheduledTaskQueue.add(<span class="keyword">this</span>);</span><br><span class="line"><span class="number">35</span>:                     }</span><br><span class="line"><span class="number">36</span>:                 }</span><br><span class="line"><span class="number">37</span>:             }</span><br><span class="line"><span class="number">38</span>:         }</span><br><span class="line"><span class="number">39</span>:     <span class="comment">// å‘ç”Ÿå¼‚å¸¸ï¼Œé€šçŸ¥ä»»åŠ¡æ‰§è¡Œå¤±è´¥</span></span><br><span class="line"><span class="number">40</span>:     } <span class="keyword">catch</span> (Throwable cause) {</span><br><span class="line"><span class="number">41</span>:         setFailureInternal(cause);</span><br><span class="line"><span class="number">42</span>:     }</span><br><span class="line"><span class="number">43</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šæ ¡éªŒï¼Œå¿…é¡»åœ¨ EventLoop çš„çº¿ç¨‹ä¸­ã€‚</li>
<li>æ ¹æ®ä¸åŒçš„ä»»åŠ¡æ‰§è¡Œå‘¨æœŸ <code>periodNanos</code> ï¼Œåœ¨æ‰§è¡Œä»»åŠ¡ä¼šç•¥æœ‰ä¸åŒã€‚å½“ç„¶ï¼Œå¤§ä½“æ˜¯ç›¸åŒçš„ã€‚</li>
<li>ç¬¬ 5 è‡³ 12 è¡Œï¼šæ‰§è¡Œå‘¨æœŸä¸ºâ€œ<strong>åªæ‰§è¡Œä¸€æ¬¡</strong>â€çš„å®šæ—¶ä»»åŠ¡ã€‚<ul>
<li>ç¬¬ 7 è¡Œï¼šè°ƒç”¨ <code>PromiseTask#setUncancellableInternal()</code> æ–¹æ³•ï¼Œè®¾ç½®ä»»åŠ¡ä¸å¯å–æ¶ˆã€‚å…·ä½“çš„æ–¹æ³•å®ç°ï¼Œæˆ‘ä»¬åœ¨åç»­å…³äº Promise çš„æ–‡ç« ä¸­åˆ†äº«ã€‚</li>
<li>ç¬¬ 9 è¡Œï¼šã€é‡è¦ã€‘è°ƒç”¨ <code>Callable#call()</code> æ–¹æ³•ï¼Œæ‰§è¡Œä»»åŠ¡ã€‚</li>
<li>ç¬¬ 11 è¡Œï¼šè°ƒç”¨ <code>PromiseTask#setSuccessInternal(V result)</code> æ–¹æ³•ï¼Œå›è°ƒé€šçŸ¥æ³¨å†Œåœ¨å®šæ—¶ä»»åŠ¡ä¸Šçš„ç›‘å¬å™¨ã€‚ä¸ºä»€ä¹ˆèƒ½è¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸º ScheduledFutureTask ç»§æ‰¿äº† PromiseTask æŠ½è±¡ç±»ã€‚</li>
</ul>
</li>
<li>ç¬¬ 13 è‡³ 38 è¡Œï¼šæ‰§è¡Œå‘¨æœŸä¸ºâ€œ<strong>å›ºå®šå‘¨æœŸ</strong>â€çš„å®šæ—¶ä»»åŠ¡ã€‚<ul>
<li>ç¬¬ 16 è¡Œï¼šè°ƒç”¨ <code>DefaultPromise#isCancelled()</code> æ–¹æ³•ï¼Œåˆ¤æ–­ä»»åŠ¡æ˜¯å¦å·²ç»å–æ¶ˆã€‚è¿™ä¸€ç‚¹ï¼Œå’Œã€ç¬¬ 7 è¡Œã€‘çš„ä»£ç ï¼Œ<strong>æ˜¯ä¸åŒçš„</strong>ã€‚å…·ä½“çš„æ–¹æ³•å®ç°ï¼Œæˆ‘ä»¬åœ¨åç»­å…³äº Promise çš„æ–‡ç« ä¸­åˆ†äº«ã€‚</li>
<li>ç¬¬ 18 è¡Œï¼šã€é‡è¦ã€‘è°ƒç”¨ <code>Callable#call()</code> æ–¹æ³•ï¼Œæ‰§è¡Œä»»åŠ¡ã€‚</li>
<li>ç¬¬ 19 è¡Œï¼šåˆ¤æ–­ EventExecutor å¹¶æœªå…³é—­ã€‚</li>
<li>ç¬¬ 20 è‡³ 26 è¡Œï¼šè®¡ç®—ä¸‹æ¬¡å®šæ—¶æ‰§è¡Œçš„æ—¶é—´ã€‚ä¸åŒçš„æ‰§è¡Œ <code>fixed</code> æ–¹å¼ï¼Œè®¡ç®—æ–¹å¼ä¸åŒã€‚å…¶ä¸­ã€ç¬¬ 25 è¡Œã€‘çš„ <code>- p</code> çš„ä»£ç ï¼Œå› ä¸º <code>p</code> æ˜¯è´Ÿæ•°ï¼Œæ‰€ä»¥é€šè¿‡<strong>è´Ÿè´Ÿå¾—æ­£</strong>æ¥è®¡ç®—ã€‚å¦å¤–ï¼Œè¿™å—ä¼šä¿®æ”¹å®šæ—¶ä»»åŠ¡çš„ <code>deadlineNanos</code> å±æ€§ï¼Œä»è€Œå˜æˆæ–°çš„å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ—¶é—´ã€‚</li>
<li>ç¬¬ 28 è¡Œï¼šå’Œã€ç¬¬ 16 è¡Œã€‘çš„ä»£ç æ˜¯<strong>ä¸€è‡´</strong>çš„ã€‚</li>
<li>ç¬¬ 29 è‡³ 34 è¡Œï¼šé‡æ–°æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡é˜Ÿåˆ— <code>scheduledTaskQueue</code> ä¸­ï¼Œç­‰å¾…ä¸‹æ¬¡å®šæ—¶æ‰§è¡Œã€‚</li>
</ul>
</li>
<li>ç¬¬ 39 è‡³ 42 è¡Œï¼šå‘ç”Ÿå¼‚å¸¸ï¼Œè°ƒç”¨ <code>PromiseTask#setFailureInternal(Throwable cause)</code> æ–¹æ³•ï¼Œå›è°ƒé€šçŸ¥æ³¨å†Œåœ¨å®šæ—¶ä»»åŠ¡ä¸Šçš„ç›‘å¬å™¨ã€‚</li>
</ul>
<h2 id="2-7-cancel"><a href="#2-7-cancel" class="headerlink" title="2.7 cancel"></a>2.7 cancel</h2><p>æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œå¯ä»¥å–æ¶ˆå®šæ—¶ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span> </span>{</span><br><span class="line">    <span class="keyword">boolean</span> canceled = <span class="keyword">super</span>.cancel(mayInterruptIfRunning);</span><br><span class="line">    <span class="comment">// å–æ¶ˆæˆåŠŸï¼Œç§»é™¤å‡ºå®šæ—¶ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">if</span> (canceled) {</span><br><span class="line">        ((AbstractScheduledEventExecutor) executor()).removeScheduled(<span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> canceled;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç§»é™¤ä»»åŠ¡</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">cancelWithoutRemove</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.cancel(mayInterruptIfRunning);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å·®åˆ«åœ¨äºï¼Œæ˜¯å¦ è°ƒç”¨ <code>AbstractScheduledEventExecutor#removeScheduled(ScheduledFutureTask)</code> æ–¹æ³•ï¼Œä»å®šæ—¶ä»»åŠ¡é˜Ÿåˆ—ç§»é™¤è‡ªå·±ã€‚</li>
</ul>
<h2 id="2-8-compareTo"><a href="#2-8-compareTo" class="headerlink" title="2.8 compareTo"></a>2.8 compareTo</h2><p><code>#compareTo(Delayed o)</code> æ–¹æ³•ï¼Œç”¨äºé˜Ÿåˆ—( ScheduledFutureTask ä½¿ç”¨ PriorityQueue ä½œä¸º<strong>ä¼˜å…ˆçº§é˜Ÿåˆ—</strong> )æ’åºã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Delayed o)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> == o) {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ScheduledFutureTask&lt;?&gt; that = (ScheduledFutureTask&lt;?&gt;) o;</span><br><span class="line">    <span class="keyword">long</span> d = deadlineNanos() - that.deadlineNanos();</span><br><span class="line">    <span class="keyword">if</span> (d &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (d &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (id &lt; that.id) {</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (id == that.id) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æŒ‰ç…§ <code>deadlineNanos</code>ã€<code>id</code> å±æ€§<strong>å‡åº</strong>æ’åºã€‚</li>
</ul>
<h2 id="2-9-priorityQueueIndex"><a href="#2-9-priorityQueueIndex" class="headerlink" title="2.9 priorityQueueIndex"></a>2.9 priorityQueueIndex</h2><p><code>#priorityQueueIndex(...)</code> æ–¹æ³•ï¼Œè·å¾—æˆ–è®¾ç½® <code>queueIndex</code> å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">priorityQueueIndex</span><span class="params">(DefaultPriorityQueue&lt;?&gt; queue)</span> </span>{ <span class="comment">// è·å¾—</span></span><br><span class="line">    <span class="keyword">return</span> queueIndex;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">priorityQueueIndex</span><span class="params">(DefaultPriorityQueue&lt;?&gt; queue, <span class="keyword">int</span> i)</span> </span>{ <span class="comment">// è®¾ç½®</span></span><br><span class="line">    queueIndex = i;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å› ä¸º ScheduledFutureTask å®ç° PriorityQueueNode æ¥å£ï¼Œæ‰€ä»¥éœ€è¦å®ç°è¿™ä¸¤ä¸ªæ–¹æ³•ã€‚</li>
</ul>
<h1 id="3-AbstractScheduledEventExecutor"><a href="#3-AbstractScheduledEventExecutor" class="headerlink" title="3. AbstractScheduledEventExecutor"></a>3. AbstractScheduledEventExecutor</h1><p><code>io.netty.util.concurrent.AbstractScheduledEventExecutor</code> ï¼Œç»§æ‰¿ AbstractEventExecutor æŠ½è±¡ç±»ï¼Œ<strong>æ”¯æŒå®šæ—¶ä»»åŠ¡</strong>çš„ EventExecutor çš„æŠ½è±¡ç±»ã€‚</p>
<h2 id="3-1-æ„é€ æ–¹æ³•"><a href="#3-1-æ„é€ æ–¹æ³•" class="headerlink" title="3.1 æ„é€ æ–¹æ³•"></a>3.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®šæ—¶ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">PriorityQueue&lt;ScheduledFutureTask&lt;?&gt;&gt; scheduledTaskQueue;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">AbstractScheduledEventExecutor</span><span class="params">()</span> </span>{</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">AbstractScheduledEventExecutor</span><span class="params">(EventExecutorGroup parent)</span> </span>{</span><br><span class="line">    <span class="keyword">super</span>(parent);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>scheduledTaskQueue</code> å±æ€§ï¼Œå®šæ—¶ä»»åŠ¡é˜Ÿåˆ—ã€‚</li>
</ul>
<h2 id="3-2-scheduledTaskQueue"><a href="#3-2-scheduledTaskQueue" class="headerlink" title="3.2 scheduledTaskQueue"></a>3.2 scheduledTaskQueue</h2><p><code>#scheduledTaskQueue()</code> æ–¹æ³•ï¼Œè·å¾—å®šæ—¶ä»»åŠ¡é˜Ÿåˆ—ã€‚è‹¥æœªåˆå§‹åŒ–ï¼Œåˆ™è¿›è¡Œåˆ›å»ºã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®šæ—¶ä»»åŠ¡æ’åºå™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Comparator&lt;ScheduledFutureTask&lt;?&gt;&gt; SCHEDULED_FUTURE_TASK_COMPARATOR =</span><br><span class="line">        <span class="keyword">new</span> Comparator&lt;ScheduledFutureTask&lt;?&gt;&gt;() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(ScheduledFutureTask&lt;?&gt; o1, ScheduledFutureTask&lt;?&gt; o2)</span> </span>{</span><br><span class="line">                <span class="keyword">return</span> o1.compareTo(o2); <span class="comment">//</span></span><br><span class="line">            }</span><br><span class="line">        };</span><br><span class="line"></span><br><span class="line">PriorityQueue&lt;ScheduledFutureTask&lt;?&gt;&gt; scheduledTaskQueue() {</span><br><span class="line">    <span class="keyword">if</span> (scheduledTaskQueue == <span class="keyword">null</span>) {</span><br><span class="line">        scheduledTaskQueue = <span class="keyword">new</span> DefaultPriorityQueue&lt;ScheduledFutureTask&lt;?&gt;&gt;(</span><br><span class="line">                SCHEDULED_FUTURE_TASK_COMPARATOR,</span><br><span class="line">                <span class="comment">// Use same initial capacity as java.util.PriorityQueue</span></span><br><span class="line">                <span class="number">11</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> scheduledTaskQueue;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åˆ›å»ºçš„é˜Ÿåˆ—æ˜¯ <code>io.netty.util.internal.DefaultPriorityQueue</code> ç±»å‹ã€‚å…·ä½“çš„ä»£ç å®ç°ï¼Œæœ¬æ–‡å…ˆä¸è§£æã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åªè¦çŸ¥é“å®ƒæ˜¯ä¸€ä¸ª<strong>ä¼˜å…ˆçº§</strong>é˜Ÿåˆ—ï¼Œé€šè¿‡ <code>SCHEDULED_FUTURE_TASK_COMPARATOR</code> æ¥æ¯”è¾ƒæ’åº ScheduledFutureTask çš„ä»»åŠ¡ä¼˜å…ˆçº§( é¡ºåº )ã€‚</li>
<li><code>SCHEDULED_FUTURE_TASK_COMPARATOR</code> çš„å…·ä½“å®ç°ï¼Œæ˜¯è°ƒç”¨ <a href="#">ã€Œ2.8 compareToã€</a> æ–¹æ³•æ¥å®ç°ï¼Œæ‰€ä»¥é˜Ÿåˆ—<strong>é¦–ä¸ª</strong>ä»»åŠ¡ï¼Œå°±æ˜¯<strong>ç¬¬ä¸€ä¸ª</strong>éœ€è¦æ‰§è¡Œçš„å®šæ—¶ä»»åŠ¡ã€‚</li>
</ul>
<h2 id="3-3-nanoTime"><a href="#3-3-nanoTime" class="headerlink" title="3.3 nanoTime"></a>3.3 nanoTime</h2><p><code>#nanoTime()</code> <strong>é™æ€</strong>æ–¹æ³•ï¼Œè·å¾—å½“å‰æ—¶é—´ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">nanoTime</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> ScheduledFutureTask.nanoTime();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨æ–¹æ³•å†…éƒ¨ï¼Œä¼šè°ƒç”¨ <a href="#">ã€Œ2.2 nanoTimeã€</a> æ–¹æ³•ã€‚</li>
</ul>
<h2 id="3-4-schedule"><a href="#3-4-schedule" class="headerlink" title="3.4 schedule"></a>3.4 schedule</h2><p><code>#schedule(final ScheduledFutureTask&lt;V&gt; task)</code> æ–¹æ³•ï¼Œæäº¤å®šæ—¶ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">&lt;V&gt; <span class="function">ScheduledFuture&lt;V&gt; <span class="title">schedule</span><span class="params">(<span class="keyword">final</span> ScheduledFutureTask&lt;V&gt; task)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (inEventLoop()) {</span><br><span class="line">        <span class="comment">// æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">        scheduledTaskQueue().add(task);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// é€šè¿‡ EventLoop çš„çº¿ç¨‹ï¼Œæ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">        execute(<span class="keyword">new</span> Runnable() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">                scheduledTaskQueue().add(task);</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> task;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¿…é¡»åœ¨ EventLoop çš„çº¿ç¨‹ä¸­ï¼Œ<strong>æ‰èƒ½</strong>æ·»åŠ åˆ°å®šæ—¶ä»»åŠ¡åˆ°é˜Ÿåˆ—ä¸­ã€‚</li>
</ul>
<p>åœ¨ ScheduledFutureTask ä¸­ï¼Œæœ‰å››ä¸ªæ–¹æ³•ï¼Œä¼šè°ƒç”¨ <code>#schedule(final ScheduledFutureTask&lt;V&gt; task)</code> æ–¹æ³•ï¼Œåˆ†åˆ«åˆ›å»º <strong>3</strong> ç§ä¸åŒç±»å‹çš„å®šæ—¶ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;V&gt; <span class="function">ScheduledFuture&lt;V&gt; <span class="title">schedule</span><span class="params">(Callable&lt;V&gt; callable, <span class="keyword">long</span> delay, TimeUnit unit)</span> </span>{</span><br><span class="line">    ObjectUtil.checkNotNull(callable, <span class="string">"callable"</span>);</span><br><span class="line">    ObjectUtil.checkNotNull(unit, <span class="string">"unit"</span>);</span><br><span class="line">    <span class="keyword">if</span> (delay &lt; <span class="number">0</span>) {</span><br><span class="line">        delay = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// æ— è§†ï¼Œå·²ç»åºŸå¼ƒ</span></span><br><span class="line">    validateScheduled0(delay, unit);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> schedule(<span class="keyword">new</span> ScheduledFutureTask&lt;V&gt;(</span><br><span class="line">            <span class="keyword">this</span>, callable, ScheduledFutureTask.deadlineNanos(unit.toNanos(delay))));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable command, <span class="keyword">long</span> initialDelay, <span class="keyword">long</span> period, TimeUnit unit) {</span><br><span class="line">    ObjectUtil.checkNotNull(command, <span class="string">"command"</span>);</span><br><span class="line">    ObjectUtil.checkNotNull(unit, <span class="string">"unit"</span>);</span><br><span class="line">    <span class="keyword">if</span> (initialDelay &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                String.format(<span class="string">"initialDelay: %d (expected: &gt;= 0)"</span>, initialDelay));</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (period &lt;= <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                String.format(<span class="string">"period: %d (expected: &gt; 0)"</span>, period));</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// æ— è§†ï¼Œå·²ç»åºŸå¼ƒ</span></span><br><span class="line">    validateScheduled0(initialDelay, unit);</span><br><span class="line">    validateScheduled0(period, unit);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> schedule(<span class="keyword">new</span> ScheduledFutureTask&lt;Void&gt;(</span><br><span class="line">            <span class="keyword">this</span>, Executors.&lt;Void&gt;callable(command, <span class="keyword">null</span>), <span class="comment">// Runnable =&gt; Callable</span></span><br><span class="line">            ScheduledFutureTask.deadlineNanos(unit.toNanos(initialDelay)), unit.toNanos(period)));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable command, <span class="keyword">long</span> initialDelay, <span class="keyword">long</span> delay, TimeUnit unit) {</span><br><span class="line">    ObjectUtil.checkNotNull(command, <span class="string">"command"</span>);</span><br><span class="line">    ObjectUtil.checkNotNull(unit, <span class="string">"unit"</span>);</span><br><span class="line">    <span class="keyword">if</span> (initialDelay &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                String.format(<span class="string">"initialDelay: %d (expected: &gt;= 0)"</span>, initialDelay));</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                String.format(<span class="string">"delay: %d (expected: &gt; 0)"</span>, delay));</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// æ— è§†ï¼Œå·²ç»åºŸå¼ƒ</span></span><br><span class="line">    validateScheduled0(initialDelay, unit);</span><br><span class="line">    validateScheduled0(delay, unit);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> schedule(<span class="keyword">new</span> ScheduledFutureTask&lt;Void&gt;(</span><br><span class="line">            <span class="keyword">this</span>, Executors.&lt;Void&gt;callable(command, <span class="keyword">null</span>), <span class="comment">// Runnable =&gt; Callable</span></span><br><span class="line">            ScheduledFutureTask.deadlineNanos(unit.toNanos(initialDelay)), -unit.toNanos(delay)));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ¯ä¸ªæ–¹æ³•ï¼Œå‰é¢éƒ½æ˜¯æ ¡éªŒå‚æ•°çš„ä»£ç ï¼Œé‡ç‚¹æ˜¯åœ¨æœ€åå¯¹ <code>#schedule(final ScheduledFutureTask&lt;V&gt; task)</code> æ–¹æ³•çš„è°ƒç”¨ã€‚</li>
</ul>
<h2 id="3-5-removeScheduled"><a href="#3-5-removeScheduled" class="headerlink" title="3.5 removeScheduled"></a>3.5 removeScheduled</h2><p><code>#removeScheduled(final ScheduledFutureTask&lt;?&gt; task)</code> æ–¹æ³•ï¼Œç§»é™¤å‡ºå®šæ—¶ä»»åŠ¡é˜Ÿåˆ—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">removeScheduled</span><span class="params">(<span class="keyword">final</span> ScheduledFutureTask&lt;?&gt; task)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (inEventLoop()) {</span><br><span class="line">        <span class="comment">// ç§»é™¤å‡ºå®šæ—¶ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">        scheduledTaskQueue().removeTyped(task);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// é€šè¿‡ EventLoop çš„çº¿ç¨‹ï¼Œç§»é™¤å‡ºå®šæ—¶ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">        execute(<span class="keyword">new</span> Runnable() {</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">                removeScheduled(task);</span><br><span class="line">            }</span><br><span class="line">        });</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¿…é¡»åœ¨ EventLoop çš„çº¿ç¨‹ä¸­ï¼Œ<strong>æ‰èƒ½</strong>ç§»é™¤å‡ºå®šæ—¶ä»»åŠ¡é˜Ÿåˆ—ã€‚</li>
</ul>
<h2 id="3-6-hasScheduledTasks"><a href="#3-6-hasScheduledTasks" class="headerlink" title="3.6 hasScheduledTasks"></a>3.6 hasScheduledTasks</h2><p><code>#hasScheduledTasks()</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰å¯æ‰§è¡Œçš„å®šæ—¶ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns {<span class="doctag">@code</span> true} if a scheduled task is ready for processing.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">hasScheduledTasks</span><span class="params">()</span> </span>{</span><br><span class="line">    Queue&lt;ScheduledFutureTask&lt;?&gt;&gt; scheduledTaskQueue = <span class="keyword">this</span>.scheduledTaskQueue;</span><br><span class="line">    <span class="comment">// è·å¾—é˜Ÿåˆ—é¦–ä¸ªå®šæ—¶ä»»åŠ¡ã€‚ä¸ä¼šä»é˜Ÿåˆ—ä¸­ï¼Œç§»é™¤è¯¥ä»»åŠ¡</span></span><br><span class="line">    ScheduledFutureTask&lt;?&gt; scheduledTask = scheduledTaskQueue == <span class="keyword">null</span> ? <span class="keyword">null</span> : scheduledTaskQueue.peek();</span><br><span class="line">    <span class="comment">// åˆ¤æ–­è¯¥ä»»åŠ¡æ˜¯å¦åˆ°è¾¾å¯æ‰§è¡Œçš„æ—¶é—´</span></span><br><span class="line">    <span class="keyword">return</span> scheduledTask != <span class="keyword">null</span> &amp;&amp; scheduledTask.deadlineNanos() &lt;= nanoTime();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹ç›´æ¥çœ‹æ–¹æ³•æ³¨é‡Šã€‚</li>
</ul>
<h2 id="3-7-peekScheduledTask"><a href="#3-7-peekScheduledTask" class="headerlink" title="3.7 peekScheduledTask"></a>3.7 peekScheduledTask</h2><p><code>#peekScheduledTask()</code> æ–¹æ³•ï¼Œè·å¾—é˜Ÿåˆ—é¦–ä¸ªå®šæ—¶ä»»åŠ¡ã€‚ä¸ä¼šä»é˜Ÿåˆ—ä¸­ï¼Œç§»é™¤è¯¥ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> ScheduledFutureTask&lt;?&gt; peekScheduledTask() {</span><br><span class="line">    Queue&lt;ScheduledFutureTask&lt;?&gt;&gt; scheduledTaskQueue = <span class="keyword">this</span>.scheduledTaskQueue;</span><br><span class="line">    <span class="keyword">if</span> (scheduledTaskQueue == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> scheduledTaskQueue.peek();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-8-nextScheduledTaskNano"><a href="#3-8-nextScheduledTaskNano" class="headerlink" title="3.8 nextScheduledTaskNano"></a>3.8 nextScheduledTaskNano</h2><p><code>#nextScheduledTaskNano()</code> æ–¹æ³•ï¼Œè·å¾—å®šæ—¶ä»»åŠ¡é˜Ÿåˆ—ï¼Œè·ç¦»å½“å‰æ—¶é—´ï¼Œè¿˜è¦å¤šä¹…å¯æ‰§è¡Œã€‚</p>
<ul>
<li>è‹¥é˜Ÿåˆ—<strong>ä¸ºç©º</strong>ï¼Œåˆ™è¿”å› <code>-1</code> ã€‚</li>
<li>è‹¥é˜Ÿåˆ—<strong>éç©º</strong>ï¼Œè‹¥ä¸ºè´Ÿæ•°ï¼Œç›´æ¥è¿”å› 0 ã€‚å®é™…ç­‰ä»·ï¼ŒScheduledFutureTask#delayNanos() æ–¹æ³•ã€‚</li>
</ul>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the nanoseconds when the next scheduled task is ready to be run or {<span class="doctag">@code</span> -1} if no task is scheduled.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">long</span> <span class="title">nextScheduledTaskNano</span><span class="params">()</span> </span>{</span><br><span class="line">    Queue&lt;ScheduledFutureTask&lt;?&gt;&gt; scheduledTaskQueue = <span class="keyword">this</span>.scheduledTaskQueue;</span><br><span class="line">    <span class="comment">// è·å¾—é˜Ÿåˆ—é¦–ä¸ªå®šæ—¶ä»»åŠ¡ã€‚ä¸ä¼šä»é˜Ÿåˆ—ä¸­ï¼Œç§»é™¤è¯¥ä»»åŠ¡</span></span><br><span class="line">    ScheduledFutureTask&lt;?&gt; scheduledTask = scheduledTaskQueue == <span class="keyword">null</span> ? <span class="keyword">null</span> : scheduledTaskQueue.peek();</span><br><span class="line">    <span class="keyword">if</span> (scheduledTask == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// è·ç¦»å½“å‰æ—¶é—´ï¼Œè¿˜è¦å¤šä¹…å¯æ‰§è¡Œã€‚è‹¥ä¸ºè´Ÿæ•°ï¼Œç›´æ¥è¿”å› 0 ã€‚å®é™…ç­‰ä»·ï¼ŒScheduledFutureTask#delayNanos() æ–¹æ³•ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> Math.max(<span class="number">0</span>, scheduledTask.deadlineNanos() - nanoTime());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åŸºæœ¬å¯ä»¥ç­‰ä»· <a href="#">ã€Œ2.5 delayNanosã€</a> çš„æ–¹æ³•ã€‚</li>
</ul>
<h2 id="3-9-pollScheduledTask"><a href="#3-9-pollScheduledTask" class="headerlink" title="3.9 pollScheduledTask"></a>3.9 pollScheduledTask</h2><p><code>#pollScheduledTask(...)</code> æ–¹æ³•ï¼Œè·å¾—æŒ‡å®šæ—¶é—´å†…ï¼Œå®šæ—¶ä»»åŠ¡é˜Ÿåˆ—<strong>é¦–ä¸ª</strong>å¯æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä»é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #pollScheduledTask(long)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> Runnable <span class="title">pollScheduledTask</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> pollScheduledTask(nanoTime()); <span class="comment">// å½“å‰æ—¶é—´</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the {<span class="doctag">@link</span> Runnable} which is ready to be executed with the given {<span class="doctag">@code</span> nanoTime}.</span></span><br><span class="line"><span class="comment"> * You should use {<span class="doctag">@link</span> #nanoTime()} to retrieve the correct {<span class="doctag">@code</span> nanoTime}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> Runnable <span class="title">pollScheduledTask</span><span class="params">(<span class="keyword">long</span> nanoTime)</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">assert</span> <span class="title">inEventLoop</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    Queue&lt;ScheduledFutureTask&lt;?&gt;&gt; scheduledTaskQueue = <span class="keyword">this</span>.scheduledTaskQueue;</span><br><span class="line">    <span class="comment">// è·å¾—é˜Ÿåˆ—é¦–ä¸ªå®šæ—¶ä»»åŠ¡ã€‚ä¸ä¼šä»é˜Ÿåˆ—ä¸­ï¼Œç§»é™¤è¯¥ä»»åŠ¡</span></span><br><span class="line">    ScheduledFutureTask&lt;?&gt; scheduledTask = scheduledTaskQueue == <span class="keyword">null</span> ? <span class="keyword">null</span> : scheduledTaskQueue.peek();</span><br><span class="line">    <span class="comment">// ç›´æ¥è¿”å›ï¼Œè‹¥è·å–ä¸åˆ°</span></span><br><span class="line">    <span class="keyword">if</span> (scheduledTask == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨æŒ‡å®šæ—¶é—´å†…ï¼Œåˆ™è¿”å›è¯¥ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">if</span> (scheduledTask.deadlineNanos() &lt;= nanoTime) {</span><br><span class="line">        scheduledTaskQueue.remove(); <span class="comment">// ç§»é™¤ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">return</span> scheduledTask;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-10-cancelScheduledTasks"><a href="#3-10-cancelScheduledTasks" class="headerlink" title="3.10 cancelScheduledTasks"></a>3.10 cancelScheduledTasks</h2><p><code>#cancelScheduledTasks()</code> æ–¹æ³•ï¼Œå–æ¶ˆå®šæ—¶ä»»åŠ¡é˜Ÿåˆ—çš„æ‰€æœ‰ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Cancel all scheduled tasks.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * This method MUST be called only when {<span class="doctag">@link</span> #inEventLoop()} is {<span class="doctag">@code</span> true}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">cancelScheduledTasks</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">assert</span> <span class="title">inEventLoop</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è‹¥é˜Ÿåˆ—ä¸ºç©ºï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    PriorityQueue&lt;ScheduledFutureTask&lt;?&gt;&gt; scheduledTaskQueue = <span class="keyword">this</span>.scheduledTaskQueue;</span><br><span class="line">    <span class="keyword">if</span> (isNullOrEmpty(scheduledTaskQueue)) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾ªç¯ï¼Œå–æ¶ˆæ‰€æœ‰ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">final</span> ScheduledFutureTask&lt;?&gt;[] scheduledTasks = scheduledTaskQueue.toArray(<span class="keyword">new</span> ScheduledFutureTask&lt;?&gt;[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">for</span> (ScheduledFutureTask&lt;?&gt; task : scheduledTasks) {</span><br><span class="line">        task.cancelWithoutRemove(<span class="keyword">false</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    scheduledTaskQueue.clearIgnoringIndexes();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isNullOrEmpty</span><span class="params">(Queue&lt;ScheduledFutureTask&lt;?&gt;&gt; queue)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> queue == <span class="keyword">null</span> || queue.isEmpty();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚</li>
</ul>
<h1 id="4-SingleThreadEventExecutor"><a href="#4-SingleThreadEventExecutor" class="headerlink" title="4. SingleThreadEventExecutor"></a>4. SingleThreadEventExecutor</h1><p>åœ¨ <a href="http://svip.iocoder.cn/Netty/EventLoop-6-EventLoop-handle-normal-task?self">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” EventLoopï¼ˆå…­ï¼‰ä¹‹ EventLoop å¤„ç†æ™®é€šä»»åŠ¡ã€‹</a> ä¸­ï¼Œæœ‰ä¸ª <code>#fetchFromScheduledTaskQueue()</code> æ–¹æ³•ï¼Œå°†å®šæ—¶ä»»åŠ¡é˜Ÿåˆ— <code>scheduledTaskQueue</code> åˆ°è¾¾å¯æ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ— <code>taskQueue</code> ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">fetchFromScheduledTaskQueue</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// è·å¾—å½“å‰æ—¶é—´</span></span><br><span class="line">    <span class="keyword">long</span> nanoTime = AbstractScheduledEventExecutor.nanoTime();</span><br><span class="line">    <span class="comment">// è·å¾—æŒ‡å®šæ—¶é—´å†…ï¼Œå®šæ—¶ä»»åŠ¡é˜Ÿåˆ—**é¦–ä¸ª**å¯æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä»é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚</span></span><br><span class="line">    Runnable scheduledTask  = pollScheduledTask(nanoTime);</span><br><span class="line">    <span class="comment">// ä¸æ–­ä»å®šæ—¶ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œè·å¾—</span></span><br><span class="line">    <span class="keyword">while</span> (scheduledTask != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// å°†å®šæ—¶ä»»åŠ¡æ·»åŠ åˆ° taskQueue ä¸­ã€‚è‹¥æ·»åŠ å¤±è´¥ï¼Œåˆ™ç»“æŸå¾ªç¯ï¼Œè¿”å› false ï¼Œè¡¨ç¤ºæœªè·å–å®Œæ‰€æœ‰è¯¾æ‰§è¡Œçš„å®šæ—¶ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (!taskQueue.offer(scheduledTask)) {</span><br><span class="line">            <span class="comment">// å°†å®šæ—¶ä»»åŠ¡æ·»åŠ å› scheduledTaskQueue ä¸­</span></span><br><span class="line">            <span class="comment">// No space left in the task queue add it back to the scheduledTaskQueue so we pick it up again.</span></span><br><span class="line">            scheduledTaskQueue().add((ScheduledFutureTask&lt;?&gt;) scheduledTask);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// è·å¾—æŒ‡å®šæ—¶é—´å†…ï¼Œå®šæ—¶ä»»åŠ¡é˜Ÿåˆ—**é¦–ä¸ª**å¯æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶ä¸”ä»é˜Ÿåˆ—ä¸­ç§»é™¤ã€‚</span></span><br><span class="line">        scheduledTask  = pollScheduledTask(nanoTime);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// è¿”å› true ï¼Œè¡¨ç¤ºè·å–å®Œæ‰€æœ‰å¯æ‰§è¡Œçš„å®šæ—¶ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹çœ‹ä¸‹ç¬”è€…çš„è¯¦ç»†ä»£ç æ³¨é‡Šã€‚å“ˆå“ˆå“ˆ</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ²¡æœ‰å½©è›‹ï¼Œç®€å•æ°´æ–‡ä¸€ç¯‡ã€‚</p>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/EventLoop-7-EventLoop-handle-schedule-task/" data-id="ck4pl3fox00difgcfymj1f461" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>