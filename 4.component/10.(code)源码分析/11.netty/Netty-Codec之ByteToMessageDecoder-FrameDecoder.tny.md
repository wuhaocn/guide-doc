<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” Codec ä¹‹ ByteToMessageDecoderï¼ˆäºŒï¼‰FrameDecoder
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>åœ¨ <a href="http://svip.iocoder.cn/Netty/Codec-1-1-ByteToMessageDecoder-core-impl">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Codec ä¹‹ ByteToMessageDecoderï¼ˆä¸€ï¼‰ã€‹</a> ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° ByteToMessageDecoder æœ‰å››ä¸ª FrameDecoder å®ç°ç±»ï¼š</p>
<ul>
<li>â‘  FixedLengthFrameDecoder ï¼ŒåŸºäº<strong>å›ºå®šé•¿åº¦</strong>æ¶ˆæ¯è¿›è¡Œç²˜åŒ…æ‹†åŒ…å¤„ç†çš„ã€‚</li>
<li>â‘¡ LengthFieldBasedFrameDecoder ï¼ŒåŸºäº<strong>æ¶ˆæ¯å¤´æŒ‡å®šæ¶ˆæ¯é•¿åº¦</strong>è¿›è¡Œç²˜åŒ…æ‹†åŒ…å¤„ç†çš„ã€‚</li>
<li>â‘¢ LineBasedFrameDecoder ï¼ŒåŸºäº<strong>æ¢è¡Œ</strong>æ¥è¿›è¡Œæ¶ˆæ¯ç²˜åŒ…æ‹†åŒ…å¤„ç†çš„ã€‚</li>
<li>â‘£ DelimiterBasedFrameDecoder ï¼ŒåŸºäº<strong>æŒ‡å®šæ¶ˆæ¯è¾¹ç•Œæ–¹å¼</strong>è¿›è¡Œç²˜åŒ…æ‹†åŒ…å¤„ç†çš„ã€‚</li>
</ul>
<p>å®é™…ä¸Šï¼Œä¸Šè¿°å››ä¸ª FrameDecoder å®ç°å¯ä»¥è¿›è¡Œè§„æ•´ï¼š</p>
<ul>
<li>â‘  æ˜¯ â‘¡ çš„ç‰¹ä¾‹ï¼Œ<strong>å›ºå®šé•¿åº¦</strong>æ˜¯<strong>æ¶ˆæ¯å¤´æŒ‡å®šæ¶ˆæ¯é•¿åº¦</strong>çš„ä¸€ç§å½¢å¼ã€‚</li>
<li>â‘¢ æ˜¯ â‘£ çš„ç‰¹ä¾‹ï¼Œ<strong>æ¢è¡Œ</strong>æ˜¯äº<strong>æŒ‡å®šæ¶ˆæ¯è¾¹ç•Œæ–¹å¼</strong>çš„ä¸€ç§å½¢å¼ã€‚</li>
</ul>
<p>æœ¬æ–‡ï¼Œç¬”è€…åªåˆ†äº« â‘  å’Œ â‘¢ ã€‚å¯¹äº â‘¡ å’Œ â‘£ ï¼Œä¼šæä¾›ç›¸å…³çš„æ–‡ç« ã€‚</p>
<h1 id="2-FixedLengthFrameDecoder"><a href="#2-FixedLengthFrameDecoder" class="headerlink" title="2. FixedLengthFrameDecoder"></a>2. FixedLengthFrameDecoder</h1><p><code>io.netty.handler.codec.FixedLengthFrameDecoder</code> ï¼Œç»§æ‰¿ ByteToMessageDecoder æŠ½è±¡ç±»ï¼ŒåŸºäº<strong>å›ºå®šé•¿åº¦</strong>æ¶ˆæ¯è¿›è¡Œç²˜åŒ…æ‹†åŒ…å¤„ç†çš„ã€‚</p>
<p>å¦‚æœä¸‹æ˜¯å›ºå®šé•¿åº¦ä¸º 3 çš„æ•°æ®æµè§£ç ï¼š</p>
<figure class="highlight plain"><table><tbody><tr><td class="code"><pre><span class="line">+---+----+------+----+      +-----+-----+-----+</span><br><span class="line">| A | BC | DEFG | HI |  -&gt;  | ABC | DEF | GHI |</span><br><span class="line">+---+----+------+----+      +-----+-----+-----+</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-1-æ„é€ æ–¹æ³•"><a href="#2-1-æ„é€ æ–¹æ³•" class="headerlink" title="2.1 æ„é€ æ–¹æ³•"></a>2.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å›ºå®šé•¿åº¦</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> frameLength;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a new instance.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> frameLength the length of the frame</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FixedLengthFrameDecoder</span><span class="params">(<span class="keyword">int</span> frameLength)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (frameLength &lt;= <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"frameLength must be a positive integer: "</span> + frameLength);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">this</span>.frameLength = frameLength;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>frameLength</code> å±æ€§ï¼Œå›ºå®šé•¿åº¦ã€‚</li>
</ul>
<h2 id="2-2-decode"><a href="#2-2-decode" class="headerlink" title="2.2 decode"></a>2.2 decode</h2><p><code>#decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code> æ–¹æ³•ï¼Œæ‰§è¡Œè§£ç ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"><span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"><span class="number">3</span>:     <span class="comment">// è§£ç æ¶ˆæ¯</span></span><br><span class="line"><span class="number">4</span>:     Object decoded = decode(ctx, in);</span><br><span class="line"><span class="number">5</span>:     <span class="comment">// æ·»åŠ åˆ° out ç»“æœä¸­</span></span><br><span class="line"><span class="number">6</span>:     <span class="keyword">if</span> (decoded != <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">7</span>:         out.add(decoded);</span><br><span class="line"><span class="number">8</span>:     }</span><br><span class="line"><span class="number">9</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ç¬¬ 4 è¡Œï¼šè°ƒç”¨ <code>#decode(ChannelHandlerContext ctx, ByteBuf in)</code> æ–¹æ³•ï¼Œè§£ç æ¶ˆæ¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a frame out of the {<span class="doctag">@link</span> ByteBuf} and return it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>   ctx             the {<span class="doctag">@link</span> ChannelHandlerContext} which this {<span class="doctag">@link</span> ByteToMessageDecoder} belongs to</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>   in              the {<span class="doctag">@link</span> ByteBuf} from which to read data</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span>  frame           the {<span class="doctag">@link</span> ByteBuf} which represent the frame or {<span class="doctag">@code</span> null} if no frame could</span></span><br><span class="line"><span class="comment"> *                          be created.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">decode</span><span class="params">(@SuppressWarnings(<span class="string">"UnusedParameters"</span>)</span> ChannelHandlerContext ctx, ByteBuf in) <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">// å¯è¯»å­—èŠ‚ä¸å¤Ÿ frameLength é•¿åº¦ï¼Œæ— æ³•è§£ç å‡ºæ¶ˆæ¯ã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (in.readableBytes() &lt; frameLength) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// å¯è¯»å­—èŠ‚è¶³å¤Ÿ frameLength é•¿åº¦ï¼Œè§£ç å‡ºä¸€æ¡æ¶ˆæ¯ã€‚</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> in.readRetainedSlice(frameLength);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å½“å¯è¯»å­—èŠ‚è¶³å¤Ÿ <code>frameLength</code> é•¿åº¦æ—¶ï¼Œè°ƒç”¨ <code>ByteBuf#readRetainedSlice(int length)</code> æ–¹æ³•ï¼Œè¯»å–ä¸€ä¸ª Slice ByteBuf å¯¹è±¡ï¼Œå¹¶å¢åŠ å¼•ç”¨è®¡æ•°ã€‚å¹¶ä¸”è¯¥ Slice ByteBuf ä½œä¸ºè§£ç çš„ä¸€æ¡æ¶ˆæ¯ã€‚å¦å¤–ï¼Œ<code>ByteBuf#readRetainedSlice(int length)</code> çš„è¿‡ç¨‹ï¼Œå› ä¸ºæ˜¯å…±äº«åŸæœ‰ ByteBuf <code>in</code> æ•°ç»„ï¼Œæ‰€ä»¥ä¸å­˜åœ¨æ•°æ®æ‹·è´ã€‚</li>
</ul>
</li>
<li>ç¬¬ 5 è‡³ 8 è¡Œï¼šè‹¥è§£ç åˆ°æ¶ˆæ¯ï¼Œæ·»åŠ åˆ° <code>out</code> ç»“æœä¸­ã€‚</li>
</ul>
<h1 id="3-LineBasedFrameDecoder"><a href="#3-LineBasedFrameDecoder" class="headerlink" title="3. LineBasedFrameDecoder"></a>3. LineBasedFrameDecoder</h1><p><code>io.netty.handler.codec.LineBasedFrameDecoder</code> ï¼Œç»§æ‰¿ ByteToMessageDecoder æŠ½è±¡ç±»ï¼ŒåŸºäº<strong>æ¢è¡Œ</strong>æ¥è¿›è¡Œæ¶ˆæ¯ç²˜åŒ…æ‹†åŒ…å¤„ç†çš„ã€‚</p>
<p>å®ƒä¼šå¤„ç† <code>"\n"</code> å’Œ <code>"\r\n"</code> ä¸¤ç§æ¢è¡Œç¬¦ã€‚</p>
<h2 id="3-1-æ„é€ æ–¹æ³•"><a href="#3-1-æ„é€ æ–¹æ³•" class="headerlink" title="3.1 æ„é€ æ–¹æ³•"></a>3.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸€æ¡æ¶ˆæ¯çš„æœ€å¤§é•¿åº¦</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Maximum length of a frame we're willing to decode.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> maxLength;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦å¿«é€Ÿå¤±è´¥</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å½“ true æ—¶ï¼Œæœªæ‰¾åˆ°æ¶ˆæ¯ï¼Œä½†æ˜¯è¶…è¿‡æœ€å¤§é•¿åº¦ï¼Œåˆ™é©¬ä¸Šè§¦å‘ Exception åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> * å½“ false æ—¶ï¼Œæœªæ‰¾åˆ°æ¶ˆæ¯ï¼Œä½†æ˜¯è¶…è¿‡æœ€å¤§é•¿åº¦ï¼Œéœ€è¦åŒ¹é…åˆ°ä¸€æ¡æ¶ˆæ¯åï¼Œå†è§¦å‘ Exception åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Whether or not to throw an exception as soon as we exceed maxLength.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> failFast;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦è¿‡æ»¤æ‰æ¢è¡Œåˆ†éš”ç¬¦ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å¦‚æœä¸º true ï¼Œè§£ç çš„æ¶ˆæ¯ä¸åŒ…å«æ¢è¡Œç¬¦ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> stripDelimiter;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦å¤„äºåºŸå¼ƒæ¨¡å¼</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å¦‚æœä¸º true ï¼Œè¯´æ˜è§£æè¶…è¿‡æœ€å¤§é•¿åº¦( maxLength )ï¼Œç»“æœè¿˜æ˜¯æ‰¾ä¸åˆ°æ¢è¡Œç¬¦</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * True if we're discarding input because we're already over maxLength.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> discarding;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åºŸå¼ƒçš„å­—èŠ‚æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> discardedBytes;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœ€åæ‰«æçš„ä½ç½®</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Last scan position.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> offset;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a new decoder.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> maxLength  the maximum length of the decoded frame.</span></span><br><span class="line"><span class="comment"> *                   A {<span class="doctag">@link</span> TooLongFrameException} is thrown if</span></span><br><span class="line"><span class="comment"> *                   the length of the frame exceeds this value.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LineBasedFrameDecoder</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> maxLength)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>(maxLength, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a new decoder.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> maxLength  the maximum length of the decoded frame.</span></span><br><span class="line"><span class="comment"> *                   A {<span class="doctag">@link</span> TooLongFrameException} is thrown if</span></span><br><span class="line"><span class="comment"> *                   the length of the frame exceeds this value.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> stripDelimiter  whether the decoded frame should strip out the</span></span><br><span class="line"><span class="comment"> *                        delimiter or not</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> failFast  If &lt;tt&gt;true&lt;/tt&gt;, a {<span class="doctag">@link</span> TooLongFrameException} is</span></span><br><span class="line"><span class="comment"> *                  thrown as soon as the decoder notices the length of the</span></span><br><span class="line"><span class="comment"> *                  frame will exceed &lt;tt&gt;maxFrameLength&lt;/tt&gt; regardless of</span></span><br><span class="line"><span class="comment"> *                  whether the entire frame has been read.</span></span><br><span class="line"><span class="comment"> *                  If &lt;tt&gt;false&lt;/tt&gt;, a {<span class="doctag">@link</span> TooLongFrameException} is</span></span><br><span class="line"><span class="comment"> *                  thrown after the entire frame that exceeds</span></span><br><span class="line"><span class="comment"> *                  &lt;tt&gt;maxFrameLength&lt;/tt&gt; has been read.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LineBasedFrameDecoder</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> maxLength, <span class="keyword">final</span> <span class="keyword">boolean</span> stripDelimiter, <span class="keyword">final</span> <span class="keyword">boolean</span> failFast)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.maxLength = maxLength;</span><br><span class="line">    <span class="keyword">this</span>.failFast = failFast;</span><br><span class="line">    <span class="keyword">this</span>.stripDelimiter = stripDelimiter;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>maxLength</code> å±æ€§ï¼Œä¸€æ¡æ¶ˆæ¯çš„æœ€å¤§é•¿åº¦ã€‚åŸæœ¬ä»¥ä¸º LineBasedFrameDecoder ä¼šæ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å› ä¸ºå¤šäº† <code>maxLength</code> å¤æ‚å¾ˆå¤šã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿ<ul>
<li>å‡è®¾ <code>maxLength = 2</code> ï¼Œæ¥æ”¶åˆ°çš„æ•°æ®ä¸º <code>"abcd\nEF\n"</code>( ç›´æ¥ä»¥å­—ç¬¦ä¸²ä¸¾ä¾‹ï¼Œä¸ºäº†å¯é˜…è¯»æ€§ )ï¼Œé‚£ä¹ˆ <code>"abcd"</code> æ˜¯ä¸ç¬¦åˆæ¡ä»¶çš„æ¶ˆæ¯ï¼Œå› ä¸ºé•¿åº¦ä¸º 4 ï¼Œè¶…è¿‡æœ€å¤§é•¿åº¦ <code>maxLength</code> ã€‚</li>
<li>ä½†æ˜¯è€ƒè™‘åˆ°æ‹†ç²˜åŒ…çš„æƒ…å†µï¼Œå¯èƒ½åˆå§‹åŒ–æ¥æ”¶åˆ°çš„æ˜¯ <code>"abc"</code> ï¼Œé‚£ä¹ˆæ— æ³•åŒ¹é…åˆ° <code>\n</code> æ¢è¡Œç¬¦ã€‚ä½†æ˜¯å‘¢ï¼Œ<code>"abc"</code> çš„é•¿åº¦ä¸º 3ï¼Œè¶…è¿‡æœ€å¤§é•¿åº¦ <code>maxLength</code> ï¼Œéœ€è¦ç­‰å¾…è¯»å–åˆ° <code>"d\n"</code> éƒ¨åˆ†ï¼Œç„¶åæŠ›å¼ƒ <code>"abcd"</code> æ•´æ¡ã€‚å†ä¹‹åï¼Œç»§ç»­è¯»å–ç¬¦åˆæ¡ä»¶çš„ <code>"EF"</code> æ®µã€‚</li>
<li>ğŸ˜ˆ æ¯”è¾ƒç»•ï¼Œèƒ–å‹å¥½å¥½ç†è§£ä¸‹ã€‚</li>
</ul>
</li>
<li><code>failFast</code> å±æ€§ï¼Œæ˜¯å¦å¿«é€Ÿå¤±è´¥ã€‚<ul>
<li><code>true</code> æ—¶ï¼Œæœªæ‰¾åˆ°æ¶ˆæ¯ï¼Œä½†æ˜¯è¶…è¿‡æœ€å¤§é•¿åº¦ï¼Œåˆ™é©¬ä¸Šè§¦å‘ Exception åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li>
<li>å½“ <code>false</code> æ—¶ï¼Œæœªæ‰¾åˆ°æ¶ˆæ¯ï¼Œä½†æ˜¯è¶…è¿‡æœ€å¤§é•¿åº¦ï¼Œéœ€è¦åŒ¹é…åˆ°ä¸€æ¡æ¶ˆæ¯åï¼Œå†è§¦å‘ Exception åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li>
<li>ğŸ˜ˆ ä¹Ÿæœ‰ç‚¹ç»•ï¼Œç­‰ä¸‹ç»“åˆä»£ç å…·ä½“ç†è§£ã€‚</li>
</ul>
</li>
<li><code>stripDelimiter</code> å±æ€§ï¼Œæ˜¯å¦è¿‡æ»¤æ‰æ¢è¡Œåˆ†éš”ç¬¦ã€‚å¦‚æœä¸º <code>true</code> ï¼Œè§£ç çš„æ¶ˆæ¯ä¸åŒ…å«æ¢è¡Œç¬¦ã€‚</li>
<li><code>discarding</code> å±æ€§ï¼Œæ˜¯å¦å¤„äºåºŸå¼ƒæ¨¡å¼ã€‚å¦‚æœä¸º <code>true</code> ï¼Œè¯´æ˜è§£æè¶…è¿‡æœ€å¤§é•¿åº¦( <code>maxLength</code> )ï¼Œç»“æœè¿˜æ˜¯æ‰¾ä¸åˆ°æ¢è¡Œç¬¦ã€‚<ul>
<li>ğŸ˜ˆ ä¹Ÿæœ‰ç‚¹ç»•ï¼Œç­‰ä¸‹ç»“åˆä»£ç å…·ä½“ç†è§£ã€‚</li>
<li><code>discardedBytes</code> å±æ€§ï¼ŒåºŸå¼ƒçš„å­—èŠ‚æ•°ã€‚</li>
<li><code>offset</code> å±æ€§ï¼Œæœ€åæ‰«æçš„ä½ç½®ã€‚</li>
</ul>
</li>
</ul>
<h2 id="3-2-decode"><a href="#3-2-decode" class="headerlink" title="3.2 decode"></a>3.2 decode</h2><p><code>#decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code> æ–¹æ³•ï¼Œæ‰§è¡Œè§£ç ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    Object decoded = decode(ctx, in);</span><br><span class="line">    <span class="keyword">if</span> (decoded != <span class="keyword">null</span>) {</span><br><span class="line">        out.add(decoded);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¿™æ®µä»£ç ï¼Œå’Œ <code>FixedLengthFrameDecoder#decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</code> æ–¹æ³•ï¼Œæ˜¯ä¸€æ ·çš„ã€‚</li>
</ul>
<hr>
<p><code>#decode(ChannelHandlerContext ctx, ByteBuf buffer)</code> æ–¹æ³•ï¼Œæ‰§è¡Œè§£ç ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">protected</span> Object <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf buffer)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// è·å¾—æ¢è¡Œç¬¦çš„ä½ç½®</span></span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">final</span> <span class="keyword">int</span> eol = findEndOfLine(buffer);</span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">if</span> (!discarding) { <span class="comment">// æœªå¤„äºåºŸå¼ƒæ¨¡å¼</span></span><br><span class="line"> <span class="number">5</span>:         <span class="keyword">if</span> (eol &gt;= <span class="number">0</span>) { <span class="comment">// æ‰¾åˆ°</span></span><br><span class="line"> <span class="number">6</span>:             <span class="keyword">final</span> ByteBuf frame;</span><br><span class="line"> <span class="number">7</span>:             <span class="keyword">final</span> <span class="keyword">int</span> length = eol - buffer.readerIndex(); <span class="comment">// è¯»å–é•¿åº¦</span></span><br><span class="line"> <span class="number">8</span>:             <span class="keyword">final</span> <span class="keyword">int</span> delimLength = buffer.getByte(eol) == <span class="string">'\r'</span> ? <span class="number">2</span> : <span class="number">1</span>; <span class="comment">// åˆ†éš”ç¬¦çš„é•¿åº¦ã€‚2 ä¸º `\r\n` ï¼Œ1 ä¸º `\n`</span></span><br><span class="line"> <span class="number">9</span>: </span><br><span class="line"><span class="number">10</span>:             <span class="comment">// è¶…è¿‡æœ€å¤§é•¿åº¦</span></span><br><span class="line"><span class="number">11</span>:             <span class="keyword">if</span> (length &gt; maxLength) {</span><br><span class="line"><span class="number">12</span>:                 <span class="comment">// è®¾ç½®æ–°çš„è¯»å–ä½ç½®</span></span><br><span class="line"><span class="number">13</span>:                 buffer.readerIndex(eol + delimLength);</span><br><span class="line"><span class="number">14</span>:                 <span class="comment">// è§¦å‘ Exception åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="number">15</span>:                 fail(ctx, length);</span><br><span class="line"><span class="number">16</span>:                 <span class="comment">// è¿”å› null ï¼Œå³æœªè§£ç åˆ°æ¶ˆæ¯</span></span><br><span class="line"><span class="number">17</span>:                 <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">18</span>:             }</span><br><span class="line"><span class="number">19</span>: </span><br><span class="line"><span class="number">20</span>:             <span class="comment">// è§£ç å‡ºä¸€æ¡æ¶ˆæ¯ã€‚</span></span><br><span class="line"><span class="number">21</span>:             <span class="keyword">if</span> (stripDelimiter) {</span><br><span class="line"><span class="number">22</span>:                 frame = buffer.readRetainedSlice(length);</span><br><span class="line"><span class="number">23</span>:                 buffer.skipBytes(delimLength); <span class="comment">// å¿½ç•¥æ¢è¡Œç¬¦</span></span><br><span class="line"><span class="number">24</span>:             } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">25</span>:                 frame = buffer.readRetainedSlice(length + delimLength);</span><br><span class="line"><span class="number">26</span>:             }</span><br><span class="line"><span class="number">27</span>: </span><br><span class="line"><span class="number">28</span>:             <span class="comment">// è¿”å›è§£ç çš„æ¶ˆæ¯</span></span><br><span class="line"><span class="number">29</span>:             <span class="keyword">return</span> frame;</span><br><span class="line"><span class="number">30</span>:         } <span class="keyword">else</span> { <span class="comment">// æœªæ‰¾åˆ°</span></span><br><span class="line"><span class="number">31</span>:             <span class="keyword">final</span> <span class="keyword">int</span> length = buffer.readableBytes();</span><br><span class="line"><span class="number">32</span>:             <span class="comment">// è¶…è¿‡æœ€å¤§é•¿åº¦</span></span><br><span class="line"><span class="number">33</span>:             <span class="keyword">if</span> (length &gt; maxLength) {</span><br><span class="line"><span class="number">34</span>:                 <span class="comment">// è®°å½• discardedBytes</span></span><br><span class="line"><span class="number">35</span>:                 discardedBytes = length;</span><br><span class="line"><span class="number">36</span>:                 <span class="comment">// è·³åˆ°å†™å…¥ä½ç½®</span></span><br><span class="line"><span class="number">37</span>:                 buffer.readerIndex(buffer.writerIndex());</span><br><span class="line"><span class="number">38</span>:                 <span class="comment">// æ ‡è®° discarding ä¸ºåºŸå¼ƒæ¨¡å¼</span></span><br><span class="line"><span class="number">39</span>:                 discarding = <span class="keyword">true</span>;</span><br><span class="line"><span class="number">40</span>:                 <span class="comment">// é‡ç½® offset</span></span><br><span class="line"><span class="number">41</span>:                 offset = <span class="number">0</span>;</span><br><span class="line"><span class="number">42</span>:                 <span class="comment">// å¦‚æœå¿«é€Ÿå¤±è´¥ï¼Œåˆ™è§¦å‘ Exception åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="number">43</span>:                 <span class="keyword">if</span> (failFast) {</span><br><span class="line"><span class="number">44</span>:                     fail(ctx, <span class="string">"over "</span> + discardedBytes);</span><br><span class="line"><span class="number">45</span>:                 }</span><br><span class="line"><span class="number">46</span>:             }</span><br><span class="line"><span class="number">47</span>:             <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">48</span>:         }</span><br><span class="line"><span class="number">49</span>:     } <span class="keyword">else</span> { <span class="comment">// å¤„äºåºŸå¼ƒæ¨¡å¼</span></span><br><span class="line"><span class="number">50</span>:         <span class="keyword">if</span> (eol &gt;= <span class="number">0</span>) { <span class="comment">// æ‰¾åˆ°</span></span><br><span class="line"><span class="number">51</span>:             <span class="keyword">final</span> <span class="keyword">int</span> length = discardedBytes + eol - buffer.readerIndex(); <span class="comment">// è¯»å–é•¿åº¦</span></span><br><span class="line"><span class="number">52</span>:             <span class="keyword">final</span> <span class="keyword">int</span> delimLength = buffer.getByte(eol) == <span class="string">'\r'</span> ? <span class="number">2</span> : <span class="number">1</span>; <span class="comment">// åˆ†éš”ç¬¦çš„é•¿åº¦ã€‚2 ä¸º `\r\n` ï¼Œ1 ä¸º `\n`</span></span><br><span class="line"><span class="number">53</span>:             <span class="comment">// è®¾ç½®æ–°çš„è¯»å–ä½ç½®</span></span><br><span class="line"><span class="number">54</span>:             buffer.readerIndex(eol + delimLength);</span><br><span class="line"><span class="number">55</span>:             <span class="comment">// é‡ç½® discardedBytes</span></span><br><span class="line"><span class="number">56</span>:             discardedBytes = <span class="number">0</span>;</span><br><span class="line"><span class="number">57</span>:             <span class="comment">// è®¾ç½® discarding ä¸ä¸ºåºŸå¼ƒæ¨¡å¼</span></span><br><span class="line"><span class="number">58</span>:             discarding = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">59</span>:             <span class="comment">// å¦‚æœä¸ä¸ºå¿«é€Ÿå¤±è´¥ï¼Œåˆ™è§¦å‘ Exception åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="number">60</span>:             <span class="keyword">if</span> (!failFast) {</span><br><span class="line"><span class="number">61</span>:                 fail(ctx, length);</span><br><span class="line"><span class="number">62</span>:             }</span><br><span class="line"><span class="number">63</span>:         } <span class="keyword">else</span> { <span class="comment">// æœªæ‰¾åˆ°</span></span><br><span class="line"><span class="number">64</span>:             <span class="comment">// å¢åŠ  discardedBytes</span></span><br><span class="line"><span class="number">65</span>:             discardedBytes += buffer.readableBytes();</span><br><span class="line"><span class="number">66</span>:             <span class="comment">// è·³åˆ°å†™å…¥ä½ç½®</span></span><br><span class="line"><span class="number">67</span>:             buffer.readerIndex(buffer.writerIndex());</span><br><span class="line"><span class="number">68</span>:         }</span><br><span class="line"><span class="number">69</span>:         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"><span class="number">70</span>:     }</span><br><span class="line"><span class="number">71</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šè°ƒç”¨ <code>#findEndOfLine(final ByteBuf buffer)</code> æ–¹æ³•ï¼Œè·å¾—æ¢è¡Œç¬¦çš„ä½ç½®ã€‚è¯¦ç»†è§£æï¼Œè¿™é‡Œèƒ–å‹å…ˆè·³åˆ° <a href="#">ã€Œ3.3 findEndOfLineã€</a> ä¸­ã€‚</li>
<li>=============== æœªå¤„äº <code>discarding</code> æ¨¡å¼ ===============</li>
<li>æ ¹æ®æ˜¯å¦æ‰¾åˆ°æ¢è¡Œç¬¦ï¼Œåˆ†æˆ â‘  â‘¡ ä¸¤ç§æƒ…å†µã€‚</li>
<li>â‘  ç¬¬ 5 è¡Œï¼š<strong>æ‰¾åˆ°</strong>æ¢è¡Œç¬¦ã€‚</li>
<li>ç¬¬ 7 è‡³ 8 è¡Œï¼šè·å¾—è¯»å–æ¶ˆæ¯çš„é•¿åº¦ã€æ¢è¡Œç¬¦çš„é•¿åº¦ã€‚</li>
<li>ç¬¬ 11 è¡Œï¼šè¯»å–æ¶ˆæ¯çš„é•¿åº¦ï¼Œè¶…è¿‡æœ€å¤§é•¿åº¦ï¼Œåˆ™<strong>ä¸¢å¼ƒ</strong>è¯¥æ¶ˆæ¯ã€‚<ul>
<li>ç¬¬ 13 è¡Œï¼š<code>buffer</code> è®¾ç½®æ–°çš„è¯»å–ä½ç½®ã€‚</li>
<li>ç¬¬ 15 è¡Œï¼šè°ƒç”¨ <code>#fail(...)</code> æ–¹æ³•ï¼Œè§¦å‘ Exception åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ3.4 failã€</a> ã€‚ğŸ˜ˆ æ³¨æ„ï¼Œæ­¤å¤„å’Œ <code>failFast</code> æ²¡æœ‰å…³ç³»ã€‚</li>
<li>ã€å¤±è´¥ã€‘ç¬¬ 17 è¡Œï¼šè¿”å› <code>null</code> ï¼Œå³æœªè§£ç åˆ°æ¶ˆæ¯ã€‚</li>
</ul>
</li>
<li>ã€æˆåŠŸã€‘ç¬¬ 20 è‡³ 26 è¡Œï¼šè§£ç å‡ºä¸€æ¡æ¶ˆæ¯ã€‚è°ƒç”¨ <code>ByteBuf#readRetainedSlice(int length)</code> æ–¹æ³•ï¼Œè¯»å–ä¸€ä¸ª Slice ByteBuf å¯¹è±¡ï¼Œå¹¶å¢åŠ å¼•ç”¨è®¡æ•°ã€‚å¹¶ä¸”è¯¥ Slice ByteBuf ä½œä¸ºè§£ç çš„ä¸€æ¡æ¶ˆæ¯ã€‚å¦å¤–ï¼Œ<code>ByteBuf#readRetainedSlice(int length)</code> çš„è¿‡ç¨‹ï¼Œå› ä¸ºæ˜¯å…±äº«åŸæœ‰ ByteBuf <code>in</code> æ•°ç»„ï¼Œæ‰€ä»¥ä¸å­˜åœ¨æ•°æ®æ‹·è´ã€‚</li>
<li>â‘¡ ç¬¬ 30 è¡Œï¼š<strong>æœªæ‰¾åˆ°</strong>æ¢è¡Œç¬¦ï¼Œè¯´æ˜å½“å‰ <code>buffer</code> <strong>ä¸å­˜åœ¨</strong>å®Œæ•´çš„æ¶ˆæ¯ã€‚éœ€è¦ç»§ç»­è¯»å–æ–°çš„æ•°æ®ï¼Œå†æ¬¡è§£ç æ‹†åŒ…ã€‚</li>
<li>ç¬¬ 33 è¡Œï¼šå¯è¯»å­—èŠ‚ï¼Œè¶…è¿‡æœ€å¤§é•¿åº¦ï¼Œé‚£ä¹ˆå³ä½¿åç»­æ‰¾åˆ°æ¢è¡Œç¬¦ï¼Œæ¶ˆæ¯ä¹Ÿ<strong>ä¸€å®š</strong>è¶…è¿‡æœ€å¤§é•¿åº¦ã€‚ </li>
<li>ç¬¬ 35 è¡Œï¼šè®°å½• <code>discardedBytes</code> ã€‚å› ä¸ºã€ç¬¬ 37 è¡Œã€‘çš„ä»£ç ï¼Œ<code>buffer</code> è·³åˆ°å†™å…¥ä½ç½®ï¼Œä¹Ÿå°±æ˜¯æŠ›å¼ƒäº† <code>discardedBytes</code> å­—èŠ‚æ•°ã€‚</li>
<li>ç¬¬ 39 è¡Œï¼šæ ‡è®° <code>discarding</code> ä¸º <code>true</code> ï¼Œè¿›å…¥åºŸå¼ƒæ¨¡å¼ã€‚é‚£ä¹ˆï¼Œåç»­å°±ä¼šæ‰§è¡Œã€ç¬¬ 49 è‡³ 70 è¡Œã€‘çš„ä»£ç é€»è¾‘ï¼Œå¯»æ‰¾åˆ°æ¢è¡Œç¬¦ï¼Œè§£ç æ‹†åŒ…å‡ºè¯¥æ¶ˆæ¯ï¼Œå¹¶<strong>æŠ›å¼ƒ</strong>å®ƒã€‚<ul>
<li>ğŸ˜ˆ è¿™æ®µï¼Œå¥½å¥½ç†è§£ä¸‹ã€‚ </li>
</ul>
</li>
<li>ç¬¬ 41 è¡Œï¼šé‡ç½® <code>offset</code> ä¸º 0 ã€‚</li>
<li>ç¬¬ 42 è‡³ 45 è¡Œï¼šå¦‚æœå¿«é€Ÿå¤±è´¥( <code>failFast = true</code> )ï¼Œè°ƒç”¨ <code>#fail(...)</code> æ–¹æ³•ï¼Œè§¦å‘ Exception åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚é‚£ä¹ˆï¼Œä¸å¿«é€Ÿå¤±è´¥( <code>failFast = false</code> )å‘¢ï¼Ÿç»§ç»­å¾€ä¸‹èµ°ï¼Œç­”æ¡ˆåœ¨ã€ç¬¬ 59 è‡³ 61 è¡Œã€‘çš„ä»£ç ï¼Œè§åˆ†æ™“ã€‚</li>
<li>ç¬¬ 47 è¡Œï¼šã€å¤±è´¥ã€‘ç¬¬ 17 è¡Œï¼šè¿”å› <code>null</code> ï¼Œå³æœªè§£ç åˆ°æ¶ˆæ¯ã€‚</li>
<li>=============== æ­£å¤„äº <code>discarding</code> æ¨¡å¼ ===============</li>
<li><code>discarding</code> æ¨¡å¼æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿåœ¨ã€ç¬¬ 33 è‡³ 46 è¡Œã€‘çš„ä»£ç ï¼Œå¦‚æœå·²è¯»å–çš„å­—èŠ‚æ•°ï¼Œè¶…è¿‡æœ€å¤§é•¿åº¦ï¼Œé‚£ä¹ˆè¿›å…¥ <code>discarding</code> æ¨¡å¼ï¼Œç»§ç»­å¯»æ‰¾åˆ°æ¢è¡Œç¬¦ï¼Œè§£ç æ‹†åŒ…å‡ºè¯¥æ¶ˆæ¯ï¼Œå¹¶<strong>æŠ›å¼ƒ</strong>å®ƒã€‚ğŸ˜ˆ å®é™…ä¸Šï¼Œå®ƒçš„æ•ˆæœæ˜¯ã€ç¬¬ 30 è‡³ 48 è¡Œã€‘+ã€ç¬¬ 49 è‡³ 69 è¡Œã€‘å’Œã€ç¬¬ 10 è‡³ 18 è¡Œã€‘çš„ä»£ç çš„æ•ˆæœæ˜¯<strong>ç­‰ä»·çš„</strong>ï¼Œåªæ˜¯è¯´ã€ç¬¬ 30 è‡³ 48 è¡Œã€‘çš„ä»£ç ï¼Œå› ä¸ºæ•°æ®åŒ…æ˜¯<strong>ä¸å®Œæ•´</strong>( æ‰¾ä¸åˆ°æ¢è¡Œç¬¦ )çš„ï¼Œæ‰€ä»¥è¿›å…¥ã€ç¬¬ 49 è‡³ 69 è¡Œã€‘çš„ä»£ç ã€‚</li>
<li>æ ¹æ®æ˜¯å¦æ‰¾åˆ°æ¢è¡Œç¬¦ï¼Œåˆ†æˆ â‘  â‘¡ ä¸¤ç§æƒ…å†µã€‚</li>
<li>â‘  ç¬¬ 50 è¡Œï¼š<strong>æ‰¾åˆ°</strong>æ¢è¡Œç¬¦ã€‚</li>
<li>ç¬¬ 51 è¡Œï¼šè¯»å–é•¿åº¦ã€‚æ­¤å¤„çš„é•¿åº¦ï¼Œç®—ä¸Šäº† <code>discardedBytes</code> çš„éƒ¨åˆ†ã€‚<ul>
<li>ç¬¬ 52 è¡Œï¼šè·å¾—æ¢è¡Œç¬¦çš„é•¿åº¦ã€‚</li>
</ul>
</li>
<li>ç¬¬ 54 è¡Œï¼šè®¾ç½®æ–°çš„è¯»å–ä½ç½®ã€‚å› ä¸ºï¼Œ<strong>æ‰¾åˆ°</strong>æ¢è¡Œç¬¦ã€‚</li>
<li>ç¬¬ 56 è¡Œï¼šé‡ç½® <code>discardedBytes</code> ä¸º 0 ã€‚å› ä¸ºï¼Œ<strong>æ‰¾åˆ°</strong>æ¢è¡Œç¬¦ã€‚</li>
<li>ç¬¬ 58 è¡Œï¼šé‡ç½® <code>offset</code> ä¸º 0 ã€‚å› ä¸ºï¼Œ<strong>æ‰¾åˆ°</strong>æ¢è¡Œç¬¦ã€‚</li>
<li>ç¬¬ 59 è‡³ 62 è¡Œï¼šå¦‚æœä¸ä¸ºå¿«é€Ÿå¤±è´¥( <code>failFast = false</code> )ï¼Œè°ƒç”¨ <code>#fail(...)</code> æ–¹æ³•ï¼Œè§¦å‘ Exception åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚<ul>
<li>å’Œã€ç¬¬ 42 è‡³ 45 è¡Œã€‘çš„ä»£ç ï¼Œç›¸å¯¹ã€‚</li>
<li>ä¹Ÿå°±è¯´ï¼Œ<code>failFast = false</code> çš„æƒ…å†µä¸‹ï¼Œåªæœ‰åœ¨è§£æåˆ°å®Œæ•´çš„æ¶ˆæ¯ï¼Œ<strong>æ‰</strong>è§¦å‘ Exception åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ğŸ˜ˆ æ˜¯ä¸æ˜¯å¾ˆç»•ï¼Œå“ˆå“ˆå“ˆå“ˆã€‚</li>
</ul>
</li>
<li>ã€å¤±è´¥ã€‘ç¬¬ 69 è¡Œï¼šè¿”å› <code>null</code> ï¼Œè™½ç„¶è§£ç åˆ°æ¶ˆæ¯ï¼Œä½†æ˜¯å› ä¸ºæ¶ˆæ¯é•¿åº¦è¶…è¿‡æœ€å¤§é•¿åº¦ï¼Œæ‰€ä»¥è¿›è¡Œ<strong>ä¸¢å¤±</strong>ã€‚å’Œã€ç¬¬ 17 è¡Œã€‘çš„ä»£ç ï¼Œæ˜¯ä¸€ä¸ªç›®çš„ã€‚</li>
<li>â‘¡ ç¬¬ 63 è¡Œï¼š<strong>æœªæ‰¾åˆ°</strong>æ¢è¡Œç¬¦ï¼Œè¯´æ˜å½“å‰ <code>buffer</code> <strong>ä¸å­˜åœ¨</strong>å®Œæ•´çš„æ¶ˆæ¯ã€‚éœ€è¦ç»§ç»­è¯»å–æ–°çš„æ•°æ®ï¼Œå†æ¬¡è§£ç æ‹†åŒ…ã€‚</li>
<li>ç¬¬ 65 è¡Œï¼šå¢åŠ  <code>discardedBytes</code> ã€‚</li>
<li>ç¬¬ 67 è¡Œï¼š<code>buffer</code> è·³åˆ°å†™å…¥ä½ç½®ã€‚</li>
<li>ç¬¬ 69 è¡Œï¼šè¿”å› <code>null</code> ï¼Œå³æœªè§£ç åˆ°æ¶ˆæ¯ã€‚</li>
</ul>
<p>ğŸ˜ˆ æ•´ä½“é€»è¾‘ï¼Œæœ‰ç‚¹ç»•ï¼Œä¸è¿‡å¾ˆæœ‰è¶£ã€‚</p>
<h2 id="3-3-findEndOfLine"><a href="#3-3-findEndOfLine" class="headerlink" title="3.3 findEndOfLine"></a>3.3 findEndOfLine</h2><p><code>#findEndOfLine(final ByteBuf buffer)</code> æ–¹æ³•ï¼Œè·å¾—æ¢è¡Œç¬¦çš„ä½ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Returns the index in the buffer of the end of line found.</span></span><br><span class="line"><span class="comment">    * Returns -1 if no end of line was found in the buffer.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">findEndOfLine</span><span class="params">(<span class="keyword">final</span> ByteBuf buffer)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">int</span> totalLength = buffer.readableBytes();</span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">int</span> i = buffer.forEachByte(buffer.readerIndex() + offset, totalLength - offset, ByteProcessor.FIND_LF);</span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// æ‰¾åˆ°</span></span><br><span class="line"> <span class="number">5</span>:     <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) {</span><br><span class="line"> <span class="number">6</span>:         <span class="comment">// é‡ç½® offset</span></span><br><span class="line"> <span class="number">7</span>:         offset = <span class="number">0</span>;</span><br><span class="line"> <span class="number">8</span>:         <span class="comment">// å¦‚æœå‰ä¸€ä¸ªå­—èŠ‚ä½ `\r` ï¼Œè¯´æ˜æ‰¾åˆ°çš„æ˜¯ `\n` ï¼Œæ‰€ä»¥éœ€è¦ -1 ï¼Œå› ä¸ºå¯»æ‰¾çš„æ˜¯é¦–ä¸ªæ¢è¡Œç¬¦çš„ä½ç½®</span></span><br><span class="line"> <span class="number">9</span>:         <span class="keyword">if</span> (i &gt; <span class="number">0</span> &amp;&amp; buffer.getByte(i - <span class="number">1</span>) == <span class="string">'\r'</span>) {</span><br><span class="line"><span class="number">10</span>:             i--;</span><br><span class="line"><span class="number">11</span>:         }</span><br><span class="line"><span class="number">12</span>:     <span class="comment">// æœªæ‰¾åˆ°ï¼Œè®°å½• offset</span></span><br><span class="line"><span class="number">13</span>:     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">14</span>:         offset = totalLength;</span><br><span class="line"><span class="number">15</span>:     }</span><br><span class="line"><span class="number">16</span>:     <span class="keyword">return</span> i;</span><br><span class="line"><span class="number">17</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å…³äº <code>offset</code> çš„é€»è¾‘ï¼Œç¬”è€…è§‰å¾—æœ‰ç‚¹é—®é¢˜ã€‚åœ¨è¿™é‡Œï¼Œèƒ–å‹å…ˆæ— è§†æ‰å®ƒã€‚ç¨åï¼Œæˆ‘ä»¬åœ¨ç»Ÿä¸€åˆ†äº«ã€‚</li>
<li>ç¬¬ 3 è¡Œï¼šåœ¨ <code>buffer</code> çš„ <code>[readerIndex, readerIndex + readableBytes)</code> ä½ç½®èŒƒå›´å†…ï¼ŒæŸ¥æ‰¾ <code>\n</code> æ¢è¡Œç¬¦çš„ä½ç½®ã€‚ğŸ˜ˆ åœ¨å¿½ç•¥ <code>offset</code> çš„å‰æä¸‹ã€‚</li>
<li>ã€æœ‰æ‰¾åˆ°ã€‘<ul>
<li>ç¬¬ 7 è¡Œï¼šé‡ç½® <code>offset</code> ã€‚</li>
<li>ç¬¬ 8 è‡³ 11 è¡Œï¼šå¦‚æœå‰ä¸€ä¸ªå­—èŠ‚ä½ <code>\r</code> ï¼Œè¯´æ˜æ‰¾åˆ°çš„æ˜¯ <code>\n</code> ï¼Œæ‰€ä»¥éœ€è¦ -1 ï¼Œå› ä¸ºå¯»æ‰¾çš„æ˜¯é¦–ä¸ªæ¢è¡Œç¬¦çš„ä½ç½®ã€‚</li>
</ul>
</li>
<li>ã€æ²¡æ‰¾åˆ°ã€‘<ul>
<li>ç¬¬ 14 è¡Œï¼šè®°å½• <code>offset</code> ã€‚</li>
</ul>
</li>
<li>ç¬¬ 16 è¡Œï¼šè¿”å›ä½ç½® <code>i</code> ã€‚ </li>
</ul>
<h2 id="3-4-fail"><a href="#3-4-fail" class="headerlink" title="3.4 fail"></a>3.4 fail</h2><p><code>#fail(...)</code> æ–¹æ³•ï¼Œè§¦å‘ Exception åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fail</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx, <span class="keyword">int</span> length)</span> </span>{</span><br><span class="line">    fail(ctx, String.valueOf(length));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fail</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx, String length)</span> </span>{</span><br><span class="line">    ctx.fireExceptionCaught(<span class="keyword">new</span> TooLongFrameException(<span class="string">"frame length ("</span> + length + <span class="string">") exceeds the allowed maximum ("</span> + maxLength + <span class="string">')'</span>));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-5-å¯èƒ½æ˜¯-offset-çš„ä¸€ä¸ª-bug"><a href="#3-5-å¯èƒ½æ˜¯-offset-çš„ä¸€ä¸ª-bug" class="headerlink" title="3.5 å¯èƒ½æ˜¯ offset çš„ä¸€ä¸ª bug"></a>3.5 å¯èƒ½æ˜¯ offset çš„ä¸€ä¸ª bug</h2><p>è¿™é‡Œï¼Œåªèƒ½è¯´æ˜¯ <code>offset</code> çš„ä¸€ä¸ª bug ï¼Œä¹Ÿæ˜¯ç¬”è€…çš„ä¸€ä¸ªæ¨æµ‹ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥æ¨å¯¼ä¸‹ã€‚</p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_10_01/01.png" title="ä»£ç å›¾" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_10_01/01.png" alt="ä»£ç å›¾"></a><span class="caption">ä»£ç å›¾</span></p>
<ul>
<li>ç¬¬ä¸€æ ¹çº¢çº¿ï¼Œåœ¨ <code>discarding</code> æ¨¡å¼ä¸‹ï¼Œå¦‚æœè¯»å–ä¸åˆ°æ¢è¡Œç¬¦ï¼Œæ¯æ¬¡ <code>buffer</code> çš„è¯»å–ä½ç½®ï¼Œéƒ½ä¼šè·³åˆ°å†™å…¥ä½ç½®ã€‚</li>
<li>ç¬¬ä¸‰æ ¹çº¢çº¿ï¼Œ<code>offset</code> è®°å½•<strong>ä¸Šä¸€æ¬¡</strong>è¯»å–çš„å­—èŠ‚æ•°ã€‚</li>
<li>ç¬¬äºŒæ ¹çº¢çº¿ï¼Œå¦‚æœæŸ¥æ‰¾çš„èŒƒå›´ <code>+ offset</code> ï¼Œä½†æ˜¯ <code>buffer</code> çš„è¯»å–ä½ç½®å·²ç»è·³åˆ°å†™å…¥ä½ç½®ï¼Œå²‚ä¸æ˜¯å’Œ <code>offset</code> çš„é‡å¤äº†ï¼Ÿï¼Ÿ</li>
</ul>
<p>æ‰€ä»¥ï¼Œç¬”è€…è®¤ä¸ºï¼Œåº”è¯¥å»æ‰ <code>offset</code> çš„ç›¸å…³é€»è¾‘ã€‚</p>
<hr>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬ä»¥ä¸€ä¸ªå®é™…æƒ…å†µï¼Œä¸¾ä¸ªä¾‹å­ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_12_04/02.png" title="ä¾‹å­" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_12_04/02.png" alt="ä¾‹å­"></a><span class="caption">ä¾‹å­</span></p>
<ul>
<li>å‡è®¾ <code>maxLength</code> ç­‰äº 1 ã€‚</li>
<li>ç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°æ•°æ® <code>"012"</code> ï¼Œæœªæ‰¾åˆ°æ¢è¡Œç¬¦ï¼Œä½†æ˜¯è¶…è¿‡æœ€å¤§é•¿åº¦ï¼Œæ‰€ä»¥è¿›å…¥ <code>discarding</code> æ¨¡å¼ã€‚</li>
<li>ç¬¬äºŒæ¬¡æ¥æ”¶åˆ°æ•°æ® <code>"34"</code> ï¼Œæœªæ‰¾åˆ°æ¢è¡Œç¬¦ï¼Œ<code>r = w = 4</code> ï¼Œå¹¶ä¸” <code>offset = 2</code> ã€‚</li>
<li>ç¬¬ä¸‰æ¬¡æ¥æ”¶åˆ°æ•°æ® <code>"\n"</code> ï¼Œä½†æ˜¯æŸ¥æ‰¾èŒƒå›´æ˜¯ <code>buffer.readerIndex() + offset = 4 + 2 &gt; 5</code> ï¼Œè¶…è¿‡èŒƒå›´ã€‚</li>
</ul>
<p>å› æ­¤ï¼Œç¬”è€…è§‰å¾—ï¼Œè¿™ä¸ªå¯èƒ½æ˜¯ offset çš„ä¸€ä¸ª bug ã€‚</p>
<h1 id="4-LengthFieldBasedFrameDecoder"><a href="#4-LengthFieldBasedFrameDecoder" class="headerlink" title="4. LengthFieldBasedFrameDecoder"></a>4. LengthFieldBasedFrameDecoder</h1><p><code>io.netty.handler.codec.LengthFieldBasedFrameDecoder</code> ï¼Œç»§æ‰¿ ByteToMessageDecoder æŠ½è±¡ç±»ï¼ŒåŸºäº<strong>æ¶ˆæ¯å¤´æŒ‡å®šæ¶ˆæ¯é•¿åº¦</strong>è¿›è¡Œç²˜åŒ…æ‹†åŒ…å¤„ç†çš„ã€‚</p>
<p>è¯¦ç»†è§£æï¼Œè§åŸºå‹ã€é—ªç”µä¾ ã€‘çš„ <a href="https://www.jianshu.com/p/a0a51fd79f62" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnettyæºç åˆ†æä¹‹LengthFieldBasedFrameDecoderã€‹</a> ä¸€æ–‡ã€‚</p>
<p>æˆ–è€…ï¼Œã€Hypercubeã€‘çš„ <a href="https://www.jianshu.com/p/c3fbd6113dd6" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆå…«ï¼‰â€“ LengthFieldBasedFrameDecoderã€‹</a> ä¸€æ–‡ã€‚</p>
<h1 id="5-DelimiterBasedFrameDecoder"><a href="#5-DelimiterBasedFrameDecoder" class="headerlink" title="5. DelimiterBasedFrameDecoder"></a>5. DelimiterBasedFrameDecoder</h1><p><code>io.netty.handler.codec.DelimiterBasedFrameDecoder</code> ï¼Œç»§æ‰¿ ByteToMessageDecoder æŠ½è±¡ç±»ï¼ŒåŸºäº<strong>æŒ‡å®šæ¶ˆæ¯è¾¹ç•Œæ–¹å¼</strong>è¿›è¡Œç²˜åŒ…æ‹†åŒ…å¤„ç†çš„ã€‚</p>
<blockquote>
<p>FROM <a href="https://www.jianshu.com/p/7c439cc7b01c" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆå…«ï¼‰â€“CodecHandlerã€‹</a> çš„ <a href="#">ã€Œ8.1.2 DelimiterBasedFrameDecoderã€</a> å°èŠ‚ã€‚</p>
<p>å¦‚ä¸‹å†…å®¹ï¼Œå› ä¸ºæ’ç‰ˆï¼Œæ‰€ä»¥æœªä½¿ç”¨å¼•ç”¨è¯­æ³•ã€‚</p>
</blockquote>
<p>è¯¥è§£ç å™¨æ˜¯æ›´é€šç”¨çš„åˆ†éš”ç¬¦è§£ç å™¨ï¼Œå¯æ”¯æŒå¤šä¸ªåˆ†éš”ç¬¦ï¼Œæ¯ä¸ªåˆ†éš”ç¬¦å¯ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªå­—ç¬¦ã€‚å¦‚æœå®šä¹‰äº†å¤šä¸ªåˆ†éš”ç¬¦ï¼Œå¹¶ä¸”å¯è§£ç å‡ºå¤šä¸ªæ¶ˆæ¯å¸§ï¼Œåˆ™é€‰æ‹©äº§ç”Ÿæœ€å°å¸§é•¿çš„ç»“æœã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨è¡Œåˆ†éš”ç¬¦<code>\r\n</code>å’Œ<code>\n</code>åˆ†éš”ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">+--------------+</span><br><span class="line">| ABC\nDEF\r\n |</span><br><span class="line">+--------------+</span><br></pre></td></tr></tbody></table></figure>
<p>å¯æœ‰ä¸¤ç§ç»“æœï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">+-----+-----+              +----------+   </span><br><span class="line">| ABC | DEF |  (âˆš)   å’Œ    | ABC\nDEF |  (Ã—)</span><br><span class="line">+-----+-----+              +----------+</span><br></pre></td></tr></tbody></table></figure>
<p>è¯¥ç¼–ç å™¨å¯é…ç½®çš„å˜é‡ä¸<code>LineBasedFrameDecoder</code>ç±»ä¼¼ï¼Œåªæ˜¯å¤šäº†ä¸€ä¸ª<code>ByteBuf[] delimiters</code>ç”¨äºé…ç½®å…·ä½“çš„åˆ†éš”ç¬¦ã€‚<br> Nettyåœ¨<code>Delimiters</code>ç±»ä¸­å®šä¹‰äº†ä¸¤ç§é»˜è®¤çš„åˆ†éš”ç¬¦ï¼Œåˆ†åˆ«æ˜¯NULLåˆ†éš”ç¬¦å’Œè¡Œåˆ†éš”ç¬¦ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ByteBuf[] nulDelimiter() {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ByteBuf[] {</span><br><span class="line">            Unpooled.wrappedBuffer(<span class="keyword">new</span> <span class="keyword">byte</span>[] { <span class="number">0</span> }) };</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ByteBuf[] lineDelimiter() {</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ByteBuf[] {</span><br><span class="line">            Unpooled.wrappedBuffer(<span class="keyword">new</span> <span class="keyword">byte</span>[] { <span class="string">'\r'</span>, <span class="string">'\n'</span> }),</span><br><span class="line">            Unpooled.wrappedBuffer(<span class="keyword">new</span> <span class="keyword">byte</span>[] { <span class="string">'\n'</span> }),</span><br><span class="line">    };</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>åœ¨ FixedLengthFrameDecoder é‚£é‡Œï¼Œå¡äº†å¥½é•¿æ—¶é—´ï¼ŒNetty åœ¨ç»†èŠ‚è¿™å—ï¼Œæ‰£çš„çœŸç»™åŠ›å•Šï¼ï¼ï¼</p>
<p>æœ¬æ–‡å‚è€ƒå¦‚ä¸‹æ–‡ç« ï¼š</p>
<ul>
<li>ç®€ä¹¦é—ªç”µä¾  <a href="https://www.jianshu.com/p/a0a51fd79f62" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnettyæºç åˆ†æä¹‹LengthFieldBasedFrameDecoderã€‹</a></li>
<li>Hypercube <a href="https://www.jianshu.com/p/7c439cc7b01c" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆå…«ï¼‰â€“CodecHandlerã€‹</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/Codec-1-2-ByteToMessageDecoder-FrameDecoder/" data-id="ck4pl3fp900eefgcf3362q4e9" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>