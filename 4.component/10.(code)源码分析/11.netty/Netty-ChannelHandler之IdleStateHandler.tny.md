<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” ChannelHandlerï¼ˆäº”ï¼‰ä¹‹ IdleStateHandler
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>åœ¨ <code>netty-handler</code> æ¨¡å—çš„ <code>timeout</code> åŒ…ï¼Œå®ç° Channel çš„è¯»å†™æ“ä½œçš„<strong>ç©ºé—²</strong>æ£€æµ‹ã€‚å¯èƒ½æœ‰èƒ–å‹ä¸å¤ªäº†è§£ç©ºé—²æ£€æµ‹çš„å…·ä½“ç”¨é€”ã€‚è¯·å…ˆç ”è¯»ç†è§£ä¸‹ <a href="https://www.cnblogs.com/ASPNET2008/p/7615973.html" rel="external nofollow noopener noreferrer" target="_blank">ã€Šç®€æ˜“RPCæ¡†æ¶-å¿ƒè·³ä¸é‡è¿æœºåˆ¶ã€‹</a> ã€‚</p>
<h1 id="2-ç±»"><a href="#2-ç±»" class="headerlink" title="2. ç±»"></a>2. ç±»</h1><p><code>timeout</code> åŒ…ï¼ŒåŒ…å«çš„ç±»ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_10_13/01.png" title="`timeout` åŒ…" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_10_13/01.png" alt="`timeout` åŒ…"></a><span class="caption">`timeout` åŒ…</span></p>
<p>ä¸€å…±æœ‰ 3 ä¸ª ChannelHandler å®ç°ç±»ï¼š</p>
<ul>
<li>IdleStateHandler ï¼Œå½“ Channel çš„<strong>è¯»æˆ–è€…å†™</strong>ç©ºé—²æ—¶é—´å¤ªé•¿æ—¶ï¼Œå°†ä¼šè§¦å‘ä¸€ä¸ª IdleStateEvent äº‹ä»¶ã€‚ç„¶åï¼Œä½ å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸ª ChannelInboundHandler ï¼Œé‡å†™ <code>#userEventTriggered(ChannelHandlerContext ctx, Object evt)</code> æ–¹æ³•ï¼Œå¤„ç†è¯¥äº‹ä»¶ã€‚<ul>
<li>ReadTimeoutHandler ï¼Œç»§æ‰¿ IdleStateHandler ç±»ï¼Œå½“ Channel çš„<strong>è¯»</strong>ç©ºé—²æ—¶é—´( è¯»æˆ–è€…å†™ )å¤ªé•¿æ—¶ï¼ŒæŠ›å‡º ReadTimeoutException å¼‚å¸¸ï¼Œå¹¶è‡ªåŠ¨å…³é—­è¯¥ Channel ã€‚ç„¶åï¼Œä½ å¯ä»¥è‡ªå®šä¸€ä¸ª ChannelInboundHandler ï¼Œé‡å†™ <code>#exceptionCaught(ChannelHandlerContext ctx, Throwable cause)</code> æ–¹æ³•ï¼Œå¤„ç†è¯¥å¼‚å¸¸ã€‚</li>
</ul>
</li>
<li>WriteTimeoutHandler ï¼Œå½“ä¸€ä¸ª<strong>å†™</strong>æ“ä½œä¸èƒ½åœ¨æŒ‡å®šæ—¶é—´å†…å®Œæˆæ—¶ï¼ŒæŠ›å‡º WriteTimeoutException å¼‚å¸¸ï¼Œå¹¶è‡ªåŠ¨å…³é—­å¯¹åº” Channel ã€‚ç„¶åï¼Œä½ å¯ä»¥è‡ªå®šä¸€ä¸ª ChannelInboundHandler ï¼Œé‡å†™ <code>#exceptionCaught(ChannelHandlerContext ctx, Throwable cause)</code> æ–¹æ³•ï¼Œå¤„ç†è¯¥å¼‚å¸¸ã€‚</li>
</ul>
<p>ğŸ˜ˆ ä» WriteTimeoutHandler å¯ä»¥çœ‹å‡ºï¼Œæœ¬æ–‡å®é™…ä¸ä»…ä»…åˆ†äº« IdleStateHandler ï¼Œæ›´å‡†ç¡®çš„æ˜¯åˆ†äº« Timeout ç›¸å…³çš„ ChannelHandler ã€‚è€ƒè™‘åˆ°å¤§å¤šæ•°èƒ–å‹å¯¹ IdleStateHandler æ¯”è¾ƒç†Ÿæ‚‰ï¼Œä¹Ÿç›¸å¯¹å¸¸ç”¨ï¼Œæ‰€ä»¥æ ‡é¢˜æ‰å–äº† <a href="#">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” ChannelHandlerï¼ˆäº”ï¼‰ä¹‹ IdleStateHandlerã€‹</a> ã€‚</p>
<h1 id="3-IdleState"><a href="#3-IdleState" class="headerlink" title="3. IdleState"></a>3. IdleState</h1><p><code>io.netty.handler.timeout.IdleState</code> ï¼Œç©ºé—²çŠ¶æ€<strong>æšä¸¾</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç©ºé—²çŠ¶æ€æšä¸¾</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * An {<span class="doctag">@link</span> Enum} that represents the idle state of a {<span class="doctag">@link</span> Channel}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> IdleState {</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * No data was received for a while.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * è¯»ç©ºé—²</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    READER_IDLE,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * No data was sent for a while.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * å†™ç©ºé—²</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    WRITER_IDLE,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * No data was either received or sent for a while.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * è¯»æˆ–å†™ä»»ä¸€ç©ºé—²</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ALL_IDLE</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¸€å…±æœ‰ 3 ç§çŠ¶æ€ã€‚å…¶ä¸­ï¼Œ<code>ALL_IDLE</code> è¡¨ç¤ºçš„æ˜¯ï¼Œè¯»<strong>æˆ–</strong>å†™ä»»ä¸€ç©ºé—²ï¼Œæ³¨æ„æ˜¯â€œæˆ–â€ã€‚</li>
</ul>
<h2 id="3-1-IdleStateEvent"><a href="#3-1-IdleStateEvent" class="headerlink" title="3.1 IdleStateEvent"></a>3.1 IdleStateEvent</h2><p><code>io.netty.handler.timeout.IdleStateEvent</code> ï¼Œç©ºé—²äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IdleStateEvent</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// READ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> IdleStateEvent FIRST_READER_IDLE_STATE_EVENT = <span class="keyword">new</span> IdleStateEvent(IdleState.READER_IDLE, <span class="keyword">true</span>); <span class="comment">// é¦–æ¬¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> IdleStateEvent READER_IDLE_STATE_EVENT = <span class="keyword">new</span> IdleStateEvent(IdleState.READER_IDLE, <span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// WRITE</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> IdleStateEvent FIRST_WRITER_IDLE_STATE_EVENT = <span class="keyword">new</span> IdleStateEvent(IdleState.WRITER_IDLE, <span class="keyword">true</span>); <span class="comment">// é¦–æ¬¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> IdleStateEvent WRITER_IDLE_STATE_EVENT = <span class="keyword">new</span> IdleStateEvent(IdleState.WRITER_IDLE, <span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// ALL</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> IdleStateEvent FIRST_ALL_IDLE_STATE_EVENT = <span class="keyword">new</span> IdleStateEvent(IdleState.ALL_IDLE, <span class="keyword">true</span>); <span class="comment">// é¦–æ¬¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> IdleStateEvent ALL_IDLE_STATE_EVENT = <span class="keyword">new</span> IdleStateEvent(IdleState.ALL_IDLE, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç©ºé—²çŠ¶æ€ç±»å‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IdleState state;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ˜¯å¦é¦–æ¬¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> first;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Constructor for sub-classes.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> state the {<span class="doctag">@link</span> IdleStateEvent} which triggered the event.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> first {<span class="doctag">@code</span> true} if its the first idle event for the {<span class="doctag">@link</span> IdleStateEvent}.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">IdleStateEvent</span><span class="params">(IdleState state, <span class="keyword">boolean</span> first)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>.state = ObjectUtil.checkNotNull(state, <span class="string">"state"</span>);</span><br><span class="line">        <span class="keyword">this</span>.first = first;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the idle state.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IdleState <span class="title">state</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> state;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns {<span class="doctag">@code</span> true} if this was the first event for the {<span class="doctag">@link</span> IdleState}</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFirst</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> first;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>3 <strong>ç±»</strong>( <code>state</code> )ç©ºé—²äº‹ä»¶ï¼Œå†ç»„åˆä¸Šæ˜¯å¦é¦–æ¬¡( <code>first</code> )ï¼Œä¸€å…±æœ‰ 6 ç§ç©ºé—²äº‹ä»¶ã€‚</li>
</ul>
<h1 id="4-TimeoutException"><a href="#4-TimeoutException" class="headerlink" title="4. TimeoutException"></a>4. TimeoutException</h1><p><code>io.netty.handler.timeout.TimeoutException</code> ï¼Œç»§æ‰¿ ChannelException ç±»ï¼Œè¶…æ—¶å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeoutException</span> <span class="keyword">extends</span> <span class="title">ChannelException</span> </span>{</span><br><span class="line"></span><br><span class="line">    TimeoutException() { }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Throwable <span class="title">fillInStackTrace</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="4-1-ReadTimeoutException"><a href="#4-1-ReadTimeoutException" class="headerlink" title="4.1 ReadTimeoutException"></a>4.1 ReadTimeoutException</h2><p><code>io.netty.handler.timeout.ReadTimeoutException</code> ï¼Œç»§æ‰¿ TimeoutException ç±»ï¼Œè¯»è¶…æ—¶( ç©ºé—² )å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReadTimeoutException</span> <span class="keyword">extends</span> <span class="title">TimeoutException</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å•ä¾‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ReadTimeoutException INSTANCE = <span class="keyword">new</span> ReadTimeoutException();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">ReadTimeoutException</span><span class="params">()</span> </span>{ }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="4-2-WriteTimeoutException"><a href="#4-2-WriteTimeoutException" class="headerlink" title="4.2 WriteTimeoutException"></a>4.2 WriteTimeoutException</h2><p><code>io.netty.handler.timeout.WriteTimeoutException</code> ï¼Œç»§æ‰¿ TimeoutException ç±»ï¼Œå†™è¶…æ—¶( ç©ºé—² )å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WriteTimeoutException</span> <span class="keyword">extends</span> <span class="title">TimeoutException</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å•ä¾‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> WriteTimeoutException INSTANCE = <span class="keyword">new</span> WriteTimeoutException();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">WriteTimeoutException</span><span class="params">()</span> </span>{ }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="5-IdleStateHandler"><a href="#5-IdleStateHandler" class="headerlink" title="5. IdleStateHandler"></a>5. IdleStateHandler</h1><p><code>io.netty.handler.timeout.IdleStateHandler</code> ï¼Œç»§æ‰¿ ChannelDuplexHandler ç±»ï¼Œå½“ Channel çš„<strong>è¯»æˆ–è€…å†™</strong>ç©ºé—²æ—¶é—´å¤ªé•¿æ—¶ï¼Œå°†ä¼šè§¦å‘ä¸€ä¸ª IdleStateEvent äº‹ä»¶ã€‚</p>
<h2 id="5-1-æ„é€ æ–¹æ³•"><a href="#5-1-æ„é€ æ–¹æ³•" class="headerlink" title="5.1 æ„é€ æ–¹æ³•"></a>5.1 æ„é€ æ–¹æ³•</h2><blockquote>
<p>è€è‰¿è‰¿ï¼šé«˜èƒ½é¢„è­¦ï¼ŒIdleStateHandler çš„å±æ€§æœ‰ç‚¹ç‚¹å¤šã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœ€å°çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼šçº³ç§’</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MIN_TIMEOUT_NANOS = TimeUnit.MILLISECONDS.toNanos(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å†™å…¥ä»»åŠ¡ç›‘å¬å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// Not create a new ChannelFutureListener per write operation to reduce GC pressure.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelFutureListener writeListener = <span class="keyword">new</span> ChannelFutureListener() {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// è®°å½•æœ€åå†™æ—¶é—´</span></span><br><span class="line">        lastWriteTime = ticksInNanos();</span><br><span class="line">        <span class="comment">// é‡ç½® firstWriterIdleEvent å’Œ firstAllIdleEvent ä¸º true</span></span><br><span class="line">        firstWriterIdleEvent = firstAllIdleEvent = <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦è§‚å¯Ÿ {<span class="doctag">@link</span> ChannelOutboundBuffer} å†™å…¥é˜Ÿåˆ—</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> observeOutput;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é…ç½®çš„è¯»ç©ºé—²æ—¶é—´ï¼Œå•ä½ï¼šçº³ç§’</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> readerIdleTimeNanos;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é…ç½®çš„å†™ç©ºé—²æ—¶é—´ï¼Œå•ä½ï¼šçº³ç§’</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> writerIdleTimeNanos;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é…ç½®çš„All( è¯»æˆ–å†™ä»»ä¸€ )ï¼Œå•ä½ï¼šçº³ç§’</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> allIdleTimeNanos;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¯»ç©ºé—²çš„å®šæ—¶æ£€æµ‹ä»»åŠ¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ScheduledFuture&lt;?&gt; readerIdleTimeout;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœ€åè¯»æ—¶é—´</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> lastReadTime;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦é¦–æ¬¡è¯»ç©ºé—²</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> firstReaderIdleEvent = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å†™ç©ºé—²çš„å®šæ—¶æ£€æµ‹ä»»åŠ¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ScheduledFuture&lt;?&gt; writerIdleTimeout;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœ€åå†™æ—¶é—´</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> lastWriteTime;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦é¦–æ¬¡å†™ç©ºé—²</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> firstWriterIdleEvent = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * All ç©ºé—²æ—¶é—´ï¼Œå•ä½ï¼šçº³ç§’</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ScheduledFuture&lt;?&gt; allIdleTimeout;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦é¦–æ¬¡ All ç©ºé—²</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> firstAllIdleEvent = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * çŠ¶æ€</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 0 - none ï¼Œæœªåˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"> * 1 - initialized ï¼Œå·²ç»åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment"> * 2 - destroyed ï¼Œå·²ç»é”€æ¯</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">byte</span> state; <span class="comment">// 0 - none, 1 - initialized, 2 - destroyed</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦æ­£åœ¨è¯»å–</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> reading;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœ€åæ£€æµ‹åˆ° {<span class="doctag">@link</span> ChannelOutboundBuffer} å‘ç”Ÿå˜åŒ–çš„æ—¶é—´</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> lastChangeCheckTimeStamp;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç¬¬ä¸€æ¡å‡†å¤‡ flash åˆ°å¯¹ç«¯çš„æ¶ˆæ¯( {<span class="doctag">@link</span> ChannelOutboundBuffer#current()} )çš„ HashCode</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> lastMessageHashCode;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ€»å…±ç­‰å¾… flush åˆ°å¯¹ç«¯çš„å†…å­˜å¤§å°( {<span class="doctag">@link</span> ChannelOutboundBuffer#totalPendingWriteBytes()} )</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> lastPendingWriteBytes;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">IdleStateHandler</span><span class="params">(<span class="keyword">int</span> readerIdleTimeSeconds, <span class="keyword">int</span> writerIdleTimeSeconds, <span class="keyword">int</span> allIdleTimeSeconds)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>(readerIdleTimeSeconds, writerIdleTimeSeconds, allIdleTimeSeconds, TimeUnit.SECONDS);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">IdleStateHandler</span><span class="params">(<span class="keyword">long</span> readerIdleTime, <span class="keyword">long</span> writerIdleTime, <span class="keyword">long</span> allIdleTime, TimeUnit unit)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>(<span class="keyword">false</span>, readerIdleTime, writerIdleTime, allIdleTime, unit);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a new instance firing {<span class="doctag">@link</span> IdleStateEvent}s.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> observeOutput</span></span><br><span class="line"><span class="comment"> *        whether or not the consumption of {<span class="doctag">@code</span> bytes} should be taken into</span></span><br><span class="line"><span class="comment"> *        consideration when assessing write idleness. The default is {<span class="doctag">@code</span> false}.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> readerIdleTime</span></span><br><span class="line"><span class="comment"> *        an {<span class="doctag">@link</span> IdleStateEvent} whose state is {<span class="doctag">@link</span> IdleState#READER_IDLE}</span></span><br><span class="line"><span class="comment"> *        will be triggered when no read was performed for the specified</span></span><br><span class="line"><span class="comment"> *        period of time.  Specify {<span class="doctag">@code</span> 0} to disable.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> writerIdleTime</span></span><br><span class="line"><span class="comment"> *        an {<span class="doctag">@link</span> IdleStateEvent} whose state is {<span class="doctag">@link</span> IdleState#WRITER_IDLE}</span></span><br><span class="line"><span class="comment"> *        will be triggered when no write was performed for the specified</span></span><br><span class="line"><span class="comment"> *        period of time.  Specify {<span class="doctag">@code</span> 0} to disable.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> allIdleTime</span></span><br><span class="line"><span class="comment"> *        an {<span class="doctag">@link</span> IdleStateEvent} whose state is {<span class="doctag">@link</span> IdleState#ALL_IDLE}</span></span><br><span class="line"><span class="comment"> *        will be triggered when neither read nor write was performed for</span></span><br><span class="line"><span class="comment"> *        the specified period of time.  Specify {<span class="doctag">@code</span> 0} to disable.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> unit</span></span><br><span class="line"><span class="comment"> *        the {<span class="doctag">@link</span> TimeUnit} of {<span class="doctag">@code</span> readerIdleTime},</span></span><br><span class="line"><span class="comment"> *        {<span class="doctag">@code</span> writeIdleTime}, and {<span class="doctag">@code</span> allIdleTime}</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">IdleStateHandler</span><span class="params">(<span class="keyword">boolean</span> observeOutput, <span class="keyword">long</span> readerIdleTime, <span class="keyword">long</span> writerIdleTime, <span class="keyword">long</span> allIdleTime, TimeUnit unit)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (unit == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"unit"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.observeOutput = observeOutput;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (readerIdleTime &lt;= <span class="number">0</span>) {</span><br><span class="line">        readerIdleTimeNanos = <span class="number">0</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        readerIdleTimeNanos = Math.max(unit.toNanos(readerIdleTime), MIN_TIMEOUT_NANOS); <span class="comment">// ä¿è¯å¤§äºç­‰äº MIN_TIMEOUT_NANOS</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (writerIdleTime &lt;= <span class="number">0</span>) {</span><br><span class="line">        writerIdleTimeNanos = <span class="number">0</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        writerIdleTimeNanos = Math.max(unit.toNanos(writerIdleTime), MIN_TIMEOUT_NANOS); <span class="comment">// ä¿è¯å¤§äºç­‰äº MIN_TIMEOUT_NANOS</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (allIdleTime &lt;= <span class="number">0</span>) {</span><br><span class="line">        allIdleTimeNanos = <span class="number">0</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        allIdleTimeNanos = Math.max(unit.toNanos(allIdleTime), MIN_TIMEOUT_NANOS); <span class="comment">// ä¿è¯å¤§äºç­‰äº MIN_TIMEOUT_NANOS</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å±æ€§æ¯”è¾ƒå¤šï¼Œä¿æŒè€å¿ƒå’Œæ·¡å®šï¼Œæˆ‘ä»¬ç»§ç»­æ¥æ•´ç†ä¸€æ³¢ã€‚</li>
<li><code>MIN_TIMEOUT_NANOS</code> é™æ€å±æ€§ï¼Œæœ€å°çš„è¶…æ—¶æ—¶é—´ä¸º <strong>1</strong> ï¼Œå•ä½ï¼šçº³ç§’ã€‚å› ä¸º IdleStateHandler åˆ›å»ºçš„ï¼Œæ£€æµ‹å®šæ—¶ä»»åŠ¡çš„æ—¶é—´ï¼Œä»¥çº³ç§’ä¸ºå•ä½ã€‚</li>
<li><code>state</code> å±æ€§ï¼ŒIdleStateHandler çš„çŠ¶æ€ã€‚ä¸€å…±æœ‰ä¸‰ç§ï¼Œè§æ³¨é‡Šã€‚</li>
<li>Read ç©ºé—²ç›¸å…³å±æ€§<ul>
<li><code>readerIdleTimeNanos</code> å±æ€§ï¼Œé…ç½®çš„è¯»ç©ºé—²æ—¶é—´ï¼Œå•ä½ï¼šçº³ç§’ã€‚</li>
<li><code>readerIdleTimeout</code> å±æ€§ï¼Œè¯»ç©ºé—²çš„å®šæ—¶æ£€æµ‹ä»»åŠ¡ã€‚</li>
<li><code>lastReadTime</code> å±æ€§ï¼Œè¯»ç©ºé—²çš„å®šæ—¶æ£€æµ‹ä»»åŠ¡ã€‚</li>
<li><code>firstReaderIdleEvent</code> å±æ€§ï¼Œæ˜¯å¦é¦–æ¬¡è¯»ç©ºé—²ã€‚</li>
<li>ã€<strong>ç‹¬æœ‰</strong>ã€‘ <code>reading</code> å±æ€§ï¼Œæ˜¯å¦æ­£åœ¨è¯»å–ã€‚</li>
</ul>
</li>
<li>Write ç©ºé—²ç›¸å…³å±æ€§<ul>
<li><code>writerIdleTimeNanos</code> å±æ€§ï¼Œé…ç½®çš„å†™ç©ºé—²æ—¶é—´ï¼Œå•ä½ï¼šçº³ç§’ã€‚</li>
<li><code>writerIdleTimeout</code> å±æ€§ï¼Œå†™ç©ºé—²çš„å®šæ—¶æ£€æµ‹ä»»åŠ¡ã€‚</li>
<li><code>lastWriteTime</code> å±æ€§ï¼Œæœ€åå†™æ—¶é—´ã€‚</li>
<li><code>writeListener</code> å±æ€§ï¼Œå†™å…¥æ“ä½œï¼Œå®Œæˆ flush åˆ°å¯¹ç«¯çš„å›è°ƒç›‘å¬å™¨ã€‚åˆå§‹æ—¶ï¼Œåˆ›å»ºå¥½ï¼Œé¿å…é‡å¤åˆ›å»ºï¼Œä»è€Œå‡è½» GC å‹åŠ›ã€‚</li>
<li>ã€<strong>ç‹¬æœ‰</strong>ã€‘ChannelOutboundBuffer ç›¸å…³å±æ€§<ul>
<li><code>observeOutput</code> å±æ€§ï¼Œ æ˜¯å¦è§‚å¯Ÿ ChannelOutboundBuffer å†™å…¥é˜Ÿåˆ—ã€‚</li>
<li><code>lastChangeCheckTimeStamp</code> å±æ€§ï¼Œæœ€åæ£€æµ‹åˆ° ChannelOutboundBuffer å‘ç”Ÿå˜åŒ–çš„æ—¶é—´ã€‚</li>
<li><code>lastMessageHashCode</code> å±æ€§ï¼Œç¬¬ä¸€æ¡å‡†å¤‡ flash åˆ°å¯¹ç«¯çš„æ¶ˆæ¯çš„ HashCode ã€‚</li>
<li><code>lastPendingWriteBytes</code> å±æ€§ï¼Œæ€»å…±ç­‰å¾… flush åˆ°å¯¹ç«¯çš„å†…å­˜å¤§å°ã€‚</li>
<li>å…³äºè¿™å‡ ä¸ªå±æ€§ï¼Œè·Ÿç€ <a href="#">ã€Œ5.7 hasOutputChangedã€</a> ä¸€èµ·ç†è§£ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ALL ç©ºé—²ç›¸å…³å±æ€§<ul>
<li>å› ä¸º ALL æ˜¯ Write å’Œ Read ä»»ä¸€ï¼Œæ‰€ä»¥å…±ç”¨å®ƒä»¬çš„ä¸€äº›å±æ€§ã€‚</li>
<li><code>allIdleTimeNanos</code> å±æ€§ï¼Œé…ç½®çš„All( è¯»æˆ–å†™ä»»ä¸€ )ï¼Œå•ä½ï¼šçº³ç§’ã€‚ </li>
</ul>
</li>
</ul>
<h2 id="5-2-initialize"><a href="#5-2-initialize" class="headerlink" title="5.2 initialize"></a>5.2 initialize</h2><p><code>#initialize(ChannelHandlerContext ctx)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– IdleStateHandler ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(ChannelHandlerContext ctx)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// æ ¡éªŒçŠ¶æ€ï¼Œé¿å…å› ä¸º `#destroy()` æ–¹æ³•åœ¨ `#initialize(ChannelHandlerContext ctx)` æ–¹æ³•ï¼Œæ‰§è¡Œä¹‹å‰</span></span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// Avoid the case where destroy() is called before scheduling timeouts.</span></span><br><span class="line"> <span class="number">4</span>:     <span class="comment">// See: https://github.com/netty/netty/issues/143</span></span><br><span class="line"> <span class="number">5</span>:     <span class="keyword">switch</span> (state) {</span><br><span class="line"> <span class="number">6</span>:     <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line"> <span class="number">7</span>:     <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line"> <span class="number">8</span>:         <span class="keyword">return</span>;</span><br><span class="line"> <span class="number">9</span>:     }</span><br><span class="line"><span class="number">10</span>: </span><br><span class="line"><span class="number">11</span>:     <span class="comment">// æ ‡è®°ä¸ºå·²åˆå§‹åŒ–</span></span><br><span class="line"><span class="number">12</span>:     state = <span class="number">1</span>;</span><br><span class="line"><span class="number">13</span>:     <span class="comment">// åˆå§‹åŒ– ChannelOutboundBuffer ç›¸å…³å±æ€§</span></span><br><span class="line"><span class="number">14</span>:     initOutputChanged(ctx);</span><br><span class="line"><span class="number">15</span>: </span><br><span class="line"><span class="number">16</span>:     <span class="comment">// åˆå§‹ç›¸åº”çš„å®šæ—¶ä»»åŠ¡</span></span><br><span class="line"><span class="number">17</span>:     lastReadTime = lastWriteTime = ticksInNanos();</span><br><span class="line"><span class="number">18</span>:     <span class="keyword">if</span> (readerIdleTimeNanos &gt; <span class="number">0</span>) {</span><br><span class="line"><span class="number">19</span>:         readerIdleTimeout = schedule(ctx, <span class="keyword">new</span> ReaderIdleTimeoutTask(ctx), readerIdleTimeNanos, TimeUnit.NANOSECONDS);</span><br><span class="line"><span class="number">20</span>:     }</span><br><span class="line"><span class="number">21</span>:     <span class="keyword">if</span> (writerIdleTimeNanos &gt; <span class="number">0</span>) {</span><br><span class="line"><span class="number">22</span>:         writerIdleTimeout = schedule(ctx, <span class="keyword">new</span> WriterIdleTimeoutTask(ctx), writerIdleTimeNanos, TimeUnit.NANOSECONDS);</span><br><span class="line"><span class="number">23</span>:     }</span><br><span class="line"><span class="number">24</span>:     <span class="keyword">if</span> (allIdleTimeNanos &gt; <span class="number">0</span>) {</span><br><span class="line"><span class="number">25</span>:         allIdleTimeout = schedule(ctx, <span class="keyword">new</span> AllIdleTimeoutTask(ctx), allIdleTimeNanos, TimeUnit.NANOSECONDS);</span><br><span class="line"><span class="number">26</span>:     }</span><br><span class="line"><span class="number">27</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 2 è‡³ 9 è¡Œï¼šæ ¡éªŒçŠ¶æ€ï¼Œé¿å…å› ä¸º <code>#destroy()</code> æ–¹æ³•åœ¨ <code>#initialize(ChannelHandlerContext ctx)</code> æ–¹æ³•ï¼Œæ‰§è¡Œä¹‹å‰ã€‚</li>
<li>ç¬¬ 12 è¡Œï¼šæ ‡è®° <code>state</code> ä¸ºå·²åˆå§‹åŒ–ã€‚</li>
<li><p>ç¬¬ 14 è¡Œï¼šè°ƒç”¨ <code>#initOutputChanged(ChannelHandlerContext ctx)</code> æ–¹æ³•ï¼Œåˆå§‹åŒ– ChannelOutboundBuffer ç›¸å…³å±æ€§ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initOutputChanged</span><span class="params">(ChannelHandlerContext ctx)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (observeOutput) {</span><br><span class="line">        Channel channel = ctx.channel();</span><br><span class="line">        Unsafe unsafe = channel.unsafe();</span><br><span class="line">        ChannelOutboundBuffer buf = unsafe.outboundBuffer();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (buf != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// è®°å½•ç¬¬ä¸€æ¡å‡†å¤‡ flash åˆ°å¯¹ç«¯çš„æ¶ˆæ¯çš„ HashCode</span></span><br><span class="line">            lastMessageHashCode = System.identityHashCode(buf.current());</span><br><span class="line">            <span class="comment">// è®°å½•æ€»å…±ç­‰å¾… flush åˆ°å¯¹ç«¯çš„å†…å­˜å¤§å°</span></span><br><span class="line">            lastPendingWriteBytes = buf.totalPendingWriteBytes();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åˆå§‹åŒ– <code>lastMessageHashCode</code> å’Œ <code>lastPendingWriteBytes</code> å±æ€§ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 17 è‡³ 26 è¡Œï¼šæ ¹æ®é…ç½®ï¼Œåˆ†åˆ«è°ƒç”¨ <code>#schedule(hannelHandlerContext ctx, Runnable task, long delay, TimeUnit unit)</code> æ–¹æ³•ï¼Œåˆå§‹ç›¸åº”çš„å®šæ—¶ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">ScheduledFuture&lt;?&gt; schedule(ChannelHandlerContext ctx, Runnable task, <span class="keyword">long</span> delay, TimeUnit unit) {</span><br><span class="line">    <span class="keyword">return</span> ctx.executor().schedule(task, delay, unit);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li>ä¸€å…±æœ‰ ReaderIdleTimeoutTaskã€WriterIdleTimeoutTaskã€AllIdleTimeoutTask ä¸‰ç§ä»»åŠ¡ï¼Œä¸‹æ–‡æˆ‘ä»¬è¯¦ç»†è§£æã€‚ </li>
</ul>
<hr>
<p>è¯¥æ–¹æ³•ï¼Œä¼šåœ¨å¤šä¸ª Channel <strong>äº‹ä»¶</strong>ä¸­è¢«è°ƒç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// &lt;2&gt;</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlerAdded</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (ctx.channel().isActive() &amp;&amp; ctx.channel().isRegistered()) {</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">        <span class="comment">// channelActive() event has been fired already, which means this.channelActive() will</span></span><br><span class="line">        <span class="comment">// not be invoked. We have to initialize here instead.</span></span><br><span class="line">        initialize(ctx);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// channelActive() event has not been fired yet.  this.channelActive() will be invoked</span></span><br><span class="line">        <span class="comment">// and initialization will occur there.</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;3&gt;</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRegistered</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">    <span class="comment">// Initialize early if channel is active already.</span></span><br><span class="line">    <span class="keyword">if</span> (ctx.channel().isActive()) {</span><br><span class="line">        initialize(ctx);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// ç»§ç»­ä¼ æ’­ Channel Registered äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">super</span>.channelRegistered(ctx);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// &lt;1&gt;</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line">    <span class="comment">// This method will be invoked only if this handler was added</span></span><br><span class="line">    <span class="comment">// before channelActive() event is fired.  If a user adds this handler</span></span><br><span class="line">    <span class="comment">// after the channelActive() event, initialize() will be called by beforeAdd().</span></span><br><span class="line">    initialize(ctx);</span><br><span class="line">    <span class="comment">// ç»§ç»­ä¼ æ’­ Channel Registered äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">super</span>.channelActive(ctx);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> ï¼šå½“å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯æˆåŠŸå»ºç«‹è¿æ¥åï¼ŒChannel è¢«æ¿€æ´»ï¼Œæ­¤æ—¶ channelActive æ–¹æ³•ï¼Œçš„åˆå§‹åŒ–è¢«è°ƒç”¨ã€‚</li>
<li><code>&lt;2&gt;</code> ï¼šå½“ Channel è¢«æ¿€æ´»åï¼ŒåŠ¨æ€æ·»åŠ æ­¤ Handler ï¼Œåˆ™ handlerAdded æ–¹æ³•çš„åˆå§‹åŒ–è¢«è°ƒç”¨ã€‚</li>
<li><code>&lt;3&gt;</code> ï¼šå½“ Channel è¢«æ¿€æ´»åï¼Œç”¨æˆ·ä¸»åŠ¨åˆ‡æ¢ Channel çš„æ‰€åœ¨çš„ EventLoop ï¼Œåˆ™ channelRegistered æ–¹æ³•çš„åˆå§‹åŒ–è¢«è°ƒç”¨ã€‚</li>
</ul>
<h2 id="5-3-destroy"><a href="#5-3-destroy" class="headerlink" title="5.3 destroy"></a>5.3 destroy</h2><p><code>#destroy()</code> æ–¹æ³•ï¼Œé”€æ¯ IdleStateHandler ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// æ ‡è®°ä¸ºé”€æ¯</span></span><br><span class="line">    state = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é”€æ¯ç›¸åº”çš„å®šæ—¶ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">if</span> (readerIdleTimeout != <span class="keyword">null</span>) {</span><br><span class="line">        readerIdleTimeout.cancel(<span class="keyword">false</span>);</span><br><span class="line">        readerIdleTimeout = <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (writerIdleTimeout != <span class="keyword">null</span>) {</span><br><span class="line">        writerIdleTimeout.cancel(<span class="keyword">false</span>);</span><br><span class="line">        writerIdleTimeout = <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (allIdleTimeout != <span class="keyword">null</span>) {</span><br><span class="line">        allIdleTimeout.cancel(<span class="keyword">false</span>);</span><br><span class="line">        allIdleTimeout = <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ ‡è®° <code>state</code> ä¸ºå·²é”€æ¯ã€‚</li>
<li>é”€æ¯å“åº”çš„å®šæ—¶ä»»åŠ¡ã€‚</li>
</ul>
<hr>
<p>è¯¥æ–¹æ³•ï¼Œä¼šåœ¨å¤šä¸ª Channel <strong>äº‹ä»¶</strong>ä¸­è¢«è°ƒç”¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlerRemoved</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">// é”€æ¯</span></span><br><span class="line">    destroy();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">// é”€æ¯</span></span><br><span class="line">    destroy();</span><br><span class="line">    <span class="comment">// ç»§ç»­ä¼ æ’­ Channel Incative äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">super</span>.channelInactive(ctx);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="5-4-channelIdle"><a href="#5-4-channelIdle" class="headerlink" title="5.4 channelIdle"></a>5.4 channelIdle</h2><p>åœ¨å®šæ—¶ä»»åŠ¡ä¸­ï¼Œå¦‚æœæ£€æµ‹åˆ°<strong>ç©ºé—²</strong>ï¼š</p>
<p>â‘  é¦–å…ˆï¼Œè°ƒç”¨ <code>#newIdleStateEvent(IdleState state, boolean first)</code> æ–¹æ³•ï¼Œåˆ›å»ºå¯¹åº”çš„ç©ºé—²äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> IdleStateEvent <span class="title">newIdleStateEvent</span><span class="params">(IdleState state, <span class="keyword">boolean</span> first)</span> </span>{</span><br><span class="line">    <span class="keyword">switch</span> (state) {</span><br><span class="line">        <span class="keyword">case</span> ALL_IDLE:</span><br><span class="line">            <span class="keyword">return</span> first ? IdleStateEvent.FIRST_ALL_IDLE_STATE_EVENT : IdleStateEvent.ALL_IDLE_STATE_EVENT;</span><br><span class="line">        <span class="keyword">case</span> READER_IDLE:</span><br><span class="line">            <span class="keyword">return</span> first ? IdleStateEvent.FIRST_READER_IDLE_STATE_EVENT : IdleStateEvent.READER_IDLE_STATE_EVENT;</span><br><span class="line">        <span class="keyword">case</span> WRITER_IDLE:</span><br><span class="line">            <span class="keyword">return</span> first ? IdleStateEvent.FIRST_WRITER_IDLE_STATE_EVENT : IdleStateEvent.WRITER_IDLE_STATE_EVENT;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unhandled: state="</span> + state + <span class="string">", first="</span> + first);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>â‘¡ ç„¶åï¼Œè°ƒç”¨ <code>#channelIdle(ChannelHandlerContext ctx, IdleStateEvent evt)</code> æ–¹æ³•ï¼Œåœ¨ pipeline ä¸­ï¼Œè§¦å‘ UserEvent äº‹ä»¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Is called when an {<span class="doctag">@link</span> IdleStateEvent} should be fired. This implementation calls</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> ChannelHandlerContext#fireUserEventTriggered(Object)}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelIdle</span><span class="params">(ChannelHandlerContext ctx, IdleStateEvent evt)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    ctx.fireUserEventTriggered(evt);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="5-5-channelRead"><a href="#5-5-channelRead" class="headerlink" title="5.5 channelRead"></a>5.5 channelRead</h2><p><code>#channelRead(ChannelHandlerContext ctx, Object msg)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">// å¼€å¯äº† read æˆ– all çš„ç©ºé—²æ£€æµ‹</span></span><br><span class="line">    <span class="keyword">if</span> (readerIdleTimeNanos &gt; <span class="number">0</span> || allIdleTimeNanos &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="comment">// æ ‡è®°æ­£åœ¨è¯»å–</span></span><br><span class="line">        reading = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// é‡ç½® firstWriterIdleEvent å’Œ firstAllIdleEvent ä¸º true</span></span><br><span class="line">        firstReaderIdleEvent = firstAllIdleEvent = <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// ç»§ç»­ä¼ æ’­ Channel Read äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    ctx.fireChannelRead(msg);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨å¼€å¯ read æˆ– all çš„ç©ºé—²æ£€æµ‹çš„æƒ…å†µä¸‹ï¼Œåœ¨ã€ç»§ç»­ä¼ æ’­ Channel Read äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‘<strong>ä¹‹å‰</strong>ï¼Œä¼šï¼š</p>
<ul>
<li>æ ‡è®° <code>reading</code> ä¸ºæ­£åœ¨è¯»å–ã€‚</li>
<li>é‡ç½® <code>firstWriterIdleEvent</code> å’Œ <code>firstAllIdleEvent</code> ä¸º <code>true</code> ï¼Œå³åˆå˜æˆ<strong>é¦–æ¬¡</strong>ã€‚</li>
</ul>
<hr>
<p>é‚£ä¹ˆä»€ä¹ˆæ—¶å€™è®°å½• <code>lastReadTime</code> æœ€åè¯»å–æ—¶é—´å‘¢ï¼Ÿç­”æ¡ˆåœ¨ <code>#channelReadComplete(ChannelHandlerContext ctx)</code> æ–¹æ³•ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">// å¼€å¯äº† read æˆ– all çš„ç©ºé—²æ£€æµ‹</span></span><br><span class="line">    <span class="keyword">if</span> ((readerIdleTimeNanos &gt; <span class="number">0</span> || allIdleTimeNanos &gt; <span class="number">0</span>) &amp;&amp; reading) {</span><br><span class="line">        <span class="comment">// è®°å½•æœ€åè¯»æ—¶é—´</span></span><br><span class="line">        lastReadTime = ticksInNanos();</span><br><span class="line">        <span class="comment">// æ ‡è®°ä¸åœ¨è¯»å–</span></span><br><span class="line">        reading = <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// ç»§ç»­ä¼ æ’­ Channel ReadComplete äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    ctx.fireChannelReadComplete();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨å¼€å¯ read æˆ– all çš„ç©ºé—²æ£€æµ‹çš„æƒ…å†µä¸‹ï¼Œåœ¨ã€ç»§ç»­ä¼ æ’­ Channel ReadComplete äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‘<strong>ä¹‹å‰</strong>ï¼Œä¼šï¼š</p>
<ul>
<li><p>è®°å½• <code>lastReadTime</code> æœ€åè¯»å–æ—¶é—´ä¸º <code>#ticksInNanos()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">ticksInNanos</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> System.nanoTime();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å½“å‰æ—¶é—´ï¼Œå•ä½ï¼šçº³ç§’ã€‚</li>
</ul>
</li>
<li><p>æ ‡è®° <code>reading</code> ä¸ºä¸åœ¨è¯»å–ã€‚</p>
</li>
</ul>
<h2 id="5-6-write"><a href="#5-6-write" class="headerlink" title="5.6 write"></a>5.6 write</h2><p><code>#write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">// å¼€å¯äº† write æˆ– all çš„ç©ºé—²æ£€æµ‹</span></span><br><span class="line">    <span class="comment">// Allow writing with void promise if handler is only configured for read timeout events.</span></span><br><span class="line">    <span class="keyword">if</span> (writerIdleTimeNanos &gt; <span class="number">0</span> || allIdleTimeNanos &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="comment">// å†™å…¥ï¼Œå¹¶æ·»åŠ å†™å…¥ç›‘å¬å™¨</span></span><br><span class="line">        ctx.write(msg, promise.unvoid()).addListener(writeListener);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// å†™å…¥ï¼Œä¸æ·»åŠ ç›‘å¬å™¨</span></span><br><span class="line">        ctx.write(msg, promise);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨å¼€å¯ write æˆ– all çš„ç©ºé—²æ£€æµ‹çš„æƒ…å†µä¸‹ï¼Œå†™å…¥çš„æ—¶å€™ï¼Œä¼šæ·»åŠ å†™å…¥ç›‘å¬å™¨ <code>writeListener</code> ã€‚è¯¥ç›‘å¬å™¨ä¼šåœ¨æ¶ˆæ¯( æ•°æ® ) flush åˆ°å¯¹ç«¯åï¼Œ<strong>å›è°ƒ</strong>ï¼Œä¿®æ”¹æœ€åå†™å…¥æ—¶é—´ <code>lastWriteTime</code> ä¸º <code>#ticksInNanos()</code> ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Not create a new ChannelFutureListener per write operation to reduce GC pressure.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelFutureListener writeListener = <span class="keyword">new</span> ChannelFutureListener() {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// è®°å½•æœ€åå†™æ—¶é—´</span></span><br><span class="line">        lastWriteTime = ticksInNanos();</span><br><span class="line">        <span class="comment">// é‡ç½® firstWriterIdleEvent å’Œ firstAllIdleEvent ä¸º true</span></span><br><span class="line">        firstWriterIdleEvent = firstAllIdleEvent = <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="5-7-hasOutputChanged"><a href="#5-7-hasOutputChanged" class="headerlink" title="5.7 hasOutputChanged"></a>5.7 hasOutputChanged</h2><blockquote>
<p>è€è‰¿è‰¿ï¼šå…³äºè¿™ä¸ªæ–¹æ³•ï¼Œçœ‹å®Œ <a href="#">ã€Œ5.8.2 WriterIdelTimeoutTaskã€</a> åï¼Œå†å›è¿‡å¤´ç†è§£ã€‚</p>
</blockquote>
<p><code>#hasOutputChanged(ChannelHandlerContext ctx, boolean first)</code> æ–¹æ³•ï¼Œåˆ¤æ–­ ChannelOutboundBuffer æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Returns {<span class="doctag">@code</span> true} if and only if the {<span class="doctag">@link</span> IdleStateHandler} was constructed</span></span><br><span class="line"><span class="comment">    * with {<span class="doctag">@link</span> #observeOutput} enabled and there has been an observed change in the</span></span><br><span class="line"><span class="comment">    * {<span class="doctag">@link</span> ChannelOutboundBuffer} between two consecutive calls of this method.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * https://github.com/netty/netty/issues/6150</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasOutputChanged</span><span class="params">(ChannelHandlerContext ctx, <span class="keyword">boolean</span> first)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// å¼€å¯è§‚å¯Ÿ ChannelOutboundBuffer é˜Ÿåˆ—</span></span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (observeOutput) {</span><br><span class="line"> <span class="number">4</span>: </span><br><span class="line"> <span class="number">5</span>:         <span class="comment">// We can take this shortcut if the ChannelPromises that got passed into write()</span></span><br><span class="line"> <span class="number">6</span>:         <span class="comment">// appear to complete. It indicates "change" on message level and we simply assume</span></span><br><span class="line"> <span class="number">7</span>:         <span class="comment">// that there's change happening on byte level. If the user doesn't observe channel</span></span><br><span class="line"> <span class="number">8</span>:         <span class="comment">// writability events then they'll eventually OOME and there's clearly a different</span></span><br><span class="line"> <span class="number">9</span>:         <span class="comment">// problem and idleness is least of their concerns.</span></span><br><span class="line"><span class="number">10</span>:         <span class="comment">// å¦‚æœ lastChangeCheckTimeStamp å’Œ lastWriteTime ä¸ä¸€æ ·ï¼Œè¯´æ˜å†™æ“ä½œè¿›è¡Œè¿‡äº†ï¼Œåˆ™æ›´æ–°æ­¤å€¼</span></span><br><span class="line"><span class="number">11</span>:         <span class="keyword">if</span> (lastChangeCheckTimeStamp != lastWriteTime) {</span><br><span class="line"><span class="number">12</span>:             lastChangeCheckTimeStamp = lastWriteTime;</span><br><span class="line"><span class="number">13</span>: </span><br><span class="line"><span class="number">14</span>:             <span class="comment">// But this applies only if it's the non-first call.</span></span><br><span class="line"><span class="number">15</span>:             <span class="keyword">if</span> (!first) { <span class="comment">// éé¦–æ¬¡</span></span><br><span class="line"><span class="number">16</span>:                 <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">17</span>:             }</span><br><span class="line"><span class="number">18</span>:         }</span><br><span class="line"><span class="number">19</span>: </span><br><span class="line"><span class="number">20</span>:         Channel channel = ctx.channel();</span><br><span class="line"><span class="number">21</span>:         Unsafe unsafe = channel.unsafe();</span><br><span class="line"><span class="number">22</span>:         ChannelOutboundBuffer buf = unsafe.outboundBuffer();</span><br><span class="line"><span class="number">23</span>: </span><br><span class="line"><span class="number">24</span>:         <span class="keyword">if</span> (buf != <span class="keyword">null</span>) {</span><br><span class="line"><span class="number">25</span>:             <span class="comment">// è·å¾—æ–°çš„ messageHashCode å’Œ pendingWriteBytes</span></span><br><span class="line"><span class="number">26</span>:             <span class="keyword">int</span> messageHashCode = System.identityHashCode(buf.current());</span><br><span class="line"><span class="number">27</span>:             <span class="keyword">long</span> pendingWriteBytes = buf.totalPendingWriteBytes();</span><br><span class="line"><span class="number">28</span>: </span><br><span class="line"><span class="number">29</span>:             <span class="comment">// å‘ç”Ÿäº†å˜åŒ–</span></span><br><span class="line"><span class="number">30</span>:             <span class="keyword">if</span> (messageHashCode != lastMessageHashCode || pendingWriteBytes != lastPendingWriteBytes) {</span><br><span class="line"><span class="number">31</span>:                 <span class="comment">// ä¿®æ”¹æœ€åä¸€æ¬¡çš„ lastMessageHashCode å’Œ lastPendingWriteBytes</span></span><br><span class="line"><span class="number">32</span>:                 lastMessageHashCode = messageHashCode;</span><br><span class="line"><span class="number">33</span>:                 lastPendingWriteBytes = pendingWriteBytes;</span><br><span class="line"><span class="number">34</span>: </span><br><span class="line"><span class="number">35</span>:                 <span class="keyword">if</span> (!first) { <span class="comment">// éé¦–æ¬¡</span></span><br><span class="line"><span class="number">36</span>:                     <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"><span class="number">37</span>:                 }</span><br><span class="line"><span class="number">38</span>:             }</span><br><span class="line"><span class="number">39</span>:         }</span><br><span class="line"><span class="number">40</span>:     }</span><br><span class="line"><span class="number">41</span>: </span><br><span class="line"><span class="number">42</span>:     <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"><span class="number">43</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 3 è¡Œï¼šåˆ¤æ–­å¼€å¯è§‚å¯Ÿ ChannelOutboundBuffer é˜Ÿåˆ—ã€‚<ul>
<li>å¦‚æœ <code>lastChangeCheckTimeStamp</code> å’Œ <code>lastWriteTime</code> ä¸ä¸€æ ·ï¼Œè¯´æ˜å†™æ“ä½œè¿›è¡Œè¿‡äº†ï¼Œåˆ™æ›´æ–°æ­¤å€¼ã€‚  </li>
<li>ç¬¬ 14 è‡³ 17 è¡Œï¼šè¿™æ®µé€»è¾‘ï¼Œç†è®ºæ¥è¯´ä¸ä¼šå‘ç”Ÿã€‚å› ä¸º <code>lastWriteTime</code> å±æ€§ï¼Œåªä¼šåœ¨ <code>writeListener</code> å›è°ƒä¸­ä¿®æ”¹ï¼Œé‚£ä¹ˆå¦‚æœå‘ç”Ÿ <code>lastChangeCheckTimeStamp</code> å’Œ <code>lastWriteTime</code> ä¸ç›¸ç­‰ï¼Œ<code>first</code> å¿…ç„¶ä¸º <code>true</code> ã€‚å› ä¸ºï¼ŒChannel ç›¸å…³çš„äº‹ä»¶é€»è¾‘ï¼Œéƒ½åœ¨å®ƒæ‰€åœ¨çš„ EventLoop ä¸­ï¼Œä¸ä¼šå‡ºç°å¹¶å‘çš„æƒ…å†µã€‚å…³äºè¿™ä¸€å—ï¼ŒåŸºå‹ã€è«é‚£ä¸€é²é“ã€‘åœ¨ <a href="https://github.com/netty/netty/issues/8251" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/netty/netty/issues/8251</a> å·²ç»è¿›è¡Œæé—®ï¼Œåç­‰ç»“æœã€‚</li>
</ul>
</li>
<li>ç¬¬ 25 è‡³ 27 è¡Œï¼šè·å¾—æ–°çš„ <code>messageHashCode</code> å’Œ <code>pendingWriteBytes</code> çš„ã€‚</li>
<li>ç¬¬ 29 è‡³ 33 è¡Œï¼šè‹¥å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™ä¿®æ”¹æœ€åä¸€æ¬¡çš„ <code>lastMessageHashCode</code> å’Œ <code>lastPendingWriteBytes</code> ã€‚<ul>
<li><code>messageHashCode != lastMessageHashCode</code> æˆç«‹ï¼Œâ‘  æœ‰å¯èƒ½å¯¹ç«¯æ¥æ”¶æ•°æ®æ¯”è¾ƒæ…¢ï¼Œå¯¼è‡´ä¸€ä¸ªæ¶ˆæ¯å‘é€äº†ä¸€éƒ¨åˆ†ï¼›â‘¡ åˆæˆ–è€…ï¼Œå‘é€çš„æ¶ˆæ¯<strong>éå¸¸éå¸¸éå¸¸å¤§</strong>ï¼Œå¯¼è‡´ä¸€ä¸ªæ¶ˆæ¯å‘é€äº†ä¸€éƒ¨åˆ†ï¼Œå°±å°†å‘é€ç¼“å­˜åŒºå†™æ»¡ã€‚å¦‚æœæ˜¯è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ ChunkedWriteHandler ï¼Œä¸€æ¡å¤§æ¶ˆæ¯ï¼Œæ‹†æˆå¤šæ¡å°æ¶ˆæ¯ã€‚</li>
<li><code>pendingWriteBytes != lastPendingWriteBytes</code> æˆç«‹ï¼Œâ‘  æœ‰æ–°çš„æ¶ˆæ¯ï¼Œå†™åˆ° ChannelOutboundBuffer å†…å­˜é˜Ÿåˆ—ä¸­ï¼›â‘¡ æœ‰å‡ æ¡æ¶ˆæ¯æˆåŠŸå†™åˆ°å¯¹ç«¯ã€‚è¿™ç§æƒ…å†µï¼Œæ­¤å¤„ä¸ä¼šå‘ç”Ÿã€‚</li>
</ul>
</li>
<li>ç¬¬ 35 è‡³ 37 è¡Œï¼šå½“ä¸”ä»…å½“ <code>first</code> ä¸º <code>true</code> æ—¶ï¼Œå³éé¦–æ¬¡ï¼Œæ‰è¿”å› <code>true</code> ï¼Œè¡¨ç¤º ChannelOutboundBuffer å‘ç”Ÿå˜åŒ–ã€‚<ul>
<li>è¿™æ˜¯ä¸€ä¸ªæœ‰ç‚¹â€œç¥å¥‡â€çš„è®¾å®šï¼Œç¬”è€…è¡¨ç¤ºä¸å¤ªç†è§£ã€‚ç†è®ºæ¥è¯´ï¼ŒChannelOutboundBuffer æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œåªéœ€è¦è€ƒè™‘ã€ç¬¬ 30 è¡Œã€‘ä»£ç çš„åˆ¤æ–­ã€‚å¦‚æœåŠ äº† <code>!first</code> çš„åˆ¤æ–­ï¼Œå¯¼è‡´çš„ç»“æœæ˜¯åœ¨ WriterIdleTimeoutTask å’Œ AllIdleTimeoutTask ä»»åŠ¡ä¸­ï¼ŒChannelOutboundBuffer å³ä½¿å‘ç”Ÿäº†å˜åŒ–ï¼Œåœ¨<strong>é¦–æ¬¡</strong>è¿˜æ˜¯ä¼šè§¦å‘ write å’Œ all ç©ºé—²äº‹ä»¶ï¼Œåœ¨<strong>éé¦–æ¬¡</strong>ä¸ä¼šè§¦å‘ write å’Œ all ç©ºé—²äº‹ä»¶ã€‚</li>
<li>å…³äºä¸Šè¿°çš„å›°æƒ‘ï¼Œ<a href="https://www.jianshu.com/p/8fe70d313d78" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty é‚£äº›äº‹å„¿ â€”â€”â€” å…³äº â€œNetty å‘é€å¤§æ•°æ®åŒ…æ—¶ è§¦å‘å†™ç©ºé—²è¶…æ—¶â€ çš„ä¸€äº›æ€è€ƒã€‹</a> ä¸€æ–‡çš„ä½œè€…ï¼Œä¹Ÿè¡¨è¾¾äº†ç›¸åŒçš„å›°æƒ‘ã€‚åç»­ï¼Œæ‰¾é—ªç”µä¾ é¢åŸºæ²Ÿé€šä¸‹ã€‚</li>
<li>å…³äºä¸Šè¿°çš„å›°æƒ‘ï¼Œ<a href="https://www.jianshu.com/p/f2ed73cf4df8" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty å¿ƒè·³æœåŠ¡ä¹‹ IdleStateHandler æºç åˆ†æã€‹</a> ä¸€æ–‡çš„ä½œè€…ï¼Œè¡¨è¾¾äº†è‡ªå·±çš„ç†è§£ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ã€‚</li>
<li>å½“ç„¶ï¼Œè¿™å—å¦‚æœä¸ç†è§£çš„èƒ–å‹ï¼Œä¹Ÿä¸è¦æ–¹ã€‚ä»ç¬”è€…ç›®å‰äº†è§£ä¸‹æ¥ï¼Œ<code>observeOutput</code> éƒ½æ˜¯è®¾ç½®ä¸º <code>false</code> ã€‚ä¹Ÿå°±è¯´ï¼Œä¸ä¼šè§¦å‘è¿™ä¸ªæ–¹æ³•çš„æ‰§è¡Œã€‚</li>
</ul>
</li>
<li>ç¬¬ 42 è¡Œï¼šè¿”å› <code>false</code> ï¼Œè¡¨ç¤º ChannelOutboundBuffer æœªå‘ç”Ÿå˜åŒ–ã€‚</li>
</ul>
<h2 id="5-8-AbstractIdleTask"><a href="#5-8-AbstractIdleTask" class="headerlink" title="5.8 AbstractIdleTask"></a>5.8 AbstractIdleTask</h2><p>AbstractIdleTask ï¼Œå®ç° Runnable æ¥å£ï¼Œç©ºé—²ä»»åŠ¡æŠ½è±¡ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>AbstractIdleTask æ˜¯ IdleStateHandler çš„å†…éƒ¨é™æ€ç±»ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractIdleTask</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChannelHandlerContext ctx;</span><br><span class="line"></span><br><span class="line">    AbstractIdleTask(ChannelHandlerContext ctx) {</span><br><span class="line">        <span class="keyword">this</span>.ctx = ctx;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// &lt;1&gt; å¿½ç•¥æœªæ‰“å¼€çš„ Channel</span></span><br><span class="line">        <span class="keyword">if</span> (!ctx.channel().isOpen()) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &lt;2&gt; æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">        run(ctx);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ChannelHandlerContext ctx)</span></span>;</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œå¿½ç•¥æœªæ‰“å¼€çš„ Channel ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œå­ç±»å®ç° <code>#run()</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå®ç°è‡ªå®šä¹‰çš„ç©ºé—²æ£€æµ‹é€»è¾‘ã€‚</li>
</ul>
<h3 id="5-8-1-ReaderIdleTimeoutTask"><a href="#5-8-1-ReaderIdleTimeoutTask" class="headerlink" title="5.8.1 ReaderIdleTimeoutTask"></a>5.8.1 ReaderIdleTimeoutTask</h3><p>ReaderIdleTimeoutTask ï¼Œç»§æ‰¿ AbstractIdleTask æŠ½è±¡ç±»ï¼Œæ£€æµ‹ Read ç©ºé—²è¶…æ—¶<strong>å®šæ—¶</strong>ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>ReaderIdleTimeoutTask æ˜¯ IdleStateHandler çš„å†…éƒ¨é™æ€ç±»ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ReaderIdleTimeoutTask</span> <span class="keyword">extends</span> <span class="title">AbstractIdleTask</span> </span>{</span><br><span class="line"> <span class="number">2</span>: </span><br><span class="line"> <span class="number">3</span>:     ReaderIdleTimeoutTask(ChannelHandlerContext ctx) {</span><br><span class="line"> <span class="number">4</span>:         <span class="keyword">super</span>(ctx);</span><br><span class="line"> <span class="number">5</span>:     }</span><br><span class="line"> <span class="number">6</span>: </span><br><span class="line"> <span class="number">7</span>:     <span class="meta">@Override</span></span><br><span class="line"> <span class="number">8</span>:     <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ChannelHandlerContext ctx)</span> </span>{</span><br><span class="line"> <span class="number">9</span>:         <span class="comment">// è®¡ç®—ä¸‹ä¸€æ¬¡æ£€æµ‹çš„å®šæ—¶ä»»åŠ¡çš„å»¶è¿Ÿ</span></span><br><span class="line"><span class="number">10</span>:         <span class="keyword">long</span> nextDelay = readerIdleTimeNanos;</span><br><span class="line"><span class="number">11</span>:         <span class="keyword">if</span> (!reading) {</span><br><span class="line"><span class="number">12</span>:             nextDelay -= ticksInNanos() - lastReadTime;</span><br><span class="line"><span class="number">13</span>:         }</span><br><span class="line"><span class="number">14</span>: </span><br><span class="line"><span class="number">15</span>:         <span class="comment">// å¦‚æœå°äºç­‰äº 0 ï¼Œè¯´æ˜æ£€æµ‹åˆ°è¯»ç©ºé—²</span></span><br><span class="line"><span class="number">16</span>:         <span class="keyword">if</span> (nextDelay &lt;= <span class="number">0</span>) {</span><br><span class="line"><span class="number">17</span>:             <span class="comment">// å»¶è¿Ÿæ—¶é—´ä¸º readerIdleTimeNanos ï¼Œå³å†æ¬¡æ£€æµ‹</span></span><br><span class="line"><span class="number">18</span>:             <span class="comment">// Reader is idle - set a new timeout and notify the callback.</span></span><br><span class="line"><span class="number">19</span>:             readerIdleTimeout = schedule(ctx, <span class="keyword">this</span>, readerIdleTimeNanos, TimeUnit.NANOSECONDS);</span><br><span class="line"><span class="number">20</span>: </span><br><span class="line"><span class="number">21</span>:             <span class="comment">// è·å¾—å½“å‰æ˜¯å¦é¦–æ¬¡æ£€æµ‹åˆ°è¯»ç©ºé—²</span></span><br><span class="line"><span class="number">22</span>:             <span class="keyword">boolean</span> first = firstReaderIdleEvent;</span><br><span class="line"><span class="number">23</span>:             <span class="comment">// æ ‡è®° firstReaderIdleEvent ä¸º false ã€‚ä¹Ÿå°±è¯´ï¼Œä¸‹æ¬¡æ£€æµ‹åˆ°ç©ºé—²ï¼Œå°±éé¦–æ¬¡äº†ã€‚</span></span><br><span class="line"><span class="number">24</span>:             firstReaderIdleEvent = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">25</span>: </span><br><span class="line"><span class="number">26</span>:             <span class="keyword">try</span> {</span><br><span class="line"><span class="number">27</span>:                 <span class="comment">// åˆ›å»ºè¯»ç©ºé—²äº‹ä»¶</span></span><br><span class="line"><span class="number">28</span>:                 IdleStateEvent event = newIdleStateEvent(IdleState.READER_IDLE, first);</span><br><span class="line"><span class="number">29</span>:                 <span class="comment">// é€šçŸ¥é€šé“ç©ºé—²äº‹ä»¶</span></span><br><span class="line"><span class="number">30</span>:                 channelIdle(ctx, event);</span><br><span class="line"><span class="number">31</span>:             } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line"><span class="number">32</span>:                 <span class="comment">// è§¦å‘ Exception Caught åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="number">33</span>:                 ctx.fireExceptionCaught(t);</span><br><span class="line"><span class="number">34</span>:             }</span><br><span class="line"><span class="number">35</span>:         <span class="comment">// å¦‚æœå¤§äº 0 ï¼Œè¯´æ˜æœªæ£€æµ‹åˆ°è¯»ç©ºé—²</span></span><br><span class="line"><span class="number">36</span>:         } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">37</span>:             <span class="comment">// å»¶è¿Ÿæ—¶é—´ä¸º nextDelay ï¼Œå³æŒ‰ç…§æœ€åä¸€æ¬¡è¯»çš„æ—¶é—´ä½œä¸ºå¼€å§‹è®¡æ•°</span></span><br><span class="line"><span class="number">38</span>:             <span class="comment">// Read occurred before the timeout - set a new timeout with shorter delay.</span></span><br><span class="line"><span class="number">39</span>:             readerIdleTimeout = schedule(ctx, <span class="keyword">this</span>, nextDelay, TimeUnit.NANOSECONDS);</span><br><span class="line"><span class="number">40</span>:         }</span><br><span class="line"><span class="number">41</span>:     }</span><br><span class="line"><span class="number">42</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 9 è‡³ 13 è¡Œï¼šè®¡ç®—ä¸‹ä¸€æ¬¡æ£€æµ‹çš„å®šæ—¶ä»»åŠ¡çš„<strong>å»¶è¿Ÿ</strong>ã€‚<ul>
<li><code>reading</code> ä¸º <code>true</code> æ—¶ï¼Œæ„å‘³ç€æ­£åœ¨è¯»å–ï¼Œ<strong>ä¸ä¼š</strong>è¢«æ£€æµ‹ä¸ºè¯»ç©ºé—²ã€‚ </li>
<li><code>reading</code> ä¸º <code>false</code> æ—¶ï¼Œå®é™… <code>nextDelay</code> çš„è®¡ç®—ä¸º <code>readerIdleTimeNanos - (ticksInNanos() - lastReadTime)</code> ã€‚å¦‚æœå°äºç­‰äº 0 ï¼Œæ„å‘³ç€ <code>ticksInNanos() - lastReadTime &gt;=  readerIdleTimeNanos</code> ï¼Œè¶…æ—¶ã€‚</li>
</ul>
</li>
<li>â‘  ç¬¬ 35 è‡³ 40 è¡Œï¼šå¦‚æœ<strong>å¤§äº</strong> 0 ï¼Œè¯´æ˜æœªæ£€æµ‹åˆ°è¯»ç©ºé—²ã€‚<ul>
<li>ç¬¬ 39 è¡Œï¼šè°ƒç”¨ <code>#schedule(ChannelHandlerContext ctx, Runnable task, long delay, TimeUnit unit)</code> æ–¹æ³•ï¼Œåˆå§‹<strong>ä¸‹ä¸€æ¬¡</strong>çš„ ReaderIdleTimeoutTask å®šæ—¶ä»»åŠ¡ã€‚å…¶ä¸­ï¼Œå»¶è¿Ÿæ—¶é—´ä¸º <code>nextDelay</code> ï¼Œå³æŒ‰ç…§æœ€åä¸€æ¬¡è¯»çš„æ—¶é—´ä½œä¸ºå¼€å§‹è®¡æ•°ã€‚</li>
</ul>
</li>
<li>â‘¡ ç¬¬ 15 è‡³ 34 è¡Œï¼šå¦‚æœ<strong>å°äºç­‰äº</strong> 0 ï¼Œè¯´æ˜æ£€æµ‹åˆ°è¯»ç©ºé—²ã€‚<ul>
<li>ç¬¬ 19 è¡Œï¼šè°ƒç”¨ <code>#schedule(ChannelHandlerContext ctx, Runnable task, long delay, TimeUnit unit)</code> æ–¹æ³•ï¼Œåˆå§‹<strong>ä¸‹ä¸€æ¬¡</strong>çš„ ReaderIdleTimeoutTask å®šæ—¶ä»»åŠ¡ã€‚å…¶ä¸­ï¼Œå»¶è¿Ÿæ—¶é—´ä¸º <code>readerIdleTimeNanos</code> ï¼Œå³é‡æ–°è®¡æ•°ã€‚</li>
<li>ç¬¬ 21 è¡Œï¼šè·å¾—å½“å‰æ˜¯å¦é¦–æ¬¡æ£€æµ‹åˆ°è¯»ç©ºé—²ã€‚<ul>
<li>ç¬¬ 24 è¡Œï¼šæ ‡è®° <code>firstReaderIdleEvent</code> ä¸º <code>false</code> ã€‚ä¹Ÿå°±è¯´ï¼Œä¸‹æ¬¡æ£€æµ‹åˆ°ç©ºé—²ï¼Œå°±<strong>éé¦–æ¬¡</strong>äº†ã€‚</li>
</ul>
</li>
<li>ç¬¬ 28 è¡Œï¼šè°ƒç”¨ <code>#newIdleStateEvent(IdleState state, boolean first)</code> æ–¹æ³•ï¼Œåˆ›å»ºåˆ›å»º<strong>è¯»</strong>ç©ºé—²äº‹ä»¶ã€‚<ul>
<li>ç¬¬ 30 è¡Œï¼š è°ƒç”¨ <code>#channelIdle(ChannelHandlerContext ctx, IdleStateEvent evt)</code> æ–¹æ³•ï¼Œåœ¨ pipeline ä¸­ï¼Œè§¦å‘ UserEvent äº‹ä»¶ã€‚</li>
</ul>
</li>
<li>ç¬¬ 31 è‡³ 34 è¡Œï¼šå¦‚æœ<strong>å‘ç”Ÿå¼‚å¸¸</strong>ï¼Œè§¦å‘ Exception Caught äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¤„ç†å¼‚å¸¸ã€‚</li>
</ul>
</li>
</ul>
<h3 id="5-8-2-WriterIdleTimeoutTask"><a href="#5-8-2-WriterIdleTimeoutTask" class="headerlink" title="5.8.2 WriterIdleTimeoutTask"></a>5.8.2 WriterIdleTimeoutTask</h3><p>WriterIdleTimeoutTask ï¼Œç»§æ‰¿ AbstractIdleTask æŠ½è±¡ç±»ï¼Œæ£€æµ‹ Write ç©ºé—²è¶…æ—¶<strong>å®šæ—¶</strong>ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>WriterIdleTimeoutTask æ˜¯ IdleStateHandler çš„å†…éƒ¨é™æ€ç±»ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WriterIdleTimeoutTask</span> <span class="keyword">extends</span> <span class="title">AbstractIdleTask</span> </span>{</span><br><span class="line"> <span class="number">2</span>: </span><br><span class="line"> <span class="number">3</span>:     WriterIdleTimeoutTask(ChannelHandlerContext ctx) {</span><br><span class="line"> <span class="number">4</span>:         <span class="keyword">super</span>(ctx);</span><br><span class="line"> <span class="number">5</span>:     }</span><br><span class="line"> <span class="number">6</span>: </span><br><span class="line"> <span class="number">7</span>:     <span class="meta">@Override</span></span><br><span class="line"> <span class="number">8</span>:     <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ChannelHandlerContext ctx)</span> </span>{</span><br><span class="line"> <span class="number">9</span>:         <span class="comment">// è®¡ç®—ä¸‹ä¸€æ¬¡æ£€æµ‹çš„å®šæ—¶ä»»åŠ¡çš„å»¶è¿Ÿ</span></span><br><span class="line"><span class="number">10</span>:         <span class="keyword">long</span> lastWriteTime = IdleStateHandler.<span class="keyword">this</span>.lastWriteTime;</span><br><span class="line"><span class="number">11</span>:         <span class="keyword">long</span> nextDelay = writerIdleTimeNanos - (ticksInNanos() - lastWriteTime);</span><br><span class="line"><span class="number">12</span>: </span><br><span class="line"><span class="number">13</span>:         <span class="comment">// å¦‚æœå°äºç­‰äº 0 ï¼Œè¯´æ˜æ£€æµ‹åˆ°å†™ç©ºé—²</span></span><br><span class="line"><span class="number">14</span>:         <span class="keyword">if</span> (nextDelay &lt;= <span class="number">0</span>) {</span><br><span class="line"><span class="number">15</span>:             <span class="comment">// å»¶è¿Ÿæ—¶é—´ä¸º writerIdleTimeout ï¼Œå³å†æ¬¡æ£€æµ‹</span></span><br><span class="line"><span class="number">16</span>:             <span class="comment">// Writer is idle - set a new timeout and notify the callback.</span></span><br><span class="line"><span class="number">17</span>:             writerIdleTimeout = schedule(ctx, <span class="keyword">this</span>, writerIdleTimeNanos, TimeUnit.NANOSECONDS);</span><br><span class="line"><span class="number">18</span>: </span><br><span class="line"><span class="number">19</span>:             <span class="comment">// è·å¾—å½“å‰æ˜¯å¦é¦–æ¬¡æ£€æµ‹åˆ°å†™ç©ºé—²</span></span><br><span class="line"><span class="number">20</span>:             <span class="keyword">boolean</span> first = firstWriterIdleEvent;</span><br><span class="line"><span class="number">21</span>:             <span class="comment">// æ ‡è®° firstWriterIdleEvent ä¸º false ã€‚ä¹Ÿå°±è¯´ï¼Œä¸‹æ¬¡æ£€æµ‹åˆ°ç©ºé—²ï¼Œå°±éé¦–æ¬¡äº†ã€‚</span></span><br><span class="line"><span class="number">22</span>:             firstWriterIdleEvent = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">23</span>: </span><br><span class="line"><span class="number">24</span>:             <span class="keyword">try</span> {</span><br><span class="line"><span class="number">25</span>:                 <span class="comment">// åˆ¤æ–­ ChannelOutboundBuffer æ˜¯å¦å‘ç”Ÿå˜åŒ–</span></span><br><span class="line"><span class="number">26</span>:                 <span class="keyword">if</span> (hasOutputChanged(ctx, first)) {</span><br><span class="line"><span class="number">27</span>:                     <span class="keyword">return</span>;</span><br><span class="line"><span class="number">28</span>:                 }</span><br><span class="line"><span class="number">29</span>: </span><br><span class="line"><span class="number">30</span>:                 <span class="comment">// åˆ›å»ºå†™ç©ºé—²äº‹ä»¶</span></span><br><span class="line"><span class="number">31</span>:                 IdleStateEvent event = newIdleStateEvent(IdleState.WRITER_IDLE, first);</span><br><span class="line"><span class="number">32</span>:                 <span class="comment">// é€šçŸ¥é€šé“ç©ºé—²äº‹ä»¶</span></span><br><span class="line"><span class="number">33</span>:                 channelIdle(ctx, event);</span><br><span class="line"><span class="number">34</span>:             } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line"><span class="number">35</span>:                 <span class="comment">// è§¦å‘ Exception Caught åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="number">36</span>:                 ctx.fireExceptionCaught(t);</span><br><span class="line"><span class="number">37</span>:             }</span><br><span class="line"><span class="number">38</span>:         <span class="comment">// å¦‚æœå¤§äº 0 ï¼Œè¯´æ˜æœªæ£€æµ‹åˆ°è¯»ç©ºé—²</span></span><br><span class="line"><span class="number">39</span>:         } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">40</span>:             <span class="comment">// Write occurred before the timeout - set a new timeout with shorter delay.</span></span><br><span class="line"><span class="number">41</span>:             writerIdleTimeout = schedule(ctx, <span class="keyword">this</span>, nextDelay, TimeUnit.NANOSECONDS);</span><br><span class="line"><span class="number">42</span>:         }</span><br><span class="line"><span class="number">43</span>:     }</span><br><span class="line"><span class="number">44</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 9 è‡³ 11 è¡Œï¼šè®¡ç®—ä¸‹ä¸€æ¬¡æ£€æµ‹çš„å®šæ—¶ä»»åŠ¡çš„<strong>å»¶è¿Ÿ</strong>ã€‚</li>
<li>â‘  ç¬¬ 38 è‡³ 42 è¡Œï¼šå¦‚æœ<strong>å¤§äº</strong> 0 ï¼Œè¯´æ˜æœªæ£€æµ‹åˆ°å†™ç©ºé—²ã€‚<ul>
<li>ç¬¬ 39 è¡Œï¼šè°ƒç”¨ <code>#schedule(ChannelHandlerContext ctx, Runnable task, long delay, TimeUnit unit)</code> æ–¹æ³•ï¼Œåˆå§‹<strong>ä¸‹ä¸€æ¬¡</strong>çš„ WriterIdleTimeoutTask å®šæ—¶ä»»åŠ¡ã€‚å…¶ä¸­ï¼Œå»¶è¿Ÿæ—¶é—´ä¸º <code>nextDelay</code> ï¼Œå³æŒ‰ç…§æœ€åä¸€æ¬¡å†™çš„æ—¶é—´ä½œä¸ºå¼€å§‹è®¡æ•°ã€‚</li>
</ul>
</li>
<li>â‘¡ ç¬¬ 13 è‡³ 37 è¡Œï¼šå¦‚æœ<strong>å°äºç­‰äº</strong> 0 ï¼Œè¯´æ˜æ£€æµ‹åˆ°å†™ç©ºé—²ã€‚<ul>
<li>ç¬¬ 17 è¡Œï¼šè°ƒç”¨ <code>#schedule(ChannelHandlerContext ctx, Runnable task, long delay, TimeUnit unit)</code> æ–¹æ³•ï¼Œåˆå§‹<strong>ä¸‹ä¸€æ¬¡</strong>çš„ WriterIdleTimeoutTask å®šæ—¶ä»»åŠ¡ã€‚å…¶ä¸­ï¼Œå»¶è¿Ÿæ—¶é—´ä¸º <code>readerIdleTimeNanos</code> ï¼Œå³é‡æ–°è®¡æ•°ã€‚</li>
<li>ç¬¬ 20 è¡Œï¼šè·å¾—å½“å‰æ˜¯å¦é¦–æ¬¡æ£€æµ‹åˆ°å†™ç©ºé—²ã€‚<ul>
<li>ç¬¬ 22 è¡Œï¼šæ ‡è®° <code>firstWriterIdleEvent</code> ä¸º <code>false</code> ã€‚ä¹Ÿå°±è¯´ï¼Œä¸‹æ¬¡æ£€æµ‹åˆ°ç©ºé—²ï¼Œå°±<strong>éé¦–æ¬¡</strong>äº†ã€‚</li>
</ul>
</li>
<li>ç¬¬ 25 è‡³ 28 è¡Œï¼šåˆ¤æ–­ ChannelOutboundBuffer æ˜¯å¦å‘ç”Ÿå˜åŒ–ã€‚å¦‚æœæœ‰å˜åŒ–ï¼Œä¸è§¦å‘å†™ç©ºé—²æ—¶é—´ã€‚</li>
<li>ç¬¬ 31 è¡Œï¼šè°ƒç”¨ <code>#newIdleStateEvent(IdleState state, boolean first)</code> æ–¹æ³•ï¼Œåˆ›å»ºåˆ›å»º<strong>å†™</strong>ç©ºé—²äº‹ä»¶ã€‚<ul>
<li>ç¬¬ 33 è¡Œï¼š è°ƒç”¨ <code>#channelIdle(ChannelHandlerContext ctx, IdleStateEvent evt)</code> æ–¹æ³•ï¼Œåœ¨ pipeline ä¸­ï¼Œè§¦å‘ UserEvent äº‹ä»¶ã€‚</li>
</ul>
</li>
<li>ç¬¬ 34 è‡³ 37 è¡Œï¼šå¦‚æœ<strong>å‘ç”Ÿå¼‚å¸¸</strong>ï¼Œè§¦å‘ Exception Caught äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¤„ç†å¼‚å¸¸ã€‚</li>
</ul>
</li>
</ul>
<h3 id="5-8-3-AllIdleTimeoutTask"><a href="#5-8-3-AllIdleTimeoutTask" class="headerlink" title="5.8.3 AllIdleTimeoutTask"></a>5.8.3 AllIdleTimeoutTask</h3><p>AllIdleTimeoutTask ï¼Œç»§æ‰¿ AbstractIdleTask æŠ½è±¡ç±»ï¼Œæ£€æµ‹ All ç©ºé—²è¶…æ—¶<strong>å®šæ—¶</strong>ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>AllIdleTimeoutTask æ˜¯ IdleStateHandler çš„å†…éƒ¨é™æ€ç±»ã€‚</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">AllIdleTimeoutTask</span> <span class="keyword">extends</span> <span class="title">AbstractIdleTask</span> </span>{</span><br><span class="line"></span><br><span class="line">    AllIdleTimeoutTask(ChannelHandlerContext ctx) {</span><br><span class="line">        <span class="keyword">super</span>(ctx);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ChannelHandlerContext ctx)</span> </span>{</span><br><span class="line">        <span class="comment">// è®¡ç®—ä¸‹ä¸€æ¬¡æ£€æµ‹çš„å®šæ—¶ä»»åŠ¡çš„å»¶è¿Ÿ</span></span><br><span class="line">        <span class="keyword">long</span> nextDelay = allIdleTimeNanos;</span><br><span class="line">        <span class="keyword">if</span> (!reading) {</span><br><span class="line">            nextDelay -= ticksInNanos() - Math.max(lastReadTime, lastWriteTime); <span class="comment">// &lt;1&gt; å–å¤§å€¼</span></span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœå°äºç­‰äº 0 ï¼Œè¯´æ˜æ£€æµ‹åˆ° all ç©ºé—²</span></span><br><span class="line">        <span class="keyword">if</span> (nextDelay &lt;= <span class="number">0</span>) {</span><br><span class="line">            <span class="comment">// å»¶è¿Ÿæ—¶é—´ä¸º allIdleTimeNanos ï¼Œå³å†æ¬¡æ£€æµ‹</span></span><br><span class="line">            <span class="comment">// Both reader and writer are idle - set a new timeout and</span></span><br><span class="line">            <span class="comment">// notify the callback.</span></span><br><span class="line">            allIdleTimeout = schedule(ctx, <span class="keyword">this</span>, allIdleTimeNanos, TimeUnit.NANOSECONDS);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·å¾—å½“å‰æ˜¯å¦é¦–æ¬¡æ£€æµ‹åˆ° all ç©ºé—²</span></span><br><span class="line">            <span class="keyword">boolean</span> first = firstAllIdleEvent;</span><br><span class="line">            <span class="comment">// æ ‡è®° firstAllIdleEvent ä¸º false ã€‚ä¹Ÿå°±è¯´ï¼Œä¸‹æ¬¡æ£€æµ‹åˆ°ç©ºé—²ï¼Œå°±éé¦–æ¬¡äº†ã€‚</span></span><br><span class="line">            firstAllIdleEvent = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                <span class="comment">// åˆ¤æ–­ ChannelOutboundBuffer æ˜¯å¦å‘ç”Ÿå˜åŒ–</span></span><br><span class="line">                <span class="keyword">if</span> (hasOutputChanged(ctx, first)) {</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                }</span><br><span class="line"></span><br><span class="line">                <span class="comment">// åˆ›å»º all ç©ºé—²äº‹ä»¶</span></span><br><span class="line">                IdleStateEvent event = newIdleStateEvent(IdleState.ALL_IDLE, first);</span><br><span class="line">                <span class="comment">// é€šçŸ¥é€šé“ç©ºé—²äº‹ä»¶</span></span><br><span class="line">                channelIdle(ctx, event);</span><br><span class="line">            } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line">                ctx.fireExceptionCaught(t);</span><br><span class="line">            }</span><br><span class="line">        <span class="comment">// å¦‚æœå¤§äº 0 ï¼Œè¯´æ˜æœªæ£€æµ‹åˆ° all ç©ºé—²</span></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// Either read or write occurred before the timeout - set a new</span></span><br><span class="line">            <span class="comment">// timeout with shorter delay.</span></span><br><span class="line">            allIdleTimeout = schedule(ctx, <span class="keyword">this</span>, nextDelay, TimeUnit.NANOSECONDS);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å› ä¸º All æ˜¯ Write å’Œ Read <strong>ä»»ä¸€</strong>ä¸€ç§ç©ºé—²å³å¯ï¼Œæ‰€ä»¥ AllIdleTimeoutTask æ˜¯ ReaderIdleTimeoutTask å’Œ WriterIdleTimeoutTask çš„<strong>ç»¼åˆ</strong>ã€‚</li>
<li><code>&lt;1&gt;</code> å¤„ï¼Œå– <code>lastReadTime</code> å’Œ <code>lastWriteTime</code> ä¸­çš„<strong>å¤§</strong>å€¼ï¼Œä»è€Œæ¥åˆ¤æ–­ï¼Œæ˜¯å¦æœ‰ Write å’Œ Read <strong>ä»»ä¸€</strong>ä¸€ç§ç©ºé—²ã€‚</li>
<li>WriterIdleTimeoutTask å°±ä¸è¯¦ç»†è§£æï¼Œèƒ–å‹è‡ªå·±è¯»è¯»ä»£ç å³å¯ã€‚</li>
</ul>
<h1 id="6-ReadTimeoutHandler"><a href="#6-ReadTimeoutHandler" class="headerlink" title="6. ReadTimeoutHandler"></a>6. ReadTimeoutHandler</h1><p><code>io.netty.handler.timeout.ReadTimeoutHandler</code> ï¼Œç»§æ‰¿ IdleStateHandler ç±»ï¼Œå½“ Channel çš„<strong>è¯»</strong>ç©ºé—²æ—¶é—´( è¯»æˆ–è€…å†™ )å¤ªé•¿æ—¶ï¼ŒæŠ›å‡º ReadTimeoutException å¼‚å¸¸ï¼Œå¹¶è‡ªåŠ¨å…³é—­è¯¥ Channel ã€‚</p>
<h2 id="6-1-æ„é€ æ–¹æ³•"><a href="#6-1-æ„é€ æ–¹æ³•" class="headerlink" title="6.1 æ„é€ æ–¹æ³•"></a>6.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Channel æ˜¯å¦å…³é—­</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> closed;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReadTimeoutHandler</span><span class="params">(<span class="keyword">int</span> timeoutSeconds)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>(timeoutSeconds, TimeUnit.SECONDS);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ReadTimeoutHandler</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> </span>{</span><br><span class="line">    <span class="comment">// ç¦ç”¨ Write / All çš„ç©ºé—²æ£€æµ‹</span></span><br><span class="line">    <span class="keyword">super</span>(timeout, <span class="number">0</span>, <span class="number">0</span>, unit); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>closed</code> å±æ€§ï¼ŒChannel æ˜¯å¦å…³é—­ã€‚</li>
<li><code>&lt;1&gt;</code> å¤„ï¼Œç¦ç”¨ Write / All çš„ç©ºé—²æ£€æµ‹ï¼Œåªæ ¹æ® <code>timeout</code> æ–¹æ³•å‚æ•°ï¼Œå¼€å¯ Read çš„ç©ºé—²æ£€æµ‹ã€‚</li>
</ul>
<h2 id="6-2-channelIdle"><a href="#6-2-channelIdle" class="headerlink" title="6.2 channelIdle"></a>6.2 channelIdle</h2><p><code>#channelIdle(ChannelHandlerContext ctx, IdleStateEvent evt)</code> æ–¹æ³•ï¼Œè¦†å†™çˆ¶ç±»æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">channelIdle</span><span class="params">(ChannelHandlerContext ctx, IdleStateEvent evt)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">assert</span> evt.state() == IdleState.READER_IDLE;</span><br><span class="line">    readTimedOut(ctx);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Is called when a read timeout was detected.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">readTimedOut</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (!closed) {</span><br><span class="line">        <span class="comment">// &lt;1&gt; è§¦å‘ Exception Caught äº‹ä»¶åˆ° pipeline ä¸­ï¼Œå¼‚å¸¸ä¸º ReadTimeoutException</span></span><br><span class="line">        ctx.fireExceptionCaught(ReadTimeoutException.INSTANCE);</span><br><span class="line">        <span class="comment">// &lt;2&gt; å…³é—­ Channel é€šé“</span></span><br><span class="line">        ctx.close();</span><br><span class="line">        <span class="comment">// &lt;3&gt; æ ‡è®° Channel ä¸ºå·²å…³é—­</span></span><br><span class="line">        closed = <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè§¦å‘ Exception Caught äº‹ä»¶åˆ° pipeline ä¸­ï¼Œå¼‚å¸¸ä¸º ReadTimeoutException ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œå…³é—­ Channel é€šé“ã€‚</li>
<li><code>&lt;3&gt;</code> å¤„ï¼Œæ ‡è®° Channel ä¸ºå·²å…³é—­ã€‚</li>
</ul>
<h1 id="7-WriteTimeoutHandler"><a href="#7-WriteTimeoutHandler" class="headerlink" title="7. WriteTimeoutHandler"></a>7. WriteTimeoutHandler</h1><p><code>io.netty.handler.timeout.WriteTimeoutHandler</code> ï¼Œç»§æ‰¿ ChannelOutboundHandlerAdapter ç±»ï¼Œå½“ä¸€ä¸ª<strong>å†™</strong>æ“ä½œä¸èƒ½åœ¨æŒ‡å®šæ—¶é—´å†…å®Œæˆæ—¶ï¼ŒæŠ›å‡º WriteTimeoutException å¼‚å¸¸ï¼Œå¹¶è‡ªåŠ¨å…³é—­å¯¹åº” Channel ã€‚</p>
<p>ğŸ˜ˆ <strong>æ³¨æ„ï¼Œè¿™é‡Œå†™å…¥ï¼ŒæŒ‡çš„æ˜¯ flush åˆ°å¯¹ç«¯ Channel ï¼Œè€Œä¸ä»…ä»…æ˜¯å†™åˆ° ChannelOutboundBuffer é˜Ÿåˆ—</strong>ã€‚</p>
<h2 id="7-1-æ„é€ æ–¹æ³•"><a href="#7-1-æ„é€ æ–¹æ³•" class="headerlink" title="7.1 æ„é€ æ–¹æ³•"></a>7.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœ€å°çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼šçº³ç§’</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> MIN_TIMEOUT_NANOS = TimeUnit.MILLISECONDS.toNanos(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼šçº³ç§’</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> timeoutNanos;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * WriteTimeoutTask åŒå‘é“¾è¡¨ã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * lastTask ä¸ºé“¾è¡¨çš„å°¾èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * A doubly-linked list to track all WriteTimeoutTasks</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> WriteTimeoutTask lastTask;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Channel æ˜¯å¦å…³é—­</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> closed;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">WriteTimeoutHandler</span><span class="params">(<span class="keyword">int</span> timeoutSeconds)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>(timeoutSeconds, TimeUnit.SECONDS);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">WriteTimeoutHandler</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (unit == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"unit"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (timeout &lt;= <span class="number">0</span>) {</span><br><span class="line">        timeoutNanos = <span class="number">0</span>;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        timeoutNanos = Math.max(unit.toNanos(timeout), MIN_TIMEOUT_NANOS); <span class="comment">// ä¿è¯å¤§äºç­‰äº MIN_TIMEOUT_NANOS</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>timeoutNanos</code> å±æ€§ï¼Œå†™å…¥è¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼šçº³ç§’ã€‚<ul>
<li><code>MIN_TIMEOUT_NANOS</code> å±æ€§ï¼Œæœ€å°çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½ï¼šçº³ç§’ã€‚</li>
</ul>
</li>
<li><code>lastTask</code> å±æ€§ï¼ŒWriteTimeoutTask åŒå‘é“¾è¡¨ã€‚å…¶ä¸­ï¼Œ<code>lastTask</code> ä¸ºé“¾è¡¨çš„<strong>å°¾èŠ‚ç‚¹</strong>ã€‚</li>
<li><code>closed</code> å±æ€§ï¼ŒChannel æ˜¯å¦å…³é—­ã€‚</li>
</ul>
<h2 id="7-2-handlerRemoved"><a href="#7-2-handlerRemoved" class="headerlink" title="7.2 handlerRemoved"></a>7.2 handlerRemoved</h2><p><code>#handlerRemoved(ChannelHandlerContext ctx)</code> æ–¹æ³•ï¼Œç§»é™¤æ‰€æœ‰ WriteTimeoutTask ä»»åŠ¡ï¼Œå¹¶å–æ¶ˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handlerRemoved</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    WriteTimeoutTask task = lastTask;</span><br><span class="line">    <span class="comment">// ç½®ç©º lastTask</span></span><br><span class="line">    lastTask = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// å¾ªç¯ç§»é™¤ï¼ŒçŸ¥é“ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">while</span> (task != <span class="keyword">null</span>) {</span><br><span class="line">        <span class="comment">// å–æ¶ˆå½“å‰ä»»åŠ¡çš„å®šæ—¶ä»»åŠ¡</span></span><br><span class="line">        task.scheduledFuture.cancel(<span class="keyword">false</span>);</span><br><span class="line">        <span class="comment">// è®°å½•å‰ä¸€ä¸ªä»»åŠ¡</span></span><br><span class="line">        WriteTimeoutTask prev = task.prev;</span><br><span class="line">        <span class="comment">// ç½®ç©ºå½“å‰ä»»åŠ¡çš„å‰åèŠ‚ç‚¹</span></span><br><span class="line">        task.prev = <span class="keyword">null</span>;</span><br><span class="line">        task.next = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// è·³åˆ°å‰ä¸€ä¸ªä»»åŠ¡</span></span><br><span class="line">        task = prev;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚</li>
</ul>
<h2 id="7-3-write"><a href="#7-3-write" class="headerlink" title="7.3 write"></a>7.3 write</h2><p><code>#write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (timeoutNanos &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="comment">// å¦‚æœ promise æ˜¯ VoidPromise ï¼Œåˆ™åŒ…è£…æˆé VoidPromise ï¼Œä¸ºäº†åç»­çš„å›è°ƒã€‚</span></span><br><span class="line">        promise = promise.unvoid(); &lt;<span class="number">1</span>ã€‹</span><br><span class="line">        <span class="comment">// åˆ›å»ºå®šæ—¶ä»»åŠ¡</span></span><br><span class="line">        scheduleTimeout(ctx, promise);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// å†™å…¥</span></span><br><span class="line">    ctx.write(msg, promise);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œå¦‚æœ <code>promise</code> ç±»å‹æ˜¯ VoidPromise ï¼Œåˆ™åŒ…è£…æˆé VoidPromise ï¼Œä¸ºäº†åç»­çš„å›è°ƒã€‚å› ä¸º VoidPromise æ— æ³•æ¥æ”¶åˆ°å›è°ƒã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#scheduleTimeout(final ChannelHandlerContext ctx, final ChannelPromise promise)</code> æ–¹æ³•ï¼Œåˆ›å»ºå®šæ—¶ä»»åŠ¡ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ7.4 scheduleTimeoutã€</a> ã€‚</li>
</ul>
<h2 id="7-4-scheduleTimeout"><a href="#7-4-scheduleTimeout" class="headerlink" title="7.4 scheduleTimeout"></a>7.4 scheduleTimeout</h2><p><code>#scheduleTimeout(final ChannelHandlerContext ctx, final ChannelPromise promise)</code> æ–¹æ³•ï¼Œåˆ›å»ºå®šæ—¶ä»»åŠ¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">scheduleTimeout</span><span class="params">(<span class="keyword">final</span> ChannelHandlerContext ctx, <span class="keyword">final</span> ChannelPromise promise)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="comment">// Schedule a timeout.</span></span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// åˆ›å»º WriteTimeoutTask ä»»åŠ¡</span></span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">final</span> WriteTimeoutTask task = <span class="keyword">new</span> WriteTimeoutTask(ctx, promise);</span><br><span class="line"> <span class="number">5</span>:     <span class="comment">// å®šæ—¶ä»»åŠ¡</span></span><br><span class="line"> <span class="number">6</span>:     task.scheduledFuture = ctx.executor().schedule(task, timeoutNanos, TimeUnit.NANOSECONDS);</span><br><span class="line"> <span class="number">7</span>: </span><br><span class="line"> <span class="number">8</span>:     <span class="keyword">if</span> (!task.scheduledFuture.isDone()) {</span><br><span class="line"> <span class="number">9</span>:         <span class="comment">// æ·»åŠ åˆ°é“¾è¡¨</span></span><br><span class="line"><span class="number">10</span>:         addWriteTimeoutTask(task);</span><br><span class="line"><span class="number">11</span>: </span><br><span class="line"><span class="number">12</span>:         <span class="comment">// Cancel the scheduled timeout if the flush promise is complete.</span></span><br><span class="line"><span class="number">13</span>:         <span class="comment">// å°† task ä½œä¸ºç›‘å¬å™¨ï¼Œæ·»åŠ åˆ° promise ä¸­ã€‚åœ¨å†™å…¥å®Œæˆåï¼Œå¯ä»¥ç§»é™¤è¯¥å®šæ—¶ä»»åŠ¡</span></span><br><span class="line"><span class="number">14</span>:         promise.addListener(task);</span><br><span class="line"><span class="number">15</span>:     }</span><br><span class="line"><span class="number">16</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 2 è‡³ 6 è¡Œï¼šåˆ›å»º WriteTimeoutTask ä»»åŠ¡ï¼Œå¹¶å‘èµ·<strong>å®šæ—¶ä»»åŠ¡</strong>ã€‚</li>
<li>ç¬¬ 8 è¡Œï¼šå¦‚æœå®šæ—¶ä»»åŠ¡<strong>å·²ç»æ‰§è¡Œå®Œæˆ</strong>ï¼Œåˆ™ä¸éœ€è¦è¿›è¡Œç›‘å¬ã€‚å¦åˆ™ï¼Œéœ€è¦æ‰§è¡Œã€ç¬¬ 10 è‡³ 14 è¡Œã€‘çš„ä»£ç é€»è¾‘ã€‚</li>
<li>ç¬¬ 10 è¡Œï¼šè°ƒç”¨ <code>#addWriteTimeoutTask(WriteTimeoutTask task)</code> æ–¹æ³•ï¼Œæ·»åŠ åˆ°é“¾è¡¨ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ7.5 addWriteTimeoutTaskã€</a> ã€‚ </li>
<li>ç¬¬ 14 è¡Œï¼šå°† <code>task</code> ä½œä¸ºç›‘å¬å™¨ï¼Œæ·»åŠ åˆ° <code>promise</code> ä¸­ã€‚åœ¨å†™å…¥å®Œæˆåï¼Œå¯ä»¥ç§»é™¤è¯¥å®šæ—¶ä»»åŠ¡ã€‚ä¹Ÿå°±è¯´ï¼Œè°ƒç”¨é“¾æ˜¯ <code>flush =&gt; å›è°ƒ =&gt; promise =&gt; å›è°ƒ =&gt; task</code> ã€‚</li>
</ul>
<h2 id="7-5-addWriteTimeoutTask"><a href="#7-5-addWriteTimeoutTask" class="headerlink" title="7.5 addWriteTimeoutTask"></a>7.5 addWriteTimeoutTask</h2><p><code>#addWriteTimeoutTask(WriteTimeoutTask task)</code> æ–¹æ³•ï¼Œæ·»åŠ åˆ°é“¾è¡¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addWriteTimeoutTask</span><span class="params">(WriteTimeoutTask task)</span> </span>{</span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ°é“¾è¡¨çš„å°¾èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (lastTask != <span class="keyword">null</span>) {</span><br><span class="line">        lastTask.next = task;</span><br><span class="line">        task.prev = lastTask;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// ä¿®æ”¹ lastTask ä¸ºå½“å‰ä»»åŠ¡</span></span><br><span class="line">    lastTask = task;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>æ·»åŠ åˆ°é“¾è¡¨çš„å°¾èŠ‚ç‚¹ï¼Œå¹¶ä¿®æ”¹ <code>lastTask</code> ä¸º<strong>å½“å‰</strong>ä»»åŠ¡ã€‚</p>
<h2 id="7-6-removeWriteTimeoutTask"><a href="#7-6-removeWriteTimeoutTask" class="headerlink" title="7.6 removeWriteTimeoutTask"></a>7.6 removeWriteTimeoutTask</h2><p><code>#removeWriteTimeoutTask(WriteTimeoutTask task)</code> æ–¹æ³•ï¼Œç§»é™¤å‡ºé“¾è¡¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeWriteTimeoutTask</span><span class="params">(WriteTimeoutTask task)</span> </span>{</span><br><span class="line">    <span class="comment">// ä»åŒå‘é“¾è¡¨ä¸­ï¼Œç§»é™¤è‡ªå·±</span></span><br><span class="line">    <span class="keyword">if</span> (task == lastTask) { <span class="comment">// å°¾èŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">// task is the tail of list</span></span><br><span class="line">        <span class="keyword">assert</span> task.next == <span class="keyword">null</span>;</span><br><span class="line">        lastTask = lastTask.prev;</span><br><span class="line">        <span class="keyword">if</span> (lastTask != <span class="keyword">null</span>) {</span><br><span class="line">            lastTask.next = <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (task.prev == <span class="keyword">null</span> &amp;&amp; task.next == <span class="keyword">null</span>) { <span class="comment">// å·²ç»è¢«ç§»é™¤</span></span><br><span class="line">        <span class="comment">// Since task is not lastTask, then it has been removed or not been added.</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (task.prev == <span class="keyword">null</span>) { <span class="comment">// å¤´èŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">// task is the head of list and the list has at least 2 nodes</span></span><br><span class="line">        task.next.prev = <span class="keyword">null</span>;</span><br><span class="line">    } <span class="keyword">else</span> { <span class="comment">// ä¸­é—´çš„èŠ‚ç‚¹</span></span><br><span class="line">        task.prev.next = task.next;</span><br><span class="line">        task.next.prev = task.prev;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// é‡ç½® task å‰åèŠ‚ç‚¹ä¸ºç©º</span></span><br><span class="line">    task.prev = <span class="keyword">null</span>;</span><br><span class="line">    task.next = <span class="keyword">null</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>è¯¥æ–¹æ³•çš„è°ƒç”¨ï¼Œåœ¨ <a href="#">ã€Œ7.8 WriteTimeoutTaskã€</a> ä¼šçœ‹åˆ°ã€‚</p>
<h2 id="7-7-writeTimedOut"><a href="#7-7-writeTimedOut" class="headerlink" title="7.7 writeTimedOut"></a>7.7 writeTimedOut</h2><p><code>#writeTimedOut(ChannelHandlerContext ctx)</code> æ–¹æ³•ï¼Œå†™å…¥è¶…æ—¶ï¼Œå…³é—­ Channel é€šé“ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Is called when a write timeout was detected</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">writeTimedOut</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (!closed) {</span><br><span class="line">        <span class="comment">// è§¦å‘ Exception Caught äº‹ä»¶åˆ° pipeline ä¸­ï¼Œå¼‚å¸¸ä¸º WriteTimeoutException</span></span><br><span class="line">        ctx.fireExceptionCaught(WriteTimeoutException.INSTANCE);</span><br><span class="line">        <span class="comment">// å…³é—­ Channel é€šé“</span></span><br><span class="line">        ctx.close();</span><br><span class="line">        <span class="comment">// æ ‡è®° Channel ä¸ºå·²å…³é—­</span></span><br><span class="line">        closed = <span class="keyword">true</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å’Œ <code>ReadTimeoutHandler#readTimeout(ChannelHandlerContext ctx)</code> æ–¹æ³•ï¼ŒåŸºæœ¬ç±»ä¼¼ã€‚</li>
</ul>
<p>è¯¥æ–¹æ³•çš„è°ƒç”¨ï¼Œåœ¨ <a href="#">ã€Œ7.8 WriteTimeoutTaskã€</a> ä¼šçœ‹åˆ°ã€‚</p>
<h2 id="7-8-WriteTimeoutTask"><a href="#7-8-WriteTimeoutTask" class="headerlink" title="7.8 WriteTimeoutTask"></a>7.8 WriteTimeoutTask</h2><p>WriteTimeoutTask ï¼Œå®ç° Runnable å’Œ ChannelFutureListener æ¥å£ï¼Œå†™å…¥è¶…æ—¶ä»»åŠ¡ã€‚</p>
<blockquote>
<p>WriteTimeoutTask æ˜¯ WriteTimeoutHandler çš„å†…éƒ¨ç±»ã€‚</p>
</blockquote>
<h3 id="7-8-1-æ„é€ æ–¹æ³•"><a href="#7-8-1-æ„é€ æ–¹æ³•" class="headerlink" title="7.8.1 æ„é€ æ–¹æ³•"></a>7.8.1 æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelHandlerContext ctx;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å†™å…¥ä»»åŠ¡çš„ Promise å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelPromise promise;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WriteTimeoutTask is also a node of a doubly-linked list</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å‰ä¸€ä¸ª task</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">WriteTimeoutTask prev;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åä¸€ä¸ª task</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">WriteTimeoutTask next;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å®šæ—¶ä»»åŠ¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ScheduledFuture&lt;?&gt; scheduledFuture;</span><br><span class="line"></span><br><span class="line">WriteTimeoutTask(ChannelHandlerContext ctx, ChannelPromise promise) {</span><br><span class="line">    <span class="keyword">this</span>.ctx = ctx;</span><br><span class="line">    <span class="keyword">this</span>.promise = promise;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="7-8-2-run"><a href="#7-8-2-run" class="headerlink" title="7.8.2 run"></a>7.8.2 run</h3><p>å½“å®šæ—¶ä»»åŠ¡æ‰§è¡Œï¼Œè¯´æ˜å†™å…¥ä»»åŠ¡æ‰§è¡Œè¶…æ—¶ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// Was not written yet so issue a write timeout</span></span><br><span class="line">    <span class="comment">// The promise itself will be failed with a ClosedChannelException once the close() was issued</span></span><br><span class="line">    <span class="comment">// See https://github.com/netty/netty/issues/2159</span></span><br><span class="line">    <span class="keyword">if</span> (!promise.isDone()) { <span class="comment">// æœªå®Œæˆï¼Œè¯´æ˜å†™å…¥è¶…æ—¶</span></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// &lt;1&gt; å†™å…¥è¶…æ—¶ï¼Œå…³é—­ Channel é€šé“</span></span><br><span class="line">            writeTimedOut(ctx);</span><br><span class="line">        } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line">            <span class="comment">// è§¦å‘ Exception Caught äº‹ä»¶åˆ° pipeline ä¸­</span></span><br><span class="line">            ctx.fireExceptionCaught(t);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &lt;2&gt; ç§»é™¤å‡ºé“¾è¡¨</span></span><br><span class="line">    removeWriteTimeoutTask(<span class="keyword">this</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#writeTimedOut(ChannelHandlerContext ctx)</code> æ–¹æ³•ï¼Œå†™å…¥è¶…æ—¶ï¼Œå…³é—­ Channel é€šé“ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#removeWriteTimeoutTask(WriteTimeoutTask task)</code> æ–¹æ³•ï¼Œç§»é™¤å‡ºé“¾è¡¨ã€‚</li>
</ul>
<h3 id="7-8-3-operationComplete"><a href="#7-8-3-operationComplete" class="headerlink" title="7.8.3 operationComplete"></a>7.8.3 operationComplete</h3><p>å½“å›è°ƒæ–¹æ³•æ‰§è¡Œï¼Œè¯´æ˜å†™å…¥ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(ChannelFuture future)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">// scheduledFuture has already be set when reaching here</span></span><br><span class="line">    <span class="comment">// &lt;1&gt; å–æ¶ˆå®šæ—¶ä»»åŠ¡</span></span><br><span class="line">    scheduledFuture.cancel(<span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// &lt;2&gt; ç§»é™¤å‡ºé“¾è¡¨</span></span><br><span class="line">    removeWriteTimeoutTask(<span class="keyword">this</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œå–æ¶ˆå®šæ—¶ä»»åŠ¡ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#removeWriteTimeoutTask(WriteTimeoutTask task)</code> æ–¹æ³•ï¼Œç§»é™¤å‡ºé“¾è¡¨ã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å’Œ ã€Œ5.7 hasOutputChangedã€(#) å°èŠ‚ï¼Œè¿™ä¸ªæ–¹æ³•è¾ƒçœŸäº†å¥½ä¹…ã€‚æ„Ÿè°¢ä¸­é—´ï¼ŒåŸºå‹ã€è«é‚£ä¸€é²é“ã€‘çš„æ²Ÿé€šã€‚</p>
<p>æ¨èé˜…è¯»æ–‡ç« ï¼š</p>
<ul>
<li>è«é‚£ä¸€é²é“ <a href="https://www.jianshu.com/p/f2ed73cf4df8" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty å¿ƒè·³æœåŠ¡ä¹‹ IdleStateHandler æºç åˆ†æã€‹</a></li>
<li>Hypercube <a href="https://www.jianshu.com/p/a9bcd89553f5" rel="external nofollow noopener noreferrer" target="_blank">è‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆå…«ï¼‰â€“ChannelHandler</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/ChannelHandler-5-idle/" data-id="ck4pl3fpa00effgcf42gighgh" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>