<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ ByteBufï¼ˆä¸€ï¼‰ç®€ä»‹
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>ä»æœ¬æ–‡å¼€å§‹ï¼Œæˆ‘ä»¬æ¥åˆ†äº« Netty ByteBuf ç›¸å…³çš„å†…å®¹ã€‚å®ƒåœ¨ <code>buffer</code> æ¨¡å—ä¸­å®ç°ï¼Œåœ¨åŠŸèƒ½å®šä½ä¸Šï¼Œå®ƒå’Œ NIO ByteBuffer æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯å¼ºå¤§éå¸¸å¤šã€‚å¦‚ä¸‹æ˜¯ <a href="#">ã€ŠNetty å®æˆ˜ã€‹</a> å¯¹å®ƒçš„<strong>ä¼˜ç‚¹æ€»</strong>ç»“ï¼š</p>
<blockquote>
<ul>
<li>A01. å®ƒå¯ä»¥è¢«ç”¨æˆ·è‡ªå®šä¹‰çš„<strong>ç¼“å†²åŒºç±»å‹</strong>æ‰©å±•</li>
<li>A02. é€šè¿‡å†…ç½®çš„ç¬¦åˆç¼“å†²åŒºç±»å‹å®ç°äº†é€æ˜çš„<strong>é›¶æ‹·è´</strong></li>
<li>A03. å®¹é‡å¯ä»¥<strong>æŒ‰éœ€å¢é•¿</strong></li>
<li>A04. åœ¨è¯»å’Œå†™è¿™ä¸¤ç§æ¨¡å¼ä¹‹é—´åˆ‡æ¢ä¸éœ€è¦è°ƒç”¨ <code>#flip()</code> æ–¹æ³•</li>
<li>A05. è¯»å’Œå†™ä½¿ç”¨äº†<strong>ä¸åŒçš„ç´¢å¼•</strong></li>
<li>A06. æ”¯æŒæ–¹æ³•çš„<strong>é“¾å¼</strong>è°ƒç”¨</li>
<li>A07. æ”¯æŒå¼•ç”¨è®¡æ•°</li>
<li>A08. æ”¯æŒ<strong>æ± åŒ–</strong></li>
</ul>
</blockquote>
<ul>
<li>ç‰¹åˆ«æ˜¯ç¬¬ A04 è¿™ç‚¹ï¼Œç›¸ä¿¡å¾ˆå¤šèƒ–å‹éƒ½è¢« NIO ByteBuffer åäººç±»çš„è¯»æ¨¡å¼å’Œå†™æ¨¡å¼ç»™å‘å“­äº†ã€‚åœ¨ <a href="http://svip.iocoder.cn/Netty/nio-3-buffer/">ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” NIO åŸºç¡€ï¼ˆä¸‰ï¼‰ä¹‹ Bufferã€‹</a> ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿåæ§½è¿‡äº†ã€‚ğŸ˜ˆ</li>
<li>å½“ç„¶ï¼Œå¯èƒ½èƒ–å‹çœ‹ç€è¿™äº›ä¼˜ç‚¹ï¼Œä¼šä¸€è„¸æ‡µé€¼ï¼Œä¸è¦ç´§ï¼Œè¾¹è¯»æºç è¾¹ç†è§£è½ã€‚</li>
</ul>
<hr>
<blockquote>
<p>è€è‰¿è‰¿ï¼Œä»ä¸‹æ–‡å¼€å§‹ï¼ŒNetty ByteBuf ï¼Œæˆ‘ä»¬åªæ‰“ ByteBuf ã€‚ç›¸æ¯” NIO ByteBuffer ï¼Œå®ƒå°‘ <code>"fer"</code> ä¸‰ä¸ªå­—æ¯ã€‚</p>
</blockquote>
<p>ByteBuf çš„ä»£ç å®ç°æŒºæœ‰è¶£çš„ï¼Œä½†æ˜¯ä¼šç•¥æœ‰ä¸€ç‚¹ç‚¹æ·±åº¦ï¼Œæ‰€ä»¥ç¬”è€…ä¼šåˆ†æˆä¸‰å¤§å—æ¥åˆ†äº«ï¼š</p>
<ul>
<li>ByteBuf ç›¸å…³ï¼Œä¸»è¦æ˜¯å®ƒçš„æ ¸å¿ƒ API å’Œæ ¸å¿ƒå­ç±»å®ç°ã€‚</li>
<li>ByteBufAllocator ç›¸å…³ï¼Œç”¨äºåˆ›å»º ByteBuf å¯¹è±¡ã€‚</li>
<li>Jemalloc ç›¸å…³ï¼Œå†…å­˜ç®¡ç†ç®—æ³•ï¼ŒNetty åŸºäºè¯¥ç®—æ³•ï¼Œå®ç°å¯¹å†…å­˜é«˜æ•ˆå’Œæœ‰æ•ˆçš„ç®¡ç†ã€‚ğŸ˜ˆ è¿™å—æ˜¯æœ€æœ€æœ€æœ‰è¶£çš„ã€‚</li>
</ul>
<p>æ¯ä¸€å—ï¼Œæˆ‘ä»¬ä¼šåˆ†æˆå‡ ç¯‡å°çš„æ–‡ç« ã€‚è€Œæœ¬æ–‡ï¼Œæˆ‘ä»¬å°±æ¥å¯¹ ByteBuf æœ‰ä¸ªæ•´ä½“çš„è®¤è¯†ï¼Œç‰¹åˆ«æ˜¯æ ¸å¿ƒ API éƒ¨åˆ†ã€‚</p>
<h1 id="2-ByteBuf"><a href="#2-ByteBuf" class="headerlink" title="2. ByteBuf"></a>2. ByteBuf</h1><p><code>io.netty.buffer.ByteBuf</code> ï¼Œå®ç° ReferenceCounted ã€Comparable æ¥å£ï¼ŒByteBuf <strong>æŠ½è±¡ç±»</strong>ã€‚æ³¨æ„ï¼ŒByteBuf æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªæ¥å£ã€‚å½“ç„¶ï¼Œå®é™…ä¸Šï¼Œå®ƒä¸»è¦å®šä¹‰äº†<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œ<strong>å¾ˆå°‘</strong>å®ç°å¯¹åº”çš„æ–¹æ³•ã€‚</p>
<p>å…³äº <code>io.netty.util.ReferenceCounted</code> æ¥å£ï¼Œå¯¹è±¡å¼•ç”¨è®¡æ•°å™¨æ¥å£ã€‚</p>
<ul>
<li>å¯¹è±¡çš„åˆå§‹å¼•ç”¨è®¡æ•°ä¸º 1 ã€‚</li>
<li>å½“å¼•ç”¨è®¡æ•°å™¨å€¼ä¸º 0 æ—¶ï¼Œè¡¨ç¤ºè¯¥å¯¹è±¡ä¸èƒ½å†è¢«ç»§ç»­å¼•ç”¨ï¼Œåªèƒ½è¢«é‡Šæ”¾ã€‚</li>
<li>æœ¬æ–‡æš‚æ—¶ä¸è§£æï¼Œæˆ‘ä»¬ä¼šåœ¨ TODO 1011</li>
</ul>
<h2 id="2-1-æŠ½è±¡æ–¹æ³•"><a href="#2-1-æŠ½è±¡æ–¹æ³•" class="headerlink" title="2.1 æŠ½è±¡æ–¹æ³•"></a>2.1 æŠ½è±¡æ–¹æ³•</h2><p> å› ä¸º ByteBuf çš„æ–¹æ³•éå¸¸å¤šï¼Œæ‰€ä»¥ç¬”è€…å¯¹å®ƒçš„æ–¹æ³•åšäº†ç®€å•çš„å½’ç±»ã€‚Letâ€™s Go ã€‚</p>
<h3 id="2-1-1-åŸºç¡€ä¿¡æ¯"><a href="#2-1-1-åŸºç¡€ä¿¡æ¯" class="headerlink" title="2.1.1 åŸºç¡€ä¿¡æ¯"></a>2.1.1 åŸºç¡€ä¿¡æ¯</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">capacity</span><span class="params">()</span></span>; <span class="comment">// å®¹é‡</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">capacity</span><span class="params">(<span class="keyword">int</span> newCapacity)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">maxCapacity</span><span class="params">()</span></span>; <span class="comment">// æœ€å¤§å®¹é‡</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBufAllocator <span class="title">alloc</span><span class="params">()</span></span>; <span class="comment">// åˆ†é…å™¨ï¼Œç”¨äºåˆ›å»º ByteBuf å¯¹è±¡ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteOrder <span class="title">order</span><span class="params">()</span></span>; <span class="comment">// å­—èŠ‚åºï¼Œå³å¤§å°ç«¯ã€‚æ¨èé˜…è¯» http://www.ruanyifeng.com/blog/2016/11/byte-order.html</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">order</span><span class="params">(ByteOrder endianness)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">unwrap</span><span class="params">()</span></span>; <span class="comment">// è·å¾—è¢«åŒ…è£…( wrap )çš„ ByteBuf å¯¹è±¡ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isDirect</span><span class="params">()</span></span>; <span class="comment">// æ˜¯å¦ NIO Direct Buffer</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isReadOnly</span><span class="params">()</span></span>; <span class="comment">// æ˜¯å¦ä¸ºåªè¯» Buffer</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">asReadOnly</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">readerIndex</span><span class="params">()</span></span>; <span class="comment">// è¯»å–ä½ç½®</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">readerIndex</span><span class="params">(<span class="keyword">int</span> readerIndex)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">writerIndex</span><span class="params">()</span></span>; <span class="comment">// å†™å…¥ä½ç½®</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writerIndex</span><span class="params">(<span class="keyword">int</span> writerIndex)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setIndex</span><span class="params">(<span class="keyword">int</span> readerIndex, <span class="keyword">int</span> writerIndex)</span></span>; <span class="comment">// è®¾ç½®è¯»å–å’Œå†™å…¥ä½ç½®</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">readableBytes</span><span class="params">()</span></span>; <span class="comment">// å‰©ä½™å¯è¯»å­—èŠ‚æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">writableBytes</span><span class="params">()</span></span>; <span class="comment">// å‰©ä½™å¯å†™å­—èŠ‚æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">maxWritableBytes</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isReadable</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isReadable</span><span class="params">(<span class="keyword">int</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isWritable</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isWritable</span><span class="params">(<span class="keyword">int</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">ensureWritable</span><span class="params">(<span class="keyword">int</span> minWritableBytes)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">ensureWritable</span><span class="params">(<span class="keyword">int</span> minWritableBytes, <span class="keyword">boolean</span> force)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">markReaderIndex</span><span class="params">()</span></span>; <span class="comment">// æ ‡è®°è¯»å–ä½ç½®</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">resetReaderIndex</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">markWriterIndex</span><span class="params">()</span></span>; <span class="comment">// æ ‡è®°å†™å…¥ä½ç½®</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">resetWriterIndex</span><span class="params">()</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<p>ä¸»è¦æ˜¯å¦‚ä¸‹å››ä¸ªå±æ€§ï¼š</p>
<ul>
<li><code>readerIndex</code> ï¼Œè¯»ç´¢å¼•ã€‚</li>
<li><code>writerIndex</code> ï¼Œå†™ç´¢å¼•ã€‚</li>
<li><code>capacity</code> ï¼Œå½“å‰å®¹é‡ã€‚</li>
<li><code>maxCapacity</code> ï¼Œæœ€å¤§å®¹é‡ã€‚å½“ <code>writerIndex</code> å†™å…¥è¶…è¿‡ <code>capacity</code> æ—¶ï¼Œå¯è‡ªåŠ¨æ‰©å®¹ã€‚<strong>æ¯æ¬¡</strong>æ‰©å®¹çš„å¤§å°ï¼Œä¸º <code>capacity</code> çš„ 2 å€ã€‚å½“ç„¶ï¼Œå‰ææ˜¯ä¸èƒ½è¶…è¿‡ <code>maxCapacity</code> å¤§å°ã€‚</li>
</ul>
<p>æ‰€ä»¥ï¼ŒByteBuf é€šè¿‡ <code>readerIndex</code> å’Œ <code>writerIndex</code> ä¸¤ä¸ªç´¢å¼•ï¼Œè§£å†³ ByteBuffer çš„è¯»å†™æ¨¡å¼çš„é—®é¢˜ã€‚</p>
<p>å››ä¸ªå¤§å°å…³ç³»å¾ˆç®€å•ï¼š<code>readerIndex</code> &lt;= <code>writerIndex</code> &lt;= <code>capacity</code> &lt;= <code>maxCapacity</code> ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_08_01/01.png" title="åˆ†æ®µ" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_08_01/01.png" alt="åˆ†æ®µ"></a><span class="caption">åˆ†æ®µ</span></p>
<ul>
<li>å›¾ä¸­ä¸€å…±æœ‰ä¸‰æ®µï¼Œå®é™…æ˜¯å››æ®µï¼Œçœç•¥äº† <code>capacity</code> åˆ° <code>maxCapacity</code> ä¹‹é—´çš„ä¸€æ®µã€‚</li>
<li>discardable bytes ï¼ŒåºŸå¼ƒæ®µã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯ä»¥ç†è§£æˆå·²è¯»çš„éƒ¨åˆ†ã€‚</li>
<li>readable bytes ï¼Œå¯è¯»æ®µã€‚å¯é€šè¿‡ <code>#readXXX()</code> æ–¹æ³•ï¼Œé¡ºåºå‘ä¸‹è¯»å–ã€‚</li>
<li>writable bytes ï¼Œå¯å†™æ®µã€‚å¯é€šè¿‡ <code>#writeXXX()</code> æ–¹æ³•ï¼Œé¡ºåºå‘ä¸‹å†™å…¥ã€‚</li>
</ul>
<p>å¦å¤–ï¼ŒByteBuf è¿˜æœ‰ <code>markReaderIndex</code> å’Œ <code>markWriterIndex</code> ä¸¤ä¸ªå±æ€§ï¼š</p>
<ul>
<li>é€šè¿‡å¯¹åº”çš„ <code>#markReaderIndex()</code> å’Œ <code>#markWriterIndex()</code> æ–¹æ³•ï¼Œåˆ†åˆ«æ ‡è®°è¯»å–å’Œå†™å…¥ä½ç½®ã€‚</li>
<li>é€šè¿‡å¯¹åº”çš„ <code>#resetReaderIndex()</code> å’Œ <code>#resetWriterIndex()</code> æ–¹æ³•ï¼Œåˆ†åˆ«è¯»å–å’Œå†™å…¥ä½ç½®åˆ°æ ‡è®°å¤„ã€‚</li>
</ul>
<h3 id="3-1-2-è¯»å–-å†™å…¥æ“ä½œ"><a href="#3-1-2-è¯»å–-å†™å…¥æ“ä½œ" class="headerlink" title="3.1.2 è¯»å– / å†™å…¥æ“ä½œ"></a>3.1.2 è¯»å– / å†™å…¥æ“ä½œ</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Boolean 1 å­—èŠ‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">getBoolean</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setBoolean</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">boolean</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">readBoolean</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeBoolean</span><span class="params">(<span class="keyword">boolean</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Byte 1 å­—èŠ‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">byte</span>  <span class="title">getByte</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">short</span> <span class="title">getUnsignedByte</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setByte</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">byte</span>  <span class="title">readByte</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">short</span> <span class="title">readUnsignedByte</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeByte</span><span class="params">(<span class="keyword">int</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Short 2 å­—èŠ‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">short</span> <span class="title">getShort</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">short</span> <span class="title">getShortLE</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getUnsignedShort</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getUnsignedShortLE</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setShort</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setShortLE</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">short</span> <span class="title">readShort</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">short</span> <span class="title">readShortLE</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span>   <span class="title">readUnsignedShort</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span>   <span class="title">readUnsignedShortLE</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeShort</span><span class="params">(<span class="keyword">int</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeShortLE</span><span class="params">(<span class="keyword">int</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ã€ç‰¹æ®Šã€‘Medium 3 å­—èŠ‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span>   <span class="title">getMedium</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getMediumLE</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span>   <span class="title">getUnsignedMedium</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span>   <span class="title">getUnsignedMediumLE</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setMedium</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setMediumLE</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span>   <span class="title">readMedium</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span>   <span class="title">readMediumLE</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span>   <span class="title">readUnsignedMedium</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span>   <span class="title">readUnsignedMediumLE</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeMedium</span><span class="params">(<span class="keyword">int</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeMediumLE</span><span class="params">(<span class="keyword">int</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Int 4 å­—èŠ‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span>   <span class="title">getInt</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span>   <span class="title">getIntLE</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span>  <span class="title">getUnsignedInt</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span>  <span class="title">getUnsignedIntLE</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setInt</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setIntLE</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span>   <span class="title">readInt</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span>   <span class="title">readIntLE</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span>  <span class="title">readUnsignedInt</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span>  <span class="title">readUnsignedIntLE</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeInt</span><span class="params">(<span class="keyword">int</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeIntLE</span><span class="params">(<span class="keyword">int</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Long 8 å­—èŠ‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span>  <span class="title">getLong</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span>  <span class="title">getLongLE</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setLong</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">long</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setLongLE</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">long</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span>  <span class="title">readLong</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span>  <span class="title">readLongLE</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeLong</span><span class="params">(<span class="keyword">long</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeLongLE</span><span class="params">(<span class="keyword">long</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Char 2 å­—èŠ‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">char</span>  <span class="title">getChar</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setChar</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">char</span>  <span class="title">readChar</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeChar</span><span class="params">(<span class="keyword">int</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Float 4 å­—èŠ‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">float</span> <span class="title">getFloat</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getFloatLE</span><span class="params">(<span class="keyword">int</span> index)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> Float.intBitsToFloat(getIntLE(index));</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setFloat</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">float</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">setFloatLE</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">float</span> value)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> setIntLE(index, Float.floatToRawIntBits(value));</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">float</span> <span class="title">readFloat</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">readFloatLE</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> Float.intBitsToFloat(readIntLE());</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeFloat</span><span class="params">(<span class="keyword">float</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">writeFloatLE</span><span class="params">(<span class="keyword">float</span> value)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> writeIntLE(Float.floatToRawIntBits(value));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Double 8 å­—èŠ‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">double</span> <span class="title">getDouble</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getDoubleLE</span><span class="params">(<span class="keyword">int</span> index)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> Double.longBitsToDouble(getLongLE(index));</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setDouble</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">double</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">setDoubleLE</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">double</span> value)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> setLongLE(index, Double.doubleToRawLongBits(value));</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">double</span> <span class="title">readDouble</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">readDoubleLE</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> Double.longBitsToDouble(readLongLE());</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeDouble</span><span class="params">(<span class="keyword">double</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">writeDoubleLE</span><span class="params">(<span class="keyword">double</span> value)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> writeLongLE(Double.doubleToRawLongBits(value));</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// Byte æ•°ç»„</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">getBytes</span><span class="params">(<span class="keyword">int</span> index, ByteBuf dst)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">getBytes</span><span class="params">(<span class="keyword">int</span> index, ByteBuf dst, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">getBytes</span><span class="params">(<span class="keyword">int</span> index, ByteBuf dst, <span class="keyword">int</span> dstIndex, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">getBytes</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">byte</span>[] dst)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">getBytes</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">byte</span>[] dst, <span class="keyword">int</span> dstIndex, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">getBytes</span><span class="params">(<span class="keyword">int</span> index, ByteBuffer dst)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">getBytes</span><span class="params">(<span class="keyword">int</span> index, OutputStream out, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getBytes</span><span class="params">(<span class="keyword">int</span> index, GatheringByteChannel out, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">getBytes</span><span class="params">(<span class="keyword">int</span> index, FileChannel out, <span class="keyword">long</span> position, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setBytes</span><span class="params">(<span class="keyword">int</span> index, ByteBuf src)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setBytes</span><span class="params">(<span class="keyword">int</span> index, ByteBuf src, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setBytes</span><span class="params">(<span class="keyword">int</span> index, ByteBuf src, <span class="keyword">int</span> srcIndex, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setBytes</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">byte</span>[] src)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setBytes</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">byte</span>[] src, <span class="keyword">int</span> srcIndex, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setBytes</span><span class="params">(<span class="keyword">int</span> index, ByteBuffer src)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">setBytes</span><span class="params">(<span class="keyword">int</span> index, InputStream in, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">setBytes</span><span class="params">(<span class="keyword">int</span> index, ScatteringByteChannel in, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">setBytes</span><span class="params">(<span class="keyword">int</span> index, FileChannel in, <span class="keyword">long</span> position, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">setZero</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">readBytes</span><span class="params">(<span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">readSlice</span><span class="params">(<span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">readRetainedSlice</span><span class="params">(<span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">readBytes</span><span class="params">(ByteBuf dst)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">readBytes</span><span class="params">(ByteBuf dst, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">readBytes</span><span class="params">(ByteBuf dst, <span class="keyword">int</span> dstIndex, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">readBytes</span><span class="params">(<span class="keyword">byte</span>[] dst)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">readBytes</span><span class="params">(<span class="keyword">byte</span>[] dst, <span class="keyword">int</span> dstIndex, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">readBytes</span><span class="params">(ByteBuffer dst)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">readBytes</span><span class="params">(OutputStream out, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">readBytes</span><span class="params">(GatheringByteChannel out, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">readBytes</span><span class="params">(FileChannel out, <span class="keyword">long</span> position, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">skipBytes</span><span class="params">(<span class="keyword">int</span> length)</span></span>; <span class="comment">// å¿½ç•¥æŒ‡å®šé•¿åº¦çš„å­—èŠ‚æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeBytes</span><span class="params">(ByteBuf src)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeBytes</span><span class="params">(ByteBuf src, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeBytes</span><span class="params">(ByteBuf src, <span class="keyword">int</span> srcIndex, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeBytes</span><span class="params">(<span class="keyword">byte</span>[] src)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeBytes</span><span class="params">(<span class="keyword">byte</span>[] src, <span class="keyword">int</span> srcIndex, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeBytes</span><span class="params">(ByteBuffer src)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span>  <span class="title">writeBytes</span><span class="params">(InputStream in, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">writeBytes</span><span class="params">(ScatteringByteChannel in, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">writeBytes</span><span class="params">(FileChannel in, <span class="keyword">long</span> position, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">writeZero</span><span class="params">(<span class="keyword">int</span> length)</span></span>; <span class="comment">// å¡«å……æŒ‡å®šé•¿åº¦çš„ 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// String</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> CharSequence <span class="title">getCharSequence</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length, Charset charset)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">setCharSequence</span><span class="params">(<span class="keyword">int</span> index, CharSequence sequence, Charset charset)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> CharSequence <span class="title">readCharSequence</span><span class="params">(<span class="keyword">int</span> length, Charset charset)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">writeCharSequence</span><span class="params">(CharSequence sequence, Charset charset)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<p>è™½ç„¶æ–¹æ³•æ¯”è¾ƒå¤šï¼Œæ€»ç»“ä¸‹æ¥æ˜¯ä¸åŒæ•°æ®ç±»å‹çš„<strong>å››ç§</strong>è¯»å†™æ–¹æ³•ï¼š</p>
<ul>
<li><code>#getXXX(index)</code> æ–¹æ³•ï¼Œè¯»å–<strong>æŒ‡å®š</strong>ä½ç½®çš„æ•°æ®ï¼Œä¸æ”¹å˜ <code>readerIndex</code> ç´¢å¼•ã€‚</li>
<li><code>#readXXX()</code> æ–¹æ³•ï¼Œè¯»å– <code>readerIndex</code> ä½ç½®çš„æ•°æ®ï¼Œä¼šæ”¹æˆ <code>readerIndex</code> ç´¢å¼•ã€‚</li>
<li><code>#setXXX(index, value)</code> æ–¹æ³•ï¼Œå†™å…¥æ•°æ®åˆ°<strong>æŒ‡å®š</strong>ä½ç½®ï¼Œä¸æ”¹å˜ <code>writeIndex</code> ç´¢å¼•ã€‚</li>
<li><code>#writeXXX(value)</code> æ–¹æ³•ï¼Œå†™å…¥æ•°æ®åˆ°<strong>æŒ‡å®š</strong>ä½ç½®ï¼Œä¼šæ”¹å˜ <code>writeIndex</code> ç´¢å¼•ã€‚</li>
</ul>
<h3 id="2-1-3-æŸ¥æ‰¾-éå†æ“ä½œ"><a href="#2-1-3-æŸ¥æ‰¾-éå†æ“ä½œ" class="headerlink" title="2.1.3 æŸ¥æ‰¾ / éå†æ“ä½œ"></a>2.1.3 æŸ¥æ‰¾ / éå†æ“ä½œ</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">indexOf</span><span class="params">(<span class="keyword">int</span> fromIndex, <span class="keyword">int</span> toIndex, <span class="keyword">byte</span> value)</span></span>; <span class="comment">// æŒ‡å®šå€¼( value ) åœ¨ ByteBuf ä¸­çš„ä½ç½®</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">bytesBefore</span><span class="params">(<span class="keyword">byte</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">bytesBefore</span><span class="params">(<span class="keyword">int</span> length, <span class="keyword">byte</span> value)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">bytesBefore</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length, <span class="keyword">byte</span> value)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">forEachByte</span><span class="params">(ByteProcessor processor)</span></span>; <span class="comment">// éå† ByteBuf ï¼Œè¿›è¡Œè‡ªå®šä¹‰å¤„ç†</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">forEachByte</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length, ByteProcessor processor)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">forEachByteDesc</span><span class="params">(ByteProcessor processor)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">forEachByteDesc</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length, ByteProcessor processor)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="3-1-4-é‡Šæ”¾æ“ä½œ"><a href="#3-1-4-é‡Šæ”¾æ“ä½œ" class="headerlink" title="3.1.4 é‡Šæ”¾æ“ä½œ"></a>3.1.4 é‡Šæ”¾æ“ä½œ</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">discardReadBytes</span><span class="params">()</span></span>; <span class="comment">// é‡Šæ”¾å·²è¯»çš„å­—èŠ‚ç©ºé—´</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">discardSomeReadBytes</span><span class="params">()</span></span>; <span class="comment">// é‡Šæ”¾éƒ¨åˆ†å·²è¯»çš„å­—èŠ‚ç©ºé—´</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">clear</span><span class="params">()</span></span>; <span class="comment">// æ¸…ç©ºå­—èŠ‚ç©ºé—´ã€‚å®é™…æ˜¯ä¿®æ”¹ readerIndex=writerIndex=0ï¼Œæ ‡è®°æ¸…ç©ºã€‚</span></span><br></pre></td></tr></tbody></table></figure>
<p><strong>discardReadBytes</strong></p>
<p><code>#discardReadBytes()</code> æ–¹æ³•ï¼Œé‡Šæ”¾ã€æ‰€æœ‰çš„ã€‘<strong>åºŸå¼ƒæ®µ</strong>çš„ç©ºé—´å†…å­˜ã€‚</p>
<ul>
<li>ä¼˜ç‚¹ï¼šè¾¾åˆ°é‡ç”¨åºŸå¼ƒæ®µçš„ç©ºé—´å†…å­˜ã€‚</li>
<li>ç¼ºç‚¹ï¼šé‡Šæ”¾çš„æ–¹å¼ï¼Œæ˜¯é€šè¿‡å¤åˆ¶<strong>å¯è¯»æ®µ</strong>åˆ° ByteBuf çš„å¤´éƒ¨ã€‚æ‰€ä»¥ï¼Œé¢‘ç¹é‡Šæ”¾ä¼šå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</li>
<li>æ€»ç»“ï¼šè¿™æ˜¯å…¸å‹çš„é—®é¢˜ï¼šé€‰æ‹©ç©ºé—´è¿˜æ˜¯æ—¶é—´ã€‚å…·ä½“çš„é€‰æ‹©ï¼Œéœ€è¦çœ‹å¯¹åº”çš„åœºæ™¯ã€‚ğŸ˜ˆ åç»­çš„æ–‡ç« ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°å¯¹è¯¥æ–¹æ³•çš„è°ƒç”¨ã€‚</li>
</ul>
<p>æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_08_01/02.png" title="discardReadBytes" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_08_01/02.png" alt="discardReadBytes"></a><span class="caption">discardReadBytes</span></p>
<p><strong>discardSomeReadBytes</strong></p>
<p><code>#discardSomeReadBytes()</code> æ–¹æ³•ï¼Œé‡Šæ”¾ã€éƒ¨åˆ†çš„ã€‘<strong>åºŸå¼ƒæ®µ</strong>çš„ç©ºé—´å†…å­˜ã€‚</p>
<p>è¿™æ˜¯å¯¹ <code>#discardSomeReadBytes()</code> æ–¹æ³•çš„è¿™ç§æ–¹æ¡ˆï¼Œå…·ä½“çš„å®ç°ï¼Œè§ <a href="#">ã€Œ4. AbstractByteBufã€</a> ä¸­ã€‚</p>
<p><strong>clear</strong></p>
<p><code>#clear()</code> æ–¹æ³•ï¼Œæ¸…ç©ºå­—èŠ‚ç©ºé—´ã€‚å®é™…æ˜¯ä¿®æ”¹ <code>readerIndex = writerIndex = 0</code> ï¼Œæ ‡è®°æ¸…ç©ºã€‚</p>
<ul>
<li>ä¼˜ç‚¹ï¼šé€šè¿‡æ ‡è®°æ¥å®ç°æ¸…ç©ºï¼Œé¿å…ç½®ç©º ByteBuf ï¼Œæå‡æ€§èƒ½ã€‚</li>
<li>ç¼ºç‚¹ï¼šæ•°æ®å®é™…è¿˜å­˜åœ¨ï¼Œå¦‚æœé”™è¯¯ä¿®æ”¹ <code>writerIndex</code> æ—¶ï¼Œä¼šå¯¼è‡´è¯»åˆ°â€œè„â€æ•°æ®ã€‚</li>
</ul>
<p>æ•´ä¸ªè¿‡ç¨‹å¦‚ä¸‹å›¾ï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_08_01/03.png" title="discardReadBytes" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_08_01/03.png" alt="discardReadBytes"></a><span class="caption">discardReadBytes</span></p>
<h3 id="3-1-5-æ‹·è´æ“ä½œ"><a href="#3-1-5-æ‹·è´æ“ä½œ" class="headerlink" title="3.1.5 æ‹·è´æ“ä½œ"></a>3.1.5 æ‹·è´æ“ä½œ</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">copy</span><span class="params">()</span></span>; <span class="comment">// æ‹·è´å¯è¯»éƒ¨åˆ†çš„å­—èŠ‚æ•°ç»„ã€‚ç‹¬ç«‹ï¼Œäº’ç›¸ä¸å½±å“ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">copy</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">slice</span><span class="params">()</span></span>; <span class="comment">// æ‹·è´å¯è¯»éƒ¨åˆ†çš„å­—èŠ‚æ•°ç»„ã€‚å…±äº«ï¼Œç›¸äº’å½±å“ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">slice</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">retainedSlice</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">duplicate</span><span class="params">()</span></span>; <span class="comment">// æ‹·è´æ•´ä¸ªçš„å­—èŠ‚æ•°ç»„ã€‚å…±äº«ï¼Œç›¸äº’å½±å“ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">retainedDuplicate</span><span class="params">()</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="3-1-6-è½¬æ¢-NIO-ByteBuffer-æ“ä½œ"><a href="#3-1-6-è½¬æ¢-NIO-ByteBuffer-æ“ä½œ" class="headerlink" title="3.1.6 è½¬æ¢ NIO ByteBuffer æ“ä½œ"></a>3.1.6 è½¬æ¢ NIO ByteBuffer æ“ä½œ</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ByteBuf åŒ…å« ByteBuffer æ•°é‡ã€‚</span></span><br><span class="line"><span class="comment">// å¦‚æœè¿”å› = 1 ï¼Œåˆ™è°ƒç”¨ `#nioBuffer()` æ–¹æ³•ï¼Œè·å¾— ByteBuf åŒ…å«çš„ ByteBuffer å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="comment">// å¦‚æœè¿”å› &gt; 1 ï¼Œåˆ™è°ƒç”¨ `#nioBuffers()` æ–¹æ³•ï¼Œè·å¾— ByteBuf åŒ…å«çš„ ByteBuffer æ•°ç»„ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">nioBufferCount</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">nioBuffer</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">nioBuffer</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer <span class="title">internalNioBuffer</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer[] nioBuffers();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuffer[] nioBuffers(<span class="keyword">int</span> index, <span class="keyword">int</span> length);</span><br></pre></td></tr></tbody></table></figure>
<h3 id="3-1-7-Heap-ç›¸å…³æ–¹æ³•"><a href="#3-1-7-Heap-ç›¸å…³æ–¹æ³•" class="headerlink" title="3.1.7 Heap ç›¸å…³æ–¹æ³•"></a>3.1.7 Heap ç›¸å…³æ–¹æ³•</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// é€‚ç”¨äº Heap ç±»å‹çš„ ByteBuf å¯¹è±¡çš„ byte[] å­—èŠ‚æ•°ç»„</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">hasArray</span><span class="params">()</span></span>; <span class="comment">// æ˜¯å¦æœ‰ byte[] å­—èŠ‚æ•°ç»„</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">byte</span>[] array();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">arrayOffset</span><span class="params">()</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/ByteBuf-1-2-ByteBuf-core-impl">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ ByteBufï¼ˆäºŒï¼‰æ ¸å¿ƒå­ç±»ã€‹</a></li>
</ul>
<h3 id="3-1-8-Unsafe-ç›¸å…³æ–¹æ³•"><a href="#3-1-8-Unsafe-ç›¸å…³æ–¹æ³•" class="headerlink" title="3.1.8 Unsafe ç›¸å…³æ–¹æ³•"></a>3.1.8 Unsafe ç›¸å…³æ–¹æ³•</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// é€‚ç”¨äº Unsafe ç±»å‹çš„ ByteBuf å¯¹è±¡</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">hasMemoryAddress</span><span class="params">()</span></span>; <span class="comment">// æ˜¯å¦æœ‰å†…å­˜åœ°å€</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">memoryAddress</span><span class="params">()</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/ByteBuf-1-2-ByteBuf-core-impl">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ ByteBufï¼ˆäºŒï¼‰æ ¸å¿ƒå­ç±»ã€‹</a></li>
</ul>
<h3 id="3-1-9-Object-ç›¸å…³"><a href="#3-1-9-Object-ç›¸å…³" class="headerlink" title="3.1.9 Object ç›¸å…³"></a>3.1.9 Object ç›¸å…³</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">toString</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">toString</span><span class="params">(Charset charset)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> String <span class="title">toString</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length, Charset charset)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(ByteBuf buffer)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="3-1-10-å¼•ç”¨è®¡æ•°ç›¸å…³"><a href="#3-1-10-å¼•ç”¨è®¡æ•°ç›¸å…³" class="headerlink" title="3.1.10 å¼•ç”¨è®¡æ•°ç›¸å…³"></a>3.1.10 å¼•ç”¨è®¡æ•°ç›¸å…³</h3><p>æœ¬æ–‡æš‚æ—¶ä¸è§£æï¼Œæˆ‘ä»¬ä¼šåœ¨ TODO 1011 ã€‚</p>
<p>æ¥è‡ª ReferenceCounted</p>
<p><a href="https://skyao.gitbooks.io/learning-netty/content/buffer/interface_ReferenceCounted.html" rel="external nofollow noopener noreferrer" target="_blank">https://skyao.gitbooks.io/learning-netty/content/buffer/interface_ReferenceCounted.html</a> å¯å‚è€ƒ</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">retain</span><span class="params">(<span class="keyword">int</span> increment)</span></span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">retain</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">touch</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">touch</span><span class="params">(Object hint)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-2-å­ç±»ç±»å›¾"><a href="#3-2-å­ç±»ç±»å›¾" class="headerlink" title="3.2 å­ç±»ç±»å›¾"></a>3.2 å­ç±»ç±»å›¾</h2><p>ByteBuf çš„å­ç±»ç°å¸¸ç°å¸¸ç°å¸¸å¤šï¼Œèƒ–å‹ç‚¹å‡» <a href="http://static2.iocoder.cn/images/Netty/2018_08_01/04.png" rel="external nofollow noopener noreferrer" target="_blank">ä¼ é€é—¨</a> å¯ä»¥è¿›è¡ŒæŸ¥çœ‹ã€‚</p>
<p>æœ¬æ–‡ä»…åˆ†äº« ByteBuf çš„<strong>äº”ä¸ª</strong>ç›´æ¥å­ç±»å®ç°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_08_01/05.png" title="ä¼ é€é—¨" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_08_01/05.png" alt="ä¼ é€é—¨"></a><span class="caption">ä¼ é€é—¨</span></p>
<ul>
<li>ã€é‡ç‚¹ã€‘AbstractByteBuf ï¼ŒByteBuf æŠ½è±¡å®ç°ç±»ï¼Œæä¾› ByteBuf çš„é»˜è®¤å®ç°ç±»ã€‚å¯ä»¥è¯´ï¼Œæ˜¯ ByteBuf æœ€æœ€æœ€é‡è¦çš„å­ç±»ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ4. AbstractByteBufã€</a> ã€‚</li>
<li>EmptyByteBuf ï¼Œç”¨äºæ„å»ºç©º ByteBuf å¯¹è±¡ï¼Œ<code>capacity</code> å’Œ <code>maxCapacity</code> å‡ä¸º 0 ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ5. EmptyByteBufã€</a> ã€‚</li>
<li>WrappedByteBuf ï¼Œç”¨äºè£…é¥° ByteBuf å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ6. WrappedByteBufã€</a> ã€‚</li>
<li>SwappedByteBuf ï¼Œç”¨äºæ„å»ºå…·æœ‰åˆ‡æ¢<strong>å­—èŠ‚åº</strong>åŠŸèƒ½çš„ ByteBuf å¯¹è±¡ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ7. SwappedByteBufã€</a> ã€‚</li>
<li>ReplayingDecoderByteBuf ï¼Œç”¨äºæ„å»ºåœ¨ IO é˜»å¡æ¡ä»¶ä¸‹å®ç°æ— é˜»å¡è§£ç çš„ç‰¹æ®Š ByteBuf å¯¹è±¡ï¼Œå½“è¦è¯»å–çš„æ•°æ®è¿˜æœªæ¥æ”¶å®Œå…¨æ—¶ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œäº¤ç”± ReplayingDecoderå¤„ç†ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ8. ReplayingDecoderByteBufã€</a> ã€‚</li>
</ul>
<h1 id="4-AbstractByteBuf"><a href="#4-AbstractByteBuf" class="headerlink" title="4. AbstractByteBuf"></a>4. AbstractByteBuf</h1><p><code>io.netty.buffer.AbstractByteBuf</code> ï¼Œå®ç° ByteBuf æŠ½è±¡ç±»ï¼ŒByteBuf æŠ½è±¡å®ç°ç±»ã€‚å®˜æ–¹æ³¨é‡Šå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A skeletal implementation of a buffer.</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></tbody></table></figure>
<p>å› ä¸º AbstractByteBuf å®ç°ç±» ByteBuf è¶…çº§å¤šçš„æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯æŒ‰ç…§ ByteBuf çš„å½’ç±»ï¼Œé€ä¸ªåˆ†æè¿‡å»ã€‚</p>
<h2 id="4-1-åŸºç¡€ä¿¡æ¯"><a href="#4-1-åŸºç¡€ä¿¡æ¯" class="headerlink" title="4.1 åŸºç¡€ä¿¡æ¯"></a>4.1 åŸºç¡€ä¿¡æ¯</h2><h3 id="4-1-1-æ„é€ æ–¹æ³•"><a href="#4-1-1-æ„é€ æ–¹æ³•" class="headerlink" title="4.1.1 æ„é€ æ–¹æ³•"></a>4.1.1 æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¯»å–ä½ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> readerIndex;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å†™å…¥ä½ç½®</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">int</span> writerIndex;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #readerIndex} çš„æ ‡è®°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> markedReaderIndex;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #writerIndex} çš„æ ‡è®°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> markedWriterIndex;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æœ€å¤§å®¹é‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> maxCapacity;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">AbstractByteBuf</span><span class="params">(<span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (maxCapacity &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"maxCapacity: "</span> + maxCapacity + <span class="string">" (expected: &gt;= 0)"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">this</span>.maxCapacity = maxCapacity;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>capacity</code> å±æ€§ï¼Œåœ¨ AbstractByteBuf æœªå®šä¹‰ï¼Œè€Œæ˜¯ç”±å­ç±»æ¥å®ç°ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿåœ¨åé¢çš„æ–‡ç« ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°ï¼ŒByteBuf æ ¹æ®<strong>å†…å­˜ç±»å‹</strong>åˆ†æˆ Heap å’Œ Direct ï¼Œå®ƒä»¬è·å– <code>capacity</code> çš„å€¼çš„æ–¹å¼ä¸åŒã€‚</li>
<li><p><code>maxCapacity</code> å±æ€§ï¼Œç›¸å…³çš„æ–¹æ³•ï¼š </p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxCapacity</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> maxCapacity;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">maxCapacity</span><span class="params">(<span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.maxCapacity = maxCapacity;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h3 id="4-1-2-è¯»ç´¢å¼•ç›¸å…³çš„æ–¹æ³•"><a href="#4-1-2-è¯»ç´¢å¼•ç›¸å…³çš„æ–¹æ³•" class="headerlink" title="4.1.2 è¯»ç´¢å¼•ç›¸å…³çš„æ–¹æ³•"></a>4.1.2 è¯»ç´¢å¼•ç›¸å…³çš„æ–¹æ³•</h3><p><strong>è·å–å’Œè®¾ç½®è¯»ä½ç½®</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">readerIndex</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> readerIndex;</span><br><span class="line">}</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">readerIndex</span><span class="params">(<span class="keyword">int</span> readerIndex)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (readerIndex &lt; <span class="number">0</span> || readerIndex &gt; writerIndex) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(String.format(</span><br><span class="line">                <span class="string">"readerIndex: %d (expected: 0 &lt;= readerIndex &lt;= writerIndex(%d))"</span>, readerIndex, writerIndex));</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">this</span>.readerIndex = readerIndex;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p><strong>æ˜¯å¦å¯è¯»</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isReadable</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> writerIndex &gt; readerIndex;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isReadable</span><span class="params">(<span class="keyword">int</span> numBytes)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> writerIndex - readerIndex &gt;= numBytes;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">readableBytes</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> writerIndex - readerIndex;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p><strong>æ ‡è®°å’Œé‡ç½®è¯»ä½ç½®</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">markReaderIndex</span><span class="params">()</span> </span>{</span><br><span class="line">    markedReaderIndex = readerIndex;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">resetReaderIndex</span><span class="params">()</span> </span>{</span><br><span class="line">    readerIndex(markedReaderIndex);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="4-1-3-å†™ç´¢å¼•ç›¸å…³çš„æ–¹æ³•"><a href="#4-1-3-å†™ç´¢å¼•ç›¸å…³çš„æ–¹æ³•" class="headerlink" title="4.1.3 å†™ç´¢å¼•ç›¸å…³çš„æ–¹æ³•"></a>4.1.3 å†™ç´¢å¼•ç›¸å…³çš„æ–¹æ³•</h3><p><strong>è·å–å’Œè®¾ç½®å†™ä½ç½®</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">writerIndex</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> writerIndex;</span><br><span class="line">}</span><br><span class="line">    </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">writerIndex</span><span class="params">(<span class="keyword">int</span> writerIndex)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (writerIndex &lt; readerIndex || writerIndex &gt; capacity()) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(String.format(</span><br><span class="line">                <span class="string">"writerIndex: %d (expected: readerIndex(%d) &lt;= writerIndex &lt;= capacity(%d))"</span>,</span><br><span class="line">                writerIndex, readerIndex, capacity()));</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">this</span>.writerIndex = writerIndex;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p><strong>æ˜¯å¦å¯å†™</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isWritable</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> capacity() &gt; writerIndex;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isWritable</span><span class="params">(<span class="keyword">int</span> numBytes)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> capacity() - writerIndex &gt;= numBytes;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">writableBytes</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> capacity() - writerIndex;</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">maxWritableBytes</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> maxCapacity() - writerIndex;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p><strong>æ ‡è®°å’Œé‡ç½®å†™ä½ç½®</strong></p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">markWriterIndex</span><span class="params">()</span> </span>{</span><br><span class="line">    markedWriterIndex = writerIndex;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">resetWriterIndex</span><span class="params">()</span> </span>{</span><br><span class="line">    writerIndex(markedWriterIndex);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<hr>
<p><strong>ä¿è¯å¯å†™</strong></p>
<p><code>#ensureWritable(int minWritableBytes)</code> æ–¹æ³•ï¼Œä¿è¯æœ‰è¶³å¤Ÿçš„å¯å†™ç©ºé—´ã€‚è‹¥ä¸å¤Ÿï¼Œåˆ™è¿›è¡Œæ‰©å®¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> ByteBuf <span class="title">ensureWritable</span><span class="params">(<span class="keyword">int</span> minWritableBytes)</span> </span>{</span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (minWritableBytes &lt; <span class="number">0</span>) {</span><br><span class="line"> <span class="number">4</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(</span><br><span class="line"> <span class="number">5</span>:                 <span class="string">"minWritableBytes: %d (expected: &gt;= 0)"</span>, minWritableBytes));</span><br><span class="line"> <span class="number">6</span>:     }</span><br><span class="line"> <span class="number">7</span>:     ensureWritable0(minWritableBytes);</span><br><span class="line"> <span class="number">8</span>:     <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line"> <span class="number">9</span>: }</span><br><span class="line"><span class="number">10</span>: </span><br><span class="line"><span class="number">11</span>: <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">ensureWritable0</span><span class="params">(<span class="keyword">int</span> minWritableBytes)</span> </span>{</span><br><span class="line"><span class="number">12</span>:     <span class="comment">// æ£€æŸ¥æ˜¯å¦å¯è®¿é—®</span></span><br><span class="line"><span class="number">13</span>:     ensureAccessible();</span><br><span class="line"><span class="number">14</span>:     <span class="comment">// ç›®å‰å®¹é‡å¯å†™ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line"><span class="number">15</span>:     <span class="keyword">if</span> (minWritableBytes &lt;= writableBytes()) {</span><br><span class="line"><span class="number">16</span>:         <span class="keyword">return</span>;</span><br><span class="line"><span class="number">17</span>:     }</span><br><span class="line"><span class="number">18</span>: </span><br><span class="line"><span class="number">19</span>:     <span class="comment">// è¶…è¿‡æœ€å¤§ä¸Šé™ï¼ŒæŠ›å‡º IndexOutOfBoundsException å¼‚å¸¸</span></span><br><span class="line"><span class="number">20</span>:     <span class="keyword">if</span> (minWritableBytes &gt; maxCapacity - writerIndex) {</span><br><span class="line"><span class="number">21</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(String.format(</span><br><span class="line"><span class="number">22</span>:                 <span class="string">"writerIndex(%d) + minWritableBytes(%d) exceeds maxCapacity(%d): %s"</span>,</span><br><span class="line"><span class="number">23</span>:                 writerIndex, minWritableBytes, maxCapacity, <span class="keyword">this</span>));</span><br><span class="line"><span class="number">24</span>:     }</span><br><span class="line"><span class="number">25</span>: </span><br><span class="line"><span class="number">26</span>:     <span class="comment">// è®¡ç®—æ–°çš„å®¹é‡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ2 å€æ‰©å®¹ï¼Œå¹¶ä¸”ä¸è¶…è¿‡æœ€å¤§å®¹é‡ä¸Šé™ã€‚</span></span><br><span class="line"><span class="number">27</span>:     <span class="comment">// Normalize the current capacity to the power of 2.</span></span><br><span class="line"><span class="number">28</span>:     <span class="keyword">int</span> newCapacity = alloc().calculateNewCapacity(writerIndex + minWritableBytes, maxCapacity);</span><br><span class="line"><span class="number">29</span>: </span><br><span class="line"><span class="number">30</span>:     <span class="comment">// è®¾ç½®æ–°çš„å®¹é‡å¤§å°</span></span><br><span class="line"><span class="number">31</span>:     <span class="comment">// Adjust to the new capacity.</span></span><br><span class="line"><span class="number">32</span>:     capacity(newCapacity);</span><br><span class="line"><span class="number">33</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ç¬¬ 13 è¡Œï¼šè°ƒç”¨ <code>#ensureAccessible()</code> æ–¹æ³•ï¼Œæ£€æŸ¥æ˜¯å¦å¯è®¿é—®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Should be called by every method that tries to access the buffers content to check</span></span><br><span class="line"><span class="comment"> * if the buffer was released before.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">ensureAccessible</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (checkAccessible &amp;&amp; refCnt() == <span class="number">0</span>) { <span class="comment">// è‹¥æŒ‡å‘ä¸º 0 ï¼Œè¯´æ˜å·²ç»é‡Šæ”¾ï¼Œä¸å¯ç»§ç»­å†™å…¥ã€‚</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalReferenceCountException(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PROP_MODE = <span class="string">"io.netty.buffer.bytebuf.checkAccessible"</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦æ£€æŸ¥å¯è®¿é—®</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #ensureAccessible() </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">boolean</span> checkAccessible;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> {</span><br><span class="line">    checkAccessible = SystemPropertyUtil.getBoolean(PROP_MODE, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) {</span><br><span class="line">        logger.debug(<span class="string">"-D{}: {}"</span>, PROP_MODE, checkAccessible);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>ç¬¬ 14 è‡³ 17 è¡Œï¼šç›®å‰å®¹é‡å¯å†™ï¼Œç›´æ¥è¿”å›ã€‚</p>
</li>
<li>ç¬¬ 19 è‡³ 24 è¡Œï¼šè¶…è¿‡æœ€å¤§ä¸Šé™ï¼ŒæŠ›å‡º IndexOutOfBoundsException å¼‚å¸¸ã€‚</li>
<li>ç¬¬ 28 è¡Œï¼šè°ƒç”¨ <code>ByteBufAllocator#calculateNewCapacity(int minNewCapacity, int maxCapacity)</code> æ–¹æ³•ï¼Œè®¡ç®—æ–°çš„å®¹é‡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ2 å€æ‰©å®¹ï¼Œå¹¶ä¸”ä¸è¶…è¿‡æœ€å¤§å®¹é‡ä¸Šé™ã€‚<strong>æ³¨æ„</strong>ï¼Œæ­¤å¤„ä»…ä»…æ˜¯è®¡ç®—ï¼Œå¹¶æ²¡æœ‰æ‰©å®¹å†…å­˜å¤åˆ¶ç­‰ç­‰æ“ä½œã€‚<ul>
<li>ç¬¬ 32 è¡Œï¼šè°ƒç”¨ <code>#capacity(newCapacity)</code> æ–¹æ³•ï¼Œè®¾ç½®æ–°çš„å®¹é‡å¤§å°ã€‚</li>
</ul>
</li>
</ul>
<p><code>#ensureWritable(int minWritableBytes, boolean force)</code> æ–¹æ³•ï¼Œä¿è¯æœ‰è¶³å¤Ÿçš„å¯å†™ç©ºé—´ã€‚è‹¥ä¸å¤Ÿï¼Œåˆ™è¿›è¡Œæ‰©å®¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">ensureWritable</span><span class="params">(<span class="keyword">int</span> minWritableBytes, <span class="keyword">boolean</span> force)</span> </span>{</span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦å¯è®¿é—®</span></span><br><span class="line">    ensureAccessible();</span><br><span class="line">    <span class="keyword">if</span> (minWritableBytes &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(</span><br><span class="line">                <span class="string">"minWritableBytes: %d (expected: &gt;= 0)"</span>, minWritableBytes));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›®å‰å®¹é‡å¯å†™ï¼Œç›´æ¥è¿”å› 0</span></span><br><span class="line">    <span class="keyword">if</span> (minWritableBytes &lt;= writableBytes()) {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> maxCapacity = maxCapacity();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> writerIndex = writerIndex();</span><br><span class="line">    <span class="comment">// è¶…è¿‡æœ€å¤§ä¸Šé™</span></span><br><span class="line">    <span class="keyword">if</span> (minWritableBytes &gt; maxCapacity - writerIndex) {</span><br><span class="line">        <span class="comment">// ä¸å¼ºåˆ¶è®¾ç½®ï¼Œæˆ–è€…å·²ç»åˆ°è¾¾æœ€å¤§å®¹é‡</span></span><br><span class="line">        <span class="keyword">if</span> (!force || capacity() == maxCapacity) {</span><br><span class="line">            <span class="comment">// è¿”å› 1</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®¾ç½®ä¸ºæœ€å¤§å®¹é‡</span></span><br><span class="line">        capacity(maxCapacity);</span><br><span class="line">        <span class="comment">// è¿”å› 3</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¡ç®—æ–°çš„å®¹é‡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ2 å€æ‰©å®¹ï¼Œå¹¶ä¸”ä¸è¶…è¿‡æœ€å¤§å®¹é‡ä¸Šé™ã€‚</span></span><br><span class="line">    <span class="comment">// Normalize the current capacity to the power of 2.</span></span><br><span class="line">    <span class="keyword">int</span> newCapacity = alloc().calculateNewCapacity(writerIndex + minWritableBytes, maxCapacity);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è®¾ç½®æ–°çš„å®¹é‡å¤§å°</span></span><br><span class="line">    <span class="comment">// Adjust to the new capacity.</span></span><br><span class="line">    capacity(newCapacity);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å› 2</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>å’Œ <code>#ensureWritable(int minWritableBytes)</code> æ–¹æ³•ï¼Œæœ‰ä¸¤ç‚¹ä¸åŒï¼š</p>
<ul>
<li>è¶…è¿‡æœ€å¤§å®¹é‡çš„ä¸Šé™æ—¶ï¼Œä¸ä¼šæŠ›å‡º IndexOutOfBoundsException å¼‚å¸¸ã€‚</li>
<li>æ ¹æ®æ‰§è¡Œçš„è¿‡ç¨‹ä¸åŒï¼Œè¿”å›ä¸åŒçš„è¿”å›å€¼ã€‚</li>
</ul>
<p>æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹ä¸‹ä»£ç ã€‚</p>
<h3 id="4-1-4-setIndex"><a href="#4-1-4-setIndex" class="headerlink" title="4.1.4 setIndex"></a>4.1.4 setIndex</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">setIndex</span><span class="params">(<span class="keyword">int</span> readerIndex, <span class="keyword">int</span> writerIndex)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (readerIndex &lt; <span class="number">0</span> || readerIndex &gt; writerIndex || writerIndex &gt; capacity()) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(String.format(</span><br><span class="line">                <span class="string">"readerIndex: %d, writerIndex: %d (expected: 0 &lt;= readerIndex &lt;= writerIndex &lt;= capacity(%d))"</span>,</span><br><span class="line">                readerIndex, writerIndex, capacity()));</span><br><span class="line">    }</span><br><span class="line">    setIndex0(readerIndex, writerIndex);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setIndex0</span><span class="params">(<span class="keyword">int</span> readerIndex, <span class="keyword">int</span> writerIndex)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.readerIndex = readerIndex;</span><br><span class="line">    <span class="keyword">this</span>.writerIndex = writerIndex;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="4-1-5-è¯»ç´¢å¼•æ ‡è®°ä½ç›¸å…³çš„æ–¹æ³•"><a href="#4-1-5-è¯»ç´¢å¼•æ ‡è®°ä½ç›¸å…³çš„æ–¹æ³•" class="headerlink" title="4.1.5 è¯»ç´¢å¼•æ ‡è®°ä½ç›¸å…³çš„æ–¹æ³•"></a>4.1.5 è¯»ç´¢å¼•æ ‡è®°ä½ç›¸å…³çš„æ–¹æ³•</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">markReaderIndex</span><span class="params">()</span> </span>{</span><br><span class="line">    markedReaderIndex = readerIndex;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">resetReaderIndex</span><span class="params">()</span> </span>{</span><br><span class="line">    readerIndex(markedReaderIndex);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="4-1-6-å†™ç´¢å¼•æ ‡è®°ä½ç›¸å…³çš„æ–¹æ³•"><a href="#4-1-6-å†™ç´¢å¼•æ ‡è®°ä½ç›¸å…³çš„æ–¹æ³•" class="headerlink" title="4.1.6 å†™ç´¢å¼•æ ‡è®°ä½ç›¸å…³çš„æ–¹æ³•"></a>4.1.6 å†™ç´¢å¼•æ ‡è®°ä½ç›¸å…³çš„æ–¹æ³•</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">markWriterIndex</span><span class="params">()</span> </span>{</span><br><span class="line">    markedWriterIndex = writerIndex;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">resetWriterIndex</span><span class="params">()</span> </span>{</span><br><span class="line">    writerIndex(markedWriterIndex);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="4-1-7-æ˜¯å¦åªè¯»ç›¸å…³"><a href="#4-1-7-æ˜¯å¦åªè¯»ç›¸å…³" class="headerlink" title="4.1.7 æ˜¯å¦åªè¯»ç›¸å…³"></a>4.1.7 æ˜¯å¦åªè¯»ç›¸å…³</h3><p><code>#isReadOnly()</code> æ–¹æ³•ï¼Œè¿”å›æ˜¯å¦åªè¯»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isReadOnly</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é»˜è®¤è¿”å› <code>false</code> ã€‚å­ç±»å¯è¦†å†™è¯¥æ–¹æ³•ï¼Œæ ¹æ®æƒ…å†µè¿”å›ç»“æœã€‚</li>
</ul>
<hr>
<p><code>#asReadOnly()</code> æ–¹æ³•ï¼Œè½¬æ¢æˆåªè¯» ByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"deprecation"</span>)</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">asReadOnly</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯åªè¯»ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (isReadOnly()) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// è½¬åŒ–æˆåªè¯» Buffer å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> Unpooled.unmodifiableBuffer(<span class="keyword">this</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¦‚æœå·²æ˜¯åªè¯»ï¼Œç›´æ¥è¿”å›è¯¥ ByteBuf å¯¹è±¡ã€‚</li>
<li><p>å¦‚æœä¸æ˜¯åªè¯»ï¼Œè°ƒç”¨ <code>Unpooled#unmodifiableBuffer(Bytebuf)</code> æ–¹æ³•ï¼Œè½¬åŒ–æˆåªè¯» Buffer å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a read-only buffer which disallows any modification operations</span></span><br><span class="line"><span class="comment"> * on the specified {<span class="doctag">@code</span> buffer}.  The new buffer has the same</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@code</span> readerIndex} and {<span class="doctag">@code</span> writerIndex} with the specified</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@code</span> buffer}.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@deprecated</span> Use {<span class="doctag">@link</span> ByteBuf#asReadOnly()}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ByteBuf <span class="title">unmodifiableBuffer</span><span class="params">(ByteBuf buffer)</span> </span>{</span><br><span class="line">    ByteOrder endianness = buffer.order();</span><br><span class="line">    <span class="comment">// å¤§ç«¯</span></span><br><span class="line">    <span class="keyword">if</span> (endianness == BIG_ENDIAN) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReadOnlyByteBuf(buffer);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// å°ç«¯</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ReadOnlyByteBuf(buffer.order(BIG_ENDIAN)).order(LITTLE_ENDIAN);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ³¨æ„ï¼Œè¿”å›çš„æ˜¯<strong>æ–°çš„</strong> <code>io.netty.buffer.ReadOnlyByteBuf</code> å¯¹è±¡ã€‚å¹¶ä¸”ï¼Œå’ŒåŸ ByteBuf å¯¹è±¡ï¼Œå…±äº« <code>readerIndex</code> å’Œ <code>writerIndex</code> ç´¢å¼•ï¼Œä»¥åŠç›¸å…³çš„æ•°æ®ã€‚ä»…ä»…æ˜¯è¯´ï¼Œåªè¯»ï¼Œä¸èƒ½å†™å…¥ã€‚</li>
</ul>
</li>
</ul>
<h3 id="4-1-8-ByteOrder-ç›¸å…³çš„æ–¹æ³•"><a href="#4-1-8-ByteOrder-ç›¸å…³çš„æ–¹æ³•" class="headerlink" title="4.1.8 ByteOrder ç›¸å…³çš„æ–¹æ³•"></a>4.1.8 ByteOrder ç›¸å…³çš„æ–¹æ³•</h3><p><code>#order()</code> æ–¹æ³•ï¼Œè·å¾—å­—èŠ‚åºã€‚ç”±å­ç±»å®ç°ï¼Œå› ä¸º AbstractByteBuf çš„å†…å­˜ç±»å‹ï¼Œä¸ç¡®å®šæ˜¯ Heap è¿˜æ˜¯ Direct ã€‚</p>
<hr>
<p><code>#order(ByteOrder endianness)</code> æ–¹æ³•ï¼Œè®¾ç½®å­—èŠ‚åºã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">order</span><span class="params">(ByteOrder endianness)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (endianness == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"endianness"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// æœªæ”¹å˜ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (endianness == order()) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// åˆ›å»º SwappedByteBuf å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> newSwappedByteBuf();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a new {<span class="doctag">@link</span> SwappedByteBuf} for this {<span class="doctag">@link</span> ByteBuf} instance.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> SwappedByteBuf <span class="title">newSwappedByteBuf</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> SwappedByteBuf(<span class="keyword">this</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¦‚æœå­—èŠ‚åºæœªä¿®æ”¹ï¼Œç›´æ¥è¿”å›è¯¥ ByteBuf å¯¹è±¡ã€‚</li>
<li>å¦‚æœå­—èŠ‚åºæœ‰ä¿®æ”¹ï¼Œè°ƒç”¨ <code>#newSwappedByteBuf()</code> æ–¹æ³•ï¼ŒTODO SwappedByteBuf</li>
</ul>
<h3 id="4-1-9-æœªå®ç°æ–¹æ³•"><a href="#4-1-9-æœªå®ç°æ–¹æ³•" class="headerlink" title="4.1.9 æœªå®ç°æ–¹æ³•"></a>4.1.9 æœªå®ç°æ–¹æ³•</h3><p>å’Œ <a href="#">ã€Œ2.1.1 åŸºç¡€ä¿¡æ¯ã€</a> ç›¸å…³çš„æ–¹æ³•ï¼Œæœ‰ä¸‰ä¸ªæœªå®ç°ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBufAllocator <span class="title">alloc</span><span class="params">()</span></span>; <span class="comment">// åˆ†é…å™¨ï¼Œç”¨äºåˆ›å»º ByteBuf å¯¹è±¡ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ByteBuf <span class="title">unwrap</span><span class="params">()</span></span>; <span class="comment">// è·å¾—è¢«åŒ…è£…( wrap )çš„ ByteBuf å¯¹è±¡ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isDirect</span><span class="params">()</span></span>; <span class="comment">// æ˜¯å¦ NIO Direct Buffer</span></span><br></pre></td></tr></tbody></table></figure>
<h2 id="4-2-è¯»å–-å†™å…¥æ“ä½œ"><a href="#4-2-è¯»å–-å†™å…¥æ“ä½œ" class="headerlink" title="4.2 è¯»å– / å†™å…¥æ“ä½œ"></a>4.2 è¯»å– / å†™å…¥æ“ä½œ</h2><p>æˆ‘ä»¬ä»¥ Int ç±»å‹ä¸ºä¾‹å­ï¼Œæ¥çœ‹çœ‹å®ƒçš„è¯»å–å’Œå†™å…¥æ“ä½œçš„å®ç°ä»£ç ã€‚</p>
<h3 id="4-2-1-getInt"><a href="#4-2-1-getInt" class="headerlink" title="4.2.1 getInt"></a>4.2.1 getInt</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(<span class="keyword">int</span> index)</span> </span>{</span><br><span class="line">    <span class="comment">// æ ¡éªŒè¯»å–æ˜¯å¦ä¼šè¶…è¿‡å®¹é‡</span></span><br><span class="line">    checkIndex(index, <span class="number">4</span>);</span><br><span class="line">    <span class="comment">// è¯»å– Int æ•°æ®</span></span><br><span class="line">    <span class="keyword">return</span> _getInt(index);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>#checkIndex(index, fieldLength)</code> æ–¹æ³•ï¼Œæ ¡éªŒè¯»å–æ˜¯å¦ä¼šè¶…è¿‡<strong>å®¹é‡</strong>ã€‚æ³¨æ„ï¼Œä¸æ˜¯è¶…è¿‡ <code>writerIndex</code> ä½ç½®ã€‚å› ä¸ºï¼Œåªæ˜¯è¯»å–æŒ‡å®šä½ç½®å¼€å§‹çš„ Int æ•°æ®ï¼Œä¸ä¼šæ”¹å˜ <code>readerIndex</code> ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">checkIndex</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> fieldLength)</span> </span>{</span><br><span class="line">    <span class="comment">// æ ¡éªŒæ˜¯å¦å¯è®¿é—®</span></span><br><span class="line">    ensureAccessible();</span><br><span class="line">    <span class="comment">// æ ¡éªŒæ˜¯å¦ä¼šè¶…è¿‡å®¹é‡</span></span><br><span class="line">    checkIndex0(index, fieldLength);</span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">checkIndex0</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> fieldLength)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (isOutOfBounds(index, fieldLength, capacity())) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(String.format(</span><br><span class="line">                <span class="string">"index: %d, length: %d (expected: range(0, %d))"</span>, index, fieldLength, capacity()));</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// MathUtil.java</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Determine if the requested {<span class="doctag">@code</span> index} and {<span class="doctag">@code</span> length} will fit within {<span class="doctag">@code</span> capacity}.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> index The starting index.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> length The length which will be utilized (starting from {<span class="doctag">@code</span> index}).</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> capacity The capacity that {<span class="doctag">@code</span> index + length} is allowed to be within.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> {<span class="doctag">@code</span> true} if the requested {<span class="doctag">@code</span> index} and {<span class="doctag">@code</span> length} will fit within {<span class="doctag">@code</span> capacity}.</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@code</span> false} if this would result in an index out of bounds exception.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isOutOfBounds</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length, <span class="keyword">int</span> capacity)</span> </span>{</span><br><span class="line">    <span class="comment">// åªæœ‰æœ‰è´Ÿæ•°ï¼Œæˆ–è¿ç®—ï¼Œå°±ä¼šæœ‰è´Ÿæ•°ã€‚</span></span><br><span class="line">    <span class="comment">// å¦å¤–ï¼Œæ­¤å¤„çš„è¶Šç•Œï¼Œä¸ä»…ä»…æœ‰ capacity - (index + length &lt; 0 ï¼Œä¾‹å¦‚ index &lt; 0 ï¼Œä¹Ÿæ˜¯è¶Šç•Œ</span></span><br><span class="line">    <span class="keyword">return</span> (index | length | (index + length) | (capacity - (index + length))) &lt; <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<ul>
<li><p>è°ƒç”¨ <code>#_getInt(index)</code> æ–¹æ³•ï¼Œè¯»å– Int æ•°æ®ã€‚è¿™æ˜¯ä¸€ä¸ª<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œç”±å­ç±»å®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">_getInt</span><span class="params">(<span class="keyword">int</span> index)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>å…³äº <code>#getIntLE(int index)</code> / <code>getUnsignedInt(int index)</code> / <code>getUnsignedIntLE(int index)</code> æ–¹æ³•çš„å®ç°ï¼Œèƒ–å‹è‡ªå·±å»çœ‹ã€‚</p>
<h3 id="4-2-2-readInt"><a href="#4-2-2-readInt" class="headerlink" title="4.2.2 readInt"></a>4.2.2 readInt</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">readInt</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// æ ¡éªŒè¯»å–æ˜¯å¦ä¼šè¶…è¿‡å¯è¯»æ®µ</span></span><br><span class="line">    checkReadableBytes0(<span class="number">4</span>);</span><br><span class="line">    <span class="comment">// è¯»å– Int æ•°æ®</span></span><br><span class="line">    <span class="keyword">int</span> v = _getInt(readerIndex);</span><br><span class="line">    <span class="comment">// ä¿®æ”¹ readerIndex ï¼ŒåŠ ä¸Šå·²è¯»å–å­—èŠ‚æ•°</span></span><br><span class="line">    readerIndex += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">return</span> v;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>è°ƒç”¨ <code>#checkReadableBytes0(fieldLength)</code> æ–¹æ³•ï¼Œæ ¡éªŒè¯»å–æ˜¯å¦ä¼šè¶…è¿‡<strong>å¯è¯»æ®µ</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkReadableBytes0</span><span class="params">(<span class="keyword">int</span> minimumReadableBytes)</span> </span>{</span><br><span class="line">    <span class="comment">// æ˜¯å¦å¯è®¿é—®</span></span><br><span class="line">    ensureAccessible();</span><br><span class="line">    <span class="comment">// æ˜¯å¦è¶…è¿‡å†™ç´¢å¼•ï¼Œå³è¶…è¿‡å¯è¯»æ®µ</span></span><br><span class="line">    <span class="keyword">if</span> (readerIndex &gt; writerIndex - minimumReadableBytes) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IndexOutOfBoundsException(String.format(</span><br><span class="line">                <span class="string">"readerIndex(%d) + length(%d) exceeds writerIndex(%d): %s"</span>,</span><br><span class="line">                readerIndex, minimumReadableBytes, writerIndex, <span class="keyword">this</span>));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>è°ƒç”¨ <code>#_getInt(index)</code> æ–¹æ³•ï¼Œè¯»å– Int æ•°æ®ã€‚</p>
</li>
<li>è¯»å–å®Œæˆï¼Œä¿®æ”¹ <code>readerIndex</code> ã€<strong>é‡è¦</strong> ğŸ˜ˆã€‘ï¼ŒåŠ ä¸Šå·²è¯»å–å­—èŠ‚æ•° 4 ã€‚</li>
</ul>
<p>å…³äº <code>#readIntLE()</code> / <code>readUnsignedInt()</code> / <code>readUnsignedIntLE()</code> æ–¹æ³•çš„å®ç°ï¼Œèƒ–å‹è‡ªå·±å»çœ‹ã€‚</p>
<h3 id="4-2-3-setInt"><a href="#4-2-3-setInt" class="headerlink" title="4.2.3 setInt"></a>4.2.3 setInt</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">setInt</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> value)</span> </span>{</span><br><span class="line">    <span class="comment">// æ ¡éªŒå†™å…¥æ˜¯å¦ä¼šè¶…è¿‡å®¹é‡</span></span><br><span class="line">    checkIndex(index, <span class="number">4</span>);</span><br><span class="line">    <span class="comment">// è®¾ç½® Int æ•°æ®</span></span><br><span class="line">    _setInt(index, value);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è°ƒç”¨ <code>#checkIndex(index, fieldLength)</code> æ–¹æ³•ï¼Œæ ¡éªŒå†™å…¥æ˜¯å¦ä¼šè¶…è¿‡<strong>å®¹é‡</strong>ã€‚</li>
<li><p>è°ƒç”¨ <code>#_setInt(index,value )</code> æ–¹æ³•ï¼Œå†™å…¥ Int æ•°æ®ã€‚è¿™æ˜¯ä¸€ä¸ª<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œç”±å­ç±»å®ç°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">_setInt</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> value)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<p>å…³äº <code>#setIntLE(int index, int value)</code> æ–¹æ³•çš„å®ç°ï¼Œèƒ–å‹è‡ªå·±å»çœ‹ã€‚</p>
<p>public abstract ByteBuf writeInt(int value);<br>public abstract ByteBuf writeIntLE(int value);</p>
<h3 id="4-2-4-writeInt"><a href="#4-2-4-writeInt" class="headerlink" title="4.2.4 writeInt"></a>4.2.4 writeInt</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">writeInt</span><span class="params">(<span class="keyword">int</span> value)</span> </span>{</span><br><span class="line">    <span class="comment">// ä¿è¯å¯å†™å…¥</span></span><br><span class="line">    ensureWritable0(<span class="number">4</span>);</span><br><span class="line">    <span class="comment">// å†™å…¥ Int æ•°æ®</span></span><br><span class="line">    _setInt(writerIndex, value);</span><br><span class="line">    <span class="comment">// ä¿®æ”¹ writerIndex ï¼ŒåŠ ä¸Šå·²å†™å…¥å­—èŠ‚æ•°</span></span><br><span class="line">    writerIndex += <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è°ƒç”¨ <code>#ensureWritable0(int minWritableBytes)</code> æ–¹æ³•ï¼Œä¿è¯å¯å†™å…¥ã€‚</li>
<li>è°ƒç”¨ <code>#_setInt(index, int value)</code> æ–¹æ³•ï¼Œå†™å…¥Int æ•°æ®ã€‚</li>
<li>å†™å…¥å®Œæˆï¼Œä¿®æ”¹ <code>writerIndex</code> ã€<strong>é‡è¦</strong> ğŸ˜ˆã€‘ï¼ŒåŠ ä¸Šå·²å†™å…¥å­—èŠ‚æ•° 4 ã€‚</li>
</ul>
<h3 id="4-2-5-å…¶å®ƒæ–¹æ³•"><a href="#4-2-5-å…¶å®ƒæ–¹æ³•" class="headerlink" title="4.2.5 å…¶å®ƒæ–¹æ³•"></a>4.2.5 å…¶å®ƒæ–¹æ³•</h3><p>å…¶å®ƒç±»å‹çš„è¯»å–å’Œå†™å…¥æ“ä½œçš„å®ç°ä»£ç ï¼Œèƒ–å‹è‡ªå·±ç ”ç©¶è½ã€‚è¿˜æ˜¯æœ‰ä¸€äº›æœ‰æ„æ€çš„æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š</p>
<ul>
<li><code>#writeZero(int length)</code> æ–¹æ³•ã€‚åŸæœ¬ä»¥ä¸ºæ˜¯å¾ªç¯ <code>length</code> æ¬¡å†™å…¥ 0 å­—èŠ‚ï¼Œç»“æœå‘ç°ä¼šåŸºäº <code>long</code> =&gt; <code>int</code> =&gt; <code>byte</code> çš„é¡ºåºï¼Œå°½å¯èƒ½åˆå¹¶å†™å…¥ã€‚</li>
<li><code>#skipBytes((int length)</code> æ–¹æ³•</li>
</ul>
<h2 id="4-3-æŸ¥æ‰¾-éå†æ“ä½œ"><a href="#4-3-æŸ¥æ‰¾-éå†æ“ä½œ" class="headerlink" title="4.3 æŸ¥æ‰¾ / éå†æ“ä½œ"></a>4.3 æŸ¥æ‰¾ / éå†æ“ä½œ</h2><p>æŸ¥æ‰¾ / éå†æ“ä½œç›¸å…³çš„æ–¹æ³•ï¼Œå®ç°æ¯”è¾ƒç®€å•ã€‚æ‰€ä»¥ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥è‡ªå·±å»çœ‹ã€‚</p>
<h2 id="4-4-é‡Šæ”¾æ“ä½œ"><a href="#4-4-é‡Šæ”¾æ“ä½œ" class="headerlink" title="4.4 é‡Šæ”¾æ“ä½œ"></a>4.4 é‡Šæ”¾æ“ä½œ</h2><h3 id="4-4-1-discardReadBytes"><a href="#4-4-1-discardReadBytes" class="headerlink" title="4.4.1 discardReadBytes"></a>4.4.1 discardReadBytes</h3><p><code>#discardReadBytes()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> ByteBuf <span class="title">discardReadBytes</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">3</span>:     <span class="comment">// æ ¡éªŒå¯è®¿é—®</span></span><br><span class="line"> <span class="number">4</span>:     ensureAccessible();</span><br><span class="line"> <span class="number">5</span>:     <span class="comment">// æ— åºŸå¼ƒæ®µï¼Œç›´æ¥è¿”å›</span></span><br><span class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (readerIndex == <span class="number">0</span>) {</span><br><span class="line"> <span class="number">7</span>:         <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line"> <span class="number">8</span>:     }</span><br><span class="line"> <span class="number">9</span>: </span><br><span class="line"><span class="number">10</span>:     <span class="comment">// æœªè¯»å–å®Œ</span></span><br><span class="line"><span class="number">11</span>:     <span class="keyword">if</span> (readerIndex != writerIndex) {</span><br><span class="line"><span class="number">12</span>:         <span class="comment">// å°†å¯è¯»æ®µå¤åˆ¶åˆ° ByteBuf å¤´</span></span><br><span class="line"><span class="number">13</span>:         setBytes(<span class="number">0</span>, <span class="keyword">this</span>, readerIndex, writerIndex - readerIndex);</span><br><span class="line"><span class="number">14</span>:         <span class="comment">// å†™ç´¢å¼•å‡å°</span></span><br><span class="line"><span class="number">15</span>:         writerIndex -= readerIndex;</span><br><span class="line"><span class="number">16</span>:         <span class="comment">// è°ƒæ•´æ ‡è®°ä½</span></span><br><span class="line"><span class="number">17</span>:         adjustMarkers(readerIndex);</span><br><span class="line"><span class="number">18</span>:         <span class="comment">// è¯»ç´¢å¼•é‡ç½®ä¸º 0</span></span><br><span class="line"><span class="number">19</span>:         readerIndex = <span class="number">0</span>;</span><br><span class="line"><span class="number">20</span>:     <span class="comment">// å…¨éƒ¨è¯»å–å®Œ</span></span><br><span class="line"><span class="number">21</span>:     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">22</span>:         <span class="comment">// è°ƒæ•´æ ‡è®°ä½</span></span><br><span class="line"><span class="number">23</span>:         adjustMarkers(readerIndex);</span><br><span class="line"><span class="number">24</span>:         <span class="comment">// è¯»å†™ç´¢å¼•éƒ½é‡ç½®ä¸º 0</span></span><br><span class="line"><span class="number">25</span>:         writerIndex = readerIndex = <span class="number">0</span>;</span><br><span class="line"><span class="number">26</span>:     }</span><br><span class="line"><span class="number">27</span>:     <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line"><span class="number">28</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 4 è¡Œï¼šè°ƒç”¨ <code>#ensureAccessible()</code> æ–¹æ³•ï¼Œæ£€æŸ¥æ˜¯å¦å¯è®¿é—®ã€‚</li>
<li>ç¬¬ 5 è‡³ 8 è¡Œï¼šæ— <strong>åºŸå¼ƒæ®µ</strong>ï¼Œç›´æ¥è¿”å›ã€‚</li>
<li><p>ç¬¬ 10 è‡³ 19 è¡Œï¼šæœªè¯»å–å®Œï¼Œå³è¿˜æœ‰<strong>å¯è¯»æ®µ</strong>ã€‚</p>
<ul>
<li>ç¬¬ 13 è¡Œï¼šè°ƒç”¨ <code>#setBytes(int index, ByteBuf src, int srcIndex, int length)</code> æ–¹æ³•ï¼Œå°†å¯è¯»æ®µå¤åˆ¶åˆ° ByteBuf å¤´å¼€å§‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_08_01/02.png" title="discardReadBytes" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_08_01/02.png" alt="discardReadBytes"></a><span class="caption">discardReadBytes</span></li>
<li>ç¬¬ 15 è¡Œï¼šå†™ç´¢å¼• <code>writerIndex</code> å‡å°ã€‚</li>
<li><p>ç¬¬ 19 è¡Œï¼šè°ƒç”¨ <code>#adjustMarkers(int decrement)</code> æ–¹æ³•ï¼Œè°ƒæ•´æ ‡è®°ä½ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">adjustMarkers</span><span class="params">(<span class="keyword">int</span> decrement)</span> </span>{</span><br><span class="line">    <span class="keyword">int</span> markedReaderIndex = <span class="keyword">this</span>.markedReaderIndex;</span><br><span class="line">    <span class="comment">// è¯»æ ‡è®°ä½å°äºå‡å°‘å€¼(decrement)</span></span><br><span class="line">    <span class="keyword">if</span> (markedReaderIndex &lt;= decrement) {</span><br><span class="line">        <span class="comment">// é‡ç½®è¯»æ ‡è®°ä½ä¸º 0</span></span><br><span class="line">        <span class="keyword">this</span>.markedReaderIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// å†™æ ‡è®°ä½å°äºå‡å°‘å€¼(decrement)</span></span><br><span class="line">        <span class="keyword">int</span> markedWriterIndex = <span class="keyword">this</span>.markedWriterIndex;</span><br><span class="line">        <span class="keyword">if</span> (markedWriterIndex &lt;= decrement) {</span><br><span class="line">            <span class="comment">// é‡ç½®å†™æ ‡è®°ä½ä¸º 0</span></span><br><span class="line">            <span class="keyword">this</span>.markedWriterIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// å‡å°å†™æ ‡è®°ä½</span></span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">this</span>.markedWriterIndex = markedWriterIndex - decrement;</span><br><span class="line">        }</span><br><span class="line">    <span class="comment">// å‡å°è¯»å†™æ ‡è®°ä½</span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">this</span>.markedReaderIndex = markedReaderIndex - decrement;</span><br><span class="line">        <span class="keyword">this</span>.markedWriterIndex -= decrement;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç è™½ç„¶æ¯”è¾ƒå¤šï¼Œä½†æ˜¯ç›®çš„å¾ˆæ˜ç¡®ï¼Œ<strong>å‡å°</strong>è¯»å†™æ ‡è®°ä½ã€‚å¹¶ä¸”ï¼Œé€šè¿‡åˆ¤æ–­ï¼Œ<strong>æœ€å¤šå‡å°è‡³ 0</strong> ã€‚</li>
</ul>
</li>
<li>ç¬¬ 19 è¡Œï¼š<strong>ä»…</strong>è¯»ç´¢å¼•é‡ç½®ä¸º 0 ã€‚</li>
</ul>
</li>
<li>ç¬¬ 20 è‡³ 26 è¡Œï¼šå…¨éƒ¨è¯»å–å®Œï¼Œå³æ— <strong>å¯è¯»æ®µ</strong>ã€‚<ul>
<li>ç¬¬ 23 è¡Œï¼šè°ƒç”¨ <code>#adjustMarkers(int decrement)</code> æ–¹æ³•ï¼Œè°ƒæ•´æ ‡è®°ä½ã€‚</li>
<li>ç¬¬ 25 è¡Œï¼šè¯»å†™ç´¢å¼•<strong>éƒ½</strong>é‡ç½®ä¸º 0 ã€‚</li>
</ul>
</li>
</ul>
<h3 id="4-4-2-discardSomeReadBytes"><a href="#4-4-2-discardSomeReadBytes" class="headerlink" title="4.4.2 discardSomeReadBytes"></a>4.4.2 discardSomeReadBytes</h3><p><code>#discardSomeReadBytes()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">discardSomeReadBytes</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// æ ¡éªŒå¯è®¿é—®</span></span><br><span class="line">    ensureAccessible();</span><br><span class="line">    <span class="comment">// æ— åºŸå¼ƒæ®µï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (readerIndex == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å…¨éƒ¨è¯»å–å®Œ</span></span><br><span class="line">    <span class="keyword">if</span> (readerIndex == writerIndex) {</span><br><span class="line">        <span class="comment">// è°ƒæ•´æ ‡è®°ä½</span></span><br><span class="line">        adjustMarkers(readerIndex);</span><br><span class="line">        <span class="comment">// è¯»å†™ç´¢å¼•éƒ½é‡ç½®ä¸º 0</span></span><br><span class="line">        writerIndex = readerIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–è¶…è¿‡å®¹é‡çš„ä¸€åŠï¼Œè¿›è¡Œé‡Šæ”¾</span></span><br><span class="line">    <span class="keyword">if</span> (readerIndex &gt;= capacity() &gt;&gt;&gt; <span class="number">1</span>) {</span><br><span class="line">        <span class="comment">// å°†å¯è¯»æ®µå¤åˆ¶åˆ° ByteBuf å¤´</span></span><br><span class="line">        setBytes(<span class="number">0</span>, <span class="keyword">this</span>, readerIndex, writerIndex - readerIndex);</span><br><span class="line">        <span class="comment">// å†™ç´¢å¼•å‡å°</span></span><br><span class="line">        writerIndex -= readerIndex;</span><br><span class="line">        <span class="comment">// è°ƒæ•´æ ‡è®°ä½</span></span><br><span class="line">        adjustMarkers(readerIndex);</span><br><span class="line">        <span class="comment">// è¯»ç´¢å¼•é‡ç½®ä¸º 0</span></span><br><span class="line">        readerIndex = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>æ•´ä½“ä»£ç å’Œ <code>#discardReadBytes()</code> æ–¹æ³•æ˜¯<strong>ä¸€è‡´çš„</strong>ã€‚å·®åˆ«åœ¨äºï¼Œ<code>readerIndex &gt;= capacity() &gt;&gt;&gt; 1</code> ï¼Œè¯»å–è¶…è¿‡å®¹é‡çš„<strong>ä¸€åŠ</strong>æ—¶ï¼Œè¿›è¡Œé‡Šæ”¾ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç©ºé—´å’Œæ—¶é—´ä¹‹é—´ï¼Œåšäº†ä¸€ä¸ªå¹³è¡¡ã€‚</p>
<p>ğŸ˜ˆ åç»­ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ï¼ŒNetty å…·ä½“åœ¨ä»€ä¹ˆæ—¶å€™ï¼Œè°ƒç”¨ <code>#discardSomeReadBytes()</code> å’Œ <code>#discardReadBytes()</code> æ–¹æ³•ã€‚</p>
<h3 id="4-4-3-clear"><a href="#4-4-3-clear" class="headerlink" title="4.4.3 clear"></a>4.4.3 clear</h3><p><code>#clear()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">clear</span><span class="params">()</span> </span>{</span><br><span class="line">    readerIndex = writerIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¯»å†™ç´¢å¼•<strong>éƒ½</strong>é‡ç½®ä¸º 0 ã€‚</li>
<li>è¯»å†™æ ‡è®°ä½<strong>ä¸ä¼š</strong>é‡ç½®ã€‚</li>
</ul>
<h2 id="4-5-æ‹·è´æ“ä½œ"><a href="#4-5-æ‹·è´æ“ä½œ" class="headerlink" title="4.5 æ‹·è´æ“ä½œ"></a>4.5 æ‹·è´æ“ä½œ</h2><h3 id="4-5-1-copy"><a href="#4-5-1-copy" class="headerlink" title="4.5.1 copy"></a>4.5.1 copy</h3><p><code>#copy()</code> æ–¹æ³•ï¼Œæ‹·è´å¯è¯»éƒ¨åˆ†çš„å­—èŠ‚æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">copy</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> copy(readerIndex, readableBytes());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è°ƒç”¨ <code>#readableBytes()</code> æ–¹æ³•ï¼Œè·å¾—å¯è¯»çš„å­—èŠ‚æ•°ã€‚</li>
<li>è°ƒç”¨ <code>#copy(int index, int length)</code> æ–¹æ³•ï¼Œæ‹·è´<strong>æŒ‡å®šéƒ¨åˆ†</strong>çš„å­—èŠ‚æ•°ç»„ã€‚ç‹¬ç«‹ï¼Œäº’ç›¸ä¸å½±å“ã€‚å…·ä½“çš„å®ç°ï¼Œéœ€è¦å­ç±»ä¸­å®ç°ï¼ŒåŸå› æ˜¯åš<strong>æ·±</strong>æ‹·è´ï¼Œéœ€è¦æ ¹æ®å†…å­˜ç±»å‹æ˜¯ Heap å’Œ Direct ä¼šæœ‰ä¸åŒã€‚</li>
</ul>
<h3 id="4-5-2-slice"><a href="#4-5-2-slice" class="headerlink" title="4.5.2 slice"></a>4.5.2 slice</h3><p><code>#slice()</code> æ–¹æ³•ï¼Œæ‹·è´å¯è¯»éƒ¨åˆ†çš„å­—èŠ‚æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">slice</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> slice(readerIndex, readableBytes());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è°ƒç”¨ <code>#readableBytes()</code> æ–¹æ³•ï¼Œè·å¾—å¯è¯»çš„å­—èŠ‚æ•°ã€‚</li>
<li><p>è°ƒç”¨ <code>#slice(int index, int length)</code> æ–¹æ³•ï¼Œæ‹·è´<strong>æŒ‡å®šéƒ¨åˆ†</strong>çš„å­—èŠ‚æ•°ç»„ã€‚å…±äº«ï¼Œäº’ç›¸å½±å“ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">slice</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length)</span> </span>{</span><br><span class="line">    <span class="comment">// æ ¡éªŒå¯è®¿é—®</span></span><br><span class="line">    ensureAccessible();</span><br><span class="line">    <span class="comment">// åˆ›å»º UnpooledSlicedByteBuf å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UnpooledSlicedByteBuf(<span class="keyword">this</span>, index, length);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¿”å›çš„æ˜¯åˆ›å»ºçš„ UnpooledSlicedByteBuf å¯¹è±¡ã€‚åœ¨å®ƒå†…éƒ¨ï¼Œä¼šè°ƒç”¨å½“å‰ ByteBuf å¯¹è±¡ï¼Œæ‰€ä»¥è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¯´æ˜¯<strong>å…±äº«</strong>çš„ã€‚æˆ–è€…è¯´ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ª<strong>æµ…</strong>æ‹·è´ã€‚</li>
</ul>
</li>
</ul>
<hr>
<p><code>#retainedSlice()</code> æ–¹æ³•ï¼Œåœ¨ <code>#slice()</code> æ–¹æ³•çš„åŸºç¡€ä¸Šï¼Œå¼•ç”¨è®¡æ•°åŠ  1 ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">retainedSlice</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> length)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> slice(index, length).retain();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è°ƒç”¨ <code>#slice(int index, int length)</code> æ–¹æ³•ï¼Œæ‹·è´<strong>æŒ‡å®šéƒ¨åˆ†</strong>çš„å­—èŠ‚æ•°ç»„ã€‚ä¹Ÿå°±è¯´ï¼Œè¿”å› UnpooledSlicedByteBuf å¯¹è±¡ã€‚</li>
<li>è°ƒç”¨ <code>UnpooledSlicedByteBuf#retain()</code> æ–¹æ³•ï¼Œï¼Œå¼•ç”¨è®¡æ•°åŠ  1 ã€‚æœ¬æ–‡æš‚æ—¶ä¸è§£æï¼Œæˆ‘ä»¬ä¼šåœ¨ TODO 1011 ã€‚</li>
</ul>
<h3 id="4-5-3-duplicate"><a href="#4-5-3-duplicate" class="headerlink" title="4.5.3 duplicate"></a>4.5.3 duplicate</h3><p><code>#duplicate()</code> æ–¹æ³•ï¼Œæ‹·è´<strong>æ•´ä¸ª</strong>çš„å­—èŠ‚æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">duplicate</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// æ ¡éªŒæ˜¯å¦å¯è®¿é—®</span></span><br><span class="line">    ensureAccessible();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UnpooledDuplicatedByteBuf(<span class="keyword">this</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åˆ›å»ºçš„ UnpooledDuplicatedByteBuf å¯¹è±¡ã€‚åœ¨å®ƒå†…éƒ¨ï¼Œä¼šè°ƒç”¨å½“å‰ ByteBuf å¯¹è±¡ï¼Œæ‰€ä»¥è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆè¯´æ˜¯<strong>å…±äº«</strong>çš„ã€‚æˆ–è€…è¯´ï¼Œæˆ‘ä»¬å¯ä»¥è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ª<strong>æµ…</strong>æ‹·è´ã€‚</li>
<li>å®ƒå’Œ <code>#slice()</code> æ–¹æ³•çš„å·®åˆ«åœ¨äºï¼Œå‰è€…æ˜¯<strong>æ•´ä¸ª</strong>ï¼Œåè€…æ˜¯<strong>å¯å†™æ®µ</strong>ã€‚</li>
</ul>
<hr>
<p><code>#retainedDuplicate()</code> æ–¹æ³•ï¼Œåœ¨ <code>#duplicate()</code> æ–¹æ³•çš„åŸºç¡€ä¸Šï¼Œå¼•ç”¨è®¡æ•°åŠ  1 ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">retainedDuplicate</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> duplicate().retain();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è°ƒç”¨ <code>#duplicate()</code> æ–¹æ³•ï¼Œæ‹·è´<strong>æ•´ä¸ª</strong>çš„å­—èŠ‚æ•°ç»„ã€‚ä¹Ÿå°±è¯´ï¼Œè¿”å› UnpooledDuplicatedByteBuf å¯¹è±¡ã€‚</li>
<li>è°ƒç”¨ <code>UnpooledDuplicatedByteBuf#retain()</code> æ–¹æ³•ï¼Œï¼Œå¼•ç”¨è®¡æ•°åŠ  1 ã€‚æœ¬æ–‡æš‚æ—¶ä¸è§£æï¼Œæˆ‘ä»¬ä¼šåœ¨ TODO 1011 ã€‚</li>
</ul>
<h2 id="4-6-è½¬æ¢-NIO-ByteBuffer-æ“ä½œ"><a href="#4-6-è½¬æ¢-NIO-ByteBuffer-æ“ä½œ" class="headerlink" title="4.6 è½¬æ¢ NIO ByteBuffer æ“ä½œ"></a>4.6 è½¬æ¢ NIO ByteBuffer æ“ä½œ</h2><h3 id="4-6-1-nioBuffer"><a href="#4-6-1-nioBuffer" class="headerlink" title="4.6.1 nioBuffer"></a>4.6.1 nioBuffer</h3><p><code>#nioBuffer()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuffer <span class="title">nioBuffer</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> nioBuffer(readerIndex, readableBytes());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>åœ¨æ–¹æ³•å†…éƒ¨ï¼Œä¼šè°ƒç”¨ <code>#nioBuffer(int index, int length)</code> æ–¹æ³•ã€‚è€Œè¯¥æ–¹æ³•ï¼Œç”±å…·ä½“çš„å­ç±»å®ç°ã€‚</p>
<blockquote>
<p>FROM <a href="https://my.oschina.net/7001/blog/742236" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥ç ”ç©¶Nettyæ¡†æ¶ä¹‹ByteBufåŠŸèƒ½åŸç†åŠæºç åˆ†æã€‹</a></p>
<p>å°†å½“å‰ ByteBuf çš„å¯è¯»ç¼“å†²åŒº( <code>readerIndex</code> åˆ° <code>writerIndex</code> ä¹‹é—´çš„å†…å®¹) è½¬æ¢ä¸º ByteBuffer å¯¹è±¡ï¼Œä¸¤è€…å…±äº«å…±äº«ç¼“å†²åŒºçš„å†…å®¹ã€‚å¯¹ ByteBuffer çš„è¯»å†™æ“ä½œä¸ä¼šå½±å“ ByteBuf çš„è¯»å†™ç´¢å¼•ã€‚</p>
<p>æ³¨æ„ï¼šByteBuffer æ— æ³•æ„ŸçŸ¥ ByteBuf çš„åŠ¨æ€æ‰©å±•æ“ä½œã€‚ByteBuffer çš„é•¿åº¦ä¸º<code>readableBytes()</code> ã€‚</p>
</blockquote>
</li>
</ul>
<h3 id="4-6-2-nioBuffers"><a href="#4-6-2-nioBuffers" class="headerlink" title="4.6.2 nioBuffers"></a>4.6.2 nioBuffers</h3><p><code>#nioBuffers()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> ByteBuffer[] nioBuffers() {</span><br><span class="line">    <span class="keyword">return</span> nioBuffers(readerIndex, readableBytes());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨æ–¹æ³•å†…éƒ¨ï¼Œä¼šè°ƒç”¨ <code>#nioBuffers(int index, int length)</code> æ–¹æ³•ã€‚è€Œè¯¥æ–¹æ³•ï¼Œç”±å…·ä½“çš„å­ç±»å®ç°ã€‚</li>
<li>ğŸ˜ˆ ä¸ºä»€ä¹ˆä¼šäº§ç”Ÿæ•°ç»„çš„æƒ…å†µå‘¢ï¼Ÿä¾‹å¦‚ CompositeByteBuf ã€‚å½“ç„¶ï¼Œåç»­æ–‡ç« ï¼Œæˆ‘ä»¬ä¹Ÿä¼šå…·ä½“åˆ†äº«ã€‚</li>
</ul>
<h2 id="4-7-Heap-ç›¸å…³æ–¹æ³•"><a href="#4-7-Heap-ç›¸å…³æ–¹æ³•" class="headerlink" title="4.7 Heap ç›¸å…³æ–¹æ³•"></a>4.7 Heap ç›¸å…³æ–¹æ³•</h2><p>Heap ç›¸å…³æ–¹æ³•ï¼Œåœ¨å­ç±»ä¸­å®ç°ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/ByteBuf-1-2-ByteBuf-core-impl">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ ByteBufï¼ˆäºŒï¼‰æ ¸å¿ƒå­ç±»ã€‹</a></p>
<h2 id="4-8-Unsafe-ç›¸å…³æ–¹æ³•"><a href="#4-8-Unsafe-ç›¸å…³æ–¹æ³•" class="headerlink" title="4.8 Unsafe ç›¸å…³æ–¹æ³•"></a>4.8 Unsafe ç›¸å…³æ–¹æ³•</h2><p>Unsafeï¼Œåœ¨å­ç±»ä¸­å®ç°ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/ByteBuf-1-2-ByteBuf-core-impl">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ ByteBufï¼ˆäºŒï¼‰æ ¸å¿ƒå­ç±»ã€‹</a></p>
<h2 id="4-9-Object-ç›¸å…³"><a href="#4-9-Object-ç›¸å…³" class="headerlink" title="4.9 Object ç›¸å…³"></a>4.9 Object ç›¸å…³</h2><p>Object ç›¸å…³çš„æ–¹æ³•ï¼Œä¸»è¦è°ƒç”¨ <code>io.netty.buffer.ByteBufUtil</code> è¿›è¡Œå®ç°ã€‚è€Œ ByteUtil æ˜¯ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„å·¥å…·ç±»ï¼Œå®ƒæä¾›äº†ä¸€ç³»åˆ—é™æ€æ–¹æ³•ï¼Œç”¨äºæ“ä½œ ByteBuf å¯¹è±¡ï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_08_01/06.png" title="ByteUtil" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_08_01/06.png" alt="ByteUtil"></a><span class="caption">ByteUtil</span></p>
<p>ğŸ˜ˆ å› ä¸º Object ç›¸å…³çš„æ–¹æ³•ï¼Œå®ç°æ¯”è¾ƒç®€å•ã€‚æ‰€ä»¥ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥è‡ªå·±å»çœ‹ã€‚</p>
<h2 id="4-10-å¼•ç”¨è®¡æ•°ç›¸å…³"><a href="#4-10-å¼•ç”¨è®¡æ•°ç›¸å…³" class="headerlink" title="4.10 å¼•ç”¨è®¡æ•°ç›¸å…³"></a>4.10 å¼•ç”¨è®¡æ•°ç›¸å…³</h2><p>æœ¬æ–‡æš‚æ—¶ä¸è§£æï¼Œæˆ‘ä»¬ä¼šåœ¨ TODO 1011 ã€‚</p>
<h1 id="5-EmptyByteBuf"><a href="#5-EmptyByteBuf" class="headerlink" title="5. EmptyByteBuf"></a>5. EmptyByteBuf</h1><p><code>io.netty.buffer.EmptyByteBuf</code> ï¼Œç»§æ‰¿ ByteBuf æŠ½è±¡ç±»ï¼Œç”¨äºæ„å»ºç©º ByteBuf å¯¹è±¡ï¼Œ<code>capacity</code> å’Œ <code>maxCapacity</code> å‡ä¸º 0 ã€‚</p>
<p>ğŸ˜ˆ ä»£ç å®ç°è¶…çº§ç®€å•ï¼Œæ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥è‡ªå·±å»çœ‹ã€‚</p>
<h1 id="6-WrappedByteBuf"><a href="#6-WrappedByteBuf" class="headerlink" title="6. WrappedByteBuf"></a>6. WrappedByteBuf</h1><p><code>io.netty.buffer.WrappedByteBuf</code> ï¼Œç»§æ‰¿ ByteBuf æŠ½è±¡ç±»ï¼Œç”¨äºè£…é¥° ByteBuf å¯¹è±¡ã€‚æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è¢«è£…é¥°çš„ ByteBuf å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> ByteBuf buf;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">WrappedByteBuf</span><span class="params">(ByteBuf buf)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (buf == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"buf"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">this</span>.buf = buf;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>buf</code> å±æ€§ï¼Œè¢«è£…é¥°çš„ ByteBuf å¯¹è±¡ã€‚</li>
<li><p>æ¯ä¸ªå®ç°æ–¹æ³•ï¼Œæ˜¯å¯¹ <code>buf</code> çš„å¯¹åº”æ–¹æ³•çš„è°ƒç”¨ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">capacity</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> buf.capacity();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">capacity</span><span class="params">(<span class="keyword">int</span> newCapacity)</span> </span>{</span><br><span class="line">    buf.capacity(newCapacity);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h1 id="7-SwappedByteBuf"><a href="#7-SwappedByteBuf" class="headerlink" title="7. SwappedByteBuf"></a>7. SwappedByteBuf</h1><p><code>io.netty.buffer.SwappedByteBuf</code> ï¼Œç»§æ‰¿ ByteBuf æŠ½è±¡ç±»ï¼Œç”¨äºæ„å»ºå…·æœ‰åˆ‡æ¢<strong>å­—èŠ‚åº</strong>åŠŸèƒ½çš„ ByteBuf å¯¹è±¡ã€‚æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŸ ByteBuf å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ByteBuf buf;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å­—èŠ‚åº</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ByteOrder order;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SwappedByteBuf</span><span class="params">(ByteBuf buf)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (buf == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"buf"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">this</span>.buf = buf;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– order å±æ€§</span></span><br><span class="line">    <span class="keyword">if</span> (buf.order() == ByteOrder.BIG_ENDIAN) {</span><br><span class="line">        order = ByteOrder.LITTLE_ENDIAN;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        order = ByteOrder.BIG_ENDIAN;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>buf</code> å±æ€§ï¼ŒåŸ ByteBuf å¯¹è±¡ã€‚</li>
<li><code>order</code> å±æ€§ï¼Œå­—èŠ‚æ•°ã€‚</li>
<li><p>å®é™…ä¸Šï¼ŒSwappedByteBuf å¯ä»¥çœ‹æˆä¸€ä¸ªç‰¹æ®Šçš„ WrappedByteBuf å®ç°ï¼Œæ‰€ä»¥å®ƒé™¤äº†è¯»å†™æ“ä½œå¤–çš„æ–¹æ³•ï¼Œéƒ½æ˜¯å¯¹ <code>buf</code> çš„å¯¹åº”æ–¹æ³•çš„è°ƒç”¨ã€‚</p>
<ul>
<li><p><code>#capacity()</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š </p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">capacity</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> buf.capacity();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç›´æ¥è°ƒç”¨ <code>buf</code> çš„å¯¹åº”æ–¹æ³•ã€‚</li>
</ul>
</li>
<li><p><code>#setInt(int index, int value)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">setInt</span><span class="params">(<span class="keyword">int</span> index, <span class="keyword">int</span> value)</span> </span>{</span><br><span class="line">    buf.setInt(index, ByteBufUtil.swapInt(value));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// ByteBufUtil.java</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Toggles the endianness of the specified 32-bit integer.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">swapInt</span><span class="params">(<span class="keyword">int</span> value)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> Integer.reverseBytes(value);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å…ˆè°ƒç”¨ <code>ByteBufUtil#swapInt(int value)</code> æ–¹æ³•ï¼Œå°† <code>value</code> çš„å€¼ï¼Œè½¬æ¢æˆç›¸åå­—èŠ‚åºçš„ Int å€¼ã€‚</li>
<li>åè°ƒç”¨ <code>buf</code> çš„å¯¹åº”æ–¹æ³•ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>é€šè¿‡ SwappedByteBuf ç±»ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä¿®æ”¹åŸ ByteBuf å¯¹è±¡çš„å­—èŠ‚åºï¼Œå¹¶ä¸”æ— éœ€è¿›è¡Œå†…å­˜å¤åˆ¶ã€‚ä½†æ˜¯åè¿‡æ¥ï¼Œä¸€å®šè¦æ³¨æ„ï¼Œè¿™ä¸¤è€…æ˜¯<strong>å…±äº«</strong>çš„ã€‚</p>
<h1 id="8-ReplayingDecoderByteBuf"><a href="#8-ReplayingDecoderByteBuf" class="headerlink" title="8. ReplayingDecoderByteBuf"></a>8. ReplayingDecoderByteBuf</h1><p><code>io.netty.handler.codec.ReplayingDecoderByteBuf</code> ï¼Œç»§æ‰¿ ByteBuf æŠ½è±¡ç±»ï¼Œç”¨äºæ„å»ºåœ¨ IO é˜»å¡æ¡ä»¶ä¸‹å®ç°æ— é˜»å¡è§£ç çš„ç‰¹æ®Š ByteBufå¯¹ è±¡ã€‚å½“è¦è¯»å–çš„æ•°æ®è¿˜æœªæ¥æ”¶å®Œå…¨æ—¶ï¼ŒæŠ›å‡ºå¼‚å¸¸ï¼Œäº¤ç”± ReplayingDecoder å¤„ç†ã€‚</p>
<p>ç»†å¿ƒçš„èƒ–å‹ï¼Œä¼šçœ‹åˆ° ReplayingDecoderByteBuf æ˜¯åœ¨ <code>codec</code> æ¨¡å—ï¼Œé…åˆ ReplayingDecoder ä½¿ç”¨ã€‚æ‰€ä»¥ï¼Œæœ¬æ–‡æš‚æ—¶ä¸ä¼šåˆ†äº«å®ƒï¼Œè€Œæ˜¯åœ¨ <a href="">ã€ŠTODO 2000 ReplayingDecoderByteBufã€‹</a> ä¸­ï¼Œè¯¦ç»†è§£æã€‚</p>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ¯é€¢å¼€ç¯‡ï¼Œå†…å®¹å°±ç‰¹åˆ«å•°å—¦ï¼Œå“ˆå“ˆå“ˆå“ˆã€‚</p>
<p>æ¨èé˜…è¯»å¦‚ä¸‹æ–‡ç« ï¼š</p>
<ul>
<li>AbeJeffrey <a href="https://my.oschina.net/7001/blog/742236" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥ç ”ç©¶Nettyæ¡†æ¶ä¹‹ByteBufåŠŸèƒ½åŸç†åŠæºç åˆ†æã€‹</a></li>
<li><a href="https://skyao.gitbooks.io/learning-netty/content/buffer/inheritance.html" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty å­¦ä¹ ç¬”è®° â€”â€” ByteBuf ç»§æ‰¿ç»“æ„ã€‹</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/ByteBuf-1-1-ByteBuf-intro/" data-id="ck4pl3fp400dyfgcf0fdpwvjn" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>