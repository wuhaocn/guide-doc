<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” ChannelPipelineï¼ˆå››ï¼‰ä¹‹ Outbound äº‹ä»¶çš„ä¼ æ’­
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡æˆ‘ä»¬æ¥åˆ†äº«ï¼Œåœ¨ pipeline ä¸­çš„ <strong>Outbound äº‹ä»¶çš„ä¼ æ’­</strong>ã€‚æˆ‘ä»¬å…ˆæ¥å›é¡¾ä¸‹ Outbound äº‹ä»¶çš„å®šä¹‰ï¼š</p>
<blockquote>
<p>è€è‰¿è‰¿ï¼šA01ã€A02 ç­‰ç­‰ï¼Œæ˜¯æˆ‘ä»¬æ¯æ¡å®šä¹‰çš„ç¼–å·ã€‚</p>
</blockquote>
<ul>
<li><p>[x] A01ï¼šOutbound äº‹ä»¶æ˜¯ã€è¯·æ±‚ã€‘äº‹ä»¶(ç”± Connect å‘èµ·ä¸€ä¸ªè¯·æ±‚, å¹¶æœ€ç»ˆç”± Unsafe å¤„ç†è¿™ä¸ªè¯·æ±‚)</p>
<blockquote>
<p>è€è‰¿è‰¿ï¼šA01 = A02 + A03</p>
</blockquote>
</li>
<li><p>[x] A02ï¼šOutbound äº‹ä»¶çš„å‘èµ·è€…æ˜¯ Channel</p>
</li>
<li>[x] A03ï¼šOutbound äº‹ä»¶çš„å¤„ç†è€…æ˜¯ Unsafe</li>
<li>[x] A04ï¼šOutbound äº‹ä»¶åœ¨ Pipeline ä¸­çš„ä¼ è¾“æ–¹å‘æ˜¯ <code>tail</code> -&gt; <code>head</code> </li>
<li>[x] A05ï¼šåœ¨ ChannelHandler ä¸­å¤„ç†äº‹ä»¶æ—¶, å¦‚æœè¿™ä¸ª Handler ä¸æ˜¯æœ€åä¸€ä¸ª Handler ï¼Œåˆ™éœ€è¦è°ƒç”¨ <code>ctx.xxx</code> (ä¾‹å¦‚ <code>ctx.connect</code> ) å°†æ­¤äº‹ä»¶ç»§ç»­ä¼ æ’­ä¸‹å». å¦‚æœä¸è¿™æ ·åš, é‚£ä¹ˆæ­¤äº‹ä»¶çš„ä¼ æ’­ä¼šæå‰ç»ˆæ­¢.</li>
<li>[x] A06ï¼šOutbound äº‹ä»¶æµ: <code>Context.OUT_EVT</code> -&gt; <code>Connect.findContextOutbound</code> -&gt; <code>nextContext.invokeOUT_EVT</code> -&gt; <code>nextHandler.OUT_EVT</code> -&gt; <code>nextContext.OUT_EVT</code></li>
</ul>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥è·Ÿç€ä»£ç ï¼Œç†è§£æ¯æ¡å®šä¹‰ã€‚</p>
<h1 id="2-ChannelOutboundInvoker"><a href="#2-ChannelOutboundInvoker" class="headerlink" title="2. ChannelOutboundInvoker"></a>2. ChannelOutboundInvoker</h1><p>åœ¨ <code>io.netty.channel.ChannelOutboundInvoker</code> æ¥å£ä¸­ï¼Œå®šä¹‰äº†æ‰€æœ‰ Outbound äº‹ä»¶å¯¹åº”çš„æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function">ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress)</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ChannelFuture <span class="title">connect</span><span class="params">(SocketAddress remoteAddress)</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">connect</span><span class="params">(SocketAddress remoteAddress, SocketAddress localAddress)</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">connect</span><span class="params">(SocketAddress remoteAddress, ChannelPromise promise)</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">connect</span><span class="params">(SocketAddress remoteAddress, SocketAddress localAddress, ChannelPromise promise)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ChannelFuture <span class="title">disconnect</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">disconnect</span><span class="params">(ChannelPromise promise)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ChannelFuture <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">close</span><span class="params">(ChannelPromise promise)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ChannelFuture <span class="title">deregister</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">deregister</span><span class="params">(ChannelPromise promise)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ChannelOutboundInvoker <span class="title">read</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ChannelFuture <span class="title">write</span><span class="params">(Object msg)</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">write</span><span class="params">(Object msg, ChannelPromise promise)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ChannelOutboundInvoker <span class="title">flush</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ChannelFuture <span class="title">writeAndFlush</span><span class="params">(Object msg, ChannelPromise promise)</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">writeAndFlush</span><span class="params">(Object msg)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<p>è€Œ ChannelOutboundInvoker çš„<strong>éƒ¨åˆ†</strong>å­ç±»/æ¥å£å¦‚ä¸‹å›¾ï¼š</p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_06_10/01.png" title="ç±»å›¾" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_06_10/01.png" alt="ç±»å›¾"></a><span class="caption">ç±»å›¾</span></p>
<ul>
<li>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç±»å›¾ï¼Œæœ‰ Channelã€ChannelPipelineã€AbstractChannelHandlerContext éƒ½ç»§æ‰¿/å®ç°äº†è¯¥æ¥å£ã€‚é‚£è¿™æ„å‘³ç€ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚</li>
</ul>
<p>åœ¨ <a href="http://svip.iocoder.cn/Netty/bootstrap-1-server/">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” å¯åŠ¨ï¼ˆä¸€ï¼‰ä¹‹æœåŠ¡ç«¯ã€‹</a> ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° Outbound äº‹ä»¶çš„å…¶ä¸­ä¹‹ä¸€ <strong>bind</strong> ï¼Œæœ¬æ–‡å°±ä»¥ <strong>bind</strong> çš„è¿‡ç¨‹ï¼Œä½œä¸ºç¤ºä¾‹ã€‚è°ƒç”¨æ ˆå¦‚ä¸‹ï¼š</p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_06_10/02.png" title="è°ƒç”¨æ ˆ" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_06_10/02.png" alt="è°ƒç”¨æ ˆ"></a><span class="caption">è°ƒç”¨æ ˆ</span></p>
<ul>
<li><p><code>AbstractChannel#bind(SocketAddress localAddress, ChannelPromise promise)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> pipeline.bind(localAddress, promise);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>AbstractChannel#bind(SocketAddress localAddress, ChannelPromise promise)</code> æ–¹æ³•ï¼Œå®ç°çš„è‡ª ChannelOutboundInvoker æ¥å£ã€‚<ul>
<li>Channel æ˜¯ <strong>bind</strong> çš„å‘èµ·è€…ï¼Œ<strong>è¿™ç¬¦åˆ Outbound äº‹ä»¶çš„å®šä¹‰ A02</strong> ã€‚</li>
</ul>
</li>
<li>åœ¨æ–¹æ³•å†…éƒ¨ï¼Œä¼šè°ƒç”¨ <code>ChannelPipeline#bind(SocketAddress localAddress, ChannelPromise promise)</code> æ–¹æ³•ï¼Œè€Œè¿™ä¸ªæ–¹æ³•ï¼Œä¹Ÿæ˜¯å®ç°çš„è‡ª ChannelOutboundInvoker æ¥å£ã€‚<em>ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œå¯¹äº ChannelOutboundInvoker æ¥å£æ–¹æ³•çš„å®ç°ï¼ŒChannel å¯¹å®ƒçš„å®ç°ï¼Œä¼šè°ƒç”¨ ChannelPipeline çš„å¯¹åº”æ–¹æ³•</em>( ( æœ‰ä¸€ç‚¹ç»•ï¼Œèƒ–å‹ç†è§£ä¸‹ ) )ã€‚<ul>
<li>é‚£ä¹ˆæ¥å£ä¸‹ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ <code>ChannelPipeline#bind(SocketAddress localAddress, ChannelPromise promise)</code> æ–¹æ³•çš„å…·ä½“å®ç°ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="3-DefaultChannelPipeline"><a href="#3-DefaultChannelPipeline" class="headerlink" title="3. DefaultChannelPipeline"></a>3. DefaultChannelPipeline</h1><p><code>DefaultChannelPipeline#bind(SocketAddress localAddress, ChannelPromise promise)</code> æ–¹æ³•çš„å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> tail.bind(localAddress, promise);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨æ–¹æ³•å†…éƒ¨ï¼Œä¼šè°ƒç”¨ <code>TailContext#bind(SocketAddress localAddress, ChannelPromise promise)</code> æ–¹æ³•ã€‚<strong>è¿™ç¬¦åˆ Outbound äº‹ä»¶çš„å®šä¹‰ A04</strong> ã€‚<ul>
<li>å®é™…ä¸Šï¼ŒTailContext çš„è¯¥æ–¹æ³•ï¼Œç»§æ‰¿è‡ª AbstractChannelHandlerContext æŠ½è±¡ç±»ï¼Œè€Œ AbstractChannelHandlerContext å®ç°äº† ChannelOutboundInvoker æ¥å£ã€‚<em>ä»è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œå¯¹äº ChannelOutboundInvoker æ¥å£æ–¹æ³•çš„å®ç°ï¼ŒChannelPipeline å¯¹å®ƒçš„å®ç°ï¼Œä¼šè°ƒç”¨ AbstractChannelHandlerContext çš„å¯¹åº”æ–¹æ³•</em>( æœ‰ä¸€ç‚¹ç»•ï¼Œèƒ–å‹ç†è§£ä¸‹ )ã€‚</li>
</ul>
</li>
</ul>
<h1 id="4-AbstractChannelHandlerContext"><a href="#4-AbstractChannelHandlerContext" class="headerlink" title="4. AbstractChannelHandlerContext"></a>4. AbstractChannelHandlerContext</h1><p><code>AbstractChannelHandlerContext#bind(SocketAddress localAddress, ChannelPromise promise)</code> æ–¹æ³•çš„å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="function"><span class="keyword">public</span> ChannelFuture <span class="title">bind</span><span class="params">(<span class="keyword">final</span> SocketAddress localAddress, <span class="keyword">final</span> ChannelPromise promise)</span> </span>{</span><br><span class="line"> <span class="number">3</span>:     <span class="keyword">if</span> (localAddress == <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">4</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"localAddress"</span>);</span><br><span class="line"> <span class="number">5</span>:     }</span><br><span class="line"> <span class="number">6</span>:     <span class="comment">// åˆ¤æ–­æ˜¯å¦ä¸ºåˆæ³•çš„ Promise å¯¹è±¡</span></span><br><span class="line"> <span class="number">7</span>:     <span class="keyword">if</span> (isNotValidPromise(promise, <span class="keyword">false</span>)) {</span><br><span class="line"> <span class="number">8</span>:         <span class="comment">// cancelled</span></span><br><span class="line"> <span class="number">9</span>:         <span class="keyword">return</span> promise;</span><br><span class="line"><span class="number">10</span>:     }</span><br><span class="line"><span class="number">11</span>: </span><br><span class="line"><span class="number">12</span>:     <span class="comment">// è·å¾—ä¸‹ä¸€ä¸ª Outbound èŠ‚ç‚¹</span></span><br><span class="line"><span class="number">13</span>:     <span class="keyword">final</span> AbstractChannelHandlerContext next = findContextOutbound();</span><br><span class="line"><span class="number">14</span>:     <span class="comment">// è·å¾—ä¸‹ä¸€ä¸ª Outbound èŠ‚ç‚¹çš„æ‰§è¡Œå™¨</span></span><br><span class="line"><span class="number">15</span>:     EventExecutor executor = next.executor();</span><br><span class="line"><span class="number">16</span>:     <span class="comment">// è°ƒç”¨ä¸‹ä¸€ä¸ª Outbound èŠ‚ç‚¹çš„ bind æ–¹æ³•</span></span><br><span class="line"><span class="number">17</span>:     <span class="keyword">if</span> (executor.inEventLoop()) {</span><br><span class="line"><span class="number">18</span>:         next.invokeBind(localAddress, promise);</span><br><span class="line"><span class="number">19</span>:     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">20</span>:         safeExecute(executor, <span class="keyword">new</span> Runnable() {</span><br><span class="line"><span class="number">21</span>:             <span class="meta">@Override</span></span><br><span class="line"><span class="number">22</span>:             <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>{</span><br><span class="line"><span class="number">23</span>:                 next.invokeBind(localAddress, promise);</span><br><span class="line"><span class="number">24</span>:             }</span><br><span class="line"><span class="number">25</span>:         }, promise, <span class="keyword">null</span>);</span><br><span class="line"><span class="number">26</span>:     }</span><br><span class="line"><span class="number">27</span>:     <span class="keyword">return</span> promise;</span><br><span class="line"><span class="number">28</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ç¬¬ 6 è‡³ 10 è¡Œï¼šåˆ¤æ–­ <code>promise</code> æ˜¯å¦ä¸ºåˆæ³•çš„ Promise å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isNotValidPromise</span><span class="params">(ChannelPromise promise, <span class="keyword">boolean</span> allowVoidPromise)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (promise == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"promise"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Promise å·²ç»å®Œæˆ</span></span><br><span class="line">    <span class="keyword">if</span> (promise.isDone()) {</span><br><span class="line">        <span class="comment">// Check if the promise was cancelled and if so signal that the processing of the operation</span></span><br><span class="line">        <span class="comment">// should not be performed.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// See https://github.com/netty/netty/issues/2349</span></span><br><span class="line">        <span class="keyword">if</span> (promise.isCancelled()) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"promise already done: "</span> + promise);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Channel ä¸ç¬¦åˆ</span></span><br><span class="line">    <span class="keyword">if</span> (promise.channel() != channel()) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(</span><br><span class="line">                <span class="string">"promise.channel does not match: %s (expected: %s)"</span>, promise.channel(), channel()));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// DefaultChannelPromise åˆæ³• // &lt;1&gt;</span></span><br><span class="line">    <span class="keyword">if</span> (promise.getClass() == DefaultChannelPromise.class) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// ç¦æ­¢ VoidChannelPromise </span></span><br><span class="line">    <span class="keyword">if</span> (!allowVoidPromise &amp;&amp; promise <span class="keyword">instanceof</span> VoidChannelPromise) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                StringUtil.simpleClassName(VoidChannelPromise.class) + <span class="string">" not allowed for this operation"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// ç¦æ­¢ CloseFuture</span></span><br><span class="line">    <span class="keyword">if</span> (promise <span class="keyword">instanceof</span> AbstractChannel.CloseFuture) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                StringUtil.simpleClassName(AbstractChannel.CloseFuture.class) + <span class="string">" not allowed in a pipeline"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è™½ç„¶æ–¹æ³•å¾ˆé•¿ï¼Œé‡ç‚¹æ˜¯ <code>&lt;1&gt;</code> å¤„ï¼Œ<code>promise</code> çš„ç±»å‹ä¸º DefaultChannelPromise ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 13 è¡Œï¼šã€é‡è¦ã€‘è°ƒç”¨ <code>#findContextOutbound()</code> æ–¹æ³•ï¼Œè·å¾—ä¸‹ä¸€ä¸ª Outbound èŠ‚ç‚¹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> AbstractChannelHandlerContext <span class="title">findContextOutbound</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// å¾ªç¯ï¼Œå‘å‰è·å¾—ä¸€ä¸ª Outbound èŠ‚ç‚¹</span></span><br><span class="line">    AbstractChannelHandlerContext ctx = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">do</span> {</span><br><span class="line">        ctx = ctx.prev;</span><br><span class="line">    } <span class="keyword">while</span> (!ctx.outbound);</span><br><span class="line">    <span class="keyword">return</span> ctx;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¾ªç¯ï¼Œ<strong>å‘å‰</strong>è·å¾—ä¸€ä¸ª Outbound èŠ‚ç‚¹ã€‚</li>
<li>å¾ªç¯ï¼Œ<strong>å‘å‰</strong>è·å¾—ä¸€ä¸ª Outbound èŠ‚ç‚¹ã€‚</li>
<li>å¾ªç¯ï¼Œ<strong>å‘å‰</strong>è·å¾—ä¸€ä¸ª Outbound èŠ‚ç‚¹ã€‚</li>
<li>ğŸ˜ˆ é‡è¦çš„äº‹æƒ…è¯´ä¸‰éï¼Œå¯¹äº Outbound äº‹ä»¶çš„ä¼ æ’­ï¼Œæ˜¯ä» pipeline çš„å°¾å·´åˆ°å¤´éƒ¨ï¼Œ<strong>è¿™ç¬¦åˆ Outbound äº‹ä»¶çš„å®šä¹‰ A04</strong> ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 15 è¡Œï¼šè°ƒç”¨ <code>AbstractChannelHandlerContext#executor()</code> æ–¹æ³•ï¼Œè·å¾—ä¸‹ä¸€ä¸ª Outbound èŠ‚ç‚¹çš„æ‰§è¡Œå™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// Will be set to null if no child executor should be used, otherwise it will be set to the</span></span><br><span class="line"><span class="comment">// child executor.</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * EventExecutor å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> EventExecutor executor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> EventExecutor <span class="title">executor</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (executor == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> channel().eventLoop();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> executor;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¦‚æœæœªè®¾ç½®<strong>å­æ‰§è¡Œå™¨</strong>ï¼Œåˆ™ä½¿ç”¨ Channel çš„ EventLoop ä½œä¸ºæ‰§è¡Œå™¨ã€‚ğŸ˜ˆ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å¿½ç•¥<strong>å­æ‰§è¡Œå™¨</strong>çš„é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥ç›´æ¥è®¤ä¸ºæ˜¯ä½¿ç”¨ <strong>Channel çš„ EventLoop ä½œä¸ºæ‰§è¡Œå™¨</strong>ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 16 è‡³ 26 è¡Œï¼š<strong>åœ¨ EventLoop çš„çº¿ç¨‹ä¸­</strong>ï¼Œè°ƒç”¨<strong>ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</strong>çš„ <code>AbstractChannelHandlerContext#invokeBind(SocketAddress localAddress, ChannelPromise promise)</code> æ–¹æ³•ï¼Œä¼ æ’­ <strong>bind</strong> äº‹ä»¶ç»™<strong>ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</strong>ã€‚</p>
<ul>
<li><p>ç¬¬ 20 è‡³ 25 è¡Œï¼šå¦‚æœä¸åœ¨ EventLoop çš„çº¿ç¨‹ä¸­ï¼Œä¼šè°ƒç”¨ <code>#safeExecute(EventExecutor executor, Runnable runnable, ChannelPromise promise, Object msg)</code> æ–¹æ³•ï¼Œæäº¤åˆ° EventLoop çš„çº¿ç¨‹ä¸­æ‰§è¡Œã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">safeExecute</span><span class="params">(EventExecutor executor, Runnable runnable, ChannelPromise promise, Object msg)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// æäº¤ EventLoop çš„çº¿ç¨‹ä¸­ï¼Œè¿›è¡Œæ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">        executor.execute(runnable);</span><br><span class="line">    } <span class="keyword">catch</span> (Throwable cause) {</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// å‘ç”Ÿå¼‚å¸¸ï¼Œå›è°ƒé€šçŸ¥ promise ç›¸å…³çš„å¼‚å¸¸</span></span><br><span class="line">            promise.setFailure(cause);</span><br><span class="line">        } <span class="keyword">finally</span> {</span><br><span class="line">            <span class="comment">// é‡Šæ”¾ msg ç›¸å…³çš„èµ„æº</span></span><br><span class="line">            <span class="keyword">if</span> (msg != <span class="keyword">null</span>) {</span><br><span class="line">                ReferenceCountUtil.release(msg);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>x</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p><code>AbstractChannelHandlerContext#invokeBind(SocketAddress localAddress, ChannelPromise promise)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">invokeBind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (invokeHandler()) { <span class="comment">// åˆ¤æ–­æ˜¯å¦ç¬¦åˆçš„ ChannelHandler</span></span><br><span class="line"> <span class="number">3</span>:         <span class="keyword">try</span> {</span><br><span class="line"> <span class="number">4</span>:             <span class="comment">// è°ƒç”¨è¯¥ ChannelHandler çš„ bind æ–¹æ³•</span></span><br><span class="line"> <span class="number">5</span>:             ((ChannelOutboundHandler) handler()).bind(<span class="keyword">this</span>, localAddress, promise);</span><br><span class="line"> <span class="number">6</span>:         } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line"> <span class="number">7</span>:             notifyOutboundHandlerException(t, promise); <span class="comment">// é€šçŸ¥ Outbound äº‹ä»¶çš„ä¼ æ’­ï¼Œå‘ç”Ÿå¼‚å¸¸</span></span><br><span class="line"> <span class="number">8</span>:         }</span><br><span class="line"> <span class="number">9</span>:     } <span class="keyword">else</span> {</span><br><span class="line"><span class="number">10</span>:         <span class="comment">// è·³è¿‡ï¼Œä¼ æ’­ Outbound äº‹ä»¶ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="number">11</span>:         bind(localAddress, promise);</span><br><span class="line"><span class="number">12</span>:     }</span><br><span class="line"><span class="number">13</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ç¬¬ 2 è¡Œï¼šè°ƒç”¨ <code>#invokeHandler()</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦ç¬¦åˆçš„ ChannelHandler ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Makes best possible effort to detect if {<span class="doctag">@link</span> ChannelHandler#handlerAdded(ChannelHandlerContext)} was called</span></span><br><span class="line"><span class="comment"> * yet. If not return {<span class="doctag">@code</span> false} and if called or could not detect return {<span class="doctag">@code</span> true}.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * If this method returns {<span class="doctag">@code</span> false} we will not invoke the {<span class="doctag">@link</span> ChannelHandler} but just forward the event.</span></span><br><span class="line"><span class="comment"> * This is needed as {<span class="doctag">@link</span> DefaultChannelPipeline} may already put the {<span class="doctag">@link</span> ChannelHandler} in the linked-list</span></span><br><span class="line"><span class="comment"> * but not called {<span class="doctag">@link</span> ChannelHandler#handlerAdded(ChannelHandlerContext)}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">invokeHandler</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// Store in local variable to reduce volatile reads.</span></span><br><span class="line">    <span class="keyword">int</span> handlerState = <span class="keyword">this</span>.handlerState;</span><br><span class="line">    <span class="keyword">return</span> handlerState == ADD_COMPLETE || (!ordered &amp;&amp; handlerState == ADD_PENDING);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¯¹äº <code>ordered = true</code> çš„èŠ‚ç‚¹ï¼Œå¿…é¡» ChannelHandler å·²ç»æ·»åŠ å®Œæˆã€‚</li>
<li>å¯¹äº <code>ordered = false</code> çš„èŠ‚ç‚¹ï¼Œæ²¡æœ‰ ChannelHandler çš„è¦æ±‚ã€‚</li>
</ul>
</li>
<li>ç¬¬ 9 è‡³ 12 è¡Œï¼šè‹¥æ˜¯<strong>ä¸ç¬¦åˆ</strong>çš„ ChannelHandler ï¼Œåˆ™<strong>è·³è¿‡</strong>è¯¥èŠ‚ç‚¹ï¼Œè°ƒç”¨ <code>AbstractChannelHandlerContext#bind(SocketAddress localAddress, ChannelPromise promise)</code> æ–¹æ³•ï¼Œä¼ æ’­ Outbound äº‹ä»¶ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚å³ï¼Œåˆå›åˆ° <a href="#">ã€Œ4. AbstractChannelHandlerContextã€</a> çš„å¼€å¤´ã€‚</li>
<li><p>ç¬¬ 2 è‡³ 8 è¡Œï¼šè‹¥æ˜¯<strong>ç¬¦åˆ</strong>çš„ ChannelHandler ï¼š</p>
<ul>
<li><p>ç¬¬ 5 è¡Œï¼šè°ƒç”¨ ChannelHandler çš„ <code>#bind(ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise)</code> æ–¹æ³•ï¼Œå¤„ç† bind äº‹ä»¶ã€‚</p>
<ul>
<li><p>ğŸ˜ˆ å®é™…ä¸Šï¼Œæ­¤æ—¶èŠ‚ç‚¹çš„æ•°æ®ç±»å‹ä¸º DefaultChannelHandlerContext ç±»ã€‚è‹¥å®ƒè¢«è®¤ä¸ºæ˜¯ Outbound èŠ‚ç‚¹ï¼Œé‚£ä¹ˆä»–çš„å¤„ç†å™¨çš„ç±»å‹ä¼šæ˜¯ <strong>ChannelOutboundHandler</strong> ã€‚è€Œ <code>io.netty.channel.ChannelOutboundHandler</code> ç±»ä¼¼ ChannelOutboundInvoker ï¼Œå®šä¹‰äº†å¯¹æ¯ä¸ª Outbound äº‹ä»¶çš„å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">bind</span><span class="params">(ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">connect</span><span class="params">(ChannelHandlerContext ctx, SocketAddress remoteAddress, SocketAddress localAddress, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">disconnect</span><span class="params">(ChannelHandlerContext ctx, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">close</span><span class="params">(ChannelHandlerContext ctx, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deregister</span><span class="params">(ChannelHandlerContext ctx, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">flush</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>èƒ–å‹è‡ªå·±å¯¹æ¯”ä¸‹å™¢ã€‚</li>
</ul>
</li>
<li><p>å¦‚æœèŠ‚ç‚¹çš„ <code>ChannelOutboundHandler#bind(ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise)</code> æ–¹æ³•çš„å®ç°ï¼Œä¸è°ƒç”¨ <code>AbstractChannelHandlerContext#bind(SocketAddress localAddress, ChannelPromise promise)</code> æ–¹æ³•ï¼Œå°±ä¸ä¼šä¼ æ’­ Outbound äº‹ä»¶ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚<strong>è¿™å°±æ˜¯ Outbound äº‹ä»¶çš„å®šä¹‰ A05</strong> ã€‚å¯èƒ½æœ‰ç‚¹ç»•ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹ Netty LoggingHandler å¯¹è¯¥æ–¹æ³•çš„å®ç°ä»£ç ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggingHandler</span> <span class="keyword">implements</span> <span class="title">ChannelInboundHandler</span>, <span class="title">ChannelOutboundHandler</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... çœç•¥æ— å…³æ–¹æ³•</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">        <span class="comment">// æ‰“å°æ—¥å¿—</span></span><br><span class="line">        log(Event.BIND, <span class="string">"localAddress="</span> + localAddress);</span><br><span class="line">        <span class="comment">// ä¼ é€’ bind äº‹ä»¶ï¼Œç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        ctx.bind(localAddress, promise); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¦‚æœæŠŠ <code>&lt;1&gt;</code> å¤„çš„ä»£ç å»æ‰ï¼Œbind äº‹ä»¶å°†ä¸ä¼šä¼ æ’­ç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ï¼ï¼<strong>ä¸€å®šè¦æ³¨æ„</strong>ã€‚</li>
</ul>
</li>
<li>è¿™å—çš„é€»è¾‘éå¸¸é‡è¦ï¼Œå¦‚æœèƒ–å‹è§‰å¾—å¾ˆç»•ï¼Œä¸€å®šè¦è‡ªå·±å¤šè°ƒè¯• + è°ƒè¯• + è°ƒè¯•ã€‚</li>
</ul>
</li>
<li>ç¬¬ 7 è¡Œï¼šå¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œè°ƒç”¨ <code>#notifyOutboundHandlerException(Throwable, Promise)</code> æ–¹æ³•ï¼Œé€šçŸ¥ Outbound äº‹ä»¶çš„ä¼ æ’­ï¼Œå‘ç”Ÿå¼‚å¸¸ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/ChannelPipeline-6-exception">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” ChannelPipelineï¼ˆå…­ï¼‰ä¹‹å¼‚å¸¸äº‹ä»¶çš„ä¼ æ’­ã€‹</a> ã€‚</li>
</ul>
</li>
</ul>
<hr>
<p>æœ¬å°èŠ‚çš„æ•´ä¸ªä»£ç å®ç°ï¼Œ<strong>å°±æ˜¯ Outbound äº‹ä»¶çš„å®šä¹‰ A06</strong>çš„ä½“ç°ã€‚è€Œéšç€ Outbound äº‹ä»¶åœ¨èŠ‚ç‚¹ä¸æ–­ä» pipeline çš„å°¾éƒ¨åˆ°å¤´éƒ¨çš„ä¼ æ’­ï¼Œæœ€ç»ˆä¼šåˆ°è¾¾ HeadContext èŠ‚ç‚¹ã€‚</p>
<h1 id="5-HeadContext"><a href="#5-HeadContext" class="headerlink" title="5. HeadContext"></a>5. HeadContext</h1><p><code>HeadContext#bind(ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    unsafe.bind(localAddress, promise);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è°ƒç”¨ <code>Unsafe#bind(SocketAddress localAddress, ChannelPromise promise)</code> æ–¹æ³•ï¼Œè¿›è¡Œ bind äº‹ä»¶çš„å¤„ç†ã€‚ä¹Ÿå°±æ˜¯è¯´ Unsafe æ˜¯ <strong>bind</strong> çš„å¤„ç†ç€ï¼Œ<strong>è¿™ç¬¦åˆ Outbound äº‹ä»¶çš„å®šä¹‰ A03</strong> ã€‚</li>
<li>è€Œåç»­çš„é€»è¾‘ï¼Œå°±æ˜¯ <a href="http://svip.iocoder.cn/Netty/bootstrap-1-server/">ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” å¯åŠ¨ï¼ˆä¸€ï¼‰ä¹‹æœåŠ¡ç«¯ã€‹</a> çš„ <a href="#"> ã€Œ3.13.2 doBind0ã€</a> å°èŠ‚ï¼Œä» <code>Unsafe#bind(SocketAddress localAddress, ChannelPromise promise)</code> æ–¹æ³•ï¼Œå¼€å§‹ã€‚</li>
<li>è‡³æ­¤ï¼Œæ•´ä¸ª pipeline çš„ Outbound äº‹ä»¶çš„ä¼ æ’­ç»“æŸã€‚</li>
</ul>
<h1 id="6-å…³äºå…¶ä»–-Outbound-äº‹ä»¶"><a href="#6-å…³äºå…¶ä»–-Outbound-äº‹ä»¶" class="headerlink" title="6. å…³äºå…¶ä»– Outbound äº‹ä»¶"></a>6. å…³äºå…¶ä»– Outbound äº‹ä»¶</h1><p>æœ¬æ–‡æš‚æ—¶åªåˆ†äº«äº† <strong>bind</strong> è¿™ä¸ª Outbound äº‹ä»¶ã€‚å‰©ä½™çš„å…¶ä»–äº‹ä»¶ï¼Œèƒ–å‹å¯ä»¥è‡ªå·±è¿›è¡Œè°ƒè¯•å’Œç†è§£ã€‚ä¾‹å¦‚ï¼š<strong>connect</strong> äº‹ä»¶ï¼Œå¹¶ä¸”ç»“åˆ <a href="http://svip.iocoder.cn/Netty/bootstrap-2-client/">ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” å¯åŠ¨ï¼ˆäºŒï¼‰ä¹‹å®¢æˆ·ç«¯ã€‹</a> ä¸€æ–‡ã€‚</p>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>*æ¨èé˜…è¯»æ–‡ç« ï¼š</p>
<ul>
<li>é—ªç”µä¾  <a href="https://www.jianshu.com/p/087b7e9a27a2" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnetty æºç åˆ†æä¹‹ pipeline(äºŒ)ã€‹</a>*</li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/Pipeline-4-outbound/" data-id="ck4pl3foy00dlfgcf4lhdb16h" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>