<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ ByteBufAllocatorï¼ˆä¸€ï¼‰ç®€ä»‹
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥åˆ†äº« ByteBufAllocator ã€‚å®ƒæ˜¯ ByteBuf çš„åˆ†é…å™¨ï¼Œè´Ÿè´£åˆ›å»º ByteBuf å¯¹è±¡ã€‚å®ƒçš„å­ç±»ç±»å›¾å¦‚ä¸‹ï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_08_20/01.png" title="ç±»å›¾" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_08_20/01.png" alt="ç±»å›¾"></a><span class="caption">ç±»å›¾</span></p>
<p>ä¸»è¦æœ‰ä¸‰ä¸ªå­ç±»ï¼š</p>
<ul>
<li>PreferHeapByteBufAllocator ï¼Œå€¾å‘åˆ›å»º <strong>Heap</strong> ByteBuf çš„åˆ†é…å™¨ã€‚</li>
<li>PooledByteBufAllocator ï¼ŒåŸºäº<strong>å†…å­˜æ± </strong>çš„ ByteBuf çš„åˆ†é…å™¨ã€‚</li>
<li>UnpooledByteBufAllocator ï¼Œ<strong>æ™®é€š</strong>çš„ ByteBuf çš„åˆ†é…å™¨ã€‚</li>
</ul>
<p>æœ¬æ–‡åˆ†äº«ä¸Šé¢ç±»å›¾çº¢æ¡†éƒ¨åˆ†ï¼Œåé¢ä¸¤ç¯‡æ–‡ç« å†åˆ†åˆ«åˆ†äº« UnpooledByteBufAllocator å’Œ PooledByteBufAllocator ã€‚</p>
<h1 id="2-ByteBufAllocator"><a href="#2-ByteBufAllocator" class="headerlink" title="2. ByteBufAllocator"></a>2. ByteBufAllocator</h1><p><code>io.netty.buffer.ByteBufAllocator</code> ï¼ŒByteBuf åˆ†é…å™¨<strong>æ¥å£</strong>ã€‚</p>
<p>è¿˜æ˜¯è€æ ·å­ï¼Œæˆ‘ä»¬é€ä¸ªæ¥çœ‹çœ‹æ¯ä¸ªæ–¹æ³•ã€‚</p>
<h2 id="2-1-DEFAULT"><a href="#2-1-DEFAULT" class="headerlink" title="2.1 DEFAULT"></a>2.1 DEFAULT</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">ByteBufAllocator DEFAULT = ByteBufUtil.DEFAULT_ALLOCATOR;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>é»˜è®¤ ByteBufAllocator å¯¹è±¡ï¼Œé€šè¿‡ <code>ByteBufUtil.DEFAULT_ALLOCATOR</code> ä¸­è·å¾—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> ByteBufAllocator DEFAULT_ALLOCATOR;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> {</span><br><span class="line">    <span class="comment">// è¯»å– ByteBufAllocator é…ç½®</span></span><br><span class="line">    String allocType = SystemPropertyUtil.get(<span class="string">"io.netty.allocator.type"</span>, PlatformDependent.isAndroid() ? <span class="string">"unpooled"</span> : <span class="string">"pooled"</span>);</span><br><span class="line">    allocType = allocType.toLowerCase(Locale.US).trim();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å– ByteBufAllocator å¯¹è±¡</span></span><br><span class="line">    ByteBufAllocator alloc;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">"unpooled"</span>.equals(allocType)) {</span><br><span class="line">        alloc = UnpooledByteBufAllocator.DEFAULT;</span><br><span class="line">        logger.debug(<span class="string">"-Dio.netty.allocator.type: {}"</span>, allocType);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"pooled"</span>.equals(allocType)) {</span><br><span class="line">        alloc = PooledByteBufAllocator.DEFAULT;</span><br><span class="line">        logger.debug(<span class="string">"-Dio.netty.allocator.type: {}"</span>, allocType);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        alloc = PooledByteBufAllocator.DEFAULT;</span><br><span class="line">        logger.debug(<span class="string">"-Dio.netty.allocator.type: pooled (unknown: {})"</span>, allocType);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    DEFAULT_ALLOCATOR = alloc;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... çœç•¥æ— å…³ä»£ç </span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨é Android ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨ PooledByteBufAllocator ä½œä¸ºé»˜è®¤  ByteBufAllocator å¯¹è±¡ã€‚</li>
<li>åœ¨ Android ç¯å¢ƒä¸‹ï¼Œä½¿ç”¨ UnpooledByteBufAllocator ä½œä¸ºé»˜è®¤  ByteBufAllocator å¯¹è±¡ã€‚å› ä¸º Android å®¢æˆ·ç«¯çš„å†…å­˜ç›¸å¯¹æœ‰é™ã€‚</li>
</ul>
</li>
</ul>
<h2 id="2-2-buffer"><a href="#2-2-buffer" class="headerlink" title="2.2 buffer"></a>2.2 buffer</h2><p><code>#buffer(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª ByteBuf å¯¹è±¡ã€‚å…·ä½“åˆ›å»ºçš„æ˜¯ Heap ByteBuf è¿˜æ˜¯ Direct ByteBuf ï¼Œç”±å®ç°ç±»å†³å®šã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Allocate a {<span class="doctag">@link</span> ByteBuf}. If it is a direct or heap buffer</span></span><br><span class="line"><span class="comment"> * depends on the actual implementation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">ByteBuf <span class="title">buffer</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ByteBuf <span class="title">buffer</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span></span>;</span><br><span class="line"><span class="function">ByteBuf <span class="title">buffer</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-2-1-ioBuffer"><a href="#2-2-1-ioBuffer" class="headerlink" title="2.2.1 ioBuffer"></a>2.2.1 ioBuffer</h3><p><code>#ioBuffer(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ªç”¨äº IO æ“ä½œçš„ ByteBuf å¯¹è±¡ã€‚å€¾å‘äº Direct ByteBuf ï¼Œå› ä¸ºå¯¹äº IO æ“ä½œæ¥è¯´ï¼Œæ€§èƒ½æ›´ä¼˜ã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Allocate a {<span class="doctag">@link</span> ByteBuf}, preferably a direct buffer which is suitable for I/O.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">ByteBuf <span class="title">ioBuffer</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ByteBuf <span class="title">ioBuffer</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span></span>;</span><br><span class="line"><span class="function">ByteBuf <span class="title">ioBuffer</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-2-2-heapBuffer"><a href="#2-2-2-heapBuffer" class="headerlink" title="2.2.2 heapBuffer"></a>2.2.2 heapBuffer</h3><p><code>#heapBuffer(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª Heap Buffer å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Allocate a heap {<span class="doctag">@link</span> ByteBuf}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">ByteBuf <span class="title">heapBuffer</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ByteBuf <span class="title">heapBuffer</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span></span>;</span><br><span class="line"><span class="function">ByteBuf <span class="title">heapBuffer</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-2-3-directBuffer"><a href="#2-2-3-directBuffer" class="headerlink" title="2.2.3 directBuffer"></a>2.2.3 directBuffer</h3><p><code>#directBuffer(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª Direct Buffer å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Allocate a direct {<span class="doctag">@link</span> ByteBuf} with the given initial capacity.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">ByteBuf <span class="title">directBuffer</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span></span>;</span><br><span class="line"><span class="function">ByteBuf <span class="title">directBuffer</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity)</span></span>;</span><br><span class="line"><span class="function">CompositeByteBuf <span class="title">compositeBuffer</span><span class="params">()</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-3-compositeBuffer"><a href="#2-3-compositeBuffer" class="headerlink" title="2.3 compositeBuffer"></a>2.3 compositeBuffer</h2><p><code>#compositeBuffer(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª Composite ByteBuf å¯¹è±¡ã€‚å…·ä½“åˆ›å»ºçš„æ˜¯ Heap ByteBuf è¿˜æ˜¯ Direct ByteBuf ï¼Œç”±å®ç°ç±»å†³å®šã€‚</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Allocate a {<span class="doctag">@link</span> CompositeByteBuf}.</span></span><br><span class="line"><span class="comment"> * If it is a direct or heap buffer depends on the actual implementation.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">CompositeByteBuf <span class="title">compositeBuffer</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">CompositeByteBuf <span class="title">compositeBuffer</span><span class="params">(<span class="keyword">int</span> maxNumComponents)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-3-1-compositeHeapBuffer"><a href="#2-3-1-compositeHeapBuffer" class="headerlink" title="2.3.1 compositeHeapBuffer"></a>2.3.1 compositeHeapBuffer</h3><p><code>#compositeHeapBuffer(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª Composite Heap ByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Allocate a heap {<span class="doctag">@link</span> CompositeByteBuf}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">CompositeByteBuf <span class="title">compositeHeapBuffer</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">CompositeByteBuf <span class="title">compositeHeapBuffer</span><span class="params">(<span class="keyword">int</span> maxNumComponents)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="2-3-2-compositeDirectBuffer"><a href="#2-3-2-compositeDirectBuffer" class="headerlink" title="2.3.2 compositeDirectBuffer"></a>2.3.2 compositeDirectBuffer</h3><p><code>#compositeDirectBuffer(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºä¸€ä¸ª Composite Direct ByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Allocate a direct {<span class="doctag">@link</span> CompositeByteBuf}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">CompositeByteBuf <span class="title">compositeDirectBuffer</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">CompositeByteBuf <span class="title">compositeDirectBuffer</span><span class="params">(<span class="keyword">int</span> maxNumComponents)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-4-isDirectBufferPooled"><a href="#2-4-isDirectBufferPooled" class="headerlink" title="2.4 isDirectBufferPooled"></a>2.4 isDirectBufferPooled</h2><p><code>#isDirectBufferPooled()</code> æ–¹æ³•ï¼Œæ˜¯å¦åŸºäº Direct ByteBuf å¯¹è±¡æ± ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns {<span class="doctag">@code</span> true} if direct {<span class="doctag">@link</span> ByteBuf}'s are pooled</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isDirectBufferPooled</span><span class="params">()</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-5-calculateNewCapacity"><a href="#2-5-calculateNewCapacity" class="headerlink" title="2.5 calculateNewCapacity"></a>2.5 calculateNewCapacity</h2><p><code>#calculateNewCapacity(int minNewCapacity, int maxCapacity)</code> æ–¹æ³•ï¼Œåœ¨ ByteBuf æ‰©å®¹æ—¶ï¼Œè®¡ç®—æ–°çš„å®¹é‡ï¼Œè¯¥å®¹é‡çš„å€¼åœ¨ <code>[minNewCapacity, maxCapacity]</code> èŒƒå›´å†…ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Calculate the new capacity of a {<span class="doctag">@link</span> ByteBuf} that is used when a {<span class="doctag">@link</span> ByteBuf} needs to expand by the</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@code</span> minNewCapacity} with {<span class="doctag">@code</span> maxCapacity} as upper-bound.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">calculateNewCapacity</span><span class="params">(<span class="keyword">int</span> minNewCapacity, <span class="keyword">int</span> maxCapacity)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<h1 id="3-AbstractByteBufAllocator"><a href="#3-AbstractByteBufAllocator" class="headerlink" title="3. AbstractByteBufAllocator"></a>3. AbstractByteBufAllocator</h1><p><code>io.netty.buffer.AbstractByteBufAllocator</code> ï¼Œå®ç° ByteBufAllocator æ¥å£ï¼ŒByteBufAllocator æŠ½è±¡å®ç°ç±»ï¼Œä¸º PooledByteBufAllocator å’Œ UnpooledByteBufAllocator æä¾›å…¬å…±çš„æ–¹æ³•ã€‚</p>
<h2 id="3-1-æ„é€ æ–¹æ³•"><a href="#3-1-æ„é€ æ–¹æ³•" class="headerlink" title="3.1 æ„é€ æ–¹æ³•"></a>3.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦å€¾å‘åˆ›å»º Direct ByteBuf</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> directByDefault;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç©º ByteBuf ç¼“å­˜</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ByteBuf emptyBuf;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Instance use heap buffers by default</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">AbstractByteBufAllocator</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>(<span class="keyword">false</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create new instance</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> preferDirect {<span class="doctag">@code</span> true} if {<span class="doctag">@link</span> #buffer(int)} should try to allocate a direct buffer rather than</span></span><br><span class="line"><span class="comment"> *                     a heap buffer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">AbstractByteBufAllocator</span><span class="params">(<span class="keyword">boolean</span> preferDirect)</span> </span>{</span><br><span class="line">    directByDefault = preferDirect &amp;&amp; PlatformDependent.hasUnsafe(); <span class="comment">// æ”¯æŒ Unsafe</span></span><br><span class="line">    emptyBuf = <span class="keyword">new</span> EmptyByteBuf(<span class="keyword">this</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>directByDefault</code> å±æ€§ï¼Œæ˜¯å¦å€¾å‘åˆ›å»º Direct ByteBuf ã€‚æœ‰ä¸€ä¸ªå‰ææ˜¯éœ€è¦æ”¯æŒ Unsafe æ“ä½œã€‚</li>
<li><code>emptyBuf</code> å±æ€§ï¼Œç©º ByteBuf ç¼“å­˜å¯¹è±¡ã€‚ç”¨äº <code>#buffer()</code> ç­‰æ–¹æ³•ï¼Œåˆ›å»º<strong>ç©º</strong> ByteBuf å¯¹è±¡æ—¶ã€‚</li>
</ul>
<h2 id="3-2-buffer"><a href="#3-2-buffer" class="headerlink" title="3.2 buffer"></a>3.2 buffer</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">buffer</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (directByDefault) {</span><br><span class="line">        <span class="keyword">return</span> directBuffer();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> heapBuffer();</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">buffer</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (directByDefault) {</span><br><span class="line">        <span class="keyword">return</span> directBuffer(initialCapacity);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> heapBuffer(initialCapacity);</span><br><span class="line">}</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">buffer</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (directByDefault) {</span><br><span class="line">        <span class="keyword">return</span> directBuffer(initialCapacity, maxCapacity);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> heapBuffer(initialCapacity, maxCapacity);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ ¹æ® <code>directByDefault</code> çš„å€¼ï¼Œè°ƒç”¨ <code>#directBuffer(...)</code> æ–¹æ³•ï¼Œè¿˜æ˜¯è°ƒç”¨ <code>#heapBuffer(...)</code> æ–¹æ³•ã€‚</li>
</ul>
<h3 id="3-2-1-ioBuffer"><a href="#3-2-1-ioBuffer" class="headerlink" title="3.2.1 ioBuffer"></a>3.2.1 ioBuffer</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é»˜è®¤å®¹é‡å¤§å°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">256</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">ioBuffer</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (PlatformDependent.hasUnsafe()) {</span><br><span class="line">        <span class="keyword">return</span> directBuffer(DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> heapBuffer(DEFAULT_INITIAL_CAPACITY);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">ioBuffer</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (PlatformDependent.hasUnsafe()) {</span><br><span class="line">        <span class="keyword">return</span> directBuffer(initialCapacity);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> heapBuffer(initialCapacity);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">ioBuffer</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (PlatformDependent.hasUnsafe()) {</span><br><span class="line">        <span class="keyword">return</span> directBuffer(initialCapacity, maxCapacity);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> heapBuffer(initialCapacity, maxCapacity);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ ¹æ®æ˜¯å¦æ”¯æŒ Unsafe æ“ä½œçš„æƒ…å†µï¼Œè°ƒç”¨ <code>#directBuffer(...)</code> æ–¹æ³•ï¼Œè¿˜æ˜¯è°ƒç”¨ <code>#heapBuffer(...)</code> æ–¹æ³•ã€‚</li>
</ul>
<h3 id="3-2-2-heapBuffer"><a href="#3-2-2-heapBuffer" class="headerlink" title="3.2.2 heapBuffer"></a>3.2.2 heapBuffer</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é»˜è®¤æœ€å¤§å®¹é‡å¤§å°ï¼Œæ— é™ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_MAX_CAPACITY = Integer.MAX_VALUE;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">heapBuffer</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> heapBuffer(DEFAULT_INITIAL_CAPACITY, DEFAULT_MAX_CAPACITY);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">heapBuffer</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> heapBuffer(initialCapacity, DEFAULT_MAX_CAPACITY);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">heapBuffer</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">    <span class="comment">// ç©º ByteBuf å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity == <span class="number">0</span> &amp;&amp; maxCapacity == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> emptyBuf;</span><br><span class="line">    }</span><br><span class="line">    validate(initialCapacity, maxCapacity); <span class="comment">// æ ¡éªŒå®¹é‡çš„å‚æ•°</span></span><br><span class="line">    <span class="comment">// åˆ›å»º Heap ByteBuf å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> newHeapBuffer(initialCapacity, maxCapacity);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>æœ€ç»ˆè°ƒç”¨ <code>#newHeapBuffer(int initialCapacity, int maxCapacity)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œåˆ›å»º Heap ByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a heap {<span class="doctag">@link</span> ByteBuf} with the given initialCapacity and maxCapacity.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> ByteBuf <span class="title">newHeapBuffer</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å› ä¸ºæ˜¯å¦åŸºäºå¯¹è±¡æ± çš„æ–¹å¼ï¼Œåˆ›å»º Heap ByteBuf å¯¹è±¡çš„å®ç°ä¼šä¸åŒï¼Œæ‰€ä»¥éœ€è¦æŠ½è±¡ã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-2-3-directBuffer"><a href="#3-2-3-directBuffer" class="headerlink" title="3.2.3 directBuffer"></a>3.2.3 directBuffer</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">directBuffer</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> directBuffer(DEFAULT_INITIAL_CAPACITY, DEFAULT_MAX_CAPACITY);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">directBuffer</span><span class="params">(<span class="keyword">int</span> initialCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> directBuffer(initialCapacity, DEFAULT_MAX_CAPACITY);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">directBuffer</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">    <span class="comment">// ç©º ByteBuf å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity == <span class="number">0</span> &amp;&amp; maxCapacity == <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> emptyBuf;</span><br><span class="line">    }</span><br><span class="line">    validate(initialCapacity, maxCapacity); <span class="comment">// æ ¡éªŒå®¹é‡çš„å‚æ•°</span></span><br><span class="line">    <span class="comment">// åˆ›å»º Direct ByteBuf å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> newDirectBuffer(initialCapacity, maxCapacity);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>æœ€ç»ˆè°ƒç”¨ <code>#newDirectBuffer(int initialCapacity, int maxCapacity)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œåˆ›å»º Direct ByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create a direct {<span class="doctag">@link</span> ByteBuf} with the given initialCapacity and maxCapacity.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> ByteBuf <span class="title">newDirectBuffer</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">int</span> maxCapacity)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å› ä¸ºæ˜¯å¦åŸºäºå¯¹è±¡æ± çš„æ–¹å¼ï¼Œåˆ›å»º Direct ByteBuf å¯¹è±¡çš„å®ç°ä¼šä¸åŒï¼Œæ‰€ä»¥éœ€è¦æŠ½è±¡ã€‚</li>
</ul>
</li>
</ul>
<h2 id="3-3-compositeBuffer"><a href="#3-3-compositeBuffer" class="headerlink" title="3.3 compositeBuffer"></a>3.3 compositeBuffer</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CompositeByteBuf <span class="title">compositeBuffer</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (directByDefault) {</span><br><span class="line">        <span class="keyword">return</span> compositeDirectBuffer();</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> compositeHeapBuffer();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CompositeByteBuf <span class="title">compositeBuffer</span><span class="params">(<span class="keyword">int</span> maxNumComponents)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (directByDefault) {</span><br><span class="line">        <span class="keyword">return</span> compositeDirectBuffer(maxNumComponents);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> compositeHeapBuffer(maxNumComponents);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ ¹æ® <code>directByDefault</code> çš„å€¼ï¼Œè°ƒç”¨ <code>#compositeDirectBuffer(...)</code> æ–¹æ³•ï¼Œè¿˜æ˜¯è°ƒç”¨ <code>#compositeHeapBuffer(...)</code> æ–¹æ³•ã€‚</li>
</ul>
<h3 id="3-3-1-compositeHeapBuffer"><a href="#3-3-1-compositeHeapBuffer" class="headerlink" title="3.3.1 compositeHeapBuffer"></a>3.3.1 compositeHeapBuffer</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Composite ByteBuf å¯åŒ…å«çš„ ByteBuf çš„æœ€å¤§æ•°é‡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_MAX_COMPONENTS = <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CompositeByteBuf <span class="title">compositeHeapBuffer</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> compositeHeapBuffer(DEFAULT_MAX_COMPONENTS);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CompositeByteBuf <span class="title">compositeHeapBuffer</span><span class="params">(<span class="keyword">int</span> maxNumComponents)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> toLeakAwareBuffer(<span class="keyword">new</span> CompositeByteBuf(<span class="keyword">this</span>, <span class="keyword">false</span>, maxNumComponents));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åˆ›å»º CompositeByteBuf å¯¹è±¡ï¼Œå¹¶ä¸”æ–¹æ³•å‚æ•° <code>direct</code> ä¸º <code>false</code> ï¼Œè¡¨ç¤º Heap ç±»å‹ã€‚</li>
<li>è°ƒç”¨ <code>#toLeakAwareBuffer(CompositeByteBuf)</code> æ–¹æ³•ï¼Œè£…é¥°æˆ LeakAware çš„ ByteBuf å¯¹è±¡ã€‚</li>
</ul>
<h3 id="3-3-2-compositeDirectBuffer"><a href="#3-3-2-compositeDirectBuffer" class="headerlink" title="3.3.2 compositeDirectBuffer"></a>3.3.2 compositeDirectBuffer</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CompositeByteBuf <span class="title">compositeDirectBuffer</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> compositeDirectBuffer(DEFAULT_MAX_COMPONENTS);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CompositeByteBuf <span class="title">compositeDirectBuffer</span><span class="params">(<span class="keyword">int</span> maxNumComponents)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> toLeakAwareBuffer(<span class="keyword">new</span> CompositeByteBuf(<span class="keyword">this</span>, <span class="keyword">true</span>, maxNumComponents));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åˆ›å»º CompositeByteBuf å¯¹è±¡ï¼Œå¹¶ä¸”æ–¹æ³•å‚æ•° <code>direct</code> ä¸º <code>true</code> ï¼Œè¡¨ç¤º Direct ç±»å‹ã€‚</li>
<li>è°ƒç”¨ <code>#toLeakAwareBuffer(CompositeByteBuf)</code> æ–¹æ³•ï¼Œè£…é¥°æˆ LeakAware çš„ ByteBuf å¯¹è±¡ã€‚</li>
</ul>
<h2 id="3-4-toLeakAwareBuffer"><a href="#3-4-toLeakAwareBuffer" class="headerlink" title="3.4 toLeakAwareBuffer"></a>3.4 toLeakAwareBuffer</h2><p>åœ¨ <a href="http://svip.iocoder.cn/Netty/ByteBuf-1-3-ByteBuf-resource-leak-detector">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ ByteBufï¼ˆä¸‰ï¼‰å†…å­˜æ³„éœ²æ£€æµ‹ã€‹</a> ä¸­çš„ <a href="#">ã€Œ3.1 åˆ›å»º LeakAware ByteBuf å¯¹è±¡ã€</a> å°èŠ‚ï¼Œå·²ç»è¯¦ç»†è§£æã€‚</p>
<h2 id="3-5-calculateNewCapacity"><a href="#3-5-calculateNewCapacity" class="headerlink" title="3.5 calculateNewCapacity"></a>3.5 calculateNewCapacity</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰©å®¹åˆ†ç•Œçº¿ï¼Œ4M</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CALCULATE_THRESHOLD = <span class="number">1048576</span> * <span class="number">4</span>; <span class="comment">// 4 MiB page</span></span><br><span class="line"></span><br><span class="line">  <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line">  <span class="number">2</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">calculateNewCapacity</span><span class="params">(<span class="keyword">int</span> minNewCapacity, <span class="keyword">int</span> maxCapacity)</span> </span>{</span><br><span class="line">  <span class="number">3</span>:     <span class="keyword">if</span> (minNewCapacity &lt; <span class="number">0</span>) {</span><br><span class="line">  <span class="number">4</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"minNewCapacity: "</span> + minNewCapacity + <span class="string">" (expected: 0+)"</span>);</span><br><span class="line">  <span class="number">5</span>:     }</span><br><span class="line">  <span class="number">6</span>:     <span class="keyword">if</span> (minNewCapacity &gt; maxCapacity) {</span><br><span class="line">  <span class="number">7</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(</span><br><span class="line">  <span class="number">8</span>:                 <span class="string">"minNewCapacity: %d (expected: not greater than maxCapacity(%d)"</span>,</span><br><span class="line">  <span class="number">9</span>:                 minNewCapacity, maxCapacity));</span><br><span class="line"> <span class="number">10</span>:     }</span><br><span class="line"> <span class="number">11</span>:     <span class="keyword">final</span> <span class="keyword">int</span> threshold = CALCULATE_THRESHOLD; <span class="comment">// 4 MiB page</span></span><br><span class="line"> <span class="number">12</span>: </span><br><span class="line"> <span class="number">13</span>:     <span class="comment">// &lt;1&gt; ç­‰äº threshold ï¼Œç›´æ¥è¿”å› threshold ã€‚</span></span><br><span class="line"> <span class="number">14</span>:     <span class="keyword">if</span> (minNewCapacity == threshold) {</span><br><span class="line"> <span class="number">15</span>:         <span class="keyword">return</span> threshold;</span><br><span class="line"> <span class="number">16</span>:     }</span><br><span class="line"> <span class="number">17</span>: </span><br><span class="line"> <span class="number">18</span>:     <span class="comment">// &lt;2&gt; è¶…è¿‡ threshold ï¼Œå¢åŠ  threshold ï¼Œä¸è¶…è¿‡ maxCapacity å¤§å°ã€‚</span></span><br><span class="line"> <span class="number">19</span>:     <span class="comment">// If over threshold, do not double but just increase by threshold.</span></span><br><span class="line"> <span class="number">20</span>:     <span class="keyword">if</span> (minNewCapacity &gt; threshold) {</span><br><span class="line"> <span class="number">21</span>:         <span class="keyword">int</span> newCapacity = minNewCapacity / threshold * threshold;</span><br><span class="line"> <span class="number">22</span>:         <span class="keyword">if</span> (newCapacity &gt; maxCapacity - threshold) { <span class="comment">// ä¸è¶…è¿‡ maxCapacity</span></span><br><span class="line"> <span class="number">23</span>:             newCapacity = maxCapacity;</span><br><span class="line"> <span class="number">24</span>:         } <span class="keyword">else</span> {</span><br><span class="line"> <span class="number">25</span>:             newCapacity += threshold;</span><br><span class="line"> <span class="number">26</span>:         }</span><br><span class="line"> <span class="number">27</span>:         <span class="keyword">return</span> newCapacity;</span><br><span class="line"> <span class="number">28</span>:     }</span><br><span class="line"> <span class="number">29</span>: </span><br><span class="line"> <span class="number">30</span>:     <span class="comment">// &lt;3&gt; æœªè¶…è¿‡ threshold ï¼Œä» 64 å¼€å§‹ä¸¤å€è®¡ç®—ï¼Œä¸è¶…è¿‡ 4M å¤§å°ã€‚</span></span><br><span class="line"> <span class="number">31</span>:     <span class="comment">// Not over threshold. Double up to 4 MiB, starting from 64.</span></span><br><span class="line"> <span class="number">32</span>:     <span class="keyword">int</span> newCapacity = <span class="number">64</span>;</span><br><span class="line"> <span class="number">33</span>:     <span class="keyword">while</span> (newCapacity &lt; minNewCapacity) {</span><br><span class="line"> <span class="number">34</span>:         newCapacity &lt;&lt;= <span class="number">1</span>;</span><br><span class="line"> <span class="number">35</span>:     }</span><br><span class="line"> <span class="number">36</span>:     <span class="keyword">return</span> Math.min(newCapacity, maxCapacity);</span><br><span class="line"> <span class="number">37</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æŒ‰ç…§ <code>CALCULATE_THRESHOLD</code> ä½œä¸ºåˆ†ç•Œçº¿ï¼Œåˆ†æˆ 3 ç§æƒ…å†µï¼š<code>&lt;1&gt;</code>/<code>&lt;2&gt;</code>/<code>&lt;3&gt;</code> ã€‚ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚</li>
</ul>
<h1 id="4-PreferHeapByteBufAllocator"><a href="#4-PreferHeapByteBufAllocator" class="headerlink" title="4. PreferHeapByteBufAllocator"></a>4. PreferHeapByteBufAllocator</h1><p><code>io.netty.channel.PreferHeapByteBufAllocator</code> ï¼Œå®ç° ByteBufAllocator æ¥å£ï¼Œ<strong>å€¾å‘åˆ›å»º Heap ByteBuf</strong> çš„åˆ†é…å™¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>#buffer(...)</code> å’Œ <code>#ioBuffer(...)</code> å’Œ <code>#compositeBuffer(...)</code> æ–¹æ³•ï¼Œåˆ›å»ºçš„éƒ½æ˜¯ Heap ByteBuf å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * çœŸæ­£çš„åˆ†é…å™¨å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ByteBufAllocator allocator;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PreferHeapByteBufAllocator</span><span class="params">(ByteBufAllocator allocator)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.allocator = ObjectUtil.checkNotNull(allocator, <span class="string">"allocator"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">buffer</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> allocator.heapBuffer();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ByteBuf <span class="title">ioBuffer</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> allocator.heapBuffer();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> CompositeByteBuf <span class="title">compositeBuffer</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> allocator.compositeHeapBuffer();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>å…¶å®ƒæ–¹æ³•ï¼Œå°±æ˜¯è°ƒç”¨ <code>allocator</code> çš„å¯¹åº”çš„æ–¹æ³•ã€‚</p>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>ğŸ˜ˆ å°æ°´æ–‡ä¸€ç¯‡ã€‚é“ºå«é“ºå«ï¼Œä½ æ‡‚çš„ã€‚</p>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/ByteBuf-2-1-ByteBufAllocator-intro/" data-id="ck4pl3fp300dvfgcfarbvedfd" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>