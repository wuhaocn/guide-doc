<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” ChannelHandlerï¼ˆå››ï¼‰ä¹‹ LoggingHandler
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>åœ¨ <code>netty-handler</code> æ¨¡å—ä¸­ï¼Œæä¾›äº†å¤šç§ ChannelHandler çš„å®ç°ç±»ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_10_10/01.png" title="`netty-handler`" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_10_10/01.png" alt="`netty-handler`"></a><span class="caption">`netty-handler`</span></p>
<ul>
<li>æ¯ä¸ª <code>package</code> åŒ…ï¼Œå¯¹åº”ä¸€ä¸ª<strong>åŠŸèƒ½ç‰¹æ€§</strong>çš„ ChannelHandler å®ç°ã€‚</li>
</ul>
<p>æœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥åˆ†äº« <code>logger</code> åŒ…ä¸‹ <code>logging</code> åŒ…çš„ LoggerHandler ã€‚</p>
<h1 id="2-LogLevel"><a href="#2-LogLevel" class="headerlink" title="2. LogLevel"></a>2. LogLevel</h1><p><code>io.netty.handler.logging.LogLevel</code> ï¼Œæ—¥å¿—çº§åˆ«æšä¸¾ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Maps the regular {<span class="doctag">@link</span> LogLevel}s with the {<span class="doctag">@link</span> InternalLogLevel} ones.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> LogLevel {</span><br><span class="line"></span><br><span class="line">    TRACE(InternalLogLevel.TRACE),</span><br><span class="line">    DEBUG(InternalLogLevel.DEBUG),</span><br><span class="line">    INFO(InternalLogLevel.INFO),</span><br><span class="line">    WARN(InternalLogLevel.WARN),</span><br><span class="line">    ERROR(InternalLogLevel.ERROR);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Netty å†…éƒ¨æ—¥å¿—çº§åˆ«</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InternalLogLevel internalLevel;</span><br><span class="line"></span><br><span class="line">    LogLevel(InternalLogLevel internalLevel) {</span><br><span class="line">        <span class="keyword">this</span>.internalLevel = internalLevel;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * For internal use only.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * &lt;p/&gt;Converts the specified {<span class="doctag">@link</span> LogLevel} to its {<span class="doctag">@link</span> InternalLogLevel} variant.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the converted level.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> InternalLogLevel <span class="title">toInternalLevel</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> internalLevel;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>Netty æä¾›äº†ä¸€å¥—æ—¥å¿—æ¡†æ¶ï¼Œæ–¹ä¾¿æ¥å…¥ slf4jã€log4jã€jdk logger ç­‰ç­‰æ—¥å¿—æ¡†æ¶ã€‚æ„Ÿå…´è¶£çš„èƒ–å‹ï¼Œå¯ä»¥çœ‹çœ‹ <a href="https://segmentfault.com/a/1190000005797595" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty4.x Internal Loggeræœºåˆ¶ã€‹</a> ã€‚ğŸ˜ˆ ç°åœ¨ï¼Œä¸çœ‹ä¹Ÿä¸å½±å“å¯¹æœ¬æ–‡çš„ç†è§£ã€‚</li>
<li>LogLevel å®ç°å¯¹ <code>io.netty.util.internal.logging.InternalLogLevel</code> çš„<strong>ä¸€ä¸€</strong>æ˜ å°„ã€‚ç¬”è€…æš‚æ—¶çœ‹ä¸å‡ºæœ‰ä»€ä¹ˆç¥å¥‡çš„ç”¨é€”ï¼Œéš¾é“æ˜¯ä¸ºäº†å¯ä»¥çµæ´»çš„ä¿®æ”¹æ˜ å°„å…³ç³»ï¼Ÿï¼æœ‰äº†è§£çš„èƒ–å‹ï¼Œå¯ä»¥æ·±åˆ»æ•™è‚²ä¸‹æˆ‘å™¢ã€‚</li>
</ul>
<h1 id="3-LoggingHandler"><a href="#3-LoggingHandler" class="headerlink" title="3. LoggingHandler"></a>3. LoggingHandler</h1><p><code>io.netty.handler.logging.LoggingHandler</code> ï¼Œç»§æ‰¿ ChannelDuplexHandler ç±»ï¼Œæ—¥å¿—å¤„ç†å™¨ï¼Œå¯¹ Inbound/Outbound äº‹ä»¶è¿›è¡Œæ—¥å¿—çš„è®°å½•ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç”¨äºå¼€å‘æµ‹è¯•æ—¶çš„è°ƒè¯•ä¹‹ç”¨ã€‚</p>
<h2 id="3-1-æ„é€ æ–¹æ³•"><a href="#3-1-æ„é€ æ–¹æ³•" class="headerlink" title="3.1 æ„é€ æ–¹æ³•"></a>3.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Sharable</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoggingHandler</span> <span class="keyword">extends</span> <span class="title">ChannelDuplexHandler</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é»˜è®¤ {<span class="doctag">@link</span> #level} æ—¥å¿—çº§åˆ«</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LogLevel DEFAULT_LEVEL = LogLevel.DEBUG;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Netty å†…éƒ¨ Logger å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> InternalLogger logger;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Netty å†…éƒ¨ LogLevel çº§åˆ«</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> InternalLogLevel internalLevel;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®çš„ LogLevel çº§åˆ«</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> LogLevel level;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new instance whose logger name is the fully qualified class</span></span><br><span class="line"><span class="comment">     * name of the instance with hex dump enabled.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoggingHandler</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(DEFAULT_LEVEL);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new instance whose logger name is the fully qualified class</span></span><br><span class="line"><span class="comment">     * name of the instance.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> level the log level</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoggingHandler</span><span class="params">(LogLevel level)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (level == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"level"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å¾— logger</span></span><br><span class="line">        logger = InternalLoggerFactory.getInstance(getClass());</span><br><span class="line">        <span class="keyword">this</span>.level = level;</span><br><span class="line">        internalLevel = level.toInternalLevel();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new instance with the specified logger name and with hex dump</span></span><br><span class="line"><span class="comment">     * enabled.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz the class type to generate the logger for</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoggingHandler</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(clazz, DEFAULT_LEVEL);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new instance with the specified logger name.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz the class type to generate the logger for</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> level the log level</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoggingHandler</span><span class="params">(Class&lt;?&gt; clazz, LogLevel level)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"clazz"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (level == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"level"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å¾— logger</span></span><br><span class="line">        logger = InternalLoggerFactory.getInstance(clazz);</span><br><span class="line">        <span class="keyword">this</span>.level = level;</span><br><span class="line">        internalLevel = level.toInternalLevel();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new instance with the specified logger name using the default log level.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name the name of the class to use for the logger</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoggingHandler</span><span class="params">(String name)</span> </span>{</span><br><span class="line">        <span class="keyword">this</span>(name, DEFAULT_LEVEL);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates a new instance with the specified logger name.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name the name of the class to use for the logger</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> level the log level</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LoggingHandler</span><span class="params">(String name, LogLevel level)</span> </span>{</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"name"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (level == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"level"</span>);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å¾— logger</span></span><br><span class="line">        logger = InternalLoggerFactory.getInstance(name);</span><br><span class="line">        <span class="keyword">this</span>.level = level;</span><br><span class="line">        internalLevel = level.toInternalLevel();</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... çœç•¥å…¶ä»–æ–¹æ³•</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é€šè¿‡ <code>@Sharable</code> æ³¨è§£ï¼Œæ”¯æŒå…±äº«ã€‚</li>
<li><code>level</code> å±æ€§ï¼Œé…ç½®çš„ LogLevel çº§åˆ«ã€‚<ul>
<li><code>DEFAULT_LEVEL</code> <strong>é™æ€</strong>å±æ€§ï¼Œé»˜è®¤çš„ <code>level</code> çº§åˆ«ã€‚æ„é€ æ–¹æ³•å¦‚æœæœªä¼ é€’ <code>LogLevel level</code> æ–¹æ³•å‚æ•°ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å€¼ã€‚</li>
<li><code>internalLevel</code> å±æ€§ï¼ŒNetty å†…éƒ¨ LogLevel çº§åˆ«ã€‚é€šè¿‡ <code>LogLevel#toInternalLevel()</code> æ–¹æ³•ï¼Œå°† <code>level</code> è½¬åŒ–æˆ <code>internalLevel</code> ã€‚</li>
</ul>
</li>
<li><code>logger</code> å±æ€§ï¼ŒNetty å†…éƒ¨ Logger å¯¹è±¡ã€‚é€šè¿‡ <code>Class&lt;?&gt; clazz</code> æˆ– <code>String name</code> æ–¹æ³•å‚æ•°ï¼Œè¿›è¡Œè·å¾—ã€‚</li>
</ul>
<h2 id="3-2-å…·ä½“å®ç°"><a href="#3-2-å…·ä½“å®ç°" class="headerlink" title="3.2 å…·ä½“å®ç°"></a>3.2 å…·ä½“å®ç°</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRegistered</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"REGISTERED"</span>));</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    ctx.fireChannelRegistered();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelUnregistered</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"UNREGISTERED"</span>));</span><br><span class="line">    }</span><br><span class="line">    ctx.fireChannelUnregistered();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelActive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="comment">// æ‰“å°æ—¥å¿—</span></span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"ACTIVE"</span>));</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// ä¼ é€’ Channel active äº‹ä»¶ï¼Œç»™ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    ctx.fireChannelActive();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelInactive</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"INACTIVE"</span>));</span><br><span class="line">    }</span><br><span class="line">    ctx.fireChannelInactive();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"EXCEPTION"</span>, cause), cause);</span><br><span class="line">    }</span><br><span class="line">    ctx.fireExceptionCaught(cause);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">userEventTriggered</span><span class="params">(ChannelHandlerContext ctx, Object evt)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"USER_EVENT"</span>, evt));</span><br><span class="line">    }</span><br><span class="line">    ctx.fireUserEventTriggered(evt);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"BIND"</span>, localAddress));</span><br><span class="line">    }</span><br><span class="line">    ctx.bind(localAddress, promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ChannelHandlerContext ctx,</span></span></span><br><span class="line"><span class="function"><span class="params">        SocketAddress remoteAddress, SocketAddress localAddress, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"CONNECT"</span>, remoteAddress, localAddress));</span><br><span class="line">    }</span><br><span class="line">    ctx.connect(remoteAddress, localAddress, promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disconnect</span><span class="params">(ChannelHandlerContext ctx, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"DISCONNECT"</span>));</span><br><span class="line">    }</span><br><span class="line">    ctx.disconnect(promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(ChannelHandlerContext ctx, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"CLOSE"</span>));</span><br><span class="line">    }</span><br><span class="line">    ctx.close(promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deregister</span><span class="params">(ChannelHandlerContext ctx, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"DEREGISTER"</span>));</span><br><span class="line">    }</span><br><span class="line">    ctx.deregister(promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"READ COMPLETE"</span>));</span><br><span class="line">    }</span><br><span class="line">    ctx.fireChannelReadComplete();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"READ"</span>, msg));</span><br><span class="line">    }</span><br><span class="line">    ctx.fireChannelRead(msg);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"WRITE"</span>, msg));</span><br><span class="line">    }</span><br><span class="line">    ctx.write(msg, promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelWritabilityChanged</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"WRITABILITY CHANGED"</span>));</span><br><span class="line">    }</span><br><span class="line">    ctx.fireChannelWritabilityChanged();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    <span class="keyword">if</span> (logger.isEnabled(internalLevel)) {</span><br><span class="line">        logger.log(internalLevel, format(ctx, <span class="string">"FLUSH"</span>));</span><br><span class="line">    }</span><br><span class="line">    ctx.flush();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>é‡Œé¢çš„æ¯ä¸ªæ–¹æ³•ï¼Œéƒ½æ˜¯ä½¿ç”¨ <code>logger</code> æ‰“å°æ—¥å¿—ï¼Œå¹¶ç»§ç»­ä¼ æ’­äº‹ä»¶åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</p>
<p>è€Œæ‰“å°çš„æ—¥å¿—çš„æ ¼å¼ï¼Œé€šè¿‡ <code>#format(...)</code> æ–¹æ³•ï¼Œè¿›è¡Œæ‹¼æ¥ã€‚</p>
<h2 id="3-3-format"><a href="#3-3-format" class="headerlink" title="3.3 format"></a>3.3 format</h2><p><code>#format(...)</code> æ–¹æ³•ï¼Œæ ¹æ®å‚æ•°çš„ä¸åŒï¼Œåˆ†æˆä¸‰ç§ã€‚</p>
<p>â‘  <code>#format(ChannelHandlerContext ctx, String eventName)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Formats an event and returns the formatted message.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> eventName the name of the event</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">format</span><span class="params">(ChannelHandlerContext ctx, String eventName)</span> </span>{</span><br><span class="line">    String chStr = ctx.channel().toString();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StringBuilder(chStr.length() + <span class="number">1</span> + eventName.length())</span><br><span class="line">        .append(chStr)</span><br><span class="line">        .append(<span class="string">' '</span>)</span><br><span class="line">        .append(eventName)</span><br><span class="line">        .toString();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>â‘¡ <code>#format(ChannelHandlerContext ctx, String eventName, Object arg)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Formats an event and returns the formatted message.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> eventName the name of the event</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> arg       the argument of the event</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">format</span><span class="params">(ChannelHandlerContext ctx, String eventName, Object arg)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (arg <span class="keyword">instanceof</span> ByteBuf) {</span><br><span class="line">        <span class="keyword">return</span> formatByteBuf(ctx, eventName, (ByteBuf) arg);</span><br><span class="line">    } <span class="keyword">else</span> <span class="keyword">if</span> (arg <span class="keyword">instanceof</span> ByteBufHolder) {</span><br><span class="line">        <span class="keyword">return</span> formatByteBufHolder(ctx, eventName, (ByteBufHolder) arg);</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> formatSimple(ctx, eventName, arg);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ ¹æ®å‚æ•°ä¸åŒï¼Œä¼šè°ƒç”¨ä¸åŒçš„ format æ–¹æ³•ã€‚</li>
</ul>
<p>â‘¢ <code>#format(ChannelHandlerContext ctx, String eventName, Object firstArg, Object secondArg)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Formats an event and returns the formatted message.  This method is currently only used for formatting</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> ChannelOutboundHandler#connect(ChannelHandlerContext, SocketAddress, SocketAddress, ChannelPromise)}.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> eventName the name of the event</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> firstArg  the first argument of the event</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> secondArg the second argument of the event</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">format</span><span class="params">(ChannelHandlerContext ctx, String eventName, Object firstArg, Object secondArg)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (secondArg == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> formatSimple(ctx, eventName, firstArg);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    String chStr = ctx.channel().toString();</span><br><span class="line">    String arg1Str = String.valueOf(firstArg);</span><br><span class="line">    String arg2Str = secondArg.toString();</span><br><span class="line">    StringBuilder buf = <span class="keyword">new</span> StringBuilder(</span><br><span class="line">            chStr.length() + <span class="number">1</span> + eventName.length() + <span class="number">2</span> + arg1Str.length() + <span class="number">2</span> + arg2Str.length());</span><br><span class="line">    buf.append(chStr).append(<span class="string">' '</span>).append(eventName).append(<span class="string">": "</span>).append(arg1Str).append(<span class="string">", "</span>).append(arg2Str);</span><br><span class="line">    <span class="keyword">return</span> buf.toString();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="3-3-1-formatByteBuf"><a href="#3-3-1-formatByteBuf" class="headerlink" title="3.3.1 formatByteBuf"></a>3.3.1 formatByteBuf</h3><p><code>#formatByteBuf(ChannelHandlerContext ctx, String eventName, ByteBuf msg)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Generates the default log message of the specified event whose argument is a {<span class="doctag">@link</span> ByteBuf}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">formatByteBuf</span><span class="params">(ChannelHandlerContext ctx, String eventName, ByteBuf msg)</span> </span>{</span><br><span class="line">    String chStr = ctx.channel().toString();</span><br><span class="line">    <span class="keyword">int</span> length = msg.readableBytes();</span><br><span class="line">    <span class="keyword">if</span> (length == <span class="number">0</span>) {</span><br><span class="line">        StringBuilder buf = <span class="keyword">new</span> StringBuilder(chStr.length() + <span class="number">1</span> + eventName.length() + <span class="number">4</span>);</span><br><span class="line">        buf.append(chStr).append(<span class="string">' '</span>).append(eventName).append(<span class="string">": 0B"</span>);</span><br><span class="line">        <span class="keyword">return</span> buf.toString();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">int</span> rows = length / <span class="number">16</span> + (length % <span class="number">15</span> == <span class="number">0</span>? <span class="number">0</span> : <span class="number">1</span>) + <span class="number">4</span>;</span><br><span class="line">        StringBuilder buf = <span class="keyword">new</span> StringBuilder(chStr.length() + <span class="number">1</span> + eventName.length() + <span class="number">2</span> + <span class="number">10</span> + <span class="number">1</span> + <span class="number">2</span> + rows * <span class="number">80</span>);</span><br><span class="line"></span><br><span class="line">        buf.append(chStr).append(<span class="string">' '</span>).append(eventName).append(<span class="string">": "</span>).append(length).append(<span class="string">'B'</span>).append(NEWLINE);</span><br><span class="line">        appendPrettyHexDump(buf, msg); <span class="comment">// &lt;1&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> buf.toString();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„çš„ <code>appendPrettyHexDump(buf, msg)</code> ï¼Œå®é™…è°ƒç”¨çš„æ˜¯ <code>ByteBufUtil#appendPrettyHexDump(StringBuilder dump, ByteBuf buf)</code> æ–¹æ³•ã€‚</li>
</ul>
<p>å¦‚ä¸‹æ˜¯ä¸€ä¸ªæ‰“å°çš„ç¤ºä¾‹ï¼š</p>
<blockquote>
<p>FROM <a href="https://www.jianshu.com/p/a9bcd89553f5" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆå…«ï¼‰â€“ChannelHandlerã€‹</a> </p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_10_10/02.png" title="ç¤ºä¾‹" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_10_10/02.png" alt="ç¤ºä¾‹"></a><span class="caption">ç¤ºä¾‹</span></p>
</blockquote>
<h3 id="3-3-2-formatByteBufHolder"><a href="#3-3-2-formatByteBufHolder" class="headerlink" title="3.3.2 formatByteBufHolder"></a>3.3.2 formatByteBufHolder</h3><p><code>#formatByteBufHolder(ChannelHandlerContext ctx, String eventName, ByteBufHolder msg)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Generates the default log message of the specified event whose argument is a {<span class="doctag">@link</span> ByteBufHolder}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">formatByteBufHolder</span><span class="params">(ChannelHandlerContext ctx, String eventName, ByteBufHolder msg)</span> </span>{</span><br><span class="line">    String chStr = ctx.channel().toString();</span><br><span class="line">    String msgStr = msg.toString();</span><br><span class="line">    ByteBuf content = msg.content();</span><br><span class="line">    <span class="keyword">int</span> length = content.readableBytes();</span><br><span class="line">    <span class="keyword">if</span> (length == <span class="number">0</span>) {</span><br><span class="line">        StringBuilder buf = <span class="keyword">new</span> StringBuilder(chStr.length() + <span class="number">1</span> + eventName.length() + <span class="number">2</span> + msgStr.length() + <span class="number">4</span>);</span><br><span class="line">        buf.append(chStr).append(<span class="string">' '</span>).append(eventName).append(<span class="string">", "</span>).append(msgStr).append(<span class="string">", 0B"</span>);</span><br><span class="line">        <span class="keyword">return</span> buf.toString();</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">int</span> rows = length / <span class="number">16</span> + (length % <span class="number">15</span> == <span class="number">0</span>? <span class="number">0</span> : <span class="number">1</span>) + <span class="number">4</span>;</span><br><span class="line">        StringBuilder buf = <span class="keyword">new</span> StringBuilder(chStr.length() + <span class="number">1</span> + eventName.length() + <span class="number">2</span> + msgStr.length() + <span class="number">2</span> + <span class="number">10</span> + <span class="number">1</span> + <span class="number">2</span> + rows * <span class="number">80</span>);</span><br><span class="line"></span><br><span class="line">        buf.append(chStr).append(<span class="string">' '</span>).append(eventName).append(<span class="string">": "</span>).append(msgStr).append(<span class="string">", "</span>).append(length).append(<span class="string">'B'</span>).append(NEWLINE);</span><br><span class="line">        appendPrettyHexDump(buf, content);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> buf.toString();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å’Œ <code>#formatByteBuf(ChannelHandlerContext ctx, String eventName, ByteBuf msg)</code> æ–¹æ³•ï¼Œå®é™…æ‰“å°çš„æ•ˆæœï¼Œéå¸¸ç›¸ä¼¼ã€‚</li>
</ul>
<h3 id="3-3-3-formatSimple"><a href="#3-3-3-formatSimple" class="headerlink" title="3.3.3 formatSimple"></a>3.3.3 formatSimple</h3><p><code>#formatSimple(ChannelHandlerContext ctx, String eventName, Object msg)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Generates the default log message of the specified event whose argument is an arbitrary object.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">formatSimple</span><span class="params">(ChannelHandlerContext ctx, String eventName, Object msg)</span> </span>{</span><br><span class="line">    String chStr = ctx.channel().toString();</span><br><span class="line">    String msgStr = String.valueOf(msg);</span><br><span class="line">    StringBuilder buf = <span class="keyword">new</span> StringBuilder(chStr.length() + <span class="number">1</span> + eventName.length() + <span class="number">2</span> + msgStr.length());</span><br><span class="line">    <span class="keyword">return</span> buf.append(chStr).append(<span class="string">' '</span>).append(eventName).append(<span class="string">": "</span>).append(msgStr).toString();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>è¿˜æ˜¯æ²¡æœ‰å½©è›‹ã€‚</p>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/ChannelHandler-4-LoggingHandler/" data-id="ck4pl3fp800ebfgcfwesx7tzu" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>