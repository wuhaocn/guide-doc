<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆå…­ï¼‰PoolThreadCache
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>åœ¨ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-5-Jemalloc-Arena">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆäº”ï¼‰PoolArenaã€‹</a> ä¸€æ–‡ä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ° PoolArena åœ¨åˆ†é…( <code>#allocate(...)</code> )å’Œé‡Šæ”¾( <code>#free(...)</code> )å†…å­˜çš„è¿‡ç¨‹ä¸­ï¼Œæ— å¯é¿å…ä¼šå‡ºç° <code>synchronized</code> çš„èº«å½±ã€‚è™½ç„¶é”çš„ç²’åº¦ä¸æ˜¯å¾ˆå¤§ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ª PoolArena å¦‚æœè¢«<strong>å¤šä¸ª</strong>çº¿ç¨‹å¼•ç”¨ï¼Œå¸¦æ¥çš„çº¿ç¨‹é”çš„åŒæ­¥å’Œç«äº‰ã€‚å¹¶ä¸”ï¼Œå¦‚æœåœ¨é”ç«äº‰çš„è¿‡ç¨‹ä¸­ï¼Œç”³è¯· Direct ByteBuffer ï¼Œé‚£ä¹ˆå¸¦æ¥çš„çº¿ç¨‹ç­‰å¾…å°±å¯èƒ½æ˜¯<strong>å‡ ç™¾æ¯«ç§’</strong>çš„æ—¶é—´ã€‚</p>
<p>é‚£ä¹ˆè¯¥å¦‚ä½•è§£å†³å‘¢ï¼Ÿå¦‚ä¸‹å›¾çº¢æ¡†æ‰€ç¤ºï¼š</p>
<blockquote>
<p>FROM <a href="http://brionas.github.io/2015/01/31/jemalloc%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" rel="external nofollow noopener noreferrer" target="_blank">ã€Šjemallocæºç è§£æ-å†…å­˜ç®¡ç†ã€‹</a></p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_09_16/01.png" title="å¤§ä½“ç»“æ„" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_09_16/01.png" alt="å¤§ä½“ç»“æ„"></a><span class="caption">å¤§ä½“ç»“æ„</span></p>
</blockquote>
<p>ç»™<strong>æ¯ä¸ª</strong>çº¿ç¨‹å¼•å…¥å…¶<strong>ç‹¬æœ‰</strong>çš„ tcache çº¿ç¨‹ç¼“å­˜ã€‚</p>
<ul>
<li>åœ¨é‡Šæ”¾å·²åˆ†é…çš„å†…å­˜å—æ—¶ï¼Œä¸æ”¾å›åˆ° Chunk ä¸­ï¼Œè€Œæ˜¯ç¼“å­˜åˆ° tcache ä¸­ã€‚</li>
<li>åœ¨åˆ†é…å†…å­˜å—æ—¶ï¼Œä¼˜å…ˆä» tcache è·å–ã€‚æ— æ³•è·å–åˆ°ï¼Œå†ä» Chunk ä¸­åˆ†é…ã€‚</li>
</ul>
<p>é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œå°½å¯èƒ½çš„é¿å…å¤šçº¿ç¨‹çš„åŒæ­¥å’Œç«äº‰ã€‚</p>
<h1 id="2-PoolThreadCache"><a href="#2-PoolThreadCache" class="headerlink" title="2. PoolThreadCache"></a>2. PoolThreadCache</h1><p><code>io.netty.buffer.PoolThreadCache</code> ï¼ŒNetty å¯¹ Jemalloc tcache çš„å®ç°ç±»ï¼Œå†…å­˜åˆ†é…çš„çº¿ç¨‹ç¼“å­˜ã€‚</p>
<h2 id="2-1-æ„é€ æ–¹æ³•"><a href="#2-1-æ„é€ æ–¹æ³•" class="headerlink" title="2.1 æ„é€ æ–¹æ³•"></a>2.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯¹åº”çš„ Heap PoolArena å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> PoolArena&lt;<span class="keyword">byte</span>[]&gt; heapArena;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¯¹åº”çš„ Direct PoolArena å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> PoolArena&lt;ByteBuffer&gt; directArena;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Hold the caches for the different size classes, which are tiny, small and normal.</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Heap ç±»å‹çš„ tiny Subpage å†…å­˜å—ç¼“å­˜æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MemoryRegionCache&lt;<span class="keyword">byte</span>[]&gt;[] tinySubPageHeapCaches;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Heap ç±»å‹çš„ small Subpage å†…å­˜å—ç¼“å­˜æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MemoryRegionCache&lt;<span class="keyword">byte</span>[]&gt;[] smallSubPageHeapCaches;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Heap ç±»å‹çš„ normal å†…å­˜å—ç¼“å­˜æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MemoryRegionCache&lt;<span class="keyword">byte</span>[]&gt;[] normalHeapCaches;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Direct ç±»å‹çš„ tiny Subpage å†…å­˜å—ç¼“å­˜æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MemoryRegionCache&lt;ByteBuffer&gt;[] tinySubPageDirectCaches;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Direct ç±»å‹çš„ small Subpage å†…å­˜å—ç¼“å­˜æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MemoryRegionCache&lt;ByteBuffer&gt;[] smallSubPageDirectCaches;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Direct ç±»å‹çš„ normal å†…å­˜å—ç¼“å­˜æ•°ç»„</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> MemoryRegionCache&lt;ByteBuffer&gt;[] normalDirectCaches;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Used for bitshifting when calculate the index of normal caches later</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨äºè®¡ç®—è¯·æ±‚åˆ†é…çš„ normal ç±»å‹çš„å†…å­˜å—ï¼Œåœ¨ {<span class="doctag">@link</span> #normalDirectCaches} æ•°ç»„ä¸­çš„ä½ç½®</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * é»˜è®¤ä¸º log2(pageSize) = log2(8192) = 13</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> numShiftsNormalDirect;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ç”¨äºè®¡ç®—è¯·æ±‚åˆ†é…çš„ normal ç±»å‹çš„å†…å­˜å—ï¼Œåœ¨ {<span class="doctag">@link</span> #normalHeapCaches} æ•°ç»„ä¸­çš„ä½ç½®</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * é»˜è®¤ä¸º log2(pageSize) = log2(8192) = 13</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> numShiftsNormalHeap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åˆ†é…æ¬¡æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> allocations;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #allocations} åˆ°è¾¾è¯¥é˜€å€¼ï¼Œé‡Šæ”¾ç¼“å­˜</span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> * é»˜è®¤ä¸º 8192 æ¬¡</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> #free()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> freeSweepAllocationThreshold;</span><br><span class="line"></span><br><span class="line">  <span class="number">1</span>: PoolThreadCache(PoolArena&lt;<span class="keyword">byte</span>[]&gt; heapArena, PoolArena&lt;ByteBuffer&gt; directArena,</span><br><span class="line">  <span class="number">2</span>:                 <span class="keyword">int</span> tinyCacheSize, <span class="keyword">int</span> smallCacheSize, <span class="keyword">int</span> normalCacheSize,</span><br><span class="line">  <span class="number">3</span>:                 <span class="keyword">int</span> maxCachedBufferCapacity, <span class="keyword">int</span> freeSweepAllocationThreshold) {</span><br><span class="line">  <span class="number">4</span>:     <span class="keyword">if</span> (maxCachedBufferCapacity &lt; <span class="number">0</span>) {</span><br><span class="line">  <span class="number">5</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"maxCachedBufferCapacity: "</span></span><br><span class="line">  <span class="number">6</span>:                 + maxCachedBufferCapacity + <span class="string">" (expected: &gt;= 0)"</span>);</span><br><span class="line">  <span class="number">7</span>:     }</span><br><span class="line">  <span class="number">8</span>:     <span class="keyword">this</span>.freeSweepAllocationThreshold = freeSweepAllocationThreshold;</span><br><span class="line">  <span class="number">9</span>:     <span class="keyword">this</span>.heapArena = heapArena;</span><br><span class="line"> <span class="number">10</span>:     <span class="keyword">this</span>.directArena = directArena;</span><br><span class="line"> <span class="number">11</span>: </span><br><span class="line"> <span class="number">12</span>:     <span class="comment">// åˆå§‹åŒ– Direct ç±»å‹çš„å†…å­˜å—ç¼“å­˜</span></span><br><span class="line"> <span class="number">13</span>:     <span class="keyword">if</span> (directArena != <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">14</span>:         <span class="comment">// åˆ›å»º tinySubPageDirectCaches</span></span><br><span class="line"> <span class="number">15</span>:         tinySubPageDirectCaches = createSubPageCaches(tinyCacheSize, PoolArena.numTinySubpagePools, SizeClass.Tiny);</span><br><span class="line"> <span class="number">16</span>:         <span class="comment">// åˆ›å»º smallSubPageDirectCaches</span></span><br><span class="line"> <span class="number">17</span>:         smallSubPageDirectCaches = createSubPageCaches(smallCacheSize, directArena.numSmallSubpagePools, SizeClass.Small);</span><br><span class="line"> <span class="number">18</span>: </span><br><span class="line"> <span class="number">19</span>:         <span class="comment">// è®¡ç®— numShiftsNormalDirect</span></span><br><span class="line"> <span class="number">20</span>:         numShiftsNormalDirect = log2(directArena.pageSize);</span><br><span class="line"> <span class="number">21</span>:         <span class="comment">// åˆ›å»º normalDirectCaches</span></span><br><span class="line"> <span class="number">22</span>:         normalDirectCaches = createNormalCaches(normalCacheSize, maxCachedBufferCapacity, directArena);</span><br><span class="line"> <span class="number">23</span>: </span><br><span class="line"> <span class="number">24</span>:         <span class="comment">// å¢åŠ  directArena çš„çº¿ç¨‹å¼•ç”¨è®¡æ•°</span></span><br><span class="line"> <span class="number">25</span>:         directArena.numThreadCaches.getAndIncrement();</span><br><span class="line"> <span class="number">26</span>:     } <span class="keyword">else</span> {</span><br><span class="line"> <span class="number">27</span>:         <span class="comment">// No directArea is configured so just null out all caches</span></span><br><span class="line"> <span class="number">28</span>:         tinySubPageDirectCaches = <span class="keyword">null</span>;</span><br><span class="line"> <span class="number">29</span>:         smallSubPageDirectCaches = <span class="keyword">null</span>;</span><br><span class="line"> <span class="number">30</span>:         normalDirectCaches = <span class="keyword">null</span>;</span><br><span class="line"> <span class="number">31</span>:         numShiftsNormalDirect = -<span class="number">1</span>;</span><br><span class="line"> <span class="number">32</span>:     }</span><br><span class="line"> <span class="number">33</span>:     <span class="comment">// åˆå§‹åŒ– Heap ç±»å‹çš„å†…å­˜å—ç¼“å­˜ã€‚åŒä¸Šé¢éƒ¨åˆ†ã€‚</span></span><br><span class="line"> <span class="number">34</span>:     <span class="keyword">if</span> (heapArena != <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">35</span>:         <span class="comment">// Create the caches for the heap allocations</span></span><br><span class="line"> <span class="number">36</span>:         tinySubPageHeapCaches = createSubPageCaches(tinyCacheSize, PoolArena.numTinySubpagePools, SizeClass.Tiny);</span><br><span class="line"> <span class="number">37</span>:         smallSubPageHeapCaches = createSubPageCaches(smallCacheSize, heapArena.numSmallSubpagePools, SizeClass.Small);</span><br><span class="line"> <span class="number">38</span>: </span><br><span class="line"> <span class="number">39</span>:         numShiftsNormalHeap = log2(heapArena.pageSize);</span><br><span class="line"> <span class="number">40</span>:         normalHeapCaches = createNormalCaches(normalCacheSize, maxCachedBufferCapacity, heapArena);</span><br><span class="line"> <span class="number">41</span>: </span><br><span class="line"> <span class="number">42</span>:         heapArena.numThreadCaches.getAndIncrement();</span><br><span class="line"> <span class="number">43</span>:     } <span class="keyword">else</span> {</span><br><span class="line"> <span class="number">44</span>:         <span class="comment">// No heapArea is configured so just null out all caches</span></span><br><span class="line"> <span class="number">45</span>:         tinySubPageHeapCaches = <span class="keyword">null</span>;</span><br><span class="line"> <span class="number">46</span>:         smallSubPageHeapCaches = <span class="keyword">null</span>;</span><br><span class="line"> <span class="number">47</span>:         normalHeapCaches = <span class="keyword">null</span>;</span><br><span class="line"> <span class="number">48</span>:         numShiftsNormalHeap = -<span class="number">1</span>;</span><br><span class="line"> <span class="number">49</span>:     }</span><br><span class="line"> <span class="number">50</span>: </span><br><span class="line"> <span class="number">51</span>:     <span class="comment">// æ ¡éªŒå‚æ•°ï¼Œä¿è¯ PoolThreadCache å¯ç¼“å­˜å†…å­˜å—ã€‚</span></span><br><span class="line"> <span class="number">52</span>:     <span class="comment">// Only check if there are caches in use.</span></span><br><span class="line"> <span class="number">53</span>:     <span class="keyword">if</span> ((tinySubPageDirectCaches != <span class="keyword">null</span> || smallSubPageDirectCaches != <span class="keyword">null</span> || normalDirectCaches != <span class="keyword">null</span></span><br><span class="line"> <span class="number">54</span>:             || tinySubPageHeapCaches != <span class="keyword">null</span> || smallSubPageHeapCaches != <span class="keyword">null</span> || normalHeapCaches != <span class="keyword">null</span>)</span><br><span class="line"> <span class="number">55</span>:             &amp;&amp; freeSweepAllocationThreshold &lt; <span class="number">1</span>) {</span><br><span class="line"> <span class="number">56</span>:         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"freeSweepAllocationThreshold: "</span> + freeSweepAllocationThreshold + <span class="string">" (expected: &gt; 0)"</span>);</span><br><span class="line"> <span class="number">57</span>:     }</span><br><span class="line"> <span class="number">58</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è™½ç„¶ä»£ç æ¯”è¾ƒå¤šï¼Œä¸»è¦åˆ†ä¸º Heap å’Œ Direct ä¸¤ç§å†…å­˜ã€‚</li>
<li>Direct ç›¸å…³<ul>
<li><code>directArena</code> å±æ€§ï¼Œå¯¹åº”çš„ Heap PoolArena å¯¹è±¡ã€‚</li>
<li><code>tinySubPageDirectCaches</code> å±æ€§ï¼ŒDirect ç±»å‹çš„ tiny Subpage å†…å­˜å—ç¼“å­˜æ•°ç»„ã€‚<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ•°ç»„å¤§å°ä¸º 512 ã€‚ </li>
<li>åœ¨ã€ç¬¬ 15 è¡Œã€‘çš„ä»£ç ï¼Œè°ƒç”¨ <code>#createSubPageCaches(int cacheSize, int numCaches, SizeClass sizeClass)</code> æ–¹æ³•ï¼Œåˆ›å»º MemoryRegionCache æ•°ç»„ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.2 createSubPageCachesã€</a> ã€‚</li>
</ul>
</li>
<li><code>smallSubPageDirectCaches</code> å±æ€§ï¼ŒDirect ç±»å‹çš„ small Subpage å†…å­˜å—ç¼“å­˜æ•°ç»„ã€‚<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ•°ç»„å¤§å°ä¸º 256 ã€‚</li>
<li>åœ¨ã€ç¬¬ 17 è¡Œã€‘çš„ä»£ç ï¼Œè°ƒç”¨ <code>#createSubPageCaches(int cacheSize, int numCaches, SizeClass sizeClass)</code> æ–¹æ³•ï¼Œåˆ›å»º MemoryRegionCache æ•°ç»„ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.2 createSubPageCachesã€</a> ã€‚</li>
</ul>
</li>
<li><code>normalDirectCaches</code> å±æ€§ï¼ŒDirect ç±»å‹çš„ normal Page å†…å­˜å—ç¼“å­˜æ•°ç»„ã€‚<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ•°ç»„å¤§å°ä¸º 64 ã€‚</li>
<li>åœ¨ã€ç¬¬ 22 è¡Œã€‘çš„ä»£ç ï¼Œè°ƒç”¨ <code>#createNormalCaches(int cacheSize, int maxCachedBufferCapacity, PoolArena&lt;T&gt; area)</code> æ–¹æ³•ï¼Œåˆ›å»º MemoryRegionCache æ•°ç»„ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.3 createNormalCachesã€</a> ã€‚</li>
<li><code>numShiftsNormalDirect</code> å±æ€§ï¼Œç”¨äºè®¡ç®—è¯·æ±‚åˆ†é…çš„ normal ç±»å‹çš„å†…å­˜å—ï¼Œåœ¨ <code>normalDirectCaches</code> æ•°ç»„ä¸­çš„ä½ç½®ã€‚<ul>
<li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ•°å€¼ä¸º 13 ã€‚</li>
<li>åœ¨ã€ç¬¬ 20 è¡Œã€‘çš„ä»£ç ï¼Œè°ƒç”¨ <code>#log2(int pageSize)</code> æ–¹æ³•ï¼Œ <code>log2(pageSize) = log2(8192) = 13</code> ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>åœ¨ã€ç¬¬ 25 è¡Œã€‘çš„ä»£ç ï¼Œå¢åŠ  <code>directArena</code> çš„çº¿ç¨‹å¼•ç”¨è®¡æ•°ã€‚é€šè¿‡è¿™æ ·çš„æ–¹å¼ï¼Œæˆ‘ä»¬èƒ½å¤ŸçŸ¥é“ï¼Œä¸€ä¸ª PoolArena å¯¹è±¡ï¼Œè¢«å¤šå°‘çº¿ç¨‹æ‰€å¼•ç”¨ã€‚</li>
</ul>
</li>
<li>Heap ç›¸å…³ï¼Œå’Œã€Direct ç›¸å…³ã€‘åŸºæœ¬<strong>ç±»ä¼¼</strong>ã€‚</li>
<li><code>allocations</code> å±æ€§ï¼Œåˆ†é…æ¬¡æ•°è®¡æ•°å™¨ã€‚æ¯æ¬¡åˆ†é…æ—¶ï¼Œè¯¥è®¡æ•°å™¨ + 1 ã€‚<ul>
<li><code>freeSweepAllocationThreshold</code> å±æ€§ï¼Œå½“ <code>allocations</code> åˆ°è¾¾è¯¥é˜€å€¼æ—¶ï¼Œè°ƒç”¨ <code>#free()</code> æ–¹æ³•ï¼Œé‡Šæ”¾ç¼“å­˜ã€‚åŒæ—¶ï¼Œä¼šé‡ç½® <code>allocations</code> è®¡æ•°å™¨ä¸º 0 ã€‚</li>
</ul>
</li>
</ul>
<h2 id="2-2-createSubPageCaches"><a href="#2-2-createSubPageCaches" class="headerlink" title="2.2 createSubPageCaches"></a>2.2 createSubPageCaches</h2><p><code>#createSubPageCaches(int cacheSize, int numCaches, SizeClass sizeClass)</code> æ–¹æ³•ï¼Œåˆ›å»º Subpage å†…å­˜å—ç¼“å­˜æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// tiny ç±»å‹ï¼Œé»˜è®¤ cacheSize = PooledByteBufAllocator.DEFAULT_TINY_CACHE_SIZE = 512 , numCaches = PoolArena.numTinySubpagePools = 512 &gt;&gt;&gt; 4 = 32</span></span><br><span class="line"><span class="comment">// small ç±»å‹ï¼Œé»˜è®¤ cacheSize = PooledByteBufAllocator.DEFAULT_SMALL_CACHE_SIZE = 256 , numCaches = pageSize - 9 = 13 - 9 = 4</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; MemoryRegionCache&lt;T&gt;[] createSubPageCaches(<span class="keyword">int</span> cacheSize, <span class="keyword">int</span> numCaches, SizeClass sizeClass) {</span><br><span class="line">    <span class="keyword">if</span> (cacheSize &gt; <span class="number">0</span> &amp;&amp; numCaches &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        MemoryRegionCache&lt;T&gt;[] cache = <span class="keyword">new</span> MemoryRegionCache[numCaches];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cache.length; i++) {</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> maybe use cacheSize / cache.length</span></span><br><span class="line">            cache[i] = <span class="keyword">new</span> SubPageMemoryRegionCache&lt;T&gt;(cacheSize, sizeClass);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> cache;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åˆ›å»ºçš„ Subpage å†…å­˜å—ç¼“å­˜æ•°ç»„ï¼Œå®é™…å’Œ <code>PoolArena.tinySubpagePools</code> å’Œ <code>PoolArena.smallSubpagePools</code> æ•°ç»„<strong>å¤§å°ä¿æŒä¸€è‡´</strong>ã€‚ä»è€Œå®ç°ï¼Œç›¸åŒå¤§å°çš„å†…å­˜ï¼Œèƒ½å¯¹åº”ç›¸åŒçš„æ•°ç»„ä¸‹æ ‡ã€‚<ul>
<li><code>sizeClass</code> = <code>tiny</code> æ—¶ï¼Œ é»˜è®¤ <code>cacheSize</code> = <code>PooledByteBufAllocator.DEFAULT_TINY_CACHE_SIZE = 512</code> , <code>numCaches</code> = <code>PoolArena.numTinySubpagePools = 512 &gt;&gt;&gt; 4 = 32</code> ã€‚</li>
<li><code>sizeClass</code> = <code>small</code> æ—¶ï¼Œé»˜è®¤ <code>cacheSize</code> = <code>PooledByteBufAllocator.DEFAULT_SMALL_CACHE_SIZE = 256</code> , <code>numCaches</code> = <code>pageSize - 9 = 13 - 9 = 4</code> ã€‚</li>
</ul>
</li>
<li>åˆ›å»ºçš„æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ çš„ç±»å‹ä¸º SubPageMemoryRegionCache ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ3.X.1 SubPageMemoryRegionCacheã€</a> ã€‚</li>
</ul>
<h2 id="2-3-createNormalCaches"><a href="#2-3-createNormalCaches" class="headerlink" title="2.3 createNormalCaches"></a>2.3 createNormalCaches</h2><p><code>#createSubPageCaches(int cacheSize, int numCaches, SizeClass sizeClass)</code> æ–¹æ³•ï¼Œåˆ›å»º Normal Page å†…å­˜å—ç¼“å­˜æ•°ç»„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="comment">// normal ç±»å‹ï¼Œé»˜è®¤ cacheSize = PooledByteBufAllocator.DEFAULT_NORMAL_CACHE_SIZE = 64 , maxCachedBufferCapacity = PoolArena.DEFAULT_MAX_CACHED_BUFFER_CAPACITY = 32 * 1024 = 32KB</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; MemoryRegionCache&lt;T&gt;[] createNormalCaches(<span class="keyword">int</span> cacheSize, <span class="keyword">int</span> maxCachedBufferCapacity, PoolArena&lt;T&gt; area) {</span><br><span class="line">    <span class="keyword">if</span> (cacheSize &gt; <span class="number">0</span> &amp;&amp; maxCachedBufferCapacity &gt; <span class="number">0</span>) {</span><br><span class="line">        <span class="comment">// &lt;1&gt; è®¡ç®—æ•°ç»„å¤§å°</span></span><br><span class="line">        <span class="keyword">int</span> max = Math.min(area.chunkSize, maxCachedBufferCapacity);</span><br><span class="line">        <span class="keyword">int</span> arraySize = Math.max(<span class="number">1</span>, log2(max / area.pageSize) + <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">        MemoryRegionCache&lt;T&gt;[] cache = <span class="keyword">new</span> MemoryRegionCache[arraySize];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cache.length; i++) {</span><br><span class="line">            cache[i] = <span class="keyword">new</span> NormalMemoryRegionCache&lt;T&gt;(cacheSize);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> cache;</span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>maxCachedBufferCapacity</code> å±æ€§ï¼Œç¼“å­˜çš„ Normal å†…å­˜å—çš„æœ€å¤§å®¹é‡ï¼Œé¿å…è¿‡å¤§çš„ Normal å†…å­˜å—è¢«ç¼“å­˜ï¼Œå ç”¨è¿‡å¤šé€šè¿‡ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>maxCachedBufferCapacity = PoolArena.DEFAULT_MAX_CACHED_BUFFER_CAPACITY = 32 * 1024 = 32KB</code> ã€‚ä¹Ÿå°±è¯´ï¼Œåœ¨ <code>&lt;1&gt;</code> å¤„ï¼Œ<code>arraySize</code> çš„è®¡ç®—<strong>æ•°ç»„å¤§å°</strong>çš„ç»“æœä¸º 3 ã€‚åˆšå¥½æ˜¯ <code>cache[0] = 8KB</code>ã€<code>cache[1] = 16KB</code>ã€<code>cache[2] = 32KB</code> ã€‚é‚£ä¹ˆï¼Œå¦‚æœç”³è¯·çš„ Normal å†…å­˜å—å¤§å°ä¸º <code>64KB</code> ï¼Œè¶…è¿‡äº†æ•°ç»„å¤§å°ï¼Œæ‰€ä»¥æ— æ³•è¢«ç¼“å­˜ã€‚ğŸ˜ˆ æ˜¯ä¸æ˜¯å’ŒåŸå…ˆè‡ªå·±è®¤ä¸ºçš„ <code>maxCachedBufferCapacity</code> å®ç°æœ€å¤§å®¹é‡çš„æƒ³æ³•ï¼Œæœ‰ç‚¹ä¸åŒã€‚</li>
<li>åˆ›å»ºçš„æ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ çš„ç±»å‹ä¸º SubPageMemoryRegionCache ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ3.X.2 NormalMemoryRegionCacheã€</a> ã€‚</li>
</ul>
<h2 id="2-4-cache"><a href="#2-4-cache" class="headerlink" title="2.4 cache"></a>2.4 cache</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> MemoryRegionCache&lt;?&gt; cacheForTiny(PoolArena&lt;?&gt; area, <span class="keyword">int</span> normCapacity) {</span><br><span class="line">    <span class="comment">// è·å¾—æ•°ç»„ä¸‹æ ‡</span></span><br><span class="line">    <span class="keyword">int</span> idx = PoolArena.tinyIdx(normCapacity);</span><br><span class="line">    <span class="keyword">if</span> (area.isDirect()) {</span><br><span class="line">        <span class="keyword">return</span> cache(tinySubPageDirectCaches, idx);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> cache(tinySubPageHeapCaches, idx);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> MemoryRegionCache&lt;?&gt; cacheForSmall(PoolArena&lt;?&gt; area, <span class="keyword">int</span> normCapacity) {</span><br><span class="line">    <span class="comment">// è·å¾—æ•°ç»„ä¸‹æ ‡</span></span><br><span class="line">    <span class="keyword">int</span> idx = PoolArena.smallIdx(normCapacity);</span><br><span class="line">    <span class="keyword">if</span> (area.isDirect()) {</span><br><span class="line">        <span class="keyword">return</span> cache(smallSubPageDirectCaches, idx);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> cache(smallSubPageHeapCaches, idx);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> MemoryRegionCache&lt;?&gt; cacheForNormal(PoolArena&lt;?&gt; area, <span class="keyword">int</span> normCapacity) {</span><br><span class="line">    <span class="keyword">if</span> (area.isDirect()) {</span><br><span class="line">        <span class="comment">// è·å¾—æ•°ç»„ä¸‹æ ‡</span></span><br><span class="line">        <span class="keyword">int</span> idx = log2(normCapacity &gt;&gt; numShiftsNormalDirect);</span><br><span class="line">        <span class="keyword">return</span> cache(normalDirectCaches, idx);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// è·å¾—æ•°ç»„ä¸‹æ ‡</span></span><br><span class="line">    <span class="keyword">int</span> idx = log2(normCapacity &gt;&gt; numShiftsNormalHeap);</span><br><span class="line">    <span class="keyword">return</span> cache(normalHeapCaches, idx);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ä¸‰ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«è·å–å†…å­˜å®¹é‡å¯¹åº”æ‰€åœ¨çš„ MemoryRegionCache å¯¹è±¡ã€‚é€šè¿‡è°ƒç”¨ <code>#cache(MemoryRegionCache&lt;T&gt;[] cache, int idx)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">MemoryRegionCache&lt;T&gt; <span class="title">cache</span><span class="params">(MemoryRegionCache&lt;T&gt;[] cache, <span class="keyword">int</span> idx)</span> </span>{</span><br><span class="line">    <span class="comment">// ä¸åœ¨èŒƒå›´å†…ï¼Œè¯´æ˜ä¸ç¼“å­˜è¯¥å®¹é‡çš„å†…å­˜å—</span></span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="keyword">null</span> || idx &gt; cache.length - <span class="number">1</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// è·å¾— MemoryRegionCache å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> cache[idx];</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<hr>
<p>å½“ç„¶ï¼Œè€ƒè™‘åˆ°ä½¿ç”¨ä¾¿åˆ©ï¼Œå°è£…äº† <code>#cache(PoolArena&lt;?&gt; area, int normCapacity, SizeClass sizeClass)</code> æ–¹æ³•ï¼Œæ”¯æŒè·å–å¯¹åº”å†…å­˜ç±»å‹çš„ MemoryRegionCache å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> MemoryRegionCache&lt;?&gt; cache(PoolArena&lt;?&gt; area, <span class="keyword">int</span> normCapacity, SizeClass sizeClass) {</span><br><span class="line">    <span class="keyword">switch</span> (sizeClass) {</span><br><span class="line">    <span class="keyword">case</span> Normal:</span><br><span class="line">        <span class="keyword">return</span> cacheForNormal(area, normCapacity);</span><br><span class="line">    <span class="keyword">case</span> Small:</span><br><span class="line">        <span class="keyword">return</span> cacheForSmall(area, normCapacity);</span><br><span class="line">    <span class="keyword">case</span> Tiny:</span><br><span class="line">        <span class="keyword">return</span> cacheForTiny(area, normCapacity);</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Error();</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="2-5-add"><a href="#2-5-add" class="headerlink" title="2.5 add"></a>2.5 add</h2><p><code>#add(PoolArena&lt;?&gt; area, PoolChunk chunk, long handle, int normCapacity, SizeClass sizeClass)</code> æ–¹æ³•ï¼Œæ·»åŠ å†…å­˜å—åˆ° PoolThreadCache çš„æŒ‡å®š MemoryRegionCache çš„é˜Ÿåˆ—ä¸­ï¼Œè¿›è¡Œç¼“å­˜ã€‚å¹¶ä¸”ï¼Œè¿”å›æ˜¯å¦æ·»åŠ æˆåŠŸã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add {<span class="doctag">@link</span> PoolChunk} and {<span class="doctag">@code</span> handle} to the cache if there is enough room.</span></span><br><span class="line"><span class="comment"> * Returns {<span class="doctag">@code</span> true} if it fit into the cache {<span class="doctag">@code</span> false} otherwise.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>({ <span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span> })</span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">add</span><span class="params">(PoolArena&lt;?&gt; area, PoolChunk chunk, <span class="keyword">long</span> handle, <span class="keyword">int</span> normCapacity, SizeClass sizeClass)</span> </span>{</span><br><span class="line">    <span class="comment">// è·å¾—å¯¹åº”çš„ MemoryRegionCache å¯¹è±¡</span></span><br><span class="line">    MemoryRegionCache&lt;?&gt; cache = cache(area, normCapacity, sizeClass);</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ° MemoryRegionCache å†…å­˜å—ä¸­</span></span><br><span class="line">    <span class="keyword">return</span> cache.add(chunk, handle);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚</li>
<li>åœ¨ <code>PoolArea#free(PoolChunk&lt;T&gt; chunk, long handle, int normCapacity, PoolThreadCache cache)</code> ä¸­ï¼Œè°ƒç”¨è¯¥æ–¹æ³•ã€‚æ‰€ä»¥ï¼Œå¯ä»¥ç»“åˆ <a href="http://svip.iocoder.cn/Netty/ByteBuf-3-5-Jemalloc-Arena">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Buffer ä¹‹ Jemallocï¼ˆäº”ï¼‰PoolArenaã€‹</a> çš„ <a href="#">ã€Œ2.6 freeã€</a> ä¸€èµ·çœ‹çœ‹ç½—ã€‚</li>
</ul>
<h2 id="2-6-allocate"><a href="#2-6-allocate" class="headerlink" title="2.6 allocate"></a>2.6 allocate</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Try to allocate a tiny buffer out of the cache. Returns {<span class="doctag">@code</span> true} if successful {<span class="doctag">@code</span> false} otherwise</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">allocateTiny</span><span class="params">(PoolArena&lt;?&gt; area, PooledByteBuf&lt;?&gt; buf, <span class="keyword">int</span> reqCapacity, <span class="keyword">int</span> normCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> allocate(cacheForTiny(area, normCapacity), buf, reqCapacity);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Try to allocate a small buffer out of the cache. Returns {<span class="doctag">@code</span> true} if successful {<span class="doctag">@code</span> false} otherwise</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">allocateSmall</span><span class="params">(PoolArena&lt;?&gt; area, PooledByteBuf&lt;?&gt; buf, <span class="keyword">int</span> reqCapacity, <span class="keyword">int</span> normCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> allocate(cacheForSmall(area, normCapacity), buf, reqCapacity);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Try to allocate a small buffer out of the cache. Returns {<span class="doctag">@code</span> true} if successful {<span class="doctag">@code</span> false} otherwise</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">allocateNormal</span><span class="params">(PoolArena&lt;?&gt; area, PooledByteBuf&lt;?&gt; buf, <span class="keyword">int</span> reqCapacity, <span class="keyword">int</span> normCapacity)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> allocate(cacheForNormal(area, normCapacity), buf, reqCapacity);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ä¸‰ä¸ªæ–¹æ³•ï¼Œä»ç¼“å­˜ä¸­åˆ†åˆ«è·å–ä¸åŒå®¹é‡å¤§å°çš„å†…å­˜å—ï¼Œåˆå§‹åŒ–åˆ° PooledByteBuf å¯¹è±¡ä¸­ã€‚é€šè¿‡è°ƒç”¨ <code>#allocate(MemoryRegionCache&lt;?&gt; cache, PooledByteBuf buf, int reqCapacity)</code> æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">allocate</span><span class="params">(MemoryRegionCache&lt;?&gt; cache, PooledByteBuf buf, <span class="keyword">int</span> reqCapacity)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (cache == <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">3</span>:         <span class="comment">// no cache found so just return false here</span></span><br><span class="line"> <span class="number">4</span>:         <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line"> <span class="number">5</span>:     }</span><br><span class="line"> <span class="number">6</span>:     <span class="comment">// åˆ†é…å†…å­˜å—ï¼Œå¹¶åˆå§‹åŒ–åˆ° MemoryRegionCache ä¸­</span></span><br><span class="line"> <span class="number">7</span>:     <span class="keyword">boolean</span> allocated = cache.allocate(buf, reqCapacity);</span><br><span class="line"> <span class="number">8</span>:     <span class="comment">// åˆ°è¾¾é˜€å€¼ï¼Œæ•´ç†ç¼“å­˜</span></span><br><span class="line"> <span class="number">9</span>:     <span class="keyword">if</span> (++ allocations &gt;= freeSweepAllocationThreshold) {</span><br><span class="line"><span class="number">10</span>:         allocations = <span class="number">0</span>;</span><br><span class="line"><span class="number">11</span>:         trim();</span><br><span class="line"><span class="number">12</span>:     }</span><br><span class="line"><span class="number">13</span>:     <span class="comment">// è¿”å›æ˜¯å¦åˆ†é…æˆåŠŸ</span></span><br><span class="line"><span class="number">14</span>:     <span class="keyword">return</span> allocated;</span><br><span class="line"><span class="number">15</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 7 è¡Œï¼šè°ƒç”¨ <code>MemoryRegionCache#allocate(buf, reqCapacity)</code> æ–¹æ³•ï¼Œä»ç¼“å­˜ä¸­åˆ†é…å†…å­˜å—ï¼Œå¹¶åˆå§‹åŒ–åˆ° MemoryRegionCache ä¸­ã€‚</li>
<li>ç¬¬ 8 è‡³ 12 è¡Œï¼šå¢åŠ  <code>allocations</code> è®¡æ•°ã€‚è‹¥åˆ°è¾¾é˜€å€¼( <code>freeSweepAllocationThreshold</code> )ï¼Œé‡ç½®è®¡æ•°ï¼Œå¹¶è°ƒç”¨ <code>#trim()</code> æ–¹æ³•ï¼Œæ•´ç†ç¼“å­˜ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.7 trimã€</a> ã€‚</li>
<li>ç¬¬ 14 è¡Œï¼šè¿”å›æ˜¯å¦åˆ†é…æˆåŠŸã€‚å¦‚æœä»ç¼“å­˜ä¸­åˆ†é…å¤±è´¥ï¼Œåç»­å°±ä» PoolArena ä¸­è·å–å†…å­˜å—ã€‚</li>
</ul>
</li>
</ul>
<h2 id="2-7-free"><a href="#2-7-free" class="headerlink" title="2.7 free"></a>2.7 free</h2><p><code>#trim()</code> æ–¹æ³•ï¼Œæ•´ç†ç¼“å­˜ï¼Œé‡Šæ”¾ä½¿ç”¨<strong>é¢‘åº¦</strong>è¾ƒå°‘çš„å†…å­˜å—ç¼“å­˜ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">free</span><span class="params">(MemoryRegionCache&lt;?&gt; cache)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> cache.free();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">trim</span><span class="params">()</span> </span>{</span><br><span class="line">    trim(tinySubPageDirectCaches);</span><br><span class="line">    trim(smallSubPageDirectCaches);</span><br><span class="line">    trim(normalDirectCaches);</span><br><span class="line">    trim(tinySubPageHeapCaches);</span><br><span class="line">    trim(smallSubPageHeapCaches);</span><br><span class="line">    trim(normalHeapCaches);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">trim</span><span class="params">(MemoryRegionCache&lt;?&gt;[] caches)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (caches == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">for</span> (MemoryRegionCache&lt;?&gt; c: caches) {</span><br><span class="line">        trim(c);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">trim</span><span class="params">(MemoryRegionCache&lt;?&gt; cache)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (cache == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    cache.trim();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¼šè°ƒç”¨æ‰€æœ‰ MemoryRegionCache çš„ <code>#trim()</code> æ–¹æ³•ï¼Œæ•´ç†æ¯ä¸ªå†…å­˜å—ç¼“å­˜ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ3.6 trimã€</a> ã€‚</li>
</ul>
<h2 id="2-8-finalize"><a href="#2-8-finalize" class="headerlink" title="2.8 finalize"></a>2.8 finalize</h2><p><code>#finalize()</code> æ–¹æ³•ï¼Œå¯¹è±¡é”€æ¯æ—¶ï¼Œæ¸…ç©ºç¼“å­˜ç­‰ç­‰ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/// <span class="doctag">TODO:</span> In the future when we move to Java9+ we should use java.lang.ref.Cleaner.</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="comment">// &lt;1&gt; è°ƒç”¨çˆ¶ finalize</span></span><br><span class="line">        <span class="keyword">super</span>.finalize();</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        <span class="comment">// æ¸…ç©ºç¼“å­˜</span></span><br><span class="line">        free();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  Should be called if the Thread that uses this cache is about to exist to release resources out of the cache</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// &lt;2&gt; æ¸…ç©ºç¼“å­˜</span></span><br><span class="line">    <span class="keyword">int</span> numFreed = free(tinySubPageDirectCaches) +</span><br><span class="line">            free(smallSubPageDirectCaches) +</span><br><span class="line">            free(normalDirectCaches) +</span><br><span class="line">            free(tinySubPageHeapCaches) +</span><br><span class="line">            free(smallSubPageHeapCaches) +</span><br><span class="line">            free(normalHeapCaches);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (numFreed &gt; <span class="number">0</span> &amp;&amp; logger.isDebugEnabled()) {</span><br><span class="line">        logger.debug(<span class="string">"Freed {} thread-local buffer(s) from thread: {}"</span>, numFreed, Thread.currentThread().getName());</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &lt;3.1&gt; å‡å° directArena çš„çº¿ç¨‹å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (directArena != <span class="keyword">null</span>) {</span><br><span class="line">        directArena.numThreadCaches.getAndDecrement();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// &lt;3.2&gt; å‡å° heapArena çš„çº¿ç¨‹å¼•ç”¨è®¡æ•°</span></span><br><span class="line">    <span class="keyword">if</span> (heapArena != <span class="keyword">null</span>) {</span><br><span class="line">        heapArena.numThreadCaches.getAndDecrement();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">free</span><span class="params">(MemoryRegionCache&lt;?&gt;[] caches)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (caches == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> numFreed = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (MemoryRegionCache&lt;?&gt; c: caches) {</span><br><span class="line">        numFreed += free(c);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> numFreed;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹ã€‚ä¸»è¦æ˜¯ <code>&lt;1&gt;</code>ã€<code>&lt;2&gt;</code>ã€<code>&lt;3.1&gt;/&lt;3.2&gt;</code> ä¸‰ä¸ªç‚¹ã€‚</li>
</ul>
<h1 id="3-MemoryRegionCache"><a href="#3-MemoryRegionCache" class="headerlink" title="3. MemoryRegionCache"></a>3. MemoryRegionCache</h1><p>MemoryRegionCache ï¼Œæ˜¯ PoolThreadCache çš„å†…éƒ¨é™æ€ç±»ï¼Œ<strong>å†…å­˜å—ç¼“å­˜</strong>ã€‚åœ¨å…¶å†…éƒ¨ï¼Œæœ‰ä¸€ä¸ª<strong>é˜Ÿåˆ—</strong>ï¼Œå­˜å‚¨ç¼“å­˜çš„å†…å­˜å—ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_09_16/02.png" title="MemoryRegionCache" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_09_16/02.png" alt="MemoryRegionCache"></a><span class="caption">MemoryRegionCache</span></p>
<h2 id="3-1-æ„é€ æ–¹æ³•"><a href="#3-1-æ„é€ æ–¹æ³•" class="headerlink" title="3.1 æ„é€ æ–¹æ³•"></a>3.1 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MemoryRegionCache</span>&lt;<span class="title">T</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * {<span class="doctag">@link</span> #queue} é˜Ÿåˆ—å¤§å°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é˜Ÿåˆ—ã€‚é‡Œé¢å­˜å‚¨å†…å­˜å—</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Queue&lt;Entry&lt;T&gt;&gt; queue;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å†…å­˜ç±»å‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SizeClass sizeClass;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆ†é…æ¬¡æ•°è®¡æ•°å™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> allocations;</span><br><span class="line"></span><br><span class="line">    MemoryRegionCache(<span class="keyword">int</span> size, SizeClass sizeClass) {</span><br><span class="line">        <span class="keyword">this</span>.size = MathUtil.safeFindNextPositivePowerOfTwo(size);</span><br><span class="line">        queue = PlatformDependent.newFixedMpscQueue(<span class="keyword">this</span>.size); <span class="comment">// &lt;1&gt; MPSC</span></span><br><span class="line">        <span class="keyword">this</span>.sizeClass = sizeClass;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ... çœç•¥å…¶å®ƒæ–¹æ³•</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>sizeClass</code> å±æ€§ï¼Œå†…å­˜ç±»å‹ã€‚</li>
<li><p><code>queue</code> å±æ€§ï¼Œé˜Ÿåˆ—ï¼Œé‡Œé¢å­˜å‚¨å†…å­˜å—ã€‚æ¯ä¸ªå…ƒç´ ä¸º Entry å¯¹è±¡ï¼Œå¯¹åº”ä¸€ä¸ªå†…å­˜å—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">T</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Recycler å¤„ç†å™¨ï¼Œç”¨äºå›æ”¶ Entry å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">final</span> Handle&lt;Entry&lt;?&gt;&gt; recyclerHandle;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * PoolChunk å¯¹è±¡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PoolChunk&lt;T&gt; chunk;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å†…å­˜å—åœ¨ {<span class="doctag">@link</span> #chunk} çš„ä½ç½®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">long</span> handle = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    Entry(Handle&lt;Entry&lt;?&gt;&gt; recyclerHandle) {</span><br><span class="line">        <span class="keyword">this</span>.recyclerHandle = recyclerHandle;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">recycle</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// ç½®ç©º</span></span><br><span class="line">        chunk = <span class="keyword">null</span>;</span><br><span class="line">        handle = -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// å›æ”¶ Entry å¯¹è±¡</span></span><br><span class="line">        recyclerHandle.recycle(<span class="keyword">this</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é€šè¿‡ <code>chunk</code> å’Œ <code>handle</code> å±æ€§ï¼Œå¯ä»¥å”¯ä¸€ç¡®è®¤ä¸€ä¸ªå†…å­˜å—ã€‚</li>
<li><code>recyclerHandle</code> å±æ€§ï¼Œç”¨äºå›æ”¶ Entry å¯¹è±¡ï¼Œç”¨äº <code>#recycle()</code> æ–¹æ³•ä¸­ã€‚</li>
</ul>
</li>
<li><code>size</code> å±æ€§ï¼Œé˜Ÿåˆ—å¤§å°ã€‚</li>
<li><code>allocations</code> å±æ€§ï¼Œåˆ†é…æ¬¡æ•°è®¡æ•°å™¨ã€‚</li>
<li>åœ¨ <code>&lt;1&gt;</code> å¤„ç†ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åˆ›å»ºçš„ <code>queue</code> å±æ€§ï¼Œç±»å‹ä¸º MPSC( Multiple Producer Single Consumer ) é˜Ÿåˆ—ï¼Œå³<strong>å¤šä¸ª</strong>ç”Ÿäº§è€…<strong>å•ä¸€</strong>æ¶ˆè´¹è€…ã€‚ä¸ºä»€ä¹ˆä½¿ç”¨ MPSC é˜Ÿåˆ—å‘¢?<ul>
<li>å¤šä¸ªç”Ÿäº§è€…ï¼ŒæŒ‡çš„æ˜¯å¤šä¸ªçº¿ç¨‹ï¼Œç§»é™¤( é‡Šæ”¾ )å†…å­˜å—å‡ºé˜Ÿåˆ—ã€‚</li>
<li>å•ä¸ªæ¶ˆè´¹è€…ï¼ŒæŒ‡çš„æ˜¯å•ä¸ªçº¿ç¨‹ï¼Œæ·»åŠ ( ç¼“å­˜ )å†…å­˜å—åˆ°é˜Ÿåˆ—ã€‚ </li>
</ul>
</li>
</ul>
<h2 id="3-2-newEntry"><a href="#3-2-newEntry" class="headerlink" title="3.2 newEntry"></a>3.2 newEntry</h2><p><code>#newEntry(PoolChunk&lt;?&gt; chunk, long handle)</code> æ–¹æ³•ï¼Œåˆ›å»º Entry å¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Entry <span class="title">newEntry</span><span class="params">(PoolChunk&lt;?&gt; chunk, <span class="keyword">long</span> handle)</span> </span>{</span><br><span class="line">    <span class="comment">// ä» Recycler å¯¹è±¡ä¸­ï¼Œè·å¾— Entry å¯¹è±¡</span></span><br><span class="line">    Entry entry = RECYCLER.get();</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å±æ€§</span></span><br><span class="line">    entry.chunk = chunk;</span><br><span class="line">    entry.handle = handle;</span><br><span class="line">    <span class="keyword">return</span> entry;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Recycler&lt;Entry&gt; RECYCLER = <span class="keyword">new</span> Recycler&lt;Entry&gt;() {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Entry <span class="title">newObject</span><span class="params">(Handle&lt;Entry&gt; handle)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Entry(handle); <span class="comment">// åˆ›å»º Entry å¯¹è±¡</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-3-add"><a href="#3-3-add" class="headerlink" title="3.3 add"></a>3.3 add</h2><p><code>#add(PoolChunk&lt;T&gt; chunk, long handle)</code> æ–¹æ³•ï¼Œæ·»åŠ ( ç¼“å­˜ )å†…å­˜å—åˆ°é˜Ÿåˆ—ï¼Œå¹¶è¿”å›æ˜¯å¦æ·»åŠ æˆåŠŸã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add to cache if not already full.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(PoolChunk&lt;T&gt; chunk, <span class="keyword">long</span> handle)</span> </span>{</span><br><span class="line">    <span class="comment">// åˆ›å»º Entry å¯¹è±¡</span></span><br><span class="line">    Entry&lt;T&gt; entry = newEntry(chunk, handle);</span><br><span class="line">    <span class="comment">// æ·»åŠ åˆ°é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">boolean</span> queued = queue.offer(entry);</span><br><span class="line">    <span class="comment">// è‹¥æ·»åŠ å¤±è´¥ï¼Œè¯´æ˜é˜Ÿåˆ—å·²æ»¡ï¼Œå›æ”¶ Entry å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (!queued) {</span><br><span class="line">        <span class="comment">// If it was not possible to cache the chunk, immediately recycle the entry</span></span><br><span class="line">        entry.recycle();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> queued; <span class="comment">// æ˜¯å¦æ·»åŠ æˆåŠŸ</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-4-allocate"><a href="#3-4-allocate" class="headerlink" title="3.4 allocate"></a>3.4 allocate</h2><p><code>#allocate(PooledByteBuf&lt;T&gt; buf, int reqCapacity)</code> æ–¹æ³•ï¼Œä»é˜Ÿåˆ—ä¸­è·å–ç¼“å­˜çš„å†…å­˜å—ï¼Œåˆå§‹åŒ–åˆ° PooledByteBuf å¯¹è±¡ä¸­ï¼Œå¹¶è¿”å›æ˜¯å¦åˆ†é…æˆåŠŸã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Allocate something out of the cache if possible and remove the entry from the cache.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">allocate</span><span class="params">(PooledByteBuf&lt;T&gt; buf, <span class="keyword">int</span> reqCapacity)</span> </span>{</span><br><span class="line">    <span class="comment">// è·å–å¹¶ç§»é™¤é˜Ÿåˆ—é¦–ä¸ª Entry å¯¹è±¡</span></span><br><span class="line">    Entry&lt;T&gt; entry = queue.poll();</span><br><span class="line">    <span class="comment">// è·å–å¤±è´¥ï¼Œè¿”å› false</span></span><br><span class="line">    <span class="keyword">if</span> (entry == <span class="keyword">null</span>) {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// &lt;1&gt; åˆå§‹åŒ–å†…å­˜å—åˆ° PooledByteBuf å¯¹è±¡ä¸­ </span></span><br><span class="line">    initBuf(entry.chunk, entry.handle, buf, reqCapacity);</span><br><span class="line">    <span class="comment">// å›æ”¶ Entry å¯¹è±¡</span></span><br><span class="line">    entry.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¢åŠ  allocations è®¡æ•°ã€‚å› ä¸ºåˆ†é…æ€»æ˜¯åœ¨ç›¸åŒçº¿ç¨‹ï¼Œæ‰€ä»¥ä¸éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨çš„é—®é¢˜</span></span><br><span class="line">    <span class="comment">// allocations is not thread-safe which is fine as this is only called from the same thread all time.</span></span><br><span class="line">    ++ allocations;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// è¿”å› true ï¼Œåˆ†é…æˆåŠŸ</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚</li>
<li><p>åœ¨ <code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#initBuf(PoolChunk&lt;T&gt; chunk, long handle, PooledByteBuf&lt;T&gt; buf, int reqCapacity)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œåˆå§‹åŒ–å†…å­˜å—åˆ° PooledByteBuf å¯¹è±¡ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Init the {<span class="doctag">@link</span> PooledByteBuf} using the provided chunk and handle with the capacity restrictions.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">initBuf</span><span class="params">(PoolChunk&lt;T&gt; chunk, <span class="keyword">long</span> handle, PooledByteBuf&lt;T&gt; buf, <span class="keyword">int</span> reqCapacity)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¯¥<strong>æŠ½è±¡</strong>æ–¹æ³•éœ€è¦å­ç±» SubPageMemoryRegionCache å’Œ NormalMemoryRegionCache æ¥å®ç°ã€‚å¹¶ä¸”ï¼Œè¿™ä¹Ÿæ˜¯ MemoryRegionCache çš„<strong>å”¯ä¸€</strong>çš„æŠ½è±¡æ–¹æ³•ã€‚</li>
</ul>
</li>
</ul>
<h2 id="3-5-free"><a href="#3-5-free" class="headerlink" title="3.5 free"></a>3.5 free</h2><p><code>#free(...)</code> æ–¹æ³•ï¼Œæ¸…é™¤é˜Ÿåˆ—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ¸…é™¤é˜Ÿåˆ—ä¸­çš„å…¨éƒ¨</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Clear out this cache and free up all previous cached {<span class="doctag">@link</span> PoolChunk}s and {<span class="doctag">@code</span> handle}s.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">free</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> free(Integer.MAX_VALUE);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¸…é™¤é˜Ÿåˆ—ä¸­çš„æŒ‡å®šæ•°é‡å…ƒç´ </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">free</span><span class="params">(<span class="keyword">int</span> max)</span> </span>{</span><br><span class="line">    <span class="keyword">int</span> numFreed = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (; numFreed &lt; max; numFreed++) {</span><br><span class="line">        <span class="comment">// è·å–å¹¶ç§»é™¤é¦–å…ƒç´ </span></span><br><span class="line">        Entry&lt;T&gt; entry = queue.poll();</span><br><span class="line">        <span class="keyword">if</span> (entry != <span class="keyword">null</span>) {</span><br><span class="line">            <span class="comment">// é‡Šæ”¾ç¼“å­˜çš„å†…å­˜å—å› Chunk ä¸­</span></span><br><span class="line">            freeEntry(entry); &lt;<span class="number">1</span>&gt;</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// all cleared</span></span><br><span class="line">            <span class="keyword">return</span> numFreed;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> numFreed;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒç®€å•ï¼Œèƒ–å‹è‡ªå·±çœ‹æ³¨é‡Šã€‚</li>
<li><p><code>&lt;1&gt;</code> å¤„ï¼Œ é‡Šæ”¾ç¼“å­˜çš„å†…å­˜å—å› Chunk ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span>  <span class="keyword">void</span> <span class="title">freeEntry</span><span class="params">(Entry entry)</span> </span>{</span><br><span class="line">    PoolChunk chunk = entry.chunk;</span><br><span class="line">    <span class="keyword">long</span> handle = entry.handle;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å›æ”¶ Entry å¯¹è±¡</span></span><br><span class="line">    <span class="comment">// recycle now so PoolChunk can be GC'ed.</span></span><br><span class="line">    entry.recycle();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡Šæ”¾ç¼“å­˜çš„å†…å­˜å—å› Chunk ä¸­</span></span><br><span class="line">    chunk.arena.freeChunk(chunk, handle, sizeClass);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
</ul>
<h2 id="3-6-trim"><a href="#3-6-trim" class="headerlink" title="3.6 trim"></a>3.6 trim</h2><p>è¿™å—å½“æ—¶æ²¡å¤ªçœ‹æ‡‚ï¼Œåæ¥è¯»äº† <a href="https://www.jianshu.com/p/9177b7dabd37" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆåï¼‰â€“PoolThreadCacheã€‹</a> æ–‡ç« åï¼Œçœ‹æ‡‚äº† <code>#trim()</code> æ–¹æ³•ã€‚å¼•ç”¨å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>åœ¨åˆ†é…è¿‡ç¨‹è¿˜æœ‰ä¸€ä¸ª<code>trim()</code>æ–¹æ³•ï¼Œå½“åˆ†é…æ“ä½œè¾¾åˆ°ä¸€å®šé˜ˆå€¼ï¼ˆNettyé»˜è®¤8192ï¼‰æ—¶ï¼Œæ²¡æœ‰è¢«åˆ†é…å‡ºå»çš„ç¼“å­˜ç©ºé—´éƒ½è¦è¢«é‡Šæ”¾ï¼Œä»¥é˜²æ­¢å†…å­˜æ³„æ¼ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š</p>
</blockquote>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// å†…éƒ¨ç±»MemoryRegionCache</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">trim</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">// allocations è¡¨ç¤ºå·²ç»é‡æ–°åˆ†é…å‡ºå»çš„ByteBufä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">int</span> free = size - allocations;  </span><br><span class="line">    allocations = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨ä¸€å®šé˜ˆå€¼å†…è¿˜æ²¡è¢«åˆ†é…å‡ºå»çš„ç©ºé—´å°†è¢«é‡Šæ”¾</span></span><br><span class="line">    <span class="keyword">if</span> (free &gt; <span class="number">0</span>) {</span><br><span class="line">        free(free); <span class="comment">// é‡Šæ”¾é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒæœŸæœ›ä¸€ä¸ª MemoryRegionCache <strong>é¢‘ç¹</strong>è¿›è¡Œå›æ”¶-åˆ†é…ï¼Œè¿™æ · <code>allocations</code> &gt; <code>size</code> ï¼Œå°†ä¸ä¼šé‡Šæ”¾é˜Ÿåˆ—ä¸­çš„ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹è¡¨ç¤ºçš„å†…å­˜ç©ºé—´ï¼›</p>
<p>ä½†å¦‚æœé•¿æ—¶é—´æ²¡æœ‰åˆ†é…ï¼Œåˆ™åº”è¯¥é‡Šæ”¾è¿™ä¸€éƒ¨åˆ†ç©ºé—´ï¼Œé˜²æ­¢å†…å­˜å æ®è¿‡å¤šã€‚Tinyè¯·æ±‚ç¼“å­˜512 ä¸ªèŠ‚ç‚¹ï¼Œç”±æ­¤å¯çŸ¥å½“ä½¿ç”¨ç‡è¶…è¿‡ <code>512 / 8192 = 6.25%</code> æ—¶å°±ä¸ä¼šé‡Šæ”¾èŠ‚ç‚¹ã€‚</p>
</blockquote>
<h2 id="3-X1-SubPageMemoryRegionCache"><a href="#3-X1-SubPageMemoryRegionCache" class="headerlink" title="3.X1 SubPageMemoryRegionCache"></a>3.X1 SubPageMemoryRegionCache</h2><p>SubPageMemoryRegionCache ï¼Œæ˜¯ PoolThreadCache çš„å†…éƒ¨é™æ€ç±»ï¼Œç»§æ‰¿ MemoryRegionCache æŠ½è±¡ç±»ï¼Œ<strong>Subpage</strong> MemoryRegionCache å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Cache used for buffers which are backed by TINY or SMALL size.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">SubPageMemoryRegionCache</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">MemoryRegionCache</span>&lt;<span class="title">T</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    SubPageMemoryRegionCache(<span class="keyword">int</span> size, SizeClass sizeClass) {</span><br><span class="line">        <span class="keyword">super</span>(size, sizeClass);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initBuf</span><span class="params">(PoolChunk&lt;T&gt; chunk, <span class="keyword">long</span> handle, PooledByteBuf&lt;T&gt; buf, <span class="keyword">int</span> reqCapacity)</span> </span>{</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– Subpage å†…å­˜å—åˆ° PooledByteBuf å¯¹è±¡ä¸­</span></span><br><span class="line">        chunk.initBufWithSubpage(buf, handle, reqCapacity);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="3-X2-NormalMemoryRegionCache"><a href="#3-X2-NormalMemoryRegionCache" class="headerlink" title="3.X2 NormalMemoryRegionCache"></a>3.X2 NormalMemoryRegionCache</h2><p>NormalMemoryRegionCache ï¼Œæ˜¯ PoolThreadCache çš„å†…éƒ¨é™æ€ç±»ï¼Œç»§æ‰¿ MemoryRegionCache æŠ½è±¡ç±»ï¼Œ<strong>Page</strong> MemoryRegionCache å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Cache used for buffers which are backed by NORMAL size.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">NormalMemoryRegionCache</span>&lt;<span class="title">T</span>&gt; <span class="keyword">extends</span> <span class="title">MemoryRegionCache</span>&lt;<span class="title">T</span>&gt; </span>{</span><br><span class="line"></span><br><span class="line">    NormalMemoryRegionCache(<span class="keyword">int</span> size) {</span><br><span class="line">        <span class="keyword">super</span>(size, SizeClass.Normal);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initBuf</span><span class="params">(PoolChunk&lt;T&gt; chunk, <span class="keyword">long</span> handle, PooledByteBuf&lt;T&gt; buf, <span class="keyword">int</span> reqCapacity)</span> </span>{</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– Page å†…å­˜å—åˆ° PooledByteBuf å¯¹è±¡ä¸­</span></span><br><span class="line">        chunk.initBuf(buf, handle, reqCapacity);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>å˜¿å˜¿ï¼Œæ¯”æƒ³è±¡ä¸­ç®€å•è›®å¤šçš„ä¸€ç¯‡æ–‡ç« ã€‚</p>
<p>æ¨èé˜…è¯»æ–‡ç« ï¼š</p>
<ul>
<li>Hypercube <a href="https://www.jianshu.com/p/9177b7dabd37" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆåï¼‰â€“PoolThreadCacheã€‹</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/ByteBuf-3-6-Jemalloc-ThreadCache/" data-id="ck4pl3fpa00egfgcfp620fla3" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>