<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” Channelï¼ˆä¸‰ï¼‰ä¹‹ read æ“ä½œ
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>æœ¬æ–‡åˆ†äº« Netty NIO æœåŠ¡ç«¯è¯»å–( <strong>read</strong> )æ¥è‡ªå®¢æˆ·ç«¯æ•°æ®çš„è¿‡ç¨‹ã€å’Œ Netty NIO å®¢æˆ·ç«¯æ¥æ”¶( <strong>read</strong> )æ¥è‡ªæœåŠ¡ç«¯æ•°æ®çš„ç»“æœã€‚å®é™…ä¸Šï¼Œè¿™ä¸¤è€…çš„å®ç°é€»è¾‘æ˜¯ä¸€è‡´çš„ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯å°±ä¸ç”¨è¯´äº†ï¼Œè‡ªèº«å°±ä½¿ç”¨äº† Netty NioSocketChannel ã€‚</li>
<li>æœåŠ¡ç«¯åœ¨æ¥å—å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚åï¼Œä¼šåˆ›å»ºå®¢æˆ·ç«¯å¯¹åº”çš„ Netty NioSocketChannel ã€‚</li>
</ul>
<p>å› æ­¤ï¼Œæˆ‘ä»¬ç»Ÿä¸€å«åš NioSocketChannel è¯»å–( <strong>read</strong> )å¯¹ç«¯çš„æ•°æ®çš„è¿‡ç¨‹ã€‚</p>
<hr>
<p>NioSocketChannel è¯»å–( <strong>read</strong> )å¯¹ç«¯çš„æ•°æ®çš„è¿‡ç¨‹ï¼Œç®€å•æ¥è¯´ï¼š</p>
<ol>
<li>NioSocketChannel æ‰€åœ¨çš„ EventLoop çº¿ç¨‹è½®è¯¢æ˜¯å¦æœ‰æ–°çš„æ•°æ®å†™å…¥ã€‚</li>
<li>å½“è½®è¯¢åˆ°æœ‰æ–°çš„æ•°æ®å†™å…¥ï¼ŒNioSocketChannel è¯»å–æ•°æ®ï¼Œå¹¶æäº¤åˆ° pipeline ä¸­è¿›è¡Œå¤„ç†ã€‚</li>
</ol>
<p>æ¯”è¾ƒç®€å•ï¼Œå’Œ <a href="http://svip.iocoder.cn/Netty/Channel-2-accept">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Channelï¼ˆäºŒï¼‰ä¹‹ accept æ“ä½œã€‹</a> æœ‰å‡ åˆ†ç›¸ä¼¼ã€‚æˆ–è€…æˆ‘ä»¬å¯ä»¥è¯´ï¼š</p>
<ul>
<li>NioServerSocketChannel è¯»å–æ–°çš„è¿æ¥ã€‚</li>
<li>NioSocketChannel è¯»å–æ–°çš„æ•°æ®ã€‚</li>
</ul>
<h1 id="2-NioByteUnsafe-read"><a href="#2-NioByteUnsafe-read" class="headerlink" title="2. NioByteUnsafe#read"></a>2. NioByteUnsafe#read</h1><p>NioByteUnsafe ï¼Œå®ç° AbstractNioUnsafe æŠ½è±¡ç±»ï¼ŒAbstractNioByteChannel çš„ Unsafe å®ç°ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">NioByteUnsafe</span> <span class="keyword">extends</span> <span class="title">AbstractNioUnsafe</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>{ <span class="comment">/** çœç•¥å†…éƒ¨å®ç° **/</span> }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleReadException</span><span class="params">(ChannelPipeline pipeline, ByteBuf byteBuf, Throwable cause, <span class="keyword">boolean</span> close, RecvByteBufAllocator.Handle allocHandle)</span> </span>{ <span class="comment">/** çœç•¥å†…éƒ¨å®ç° **/</span> }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeOnRead</span><span class="params">(ChannelPipeline pipeline)</span> </span>{ <span class="comment">/** çœç•¥å†…éƒ¨å®ç° **/</span> }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¸€å…±æœ‰ 3 ä¸ªæ–¹æ³•ã€‚ä½†æ˜¯å®ç°ä¸Šï¼Œå…¥å£ä¸º <code>#read()</code> æ–¹æ³•ï¼Œè€Œå¦å¤– 2 ä¸ªæ–¹æ³•è¢«å®ƒæ‰€è°ƒç”¨ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬èµ¶ç´§å¼€å§‹ <code>#read()</code> æ–¹æ³•çš„ç†è§£å§ã€‚</li>
</ul>
<h2 id="2-1-read"><a href="#2-1-read" class="headerlink" title="2.1 read"></a>2.1 read</h2><p>åœ¨ NioEventLoop çš„ <code>#processSelectedKey(SelectionKey k, AbstractNioChannel ch)</code> æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¼šçœ‹åˆ°è¿™æ ·ä¸€æ®µä»£ç ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// SelectionKey.OP_READ æˆ– SelectionKey.OP_ACCEPT å°±ç»ª</span></span><br><span class="line"><span class="comment">// readyOps == 0 æ˜¯å¯¹ JDK Bug çš„å¤„ç†ï¼Œé˜²æ­¢ç©ºçš„æ­»å¾ªç¯</span></span><br><span class="line"><span class="comment">// Also check for readOps of 0 to workaround possible JDK bug which may otherwise lead</span></span><br><span class="line"><span class="comment">// to a spin loop</span></span><br><span class="line"><span class="keyword">if</span> ((readyOps &amp; (SelectionKey.OP_READ | SelectionKey.OP_ACCEPT)) != <span class="number">0</span> || readyOps == <span class="number">0</span>) {</span><br><span class="line">    unsafe.read();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å½“ <code>(readyOps &amp; SelectionKey.OP_READ) != 0</code> æ—¶ï¼Œè¿™å°±æ˜¯ NioSocketChannel æ‰€åœ¨çš„ EventLoop çš„çº¿ç¨‹<strong>è½®è¯¢åˆ°</strong>æœ‰æ–°çš„æ•°æ®å†™å…¥ã€‚</li>
<li>ç„¶åï¼Œè°ƒç”¨ <code>NioByteUnsafe#read()</code> æ–¹æ³•ï¼Œè¯»å–æ–°çš„å†™å…¥æ•°æ®ã€‚</li>
</ul>
<hr>
<p><code>NioByteUnsafe#read()</code> æ–¹æ³•ï¼Œè¯»å–æ–°çš„å†™å…¥æ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"> <span class="number">2</span>: <span class="meta">@SuppressWarnings</span>(<span class="string">"Duplicates"</span>)</span><br><span class="line"> <span class="number">3</span>: <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">()</span> </span>{</span><br><span class="line"> <span class="number">4</span>:     <span class="keyword">final</span> ChannelConfig config = config();</span><br><span class="line"> <span class="number">5</span>:     <span class="comment">// è‹¥ inputClosedSeenErrorOnRead = true ï¼Œç§»é™¤å¯¹ SelectionKey.OP_READ äº‹ä»¶çš„æ„Ÿå…´è¶£ã€‚</span></span><br><span class="line"> <span class="number">6</span>:     <span class="keyword">if</span> (shouldBreakReadReady(config)) {</span><br><span class="line"> <span class="number">7</span>:         clearReadPending();</span><br><span class="line"> <span class="number">8</span>:         <span class="keyword">return</span>;</span><br><span class="line"> <span class="number">9</span>:     }</span><br><span class="line"><span class="number">10</span>:     <span class="keyword">final</span> ChannelPipeline pipeline = pipeline();</span><br><span class="line"><span class="number">11</span>:     <span class="keyword">final</span> ByteBufAllocator allocator = config.getAllocator();</span><br><span class="line"><span class="number">12</span>:     <span class="comment">// è·å¾— RecvByteBufAllocator.Handle å¯¹è±¡</span></span><br><span class="line"><span class="number">13</span>:     <span class="keyword">final</span> RecvByteBufAllocator.Handle allocHandle = recvBufAllocHandle();</span><br><span class="line"><span class="number">14</span>:     <span class="comment">// é‡ç½® RecvByteBufAllocator.Handle å¯¹è±¡</span></span><br><span class="line"><span class="number">15</span>:     allocHandle.reset(config);</span><br><span class="line"><span class="number">16</span>: </span><br><span class="line"><span class="number">17</span>:     ByteBuf byteBuf = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">18</span>:     <span class="keyword">boolean</span> close = <span class="keyword">false</span>; <span class="comment">// æ˜¯å¦å…³é—­è¿æ¥</span></span><br><span class="line"><span class="number">19</span>:     <span class="keyword">try</span> {</span><br><span class="line"><span class="number">20</span>:         <span class="keyword">do</span> {</span><br><span class="line"><span class="number">21</span>:             <span class="comment">// ç”³è¯· ByteBuf å¯¹è±¡</span></span><br><span class="line"><span class="number">22</span>:             byteBuf = allocHandle.allocate(allocator);</span><br><span class="line"><span class="number">23</span>:             <span class="comment">// è¯»å–æ•°æ®</span></span><br><span class="line"><span class="number">24</span>:             <span class="comment">// è®¾ç½®æœ€åè¯»å–å­—èŠ‚æ•°</span></span><br><span class="line"><span class="number">25</span>:             allocHandle.lastBytesRead(doReadBytes(byteBuf));</span><br><span class="line"><span class="number">26</span>:             <span class="comment">// &lt;1&gt; æœªè¯»å–åˆ°æ•°æ®</span></span><br><span class="line"><span class="number">27</span>:             <span class="keyword">if</span> (allocHandle.lastBytesRead() &lt;= <span class="number">0</span>) {</span><br><span class="line"><span class="number">28</span>:                 <span class="comment">// é‡Šæ”¾ ByteBuf å¯¹è±¡</span></span><br><span class="line"><span class="number">29</span>:                 <span class="comment">// nothing was read. release the buffer.</span></span><br><span class="line"><span class="number">30</span>:                 byteBuf.release();</span><br><span class="line"><span class="number">31</span>:                 <span class="comment">// ç½®ç©º ByteBuf å¯¹è±¡</span></span><br><span class="line"><span class="number">32</span>:                 byteBuf = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">33</span>:                 <span class="comment">// å¦‚æœæœ€åè¯»å–çš„å­—èŠ‚ä¸ºå°äº 0 ï¼Œè¯´æ˜å¯¹ç«¯å·²ç»å…³é—­</span></span><br><span class="line"><span class="number">34</span>:                 close = allocHandle.lastBytesRead() &lt; <span class="number">0</span>;</span><br><span class="line"><span class="number">35</span>:                 <span class="comment">// TODO</span></span><br><span class="line"><span class="number">36</span>:                 <span class="keyword">if</span> (close) {</span><br><span class="line"><span class="number">37</span>:                     <span class="comment">// There is nothing left to read as we received an EOF.</span></span><br><span class="line"><span class="number">38</span>:                     readPending = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">39</span>:                 }</span><br><span class="line"><span class="number">40</span>:                 <span class="comment">// ç»“æŸå¾ªç¯</span></span><br><span class="line"><span class="number">41</span>:                 <span class="keyword">break</span>;</span><br><span class="line"><span class="number">42</span>:             }</span><br><span class="line"><span class="number">43</span>: </span><br><span class="line"><span class="number">44</span>:             <span class="comment">// &lt;2&gt; è¯»å–åˆ°æ•°æ®</span></span><br><span class="line"><span class="number">45</span>: </span><br><span class="line"><span class="number">46</span>:             <span class="comment">// è¯»å–æ¶ˆæ¯æ•°é‡ + localRead</span></span><br><span class="line"><span class="number">47</span>:             allocHandle.incMessagesRead(<span class="number">1</span>);</span><br><span class="line"><span class="number">48</span>:             <span class="comment">// TODO èŠ‹è‰¿ readPending</span></span><br><span class="line"><span class="number">49</span>:             readPending = <span class="keyword">false</span>;</span><br><span class="line"><span class="number">50</span>:             <span class="comment">// è§¦å‘ Channel read äº‹ä»¶åˆ° pipeline ä¸­ã€‚ TODO</span></span><br><span class="line"><span class="number">51</span>:             pipeline.fireChannelRead(byteBuf);</span><br><span class="line"><span class="number">52</span>:             <span class="comment">// ç½®ç©º ByteBuf å¯¹è±¡</span></span><br><span class="line"><span class="number">53</span>:             byteBuf = <span class="keyword">null</span>;</span><br><span class="line"><span class="number">54</span>:         } <span class="keyword">while</span> (allocHandle.continueReading()); <span class="comment">// å¾ªç¯åˆ¤æ–­æ˜¯å¦ç»§ç»­è¯»å–</span></span><br><span class="line"><span class="number">55</span>: </span><br><span class="line"><span class="number">56</span>:         <span class="comment">// è¯»å–å®Œæˆ</span></span><br><span class="line"><span class="number">57</span>:         allocHandle.readComplete();</span><br><span class="line"><span class="number">58</span>:         <span class="comment">// è§¦å‘ Channel readComplete äº‹ä»¶åˆ° pipeline ä¸­ã€‚</span></span><br><span class="line"><span class="number">59</span>:         pipeline.fireChannelReadComplete();</span><br><span class="line"><span class="number">60</span>: </span><br><span class="line"><span class="number">61</span>:         <span class="comment">// å…³é—­å®¢æˆ·ç«¯çš„è¿æ¥</span></span><br><span class="line"><span class="number">62</span>:         <span class="keyword">if</span> (close) {</span><br><span class="line"><span class="number">63</span>:             closeOnRead(pipeline);</span><br><span class="line"><span class="number">64</span>:         }</span><br><span class="line"><span class="number">65</span>:     } <span class="keyword">catch</span> (Throwable t) {</span><br><span class="line"><span class="number">66</span>:         handleReadException(pipeline, byteBuf, t, close, allocHandle);</span><br><span class="line"><span class="number">67</span>:     } <span class="keyword">finally</span> {</span><br><span class="line"><span class="number">68</span>:         <span class="comment">// TODO èŠ‹è‰¿ readPending</span></span><br><span class="line"><span class="number">69</span>:         <span class="comment">// Check if there is a readPending which was not processed yet.</span></span><br><span class="line"><span class="number">70</span>:         <span class="comment">// This could be for two reasons:</span></span><br><span class="line"><span class="number">71</span>:         <span class="comment">// * The user called Channel.read() or ChannelHandlerContext.read() in channelRead(...) method</span></span><br><span class="line"><span class="number">72</span>:         <span class="comment">// * The user called Channel.read() or ChannelHandlerContext.read() in channelReadComplete(...) method</span></span><br><span class="line"><span class="number">73</span>:         <span class="comment">//</span></span><br><span class="line"><span class="number">74</span>:         <span class="comment">// See https://github.com/netty/netty/issues/2254</span></span><br><span class="line"><span class="number">75</span>:         <span class="keyword">if</span> (!readPending &amp;&amp; !config.isAutoRead()) {</span><br><span class="line"><span class="number">76</span>:             removeReadOp();</span><br><span class="line"><span class="number">77</span>:         }</span><br><span class="line"><span class="number">78</span>:     }</span><br><span class="line"><span class="number">79</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 5 è‡³ 9 è¡Œï¼šè‹¥ inputClosedSeenErrorOnRead = true ï¼Œç§»é™¤å¯¹ SelectionKey.OP_READ äº‹ä»¶çš„æ„Ÿå…´è¶£ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/Channel-7-close/">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Channelï¼ˆä¸ƒï¼‰ä¹‹ close æ“ä½œã€‹</a> çš„ <a href="#">ã€Œ5. æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­è¿æ¥ã€</a> å°èŠ‚ã€‚</li>
<li>ç¬¬ 12 è‡³ 15 è¡Œï¼šè·å¾— RecvByteBufAllocator.Handle å¯¹è±¡ï¼Œå¹¶é‡ç½®å®ƒã€‚è¿™é‡Œçš„é€»è¾‘ï¼Œå’Œ <code>NioMessageUnsafe#read()</code> æ–¹æ³•çš„ã€ç¬¬ 14 è‡³ 17 è¡Œã€‘çš„ä»£ç æ˜¯ä¸€è‡´çš„ã€‚ç›¸å…³çš„è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/Channel-2-accept">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Channelï¼ˆäºŒï¼‰ä¹‹ accept æ“ä½œã€‹</a> ã€‚</li>
<li><p>ç¬¬ 20 è‡³ 64 è¡Œï¼š<strong>while å¾ªç¯</strong> è¯»å–æ–°çš„å†™å…¥æ•°æ®ã€‚</p>
<ul>
<li>ç¬¬ 22 è¡Œï¼šè°ƒç”¨ <code>RecvByteBufAllocator.Handle#allocate(ByteBufAllocator allocator)</code> æ–¹æ³•ï¼Œç”³è¯· ByteBuf å¯¹è±¡ã€‚å…³äºå®ƒçš„å†…å®¹ï¼Œæˆ‘ä»¬æ”¾åœ¨ ByteBuf ç›¸å…³çš„æ–‡ç« ï¼Œè¯¦ç»†è§£æã€‚</li>
<li>ç¬¬ 25 è¡Œï¼šè°ƒç”¨ <code>AbstractNioByteChannel#doReadBytes(ByteBuf buf)</code> æ–¹æ³•ï¼Œè¯»å–æ•°æ®ã€‚è¯¦ç»†è§£æï¼Œèƒ–å‹å…ˆè·³åˆ° <a href="#">ã€Œ3. AbstractNioMessageChannel#doReadMessagesã€</a> ä¸­ï¼Œçœ‹å®Œè®°å¾—å›åˆ°æ­¤å¤„ã€‚</li>
<li><p>ç¬¬ 25 è¡Œï¼šè°ƒç”¨ <code>RecvByteBufAllocator.Handle#lastBytesRead(int bytes)</code> æ–¹æ³•ï¼Œè®¾ç½®<strong>æœ€å</strong>è¯»å–å­—èŠ‚æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AdaptiveRecvByteBufAllocator.HandleImpl.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lastBytesRead</span><span class="params">(<span class="keyword">int</span> bytes)</span> </span>{</span><br><span class="line">    <span class="comment">// If we read as much as we asked for we should check if we need to ramp up the size of our next guess.</span></span><br><span class="line">    <span class="comment">// This helps adjust more quickly when large amounts of data is pending and can avoid going back to</span></span><br><span class="line">    <span class="comment">// the selector to check for more data. Going back to the selector can add significant latency for large</span></span><br><span class="line">    <span class="comment">// data transfers.</span></span><br><span class="line">    <span class="keyword">if</span> (bytes == attemptedBytesRead()) {</span><br><span class="line">        record(bytes);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">super</span>.lastBytesRead(bytes);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// DefaultMaxMessagesRecvByteBufAllocator.MaxMessageHandle.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lastBytesRead</span><span class="params">(<span class="keyword">int</span> bytes)</span> </span>{</span><br><span class="line">    lastBytesRead = bytes; <span class="comment">// è®¾ç½®æœ€åä¸€æ¬¡è¯»å–å­—èŠ‚æ•° &lt;1&gt;</span></span><br><span class="line">    <span class="keyword">if</span> (bytes &gt; <span class="number">0</span>) {</span><br><span class="line">        totalBytesRead += bytes; <span class="comment">// æ€»å…±è¯»å–å­—èŠ‚æ•°</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬åªçœ‹é‡ç‚¹ï¼Œå½“ç„¶ä¹Ÿä¸ç»†è®²ã€‚</li>
<li>åœ¨ <code>&lt;1&gt;</code> å¤„ï¼Œè®¾ç½®æœ€åä¸€æ¬¡è¯»å–å­—èŠ‚æ•°ã€‚</li>
</ul>
</li>
<li><p>è¯»å–æœ‰ï¼Œæœ‰ä¸¤ç§ç»“æœï¼Œ<strong>æ˜¯</strong>/<strong>å¦</strong>è¯»å–åˆ°æ•°æ®ã€‚</p>
</li>
<li><code>&lt;1&gt;</code> <strong>æœª</strong>è¯»å–åˆ°æ•°æ®ï¼Œå³ <code>allocHandle.lastBytesRead() &lt;= 0</code> ã€‚</li>
<li>ç¬¬ 30 è¡Œï¼šè°ƒç”¨ <code>ByteBuf#release()</code> æ–¹æ³•ï¼Œé‡Šæ”¾ ByteBuf å¯¹è±¡ã€‚<ul>
<li>ç¬¬ 32 è¡Œï¼šç½®ç©º ByteBuf å¯¹è±¡ã€‚</li>
</ul>
</li>
<li>ç¬¬ 34 è¡Œï¼šå¦‚æœæœ€åè¯»å–çš„å­—èŠ‚ä¸ºå°äº 0 ï¼Œè¯´æ˜å¯¹ç«¯å·²ç»å…³é—­ã€‚</li>
<li>ç¬¬ 35 è‡³ 39 è¡Œï¼šTODO èŠ‹è‰¿ ç»†èŠ‚</li>
<li>ç¬¬ 41 è¡Œï¼š<code>break</code> ç»“æŸå¾ªç¯ã€‚</li>
<li><code>&lt;2&gt;</code> <strong>æœ‰</strong>è¯»å–åˆ°æ•°æ®ï¼Œå³ <code>allocHandle.lastBytesRead() &gt; 0</code> ã€‚</li>
<li>ç¬¬ 47 è¡Œï¼šè°ƒç”¨ <code>AdaptiveRecvByteBufAllocator.HandleImpl#incMessagesRead(int amt)</code> æ–¹æ³•ï¼Œè¯»å–æ¶ˆæ¯( å®¢æˆ·ç«¯ )æ•°é‡ + <code>localRead = 1</code> ã€‚</li>
<li>ç¬¬ 49 è¡Œï¼šTODO èŠ‹è‰¿ readPending</li>
<li><p>ç¬¬ 51 è¡Œï¼šè°ƒç”¨ <code>ChannelPipeline#fireChannelRead(Object msg)</code> æ–¹æ³•ï¼Œè§¦å‘ Channel read äº‹ä»¶åˆ° pipeline ä¸­ã€‚</p>
<ul>
<li><strong>æ³¨æ„</strong>ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šåœ¨è‡ªå·±çš„ Netty åº”ç”¨ç¨‹åºä¸­ï¼Œè‡ªå®šä¹‰ ChannelHandler å¤„ç†è¯»å–åˆ°çš„æ•°æ®ã€‚ğŸ˜ˆ å½“ç„¶ï¼Œæ­¤æ—¶è¯»å–çš„æ•°æ®ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯éœ€è¦åœ¨è§£ç ( Decode )ã€‚å…³äºè¿™ä¸€å—ï¼Œåœ¨åç»­å…³äº Codec ( ç¼–è§£ç  )çš„æ–‡ç« ä¸­ï¼Œè¯¦ç»†è§£æã€‚</li>
<li><p>å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰ ChannelHandler è¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆä¼šè¢« pipeline ä¸­çš„å°¾èŠ‚ç‚¹  TailContext æ‰€å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// TailContext.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelRead</span><span class="params">(ChannelHandlerContext ctx, Object msg)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    onUnhandledInboundMessage(msg);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// DefaultChannelPipeline.java</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onUnhandledInboundMessage</span><span class="params">(Object msg)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        logger.debug(<span class="string">"Discarded inbound message {} that reached at the tail of the pipeline. "</span> + <span class="string">"Please check your pipeline configuration."</span>, msg);</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        ReferenceCountUtil.release(msg);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æœ€ç»ˆä¹Ÿä¼š<strong>é‡Šæ”¾</strong> ByteBuf å¯¹è±¡ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆã€ç¬¬ 53 è¡Œã€‘çš„ä»£ç ï¼Œåªå»ç½®ç©º ByteBuf å¯¹è±¡ï¼Œè€Œä¸ç”¨å†å»é‡Šæ”¾çš„åŸå› ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 53 è¡Œï¼šç½®ç©º ByteBuf å¯¹è±¡ã€‚</li>
<li><p>ç¬¬ 54 è¡Œï¼šè°ƒç”¨ <code>AdaptiveRecvByteBufAllocator.HandleImpl#incMessagesRead(int amt)#continueReading()</code> æ–¹æ³•ï¼Œåˆ¤æ–­æ˜¯å¦å¾ªç¯æ˜¯å¦ç»§ç»­ï¼Œè¯»å–æ–°çš„æ•°æ®ã€‚ä»£ç å¦‚ä¸‹ï¼š </p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// DefaultMaxMessagesRecvByteBufAllocator.MaxMessageHandle.java</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> UncheckedBooleanSupplier defaultMaybeMoreSupplier = <span class="keyword">new</span> UncheckedBooleanSupplier() {</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">get</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> attemptedBytesRead == lastBytesRead; <span class="comment">// æœ€åè¯»å–çš„å­—èŠ‚æ•°ï¼Œæ˜¯å¦ç­‰äºï¼Œæœ€å¤§å¯å†™å…¥çš„å­—èŠ‚æ•°</span></span><br><span class="line">    }</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">continueReading</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> continueReading(defaultMaybeMoreSupplier);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">continueReading</span><span class="params">(UncheckedBooleanSupplier maybeMoreDataSupplier)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> config.isAutoRead() &amp;&amp;</span><br><span class="line">           (!respectMaybeMoreData || maybeMoreDataSupplier.get()) &amp;&amp; <span class="comment">// &lt;1&gt;</span></span><br><span class="line">           totalMessages &lt; maxMessagePerRead &amp;&amp;</span><br><span class="line">           totalBytesRead &gt; <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæœ€åè¯»å–çš„å­—èŠ‚æ•°ï¼Œ<strong>ä¸ç­‰äº</strong>æœ€å¤§å¯å†™å…¥çš„å­—èŠ‚æ•°ï¼Œå³ <code>&lt;1&gt;</code> å¤„çš„ä»£ç  <code>UncheckedBooleanSupplier#get()</code> è¿”å› <code>false</code> ï¼Œåˆ™ä¸å†è¿›è¡Œæ•°æ®è¯»å–ã€‚å› ä¸º ğŸ˜ˆ ä¹Ÿæ²¡æœ‰æ•°æ®å¯ä»¥è¯»å–å•¦ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 57 è¡Œï¼šè°ƒç”¨ <code>RecvByteBufAllocator.Handle#readComplete()</code> æ–¹æ³•ï¼Œè¯»å–å®Œæˆã€‚æš‚æ— é‡è¦çš„é€»è¾‘ï¼Œä¸è¯¦ç»†è§£æã€‚</li>
<li><p>ç¬¬ 59 è¡Œï¼šè°ƒç”¨ <code>ChannelPipeline#fireChannelReadComplete()</code> æ–¹æ³•ï¼Œè§¦å‘ Channel readComplete äº‹ä»¶åˆ° pipeline ä¸­ã€‚</p>
<ul>
<li><em>å¦‚æœæœ‰éœ€è¦ï¼Œèƒ–å‹å¯ä»¥è‡ªå®šä¹‰å¤„ç†å™¨ï¼Œå¤„ç†è¯¥äº‹ä»¶ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸éœ€è¦</em>ã€‚</li>
<li><p>å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰ ChannelHandler è¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆä¼šè¢« pipeline ä¸­çš„å°¾èŠ‚ç‚¹  TailContext æ‰€å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// TailContext.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">channelReadComplete</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    onUnhandledInboundChannelReadComplete();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// DefaultChannelPipeline.java</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onUnhandledInboundChannelReadComplete</span><span class="params">()</span> </span>{</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å…·ä½“çš„è°ƒç”¨æ˜¯<strong>ç©ºæ–¹æ³•</strong>ã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 61 è‡³ 64 è¡Œï¼šå…³é—­å®¢æˆ·ç«¯çš„è¿æ¥ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/Channel-7-close/">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Channelï¼ˆä¸ƒï¼‰ä¹‹ close æ“ä½œã€‹</a> çš„ <a href="#">ã€Œ5. æœåŠ¡ç«¯å¤„ç†å®¢æˆ·ç«¯ä¸»åŠ¨å…³é—­è¿æ¥ã€</a> å°èŠ‚ã€‚</li>
<li>ç¬¬ 65 è‡³ 66 è¡Œï¼šå½“å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œè°ƒç”¨ <code>#handleReadException(hannelPipeline pipeline, ByteBuf byteBuf, Throwable cause, boolean close, RecvByteBufAllocator.Handle allocHandle)</code> æ–¹æ³•ï¼Œå¤„ç†å¼‚å¸¸ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ2.2 handleReadExceptionã€</a> ä¸­ã€‚</li>
<li>ç¬¬ 67 è‡³ 78 è¡Œï¼šTODO èŠ‹è‰¿ ç»†èŠ‚</li>
</ul>
<h2 id="2-2-handleReadException"><a href="#2-2-handleReadException" class="headerlink" title="2.2 handleReadException"></a>2.2 handleReadException</h2><p><code>#handleReadException(hannelPipeline pipeline, ByteBuf byteBuf, Throwable cause, boolean close, RecvByteBufAllocator.Handle allocHandle)</code> æ–¹æ³•ï¼Œå¤„ç†å¼‚å¸¸ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"> <span class="number">1</span>: <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleReadException</span><span class="params">(ChannelPipeline pipeline, ByteBuf byteBuf, Throwable cause, <span class="keyword">boolean</span> close, RecvByteBufAllocator.Handle allocHandle)</span> </span>{</span><br><span class="line"> <span class="number">2</span>:     <span class="keyword">if</span> (byteBuf != <span class="keyword">null</span>) {</span><br><span class="line"> <span class="number">3</span>:         <span class="keyword">if</span> (byteBuf.isReadable()) {</span><br><span class="line"> <span class="number">4</span>:             <span class="comment">// TODO èŠ‹è‰¿ ç»†èŠ‚</span></span><br><span class="line"> <span class="number">5</span>:             readPending = <span class="keyword">false</span>;</span><br><span class="line"> <span class="number">6</span>:             <span class="comment">// è§¦å‘ Channel read äº‹ä»¶åˆ° pipeline ä¸­ã€‚</span></span><br><span class="line"> <span class="number">7</span>:             pipeline.fireChannelRead(byteBuf);</span><br><span class="line"> <span class="number">8</span>:         } <span class="keyword">else</span> {</span><br><span class="line"> <span class="number">9</span>:             <span class="comment">// é‡Šæ”¾ ByteBuf å¯¹è±¡</span></span><br><span class="line"><span class="number">10</span>:             byteBuf.release();</span><br><span class="line"><span class="number">11</span>:         }</span><br><span class="line"><span class="number">12</span>:     }</span><br><span class="line"><span class="number">13</span>:     <span class="comment">// è¯»å–å®Œæˆ</span></span><br><span class="line"><span class="number">14</span>:     allocHandle.readComplete();</span><br><span class="line"><span class="number">15</span>:     <span class="comment">// è§¦å‘ Channel readComplete äº‹ä»¶åˆ° pipeline ä¸­ã€‚</span></span><br><span class="line"><span class="number">16</span>:     pipeline.fireChannelReadComplete();</span><br><span class="line"><span class="number">17</span>:     <span class="comment">// è§¦å‘ exceptionCaught äº‹ä»¶åˆ° pipeline ä¸­ã€‚</span></span><br><span class="line"><span class="number">18</span>:     pipeline.fireExceptionCaught(cause);</span><br><span class="line"><span class="number">19</span>:     <span class="comment">// // TODO èŠ‹è‰¿ ç»†èŠ‚</span></span><br><span class="line"><span class="number">20</span>:     <span class="keyword">if</span> (close || cause <span class="keyword">instanceof</span> IOException) {</span><br><span class="line"><span class="number">21</span>:         closeOnRead(pipeline);</span><br><span class="line"><span class="number">22</span>:     }</span><br><span class="line"><span class="number">23</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>ç¬¬ 2 è¡Œï¼š<code>byteBuf</code> éç©ºï¼Œè¯´æ˜åœ¨å‘ç”Ÿå¼‚å¸¸ä¹‹å‰ï¼Œè‡³å°‘ç”³è¯· ByteBuf å¯¹è±¡æ˜¯<strong>æˆåŠŸ</strong>çš„ã€‚</p>
<ul>
<li><p>ç¬¬ 3 è¡Œï¼šè°ƒç”¨ <code>ByteBuf#isReadable()</code> æ–¹æ³•ï¼Œåˆ¤æ–­ ByteBuf å¯¹è±¡æ˜¯å¦å¯è¯»ï¼Œå³å‰©ä½™å¯è¯»çš„å­—èŠ‚æ•°æ®ã€‚</p>
<ul>
<li><p>è¯¥æ–¹æ³•çš„è‹±æ–‡æ³¨é‡Šå¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Returns {<span class="doctag">@code</span> true}</span></span><br><span class="line"><span class="comment"> * if and only if {<span class="doctag">@code</span> (this.writerIndex - this.readerIndex)} is greater</span></span><br><span class="line"><span class="comment"> * than {<span class="doctag">@code</span> 0}.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">isReadable</span><span class="params">()</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å³ <code>this.writerIndex - this.readerIndex &gt; 0</code> ã€‚</li>
</ul>
</li>
<li>ç¬¬ 5 è¡Œï¼šTODO èŠ‹è‰¿ ç»†èŠ‚</li>
<li>ç¬¬ 7 è¡Œï¼šè°ƒç”¨ <code>ChannelPipeline#fireChannelRead(Object msg)</code> æ–¹æ³•ï¼Œè§¦å‘ Channel read äº‹ä»¶åˆ° pipeline ä¸­ã€‚</li>
</ul>
</li>
<li>ç¬¬ 8 è‡³ 11 è¡Œï¼šByteBuf å¯¹è±¡ä¸å¯è¯»ï¼Œæ‰€ä»¥è°ƒç”¨ <code>ByteBuf#release()</code> æ–¹æ³•ï¼Œé‡Šæ”¾ ByteBuf å¯¹è±¡ã€‚</li>
</ul>
</li>
<li>ç¬¬ 14 è¡Œï¼šè°ƒç”¨ <code>RecvByteBufAllocator.Handle#readComplete()</code> æ–¹æ³•ï¼Œè¯»å–å®Œæˆã€‚æš‚æ— é‡è¦çš„é€»è¾‘ï¼Œä¸è¯¦ç»†è§£æã€‚</li>
<li>ç¬¬ 16 è¡Œï¼šè°ƒç”¨ <code>ChannelPipeline#fireChannelReadComplete()</code> æ–¹æ³•ï¼Œè§¦å‘ Channel readComplete äº‹ä»¶åˆ° pipeline ä¸­ã€‚</li>
<li><p>ç¬¬ 18 è¡Œï¼šè°ƒç”¨ <code>ChannelPipeline#fireExceptionCaught(Throwable)</code> æ–¹æ³•ï¼Œè§¦å‘ exceptionCaught äº‹ä»¶åˆ° pipeline ä¸­ã€‚</p>
<ul>
<li><strong>æ³¨æ„</strong>ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¼šåœ¨è‡ªå·±çš„ Netty åº”ç”¨ç¨‹åºä¸­ï¼Œè‡ªå®šä¹‰ ChannelHandler å¤„ç†å¼‚å¸¸ã€‚</li>
<li><p>å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰ ChannelHandler è¿›è¡Œå¤„ç†ï¼Œæœ€ç»ˆä¼šè¢« pipeline ä¸­çš„å°¾èŠ‚ç‚¹  TailContext æ‰€å¤„ç†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// TailContext.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exceptionCaught</span><span class="params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    onUnhandledInboundException(cause);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// DefaultChannelPipeline.java</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onUnhandledInboundException</span><span class="params">(Throwable cause)</span> </span>{</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        logger.warn(<span class="string">"An exceptionCaught() event was fired, and it reached at the tail of the pipeline. "</span> +</span><br><span class="line">                        <span class="string">"It usually means the last handler in the pipeline did not handle the exception."</span>,</span><br><span class="line">                cause);</span><br><span class="line">    } <span class="keyword">finally</span> {</span><br><span class="line">        ReferenceCountUtil.release(cause);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>æ‰“å°<strong>å‘Šè­¦</strong>æ—¥å¿—ã€‚</li>
<li>è°ƒç”¨ <code>ReferenceCountUtil#release(Object msg)</code> æ–¹æ³•ï¼Œé‡Šæ”¾å’Œå¼‚å¸¸ç›¸å…³çš„èµ„æºã€‚</li>
</ul>
</li>
</ul>
</li>
<li>ç¬¬ 19 è‡³ 22 è¡Œï¼šTODO èŠ‹è‰¿ï¼Œç»†èŠ‚</li>
</ul>
<h2 id="2-3-closeOnRead"><a href="#2-3-closeOnRead" class="headerlink" title="2.3 closeOnRead"></a>2.3 closeOnRead</h2><p>TODO èŠ‹è‰¿ï¼Œç»†èŠ‚</p>
<h1 id="3-AbstractNioByteChannel-doReadBytes"><a href="#3-AbstractNioByteChannel-doReadBytes" class="headerlink" title="3. AbstractNioByteChannel#doReadBytes"></a>3. AbstractNioByteChannel#doReadBytes</h1><p><code>doReadBytes(ByteBuf buf)</code> <strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œè¯»å–å†™å…¥çš„æ•°æ®åˆ°æ–¹æ³•å‚æ•° <code>buf</code> ä¸­ã€‚å®ƒæ˜¯ä¸€ä¸ª<strong>æŠ½è±¡</strong>æ–¹æ³•ï¼Œå®šä¹‰åœ¨ AbstractNioByteChannel æŠ½è±¡ç±»ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Read bytes into the given {<span class="doctag">@link</span> ByteBuf} and return the amount.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">doReadBytes</span><span class="params">(ByteBuf buf)</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¿”å›å€¼ä¸ºè¯»å–åˆ°çš„å­—èŠ‚æ•°ã€‚</li>
<li><strong>å½“è¿”å›å€¼å°äº 0 æ—¶ï¼Œè¡¨ç¤ºå¯¹ç«¯å·²ç»å…³é—­</strong>ã€‚</li>
</ul>
<p>NioSocketChannel å¯¹è¯¥æ–¹æ³•çš„å®ç°ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="number">1</span>: <span class="meta">@Override</span></span><br><span class="line"><span class="number">2</span>: <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">doReadBytes</span><span class="params">(ByteBuf byteBuf)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line"><span class="number">3</span>:     <span class="comment">// è·å¾— RecvByteBufAllocator.Handle å¯¹è±¡</span></span><br><span class="line"><span class="number">4</span>:     <span class="keyword">final</span> RecvByteBufAllocator.Handle allocHandle = unsafe().recvBufAllocHandle();</span><br><span class="line"><span class="number">5</span>:     <span class="comment">// è®¾ç½®æœ€å¤§å¯è¯»å–å­—èŠ‚æ•°é‡ã€‚å› ä¸º ByteBuf ç›®å‰æœ€å¤§å†™å…¥çš„å¤§å°ä¸º byteBuf.writableBytes()</span></span><br><span class="line"><span class="number">6</span>:     allocHandle.attemptedBytesRead(byteBuf.writableBytes());</span><br><span class="line"><span class="number">7</span>:     <span class="comment">// è¯»å–æ•°æ®åˆ° ByteBuf ä¸­</span></span><br><span class="line"><span class="number">8</span>:     <span class="keyword">return</span> byteBuf.writeBytes(javaChannel(), allocHandle.attemptedBytesRead());</span><br><span class="line"><span class="number">9</span>: }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ 4 è¡Œï¼šè·å¾— RecvByteBufAllocator.Handle å¯¹è±¡ã€‚<ul>
<li>ç¬¬ 6 è¡Œï¼šè®¾ç½®æœ€å¤§å¯è¯»å–å­—èŠ‚æ•°é‡ã€‚å› ä¸º ByteBuf å¯¹è±¡<strong>ç›®å‰</strong>æœ€å¤§å¯å†™å…¥çš„å¤§å°ä¸º <code>ByteBuf#writableBytes()</code> çš„é•¿åº¦ã€‚</li>
</ul>
</li>
<li><p>ç¬¬ 8 è¡Œï¼šè°ƒç”¨ <code>ByteBuf#writeBytes(ScatteringByteChannel in, int length)</code> æ–¹æ³•ï¼Œè¯»å–æ•°æ®åˆ° ByteBuf å¯¹è±¡ä¸­ã€‚å› ä¸º ByteBuf æœ‰å¤šç§å®ç°ï¼Œæˆ‘ä»¬ä»¥é»˜è®¤çš„ PooledUnsafeDirectByteBuf ä¸¾ä¾‹å­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractByteBuf.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">writeBytes</span><span class="params">(ScatteringByteChannel in, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    ensureWritable(length);</span><br><span class="line">    <span class="keyword">int</span> writtenBytes = setBytes(writerIndex, in, length); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">    <span class="keyword">if</span> (writtenBytes &gt; <span class="number">0</span>) { <span class="comment">// &lt;3&gt;</span></span><br><span class="line">        writerIndex += writtenBytes;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> writtenBytes;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// PooledUnsafeDirectByteBuf.java</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">setBytes</span><span class="params">(<span class="keyword">int</span> index, ScatteringByteChannel in, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> IOException </span>{</span><br><span class="line">    checkIndex(index, length);</span><br><span class="line">    ByteBuffer tmpBuf = internalNioBuffer();</span><br><span class="line">    index = idx(index);</span><br><span class="line">    tmpBuf.clear().position(index).limit(index + length);</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        <span class="keyword">return</span> in.read(tmpBuf); <span class="comment">// &lt;2&gt;</span></span><br><span class="line">    } <span class="keyword">catch</span> (ClosedChannelException ignored) {</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä»£ç æ¯”è¾ƒå¤šï¼Œæˆ‘ä»¬åªçœ‹é‡ç‚¹ï¼Œå½“ç„¶ä¹Ÿä¸ç»†è®²ã€‚è¿˜æ˜¯é‚£å¥è¯ï¼Œå…³äº ByteBuf çš„å†…å®¹ï¼Œæˆ‘ä»¬åœ¨ ByteBuf ç›¸å…³çš„æ–‡ç« è¯¦ç»†è§£æã€‚</li>
<li>åœ¨ <code>&lt;1&gt;</code> å¤„ï¼Œä¼šè°ƒç”¨ <code>#setBytes(int index, ScatteringByteChannel in, int length)</code> æ–¹æ³•ã€‚</li>
<li>åœ¨ <code>&lt;2&gt;</code> å¤„ï¼Œä¼šè°ƒç”¨ Java NIO çš„ <code>ScatteringByteChannel#read(ByteBuffer)</code> æ–¹æ³•ï¼Œè¯»å–<strong>æ•°æ®</strong>åˆ°ä¸´æ—¶çš„ Java NIO ByteBuffer ä¸­ã€‚<ul>
<li>åœ¨å¯¹ç«¯æœªæ–­å¼€æ—¶ï¼Œè¿”å›çš„æ˜¯è¯»å–æ•°æ®çš„<strong>å­—èŠ‚æ•°</strong>ã€‚</li>
<li>åœ¨å¯¹ç«¯å·²æ–­å¼€æ—¶ï¼Œè¿”å› <code>-1</code> ï¼Œè¡¨ç¤ºæ–­å¼€ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ <code>&lt;3&gt;</code> å¤„åšäº† <code>writtenBytes &gt; 0</code> çš„åˆ¤æ–­çš„åŸå› ã€‚</li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ¨èé˜…è¯»æ–‡ç« ï¼š</p>
<ul>
<li>é—ªç”µä¾  <a href="https://www.jianshu.com/p/6b48196b5043" rel="external nofollow noopener noreferrer" target="_blank">ã€Šæ·±å…¥æµ…å‡º Netty readã€‹</a></li>
<li>Hypercube <a href="https://www.jianshu.com/p/9258af254e1d" rel="external nofollow noopener noreferrer" target="_blank">ã€Šè‡ªé¡¶å‘ä¸‹æ·±å…¥åˆ†æNettyï¼ˆå…­ï¼‰â€“ Channelæºç å®ç°ã€‹</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/Channel-3-read/" data-id="ck4pl3fp500e2fgcfrk29d8af" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>