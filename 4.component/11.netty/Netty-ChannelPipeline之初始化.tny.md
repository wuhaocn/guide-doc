<div class="article-inner">


<header class="article-header">


<h1 class="article-title" itemprop="name">
ç²¾å°½ Netty æºç è§£æ â€”â€” ChannelPipelineï¼ˆä¸€ï¼‰ä¹‹åˆå§‹åŒ–
</h1>


</header>

<div class="article-entry" itemprop="articleBody">

<!-- Table of Contents -->

<h1 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h1><p>åœ¨ <a href="http://svip.iocoder.cn/Netty/intro-2/?self">ã€Šç²¾å°½ Netty æºç åˆ†æ â€”â€” Netty ç®€ä»‹ï¼ˆäºŒï¼‰ä¹‹æ ¸å¿ƒç»„ä»¶ã€‹</a> ä¸­ï¼Œå¯¹ EventLoopGroup å’Œ EventLoop åšäº†å®šä¹‰ï¼Œæˆ‘ä»¬å†æ¥å›é¡¾ä¸‹ï¼š</p>
<blockquote>
<p>ChannelPipeline ä¸º ChannelHandler çš„<strong>é“¾</strong>ï¼Œæä¾›äº†ä¸€ä¸ªå®¹å™¨å¹¶å®šä¹‰äº†ç”¨äºæ²¿ç€é“¾ä¼ æ’­å…¥ç«™å’Œå‡ºç«™äº‹ä»¶æµçš„ API ã€‚ä¸€ä¸ªæ•°æ®æˆ–è€…äº‹ä»¶å¯èƒ½ä¼šè¢«å¤šä¸ª Handler å¤„ç†ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæ•°æ®æˆ–è€…äº‹ä»¶ç»æµ ChannelPipeline ï¼Œç”± ChannelHandler å¤„ç†ã€‚åœ¨è¿™ä¸ªå¤„ç†è¿‡ç¨‹ä¸­ï¼Œä¸€ä¸ª ChannelHandler æ¥æ”¶æ•°æ®åå¤„ç†å®Œæˆåäº¤ç»™ä¸‹ä¸€ä¸ª ChannelHandlerï¼Œæˆ–è€…ä»€ä¹ˆéƒ½ä¸åšç›´æ¥äº¤ç»™ä¸‹ä¸€ä¸ª ChannelHandlerã€‚</p>
</blockquote>
<p>å› ä¸º ChannelPipeline æ¶‰åŠçš„ä»£ç é‡è¾ƒå¤§ï¼Œæ‰€ä»¥ç¬”è€…ä¼šåˆ†æˆå¥½å‡ ç¯‡æ–‡ç« åˆ†åˆ«åˆ†äº«ã€‚è€Œæœ¬æ–‡ï¼Œæˆ‘ä»¬æ¥åˆ†äº« ChannelPipeline çš„<strong>åˆå§‹åŒ–</strong>ã€‚ä¹Ÿå› æ­¤ï¼Œæœ¬æ–‡æ›´å¤šæ˜¯ä½“ç° ChannelPipeline çš„<strong>æ•´ä½“æ€§</strong>ï¼Œæ‰€ä»¥ä¸ä¼šè¿‡å¤šä»‹ç»æ¯ä¸ªç±»çš„å…·ä½“çš„<strong>æ¯ä¸ªæ–¹æ³•</strong>çš„å®ç°ã€‚</p>
<h1 id="2-ChannelPipeline"><a href="#2-ChannelPipeline" class="headerlink" title="2. ChannelPipeline"></a>2. ChannelPipeline</h1><p><code>io.netty.channel.ChannelPipeline</code> ï¼Œç»§æ‰¿ ChannelInboundInvokerã€ChannelOutboundInvokerã€Iterable æ¥å£ï¼ŒChannel Pipeline æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ChannelPipeline</span></span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">ChannelInboundInvoker</span>, <span class="title">ChannelOutboundInvoker</span>, <span class="title">Iterable</span>&lt;<span class="title">Entry</span>&lt;<span class="title">String</span>, <span class="title">ChannelHandler</span>&gt;&gt; </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== æ·»åŠ  ChannelHandler ç›¸å…³ ==========</span></span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">addFirst</span><span class="params">(String name, ChannelHandler handler)</span></span>;</span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">addFirst</span><span class="params">(EventExecutorGroup group, String name, ChannelHandler handler)</span></span>;</span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">addLast</span><span class="params">(String name, ChannelHandler handler)</span></span>;</span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">addLast</span><span class="params">(EventExecutorGroup group, String name, ChannelHandler handler)</span></span>;</span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">addBefore</span><span class="params">(String baseName, String name, ChannelHandler handler)</span></span>;</span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">addBefore</span><span class="params">(EventExecutorGroup group, String baseName, String name, ChannelHandler handler)</span></span>;</span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">addAfter</span><span class="params">(String baseName, String name, ChannelHandler handler)</span></span>;</span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">addAfter</span><span class="params">(EventExecutorGroup group, String baseName, String name, ChannelHandler handler)</span></span>;</span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">addFirst</span><span class="params">(ChannelHandler... handlers)</span></span>;</span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">addFirst</span><span class="params">(EventExecutorGroup group, ChannelHandler... handlers)</span></span>;</span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">addLast</span><span class="params">(ChannelHandler... handlers)</span></span>;</span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">addLast</span><span class="params">(EventExecutorGroup group, ChannelHandler... handlers)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== ç§»é™¤ ChannelHandler ç›¸å…³ ==========</span></span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">remove</span><span class="params">(ChannelHandler handler)</span></span>;</span><br><span class="line">    <span class="function">ChannelHandler <span class="title">remove</span><span class="params">(String name)</span></span>;</span><br><span class="line">    &lt;T extends ChannelHandler&gt; <span class="function">T <span class="title">remove</span><span class="params">(Class&lt;T&gt; handlerType)</span></span>;</span><br><span class="line">    <span class="function">ChannelHandler <span class="title">removeFirst</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">ChannelHandler <span class="title">removeLast</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ========== æ›¿æ¢ ChannelHandler ç›¸å…³ ==========</span></span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">replace</span><span class="params">(ChannelHandler oldHandler, String newName, ChannelHandler newHandler)</span></span>;</span><br><span class="line">    <span class="function">ChannelHandler <span class="title">replace</span><span class="params">(String oldName, String newName, ChannelHandler newHandler)</span></span>;</span><br><span class="line">    &lt;T extends ChannelHandler&gt; <span class="function">T <span class="title">replace</span><span class="params">(Class&lt;T&gt; oldHandlerType, String newName, ChannelHandler newHandler)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== æŸ¥è¯¢ ChannelHandler ç›¸å…³ ==========</span></span><br><span class="line">    <span class="function">ChannelHandler <span class="title">first</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">ChannelHandlerContext <span class="title">firstContext</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">ChannelHandler <span class="title">last</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">ChannelHandlerContext <span class="title">lastContext</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">ChannelHandler <span class="title">get</span><span class="params">(String name)</span></span>;</span><br><span class="line">    &lt;T extends ChannelHandler&gt; <span class="function">T <span class="title">get</span><span class="params">(Class&lt;T&gt; handlerType)</span></span>;</span><br><span class="line">    <span class="function">ChannelHandlerContext <span class="title">context</span><span class="params">(ChannelHandler handler)</span></span>;</span><br><span class="line">    <span class="function">ChannelHandlerContext <span class="title">context</span><span class="params">(String name)</span></span>;</span><br><span class="line">    <span class="function">ChannelHandlerContext <span class="title">context</span><span class="params">(Class&lt;? extends ChannelHandler&gt; handlerType)</span></span>;</span><br><span class="line">    <span class="function">List&lt;String&gt; <span class="title">names</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== Channel ç›¸å…³ ==========</span></span><br><span class="line">    <span class="function">Channel <span class="title">channel</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== ChannelInboundInvoker ç›¸å…³ ==========    </span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">fireChannelRegistered</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">fireChannelUnregistered</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">fireChannelActive</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">fireChannelInactive</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">fireExceptionCaught</span><span class="params">(Throwable cause)</span></span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">fireUserEventTriggered</span><span class="params">(Object event)</span></span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">fireChannelRead</span><span class="params">(Object msg)</span></span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">fireChannelReadComplete</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">fireChannelWritabilityChanged</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ========== ChannelOutboundInvoker ç›¸å…³ ==========    </span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">ChannelPipeline <span class="title">flush</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>è™½ç„¶æ¥å£çš„æ–¹æ³•æ¯”è¾ƒå¤šï¼Œç¬”è€…åšäº†å½’ç±»å¦‚ä¸‹ï¼š</p>
<ul>
<li>ChannelHandler çš„å¢åˆ æ”¹æŸ¥çš„ç›¸å…³æ–¹æ³•ã€‚</li>
<li>Channel çš„ç›¸å…³æ–¹æ³•ï¼Œç›®å‰åªæœ‰ä¸€ä¸ªã€‚</li>
<li>ç»§æ‰¿è‡ª ChannelInboundInvoker çš„ç›¸å…³æ–¹æ³•ã€‚</li>
<li>ç»§æ‰¿è‡ª ChannelOutboundInvoker çš„ç›¸å…³æ–¹æ³•ã€‚</li>
</ul>
<p>æœ‰å¯èƒ½ä¼šç–‘æƒ‘ä¸ºä»€ä¹ˆç»§æ‰¿ Iterable æ¥å£ï¼Ÿå› ä¸º ChannelPipeline æ˜¯ ChannelHandler çš„<strong>é“¾</strong>ã€‚</p>
<p>ChannelPipeline çš„ç±»å›¾å¦‚ä¸‹ï¼š</p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_06_01/01.png" title="ChannelPipeline ç±»å›¾" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_06_01/01.png" alt="ChannelPipeline ç±»å›¾"></a><span class="caption">ChannelPipeline ç±»å›¾</span></p>
<h2 id="2-1-ChannelInboundInvoker"><a href="#2-1-ChannelInboundInvoker" class="headerlink" title="2.1 ChannelInboundInvoker"></a>2.1 ChannelInboundInvoker</h2><p><code>io.netty.channel.ChannelInboundInvoker</code> ï¼ŒChannel Inbound Invoker( è°ƒç”¨è€… ) æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function">ChannelPipeline <span class="title">fireChannelRegistered</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">fireChannelUnregistered</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">fireChannelActive</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">fireChannelInactive</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">fireExceptionCaught</span><span class="params">(Throwable cause)</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">fireUserEventTriggered</span><span class="params">(Object event)</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">fireChannelRead</span><span class="params">(Object msg)</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">fireChannelReadComplete</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">fireChannelWritabilityChanged</span><span class="params">()</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é€šçŸ¥ Channel äº‹ä»¶çš„æ¥å£æ–¹æ³•ã€‚</li>
</ul>
<h2 id="2-2-ChannelOutboundInvoker"><a href="#2-2-ChannelOutboundInvoker" class="headerlink" title="2.2 ChannelOutboundInvoker"></a>2.2 ChannelOutboundInvoker</h2><p><code>io.netty.channel.ChannelOutboundInvoker</code> ï¼ŒChannel Outbound Invoker( è°ƒç”¨è€… ) æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ========== Channel æ“ä½œç›¸å…³ ==========    </span></span><br><span class="line"><span class="function">ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress)</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">connect</span><span class="params">(SocketAddress remoteAddress)</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">connect</span><span class="params">(SocketAddress remoteAddress, SocketAddress localAddress)</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">disconnect</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">deregister</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">bind</span><span class="params">(SocketAddress localAddress, ChannelPromise promise)</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">connect</span><span class="params">(SocketAddress remoteAddress, ChannelPromise promise)</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">connect</span><span class="params">(SocketAddress remoteAddress, SocketAddress localAddress, ChannelPromise promise)</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">disconnect</span><span class="params">(ChannelPromise promise)</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">close</span><span class="params">(ChannelPromise promise)</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">deregister</span><span class="params">(ChannelPromise promise)</span></span>;</span><br><span class="line"><span class="function">ChannelOutboundInvoker <span class="title">read</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">write</span><span class="params">(Object msg)</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">write</span><span class="params">(Object msg, ChannelPromise promise)</span></span>;</span><br><span class="line"><span class="function">ChannelOutboundInvoker <span class="title">flush</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">writeAndFlush</span><span class="params">(Object msg, ChannelPromise promise)</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">writeAndFlush</span><span class="params">(Object msg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== Promise ç›¸å…³ ==========    </span></span><br><span class="line"><span class="function">ChannelPromise <span class="title">newPromise</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelProgressivePromise <span class="title">newProgressivePromise</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">newSucceededFuture</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelFuture <span class="title">newFailedFuture</span><span class="params">(Throwable cause)</span></span>;</span><br><span class="line"><span class="function">ChannelPromise <span class="title">voidPromise</span><span class="params">()</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å‘èµ· Channel æ“ä½œçš„æ¥å£æ–¹æ³•ã€‚</li>
<li>åˆ›å»º Promise å¯¹è±¡çš„æ¥å£æ–¹æ³•ã€‚</li>
</ul>
<h2 id="2-3-Outbound-v-s-Inbound-äº‹ä»¶"><a href="#2-3-Outbound-v-s-Inbound-äº‹ä»¶" class="headerlink" title="2.3 Outbound v.s Inbound äº‹ä»¶"></a>2.3 Outbound v.s Inbound äº‹ä»¶</h2><p>åœ¨ <a href="https://segmentfault.com/a/1190000007309311" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty æºç åˆ†æä¹‹ äºŒ è´¯ç©¿Netty çš„å¤§åŠ¨è„‰ â”€â”€ ChannelPipeline (äºŒ)ã€‹</a> ä¸­ï¼Œç¬”è€…çœ‹åˆ°ä¸€ä¸ªæ¯”è¾ƒä¸é”™çš„æ€»ç»“ï¼š</p>
<blockquote>
<p>è€è‰¿è‰¿ï¼šå› ä¸ºè¦åŠ ä¸€äº›æ³¨é‡Šï¼Œæ‰€ä»¥æš‚æ—¶ä¸ä½¿ç”¨å¼•ç”¨ã€‚</p>
</blockquote>
<p><strong>å¯¹äº Outbound äº‹ä»¶</strong>ï¼š</p>
<ul>
<li>Outbound äº‹ä»¶æ˜¯ã€è¯·æ±‚ã€‘äº‹ä»¶(ç”± Connect å‘èµ·ä¸€ä¸ªè¯·æ±‚, å¹¶æœ€ç»ˆç”± Unsafe å¤„ç†è¿™ä¸ªè¯·æ±‚)</li>
<li>Outbound äº‹ä»¶çš„å‘èµ·è€…æ˜¯ Channel</li>
<li>Outbound äº‹ä»¶çš„å¤„ç†è€…æ˜¯ Unsafe</li>
<li><p>Outbound äº‹ä»¶åœ¨ Pipeline ä¸­çš„ä¼ è¾“æ–¹å‘æ˜¯ <code>tail</code> -&gt; <code>head</code> </p>
<blockquote>
<p>æ—ç™½ï¼šOutbound ç¿»è¯‘ä¸ºâ€œå‡ºç«™â€ï¼Œæ‰€ä»¥ä» <code>tail</code>( å°¾ )åˆ° <code>head</code>( å¤´ )ä¹Ÿåˆç†ã€‚</p>
<p>è‡³äºä»€ä¹ˆæ˜¯ <code>head</code> å’Œ <code>tail</code> ï¼Œç­‰çœ‹äº†å…·ä½“çš„ ChannelPipeline å®ç°ç±» DefaultChannelPipeline å†è¯´ã€‚</p>
</blockquote>
</li>
<li><p>åœ¨ ChannelHandler ä¸­å¤„ç†äº‹ä»¶æ—¶, å¦‚æœè¿™ä¸ª Handler ä¸æ˜¯æœ€åä¸€ä¸ª Handler, åˆ™éœ€è¦è°ƒç”¨ <code>ctx.xxx</code> (ä¾‹å¦‚ <code>ctx.connect</code> ) å°†æ­¤äº‹ä»¶ç»§ç»­ä¼ æ’­ä¸‹å». å¦‚æœä¸è¿™æ ·åš, é‚£ä¹ˆæ­¤äº‹ä»¶çš„ä¼ æ’­ä¼šæå‰ç»ˆæ­¢.</p>
</li>
<li>Outbound äº‹ä»¶æµ: <code>Context.OUT_EVT</code> -&gt; <code>Connect.findContextOutbound</code> -&gt; <code>nextContext.invokeOUT_EVT</code> -&gt; <code>nextHandler.OUT_EVT</code> -&gt; <code>nextContext.OUT_EVT</code></li>
</ul>
<p><strong>å¯¹äº Inbound äº‹ä»¶</strong>ï¼š</p>
<ul>
<li>Inbound äº‹ä»¶æ˜¯ã€é€šçŸ¥ã€‘äº‹ä»¶, å½“æŸä»¶äº‹æƒ…å·²ç»å°±ç»ªå, é€šçŸ¥ä¸Šå±‚.</li>
<li>Inbound äº‹ä»¶å‘èµ·è€…æ˜¯ Unsafe</li>
<li>Inbound äº‹ä»¶çš„å¤„ç†è€…æ˜¯ TailContext, å¦‚æœç”¨æˆ·æ²¡æœ‰å®ç°è‡ªå®šä¹‰çš„å¤„ç†æ–¹æ³•, é‚£ä¹ˆInbound äº‹ä»¶é»˜è®¤çš„å¤„ç†è€…æ˜¯ TailContext, å¹¶ä¸”å…¶å¤„ç†æ–¹æ³•æ˜¯ç©ºå®ç°.</li>
<li><p>Inbound äº‹ä»¶åœ¨ Pipeline ä¸­ä¼ è¾“æ–¹å‘æ˜¯ <code>head</code>( å¤´ ) -&gt; <code>tail</code>( å°¾ )</p>
<blockquote>
<p>æ—ç™½ï¼šInbound ç¿»è¯‘ä¸ºâ€œå…¥ç«™â€ï¼Œæ‰€ä»¥ä» <code>head</code>( å¤´ )åˆ° <code>tail</code>( å°¾ )ä¹Ÿåˆç†ã€‚</p>
</blockquote>
</li>
<li><p>åœ¨ ChannelHandler ä¸­å¤„ç†äº‹ä»¶æ—¶, å¦‚æœè¿™ä¸ª Handler ä¸æ˜¯æœ€åä¸€ä¸ª Handler, åˆ™éœ€è¦è°ƒç”¨ <code>ctx.fireIN_EVT</code> (ä¾‹å¦‚ <code>ctx.fireChannelActive</code> ) å°†æ­¤äº‹ä»¶ç»§ç»­ä¼ æ’­ä¸‹å». å¦‚æœä¸è¿™æ ·åš, é‚£ä¹ˆæ­¤äº‹ä»¶çš„ä¼ æ’­ä¼šæå‰ç»ˆæ­¢.</p>
</li>
<li>Inbound äº‹ä»¶æµ: <code>Context.fireIN_EVT</code> -&gt; <code>Connect.findContextInbound</code> -&gt; <code>nextContext.invokeIN_EVT</code> -&gt; <code>nextHandler.IN_EVT</code> -&gt; <code>nextContext.fireIN_EVT</code></li>
</ul>
<p>Outbound å’Œ Inbound äº‹ä»¶ååˆ†çš„é•œåƒ, å¹¶ä¸” Context ä¸ Handler ç›´æ¥çš„è°ƒç”¨å…³ç³»æ˜¯å¦å®¹æ˜“æ··æ·†, å› æ­¤è¯»è€…åœ¨é˜…è¯»è¿™é‡Œçš„æºç æ—¶, éœ€è¦ç‰¹åˆ«çš„æ³¨æ„ã€‚</p>
<h1 id="3-DefaultChannelPipeline"><a href="#3-DefaultChannelPipeline" class="headerlink" title="3. DefaultChannelPipeline"></a>3. DefaultChannelPipeline</h1><p><code>io.netty.channel.DefaultChannelPipeline</code> ï¼Œå®ç° ChannelPipeline æ¥å£ï¼Œé»˜è®¤ ChannelPipeline å®ç°ç±»ã€‚ğŸ˜ˆ å®é™…ä¸Šï¼Œä¹Ÿåªæœ‰è¿™ä¸ªå®ç°ç±»ã€‚</p>
<h2 id="3-1-é™æ€å±æ€§"><a href="#3-1-é™æ€å±æ€§" class="headerlink" title="3.1 é™æ€å±æ€§"></a>3.1 é™æ€å±æ€§</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #head} çš„åå­—</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String HEAD_NAME = generateName0(HeadContext.class);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #tail} çš„åå­—</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAIL_NAME = generateName0(TailContext.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åå­—({<span class="doctag">@link</span> AbstractChannelHandlerContext#name})ç¼“å­˜ ï¼ŒåŸºäº ThreadLocal ï¼Œç”¨äºç”Ÿæˆåœ¨çº¿ç¨‹ä¸­å”¯ä¸€çš„åå­—ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> FastThreadLocal&lt;Map&lt;Class&lt;?&gt;, String&gt;&gt; nameCaches = <span class="keyword">new</span> FastThreadLocal&lt;Map&lt;Class&lt;?&gt;, String&gt;&gt;() {</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Map&lt;Class&lt;?&gt;, String&gt; initialValue() <span class="keyword">throws</span> Exception {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> WeakHashMap&lt;Class&lt;?&gt;, String&gt;();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #estimatorHandle} çš„åŸå­æ›´æ–°å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicReferenceFieldUpdater&lt;DefaultChannelPipeline, MessageSizeEstimator.Handle&gt; ESTIMATOR =</span><br><span class="line">        AtomicReferenceFieldUpdater.newUpdater(</span><br><span class="line">                DefaultChannelPipeline.class, MessageSizeEstimator.Handle.class, <span class="string">"estimatorHandle"</span>);</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p><code>HEAD_NAME</code> å’Œ <code>TAIL_NAME</code> é™æ€å±æ€§ï¼Œé€šè¿‡è°ƒç”¨ <code>#generateName0(Class&lt;?&gt; handlerType)</code> æ–¹æ³•ï¼Œç”Ÿæˆå¯¹åº”çš„åå­—ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">generateName0</span><span class="params">(Class&lt;?&gt; handlerType)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> StringUtil.simpleClassName(handlerType) + <span class="string">"#0"</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å³ <code>HEAD_NAME = "HeadContext#0"</code>ï¼Œ<code>TAIL_NAME= "TailContext#0"</code> ã€‚</li>
</ul>
</li>
<li><code>nameCaches</code> é™æ€å±æ€§ï¼Œåå­—( <code>AbstractChannelHandlerContext.name</code> )ç¼“å­˜ ï¼ŒåŸºäº ThreadLocal ï¼Œç”¨äºç”Ÿæˆ<strong>åœ¨çº¿ç¨‹ä¸­å”¯ä¸€çš„åå­—</strong>ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/Pipeline-2-add-channel-handler">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Pipelineï¼ˆäºŒï¼‰ä¹‹æ·»åŠ  ChannelHandlerã€‹</a> ã€‚</li>
<li><code>ESTIMATOR</code> é™æ€å±æ€§ï¼Œ<code>estimatorHandle</code> å±æ€§çš„<strong>åŸå­</strong>æ›´æ–°å™¨ã€‚</li>
</ul>
<h2 id="3-2-æ„é€ æ–¹æ³•"><a href="#3-2-æ„é€ æ–¹æ³•" class="headerlink" title="3.2 æ„é€ æ–¹æ³•"></a>3.2 æ„é€ æ–¹æ³•</h2><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Head èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> AbstractChannelHandlerContext head;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Tail èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> AbstractChannelHandlerContext tail;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰€å± Channel å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Channel channel;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æˆåŠŸçš„ Promise å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ChannelFuture succeededFuture;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸è¿›è¡Œé€šçŸ¥çš„ Promise å¯¹è±¡</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * ç”¨äºä¸€äº›æ–¹æ³•æ‰§è¡Œï¼Œéœ€è¦ä¼ å…¥ Promise ç±»å‹çš„æ–¹æ³•å‚æ•°ï¼Œä½†æ˜¯ä¸éœ€è¦è¿›è¡Œé€šçŸ¥ï¼Œå°±ä¼ å…¥è¯¥å€¼</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> io.netty.channel.AbstractChannel.AbstractUnsafe#safeSetSuccess(ChannelPromise) </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> VoidChannelPromise voidPromise;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TODO 1008 DefaultChannelPipeline å­—æ®µç”¨é€”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> touch = ResourceLeakDetector.isEnabled();</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å­æ‰§è¡Œå™¨é›†åˆã€‚</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * é»˜è®¤æƒ…å†µä¸‹ï¼ŒChannelHandler ä½¿ç”¨ Channel æ‰€åœ¨çš„ EventLoop ä½œä¸ºæ‰§è¡Œå™¨ã€‚</span></span><br><span class="line"><span class="comment"> * ä½†æ˜¯å¦‚æœæœ‰éœ€è¦ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰æ‰§è¡Œå™¨ã€‚è¯¦ç»†è§£æï¼Œè§ {<span class="doctag">@link</span> #childExecutor(EventExecutorGroup)} ã€‚</span></span><br><span class="line"><span class="comment"> * å®é™…æƒ…å†µä¸‹ï¼ŒåŸºæœ¬ä¸ä¼šç”¨åˆ°ã€‚å’ŒåŸºå‹ã€é—ªç”µä¾ ã€‘æ²Ÿé€šè¿‡ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Map&lt;EventExecutorGroup, EventExecutor&gt; childExecutors;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * TODO 1008 DefaultChannelPipeline å­—æ®µç”¨é€”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> MessageSizeEstimator.Handle estimatorHandle;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦é¦–æ¬¡æ³¨å†Œ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> firstRegistration = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This is the head of a linked list that is processed by {<span class="doctag">@link</span> #callHandlerAddedForAllHandlers()} and so process</span></span><br><span class="line"><span class="comment"> * all the pending {<span class="doctag">@link</span> #callHandlerAdded0(AbstractChannelHandlerContext)}.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * We only keep the head because it is expected that the list is used infrequently and its size is small.</span></span><br><span class="line"><span class="comment"> * Thus full iterations to do insertions is assumed to be a good compromised to saving memory and tail management</span></span><br><span class="line"><span class="comment"> * complexity.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * å‡†å¤‡æ·»åŠ  ChannelHandler çš„å›è°ƒ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> PendingHandlerCallback pendingHandlerCallbackHead;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Set to {<span class="doctag">@code</span> true} once the {<span class="doctag">@link</span> AbstractChannel} is registered.Once set to {<span class="doctag">@code</span> true} the value will never</span></span><br><span class="line"><span class="comment"> * change.</span></span><br><span class="line"><span class="comment"> * Channel æ˜¯å¦å·²æ³¨å†Œ</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> registered;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">DefaultChannelPipeline</span><span class="params">(Channel channel)</span> </span>{</span><br><span class="line">    <span class="keyword">this</span>.channel = ObjectUtil.checkNotNull(channel, <span class="string">"channel"</span>);</span><br><span class="line">    <span class="comment">// succeededFuture çš„åˆ›å»º</span></span><br><span class="line">    succeededFuture = <span class="keyword">new</span> SucceededChannelFuture(channel, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">// voidPromise çš„åˆ›å»º</span></span><br><span class="line">    voidPromise =  <span class="keyword">new</span> VoidChannelPromise(channel, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ›å»º Tail åŠè¯¶ç‚¹</span></span><br><span class="line">    tail = <span class="keyword">new</span> TailContext(<span class="keyword">this</span>); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">    <span class="comment">// åˆ›å»º Head èŠ‚ç‚¹</span></span><br><span class="line">    head = <span class="keyword">new</span> HeadContext(<span class="keyword">this</span>); <span class="comment">// &lt;2&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›¸äº’æŒ‡å‘ &lt;3&gt;</span></span><br><span class="line">    head.next = tail;</span><br><span class="line">    tail.prev = head;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>head</code> å±æ€§ï¼ŒHead èŠ‚ç‚¹ï¼Œåœ¨æ„é€ æ–¹æ³•çš„ <code>&lt;1&gt;</code> å¤„åˆå§‹åŒ–ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ4.2 HeadContextã€</a> ã€‚</li>
<li><code>tail</code> èŠ‚ç‚¹ï¼ŒTail èŠ‚ç‚¹ï¼Œåœ¨æ„é€ æ–¹æ³•çš„ <code>&lt;2&gt;</code> å¤„åˆå§‹åŒ–ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ4.3 TailContextã€</a> ã€‚</li>
<li><p>åœ¨æ„é€ æ–¹æ³•çš„ <code>&lt;3&gt;</code> å¤„ï¼Œ<code>head</code> èŠ‚ç‚¹å‘<strong>ä¸‹</strong>æŒ‡å‘ <code>tail</code> èŠ‚ç‚¹ï¼Œ<code>tail</code> èŠ‚ç‚¹å‘<strong>ä¸Š</strong>æŒ‡å‘ <code>head</code> èŠ‚ç‚¹ï¼Œä»è€Œå½¢æˆ<strong>ç›¸äº’</strong>çš„æŒ‡å‘ã€‚å³å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<blockquote>
<p>FROM <a href="https://www.jianshu.com/p/6efa9c5fa702" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnetty æºç åˆ†æä¹‹ pipeline(ä¸€)ã€‹</a></p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_06_01/02.png" title="pipeline èŠ‚ç‚¹é“¾(é»˜è®¤)" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_06_01/02.png" alt="pipeline èŠ‚ç‚¹é“¾(é»˜è®¤)"></a><span class="caption">pipeline èŠ‚ç‚¹é“¾(é»˜è®¤)</span></p>
</blockquote>
<ul>
<li>pipeline ä¸­çš„èŠ‚ç‚¹çš„æ•°æ®ç»“æ„æ˜¯ ChannelHandlerContext ç±»ã€‚æ¯ä¸ª ChannelHandlerContext åŒ…å«<strong>ä¸€ä¸ª</strong> ChannelHandlerã€å®ƒçš„<strong>ä¸Šä¸‹</strong>èŠ‚ç‚¹( <strong>ä»è€Œå½¢æˆ ChannelHandler é“¾</strong> )ã€ä»¥åŠå…¶ä»–ä¸Šä¸‹æ–‡ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ4. ChannelHandlerContextã€</a> ã€‚</li>
<li><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œpipeline æœ‰ <code>head</code> å’Œ <code>tail</code> èŠ‚ç‚¹ï¼Œå½¢æˆé»˜è®¤çš„ ChannelHandler é“¾ã€‚è€Œæˆ‘ä»¬å¯ä»¥åœ¨å®ƒä»¬ä¹‹é—´ï¼ŒåŠ å…¥è‡ªå®šä¹‰çš„ ChannelHandler èŠ‚ç‚¹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<blockquote>
<p>FROM <a href="https://www.jianshu.com/p/6efa9c5fa702" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnetty æºç åˆ†æä¹‹ pipeline(ä¸€)ã€‹</a></p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_06_01/03.png" title="pipeline èŠ‚ç‚¹é“¾(è‡ªå®šä¹‰)" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_06_01/03.png" alt="pipeline èŠ‚ç‚¹é“¾(è‡ªå®šä¹‰)"></a><span class="caption">pipeline èŠ‚ç‚¹é“¾(è‡ªå®šä¹‰)</span></p>
</blockquote>
</li>
</ul>
</li>
<li><p><code>childExecutors</code> å±æ€§ï¼Œå­æ‰§è¡Œå™¨é›†åˆã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒChannelHandler ä½¿ç”¨ Channel æ‰€åœ¨çš„ EventLoop ä½œä¸ºæ‰§è¡Œå™¨ã€‚</p>
<ul>
<li>ä½†æ˜¯å¦‚æœæœ‰éœ€è¦ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰æ‰§è¡Œå™¨ã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/Pipeline-2-add-channel-handler">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Pipelineï¼ˆäºŒï¼‰ä¹‹æ·»åŠ  ChannelHandlerã€‹</a> ã€‚</li>
<li>å®é™…æƒ…å†µä¸‹ï¼ŒåŸºæœ¬ä¸ä¼šç”¨åˆ°ã€‚å’ŒåŸºå‹ã€é—ªç”µä¾ ã€‘æ²Ÿé€šè¿‡ã€‚</li>
</ul>
</li>
<li><code>pendingHandlerCallbackHead</code> å±æ€§ï¼Œå‡†å¤‡æ·»åŠ  ChannelHandler çš„å›è°ƒã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/Pipeline-2-add-channel-handler">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Pipelineï¼ˆäºŒï¼‰ä¹‹æ·»åŠ  ChannelHandlerã€‹</a> ã€‚</li>
<li><code>registered</code> å±æ€§ï¼ŒChannel æ˜¯å¦å·²æ³¨å†Œã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/Pipeline-2-add-channel-handler">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Pipelineï¼ˆäºŒï¼‰ä¹‹æ·»åŠ  ChannelHandlerã€‹</a> ã€‚</li>
<li><code>firstRegistration</code> å±æ€§ï¼Œæ˜¯å¦é¦–æ¬¡æ³¨å†Œã€‚è¯¦ç»†è§£æï¼Œè§ <a href="http://svip.iocoder.cn/Netty/Pipeline-2-add-channel-handler">ã€Šç²¾å°½ Netty æºç è§£æ â€”â€” Pipelineï¼ˆäºŒï¼‰ä¹‹æ·»åŠ  ChannelHandlerã€‹</a> ã€‚</li>
</ul>
<h2 id="3-3-å…¶ä»–æ–¹æ³•"><a href="#3-3-å…¶ä»–æ–¹æ³•" class="headerlink" title="3.3 å…¶ä»–æ–¹æ³•"></a>3.3 å…¶ä»–æ–¹æ³•</h2><p>DefaultChannelPipeline ä¸­çš„å…¶ä»–æ–¹æ³•ï¼Œè¯¦ç»†è§£æï¼Œè§åç»­çš„æ–‡ç« ã€‚</p>
<h1 id="4-ChannelHandlerContext"><a href="#4-ChannelHandlerContext" class="headerlink" title="4. ChannelHandlerContext"></a>4. ChannelHandlerContext</h1><p><code>io.netty.channel.ChannelHandlerContext</code> ï¼Œç»§æ‰¿ ChannelInboundInvokerã€ChannelOutboundInvokerã€AttributeMap æ¥å£ï¼ŒChannelHandler Context( ä¸Šä¸‹æ–‡ )æ¥å£ï¼Œä½œä¸º ChannelPipeline ä¸­çš„<strong>èŠ‚ç‚¹</strong>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">// ========== Context ç›¸å…³ ==========</span></span><br><span class="line"><span class="function">String <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">Channel <span class="title">channel</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">EventExecutor <span class="title">executor</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelHandler <span class="title">handler</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function">ChannelPipeline <span class="title">pipeline</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isRemoved</span><span class="params">()</span></span>; <span class="comment">// æ˜¯å¦å·²ç»ç§»é™¤</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== ByteBuf ç›¸å…³ ==========    </span></span><br><span class="line"><span class="function">ByteBufAllocator <span class="title">alloc</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== ChannelInboundInvoker ç›¸å…³ ==========    </span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function">ChannelHandlerContext <span class="title">fireChannelRegistered</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function">ChannelHandlerContext <span class="title">fireChannelUnregistered</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function">ChannelHandlerContext <span class="title">fireChannelActive</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function">ChannelHandlerContext <span class="title">fireChannelInactive</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function">ChannelHandlerContext <span class="title">fireExceptionCaught</span><span class="params">(Throwable cause)</span></span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function">ChannelHandlerContext <span class="title">fireUserEventTriggered</span><span class="params">(Object evt)</span></span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function">ChannelHandlerContext <span class="title">fireChannelRead</span><span class="params">(Object msg)</span></span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function">ChannelHandlerContext <span class="title">fireChannelReadComplete</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function">ChannelHandlerContext <span class="title">fireChannelWritabilityChanged</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== ChannelOutboundInvoker ç›¸å…³ ==========</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function">ChannelHandlerContext <span class="title">read</span><span class="params">()</span></span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function">ChannelHandlerContext <span class="title">flush</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== AttributeMap ç›¸å…³ ==========</span></span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">&lt;T&gt; <span class="function">Attribute&lt;T&gt; <span class="title">attr</span><span class="params">(AttributeKey&lt;T&gt; key)</span></span>;</span><br><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">&lt;T&gt; <span class="function"><span class="keyword">boolean</span> <span class="title">hasAttr</span><span class="params">(AttributeKey&lt;T&gt; key)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<p>è™½ç„¶æ¥å£çš„æ–¹æ³•æ¯”è¾ƒå¤šï¼Œç¬”è€…åšäº†å½’ç±»å¦‚ä¸‹ï¼š</p>
<ul>
<li>Context ç›¸å…³çš„æ¥å£æ–¹æ³•ã€‚</li>
<li>ç»§æ‰¿è‡ª ChannelInboundInvoker çš„ç›¸å…³æ–¹æ³•ï¼Œ<em>å’Œ ChannelPipeline ä¸€æ ·</em>ã€‚</li>
<li>ç»§æ‰¿è‡ª ChannelOutboundInvoker çš„ç›¸å…³æ–¹æ³•ï¼Œ<em>å’Œ ChannelPipeline ä¸€æ ·</em>ã€‚</li>
<li>ç»§æ‰¿è‡ª AttributeMap çš„ç›¸å…³æ–¹æ³•ï¼Œå®é™…ä¸Šå·²ç»åºŸå¼ƒ( <code>@Deprecated</code> )äº†ï¼Œä¸å†ä» ChannelHandlerContext ä¸­è·å–ï¼Œè€Œæ˜¯ä» Channel ä¸­è·å–ã€‚</li>
</ul>
<p>ChannelHandlerContext çš„ç±»å›¾å¦‚ä¸‹ï¼š</p>
<p><a href="http://static2.iocoder.cn/images/Netty/2018_06_01/04.png" title="ChannelHandlerContext ç±»å›¾" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_06_01/04.png" alt="ChannelHandlerContext ç±»å›¾"></a><span class="caption">ChannelHandlerContext ç±»å›¾</span></p>
<ul>
<li>ğŸ˜ˆ ç±»å›¾ä¸­çš„ AttributeMap å’Œ DefaultAttributeMap å¯ä»¥æ— è§†ã€‚</li>
</ul>
<h2 id="4-1-AbstractChannelHandlerContext"><a href="#4-1-AbstractChannelHandlerContext" class="headerlink" title="4.1 AbstractChannelHandlerContext"></a>4.1 AbstractChannelHandlerContext</h2><p><code>io.netty.channel.AbstractChannelHandlerContext</code> ï¼Œå®ç° ChannelHandlerContextã€ResourceLeakHint æ¥å£ï¼Œç»§æ‰¿ DefaultAttributeMap ç±»ï¼ŒChannelHandlerContext æŠ½è±¡åŸºç±»ã€‚</p>
<h3 id="4-1-1-é™æ€å±æ€§"><a href="#4-1-1-é™æ€å±æ€§" class="headerlink" title="4.1.1 é™æ€å±æ€§"></a>4.1.1 é™æ€å±æ€§</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Neither {<span class="doctag">@link</span> ChannelHandler#handlerAdded(ChannelHandlerContext)}</span></span><br><span class="line"><span class="comment"> * nor {<span class="doctag">@link</span> ChannelHandler#handlerRemoved(ChannelHandlerContext)} was called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INIT = <span class="number">0</span>; <span class="comment">// åˆå§‹åŒ–</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> ChannelHandler#handlerAdded(ChannelHandlerContext)} is about to be called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ADD_PENDING = <span class="number">1</span>; <span class="comment">// æ·»åŠ å‡†å¤‡ä¸­</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> ChannelHandler#handlerAdded(ChannelHandlerContext)} was called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> ADD_COMPLETE = <span class="number">2</span>; <span class="comment">// å·²æ·»åŠ </span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> ChannelHandler#handlerRemoved(ChannelHandlerContext)} was called.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REMOVE_COMPLETE = <span class="number">3</span>; <span class="comment">// å·²ç§»é™¤</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * {<span class="doctag">@link</span> #handlerState} çš„åŸå­æ›´æ–°å™¨</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicIntegerFieldUpdater&lt;AbstractChannelHandlerContext&gt; HANDLER_STATE_UPDATER = AtomicIntegerFieldUpdater.newUpdater(AbstractChannelHandlerContext.class, <span class="string">"handlerState"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== éé™æ€å±æ€§ ==========</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤„ç†å™¨çŠ¶æ€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> handlerState = INIT;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>handlerState</code> å±æ€§( <strong>éé™æ€</strong>å±æ€§ï¼Œæ”¾è¿™é‡Œä¸»è¦æ˜¯ä¸ºäº†ç»Ÿä¸€è®² )ï¼Œå¤„ç†å™¨çŠ¶æ€ã€‚å…±æœ‰ <strong>4</strong> ç§çŠ¶æ€ã€‚çŠ¶æ€å˜è¿å¦‚ä¸‹å›¾ï¼š<a href="http://static2.iocoder.cn/images/Netty/2018_06_01/05.png" title="`handlerState` å˜è¿" class="fancybox" rel="article0"><img src="http://static2.iocoder.cn/images/Netty/2018_06_01/05.png" alt="`handlerState` å˜è¿"></a><span class="caption">`handlerState` å˜è¿</span><ul>
<li>è¯¦ç»†è§£æï¼Œè§ <a href="#">ã€Œ4.1.3 setAddCompleteã€</a>ã€<a href="#">ã€Œ4.1.4 setRemovedã€</a>ã€<a href="#">ã€Œ4.1.5 setAddPendingã€</a> ä¸­ã€‚</li>
</ul>
</li>
<li><code>HANDLER_STATE_UPDATER</code> <strong>é™æ€</strong>å±æ€§ï¼Œ<code>handlerState</code> çš„åŸå­æ›´æ–°å™¨ã€‚</li>
</ul>
<h3 id="4-1-2-æ„é€ æ–¹æ³•"><a href="#4-1-2-æ„é€ æ–¹æ³•" class="headerlink" title="4.1.2 æ„é€ æ–¹æ³•"></a>4.1.2 æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸Šä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">volatile</span> AbstractChannelHandlerContext next;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">volatile</span> AbstractChannelHandlerContext prev;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦ä¸º inbound</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> inbound;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦ä¸º outbound</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> outbound;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰€å± pipeline</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DefaultChannelPipeline pipeline;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åå­—</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ˜¯å¦ä½¿ç”¨æœ‰åºçš„ EventExecutor ( {<span class="doctag">@link</span> #executor} )ï¼Œå³ OrderedEventExecutor</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> ordered;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Will be set to null if no child executor should be used, otherwise it will be set to the</span></span><br><span class="line"><span class="comment">// child executor.</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * EventExecutor å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> EventExecutor executor;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æˆåŠŸçš„ Promise å¯¹è±¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> ChannelFuture succeededFuture;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Lazily instantiated tasks used to trigger events to a handler with different executor. æ‡’åŠ è½½</span></span><br><span class="line"><span class="comment">// There is no need to make this volatile as at worse it will just create a few more instances then needed.</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰§è¡Œ Channel ReadComplete äº‹ä»¶çš„ä»»åŠ¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Runnable invokeChannelReadCompleteTask;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰§è¡Œ Channel Read äº‹ä»¶çš„ä»»åŠ¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Runnable invokeReadTask;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰§è¡Œ Channel WritableStateChanged äº‹ä»¶çš„ä»»åŠ¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Runnable invokeChannelWritableStateChangedTask;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰§è¡Œ flush äº‹ä»¶çš„ä»»åŠ¡</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> Runnable invokeFlushTask;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * å¤„ç†å™¨çŠ¶æ€</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> handlerState = INIT;</span><br><span class="line"></span><br><span class="line">AbstractChannelHandlerContext(DefaultChannelPipeline pipeline, EventExecutor executor, String name,</span><br><span class="line">                              <span class="keyword">boolean</span> inbound, <span class="keyword">boolean</span> outbound) {</span><br><span class="line">    <span class="keyword">this</span>.name = ObjectUtil.checkNotNull(name, <span class="string">"name"</span>);</span><br><span class="line">    <span class="keyword">this</span>.pipeline = pipeline;</span><br><span class="line">    <span class="keyword">this</span>.executor = executor;</span><br><span class="line">    <span class="keyword">this</span>.inbound = inbound;</span><br><span class="line">    <span class="keyword">this</span>.outbound = outbound;</span><br><span class="line">    <span class="comment">// Its ordered if its driven by the EventLoop or the given Executor is an instanceof OrderedEventExecutor.</span></span><br><span class="line">    ordered = executor == <span class="keyword">null</span> || executor <span class="keyword">instanceof</span> OrderedEventExecutor; <span class="comment">// &lt;1&gt;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>next</code>ã€<code>prev</code> å±æ€§ï¼Œåˆ†åˆ«è®°å½•ä¸Šã€ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚</li>
<li>Handler ç›¸å…³å±æ€§ï¼š<ul>
<li>åœ¨ AbstractChannelHandlerContext æŠ½è±¡ç±»ä¸­ï¼ŒæŒ‰ç…§æˆ‘ä»¬ä¸Šæ–‡çš„åˆ†äº«ï¼Œåº”è¯¥ä¼šçœ‹åˆ°ä¸€ä¸ªç±»å‹ä¸º ChannelHandler çš„å¤„ç†å™¨ï¼Œä½†æ˜¯<strong>å®é™…å¹¶ä¸æ˜¯è¿™æ ·</strong>ã€‚è€Œæ˜¯ï¼ŒğŸ˜ˆ æˆ‘ä»¬ä¸‹æ–‡ DefaultChannelHandlerContextã€TailContextã€HeadContext è§ã€‚</li>
<li><code>inbound</code>ã€<code>outbound</code> å±æ€§ï¼Œåˆ†åˆ«æ˜¯å¦ä¸º Inboundã€Outbound å¤„ç†å™¨ã€‚</li>
<li><code>name</code> å±æ€§ï¼Œå¤„ç†å™¨åå­—ã€‚</li>
<li><code>handlerState</code> å±æ€§ï¼Œå¤„ç†å™¨çŠ¶æ€ï¼Œåˆå§‹ä¸º <code>INIT</code> ã€‚</li>
</ul>
</li>
<li><code>executor</code> å±æ€§ï¼ŒEventExecutor å¯¹è±¡<ul>
<li><code>ordered</code> å±æ€§ï¼Œæ˜¯å¦ä½¿ç”¨æœ‰åºçš„ <code>executor</code>ï¼Œå³ OrderedEventExecutor ï¼Œåœ¨æ„é€ æ–¹æ³•çš„ <code>&lt;1&gt;</code> å¤„ç†çš„åˆå§‹åŒ–ã€‚</li>
</ul>
</li>
<li><code>pipeline</code> å±æ€§ï¼Œæ‰€å± DefaultChannelPipeline å¯¹è±¡ã€‚</li>
</ul>
<h3 id="4-1-3-setAddComplete"><a href="#4-1-3-setAddComplete" class="headerlink" title="4.1.3 setAddComplete"></a>4.1.3 setAddComplete</h3><p><code>#setAddComplete()</code> æ–¹æ³•ï¼Œè®¾ç½® ChannelHandler æ·»åŠ å®Œæˆã€‚å®Œæˆåï¼ŒçŠ¶æ€æœ‰ä¸¤ç§ç»“æœï¼š</p>
<ol>
<li><code>REMOVE_COMPLETE</code></li>
<li><code>ADD_COMPLETE</code></li>
</ol>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setAddComplete</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">for</span> (;;) {</span><br><span class="line">        <span class="keyword">int</span> oldState = handlerState;</span><br><span class="line">        <span class="comment">// Ensure we never update when the handlerState is REMOVE_COMPLETE already.</span></span><br><span class="line">        <span class="comment">// oldState is usually ADD_PENDING but can also be REMOVE_COMPLETE when an EventExecutor is used that is not</span></span><br><span class="line">        <span class="comment">// exposing ordering guarantees.</span></span><br><span class="line">        <span class="keyword">if</span> (oldState == REMOVE_COMPLETE || HANDLER_STATE_UPDATER.compareAndSet(<span class="keyword">this</span>, oldState, ADD_COMPLETE)) {</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å¾ªç¯ + CAS ä¿è¯å¤šçº¿ç¨‹ä¸‹çš„å®‰å…¨å˜æ›´ <code>handlerState</code> å±æ€§ã€‚</li>
</ul>
<h3 id="4-1-4-setRemoved"><a href="#4-1-4-setRemoved" class="headerlink" title="4.1.4 setRemoved"></a>4.1.4 setRemoved</h3><p><code>#setRemoved()</code> æ–¹æ³•ï¼Œè®¾ç½® ChannelHandler å·²ç§»é™¤ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setRemoved</span><span class="params">()</span> </span>{</span><br><span class="line">    handlerState = REMOVE_COMPLETE;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="4-1-5-setAddPending"><a href="#4-1-5-setAddPending" class="headerlink" title="4.1.5 setAddPending"></a>4.1.5 setAddPending</h3><p><code>#setAddPending()</code> æ–¹æ³•ï¼Œè®¾ç½® ChannelHandler å‡†å¤‡æ·»åŠ ä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setAddPending</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">boolean</span> updated = HANDLER_STATE_UPDATER.compareAndSet(<span class="keyword">this</span>, INIT, ADD_PENDING);</span><br><span class="line">    <span class="keyword">assert</span> updated; <span class="comment">// This should always be true as it MUST be called before setAddComplete() or setRemoved().</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å½“ä¸”ä»…å½“ <code>INIT</code> å¯ä¿®æ”¹ä¸º <code>ADD_PENDING</code> ã€‚ç†è®ºæ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªç»å¯¹ä¼šæˆåŠŸçš„æ“ä½œï¼ŒåŸå› è§è‹±æ–‡æ³¨é‡Šã€‚</li>
</ul>
<h3 id="4-1-6-å…¶ä»–æ–¹æ³•"><a href="#4-1-6-å…¶ä»–æ–¹æ³•" class="headerlink" title="4.1.6 å…¶ä»–æ–¹æ³•"></a>4.1.6 å…¶ä»–æ–¹æ³•</h3><p>AbstractChannelHandlerContext ä¸­çš„å…¶ä»–æ–¹æ³•ï¼Œè¯¦ç»†è§£æï¼Œè§åç»­çš„æ–‡ç« ã€‚</p>
<h2 id="4-2-HeadContext"><a href="#4-2-HeadContext" class="headerlink" title="4.2 HeadContext"></a>4.2 HeadContext</h2><p>HeadContext ï¼Œå®ç° ChannelOutboundHandlerã€ChannelInboundHandler æ¥å£ï¼Œç»§æ‰¿ AbstractChannelHandlerContext æŠ½è±¡ç±»ï¼Œ<strong>pipe å¤´èŠ‚ç‚¹</strong> Context å®ç°ç±»ã€‚</p>
<blockquote>
<p>HeadContext æ˜¯ DefaultChannelPipeline çš„å†…éƒ¨ç±»ã€‚</p>
</blockquote>
<h3 id="4-2-1-æ„é€ æ–¹æ³•"><a href="#4-2-1-æ„é€ æ–¹æ³•" class="headerlink" title="4.2.1 æ„é€ æ–¹æ³•"></a>4.2.1 æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Unsafe unsafe;</span><br><span class="line"></span><br><span class="line">HeadContext(DefaultChannelPipeline pipeline) {</span><br><span class="line">    <span class="keyword">super</span>(pipeline, <span class="keyword">null</span>, HEAD_NAME, <span class="keyword">false</span>, <span class="keyword">true</span>); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">    unsafe = pipeline.channel().unsafe(); <span class="comment">// &lt;2&gt;</span></span><br><span class="line">    setAddComplete(); <span class="comment">// &lt;3&gt;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨çˆ¶ AbstractChannelHandlerContext  çš„æ„é€ æ–¹æ³•ï¼Œè®¾ç½® <code>inbound = false</code>ã€<code>outbound = true</code> ã€‚</li>
<li><p><code>&lt;2&gt;</code> å¤„ï¼Œä½¿ç”¨ Channel çš„ Unsafe ä½œä¸º <code>unsafe</code> å±æ€§ã€‚HeadContext å®ç° ChannelOutboundHandler æ¥å£çš„æ–¹æ³•ï¼Œéƒ½ä¼šè°ƒç”¨ Unsafe å¯¹åº”çš„æ–¹æ³•ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">bind</span><span class="params">(ChannelHandlerContext ctx, SocketAddress localAddress, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    unsafe.bind(localAddress, promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">(ChannelHandlerContext ctx, SocketAddress remoteAddress, SocketAddress localAddress, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    unsafe.connect(remoteAddress, localAddress, promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">disconnect</span><span class="params">(ChannelHandlerContext ctx, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    unsafe.disconnect(promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(ChannelHandlerContext ctx, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    unsafe.close(promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deregister</span><span class="params">(ChannelHandlerContext ctx, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    unsafe.deregister(promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(ChannelHandlerContext ctx)</span> </span>{</span><br><span class="line">    unsafe.beginRead();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(ChannelHandlerContext ctx, Object msg, ChannelPromise promise)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    unsafe.write(msg, promise);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">(ChannelHandlerContext ctx)</span> <span class="keyword">throws</span> Exception </span>{</span><br><span class="line">    unsafe.flush();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè®¾ç½® <code>outbound = true</code> çš„åŸå› ã€‚</li>
</ul>
</li>
<li><p><code>&lt;3&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#setAddComplete()</code> æ–¹æ³•ï¼Œè®¾ç½® ChannelHandler æ·»åŠ å®Œæˆã€‚æ­¤æ—¶ï¼Œ<code>handlerStatus</code> ä¼šå˜æˆ <code>ADD_COMPLETE</code> çŠ¶æ€ã€‚</p>
</li>
</ul>
<h3 id="4-2-2-handler"><a href="#4-2-2-handler" class="headerlink" title="4.2.2 handler"></a>4.2.2 handler</h3><p><code>#handler()</code> æ–¹æ³•ï¼Œè¿”å›è‡ªå·±ä½œä¸º Context çš„ <strong>ChannelHandler</strong> ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ChannelHandler <span class="title">handler</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å› ä¸º HeadContext ï¼Œå®ç° ChannelOutboundHandlerã€ChannelInboundHandler æ¥å£ï¼Œè€Œå®ƒä»¬æœ¬èº«å°±æ˜¯ ChannelHandler ã€‚</li>
</ul>
<h3 id="4-2-3-å…¶ä»–æ–¹æ³•"><a href="#4-2-3-å…¶ä»–æ–¹æ³•" class="headerlink" title="4.2.3 å…¶ä»–æ–¹æ³•"></a>4.2.3 å…¶ä»–æ–¹æ³•</h3><p>HeadContext ä¸­çš„å…¶ä»–æ–¹æ³•ï¼Œè¯¦ç»†è§£æï¼Œè§åç»­çš„æ–‡ç« ã€‚ </p>
<h2 id="4-3-TailContext"><a href="#4-3-TailContext" class="headerlink" title="4.3 TailContext"></a>4.3 TailContext</h2><p>TailContext ï¼Œå®ç° ChannelInboundHandler æ¥å£ï¼Œç»§æ‰¿ AbstractChannelHandlerContext æŠ½è±¡ç±»ï¼Œ<strong>pipe å°¾èŠ‚ç‚¹</strong> Context å®ç°ç±»ã€‚</p>
<blockquote>
<p>TailContext æ˜¯ DefaultChannelPipeline çš„å†…éƒ¨ç±»ã€‚</p>
</blockquote>
<h3 id="4-3-1-æ„é€ æ–¹æ³•"><a href="#4-3-1-æ„é€ æ–¹æ³•" class="headerlink" title="4.3.1 æ„é€ æ–¹æ³•"></a>4.3.1 æ„é€ æ–¹æ³•</h3><figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line">TailContext(DefaultChannelPipeline pipeline) {</span><br><span class="line">    <span class="keyword">super</span>(pipeline, <span class="keyword">null</span>, TAIL_NAME, <span class="keyword">true</span>, <span class="keyword">false</span>); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">    setAddComplete(); <span class="comment">// &lt;2&gt;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨çˆ¶ AbstractChannelHandlerContext  çš„æ„é€ æ–¹æ³•ï¼Œè®¾ç½® <code>inbound = true</code>ã€<code>outbound = false</code> ï¼Œå’Œ HeadContext <strong>ç›¸å</strong>ã€‚</li>
<li><code>&lt;2&gt;</code> å¤„ï¼Œè°ƒç”¨ <code>#setAddComplete()</code> æ–¹æ³•ï¼Œè®¾ç½® ChannelHandler æ·»åŠ å®Œæˆã€‚æ­¤æ—¶ï¼Œ<code>handlerStatus</code> ä¼šå˜æˆ <code>ADD_COMPLETE</code> çŠ¶æ€ã€‚</li>
</ul>
<h3 id="4-3-2-handler"><a href="#4-3-2-handler" class="headerlink" title="4.3.2 handler"></a>4.3.2 handler</h3><p><code>#handler()</code> æ–¹æ³•ï¼Œè¿”å›è‡ªå·±ä½œä¸º Context çš„ <strong>ChannelHandler</strong> ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ChannelHandler <span class="title">handler</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å› ä¸º HeadContext ï¼Œå®ç° ChannelInboundHandler æ¥å£ï¼Œè€Œå®ƒä»¬æœ¬èº«å°±æ˜¯ ChannelHandler ã€‚</li>
</ul>
<h3 id="4-3-3-å…¶ä»–æ–¹æ³•"><a href="#4-3-3-å…¶ä»–æ–¹æ³•" class="headerlink" title="4.3.3 å…¶ä»–æ–¹æ³•"></a>4.3.3 å…¶ä»–æ–¹æ³•</h3><p>TailContext ä¸­çš„å…¶ä»–æ–¹æ³•ï¼Œè¯¦ç»†è§£æï¼Œè§åç»­çš„æ–‡ç« ã€‚ </p>
<h2 id="4-4-DefaultChannelHandlerContext"><a href="#4-4-DefaultChannelHandlerContext" class="headerlink" title="4.4 DefaultChannelHandlerContext"></a>4.4 DefaultChannelHandlerContext</h2><p><code>io.netty.channel.DefaultChannelHandlerContext</code> ï¼Œå®ç° AbstractChannelHandlerContext æŠ½è±¡ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultChannelHandlerContext</span> <span class="keyword">extends</span> <span class="title">AbstractChannelHandlerContext</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ChannelHandler handler;</span><br><span class="line"></span><br><span class="line">    DefaultChannelHandlerContext(</span><br><span class="line">            DefaultChannelPipeline pipeline, EventExecutor executor, String name, ChannelHandler handler) {</span><br><span class="line">        <span class="keyword">super</span>(pipeline, executor, name, isInbound(handler), isOutbound(handler)); <span class="comment">// &lt;1&gt;</span></span><br><span class="line">        <span class="keyword">if</span> (handler == <span class="keyword">null</span>) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"handler"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">this</span>.handler = handler; <span class="comment">// &lt;2&gt;</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ChannelHandler <span class="title">handler</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> handler;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isInbound</span><span class="params">(ChannelHandler handler)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> handler <span class="keyword">instanceof</span> ChannelInboundHandler;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isOutbound</span><span class="params">(ChannelHandler handler)</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> handler <span class="keyword">instanceof</span> ChannelOutboundHandler;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ä¸åŒäº HeadContextã€TailContextï¼Œå®ƒä»¬è‡ªèº«å°±æ˜¯ä¸€ä¸ª Context çš„åŒæ—¶ï¼Œä¹Ÿæ˜¯ä¸€ä¸ª ChannelHandler ã€‚è€Œ DefaultChannelHandlerContext æ˜¯<strong>å†…åµŒ</strong> ä¸€ä¸ª ChannelHandler å¯¹è±¡ï¼Œå³ <code>handler</code> ã€‚è¿™ä¸ªå±æ€§é€šè¿‡æ„é€ æ–¹æ³•ä¼ å…¥ï¼Œåœ¨ <code>&lt;2&gt;</code> å¤„è¿›è¡Œèµ‹å€¼ã€‚</li>
<li><code>&lt;1&gt;</code> å¤„ï¼Œè°ƒç”¨çˆ¶ AbstractChannelHandlerContext  çš„æ„é€ æ–¹æ³•ï¼Œé€šè¿‡åˆ¤æ–­ä¼ å…¥çš„ <code>handler</code> æ˜¯å¦ä¸º ChannelInboundHandler å’Œ ChannelOutboundHandler æ¥åˆ†åˆ«åˆ¤æ–­æ˜¯å¦ä¸º <code>inbound</code> å’Œ <code>outbound</code> ã€‚</li>
</ul>
<h1 id="666-å½©è›‹"><a href="#666-å½©è›‹" class="headerlink" title="666. å½©è›‹"></a>666. å½©è›‹</h1><p>æ¨èé˜…è¯»å¦‚ä¸‹æ–‡ç« ï¼š</p>
<ul>
<li>é—ªç”µä¾  <a href="https://www.jianshu.com/p/6efa9c5fa702" rel="external nofollow noopener noreferrer" target="_blank">ã€Šnetty æºç åˆ†æä¹‹ pipeline(ä¸€)ã€‹</a></li>
<li>æ°¸é¡º <a href="https://segmentfault.com/a/1190000007308934" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty æºç åˆ†æä¹‹ äºŒ è´¯ç©¿Netty çš„å¤§åŠ¨è„‰ â”€â”€ ChannelPipeline (ä¸€)ã€‹</a></li>
<li>å å°ç‹¼ <a href="https://www.jianshu.com/p/3876874306d5" rel="external nofollow noopener noreferrer" target="_blank">ã€ŠNetty æºç åˆ†æä¹‹ ChannelPipelineã€‹</a></li>
</ul>


</div>
<!--
<footer class="article-footer">
<a data-url="http://svip.iocoder.cn/Netty/ChannelPipeline-1-init/" data-id="ck4pl3foy00djfgcf0due8euj" class="article-share-link">åˆ†äº«</a>



</footer>
-->
</div>